<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 8328:c0fa78af189d806b821b1e7b38992a6af7cd961b</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ c0fa78af189d806b821b1e7b38992a6af7cd961b" />
<meta property="og:url" content="/comm-central/rev/c0fa78af189d806b821b1e7b38992a6af7cd961b" />
<meta property="og:description" content="Bug 662960 - MozMill: replace uses of waitForEval with waitFor. r=bienvenu+bwinton" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / c0fa78af189d806b821b1e7b38992a6af7cd961b 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/c0fa78af189d806b821b1e7b38992a6af7cd961b">shortlog</a> |
<a href="/comm-central/log/c0fa78af189d806b821b1e7b38992a6af7cd961b">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/c0fa78af189d806b821b1e7b38992a6af7cd961b">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/c0fa78af189d806b821b1e7b38992a6af7cd961b">files</a> |
changeset |
<a href="/comm-central/raw-rev/c0fa78af189d806b821b1e7b38992a6af7cd961b">raw</a>  | <a href="/comm-central/archive/c0fa78af189d806b821b1e7b38992a6af7cd961b.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=662960">Bug 662960</a> - MozMill: replace uses of waitForEval with waitFor. r=bienvenu+bwinton
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#83;&#105;&#100;&#100;&#104;&#97;&#114;&#116;&#104;&#32;&#65;&#103;&#97;&#114;&#119;&#97;&#108;&#32;&#60;&#115;&#105;&#100;&#46;&#98;&#117;&#103;&#122;&#105;&#108;&#108;&#97;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 18 Aug 2011 14:41:03 +0530</td></tr>

<tr>
 <td>changeset 8328</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/c0fa78af189d806b821b1e7b38992a6af7cd961b">c0fa78af189d806b821b1e7b38992a6af7cd961b</a></td>
</tr>



<tr>
<td>parent 8327</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/790cc2369783c05a19a3c87f41ec88c0c2b8bbbb">790cc2369783c05a19a3c87f41ec88c0c2b8bbbb</a>
</td>
</tr>

<tr>
<td>child 8329</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/13680615caa790c4ae73ea82db5fb7f059b897ba">13680615caa790c4ae73ea82db5fb7f059b897ba</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=c0fa78af189d806b821b1e7b38992a6af7cd961b">6395</a></td></tr>
<tr><td>push user</td><td>sid.bugzilla@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Thu, 18 Aug 2011 09:17:05 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@c0fa78af189d [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=c0fa78af189d806b821b1e7b38992a6af7cd961b">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=c0fa78af189d806b821b1e7b38992a6af7cd961b&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c0fa78af189d806b821b1e7b38992a6af7cd961b&newProject=comm-central&newRevision=790cc2369783c05a19a3c87f41ec88c0c2b8bbbb&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c0fa78af189d806b821b1e7b38992a6af7cd961b&newProject=comm-central&newRevision=790cc2369783c05a19a3c87f41ec88c0c2b8bbbb&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c0fa78af189d806b821b1e7b38992a6af7cd961b&newProject=comm-central&newRevision=790cc2369783c05a19a3c87f41ec88c0c2b8bbbb&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28bienvenu%29&revcount=50">bienvenu</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=662960">662960</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=662960">Bug 662960</a> - MozMill: replace uses of waitForEval with waitFor. r=bienvenu+bwinton</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/account/test-mail-account-setup-wizard.js">mail/test/mozmill/account/test-mail-account-setup-wizard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/account/test-mail-account-setup-wizard.js">file</a> |
<a href="/comm-central/annotate/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/account/test-mail-account-setup-wizard.js">annotate</a> |
<a href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/account/test-mail-account-setup-wizard.js">diff</a> |
<a href="/comm-central/comparison/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/account/test-mail-account-setup-wizard.js">comparison</a> |
<a href="/comm-central/log/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/account/test-mail-account-setup-wizard.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/account/test-retest-config.js">mail/test/mozmill/account/test-retest-config.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/account/test-retest-config.js">file</a> |
<a href="/comm-central/annotate/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/account/test-retest-config.js">annotate</a> |
<a href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/account/test-retest-config.js">diff</a> |
<a href="/comm-central/comparison/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/account/test-retest-config.js">comparison</a> |
<a href="/comm-central/log/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/account/test-retest-config.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/addrbook/test-address-book.js">mail/test/mozmill/addrbook/test-address-book.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/addrbook/test-address-book.js">file</a> |
<a href="/comm-central/annotate/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/addrbook/test-address-book.js">annotate</a> |
<a href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/addrbook/test-address-book.js">diff</a> |
<a href="/comm-central/comparison/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/addrbook/test-address-book.js">comparison</a> |
<a href="/comm-central/log/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/addrbook/test-address-book.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/composition/test-forward-headers.js">mail/test/mozmill/composition/test-forward-headers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/composition/test-forward-headers.js">file</a> |
<a href="/comm-central/annotate/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/composition/test-forward-headers.js">annotate</a> |
<a href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/composition/test-forward-headers.js">diff</a> |
<a href="/comm-central/comparison/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/composition/test-forward-headers.js">comparison</a> |
<a href="/comm-central/log/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/composition/test-forward-headers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-policy/test-compose-mailto.js">mail/test/mozmill/content-policy/test-compose-mailto.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-policy/test-compose-mailto.js">file</a> |
<a href="/comm-central/annotate/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-policy/test-compose-mailto.js">annotate</a> |
<a href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-policy/test-compose-mailto.js">diff</a> |
<a href="/comm-central/comparison/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-policy/test-compose-mailto.js">comparison</a> |
<a href="/comm-central/log/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-policy/test-compose-mailto.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-policy/test-dns-prefetch.js">mail/test/mozmill/content-policy/test-dns-prefetch.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-policy/test-dns-prefetch.js">file</a> |
<a href="/comm-central/annotate/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-policy/test-dns-prefetch.js">annotate</a> |
<a href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-policy/test-dns-prefetch.js">diff</a> |
<a href="/comm-central/comparison/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-policy/test-dns-prefetch.js">comparison</a> |
<a href="/comm-central/log/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-policy/test-dns-prefetch.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-policy/test-exposed-in-content-tabs.js">mail/test/mozmill/content-policy/test-exposed-in-content-tabs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-policy/test-exposed-in-content-tabs.js">file</a> |
<a href="/comm-central/annotate/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-policy/test-exposed-in-content-tabs.js">annotate</a> |
<a href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-policy/test-exposed-in-content-tabs.js">diff</a> |
<a href="/comm-central/comparison/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-policy/test-exposed-in-content-tabs.js">comparison</a> |
<a href="/comm-central/log/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-policy/test-exposed-in-content-tabs.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-policy/test-general-content-policy.js">mail/test/mozmill/content-policy/test-general-content-policy.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-policy/test-general-content-policy.js">file</a> |
<a href="/comm-central/annotate/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-policy/test-general-content-policy.js">annotate</a> |
<a href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-policy/test-general-content-policy.js">diff</a> |
<a href="/comm-central/comparison/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-policy/test-general-content-policy.js">comparison</a> |
<a href="/comm-central/log/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-policy/test-general-content-policy.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-policy/test-plugins-policy.js">mail/test/mozmill/content-policy/test-plugins-policy.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-policy/test-plugins-policy.js">file</a> |
<a href="/comm-central/annotate/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-policy/test-plugins-policy.js">annotate</a> |
<a href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-policy/test-plugins-policy.js">diff</a> |
<a href="/comm-central/comparison/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-policy/test-plugins-policy.js">comparison</a> |
<a href="/comm-central/log/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-policy/test-plugins-policy.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-tabs/test-about-support.js">mail/test/mozmill/content-tabs/test-about-support.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-tabs/test-about-support.js">file</a> |
<a href="/comm-central/annotate/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-tabs/test-about-support.js">annotate</a> |
<a href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-tabs/test-about-support.js">diff</a> |
<a href="/comm-central/comparison/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-tabs/test-about-support.js">comparison</a> |
<a href="/comm-central/log/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-tabs/test-about-support.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-tabs/test-install-xpi.js">mail/test/mozmill/content-tabs/test-install-xpi.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-tabs/test-install-xpi.js">file</a> |
<a href="/comm-central/annotate/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-tabs/test-install-xpi.js">annotate</a> |
<a href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-tabs/test-install-xpi.js">diff</a> |
<a href="/comm-central/comparison/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-tabs/test-install-xpi.js">comparison</a> |
<a href="/comm-central/log/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-tabs/test-install-xpi.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-tabs/test-lwthemes.js">mail/test/mozmill/content-tabs/test-lwthemes.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-tabs/test-lwthemes.js">file</a> |
<a href="/comm-central/annotate/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-tabs/test-lwthemes.js">annotate</a> |
<a href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-tabs/test-lwthemes.js">diff</a> |
<a href="/comm-central/comparison/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-tabs/test-lwthemes.js">comparison</a> |
<a href="/comm-central/log/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/content-tabs/test-lwthemes.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/cookies/test-cookies.js">mail/test/mozmill/cookies/test-cookies.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/cookies/test-cookies.js">file</a> |
<a href="/comm-central/annotate/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/cookies/test-cookies.js">annotate</a> |
<a href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/cookies/test-cookies.js">diff</a> |
<a href="/comm-central/comparison/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/cookies/test-cookies.js">comparison</a> |
<a href="/comm-central/log/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/cookies/test-cookies.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/folder-display/test-recent-menu.js">mail/test/mozmill/folder-display/test-recent-menu.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/folder-display/test-recent-menu.js">file</a> |
<a href="/comm-central/annotate/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/folder-display/test-recent-menu.js">annotate</a> |
<a href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/folder-display/test-recent-menu.js">diff</a> |
<a href="/comm-central/comparison/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/folder-display/test-recent-menu.js">comparison</a> |
<a href="/comm-central/log/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/folder-display/test-recent-menu.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/folder-display/test-savedsearch-reload-after-compact.js">mail/test/mozmill/folder-display/test-savedsearch-reload-after-compact.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/folder-display/test-savedsearch-reload-after-compact.js">file</a> |
<a href="/comm-central/annotate/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/folder-display/test-savedsearch-reload-after-compact.js">annotate</a> |
<a href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/folder-display/test-savedsearch-reload-after-compact.js">diff</a> |
<a href="/comm-central/comparison/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/folder-display/test-savedsearch-reload-after-compact.js">comparison</a> |
<a href="/comm-central/log/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/folder-display/test-savedsearch-reload-after-compact.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/instrumentation/test-instrument-setup.js">mail/test/mozmill/instrumentation/test-instrument-setup.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/instrumentation/test-instrument-setup.js">file</a> |
<a href="/comm-central/annotate/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/instrumentation/test-instrument-setup.js">annotate</a> |
<a href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/instrumentation/test-instrument-setup.js">diff</a> |
<a href="/comm-central/comparison/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/instrumentation/test-instrument-setup.js">comparison</a> |
<a href="/comm-central/log/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/instrumentation/test-instrument-setup.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/quick-filter-bar/test-display-issues.js">mail/test/mozmill/quick-filter-bar/test-display-issues.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/quick-filter-bar/test-display-issues.js">file</a> |
<a href="/comm-central/annotate/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/quick-filter-bar/test-display-issues.js">annotate</a> |
<a href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/quick-filter-bar/test-display-issues.js">diff</a> |
<a href="/comm-central/comparison/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/quick-filter-bar/test-display-issues.js">comparison</a> |
<a href="/comm-central/log/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/quick-filter-bar/test-display-issues.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/shared-modules/test-account-manager-helpers.js">mail/test/mozmill/shared-modules/test-account-manager-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/shared-modules/test-account-manager-helpers.js">file</a> |
<a href="/comm-central/annotate/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/shared-modules/test-account-manager-helpers.js">annotate</a> |
<a href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/shared-modules/test-account-manager-helpers.js">diff</a> |
<a href="/comm-central/comparison/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/shared-modules/test-account-manager-helpers.js">comparison</a> |
<a href="/comm-central/log/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/shared-modules/test-account-manager-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/shared-modules/test-compose-helpers.js">mail/test/mozmill/shared-modules/test-compose-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/shared-modules/test-compose-helpers.js">file</a> |
<a href="/comm-central/annotate/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/shared-modules/test-compose-helpers.js">annotate</a> |
<a href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/shared-modules/test-compose-helpers.js">diff</a> |
<a href="/comm-central/comparison/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/shared-modules/test-compose-helpers.js">comparison</a> |
<a href="/comm-central/log/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/shared-modules/test-compose-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/shared-modules/test-content-tab-helpers.js">mail/test/mozmill/shared-modules/test-content-tab-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/shared-modules/test-content-tab-helpers.js">file</a> |
<a href="/comm-central/annotate/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/shared-modules/test-content-tab-helpers.js">annotate</a> |
<a href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/shared-modules/test-content-tab-helpers.js">diff</a> |
<a href="/comm-central/comparison/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/shared-modules/test-content-tab-helpers.js">comparison</a> |
<a href="/comm-central/log/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/shared-modules/test-content-tab-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">mail/test/mozmill/shared-modules/test-folder-display-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">file</a> |
<a href="/comm-central/annotate/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">annotate</a> |
<a href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">diff</a> |
<a href="/comm-central/comparison/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">comparison</a> |
<a href="/comm-central/log/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/shared-modules/test-junk-helpers.js">mail/test/mozmill/shared-modules/test-junk-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/shared-modules/test-junk-helpers.js">file</a> |
<a href="/comm-central/annotate/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/shared-modules/test-junk-helpers.js">annotate</a> |
<a href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/shared-modules/test-junk-helpers.js">diff</a> |
<a href="/comm-central/comparison/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/shared-modules/test-junk-helpers.js">comparison</a> |
<a href="/comm-central/log/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/shared-modules/test-junk-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/shared-modules/test-pref-window-helpers.js">mail/test/mozmill/shared-modules/test-pref-window-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/shared-modules/test-pref-window-helpers.js">file</a> |
<a href="/comm-central/annotate/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/shared-modules/test-pref-window-helpers.js">annotate</a> |
<a href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/shared-modules/test-pref-window-helpers.js">diff</a> |
<a href="/comm-central/comparison/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/shared-modules/test-pref-window-helpers.js">comparison</a> |
<a href="/comm-central/log/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/shared-modules/test-pref-window-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/shared-modules/test-window-helpers.js">mail/test/mozmill/shared-modules/test-window-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/shared-modules/test-window-helpers.js">file</a> |
<a href="/comm-central/annotate/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/shared-modules/test-window-helpers.js">annotate</a> |
<a href="/comm-central/diff/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/shared-modules/test-window-helpers.js">diff</a> |
<a href="/comm-central/comparison/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/shared-modules/test-window-helpers.js">comparison</a> |
<a href="/comm-central/log/c0fa78af189d806b821b1e7b38992a6af7cd961b/mail/test/mozmill/shared-modules/test-window-helpers.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/test/mozmill/account/test-mail-account-setup-wizard.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/test/mozmill/account/test-mail-account-setup-wizard.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -117,32 +117,34 @@ function test_mail_account_setup() {</span>
<a href="#l1.4"></a><span id="l1.4">     input_value(awc, user.password);</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6">     // Load the autoconfig file from http://localhost:433**/autoconfig/example.com</span>
<a href="#l1.7"></a><span id="l1.7">     awc.e(&quot;next_button&quot;).click();</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9">     let config = null;</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11">     // XXX: This should probably use a notification, once we fix bug 561143.</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    awc.waitForEval(&quot;subject._currentConfig != null&quot;, 8000, 600,</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-                    awc.window.gEmailConfigWizard);</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+    awc.waitFor(function () (awc.window.gEmailConfigWizard._currentConfig != null),</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+                &quot;Timeout waiting for current config to become non-null&quot;,</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+                8000, 600);</span>
<a href="#l1.17"></a><span id="l1.17">     config = awc.window.gEmailConfigWizard.getConcreteConfig();</span>
<a href="#l1.18"></a><span id="l1.18"> </span>
<a href="#l1.19"></a><span id="l1.19">     // Open the advanced settings (Account Manager) to create the account</span>
<a href="#l1.20"></a><span id="l1.20">     // immediately.  We use an invalid email/password so the setup will fail</span>
<a href="#l1.21"></a><span id="l1.21">     // anyway.</span>
<a href="#l1.22"></a><span id="l1.22">     open_advanced_settings_from_account_wizard(subtest_verify_account, awc);</span>
<a href="#l1.23"></a><span id="l1.23"> </span>
<a href="#l1.24"></a><span id="l1.24">     // Clean up</span>
<a href="#l1.25"></a><span id="l1.25">     pref.clearUserPref(pref_name);</span>
<a href="#l1.26"></a><span id="l1.26">   });</span>
<a href="#l1.27"></a><span id="l1.27"> }</span>
<a href="#l1.28"></a><span id="l1.28"> </span>
<a href="#l1.29"></a><span id="l1.29"> function subtest_verify_account(amc) {</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-  amc.waitForEval(&quot;subject.currentAccount != null&quot;, 6000, 600, amc.window);</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+  amc.waitFor(function () (amc.window.currentAccount != null),</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+              &quot;Timeout waiting for currentAccount to become non-null&quot;);</span>
<a href="#l1.33"></a><span id="l1.33">   account = amc.window.currentAccount;</span>
<a href="#l1.34"></a><span id="l1.34">   let identity = account.defaultIdentity;</span>
<a href="#l1.35"></a><span id="l1.35">   incoming = account.incomingServer;</span>
<a href="#l1.36"></a><span id="l1.36">   outgoing = amc.window.smtpService.getServerByKey(identity.smtpServerKey);</span>
<a href="#l1.37"></a><span id="l1.37"> </span>
<a href="#l1.38"></a><span id="l1.38">   let config = {</span>
<a href="#l1.39"></a><span id="l1.39">     &quot;incoming server username&quot;: {</span>
<a href="#l1.40"></a><span id="l1.40">       actual: incoming.username, expected: user.email.split(&quot;@&quot;)[0]</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineat">@@ -203,22 +205,24 @@ function test_bad_password_uses_old_sett</span>
<a href="#l1.42"></a><span id="l1.42">       awc.keypress(null, &quot;VK_TAB&quot;, {});</span>
<a href="#l1.43"></a><span id="l1.43">       input_value(awc, user.password);</span>
<a href="#l1.44"></a><span id="l1.44"> </span>
<a href="#l1.45"></a><span id="l1.45">       // Load the autoconfig file from http://localhost:433**/autoconfig/example.com</span>
<a href="#l1.46"></a><span id="l1.46">       awc.e(&quot;next_button&quot;).click();</span>
<a href="#l1.47"></a><span id="l1.47"> </span>
<a href="#l1.48"></a><span id="l1.48">       let config = null;</span>
<a href="#l1.49"></a><span id="l1.49"> </span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-      awc.waitForEval(&quot;subject.disabled == false &amp;&amp; subject.hidden == false&quot;,</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineminus">-                      8000, 600, awc.e(&quot;create_button&quot;));</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+      awc.waitFor(function () (this.disabled == false &amp;&amp; this.hidden == false),</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+                  &quot;Timeout waiting for create button to be visible and active&quot;,</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+                  8000, 600, awc.e(&quot;create_button&quot;));</span>
<a href="#l1.55"></a><span id="l1.55">       awc.e(&quot;create_button&quot;).click();</span>
<a href="#l1.56"></a><span id="l1.56"> </span>
<a href="#l1.57"></a><span id="l1.57" class="difflineminus">-      awc.waitForEval(&quot;subject.disabled == false&quot;, 8000, 600,</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineminus">-                      awc.e(&quot;create_button&quot;));</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+      awc.waitFor(function () (this.disabled == false),</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+                  &quot;Timeout waiting for create button to be visible and active&quot;,</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+                  8000, 600, awc.e(&quot;create_button&quot;));</span>
<a href="#l1.62"></a><span id="l1.62">       awc.e(&quot;create_button&quot;).click();</span>
<a href="#l1.63"></a><span id="l1.63">       awc.e(&quot;manual-edit_button&quot;).click();</span>
<a href="#l1.64"></a><span id="l1.64"> </span>
<a href="#l1.65"></a><span id="l1.65">       // Make sure all the values are the same as in the user object.</span>
<a href="#l1.66"></a><span id="l1.66">       awc.sleep(1000);</span>
<a href="#l1.67"></a><span id="l1.67">       assert_equals(awc.e(&quot;outgoing_hostname&quot;).value, user.outgoingHost,</span>
<a href="#l1.68"></a><span id="l1.68">                     &quot;Outgoing server changed!&quot;);</span>
<a href="#l1.69"></a><span id="l1.69">       assert_equals(awc.e(&quot;incoming_hostname&quot;).value, user.incomingHost,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/test/mozmill/account/test-retest-config.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/test/mozmill/account/test-retest-config.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -85,38 +85,41 @@ function test_re_test_config() {</span>
<a href="#l2.4"></a><span id="l2.4">     input_value(awc, user.name);</span>
<a href="#l2.5"></a><span id="l2.5">     awc.keypress(null, &quot;VK_TAB&quot;, {});</span>
<a href="#l2.6"></a><span id="l2.6">     input_value(awc, user.email);</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8">     // Click &quot;continue&quot; button</span>
<a href="#l2.9"></a><span id="l2.9">     awc.e(&quot;next_button&quot;).click();</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11">     // Wait for 'edit' button to be enabled</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-    awc.waitForEval(&quot;subject.disabled == false &amp;&amp; subject.hidden == false&quot;,</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-                    8000, 600, awc.e(&quot;create_button&quot;));</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+    awc.waitFor(function () (this.disabled == false &amp;&amp; this.hidden == false),</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+                &quot;Timeout waiting for edit button to be enabled&quot;,</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+                8000, 600, awc.e(&quot;create_button&quot;));</span>
<a href="#l2.17"></a><span id="l2.17"> </span>
<a href="#l2.18"></a><span id="l2.18">     awc.e(&quot;manual-edit_button&quot;).click();</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20">     // Click &quot;re-test&quot; button</span>
<a href="#l2.21"></a><span id="l2.21">     awc.e(&quot;half-manual-test_button&quot;).click();</span>
<a href="#l2.22"></a><span id="l2.22"> </span>
<a href="#l2.23"></a><span id="l2.23" class="difflineminus">-    awc.waitForEval(&quot;subject.disabled == false&quot;, 20000, 600,</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineminus">-                    awc.e(&quot;half-manual-test_button&quot;));</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+    awc.waitFor(function () (this.disabled == false),</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+                &quot;Timeout waiting for re-test button to be enabled&quot;,</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+                20000, 600, awc.e(&quot;half-manual-test_button&quot;));</span>
<a href="#l2.28"></a><span id="l2.28"> </span>
<a href="#l2.29"></a><span id="l2.29">     // There used to be a &quot;start over&quot; button (line commented out below). Now just</span>
<a href="#l2.30"></a><span id="l2.30">     // changing the value of the email field does the trick.</span>
<a href="#l2.31"></a><span id="l2.31">     awc.e(&quot;realname&quot;).focus();</span>
<a href="#l2.32"></a><span id="l2.32">     awc.keypress(null, &quot;VK_TAB&quot;, {});</span>
<a href="#l2.33"></a><span id="l2.33">     input_value(awc, user.altEmail);</span>
<a href="#l2.34"></a><span id="l2.34">     awc.keypress(null, &quot;VK_TAB&quot;, {});</span>
<a href="#l2.35"></a><span id="l2.35"> </span>
<a href="#l2.36"></a><span id="l2.36">     // Wait for the &quot;continue&quot; button to be back, which means we're back to the</span>
<a href="#l2.37"></a><span id="l2.37">     // original state.</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">-    awc.waitForEval(&quot;subject.hidden == false&quot;, 20000, 600,</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-                    awc.e(&quot;next_button&quot;));</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+    awc.waitFor(function () (this.hidden == false),</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+                &quot;Timeout waiting for continue button to be visible&quot;,</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+                20000, 600, awc.e(&quot;next_button&quot;));</span>
<a href="#l2.43"></a><span id="l2.43"> </span>
<a href="#l2.44"></a><span id="l2.44">     awc.e(&quot;next_button&quot;).click();</span>
<a href="#l2.45"></a><span id="l2.45"> </span>
<a href="#l2.46"></a><span id="l2.46">     // Previously, we'd switched to the manual editing state. Now we've started</span>
<a href="#l2.47"></a><span id="l2.47">     // over, we should make sure the information is presented back in its original</span>
<a href="#l2.48"></a><span id="l2.48">     // &quot;automatic&quot; mode.</span>
<a href="#l2.49"></a><span id="l2.49">     assert_true(!awc.e(&quot;manual-edit_button&quot;).hidden,</span>
<a href="#l2.50"></a><span id="l2.50">       &quot;We're not back to the original state!&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/test/mozmill/addrbook/test-address-book.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/test/mozmill/addrbook/test-address-book.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -119,18 +119,20 @@ function setupModule(module)</span>
<a href="#l3.4"></a><span id="l3.4">   addrBook3.addMailList(mListC);</span>
<a href="#l3.5"></a><span id="l3.5"> </span>
<a href="#l3.6"></a><span id="l3.6">   mListD = create_mailing_list(&quot;ML D&quot;);</span>
<a href="#l3.7"></a><span id="l3.7">   addrBook3.addMailList(mListD);</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9">   // There are 7 address books (Personal, AB 1, AB 2, AB 3, AB 4, LDAP Book</span>
<a href="#l3.10"></a><span id="l3.10">   // and Collected Address Book.  So let's ensure that those address books</span>
<a href="#l3.11"></a><span id="l3.11">   // exist in the tree view before executing our tests.</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  abController.waitForEval(&quot;subject.window.gDirectoryTreeView.rowCount == 7&quot;,</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-                           1000, 10, abController);</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+  abController.waitFor(</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+    function () (abController.window.gDirectoryTreeView.rowCount == 7),</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+    &quot;Timeout waiting for all 7 address books to show up in the tree view&quot;,</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+    1000, 10);</span>
<a href="#l3.18"></a><span id="l3.18"> }</span>
<a href="#l3.19"></a><span id="l3.19"> </span>
<a href="#l3.20"></a><span id="l3.20"> /* Test that the address book manager automatically sorts</span>
<a href="#l3.21"></a><span id="l3.21">  * address books.</span>
<a href="#l3.22"></a><span id="l3.22">  *</span>
<a href="#l3.23"></a><span id="l3.23">  * Currently, we sort address books as follows:</span>
<a href="#l3.24"></a><span id="l3.24">  * 1. Personal Address Book</span>
<a href="#l3.25"></a><span id="l3.25">  * 2. Mork Address Books</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-forward-headers.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-forward-headers.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -111,17 +111,18 @@ function test_forward_inline () {</span>
<a href="#l4.4"></a><span id="l4.4">   let done = {};</span>
<a href="#l4.5"></a><span id="l4.5">   mc.window.MsgHdrToMimeMessage(fMsgHdr, function(aMsgHdr, aMimeMsg) {</span>
<a href="#l4.6"></a><span id="l4.6">     assert_equals(aMimeMsg.headers[&quot;x-forwarded-message-id&quot;],</span>
<a href="#l4.7"></a><span id="l4.7">       &quot;&lt;&quot;+oMsgHdr.messageId+&quot;&gt;&quot;);</span>
<a href="#l4.8"></a><span id="l4.8">     assert_equals(aMimeMsg.headers[&quot;references&quot;],</span>
<a href="#l4.9"></a><span id="l4.9">       &quot;&lt;&quot;+oMsgHdr.messageId+&quot;&gt;&quot;);</span>
<a href="#l4.10"></a><span id="l4.10">     done.value = true;</span>
<a href="#l4.11"></a><span id="l4.11">   });</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  mc.waitForEval(&quot;subject.value==true&quot;, 30000, 100, done);</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+  mc.waitFor(function () done.value == true,</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+             &quot;Timeout waiting for message to be streamed&quot;, 30000, 100);</span>
<a href="#l4.15"></a><span id="l4.15"> </span>
<a href="#l4.16"></a><span id="l4.16">   press_delete(mc);</span>
<a href="#l4.17"></a><span id="l4.17"> }</span>
<a href="#l4.18"></a><span id="l4.18"> </span>
<a href="#l4.19"></a><span id="l4.19"> function test_forward_as_attachments () {</span>
<a href="#l4.20"></a><span id="l4.20">   be_in_folder(folder);</span>
<a href="#l4.21"></a><span id="l4.21">   // original message header</span>
<a href="#l4.22"></a><span id="l4.22">   let oMsgHdr0 = select_click_row(0);</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineat">@@ -143,12 +144,13 @@ function test_forward_as_attachments () </span>
<a href="#l4.24"></a><span id="l4.24">   let done = {};</span>
<a href="#l4.25"></a><span id="l4.25">   mc.window.MsgHdrToMimeMessage(fMsgHdr, function(aMsgHdr, aMimeMsg) {</span>
<a href="#l4.26"></a><span id="l4.26">     assert_equals(aMimeMsg.headers[&quot;x-forwarded-message-id&quot;],</span>
<a href="#l4.27"></a><span id="l4.27">       &quot;&lt;&quot;+oMsgHdr0.messageId+&quot;&gt; &lt;&quot;+oMsgHdr1.messageId+&quot;&gt;&quot;);</span>
<a href="#l4.28"></a><span id="l4.28">     assert_equals(aMimeMsg.headers[&quot;references&quot;],</span>
<a href="#l4.29"></a><span id="l4.29">       &quot;&lt;&quot;+oMsgHdr0.messageId+&quot;&gt; &lt;&quot;+oMsgHdr1.messageId+&quot;&gt;&quot;);</span>
<a href="#l4.30"></a><span id="l4.30">     done.value = true;</span>
<a href="#l4.31"></a><span id="l4.31">   });</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-  mc.waitForEval(&quot;subject.value==true&quot;, 30000, 100, done);</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+  mc.waitFor(function () done.value == true,</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+             &quot;Timeout waiting for message to be streamed&quot;, 30000, 100);</span>
<a href="#l4.35"></a><span id="l4.35"> </span>
<a href="#l4.36"></a><span id="l4.36">   press_delete(mc);</span>
<a href="#l4.37"></a><span id="l4.37"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/test/mozmill/content-policy/test-compose-mailto.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/test/mozmill/content-policy/test-compose-mailto.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -34,17 +34,18 @@</span>
<a href="#l5.4"></a><span id="l5.4">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l5.5"></a><span id="l5.5">  *</span>
<a href="#l5.6"></a><span id="l5.6">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8"> var MODULE_NAME = 'test-compose-mailto';</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10"> var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l5.11"></a><span id="l5.11"> var MODULE_REQUIRES = ['folder-display-helpers', 'compose-helpers',</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-                       'window-helpers', 'keyboard-helpers'];</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+                       'window-helpers', 'keyboard-helpers',</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+                       'content-tab-helpers'];</span>
<a href="#l5.15"></a><span id="l5.15"> var jumlib = {};</span>
<a href="#l5.16"></a><span id="l5.16"> Components.utils.import(&quot;resource://mozmill/modules/jum.js&quot;, jumlib);</span>
<a href="#l5.17"></a><span id="l5.17"> var elib = {};</span>
<a href="#l5.18"></a><span id="l5.18"> Components.utils.import('resource://mozmill/modules/elementslib.js', elib);</span>
<a href="#l5.19"></a><span id="l5.19"> </span>
<a href="#l5.20"></a><span id="l5.20"> var folder = null;</span>
<a href="#l5.21"></a><span id="l5.21"> var composeHelper = null;</span>
<a href="#l5.22"></a><span id="l5.22"> var windowHelper = null;</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineat">@@ -61,31 +62,26 @@ var setupModule = function (module) {</span>
<a href="#l5.24"></a><span id="l5.24">   let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l5.25"></a><span id="l5.25">   fdh.installInto(module);</span>
<a href="#l5.26"></a><span id="l5.26">   let kh = collector.getModule('keyboard-helpers');</span>
<a href="#l5.27"></a><span id="l5.27">   kh.installInto(module);</span>
<a href="#l5.28"></a><span id="l5.28">   composeHelper = collector.getModule('compose-helpers');</span>
<a href="#l5.29"></a><span id="l5.29">   composeHelper.installInto(module);</span>
<a href="#l5.30"></a><span id="l5.30">   windowHelper = collector.getModule('window-helpers');</span>
<a href="#l5.31"></a><span id="l5.31">   windowHelper.installInto(module);</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+  let cth = collector.getModule(&quot;content-tab-helpers&quot;);</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+  cth.installInto(module);</span>
<a href="#l5.34"></a><span id="l5.34"> };</span>
<a href="#l5.35"></a><span id="l5.35"> </span>
<a href="#l5.36"></a><span id="l5.36"> function test_openComposeFromMailToLink() {</span>
<a href="#l5.37"></a><span id="l5.37">   // Open a content tab with the mailto link in it.</span>
<a href="#l5.38"></a><span id="l5.38">     // To open a tab we're going to have to cheat and use tabmail so we can load</span>
<a href="#l5.39"></a><span id="l5.39">   // in the data of what we want.</span>
<a href="#l5.40"></a><span id="l5.40">   gPreCount = mc.tabmail.tabContainer.childNodes.length;</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineminus">-</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineminus">-  gNewTab = mc.tabmail.openTab(&quot;contentTab&quot;, { contentPage: url + &quot;mailtolink.html&quot; });</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-  mc.waitForEval(&quot;subject.busy == false&quot;, 5000, 100, gNewTab);</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineminus">-</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineminus">-  if (mc.tabmail.tabContainer.childNodes.length != gPreCount + 1)</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineminus">-    throw new Error(&quot;The content tab didn't open&quot;);</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineminus">-</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+  gNewTab = open_content_tab_with_url(url + &quot;mailtolink.html&quot;);</span>
<a href="#l5.50"></a><span id="l5.50">   gComposeWin = composeHelper.open_compose_with_element_click(&quot;mailtolink&quot;);</span>
<a href="#l5.51"></a><span id="l5.51"> }</span>
<a href="#l5.52"></a><span id="l5.52"> </span>
<a href="#l5.53"></a><span id="l5.53"> function test_checkInsertImage() {</span>
<a href="#l5.54"></a><span id="l5.54">   // First focus on the editor element</span>
<a href="#l5.55"></a><span id="l5.55">   gComposeWin.e(&quot;content-frame&quot;).focus();</span>
<a href="#l5.56"></a><span id="l5.56"> </span>
<a href="#l5.57"></a><span id="l5.57">   // Now open the image window</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/test/mozmill/content-policy/test-dns-prefetch.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/test/mozmill/content-policy/test-dns-prefetch.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -42,17 +42,18 @@</span>
<a href="#l6.4"></a><span id="l6.4">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l6.5"></a><span id="l6.5">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l6.6"></a><span id="l6.6">  *</span>
<a href="#l6.7"></a><span id="l6.7">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9"> var MODULE_NAME = 'test-exposed-in-content-tabs';</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11"> var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'compose-helpers'];</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+var MODULE_REQUIRES = ['folder-display-helpers', 'compose-helpers',</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+                       'content-tab-helpers'];</span>
<a href="#l6.15"></a><span id="l6.15"> var jumlib = {};</span>
<a href="#l6.16"></a><span id="l6.16"> Components.utils.import(&quot;resource://mozmill/modules/jum.js&quot;, jumlib);</span>
<a href="#l6.17"></a><span id="l6.17"> var elib = {};</span>
<a href="#l6.18"></a><span id="l6.18"> Components.utils.import('resource://mozmill/modules/elementslib.js', elib);</span>
<a href="#l6.19"></a><span id="l6.19"> </span>
<a href="#l6.20"></a><span id="l6.20"> var folder = null;</span>
<a href="#l6.21"></a><span id="l6.21"> var composeHelper = null;</span>
<a href="#l6.22"></a><span id="l6.22"> var gMsgNo = 0;</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineat">@@ -69,16 +70,18 @@ const msgBody = '&lt;!DOCTYPE HTML PUBLIC &quot;</span>
<a href="#l6.24"></a><span id="l6.24"> 'dns prefetch test message\n' +</span>
<a href="#l6.25"></a><span id="l6.25"> '&lt;/body&gt;\n&lt;/html&gt;\n';</span>
<a href="#l6.26"></a><span id="l6.26"> </span>
<a href="#l6.27"></a><span id="l6.27"> var setupModule = function (module) {</span>
<a href="#l6.28"></a><span id="l6.28">   let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l6.29"></a><span id="l6.29">   fdh.installInto(module);</span>
<a href="#l6.30"></a><span id="l6.30">   composeHelper = collector.getModule('compose-helpers');</span>
<a href="#l6.31"></a><span id="l6.31">   composeHelper.installInto(module);</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+  let cth = collector.getModule('content-tab-helpers');</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+  cth.installInto(module);</span>
<a href="#l6.34"></a><span id="l6.34"> </span>
<a href="#l6.35"></a><span id="l6.35">   folder = create_folder(&quot;dnsPrefetch&quot;);</span>
<a href="#l6.36"></a><span id="l6.36"> };</span>
<a href="#l6.37"></a><span id="l6.37"> </span>
<a href="#l6.38"></a><span id="l6.38"> function addToFolder(aSubject, aBody, aFolder) {</span>
<a href="#l6.39"></a><span id="l6.39"> </span>
<a href="#l6.40"></a><span id="l6.40">   let msgId = Components.classes[&quot;@mozilla.org/uuid-generator;1&quot;]</span>
<a href="#l6.41"></a><span id="l6.41">                           .getService(Components.interfaces.nsIUUIDGenerator)</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineat">@@ -192,22 +195,17 @@ function test_dnsPrefetch_compose() {</span>
<a href="#l6.43"></a><span id="l6.43"> function test_dnsPrefetch_contentTab() {</span>
<a href="#l6.44"></a><span id="l6.44">   // To open a tab we're going to have to cheat and use tabmail so we can load</span>
<a href="#l6.45"></a><span id="l6.45">   // in the data of what we want.</span>
<a href="#l6.46"></a><span id="l6.46">   let preCount = mc.tabmail.tabContainer.childNodes.length;</span>
<a href="#l6.47"></a><span id="l6.47"> </span>
<a href="#l6.48"></a><span id="l6.48">   let dataurl = 'data:text/html,&lt;html&gt;&lt;head&gt;&lt;title&gt;test dns prefetch&lt;/title&gt;' +</span>
<a href="#l6.49"></a><span id="l6.49">     '&lt;/head&gt;&lt;body&gt;test dns prefetch&lt;/body&gt;&lt;/html&gt;';</span>
<a href="#l6.50"></a><span id="l6.50"> </span>
<a href="#l6.51"></a><span id="l6.51" class="difflineminus">-  let newTab = mc.tabmail.openTab(&quot;contentTab&quot;, { contentPage: dataurl });</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineminus">-</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineminus">-  mc.waitForEval(&quot;subject.busy == false&quot;, 5000, 100, newTab);</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineminus">-</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineminus">-  if (mc.tabmail.tabContainer.childNodes.length != preCount + 1)</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineminus">-    throw new Error(&quot;The content tab didn't open&quot;);</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+  let newTab = open_content_tab_with_url(dataurl);</span>
<a href="#l6.58"></a><span id="l6.58"> </span>
<a href="#l6.59"></a><span id="l6.59">   // XXX this should be a check for DNS prefetch being enabled, but bug 545407</span>
<a href="#l6.60"></a><span id="l6.60">   // needs fixing for that to work.</span>
<a href="#l6.61"></a><span id="l6.61">   var versionChecker =</span>
<a href="#l6.62"></a><span id="l6.62">     Components.classes[&quot;@mozilla.org/xpcom/version-comparator;1&quot;]</span>
<a href="#l6.63"></a><span id="l6.63">               .getService(Components.interfaces.nsIVersionComparator);</span>
<a href="#l6.64"></a><span id="l6.64"> </span>
<a href="#l6.65"></a><span id="l6.65">   if (versionChecker.compare(mc.window.Application.version, &quot;3.2a1pre&quot;) &gt;= 0) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/test/mozmill/content-policy/test-exposed-in-content-tabs.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/test/mozmill/content-policy/test-exposed-in-content-tabs.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -40,17 +40,18 @@</span>
<a href="#l7.4"></a><span id="l7.4">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l7.5"></a><span id="l7.5">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l7.6"></a><span id="l7.6">  *</span>
<a href="#l7.7"></a><span id="l7.7">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9"> var MODULE_NAME = 'test-exposed-in-content-tabs';</span>
<a href="#l7.10"></a><span id="l7.10"> </span>
<a href="#l7.11"></a><span id="l7.11"> var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'compose-helpers'];</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+var MODULE_REQUIRES = ['folder-display-helpers', 'compose-helpers',</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+                       'content-tab-helpers'];</span>
<a href="#l7.15"></a><span id="l7.15"> var jumlib = {};</span>
<a href="#l7.16"></a><span id="l7.16"> Components.utils.import(&quot;resource://mozmill/modules/jum.js&quot;, jumlib);</span>
<a href="#l7.17"></a><span id="l7.17"> var elib = {};</span>
<a href="#l7.18"></a><span id="l7.18"> Components.utils.import('resource://mozmill/modules/elementslib.js', elib);</span>
<a href="#l7.19"></a><span id="l7.19"> </span>
<a href="#l7.20"></a><span id="l7.20"> var folder = null;</span>
<a href="#l7.21"></a><span id="l7.21"> var composeHelper = null;</span>
<a href="#l7.22"></a><span id="l7.22"> var gMsgNo = 0;</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineat">@@ -70,16 +71,18 @@ const msgBody = '&lt;!DOCTYPE HTML PUBLIC &quot;</span>
<a href="#l7.24"></a><span id="l7.24"> '&lt;img id=&quot;testelement&quot; src=&quot;' + url + 'pass.png&quot;/&gt;\n' +</span>
<a href="#l7.25"></a><span id="l7.25"> '&lt;/body&gt;\n&lt;/html&gt;\n';</span>
<a href="#l7.26"></a><span id="l7.26"> </span>
<a href="#l7.27"></a><span id="l7.27"> var setupModule = function (module) {</span>
<a href="#l7.28"></a><span id="l7.28">   let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l7.29"></a><span id="l7.29">   fdh.installInto(module);</span>
<a href="#l7.30"></a><span id="l7.30">   composeHelper = collector.getModule('compose-helpers');</span>
<a href="#l7.31"></a><span id="l7.31">   composeHelper.installInto(module);</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+  let cth = collector.getModule('content-tab-helpers');</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+  cth.installInto(module);</span>
<a href="#l7.34"></a><span id="l7.34"> </span>
<a href="#l7.35"></a><span id="l7.35">   folder = create_folder(&quot;exposedInContent&quot;);</span>
<a href="#l7.36"></a><span id="l7.36"> };</span>
<a href="#l7.37"></a><span id="l7.37"> </span>
<a href="#l7.38"></a><span id="l7.38"> function addToFolder(aSubject, aBody, aFolder) {</span>
<a href="#l7.39"></a><span id="l7.39"> </span>
<a href="#l7.40"></a><span id="l7.40">   let msgId = Components.classes[&quot;@mozilla.org/uuid-generator;1&quot;]</span>
<a href="#l7.41"></a><span id="l7.41">                           .getService(Components.interfaces.nsIUUIDGenerator)</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineat">@@ -140,22 +143,17 @@ function addMsgToFolder(folder) {</span>
<a href="#l7.43"></a><span id="l7.43"> function checkContentTab(msgURL) {</span>
<a href="#l7.44"></a><span id="l7.44">   // To open a tab we're going to have to cheat and use tabmail so we can load</span>
<a href="#l7.45"></a><span id="l7.45">   // in the data of what we want.</span>
<a href="#l7.46"></a><span id="l7.46">   let preCount = mc.tabmail.tabContainer.childNodes.length;</span>
<a href="#l7.47"></a><span id="l7.47"> </span>
<a href="#l7.48"></a><span id="l7.48">   let dataurl = 'data:text/html,&lt;html&gt;&lt;head&gt;&lt;title&gt;test exposed&lt;/title&gt;' +</span>
<a href="#l7.49"></a><span id="l7.49">     '&lt;/head&gt;&lt;body&gt;&lt;iframe id=&quot;msgIframe&quot; src=&quot;' + msgURL + '&quot;/&gt;&lt;/body&gt;&lt;/html&gt;';</span>
<a href="#l7.50"></a><span id="l7.50"> </span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-  let newTab = mc.tabmail.openTab(&quot;contentTab&quot;, { contentPage: dataurl });</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-  mc.waitForEval(&quot;subject.busy == false&quot;, 5000, 100, newTab);</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineminus">-  if (mc.tabmail.tabContainer.childNodes.length != preCount + 1)</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineminus">-    throw new Error(&quot;The content tab didn't open&quot;);</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+  let newTab = open_content_tab_with_url(dataurl);</span>
<a href="#l7.58"></a><span id="l7.58"> </span>
<a href="#l7.59"></a><span id="l7.59">   if (mc.window.content.document.getElementById(&quot;msgIframe&quot;)</span>
<a href="#l7.60"></a><span id="l7.60">         .contentDocument.URL != &quot;about:blank&quot;)</span>
<a href="#l7.61"></a><span id="l7.61">     throw new Error(&quot;Message display/access has not been blocked from remote content!&quot;);</span>
<a href="#l7.62"></a><span id="l7.62"> </span>
<a href="#l7.63"></a><span id="l7.63">   mc.tabmail.closeTab(newTab);</span>
<a href="#l7.64"></a><span id="l7.64"> </span>
<a href="#l7.65"></a><span id="l7.65">   if (mc.tabmail.tabContainer.childNodes.length != preCount)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/test/mozmill/content-policy/test-general-content-policy.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/test/mozmill/content-policy/test-general-content-policy.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -49,17 +49,18 @@</span>
<a href="#l8.4"></a><span id="l8.4">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l8.5"></a><span id="l8.5">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l8.6"></a><span id="l8.6">  *</span>
<a href="#l8.7"></a><span id="l8.7">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9"> var MODULE_NAME = 'test-general-content-policy';</span>
<a href="#l8.10"></a><span id="l8.10"> </span>
<a href="#l8.11"></a><span id="l8.11"> var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers', 'compose-helpers'];</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers',</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+                       'compose-helpers', 'content-tab-helpers'];</span>
<a href="#l8.15"></a><span id="l8.15"> var jumlib = {};</span>
<a href="#l8.16"></a><span id="l8.16"> Components.utils.import(&quot;resource://mozmill/modules/jum.js&quot;, jumlib);</span>
<a href="#l8.17"></a><span id="l8.17"> var elib = {};</span>
<a href="#l8.18"></a><span id="l8.18"> Components.utils.import('resource://mozmill/modules/elementslib.js', elib);</span>
<a href="#l8.19"></a><span id="l8.19"> </span>
<a href="#l8.20"></a><span id="l8.20"> var folder = null;</span>
<a href="#l8.21"></a><span id="l8.21"> var composeHelper = null;</span>
<a href="#l8.22"></a><span id="l8.22"> var gMsgNo = 0;</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineat">@@ -127,16 +128,18 @@ const msgBodyEnd = '&lt;/body&gt;\n&lt;/html&gt;\n';</span>
<a href="#l8.24"></a><span id="l8.24"> </span>
<a href="#l8.25"></a><span id="l8.25"> var setupModule = function (module) {</span>
<a href="#l8.26"></a><span id="l8.26">   let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l8.27"></a><span id="l8.27">   fdh.installInto(module);</span>
<a href="#l8.28"></a><span id="l8.28">   let wh = collector.getModule('window-helpers');</span>
<a href="#l8.29"></a><span id="l8.29">   wh.installInto(module);</span>
<a href="#l8.30"></a><span id="l8.30">   composeHelper = collector.getModule('compose-helpers');</span>
<a href="#l8.31"></a><span id="l8.31">   composeHelper.installInto(module);</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+  let cth = collector.getModule('content-tab-helpers');</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+  cth.installInto(module);</span>
<a href="#l8.34"></a><span id="l8.34"> </span>
<a href="#l8.35"></a><span id="l8.35">   folder = create_folder(&quot;generalContentPolicy&quot;);</span>
<a href="#l8.36"></a><span id="l8.36"> };</span>
<a href="#l8.37"></a><span id="l8.37"> </span>
<a href="#l8.38"></a><span id="l8.38"> function addToFolder(aSubject, aBody, aFolder) {</span>
<a href="#l8.39"></a><span id="l8.39"> </span>
<a href="#l8.40"></a><span id="l8.40">   let msgId = Components.classes[&quot;@mozilla.org/uuid-generator;1&quot;]</span>
<a href="#l8.41"></a><span id="l8.41">                           .getService(Components.interfaces.nsIUUIDGenerator)</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineat">@@ -248,22 +251,17 @@ function allowRemoteContentAndCheck(test</span>
<a href="#l8.43"></a><span id="l8.43">     throw new Error(test.type + &quot; has been unexpectedly blocked in message content&quot;);</span>
<a href="#l8.44"></a><span id="l8.44"> }</span>
<a href="#l8.45"></a><span id="l8.45"> </span>
<a href="#l8.46"></a><span id="l8.46"> function checkContentTab(test) {</span>
<a href="#l8.47"></a><span id="l8.47">   // To open a tab we're going to have to cheat and use tabmail so we can load</span>
<a href="#l8.48"></a><span id="l8.48">   // in the data of what we want.</span>
<a href="#l8.49"></a><span id="l8.49">   let preCount = mc.tabmail.tabContainer.childNodes.length;</span>
<a href="#l8.50"></a><span id="l8.50"> </span>
<a href="#l8.51"></a><span id="l8.51" class="difflineminus">-  let newTab = mc.tabmail.openTab(&quot;contentTab&quot;, { contentPage: url + test.webPage });</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineminus">-</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineminus">-  mc.waitForEval(&quot;subject.busy == false&quot;, 5000, 100, newTab);</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineminus">-</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineminus">-  if (mc.tabmail.tabContainer.childNodes.length != preCount + 1)</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineminus">-    throw new Error(&quot;The content tab didn't open&quot;);</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+  let newTab = open_content_tab_with_url(url + test.webPage);</span>
<a href="#l8.58"></a><span id="l8.58"> </span>
<a href="#l8.59"></a><span id="l8.59">   if (!test.checkForAllowed(mc.window.content.document</span>
<a href="#l8.60"></a><span id="l8.60">                               .getElementById(&quot;testelement&quot;)))</span>
<a href="#l8.61"></a><span id="l8.61">     throw new Error(test.type + &quot; has been unexpectedly blocked in content tab&quot;);</span>
<a href="#l8.62"></a><span id="l8.62"> </span>
<a href="#l8.63"></a><span id="l8.63">   mc.tabmail.closeTab(newTab);</span>
<a href="#l8.64"></a><span id="l8.64"> </span>
<a href="#l8.65"></a><span id="l8.65">   if (mc.tabmail.tabContainer.childNodes.length != preCount)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/test/mozmill/content-policy/test-plugins-policy.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/test/mozmill/content-policy/test-plugins-policy.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -40,17 +40,18 @@</span>
<a href="#l9.4"></a><span id="l9.4">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l9.5"></a><span id="l9.5">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l9.6"></a><span id="l9.6">  *</span>
<a href="#l9.7"></a><span id="l9.7">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l9.8"></a><span id="l9.8"> </span>
<a href="#l9.9"></a><span id="l9.9"> var MODULE_NAME = 'test-plugins-policy';</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11"> var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers', 'compose-helpers'];</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers',</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+                       'compose-helpers', 'content-tab-helpers'];</span>
<a href="#l9.15"></a><span id="l9.15"> var jumlib = {};</span>
<a href="#l9.16"></a><span id="l9.16"> Components.utils.import(&quot;resource://mozmill/modules/jum.js&quot;, jumlib);</span>
<a href="#l9.17"></a><span id="l9.17"> var elib = {};</span>
<a href="#l9.18"></a><span id="l9.18"> Components.utils.import('resource://mozmill/modules/elementslib.js', elib);</span>
<a href="#l9.19"></a><span id="l9.19"> </span>
<a href="#l9.20"></a><span id="l9.20"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l9.21"></a><span id="l9.21"> </span>
<a href="#l9.22"></a><span id="l9.22"> var folder = null;</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineat">@@ -74,16 +75,18 @@ const msgBody = '&lt;!DOCTYPE HTML PUBLIC &quot;</span>
<a href="#l9.24"></a><span id="l9.24"> </span>
<a href="#l9.25"></a><span id="l9.25"> var setupModule = function (module) {</span>
<a href="#l9.26"></a><span id="l9.26">   let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l9.27"></a><span id="l9.27">   fdh.installInto(module);</span>
<a href="#l9.28"></a><span id="l9.28">   let wh = collector.getModule('window-helpers');</span>
<a href="#l9.29"></a><span id="l9.29">   wh.installInto(module);</span>
<a href="#l9.30"></a><span id="l9.30">   composeHelper = collector.getModule('compose-helpers');</span>
<a href="#l9.31"></a><span id="l9.31">   composeHelper.installInto(module);</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+  let cth = collector.getModule('content-tab-helpers');</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+  cth.installInto(module);</span>
<a href="#l9.34"></a><span id="l9.34"> </span>
<a href="#l9.35"></a><span id="l9.35">   folder = create_folder(&quot;pluginPolicy&quot;);</span>
<a href="#l9.36"></a><span id="l9.36"> };</span>
<a href="#l9.37"></a><span id="l9.37"> </span>
<a href="#l9.38"></a><span id="l9.38"> function addToFolder(aSubject, aBody, aFolder) {</span>
<a href="#l9.39"></a><span id="l9.39">   let msgId = Components.classes[&quot;@mozilla.org/uuid-generator;1&quot;]</span>
<a href="#l9.40"></a><span id="l9.40">                           .getService(Components.interfaces.nsIUUIDGenerator)</span>
<a href="#l9.41"></a><span id="l9.41">                           .generateUUID() +&quot;@mozillamessaging.invalid&quot;;</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineat">@@ -215,22 +218,17 @@ function test_checkStandaloneMessageWind</span>
<a href="#l9.43"></a><span id="l9.43">   checkStandaloneMessageWindow(false);</span>
<a href="#l9.44"></a><span id="l9.44"> }</span>
<a href="#l9.45"></a><span id="l9.45"> </span>
<a href="#l9.46"></a><span id="l9.46"> function test_checkContentTab() {</span>
<a href="#l9.47"></a><span id="l9.47">   // To open a tab we're going to have to cheat and use tabmail so we can load</span>
<a href="#l9.48"></a><span id="l9.48">   // in the data of what we want.</span>
<a href="#l9.49"></a><span id="l9.49">   let preCount = mc.tabmail.tabContainer.childNodes.length;</span>
<a href="#l9.50"></a><span id="l9.50"> </span>
<a href="#l9.51"></a><span id="l9.51" class="difflineminus">-  let newTab = mc.tabmail.openTab(&quot;contentTab&quot;, { contentPage: url + &quot;plugin.html&quot; });</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineminus">-</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineminus">-  mc.waitForEval(&quot;subject.busy == false&quot;, 5000, 100, newTab);</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineminus">-</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineminus">-  if (mc.tabmail.tabContainer.childNodes.length != preCount + 1)</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineminus">-    throw new Error(&quot;The content tab didn't open&quot;);</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+  let newTab = open_content_tab_with_url(url + &quot;plugin.html&quot;);</span>
<a href="#l9.58"></a><span id="l9.58"> </span>
<a href="#l9.59"></a><span id="l9.59">   if (!isPluginLoaded(mc.tabmail.getBrowserForSelectedTab().contentDocument))</span>
<a href="#l9.60"></a><span id="l9.60">     throw new Error(&quot;Plugin has been unexpectedly blocked in content tab&quot;);</span>
<a href="#l9.61"></a><span id="l9.61"> </span>
<a href="#l9.62"></a><span id="l9.62">   mc.tabmail.closeTab(newTab);</span>
<a href="#l9.63"></a><span id="l9.63"> </span>
<a href="#l9.64"></a><span id="l9.64">   if (mc.tabmail.tabContainer.childNodes.length != preCount)</span>
<a href="#l9.65"></a><span id="l9.65">     throw new Error(&quot;The content tab didn't close&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/test/mozmill/content-tabs/test-about-support.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/test/mozmill/content-tabs/test-about-support.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -36,19 +36,16 @@</span>
<a href="#l10.4"></a><span id="l10.4">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l10.5"></a><span id="l10.5"> </span>
<a href="#l10.6"></a><span id="l10.6"> var MODULE_NAME = 'test-about-support';</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8"> var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l10.9"></a><span id="l10.9"> var MODULE_REQUIRES = ['folder-display-helpers', 'content-tab-helpers',</span>
<a href="#l10.10"></a><span id="l10.10">                        'compose-helpers', 'window-helpers'];</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-var controller = {};</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-Components.utils.import('resource://mozmill/modules/controller.js', controller);</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-</span>
<a href="#l10.15"></a><span id="l10.15"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l10.16"></a><span id="l10.16"> </span>
<a href="#l10.17"></a><span id="l10.17"> function setupModule(module) {</span>
<a href="#l10.18"></a><span id="l10.18">   let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l10.19"></a><span id="l10.19">   fdh.installInto(module);</span>
<a href="#l10.20"></a><span id="l10.20">   let cth = collector.getModule(&quot;content-tab-helpers&quot;);</span>
<a href="#l10.21"></a><span id="l10.21">   cth.installInto(module);</span>
<a href="#l10.22"></a><span id="l10.22">   let ch = collector.getModule(&quot;compose-helpers&quot;);</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineat">@@ -86,21 +83,18 @@ const ABOUT_SUPPORT_ERROR_STRINGS = [&quot;un</span>
<a href="#l10.24"></a><span id="l10.24">  *</span>
<a href="#l10.25"></a><span id="l10.25">  * @returns the about:support tab.</span>
<a href="#l10.26"></a><span id="l10.26">  */</span>
<a href="#l10.27"></a><span id="l10.27"> function open_about_support() {</span>
<a href="#l10.28"></a><span id="l10.28">   let tab = open_content_tab_with_click(mc.menus.helpMenu.aboutsupport_open);</span>
<a href="#l10.29"></a><span id="l10.29">   assert_content_tab_has_url(tab, &quot;about:support&quot;);</span>
<a href="#l10.30"></a><span id="l10.30">   // We have one variable that's asynchronously populated -- wait for it to be</span>
<a href="#l10.31"></a><span id="l10.31">   // populated.</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-  if (!controller.waitForEval(&quot;subject.gExtensions !== undefined&quot;,</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineminus">-                              NORMAL_TIMEOUT, FAST_INTERVAL,</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineminus">-                              tab.browser.contentWindow)) {</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineminus">-    mark_failure([&quot;Timeout waiting for about:support's gExtensions to populate.&quot;]);</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineminus">-  }</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+  mc.waitFor(function () tab.browser.contentWindow.gExtensions !== undefined,</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+             &quot;Timeout waiting for about:support's gExtensions to populate.&quot;);</span>
<a href="#l10.39"></a><span id="l10.39">   return tab;</span>
<a href="#l10.40"></a><span id="l10.40"> }</span>
<a href="#l10.41"></a><span id="l10.41"> </span>
<a href="#l10.42"></a><span id="l10.42"> /**</span>
<a href="#l10.43"></a><span id="l10.43">  * Opens a compose window containing the troubleshooting information.</span>
<a href="#l10.44"></a><span id="l10.44">  *</span>
<a href="#l10.45"></a><span id="l10.45">  * @param aTab The about:support tab.</span>
<a href="#l10.46"></a><span id="l10.46">  */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/test/mozmill/content-tabs/test-install-xpi.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/test/mozmill/content-tabs/test-install-xpi.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -62,17 +62,18 @@ const ALERT_TIMEOUT = 10000;</span>
<a href="#l11.4"></a><span id="l11.4"> let AlertWatcher = {</span>
<a href="#l11.5"></a><span id="l11.5">   planForAlert: function(aController) {</span>
<a href="#l11.6"></a><span id="l11.6">     this.alerted = false;</span>
<a href="#l11.7"></a><span id="l11.7">     aController.window.document.addEventListener(&quot;AlertActive&quot;,</span>
<a href="#l11.8"></a><span id="l11.8">                                                  this.alertActive, false);</span>
<a href="#l11.9"></a><span id="l11.9">   },</span>
<a href="#l11.10"></a><span id="l11.10">   waitForAlert: function(aController) {</span>
<a href="#l11.11"></a><span id="l11.11">     if (!this.alerted) {</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-      aController.waitForEval(&quot;subject.alerted&quot;, ALERT_TIMEOUT, 100, this);</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+      aController.waitFor(function () this.alerted, &quot;Timeout waiting for alert&quot;,</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+                          ALERT_TIMEOUT, 100, this);</span>
<a href="#l11.15"></a><span id="l11.15">     }</span>
<a href="#l11.16"></a><span id="l11.16">     aController.window.document.removeEventListener(&quot;AlertActive&quot;,</span>
<a href="#l11.17"></a><span id="l11.17">                                                     this.alertActive, false);</span>
<a href="#l11.18"></a><span id="l11.18">   },</span>
<a href="#l11.19"></a><span id="l11.19">   alerted: false,</span>
<a href="#l11.20"></a><span id="l11.20">   alertActive: function() {</span>
<a href="#l11.21"></a><span id="l11.21">     AlertWatcher.alerted = true;</span>
<a href="#l11.22"></a><span id="l11.22">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/test/mozmill/content-tabs/test-lwthemes.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/test/mozmill/content-tabs/test-lwthemes.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -67,25 +67,27 @@ const ALERT_TIMEOUT = 10000;</span>
<a href="#l12.4"></a><span id="l12.4"> </span>
<a href="#l12.5"></a><span id="l12.5"> let AlertWatcher = {</span>
<a href="#l12.6"></a><span id="l12.6">   planForAlert: function(aController) {</span>
<a href="#l12.7"></a><span id="l12.7">     this.alerted = false;</span>
<a href="#l12.8"></a><span id="l12.8">     aController.window.document.addEventListener(&quot;AlertActive&quot;,</span>
<a href="#l12.9"></a><span id="l12.9">                                                  this.alertActive, false);</span>
<a href="#l12.10"></a><span id="l12.10">   },</span>
<a href="#l12.11"></a><span id="l12.11">   waitForAlert: function(aController) {</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-    if (!this.alerted)</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-      aController.waitForEval(&quot;subject.alerted&quot;, ALERT_TIMEOUT, 100, this);</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+    if (!this.alerted) {</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+      aController.waitFor(function () this.alerted, &quot;Timeout waiting for alert&quot;,</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+                          ALERT_TIMEOUT, 100, this);</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+    }</span>
<a href="#l12.19"></a><span id="l12.19">     // Double check the notification box has finished animating.</span>
<a href="#l12.20"></a><span id="l12.20">     let notificationBox =</span>
<a href="#l12.21"></a><span id="l12.21">       mc.tabmail.selectedTab.panel.getElementsByTagName(&quot;notificationbox&quot;)[0];</span>
<a href="#l12.22"></a><span id="l12.22">     if (notificationBox &amp;&amp; notificationBox._animating)</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineminus">-      aController.waitForEval(&quot;!subject._animating&quot;, ALERT_TIMEOUT, 100,</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineminus">-                              notificationBox);</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+      aController.waitFor(function () !notificationBox._animating,</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+                          &quot;Timeout waiting for notification box animation to finish&quot;,</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineplus">+                          ALERT_TIMEOUT, 100);</span>
<a href="#l12.28"></a><span id="l12.28"> </span>
<a href="#l12.29"></a><span id="l12.29">     aController.window.document.removeEventListener(&quot;AlertActive&quot;,</span>
<a href="#l12.30"></a><span id="l12.30">                                                     this.alertActive, false);</span>
<a href="#l12.31"></a><span id="l12.31">   },</span>
<a href="#l12.32"></a><span id="l12.32">   alerted: false,</span>
<a href="#l12.33"></a><span id="l12.33">   alertActive: function() {</span>
<a href="#l12.34"></a><span id="l12.34">     AlertWatcher.alerted = true;</span>
<a href="#l12.35"></a><span id="l12.35">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mail/test/mozmill/cookies/test-cookies.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mail/test/mozmill/cookies/test-cookies.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -39,62 +39,43 @@</span>
<a href="#l13.4"></a><span id="l13.4">  * Test file to check that cookies are correctly enabled in Thunderbird.</span>
<a href="#l13.5"></a><span id="l13.5">  *</span>
<a href="#l13.6"></a><span id="l13.6">  * XXX: Still need to check remote content in messages.</span>
<a href="#l13.7"></a><span id="l13.7">  */</span>
<a href="#l13.8"></a><span id="l13.8"> </span>
<a href="#l13.9"></a><span id="l13.9"> var MODULE_NAME = 'test-cookies';</span>
<a href="#l13.10"></a><span id="l13.10"> </span>
<a href="#l13.11"></a><span id="l13.11"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-var MODULE_REQUIRES = ['window-helpers'];</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+var MODULE_REQUIRES = ['window-helpers', 'content-tab-helpers', 'folder-display-helpers'];</span>
<a href="#l13.14"></a><span id="l13.14"> </span>
<a href="#l13.15"></a><span id="l13.15" class="difflineminus">-var controller = {};</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineminus">-Components.utils.import('resource://mozmill/modules/controller.js', controller);</span>
<a href="#l13.17"></a><span id="l13.17"> var mozmill = {}; Components.utils.import('resource://mozmill/modules/mozmill.js', mozmill);</span>
<a href="#l13.18"></a><span id="l13.18"> var elementslib = {}; Components.utils.import('resource://mozmill/modules/elementslib.js', elementslib);</span>
<a href="#l13.19"></a><span id="l13.19"> </span>
<a href="#l13.20"></a><span id="l13.20" class="difflineminus">-// The main controller.</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineminus">-var mc;</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineminus">-</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineminus">-// The windowHelper module.</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineminus">-var windowHelper;</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineminus">-</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineminus">-var newTab = null;</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineminus">-</span>
<a href="#l13.28"></a><span id="l13.28"> // RELATIVE_ROOT messes with the collector, so we have to bring the path back</span>
<a href="#l13.29"></a><span id="l13.29"> // so we get the right path for the resources.</span>
<a href="#l13.30"></a><span id="l13.30"> var url = collector.addHttpResource('../cookies/html', 'cookies');</span>
<a href="#l13.31"></a><span id="l13.31"> </span>
<a href="#l13.32"></a><span id="l13.32"> function setupModule(module) {</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-  windowHelper = collector.getModule('window-helpers');</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineminus">-  mc = windowHelper.wait_for_existing_window(&quot;mail:3pane&quot;);</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineminus">-  windowHelper.augment_controller(mc);</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+  let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+  fdh.installInto(module);</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+  let wh = collector.getModule('window-helpers');</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+  wh.installInto(module);</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+  let cth = collector.getModule(&quot;content-tab-helpers&quot;);</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineplus">+  cth.installInto(module);</span>
<a href="#l13.42"></a><span id="l13.42"> }</span>
<a href="#l13.43"></a><span id="l13.43"> </span>
<a href="#l13.44"></a><span id="l13.44"> /**</span>
<a href="#l13.45"></a><span id="l13.45">  * Test deleting junk messages with no messages marked as junk.</span>
<a href="#l13.46"></a><span id="l13.46">  */</span>
<a href="#l13.47"></a><span id="l13.47"> function test_load_cookie_page() {</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineminus">-  newTab = mc.tabmail.openTab(&quot;contentTab&quot;,</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineminus">-                              {contentPage: url + &quot;cookietest1.html&quot;});</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineminus">-</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineminus">-  if (!newTab)</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineminus">-    throw new Error(&quot;Expected new tab info to be returned from openTab&quot;);</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineminus">-</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineminus">-  mc.waitForEval(&quot;subject.busy == false&quot;, 5000, 100, newTab);</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+  open_content_tab_with_url(url + &quot;cookietest1.html&quot;);</span>
<a href="#l13.56"></a><span id="l13.56"> }</span>
<a href="#l13.57"></a><span id="l13.57"> </span>
<a href="#l13.58"></a><span id="l13.58"> function test_load_cookie_result_page() {</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineminus">-  newTab = mc.tabmail.openTab(&quot;contentTab&quot;,</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineminus">-                              {contentPage: url + &quot;cookietest2.html&quot;});</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineminus">-</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineminus">-  if (!newTab)</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineminus">-    throw new Error(&quot;Expected new tab info to be returned from openTab&quot;);</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineminus">-</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineminus">-  mc.waitForEval(&quot;subject.busy == false&quot;, 5000, 100, newTab);</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineplus">+  open_content_tab_with_url(url + &quot;cookietest2.html&quot;);</span>
<a href="#l13.67"></a><span id="l13.67"> </span>
<a href="#l13.68"></a><span id="l13.68">   if (mc.window.content.document.title != &quot;Cookie Test 2&quot;)</span>
<a href="#l13.69"></a><span id="l13.69">     throw new Error(&quot;The cookie test 2 page is not the selected tab or not content-primary&quot;);</span>
<a href="#l13.70"></a><span id="l13.70"> </span>
<a href="#l13.71"></a><span id="l13.71">   let cookie = mc.window.content.wrappedJSObject.theCookie;</span>
<a href="#l13.72"></a><span id="l13.72"> </span>
<a href="#l13.73"></a><span id="l13.73">   dump(&quot;Cookie is: &quot; + cookie + &quot;\n&quot;);</span>
<a href="#l13.74"></a><span id="l13.74"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-recent-menu.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-recent-menu.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -85,18 +85,18 @@ function test_move_message() {</span>
<a href="#l14.4"></a><span id="l14.4">     SetMessageKey: function(aKey) { },</span>
<a href="#l14.5"></a><span id="l14.5">     SetMessageId: function(aMessageId) {},</span>
<a href="#l14.6"></a><span id="l14.6">     OnStopCopy: function(aStatus) {</span>
<a href="#l14.7"></a><span id="l14.7">       this.copyDone = true;</span>
<a href="#l14.8"></a><span id="l14.8">     }</span>
<a href="#l14.9"></a><span id="l14.9">   };</span>
<a href="#l14.10"></a><span id="l14.10">   MailServices.copy.CopyMessages(folder1, array, folder2, true,</span>
<a href="#l14.11"></a><span id="l14.11">                                  copyListener, mc.window.msgWindow, true);</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-  mc.waitForEval(&quot;subject.copyDone == true&quot;,</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-                          10000, 100, copyListener);</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+  mc.waitFor(function () copyListener.copyDone,</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+             &quot;Timeout waiting for copy to complete&quot;, 10000, 100);</span>
<a href="#l14.16"></a><span id="l14.16">   // We've moved a message to aaafolder2 - it should appear in recent list now.</span>
<a href="#l14.17"></a><span id="l14.17">   mc.click_menus_in_sequence(mc.e(&quot;mailContext&quot;), [{id: &quot;mailContext-moveMenu&quot;},</span>
<a href="#l14.18"></a><span id="l14.18">                                                    {label: &quot;Recent&quot;}]);</span>
<a href="#l14.19"></a><span id="l14.19">   // firstChild is move menu popup, its child is Recent, its child is menuPopup,</span>
<a href="#l14.20"></a><span id="l14.20">   // and menuPopup's children are what we want.</span>
<a href="#l14.21"></a><span id="l14.21">   let recentChildren = mc.eid(&quot;mailContext-moveMenu&quot;)</span>
<a href="#l14.22"></a><span id="l14.22">                        .node.firstChild.firstChild.firstChild.children;</span>
<a href="#l14.23"></a><span id="l14.23">   assert_equals(recentChildren.length, gInitRecentMenuCount + 1,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-savedsearch-reload-after-compact.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-savedsearch-reload-after-compact.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -84,17 +84,17 @@ function test_setup_virtual_folder_and_c</span>
<a href="#l15.4"></a><span id="l15.4">     OnStartRunningUrl: function (aUrl) {</span>
<a href="#l15.5"></a><span id="l15.5">     },</span>
<a href="#l15.6"></a><span id="l15.6">     OnStopRunningUrl: function (aUrl, aExitCode) {</span>
<a href="#l15.7"></a><span id="l15.7">       this.compactDone = true;</span>
<a href="#l15.8"></a><span id="l15.8">     }</span>
<a href="#l15.9"></a><span id="l15.9">   };</span>
<a href="#l15.10"></a><span id="l15.10">   otherFolder.compactAll(urlListener, null, false);</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-  mc.waitForEval(&quot;subject.compactDone == true&quot;,</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-                          10000, 100, urlListener);</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+  mc.waitFor(function () urlListener.compactDone,</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+             &quot;Timeout waiting for compact to complete&quot;, 10000, 100);</span>
<a href="#l15.16"></a><span id="l15.16"> </span>
<a href="#l15.17"></a><span id="l15.17">   // Let the event queue clear.</span>
<a href="#l15.18"></a><span id="l15.18">   mc.sleep(0);</span>
<a href="#l15.19"></a><span id="l15.19">   // Check view is still valid</span>
<a href="#l15.20"></a><span id="l15.20">   let msgHdr = mc.dbView.getMsgHdrAt(0);</span>
<a href="#l15.21"></a><span id="l15.21"> }</span>
<a href="#l15.22"></a><span id="l15.22"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mail/test/mozmill/instrumentation/test-instrument-setup.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mail/test/mozmill/instrumentation/test-instrument-setup.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -88,18 +88,19 @@ function test_mail_account_setup() {</span>
<a href="#l16.4"></a><span id="l16.4">   input_value(awc, user.email);</span>
<a href="#l16.5"></a><span id="l16.5"> </span>
<a href="#l16.6"></a><span id="l16.6">   // Load the autoconfig file from http://localhost:433**/autoconfig/example.com</span>
<a href="#l16.7"></a><span id="l16.7">   awc.e(&quot;next_button&quot;).click();</span>
<a href="#l16.8"></a><span id="l16.8"> </span>
<a href="#l16.9"></a><span id="l16.9">   let config = null;</span>
<a href="#l16.10"></a><span id="l16.10"> </span>
<a href="#l16.11"></a><span id="l16.11">   // XXX: This should probably use a notification, once we fix bug 561143.</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-  awc.waitForEval(&quot;subject._currentConfig != null&quot;, 8000, 600,</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-                  awc.window.gEmailConfigWizard);</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+  awc.waitFor(function () awc.window.gEmailConfigWizard._currentConfig != null,</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+              &quot;Timeout waiting for current config to become non-null&quot;,</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+              8000, 600);</span>
<a href="#l16.17"></a><span id="l16.17">   config = awc.window.gEmailConfigWizard._currentConfig;</span>
<a href="#l16.18"></a><span id="l16.18">   plan_for_window_close(awc);</span>
<a href="#l16.19"></a><span id="l16.19">   awc.e(&quot;create_button&quot;).click();</span>
<a href="#l16.20"></a><span id="l16.20"> </span>
<a href="#l16.21"></a><span id="l16.21">   // Clean up</span>
<a href="#l16.22"></a><span id="l16.22">   pref.clearUserPref(pref_name);</span>
<a href="#l16.23"></a><span id="l16.23">   wait_for_window_close();</span>
<a href="#l16.24"></a><span id="l16.24">   remove_account();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mail/test/mozmill/quick-filter-bar/test-display-issues.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mail/test/mozmill/quick-filter-bar/test-display-issues.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -56,17 +56,18 @@ function setupModule(module) {</span>
<a href="#l17.4"></a><span id="l17.4">   let qfb = collector.getModule('quick-filter-bar-helper');</span>
<a href="#l17.5"></a><span id="l17.5">   qfb.installInto(module);</span>
<a href="#l17.6"></a><span id="l17.6"> </span>
<a href="#l17.7"></a><span id="l17.7">   folder = create_folder(&quot;QuickFilterBarDisplayIssues&quot;);</span>
<a href="#l17.8"></a><span id="l17.8">   be_in_folder(folder);</span>
<a href="#l17.9"></a><span id="l17.9"> }</span>
<a href="#l17.10"></a><span id="l17.10"> </span>
<a href="#l17.11"></a><span id="l17.11"> function wait_for_resize(width) {</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-  mc.waitForEval(&quot;subject.outerWidth == &quot; + width, 1000, 50, mc.window);</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+  mc.waitFor(function () (mc.window.outerWidth == width),</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+             &quot;Timeout waiting for resize&quot;, 1000, 50);</span>
<a href="#l17.15"></a><span id="l17.15"> }</span>
<a href="#l17.16"></a><span id="l17.16"> </span>
<a href="#l17.17"></a><span id="l17.17"> function resize_to(width, height) {</span>
<a href="#l17.18"></a><span id="l17.18">   mark_action(&quot;test&quot;, &quot;resize_to&quot;, [width, &quot;x&quot;, height]);</span>
<a href="#l17.19"></a><span id="l17.19">   mc.window.resizeTo(width, height);</span>
<a href="#l17.20"></a><span id="l17.20">   // Give the event loop a spin in order to let the reality of an asynchronously</span>
<a href="#l17.21"></a><span id="l17.21">   //  interacting window manager have its impact.  This still may not be</span>
<a href="#l17.22"></a><span id="l17.22">   //  sufficient.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-account-manager-helpers.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-account-manager-helpers.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -40,16 +40,18 @@ var Cc = Components.classes;</span>
<a href="#l18.4"></a><span id="l18.4"> var Cu = Components.utils;</span>
<a href="#l18.5"></a><span id="l18.5"> </span>
<a href="#l18.6"></a><span id="l18.6"> var elib = {};</span>
<a href="#l18.7"></a><span id="l18.7"> Cu.import('resource://mozmill/modules/elementslib.js', elib);</span>
<a href="#l18.8"></a><span id="l18.8"> var mozmill = {};</span>
<a href="#l18.9"></a><span id="l18.9"> Cu.import('resource://mozmill/modules/mozmill.js', mozmill);</span>
<a href="#l18.10"></a><span id="l18.10"> var EventUtils = {};</span>
<a href="#l18.11"></a><span id="l18.11"> Cu.import('resource://mozmill/stdlib/EventUtils.js', EventUtils);</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+var utils = {};</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+Cu.import('resource://mozmill/modules/utils.js', utils);</span>
<a href="#l18.14"></a><span id="l18.14"> </span>
<a href="#l18.15"></a><span id="l18.15"> const MODULE_NAME = 'account-manager-helpers';</span>
<a href="#l18.16"></a><span id="l18.16"> const RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l18.17"></a><span id="l18.17"> </span>
<a href="#l18.18"></a><span id="l18.18"> // we need this for the main controller</span>
<a href="#l18.19"></a><span id="l18.19"> const MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers'];</span>
<a href="#l18.20"></a><span id="l18.20"> </span>
<a href="#l18.21"></a><span id="l18.21"> var wh, fdh, mc;</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineat">@@ -98,18 +100,18 @@ function open_advanced_settings_from_acc</span>
<a href="#l18.23"></a><span id="l18.23"> </span>
<a href="#l18.24"></a><span id="l18.24"> /**</span>
<a href="#l18.25"></a><span id="l18.25">  * Click a row in the account settings tree</span>
<a href="#l18.26"></a><span id="l18.26">  *</span>
<a href="#l18.27"></a><span id="l18.27">  * @param controller the Mozmill controller for the account settings dialog</span>
<a href="#l18.28"></a><span id="l18.28">  * @param rowIndex the row to click</span>
<a href="#l18.29"></a><span id="l18.29">  */</span>
<a href="#l18.30"></a><span id="l18.30"> function click_account_tree_row(controller, rowIndex) {</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineminus">-  controller.waitForEval(&quot;subject.currentAccount != null&quot;, 6000, 600,</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineminus">-                         controller.window);</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineplus">+  utils.waitFor(function () controller.window.currentAccount != null,</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineplus">+                &quot;Timeout waiting for currentAccount to become non-null&quot;);</span>
<a href="#l18.35"></a><span id="l18.35"> </span>
<a href="#l18.36"></a><span id="l18.36">   var tree = controller.window.document.getElementById(&quot;accounttree&quot;);</span>
<a href="#l18.37"></a><span id="l18.37">   var selection = tree.view.selection;</span>
<a href="#l18.38"></a><span id="l18.38">   selection.select(rowIndex);</span>
<a href="#l18.39"></a><span id="l18.39">   tree.treeBoxObject.ensureRowIsVisible(rowIndex);</span>
<a href="#l18.40"></a><span id="l18.40"> </span>
<a href="#l18.41"></a><span id="l18.41">   // get cell coordinates</span>
<a href="#l18.42"></a><span id="l18.42">   var x = {}, y = {}, width = {}, height = {};</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineat">@@ -117,11 +119,11 @@ function click_account_tree_row(controll</span>
<a href="#l18.44"></a><span id="l18.44">   tree.treeBoxObject.getCoordsForCellItem(rowIndex, column, &quot;text&quot;,</span>
<a href="#l18.45"></a><span id="l18.45">                                            x, y, width, height);</span>
<a href="#l18.46"></a><span id="l18.46"> </span>
<a href="#l18.47"></a><span id="l18.47">   controller.sleep(0);</span>
<a href="#l18.48"></a><span id="l18.48">   EventUtils.synthesizeMouse(tree.body, x.value + 4, y.value + 4,</span>
<a href="#l18.49"></a><span id="l18.49">                              {}, tree.ownerDocument.defaultView);</span>
<a href="#l18.50"></a><span id="l18.50">   controller.sleep(0);</span>
<a href="#l18.51"></a><span id="l18.51"> </span>
<a href="#l18.52"></a><span id="l18.52" class="difflineminus">-  controller.waitForEval(&quot;subject.pendingAccount == null&quot;, 6000, 600,</span>
<a href="#l18.53"></a><span id="l18.53" class="difflineminus">-                         controller.window);</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineplus">+  utils.waitFor(function () controller.window.pendingAccount == null,</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineplus">+                &quot;Timeout waiting for pendingAccount to become null&quot;);</span>
<a href="#l18.56"></a><span id="l18.56"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-compose-helpers.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-compose-helpers.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -38,16 +38,18 @@</span>
<a href="#l19.4"></a><span id="l19.4"> var Ci = Components.interfaces;</span>
<a href="#l19.5"></a><span id="l19.5"> var Cc = Components.classes;</span>
<a href="#l19.6"></a><span id="l19.6"> var Cu = Components.utils;</span>
<a href="#l19.7"></a><span id="l19.7"> </span>
<a href="#l19.8"></a><span id="l19.8"> var elib = {};</span>
<a href="#l19.9"></a><span id="l19.9"> Cu.import('resource://mozmill/modules/elementslib.js', elib);</span>
<a href="#l19.10"></a><span id="l19.10"> var mozmill = {};</span>
<a href="#l19.11"></a><span id="l19.11"> Cu.import('resource://mozmill/modules/mozmill.js', mozmill);</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+var utils = {};</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+Cu.import('resource://mozmill/modules/utils.js', utils);</span>
<a href="#l19.14"></a><span id="l19.14"> </span>
<a href="#l19.15"></a><span id="l19.15"> const MODULE_NAME = 'compose-helpers';</span>
<a href="#l19.16"></a><span id="l19.16"> </span>
<a href="#l19.17"></a><span id="l19.17"> const RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l19.18"></a><span id="l19.18"> </span>
<a href="#l19.19"></a><span id="l19.19"> // we need this for the main controller</span>
<a href="#l19.20"></a><span id="l19.20"> const MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers'];</span>
<a href="#l19.21"></a><span id="l19.21"> </span>
<a href="#l19.22"></a><span id="l19.22" class="difflineat">@@ -219,18 +221,19 @@ function wait_for_compose_window(aContro</span>
<a href="#l19.23"></a><span id="l19.23">           this.editorLoaded = true;</span>
<a href="#l19.24"></a><span id="l19.24">         }</span>
<a href="#l19.25"></a><span id="l19.25">       }</span>
<a href="#l19.26"></a><span id="l19.26">     };</span>
<a href="#l19.27"></a><span id="l19.27"> </span>
<a href="#l19.28"></a><span id="l19.28">     editor.commandManager.addCommandObserver(editorObserver,</span>
<a href="#l19.29"></a><span id="l19.29">                                              &quot;obs_documentCreated&quot;);</span>
<a href="#l19.30"></a><span id="l19.30"> </span>
<a href="#l19.31"></a><span id="l19.31" class="difflineminus">-    aController.waitForEval(&quot;subject.editorLoaded == true&quot;,</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineminus">-                            10000, 100, editorObserver);</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineplus">+    utils.waitFor(function () editorObserver.editorLoaded,</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineplus">+                  &quot;Timeout waiting for compose window editor to load&quot;,</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineplus">+                  10000, 100);</span>
<a href="#l19.36"></a><span id="l19.36"> </span>
<a href="#l19.37"></a><span id="l19.37">     // Let the event queue clear.</span>
<a href="#l19.38"></a><span id="l19.38">     aController.sleep(0);</span>
<a href="#l19.39"></a><span id="l19.39"> </span>
<a href="#l19.40"></a><span id="l19.40">     editor.commandManager.removeCommandObserver(editorObserver,</span>
<a href="#l19.41"></a><span id="l19.41">                                                 &quot;obs_documentCreated&quot;);</span>
<a href="#l19.42"></a><span id="l19.42">   }</span>
<a href="#l19.43"></a><span id="l19.43"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-content-tab-helpers.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-content-tab-helpers.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -38,18 +38,18 @@</span>
<a href="#l20.4"></a><span id="l20.4"> var Ci = Components.interfaces;</span>
<a href="#l20.5"></a><span id="l20.5"> var Cc = Components.classes;</span>
<a href="#l20.6"></a><span id="l20.6"> var Cu = Components.utils;</span>
<a href="#l20.7"></a><span id="l20.7"> </span>
<a href="#l20.8"></a><span id="l20.8"> var elib = {};</span>
<a href="#l20.9"></a><span id="l20.9"> Cu.import('resource://mozmill/modules/elementslib.js', elib);</span>
<a href="#l20.10"></a><span id="l20.10"> var mozmill = {};</span>
<a href="#l20.11"></a><span id="l20.11"> Cu.import('resource://mozmill/modules/mozmill.js', mozmill);</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-var controller = {};</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-Cu.import('resource://mozmill/modules/controller.js', controller);</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineplus">+var utils = {};</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineplus">+Cu.import('resource://mozmill/modules/utils.js', utils);</span>
<a href="#l20.16"></a><span id="l20.16"> </span>
<a href="#l20.17"></a><span id="l20.17"> const MODULE_NAME = 'content-tab-helpers';</span>
<a href="#l20.18"></a><span id="l20.18"> </span>
<a href="#l20.19"></a><span id="l20.19"> const RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l20.20"></a><span id="l20.20"> </span>
<a href="#l20.21"></a><span id="l20.21"> // we need this for the main controller</span>
<a href="#l20.22"></a><span id="l20.22"> const MODULE_REQUIRES = ['folder-display-helpers'];</span>
<a href="#l20.23"></a><span id="l20.23"> </span>
<a href="#l20.24"></a><span id="l20.24" class="difflineat">@@ -106,20 +106,20 @@ function open_content_tab_with_url(aURL,</span>
<a href="#l20.25"></a><span id="l20.25">     aBackground = false;</span>
<a href="#l20.26"></a><span id="l20.26">   if (aController === undefined)</span>
<a href="#l20.27"></a><span id="l20.27">     aController = mc;</span>
<a href="#l20.28"></a><span id="l20.28"> </span>
<a href="#l20.29"></a><span id="l20.29">   let preCount = mc.tabmail.tabContainer.childNodes.length;</span>
<a href="#l20.30"></a><span id="l20.30">   let newTab = mc.tabmail.openTab(&quot;contentTab&quot;, {contentPage: aURL,</span>
<a href="#l20.31"></a><span id="l20.31">                                                  background: aBackground,</span>
<a href="#l20.32"></a><span id="l20.32">                                                  clickHandler: aClickHandler});</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineminus">-  if (!controller.waitForEval(&quot;subject.childNodes.length == &quot; + (preCount + 1),</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineminus">-                              FAST_TIMEOUT, FAST_INTERVAL,</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineminus">-                              aController.tabmail.tabContainer))</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineminus">-    mark_failure([&quot;Timeout waiting for the content tab to open with URL:&quot;, aURL]);</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineplus">+  utils.waitFor(function () (</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineplus">+                  aController.tabmail.tabContainer.childNodes.length == preCount + 1),</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineplus">+                &quot;Timeout waiting for the content tab to open with URL: &quot; + aURL,</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineplus">+                FAST_TIMEOUT, FAST_INTERVAL);</span>
<a href="#l20.41"></a><span id="l20.41"> </span>
<a href="#l20.42"></a><span id="l20.42">   // We append new tabs at the end, so check the last one.</span>
<a href="#l20.43"></a><span id="l20.43">   let expectedNewTab = aController.tabmail.tabInfo[preCount];</span>
<a href="#l20.44"></a><span id="l20.44">   folderDisplayHelper.assert_selected_tab(expectedNewTab);</span>
<a href="#l20.45"></a><span id="l20.45">   wait_for_content_tab_load(expectedNewTab);</span>
<a href="#l20.46"></a><span id="l20.46">   return expectedNewTab;</span>
<a href="#l20.47"></a><span id="l20.47"> }</span>
<a href="#l20.48"></a><span id="l20.48"> </span>
<a href="#l20.49"></a><span id="l20.49" class="difflineat">@@ -134,20 +134,20 @@ function open_content_tab_with_url(aURL,</span>
<a href="#l20.50"></a><span id="l20.50">  * @returns The newly-opened tab.</span>
<a href="#l20.51"></a><span id="l20.51">  */</span>
<a href="#l20.52"></a><span id="l20.52"> function open_content_tab_with_click(aElem, aController) {</span>
<a href="#l20.53"></a><span id="l20.53">   if (aController === undefined)</span>
<a href="#l20.54"></a><span id="l20.54">     aController = mc;</span>
<a href="#l20.55"></a><span id="l20.55"> </span>
<a href="#l20.56"></a><span id="l20.56">   let preCount = aController.tabmail.tabContainer.childNodes.length;</span>
<a href="#l20.57"></a><span id="l20.57">   aController.click(new elib.Elem(aElem));</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineminus">-  if (!controller.waitForEval(&quot;subject.childNodes.length == &quot; + (preCount + 1),</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineminus">-                              FAST_TIMEOUT, FAST_INTERVAL,</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineminus">-                              aController.tabmail.tabContainer))</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineminus">-    mark_failure([&quot;Timeout waiting for the content tab to open&quot;]);</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineplus">+  utils.waitFor(function () (</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineplus">+                  aController.tabmail.tabContainer.childNodes.length == preCount + 1),</span>
<a href="#l20.64"></a><span id="l20.64" class="difflineplus">+                &quot;Timeout waiting for the content tab to open&quot;,</span>
<a href="#l20.65"></a><span id="l20.65" class="difflineplus">+                FAST_TIMEOUT, FAST_INTERVAL);</span>
<a href="#l20.66"></a><span id="l20.66"> </span>
<a href="#l20.67"></a><span id="l20.67">   // We append new tabs at the end, so check the last one.</span>
<a href="#l20.68"></a><span id="l20.68">   let expectedNewTab = aController.tabmail.tabInfo[preCount];</span>
<a href="#l20.69"></a><span id="l20.69">   folderDisplayHelper.assert_selected_tab(expectedNewTab);</span>
<a href="#l20.70"></a><span id="l20.70">   folderDisplayHelper.assert_tab_mode_name(expectedNewTab, &quot;contentTab&quot;);</span>
<a href="#l20.71"></a><span id="l20.71">   wait_for_content_tab_load(expectedNewTab);</span>
<a href="#l20.72"></a><span id="l20.72">   return expectedNewTab;</span>
<a href="#l20.73"></a><span id="l20.73"> }</span>
<a href="#l20.74"></a><span id="l20.74" class="difflineat">@@ -186,19 +186,18 @@ function wait_for_content_tab_load(aTab)</span>
<a href="#l20.75"></a><span id="l20.75">       return false;</span>
<a href="#l20.76"></a><span id="l20.76">     // Also require that our tab infrastructure thinks that the page is loaded.</span>
<a href="#l20.77"></a><span id="l20.77">     if (aTab.busy)</span>
<a href="#l20.78"></a><span id="l20.78">       return false;</span>
<a href="#l20.79"></a><span id="l20.79">     // Finally, require that the tab's browser thinks that no page is being loaded.</span>
<a href="#l20.80"></a><span id="l20.80">     return !(aTab.browser.isLoadingDocument);</span>
<a href="#l20.81"></a><span id="l20.81">   }</span>
<a href="#l20.82"></a><span id="l20.82"> </span>
<a href="#l20.83"></a><span id="l20.83" class="difflineminus">-  if (!controller.waitForEval(&quot;subject()&quot;, NORMAL_TIMEOUT, FAST_INTERVAL,</span>
<a href="#l20.84"></a><span id="l20.84" class="difflineminus">-                              isLoadedChecker))</span>
<a href="#l20.85"></a><span id="l20.85" class="difflineminus">-    mark_failure([&quot;Timeout waiting for the content tab page to load.&quot;]);</span>
<a href="#l20.86"></a><span id="l20.86" class="difflineplus">+  utils.waitFor(isLoadedChecker,</span>
<a href="#l20.87"></a><span id="l20.87" class="difflineplus">+                &quot;Timeout waiting for the content tab page to load.&quot;);</span>
<a href="#l20.88"></a><span id="l20.88">   // the above may return immediately, meaning the event queue might not get a</span>
<a href="#l20.89"></a><span id="l20.89">   //  chance.  give it a chance now.</span>
<a href="#l20.90"></a><span id="l20.90">   mc.sleep(0);</span>
<a href="#l20.91"></a><span id="l20.91"> }</span>
<a href="#l20.92"></a><span id="l20.92"> </span>
<a href="#l20.93"></a><span id="l20.93"> /**</span>
<a href="#l20.94"></a><span id="l20.94">  * Assert that the given content tab has the given URL (string) loaded.</span>
<a href="#l20.95"></a><span id="l20.95">  */</span>
<a href="#l20.96"></a><span id="l20.96" class="difflineat">@@ -264,18 +263,19 @@ function assert_content_tab_element_visi</span>
<a href="#l20.97"></a><span id="l20.97"> </span>
<a href="#l20.98"></a><span id="l20.98"> /**</span>
<a href="#l20.99"></a><span id="l20.99">  * Waits for the element's display property to be the given value.</span>
<a href="#l20.100"></a><span id="l20.100">  */</span>
<a href="#l20.101"></a><span id="l20.101"> function wait_for_content_tab_element_display_value(aTab, aElem, aValue) {</span>
<a href="#l20.102"></a><span id="l20.102">   function isValue() {</span>
<a href="#l20.103"></a><span id="l20.103">     return get_content_tab_element_display(aTab, aElem) == aValue;</span>
<a href="#l20.104"></a><span id="l20.104">   }</span>
<a href="#l20.105"></a><span id="l20.105" class="difflineminus">-  if (!controller.waitForEval(&quot;subject()&quot;, NORMAL_TIMEOUT, FAST_INTERVAL,</span>
<a href="#l20.106"></a><span id="l20.106" class="difflineminus">-                              isValue)) {</span>
<a href="#l20.107"></a><span id="l20.107" class="difflineplus">+  try {</span>
<a href="#l20.108"></a><span id="l20.108" class="difflineplus">+    utils.waitFor(isValue);</span>
<a href="#l20.109"></a><span id="l20.109" class="difflineplus">+  } catch (e if e instanceof utils.TimeoutError) {</span>
<a href="#l20.110"></a><span id="l20.110">     mark_failure([&quot;Timeout waiting for element&quot;, aElem, &quot;to have display value&quot;,</span>
<a href="#l20.111"></a><span id="l20.111">                   aValue]);</span>
<a href="#l20.112"></a><span id="l20.112">   }</span>
<a href="#l20.113"></a><span id="l20.113"> }</span>
<a href="#l20.114"></a><span id="l20.114"> </span>
<a href="#l20.115"></a><span id="l20.115"> /**</span>
<a href="#l20.116"></a><span id="l20.116">  * Asserts that the given text is present on the content tab's page.</span>
<a href="#l20.117"></a><span id="l20.117">  */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-folder-display-helpers.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-folder-display-helpers.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -45,16 +45,18 @@ Cu.import('resource://mozmill/stdlib/Eve</span>
<a href="#l21.4"></a><span id="l21.4"> var mozmill = {};</span>
<a href="#l21.5"></a><span id="l21.5"> Cu.import('resource://mozmill/modules/mozmill.js', mozmill);</span>
<a href="#l21.6"></a><span id="l21.6"> var controller = {};</span>
<a href="#l21.7"></a><span id="l21.7"> Cu.import('resource://mozmill/modules/controller.js', controller);</span>
<a href="#l21.8"></a><span id="l21.8"> var frame = {};</span>
<a href="#l21.9"></a><span id="l21.9"> Cu.import('resource://mozmill/modules/frame.js', frame);</span>
<a href="#l21.10"></a><span id="l21.10"> var os = {};</span>
<a href="#l21.11"></a><span id="l21.11"> Cu.import('resource://mozmill/stdlib/os.js', os);</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineplus">+var utils = {};</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+Cu.import('resource://mozmill/modules/utils.js', utils);</span>
<a href="#l21.14"></a><span id="l21.14"> </span>
<a href="#l21.15"></a><span id="l21.15"> Cu.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l21.16"></a><span id="l21.16"> </span>
<a href="#l21.17"></a><span id="l21.17"> const MODULE_NAME = 'folder-display-helpers';</span>
<a href="#l21.18"></a><span id="l21.18"> </span>
<a href="#l21.19"></a><span id="l21.19"> const RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l21.20"></a><span id="l21.20"> // we need window-helpers for augment_controller</span>
<a href="#l21.21"></a><span id="l21.21"> const MODULE_REQUIRES = ['window-helpers'];</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineat">@@ -409,19 +411,16 @@ function teardownImporter(customTeardown</span>
<a href="#l21.23"></a><span id="l21.23"> /*</span>
<a href="#l21.24"></a><span id="l21.24">  * Although we all agree that the use of generators when dealing with async</span>
<a href="#l21.25"></a><span id="l21.25">  *  operations is awesome, the mozmill idiom is for calls to be synchronous and</span>
<a href="#l21.26"></a><span id="l21.26">  *  just spin event loops when they need to wait for things to happen.  This</span>
<a href="#l21.27"></a><span id="l21.27">  *  does make the test code significantly less confusing, so we do it too.</span>
<a href="#l21.28"></a><span id="l21.28">  * All of our operations are synchronous and just spin until they are happy.</span>
<a href="#l21.29"></a><span id="l21.29">  */</span>
<a href="#l21.30"></a><span id="l21.30"> </span>
<a href="#l21.31"></a><span id="l21.31" class="difflineminus">-const NORMAL_TIMEOUT = 6000;</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineminus">-const FAST_INTERVAL = 100;</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineminus">-</span>
<a href="#l21.34"></a><span id="l21.34"> /**</span>
<a href="#l21.35"></a><span id="l21.35">  * Create a folder and rebuild the folder tree view.</span>
<a href="#l21.36"></a><span id="l21.36">  */</span>
<a href="#l21.37"></a><span id="l21.37"> function create_folder(aFolderName) {</span>
<a href="#l21.38"></a><span id="l21.38">   let folder = testHelperModule.make_empty_folder(aFolderName);</span>
<a href="#l21.39"></a><span id="l21.39">   mc.folderTreeView.mode = &quot;all&quot;;</span>
<a href="#l21.40"></a><span id="l21.40">   return folder;</span>
<a href="#l21.41"></a><span id="l21.41"> }</span>
<a href="#l21.42"></a><span id="l21.42" class="difflineat">@@ -493,19 +492,18 @@ function enter_folder(aFolder) {</span>
<a href="#l21.43"></a><span id="l21.43">   mark_action(&quot;fdh&quot;, &quot;enter_folder&quot;, [aFolder]);</span>
<a href="#l21.44"></a><span id="l21.44"> </span>
<a href="#l21.45"></a><span id="l21.45">   // this selection event may not be synchronous...</span>
<a href="#l21.46"></a><span id="l21.46">   mc.folderTreeView.selectFolder(aFolder);</span>
<a href="#l21.47"></a><span id="l21.47">   // ... so wait until it goes through by waiting on the displayedFolder...</span>
<a href="#l21.48"></a><span id="l21.48">   function isDisplayedFolder() {</span>
<a href="#l21.49"></a><span id="l21.49">     return mc.folderDisplay.displayedFolder == aFolder;</span>
<a href="#l21.50"></a><span id="l21.50">   }</span>
<a href="#l21.51"></a><span id="l21.51" class="difflineminus">-  if (!controller.waitForEval('subject()', NORMAL_TIMEOUT, FAST_INTERVAL,</span>
<a href="#l21.52"></a><span id="l21.52" class="difflineminus">-                              isDisplayedFolder))</span>
<a href="#l21.53"></a><span id="l21.53" class="difflineminus">-    mark_failure([&quot;Timeout trying to enter folder&quot;, aFolder.URI]);</span>
<a href="#l21.54"></a><span id="l21.54" class="difflineplus">+  utils.waitFor(isDisplayedFolder,</span>
<a href="#l21.55"></a><span id="l21.55" class="difflineplus">+                &quot;Timeout trying to enter folder&quot; + aFolder.URI);</span>
<a href="#l21.56"></a><span id="l21.56"> </span>
<a href="#l21.57"></a><span id="l21.57">   wait_for_all_messages_to_load();</span>
<a href="#l21.58"></a><span id="l21.58"> </span>
<a href="#l21.59"></a><span id="l21.59">   // and drain the event queue</span>
<a href="#l21.60"></a><span id="l21.60">   controller.sleep(0);</span>
<a href="#l21.61"></a><span id="l21.61"> }</span>
<a href="#l21.62"></a><span id="l21.62"> </span>
<a href="#l21.63"></a><span id="l21.63"> /**</span>
<a href="#l21.64"></a><span id="l21.64" class="difflineat">@@ -882,18 +880,23 @@ function select_none(aController) {</span>
<a href="#l21.65"></a><span id="l21.65">   focus_thread_tree();</span>
<a href="#l21.66"></a><span id="l21.66">   aController.dbView.selection.clearSelection();</span>
<a href="#l21.67"></a><span id="l21.67">   // Because the selection event may not be generated immediately, we need to</span>
<a href="#l21.68"></a><span id="l21.68">   //  spin until the message display thinks it is not displaying a message,</span>
<a href="#l21.69"></a><span id="l21.69">   //  which is the sign that the event actually happened.</span>
<a href="#l21.70"></a><span id="l21.70">   function noMessageChecker() {</span>
<a href="#l21.71"></a><span id="l21.71">     return aController.messageDisplay.displayedMessage == null;</span>
<a href="#l21.72"></a><span id="l21.72">   }</span>
<a href="#l21.73"></a><span id="l21.73" class="difflineminus">-  controller.sleep('subject()',</span>
<a href="#l21.74"></a><span id="l21.74" class="difflineminus">-                   NORMAL_TIMEOUT, FAST_INTERVAL, noMessageChecker);</span>
<a href="#l21.75"></a><span id="l21.75" class="difflineplus">+  try {</span>
<a href="#l21.76"></a><span id="l21.76" class="difflineplus">+    utils.waitFor(noMessageChecker);</span>
<a href="#l21.77"></a><span id="l21.77" class="difflineplus">+  } catch (e if e instanceof utils.TimeoutError) {</span>
<a href="#l21.78"></a><span id="l21.78" class="difflineplus">+    mark_failure([&quot;Timeout waiting for displayedMessage to become null.&quot;,</span>
<a href="#l21.79"></a><span id="l21.79" class="difflineplus">+                  &quot;Current value: &quot;,</span>
<a href="#l21.80"></a><span id="l21.80" class="difflineplus">+                  aController.messageDisplay.displayedMessage]);</span>
<a href="#l21.81"></a><span id="l21.81" class="difflineplus">+  }</span>
<a href="#l21.82"></a><span id="l21.82">   wait_for_blank_content_pane(aController);</span>
<a href="#l21.83"></a><span id="l21.83"> }</span>
<a href="#l21.84"></a><span id="l21.84"> </span>
<a href="#l21.85"></a><span id="l21.85"> /**</span>
<a href="#l21.86"></a><span id="l21.86">  * Normalize a view index to be an absolute index, handling slice-style negative</span>
<a href="#l21.87"></a><span id="l21.87">  *  references as well as piercing complex things like message headers and</span>
<a href="#l21.88"></a><span id="l21.88">  *  synthetic message sets.</span>
<a href="#l21.89"></a><span id="l21.89">  *</span>
<a href="#l21.90"></a><span id="l21.90" class="difflineat">@@ -1367,17 +1370,18 @@ function delete_via_popup() {</span>
<a href="#l21.91"></a><span id="l21.91">   mc.click(mc.eid(&quot;mailContext-delete&quot;));</span>
<a href="#l21.92"></a><span id="l21.92">   // for reasons unknown, the pop-up does not close itself?</span>
<a href="#l21.93"></a><span id="l21.93">   close_popup(mc, mc.eid(&quot;mailContext&quot;));</span>
<a href="#l21.94"></a><span id="l21.94">   wait_for_folder_events();</span>
<a href="#l21.95"></a><span id="l21.95"> }</span>
<a href="#l21.96"></a><span id="l21.96"> </span>
<a href="#l21.97"></a><span id="l21.97"> function wait_for_popup_to_open(popupElem) {</span>
<a href="#l21.98"></a><span id="l21.98">   mark_action(&quot;fdh&quot;, &quot;wait_for_popup_to_open&quot;, [popupElem]);</span>
<a href="#l21.99"></a><span id="l21.99" class="difflineminus">-  mc.waitForEval(&quot;subject.state == 'open'&quot;, 1000, 50, popupElem);</span>
<a href="#l21.100"></a><span id="l21.100" class="difflineplus">+  utils.waitFor(function () popupElem.state == &quot;open&quot;,</span>
<a href="#l21.101"></a><span id="l21.101" class="difflineplus">+                &quot;Timeout waiting for popup to open&quot;, 1000, 50);</span>
<a href="#l21.102"></a><span id="l21.102"> }</span>
<a href="#l21.103"></a><span id="l21.103"> </span>
<a href="#l21.104"></a><span id="l21.104"> /**</span>
<a href="#l21.105"></a><span id="l21.105">  * Close the open pop-up.</span>
<a href="#l21.106"></a><span id="l21.106">  */</span>
<a href="#l21.107"></a><span id="l21.107"> function close_popup(aController, eid) {</span>
<a href="#l21.108"></a><span id="l21.108">   if (aController == null)</span>
<a href="#l21.109"></a><span id="l21.109">     aController = mc;</span>
<a href="#l21.110"></a><span id="l21.110" class="difflineat">@@ -1390,19 +1394,18 @@ function close_popup(aController, eid) {</span>
<a href="#l21.111"></a><span id="l21.111">   }</span>
<a href="#l21.112"></a><span id="l21.112">   mark_action(&quot;fdh&quot;, &quot;close_popup&quot;, [elem]);</span>
<a href="#l21.113"></a><span id="l21.113">   // if it's in the process of closing, don't push escape</span>
<a href="#l21.114"></a><span id="l21.114">   if (elem.state == &quot;hiding&quot;)</span>
<a href="#l21.115"></a><span id="l21.115">     mark_action(&quot;fdh&quot;, &quot;close_popup&quot;,</span>
<a href="#l21.116"></a><span id="l21.116">                 [&quot;popup suspiciously already closing...&quot;]);</span>
<a href="#l21.117"></a><span id="l21.117">   else // actually push escape because it's not closing/closed</span>
<a href="#l21.118"></a><span id="l21.118">     aController.keypress(eid, &quot;VK_ESCAPE&quot;, {});</span>
<a href="#l21.119"></a><span id="l21.119" class="difflineminus">-   if (!controller.waitForEval(&quot;subject.state == 'closed'&quot;, 1000, 50,</span>
<a href="#l21.120"></a><span id="l21.120" class="difflineminus">-                               elem))</span>
<a href="#l21.121"></a><span id="l21.121" class="difflineminus">-     throw new Error(&quot;Popup did not close!&quot;);</span>
<a href="#l21.122"></a><span id="l21.122" class="difflineplus">+  utils.waitFor(function () elem.state == &quot;closed&quot;, &quot;Popup did not close!&quot;,</span>
<a href="#l21.123"></a><span id="l21.123" class="difflineplus">+                1000, 50);</span>
<a href="#l21.124"></a><span id="l21.124"> }</span>
<a href="#l21.125"></a><span id="l21.125"> </span>
<a href="#l21.126"></a><span id="l21.126"> /**</span>
<a href="#l21.127"></a><span id="l21.127">  * Pretend we are pressing the delete key, triggering message deletion of the</span>
<a href="#l21.128"></a><span id="l21.128">  *  selected messages.</span>
<a href="#l21.129"></a><span id="l21.129">  *</span>
<a href="#l21.130"></a><span id="l21.130">  * @param aController The controller in whose context to do this, defaults to</span>
<a href="#l21.131"></a><span id="l21.131">  *     |mc| if omitted.</span>
<a href="#l21.132"></a><span id="l21.132" class="difflineat">@@ -1447,19 +1450,18 @@ function archive_selected_messages(aCont</span>
<a href="#l21.133"></a><span id="l21.133">   if (expectedCount &amp;&amp; aController.messageDisplay.visible)</span>
<a href="#l21.134"></a><span id="l21.134">     plan_for_message_display(aController);</span>
<a href="#l21.135"></a><span id="l21.135">   aController.keypress(null, &quot;a&quot;, {});</span>
<a href="#l21.136"></a><span id="l21.136"> </span>
<a href="#l21.137"></a><span id="l21.137">   // Wait for the view rowCount to decrease by the number of selected messages.</span>
<a href="#l21.138"></a><span id="l21.138">   let messagesDeletedFromView = function() {</span>
<a href="#l21.139"></a><span id="l21.139">     return aController.dbView.rowCount == expectedCount;</span>
<a href="#l21.140"></a><span id="l21.140">   };</span>
<a href="#l21.141"></a><span id="l21.141" class="difflineminus">-  controller.waitForEval('subject()',</span>
<a href="#l21.142"></a><span id="l21.142" class="difflineminus">-                         NORMAL_TIMEOUT,</span>
<a href="#l21.143"></a><span id="l21.143" class="difflineminus">-                         FAST_INTERVAL, messagesDeletedFromView);</span>
<a href="#l21.144"></a><span id="l21.144" class="difflineplus">+  utils.waitFor(messagesDeletedFromView,</span>
<a href="#l21.145"></a><span id="l21.145" class="difflineplus">+                &quot;Timeout waiting for messages to be archived&quot;);</span>
<a href="#l21.146"></a><span id="l21.146">   wait_for_message_display_completion(</span>
<a href="#l21.147"></a><span id="l21.147">     aController, expectedCount &amp;&amp; aController.messageDisplay.visible);</span>
<a href="#l21.148"></a><span id="l21.148">   // The above may return immediately, meaning the event queue might not get a</span>
<a href="#l21.149"></a><span id="l21.149">   //  chance.  give it a chance now.</span>
<a href="#l21.150"></a><span id="l21.150">   aController.sleep(0);</span>
<a href="#l21.151"></a><span id="l21.151"> }</span>
<a href="#l21.152"></a><span id="l21.152"> </span>
<a href="#l21.153"></a><span id="l21.153"> /**</span>
<a href="#l21.154"></a><span id="l21.154" class="difflineat">@@ -1491,19 +1493,18 @@ function press_enter(aController) {</span>
<a href="#l21.155"></a><span id="l21.155">  *  search.</span>
<a href="#l21.156"></a><span id="l21.156">  * This method is generally called automatically most of the time, and you</span>
<a href="#l21.157"></a><span id="l21.157">  *  should not need to call it yourself unless you are operating outside the</span>
<a href="#l21.158"></a><span id="l21.158">  *  helper methods in this file.</span>
<a href="#l21.159"></a><span id="l21.159">  */</span>
<a href="#l21.160"></a><span id="l21.160"> function wait_for_all_messages_to_load(aController) {</span>
<a href="#l21.161"></a><span id="l21.161">   if (aController == null)</span>
<a href="#l21.162"></a><span id="l21.162">     aController = mc;</span>
<a href="#l21.163"></a><span id="l21.163" class="difflineminus">-  if (!controller.waitForEval('subject.allMessagesLoaded', NORMAL_TIMEOUT,</span>
<a href="#l21.164"></a><span id="l21.164" class="difflineminus">-                              FAST_INTERVAL, aController.folderDisplay))</span>
<a href="#l21.165"></a><span id="l21.165" class="difflineminus">-    mark_failure([&quot;Messages never finished loading.  Timed Out.&quot;]);</span>
<a href="#l21.166"></a><span id="l21.166" class="difflineplus">+  utils.waitFor(function () aController.folderDisplay.allMessagesLoaded,</span>
<a href="#l21.167"></a><span id="l21.167" class="difflineplus">+                &quot;Messages never finished loading.  Timed Out.&quot;);</span>
<a href="#l21.168"></a><span id="l21.168">   // the above may return immediately, meaning the event queue might not get a</span>
<a href="#l21.169"></a><span id="l21.169">   //  chance.  give it a chance now.</span>
<a href="#l21.170"></a><span id="l21.170">   aController.sleep(0);</span>
<a href="#l21.171"></a><span id="l21.171"> }</span>
<a href="#l21.172"></a><span id="l21.172"> </span>
<a href="#l21.173"></a><span id="l21.173"> /**</span>
<a href="#l21.174"></a><span id="l21.174">  * Call this before triggering a message display that you are going to wait for</span>
<a href="#l21.175"></a><span id="l21.175">  *  using |wait_for_message_display_completion| where you are passing true for</span>
<a href="#l21.176"></a><span id="l21.176" class="difflineat">@@ -1600,19 +1601,18 @@ function wait_for_message_display_comple</span>
<a href="#l21.177"></a><span id="l21.177">       let urlRunningObj = {};</span>
<a href="#l21.178"></a><span id="l21.178">       uri.GetUrlState(urlRunningObj);</span>
<a href="#l21.179"></a><span id="l21.179">       // GetUrlState returns true if the url is still running</span>
<a href="#l21.180"></a><span id="l21.180">       return !urlRunningObj.value;</span>
<a href="#l21.181"></a><span id="l21.181">     }</span>
<a href="#l21.182"></a><span id="l21.182">     // not a mailnews URL, just check the busy flags...</span>
<a href="#l21.183"></a><span id="l21.183">     return !docShell.busyFlags;</span>
<a href="#l21.184"></a><span id="l21.184">   };</span>
<a href="#l21.185"></a><span id="l21.185" class="difflineminus">-  if (!controller.waitForEval('subject()', NORMAL_TIMEOUT, FAST_INTERVAL,</span>
<a href="#l21.186"></a><span id="l21.186" class="difflineminus">-                              isLoadedChecker))</span>
<a href="#l21.187"></a><span id="l21.187" class="difflineminus">-    mark_failure([&quot;Timed out waiting for message display completion.&quot;]);</span>
<a href="#l21.188"></a><span id="l21.188" class="difflineplus">+  utils.waitFor(isLoadedChecker,</span>
<a href="#l21.189"></a><span id="l21.189" class="difflineplus">+                &quot;Timed out waiting for message display completion.&quot;);</span>
<a href="#l21.190"></a><span id="l21.190">   // the above may return immediately, meaning the event queue might not get a</span>
<a href="#l21.191"></a><span id="l21.191">   //  chance.  give it a chance now.</span>
<a href="#l21.192"></a><span id="l21.192">   aController.sleep(0);</span>
<a href="#l21.193"></a><span id="l21.193">   mark_action(&quot;fdhb&quot;, &quot;/wait_for_message_display_completion&quot;,</span>
<a href="#l21.194"></a><span id="l21.194">               [&quot;waited?&quot;, checkCount &gt; 1]);</span>
<a href="#l21.195"></a><span id="l21.195"> }</span>
<a href="#l21.196"></a><span id="l21.196"> </span>
<a href="#l21.197"></a><span id="l21.197"> /**</span>
<a href="#l21.198"></a><span id="l21.198" class="difflineat">@@ -1625,20 +1625,23 @@ function wait_for_message_display_comple</span>
<a href="#l21.199"></a><span id="l21.199"> function wait_for_blank_content_pane(aController) {</span>
<a href="#l21.200"></a><span id="l21.200">   if (aController == null)</span>
<a href="#l21.201"></a><span id="l21.201">     aController = mc;</span>
<a href="#l21.202"></a><span id="l21.202">   mark_action(&quot;fdh&quot;, &quot;wait_for_blank_content_pane&quot;, []);</span>
<a href="#l21.203"></a><span id="l21.203"> </span>
<a href="#l21.204"></a><span id="l21.204">   let isBlankChecker = function() {</span>
<a href="#l21.205"></a><span id="l21.205">     return aController.window.content.location.href == &quot;about:blank&quot;;</span>
<a href="#l21.206"></a><span id="l21.206">   };</span>
<a href="#l21.207"></a><span id="l21.207" class="difflineminus">-  if (!controller.waitForEval('subject()', NORMAL_TIMEOUT, FAST_INTERVAL,</span>
<a href="#l21.208"></a><span id="l21.208" class="difflineminus">-                              isBlankChecker))</span>
<a href="#l21.209"></a><span id="l21.209" class="difflineplus">+  try {</span>
<a href="#l21.210"></a><span id="l21.210" class="difflineplus">+    utils.waitFor(isBlankChecker);</span>
<a href="#l21.211"></a><span id="l21.211" class="difflineplus">+  } catch (e if e instanceof utils.TimeoutError) {</span>
<a href="#l21.212"></a><span id="l21.212">     mark_failure([&quot;Timeout waiting for blank content pane.  Current location:&quot;,</span>
<a href="#l21.213"></a><span id="l21.213">                   aController.window.content.location.href]);</span>
<a href="#l21.214"></a><span id="l21.214" class="difflineplus">+  }</span>
<a href="#l21.215"></a><span id="l21.215" class="difflineplus">+</span>
<a href="#l21.216"></a><span id="l21.216">   // the above may return immediately, meaning the event queue might not get a</span>
<a href="#l21.217"></a><span id="l21.217">   //  chance.  give it a chance now.</span>
<a href="#l21.218"></a><span id="l21.218">   aController.sleep(0);</span>
<a href="#l21.219"></a><span id="l21.219">   mark_action(&quot;fdh&quot;, &quot;/wait_for_blank_content_pane&quot;, []);</span>
<a href="#l21.220"></a><span id="l21.220"> }</span>
<a href="#l21.221"></a><span id="l21.221"> </span>
<a href="#l21.222"></a><span id="l21.222"> </span>
<a href="#l21.223"></a><span id="l21.223"> var FolderListener = {</span>
<a href="#l21.224"></a><span id="l21.224" class="difflineat">@@ -1662,19 +1665,22 @@ var FolderListener = {</span>
<a href="#l21.225"></a><span id="l21.225">     this.sawEvents = false;</span>
<a href="#l21.226"></a><span id="l21.226">     this.watchingFor = [];</span>
<a href="#l21.227"></a><span id="l21.227">     for (let i = 0; i &lt; arguments.length; i++)</span>
<a href="#l21.228"></a><span id="l21.228">       this.watchingFor[i] = arguments[i];</span>
<a href="#l21.229"></a><span id="l21.229">   },</span>
<a href="#l21.230"></a><span id="l21.230">   waitForEvents: function FolderListener_waitForEvents() {</span>
<a href="#l21.231"></a><span id="l21.231">     if (this.sawEvents)</span>
<a href="#l21.232"></a><span id="l21.232">       return;</span>
<a href="#l21.233"></a><span id="l21.233" class="difflineminus">-    if (!controller.waitForEval('subject.sawEvents', NORMAL_TIMEOUT,</span>
<a href="#l21.234"></a><span id="l21.234" class="difflineminus">-                                FAST_INTERVAL, this))</span>
<a href="#l21.235"></a><span id="l21.235" class="difflineplus">+    let self = this;</span>
<a href="#l21.236"></a><span id="l21.236" class="difflineplus">+    try {</span>
<a href="#l21.237"></a><span id="l21.237" class="difflineplus">+      utils.waitFor(function () self.sawEvents);</span>
<a href="#l21.238"></a><span id="l21.238" class="difflineplus">+    } catch (e if e instanceof utils.TimeoutError) {</span>
<a href="#l21.239"></a><span id="l21.239">       mark_failure([&quot;Timeout waiting for events:&quot;, this.watchingFor]);</span>
<a href="#l21.240"></a><span id="l21.240" class="difflineplus">+    }</span>
<a href="#l21.241"></a><span id="l21.241">   },</span>
<a href="#l21.242"></a><span id="l21.242"> </span>
<a href="#l21.243"></a><span id="l21.243">   OnItemEvent: function FolderNotificationHelper_OnItemEvent(</span>
<a href="#l21.244"></a><span id="l21.244">       aFolder, aEvent) {</span>
<a href="#l21.245"></a><span id="l21.245">     if (!this.watchingFor)</span>
<a href="#l21.246"></a><span id="l21.246">       return;</span>
<a href="#l21.247"></a><span id="l21.247">     if (this.watchingFor.indexOf(aEvent.toString()) != -1) {</span>
<a href="#l21.248"></a><span id="l21.248">       this.watchingFor = null;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-junk-helpers.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-junk-helpers.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -38,29 +38,26 @@</span>
<a href="#l22.4"></a><span id="l22.4"> var Ci = Components.interfaces;</span>
<a href="#l22.5"></a><span id="l22.5"> var Cc = Components.classes;</span>
<a href="#l22.6"></a><span id="l22.6"> var Cu = Components.utils;</span>
<a href="#l22.7"></a><span id="l22.7"> </span>
<a href="#l22.8"></a><span id="l22.8"> var elib = {};</span>
<a href="#l22.9"></a><span id="l22.9"> Cu.import('resource://mozmill/modules/elementslib.js', elib);</span>
<a href="#l22.10"></a><span id="l22.10"> var mozmill = {};</span>
<a href="#l22.11"></a><span id="l22.11"> Cu.import('resource://mozmill/modules/mozmill.js', mozmill);</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-var controller = {};</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineminus">-Cu.import('resource://mozmill/modules/controller.js', controller);</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineplus">+var utils = {};</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineplus">+Cu.import(&quot;resource://mozmill/modules/utils.js&quot;, utils);</span>
<a href="#l22.16"></a><span id="l22.16"> </span>
<a href="#l22.17"></a><span id="l22.17"> const MODULE_NAME = 'junk-helpers';</span>
<a href="#l22.18"></a><span id="l22.18"> </span>
<a href="#l22.19"></a><span id="l22.19"> const RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l22.20"></a><span id="l22.20"> </span>
<a href="#l22.21"></a><span id="l22.21"> // we need this for the main controller</span>
<a href="#l22.22"></a><span id="l22.22"> const MODULE_REQUIRES = ['folder-display-helpers'];</span>
<a href="#l22.23"></a><span id="l22.23"> </span>
<a href="#l22.24"></a><span id="l22.24" class="difflineminus">-const NORMAL_TIMEOUT = 6000;</span>
<a href="#l22.25"></a><span id="l22.25" class="difflineminus">-const FAST_INTERVAL = 100;</span>
<a href="#l22.26"></a><span id="l22.26" class="difflineminus">-</span>
<a href="#l22.27"></a><span id="l22.27"> var folderDisplayHelper;</span>
<a href="#l22.28"></a><span id="l22.28"> var mc;</span>
<a href="#l22.29"></a><span id="l22.29"> </span>
<a href="#l22.30"></a><span id="l22.30"> // logHelper (and therefore folderDisplayHelper) exports</span>
<a href="#l22.31"></a><span id="l22.31"> var mark_failure;</span>
<a href="#l22.32"></a><span id="l22.32"> </span>
<a href="#l22.33"></a><span id="l22.33"> function setupModule() {</span>
<a href="#l22.34"></a><span id="l22.34">   folderDisplayHelper = collector.getModule('folder-display-helpers');</span>
<a href="#l22.35"></a><span id="l22.35" class="difflineat">@@ -169,21 +166,20 @@ function delete_mail_marked_as_junk(aNum</span>
<a href="#l22.36"></a><span id="l22.36">     //       allow listeners to be passed in.</span>
<a href="#l22.37"></a><span id="l22.37">     //</span>
<a href="#l22.38"></a><span id="l22.38">     // The solution adopted is to use a combination of 3 and having</span>
<a href="#l22.39"></a><span id="l22.39">     // deleteJunkInFolder return the number of messages deleted. This embraces</span>
<a href="#l22.40"></a><span id="l22.40">     // the unavoidability of a) above, solves b), and side-steps c) (which is</span>
<a href="#l22.41"></a><span id="l22.41">     // fine, because we already have all sorts of events when messages are</span>
<a href="#l22.42"></a><span id="l22.42">     // deleted). The only assumption is that deleteJunkInFolder is synchronous</span>
<a href="#l22.43"></a><span id="l22.43">     // if no messages are deleted.</span>
<a href="#l22.44"></a><span id="l22.44" class="difflineminus">-    if (!controller.waitForEval(&quot;subject != null&quot;, NORMAL_TIMEOUT,</span>
<a href="#l22.45"></a><span id="l22.45" class="difflineminus">-                                FAST_INTERVAL, numMessagesDeleted))</span>
<a href="#l22.46"></a><span id="l22.46" class="difflineminus">-      mark_failure([&quot;Timeout waiting for numMessagesDeleted to turn &quot; +</span>
<a href="#l22.47"></a><span id="l22.47" class="difflineminus">-                    &quot;non-null. This either means that deleteJunkInFolder &quot; +</span>
<a href="#l22.48"></a><span id="l22.48" class="difflineminus">-                    &quot;didn't get called or that it didn't return a value.&quot;]);</span>
<a href="#l22.49"></a><span id="l22.49" class="difflineplus">+    utils.waitFor(function () numMessagesDeleted != null,</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineplus">+                  &quot;Timeout waiting for numMessagesDeleted to turn &quot; +</span>
<a href="#l22.51"></a><span id="l22.51" class="difflineplus">+                  &quot;non-null. This either means that deleteJunkInFolder &quot; +</span>
<a href="#l22.52"></a><span id="l22.52" class="difflineplus">+                  &quot;didn't get called or that it didn't return a value.&quot;);</span>
<a href="#l22.53"></a><span id="l22.53"> </span>
<a href="#l22.54"></a><span id="l22.54">     // Check the number of deleted messages.</span>
<a href="#l22.55"></a><span id="l22.55">     if (aNumDeletesExpected != numMessagesDeleted)</span>
<a href="#l22.56"></a><span id="l22.56">       mark_failure([&quot;Expected&quot;, aNumDeletesExpected, &quot;deletes, but&quot;,</span>
<a href="#l22.57"></a><span id="l22.57">                     numMessagesDeleted, &quot;happened&quot;]);</span>
<a href="#l22.58"></a><span id="l22.58">   }</span>
<a href="#l22.59"></a><span id="l22.59">   finally {</span>
<a href="#l22.60"></a><span id="l22.60">     aController.window.deleteJunkInFolder = realDeleteJunkInFolder;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-pref-window-helpers.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-pref-window-helpers.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -39,28 +39,25 @@</span>
<a href="#l23.4"></a><span id="l23.4"> /*</span>
<a href="#l23.5"></a><span id="l23.5">  * Helpers to deal with the preferences window.</span>
<a href="#l23.6"></a><span id="l23.6">  */</span>
<a href="#l23.7"></a><span id="l23.7"> </span>
<a href="#l23.8"></a><span id="l23.8"> var Ci = Components.interfaces;</span>
<a href="#l23.9"></a><span id="l23.9"> var Cc = Components.classes;</span>
<a href="#l23.10"></a><span id="l23.10"> var Cu = Components.utils;</span>
<a href="#l23.11"></a><span id="l23.11"> </span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-var controller = {};</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">-Cu.import(&quot;resource://mozmill/modules/controller.js&quot;, controller);</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineplus">+var utils = {};</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineplus">+Cu.import(&quot;resource://mozmill/modules/utils.js&quot;, utils);</span>
<a href="#l23.16"></a><span id="l23.16"> </span>
<a href="#l23.17"></a><span id="l23.17"> const MODULE_NAME = &quot;pref-window-helpers&quot;;</span>
<a href="#l23.18"></a><span id="l23.18"> </span>
<a href="#l23.19"></a><span id="l23.19"> const RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l23.20"></a><span id="l23.20"> </span>
<a href="#l23.21"></a><span id="l23.21"> const MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l23.22"></a><span id="l23.22"> </span>
<a href="#l23.23"></a><span id="l23.23" class="difflineminus">-const NORMAL_TIMEOUT = 6000;</span>
<a href="#l23.24"></a><span id="l23.24" class="difflineminus">-const FAST_INTERVAL = 100;</span>
<a href="#l23.25"></a><span id="l23.25" class="difflineminus">-</span>
<a href="#l23.26"></a><span id="l23.26"> var fdh;</span>
<a href="#l23.27"></a><span id="l23.27"> var wh;</span>
<a href="#l23.28"></a><span id="l23.28"> </span>
<a href="#l23.29"></a><span id="l23.29"> function setupModule() {</span>
<a href="#l23.30"></a><span id="l23.30">   fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l23.31"></a><span id="l23.31">   wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l23.32"></a><span id="l23.32"> }</span>
<a href="#l23.33"></a><span id="l23.33"> </span>
<a href="#l23.34"></a><span id="l23.34" class="difflineat">@@ -86,20 +83,17 @@ function installInto(module) {</span>
<a href="#l23.35"></a><span id="l23.35">  */</span>
<a href="#l23.36"></a><span id="l23.36"> function open_pref_window(aPaneID, aCallback) {</span>
<a href="#l23.37"></a><span id="l23.37">   function waitForPaneLoad(prefc) {</span>
<a href="#l23.38"></a><span id="l23.38">     let pane = prefc.e(aPaneID);</span>
<a href="#l23.39"></a><span id="l23.39">     function paneLoadedChecker() {</span>
<a href="#l23.40"></a><span id="l23.40">       return pane.loaded;</span>
<a href="#l23.41"></a><span id="l23.41">     }</span>
<a href="#l23.42"></a><span id="l23.42"> </span>
<a href="#l23.43"></a><span id="l23.43" class="difflineminus">-    if (!controller.waitForEval(&quot;subject()&quot;, NORMAL_TIMEOUT, FAST_INTERVAL,</span>
<a href="#l23.44"></a><span id="l23.44" class="difflineminus">-                                paneLoadedChecker))</span>
<a href="#l23.45"></a><span id="l23.45" class="difflineminus">-      throw new Error(&quot;Timed out waiting for prefpane &quot; + aPaneID +</span>
<a href="#l23.46"></a><span id="l23.46" class="difflineminus">-                      &quot; to load.&quot;);</span>
<a href="#l23.47"></a><span id="l23.47" class="difflineminus">-</span>
<a href="#l23.48"></a><span id="l23.48" class="difflineplus">+    utils.waitFor(paneLoadedChecker,</span>
<a href="#l23.49"></a><span id="l23.49" class="difflineplus">+                  &quot;Timed out waiting for prefpane &quot; + aPaneID + &quot; to load.&quot;);</span>
<a href="#l23.50"></a><span id="l23.50">     aCallback(prefc);</span>
<a href="#l23.51"></a><span id="l23.51">   }</span>
<a href="#l23.52"></a><span id="l23.52"> </span>
<a href="#l23.53"></a><span id="l23.53">   wh.plan_for_modal_dialog(&quot;Mail:Preferences&quot;, waitForPaneLoad);</span>
<a href="#l23.54"></a><span id="l23.54">   fdh.mc.window.openOptionsDialog(aPaneID);</span>
<a href="#l23.55"></a><span id="l23.55">   wh.wait_for_modal_dialog(&quot;Mail:Preferences&quot;);</span>
<a href="#l23.56"></a><span id="l23.56"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-window-helpers.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-window-helpers.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -42,16 +42,18 @@ var Cu = Components.utils;</span>
<a href="#l24.4"></a><span id="l24.4"> var mozmill = {};</span>
<a href="#l24.5"></a><span id="l24.5"> Cu.import('resource://mozmill/modules/mozmill.js', mozmill);</span>
<a href="#l24.6"></a><span id="l24.6"> var controller = {};</span>
<a href="#l24.7"></a><span id="l24.7"> Cu.import('resource://mozmill/modules/controller.js', controller);</span>
<a href="#l24.8"></a><span id="l24.8"> var elib = {};</span>
<a href="#l24.9"></a><span id="l24.9"> Cu.import('resource://mozmill/modules/elementslib.js', elib);</span>
<a href="#l24.10"></a><span id="l24.10"> var frame = {};</span>
<a href="#l24.11"></a><span id="l24.11"> Cu.import('resource://mozmill/modules/frame.js', frame);</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineplus">+var utils = {};</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+Cu.import('resource://mozmill/modules/utils.js', utils);</span>
<a href="#l24.14"></a><span id="l24.14"> </span>
<a href="#l24.15"></a><span id="l24.15"> Cu.import('resource:///modules/iteratorUtils.jsm');</span>
<a href="#l24.16"></a><span id="l24.16"> </span>
<a href="#l24.17"></a><span id="l24.17"> const MODULE_NAME = 'window-helpers';</span>
<a href="#l24.18"></a><span id="l24.18"> </span>
<a href="#l24.19"></a><span id="l24.19"> /**</span>
<a href="#l24.20"></a><span id="l24.20">  * Timeout to use when waiting for the first window ever to load.  This is</span>
<a href="#l24.21"></a><span id="l24.21">  *  long because we are basically waiting for the entire app startup process.</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineat">@@ -270,24 +272,24 @@ var WindowWatcher = {</span>
<a href="#l24.23"></a><span id="l24.23">   waitingForOpen: null,</span>
<a href="#l24.24"></a><span id="l24.24">   /**</span>
<a href="#l24.25"></a><span id="l24.25">    * Wait for the given windowType to open and finish loading.</span>
<a href="#l24.26"></a><span id="l24.26">    *</span>
<a href="#l24.27"></a><span id="l24.27">    * @return The window wrapped in a MozMillController.</span>
<a href="#l24.28"></a><span id="l24.28">    */</span>
<a href="#l24.29"></a><span id="l24.29">   waitForWindowOpen: function WindowWatcher_waitForWindowOpen(aWindowType) {</span>
<a href="#l24.30"></a><span id="l24.30">     this.waitingForOpen = aWindowType;</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineminus">-    if (!controller.waitForEval(</span>
<a href="#l24.32"></a><span id="l24.32" class="difflineminus">-          'subject.monitorizeOpen()',</span>
<a href="#l24.33"></a><span id="l24.33" class="difflineminus">-          this._firstWindowOpened ? WINDOW_OPEN_TIMEOUT_MS</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineminus">-            : FIRST_WINDOW_EVER_TIMEOUT_MS,</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineminus">-          this._firstWindowOpened ? WINDOW_OPEN_CHECK_INTERVAL_MS</span>
<a href="#l24.36"></a><span id="l24.36" class="difflineminus">-            : FIRST_WINDOW_CHECK_INTERVAL_MS,</span>
<a href="#l24.37"></a><span id="l24.37" class="difflineminus">-          this))</span>
<a href="#l24.38"></a><span id="l24.38" class="difflineminus">-      throw new Error(&quot;Timed out waiting for window open!&quot;);</span>
<a href="#l24.39"></a><span id="l24.39" class="difflineplus">+    utils.waitFor(function () this.monitorizeOpen(),</span>
<a href="#l24.40"></a><span id="l24.40" class="difflineplus">+                  &quot;Timed out waiting for window open!&quot;,</span>
<a href="#l24.41"></a><span id="l24.41" class="difflineplus">+                  this._firstWindowOpened ? WINDOW_OPEN_TIMEOUT_MS</span>
<a href="#l24.42"></a><span id="l24.42" class="difflineplus">+                    : FIRST_WINDOW_EVER_TIMEOUT_MS,</span>
<a href="#l24.43"></a><span id="l24.43" class="difflineplus">+                  this._firstWindowOpened ? WINDOW_OPEN_CHECK_INTERVAL_MS</span>
<a href="#l24.44"></a><span id="l24.44" class="difflineplus">+                    : FIRST_WINDOW_CHECK_INTERVAL_MS,</span>
<a href="#l24.45"></a><span id="l24.45" class="difflineplus">+                  this);</span>
<a href="#l24.46"></a><span id="l24.46" class="difflineplus">+</span>
<a href="#l24.47"></a><span id="l24.47">     this.waitingForOpen = null;</span>
<a href="#l24.48"></a><span id="l24.48">     let xulWindow = this.waitingList[aWindowType];</span>
<a href="#l24.49"></a><span id="l24.49">     let domWindow = xulWindow.docShell.QueryInterface(Ci.nsIInterfaceRequestor)</span>
<a href="#l24.50"></a><span id="l24.50">                                       .getInterface(Ci.nsIDOMWindow);</span>
<a href="#l24.51"></a><span id="l24.51">     delete this.waitingList[aWindowType];</span>
<a href="#l24.52"></a><span id="l24.52">     // spin the event loop to make sure any setTimeout 0 calls have gotten their</span>
<a href="#l24.53"></a><span id="l24.53">     //  time in the sun.</span>
<a href="#l24.54"></a><span id="l24.54">     controller.sleep(0);</span>
<a href="#l24.55"></a><span id="l24.55" class="difflineat">@@ -296,18 +298,18 @@ var WindowWatcher = {</span>
<a href="#l24.56"></a><span id="l24.56">     mark_action(&quot;winhelp&quot;, &quot;new MozMillController()&quot;, [aWindowType]);</span>
<a href="#l24.57"></a><span id="l24.57">     let c = new controller.MozMillController(domWindow);</span>
<a href="#l24.58"></a><span id="l24.58">     mark_action(&quot;winhelp&quot;, &quot;/new MozMillController()&quot;, [aWindowType]);</span>
<a href="#l24.59"></a><span id="l24.59">     return c;</span>
<a href="#l24.60"></a><span id="l24.60">   },</span>
<a href="#l24.61"></a><span id="l24.61"> </span>
<a href="#l24.62"></a><span id="l24.62">   /**</span>
<a href="#l24.63"></a><span id="l24.63">    * Because the modal dialog spins its own event loop, the mozmill idiom of</span>
<a href="#l24.64"></a><span id="l24.64" class="difflineminus">-   *  spinning your own event-loop as performed by waitForEval is no good.  We</span>
<a href="#l24.65"></a><span id="l24.65" class="difflineminus">-   *  use this timer to generate our events so that we can have a waitForEval</span>
<a href="#l24.66"></a><span id="l24.66" class="difflineplus">+   *  spinning your own event-loop as performed by waitFor is no good.  We use</span>
<a href="#l24.67"></a><span id="l24.67" class="difflineplus">+   *  this timer to generate our events so that we can have a waitFor</span>
<a href="#l24.68"></a><span id="l24.68">    *  equivalent.</span>
<a href="#l24.69"></a><span id="l24.69">    *</span>
<a href="#l24.70"></a><span id="l24.70">    * We only have one timer right now because modal dialogs that spawn modal</span>
<a href="#l24.71"></a><span id="l24.71">    *  dialogs are not tremendously likely.</span>
<a href="#l24.72"></a><span id="l24.72">    */</span>
<a href="#l24.73"></a><span id="l24.73">   _timer: null,</span>
<a href="#l24.74"></a><span id="l24.74">   _timerRuntimeSoFar: 0,</span>
<a href="#l24.75"></a><span id="l24.75">   /**</span>
<a href="#l24.76"></a><span id="l24.76" class="difflineat">@@ -372,20 +374,21 @@ var WindowWatcher = {</span>
<a href="#l24.77"></a><span id="l24.77">    * Symmetry for planForModalDialog; conceptually provides the waiting.  In</span>
<a href="#l24.78"></a><span id="l24.78">    *  reality, all we do is potentially soak up the event loop a little to</span>
<a href="#l24.79"></a><span id="l24.79">    */</span>
<a href="#l24.80"></a><span id="l24.80">   waitForModalDialog: function WindowWatcher_waitForModalDialog(aWindowType, aTimeout) {</span>
<a href="#l24.81"></a><span id="l24.81">     // did the window already come and go?</span>
<a href="#l24.82"></a><span id="l24.82">     if (this.subTestFunc == null)</span>
<a href="#l24.83"></a><span id="l24.83">       return;</span>
<a href="#l24.84"></a><span id="l24.84">     // spin the event loop until we the window has come and gone.</span>
<a href="#l24.85"></a><span id="l24.85" class="difflineminus">-    if (!controller.waitForEval(</span>
<a href="#l24.86"></a><span id="l24.86" class="difflineminus">-           'subject.waitingForOpen == null &amp;&amp; subject.monitorizeClose()',</span>
<a href="#l24.87"></a><span id="l24.87" class="difflineminus">-            aTimeout || WINDOW_OPEN_TIMEOUT_MS, WINDOW_OPEN_CHECK_INTERVAL_MS, this))</span>
<a href="#l24.88"></a><span id="l24.88" class="difflineminus">-      throw new Error(&quot;Timeout waiting for modal dialog to open.&quot;);</span>
<a href="#l24.89"></a><span id="l24.89" class="difflineplus">+    utils.waitFor(function () (this.waitingForOpen == null &amp;&amp;</span>
<a href="#l24.90"></a><span id="l24.90" class="difflineplus">+                               this.monitorizeClose()),</span>
<a href="#l24.91"></a><span id="l24.91" class="difflineplus">+                  &quot;Timeout waiting for modal dialog to open.&quot;,</span>
<a href="#l24.92"></a><span id="l24.92" class="difflineplus">+                  aTimeout || WINDOW_OPEN_TIMEOUT_MS,</span>
<a href="#l24.93"></a><span id="l24.93" class="difflineplus">+                  WINDOW_OPEN_CHECK_INTERVAL_MS, this);</span>
<a href="#l24.94"></a><span id="l24.94">     this.waitingForClose = null;</span>
<a href="#l24.95"></a><span id="l24.95">   },</span>
<a href="#l24.96"></a><span id="l24.96"> </span>
<a href="#l24.97"></a><span id="l24.97">   planForWindowClose: function WindowWatcher_planForWindowClose(aXULWindow) {</span>
<a href="#l24.98"></a><span id="l24.98">     let windowType =</span>
<a href="#l24.99"></a><span id="l24.99">       aXULWindow.document.documentElement.getAttribute(&quot;windowtype&quot;) ||</span>
<a href="#l24.100"></a><span id="l24.100">       aXULWindow.document.documentElement.getAttribute(&quot;id&quot;);</span>
<a href="#l24.101"></a><span id="l24.101">     this.waitingList[windowType] = aXULWindow;</span>
<a href="#l24.102"></a><span id="l24.102" class="difflineat">@@ -393,20 +396,19 @@ var WindowWatcher = {</span>
<a href="#l24.103"></a><span id="l24.103">   },</span>
<a href="#l24.104"></a><span id="l24.104"> </span>
<a href="#l24.105"></a><span id="l24.105">   /**</span>
<a href="#l24.106"></a><span id="l24.106">    * The current windowType we are waiting to close.  Same deal as</span>
<a href="#l24.107"></a><span id="l24.107">    *  waitingForOpen, this makes the eval less crazy.</span>
<a href="#l24.108"></a><span id="l24.108">    */</span>
<a href="#l24.109"></a><span id="l24.109">   waitingForClose: null,</span>
<a href="#l24.110"></a><span id="l24.110">   waitForWindowClose: function WindowWatcher_waitForWindowClose() {</span>
<a href="#l24.111"></a><span id="l24.111" class="difflineminus">-    if (!controller.waitForEval('subject.monitorizeClose()',</span>
<a href="#l24.112"></a><span id="l24.112" class="difflineminus">-                                WINDOW_CLOSE_TIMEOUT_MS,</span>
<a href="#l24.113"></a><span id="l24.113" class="difflineminus">-                                WINDOW_CLOSE_CHECK_INTERVAL_MS, this))</span>
<a href="#l24.114"></a><span id="l24.114" class="difflineminus">-      throw new Error(&quot;Timeout waiting for window to close!&quot;);</span>
<a href="#l24.115"></a><span id="l24.115" class="difflineplus">+    utils.waitFor(function () this.monitorizeClose(),</span>
<a href="#l24.116"></a><span id="l24.116" class="difflineplus">+                  &quot;Timeout waiting for window to close!&quot;,</span>
<a href="#l24.117"></a><span id="l24.117" class="difflineplus">+      WINDOW_CLOSE_TIMEOUT_MS, WINDOW_CLOSE_CHECK_INTERVAL_MS, this);</span>
<a href="#l24.118"></a><span id="l24.118">     let didDisappear = this.waitingList[this.waitingForClose] == null;</span>
<a href="#l24.119"></a><span id="l24.119">     delete this.waitingList[windowType];</span>
<a href="#l24.120"></a><span id="l24.120">     let windowType = this.waitingForClose;</span>
<a href="#l24.121"></a><span id="l24.121">     this.waitingForClose = null;</span>
<a href="#l24.122"></a><span id="l24.122">     if (!didDisappear)</span>
<a href="#l24.123"></a><span id="l24.123">       throw new Error(windowType + &quot; window did not disappear!&quot;);</span>
<a href="#l24.124"></a><span id="l24.124">   },</span>
<a href="#l24.125"></a><span id="l24.125"> </span>
<a href="#l24.126"></a><span id="l24.126" class="difflineat">@@ -683,21 +685,18 @@ function plan_for_observable_event(aTopi</span>
<a href="#l24.127"></a><span id="l24.127">  * @param aTopic The topic sent via the observer service.</span>
<a href="#l24.128"></a><span id="l24.128">  */</span>
<a href="#l24.129"></a><span id="l24.129"> function wait_for_observable_event(aTopic) {</span>
<a href="#l24.130"></a><span id="l24.130">   mark_action(&quot;fdh&quot;, &quot;wait_for_observable_event&quot;, [aTopic]);</span>
<a href="#l24.131"></a><span id="l24.131">   try {</span>
<a href="#l24.132"></a><span id="l24.132">     function areWeThereYet() {</span>
<a href="#l24.133"></a><span id="l24.133">       return observationSaw[aTopic];</span>
<a href="#l24.134"></a><span id="l24.134">     }</span>
<a href="#l24.135"></a><span id="l24.135" class="difflineminus">-    if (!controller.waitForEval(</span>
<a href="#l24.136"></a><span id="l24.136" class="difflineminus">-          'subject()',</span>
<a href="#l24.137"></a><span id="l24.137" class="difflineminus">-          3000, 50,</span>
<a href="#l24.138"></a><span id="l24.138" class="difflineminus">-          areWeThereYet))</span>
<a href="#l24.139"></a><span id="l24.139" class="difflineminus">-      throw new Error(&quot;Timed out waiting for notification: &quot; + aTopic);</span>
<a href="#l24.140"></a><span id="l24.140" class="difflineplus">+    utils.waitFor(areWeThereYet,</span>
<a href="#l24.141"></a><span id="l24.141" class="difflineplus">+                  &quot;Timed out waiting for notification: &quot; + aTopic);</span>
<a href="#l24.142"></a><span id="l24.142">   }</span>
<a href="#l24.143"></a><span id="l24.143">   finally {</span>
<a href="#l24.144"></a><span id="l24.144">     obsService.removeObserver(observationWaitFuncs[aTopic], aTopic);</span>
<a href="#l24.145"></a><span id="l24.145">     delete observationWaitFuncs[aTopic];</span>
<a href="#l24.146"></a><span id="l24.146">     delete observationSaw[aTopic];</span>
<a href="#l24.147"></a><span id="l24.147">   }</span>
<a href="#l24.148"></a><span id="l24.148"> }</span>
<a href="#l24.149"></a><span id="l24.149"> </span>
<a href="#l24.150"></a><span id="l24.150" class="difflineat">@@ -845,20 +844,18 @@ var AugmentEverybodyWith = {</span>
<a href="#l24.151"></a><span id="l24.151">      *     attribute with a single value.  We pick the menu option whose DOM</span>
<a href="#l24.152"></a><span id="l24.152">      *     node has an attribute with that name and value.  We click whatever we</span>
<a href="#l24.153"></a><span id="l24.153">      *     find.  We throw if we don't find what you were asking for.</span>
<a href="#l24.154"></a><span id="l24.154">      */</span>
<a href="#l24.155"></a><span id="l24.155">     click_menus_in_sequence: function _click_menus(aRootPopup, aActions) {</span>
<a href="#l24.156"></a><span id="l24.156">       if (aRootPopup.state == &quot;closed&quot;)</span>
<a href="#l24.157"></a><span id="l24.157">         aRootPopup.openPopup(null, &quot;&quot;, 0, 0, true, true);</span>
<a href="#l24.158"></a><span id="l24.158">       if (aRootPopup.state != &quot;open&quot;) { // handle &quot;showing&quot;</span>
<a href="#l24.159"></a><span id="l24.159" class="difflineminus">-        if (!controller.waitForEval(&quot;subject.state == 'open'&quot;, 1000, 50,</span>
<a href="#l24.160"></a><span id="l24.160" class="difflineminus">-                                    aRootPopup)) {</span>
<a href="#l24.161"></a><span id="l24.161" class="difflineminus">-          throw new Error(&quot;Popup never opened!&quot;);</span>
<a href="#l24.162"></a><span id="l24.162" class="difflineminus">-        }</span>
<a href="#l24.163"></a><span id="l24.163" class="difflineplus">+        utils.waitFor(function () aRootPopup.state == &quot;open&quot;,</span>
<a href="#l24.164"></a><span id="l24.164" class="difflineplus">+                      &quot;Popup never opened!&quot;, 1000, 50);</span>
<a href="#l24.165"></a><span id="l24.165">       }</span>
<a href="#l24.166"></a><span id="l24.166">       // These popups sadly do not close themselves, so we need to keep track</span>
<a href="#l24.167"></a><span id="l24.167">       //  of them so we can make sure they end up closed.</span>
<a href="#l24.168"></a><span id="l24.168">       let closeStack = [aRootPopup];</span>
<a href="#l24.169"></a><span id="l24.169"> </span>
<a href="#l24.170"></a><span id="l24.170">       let curPopup = aRootPopup;</span>
<a href="#l24.171"></a><span id="l24.171">       for each (let [iAction, actionObj] in Iterator(aActions)) {</span>
<a href="#l24.172"></a><span id="l24.172">         let matchingNode = null;</span>
<a href="#l24.173"></a><span id="l24.173" class="difflineat">@@ -884,29 +881,27 @@ var AugmentEverybodyWith = {</span>
<a href="#l24.174"></a><span id="l24.174">         if (!matchingNode)</span>
<a href="#l24.175"></a><span id="l24.175">           throw new Error(&quot;Did not find matching menu item for action index &quot; +</span>
<a href="#l24.176"></a><span id="l24.176">                           iAction);</span>
<a href="#l24.177"></a><span id="l24.177"> </span>
<a href="#l24.178"></a><span id="l24.178">         this.click(new elib.Elem(matchingNode));</span>
<a href="#l24.179"></a><span id="l24.179">         if (&quot;menupopup&quot; in matchingNode) {</span>
<a href="#l24.180"></a><span id="l24.180">           curPopup = matchingNode.menupopup;</span>
<a href="#l24.181"></a><span id="l24.181">           closeStack.push(curPopup);</span>
<a href="#l24.182"></a><span id="l24.182" class="difflineminus">-          if (!controller.waitForEval(&quot;subject.state == 'open'&quot;, 1000, 50,</span>
<a href="#l24.183"></a><span id="l24.183" class="difflineminus">-                                      curPopup)) {</span>
<a href="#l24.184"></a><span id="l24.184" class="difflineminus">-            throw new Error(&quot;Popup never opened at action depth: &quot; + iAction);</span>
<a href="#l24.185"></a><span id="l24.185" class="difflineminus">-          }</span>
<a href="#l24.186"></a><span id="l24.186" class="difflineplus">+          utils.waitFor(function () curPopup.state == &quot;open&quot;,</span>
<a href="#l24.187"></a><span id="l24.187" class="difflineplus">+                        &quot;Popup never opened at action depth: &quot; + iAction,</span>
<a href="#l24.188"></a><span id="l24.188" class="difflineplus">+                        1000, 50);</span>
<a href="#l24.189"></a><span id="l24.189">         }</span>
<a href="#l24.190"></a><span id="l24.190">       }</span>
<a href="#l24.191"></a><span id="l24.191"> </span>
<a href="#l24.192"></a><span id="l24.192">       while (closeStack.length) {</span>
<a href="#l24.193"></a><span id="l24.193">         curPopup = closeStack.pop();</span>
<a href="#l24.194"></a><span id="l24.194">         this.keypress(new elib.Elem(curPopup), &quot;VK_ESCAPE&quot;, {});</span>
<a href="#l24.195"></a><span id="l24.195" class="difflineminus">-        if (!controller.waitForEval(&quot;subject.state == 'closed'&quot;, 1000, 50,</span>
<a href="#l24.196"></a><span id="l24.196" class="difflineminus">-                                    curPopup))</span>
<a href="#l24.197"></a><span id="l24.197" class="difflineminus">-          throw new Error(&quot;Popup did not close!&quot;);</span>
<a href="#l24.198"></a><span id="l24.198" class="difflineplus">+        utils.waitFor(function () curPopup.state == &quot;closed&quot;,</span>
<a href="#l24.199"></a><span id="l24.199" class="difflineplus">+                      &quot;Popup did not close!&quot;, 1000, 50);</span>
<a href="#l24.200"></a><span id="l24.200">       }</span>
<a href="#l24.201"></a><span id="l24.201">     },</span>
<a href="#l24.202"></a><span id="l24.202"> </span>
<a href="#l24.203"></a><span id="l24.203">     /**</span>
<a href="#l24.204"></a><span id="l24.204">      * mark_action helper method that produces something that can be concat()ed</span>
<a href="#l24.205"></a><span id="l24.205">      *  onto a list being passed to mark_action in order to describe the focus</span>
<a href="#l24.206"></a><span id="l24.206">      *  state of the window.  For now this will be a variable-length list but</span>
<a href="#l24.207"></a><span id="l24.207">      *  could be changed to a single object in the future.</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

