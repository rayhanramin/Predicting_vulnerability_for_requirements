<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 11107:b85ebeaa2577c2c65b5802340a0b9d520dd72d6d</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ b85ebeaa2577c2c65b5802340a0b9d520dd72d6d" />
<meta property="og:url" content="/comm-central/rev/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d" />
<meta property="og:description" content="Fix bug 792266 - Use Services.jsm where possible. r=philipp" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / b85ebeaa2577c2c65b5802340a0b9d520dd72d6d 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d">shortlog</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d">files</a> |
changeset |
<a href="/comm-central/raw-rev/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d">raw</a>  | <a href="/comm-central/archive/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=792266">bug 792266</a> - Use Services.jsm where possible. r=philipp
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#114;&#99;&#104;&#97;&#101;&#111;&#112;&#116;&#101;&#114;&#121;&#120;&#32;&#60;&#97;&#114;&#99;&#104;&#97;&#101;&#111;&#112;&#116;&#101;&#114;&#121;&#120;&#64;&#99;&#111;&#111;&#108;&#101;&#45;&#102;&#105;&#108;&#101;&#115;&#46;&#100;&#101;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 24 Sep 2012 10:39:39 +0200</td></tr>

<tr>
 <td>changeset 11107</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d">b85ebeaa2577c2c65b5802340a0b9d520dd72d6d</a></td>
</tr>



<tr>
<td>parent 11106</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/53a7ba30571ca6bc810d4320954e6497ab1f727f">53a7ba30571ca6bc810d4320954e6497ab1f727f</a>
</td>
</tr>

<tr>
<td>child 11108</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/987cb8d531508028f844fa82f91c4d7d3b73530a">987cb8d531508028f844fa82f91c4d7d3b73530a</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=b85ebeaa2577c2c65b5802340a0b9d520dd72d6d">8335</a></td></tr>
<tr><td>push user</td><td>mozilla@kewis.ch</td></tr>
<tr><td>push date</td><td class="date age">Mon, 24 Sep 2012 08:39:43 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@b85ebeaa2577 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b85ebeaa2577c2c65b5802340a0b9d520dd72d6d">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b85ebeaa2577c2c65b5802340a0b9d520dd72d6d&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b85ebeaa2577c2c65b5802340a0b9d520dd72d6d&newProject=comm-central&newRevision=b85ebeaa2577c2c65b5802340a0b9d520dd72d6d&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b85ebeaa2577c2c65b5802340a0b9d520dd72d6d&newProject=comm-central&newRevision=b85ebeaa2577c2c65b5802340a0b9d520dd72d6d&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b85ebeaa2577c2c65b5802340a0b9d520dd72d6d&newProject=comm-central&newRevision=b85ebeaa2577c2c65b5802340a0b9d520dd72d6d&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28philipp%29&revcount=50">philipp</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=792266">792266</a></td></tr>




</table></div>

<div class="page_body description">Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=792266">bug 792266</a> - Use Services.jsm where possible. r=philipp</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/agenda-listbox.js">calendar/base/content/agenda-listbox.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/agenda-listbox.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/agenda-listbox.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/agenda-listbox.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/agenda-listbox.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/agenda-listbox.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-base-view.xml">calendar/base/content/calendar-base-view.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-base-view.xml">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-base-view.xml">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-base-view.xml">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-base-view.xml">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-base-view.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-clipboard.js">calendar/base/content/calendar-clipboard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-clipboard.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-clipboard.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-clipboard.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-clipboard.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-clipboard.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-common-sets.js">calendar/base/content/calendar-common-sets.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-common-sets.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-common-sets.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-common-sets.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-common-sets.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-common-sets.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-daypicker.xml">calendar/base/content/calendar-daypicker.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-daypicker.xml">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-daypicker.xml">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-daypicker.xml">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-daypicker.xml">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-daypicker.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-dnd-listener.js">calendar/base/content/calendar-dnd-listener.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-dnd-listener.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-dnd-listener.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-dnd-listener.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-dnd-listener.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-dnd-listener.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-management.js">calendar/base/content/calendar-management.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-management.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-management.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-management.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-management.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-management.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-task-tree.xml">calendar/base/content/calendar-task-tree.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-task-tree.xml">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-task-tree.xml">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-task-tree.xml">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-task-tree.xml">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-task-tree.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-task-view.js">calendar/base/content/calendar-task-view.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-task-view.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-task-view.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-task-view.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-task-view.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-task-view.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-unifinder.js">calendar/base/content/calendar-unifinder.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-unifinder.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-unifinder.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-unifinder.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-unifinder.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-unifinder.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-views.js">calendar/base/content/calendar-views.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-views.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-views.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-views.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-views.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/calendar-views.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/dialogs/calendar-dialog-utils.js">calendar/base/content/dialogs/calendar-dialog-utils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/dialogs/calendar-dialog-utils.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/dialogs/calendar-dialog-utils.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/dialogs/calendar-dialog-utils.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/dialogs/calendar-dialog-utils.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/dialogs/calendar-dialog-utils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">calendar/base/content/dialogs/calendar-event-dialog-attendees.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">calendar/base/content/dialogs/calendar-event-dialog-attendees.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">calendar/base/content/dialogs/calendar-event-dialog-recurrence.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/dialogs/calendar-event-dialog.js">calendar/base/content/dialogs/calendar-event-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/dialogs/calendar-event-dialog.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/dialogs/calendar-event-dialog.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/dialogs/calendar-event-dialog.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/dialogs/calendar-event-dialog.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/dialogs/calendar-event-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/dialogs/calendar-migration-dialog.js">calendar/base/content/dialogs/calendar-migration-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/dialogs/calendar-migration-dialog.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/dialogs/calendar-migration-dialog.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/dialogs/calendar-migration-dialog.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/dialogs/calendar-migration-dialog.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/dialogs/calendar-migration-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/preferences/advanced.js">calendar/base/content/preferences/advanced.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/preferences/advanced.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/preferences/advanced.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/preferences/advanced.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/preferences/advanced.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/preferences/advanced.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/preferences/alarms.js">calendar/base/content/preferences/alarms.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/preferences/alarms.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/preferences/alarms.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/preferences/alarms.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/preferences/alarms.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/preferences/alarms.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/preferences/categories.js">calendar/base/content/preferences/categories.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/preferences/categories.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/preferences/categories.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/preferences/categories.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/preferences/categories.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/preferences/categories.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/preferences/connection.js">calendar/base/content/preferences/connection.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/preferences/connection.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/preferences/connection.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/preferences/connection.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/preferences/connection.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/preferences/connection.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/widgets/minimonth.xml">calendar/base/content/widgets/minimonth.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/widgets/minimonth.xml">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/widgets/minimonth.xml">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/widgets/minimonth.xml">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/widgets/minimonth.xml">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/content/widgets/minimonth.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/modules/calAuthUtils.jsm">calendar/base/modules/calAuthUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/modules/calAuthUtils.jsm">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/modules/calAuthUtils.jsm">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/modules/calAuthUtils.jsm">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/modules/calAuthUtils.jsm">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/modules/calAuthUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/modules/calProviderUtils.jsm">calendar/base/modules/calProviderUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/modules/calProviderUtils.jsm">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/modules/calProviderUtils.jsm">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/modules/calProviderUtils.jsm">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/modules/calProviderUtils.jsm">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/modules/calProviderUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/modules/calUtils.jsm">calendar/base/modules/calUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/modules/calUtils.jsm">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/modules/calUtils.jsm">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/modules/calUtils.jsm">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/modules/calUtils.jsm">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/modules/calUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calAlarmMonitor.js">calendar/base/src/calAlarmMonitor.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calAlarmMonitor.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calAlarmMonitor.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calAlarmMonitor.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calAlarmMonitor.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calAlarmMonitor.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calAlarmService.js">calendar/base/src/calAlarmService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calAlarmService.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calAlarmService.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calAlarmService.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calAlarmService.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calAlarmService.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calApplicationUtils.js">calendar/base/src/calApplicationUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calApplicationUtils.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calApplicationUtils.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calApplicationUtils.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calApplicationUtils.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calApplicationUtils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calCachedCalendar.js">calendar/base/src/calCachedCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calCachedCalendar.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calCachedCalendar.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calCachedCalendar.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calCachedCalendar.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calCachedCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calCalendarManager.js">calendar/base/src/calCalendarManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calCalendarManager.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calCalendarManager.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calCalendarManager.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calCalendarManager.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calCalendarManager.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calDateTimeFormatter.js">calendar/base/src/calDateTimeFormatter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calDateTimeFormatter.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calDateTimeFormatter.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calDateTimeFormatter.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calDateTimeFormatter.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calDateTimeFormatter.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calProtocolHandler.js">calendar/base/src/calProtocolHandler.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calProtocolHandler.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calProtocolHandler.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calProtocolHandler.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calProtocolHandler.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calProtocolHandler.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calTimezoneService.js">calendar/base/src/calTimezoneService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calTimezoneService.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calTimezoneService.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calTimezoneService.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calTimezoneService.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calTimezoneService.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calUtils.js">calendar/base/src/calUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calUtils.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calUtils.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calUtils.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calUtils.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/base/src/calUtils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/itip/calItipEmailTransport.js">calendar/itip/calItipEmailTransport.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/itip/calItipEmailTransport.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/itip/calItipEmailTransport.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/itip/calItipEmailTransport.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/itip/calItipEmailTransport.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/itip/calItipEmailTransport.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/lightning/components/lightningTextCalendarConverter.js">calendar/lightning/components/lightningTextCalendarConverter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/lightning/components/lightningTextCalendarConverter.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/lightning/components/lightningTextCalendarConverter.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/lightning/components/lightningTextCalendarConverter.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/lightning/components/lightningTextCalendarConverter.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/lightning/components/lightningTextCalendarConverter.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/lightning/content/messenger-overlay-sidebar.js">calendar/lightning/content/messenger-overlay-sidebar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/lightning/content/messenger-overlay-sidebar.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/lightning/content/messenger-overlay-sidebar.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/lightning/content/messenger-overlay-sidebar.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/lightning/content/messenger-overlay-sidebar.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/lightning/content/messenger-overlay-sidebar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/lightning/content/suite-overlay-sidebar.js">calendar/lightning/content/suite-overlay-sidebar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/lightning/content/suite-overlay-sidebar.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/lightning/content/suite-overlay-sidebar.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/lightning/content/suite-overlay-sidebar.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/lightning/content/suite-overlay-sidebar.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/lightning/content/suite-overlay-sidebar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/caldav/calDavCalendar.js">calendar/providers/caldav/calDavCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/caldav/calDavCalendar.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/caldav/calDavCalendar.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/caldav/calDavCalendar.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/caldav/calDavCalendar.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/caldav/calDavCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/gdata/components/calGoogleRequest.js">calendar/providers/gdata/components/calGoogleRequest.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/gdata/components/calGoogleRequest.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/gdata/components/calGoogleRequest.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/gdata/components/calGoogleRequest.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/gdata/components/calGoogleRequest.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/gdata/components/calGoogleRequest.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/gdata/components/calGoogleSession.js">calendar/providers/gdata/components/calGoogleSession.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/gdata/components/calGoogleSession.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/gdata/components/calGoogleSession.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/gdata/components/calGoogleSession.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/gdata/components/calGoogleSession.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/gdata/components/calGoogleSession.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/ics/calICSCalendar.js">calendar/providers/ics/calICSCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/ics/calICSCalendar.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/ics/calICSCalendar.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/ics/calICSCalendar.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/ics/calICSCalendar.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/ics/calICSCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/storage/calStorageUpgrade.jsm">calendar/providers/storage/calStorageUpgrade.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/storage/calStorageUpgrade.jsm">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/storage/calStorageUpgrade.jsm">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/storage/calStorageUpgrade.jsm">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/storage/calStorageUpgrade.jsm">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/storage/calStorageUpgrade.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/wcap/calWcapRequest.js">calendar/providers/wcap/calWcapRequest.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/wcap/calWcapRequest.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/wcap/calWcapRequest.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/wcap/calWcapRequest.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/wcap/calWcapRequest.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/wcap/calWcapRequest.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/wcap/calWcapSession.js">calendar/providers/wcap/calWcapSession.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/wcap/calWcapSession.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/wcap/calWcapSession.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/wcap/calWcapSession.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/wcap/calWcapSession.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/wcap/calWcapSession.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/wcap/calWcapUtils.js">calendar/providers/wcap/calWcapUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/wcap/calWcapUtils.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/wcap/calWcapUtils.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/wcap/calWcapUtils.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/wcap/calWcapUtils.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/providers/wcap/calWcapUtils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/resources/content/calendar.js">calendar/resources/content/calendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/resources/content/calendar.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/resources/content/calendar.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/resources/content/calendar.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/resources/content/calendar.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/resources/content/calendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/resources/content/calendarService.js">calendar/resources/content/calendarService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/resources/content/calendarService.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/resources/content/calendarService.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/resources/content/calendarService.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/resources/content/calendarService.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/resources/content/calendarService.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/resources/content/publish.js">calendar/resources/content/publish.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/resources/content/publish.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/resources/content/publish.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/resources/content/publish.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/resources/content/publish.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/resources/content/publish.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/sunbird/base/content/applicationUtil.js">calendar/sunbird/base/content/applicationUtil.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/sunbird/base/content/applicationUtil.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/sunbird/base/content/applicationUtil.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/sunbird/base/content/applicationUtil.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/sunbird/base/content/applicationUtil.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/sunbird/base/content/applicationUtil.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/sunbird/base/content/calendar-offline.js">calendar/sunbird/base/content/calendar-offline.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/sunbird/base/content/calendar-offline.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/sunbird/base/content/calendar-offline.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/sunbird/base/content/calendar-offline.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/sunbird/base/content/calendar-offline.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/sunbird/base/content/calendar-offline.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/test/mozmill/testAlarmDefaultValue.js">calendar/test/mozmill/testAlarmDefaultValue.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/test/mozmill/testAlarmDefaultValue.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/test/mozmill/testAlarmDefaultValue.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/test/mozmill/testAlarmDefaultValue.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/test/mozmill/testAlarmDefaultValue.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/test/mozmill/testAlarmDefaultValue.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/test/mozmill/testLocalICS.js">calendar/test/mozmill/testLocalICS.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/test/mozmill/testLocalICS.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/test/mozmill/testLocalICS.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/test/mozmill/testLocalICS.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/test/mozmill/testLocalICS.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/test/mozmill/testLocalICS.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/test/unit/head_consts.js">calendar/test/unit/head_consts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/test/unit/head_consts.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/test/unit/head_consts.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/test/unit/head_consts.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/test/unit/head_consts.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/test/unit/head_consts.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/test/unit/test_calmgr.js">calendar/test/unit/test_calmgr.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/test/unit/test_calmgr.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/test/unit/test_calmgr.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/test/unit/test_calmgr.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/test/unit/test_calmgr.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/test/unit/test_calmgr.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/test/unit/test_webcal.js">calendar/test/unit/test_webcal.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/test/unit/test_webcal.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/test/unit/test_webcal.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/test/unit/test_webcal.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/test/unit/test_webcal.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/test/unit/test_webcal.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/timezones/update.js">calendar/timezones/update.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/timezones/update.js">file</a> |
<a href="/comm-central/annotate/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/timezones/update.js">annotate</a> |
<a href="/comm-central/diff/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/timezones/update.js">diff</a> |
<a href="/comm-central/comparison/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/timezones/update.js">comparison</a> |
<a href="/comm-central/log/b85ebeaa2577c2c65b5802340a0b9d520dd72d6d/calendar/timezones/update.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/content/agenda-listbox.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/content/agenda-listbox.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1,12 +1,14 @@</span>
<a href="#l1.4"></a><span id="l1.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.5"></a><span id="l1.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.6"></a><span id="l1.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l1.9"></a><span id="l1.9" class="difflineplus">+</span>
<a href="#l1.10"></a><span id="l1.10"> function Synthetic(aOpen, aDuration) {</span>
<a href="#l1.11"></a><span id="l1.11">     this.open = aOpen;</span>
<a href="#l1.12"></a><span id="l1.12">     this.duration = aDuration;</span>
<a href="#l1.13"></a><span id="l1.13"> }</span>
<a href="#l1.14"></a><span id="l1.14"> </span>
<a href="#l1.15"></a><span id="l1.15"> var agendaListbox = {</span>
<a href="#l1.16"></a><span id="l1.16">     agendaListboxControl: null,</span>
<a href="#l1.17"></a><span id="l1.17">     pendingRefresh: null,</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineat">@@ -1072,24 +1074,22 @@ function scheduleNextCurrentEventUpdate(</span>
<a href="#l1.19"></a><span id="l1.19">         var wakeObserver = {</span>
<a href="#l1.20"></a><span id="l1.20">            observe: function(aSubject, aTopic, aData) {</span>
<a href="#l1.21"></a><span id="l1.21">                if (aTopic == &quot;wake_notification&quot;) {</span>
<a href="#l1.22"></a><span id="l1.22">                    aRefreshCallback();</span>
<a href="#l1.23"></a><span id="l1.23">                }</span>
<a href="#l1.24"></a><span id="l1.24">            }</span>
<a href="#l1.25"></a><span id="l1.25">         };</span>
<a href="#l1.26"></a><span id="l1.26">         // Add observer</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineminus">-        var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">-                                        .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineminus">-        observerService.addObserver(wakeObserver, &quot;wake_notification&quot;, false);</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+        Services.obs.addObserver(wakeObserver, &quot;wake_notification&quot;, false);</span>
<a href="#l1.31"></a><span id="l1.31"> </span>
<a href="#l1.32"></a><span id="l1.32">         // Remove observer on unload</span>
<a href="#l1.33"></a><span id="l1.33">         window.addEventListener(&quot;unload&quot;,</span>
<a href="#l1.34"></a><span id="l1.34">                                 function() {</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-                                    observerService.removeObserver(wakeObserver, &quot;wake_notification&quot;);</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+                                    Services.obs.removeObserver(wakeObserver, &quot;wake_notification&quot;);</span>
<a href="#l1.37"></a><span id="l1.37">                                 }, false);</span>
<a href="#l1.38"></a><span id="l1.38"> </span>
<a href="#l1.39"></a><span id="l1.39">         gEventTimer = Components.classes[&quot;@mozilla.org/timer;1&quot;]</span>
<a href="#l1.40"></a><span id="l1.40">                                    .createInstance(Components.interfaces.nsITimer);</span>
<a href="#l1.41"></a><span id="l1.41">     } else {</span>
<a href="#l1.42"></a><span id="l1.42">         gEventTimer.cancel();</span>
<a href="#l1.43"></a><span id="l1.43">     }</span>
<a href="#l1.44"></a><span id="l1.44">     gEventTimer.initWithCallback(udCallback, aMsUntil, gEventTimer.TYPE_ONE_SHOT);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/base/content/calendar-base-view.xml</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/base/content/calendar-base-view.xml</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -244,16 +244,18 @@</span>
<a href="#l2.4"></a><span id="l2.4">             onDefaultCalendarChanged:</span>
<a href="#l2.5"></a><span id="l2.5">             function onDefaultCalendarChanged(aNewDefaultCalendar) {</span>
<a href="#l2.6"></a><span id="l2.6">                 // don't care, for now</span>
<a href="#l2.7"></a><span id="l2.7">             }</span>
<a href="#l2.8"></a><span id="l2.8">         })</span>
<a href="#l2.9"></a><span id="l2.9">       ]]&gt;&lt;/field&gt;</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+        Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+</span>
<a href="#l2.14"></a><span id="l2.14">         const kWorkdaysCommand = &quot;calendar_toggle_workdays_only_command&quot;;</span>
<a href="#l2.15"></a><span id="l2.15">         const kTasksInViewCommand = &quot;calendar_toggle_tasks_in_view_command&quot;;</span>
<a href="#l2.16"></a><span id="l2.16">         const kShowCompleted = &quot;calendar_toggle_show_completed_in_view_command&quot;;</span>
<a href="#l2.17"></a><span id="l2.17">         const kOrientation = &quot;calendar_toggle_orientation_command&quot;;</span>
<a href="#l2.18"></a><span id="l2.18"> </span>
<a href="#l2.19"></a><span id="l2.19">         this.workdaysOnly = (document.getElementById(kWorkdaysCommand)</span>
<a href="#l2.20"></a><span id="l2.20">                                 .getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l2.21"></a><span id="l2.21">         this.tasksInView = (document.getElementById(kTasksInViewCommand)</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -268,35 +270,32 @@</span>
<a href="#l2.23"></a><span id="l2.23">                            .getService(Components.interfaces.calIAlarmService);</span>
<a href="#l2.24"></a><span id="l2.24">         alarmService.addObserver(this.mObserver);</span>
<a href="#l2.25"></a><span id="l2.25">         let self = this;</span>
<a href="#l2.26"></a><span id="l2.26">         this.setAttribute(&quot;type&quot;, this.type);</span>
<a href="#l2.27"></a><span id="l2.27">         this.mResizeHandler = function resizeHandler() {</span>
<a href="#l2.28"></a><span id="l2.28">             self.onResize(self); };</span>
<a href="#l2.29"></a><span id="l2.29">         this.viewBroadcaster.addEventListener(this.getAttribute(&quot;type&quot;) + &quot;viewresized&quot;, this.mResizeHandler, true);</span>
<a href="#l2.30"></a><span id="l2.30">         // add a preference observer to monitor changes</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-        let pb2 = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;].</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-                  getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-        pb2.addObserver(&quot;calendar.&quot;, this.mPrefObserver, false);</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+        Services.prefs.addObserver(&quot;calendar.&quot;, this.mPrefObserver, false);</span>
<a href="#l2.36"></a><span id="l2.36">         this.weekStartOffset = getPrefSafe(&quot;calendar.week.start&quot;, 0);</span>
<a href="#l2.37"></a><span id="l2.37">         this.updateDaysOffPrefs();</span>
<a href="#l2.38"></a><span id="l2.38">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l2.39"></a><span id="l2.39"> </span>
<a href="#l2.40"></a><span id="l2.40">       &lt;destructor&gt;&lt;![CDATA[</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+        Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+</span>
<a href="#l2.43"></a><span id="l2.43">         if (this.mCalendar) {</span>
<a href="#l2.44"></a><span id="l2.44">             this.mCalendar.removeObserver(this.mObserver);</span>
<a href="#l2.45"></a><span id="l2.45">         }</span>
<a href="#l2.46"></a><span id="l2.46">         let alarmService = Components.classes['@mozilla.org/calendar/alarm-service;1']</span>
<a href="#l2.47"></a><span id="l2.47">                            .getService(Components.interfaces.calIAlarmService);</span>
<a href="#l2.48"></a><span id="l2.48">         alarmService.removeObserver(this.mObserver);</span>
<a href="#l2.49"></a><span id="l2.49">         this.viewBroadcaster.removeEventListener(this.getAttribute(&quot;type&quot;) + &quot;viewresized&quot;, this.mResizeHandler, true);</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-        let pb2 = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;].</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-                  getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-        pb2.removeObserver(&quot;calendar.&quot;, this.mPrefObserver);</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+        Services.prefs.removeObserver(&quot;calendar.&quot;, this.mPrefObserver);</span>
<a href="#l2.54"></a><span id="l2.54">       ]]&gt;&lt;/destructor&gt;</span>
<a href="#l2.55"></a><span id="l2.55"> </span>
<a href="#l2.56"></a><span id="l2.56">       &lt;property name=&quot;type&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l2.57"></a><span id="l2.57">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l2.58"></a><span id="l2.58">             let typelist = this.id.split(&quot;-&quot;);</span>
<a href="#l2.59"></a><span id="l2.59">             return typelist[0];</span>
<a href="#l2.60"></a><span id="l2.60">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l2.61"></a><span id="l2.61">       &lt;/property&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/base/content/calendar-clipboard.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/base/content/calendar-clipboard.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,41 +1,32 @@</span>
<a href="#l3.4"></a><span id="l3.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.5"></a><span id="l3.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.6"></a><span id="l3.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l3.9"></a><span id="l3.9"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11"> /**</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">- * Gets the clipboard service.</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">- * @see nsIClipboard</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">- * @return          The clipboard service.</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">- */</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-function getClipboard() {</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-    return Components.classes[&quot;@mozilla.org/widget/clipboard;1&quot;]</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-                     .getService(Components.interfaces.nsIClipboard);</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-}</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-/**</span>
<a href="#l3.22"></a><span id="l3.22">  * Test if a writable calendar is selected, and if the clipboard has items that</span>
<a href="#l3.23"></a><span id="l3.23">  * can be pasted into Calendar. The data must be of type &quot;text/calendar&quot; or</span>
<a href="#l3.24"></a><span id="l3.24">  * &quot;text/unicode&quot;.</span>
<a href="#l3.25"></a><span id="l3.25">  *</span>
<a href="#l3.26"></a><span id="l3.26">  * @return          If true, pasting is currently possible.</span>
<a href="#l3.27"></a><span id="l3.27">  */</span>
<a href="#l3.28"></a><span id="l3.28"> function canPaste() {</span>
<a href="#l3.29"></a><span id="l3.29">     let selectedCal = getSelectedCalendar();</span>
<a href="#l3.30"></a><span id="l3.30">     if (!selectedCal || !cal.isCalendarWritable(selectedCal)) {</span>
<a href="#l3.31"></a><span id="l3.31">         return false;</span>
<a href="#l3.32"></a><span id="l3.32">     }</span>
<a href="#l3.33"></a><span id="l3.33"> </span>
<a href="#l3.34"></a><span id="l3.34">     const flavors = [&quot;text/calendar&quot;, &quot;text/unicode&quot;];</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-    return getClipboard().hasDataMatchingFlavors(flavors,</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-                                                 flavors.length,</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineminus">-                                                 Components.interfaces.nsIClipboard.kGlobalClipboard);</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+    return Services.clipboard.hasDataMatchingFlavors(flavors,</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+                                                     flavors.length,</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+                                                     Components.interfaces.nsIClipboard.kGlobalClipboard);</span>
<a href="#l3.41"></a><span id="l3.41"> }</span>
<a href="#l3.42"></a><span id="l3.42"> </span>
<a href="#l3.43"></a><span id="l3.43"> /**</span>
<a href="#l3.44"></a><span id="l3.44">  * Copy the ics data of the current view's selected events to the clipboard and</span>
<a href="#l3.45"></a><span id="l3.45">  * deletes the events on success</span>
<a href="#l3.46"></a><span id="l3.46">  */</span>
<a href="#l3.47"></a><span id="l3.47"> function cutToClipboard() {</span>
<a href="#l3.48"></a><span id="l3.48">     if (copyToClipboard()) {</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineat">@@ -62,17 +53,17 @@ function copyToClipboard(calendarItemArr</span>
<a href="#l3.50"></a><span id="l3.50">         return false;</span>
<a href="#l3.51"></a><span id="l3.51">     }</span>
<a href="#l3.52"></a><span id="l3.52"> </span>
<a href="#l3.53"></a><span id="l3.53">     let icsSerializer = Components.classes[&quot;@mozilla.org/calendar/ics-serializer;1&quot;]</span>
<a href="#l3.54"></a><span id="l3.54">                                   .createInstance(Components.interfaces.calIIcsSerializer);</span>
<a href="#l3.55"></a><span id="l3.55">     icsSerializer.addItems(calendarItemArray, calendarItemArray.length);</span>
<a href="#l3.56"></a><span id="l3.56">     let icsString = icsSerializer.serializeToString();</span>
<a href="#l3.57"></a><span id="l3.57"> </span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">-    let clipboard = getClipboard();</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+    let clipboard = Services.clipboard;</span>
<a href="#l3.60"></a><span id="l3.60">     let trans = Components.classes[&quot;@mozilla.org/widget/transferable;1&quot;]</span>
<a href="#l3.61"></a><span id="l3.61">                           .createInstance(Components.interfaces.nsITransferable);</span>
<a href="#l3.62"></a><span id="l3.62"> </span>
<a href="#l3.63"></a><span id="l3.63">     if (trans &amp;&amp; clipboard) {</span>
<a href="#l3.64"></a><span id="l3.64">         // Register supported data flavors</span>
<a href="#l3.65"></a><span id="l3.65">         trans.addDataFlavor(&quot;text/calendar&quot;);</span>
<a href="#l3.66"></a><span id="l3.66">         trans.addDataFlavor(&quot;text/unicode&quot;);</span>
<a href="#l3.67"></a><span id="l3.67"> </span>
<a href="#l3.68"></a><span id="l3.68" class="difflineat">@@ -104,17 +95,17 @@ function copyToClipboard(calendarItemArr</span>
<a href="#l3.69"></a><span id="l3.69">  * Reads ics data from the clipboard, parses it into items and inserts the items</span>
<a href="#l3.70"></a><span id="l3.70">  * into the currently selected calendar.</span>
<a href="#l3.71"></a><span id="l3.71">  */</span>
<a href="#l3.72"></a><span id="l3.72"> function pasteFromClipboard() {</span>
<a href="#l3.73"></a><span id="l3.73">     if (!canPaste()) {</span>
<a href="#l3.74"></a><span id="l3.74">         return;</span>
<a href="#l3.75"></a><span id="l3.75">     }</span>
<a href="#l3.76"></a><span id="l3.76"> </span>
<a href="#l3.77"></a><span id="l3.77" class="difflineminus">-    let clipboard = getClipboard();</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+    let clipboard = Services.clipboard;</span>
<a href="#l3.79"></a><span id="l3.79">     let trans = Components.classes[&quot;@mozilla.org/widget/transferable;1&quot;]</span>
<a href="#l3.80"></a><span id="l3.80">                           .createInstance(Components.interfaces.nsITransferable);</span>
<a href="#l3.81"></a><span id="l3.81"> </span>
<a href="#l3.82"></a><span id="l3.82">     if (!trans || !clipboard) {</span>
<a href="#l3.83"></a><span id="l3.83">         return;</span>
<a href="#l3.84"></a><span id="l3.84">     }</span>
<a href="#l3.85"></a><span id="l3.85"> </span>
<a href="#l3.86"></a><span id="l3.86">     // Register the wanted data flavors (highest fidelity first!)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/base/content/calendar-common-sets.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/base/content/calendar-common-sets.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1,12 +1,14 @@</span>
<a href="#l4.4"></a><span id="l4.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.5"></a><span id="l4.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.6"></a><span id="l4.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+</span>
<a href="#l4.10"></a><span id="l4.10"> var CalendarDeleteCommandEnabled = false;</span>
<a href="#l4.11"></a><span id="l4.11"> var CalendarNewItemsCommandEnabled = false;</span>
<a href="#l4.12"></a><span id="l4.12"> </span>
<a href="#l4.13"></a><span id="l4.13"> /**</span>
<a href="#l4.14"></a><span id="l4.14">  * Command controller to execute calendar specific commands</span>
<a href="#l4.15"></a><span id="l4.15">  * @see nsICommandController</span>
<a href="#l4.16"></a><span id="l4.16">  */</span>
<a href="#l4.17"></a><span id="l4.17"> var calendarController = {</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineat">@@ -517,17 +519,17 @@ var calendarController = {</span>
<a href="#l4.19"></a><span id="l4.19">                  !this.all_local_calendars_readonly));</span>
<a href="#l4.20"></a><span id="l4.20">     },</span>
<a href="#l4.21"></a><span id="l4.21"> </span>
<a href="#l4.22"></a><span id="l4.22">     /**</span>
<a href="#l4.23"></a><span id="l4.23">      * Returns a boolean indicating if the application is currently in offline</span>
<a href="#l4.24"></a><span id="l4.24">      * mode.</span>
<a href="#l4.25"></a><span id="l4.25">      */</span>
<a href="#l4.26"></a><span id="l4.26">     get offline() {</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-        return getIOService().offline;</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+        return Services.io.offline;</span>
<a href="#l4.29"></a><span id="l4.29">     },</span>
<a href="#l4.30"></a><span id="l4.30"> </span>
<a href="#l4.31"></a><span id="l4.31">     /**</span>
<a href="#l4.32"></a><span id="l4.32">      * Returns a boolean indicating if all calendars are readonly.</span>
<a href="#l4.33"></a><span id="l4.33">      */</span>
<a href="#l4.34"></a><span id="l4.34">     get all_readonly () {</span>
<a href="#l4.35"></a><span id="l4.35">         var calMgr = getCalendarManager();</span>
<a href="#l4.36"></a><span id="l4.36">         return (calMgr.readOnlyCalendarCount == calMgr.calendarCount);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/base/content/calendar-daypicker.xml</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/base/content/calendar-daypicker.xml</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -116,32 +116,26 @@</span>
<a href="#l5.4"></a><span id="l5.4">                   days.push(index + 1);</span>
<a href="#l5.5"></a><span id="l5.5">               }</span>
<a href="#l5.6"></a><span id="l5.6">           }</span>
<a href="#l5.7"></a><span id="l5.7">           return days;</span>
<a href="#l5.8"></a><span id="l5.8">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l5.9"></a><span id="l5.9">       &lt;/property&gt;</span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-        var pb = Components.classes[</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-            &quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-                .getService(</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-                    Components.interfaces.nsIPrefBranch);</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+        Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+</span>
<a href="#l5.18"></a><span id="l5.18">         this.weekStartOffset = 0;</span>
<a href="#l5.19"></a><span id="l5.19">         try {</span>
<a href="#l5.20"></a><span id="l5.20">             this.weekStartOffset =</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineminus">-                pb.getIntPref(&quot;calendar.week.start&quot;);</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+                Services.prefs.getIntPref(&quot;calendar.week.start&quot;);</span>
<a href="#l5.23"></a><span id="l5.23">         } catch (ex) {</span>
<a href="#l5.24"></a><span id="l5.24">         }</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">-        var sbs = Components.classes[</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineminus">-            &quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineminus">-                .getService(</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">-                    Components.interfaces.nsIStringBundleService);</span>
<a href="#l5.29"></a><span id="l5.29">         var props =</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-            sbs.createBundle(</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+            Services.strings.createBundle(</span>
<a href="#l5.32"></a><span id="l5.32">                 &quot;chrome://calendar/locale/dateFormat.properties&quot;);</span>
<a href="#l5.33"></a><span id="l5.33">         var mainbox =</span>
<a href="#l5.34"></a><span id="l5.34">             document.getAnonymousElementByAttribute(</span>
<a href="#l5.35"></a><span id="l5.35">                 this, &quot;anonid&quot;, &quot;mainbox&quot;);</span>
<a href="#l5.36"></a><span id="l5.36">         var numChilds = mainbox.childNodes.length;</span>
<a href="#l5.37"></a><span id="l5.37">         for (var i = 0; i &lt; numChilds; i++) {</span>
<a href="#l5.38"></a><span id="l5.38">             var child = mainbox.childNodes[i];</span>
<a href="#l5.39"></a><span id="l5.39">             var dow = i + this.weekStartOffset;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/calendar/base/content/calendar-dnd-listener.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/calendar/base/content/calendar-dnd-listener.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1,14 +1,15 @@</span>
<a href="#l6.4"></a><span id="l6.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.5"></a><span id="l6.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.6"></a><span id="l6.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l6.9"></a><span id="l6.9"> Components.utils.import(&quot;resource://calendar/modules/calAlarmUtils.jsm&quot;);</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12"> var itemConversion = {</span>
<a href="#l6.13"></a><span id="l6.13"> </span>
<a href="#l6.14"></a><span id="l6.14">     /**</span>
<a href="#l6.15"></a><span id="l6.15">      * Converts an email message to a calendar item.</span>
<a href="#l6.16"></a><span id="l6.16">      *</span>
<a href="#l6.17"></a><span id="l6.17">      * @param aItem     The target calIItemBase.</span>
<a href="#l6.18"></a><span id="l6.18">      * @param aMessage  The nsIMsgHdr to convert from.</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineat">@@ -267,20 +268,20 @@ calDNDBaseObserver.prototype = {</span>
<a href="#l6.20"></a><span id="l6.20">                 }</span>
<a href="#l6.21"></a><span id="l6.21">                 finally {</span>
<a href="#l6.22"></a><span id="l6.22">                     inputStream.close();</span>
<a href="#l6.23"></a><span id="l6.23">                 }</span>
<a href="#l6.24"></a><span id="l6.24"> </span>
<a href="#l6.25"></a><span id="l6.25">                 break;</span>
<a href="#l6.26"></a><span id="l6.26">             case &quot;application/x-moz-file-promise&quot;:</span>
<a href="#l6.27"></a><span id="l6.27">             case &quot;text/x-moz-url&quot;:</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineminus">-                var uri = cal.getIOService().newURI(data.toString(), null, null);</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+                var uri = Services.io.newURI(data.toString(), null, null);</span>
<a href="#l6.30"></a><span id="l6.30">                 var loader = Components.classes[&quot;@mozilla.org/network/unichar-stream-loader;1&quot;]</span>
<a href="#l6.31"></a><span id="l6.31">                              .createInstance(Components.interfaces.nsIUnicharStreamLoader);</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-                var channel = cal.getIOService().newChannelFromURI(uri);</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+                var channel = Services.io.newChannelFromURI(uri);</span>
<a href="#l6.34"></a><span id="l6.34">                 channel.loadFlags |= Components.interfaces.nsIRequest.LOAD_BYPASS_CACHE;</span>
<a href="#l6.35"></a><span id="l6.35"> </span>
<a href="#l6.36"></a><span id="l6.36">                 var self = this;</span>
<a href="#l6.37"></a><span id="l6.37"> </span>
<a href="#l6.38"></a><span id="l6.38">                 var listener = {</span>
<a href="#l6.39"></a><span id="l6.39"> </span>
<a href="#l6.40"></a><span id="l6.40">                     // nsIUnicharStreamLoaderObserver:</span>
<a href="#l6.41"></a><span id="l6.41">                     onDetermineCharset: function(loader, context, firstSegment, length) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/calendar/base/content/calendar-management.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/calendar/base/content/calendar-management.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1,13 +1,14 @@</span>
<a href="#l7.4"></a><span id="l7.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.5"></a><span id="l7.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.6"></a><span id="l7.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.7"></a><span id="l7.7"> </span>
<a href="#l7.8"></a><span id="l7.8"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l7.10"></a><span id="l7.10"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12"> /**</span>
<a href="#l7.13"></a><span id="l7.13">  * Get this window's currently selected calendar.</span>
<a href="#l7.14"></a><span id="l7.14">  *</span>
<a href="#l7.15"></a><span id="l7.15">  * @return      The currently selected calendar.</span>
<a href="#l7.16"></a><span id="l7.16">  */</span>
<a href="#l7.17"></a><span id="l7.17"> function getSelectedCalendar() {</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineat">@@ -23,23 +24,21 @@ function getSelectedCalendar() {</span>
<a href="#l7.19"></a><span id="l7.19">  */</span>
<a href="#l7.20"></a><span id="l7.20"> function promptDeleteCalendar(aCalendar) {</span>
<a href="#l7.21"></a><span id="l7.21">     let calendars = cal.getCalendarManager().getCalendars({});</span>
<a href="#l7.22"></a><span id="l7.22">     if (calendars.length &lt;= 1) {</span>
<a href="#l7.23"></a><span id="l7.23">         // If this is the last calendar, don't delete it.</span>
<a href="#l7.24"></a><span id="l7.24">         return;</span>
<a href="#l7.25"></a><span id="l7.25">     }</span>
<a href="#l7.26"></a><span id="l7.26"> </span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">-    let promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-                                  .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-    let ok = promptService.confirm(window,</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-                                   calGetString(&quot;calendar&quot;, &quot;unsubscribeCalendarTitle&quot;),</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-                                   calGetString(&quot;calendar&quot;, &quot;unsubscribeCalendarMessage&quot;,</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-                                                [aCalendar.name]),</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-                                   {});</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+    let ok = Services.prompt.confirm(window,</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+                                     calGetString(&quot;calendar&quot;, &quot;unsubscribeCalendarTitle&quot;),</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+                                     calGetString(&quot;calendar&quot;, &quot;unsubscribeCalendarMessage&quot;,</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+                                                  [aCalendar.name]),</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+                                     {});</span>
<a href="#l7.39"></a><span id="l7.39"> </span>
<a href="#l7.40"></a><span id="l7.40">     if (ok) {</span>
<a href="#l7.41"></a><span id="l7.41">         let calMgr = cal.getCalendarManager();</span>
<a href="#l7.42"></a><span id="l7.42">         calMgr.unregisterCalendar(aCalendar);</span>
<a href="#l7.43"></a><span id="l7.43">         calMgr.deleteCalendar(aCalendar);</span>
<a href="#l7.44"></a><span id="l7.44">     }</span>
<a href="#l7.45"></a><span id="l7.45"> }</span>
<a href="#l7.46"></a><span id="l7.46"> </span>
<a href="#l7.47"></a><span id="l7.47" class="difflineat">@@ -255,36 +254,32 @@ var calendarOfflineManager = {</span>
<a href="#l7.48"></a><span id="l7.48">                                     [Components.interfaces.nsIObserver,</span>
<a href="#l7.49"></a><span id="l7.49">                                      Components.interfaces.nsISupports]);</span>
<a href="#l7.50"></a><span id="l7.50">     },</span>
<a href="#l7.51"></a><span id="l7.51"> </span>
<a href="#l7.52"></a><span id="l7.52">     init: function cOM_init() {</span>
<a href="#l7.53"></a><span id="l7.53">         if (this.initialized) {</span>
<a href="#l7.54"></a><span id="l7.54">             throw Components.results.NS_ERROR_ALREADY_INITIALIZED;</span>
<a href="#l7.55"></a><span id="l7.55">         }</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineminus">-        let os = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineminus">-                           .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineminus">-        os.addObserver(this, &quot;network:offline-status-changed&quot;, false);</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+        Services.obs.addObserver(this, &quot;network:offline-status-changed&quot;, false);</span>
<a href="#l7.60"></a><span id="l7.60"> </span>
<a href="#l7.61"></a><span id="l7.61">         this.updateOfflineUI(!this.isOnline());</span>
<a href="#l7.62"></a><span id="l7.62">         this.initialized = true;</span>
<a href="#l7.63"></a><span id="l7.63">     },</span>
<a href="#l7.64"></a><span id="l7.64"> </span>
<a href="#l7.65"></a><span id="l7.65">     uninit: function cOM_uninit() {</span>
<a href="#l7.66"></a><span id="l7.66">         if (!this.initialized) {</span>
<a href="#l7.67"></a><span id="l7.67">             throw Components.results.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l7.68"></a><span id="l7.68">         }</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineminus">-        let os = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineminus">-                           .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineminus">-        os.removeObserver(this, &quot;network:offline-status-changed&quot;, false);</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+        Services.obs.removeObserver(this, &quot;network:offline-status-changed&quot;, false);</span>
<a href="#l7.73"></a><span id="l7.73">         this.initialized = false;</span>
<a href="#l7.74"></a><span id="l7.74">     },</span>
<a href="#l7.75"></a><span id="l7.75"> </span>
<a href="#l7.76"></a><span id="l7.76">     isOnline: function cOM_isOnline() {</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineminus">-        return (!getIOService().offline);</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+        return (!Services.io.offline);</span>
<a href="#l7.79"></a><span id="l7.79"> </span>
<a href="#l7.80"></a><span id="l7.80">     },</span>
<a href="#l7.81"></a><span id="l7.81"> </span>
<a href="#l7.82"></a><span id="l7.82">     updateOfflineUI: function cOM_updateOfflineUI(aIsOffline) {</span>
<a href="#l7.83"></a><span id="l7.83">         // Refresh the current view</span>
<a href="#l7.84"></a><span id="l7.84">         currentView().goToDay(currentView().selectedDay);</span>
<a href="#l7.85"></a><span id="l7.85"> </span>
<a href="#l7.86"></a><span id="l7.86">         // Set up disabled locks for offline</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/calendar/base/content/calendar-task-tree.xml</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/calendar/base/content/calendar-task-tree.xml</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -110,35 +110,34 @@</span>
<a href="#l8.4"></a><span id="l8.4">         &lt;/xul:treecols&gt;</span>
<a href="#l8.5"></a><span id="l8.5">         &lt;xul:treechildren tooltip=&quot;taskTreeTooltip&quot;/&gt;</span>
<a href="#l8.6"></a><span id="l8.6">       &lt;/xul:tree&gt;</span>
<a href="#l8.7"></a><span id="l8.7">     &lt;/content&gt;</span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9">     &lt;implementation implements=&quot;nsIObserver&quot;&gt;</span>
<a href="#l8.10"></a><span id="l8.10">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l8.11"></a><span id="l8.11">         Components.utils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+        Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l8.13"></a><span id="l8.13">         Components.utils.import(&quot;resource://calendar/modules/calItemUtils.jsm&quot;);</span>
<a href="#l8.14"></a><span id="l8.14">         let self = this;</span>
<a href="#l8.15"></a><span id="l8.15"> </span>
<a href="#l8.16"></a><span id="l8.16">         // set up the tree filter</span>
<a href="#l8.17"></a><span id="l8.17">         this.mFilter = new calFilter();</span>
<a href="#l8.18"></a><span id="l8.18"> </span>
<a href="#l8.19"></a><span id="l8.19">         // set up the custom tree view</span>
<a href="#l8.20"></a><span id="l8.20">         let tree = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;calendar-task-tree&quot;);</span>
<a href="#l8.21"></a><span id="l8.21">         this.mTreeView.tree = tree;</span>
<a href="#l8.22"></a><span id="l8.22">         tree.view = this.mTreeView;</span>
<a href="#l8.23"></a><span id="l8.23"> </span>
<a href="#l8.24"></a><span id="l8.24">         // set up our calendar event observer</span>
<a href="#l8.25"></a><span id="l8.25">         let composite = getCompositeCalendar();</span>
<a href="#l8.26"></a><span id="l8.26">         composite.addObserver(this.mTaskTreeObserver);</span>
<a href="#l8.27"></a><span id="l8.27"> </span>
<a href="#l8.28"></a><span id="l8.28">         // set up the preference observer</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineminus">-        let prefService = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-                                    .getService(Components.interfaces.nsIPrefService);</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-        let branch = prefService.getBranch(&quot;&quot;);</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+        let branch = Services.prefs.getBranch(&quot;&quot;);</span>
<a href="#l8.33"></a><span id="l8.33">         branch.addObserver(&quot;calendar.&quot;, this, false);</span>
<a href="#l8.34"></a><span id="l8.34"> </span>
<a href="#l8.35"></a><span id="l8.35"> </span>
<a href="#l8.36"></a><span id="l8.36">         // we want to make several attributes on the column</span>
<a href="#l8.37"></a><span id="l8.37">         // elements persistent, but unfortunately there's no</span>
<a href="#l8.38"></a><span id="l8.38">         // relyable way with the 'persist' feature.</span>
<a href="#l8.39"></a><span id="l8.39">         // that's why we need to store the necessary bits and</span>
<a href="#l8.40"></a><span id="l8.40">         // pieces at the element this binding is attached to.</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineat">@@ -169,24 +168,24 @@</span>
<a href="#l8.42"></a><span id="l8.42">                 if (sorted == content) {</span>
<a href="#l8.43"></a><span id="l8.43">                     this.mTreeView.sortDirection = sortDirection;</span>
<a href="#l8.44"></a><span id="l8.44">                     this.mTreeView.selectedColumn = treecols[i];</span>
<a href="#l8.45"></a><span id="l8.45">                 }</span>
<a href="#l8.46"></a><span id="l8.46">             }</span>
<a href="#l8.47"></a><span id="l8.47">         }</span>
<a href="#l8.48"></a><span id="l8.48">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l8.49"></a><span id="l8.49">       &lt;destructor&gt;&lt;![CDATA[</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+          Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+</span>
<a href="#l8.52"></a><span id="l8.52">           // remove composite calendar observer</span>
<a href="#l8.53"></a><span id="l8.53">           let composite = getCompositeCalendar();</span>
<a href="#l8.54"></a><span id="l8.54">           composite.removeObserver(this.mTaskTreeObserver);</span>
<a href="#l8.55"></a><span id="l8.55"> </span>
<a href="#l8.56"></a><span id="l8.56">           // remove the preference observer</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineminus">-          let prefService = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineminus">-                                      .getService(Components.interfaces.nsIPrefService);</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineminus">-          let branch = prefService.getBranch(&quot;&quot;);</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+          let branch = Services.prefs.getBranch(&quot;&quot;);</span>
<a href="#l8.61"></a><span id="l8.61">           branch.removeObserver(&quot;calendar.&quot;, this, false);</span>
<a href="#l8.62"></a><span id="l8.62"> </span>
<a href="#l8.63"></a><span id="l8.63">           let widths = &quot;&quot;;</span>
<a href="#l8.64"></a><span id="l8.64">           let ordinals = &quot;&quot;;</span>
<a href="#l8.65"></a><span id="l8.65">           let visible = &quot;&quot;;</span>
<a href="#l8.66"></a><span id="l8.66">           let sorted = this.mTreeView.selectedColumn;</span>
<a href="#l8.67"></a><span id="l8.67">           let tree = document.getAnonymousNodes(this)[0];</span>
<a href="#l8.68"></a><span id="l8.68">           let treecols = tree.getElementsByTagNameNS(tree.namespaceURI, &quot;treecol&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/calendar/base/content/calendar-task-view.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/calendar/base/content/calendar-task-view.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1,13 +1,14 @@</span>
<a href="#l9.4"></a><span id="l9.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.5"></a><span id="l9.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.6"></a><span id="l9.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8"> Components.utils.import(&quot;resource://calendar/modules/calRecurrenceUtils.jsm&quot;);</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11"> var taskDetailsView = {</span>
<a href="#l9.12"></a><span id="l9.12"> </span>
<a href="#l9.13"></a><span id="l9.13">     /**</span>
<a href="#l9.14"></a><span id="l9.14">      * Task Details Events</span>
<a href="#l9.15"></a><span id="l9.15">      *</span>
<a href="#l9.16"></a><span id="l9.16">      * XXXberend Please document this function, possibly also consolidate since</span>
<a href="#l9.17"></a><span id="l9.17">      * its the only function in taskDetailsView.</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineat">@@ -259,20 +260,17 @@ function taskViewOnLoad() {</span>
<a href="#l9.19"></a><span id="l9.19">     var toolbox = document.getElementById(&quot;task-actions-toolbox&quot;);</span>
<a href="#l9.20"></a><span id="l9.20">     toolbox.customizeDone = function(aEvent) {</span>
<a href="#l9.21"></a><span id="l9.21">         MailToolboxCustomizeDone(aEvent, &quot;CustomizeTaskActionsToolbar&quot;);</span>
<a href="#l9.22"></a><span id="l9.22">     };</span>
<a href="#l9.23"></a><span id="l9.23"> </span>
<a href="#l9.24"></a><span id="l9.24">     var toolbarset = document.getElementById(&quot;customToolbars&quot;);</span>
<a href="#l9.25"></a><span id="l9.25">     toolbox.toolbarset = toolbarset;</span>
<a href="#l9.26"></a><span id="l9.26"> </span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">-    Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">-              .getService(Components.interfaces.nsIObserverService)</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">-              .notifyObservers(window, &quot;calendar-taskview-startup-done&quot;,</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-                               false);</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+    Services.obs.notifyObservers(window, &quot;calendar-taskview-startup-done&quot;, false);</span>
<a href="#l9.32"></a><span id="l9.32"> }</span>
<a href="#l9.33"></a><span id="l9.33"> </span>
<a href="#l9.34"></a><span id="l9.34"> /**</span>
<a href="#l9.35"></a><span id="l9.35">  * Copy the value of the given link node to the clipboard</span>
<a href="#l9.36"></a><span id="l9.36">  *</span>
<a href="#l9.37"></a><span id="l9.37">  * @param linkNode      The node containing the value to copy to the clipboard</span>
<a href="#l9.38"></a><span id="l9.38">  */</span>
<a href="#l9.39"></a><span id="l9.39"> function taskViewCopyLink(linkNode) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/calendar/base/content/calendar-unifinder.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/calendar/base/content/calendar-unifinder.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -8,16 +8,17 @@</span>
<a href="#l10.4"></a><span id="l10.4">  * This is a hacked in interface to the unifinder. We will need to</span>
<a href="#l10.5"></a><span id="l10.5">  * improve this to make it usable in general.</span>
<a href="#l10.6"></a><span id="l10.6">  *</span>
<a href="#l10.7"></a><span id="l10.7">  * NOTE: Including this file will cause a load handler to be added to the</span>
<a href="#l10.8"></a><span id="l10.8">  * window.</span>
<a href="#l10.9"></a><span id="l10.9">  */</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l10.13"></a><span id="l10.13"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l10.14"></a><span id="l10.14"> </span>
<a href="#l10.15"></a><span id="l10.15"> // Set this to true when the calendar event tree is clicked to allow for</span>
<a href="#l10.16"></a><span id="l10.16"> // multiple selection</span>
<a href="#l10.17"></a><span id="l10.17"> var gCalendarEventTreeClicked = false;</span>
<a href="#l10.18"></a><span id="l10.18"> </span>
<a href="#l10.19"></a><span id="l10.19"> // Store the start and enddate, because the providers can't be trusted when</span>
<a href="#l10.20"></a><span id="l10.20"> // dealing with all-day events. So we need to filter later. See bug 306157</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineat">@@ -183,19 +184,17 @@ var unifinderObserver = {</span>
<a href="#l10.22"></a><span id="l10.22">  * used to add observers, event listeners, etc.</span>
<a href="#l10.23"></a><span id="l10.23">  */</span>
<a href="#l10.24"></a><span id="l10.24"> function prepareCalendarUnifinder() {</span>
<a href="#l10.25"></a><span id="l10.25">     // Only load once</span>
<a href="#l10.26"></a><span id="l10.26">     window.removeEventListener(&quot;load&quot;, prepareCalendarUnifinder, false);</span>
<a href="#l10.27"></a><span id="l10.27">     let unifinderTree = document.getElementById(&quot;unifinder-search-results-tree&quot;);</span>
<a href="#l10.28"></a><span id="l10.28"> </span>
<a href="#l10.29"></a><span id="l10.29">     // Add pref observer</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">-    let prefService = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-                                .getService(Components.interfaces.nsIPrefService);</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-    let branch = prefService.getBranch(&quot;&quot;);</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+    let branch = Services.prefs.getBranch(&quot;&quot;);</span>
<a href="#l10.34"></a><span id="l10.34">     branch.addObserver(&quot;calendar.&quot;, unifinderObserver, false);</span>
<a href="#l10.35"></a><span id="l10.35"> </span>
<a href="#l10.36"></a><span id="l10.36">     // Check if this is not the hidden window, which has no UI elements</span>
<a href="#l10.37"></a><span id="l10.37">     if (unifinderTree) {</span>
<a href="#l10.38"></a><span id="l10.38">         // set up our calendar event observer</span>
<a href="#l10.39"></a><span id="l10.39">         let ccalendar = getCompositeCalendar();</span>
<a href="#l10.40"></a><span id="l10.40">         ccalendar.addObserver(unifinderObserver);</span>
<a href="#l10.41"></a><span id="l10.41"> </span>
<a href="#l10.42"></a><span id="l10.42" class="difflineat">@@ -241,19 +240,17 @@ function prepareCalendarUnifinder() {</span>
<a href="#l10.43"></a><span id="l10.43">  * Called when the window is unloaded to clean up any observers and listeners</span>
<a href="#l10.44"></a><span id="l10.44">  * added.</span>
<a href="#l10.45"></a><span id="l10.45">  */</span>
<a href="#l10.46"></a><span id="l10.46"> function finishCalendarUnifinder() {</span>
<a href="#l10.47"></a><span id="l10.47">     let ccalendar = getCompositeCalendar();</span>
<a href="#l10.48"></a><span id="l10.48">     ccalendar.removeObserver(unifinderObserver);</span>
<a href="#l10.49"></a><span id="l10.49"> </span>
<a href="#l10.50"></a><span id="l10.50">     // Remove pref observer</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineminus">-    let prefService = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineminus">-                                .getService(Components.interfaces.nsIPrefService);</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineminus">-    let branch = prefService.getBranch(&quot;&quot;);</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineplus">+    let branch = Services.prefs.getBranch(&quot;&quot;);</span>
<a href="#l10.55"></a><span id="l10.55">     branch.removeObserver(&quot;calendar.&quot;, unifinderObserver, false);</span>
<a href="#l10.56"></a><span id="l10.56"> </span>
<a href="#l10.57"></a><span id="l10.57">     let viewDeck = getViewDeck();</span>
<a href="#l10.58"></a><span id="l10.58">     if (viewDeck) {</span>
<a href="#l10.59"></a><span id="l10.59">         viewDeck.removeEventListener(&quot;dayselect&quot;, unifinderDaySelect, false);</span>
<a href="#l10.60"></a><span id="l10.60">         viewDeck.removeEventListener(&quot;itemselect&quot;, unifinderItemSelect, true);</span>
<a href="#l10.61"></a><span id="l10.61">     }</span>
<a href="#l10.62"></a><span id="l10.62"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/calendar/base/content/calendar-views.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/calendar/base/content/calendar-views.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -1,14 +1,15 @@</span>
<a href="#l11.4"></a><span id="l11.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.5"></a><span id="l11.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.6"></a><span id="l11.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.7"></a><span id="l11.7"> </span>
<a href="#l11.8"></a><span id="l11.8"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l11.9"></a><span id="l11.9"> Components.utils.import(&quot;resource://calendar/modules/calAlarmUtils.jsm&quot;);</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12"> /**</span>
<a href="#l11.13"></a><span id="l11.13">  * Controller for the views</span>
<a href="#l11.14"></a><span id="l11.14">  * @see calIcalendarViewController</span>
<a href="#l11.15"></a><span id="l11.15">  */</span>
<a href="#l11.16"></a><span id="l11.16"> var calendarViewController = {</span>
<a href="#l11.17"></a><span id="l11.17">     QueryInterface: function(aIID) {</span>
<a href="#l11.18"></a><span id="l11.18">         if (!aIID.equals(Components.interfaces.calICalendarViewController) &amp;&amp;</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineat">@@ -411,24 +412,22 @@ function scheduleMidnightUpdate(aRefresh</span>
<a href="#l11.20"></a><span id="l11.20">                    }</span>
<a href="#l11.21"></a><span id="l11.21">                    this.mTimer.initWithCallback(udCallback, 10 * 1000,</span>
<a href="#l11.22"></a><span id="l11.22">                                                 Components.interfaces.nsITimer.TYPE_ONE_SHOT);</span>
<a href="#l11.23"></a><span id="l11.23">                }</span>
<a href="#l11.24"></a><span id="l11.24">            }</span>
<a href="#l11.25"></a><span id="l11.25">         };</span>
<a href="#l11.26"></a><span id="l11.26"> </span>
<a href="#l11.27"></a><span id="l11.27">         // Add observer</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">-        var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineminus">-                                        .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-        observerService.addObserver(wakeObserver, &quot;wake_notification&quot;, false);</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+        Services.obs.addObserver(wakeObserver, &quot;wake_notification&quot;, false);</span>
<a href="#l11.32"></a><span id="l11.32"> </span>
<a href="#l11.33"></a><span id="l11.33">         // Remove observer on unload</span>
<a href="#l11.34"></a><span id="l11.34">         window.addEventListener(&quot;unload&quot;,</span>
<a href="#l11.35"></a><span id="l11.35">                                 function() {</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineminus">-                                    observerService.removeObserver(wakeObserver, &quot;wake_notification&quot;);</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+                                    Services.obs.removeObserver(wakeObserver, &quot;wake_notification&quot;);</span>
<a href="#l11.38"></a><span id="l11.38">                                 }, false);</span>
<a href="#l11.39"></a><span id="l11.39">         gMidnightTimer = Components.classes[&quot;@mozilla.org/timer;1&quot;]</span>
<a href="#l11.40"></a><span id="l11.40">                                    .createInstance(Components.interfaces.nsITimer);</span>
<a href="#l11.41"></a><span id="l11.41">     } else {</span>
<a href="#l11.42"></a><span id="l11.42">         gMidnightTimer.cancel();</span>
<a href="#l11.43"></a><span id="l11.43">     }</span>
<a href="#l11.44"></a><span id="l11.44">     gMidnightTimer.initWithCallback(udCallback, msUntilTomorrow, gMidnightTimer.TYPE_ONE_SHOT);</span>
<a href="#l11.45"></a><span id="l11.45"> }</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineat">@@ -491,19 +490,17 @@ var categoryManagement = {</span>
<a href="#l11.47"></a><span id="l11.47">     QueryInterface: function cM_QueryInterface(aIID) {</span>
<a href="#l11.48"></a><span id="l11.48">         return cal.doQueryInterface(this,</span>
<a href="#l11.49"></a><span id="l11.49">                                     categoryManagement.__proto__,</span>
<a href="#l11.50"></a><span id="l11.50">                                     aIID,</span>
<a href="#l11.51"></a><span id="l11.51">                                     [Components.interfaces.nsIObserver]);</span>
<a href="#l11.52"></a><span id="l11.52">     },</span>
<a href="#l11.53"></a><span id="l11.53"> </span>
<a href="#l11.54"></a><span id="l11.54">     initCategories: function cM_initCategories() {</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineminus">-      let prefService = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineminus">-                                  .getService(Components.interfaces.nsIPrefService);</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineminus">-      categoryPrefBranch = prefService.getBranch(&quot;calendar.category.color.&quot;);</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineplus">+      categoryPrefBranch = Services.prefs.getBranch(&quot;calendar.category.color.&quot;);</span>
<a href="#l11.59"></a><span id="l11.59">       let categories = categoryPrefBranch.getChildList(&quot;&quot;);</span>
<a href="#l11.60"></a><span id="l11.60"> </span>
<a href="#l11.61"></a><span id="l11.61">       // Fix illegally formatted category prefs.</span>
<a href="#l11.62"></a><span id="l11.62">       for (let i in categories) {</span>
<a href="#l11.63"></a><span id="l11.63">           let category = categories[i];</span>
<a href="#l11.64"></a><span id="l11.64">           if (category.search(/[^_0-9a-z-]/) != -1) {</span>
<a href="#l11.65"></a><span id="l11.65">               let categoryFix = formatStringForCSSRule(category);</span>
<a href="#l11.66"></a><span id="l11.66">               if (!categoryPrefBranch.prefHasUserValue(categoryFix)) {</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineat">@@ -519,19 +516,17 @@ var categoryManagement = {</span>
<a href="#l11.68"></a><span id="l11.68"> </span>
<a href="#l11.69"></a><span id="l11.69">       // Add color information to the stylesheets.</span>
<a href="#l11.70"></a><span id="l11.70">       categories.forEach(categoryManagement.updateStyleSheetForCategory,</span>
<a href="#l11.71"></a><span id="l11.71">                          categoryManagement);</span>
<a href="#l11.72"></a><span id="l11.72">       categoryPrefBranch.addObserver(&quot;&quot;, categoryManagement, false);</span>
<a href="#l11.73"></a><span id="l11.73">     },</span>
<a href="#l11.74"></a><span id="l11.74"> </span>
<a href="#l11.75"></a><span id="l11.75">     cleanupCategories: function cM_cleanupCategories() {</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineminus">-      let prefService = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineminus">-                                  .getService(Components.interfaces.nsIPrefService);</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineminus">-      categoryPrefBranch = prefService.getBranch(&quot;calendar.category.color.&quot;);</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineplus">+      categoryPrefBranch = Services.prefs.getBranch(&quot;calendar.category.color.&quot;);</span>
<a href="#l11.80"></a><span id="l11.80">       categoryPrefBranch.removeObserver(&quot;&quot;, categoryManagement);</span>
<a href="#l11.81"></a><span id="l11.81">     },</span>
<a href="#l11.82"></a><span id="l11.82"> </span>
<a href="#l11.83"></a><span id="l11.83">     observe: function cM_observe(aSubject, aTopic, aPrefName) {</span>
<a href="#l11.84"></a><span id="l11.84">         this.updateStyleSheetForCategory(aPrefName);</span>
<a href="#l11.85"></a><span id="l11.85">         // TODO Currently, the only way to find out if categories are removed is</span>
<a href="#l11.86"></a><span id="l11.86">         // to initially grab the calendar.categories.names preference and then</span>
<a href="#l11.87"></a><span id="l11.87">         // observe changes to it. it would be better if we had hooks for this,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-dialog-utils.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-dialog-utils.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -1,13 +1,14 @@</span>
<a href="#l12.4"></a><span id="l12.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l12.5"></a><span id="l12.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l12.6"></a><span id="l12.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8"> Components.utils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l12.10"></a><span id="l12.10"> </span>
<a href="#l12.11"></a><span id="l12.11"> Components.utils.import(&quot;resource://calendar/modules/calAlarmUtils.jsm&quot;);</span>
<a href="#l12.12"></a><span id="l12.12"> Components.utils.import(&quot;resource://calendar/modules/calIteratorUtils.jsm&quot;);</span>
<a href="#l12.13"></a><span id="l12.13"> Components.utils.import(&quot;resource://calendar/modules/calRecurrenceUtils.jsm&quot;);</span>
<a href="#l12.14"></a><span id="l12.14"> </span>
<a href="#l12.15"></a><span id="l12.15"> /**</span>
<a href="#l12.16"></a><span id="l12.16">  * Dispose of controlling operations of this event dialog. Uses</span>
<a href="#l12.17"></a><span id="l12.17">  * window.arguments[0].job.dispose()</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineat">@@ -425,17 +426,17 @@ function updateLink() {</span>
<a href="#l12.19"></a><span id="l12.19">         !itemUrlString.length) {</span>
<a href="#l12.20"></a><span id="l12.20">         // Hide if there is no url, or the menuitem was chosen so that the url</span>
<a href="#l12.21"></a><span id="l12.21">         // should be hidden</span>
<a href="#l12.22"></a><span id="l12.22">         hideOrShow(false);</span>
<a href="#l12.23"></a><span id="l12.23">     } else {</span>
<a href="#l12.24"></a><span id="l12.24">         var handler, uri;</span>
<a href="#l12.25"></a><span id="l12.25">         try {</span>
<a href="#l12.26"></a><span id="l12.26">             uri = makeURL(itemUrlString);</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineminus">-            handler = getIOService().getProtocolHandler(uri.scheme);</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineplus">+            handler = Services.io.getProtocolHandler(uri.scheme);</span>
<a href="#l12.29"></a><span id="l12.29">         } catch (e) {</span>
<a href="#l12.30"></a><span id="l12.30">             // No protocol handler for the given protocol, or invalid uri</span>
<a href="#l12.31"></a><span id="l12.31">             hideOrShow(false);</span>
<a href="#l12.32"></a><span id="l12.32">             return;</span>
<a href="#l12.33"></a><span id="l12.33">         }</span>
<a href="#l12.34"></a><span id="l12.34"> </span>
<a href="#l12.35"></a><span id="l12.35">         // Only show if its either an internal protcol handler, or its external</span>
<a href="#l12.36"></a><span id="l12.36">         // and there is an external app for the scheme</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-attendees.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-attendees.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -1,12 +1,14 @@</span>
<a href="#l13.4"></a><span id="l13.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l13.5"></a><span id="l13.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l13.6"></a><span id="l13.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l13.7"></a><span id="l13.7"> </span>
<a href="#l13.8"></a><span id="l13.8" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineplus">+</span>
<a href="#l13.10"></a><span id="l13.10"> var gStartDate = null;</span>
<a href="#l13.11"></a><span id="l13.11"> var gEndDate = null;</span>
<a href="#l13.12"></a><span id="l13.12"> var gStartTimezone = null;</span>
<a href="#l13.13"></a><span id="l13.13"> var gEndTimezone = null;</span>
<a href="#l13.14"></a><span id="l13.14"> var gDuration = null;</span>
<a href="#l13.15"></a><span id="l13.15"> var gStartHour = 0;</span>
<a href="#l13.16"></a><span id="l13.16"> var gEndHour = 24;</span>
<a href="#l13.17"></a><span id="l13.17"> var gIsReadOnly = false;</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineat">@@ -98,22 +100,20 @@ function onLoad() {</span>
<a href="#l13.19"></a><span id="l13.19">                 case &quot;calendar.view.daystarthour&quot;:</span>
<a href="#l13.20"></a><span id="l13.20">                 case &quot;calendar.view.dayendhour&quot;:</span>
<a href="#l13.21"></a><span id="l13.21">                     initTimeRange();</span>
<a href="#l13.22"></a><span id="l13.22">                     propagateDateTime();</span>
<a href="#l13.23"></a><span id="l13.23">                     break;</span>
<a href="#l13.24"></a><span id="l13.24">             }</span>
<a href="#l13.25"></a><span id="l13.25">         }</span>
<a href="#l13.26"></a><span id="l13.26">     }</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineminus">-    var pb2 = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;].</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineminus">-              getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineminus">-    pb2.addObserver(&quot;calendar.&quot;, prefObserver, false);</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+    Services.prefs.addObserver(&quot;calendar.&quot;, prefObserver, false);</span>
<a href="#l13.31"></a><span id="l13.31">     window.addEventListener(&quot;unload&quot;,</span>
<a href="#l13.32"></a><span id="l13.32">         function() {</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-            pb2.removeObserver(&quot;calendar.&quot;, prefObserver);</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+            Services.prefs.removeObserver(&quot;calendar.&quot;, prefObserver);</span>
<a href="#l13.35"></a><span id="l13.35">         },</span>
<a href="#l13.36"></a><span id="l13.36">         false);</span>
<a href="#l13.37"></a><span id="l13.37"> </span>
<a href="#l13.38"></a><span id="l13.38">     opener.setCursor(&quot;auto&quot;);</span>
<a href="#l13.39"></a><span id="l13.39">     self.focus();</span>
<a href="#l13.40"></a><span id="l13.40"> }</span>
<a href="#l13.41"></a><span id="l13.41"> </span>
<a href="#l13.42"></a><span id="l13.42"> /**</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineat">@@ -403,22 +403,17 @@ function updateEndTime() {</span>
<a href="#l13.44"></a><span id="l13.44">         gEndDate = saveEndTime;</span>
<a href="#l13.45"></a><span id="l13.45">         warning = true;</span>
<a href="#l13.46"></a><span id="l13.46">     }</span>
<a href="#l13.47"></a><span id="l13.47"> </span>
<a href="#l13.48"></a><span id="l13.48">     propagateDateTime();</span>
<a href="#l13.49"></a><span id="l13.49"> </span>
<a href="#l13.50"></a><span id="l13.50">     if (warning) {</span>
<a href="#l13.51"></a><span id="l13.51">         var callback = function() {</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineminus">-            var promptService =</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineminus">-                Components.classes[</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineminus">-                    &quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineminus">-                    .getService(</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineminus">-                        Components.interfaces.nsIPromptService);</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineminus">-            promptService.alert(</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineplus">+            Services.prompt.alert(</span>
<a href="#l13.59"></a><span id="l13.59">                 null,</span>
<a href="#l13.60"></a><span id="l13.60">                 document.title,</span>
<a href="#l13.61"></a><span id="l13.61">                 calGetString(&quot;calendar&quot;, &quot;warningEndBeforeStart&quot;));</span>
<a href="#l13.62"></a><span id="l13.62">         }</span>
<a href="#l13.63"></a><span id="l13.63">         setTimeout(callback, 1);</span>
<a href="#l13.64"></a><span id="l13.64">     }</span>
<a href="#l13.65"></a><span id="l13.65"> }</span>
<a href="#l13.66"></a><span id="l13.66"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -62,16 +62,17 @@</span>
<a href="#l14.4"></a><span id="l14.4">       &lt;field name=&quot;mLDAPSession&quot;&gt;null&lt;/field&gt;</span>
<a href="#l14.5"></a><span id="l14.5">       &lt;field name=&quot;mSessionAdded&quot;&gt;false&lt;/field&gt;</span>
<a href="#l14.6"></a><span id="l14.6">       &lt;field name=&quot;mIsReadOnly&quot;&gt;false&lt;/field&gt;</span>
<a href="#l14.7"></a><span id="l14.7">       &lt;field name=&quot;mIsInvitation&quot;&gt;false&lt;/field&gt;</span>
<a href="#l14.8"></a><span id="l14.8">       &lt;field name=&quot;mPopupOpen&quot;&gt;false&lt;/field&gt;</span>
<a href="#l14.9"></a><span id="l14.9"> </span>
<a href="#l14.10"></a><span id="l14.10">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l14.11"></a><span id="l14.11">         Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+        Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l14.13"></a><span id="l14.13"> </span>
<a href="#l14.14"></a><span id="l14.14">         this.mMaxAttendees = 0;</span>
<a href="#l14.15"></a><span id="l14.15"> </span>
<a href="#l14.16"></a><span id="l14.16">         var self = this;</span>
<a href="#l14.17"></a><span id="l14.17">         var load = function loadHandler() {</span>
<a href="#l14.18"></a><span id="l14.18">             self.onLoad();</span>
<a href="#l14.19"></a><span id="l14.19">         };</span>
<a href="#l14.20"></a><span id="l14.20">         window.addEventListener(&quot;load&quot;, load, true);</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineat">@@ -98,19 +99,17 @@</span>
<a href="#l14.22"></a><span id="l14.22"> </span>
<a href="#l14.23"></a><span id="l14.23">         var component = Components.classes[&quot;@mozilla.org/messenger/headerparser;1&quot;];</span>
<a href="#l14.24"></a><span id="l14.24">         if (component) {</span>
<a href="#l14.25"></a><span id="l14.25">             this.mHeaderParser = component.getService(Components.interfaces.nsIMsgHeaderParser);</span>
<a href="#l14.26"></a><span id="l14.26">         }</span>
<a href="#l14.27"></a><span id="l14.27"> </span>
<a href="#l14.28"></a><span id="l14.28">         // First get the preferences service</span>
<a href="#l14.29"></a><span id="l14.29">         try {</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineminus">-            this.mPrefs = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-                                    .getService(Components.interfaces.nsIPrefService)</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">-                                    .getBranch(null);</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+            this.mPrefs = Services.prefs.getBranch(null);</span>
<a href="#l14.34"></a><span id="l14.34">         } catch (ex) {</span>
<a href="#l14.35"></a><span id="l14.35">         }</span>
<a href="#l14.36"></a><span id="l14.36"> </span>
<a href="#l14.37"></a><span id="l14.37">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l14.38"></a><span id="l14.38"> </span>
<a href="#l14.39"></a><span id="l14.39">       &lt;method name=&quot;onLoad&quot;&gt;</span>
<a href="#l14.40"></a><span id="l14.40">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l14.41"></a><span id="l14.41">           var listbox =</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineat">@@ -1214,16 +1213,18 @@</span>
<a href="#l14.43"></a><span id="l14.43">       &lt;/method&gt;</span>
<a href="#l14.44"></a><span id="l14.44"> </span>
<a href="#l14.45"></a><span id="l14.45">       &lt;!-- ############################################################################# --&gt;</span>
<a href="#l14.46"></a><span id="l14.46">       &lt;!-- LDAP support                                                                  --&gt;</span>
<a href="#l14.47"></a><span id="l14.47">       &lt;!-- ############################################################################# --&gt;</span>
<a href="#l14.48"></a><span id="l14.48"> </span>
<a href="#l14.49"></a><span id="l14.49">       &lt;method name=&quot;setupAutocomplete&quot;&gt;</span>
<a href="#l14.50"></a><span id="l14.50">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+          Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+</span>
<a href="#l14.53"></a><span id="l14.53">           var setupObserver = false;</span>
<a href="#l14.54"></a><span id="l14.54">           var autocompleteLdap = false;</span>
<a href="#l14.55"></a><span id="l14.55">           var autocompleteDirectory = null;</span>
<a href="#l14.56"></a><span id="l14.56">           var prevAutocompleteDirectory = this.mCurrentAutocompleteDirectory;</span>
<a href="#l14.57"></a><span id="l14.57">           var i;</span>
<a href="#l14.58"></a><span id="l14.58"> </span>
<a href="#l14.59"></a><span id="l14.59">           try {</span>
<a href="#l14.60"></a><span id="l14.60">               autocompleteLdap = this.mPrefs.getBoolPref(&quot;ldap_2.autoComplete.useDirectory&quot;);</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineat">@@ -1251,17 +1252,17 @@</span>
<a href="#l14.62"></a><span id="l14.62">               LDAPSession = this.mLDAPSession;</span>
<a href="#l14.63"></a><span id="l14.63">           } else {</span>
<a href="#l14.64"></a><span id="l14.64">               LDAPSession = Components.classes[</span>
<a href="#l14.65"></a><span id="l14.65">                   &quot;@mozilla.org/autocompleteSession;1?type=ldap&quot;].createInstance()</span>
<a href="#l14.66"></a><span id="l14.66">                   .QueryInterface(</span>
<a href="#l14.67"></a><span id="l14.67">                       Components.interfaces.nsILDAPAutoCompleteSession);</span>
<a href="#l14.68"></a><span id="l14.68">           }</span>
<a href="#l14.69"></a><span id="l14.69"> </span>
<a href="#l14.70"></a><span id="l14.70" class="difflineminus">-          if (LDAPSession &amp;&amp; autocompleteDirectory &amp;&amp; !cal.getIOService().offline) {</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+          if (LDAPSession &amp;&amp; autocompleteDirectory &amp;&amp; !Services.io.offline) {</span>
<a href="#l14.72"></a><span id="l14.72">               // Add observer on the directory server we are autocompleting against</span>
<a href="#l14.73"></a><span id="l14.73">               // only if current server is different from previous.</span>
<a href="#l14.74"></a><span id="l14.74">               // Remove observer if current server is different from previous</span>
<a href="#l14.75"></a><span id="l14.75">               this.mCurrentAutocompleteDirectory = autocompleteDirectory;</span>
<a href="#l14.76"></a><span id="l14.76">               if (prevAutocompleteDirectory) {</span>
<a href="#l14.77"></a><span id="l14.77">                   if (prevAutocompleteDirectory != this.mCurrentAutocompleteDirectory) {</span>
<a href="#l14.78"></a><span id="l14.78">                       this.removeDirectorySettingsObserver(prevAutocompleteDirectory);</span>
<a href="#l14.79"></a><span id="l14.79">                       this.addDirectorySettingsObserver();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -1,13 +1,14 @@</span>
<a href="#l15.4"></a><span id="l15.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l15.5"></a><span id="l15.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l15.6"></a><span id="l15.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l15.7"></a><span id="l15.7"> </span>
<a href="#l15.8"></a><span id="l15.8"> Components.utils.import(&quot;resource://calendar/modules/calRecurrenceUtils.jsm&quot;);</span>
<a href="#l15.9"></a><span id="l15.9" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l15.10"></a><span id="l15.10"> </span>
<a href="#l15.11"></a><span id="l15.11"> var gIsReadOnly = false;</span>
<a href="#l15.12"></a><span id="l15.12"> var gStartTime = null;</span>
<a href="#l15.13"></a><span id="l15.13"> var gEndTime = null;</span>
<a href="#l15.14"></a><span id="l15.14"> var gUntilDate = null;</span>
<a href="#l15.15"></a><span id="l15.15"> </span>
<a href="#l15.16"></a><span id="l15.16"> /**</span>
<a href="#l15.17"></a><span id="l15.17">  * Sets up the recurrence dialog from the window arguments. Takes care of filling</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineat">@@ -599,20 +600,18 @@ function checkUntilDate() {</span>
<a href="#l15.19"></a><span id="l15.19">     if (untilDate.compare(startDate) &lt; 0) {</span>
<a href="#l15.20"></a><span id="l15.20">         setElementValue(&quot;repeat-until-date&quot;, (gUntilDate || gStartTime).getInTimezone(floating()).jsDate);</span>
<a href="#l15.21"></a><span id="l15.21">         checkUntilDate.warning = true;</span>
<a href="#l15.22"></a><span id="l15.22">         let callback = function() {</span>
<a href="#l15.23"></a><span id="l15.23">             // No warning when the dialog is being closed with the Cancel button.</span>
<a href="#l15.24"></a><span id="l15.24">             if (!checkUntilDate.warning) {</span>
<a href="#l15.25"></a><span id="l15.25">                 return;</span>
<a href="#l15.26"></a><span id="l15.26">             }</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineminus">-            let promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineminus">-                                          .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineminus">-            promptService.alert(null, document.title,</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineminus">-                                calGetString(&quot;calendar&quot;, &quot;warningUntilBeforeStart&quot;));</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineplus">+            Services.prompt.alert(null, document.title,</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+                                  calGetString(&quot;calendar&quot;, &quot;warningUntilBeforeStart&quot;));</span>
<a href="#l15.33"></a><span id="l15.33">             checkUntilDate.warning = false;</span>
<a href="#l15.34"></a><span id="l15.34">         }</span>
<a href="#l15.35"></a><span id="l15.35">         setTimeout(callback, 1);</span>
<a href="#l15.36"></a><span id="l15.36">     } else {</span>
<a href="#l15.37"></a><span id="l15.37">         gUntilDate = untilDate;</span>
<a href="#l15.38"></a><span id="l15.38">         updateRecurrenceControls();</span>
<a href="#l15.39"></a><span id="l15.39">     }</span>
<a href="#l15.40"></a><span id="l15.40"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -250,18 +250,17 @@ function onAccept() {</span>
<a href="#l16.4"></a><span id="l16.4">  * @return    Returns true if the window should be closed.</span>
<a href="#l16.5"></a><span id="l16.5">  */</span>
<a href="#l16.6"></a><span id="l16.6"> function onCommandCancel() {</span>
<a href="#l16.7"></a><span id="l16.7">     // Allow closing if the item has not changed and no warning dialog has to be showed.</span>
<a href="#l16.8"></a><span id="l16.8">     if (!isItemChanged() &amp;&amp; !gWarning) {</span>
<a href="#l16.9"></a><span id="l16.9">         return true;</span>
<a href="#l16.10"></a><span id="l16.10">     }</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-    var promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-                        .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+    var promptService = Components.interfaces.nsIPromptService;</span>
<a href="#l16.15"></a><span id="l16.15"> </span>
<a href="#l16.16"></a><span id="l16.16">     var promptTitle = calGetString(&quot;calendar&quot;,</span>
<a href="#l16.17"></a><span id="l16.17">                                    isEvent(window.calendarItem) ?</span>
<a href="#l16.18"></a><span id="l16.18">                                       &quot;askSaveTitleEvent&quot; :</span>
<a href="#l16.19"></a><span id="l16.19">                                       &quot;askSaveTitleTask&quot;);</span>
<a href="#l16.20"></a><span id="l16.20">     var promptMessage = calGetString(&quot;calendar&quot;,</span>
<a href="#l16.21"></a><span id="l16.21">                                      isEvent(window.calendarItem) ?</span>
<a href="#l16.22"></a><span id="l16.22">                                         &quot;askSaveMessageEvent&quot; :</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineat">@@ -269,25 +268,25 @@ function onCommandCancel() {</span>
<a href="#l16.24"></a><span id="l16.24"> </span>
<a href="#l16.25"></a><span id="l16.25">     var flags = promptService.BUTTON_TITLE_SAVE *</span>
<a href="#l16.26"></a><span id="l16.26">                 promptService.BUTTON_POS_0 +</span>
<a href="#l16.27"></a><span id="l16.27">                 promptService.BUTTON_TITLE_CANCEL *</span>
<a href="#l16.28"></a><span id="l16.28">                 promptService.BUTTON_POS_1 +</span>
<a href="#l16.29"></a><span id="l16.29">                 promptService.BUTTON_TITLE_DONT_SAVE *</span>
<a href="#l16.30"></a><span id="l16.30">                 promptService.BUTTON_POS_2;</span>
<a href="#l16.31"></a><span id="l16.31"> </span>
<a href="#l16.32"></a><span id="l16.32" class="difflineminus">-    var choice = promptService.confirmEx(null,</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineminus">-                                         promptTitle,</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineminus">-                                         promptMessage,</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineminus">-                                         flags,</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineminus">-                                         null,</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineminus">-                                         null,</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineminus">-                                         null,</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineminus">-                                         null,</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineminus">-                                         {});</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineplus">+    var choice = Services.prompt.confirmEx(null,</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineplus">+                                           promptTitle,</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineplus">+                                           promptMessage,</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineplus">+                                           flags,</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineplus">+                                           null,</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineplus">+                                           null,</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineplus">+                                           null,</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineplus">+                                           null,</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineplus">+                                           {});</span>
<a href="#l16.50"></a><span id="l16.50">     switch (choice) {</span>
<a href="#l16.51"></a><span id="l16.51">         case 0: // Save</span>
<a href="#l16.52"></a><span id="l16.52">             onCommandSave(true);</span>
<a href="#l16.53"></a><span id="l16.53">             return true;</span>
<a href="#l16.54"></a><span id="l16.54">         case 2: // Don't save</span>
<a href="#l16.55"></a><span id="l16.55">             // Don't show any warning dialog when closing without saving.</span>
<a href="#l16.56"></a><span id="l16.56">             gWarning = false;</span>
<a href="#l16.57"></a><span id="l16.57">             return true;</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineat">@@ -629,19 +628,17 @@ function dateTimeControls2State(aStartDa</span>
<a href="#l16.59"></a><span id="l16.59">     }</span>
<a href="#l16.60"></a><span id="l16.60"> </span>
<a href="#l16.61"></a><span id="l16.61">     updateDateTime();</span>
<a href="#l16.62"></a><span id="l16.62">     updateTimezone();</span>
<a href="#l16.63"></a><span id="l16.63"> </span>
<a href="#l16.64"></a><span id="l16.64">     if (warning) {</span>
<a href="#l16.65"></a><span id="l16.65">         gWarning = true;</span>
<a href="#l16.66"></a><span id="l16.66">         var callback = function func() {</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineminus">-            var promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineminus">-                                .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineminus">-            promptService.alert(</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineplus">+            Services.prompt.alert(</span>
<a href="#l16.71"></a><span id="l16.71">                 null,</span>
<a href="#l16.72"></a><span id="l16.72">                 document.title,</span>
<a href="#l16.73"></a><span id="l16.73">                 calGetString(&quot;calendar&quot;, &quot;warningEndBeforeStart&quot;));</span>
<a href="#l16.74"></a><span id="l16.74">                 gWarning = false;</span>
<a href="#l16.75"></a><span id="l16.75">         }</span>
<a href="#l16.76"></a><span id="l16.76">         setTimeout(callback, 1);</span>
<a href="#l16.77"></a><span id="l16.77">     }</span>
<a href="#l16.78"></a><span id="l16.78"> }</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineat">@@ -1659,29 +1656,27 @@ function loadCloudProviders() {</span>
<a href="#l16.80"></a><span id="l16.80">         optionsPopup.appendChild(item).cloudProvider = cloudProvider;</span>
<a href="#l16.81"></a><span id="l16.81">     }</span>
<a href="#l16.82"></a><span id="l16.82"> }</span>
<a href="#l16.83"></a><span id="l16.83"> </span>
<a href="#l16.84"></a><span id="l16.84"> /**</span>
<a href="#l16.85"></a><span id="l16.85">  * Prompts the user to attach an url to this item.</span>
<a href="#l16.86"></a><span id="l16.86">  */</span>
<a href="#l16.87"></a><span id="l16.87"> function attachURL() {</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineminus">-    var promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l16.89"></a><span id="l16.89" class="difflineminus">-                       .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l16.90"></a><span id="l16.90" class="difflineminus">-    if (promptService) {</span>
<a href="#l16.91"></a><span id="l16.91" class="difflineplus">+    if (Services.prompt) {</span>
<a href="#l16.92"></a><span id="l16.92">         // ghost in an example...</span>
<a href="#l16.93"></a><span id="l16.93">         var result = { value: &quot;http://&quot; };</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineminus">-        if (promptService.prompt(window,</span>
<a href="#l16.95"></a><span id="l16.95" class="difflineminus">-                                 calGetString(&quot;calendar-event-dialog&quot;,</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineminus">-                                              &quot;specifyLinkLocation&quot;),</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineminus">-                                 calGetString(&quot;calendar-event-dialog&quot;,</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineminus">-                                              &quot;enterLinkLocation&quot;),</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineminus">-                                 result,</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineminus">-                                 null,</span>
<a href="#l16.101"></a><span id="l16.101" class="difflineminus">-                                 { value: 0 })) {</span>
<a href="#l16.102"></a><span id="l16.102" class="difflineplus">+        if (Services.prompt.prompt(window,</span>
<a href="#l16.103"></a><span id="l16.103" class="difflineplus">+                                   calGetString(&quot;calendar-event-dialog&quot;,</span>
<a href="#l16.104"></a><span id="l16.104" class="difflineplus">+                                                &quot;specifyLinkLocation&quot;),</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineplus">+                                   calGetString(&quot;calendar-event-dialog&quot;,</span>
<a href="#l16.106"></a><span id="l16.106" class="difflineplus">+                                                &quot;enterLinkLocation&quot;),</span>
<a href="#l16.107"></a><span id="l16.107" class="difflineplus">+                                   result,</span>
<a href="#l16.108"></a><span id="l16.108" class="difflineplus">+                                   null,</span>
<a href="#l16.109"></a><span id="l16.109" class="difflineplus">+                                   { value: 0 })) {</span>
<a href="#l16.110"></a><span id="l16.110"> </span>
<a href="#l16.111"></a><span id="l16.111">             try {</span>
<a href="#l16.112"></a><span id="l16.112">                 // If something bogus was entered, makeURL may fail.</span>
<a href="#l16.113"></a><span id="l16.113">                 var attachment = createAttachment();</span>
<a href="#l16.114"></a><span id="l16.114">                 attachment.uri = makeURL(result.value);</span>
<a href="#l16.115"></a><span id="l16.115">                 addAttachment(attachment);</span>
<a href="#l16.116"></a><span id="l16.116">             } catch (e) {</span>
<a href="#l16.117"></a><span id="l16.117">                 // TODO We might want to show a warning instead of just not</span>
<a href="#l16.118"></a><span id="l16.118" class="difflineat">@@ -1948,25 +1943,23 @@ function deleteAttachment() {</span>
<a href="#l16.119"></a><span id="l16.119">  * Removes all attachments from the dialog controls.</span>
<a href="#l16.120"></a><span id="l16.120">  */</span>
<a href="#l16.121"></a><span id="l16.121"> function deleteAllAttachments() {</span>
<a href="#l16.122"></a><span id="l16.122">     var documentLink = document.getElementById(&quot;attachment-link&quot;);</span>
<a href="#l16.123"></a><span id="l16.123">     var itemCount = documentLink.getRowCount();</span>
<a href="#l16.124"></a><span id="l16.124">     var ok = (itemCount &lt; 2);</span>
<a href="#l16.125"></a><span id="l16.125"> </span>
<a href="#l16.126"></a><span id="l16.126">     if (itemCount &gt; 1) {</span>
<a href="#l16.127"></a><span id="l16.127" class="difflineminus">-        var promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l16.128"></a><span id="l16.128" class="difflineminus">-                                      .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l16.129"></a><span id="l16.129" class="difflineminus">-        ok = promptService.confirm(window,</span>
<a href="#l16.130"></a><span id="l16.130" class="difflineminus">-                                       calGetString(&quot;calendar-event-dialog&quot;,</span>
<a href="#l16.131"></a><span id="l16.131" class="difflineminus">-                                                    &quot;removeCalendarsTitle&quot;),</span>
<a href="#l16.132"></a><span id="l16.132" class="difflineminus">-                                       calGetString(&quot;calendar-event-dialog&quot;,</span>
<a href="#l16.133"></a><span id="l16.133" class="difflineminus">-                                                    &quot;removeCalendarsText&quot;,</span>
<a href="#l16.134"></a><span id="l16.134" class="difflineminus">-                                                    [itemCount]),</span>
<a href="#l16.135"></a><span id="l16.135" class="difflineminus">-                                       {});</span>
<a href="#l16.136"></a><span id="l16.136" class="difflineplus">+        ok = Services.prompt.confirm(window,</span>
<a href="#l16.137"></a><span id="l16.137" class="difflineplus">+                                     calGetString(&quot;calendar-event-dialog&quot;,</span>
<a href="#l16.138"></a><span id="l16.138" class="difflineplus">+                                                  &quot;removeCalendarsTitle&quot;),</span>
<a href="#l16.139"></a><span id="l16.139" class="difflineplus">+                                     calGetString(&quot;calendar-event-dialog&quot;,</span>
<a href="#l16.140"></a><span id="l16.140" class="difflineplus">+                                                  &quot;removeCalendarsText&quot;,</span>
<a href="#l16.141"></a><span id="l16.141" class="difflineplus">+                                                  [itemCount]),</span>
<a href="#l16.142"></a><span id="l16.142" class="difflineplus">+                                     {});</span>
<a href="#l16.143"></a><span id="l16.143">     }</span>
<a href="#l16.144"></a><span id="l16.144"> </span>
<a href="#l16.145"></a><span id="l16.145">     if (ok) {</span>
<a href="#l16.146"></a><span id="l16.146">         let child;</span>
<a href="#l16.147"></a><span id="l16.147">         let documentLink = document.getElementById(&quot;attachment-link&quot;);</span>
<a href="#l16.148"></a><span id="l16.148">         while (documentLink.hasChildNodes()) {</span>
<a href="#l16.149"></a><span id="l16.149">             child = documentLink.removeChild(documentLink.lastChild);</span>
<a href="#l16.150"></a><span id="l16.150">             child.attachment = null;</span>
<a href="#l16.151"></a><span id="l16.151" class="difflineat">@@ -2517,30 +2510,28 @@ function onCommandSave(aIsClosing) {</span>
<a href="#l16.152"></a><span id="l16.152"> /**</span>
<a href="#l16.153"></a><span id="l16.153">  * This function is called when the user chooses to delete an Item</span>
<a href="#l16.154"></a><span id="l16.154">  * from the Event/Task dialog</span>
<a href="#l16.155"></a><span id="l16.155">  *</span>
<a href="#l16.156"></a><span id="l16.156">  */</span>
<a href="#l16.157"></a><span id="l16.157"> function onCommandDeleteItem() {</span>
<a href="#l16.158"></a><span id="l16.158">     // only ask for confirmation, if the User changed anything on a new item or we modify an existing item</span>
<a href="#l16.159"></a><span id="l16.159">     if (isItemChanged() || window.mode != &quot;new&quot;) {</span>
<a href="#l16.160"></a><span id="l16.160" class="difflineminus">-        let promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l16.161"></a><span id="l16.161" class="difflineminus">-                                    .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l16.162"></a><span id="l16.162">         let promptTitle = &quot;&quot;;</span>
<a href="#l16.163"></a><span id="l16.163">         let promptMessage = &quot;&quot;;</span>
<a href="#l16.164"></a><span id="l16.164"> </span>
<a href="#l16.165"></a><span id="l16.165">         if (cal.isEvent(window.calendarItem)) {</span>
<a href="#l16.166"></a><span id="l16.166">             promptTitle = calGetString(&quot;calendar&quot;, &quot;deleteEventLabel&quot;);</span>
<a href="#l16.167"></a><span id="l16.167">             promptMessage = calGetString(&quot;calendar&quot;, &quot;deleteEventMessage&quot;);</span>
<a href="#l16.168"></a><span id="l16.168">         } else if (cal.isToDo(window.calendarItem)) {</span>
<a href="#l16.169"></a><span id="l16.169">             promptTitle = calGetString(&quot;calendar&quot;, &quot;deleteTaskLabel&quot;);</span>
<a href="#l16.170"></a><span id="l16.170">             promptMessage = calGetString(&quot;calendar&quot;, &quot;deleteTaskMessage&quot;);</span>
<a href="#l16.171"></a><span id="l16.171">         }</span>
<a href="#l16.172"></a><span id="l16.172"> </span>
<a href="#l16.173"></a><span id="l16.173" class="difflineminus">-        let answerDelete = promptService.confirm(</span>
<a href="#l16.174"></a><span id="l16.174" class="difflineplus">+        let answerDelete = Services.prompt.confirm(</span>
<a href="#l16.175"></a><span id="l16.175">                                     null,</span>
<a href="#l16.176"></a><span id="l16.176">                                     promptTitle,</span>
<a href="#l16.177"></a><span id="l16.177">                                     promptMessage);</span>
<a href="#l16.178"></a><span id="l16.178">         if (!answerDelete) {</span>
<a href="#l16.179"></a><span id="l16.179">             return;</span>
<a href="#l16.180"></a><span id="l16.180">         }</span>
<a href="#l16.181"></a><span id="l16.181">     }</span>
<a href="#l16.182"></a><span id="l16.182"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-migration-dialog.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-migration-dialog.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -1,35 +1,32 @@</span>
<a href="#l17.4"></a><span id="l17.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l17.5"></a><span id="l17.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l17.6"></a><span id="l17.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l17.7"></a><span id="l17.7"> </span>
<a href="#l17.8"></a><span id="l17.8"> const SUNBIRD_UID = &quot;{718e30fb-e89b-41dd-9da7-e25a45638b28}&quot;;</span>
<a href="#l17.9"></a><span id="l17.9"> const FIREFOX_UID = &quot;{ec8030f7-c20a-464f-9b0e-13a3a9e97384}&quot;;</span>
<a href="#l17.10"></a><span id="l17.10"> </span>
<a href="#l17.11"></a><span id="l17.11"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-Components.utils.import(&quot;resource:///modules/Services.jsm&quot;);</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l17.14"></a><span id="l17.14"> </span>
<a href="#l17.15"></a><span id="l17.15"> //</span>
<a href="#l17.16"></a><span id="l17.16"> // The front-end wizard bits.</span>
<a href="#l17.17"></a><span id="l17.17"> //</span>
<a href="#l17.18"></a><span id="l17.18"> var gMigrateWizard = {</span>
<a href="#l17.19"></a><span id="l17.19">     /**</span>
<a href="#l17.20"></a><span id="l17.20">      * Called from onload of the migrator window.  Takes all of the migrators</span>
<a href="#l17.21"></a><span id="l17.21">      * that were passed in via window.arguments and adds them to checklist. The</span>
<a href="#l17.22"></a><span id="l17.22">      * user can then check these off to migrate the data from those sources.</span>
<a href="#l17.23"></a><span id="l17.23">      */</span>
<a href="#l17.24"></a><span id="l17.24">     loadMigrators: function gmw_load() {</span>
<a href="#l17.25"></a><span id="l17.25">         var listbox = document.getElementById(&quot;datasource-list&quot;);</span>
<a href="#l17.26"></a><span id="l17.26"> </span>
<a href="#l17.27"></a><span id="l17.27">         //XXX Once we have branding for lightning, this hack can go away</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineminus">-        var sbs = Components.classes[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineminus">-                  .getService(Components.interfaces.nsIStringBundleService);</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineminus">-</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineminus">-        var props = sbs.createBundle(&quot;chrome://calendar/locale/migration.properties&quot;);</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+        var props = Services.strings.createBundle(&quot;chrome://calendar/locale/migration.properties&quot;);</span>
<a href="#l17.33"></a><span id="l17.33"> </span>
<a href="#l17.34"></a><span id="l17.34">         if (!cal.isSunbird()) {</span>
<a href="#l17.35"></a><span id="l17.35">             var wizard = document.getElementById(&quot;migration-wizard&quot;);</span>
<a href="#l17.36"></a><span id="l17.36">             var desc = document.getElementById(&quot;wizard-desc&quot;);</span>
<a href="#l17.37"></a><span id="l17.37">             // Since we don't translate &quot;Lightning&quot;...</span>
<a href="#l17.38"></a><span id="l17.38">             wizard.title = props.formatStringFromName(&quot;migrationTitle&quot;,</span>
<a href="#l17.39"></a><span id="l17.39">                                                       [&quot;Lightning&quot;],</span>
<a href="#l17.40"></a><span id="l17.40">                                                       1);</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineat">@@ -73,19 +70,17 @@ var gMigrateWizard = {</span>
<a href="#l17.42"></a><span id="l17.42">         // Don't let the user get away while we're migrating</span>
<a href="#l17.43"></a><span id="l17.43">         //XXX may want to wire this into the 'cancel' function once that's</span>
<a href="#l17.44"></a><span id="l17.44">         //    written</span>
<a href="#l17.45"></a><span id="l17.45">         var wizard = document.getElementById(&quot;migration-wizard&quot;);</span>
<a href="#l17.46"></a><span id="l17.46">         wizard.canAdvance = false;</span>
<a href="#l17.47"></a><span id="l17.47">         wizard.canRewind = false;</span>
<a href="#l17.48"></a><span id="l17.48"> </span>
<a href="#l17.49"></a><span id="l17.49">         // We're going to need this for the progress meter's description</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineminus">-        var sbs = Components.classes[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineminus">-                  .getService(Components.interfaces.nsIStringBundleService);</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineminus">-        var props = sbs.createBundle(&quot;chrome://calendar/locale/migration.properties&quot;);</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineplus">+        var props = Services.strings.createBundle(&quot;chrome://calendar/locale/migration.properties&quot;);</span>
<a href="#l17.54"></a><span id="l17.54">         var label = document.getElementById(&quot;progress-label&quot;);</span>
<a href="#l17.55"></a><span id="l17.55">         var meter = document.getElementById(&quot;migrate-progressmeter&quot;);</span>
<a href="#l17.56"></a><span id="l17.56"> </span>
<a href="#l17.57"></a><span id="l17.57">         var i = 0;</span>
<a href="#l17.58"></a><span id="l17.58">         // Because some of our migrators involve async code, we need this</span>
<a href="#l17.59"></a><span id="l17.59">         // call-back function so we know when to start the next migrator.</span>
<a href="#l17.60"></a><span id="l17.60">         function getNextMigrator() {</span>
<a href="#l17.61"></a><span id="l17.61">             if (migrators[i]) {</span>
<a href="#l17.62"></a><span id="l17.62" class="difflineat">@@ -153,42 +148,37 @@ var gDataMigrator = {</span>
<a href="#l17.63"></a><span id="l17.63">     mDirService: null,</span>
<a href="#l17.64"></a><span id="l17.64">     mIoService: null,</span>
<a href="#l17.65"></a><span id="l17.65"> </span>
<a href="#l17.66"></a><span id="l17.66">     /**</span>
<a href="#l17.67"></a><span id="l17.67">      * Cached getter for the directory service.</span>
<a href="#l17.68"></a><span id="l17.68">      */</span>
<a href="#l17.69"></a><span id="l17.69">     get dirService() {</span>
<a href="#l17.70"></a><span id="l17.70">         if (!this.mDirService) {</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineminus">-            this.mDirService = Components.classes[&quot;@mozilla.org/file/directory_service;1&quot;]</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineminus">-                               .getService(Components.interfaces.nsIProperties);</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineplus">+            this.mDirService = Service.dirsvc;</span>
<a href="#l17.74"></a><span id="l17.74">         }</span>
<a href="#l17.75"></a><span id="l17.75">         return this.mDirService;</span>
<a href="#l17.76"></a><span id="l17.76">     },</span>
<a href="#l17.77"></a><span id="l17.77"> </span>
<a href="#l17.78"></a><span id="l17.78">     /**</span>
<a href="#l17.79"></a><span id="l17.79">      * Call to do a general data migration (for a clean profile)  Will run</span>
<a href="#l17.80"></a><span id="l17.80">      * through all of the known migrator-checkers.  These checkers will return</span>
<a href="#l17.81"></a><span id="l17.81">      * an array of valid dataMigrator objects, for each kind of data they find.</span>
<a href="#l17.82"></a><span id="l17.82">      * If there is at least one valid migrator, we'll pop open the migration</span>
<a href="#l17.83"></a><span id="l17.83">      * wizard, otherwise, we'll return silently.</span>
<a href="#l17.84"></a><span id="l17.84">      */</span>
<a href="#l17.85"></a><span id="l17.85">     checkAndMigrate: function gdm_migrate() {</span>
<a href="#l17.86"></a><span id="l17.86" class="difflineminus">-        var appInfo = Components.classes[&quot;@mozilla.org/xre/app-info;1&quot;]</span>
<a href="#l17.87"></a><span id="l17.87" class="difflineminus">-                      .getService(Components.interfaces.nsIXULAppInfo);</span>
<a href="#l17.88"></a><span id="l17.88" class="difflineminus">-        if (appInfo.ID == FIREFOX_UID) {</span>
<a href="#l17.89"></a><span id="l17.89" class="difflineplus">+        if (Services.appinfo.ID == FIREFOX_UID) {</span>
<a href="#l17.90"></a><span id="l17.90">             this.mIsInFirefox = true;</span>
<a href="#l17.91"></a><span id="l17.91">             // We can't handle Firefox Lightning yet</span>
<a href="#l17.92"></a><span id="l17.92">             migLOG(&quot;Holy cow, you're Firefox-Lightning! sorry, can't help.&quot;);</span>
<a href="#l17.93"></a><span id="l17.93">             return;</span>
<a href="#l17.94"></a><span id="l17.94">         }</span>
<a href="#l17.95"></a><span id="l17.95"> </span>
<a href="#l17.96"></a><span id="l17.96" class="difflineminus">-        var xulRuntime = Components.classes[&quot;@mozilla.org/xre/app-info;1&quot;]</span>
<a href="#l17.97"></a><span id="l17.97" class="difflineminus">-                         .getService(Components.interfaces.nsIXULRuntime);</span>
<a href="#l17.98"></a><span id="l17.98" class="difflineminus">-        this.mPlatform = xulRuntime.OS.toLowerCase();</span>
<a href="#l17.99"></a><span id="l17.99" class="difflineplus">+        this.mPlatform = Services.appinfo.OS.toLowerCase();</span>
<a href="#l17.100"></a><span id="l17.100"> </span>
<a href="#l17.101"></a><span id="l17.101">         migLOG(&quot;mPlatform is: &quot; + this.mPlatform);</span>
<a href="#l17.102"></a><span id="l17.102"> </span>
<a href="#l17.103"></a><span id="l17.103">         var DMs = [];</span>
<a href="#l17.104"></a><span id="l17.104">         var migrators = [this.checkOldCal,</span>
<a href="#l17.105"></a><span id="l17.105">                          this.checkEvolution,</span>
<a href="#l17.106"></a><span id="l17.106">                          this.checkWindowsMail,</span>
<a href="#l17.107"></a><span id="l17.107">                          this.checkIcal];</span>
<a href="#l17.108"></a><span id="l17.108" class="difflineat">@@ -203,19 +193,17 @@ var gDataMigrator = {</span>
<a href="#l17.109"></a><span id="l17.109">         if (DMs.length == 0) {</span>
<a href="#l17.110"></a><span id="l17.110">             // No migration available</span>
<a href="#l17.111"></a><span id="l17.111">             return;</span>
<a href="#l17.112"></a><span id="l17.112">         }</span>
<a href="#l17.113"></a><span id="l17.113">         migLOG(&quot;DMs: &quot; + DMs.length);</span>
<a href="#l17.114"></a><span id="l17.114"> </span>
<a href="#l17.115"></a><span id="l17.115">         var url = &quot;chrome://calendar/content/calendar-migration-dialog.xul&quot;;</span>
<a href="#l17.116"></a><span id="l17.116"> #ifdef XP_MACOSX</span>
<a href="#l17.117"></a><span id="l17.117" class="difflineminus">-        var wm = Components.classes[&quot;@mozilla.org/appshell/window-mediator;1&quot;]</span>
<a href="#l17.118"></a><span id="l17.118" class="difflineminus">-                           .getService(Components.interfaces.nsIWindowMediator);</span>
<a href="#l17.119"></a><span id="l17.119" class="difflineminus">-        var win = wm.getMostRecentWindow(&quot;Calendar:MigrationWizard&quot;);</span>
<a href="#l17.120"></a><span id="l17.120" class="difflineplus">+        var win = Services.wm.getMostRecentWindow(&quot;Calendar:MigrationWizard&quot;);</span>
<a href="#l17.121"></a><span id="l17.121">         if (win) {</span>
<a href="#l17.122"></a><span id="l17.122">             win.focus();</span>
<a href="#l17.123"></a><span id="l17.123">         } else {</span>
<a href="#l17.124"></a><span id="l17.124">             openDialog(url, &quot;migration&quot;, &quot;centerscreen,chrome,resizable=no,width=500,height=400&quot;, DMs);</span>
<a href="#l17.125"></a><span id="l17.125">         }</span>
<a href="#l17.126"></a><span id="l17.126"> #else</span>
<a href="#l17.127"></a><span id="l17.127">         openDialog(url, &quot;migration&quot;, &quot;modal,centerscreen,chrome,resizable=no,width=500,height=400&quot;, DMs);</span>
<a href="#l17.128"></a><span id="l17.128"> #endif</span>
<a href="#l17.129"></a><span id="l17.129" class="difflineat">@@ -404,17 +392,17 @@ var gDataMigrator = {</span>
<a href="#l17.130"></a><span id="l17.130">                     var sub = str.substring(index, endIndex);</span>
<a href="#l17.131"></a><span id="l17.131">                     str = str.replace(sub, &quot;&quot;, &quot;g&quot;);</span>
<a href="#l17.132"></a><span id="l17.132">                     index = str.indexOf(&quot;;TZID=&quot;);</span>
<a href="#l17.133"></a><span id="l17.133">                 }</span>
<a href="#l17.134"></a><span id="l17.134">                 var tempFile = gDataMigrator.dirService.get(&quot;TmpD&quot;, Components.interfaces.nsIFile);</span>
<a href="#l17.135"></a><span id="l17.135">                 tempFile.append(&quot;icalTemp.ics&quot;);</span>
<a href="#l17.136"></a><span id="l17.136">                 tempFile.createUnique(Components.interfaces.nsIFile.NORMAL_FILE_TYPE,</span>
<a href="#l17.137"></a><span id="l17.137">                                       parseInt(&quot;0600&quot;, 8));</span>
<a href="#l17.138"></a><span id="l17.138" class="difflineminus">-                var tempUri = cal.getIOService().newFileURI(tempFile);</span>
<a href="#l17.139"></a><span id="l17.139" class="difflineplus">+                var tempUri = Services.io.newFileURI(tempFile);</span>
<a href="#l17.140"></a><span id="l17.140"> </span>
<a href="#l17.141"></a><span id="l17.141">                 var stream = Components.classes[&quot;@mozilla.org/network/file-output-stream;1&quot;]</span>
<a href="#l17.142"></a><span id="l17.142">                              .createInstance(Components.interfaces.nsIFileOutputStream);</span>
<a href="#l17.143"></a><span id="l17.143">                 stream.init(tempFile, 0x2A, parseInt(&quot;0600&quot;, 8), 0);</span>
<a href="#l17.144"></a><span id="l17.144">                 var convStream = Components.classes[&quot;@mozilla.org/intl/converter-output-stream;1&quot;]</span>
<a href="#l17.145"></a><span id="l17.145">                                 .createInstance(Components.interfaces.nsIConverterOutputStream);</span>
<a href="#l17.146"></a><span id="l17.146">                 convStream.init(stream, 'UTF-8', 0, 0x0000);</span>
<a href="#l17.147"></a><span id="l17.147">                 convStream.writeString(str);</span>
<a href="#l17.148"></a><span id="l17.148" class="difflineat">@@ -721,13 +709,11 @@ var gDataMigrator = {</span>
<a href="#l17.149"></a><span id="l17.149">  * XXX Use log4moz instead.</span>
<a href="#l17.150"></a><span id="l17.150">  *</span>
<a href="#l17.151"></a><span id="l17.151">  * @param aString   The string to log</span>
<a href="#l17.152"></a><span id="l17.152">  */</span>
<a href="#l17.153"></a><span id="l17.153"> function migLOG(aString) {</span>
<a href="#l17.154"></a><span id="l17.154">     if (!getPrefSafe(&quot;calendar.migration.log&quot;, false)) {</span>
<a href="#l17.155"></a><span id="l17.155">         return;</span>
<a href="#l17.156"></a><span id="l17.156">     }</span>
<a href="#l17.157"></a><span id="l17.157" class="difflineminus">-    var consoleService = Components.classes[&quot;@mozilla.org/consoleservice;1&quot;]</span>
<a href="#l17.158"></a><span id="l17.158" class="difflineminus">-                         .getService(Components.interfaces.nsIConsoleService);</span>
<a href="#l17.159"></a><span id="l17.159" class="difflineminus">-    consoleService.logStringMessage(aString);</span>
<a href="#l17.160"></a><span id="l17.160" class="difflineplus">+    Services.console.logStringMessage(aString);</span>
<a href="#l17.161"></a><span id="l17.161">     dump(aString+&quot;\n&quot;);</span>
<a href="#l17.162"></a><span id="l17.162"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/calendar/base/content/preferences/advanced.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/calendar/base/content/preferences/advanced.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -1,14 +1,16 @@</span>
<a href="#l18.4"></a><span id="l18.4"> /**</span>
<a href="#l18.5"></a><span id="l18.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l18.6"></a><span id="l18.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l18.7"></a><span id="l18.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l18.8"></a><span id="l18.8">  */</span>
<a href="#l18.9"></a><span id="l18.9"> </span>
<a href="#l18.10"></a><span id="l18.10" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l18.11"></a><span id="l18.11" class="difflineplus">+</span>
<a href="#l18.12"></a><span id="l18.12"> /**</span>
<a href="#l18.13"></a><span id="l18.13">  * Global Object to hold methods for the advanced pref pane</span>
<a href="#l18.14"></a><span id="l18.14">  */</span>
<a href="#l18.15"></a><span id="l18.15"> var gAdvancedPane = {</span>
<a href="#l18.16"></a><span id="l18.16">     _inited: false,</span>
<a href="#l18.17"></a><span id="l18.17">     /**</span>
<a href="#l18.18"></a><span id="l18.18">      * Initialize the advanced pref pane. Sets up dialog controls to match the</span>
<a href="#l18.19"></a><span id="l18.19">      * values set in prefs.</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineat">@@ -137,21 +139,19 @@ var gAdvancedPane = {</span>
<a href="#l18.21"></a><span id="l18.21">     /**</span>
<a href="#l18.22"></a><span id="l18.22">      * Displays the &quot;Remove Master Password&quot; dialog to allow the user to</span>
<a href="#l18.23"></a><span id="l18.23">      * remove the current Master Password.  When the dialog is dismissed,</span>
<a href="#l18.24"></a><span id="l18.24">      * the Master Password UI is automatically updated.</span>
<a href="#l18.25"></a><span id="l18.25">      */</span>
<a href="#l18.26"></a><span id="l18.26">     _removeMasterPassword: function advRemoveMasterPassword() {</span>
<a href="#l18.27"></a><span id="l18.27">         if (this._secModDb.isFIPSEnabled) {</span>
<a href="#l18.28"></a><span id="l18.28">             var bundle = document.getElementById(&quot;bundleCalendarPreferences&quot;);</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineminus">-            var promptSvc = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineminus">-                                      .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineminus">-            promptSvc.alert(window,</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineminus">-                            bundle.getString(&quot;pw_change_failed_title&quot;),</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineminus">-                            bundle.getString(&quot;pw_change2empty_in_fips_mode&quot;));</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineplus">+            Services.prompt.alert(window,</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineplus">+                                  bundle.getString(&quot;pw_change_failed_title&quot;),</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineplus">+                                  bundle.getString(&quot;pw_change2empty_in_fips_mode&quot;));</span>
<a href="#l18.37"></a><span id="l18.37">         } else {</span>
<a href="#l18.38"></a><span id="l18.38">             var url = &quot;chrome://mozapps/content/preferences/removemp.xul&quot;;</span>
<a href="#l18.39"></a><span id="l18.39">             document.documentElement.openSubDialog(url, &quot;&quot;, null);</span>
<a href="#l18.40"></a><span id="l18.40"> </span>
<a href="#l18.41"></a><span id="l18.41">         }</span>
<a href="#l18.42"></a><span id="l18.42">         this._initMasterPasswordUI();</span>
<a href="#l18.43"></a><span id="l18.43">     },</span>
<a href="#l18.44"></a><span id="l18.44"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/calendar/base/content/preferences/alarms.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/calendar/base/content/preferences/alarms.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -1,14 +1,15 @@</span>
<a href="#l19.4"></a><span id="l19.4"> /**</span>
<a href="#l19.5"></a><span id="l19.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l19.6"></a><span id="l19.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l19.7"></a><span id="l19.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l19.8"></a><span id="l19.8">  */</span>
<a href="#l19.9"></a><span id="l19.9"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l19.10"></a><span id="l19.10" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l19.11"></a><span id="l19.11"> </span>
<a href="#l19.12"></a><span id="l19.12"> /**</span>
<a href="#l19.13"></a><span id="l19.13">  * Global Object to hold methods for the alarms pref pane</span>
<a href="#l19.14"></a><span id="l19.14">  */</span>
<a href="#l19.15"></a><span id="l19.15"> var gAlarmsPane = {</span>
<a href="#l19.16"></a><span id="l19.16">     /**</span>
<a href="#l19.17"></a><span id="l19.17">      * Initialize the alarms pref pane. Sets up dialog controls to match the</span>
<a href="#l19.18"></a><span id="l19.18">      * values set in prefs.</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineat">@@ -68,17 +69,17 @@ var gAlarmsPane = {</span>
<a href="#l19.20"></a><span id="l19.20">      * Converts the given file url to a nsILocalFile</span>
<a href="#l19.21"></a><span id="l19.21">      *</span>
<a href="#l19.22"></a><span id="l19.22">      * @param aFileURL    A string with a file:// url.</span>
<a href="#l19.23"></a><span id="l19.23">      * @return            The corresponding nsILocalFile.</span>
<a href="#l19.24"></a><span id="l19.24">      */</span>
<a href="#l19.25"></a><span id="l19.25">     convertURLToLocalFile: function gAP_convertURLToLocalFile(aFileURL) {</span>
<a href="#l19.26"></a><span id="l19.26">         // Convert the file url into a nsILocalFile</span>
<a href="#l19.27"></a><span id="l19.27">         if (aFileURL) {</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineminus">-            var fph = cal.getIOService()</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineplus">+            var fph = Services.io</span>
<a href="#l19.30"></a><span id="l19.30">                          .getProtocolHandler(&quot;file&quot;)</span>
<a href="#l19.31"></a><span id="l19.31">                          .QueryInterface(Components.interfaces.nsIFileProtocolHandler);</span>
<a href="#l19.32"></a><span id="l19.32">             return fph.getFileFromURLSpec(aFileURL);</span>
<a href="#l19.33"></a><span id="l19.33">         } else {</span>
<a href="#l19.34"></a><span id="l19.34">             return null;</span>
<a href="#l19.35"></a><span id="l19.35">         }</span>
<a href="#l19.36"></a><span id="l19.36">     },</span>
<a href="#l19.37"></a><span id="l19.37"> </span>
<a href="#l19.38"></a><span id="l19.38" class="difflineat">@@ -136,22 +137,21 @@ var gAlarmsPane = {</span>
<a href="#l19.39"></a><span id="l19.39"> </span>
<a href="#l19.40"></a><span id="l19.40">     /**</span>
<a href="#l19.41"></a><span id="l19.41">      * Plays the alarm sound currently selected.</span>
<a href="#l19.42"></a><span id="l19.42">      */</span>
<a href="#l19.43"></a><span id="l19.43">     previewAlarm: function gAP_previewAlarm() {</span>
<a href="#l19.44"></a><span id="l19.44">         var soundUrl = document.getElementById(&quot;alarmSoundFileField&quot;).value;</span>
<a href="#l19.45"></a><span id="l19.45">         var soundIfc = Components.classes[&quot;@mozilla.org/sound;1&quot;]</span>
<a href="#l19.46"></a><span id="l19.46">                             .createInstance(Components.interfaces.nsISound);</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineminus">-        var ios = cal.getIOService();</span>
<a href="#l19.48"></a><span id="l19.48">         var url;</span>
<a href="#l19.49"></a><span id="l19.49">         try {</span>
<a href="#l19.50"></a><span id="l19.50">             soundIfc.init();</span>
<a href="#l19.51"></a><span id="l19.51">             if (soundUrl &amp;&amp; soundUrl.length &amp;&amp; soundUrl.length &gt; 0) {</span>
<a href="#l19.52"></a><span id="l19.52" class="difflineminus">-                url = ios.newURI(soundUrl, null, null);</span>
<a href="#l19.53"></a><span id="l19.53" class="difflineplus">+                url = Services.io.newURI(soundUrl, null, null);</span>
<a href="#l19.54"></a><span id="l19.54">                 soundIfc.play(url);</span>
<a href="#l19.55"></a><span id="l19.55">             } else {</span>
<a href="#l19.56"></a><span id="l19.56">                 soundIfc.beep();</span>
<a href="#l19.57"></a><span id="l19.57">             }</span>
<a href="#l19.58"></a><span id="l19.58">         } catch (ex) {</span>
<a href="#l19.59"></a><span id="l19.59">             dump(&quot;alarms.js previewAlarm Exception caught! &quot; + ex + &quot;\n&quot;);</span>
<a href="#l19.60"></a><span id="l19.60">         }</span>
<a href="#l19.61"></a><span id="l19.61">     },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/calendar/base/content/preferences/categories.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/calendar/base/content/preferences/categories.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -1,19 +1,18 @@</span>
<a href="#l20.4"></a><span id="l20.4"> /**</span>
<a href="#l20.5"></a><span id="l20.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l20.6"></a><span id="l20.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l20.7"></a><span id="l20.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l20.8"></a><span id="l20.8">  */</span>
<a href="#l20.9"></a><span id="l20.9"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l20.10"></a><span id="l20.10" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l20.11"></a><span id="l20.11"> </span>
<a href="#l20.12"></a><span id="l20.12"> var gCategoryList;</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-var prefService = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineminus">-                    .getService(Components.interfaces.nsIPrefService);</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineminus">-var categoryPrefBranch = prefService.getBranch(&quot;calendar.category.color.&quot;);</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineplus">+var categoryPrefBranch = Services.prefs.getBranch(&quot;calendar.category.color.&quot;);</span>
<a href="#l20.17"></a><span id="l20.17"> </span>
<a href="#l20.18"></a><span id="l20.18"> /**</span>
<a href="#l20.19"></a><span id="l20.19">  * Global Object to hold methods for the categories pref pane</span>
<a href="#l20.20"></a><span id="l20.20">  */</span>
<a href="#l20.21"></a><span id="l20.21"> var gCategoriesPane = {</span>
<a href="#l20.22"></a><span id="l20.22"> </span>
<a href="#l20.23"></a><span id="l20.23">     /**</span>
<a href="#l20.24"></a><span id="l20.24">      * Initialize the categories pref pane. Sets up dialog controls to show the</span>
<a href="#l20.25"></a><span id="l20.25" class="difflineat">@@ -173,36 +172,33 @@ var gCategoriesPane = {</span>
<a href="#l20.26"></a><span id="l20.26">      *</span>
<a href="#l20.27"></a><span id="l20.27">      * @param categoryName      The name of the category.</span>
<a href="#l20.28"></a><span id="l20.28">      * @param categoryColor     The color of the category</span>
<a href="#l20.29"></a><span id="l20.29">      */</span>
<a href="#l20.30"></a><span id="l20.30">     saveCategory: function gCP_saveCateogry(categoryName, categoryColor) {</span>
<a href="#l20.31"></a><span id="l20.31">         var list = document.getElementById(&quot;categorieslist&quot;);</span>
<a href="#l20.32"></a><span id="l20.32">         // Check to make sure another category doesn't have the same name</span>
<a href="#l20.33"></a><span id="l20.33">         var toBeDeleted = -1;</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineminus">-        var promptService = </span>
<a href="#l20.35"></a><span id="l20.35" class="difflineminus">-             Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineminus">-                       .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l20.37"></a><span id="l20.37">         for (var i=0; i &lt; gCategoryList.length; i++) {</span>
<a href="#l20.38"></a><span id="l20.38">             if (i == list.selectedIndex)</span>
<a href="#l20.39"></a><span id="l20.39">                 continue;</span>
<a href="#l20.40"></a><span id="l20.40">             if (categoryName.toLowerCase() == gCategoryList[i].toLowerCase()) {</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineminus">-                if (promptService.confirm(null, overwriteTitle, overwrite)) {</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineplus">+                if (Services.prompt.confirm(null, overwriteTitle, overwrite)) {</span>
<a href="#l20.43"></a><span id="l20.43">                     if (list.selectedIndex != -1)</span>
<a href="#l20.44"></a><span id="l20.44">                         // Don't delete the old category yet. It will mess up indices.</span>
<a href="#l20.45"></a><span id="l20.45">                         toBeDeleted = list.selectedIndex;</span>
<a href="#l20.46"></a><span id="l20.46">                     list.selectedIndex = i;</span>
<a href="#l20.47"></a><span id="l20.47">                 } else {</span>
<a href="#l20.48"></a><span id="l20.48">                     return;</span>
<a href="#l20.49"></a><span id="l20.49">                 }</span>
<a href="#l20.50"></a><span id="l20.50">             }</span>
<a href="#l20.51"></a><span id="l20.51">         }</span>
<a href="#l20.52"></a><span id="l20.52"> </span>
<a href="#l20.53"></a><span id="l20.53">         if (categoryName.length == 0) {</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineminus">-            promptService.alert(null, null, noBlankCategories);</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineplus">+            Services.prompt.alert(null, null, noBlankCategories);</span>
<a href="#l20.56"></a><span id="l20.56">             return;</span>
<a href="#l20.57"></a><span id="l20.57">         }</span>
<a href="#l20.58"></a><span id="l20.58"> </span>
<a href="#l20.59"></a><span id="l20.59">         var categoryNameFix = formatStringForCSSRule(categoryName);</span>
<a href="#l20.60"></a><span id="l20.60">         if (list.selectedIndex == -1) {</span>
<a href="#l20.61"></a><span id="l20.61">             this.backupData(categoryNameFix);</span>
<a href="#l20.62"></a><span id="l20.62">             gCategoryList.push(categoryName);</span>
<a href="#l20.63"></a><span id="l20.63">             if (categoryColor)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/calendar/base/content/preferences/connection.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/calendar/base/content/preferences/connection.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -1,15 +1,18 @@</span>
<a href="#l21.4"></a><span id="l21.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l21.5"></a><span id="l21.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l21.6"></a><span id="l21.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l21.7"></a><span id="l21.7"> </span>
<a href="#l21.8"></a><span id="l21.8"> /**</span>
<a href="#l21.9"></a><span id="l21.9">  * Global Object to hold methods for the connections dialog.</span>
<a href="#l21.10"></a><span id="l21.10">  */</span>
<a href="#l21.11"></a><span id="l21.11" class="difflineplus">+</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+</span>
<a href="#l21.14"></a><span id="l21.14"> var gConnectionsDialog = {</span>
<a href="#l21.15"></a><span id="l21.15">   /**</span>
<a href="#l21.16"></a><span id="l21.16">    * Handler function to be called before the pref window is closed (i.e</span>
<a href="#l21.17"></a><span id="l21.17">    * onbeforeaccept attribute).</span>
<a href="#l21.18"></a><span id="l21.18">    */</span>
<a href="#l21.19"></a><span id="l21.19">   beforeAccept: function gCD_beforeAccept() {</span>
<a href="#l21.20"></a><span id="l21.20">     var proxyTypePref = document.getElementById(&quot;network.proxy.type&quot;);</span>
<a href="#l21.21"></a><span id="l21.21">     if (proxyTypePref.value == 2) {</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineat">@@ -80,21 +83,18 @@ var gConnectionsDialog = {</span>
<a href="#l21.23"></a><span id="l21.23">    * if the current value of the PAC textbox does not match the value stored</span>
<a href="#l21.24"></a><span id="l21.24">    * in prefs.  Likewise, disable the reload button if PAC is not configured</span>
<a href="#l21.25"></a><span id="l21.25">    * in prefs.</span>
<a href="#l21.26"></a><span id="l21.26">    */</span>
<a href="#l21.27"></a><span id="l21.27">   updateReloadButton: function gCD_updateReloadButton() {</span>
<a href="#l21.28"></a><span id="l21.28">     var typedURL = document.getElementById(&quot;networkProxyAutoconfigURL&quot;).value;</span>
<a href="#l21.29"></a><span id="l21.29">     var proxyTypeCur = document.getElementById(&quot;network.proxy.type&quot;).value;</span>
<a href="#l21.30"></a><span id="l21.30"> </span>
<a href="#l21.31"></a><span id="l21.31" class="difflineminus">-    var prefs =</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineminus">-        Components.classes[&quot;@mozilla.org/preferences-service;1&quot;].</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineminus">-        getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineminus">-    var pacURL = prefs.getCharPref(&quot;network.proxy.autoconfig_url&quot;);</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineminus">-    var proxyType = prefs.getIntPref(&quot;network.proxy.type&quot;);</span>
<a href="#l21.36"></a><span id="l21.36" class="difflineplus">+    var pacURL = Services.prefs.getCharPref(&quot;network.proxy.autoconfig_url&quot;);</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineplus">+    var proxyType = Services.prefs.getIntPref(&quot;network.proxy.type&quot;);</span>
<a href="#l21.38"></a><span id="l21.38"> </span>
<a href="#l21.39"></a><span id="l21.39">     var disableReloadPref =</span>
<a href="#l21.40"></a><span id="l21.40">         document.getElementById(&quot;pref.advanced.proxies.disable_button.reload&quot;);</span>
<a href="#l21.41"></a><span id="l21.41">     disableReloadPref.disabled =</span>
<a href="#l21.42"></a><span id="l21.42">         (proxyTypeCur != 2 || proxyType != 2 || typedURL != pacURL);</span>
<a href="#l21.43"></a><span id="l21.43">   },</span>
<a href="#l21.44"></a><span id="l21.44"> </span>
<a href="#l21.45"></a><span id="l21.45">   /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/calendar/base/content/widgets/minimonth.xml</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/calendar/base/content/widgets/minimonth.xml</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -404,44 +404,44 @@</span>
<a href="#l22.4"></a><span id="l22.4">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l22.5"></a><span id="l22.5">       &lt;/property&gt;</span>
<a href="#l22.6"></a><span id="l22.6">       &lt;field name=&quot;mDaymap&quot;&gt;null&lt;/field&gt;</span>
<a href="#l22.7"></a><span id="l22.7">       &lt;field name=&quot;mValue&quot;&gt;null&lt;/field&gt;</span>
<a href="#l22.8"></a><span id="l22.8">       &lt;field name=&quot;mEditorDate&quot;&gt;null&lt;/field&gt;</span>
<a href="#l22.9"></a><span id="l22.9">       &lt;field name=&quot;mIsReadOnly&quot;&gt;false&lt;/field&gt;</span>
<a href="#l22.10"></a><span id="l22.10">       &lt;field name=&quot;mObservesComposite&quot;&gt;false&lt;/field&gt;</span>
<a href="#l22.11"></a><span id="l22.11">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineplus">+          Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+</span>
<a href="#l22.14"></a><span id="l22.14">           this.mToday = false;</span>
<a href="#l22.15"></a><span id="l22.15">           this.mSelected = false;</span>
<a href="#l22.16"></a><span id="l22.16">           this.mValue = new Date() // Default to &quot;today&quot;</span>
<a href="#l22.17"></a><span id="l22.17">           // save references for convenience</span>
<a href="#l22.18"></a><span id="l22.18">           if (this.hasAttribute(&quot;readonly&quot;)) {</span>
<a href="#l22.19"></a><span id="l22.19">               this.mIsReadOnly = this.getAttribute(&quot;readonly&quot;) == &quot;true&quot;;</span>
<a href="#l22.20"></a><span id="l22.20">           }</span>
<a href="#l22.21"></a><span id="l22.21">           this.refreshDisplay( );</span>
<a href="#l22.22"></a><span id="l22.22">           if (this.hasAttribute(&quot;freebusy&quot;)) {</span>
<a href="#l22.23"></a><span id="l22.23">               this._setFreeBusy(this.getAttribute(&quot;freebusy&quot;) == &quot;true&quot;);</span>
<a href="#l22.24"></a><span id="l22.24">           }</span>
<a href="#l22.25"></a><span id="l22.25"> </span>
<a href="#l22.26"></a><span id="l22.26">           // Add pref observer for calendar.week.start</span>
<a href="#l22.27"></a><span id="l22.27" class="difflineminus">-          let prefService = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineminus">-                                      .getService(Components.interfaces.nsIPrefService);</span>
<a href="#l22.29"></a><span id="l22.29" class="difflineminus">-          let branch = prefService.getBranch(&quot;&quot;);</span>
<a href="#l22.30"></a><span id="l22.30" class="difflineplus">+          let branch = Services.prefs.getBranch(&quot;&quot;);</span>
<a href="#l22.31"></a><span id="l22.31">           branch.addObserver(&quot;calendar.week.start&quot;, this, false);</span>
<a href="#l22.32"></a><span id="l22.32">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l22.33"></a><span id="l22.33">       &lt;destructor&gt;&lt;![CDATA[</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineplus">+          Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l22.35"></a><span id="l22.35" class="difflineplus">+</span>
<a href="#l22.36"></a><span id="l22.36">           var composite = getCompositeCalendar();</span>
<a href="#l22.37"></a><span id="l22.37">           if (composite &amp;&amp; this.mObservesComposite == true) {</span>
<a href="#l22.38"></a><span id="l22.38">               getCompositeCalendar().removeObserver(this);</span>
<a href="#l22.39"></a><span id="l22.39">           }</span>
<a href="#l22.40"></a><span id="l22.40"> </span>
<a href="#l22.41"></a><span id="l22.41">           // Remove pref observer for calendar.week.start</span>
<a href="#l22.42"></a><span id="l22.42" class="difflineminus">-          let prefService = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l22.43"></a><span id="l22.43" class="difflineminus">-                                      .getService(Components.interfaces.nsIPrefService);</span>
<a href="#l22.44"></a><span id="l22.44" class="difflineminus">-          let branch = prefService.getBranch(&quot;&quot;);</span>
<a href="#l22.45"></a><span id="l22.45" class="difflineplus">+          let branch = Services.prefs.getBranch(&quot;&quot;);</span>
<a href="#l22.46"></a><span id="l22.46">           branch.removeObserver(&quot;calendar.week.start&quot;, this, false);</span>
<a href="#l22.47"></a><span id="l22.47">       ]]&gt;&lt;/destructor&gt;</span>
<a href="#l22.48"></a><span id="l22.48"> </span>
<a href="#l22.49"></a><span id="l22.49">      &lt;!-- calIOperationListener methods --&gt;</span>
<a href="#l22.50"></a><span id="l22.50">       &lt;method name=&quot;onOperationComplete&quot;&gt;</span>
<a href="#l22.51"></a><span id="l22.51">         &lt;parameter name=&quot;aCalendar&quot;/&gt;</span>
<a href="#l22.52"></a><span id="l22.52">         &lt;parameter name=&quot;aStatus&quot;/&gt;</span>
<a href="#l22.53"></a><span id="l22.53">         &lt;parameter name=&quot;aOperationType&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/calendar/base/modules/calAuthUtils.jsm</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/calendar/base/modules/calAuthUtils.jsm</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -1,13 +1,14 @@</span>
<a href="#l23.4"></a><span id="l23.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l23.5"></a><span id="l23.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l23.6"></a><span id="l23.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l23.7"></a><span id="l23.7"> </span>
<a href="#l23.8"></a><span id="l23.8"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l23.9"></a><span id="l23.9" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l23.10"></a><span id="l23.10"> </span>
<a href="#l23.11"></a><span id="l23.11"> /*</span>
<a href="#l23.12"></a><span id="l23.12">  * Authentication helper code</span>
<a href="#l23.13"></a><span id="l23.13">  */</span>
<a href="#l23.14"></a><span id="l23.14"> </span>
<a href="#l23.15"></a><span id="l23.15"> EXPORTED_SYMBOLS = [&quot;cal&quot;]; // even though it's defined in calUtils.jsm, import needs this</span>
<a href="#l23.16"></a><span id="l23.16"> cal.auth = {</span>
<a href="#l23.17"></a><span id="l23.17">     /**</span>
<a href="#l23.18"></a><span id="l23.18" class="difflineat">@@ -37,19 +38,17 @@ cal.auth = {</span>
<a href="#l23.19"></a><span id="l23.19">                                                aFixedUsername) {</span>
<a href="#l23.20"></a><span id="l23.20"> </span>
<a href="#l23.21"></a><span id="l23.21">         if (typeof aUsername != &quot;object&quot; ||</span>
<a href="#l23.22"></a><span id="l23.22">             typeof aPassword != &quot;object&quot; ||</span>
<a href="#l23.23"></a><span id="l23.23">             typeof aSavePassword != &quot;object&quot;) {</span>
<a href="#l23.24"></a><span id="l23.24">             throw new Components.Exception(&quot;&quot;, Components.results.NS_ERROR_XPC_NEED_OUT_OBJECT);</span>
<a href="#l23.25"></a><span id="l23.25">         }</span>
<a href="#l23.26"></a><span id="l23.26"> </span>
<a href="#l23.27"></a><span id="l23.27" class="difflineminus">-        let watcher = Components.classes[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l23.28"></a><span id="l23.28" class="difflineminus">-                                .getService(Components.interfaces.nsIWindowWatcher);</span>
<a href="#l23.29"></a><span id="l23.29" class="difflineminus">-        let prompter = watcher.getNewPrompter(null);</span>
<a href="#l23.30"></a><span id="l23.30" class="difflineplus">+        let prompter = Services.ww.getNewPrompter(null);</span>
<a href="#l23.31"></a><span id="l23.31"> </span>
<a href="#l23.32"></a><span id="l23.32">         // Only show the save password box if we are supposed to.</span>
<a href="#l23.33"></a><span id="l23.33">         let savepassword = null;</span>
<a href="#l23.34"></a><span id="l23.34">         if (cal.getPrefSafe(&quot;signon.rememberSignons&quot;, true)) {</span>
<a href="#l23.35"></a><span id="l23.35">             savepassword = cal.calGetString(&quot;passwordmgr&quot;, &quot;rememberPassword&quot;, null, &quot;passwordmgr&quot;);</span>
<a href="#l23.36"></a><span id="l23.36">         }</span>
<a href="#l23.37"></a><span id="l23.37"> </span>
<a href="#l23.38"></a><span id="l23.38">         let aText;</span>
<a href="#l23.39"></a><span id="l23.39" class="difflineat">@@ -79,27 +78,25 @@ cal.auth = {</span>
<a href="#l23.40"></a><span id="l23.40">      * @param aHostName     The corresponding hostname</span>
<a href="#l23.41"></a><span id="l23.41">      * @param aRealm        The password realm (unused on branch)</span>
<a href="#l23.42"></a><span id="l23.42">      */</span>
<a href="#l23.43"></a><span id="l23.43">     passwordManagerSave: function calPasswordManagerSave(aUsername, aPassword, aHostName, aRealm) {</span>
<a href="#l23.44"></a><span id="l23.44">         cal.ASSERT(aUsername);</span>
<a href="#l23.45"></a><span id="l23.45">         cal.ASSERT(aPassword);</span>
<a href="#l23.46"></a><span id="l23.46"> </span>
<a href="#l23.47"></a><span id="l23.47">         try {</span>
<a href="#l23.48"></a><span id="l23.48" class="difflineminus">-            let loginManager = Components.classes[&quot;@mozilla.org/login-manager;1&quot;]</span>
<a href="#l23.49"></a><span id="l23.49" class="difflineminus">-                                         .getService(Components.interfaces.nsILoginManager);</span>
<a href="#l23.50"></a><span id="l23.50" class="difflineminus">-            let logins = loginManager.findLogins({}, aHostName, null, aRealm);</span>
<a href="#l23.51"></a><span id="l23.51" class="difflineplus">+            let logins = Services.logins.findLogins({}, aHostName, null, aRealm);</span>
<a href="#l23.52"></a><span id="l23.52"> </span>
<a href="#l23.53"></a><span id="l23.53">             let newLoginInfo = Components.classes[&quot;@mozilla.org/login-manager/loginInfo;1&quot;]</span>
<a href="#l23.54"></a><span id="l23.54">                                          .createInstance(Components.interfaces.nsILoginInfo);</span>
<a href="#l23.55"></a><span id="l23.55">             newLoginInfo.init(aHostName, null, aRealm, aUsername, aPassword, &quot;&quot;, &quot;&quot;);</span>
<a href="#l23.56"></a><span id="l23.56">             if (logins.length &gt; 0) {</span>
<a href="#l23.57"></a><span id="l23.57" class="difflineminus">-                loginManager.modifyLogin(logins[0], newLoginInfo);</span>
<a href="#l23.58"></a><span id="l23.58" class="difflineplus">+                Services.logins.modifyLogin(logins[0], newLoginInfo);</span>
<a href="#l23.59"></a><span id="l23.59">             } else {</span>
<a href="#l23.60"></a><span id="l23.60" class="difflineminus">-                loginManager.addLogin(newLoginInfo);</span>
<a href="#l23.61"></a><span id="l23.61" class="difflineplus">+                Services.logins.addLogin(newLoginInfo);</span>
<a href="#l23.62"></a><span id="l23.62">             }</span>
<a href="#l23.63"></a><span id="l23.63">         } catch (exc) {</span>
<a href="#l23.64"></a><span id="l23.64">             cal.ASSERT(false, exc);</span>
<a href="#l23.65"></a><span id="l23.65">         }</span>
<a href="#l23.66"></a><span id="l23.66">     },</span>
<a href="#l23.67"></a><span id="l23.67"> </span>
<a href="#l23.68"></a><span id="l23.68">     /**</span>
<a href="#l23.69"></a><span id="l23.69">      * Helper to retrieve an entry from the password manager.</span>
<a href="#l23.70"></a><span id="l23.70" class="difflineat">@@ -113,23 +110,21 @@ cal.auth = {</span>
<a href="#l23.71"></a><span id="l23.71">     passwordManagerGet: function calPasswordManagerGet(aUsername, aPassword, aHostName, aRealm) {</span>
<a href="#l23.72"></a><span id="l23.72">         cal.ASSERT(aUsername);</span>
<a href="#l23.73"></a><span id="l23.73"> </span>
<a href="#l23.74"></a><span id="l23.74">         if (typeof aPassword != &quot;object&quot;) {</span>
<a href="#l23.75"></a><span id="l23.75">             throw new Components.Exception(&quot;&quot;, Components.results.NS_ERROR_XPC_NEED_OUT_OBJECT);</span>
<a href="#l23.76"></a><span id="l23.76">         }</span>
<a href="#l23.77"></a><span id="l23.77"> </span>
<a href="#l23.78"></a><span id="l23.78">         try {</span>
<a href="#l23.79"></a><span id="l23.79" class="difflineminus">-            let loginManager = Components.classes[&quot;@mozilla.org/login-manager;1&quot;]</span>
<a href="#l23.80"></a><span id="l23.80" class="difflineminus">-                                         .getService(Components.interfaces.nsILoginManager);</span>
<a href="#l23.81"></a><span id="l23.81" class="difflineminus">-            if (!loginManager.getLoginSavingEnabled(aUsername)) {</span>
<a href="#l23.82"></a><span id="l23.82" class="difflineplus">+            if (!Services.logins.getLoginSavingEnabled(aUsername)) {</span>
<a href="#l23.83"></a><span id="l23.83">                 return false;</span>
<a href="#l23.84"></a><span id="l23.84">             }</span>
<a href="#l23.85"></a><span id="l23.85"> </span>
<a href="#l23.86"></a><span id="l23.86" class="difflineminus">-            let logins = loginManager.findLogins({}, aHostName, null, aRealm);</span>
<a href="#l23.87"></a><span id="l23.87" class="difflineplus">+            let logins = Services.logins.findLogins({}, aHostName, null, aRealm);</span>
<a href="#l23.88"></a><span id="l23.88">             for each (let loginInfo in logins) {</span>
<a href="#l23.89"></a><span id="l23.89">                 if (loginInfo.username == aUsername) {</span>
<a href="#l23.90"></a><span id="l23.90">                     aPassword.value = loginInfo.password;</span>
<a href="#l23.91"></a><span id="l23.91">                     return true;</span>
<a href="#l23.92"></a><span id="l23.92">                 }</span>
<a href="#l23.93"></a><span id="l23.93">             }</span>
<a href="#l23.94"></a><span id="l23.94">         } catch (exc) {</span>
<a href="#l23.95"></a><span id="l23.95">             cal.ASSERT(false, exc);</span>
<a href="#l23.96"></a><span id="l23.96" class="difflineat">@@ -144,22 +139,20 @@ cal.auth = {</span>
<a href="#l23.97"></a><span id="l23.97">      * @param aHostName     The corresponding hostname</span>
<a href="#l23.98"></a><span id="l23.98">      * @param aRealm        The password realm (unused on branch)</span>
<a href="#l23.99"></a><span id="l23.99">      * @return              Could the user be removed?</span>
<a href="#l23.100"></a><span id="l23.100">      */</span>
<a href="#l23.101"></a><span id="l23.101">     passwordManagerRemove: function calPasswordManagerRemove(aUsername, aHostName, aRealm) {</span>
<a href="#l23.102"></a><span id="l23.102">         cal.ASSERT(aUsername);</span>
<a href="#l23.103"></a><span id="l23.103"> </span>
<a href="#l23.104"></a><span id="l23.104">         try {</span>
<a href="#l23.105"></a><span id="l23.105" class="difflineminus">-            let loginManager = Components.classes[&quot;@mozilla.org/login-manager;1&quot;]</span>
<a href="#l23.106"></a><span id="l23.106" class="difflineminus">-                                         .getService(Components.interfaces.nsILoginManager);</span>
<a href="#l23.107"></a><span id="l23.107" class="difflineminus">-            let logins = loginManager.findLogins({}, aHostName, null, aRealm);</span>
<a href="#l23.108"></a><span id="l23.108" class="difflineplus">+            let logins = Services.logins.findLogins({}, aHostName, null, aRealm);</span>
<a href="#l23.109"></a><span id="l23.109">             for each (let loginInfo in logins) {</span>
<a href="#l23.110"></a><span id="l23.110">                 if (loginInfo.username == aUsername) {</span>
<a href="#l23.111"></a><span id="l23.111" class="difflineminus">-                    loginManager.removeLogin(loginInfo);</span>
<a href="#l23.112"></a><span id="l23.112" class="difflineplus">+                    Services.logins.removeLogin(loginInfo);</span>
<a href="#l23.113"></a><span id="l23.113">                     return true;</span>
<a href="#l23.114"></a><span id="l23.114">                 }</span>
<a href="#l23.115"></a><span id="l23.115">             }</span>
<a href="#l23.116"></a><span id="l23.116">         } catch (exc) {</span>
<a href="#l23.117"></a><span id="l23.117">         }</span>
<a href="#l23.118"></a><span id="l23.118">         return false;</span>
<a href="#l23.119"></a><span id="l23.119">     }</span>
<a href="#l23.120"></a><span id="l23.120"> };</span>
<a href="#l23.121"></a><span id="l23.121" class="difflineat">@@ -175,19 +168,17 @@ cal.auth = {</span>
<a href="#l23.122"></a><span id="l23.122">  * There is one instance of that object per calendar provider.</span>
<a href="#l23.123"></a><span id="l23.123">  */</span>
<a href="#l23.124"></a><span id="l23.124"> cal.auth.Prompt.prototype = {</span>
<a href="#l23.125"></a><span id="l23.125">     getPasswordInfo: function capGPI(aPasswordRealm) {</span>
<a href="#l23.126"></a><span id="l23.126">         let username;</span>
<a href="#l23.127"></a><span id="l23.127">         let password;</span>
<a href="#l23.128"></a><span id="l23.128">         let found = false;</span>
<a href="#l23.129"></a><span id="l23.129"> </span>
<a href="#l23.130"></a><span id="l23.130" class="difflineminus">-        let loginManager = Components.classes[&quot;@mozilla.org/login-manager;1&quot;]</span>
<a href="#l23.131"></a><span id="l23.131" class="difflineminus">-                                     .getService(Components.interfaces.nsILoginManager);</span>
<a href="#l23.132"></a><span id="l23.132" class="difflineminus">-        let logins = loginManager.findLogins({}, aPasswordRealm.prePath, null, aPasswordRealm.realm);</span>
<a href="#l23.133"></a><span id="l23.133" class="difflineplus">+        let logins = Services.logins.findLogins({}, aPasswordRealm.prePath, null, aPasswordRealm.realm);</span>
<a href="#l23.134"></a><span id="l23.134">         if (logins.length) {</span>
<a href="#l23.135"></a><span id="l23.135">             username = logins[0].username;</span>
<a href="#l23.136"></a><span id="l23.136">             password = logins[0].password;</span>
<a href="#l23.137"></a><span id="l23.137">             found = true;</span>
<a href="#l23.138"></a><span id="l23.138">         }</span>
<a href="#l23.139"></a><span id="l23.139">         if (found) {</span>
<a href="#l23.140"></a><span id="l23.140">             let keyStr = aPasswordRealm.prePath +&quot;:&quot; + aPasswordRealm.realm;</span>
<a href="#l23.141"></a><span id="l23.141">             let now = new Date();</span>
<a href="#l23.142"></a><span id="l23.142" class="difflineat">@@ -237,18 +228,18 @@ cal.auth.Prompt.prototype = {</span>
<a href="#l23.143"></a><span id="l23.143">      *         return value of false.</span>
<a href="#l23.144"></a><span id="l23.144">      */</span>
<a href="#l23.145"></a><span id="l23.145">     promptAuth: function capPA(aChannel, aLevel, aAuthInfo) {</span>
<a href="#l23.146"></a><span id="l23.146">         let hostRealm = {};</span>
<a href="#l23.147"></a><span id="l23.147">         hostRealm.prePath = aChannel.URI.prePath;</span>
<a href="#l23.148"></a><span id="l23.148">         hostRealm.realm = aAuthInfo.realm;</span>
<a href="#l23.149"></a><span id="l23.149">         let port = aChannel.URI.port;</span>
<a href="#l23.150"></a><span id="l23.150">         if (port == -1) {</span>
<a href="#l23.151"></a><span id="l23.151" class="difflineminus">-            let handler = cal.getIOService().getProtocolHandler(aChannel.URI.scheme)</span>
<a href="#l23.152"></a><span id="l23.152" class="difflineminus">-                                            .QueryInterface(Components.interfaces.nsIProtocolHandler);</span>
<a href="#l23.153"></a><span id="l23.153" class="difflineplus">+            let handler = Services.io.getProtocolHandler(aChannel.URI.scheme)</span>
<a href="#l23.154"></a><span id="l23.154" class="difflineplus">+                                     .QueryInterface(Components.interfaces.nsIProtocolHandler);</span>
<a href="#l23.155"></a><span id="l23.155">             port = handler.defaultPort;</span>
<a href="#l23.156"></a><span id="l23.156">         }</span>
<a href="#l23.157"></a><span id="l23.157">         hostRealm.passwordRealm = aChannel.URI.host + &quot;:&quot; + port + &quot; (&quot; + aAuthInfo.realm + &quot;)&quot;;</span>
<a href="#l23.158"></a><span id="l23.158"> </span>
<a href="#l23.159"></a><span id="l23.159">         let pw = this.getPasswordInfo(hostRealm);</span>
<a href="#l23.160"></a><span id="l23.160">         aAuthInfo.username = pw.username;</span>
<a href="#l23.161"></a><span id="l23.161">         if (pw &amp;&amp; pw.found) {</span>
<a href="#l23.162"></a><span id="l23.162">             aAuthInfo.password = pw.password;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/calendar/base/modules/calProviderUtils.jsm</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/calendar/base/modules/calProviderUtils.jsm</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -1,14 +1,15 @@</span>
<a href="#l24.4"></a><span id="l24.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l24.5"></a><span id="l24.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l24.6"></a><span id="l24.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l24.7"></a><span id="l24.7"> </span>
<a href="#l24.8"></a><span id="l24.8"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l24.9"></a><span id="l24.9"> Components.utils.import(&quot;resource://calendar/modules/calAuthUtils.jsm&quot;);</span>
<a href="#l24.10"></a><span id="l24.10" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l24.11"></a><span id="l24.11"> </span>
<a href="#l24.12"></a><span id="l24.12"> /*</span>
<a href="#l24.13"></a><span id="l24.13">  * Provider helper code</span>
<a href="#l24.14"></a><span id="l24.14">  */</span>
<a href="#l24.15"></a><span id="l24.15"> </span>
<a href="#l24.16"></a><span id="l24.16"> EXPORTED_SYMBOLS = [&quot;cal&quot;]; // even though it's defined in calUtils.jsm, import needs this</span>
<a href="#l24.17"></a><span id="l24.17"> </span>
<a href="#l24.18"></a><span id="l24.18"> /**</span>
<a href="#l24.19"></a><span id="l24.19" class="difflineat">@@ -21,17 +22,17 @@ EXPORTED_SYMBOLS = [&quot;cal&quot;]; // even thou</span>
<a href="#l24.20"></a><span id="l24.20">  *                                     nsIInputStream or string data. In the</span>
<a href="#l24.21"></a><span id="l24.21">  *                                     latter case the string will be converted</span>
<a href="#l24.22"></a><span id="l24.22">  *                                     to an input stream.</span>
<a href="#l24.23"></a><span id="l24.23">  * @param aContentType               Value for Content-Type header, if any</span>
<a href="#l24.24"></a><span id="l24.24">  * @param aNotificationCallbacks     Calendar using channel</span>
<a href="#l24.25"></a><span id="l24.25">  * @param aExisting                  An existing channel to modify (optional)</span>
<a href="#l24.26"></a><span id="l24.26">  */</span>
<a href="#l24.27"></a><span id="l24.27"> cal.prepHttpChannel = function calPrepHttpChannel(aUri, aUploadData, aContentType, aNotificationCallbacks, aExisting) {</span>
<a href="#l24.28"></a><span id="l24.28" class="difflineminus">-    let channel = aExisting || cal.getIOService().newChannelFromURI(aUri);</span>
<a href="#l24.29"></a><span id="l24.29" class="difflineplus">+    let channel = aExisting || Services.io.newChannelFromURI(aUri);</span>
<a href="#l24.30"></a><span id="l24.30">     let httpchannel = channel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l24.31"></a><span id="l24.31"> </span>
<a href="#l24.32"></a><span id="l24.32">     httpchannel.setRequestHeader(&quot;Accept&quot;, &quot;text/xml&quot;, false);</span>
<a href="#l24.33"></a><span id="l24.33">     httpchannel.setRequestHeader(&quot;Accept-Charset&quot;, &quot;utf-8,*;q=0.1&quot;, false);</span>
<a href="#l24.34"></a><span id="l24.34">     httpchannel.loadFlags |= Components.interfaces.nsIRequest.LOAD_BYPASS_CACHE;</span>
<a href="#l24.35"></a><span id="l24.35">     httpchannel.notificationCallbacks = aNotificationCallbacks;</span>
<a href="#l24.36"></a><span id="l24.36"> </span>
<a href="#l24.37"></a><span id="l24.37">     if (aUploadData) {</span>
<a href="#l24.38"></a><span id="l24.38" class="difflineat">@@ -113,19 +114,17 @@ cal.InterfaceRequestor_getInterface = fu</span>
<a href="#l24.39"></a><span id="l24.39">         // Support Auth Prompt Interfaces</span>
<a href="#l24.40"></a><span id="l24.40">         if (aIID.equals(Components.interfaces.nsIAuthPrompt2)) {</span>
<a href="#l24.41"></a><span id="l24.41">             if (!this.calAuthPrompt) {</span>
<a href="#l24.42"></a><span id="l24.42">                 this.calAuthPrompt = new cal.auth.Prompt();</span>
<a href="#l24.43"></a><span id="l24.43">             }</span>
<a href="#l24.44"></a><span id="l24.44">             return this.calAuthPrompt;</span>
<a href="#l24.45"></a><span id="l24.45">         } else if (aIID.equals(Components.interfaces.nsIAuthPromptProvider) ||</span>
<a href="#l24.46"></a><span id="l24.46">                    aIID.equals(Components.interfaces.nsIPrompt)) {</span>
<a href="#l24.47"></a><span id="l24.47" class="difflineminus">-            return Components.classes[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l24.48"></a><span id="l24.48" class="difflineminus">-                             .getService(Components.interfaces.nsIWindowWatcher)</span>
<a href="#l24.49"></a><span id="l24.49" class="difflineminus">-                             .getNewPrompter(null);</span>
<a href="#l24.50"></a><span id="l24.50" class="difflineplus">+            return Services.ww.getNewPrompter(null);</span>
<a href="#l24.51"></a><span id="l24.51">         } else if (aIID.equals(Components.interfaces.nsIBadCertListener2)) {</span>
<a href="#l24.52"></a><span id="l24.52">             if (!this.badCertHandler) {</span>
<a href="#l24.53"></a><span id="l24.53">                 this.badCertHandler = new cal.BadCertHandler(this);</span>
<a href="#l24.54"></a><span id="l24.54">             }</span>
<a href="#l24.55"></a><span id="l24.55">             return this.badCertHandler;</span>
<a href="#l24.56"></a><span id="l24.56">         } else {</span>
<a href="#l24.57"></a><span id="l24.57">             Components.returnCode = e;</span>
<a href="#l24.58"></a><span id="l24.58">         }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/calendar/base/modules/calUtils.jsm</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/calendar/base/modules/calUtils.jsm</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -2,72 +2,67 @@</span>
<a href="#l25.4"></a><span id="l25.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l25.5"></a><span id="l25.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l25.6"></a><span id="l25.6"> </span>
<a href="#l25.7"></a><span id="l25.7"> // New code must not load/import calUtils.js, but should use calUtils.jsm.</span>
<a href="#l25.8"></a><span id="l25.8"> </span>
<a href="#l25.9"></a><span id="l25.9"> var gCalThreadingEnabled;</span>
<a href="#l25.10"></a><span id="l25.10"> </span>
<a href="#l25.11"></a><span id="l25.11"> Components.utils.import(&quot;resource:///modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l25.13"></a><span id="l25.13"> </span>
<a href="#l25.14"></a><span id="l25.14"> EXPORTED_SYMBOLS = [&quot;cal&quot;];</span>
<a href="#l25.15"></a><span id="l25.15"> let cal = {</span>
<a href="#l25.16"></a><span id="l25.16">     // new code should land here,</span>
<a href="#l25.17"></a><span id="l25.17">     // and more code should be moved from calUtils.js into this object to avoid</span>
<a href="#l25.18"></a><span id="l25.18">     // clashes with other extensions</span>
<a href="#l25.19"></a><span id="l25.19"> </span>
<a href="#l25.20"></a><span id="l25.20" class="difflineminus">-    getThreadManager: generateServiceAccessor(&quot;@mozilla.org/thread-manager;1&quot;,</span>
<a href="#l25.21"></a><span id="l25.21" class="difflineminus">-                                              Components.interfaces.nsIThreadManager),</span>
<a href="#l25.22"></a><span id="l25.22">     getIOService: generateServiceAccessor(&quot;@mozilla.org/network/io-service;1&quot;,</span>
<a href="#l25.23"></a><span id="l25.23">                                           Components.interfaces.nsIIOService2),</span>
<a href="#l25.24"></a><span id="l25.24" class="difflineminus">-    getObserverService: generateServiceAccessor(&quot;@mozilla.org/observer-service;1&quot;,</span>
<a href="#l25.25"></a><span id="l25.25" class="difflineminus">-                                                Components.interfaces.nsIObserverService),</span>
<a href="#l25.26"></a><span id="l25.26">     getDragService: generateServiceAccessor(&quot;@mozilla.org/widget/dragservice;1&quot;,</span>
<a href="#l25.27"></a><span id="l25.27">                                                 Components.interfaces.nsIDragService),</span>
<a href="#l25.28"></a><span id="l25.28"> </span>
<a href="#l25.29"></a><span id="l25.29">     /**</span>
<a href="#l25.30"></a><span id="l25.30">      * Loads an array of calendar scripts into the passed scope.</span>
<a href="#l25.31"></a><span id="l25.31">      *</span>
<a href="#l25.32"></a><span id="l25.32">      * @param scriptNames an array of calendar script names</span>
<a href="#l25.33"></a><span id="l25.33">      * @param scope       scope to load into</span>
<a href="#l25.34"></a><span id="l25.34">      * @param baseDir     base dir; defaults to calendar-js/</span>
<a href="#l25.35"></a><span id="l25.35">      */</span>
<a href="#l25.36"></a><span id="l25.36">     loadScripts: function cal_loadScripts(scriptNames, scope, baseDir) {</span>
<a href="#l25.37"></a><span id="l25.37" class="difflineminus">-        let scriptLoader = Components.classes[&quot;@mozilla.org/moz/jssubscript-loader;1&quot;]</span>
<a href="#l25.38"></a><span id="l25.38" class="difflineminus">-                                     .createInstance(Components.interfaces.mozIJSSubScriptLoader);</span>
<a href="#l25.39"></a><span id="l25.39">         let ioService = cal.getIOService();</span>
<a href="#l25.40"></a><span id="l25.40"> </span>
<a href="#l25.41"></a><span id="l25.41">         if (!baseDir) {</span>
<a href="#l25.42"></a><span id="l25.42">             baseDir = __LOCATION__.parent.parent.clone();</span>
<a href="#l25.43"></a><span id="l25.43">             baseDir.append(&quot;calendar-js&quot;);</span>
<a href="#l25.44"></a><span id="l25.44">         }</span>
<a href="#l25.45"></a><span id="l25.45"> </span>
<a href="#l25.46"></a><span id="l25.46">         for each (let script in scriptNames) {</span>
<a href="#l25.47"></a><span id="l25.47">             if (!script) {</span>
<a href="#l25.48"></a><span id="l25.48">                 // If the array element is null, then just skip this script.</span>
<a href="#l25.49"></a><span id="l25.49">                 continue;</span>
<a href="#l25.50"></a><span id="l25.50">             }</span>
<a href="#l25.51"></a><span id="l25.51">             let scriptFile = baseDir.clone();</span>
<a href="#l25.52"></a><span id="l25.52">             scriptFile.append(script);</span>
<a href="#l25.53"></a><span id="l25.53">             let scriptUrlSpec = ioService.newFileURI(scriptFile).spec;</span>
<a href="#l25.54"></a><span id="l25.54">             try {</span>
<a href="#l25.55"></a><span id="l25.55" class="difflineminus">-                scriptLoader.loadSubScript(scriptUrlSpec, scope);</span>
<a href="#l25.56"></a><span id="l25.56" class="difflineplus">+                Services.scriptLoader.loadSubScript(scriptUrlSpec, scope);</span>
<a href="#l25.57"></a><span id="l25.57">             } catch (exc) {</span>
<a href="#l25.58"></a><span id="l25.58">                 Components.utils.reportError(exc + &quot; (&quot; + scriptUrlSpec + &quot;)&quot;);</span>
<a href="#l25.59"></a><span id="l25.59">             }</span>
<a href="#l25.60"></a><span id="l25.60">         }</span>
<a href="#l25.61"></a><span id="l25.61">     },</span>
<a href="#l25.62"></a><span id="l25.62"> </span>
<a href="#l25.63"></a><span id="l25.63">     /**</span>
<a href="#l25.64"></a><span id="l25.64">      * Schedules execution of the passed function to the current thread's queue.</span>
<a href="#l25.65"></a><span id="l25.65">      */</span>
<a href="#l25.66"></a><span id="l25.66">     postPone: function cal_postPone(func) {</span>
<a href="#l25.67"></a><span id="l25.67">         if (this.threadingEnabled) {</span>
<a href="#l25.68"></a><span id="l25.68" class="difflineminus">-            cal.getThreadManager().currentThread.dispatch({ run: func },</span>
<a href="#l25.69"></a><span id="l25.69" class="difflineminus">-                                                          Components.interfaces.nsIEventTarget.DISPATCH_NORMAL);</span>
<a href="#l25.70"></a><span id="l25.70" class="difflineplus">+            Services.tm.currentThread.dispatch({ run: func },</span>
<a href="#l25.71"></a><span id="l25.71" class="difflineplus">+                                               Components.interfaces.nsIEventTarget.DISPATCH_NORMAL);</span>
<a href="#l25.72"></a><span id="l25.72">         } else {</span>
<a href="#l25.73"></a><span id="l25.73">             func();</span>
<a href="#l25.74"></a><span id="l25.74">         }</span>
<a href="#l25.75"></a><span id="l25.75">     },</span>
<a href="#l25.76"></a><span id="l25.76"> </span>
<a href="#l25.77"></a><span id="l25.77">     /**</span>
<a href="#l25.78"></a><span id="l25.78">      * Create an adapter for the given interface. If passed, methods will be</span>
<a href="#l25.79"></a><span id="l25.79">      * added to the template object, otherwise a new object will be returned.</span>
<a href="#l25.80"></a><span id="l25.80" class="difflineat">@@ -424,21 +419,19 @@ let cal = {</span>
<a href="#l25.81"></a><span id="l25.81">         return sortEntry.mItem;</span>
<a href="#l25.82"></a><span id="l25.82">     },</span>
<a href="#l25.83"></a><span id="l25.83"> </span>
<a href="#l25.84"></a><span id="l25.84">     sortEntryKey: function cal_sortEntryKey(sortEntry) {</span>
<a href="#l25.85"></a><span id="l25.85">         return sortEntry.mSortKey;</span>
<a href="#l25.86"></a><span id="l25.86">     },</span>
<a href="#l25.87"></a><span id="l25.87"> </span>
<a href="#l25.88"></a><span id="l25.88">     createLocaleCollator: function cal_createLocaleCollator() {</span>
<a href="#l25.89"></a><span id="l25.89" class="difflineminus">-        let localeService = Components.classes[&quot;@mozilla.org/intl/nslocaleservice;1&quot;]</span>
<a href="#l25.90"></a><span id="l25.90" class="difflineminus">-                                      .getService(Components.interfaces.nsILocaleService);</span>
<a href="#l25.91"></a><span id="l25.91">         return Components.classes[&quot;@mozilla.org/intl/collation-factory;1&quot;]</span>
<a href="#l25.92"></a><span id="l25.92">                          .getService(Components.interfaces.nsICollationFactory)</span>
<a href="#l25.93"></a><span id="l25.93" class="difflineminus">-                         .CreateCollation(localeService.getApplicationLocale());</span>
<a href="#l25.94"></a><span id="l25.94" class="difflineplus">+                         .CreateCollation(Services.locale.getApplicationLocale());</span>
<a href="#l25.95"></a><span id="l25.95">      },</span>
<a href="#l25.96"></a><span id="l25.96"> </span>
<a href="#l25.97"></a><span id="l25.97">     /**</span>
<a href="#l25.98"></a><span id="l25.98">      * Sort an array of strings according to the current locale.</span>
<a href="#l25.99"></a><span id="l25.99">      * Modifies aStringArray, returning it sorted.</span>
<a href="#l25.100"></a><span id="l25.100">      */</span>
<a href="#l25.101"></a><span id="l25.101">     sortArrayByLocaleCollator: function cal_sortArrayByLocaleCollator(aStringArray) {</span>
<a href="#l25.102"></a><span id="l25.102">         var localeCollator = cal.createLocaleCollator();</span>
<a href="#l25.103"></a><span id="l25.103" class="difflineat">@@ -570,45 +563,39 @@ let cal = {</span>
<a href="#l25.104"></a><span id="l25.104">             childNode = prevChildNode;</span>
<a href="#l25.105"></a><span id="l25.105">         };</span>
<a href="#l25.106"></a><span id="l25.106">     },</span>
<a href="#l25.107"></a><span id="l25.107"> </span>
<a href="#l25.108"></a><span id="l25.108">     /**</span>
<a href="#l25.109"></a><span id="l25.109">      * Returns the most recent calendar window in an application independent way</span>
<a href="#l25.110"></a><span id="l25.110">      */</span>
<a href="#l25.111"></a><span id="l25.111">     getCalendarWindow: function cal_getCalendarWindow() {</span>
<a href="#l25.112"></a><span id="l25.112" class="difflineminus">-        let wm = Components.classes[&quot;@mozilla.org/appshell/window-mediator;1&quot;]</span>
<a href="#l25.113"></a><span id="l25.113" class="difflineminus">-                           .getService(Components.interfaces.nsIWindowMediator);</span>
<a href="#l25.114"></a><span id="l25.114" class="difflineminus">-        return wm.getMostRecentWindow(&quot;calendarMainWindow&quot;) ||</span>
<a href="#l25.115"></a><span id="l25.115" class="difflineminus">-               wm.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l25.116"></a><span id="l25.116" class="difflineplus">+        return Services.wm.getMostRecentWindow(&quot;calendarMainWindow&quot;) ||</span>
<a href="#l25.117"></a><span id="l25.117" class="difflineplus">+               Services.wm.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l25.118"></a><span id="l25.118">     },</span>
<a href="#l25.119"></a><span id="l25.119"> </span>
<a href="#l25.120"></a><span id="l25.120">     /**</span>
<a href="#l25.121"></a><span id="l25.121">      * Adds an observer listening for the topic.</span>
<a href="#l25.122"></a><span id="l25.122">      *</span>
<a href="#l25.123"></a><span id="l25.123">      * @param func function to execute on topic</span>
<a href="#l25.124"></a><span id="l25.124">      * @param topic topic to listen for</span>
<a href="#l25.125"></a><span id="l25.125">      * @param oneTime whether to listen only once</span>
<a href="#l25.126"></a><span id="l25.126">      */</span>
<a href="#l25.127"></a><span id="l25.127">     addObserver: function cal_addObserver(func, topic, oneTime) {</span>
<a href="#l25.128"></a><span id="l25.128">         let observer = { // nsIObserver:</span>
<a href="#l25.129"></a><span id="l25.129">             observe: function cal_addObserver_observe(subject, topic_, data) {</span>
<a href="#l25.130"></a><span id="l25.130">                 if (topic == topic_) {</span>
<a href="#l25.131"></a><span id="l25.131">                     if (oneTime) {</span>
<a href="#l25.132"></a><span id="l25.132" class="difflineminus">-                        Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l25.133"></a><span id="l25.133" class="difflineminus">-                                  .getService(Components.interfaces.nsIObserverService)</span>
<a href="#l25.134"></a><span id="l25.134" class="difflineminus">-                                  .removeObserver(this, topic);</span>
<a href="#l25.135"></a><span id="l25.135" class="difflineplus">+                        Services.obs.removeObserver(this, topic);</span>
<a href="#l25.136"></a><span id="l25.136">                     }</span>
<a href="#l25.137"></a><span id="l25.137">                     func(subject, topic, data);</span>
<a href="#l25.138"></a><span id="l25.138">                 }</span>
<a href="#l25.139"></a><span id="l25.139">             }</span>
<a href="#l25.140"></a><span id="l25.140">         };</span>
<a href="#l25.141"></a><span id="l25.141" class="difflineminus">-        Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l25.142"></a><span id="l25.142" class="difflineminus">-                  .getService(Components.interfaces.nsIObserverService)</span>
<a href="#l25.143"></a><span id="l25.143" class="difflineminus">-                  .addObserver(observer, topic, false /* don't hold weakly */);</span>
<a href="#l25.144"></a><span id="l25.144" class="difflineplus">+        Services.obs.addObserver(observer, topic, false /* don't hold weakly */);</span>
<a href="#l25.145"></a><span id="l25.145">     },</span>
<a href="#l25.146"></a><span id="l25.146"> </span>
<a href="#l25.147"></a><span id="l25.147">     /**</span>
<a href="#l25.148"></a><span id="l25.148">      * Adds an xpcom shutdown observer.</span>
<a href="#l25.149"></a><span id="l25.149">      *</span>
<a href="#l25.150"></a><span id="l25.150">      * @param func function to execute</span>
<a href="#l25.151"></a><span id="l25.151">      */</span>
<a href="#l25.152"></a><span id="l25.152">     addShutdownObserver: function cal_addShutdownObserver(func) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/calendar/base/src/calAlarmMonitor.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/calendar/base/src/calAlarmMonitor.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -1,18 +1,17 @@</span>
<a href="#l26.4"></a><span id="l26.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l26.5"></a><span id="l26.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l26.6"></a><span id="l26.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l26.7"></a><span id="l26.7"> </span>
<a href="#l26.8"></a><span id="l26.8"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l26.9"></a><span id="l26.9" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l26.10"></a><span id="l26.10"> </span>
<a href="#l26.11"></a><span id="l26.11"> function peekAlarmWindow() {</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-    let windowMediator = Components.classes[&quot;@mozilla.org/appshell/window-mediator;1&quot;]</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineminus">-                                   .getService(Components.interfaces.nsIWindowMediator);</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineminus">-    return windowMediator.getMostRecentWindow(&quot;Calendar:AlarmWindow&quot;);</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineplus">+    return Services.wm.getMostRecentWindow(&quot;Calendar:AlarmWindow&quot;);</span>
<a href="#l26.16"></a><span id="l26.16"> }</span>
<a href="#l26.17"></a><span id="l26.17"> </span>
<a href="#l26.18"></a><span id="l26.18"> /**</span>
<a href="#l26.19"></a><span id="l26.19">  * The alarm monitor takes care of playing the alarm sound and opening one copy</span>
<a href="#l26.20"></a><span id="l26.20">  * of the calendar-alarm-dialog. Both depend on their respective prefs to be</span>
<a href="#l26.21"></a><span id="l26.21">  * set. This monitor is only used for DISPLAY type alarms.</span>
<a href="#l26.22"></a><span id="l26.22">  */</span>
<a href="#l26.23"></a><span id="l26.23"> function calAlarmMonitor() {</span>
<a href="#l26.24"></a><span id="l26.24" class="difflineat">@@ -126,19 +125,17 @@ calAlarmMonitor.prototype = {</span>
<a href="#l26.25"></a><span id="l26.25">         }</span>
<a href="#l26.26"></a><span id="l26.26"> </span>
<a href="#l26.27"></a><span id="l26.27">         if (!getPrefSafe(&quot;calendar.alarms.show&quot;, true)) {</span>
<a href="#l26.28"></a><span id="l26.28">             return;</span>
<a href="#l26.29"></a><span id="l26.29">         }</span>
<a href="#l26.30"></a><span id="l26.30"> </span>
<a href="#l26.31"></a><span id="l26.31">         let calAlarmWindow = peekAlarmWindow();</span>
<a href="#l26.32"></a><span id="l26.32">         if (!calAlarmWindow  &amp;&amp; !this.mWindowOpening) {</span>
<a href="#l26.33"></a><span id="l26.33" class="difflineminus">-            let windowWatcher = Components.classes[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l26.34"></a><span id="l26.34" class="difflineminus">-                                          .getService(Components.interfaces.nsIWindowWatcher);</span>
<a href="#l26.35"></a><span id="l26.35" class="difflineminus">-            this.mWindowOpening = windowWatcher.openWindow(</span>
<a href="#l26.36"></a><span id="l26.36" class="difflineplus">+            this.mWindowOpening = Services.ww.openWindow(</span>
<a href="#l26.37"></a><span id="l26.37">                 null,</span>
<a href="#l26.38"></a><span id="l26.38">                 &quot;chrome://calendar/content/calendar-alarm-dialog.xul&quot;,</span>
<a href="#l26.39"></a><span id="l26.39">                 &quot;_blank&quot;,</span>
<a href="#l26.40"></a><span id="l26.40">                 &quot;chrome,dialog=yes,all,resizable&quot;,</span>
<a href="#l26.41"></a><span id="l26.41">                 this);</span>
<a href="#l26.42"></a><span id="l26.42">         }</span>
<a href="#l26.43"></a><span id="l26.43">         if (!this.mWindowOpening) {</span>
<a href="#l26.44"></a><span id="l26.44">             calAlarmWindow.addWidgetFor(aItem, aAlarm);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/calendar/base/src/calAlarmService.js</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/calendar/base/src/calAlarmService.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -1,14 +1,15 @@</span>
<a href="#l27.4"></a><span id="l27.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l27.5"></a><span id="l27.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l27.6"></a><span id="l27.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l27.7"></a><span id="l27.7"> </span>
<a href="#l27.8"></a><span id="l27.8"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l27.9"></a><span id="l27.9"> Components.utils.import(&quot;resource://calendar/modules/calAlarmUtils.jsm&quot;);</span>
<a href="#l27.10"></a><span id="l27.10" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l27.11"></a><span id="l27.11"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l27.12"></a><span id="l27.12"> </span>
<a href="#l27.13"></a><span id="l27.13"> const kHoursBetweenUpdates = 6;</span>
<a href="#l27.14"></a><span id="l27.14"> </span>
<a href="#l27.15"></a><span id="l27.15"> function nowUTC() {</span>
<a href="#l27.16"></a><span id="l27.16">     return jsDateToDateTime(new Date()).getInTimezone(UTC());</span>
<a href="#l27.17"></a><span id="l27.17"> }</span>
<a href="#l27.18"></a><span id="l27.18"> </span>
<a href="#l27.19"></a><span id="l27.19" class="difflineat">@@ -215,23 +216,19 @@ calAlarmService.prototype = {</span>
<a href="#l27.20"></a><span id="l27.20">         this.mObservers.remove(aObserver);</span>
<a href="#l27.21"></a><span id="l27.21">     },</span>
<a href="#l27.22"></a><span id="l27.22"> </span>
<a href="#l27.23"></a><span id="l27.23">     startup: function cAS_startup() {</span>
<a href="#l27.24"></a><span id="l27.24">         if (this.mStarted) {</span>
<a href="#l27.25"></a><span id="l27.25">             return;</span>
<a href="#l27.26"></a><span id="l27.26">         }</span>
<a href="#l27.27"></a><span id="l27.27"> </span>
<a href="#l27.28"></a><span id="l27.28" class="difflineminus">-        let observerSvc = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l27.29"></a><span id="l27.29" class="difflineminus">-                          .getService</span>
<a href="#l27.30"></a><span id="l27.30" class="difflineminus">-                          (Components.interfaces.nsIObserverService);</span>
<a href="#l27.31"></a><span id="l27.31" class="difflineminus">-</span>
<a href="#l27.32"></a><span id="l27.32" class="difflineminus">-        observerSvc.addObserver(this, &quot;profile-after-change&quot;, false);</span>
<a href="#l27.33"></a><span id="l27.33" class="difflineminus">-        observerSvc.addObserver(this, &quot;xpcom-shutdown&quot;, false);</span>
<a href="#l27.34"></a><span id="l27.34" class="difflineminus">-        observerSvc.addObserver(this, &quot;wake_notification&quot;, false);</span>
<a href="#l27.35"></a><span id="l27.35" class="difflineplus">+        Services.obs.addObserver(this, &quot;profile-after-change&quot;, false);</span>
<a href="#l27.36"></a><span id="l27.36" class="difflineplus">+        Services.obs.addObserver(this, &quot;xpcom-shutdown&quot;, false);</span>
<a href="#l27.37"></a><span id="l27.37" class="difflineplus">+        Services.obs.addObserver(this, &quot;wake_notification&quot;, false);</span>
<a href="#l27.38"></a><span id="l27.38"> </span>
<a href="#l27.39"></a><span id="l27.39">         /* Tell people that we're alive so they can start monitoring alarms.</span>
<a href="#l27.40"></a><span id="l27.40">          */</span>
<a href="#l27.41"></a><span id="l27.41">         let notifier = Components.classes[&quot;@mozilla.org/embedcomp/appstartup-notifier;1&quot;]</span>
<a href="#l27.42"></a><span id="l27.42">                                  .getService(Components.interfaces.nsIObserver);</span>
<a href="#l27.43"></a><span id="l27.43">         notifier.observe(null, &quot;alarm-service-startup&quot;, null);</span>
<a href="#l27.44"></a><span id="l27.44"> </span>
<a href="#l27.45"></a><span id="l27.45">         getCalendarManager().addObserver(this.calendarManagerObserver);</span>
<a href="#l27.46"></a><span id="l27.46" class="difflineat">@@ -297,22 +294,19 @@ calAlarmService.prototype = {</span>
<a href="#l27.47"></a><span id="l27.47"> </span>
<a href="#l27.48"></a><span id="l27.48">         // Stop observing all calendars. This will also clear the timers.</span>
<a href="#l27.49"></a><span id="l27.49">         for each (let calendar in calmgr.getCalendars({})) {</span>
<a href="#l27.50"></a><span id="l27.50">             this.unobserveCalendar(calendar);</span>
<a href="#l27.51"></a><span id="l27.51">         }</span>
<a href="#l27.52"></a><span id="l27.52"> </span>
<a href="#l27.53"></a><span id="l27.53">         this.mRangeEnd = null;</span>
<a href="#l27.54"></a><span id="l27.54"> </span>
<a href="#l27.55"></a><span id="l27.55" class="difflineminus">-        let observerSvc = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l27.56"></a><span id="l27.56" class="difflineminus">-                          .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l27.57"></a><span id="l27.57" class="difflineminus">-</span>
<a href="#l27.58"></a><span id="l27.58" class="difflineminus">-        observerSvc.removeObserver(this, &quot;profile-after-change&quot;);</span>
<a href="#l27.59"></a><span id="l27.59" class="difflineminus">-        observerSvc.removeObserver(this, &quot;xpcom-shutdown&quot;);</span>
<a href="#l27.60"></a><span id="l27.60" class="difflineminus">-        observerSvc.removeObserver(this, &quot;wake_notification&quot;);</span>
<a href="#l27.61"></a><span id="l27.61" class="difflineplus">+        Services.obs.removeObserver(this, &quot;profile-after-change&quot;);</span>
<a href="#l27.62"></a><span id="l27.62" class="difflineplus">+        Services.obs.removeObserver(this, &quot;xpcom-shutdown&quot;);</span>
<a href="#l27.63"></a><span id="l27.63" class="difflineplus">+        Services.obs.removeObserver(this, &quot;wake_notification&quot;);</span>
<a href="#l27.64"></a><span id="l27.64"> </span>
<a href="#l27.65"></a><span id="l27.65">         this.mStarted = false;</span>
<a href="#l27.66"></a><span id="l27.66">     },</span>
<a href="#l27.67"></a><span id="l27.67"> </span>
<a href="#l27.68"></a><span id="l27.68">     observeCalendar: function cAS_observeCalendar(calendar) {</span>
<a href="#l27.69"></a><span id="l27.69">         calendar.addObserver(this.calendarObserver);</span>
<a href="#l27.70"></a><span id="l27.70">     },</span>
<a href="#l27.71"></a><span id="l27.71"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/calendar/base/src/calApplicationUtils.js</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/calendar/base/src/calApplicationUtils.js</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -1,19 +1,19 @@</span>
<a href="#l28.4"></a><span id="l28.4"> /* -*- Mode: javascript; tab-width: 20; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l28.5"></a><span id="l28.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l28.6"></a><span id="l28.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l28.7"></a><span id="l28.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l28.8"></a><span id="l28.8"> </span>
<a href="#l28.9"></a><span id="l28.9" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l28.10"></a><span id="l28.10" class="difflineplus">+</span>
<a href="#l28.11"></a><span id="l28.11"> function openAboutDialog()</span>
<a href="#l28.12"></a><span id="l28.12"> {</span>
<a href="#l28.13"></a><span id="l28.13">   const SUNBIRD_ID = &quot;{718e30fb-e89b-41dd-9da7-e25a45638b28}&quot;;</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineminus">-  var appInfo = Components.classes[&quot;@mozilla.org/xre/app-info;1&quot;]</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineminus">-                          .getService(Components.interfaces.nsIXULAppInfo);</span>
<a href="#l28.16"></a><span id="l28.16" class="difflineminus">-  var url = (appInfo.ID == SUNBIRD_ID) ?</span>
<a href="#l28.17"></a><span id="l28.17" class="difflineplus">+  var url = (Services.appinfo.ID == SUNBIRD_ID) ?</span>
<a href="#l28.18"></a><span id="l28.18">     &quot;chrome://sunbird/content/aboutDialog.xul&quot; :</span>
<a href="#l28.19"></a><span id="l28.19">     &quot;chrome://messenger/content/aboutDialog.xul&quot; ;</span>
<a href="#l28.20"></a><span id="l28.20"> #ifdef XP_WIN</span>
<a href="#l28.21"></a><span id="l28.21">   var features = &quot;chrome,centerscreen,dependent&quot;;</span>
<a href="#l28.22"></a><span id="l28.22"> #elifdef XP_MACOSX</span>
<a href="#l28.23"></a><span id="l28.23">   var features = &quot;chrome,resizable=no,minimizable=no&quot;;</span>
<a href="#l28.24"></a><span id="l28.24"> #else</span>
<a href="#l28.25"></a><span id="l28.25">   var features = &quot;chrome,centerscreen,dependent,dialog=no&quot;;</span>
<a href="#l28.26"></a><span id="l28.26" class="difflineat">@@ -22,82 +22,71 @@ function openAboutDialog()</span>
<a href="#l28.27"></a><span id="l28.27"> }</span>
<a href="#l28.28"></a><span id="l28.28"> </span>
<a href="#l28.29"></a><span id="l28.29"> /**</span>
<a href="#l28.30"></a><span id="l28.30">  * Opens the release notes page for this version of the application.</span>
<a href="#l28.31"></a><span id="l28.31">  */</span>
<a href="#l28.32"></a><span id="l28.32"> function openReleaseNotes()</span>
<a href="#l28.33"></a><span id="l28.33"> {</span>
<a href="#l28.34"></a><span id="l28.34">   const SUNBIRD_ID = &quot;{718e30fb-e89b-41dd-9da7-e25a45638b28}&quot;;</span>
<a href="#l28.35"></a><span id="l28.35" class="difflineminus">-  var appInfo = Components.classes[&quot;@mozilla.org/xre/app-info;1&quot;]</span>
<a href="#l28.36"></a><span id="l28.36" class="difflineminus">-                          .getService(Components.interfaces.nsIXULAppInfo);</span>
<a href="#l28.37"></a><span id="l28.37" class="difflineminus">-  if (appInfo.ID == SUNBIRD_ID) {</span>
<a href="#l28.38"></a><span id="l28.38" class="difflineminus">-    var appInfo = Components.classes[&quot;@mozilla.org/xre/app-info;1&quot;]</span>
<a href="#l28.39"></a><span id="l28.39" class="difflineminus">-                            .getService(Components.interfaces.nsIXULAppInfo);</span>
<a href="#l28.40"></a><span id="l28.40" class="difflineminus">-    var sbs = Components.classes[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l28.41"></a><span id="l28.41" class="difflineminus">-                        .getService(Components.interfaces.nsIStringBundleService);</span>
<a href="#l28.42"></a><span id="l28.42" class="difflineminus">-    var bundle = sbs.createBundle(&quot;chrome://branding/locale/brand.properties&quot;);</span>
<a href="#l28.43"></a><span id="l28.43" class="difflineminus">-    var relNotesURL = bundle.formatStringFromName(&quot;releaseNotesURL&quot;,[appInfo.version],1)</span>
<a href="#l28.44"></a><span id="l28.44" class="difflineplus">+  if (Services.appinfo.ID == SUNBIRD_ID) {</span>
<a href="#l28.45"></a><span id="l28.45" class="difflineplus">+    var bundle = Services.strings.createBundle(&quot;chrome://branding/locale/brand.properties&quot;);</span>
<a href="#l28.46"></a><span id="l28.46" class="difflineplus">+    var relNotesURL = bundle.formatStringFromName(&quot;releaseNotesURL&quot;,[Services.appinfo.version],1)</span>
<a href="#l28.47"></a><span id="l28.47">     launchBrowser(relNotesURL);</span>
<a href="#l28.48"></a><span id="l28.48">   } else {</span>
<a href="#l28.49"></a><span id="l28.49">     openFormattedRegionURL('app.releaseNotesURL');</span>
<a href="#l28.50"></a><span id="l28.50">   }</span>
<a href="#l28.51"></a><span id="l28.51"> }</span>
<a href="#l28.52"></a><span id="l28.52"> </span>
<a href="#l28.53"></a><span id="l28.53"> /**</span>
<a href="#l28.54"></a><span id="l28.54">  * Opens region specific web pages for the application like the release notes, the help site, etc. </span>
<a href="#l28.55"></a><span id="l28.55">  *   aResourceName --&gt; the string resource ID in region.properties to load. </span>
<a href="#l28.56"></a><span id="l28.56">  */</span>
<a href="#l28.57"></a><span id="l28.57"> function openRegionURL(aResourceName)</span>
<a href="#l28.58"></a><span id="l28.58"> {</span>
<a href="#l28.59"></a><span id="l28.59" class="difflineminus">-  var appInfo = Components.classes[&quot;@mozilla.org/xre/app-info;1&quot;]</span>
<a href="#l28.60"></a><span id="l28.60" class="difflineminus">-                          .getService(Components.interfaces.nsIXULAppInfo);</span>
<a href="#l28.61"></a><span id="l28.61">   try {</span>
<a href="#l28.62"></a><span id="l28.62" class="difflineminus">-    var strBundleService = Components.classes[&quot;@mozilla.org/intl/stringbundle;1&quot;].getService(Components.interfaces.nsIStringBundleService);</span>
<a href="#l28.63"></a><span id="l28.63" class="difflineminus">-    var regionBundle = strBundleService.createBundle(&quot;chrome://messenger-region/locale/region.properties&quot;);</span>
<a href="#l28.64"></a><span id="l28.64" class="difflineplus">+    var regionBundle = Services.strings.createBundle(&quot;chrome://messenger-region/locale/region.properties&quot;);</span>
<a href="#l28.65"></a><span id="l28.65">     // the release notes are special and need to be formatted with the app version</span>
<a href="#l28.66"></a><span id="l28.66">     var urlToOpen;</span>
<a href="#l28.67"></a><span id="l28.67">     if (aResourceName == &quot;releaseNotesURL&quot;)</span>
<a href="#l28.68"></a><span id="l28.68" class="difflineminus">-      urlToOpen = regionBundle.formatStringFromName(aResourceName, [appInfo.version], 1);</span>
<a href="#l28.69"></a><span id="l28.69" class="difflineplus">+      urlToOpen = regionBundle.formatStringFromName(aResourceName, [Services.appinfo.version], 1);</span>
<a href="#l28.70"></a><span id="l28.70">     else</span>
<a href="#l28.71"></a><span id="l28.71">       urlToOpen = regionBundle.GetStringFromName(aResourceName);</span>
<a href="#l28.72"></a><span id="l28.72">       </span>
<a href="#l28.73"></a><span id="l28.73">     var protocolSvc = Components.classes[&quot;@mozilla.org/uriloader/external-protocol-service;1&quot;]</span>
<a href="#l28.74"></a><span id="l28.74">                       .getService(Components.interfaces.nsIExternalProtocolService);</span>
<a href="#l28.75"></a><span id="l28.75" class="difflineminus">-    protocolSvc.loadUrl(cal.getIOService().newURI(urlToOpen, null, null));</span>
<a href="#l28.76"></a><span id="l28.76" class="difflineplus">+    protocolSvc.loadUrl(Services.io.newURI(urlToOpen, null, null));</span>
<a href="#l28.77"></a><span id="l28.77">   } catch (ex) {}</span>
<a href="#l28.78"></a><span id="l28.78"> }</span>
<a href="#l28.79"></a><span id="l28.79"> </span>
<a href="#l28.80"></a><span id="l28.80"> /**</span>
<a href="#l28.81"></a><span id="l28.81">  *  Fetches the url for the passed in pref name, formats it and then loads it in the default</span>
<a href="#l28.82"></a><span id="l28.82">  *  browser.</span>
<a href="#l28.83"></a><span id="l28.83">  *</span>
<a href="#l28.84"></a><span id="l28.84">  *  @param aPrefName - name of the pref that holds the url we want to format and open</span>
<a href="#l28.85"></a><span id="l28.85">  */</span>
<a href="#l28.86"></a><span id="l28.86"> function openFormattedRegionURL(aPrefName)</span>
<a href="#l28.87"></a><span id="l28.87"> {</span>
<a href="#l28.88"></a><span id="l28.88">   var formattedUrl = getFormattedRegionURL(aPrefName);</span>
<a href="#l28.89"></a><span id="l28.89">   </span>
<a href="#l28.90"></a><span id="l28.90">   var protocolSvc = Components.classes[&quot;@mozilla.org/uriloader/external-protocol-service;1&quot;].</span>
<a href="#l28.91"></a><span id="l28.91">                                getService(Components.interfaces.nsIExternalProtocolService);</span>
<a href="#l28.92"></a><span id="l28.92" class="difflineminus">-  protocolSvc.loadUrl(cal.getIOService().newURI(formattedUrl, null, null));</span>
<a href="#l28.93"></a><span id="l28.93" class="difflineplus">+  protocolSvc.loadUrl(Services.io.newURI(formattedUrl, null, null));</span>
<a href="#l28.94"></a><span id="l28.94"> }</span>
<a href="#l28.95"></a><span id="l28.95"> </span>
<a href="#l28.96"></a><span id="l28.96"> /**</span>
<a href="#l28.97"></a><span id="l28.97">  *  Fetches the url for the passed in pref name and uses the URL formatter service to </span>
<a href="#l28.98"></a><span id="l28.98">  *    process it.</span>
<a href="#l28.99"></a><span id="l28.99">  *</span>
<a href="#l28.100"></a><span id="l28.100">  *  @param aPrefName - name of the pref that holds the url we want to format and open</span>
<a href="#l28.101"></a><span id="l28.101">  *  @returns the formatted url string</span>
<a href="#l28.102"></a><span id="l28.102">  */</span>
<a href="#l28.103"></a><span id="l28.103"> function getFormattedRegionURL(aPrefName)</span>
<a href="#l28.104"></a><span id="l28.104"> {</span>
<a href="#l28.105"></a><span id="l28.105" class="difflineminus">-  var formatter = Components.classes[&quot;@mozilla.org/toolkit/URLFormatterService;1&quot;].</span>
<a href="#l28.106"></a><span id="l28.106" class="difflineminus">-                             getService(Components.interfaces.nsIURLFormatter);</span>
<a href="#l28.107"></a><span id="l28.107" class="difflineminus">-  return formatter.formatURLPref(aPrefName);</span>
<a href="#l28.108"></a><span id="l28.108" class="difflineplus">+  return Services.urlFormatter.formatURLPref(aPrefName);</span>
<a href="#l28.109"></a><span id="l28.109"> }</span>
<a href="#l28.110"></a><span id="l28.110"> </span>
<a href="#l28.111"></a><span id="l28.111"> /**</span>
<a href="#l28.112"></a><span id="l28.112">  * Launch the given url (string) in the external browser. If an event is passed,</span>
<a href="#l28.113"></a><span id="l28.113">  * then this is only done on left click and the event propagation is stopped.</span>
<a href="#l28.114"></a><span id="l28.114">  *</span>
<a href="#l28.115"></a><span id="l28.115">  * @param url       The URL to open, as a string</span>
<a href="#l28.116"></a><span id="l28.116">  * @param event     (optional) The event that caused the URL to open</span>
<a href="#l28.117"></a><span id="l28.117" class="difflineat">@@ -117,17 +106,17 @@ function launchBrowser(url, event)</span>
<a href="#l28.118"></a><span id="l28.118">     Components.utils.reportError (&quot;launchBrowser: &quot; +</span>
<a href="#l28.119"></a><span id="l28.119">                                   &quot;Invalid URL provided: &quot; + url +</span>
<a href="#l28.120"></a><span id="l28.120">                                   &quot; Only http:// and https:// URLs are valid.&quot;);</span>
<a href="#l28.121"></a><span id="l28.121">     return;</span>
<a href="#l28.122"></a><span id="l28.122">   }</span>
<a href="#l28.123"></a><span id="l28.123"> </span>
<a href="#l28.124"></a><span id="l28.124">   Components.classes[&quot;@mozilla.org/uriloader/external-protocol-service;1&quot;]</span>
<a href="#l28.125"></a><span id="l28.125">             .getService(Components.interfaces.nsIExternalProtocolService)</span>
<a href="#l28.126"></a><span id="l28.126" class="difflineminus">-            .loadUrl(cal.getIOService().newURI(url, null, null));</span>
<a href="#l28.127"></a><span id="l28.127" class="difflineplus">+            .loadUrl(Services.io.newURI(url, null, null));</span>
<a href="#l28.128"></a><span id="l28.128"> </span>
<a href="#l28.129"></a><span id="l28.129">   // Make sure that any default click handlers don't do anything, we have taken</span>
<a href="#l28.130"></a><span id="l28.130">   // care of all processing</span>
<a href="#l28.131"></a><span id="l28.131">   if (event) {</span>
<a href="#l28.132"></a><span id="l28.132">       event.stopPropagation();</span>
<a href="#l28.133"></a><span id="l28.133">       event.preventDefault();</span>
<a href="#l28.134"></a><span id="l28.134">   }</span>
<a href="#l28.135"></a><span id="l28.135"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/calendar/base/src/calCachedCalendar.js</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/calendar/base/src/calCachedCalendar.js</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -1,13 +1,14 @@</span>
<a href="#l29.4"></a><span id="l29.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l29.5"></a><span id="l29.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l29.6"></a><span id="l29.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l29.7"></a><span id="l29.7"> </span>
<a href="#l29.8"></a><span id="l29.8"> Components.utils.import(&quot;resource://calendar/modules/calProviderUtils.jsm&quot;);</span>
<a href="#l29.9"></a><span id="l29.9" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l29.10"></a><span id="l29.10"> </span>
<a href="#l29.11"></a><span id="l29.11"> const calICalendar = Components.interfaces.calICalendar;</span>
<a href="#l29.12"></a><span id="l29.12"> const cICL = Components.interfaces.calIChangeLog;</span>
<a href="#l29.13"></a><span id="l29.13"> </span>
<a href="#l29.14"></a><span id="l29.14"> let gNoOpListener = {</span>
<a href="#l29.15"></a><span id="l29.15">     onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l29.16"></a><span id="l29.16">     },</span>
<a href="#l29.17"></a><span id="l29.17"> </span>
<a href="#l29.18"></a><span id="l29.18" class="difflineat">@@ -661,17 +662,17 @@ calCachedCalendar.prototype = {</span>
<a href="#l29.19"></a><span id="l29.19">     get superCalendar() {</span>
<a href="#l29.20"></a><span id="l29.20">         return this.mSuperCalendar &amp;&amp; this.mSuperCalendar.superCalendar || this;</span>
<a href="#l29.21"></a><span id="l29.21">     },</span>
<a href="#l29.22"></a><span id="l29.22">     set superCalendar(val) {</span>
<a href="#l29.23"></a><span id="l29.23">         return (this.mSuperCalendar = val);</span>
<a href="#l29.24"></a><span id="l29.24">     },</span>
<a href="#l29.25"></a><span id="l29.25"> </span>
<a href="#l29.26"></a><span id="l29.26">     get offline() {</span>
<a href="#l29.27"></a><span id="l29.27" class="difflineminus">-        return getIOService().offline;</span>
<a href="#l29.28"></a><span id="l29.28" class="difflineplus">+        return Services.io.offline;</span>
<a href="#l29.29"></a><span id="l29.29">     },</span>
<a href="#l29.30"></a><span id="l29.30">     get supportsChangeLog() {</span>
<a href="#l29.31"></a><span id="l29.31">         return calInstanceOf(this.mUncachedCalendar, Components.interfaces.calIChangeLog);</span>
<a href="#l29.32"></a><span id="l29.32">     },</span>
<a href="#l29.33"></a><span id="l29.33"> </span>
<a href="#l29.34"></a><span id="l29.34">     get canRefresh() { // enable triggering sync using the reload button</span>
<a href="#l29.35"></a><span id="l29.35">         return true;</span>
<a href="#l29.36"></a><span id="l29.36">     },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/calendar/base/src/calCalendarManager.js</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/calendar/base/src/calCalendarManager.js</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -443,42 +443,39 @@ calCalendarManager.prototype = {</span>
<a href="#l30.4"></a><span id="l30.4">             errorBoxButtonLabel = calGetString(&quot;calendar&quot;, &quot;tooNewSchemaButtonQuit&quot;, [hostAppName]);</span>
<a href="#l30.5"></a><span id="l30.5">         } else {</span>
<a href="#l30.6"></a><span id="l30.6">             var calAppName = calGetString(&quot;lightning&quot;, &quot;brandShortName&quot;, null, &quot;lightning&quot;);</span>
<a href="#l30.7"></a><span id="l30.7">             errorBoxTitle = calGetString(&quot;calendar&quot;, &quot;tooNewSchemaErrorBoxTitle&quot;, [calAppName]);</span>
<a href="#l30.8"></a><span id="l30.8">             errorBoxText = calGetString(&quot;calendar&quot;, &quot;tooNewSchemaErrorBoxTextLightning&quot;, [calAppName, hostAppName]);</span>
<a href="#l30.9"></a><span id="l30.9">             errorBoxButtonLabel = calGetString(&quot;calendar&quot;, &quot;tooNewSchemaButtonRestart&quot;, [hostAppName]);</span>
<a href="#l30.10"></a><span id="l30.10">         }</span>
<a href="#l30.11"></a><span id="l30.11"> </span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-        var promptSvc = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineminus">-                                  .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineplus">+        var promptSvc = Services.prompt;</span>
<a href="#l30.15"></a><span id="l30.15"> </span>
<a href="#l30.16"></a><span id="l30.16">         var errorBoxButtonFlags = (promptSvc.BUTTON_POS_0 *</span>
<a href="#l30.17"></a><span id="l30.17">                                    promptSvc.BUTTON_TITLE_IS_STRING +</span>
<a href="#l30.18"></a><span id="l30.18">                                    promptSvc.BUTTON_POS_0_DEFAULT);</span>
<a href="#l30.19"></a><span id="l30.19"> </span>
<a href="#l30.20"></a><span id="l30.20">         var choice = promptSvc.confirmEx(null,</span>
<a href="#l30.21"></a><span id="l30.21">                                          errorBoxTitle,</span>
<a href="#l30.22"></a><span id="l30.22">                                          errorBoxText,</span>
<a href="#l30.23"></a><span id="l30.23">                                          errorBoxButtonFlags,</span>
<a href="#l30.24"></a><span id="l30.24">                                          errorBoxButtonLabel,</span>
<a href="#l30.25"></a><span id="l30.25">                                          null, // No second button text</span>
<a href="#l30.26"></a><span id="l30.26">                                          null, // No third button text</span>
<a href="#l30.27"></a><span id="l30.27">                                          null, // No checkbox</span>
<a href="#l30.28"></a><span id="l30.28">                                          { value: false }); // Unnecessary checkbox state</span>
<a href="#l30.29"></a><span id="l30.29"> </span>
<a href="#l30.30"></a><span id="l30.30" class="difflineminus">-        var startup = Components.classes[&quot;@mozilla.org/toolkit/app-startup;1&quot;]</span>
<a href="#l30.31"></a><span id="l30.31" class="difflineminus">-                                .getService(Components.interfaces.nsIAppStartup);</span>
<a href="#l30.32"></a><span id="l30.32">         if (isSunbird()) {</span>
<a href="#l30.33"></a><span id="l30.33" class="difflineminus">-            startup.quit(Components.interfaces.nsIAppStartup.eForceQuit);</span>
<a href="#l30.34"></a><span id="l30.34" class="difflineplus">+            Services.startup.quit(Components.interfaces.nsIAppStartup.eForceQuit);</span>
<a href="#l30.35"></a><span id="l30.35">         } else {</span>
<a href="#l30.36"></a><span id="l30.36">             // Disable Lightning</span>
<a href="#l30.37"></a><span id="l30.37">             AddonManager.getAddonByID(&quot;{e2fda1a4-762b-4020-b5ad-a41df1933103}&quot;, function getLightningExt(aAddon) {</span>
<a href="#l30.38"></a><span id="l30.38">                 aAddon.userDisabled = true;</span>
<a href="#l30.39"></a><span id="l30.39" class="difflineminus">-                startup.quit(Components.interfaces.nsIAppStartup.eRestart |</span>
<a href="#l30.40"></a><span id="l30.40" class="difflineplus">+                Services.startup.quit(Components.interfaces.nsIAppStartup.eRestart |</span>
<a href="#l30.41"></a><span id="l30.41">                     Components.interfaces.nsIAppStartup.eForceQuit);</span>
<a href="#l30.42"></a><span id="l30.42">             });</span>
<a href="#l30.43"></a><span id="l30.43">         }</span>
<a href="#l30.44"></a><span id="l30.44">     },</span>
<a href="#l30.45"></a><span id="l30.45"> </span>
<a href="#l30.46"></a><span id="l30.46">     /**</span>
<a href="#l30.47"></a><span id="l30.47">      * calICalendarManager interface</span>
<a href="#l30.48"></a><span id="l30.48">      */</span>
<a href="#l30.49"></a><span id="l30.49" class="difflineat">@@ -517,23 +514,21 @@ calCalendarManager.prototype = {</span>
<a href="#l30.50"></a><span id="l30.50"> </span>
<a href="#l30.51"></a><span id="l30.51">             // Log the possibly translated message via the UI.</span>
<a href="#l30.52"></a><span id="l30.52">             let paramBlock = Components.classes[&quot;@mozilla.org/embedcomp/dialogparam;1&quot;]</span>
<a href="#l30.53"></a><span id="l30.53">                                        .createInstance(Components.interfaces.nsIDialogParamBlock);</span>
<a href="#l30.54"></a><span id="l30.54">             paramBlock.SetNumberStrings(3);</span>
<a href="#l30.55"></a><span id="l30.55">             paramBlock.SetString(0, uiMessage);</span>
<a href="#l30.56"></a><span id="l30.56">             paramBlock.SetString(1, &quot;0x&quot; + rc.toString(0x10));</span>
<a href="#l30.57"></a><span id="l30.57">             paramBlock.SetString(2, ex);</span>
<a href="#l30.58"></a><span id="l30.58" class="difflineminus">-            let wWatcher = Components.classes[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l30.59"></a><span id="l30.59" class="difflineminus">-                                     .getService(Components.interfaces.nsIWindowWatcher);</span>
<a href="#l30.60"></a><span id="l30.60" class="difflineminus">-            wWatcher.openWindow(null,</span>
<a href="#l30.61"></a><span id="l30.61" class="difflineminus">-                                &quot;chrome://calendar/content/calendar-error-prompt.xul&quot;,</span>
<a href="#l30.62"></a><span id="l30.62" class="difflineminus">-                                &quot;_blank&quot;,</span>
<a href="#l30.63"></a><span id="l30.63" class="difflineminus">-                                &quot;chrome,dialog=yes,alwaysRaised=yes&quot;,</span>
<a href="#l30.64"></a><span id="l30.64" class="difflineminus">-                                paramBlock);</span>
<a href="#l30.65"></a><span id="l30.65" class="difflineplus">+            Services.ww.openWindow(null,</span>
<a href="#l30.66"></a><span id="l30.66" class="difflineplus">+                                   &quot;chrome://calendar/content/calendar-error-prompt.xul&quot;,</span>
<a href="#l30.67"></a><span id="l30.67" class="difflineplus">+                                   &quot;_blank&quot;,</span>
<a href="#l30.68"></a><span id="l30.68" class="difflineplus">+                                   &quot;chrome,dialog=yes,alwaysRaised=yes&quot;,</span>
<a href="#l30.69"></a><span id="l30.69" class="difflineplus">+                                   paramBlock);</span>
<a href="#l30.70"></a><span id="l30.70">             return null;</span>
<a href="#l30.71"></a><span id="l30.71">         }</span>
<a href="#l30.72"></a><span id="l30.72">     },</span>
<a href="#l30.73"></a><span id="l30.73"> </span>
<a href="#l30.74"></a><span id="l30.74">     registerCalendar: function(calendar) {</span>
<a href="#l30.75"></a><span id="l30.75">         this.assureCache();</span>
<a href="#l30.76"></a><span id="l30.76"> </span>
<a href="#l30.77"></a><span id="l30.77">         // If the calendar is already registered, bail out</span>
<a href="#l30.78"></a><span id="l30.78" class="difflineat">@@ -914,19 +909,17 @@ calMgrCalendarObserver.prototype = {</span>
<a href="#l30.79"></a><span id="l30.79">         this.onPropertyChanged(aCalendar, aName, false, true);</span>
<a href="#l30.80"></a><span id="l30.80">     },</span>
<a href="#l30.81"></a><span id="l30.81"> </span>
<a href="#l30.82"></a><span id="l30.82">     // Error announcer specific functions</span>
<a href="#l30.83"></a><span id="l30.83">     announceError: function(aCalendar, aErrNo, aMessage) {</span>
<a href="#l30.84"></a><span id="l30.84"> </span>
<a href="#l30.85"></a><span id="l30.85">         var paramBlock = Components.classes[&quot;@mozilla.org/embedcomp/dialogparam;1&quot;]</span>
<a href="#l30.86"></a><span id="l30.86">                                    .createInstance(Components.interfaces.nsIDialogParamBlock);</span>
<a href="#l30.87"></a><span id="l30.87" class="difflineminus">-        var sbs = Components.classes[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l30.88"></a><span id="l30.88" class="difflineminus">-                            .getService(Components.interfaces.nsIStringBundleService);</span>
<a href="#l30.89"></a><span id="l30.89" class="difflineminus">-        var props = sbs.createBundle(&quot;chrome://calendar/locale/calendar.properties&quot;);</span>
<a href="#l30.90"></a><span id="l30.90" class="difflineplus">+        var props = Services.strings.createBundle(&quot;chrome://calendar/locale/calendar.properties&quot;);</span>
<a href="#l30.91"></a><span id="l30.91">         var errMsg;</span>
<a href="#l30.92"></a><span id="l30.92">         paramBlock.SetNumberStrings(3);</span>
<a href="#l30.93"></a><span id="l30.93">         if (!this.storedReadOnly &amp;&amp; this.calendar.readOnly) {</span>
<a href="#l30.94"></a><span id="l30.94">             // Major errors change the calendar to readOnly</span>
<a href="#l30.95"></a><span id="l30.95">             errMsg = props.formatStringFromName(&quot;readOnlyMode&quot;, [this.calendar.name], 1);</span>
<a href="#l30.96"></a><span id="l30.96">         } else if (!this.storedReadOnly &amp;&amp; !this.calendar.readOnly) {</span>
<a href="#l30.97"></a><span id="l30.97">             // Minor errors don't, but still tell the user something went wrong</span>
<a href="#l30.98"></a><span id="l30.98">             errMsg = props.formatStringFromName(&quot;minorError&quot;, [this.calendar.name], 1);</span>
<a href="#l30.99"></a><span id="l30.99" class="difflineat">@@ -990,20 +983,18 @@ calMgrCalendarObserver.prototype = {</span>
<a href="#l30.100"></a><span id="l30.100">                 return;</span>
<a href="#l30.101"></a><span id="l30.101">             }</span>
<a href="#l30.102"></a><span id="l30.102"> </span>
<a href="#l30.103"></a><span id="l30.103">             // this message hasn't been announced recently, remember the</span>
<a href="#l30.104"></a><span id="l30.104">             // details of the message for future reference.</span>
<a href="#l30.105"></a><span id="l30.105">             this.announcedMessages.push(paramBlock);</span>
<a href="#l30.106"></a><span id="l30.106"> </span>
<a href="#l30.107"></a><span id="l30.107">             // Display in prompt window.</span>
<a href="#l30.108"></a><span id="l30.108" class="difflineminus">-            var wWatcher = Components.classes[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l30.109"></a><span id="l30.109" class="difflineminus">-                                  .getService(Components.interfaces.nsIWindowWatcher);</span>
<a href="#l30.110"></a><span id="l30.110">             var promptWindow =</span>
<a href="#l30.111"></a><span id="l30.111" class="difflineminus">-                wWatcher.openWindow</span>
<a href="#l30.112"></a><span id="l30.112" class="difflineplus">+                Services.ww.openWindow</span>
<a href="#l30.113"></a><span id="l30.113">                     (null, &quot;chrome://calendar/content/calendar-error-prompt.xul&quot;,</span>
<a href="#l30.114"></a><span id="l30.114">                      &quot;_blank&quot;, &quot;chrome,dialog=yes,alwaysRaised=yes&quot;,</span>
<a href="#l30.115"></a><span id="l30.115">                      paramBlock);</span>
<a href="#l30.116"></a><span id="l30.116">             // Will remove paramBlock from announced messages when</span>
<a href="#l30.117"></a><span id="l30.117">             // promptWindow is closed.  (Closing fires unloaded event, but</span>
<a href="#l30.118"></a><span id="l30.118">             // promptWindow is also unloaded [to clean it?] before loading,</span>
<a href="#l30.119"></a><span id="l30.119">             // so wait for detected load event before detecting unload event</span>
<a href="#l30.120"></a><span id="l30.120">             // that signifies user closed this prompt window.)</span>
<a href="#l30.121"></a><span id="l30.121" class="difflineat">@@ -1058,19 +1049,17 @@ function getPrefBranchFor(id) {</span>
<a href="#l30.122"></a><span id="l30.122"> }</span>
<a href="#l30.123"></a><span id="l30.123"> </span>
<a href="#l30.124"></a><span id="l30.124"> /**</span>
<a href="#l30.125"></a><span id="l30.125">  * Helper function to flush the preferences file. If the application crashes</span>
<a href="#l30.126"></a><span id="l30.126">  * after a calendar has been created using the prefs registry, then the calendar</span>
<a href="#l30.127"></a><span id="l30.127">  * won't show up. Writing the prefs helps counteract.</span>
<a href="#l30.128"></a><span id="l30.128">  */</span>
<a href="#l30.129"></a><span id="l30.129"> function flushPrefs() {</span>
<a href="#l30.130"></a><span id="l30.130" class="difflineminus">-    Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l30.131"></a><span id="l30.131" class="difflineminus">-              .getService(Components.interfaces.nsIPrefService)</span>
<a href="#l30.132"></a><span id="l30.132" class="difflineminus">-              .savePrefFile(null);</span>
<a href="#l30.133"></a><span id="l30.133" class="difflineplus">+    Services.prefs.savePrefFile(null);</span>
<a href="#l30.134"></a><span id="l30.134"> }</span>
<a href="#l30.135"></a><span id="l30.135"> </span>
<a href="#l30.136"></a><span id="l30.136"> /**</span>
<a href="#l30.137"></a><span id="l30.137">  * Callback object for the refresh timer. Should be called as an object, i.e</span>
<a href="#l30.138"></a><span id="l30.138">  * let foo = new timerCallback(calendar);</span>
<a href="#l30.139"></a><span id="l30.139">  *</span>
<a href="#l30.140"></a><span id="l30.140">  * @param aCalendar     The calendar to refresh on notification</span>
<a href="#l30.141"></a><span id="l30.141">  */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/calendar/base/src/calDateTimeFormatter.js</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/calendar/base/src/calDateTimeFormatter.js</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -1,19 +1,18 @@</span>
<a href="#l31.4"></a><span id="l31.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l31.5"></a><span id="l31.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l31.6"></a><span id="l31.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l31.7"></a><span id="l31.7"> </span>
<a href="#l31.8"></a><span id="l31.8" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l31.9"></a><span id="l31.9" class="difflineplus">+</span>
<a href="#l31.10"></a><span id="l31.10"> const nsIScriptableDateFormat = Components.interfaces.nsIScriptableDateFormat;</span>
<a href="#l31.11"></a><span id="l31.11"> </span>
<a href="#l31.12"></a><span id="l31.12"> function calDateTimeFormatter() {</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineminus">-    var strBundleService =</span>
<a href="#l31.14"></a><span id="l31.14" class="difflineminus">-        Components.classes[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l31.15"></a><span id="l31.15" class="difflineminus">-                  .getService(Components.interfaces.nsIStringBundleService);</span>
<a href="#l31.16"></a><span id="l31.16" class="difflineminus">-    this.mDateStringBundle =  strBundleService.createBundle(&quot;chrome://calendar/locale/dateFormat.properties&quot;);</span>
<a href="#l31.17"></a><span id="l31.17" class="difflineplus">+    this.mDateStringBundle = Services.strings.createBundle(&quot;chrome://calendar/locale/dateFormat.properties&quot;);</span>
<a href="#l31.18"></a><span id="l31.18"> </span>
<a href="#l31.19"></a><span id="l31.19">     this.mDateService =</span>
<a href="#l31.20"></a><span id="l31.20">         Components.classes[&quot;@mozilla.org/intl/scriptabledateformat;1&quot;]</span>
<a href="#l31.21"></a><span id="l31.21">                   .getService(nsIScriptableDateFormat);</span>
<a href="#l31.22"></a><span id="l31.22"> </span>
<a href="#l31.23"></a><span id="l31.23">     // Do does the month or day come first in this locale?</span>
<a href="#l31.24"></a><span id="l31.24">     this.mMonthFirst = false;</span>
<a href="#l31.25"></a><span id="l31.25"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/calendar/base/src/calProtocolHandler.js</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/calendar/base/src/calProtocolHandler.js</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -1,12 +1,13 @@</span>
<a href="#l32.4"></a><span id="l32.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l32.5"></a><span id="l32.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l32.6"></a><span id="l32.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l32.7"></a><span id="l32.7"> </span>
<a href="#l32.8"></a><span id="l32.8" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l32.9"></a><span id="l32.9"> </span>
<a href="#l32.10"></a><span id="l32.10"> /** Constructor for webcal: protocol handler */</span>
<a href="#l32.11"></a><span id="l32.11"> function calProtocolHandlerWebcal() {</span>
<a href="#l32.12"></a><span id="l32.12">     calProtocolHandler.call(this, &quot;webcal&quot;);</span>
<a href="#l32.13"></a><span id="l32.13"> }</span>
<a href="#l32.14"></a><span id="l32.14"> </span>
<a href="#l32.15"></a><span id="l32.15"> /** Constructor for webcals: protocl handler */</span>
<a href="#l32.16"></a><span id="l32.16"> function calProtocolHandlerWebcals() {</span>
<a href="#l32.17"></a><span id="l32.17" class="difflineat">@@ -15,17 +16,17 @@ function calProtocolHandlerWebcals() {</span>
<a href="#l32.18"></a><span id="l32.18"> </span>
<a href="#l32.19"></a><span id="l32.19"> /**</span>
<a href="#l32.20"></a><span id="l32.20">  * Generic webcal constructor</span>
<a href="#l32.21"></a><span id="l32.21">  *</span>
<a href="#l32.22"></a><span id="l32.22">  * @param scheme        The scheme to init for (webcal, webcals)</span>
<a href="#l32.23"></a><span id="l32.23">  */</span>
<a href="#l32.24"></a><span id="l32.24"> function calProtocolHandler(scheme) {</span>
<a href="#l32.25"></a><span id="l32.25">     this.scheme = scheme;</span>
<a href="#l32.26"></a><span id="l32.26" class="difflineminus">-    this.mHttpProtocol = cal.getIOService().getProtocolHandler(this.scheme == &quot;webcal&quot; ? &quot;http&quot; : &quot;https&quot;);</span>
<a href="#l32.27"></a><span id="l32.27" class="difflineplus">+    this.mHttpProtocol = Services.io.getProtocolHandler(this.scheme == &quot;webcal&quot; ? &quot;http&quot; : &quot;https&quot;);</span>
<a href="#l32.28"></a><span id="l32.28"> }</span>
<a href="#l32.29"></a><span id="l32.29"> </span>
<a href="#l32.30"></a><span id="l32.30"> calProtocolHandler.prototype = {</span>
<a href="#l32.31"></a><span id="l32.31">     getInterfaces: function cP_getInterfaces(aCount) {</span>
<a href="#l32.32"></a><span id="l32.32">         const interfaces = [Components.interfaces.nsIProtocolHandler,</span>
<a href="#l32.33"></a><span id="l32.33">                             Components.interfaces.nsIClassInfo,</span>
<a href="#l32.34"></a><span id="l32.34">                             Components.interfaces.nsISupports];</span>
<a href="#l32.35"></a><span id="l32.35"> </span>
<a href="#l32.36"></a><span id="l32.36" class="difflineat">@@ -61,17 +62,17 @@ calProtocolHandler.prototype = {</span>
<a href="#l32.37"></a><span id="l32.37">     },</span>
<a href="#l32.38"></a><span id="l32.38">     </span>
<a href="#l32.39"></a><span id="l32.39">     newChannel: function cph_newChannel(aUri) {</span>
<a href="#l32.40"></a><span id="l32.40">         // make sure to clone the uri, because we are about to change</span>
<a href="#l32.41"></a><span id="l32.41">         // it, and we don't want to change the original uri.</span>
<a href="#l32.42"></a><span id="l32.42">         var uri = aUri.clone();</span>
<a href="#l32.43"></a><span id="l32.43">         uri.scheme = this.mHttpProtocol.scheme;</span>
<a href="#l32.44"></a><span id="l32.44"> </span>
<a href="#l32.45"></a><span id="l32.45" class="difflineminus">-        var channel = getIOService().newChannelFromURI(uri, null);</span>
<a href="#l32.46"></a><span id="l32.46" class="difflineplus">+        var channel = Services.io.newChannelFromURI(uri, null);</span>
<a href="#l32.47"></a><span id="l32.47">         channel.originalURI = aUri;</span>
<a href="#l32.48"></a><span id="l32.48">         return channel;</span>
<a href="#l32.49"></a><span id="l32.49">     },</span>
<a href="#l32.50"></a><span id="l32.50">     </span>
<a href="#l32.51"></a><span id="l32.51">     allowPort: function cph_allowPort(aPort, aScheme) {</span>
<a href="#l32.52"></a><span id="l32.52">         // We are not overriding any special ports</span>
<a href="#l32.53"></a><span id="l32.53">         return false;</span>
<a href="#l32.54"></a><span id="l32.54">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/calendar/base/src/calTimezoneService.js</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/calendar/base/src/calTimezoneService.js</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -156,19 +156,17 @@ calTimezoneService.prototype = {</span>
<a href="#l33.4"></a><span id="l33.4">         if (!this.mSelectByTzid) {</span>
<a href="#l33.5"></a><span id="l33.5">             this.initialize(aCompleteListener);</span>
<a href="#l33.6"></a><span id="l33.6">         }</span>
<a href="#l33.7"></a><span id="l33.7">     },</span>
<a href="#l33.8"></a><span id="l33.8"> </span>
<a href="#l33.9"></a><span id="l33.9">     _initDB: function _initDB(sqlTzFile) {</span>
<a href="#l33.10"></a><span id="l33.10">         try {</span>
<a href="#l33.11"></a><span id="l33.11">             cal.LOG(&quot;[calTimezoneService] using &quot; + sqlTzFile.path);</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-            let dbService = Components.classes[&quot;@mozilla.org/storage/service;1&quot;]</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineminus">-                                      .getService(Components.interfaces.mozIStorageService);</span>
<a href="#l33.14"></a><span id="l33.14" class="difflineminus">-            this.mDb = dbService.openDatabase(sqlTzFile);</span>
<a href="#l33.15"></a><span id="l33.15" class="difflineplus">+            this.mDb = Services.storage.openDatabase(sqlTzFile);</span>
<a href="#l33.16"></a><span id="l33.16">             if (this.mDb) {</span>
<a href="#l33.17"></a><span id="l33.17">                 this.mSelectByTzid = this.mDb.createStatement(&quot;SELECT * FROM tz_data WHERE tzid = :tzid LIMIT 1&quot;);</span>
<a href="#l33.18"></a><span id="l33.18"> </span>
<a href="#l33.19"></a><span id="l33.19">                 let selectVersion = this.mDb.createStatement(&quot;SELECT version FROM tz_version LIMIT 1&quot;);</span>
<a href="#l33.20"></a><span id="l33.20">                 try {</span>
<a href="#l33.21"></a><span id="l33.21">                     if (selectVersion.executeStep()) {</span>
<a href="#l33.22"></a><span id="l33.22">                         this.mVersion = selectVersion.row.version;</span>
<a href="#l33.23"></a><span id="l33.23">                     }</span>
<a href="#l33.24"></a><span id="l33.24" class="difflineat">@@ -185,22 +183,22 @@ calTimezoneService.prototype = {</span>
<a href="#l33.25"></a><span id="l33.25">     },</span>
<a href="#l33.26"></a><span id="l33.26"> </span>
<a href="#l33.27"></a><span id="l33.27">     initialize: function calTimezoneService_initialize(aCompleteListener) {</span>
<a href="#l33.28"></a><span id="l33.28">         // Helper function to convert an nsIURI to a nsIFile</span>
<a href="#l33.29"></a><span id="l33.29">         function toFile(uriSpec) {</span>
<a href="#l33.30"></a><span id="l33.30">             let uri = cal.makeURL(uriSpec);</span>
<a href="#l33.31"></a><span id="l33.31"> </span>
<a href="#l33.32"></a><span id="l33.32">             if (uri.schemeIs(&quot;file&quot;)) {</span>
<a href="#l33.33"></a><span id="l33.33" class="difflineminus">-                let handler = cal.getIOService().getProtocolHandler(&quot;file&quot;)</span>
<a href="#l33.34"></a><span id="l33.34" class="difflineminus">-                                 .QueryInterface(Components.interfaces.nsIFileProtocolHandler);</span>
<a href="#l33.35"></a><span id="l33.35" class="difflineplus">+                let handler = Services.io.getProtocolHandler(&quot;file&quot;)</span>
<a href="#l33.36"></a><span id="l33.36" class="difflineplus">+                                      .QueryInterface(Components.interfaces.nsIFileProtocolHandler);</span>
<a href="#l33.37"></a><span id="l33.37">                 return handler.getFileFromURLSpec(uri.spec);</span>
<a href="#l33.38"></a><span id="l33.38">             } else if (uri.schemeIs(&quot;resource&quot;)) {</span>
<a href="#l33.39"></a><span id="l33.39" class="difflineminus">-                let handler = cal.getIOService().getProtocolHandler(&quot;resource&quot;)</span>
<a href="#l33.40"></a><span id="l33.40" class="difflineminus">-                                 .QueryInterface(Components.interfaces.nsIResProtocolHandler);</span>
<a href="#l33.41"></a><span id="l33.41" class="difflineplus">+                let handler = Services.io.getProtocolHandler(&quot;resource&quot;)</span>
<a href="#l33.42"></a><span id="l33.42" class="difflineplus">+                                      .QueryInterface(Components.interfaces.nsIResProtocolHandler);</span>
<a href="#l33.43"></a><span id="l33.43">                 let newUriSpec;</span>
<a href="#l33.44"></a><span id="l33.44">                 try {</span>
<a href="#l33.45"></a><span id="l33.45">                     newUriSpec = handler.resolveURI(uri);</span>
<a href="#l33.46"></a><span id="l33.46">                 } catch (e) {</span>
<a href="#l33.47"></a><span id="l33.47">                     // Possibly the resource location is not registered, return</span>
<a href="#l33.48"></a><span id="l33.48">                     // null to indicate error</span>
<a href="#l33.49"></a><span id="l33.49">                     return null;</span>
<a href="#l33.50"></a><span id="l33.50">                 }</span>
<a href="#l33.51"></a><span id="l33.51" class="difflineat">@@ -231,17 +229,17 @@ calTimezoneService.prototype = {</span>
<a href="#l33.52"></a><span id="l33.52">         if (!canInit) {</span>
<a href="#l33.53"></a><span id="l33.53">             // If that fails, we might have the file bundled</span>
<a href="#l33.54"></a><span id="l33.54">             canInit = tryTzUri(&quot;resource://calendar/timezones.sqlite&quot;);</span>
<a href="#l33.55"></a><span id="l33.55">             bundleURL = &quot;chrome://calendar/locale/timezones.properties&quot;</span>
<a href="#l33.56"></a><span id="l33.56">         }</span>
<a href="#l33.57"></a><span id="l33.57"> </span>
<a href="#l33.58"></a><span id="l33.58">         if (canInit) {</span>
<a href="#l33.59"></a><span id="l33.59">             // Seems like a success, make the bundle url global</span>
<a href="#l33.60"></a><span id="l33.60" class="difflineminus">-            g_stringBundle = cal.calGetStringBundle(bundleURL);</span>
<a href="#l33.61"></a><span id="l33.61" class="difflineplus">+            g_stringBundle = Services.strings.createBundle(bundleURL);</span>
<a href="#l33.62"></a><span id="l33.62">         } else {</span>
<a href="#l33.63"></a><span id="l33.63">             // Otherwise, we have to give up. Show an error and fail hard!</span>
<a href="#l33.64"></a><span id="l33.64">             let msg = cal.calGetString(&quot;calendar&quot;, &quot;missingCalendarTimezonesError&quot;);</span>
<a href="#l33.65"></a><span id="l33.65">             cal.ERROR(msg);</span>
<a href="#l33.66"></a><span id="l33.66">             cal.showError(msg);</span>
<a href="#l33.67"></a><span id="l33.67">         }</span>
<a href="#l33.68"></a><span id="l33.68"> </span>
<a href="#l33.69"></a><span id="l33.69">         // Make sure UTC and floating are cached by calling their getters</span>
<a href="#l33.70"></a><span id="l33.70" class="difflineat">@@ -574,17 +572,17 @@ function guessSystemTimezone() {</span>
<a href="#l33.71"></a><span id="l33.71">     }</span>
<a href="#l33.72"></a><span id="l33.72"> </span>
<a href="#l33.73"></a><span id="l33.73">     // Try to find a tz that matches OS/JSDate timezone.  If no name match,</span>
<a href="#l33.74"></a><span id="l33.74">     // will use first of probable timezone(s) with highest score.</span>
<a href="#l33.75"></a><span id="l33.75">     var probableTZId = &quot;floating&quot;; // default fallback tz if no tz matches.</span>
<a href="#l33.76"></a><span id="l33.76">     var probableTZScore = 0;</span>
<a href="#l33.77"></a><span id="l33.77">     var probableTZSource = null;</span>
<a href="#l33.78"></a><span id="l33.78"> </span>
<a href="#l33.79"></a><span id="l33.79" class="difflineminus">-    const calProperties = cal.calGetStringBundle(&quot;chrome://calendar/locale/calendar.properties&quot;);</span>
<a href="#l33.80"></a><span id="l33.80" class="difflineplus">+    const calProperties = Services.strings.createBundle(&quot;chrome://calendar/locale/calendar.properties&quot;);</span>
<a href="#l33.81"></a><span id="l33.81"> </span>
<a href="#l33.82"></a><span id="l33.82">     // First, try to detect operating system timezone.</span>
<a href="#l33.83"></a><span id="l33.83">     try {</span>
<a href="#l33.84"></a><span id="l33.84">         var osUserTimeZone = null;</span>
<a href="#l33.85"></a><span id="l33.85">         var zoneInfoIdFromOSUserTimeZone = null;</span>
<a href="#l33.86"></a><span id="l33.86">         var handler = Components.classes[&quot;@mozilla.org/network/protocol;1?name=http&quot;]</span>
<a href="#l33.87"></a><span id="l33.87">                                 .getService(Components.interfaces.nsIHttpProtocolHandler);</span>
<a href="#l33.88"></a><span id="l33.88"> </span>
<a href="#l33.89"></a><span id="l33.89" class="difflineat">@@ -633,18 +631,18 @@ function guessSystemTimezone() {</span>
<a href="#l33.90"></a><span id="l33.90">                 break;</span>
<a href="#l33.91"></a><span id="l33.91">               }</span>
<a href="#l33.92"></a><span id="l33.92">             }</span>
<a href="#l33.93"></a><span id="l33.93">             wrk.close();</span>
<a href="#l33.94"></a><span id="l33.94"> </span>
<a href="#l33.95"></a><span id="l33.95">             if (osUserTimeZone != null) {</span>
<a href="#l33.96"></a><span id="l33.96">                 // Lookup timezone registry key in table of known tz keys</span>
<a href="#l33.97"></a><span id="l33.97">                 // to convert to ZoneInfo timezone id.</span>
<a href="#l33.98"></a><span id="l33.98" class="difflineminus">-                const regKeyToZoneInfoBundle = cal.calGetStringBundle(&quot;chrome://calendar/content/&quot;+</span>
<a href="#l33.99"></a><span id="l33.99" class="difflineminus">-                                                                      fileOSName + &quot;ToZoneInfoTZId.properties&quot;);</span>
<a href="#l33.100"></a><span id="l33.100" class="difflineplus">+                const regKeyToZoneInfoBundle = Services.strings.createBundle(&quot;chrome://calendar/content/&quot;+</span>
<a href="#l33.101"></a><span id="l33.101" class="difflineplus">+                                                                             fileOSName + &quot;ToZoneInfoTZId.properties&quot;);</span>
<a href="#l33.102"></a><span id="l33.102">                 zoneInfoIdFromOSUserTimeZone =</span>
<a href="#l33.103"></a><span id="l33.103">                     regKeyToZoneInfoBundle.GetStringFromName(osUserTimeZone);</span>
<a href="#l33.104"></a><span id="l33.104">             }</span>
<a href="#l33.105"></a><span id="l33.105">         } else {</span>
<a href="#l33.106"></a><span id="l33.106">             // Else look for ZoneInfo timezone id in</span>
<a href="#l33.107"></a><span id="l33.107">             // - TZ environment variable value</span>
<a href="#l33.108"></a><span id="l33.108">             // - /etc/localtime symbolic link target path</span>
<a href="#l33.109"></a><span id="l33.109">             // - /etc/TIMEZONE or /etc/timezone file content</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/calendar/base/src/calUtils.js</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/calendar/base/src/calUtils.js</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -2,17 +2,17 @@</span>
<a href="#l34.4"></a><span id="l34.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l34.5"></a><span id="l34.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l34.6"></a><span id="l34.6"> </span>
<a href="#l34.7"></a><span id="l34.7"> /* This file contains commonly used functions in a centralized place so that</span>
<a href="#l34.8"></a><span id="l34.8">  * various components (and other js scopes) don't need to replicate them. Note</span>
<a href="#l34.9"></a><span id="l34.9">  * that loading this file twice in the same scope will throw errors.</span>
<a href="#l34.10"></a><span id="l34.10">  */</span>
<a href="#l34.11"></a><span id="l34.11"> </span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-Components.utils.import(&quot;resource:///modules/Services.jsm&quot;);</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l34.14"></a><span id="l34.14"> </span>
<a href="#l34.15"></a><span id="l34.15"> function _calIcalCreator(cid, iid) {</span>
<a href="#l34.16"></a><span id="l34.16">     return function(icalString) {</span>
<a href="#l34.17"></a><span id="l34.17">         let thing = Components.classes[cid].createInstance(iid);</span>
<a href="#l34.18"></a><span id="l34.18">         if (icalString) {</span>
<a href="#l34.19"></a><span id="l34.19">             thing.icalString = icalString;</span>
<a href="#l34.20"></a><span id="l34.20">         }</span>
<a href="#l34.21"></a><span id="l34.21">         return thing;</span>
<a href="#l34.22"></a><span id="l34.22" class="difflineat">@@ -43,34 +43,22 @@ let createRecurrenceRule = _calIcalCreat</span>
<a href="#l34.23"></a><span id="l34.23"> /* Returns a clean new calIRecurrenceInfo */</span>
<a href="#l34.24"></a><span id="l34.24"> function createRecurrenceInfo(aItem) {</span>
<a href="#l34.25"></a><span id="l34.25">     var recInfo = Components.classes[&quot;@mozilla.org/calendar/recurrence-info;1&quot;].</span>
<a href="#l34.26"></a><span id="l34.26">            createInstance(Components.interfaces.calIRecurrenceInfo);</span>
<a href="#l34.27"></a><span id="l34.27">     recInfo.item = aItem;</span>
<a href="#l34.28"></a><span id="l34.28">     return recInfo;</span>
<a href="#l34.29"></a><span id="l34.29"> }</span>
<a href="#l34.30"></a><span id="l34.30"> </span>
<a href="#l34.31"></a><span id="l34.31" class="difflineminus">-/* Shortcut to the console service */</span>
<a href="#l34.32"></a><span id="l34.32" class="difflineminus">-function getConsoleService() {</span>
<a href="#l34.33"></a><span id="l34.33" class="difflineminus">-    return Components.classes[&quot;@mozilla.org/consoleservice;1&quot;]</span>
<a href="#l34.34"></a><span id="l34.34" class="difflineminus">-                     .getService(Components.interfaces.nsIConsoleService);</span>
<a href="#l34.35"></a><span id="l34.35" class="difflineminus">-}</span>
<a href="#l34.36"></a><span id="l34.36" class="difflineminus">-</span>
<a href="#l34.37"></a><span id="l34.37"> /* Shortcut to the account manager service */</span>
<a href="#l34.38"></a><span id="l34.38"> function getAccountManager() {</span>
<a href="#l34.39"></a><span id="l34.39">     return Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l34.40"></a><span id="l34.40">                      .getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l34.41"></a><span id="l34.41"> }</span>
<a href="#l34.42"></a><span id="l34.42"> </span>
<a href="#l34.43"></a><span id="l34.43" class="difflineminus">-/* Shortcut to the IO service */</span>
<a href="#l34.44"></a><span id="l34.44" class="difflineminus">-function getIOService() {</span>
<a href="#l34.45"></a><span id="l34.45" class="difflineminus">-    return Components.classes[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l34.46"></a><span id="l34.46" class="difflineminus">-                     .getService(Components.interfaces.nsIIOService);</span>
<a href="#l34.47"></a><span id="l34.47" class="difflineminus">-}</span>
<a href="#l34.48"></a><span id="l34.48" class="difflineminus">-</span>
<a href="#l34.49"></a><span id="l34.49"> /* Shortcut to the calendar-manager service */</span>
<a href="#l34.50"></a><span id="l34.50"> function getCalendarManager() {</span>
<a href="#l34.51"></a><span id="l34.51">     return Components.classes[&quot;@mozilla.org/calendar/manager;1&quot;]</span>
<a href="#l34.52"></a><span id="l34.52">                      .getService(Components.interfaces.calICalendarManager);</span>
<a href="#l34.53"></a><span id="l34.53"> }</span>
<a href="#l34.54"></a><span id="l34.54"> </span>
<a href="#l34.55"></a><span id="l34.55"> /* Shortcut to the ICS service */</span>
<a href="#l34.56"></a><span id="l34.56"> function getIcsService() {</span>
<a href="#l34.57"></a><span id="l34.57" class="difflineat">@@ -227,19 +215,17 @@ function formatStringForCSSRule(aString)</span>
<a href="#l34.58"></a><span id="l34.58"> }</span>
<a href="#l34.59"></a><span id="l34.59"> </span>
<a href="#l34.60"></a><span id="l34.60"> /**</span>
<a href="#l34.61"></a><span id="l34.61">  * Shared dialog functions</span>
<a href="#l34.62"></a><span id="l34.62">  * Gets the calendar directory, defaults to &lt;profile-dir&gt;/calendar</span>
<a href="#l34.63"></a><span id="l34.63">  */</span>
<a href="#l34.64"></a><span id="l34.64"> function getCalendarDirectory() {</span>
<a href="#l34.65"></a><span id="l34.65">     if (getCalendarDirectory.mDir === undefined) {</span>
<a href="#l34.66"></a><span id="l34.66" class="difflineminus">-        var dirSvc = Components.classes[&quot;@mozilla.org/file/directory_service;1&quot;]</span>
<a href="#l34.67"></a><span id="l34.67" class="difflineminus">-                               .getService(Components.interfaces.nsIProperties);</span>
<a href="#l34.68"></a><span id="l34.68" class="difflineminus">-        var dir = dirSvc.get(&quot;ProfD&quot;, Components.interfaces.nsILocalFile);</span>
<a href="#l34.69"></a><span id="l34.69" class="difflineplus">+        var dir = Services.dirsvc.get(&quot;ProfD&quot;, Components.interfaces.nsILocalFile);</span>
<a href="#l34.70"></a><span id="l34.70">         dir.append(&quot;calendar-data&quot;);</span>
<a href="#l34.71"></a><span id="l34.71">         if (!dir.exists()) {</span>
<a href="#l34.72"></a><span id="l34.72">             try {</span>
<a href="#l34.73"></a><span id="l34.73">                 dir.create(Components.interfaces.nsIFile.DIRECTORY_TYPE,</span>
<a href="#l34.74"></a><span id="l34.74">                            parseInt(&quot;0700&quot;, 8));</span>
<a href="#l34.75"></a><span id="l34.75">             } catch (exc) {</span>
<a href="#l34.76"></a><span id="l34.76">                 ASSERT(false, exc);</span>
<a href="#l34.77"></a><span id="l34.77">                 throw exc;</span>
<a href="#l34.78"></a><span id="l34.78" class="difflineat">@@ -256,17 +242,17 @@ function getCalendarDirectory() {</span>
<a href="#l34.79"></a><span id="l34.79">  * local.</span>
<a href="#l34.80"></a><span id="l34.80">  *</span>
<a href="#l34.81"></a><span id="l34.81">  * @param aCalendar     The calendar to check</span>
<a href="#l34.82"></a><span id="l34.82">  * @return              True if the calendar is writable</span>
<a href="#l34.83"></a><span id="l34.83">  */</span>
<a href="#l34.84"></a><span id="l34.84"> function isCalendarWritable(aCalendar) {</span>
<a href="#l34.85"></a><span id="l34.85">     return (!aCalendar.getProperty(&quot;disabled&quot;) &amp;&amp;</span>
<a href="#l34.86"></a><span id="l34.86">             !aCalendar.readOnly &amp;&amp;</span>
<a href="#l34.87"></a><span id="l34.87" class="difflineminus">-            (!getIOService().offline ||</span>
<a href="#l34.88"></a><span id="l34.88" class="difflineplus">+            (!Services.io.offline ||</span>
<a href="#l34.89"></a><span id="l34.89">              aCalendar.getProperty(&quot;cache.enabled&quot;) ||</span>
<a href="#l34.90"></a><span id="l34.90">              aCalendar.getProperty(&quot;cache.always&quot;) ||</span>
<a href="#l34.91"></a><span id="l34.91">              aCalendar.getProperty(&quot;requiresNetwork&quot;) === false));</span>
<a href="#l34.92"></a><span id="l34.92"> }</span>
<a href="#l34.93"></a><span id="l34.93"> </span>
<a href="#l34.94"></a><span id="l34.94"> /**</span>
<a href="#l34.95"></a><span id="l34.95">  * Check if the specified calendar is writable from an ACL point of view.</span>
<a href="#l34.96"></a><span id="l34.96">  *</span>
<a href="#l34.97"></a><span id="l34.97" class="difflineat">@@ -371,17 +357,17 @@ function calPrint() {</span>
<a href="#l34.98"></a><span id="l34.98"> /**</span>
<a href="#l34.99"></a><span id="l34.99">  * Takes a string and returns an nsIURI</span>
<a href="#l34.100"></a><span id="l34.100">  *</span>
<a href="#l34.101"></a><span id="l34.101">  * @param aUriString  the string of the address to for the spec of the nsIURI</span>
<a href="#l34.102"></a><span id="l34.102">  *</span>
<a href="#l34.103"></a><span id="l34.103">  * @returns  an nsIURI whose spec is aUriString</span>
<a href="#l34.104"></a><span id="l34.104">  */</span>
<a href="#l34.105"></a><span id="l34.105"> function makeURL(aUriString) {</span>
<a href="#l34.106"></a><span id="l34.106" class="difflineminus">-    return getIOService().newURI(aUriString, null, null);</span>
<a href="#l34.107"></a><span id="l34.107" class="difflineplus">+    return Services.io.newURI(aUriString, null, null);</span>
<a href="#l34.108"></a><span id="l34.108"> }</span>
<a href="#l34.109"></a><span id="l34.109"> </span>
<a href="#l34.110"></a><span id="l34.110"> /**</span>
<a href="#l34.111"></a><span id="l34.111">  * Returns a calIDateTime that corresponds to the current time in the user's</span>
<a href="#l34.112"></a><span id="l34.112">  * default timezone.</span>
<a href="#l34.113"></a><span id="l34.113">  */</span>
<a href="#l34.114"></a><span id="l34.114"> function now() {</span>
<a href="#l34.115"></a><span id="l34.115">     var d = createDateTime();</span>
<a href="#l34.116"></a><span id="l34.116" class="difflineat">@@ -497,18 +483,17 @@ function isToDo(aObject) {</span>
<a href="#l34.117"></a><span id="l34.117">  * will get a bool, int, or string pref.  If the pref is undefined, it will</span>
<a href="#l34.118"></a><span id="l34.118">  * return aDefault.</span>
<a href="#l34.119"></a><span id="l34.119">  *</span>
<a href="#l34.120"></a><span id="l34.120">  * @param aPrefName   the (full) name of preference to get</span>
<a href="#l34.121"></a><span id="l34.121">  * @param aDefault    (optional) the value to return if the pref is undefined</span>
<a href="#l34.122"></a><span id="l34.122">  */</span>
<a href="#l34.123"></a><span id="l34.123"> function getPrefSafe(aPrefName, aDefault) {</span>
<a href="#l34.124"></a><span id="l34.124">     const nsIPrefBranch = Components.interfaces.nsIPrefBranch;</span>
<a href="#l34.125"></a><span id="l34.125" class="difflineminus">-    const prefB = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l34.126"></a><span id="l34.126" class="difflineminus">-                            .getService(nsIPrefBranch);</span>
<a href="#l34.127"></a><span id="l34.127" class="difflineplus">+    const prefB = Services.prefs;</span>
<a href="#l34.128"></a><span id="l34.128">     // Since bug 193332 does not fix the current branch, calling get*Pref will</span>
<a href="#l34.129"></a><span id="l34.129">     // throw NS_ERROR_UNEXPECTED if clearUserPref() was called and there is no</span>
<a href="#l34.130"></a><span id="l34.130">     // default value. To work around that, catch the exception.</span>
<a href="#l34.131"></a><span id="l34.131">     try {</span>
<a href="#l34.132"></a><span id="l34.132">         switch (prefB.getPrefType(aPrefName)) {</span>
<a href="#l34.133"></a><span id="l34.133">             case nsIPrefBranch.PREF_BOOL:</span>
<a href="#l34.134"></a><span id="l34.134">                 return prefB.getBoolPref(aPrefName);</span>
<a href="#l34.135"></a><span id="l34.135">             case nsIPrefBranch.PREF_INT:</span>
<a href="#l34.136"></a><span id="l34.136" class="difflineat">@@ -540,58 +525,52 @@ function setPref(aPrefName, aPrefValue, </span>
<a href="#l34.137"></a><span id="l34.137">             case &quot;number&quot;: // xxx think: includes non-int numbers, too</span>
<a href="#l34.138"></a><span id="l34.138">                 aPrefType = &quot;INT&quot;;</span>
<a href="#l34.139"></a><span id="l34.139">                 break;</span>
<a href="#l34.140"></a><span id="l34.140">             default:</span>
<a href="#l34.141"></a><span id="l34.141">                 aPrefType = &quot;CHAR&quot;;</span>
<a href="#l34.142"></a><span id="l34.142">                 break;</span>
<a href="#l34.143"></a><span id="l34.143">         }</span>
<a href="#l34.144"></a><span id="l34.144">     }</span>
<a href="#l34.145"></a><span id="l34.145" class="difflineminus">-    let prefB = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l34.146"></a><span id="l34.146" class="difflineminus">-                          .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l34.147"></a><span id="l34.147">     switch (aPrefType) {</span>
<a href="#l34.148"></a><span id="l34.148">         case &quot;BOOL&quot;:</span>
<a href="#l34.149"></a><span id="l34.149" class="difflineminus">-            prefB.setBoolPref(aPrefName, aPrefValue);</span>
<a href="#l34.150"></a><span id="l34.150" class="difflineplus">+            Services.prefs.setBoolPref(aPrefName, aPrefValue);</span>
<a href="#l34.151"></a><span id="l34.151">             break;</span>
<a href="#l34.152"></a><span id="l34.152">         case &quot;INT&quot;:</span>
<a href="#l34.153"></a><span id="l34.153" class="difflineminus">-            prefB.setIntPref(aPrefName, aPrefValue);</span>
<a href="#l34.154"></a><span id="l34.154" class="difflineplus">+            Services.prefs.setIntPref(aPrefName, aPrefValue);</span>
<a href="#l34.155"></a><span id="l34.155">             break;</span>
<a href="#l34.156"></a><span id="l34.156">         case &quot;CHAR&quot;:</span>
<a href="#l34.157"></a><span id="l34.157" class="difflineminus">-            prefB.setCharPref(aPrefName, aPrefValue);</span>
<a href="#l34.158"></a><span id="l34.158" class="difflineplus">+            Services.prefs.setCharPref(aPrefName, aPrefValue);</span>
<a href="#l34.159"></a><span id="l34.159">             break;</span>
<a href="#l34.160"></a><span id="l34.160">     }</span>
<a href="#l34.161"></a><span id="l34.161"> }</span>
<a href="#l34.162"></a><span id="l34.162"> </span>
<a href="#l34.163"></a><span id="l34.163"> /**</span>
<a href="#l34.164"></a><span id="l34.164">  * Helper function to set a localized (complex) pref from a given string</span>
<a href="#l34.165"></a><span id="l34.165">  *</span>
<a href="#l34.166"></a><span id="l34.166">  * @param aPrefName   the (full) name of preference to set</span>
<a href="#l34.167"></a><span id="l34.167">  * @param aString     the string to which the preference value should be set</span>
<a href="#l34.168"></a><span id="l34.168">  */</span>
<a href="#l34.169"></a><span id="l34.169"> function setLocalizedPref(aPrefName, aString) {</span>
<a href="#l34.170"></a><span id="l34.170" class="difflineminus">-    const prefB = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;].</span>
<a href="#l34.171"></a><span id="l34.171" class="difflineminus">-                  getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l34.172"></a><span id="l34.172">     var str = Components.classes[&quot;@mozilla.org/supports-string;1&quot;].</span>
<a href="#l34.173"></a><span id="l34.173">               createInstance(Components.interfaces.nsISupportsString);</span>
<a href="#l34.174"></a><span id="l34.174">     str.data = aString;</span>
<a href="#l34.175"></a><span id="l34.175" class="difflineminus">-    prefB.setComplexValue(aPrefName, Components.interfaces.nsISupportsString, str);</span>
<a href="#l34.176"></a><span id="l34.176" class="difflineplus">+    Services.prefs.setComplexValue(aPrefName, Components.interfaces.nsISupportsString, str);</span>
<a href="#l34.177"></a><span id="l34.177"> }</span>
<a href="#l34.178"></a><span id="l34.178"> </span>
<a href="#l34.179"></a><span id="l34.179"> /**</span>
<a href="#l34.180"></a><span id="l34.180">  * Like getPrefSafe, except for complex prefs (those used for localized data).</span>
<a href="#l34.181"></a><span id="l34.181">  *</span>
<a href="#l34.182"></a><span id="l34.182">  * @param aPrefName   the (full) name of preference to get</span>
<a href="#l34.183"></a><span id="l34.183">  * @param aDefault    (optional) the value to return if the pref is undefined</span>
<a href="#l34.184"></a><span id="l34.184">  */</span>
<a href="#l34.185"></a><span id="l34.185"> function getLocalizedPref(aPrefName, aDefault) {</span>
<a href="#l34.186"></a><span id="l34.186" class="difflineminus">-    const pb2 = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;].</span>
<a href="#l34.187"></a><span id="l34.187" class="difflineminus">-                getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l34.188"></a><span id="l34.188">     var result;</span>
<a href="#l34.189"></a><span id="l34.189">     try {</span>
<a href="#l34.190"></a><span id="l34.190" class="difflineminus">-        result = pb2.getComplexValue(aPrefName, Components.interfaces.nsISupportsString).data;</span>
<a href="#l34.191"></a><span id="l34.191" class="difflineplus">+        result = Services.prefs.getComplexValue(aPrefName, Components.interfaces.nsISupportsString).data;</span>
<a href="#l34.192"></a><span id="l34.192">     } catch(ex) {</span>
<a href="#l34.193"></a><span id="l34.193">         return aDefault;</span>
<a href="#l34.194"></a><span id="l34.194">     }</span>
<a href="#l34.195"></a><span id="l34.195">     return result;</span>
<a href="#l34.196"></a><span id="l34.196"> }</span>
<a href="#l34.197"></a><span id="l34.197"> </span>
<a href="#l34.198"></a><span id="l34.198"> /**</span>
<a href="#l34.199"></a><span id="l34.199">  * Get array of category names from preferences or locale default,</span>
<a href="#l34.200"></a><span id="l34.200" class="difflineat">@@ -699,43 +678,31 @@ function setPrefCategoriesFromArray(aCat</span>
<a href="#l34.201"></a><span id="l34.201">  * may contain unescaped commas, which will be escaped in combined string.</span>
<a href="#l34.202"></a><span id="l34.202">  */</span>
<a href="#l34.203"></a><span id="l34.203"> function categoriesArrayToString(aSortedCategoriesArray) {</span>
<a href="#l34.204"></a><span id="l34.204">     function escapeComma(category) { return category.replace(/,/g,&quot;\\,&quot;); }</span>
<a href="#l34.205"></a><span id="l34.205">     return aSortedCategoriesArray.map(escapeComma).join(&quot;,&quot;);</span>
<a href="#l34.206"></a><span id="l34.206"> }</span>
<a href="#l34.207"></a><span id="l34.207"> </span>
<a href="#l34.208"></a><span id="l34.208"> /**</span>
<a href="#l34.209"></a><span id="l34.209" class="difflineminus">- * Creates a string bundle.</span>
<a href="#l34.210"></a><span id="l34.210" class="difflineminus">- *</span>
<a href="#l34.211"></a><span id="l34.211" class="difflineminus">- * @param bundleURL The bundle URL</span>
<a href="#l34.212"></a><span id="l34.212" class="difflineminus">- * @return string bundle</span>
<a href="#l34.213"></a><span id="l34.213" class="difflineminus">- */</span>
<a href="#l34.214"></a><span id="l34.214" class="difflineminus">-function calGetStringBundle(bundleURL) {</span>
<a href="#l34.215"></a><span id="l34.215" class="difflineminus">-    let service = Components.classes[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l34.216"></a><span id="l34.216" class="difflineminus">-                            .getService(Components.interfaces.nsIStringBundleService);</span>
<a href="#l34.217"></a><span id="l34.217" class="difflineminus">-    return service.createBundle(bundleURL);</span>
<a href="#l34.218"></a><span id="l34.218" class="difflineminus">-}</span>
<a href="#l34.219"></a><span id="l34.219" class="difflineminus">-</span>
<a href="#l34.220"></a><span id="l34.220" class="difflineminus">-/**</span>
<a href="#l34.221"></a><span id="l34.221">  * Gets the value of a string in a .properties file from the calendar bundle</span>
<a href="#l34.222"></a><span id="l34.222">  *</span>
<a href="#l34.223"></a><span id="l34.223">  * @param aBundleName  the name of the properties file.  It is assumed that the</span>
<a href="#l34.224"></a><span id="l34.224">  *                     file lives in chrome://calendar/locale/</span>
<a href="#l34.225"></a><span id="l34.225">  * @param aStringName  the name of the string within the properties file</span>
<a href="#l34.226"></a><span id="l34.226">  * @param aParams      optional array of parameters to format the string</span>
<a href="#l34.227"></a><span id="l34.227">  * @param aComponent   optional stringbundle component name</span>
<a href="#l34.228"></a><span id="l34.228">  */</span>
<a href="#l34.229"></a><span id="l34.229"> function calGetString(aBundleName, aStringName, aParams, aComponent) {</span>
<a href="#l34.230"></a><span id="l34.230">     try {</span>
<a href="#l34.231"></a><span id="l34.231">         if (!aComponent) {</span>
<a href="#l34.232"></a><span id="l34.232">             aComponent = &quot;calendar&quot;;</span>
<a href="#l34.233"></a><span id="l34.233">         }</span>
<a href="#l34.234"></a><span id="l34.234">         var propName = &quot;chrome://&quot; + aComponent + &quot;/locale/&quot; + aBundleName + &quot;.properties&quot;;</span>
<a href="#l34.235"></a><span id="l34.235" class="difflineminus">-        var props = calGetStringBundle(propName);</span>
<a href="#l34.236"></a><span id="l34.236" class="difflineplus">+        var props = Services.strings.createBundle(propName);</span>
<a href="#l34.237"></a><span id="l34.237"> </span>
<a href="#l34.238"></a><span id="l34.238">         if (aParams &amp;&amp; aParams.length) {</span>
<a href="#l34.239"></a><span id="l34.239">             return props.formatStringFromName(aStringName, aParams, aParams.length);</span>
<a href="#l34.240"></a><span id="l34.240">         } else {</span>
<a href="#l34.241"></a><span id="l34.241">             return props.GetStringFromName(aStringName);</span>
<a href="#l34.242"></a><span id="l34.242">         }</span>
<a href="#l34.243"></a><span id="l34.243">     } catch (ex) {</span>
<a href="#l34.244"></a><span id="l34.244">         var s = (&quot;Failed to read '&quot; + aStringName + &quot;' from &quot; + propName + &quot;.&quot;);</span>
<a href="#l34.245"></a><span id="l34.245" class="difflineat">@@ -964,21 +931,19 @@ function setDefaultStartEndHour(aItem, a</span>
<a href="#l34.246"></a><span id="l34.246"> /**</span>
<a href="#l34.247"></a><span id="l34.247">  * Logs a string or an object to both stderr and the js-console only in the case</span>
<a href="#l34.248"></a><span id="l34.248">  * where the calendar.debug.log pref is set to true.</span>
<a href="#l34.249"></a><span id="l34.249">  *</span>
<a href="#l34.250"></a><span id="l34.250">  * @param aArg  either a string to log or an object whose entire set of</span>
<a href="#l34.251"></a><span id="l34.251">  *              properties should be logged.</span>
<a href="#l34.252"></a><span id="l34.252">  */</span>
<a href="#l34.253"></a><span id="l34.253"> function LOG(aArg) {</span>
<a href="#l34.254"></a><span id="l34.254" class="difflineminus">-    var prefB = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;].</span>
<a href="#l34.255"></a><span id="l34.255" class="difflineminus">-                getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l34.256"></a><span id="l34.256">     var shouldLog = false;</span>
<a href="#l34.257"></a><span id="l34.257">     try {</span>
<a href="#l34.258"></a><span id="l34.258" class="difflineminus">-        shouldLog = prefB.getBoolPref(&quot;calendar.debug.log&quot;);</span>
<a href="#l34.259"></a><span id="l34.259" class="difflineplus">+        shouldLog = Services.prefs.getBoolPref(&quot;calendar.debug.log&quot;);</span>
<a href="#l34.260"></a><span id="l34.260">     } catch(ex) {}</span>
<a href="#l34.261"></a><span id="l34.261"> </span>
<a href="#l34.262"></a><span id="l34.262">     if (!shouldLog) {</span>
<a href="#l34.263"></a><span id="l34.263">         return;</span>
<a href="#l34.264"></a><span id="l34.264">     }</span>
<a href="#l34.265"></a><span id="l34.265">     ASSERT(aArg, &quot;Bad log argument.&quot;, false);</span>
<a href="#l34.266"></a><span id="l34.266">     var string;</span>
<a href="#l34.267"></a><span id="l34.267">     // We should just dump() both String objects, and string primitives.</span>
<a href="#l34.268"></a><span id="l34.268" class="difflineat">@@ -989,47 +954,47 @@ function LOG(aArg) {</span>
<a href="#l34.269"></a><span id="l34.269">         }</span>
<a href="#l34.270"></a><span id="l34.270">         string += &quot;End object\n&quot;;</span>
<a href="#l34.271"></a><span id="l34.271">     } else {</span>
<a href="#l34.272"></a><span id="l34.272">         string = aArg;</span>
<a href="#l34.273"></a><span id="l34.273">     }</span>
<a href="#l34.274"></a><span id="l34.274"> </span>
<a href="#l34.275"></a><span id="l34.275">     // xxx todo consider using function debug()</span>
<a href="#l34.276"></a><span id="l34.276">     dump(string + '\n');</span>
<a href="#l34.277"></a><span id="l34.277" class="difflineminus">-    getConsoleService().logStringMessage(string);</span>
<a href="#l34.278"></a><span id="l34.278" class="difflineplus">+    Services.console.logStringMessage(string);</span>
<a href="#l34.279"></a><span id="l34.279"> }</span>
<a href="#l34.280"></a><span id="l34.280"> </span>
<a href="#l34.281"></a><span id="l34.281"> /**</span>
<a href="#l34.282"></a><span id="l34.282">  * Dumps a warning to both console and js console.</span>
<a href="#l34.283"></a><span id="l34.283">  *</span>
<a href="#l34.284"></a><span id="l34.284">  * @param aMessage warning message</span>
<a href="#l34.285"></a><span id="l34.285">  */</span>
<a href="#l34.286"></a><span id="l34.286"> function WARN(aMessage) {</span>
<a href="#l34.287"></a><span id="l34.287">     dump(&quot;Warning: &quot; + aMessage + '\n');</span>
<a href="#l34.288"></a><span id="l34.288">     var scriptError = Components.classes[&quot;@mozilla.org/scripterror;1&quot;]</span>
<a href="#l34.289"></a><span id="l34.289">                                 .createInstance(Components.interfaces.nsIScriptError);</span>
<a href="#l34.290"></a><span id="l34.290">     scriptError.init(aMessage, null, null, 0, 0,</span>
<a href="#l34.291"></a><span id="l34.291">                      Components.interfaces.nsIScriptError.warningFlag,</span>
<a href="#l34.292"></a><span id="l34.292">                      &quot;component javascript&quot;);</span>
<a href="#l34.293"></a><span id="l34.293" class="difflineminus">-    getConsoleService().logMessage(scriptError);</span>
<a href="#l34.294"></a><span id="l34.294" class="difflineplus">+    Services.console.logMessage(scriptError);</span>
<a href="#l34.295"></a><span id="l34.295"> }</span>
<a href="#l34.296"></a><span id="l34.296"> </span>
<a href="#l34.297"></a><span id="l34.297"> /**</span>
<a href="#l34.298"></a><span id="l34.298">  * Dumps an error to both console and js console.</span>
<a href="#l34.299"></a><span id="l34.299">  *</span>
<a href="#l34.300"></a><span id="l34.300">  * @param aMessage error message</span>
<a href="#l34.301"></a><span id="l34.301">  */</span>
<a href="#l34.302"></a><span id="l34.302"> function ERROR(aMessage) {</span>
<a href="#l34.303"></a><span id="l34.303">     dump(&quot;Error: &quot; + aMessage + '\n');</span>
<a href="#l34.304"></a><span id="l34.304">     var scriptError = Components.classes[&quot;@mozilla.org/scripterror;1&quot;]</span>
<a href="#l34.305"></a><span id="l34.305">                                 .createInstance(Components.interfaces.nsIScriptError);</span>
<a href="#l34.306"></a><span id="l34.306">     scriptError.init(aMessage, null, null, 0, 0,</span>
<a href="#l34.307"></a><span id="l34.307">                      Components.interfaces.nsIScriptError.errorFlag,</span>
<a href="#l34.308"></a><span id="l34.308">                      &quot;component javascript&quot;);</span>
<a href="#l34.309"></a><span id="l34.309" class="difflineminus">-    getConsoleService().logMessage(scriptError);</span>
<a href="#l34.310"></a><span id="l34.310" class="difflineplus">+    Services.console.logMessage(scriptError);</span>
<a href="#l34.311"></a><span id="l34.311"> }</span>
<a href="#l34.312"></a><span id="l34.312"> </span>
<a href="#l34.313"></a><span id="l34.313"> /**</span>
<a href="#l34.314"></a><span id="l34.314">  * Returns a string describing the current js-stack with filename and line</span>
<a href="#l34.315"></a><span id="l34.315">  * numbers.</span>
<a href="#l34.316"></a><span id="l34.316">  *</span>
<a href="#l34.317"></a><span id="l34.317">  * @param aDepth (optional) The number of frames to include. Defaults to 5.</span>
<a href="#l34.318"></a><span id="l34.318">  * @param aSkip  (optional) Number of frames to skip</span>
<a href="#l34.319"></a><span id="l34.319" class="difflineat">@@ -1076,19 +1041,17 @@ function ASSERT(aCondition, aMessage, aC</span>
<a href="#l34.320"></a><span id="l34.320">  * Uses the prompt service to display an error message.</span>
<a href="#l34.321"></a><span id="l34.321">  * This function cannot be migrated into a module file, because it relies on an outer window object.</span>
<a href="#l34.322"></a><span id="l34.322">  *</span>
<a href="#l34.323"></a><span id="l34.323">  * @param aMsg The message to be shown</span>
<a href="#l34.324"></a><span id="l34.324">  */</span>
<a href="#l34.325"></a><span id="l34.325"> function showError(aMsg) {</span>
<a href="#l34.326"></a><span id="l34.326">     let window = window || null;</span>
<a href="#l34.327"></a><span id="l34.327">     if (window) {</span>
<a href="#l34.328"></a><span id="l34.328" class="difflineminus">-        let promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l34.329"></a><span id="l34.329" class="difflineminus">-                                      .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l34.330"></a><span id="l34.330" class="difflineminus">-        promptService.alert(window, calGetString(&quot;calendar&quot;, &quot;genericErrorTitle&quot;), aMsg);</span>
<a href="#l34.331"></a><span id="l34.331" class="difflineplus">+        Services.prompt.alert(window, calGetString(&quot;calendar&quot;, &quot;genericErrorTitle&quot;), aMsg);</span>
<a href="#l34.332"></a><span id="l34.332">     }</span>
<a href="#l34.333"></a><span id="l34.333"> }</span>
<a href="#l34.334"></a><span id="l34.334"> </span>
<a href="#l34.335"></a><span id="l34.335"> /**</span>
<a href="#l34.336"></a><span id="l34.336">  * Pick whichever of &quot;black&quot; or &quot;white&quot; will look better when used as a text</span>
<a href="#l34.337"></a><span id="l34.337">  * color against a background of bgColor.</span>
<a href="#l34.338"></a><span id="l34.338">  *</span>
<a href="#l34.339"></a><span id="l34.339">  * @param bgColor   the background color as a &quot;#RRGGBB&quot; string</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/calendar/itip/calItipEmailTransport.js</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/calendar/itip/calItipEmailTransport.js</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -1,13 +1,14 @@</span>
<a href="#l35.4"></a><span id="l35.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l35.5"></a><span id="l35.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l35.6"></a><span id="l35.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l35.7"></a><span id="l35.7"> </span>
<a href="#l35.8"></a><span id="l35.8"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l35.9"></a><span id="l35.9" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l35.10"></a><span id="l35.10"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l35.11"></a><span id="l35.11"> </span>
<a href="#l35.12"></a><span id="l35.12"> function convertFromUnicode(aCharset, aSrc) {</span>
<a href="#l35.13"></a><span id="l35.13">     let unicodeConverter = Components.classes[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l35.14"></a><span id="l35.14">                                      .createInstance(Components.interfaces.nsIScriptableUnicodeConverter);</span>
<a href="#l35.15"></a><span id="l35.15">     unicodeConverter.charset = aCharset;</span>
<a href="#l35.16"></a><span id="l35.16">     return unicodeConverter.ConvertFromUnicode(aSrc);</span>
<a href="#l35.17"></a><span id="l35.17"> }</span>
<a href="#l35.18"></a><span id="l35.18" class="difflineat">@@ -204,25 +205,23 @@ calItipEmailTransport.prototype = {</span>
<a href="#l35.19"></a><span id="l35.19">         switch (aItem.autoResponse) {</span>
<a href="#l35.20"></a><span id="l35.20">             case (Components.interfaces.calIItipItem.USER): {</span>
<a href="#l35.21"></a><span id="l35.21">                 cal.LOG(&quot;sendXpcomMail: Found USER autoResponse type.\n&quot; +</span>
<a href="#l35.22"></a><span id="l35.22">                         &quot;This type is currently unsupported, the compose API will always enter a text/plain\n&quot; +</span>
<a href="#l35.23"></a><span id="l35.23">                         &quot;or text/html part as first part of the message.\n&quot; +</span>
<a href="#l35.24"></a><span id="l35.24">                         &quot;This will disable OL (up to 2003) to consume the mail as an iTIP invitation showing\n&quot; +</span>
<a href="#l35.25"></a><span id="l35.25">                         &quot;the usual calendar buttons.&quot;);</span>
<a href="#l35.26"></a><span id="l35.26">                 // To somehow have a last resort before sending spam, the user can choose to send the mail.</span>
<a href="#l35.27"></a><span id="l35.27" class="difflineminus">-                let promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l35.28"></a><span id="l35.28" class="difflineminus">-                                              .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l35.29"></a><span id="l35.29">                 let prefCompatMode = cal.getPrefSafe(&quot;calendar.itip.compatSendMode&quot;, 0);</span>
<a href="#l35.30"></a><span id="l35.30">                 let inoutCheck = { value: (prefCompatMode == 1) };</span>
<a href="#l35.31"></a><span id="l35.31" class="difflineminus">-                if (!promptService.confirmCheck(null,</span>
<a href="#l35.32"></a><span id="l35.32" class="difflineminus">-                                                cal.calGetString(&quot;lightning&quot;, &quot;imipSendMail.title&quot;, null, &quot;lightning&quot;),</span>
<a href="#l35.33"></a><span id="l35.33" class="difflineminus">-                                                cal.calGetString(&quot;lightning&quot;, &quot;imipSendMail.text&quot;, null, &quot;lightning&quot;),</span>
<a href="#l35.34"></a><span id="l35.34" class="difflineminus">-                                                cal.calGetString(&quot;lightning&quot;, &quot;imipSendMail.Outlook2000CompatMode.text&quot;, null, &quot;lightning&quot;),</span>
<a href="#l35.35"></a><span id="l35.35" class="difflineminus">-                                                inoutCheck)) {</span>
<a href="#l35.36"></a><span id="l35.36" class="difflineplus">+                if (!Services.prompt.confirmCheck(null,</span>
<a href="#l35.37"></a><span id="l35.37" class="difflineplus">+                                                  cal.calGetString(&quot;lightning&quot;, &quot;imipSendMail.title&quot;, null, &quot;lightning&quot;),</span>
<a href="#l35.38"></a><span id="l35.38" class="difflineplus">+                                                  cal.calGetString(&quot;lightning&quot;, &quot;imipSendMail.text&quot;, null, &quot;lightning&quot;),</span>
<a href="#l35.39"></a><span id="l35.39" class="difflineplus">+                                                  cal.calGetString(&quot;lightning&quot;, &quot;imipSendMail.Outlook2000CompatMode.text&quot;, null, &quot;lightning&quot;),</span>
<a href="#l35.40"></a><span id="l35.40" class="difflineplus">+                                                  inoutCheck)) {</span>
<a href="#l35.41"></a><span id="l35.41">                     break;</span>
<a href="#l35.42"></a><span id="l35.42">                 } // else go on with auto sending for now</span>
<a href="#l35.43"></a><span id="l35.43">                 compatMode = (inoutCheck.value ? 1 : 0);</span>
<a href="#l35.44"></a><span id="l35.44">                 if (compatMode != prefCompatMode) {</span>
<a href="#l35.45"></a><span id="l35.45">                     cal.setPref(&quot;calendar.itip.compatSendMode&quot;, compatMode);</span>
<a href="#l35.46"></a><span id="l35.46">                 }</span>
<a href="#l35.47"></a><span id="l35.47">             }</span>
<a href="#l35.48"></a><span id="l35.48">             case (Components.interfaces.calIItipItem.AUTO): {</span>
<a href="#l35.49"></a><span id="l35.49" class="difflineat">@@ -255,18 +254,18 @@ calItipEmailTransport.prototype = {</span>
<a href="#l35.50"></a><span id="l35.50">                     let msgSend = Components.classes[&quot;@mozilla.org/messengercompose/send;1&quot;]</span>
<a href="#l35.51"></a><span id="l35.51">                                             .createInstance(Components.interfaces.nsIMsgSend);</span>
<a href="#l35.52"></a><span id="l35.52">                     msgSend.sendMessageFile(identity,</span>
<a href="#l35.53"></a><span id="l35.53">                                             account.key,</span>
<a href="#l35.54"></a><span id="l35.54">                                             composeFields,</span>
<a href="#l35.55"></a><span id="l35.55">                                             mailFile,</span>
<a href="#l35.56"></a><span id="l35.56">                                             true  /* deleteSendFileOnCompletion */,</span>
<a href="#l35.57"></a><span id="l35.57">                                             false /* digest_p */,</span>
<a href="#l35.58"></a><span id="l35.58" class="difflineminus">-                                            (cal.getIOService().offline ? Components.interfaces.nsIMsgSend.nsMsgQueueForLater</span>
<a href="#l35.59"></a><span id="l35.59" class="difflineminus">-                                                                    : Components.interfaces.nsIMsgSend.nsMsgDeliverNow),</span>
<a href="#l35.60"></a><span id="l35.60" class="difflineplus">+                                            (Services.io.offline ? Components.interfaces.nsIMsgSend.nsMsgQueueForLater</span>
<a href="#l35.61"></a><span id="l35.61" class="difflineplus">+                                                                 : Components.interfaces.nsIMsgSend.nsMsgDeliverNow),</span>
<a href="#l35.62"></a><span id="l35.62">                                             null  /* nsIMsgDBHdr msgToReplace */,</span>
<a href="#l35.63"></a><span id="l35.63">                                             null  /* nsIMsgSendListener aListener */,</span>
<a href="#l35.64"></a><span id="l35.64">                                             null  /* nsIMsgStatusFeedback aStatusFeedback */,</span>
<a href="#l35.65"></a><span id="l35.65">                                             &quot;&quot;    /* password */);</span>
<a href="#l35.66"></a><span id="l35.66">                 }</span>
<a href="#l35.67"></a><span id="l35.67">                 break;</span>
<a href="#l35.68"></a><span id="l35.68">             }</span>
<a href="#l35.69"></a><span id="l35.69">             case (Components.interfaces.calIItipItem.NONE):</span>
<a href="#l35.70"></a><span id="l35.70" class="difflineat">@@ -355,19 +354,17 @@ calItipEmailTransport.prototype = {</span>
<a href="#l35.71"></a><span id="l35.71">                                  &quot;\r\n&quot; +</span>
<a href="#l35.72"></a><span id="l35.72">                                  utf8CalText +</span>
<a href="#l35.73"></a><span id="l35.73">                                  &quot;\r\n\r\n&quot; +</span>
<a href="#l35.74"></a><span id="l35.74">                                  &quot;--Boundary_(ID_qyG4ZdjoAsiZ+Jo19dCbWQ)--\r\n&quot;);</span>
<a href="#l35.75"></a><span id="l35.75">                     break;</span>
<a href="#l35.76"></a><span id="l35.76">             }</span>
<a href="#l35.77"></a><span id="l35.77">             cal.LOG(&quot;mail text:\n&quot; + mailText);</span>
<a href="#l35.78"></a><span id="l35.78"> </span>
<a href="#l35.79"></a><span id="l35.79" class="difflineminus">-            let dirUtils = Components.classes[&quot;@mozilla.org/file/directory_service;1&quot;]</span>
<a href="#l35.80"></a><span id="l35.80" class="difflineminus">-                                     .createInstance(Components.interfaces.nsIProperties);</span>
<a href="#l35.81"></a><span id="l35.81" class="difflineminus">-            let tempFile = dirUtils.get(&quot;TmpD&quot;, Components.interfaces.nsIFile);</span>
<a href="#l35.82"></a><span id="l35.82" class="difflineplus">+            let tempFile = Services.dirsvc.get(&quot;TmpD&quot;, Components.interfaces.nsIFile);</span>
<a href="#l35.83"></a><span id="l35.83">             tempFile.append(&quot;itipTemp&quot;);</span>
<a href="#l35.84"></a><span id="l35.84">             tempFile.createUnique(Components.interfaces.nsIFile.NORMAL_FILE_TYPE,</span>
<a href="#l35.85"></a><span id="l35.85">                                   parseInt(&quot;0600&quot;, 8));</span>
<a href="#l35.86"></a><span id="l35.86"> </span>
<a href="#l35.87"></a><span id="l35.87">             let outputStream = Components.classes[&quot;@mozilla.org/network/file-output-stream;1&quot;]</span>
<a href="#l35.88"></a><span id="l35.88">                                          .createInstance(Components.interfaces.nsIFileOutputStream);</span>
<a href="#l35.89"></a><span id="l35.89">             // Let's write the file - constants from file-utils.js</span>
<a href="#l35.90"></a><span id="l35.90">             const MODE_WRONLY   = 0x02;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/calendar/lightning/components/lightningTextCalendarConverter.js</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/calendar/lightning/components/lightningTextCalendarConverter.js</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -254,19 +254,17 @@ ltnMimeConverter.prototype = {</span>
<a href="#l36.4"></a><span id="l36.4">                     itipItem = Components.classes[&quot;@mozilla.org/calendar/itip-item;1&quot;]</span>
<a href="#l36.5"></a><span id="l36.5">                                              .createInstance(Components.interfaces.calIItipItem);</span>
<a href="#l36.6"></a><span id="l36.6">                     itipItem.init(data);</span>
<a href="#l36.7"></a><span id="l36.7"> </span>
<a href="#l36.8"></a><span id="l36.8">                     let sinkProps = msgWindow.msgHeaderSink.properties;</span>
<a href="#l36.9"></a><span id="l36.9">                     sinkProps.setPropertyAsInterface(&quot;itipItem&quot;, itipItem);</span>
<a href="#l36.10"></a><span id="l36.10"> </span>
<a href="#l36.11"></a><span id="l36.11">                     // Notify the observer that the itipItem is available</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineminus">-                    let observer = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineminus">-                                             .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l36.14"></a><span id="l36.14" class="difflineminus">-                    observer.notifyObservers(null, &quot;onItipItemCreation&quot;, 0);</span>
<a href="#l36.15"></a><span id="l36.15" class="difflineplus">+                    Services.obs.notifyObservers(null, &quot;onItipItemCreation&quot;, 0);</span>
<a href="#l36.16"></a><span id="l36.16">                 }</span>
<a href="#l36.17"></a><span id="l36.17">             }</span>
<a href="#l36.18"></a><span id="l36.18">         } catch (e) {</span>
<a href="#l36.19"></a><span id="l36.19">             cal.ERROR(&quot;[ltnMimeConverter] convertToHTML: &quot; + e);</span>
<a href="#l36.20"></a><span id="l36.20">         }</span>
<a href="#l36.21"></a><span id="l36.21"> </span>
<a href="#l36.22"></a><span id="l36.22">         // Create the HTML string for display</span>
<a href="#l36.23"></a><span id="l36.23">         return cal.xml.serializeDOM(this.createHtml(event, itipItem));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/calendar/lightning/content/messenger-overlay-sidebar.js</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/calendar/lightning/content/messenger-overlay-sidebar.js</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -1,12 +1,13 @@</span>
<a href="#l37.4"></a><span id="l37.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l37.5"></a><span id="l37.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l37.6"></a><span id="l37.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l37.7"></a><span id="l37.7"> </span>
<a href="#l37.8"></a><span id="l37.8" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l37.9"></a><span id="l37.9"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l37.10"></a><span id="l37.10"> </span>
<a href="#l37.11"></a><span id="l37.11"> var gLastShownCalendarView = null;</span>
<a href="#l37.12"></a><span id="l37.12"> </span>
<a href="#l37.13"></a><span id="l37.13"> var calendarTabMonitor = {</span>
<a href="#l37.14"></a><span id="l37.14">     monitorName: &quot;lightning&quot;,</span>
<a href="#l37.15"></a><span id="l37.15"> </span>
<a href="#l37.16"></a><span id="l37.16">     // Unused, but needed functions</span>
<a href="#l37.17"></a><span id="l37.17" class="difflineat">@@ -177,19 +178,17 @@ function ltnOnLoad(event) {</span>
<a href="#l37.18"></a><span id="l37.18">     toolbox.customizeDone = function(aEvent) {</span>
<a href="#l37.19"></a><span id="l37.19">         MailToolboxCustomizeDone(aEvent, &quot;CustomizeCalendarToolbar&quot;);</span>
<a href="#l37.20"></a><span id="l37.20">     };</span>
<a href="#l37.21"></a><span id="l37.21">     toolbox = document.getElementById(&quot;task-toolbox&quot;);</span>
<a href="#l37.22"></a><span id="l37.22">     toolbox.customizeDone = function(aEvent) {</span>
<a href="#l37.23"></a><span id="l37.23">         MailToolboxCustomizeDone(aEvent, &quot;CustomizeTaskToolbar&quot;);</span>
<a href="#l37.24"></a><span id="l37.24">     };</span>
<a href="#l37.25"></a><span id="l37.25"> </span>
<a href="#l37.26"></a><span id="l37.26" class="difflineminus">-    Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l37.27"></a><span id="l37.27" class="difflineminus">-              .getService(Components.interfaces.nsIObserverService)</span>
<a href="#l37.28"></a><span id="l37.28" class="difflineminus">-              .notifyObservers(window, &quot;lightning-startup-done&quot;, false);</span>
<a href="#l37.29"></a><span id="l37.29" class="difflineplus">+    Services.obs.notifyObservers(window, &quot;lightning-startup-done&quot;, false);</span>
<a href="#l37.30"></a><span id="l37.30"> </span>
<a href="#l37.31"></a><span id="l37.31"> }</span>
<a href="#l37.32"></a><span id="l37.32"> </span>
<a href="#l37.33"></a><span id="l37.33"> /* Called at midnight to tell us to redraw date-specific widgets.  Do NOT call</span>
<a href="#l37.34"></a><span id="l37.34">  * this for normal refresh, since it also calls scheduleMidnightRefresh.</span>
<a href="#l37.35"></a><span id="l37.35">  */</span>
<a href="#l37.36"></a><span id="l37.36"> function refreshUIBits() {</span>
<a href="#l37.37"></a><span id="l37.37">     try {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/calendar/lightning/content/suite-overlay-sidebar.js</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/calendar/lightning/content/suite-overlay-sidebar.js</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -1,19 +1,19 @@</span>
<a href="#l38.4"></a><span id="l38.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l38.5"></a><span id="l38.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l38.6"></a><span id="l38.6">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l38.7"></a><span id="l38.7"> </span>
<a href="#l38.8"></a><span id="l38.8" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l38.9"></a><span id="l38.9" class="difflineplus">+</span>
<a href="#l38.10"></a><span id="l38.10"> var ltnSuiteUtils = {</span>
<a href="#l38.11"></a><span id="l38.11"> </span>
<a href="#l38.12"></a><span id="l38.12">   addStartupObserver: function lSU_addStartupObserver() {</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineminus">-    let obs = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l38.14"></a><span id="l38.14" class="difflineminus">-                        .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l38.15"></a><span id="l38.15" class="difflineminus">-    obs.addObserver(this.startupObserver, &quot;lightning-startup-done&quot;, false);</span>
<a href="#l38.16"></a><span id="l38.16" class="difflineminus">-    obs.addObserver(this.startupObserver, &quot;calendar-taskview-startup-done&quot;,</span>
<a href="#l38.17"></a><span id="l38.17" class="difflineplus">+    Services.obs.addObserver(this.startupObserver, &quot;lightning-startup-done&quot;, false);</span>
<a href="#l38.18"></a><span id="l38.18" class="difflineplus">+    Services.obs.addObserver(this.startupObserver, &quot;calendar-taskview-startup-done&quot;,</span>
<a href="#l38.19"></a><span id="l38.19">                     false);</span>
<a href="#l38.20"></a><span id="l38.20"> </span>
<a href="#l38.21"></a><span id="l38.21">   },</span>
<a href="#l38.22"></a><span id="l38.22"> </span>
<a href="#l38.23"></a><span id="l38.23">   startupObserver: {</span>
<a href="#l38.24"></a><span id="l38.24">     observe: function lSU_observe(subject, topic, state) {</span>
<a href="#l38.25"></a><span id="l38.25">       if (topic != &quot;lightning-startup-done&quot; &amp;&amp;</span>
<a href="#l38.26"></a><span id="l38.26">           topic != &quot;calendar-taskview-startup-done&quot;) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -2107,17 +2107,17 @@ calDavCalendar.prototype = {</span>
<a href="#l39.4"></a><span id="l39.4">                          this.buildDetailedMessage(status, extraInfo));</span>
<a href="#l39.5"></a><span id="l39.5">     },</span>
<a href="#l39.6"></a><span id="l39.6"> </span>
<a href="#l39.7"></a><span id="l39.7">     buildDetailedMessage : function caldav_buildDetailedMessage(status, extraInfo) {</span>
<a href="#l39.8"></a><span id="l39.8">         if (!status) {</span>
<a href="#l39.9"></a><span id="l39.9">             return &quot;&quot;;</span>
<a href="#l39.10"></a><span id="l39.10">         }</span>
<a href="#l39.11"></a><span id="l39.11"> </span>
<a href="#l39.12"></a><span id="l39.12" class="difflineminus">-        var props = calGetStringBundle(&quot;chrome://calendar/locale/calendar.properties&quot;);</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineplus">+        var props = Services.strings.createBundle(&quot;chrome://calendar/locale/calendar.properties&quot;);</span>
<a href="#l39.14"></a><span id="l39.14">         let statusString;</span>
<a href="#l39.15"></a><span id="l39.15">         try {</span>
<a href="#l39.16"></a><span id="l39.16">             statusString = props.GetStringFromName(&quot;caldavRequestStatusCodeString&quot; + status);</span>
<a href="#l39.17"></a><span id="l39.17">         } catch (e) {</span>
<a href="#l39.18"></a><span id="l39.18">             // Fallback on generic string if no string is defined for the status code</span>
<a href="#l39.19"></a><span id="l39.19">             statusString = props.GetStringFromName(&quot;caldavRequestStatusCodeStringGeneric&quot;);</span>
<a href="#l39.20"></a><span id="l39.20">         }</span>
<a href="#l39.21"></a><span id="l39.21">         return props.formatStringFromName(&quot;caldavRequestStatusCode&quot;, [ status ], 1) + &quot;, &quot; +</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/calendar/providers/gdata/components/calGoogleRequest.js</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/calendar/providers/gdata/components/calGoogleRequest.js</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -1,13 +1,14 @@</span>
<a href="#l40.4"></a><span id="l40.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l40.5"></a><span id="l40.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l40.6"></a><span id="l40.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l40.7"></a><span id="l40.7"> </span>
<a href="#l40.8"></a><span id="l40.8"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l40.9"></a><span id="l40.9" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l40.10"></a><span id="l40.10"> </span>
<a href="#l40.11"></a><span id="l40.11"> /**</span>
<a href="#l40.12"></a><span id="l40.12">  * calGoogleRequest</span>
<a href="#l40.13"></a><span id="l40.13">  * This class represents a HTTP request sent to Google</span>
<a href="#l40.14"></a><span id="l40.14">  *</span>
<a href="#l40.15"></a><span id="l40.15">  * @constructor</span>
<a href="#l40.16"></a><span id="l40.16">  * @class</span>
<a href="#l40.17"></a><span id="l40.17">  */</span>
<a href="#l40.18"></a><span id="l40.18" class="difflineat">@@ -181,25 +182,22 @@ calGoogleRequest.prototype = {</span>
<a href="#l40.19"></a><span id="l40.19">     commit: function cGR_commit(aSession) {</span>
<a href="#l40.20"></a><span id="l40.20"> </span>
<a href="#l40.21"></a><span id="l40.21">         try {</span>
<a href="#l40.22"></a><span id="l40.22">             // Set the session to request with</span>
<a href="#l40.23"></a><span id="l40.23">             if (aSession) {</span>
<a href="#l40.24"></a><span id="l40.24">                 this.mSession = aSession;</span>
<a href="#l40.25"></a><span id="l40.25">             }</span>
<a href="#l40.26"></a><span id="l40.26"> </span>
<a href="#l40.27"></a><span id="l40.27" class="difflineminus">-            // create the channel</span>
<a href="#l40.28"></a><span id="l40.28" class="difflineminus">-            let ioService = cal.getIOService();</span>
<a href="#l40.29"></a><span id="l40.29" class="difflineminus">-</span>
<a href="#l40.30"></a><span id="l40.30">             let uristring = this.uri;</span>
<a href="#l40.31"></a><span id="l40.31">             if (this.mQueryParameters.length &gt; 0) {</span>
<a href="#l40.32"></a><span id="l40.32">                 uristring += &quot;?&quot; + this.mQueryParameters.join(&quot;&amp;&quot;);</span>
<a href="#l40.33"></a><span id="l40.33">             }</span>
<a href="#l40.34"></a><span id="l40.34" class="difflineminus">-            let uri = ioService.newURI(uristring, null, null);</span>
<a href="#l40.35"></a><span id="l40.35" class="difflineminus">-            let channel = ioService.newChannelFromURI(uri);</span>
<a href="#l40.36"></a><span id="l40.36" class="difflineplus">+            let uri = Services.io.newURI(uristring, null, null);</span>
<a href="#l40.37"></a><span id="l40.37" class="difflineplus">+            let channel = Services.io.newChannelFromURI(uri);</span>
<a href="#l40.38"></a><span id="l40.38"> </span>
<a href="#l40.39"></a><span id="l40.39">             this.prepareChannel(channel);</span>
<a href="#l40.40"></a><span id="l40.40"> </span>
<a href="#l40.41"></a><span id="l40.41">             channel = channel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l40.42"></a><span id="l40.42">             channel.redirectionLimit = 3;</span>
<a href="#l40.43"></a><span id="l40.43"> </span>
<a href="#l40.44"></a><span id="l40.44">             this.mLoader = cal.createStreamLoader();</span>
<a href="#l40.45"></a><span id="l40.45"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/calendar/providers/gdata/components/calGoogleSession.js</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/calendar/providers/gdata/components/calGoogleSession.js</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -1,15 +1,16 @@</span>
<a href="#l41.4"></a><span id="l41.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l41.5"></a><span id="l41.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l41.6"></a><span id="l41.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l41.7"></a><span id="l41.7"> </span>
<a href="#l41.8"></a><span id="l41.8"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l41.9"></a><span id="l41.9"> Components.utils.import(&quot;resource://calendar/modules/calXMLUtils.jsm&quot;);</span>
<a href="#l41.10"></a><span id="l41.10"> Components.utils.import(&quot;resource://calendar/modules/calProviderUtils.jsm&quot;);</span>
<a href="#l41.11"></a><span id="l41.11" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l41.12"></a><span id="l41.12"> </span>
<a href="#l41.13"></a><span id="l41.13"> // This constant is an arbitrary large number. It is used to tell google to get</span>
<a href="#l41.14"></a><span id="l41.14"> // many events, the exact number is not important.</span>
<a href="#l41.15"></a><span id="l41.15"> const kMANY_EVENTS = 0x7FFFFFFF;</span>
<a href="#l41.16"></a><span id="l41.16"> </span>
<a href="#l41.17"></a><span id="l41.17"> function calGoogleSessionManager() {</span>
<a href="#l41.18"></a><span id="l41.18">     this.wrappedJSObject = this;</span>
<a href="#l41.19"></a><span id="l41.19"> </span>
<a href="#l41.20"></a><span id="l41.20" class="difflineat">@@ -355,21 +356,19 @@ calGoogleSession.prototype = {</span>
<a href="#l41.21"></a><span id="l41.21">                     return;</span>
<a href="#l41.22"></a><span id="l41.22">                 }</span>
<a href="#l41.23"></a><span id="l41.23">             }</span>
<a href="#l41.24"></a><span id="l41.24"> </span>
<a href="#l41.25"></a><span id="l41.25">             // Now we should have a password</span>
<a href="#l41.26"></a><span id="l41.26">             ASSERT(this.mGooglePass);</span>
<a href="#l41.27"></a><span id="l41.27"> </span>
<a href="#l41.28"></a><span id="l41.28">             // Get Version info</span>
<a href="#l41.29"></a><span id="l41.29" class="difflineminus">-            let appInfo = Components.classes[&quot;@mozilla.org/xre/app-info;1&quot;].</span>
<a href="#l41.30"></a><span id="l41.30" class="difflineminus">-                          getService(Components.interfaces.nsIXULAppInfo);</span>
<a href="#l41.31"></a><span id="l41.31" class="difflineminus">-            let source = appInfo.vendor + &quot;-&quot; +</span>
<a href="#l41.32"></a><span id="l41.32" class="difflineminus">-                         appInfo.name + &quot;-&quot; +</span>
<a href="#l41.33"></a><span id="l41.33" class="difflineminus">-                         appInfo.version;</span>
<a href="#l41.34"></a><span id="l41.34" class="difflineplus">+            let source = Services.appinfo.vendor + &quot;-&quot; +</span>
<a href="#l41.35"></a><span id="l41.35" class="difflineplus">+                         Services.appinfo.name + &quot;-&quot; +</span>
<a href="#l41.36"></a><span id="l41.36" class="difflineplus">+                         Services.appinfo.version;</span>
<a href="#l41.37"></a><span id="l41.37"> </span>
<a href="#l41.38"></a><span id="l41.38">             // Request Login</span>
<a href="#l41.39"></a><span id="l41.39">             let request = new calGoogleRequest(this);</span>
<a href="#l41.40"></a><span id="l41.40"> </span>
<a href="#l41.41"></a><span id="l41.41">             request.type = request.LOGIN;</span>
<a href="#l41.42"></a><span id="l41.42">             request.calendar = aCalendar;</span>
<a href="#l41.43"></a><span id="l41.43">             request.responseListener = this;</span>
<a href="#l41.44"></a><span id="l41.44"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1" class="difflineminus">--- a/calendar/providers/ics/calICSCalendar.js</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineplus">+++ b/calendar/providers/ics/calICSCalendar.js</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineat">@@ -120,17 +120,17 @@ calICSCalendar.prototype = {</span>
<a href="#l42.4"></a><span id="l42.4"> </span>
<a href="#l42.5"></a><span id="l42.5">     get uri() { return this.mUri },</span>
<a href="#l42.6"></a><span id="l42.6">     set uri(aUri) {</span>
<a href="#l42.7"></a><span id="l42.7">         this.mUri = aUri;</span>
<a href="#l42.8"></a><span id="l42.8">         this.mMemoryCalendar.uri = this.mUri;</span>
<a href="#l42.9"></a><span id="l42.9"> </span>
<a href="#l42.10"></a><span id="l42.10">         // Use the ioservice, to create a channel, which makes finding the</span>
<a href="#l42.11"></a><span id="l42.11">         // right hooks to use easier.</span>
<a href="#l42.12"></a><span id="l42.12" class="difflineminus">-        var channel = cal.getIOService().newChannelFromURI(this.mUri);</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineplus">+        var channel = Services.io.newChannelFromURI(this.mUri);</span>
<a href="#l42.14"></a><span id="l42.14"> </span>
<a href="#l42.15"></a><span id="l42.15">         if (calInstanceOf(channel, Components.interfaces.nsIHttpChannel)) {</span>
<a href="#l42.16"></a><span id="l42.16">             this.mHooks = new httpHooks(this);</span>
<a href="#l42.17"></a><span id="l42.17">         } else if (calInstanceOf(channel, Components.interfaces.nsIFileChannel)) {</span>
<a href="#l42.18"></a><span id="l42.18">             this.mHooks = new fileHooks(this);</span>
<a href="#l42.19"></a><span id="l42.19">         } else {</span>
<a href="#l42.20"></a><span id="l42.20">             this.mHooks = new dummyHooks(this);</span>
<a href="#l42.21"></a><span id="l42.21">         }</span>
<a href="#l42.22"></a><span id="l42.22" class="difflineat">@@ -175,17 +175,17 @@ calICSCalendar.prototype = {</span>
<a href="#l42.23"></a><span id="l42.23">         this.mMemoryCalendar.superCalendar = this;</span>
<a href="#l42.24"></a><span id="l42.24">     },</span>
<a href="#l42.25"></a><span id="l42.25"> </span>
<a href="#l42.26"></a><span id="l42.26">     doRefresh: function calICSCalendar_doRefresh(aForce) {</span>
<a href="#l42.27"></a><span id="l42.27">         let prbForce = Components.classes[&quot;@mozilla.org/supports-PRBool;1&quot;]</span>
<a href="#l42.28"></a><span id="l42.28">                                  .createInstance(Components.interfaces.nsISupportsPRBool);</span>
<a href="#l42.29"></a><span id="l42.29">         prbForce.data = aForce;</span>
<a href="#l42.30"></a><span id="l42.30"> </span>
<a href="#l42.31"></a><span id="l42.31" class="difflineminus">-        var channel = cal.getIOService().newChannelFromURI(this.mUri);</span>
<a href="#l42.32"></a><span id="l42.32" class="difflineplus">+        var channel = Services.io.newChannelFromURI(this.mUri);</span>
<a href="#l42.33"></a><span id="l42.33">         this.prepareChannel(channel, aForce);</span>
<a href="#l42.34"></a><span id="l42.34"> </span>
<a href="#l42.35"></a><span id="l42.35">         var streamLoader = Components.classes[&quot;@mozilla.org/network/stream-loader;1&quot;]</span>
<a href="#l42.36"></a><span id="l42.36">                                      .createInstance(Components.interfaces.nsIStreamLoader);</span>
<a href="#l42.37"></a><span id="l42.37"> </span>
<a href="#l42.38"></a><span id="l42.38">         // Lock other changes to the item list.</span>
<a href="#l42.39"></a><span id="l42.39">         this.lock();</span>
<a href="#l42.40"></a><span id="l42.40"> </span>
<a href="#l42.41"></a><span id="l42.41" class="difflineat">@@ -309,60 +309,58 @@ calICSCalendar.prototype = {</span>
<a href="#l42.42"></a><span id="l42.42">             this.unlock(calIErrors.MODIFICATION_FAILED);</span>
<a href="#l42.43"></a><span id="l42.43">             throw exc;</span>
<a href="#l42.44"></a><span id="l42.44">         }</span>
<a href="#l42.45"></a><span id="l42.45">     },</span>
<a href="#l42.46"></a><span id="l42.46"> </span>
<a href="#l42.47"></a><span id="l42.47">     doWriteICS: function () {</span>
<a href="#l42.48"></a><span id="l42.48">         cal.LOG(&quot;[calICSCalendar] Writing ICS File &quot; + this.uri.spec);</span>
<a href="#l42.49"></a><span id="l42.49">         var savedthis = this;</span>
<a href="#l42.50"></a><span id="l42.50" class="difflineminus">-        var appStartup = Components.classes[&quot;@mozilla.org/toolkit/app-startup;1&quot;]</span>
<a href="#l42.51"></a><span id="l42.51" class="difflineminus">-                                   .getService(Components.interfaces.nsIAppStartup);</span>
<a href="#l42.52"></a><span id="l42.52">         var listener =</span>
<a href="#l42.53"></a><span id="l42.53">         {</span>
<a href="#l42.54"></a><span id="l42.54">             serializer: null,</span>
<a href="#l42.55"></a><span id="l42.55">             onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDetail)</span>
<a href="#l42.56"></a><span id="l42.56">             {</span>
<a href="#l42.57"></a><span id="l42.57">                 var inLastWindowClosingSurvivalArea = false;</span>
<a href="#l42.58"></a><span id="l42.58">                 try  {</span>
<a href="#l42.59"></a><span id="l42.59">                     // All events are returned. Now set up a channel and a</span>
<a href="#l42.60"></a><span id="l42.60">                     // streamloader to upload.  onStopRequest will be called</span>
<a href="#l42.61"></a><span id="l42.61">                     // once the write has finished</span>
<a href="#l42.62"></a><span id="l42.62" class="difflineminus">-                    var channel = cal.getIOService().newChannelFromURI(savedthis.mUri);</span>
<a href="#l42.63"></a><span id="l42.63" class="difflineplus">+                    var channel = Services.io.newChannelFromURI(savedthis.mUri);</span>
<a href="#l42.64"></a><span id="l42.64"> </span>
<a href="#l42.65"></a><span id="l42.65">                     // Allow the hook to add things to the channel, like a</span>
<a href="#l42.66"></a><span id="l42.66">                     // header that checks etags</span>
<a href="#l42.67"></a><span id="l42.67">                     var notChanged = savedthis.mHooks.onBeforePut(channel);</span>
<a href="#l42.68"></a><span id="l42.68">                     if (notChanged) {</span>
<a href="#l42.69"></a><span id="l42.69">                         channel.notificationCallbacks = savedthis;</span>
<a href="#l42.70"></a><span id="l42.70">                         var uploadChannel = channel.QueryInterface(</span>
<a href="#l42.71"></a><span id="l42.71">                             Components.interfaces.nsIUploadChannel);</span>
<a href="#l42.72"></a><span id="l42.72"> </span>
<a href="#l42.73"></a><span id="l42.73">                         // Serialize</span>
<a href="#l42.74"></a><span id="l42.74">                         var icsStream = this.serializer.serializeToInputStream();</span>
<a href="#l42.75"></a><span id="l42.75"> </span>
<a href="#l42.76"></a><span id="l42.76">                         // Upload</span>
<a href="#l42.77"></a><span id="l42.77">                         uploadChannel.setUploadStream(icsStream,</span>
<a href="#l42.78"></a><span id="l42.78">                                                     &quot;text/calendar&quot;, -1);</span>
<a href="#l42.79"></a><span id="l42.79"> </span>
<a href="#l42.80"></a><span id="l42.80" class="difflineminus">-                        appStartup.enterLastWindowClosingSurvivalArea();</span>
<a href="#l42.81"></a><span id="l42.81" class="difflineplus">+                        Services.startup.enterLastWindowClosingSurvivalArea();</span>
<a href="#l42.82"></a><span id="l42.82">                         inLastWindowClosingSurvivalArea = true;</span>
<a href="#l42.83"></a><span id="l42.83">                         channel.asyncOpen(savedthis, savedthis);</span>
<a href="#l42.84"></a><span id="l42.84">                     } else {</span>
<a href="#l42.85"></a><span id="l42.85">                         if (inLastWindowClosingSurvivalArea) {</span>
<a href="#l42.86"></a><span id="l42.86" class="difflineminus">-                            appStartup.exitLastWindowClosingSurvivalArea();</span>
<a href="#l42.87"></a><span id="l42.87" class="difflineplus">+                            Services.startup.exitLastWindowClosingSurvivalArea();</span>
<a href="#l42.88"></a><span id="l42.88">                         }</span>
<a href="#l42.89"></a><span id="l42.89">                         savedthis.mObserver.onError(savedthis.superCalendar,</span>
<a href="#l42.90"></a><span id="l42.90">                                                     calIErrors.MODIFICATION_FAILED,</span>
<a href="#l42.91"></a><span id="l42.91">                                                     &quot;The calendar has been changed remotely. Please reload and apply your changes again!&quot;);</span>
<a href="#l42.92"></a><span id="l42.92">                         savedthis.unlock(calIErrors.MODIFICATION_FAILED);</span>
<a href="#l42.93"></a><span id="l42.93">                     }</span>
<a href="#l42.94"></a><span id="l42.94">                 } catch (ex) {</span>
<a href="#l42.95"></a><span id="l42.95">                     if (inLastWindowClosingSurvivalArea) {</span>
<a href="#l42.96"></a><span id="l42.96" class="difflineminus">-                        appStartup.exitLastWindowClosingSurvivalArea();</span>
<a href="#l42.97"></a><span id="l42.97" class="difflineplus">+                        Services.startup.exitLastWindowClosingSurvivalArea();</span>
<a href="#l42.98"></a><span id="l42.98">                     }</span>
<a href="#l42.99"></a><span id="l42.99">                     savedthis.mObserver.onError(savedthis.superCalendar,</span>
<a href="#l42.100"></a><span id="l42.100">                                                 ex.result, &quot;The calendar could not be saved; there &quot; +</span>
<a href="#l42.101"></a><span id="l42.101">                                                 &quot;was a failure: 0x&quot; + ex.result.toString(16));</span>
<a href="#l42.102"></a><span id="l42.102">                     savedthis.mObserver.onError(savedthis.superCalendar, calIErrors.MODIFICATION_FAILED, &quot;&quot;);</span>
<a href="#l42.103"></a><span id="l42.103">                     savedthis.unlock(calIErrors.MODIFICATION_FAILED);</span>
<a href="#l42.104"></a><span id="l42.104">                     savedthis.forceRefresh();</span>
<a href="#l42.105"></a><span id="l42.105">                 }</span>
<a href="#l42.106"></a><span id="l42.106" class="difflineat">@@ -417,42 +415,39 @@ calICSCalendar.prototype = {</span>
<a href="#l42.107"></a><span id="l42.107">         ctxt = ctxt.wrappedJSObject;</span>
<a href="#l42.108"></a><span id="l42.108">         let httpChannel;</span>
<a href="#l42.109"></a><span id="l42.109">         try {</span>
<a href="#l42.110"></a><span id="l42.110">             httpChannel = request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l42.111"></a><span id="l42.111">             cal.LOG(&quot;[calICSCalendar] channel.requestSucceeded: &quot; + httpChannel.requestSucceeded);</span>
<a href="#l42.112"></a><span id="l42.112">         } catch(e) {</span>
<a href="#l42.113"></a><span id="l42.113">         }</span>
<a href="#l42.114"></a><span id="l42.114"> </span>
<a href="#l42.115"></a><span id="l42.115" class="difflineminus">-        let appStartup = Components.classes[&quot;@mozilla.org/toolkit/app-startup;1&quot;]</span>
<a href="#l42.116"></a><span id="l42.116" class="difflineminus">-                                   .getService(Components.interfaces.nsIAppStartup);</span>
<a href="#l42.117"></a><span id="l42.117" class="difflineminus">-</span>
<a href="#l42.118"></a><span id="l42.118">         if ((httpChannel &amp;&amp; !httpChannel.requestSucceeded) ||</span>
<a href="#l42.119"></a><span id="l42.119">             (!httpChannel &amp;&amp; !Components.isSuccessCode(request.status))) {</span>
<a href="#l42.120"></a><span id="l42.120">             ctxt.mObserver.onError(this.superCalendar,</span>
<a href="#l42.121"></a><span id="l42.121">                                    Components.isSuccessCode(request.status)</span>
<a href="#l42.122"></a><span id="l42.122">                                    ? calIErrors.DAV_PUT_ERROR</span>
<a href="#l42.123"></a><span id="l42.123">                                    : request.status,</span>
<a href="#l42.124"></a><span id="l42.124">                                    &quot;Publishing the calendar file failed\n&quot; +</span>
<a href="#l42.125"></a><span id="l42.125">                                        &quot;Status code: &quot;+request.status.toString(16)+&quot;\n&quot;);</span>
<a href="#l42.126"></a><span id="l42.126">             ctxt.mObserver.onError(this.superCalendar, calIErrors.MODIFICATION_FAILED, &quot;&quot;);</span>
<a href="#l42.127"></a><span id="l42.127"> </span>
<a href="#l42.128"></a><span id="l42.128">             // the PUT has failed, refresh, and signal error to all modifying operations:</span>
<a href="#l42.129"></a><span id="l42.129">             this.forceRefresh();</span>
<a href="#l42.130"></a><span id="l42.130">             ctxt.unlock(calIErrors.MODIFICATION_FAILED);</span>
<a href="#l42.131"></a><span id="l42.131" class="difflineminus">-            appStartup.exitLastWindowClosingSurvivalArea();</span>
<a href="#l42.132"></a><span id="l42.132" class="difflineplus">+            Services.startup.exitLastWindowClosingSurvivalArea();</span>
<a href="#l42.133"></a><span id="l42.133">             return;</span>
<a href="#l42.134"></a><span id="l42.134">         }</span>
<a href="#l42.135"></a><span id="l42.135"> </span>
<a href="#l42.136"></a><span id="l42.136">         // Allow the hook to grab data of the channel, like the new etag</span>
<a href="#l42.137"></a><span id="l42.137"> </span>
<a href="#l42.138"></a><span id="l42.138">         ctxt.mHooks.onAfterPut(request,</span>
<a href="#l42.139"></a><span id="l42.139">                                function() {</span>
<a href="#l42.140"></a><span id="l42.140">                                    ctxt.unlock();</span>
<a href="#l42.141"></a><span id="l42.141" class="difflineminus">-                                   appStartup.exitLastWindowClosingSurvivalArea();</span>
<a href="#l42.142"></a><span id="l42.142" class="difflineplus">+                                   Services.startup.exitLastWindowClosingSurvivalArea();</span>
<a href="#l42.143"></a><span id="l42.143">                                });</span>
<a href="#l42.144"></a><span id="l42.144">     },</span>
<a href="#l42.145"></a><span id="l42.145"> </span>
<a href="#l42.146"></a><span id="l42.146">     // Always use the queue, just to reduce the amount of places where</span>
<a href="#l42.147"></a><span id="l42.147">     // this.mMemoryCalendar.addItem() and friends are called. less</span>
<a href="#l42.148"></a><span id="l42.148">     // copied code.</span>
<a href="#l42.149"></a><span id="l42.149">     addItem: function (aItem, aListener) {</span>
<a href="#l42.150"></a><span id="l42.150">         this.adoptItem(aItem.clone(), aListener);</span>
<a href="#l42.151"></a><span id="l42.151" class="difflineat">@@ -769,17 +764,17 @@ calICSCalendar.prototype = {</span>
<a href="#l42.152"></a><span id="l42.152"> </span>
<a href="#l42.153"></a><span id="l42.153">         var backupFile = backupDir.clone();</span>
<a href="#l42.154"></a><span id="l42.154">         backupFile.append(makeName('edit'));</span>
<a href="#l42.155"></a><span id="l42.155">         backupFile.createUnique(CI.nsIFile.NORMAL_FILE_TYPE, parseInt(&quot;0600&quot;, 8));</span>
<a href="#l42.156"></a><span id="l42.156"> </span>
<a href="#l42.157"></a><span id="l42.157">         purgeOldBackups();</span>
<a href="#l42.158"></a><span id="l42.158"> </span>
<a href="#l42.159"></a><span id="l42.159">         // Now go download the remote file, and store it somewhere local.</span>
<a href="#l42.160"></a><span id="l42.160" class="difflineminus">-        var channel = cal.getIOService().newChannelFromURI(this.mUri);</span>
<a href="#l42.161"></a><span id="l42.161" class="difflineplus">+        var channel = Services.io.newChannelFromURI(this.mUri);</span>
<a href="#l42.162"></a><span id="l42.162">         channel.loadFlags |= Components.interfaces.nsIRequest.LOAD_BYPASS_CACHE;</span>
<a href="#l42.163"></a><span id="l42.163">         channel.notificationCallbacks = this;</span>
<a href="#l42.164"></a><span id="l42.164"> </span>
<a href="#l42.165"></a><span id="l42.165">         var downloader = Components.classes[&quot;@mozilla.org/network/downloader;1&quot;]</span>
<a href="#l42.166"></a><span id="l42.166">                                    .createInstance(CI.nsIDownloader);</span>
<a href="#l42.167"></a><span id="l42.167"> </span>
<a href="#l42.168"></a><span id="l42.168">         var savedthis = this;</span>
<a href="#l42.169"></a><span id="l42.169">         var listener = {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1" class="difflineminus">--- a/calendar/providers/storage/calStorageUpgrade.jsm</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineplus">+++ b/calendar/providers/storage/calStorageUpgrade.jsm</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineat">@@ -366,19 +366,17 @@ function ensureUpdatedTimezones(db) {</span>
<a href="#l43.4"></a><span id="l43.4">     try {</span>
<a href="#l43.5"></a><span id="l43.5">         version = (selectTzVersion.executeStep() ? selectTzVersion.row.version : null);</span>
<a href="#l43.6"></a><span id="l43.6">     } finally {</span>
<a href="#l43.7"></a><span id="l43.7">         selectTzVersion.reset();</span>
<a href="#l43.8"></a><span id="l43.8">     }</span>
<a href="#l43.9"></a><span id="l43.9"> </span>
<a href="#l43.10"></a><span id="l43.10">     let versionComp = 1;</span>
<a href="#l43.11"></a><span id="l43.11">     if (version) {</span>
<a href="#l43.12"></a><span id="l43.12" class="difflineminus">-        versionComp = Components.classes[&quot;@mozilla.org/xpcom/version-comparator;1&quot;]</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineminus">-                                .getService(Components.interfaces.nsIVersionComparator)</span>
<a href="#l43.14"></a><span id="l43.14" class="difflineminus">-                                .compare(tzServiceVersion, version);</span>
<a href="#l43.15"></a><span id="l43.15" class="difflineplus">+        versionComp = Services.vc.compare(tzServiceVersion, version);</span>
<a href="#l43.16"></a><span id="l43.16">     }</span>
<a href="#l43.17"></a><span id="l43.17"> </span>
<a href="#l43.18"></a><span id="l43.18">     if (versionComp != 0) {</span>
<a href="#l43.19"></a><span id="l43.19">         cal.LOG(&quot;[calStorageCalendar] Timezones have been changed from &quot; + version + &quot; to &quot; + tzServiceVersion + &quot;, updating calendar data.&quot;);</span>
<a href="#l43.20"></a><span id="l43.20"> </span>
<a href="#l43.21"></a><span id="l43.21">         let zonesToUpdate = [];</span>
<a href="#l43.22"></a><span id="l43.22">         let getZones = createStatement(db,</span>
<a href="#l43.23"></a><span id="l43.23">             &quot;SELECT DISTINCT(zone) FROM (&quot;+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapRequest.js</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapRequest.js</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineat">@@ -12,16 +12,18 @@</span>
<a href="#l44.4"></a><span id="l44.4">    The response function gets the ended request as first parameter to check</span>
<a href="#l44.5"></a><span id="l44.5">    whether the request has been successful and get its data.</span>
<a href="#l44.6"></a><span id="l44.6">    The request function itself may return either</span>
<a href="#l44.7"></a><span id="l44.7">    - a further calIOperation request object, i.e. an async continuation</span>
<a href="#l44.8"></a><span id="l44.8">    - some data (incl null/undefined) which is the result of the async function,</span>
<a href="#l44.9"></a><span id="l44.9">      indicating that there is no further continuation</span>
<a href="#l44.10"></a><span id="l44.10"> */</span>
<a href="#l44.11"></a><span id="l44.11"> </span>
<a href="#l44.12"></a><span id="l44.12" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineplus">+</span>
<a href="#l44.14"></a><span id="l44.14"> function generateRequestId() {</span>
<a href="#l44.15"></a><span id="l44.15">     if (!generateRequestId.mRequestPrefix) {</span>
<a href="#l44.16"></a><span id="l44.16">         generateRequestId.mRequestPrefix = (cal.getUUID() + &quot;-&quot;);</span>
<a href="#l44.17"></a><span id="l44.17">         generateRequestId.mRequestId = 0;</span>
<a href="#l44.18"></a><span id="l44.18">     }</span>
<a href="#l44.19"></a><span id="l44.19">     ++generateRequestId.mRequestId;</span>
<a href="#l44.20"></a><span id="l44.20">     return (generateRequestId.mRequestPrefix + generateRequestId.mRequestId);</span>
<a href="#l44.21"></a><span id="l44.21"> }</span>
<a href="#l44.22"></a><span id="l44.22" class="difflineat">@@ -405,18 +407,18 @@ calWcapNetworkRequest.prototype = {</span>
<a href="#l44.23"></a><span id="l44.23"> };</span>
<a href="#l44.24"></a><span id="l44.24"> </span>
<a href="#l44.25"></a><span id="l44.25"> function issueNetworkRequest(parentRequest, respFunc, url, bLogging) {</span>
<a href="#l44.26"></a><span id="l44.26">     var netRequest = new calWcapNetworkRequest(url, respFunc, bLogging);</span>
<a href="#l44.27"></a><span id="l44.27">     if (parentRequest) {</span>
<a href="#l44.28"></a><span id="l44.28">         parentRequest.attachSubRequest(netRequest);</span>
<a href="#l44.29"></a><span id="l44.29">     }</span>
<a href="#l44.30"></a><span id="l44.30">     try {</span>
<a href="#l44.31"></a><span id="l44.31" class="difflineminus">-        var uri = getIOService().newURI(url, null, null);</span>
<a href="#l44.32"></a><span id="l44.32" class="difflineminus">-        var channel = getIOService().newChannelFromURI(uri);</span>
<a href="#l44.33"></a><span id="l44.33" class="difflineplus">+        var uri = Services.io.newURI(url, null, null);</span>
<a href="#l44.34"></a><span id="l44.34" class="difflineplus">+        var channel = Services.io.newChannelFromURI(uri);</span>
<a href="#l44.35"></a><span id="l44.35">         netRequest.prepareChannel(channel);</span>
<a href="#l44.36"></a><span id="l44.36">         channel = channel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l44.37"></a><span id="l44.37">         channel.redirectionLimit = 3;</span>
<a href="#l44.38"></a><span id="l44.38">         channel.notificationCallbacks = netRequest;</span>
<a href="#l44.39"></a><span id="l44.39">         var loader = Components.classes[&quot;@mozilla.org/network/unichar-stream-loader;1&quot;]</span>
<a href="#l44.40"></a><span id="l44.40">                                .createInstance(Components.interfaces.nsIUnicharStreamLoader);</span>
<a href="#l44.41"></a><span id="l44.41">         netRequest.m_loader = loader;</span>
<a href="#l44.42"></a><span id="l44.42"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapSession.js</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapSession.js</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineat">@@ -1,14 +1,15 @@</span>
<a href="#l45.4"></a><span id="l45.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l45.5"></a><span id="l45.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l45.6"></a><span id="l45.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l45.7"></a><span id="l45.7"> </span>
<a href="#l45.8"></a><span id="l45.8"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l45.9"></a><span id="l45.9"> Components.utils.import(&quot;resource://calendar/modules/calIteratorUtils.jsm&quot;);</span>
<a href="#l45.10"></a><span id="l45.10" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l45.11"></a><span id="l45.11"> </span>
<a href="#l45.12"></a><span id="l45.12"> function calWcapTimezone(tzProvider, tzid_, component_) {</span>
<a href="#l45.13"></a><span id="l45.13">     this.wrappedJSObject = this;</span>
<a href="#l45.14"></a><span id="l45.14">     this.provider = tzProvider;</span>
<a href="#l45.15"></a><span id="l45.15">     this.icalComponent = component_;</span>
<a href="#l45.16"></a><span id="l45.16">     this.tzid = tzid_;</span>
<a href="#l45.17"></a><span id="l45.17">     this.isUTC = false;</span>
<a href="#l45.18"></a><span id="l45.18">     this.isFloating = false;</span>
<a href="#l45.19"></a><span id="l45.19" class="difflineat">@@ -91,19 +92,17 @@ function getWcapSessionFor(calendar, uri</span>
<a href="#l45.20"></a><span id="l45.20"> }</span>
<a href="#l45.21"></a><span id="l45.21"> </span>
<a href="#l45.22"></a><span id="l45.22"> function calWcapSession(contextId) {</span>
<a href="#l45.23"></a><span id="l45.23">     this.wrappedJSObject = this;</span>
<a href="#l45.24"></a><span id="l45.24">     this.m_contextId = contextId;</span>
<a href="#l45.25"></a><span id="l45.25">     this.m_loginQueue = [];</span>
<a href="#l45.26"></a><span id="l45.26"> </span>
<a href="#l45.27"></a><span id="l45.27">     // listen for shutdown, being logged out:</span>
<a href="#l45.28"></a><span id="l45.28" class="difflineminus">-    var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l45.29"></a><span id="l45.29" class="difflineminus">-                                    .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l45.30"></a><span id="l45.30" class="difflineminus">-    observerService.addObserver(this, &quot;quit-application&quot;, false /* don't hold weakly */);</span>
<a href="#l45.31"></a><span id="l45.31" class="difflineplus">+    Services.obs.addObserver(this, &quot;quit-application&quot;, false /* don't hold weakly */);</span>
<a href="#l45.32"></a><span id="l45.32">     cal.getCalendarManager().addObserver(this);</span>
<a href="#l45.33"></a><span id="l45.33"> }</span>
<a href="#l45.34"></a><span id="l45.34"> calWcapSession.prototype = {</span>
<a href="#l45.35"></a><span id="l45.35">     getInterfaces: function ci_wcapSession_getInterfaces(count) {</span>
<a href="#l45.36"></a><span id="l45.36">         const ifaces = [calIWcapSession,</span>
<a href="#l45.37"></a><span id="l45.37">                         calIFreeBusyProvider,</span>
<a href="#l45.38"></a><span id="l45.38">                         calICalendarSearchProvider,</span>
<a href="#l45.39"></a><span id="l45.39">                         Components.interfaces.calITimezoneProvider,</span>
<a href="#l45.40"></a><span id="l45.40" class="difflineat">@@ -128,17 +127,17 @@ calWcapSession.prototype = {</span>
<a href="#l45.41"></a><span id="l45.41">     },</span>
<a href="#l45.42"></a><span id="l45.42"> </span>
<a href="#l45.43"></a><span id="l45.43">     toString: function calWcapSession_toString(msg) {</span>
<a href="#l45.44"></a><span id="l45.44">         let str = (&quot;context-id: &quot; + this.m_contextId + &quot;, uri: &quot; + (this.uri ? this.uri.spec : &quot;unknown&quot;));</span>
<a href="#l45.45"></a><span id="l45.45">         if (this.credentials.userId) {</span>
<a href="#l45.46"></a><span id="l45.46">             str += (&quot;, userId=&quot; + this.credentials.userId);</span>
<a href="#l45.47"></a><span id="l45.47">         }</span>
<a href="#l45.48"></a><span id="l45.48">         if (!this.m_sessionId) {</span>
<a href="#l45.49"></a><span id="l45.49" class="difflineminus">-            str += (getIOService().offline ? &quot;, offline&quot; : &quot;, not logged in&quot;);</span>
<a href="#l45.50"></a><span id="l45.50" class="difflineplus">+            str += (Services.io.offline ? &quot;, offline&quot; : &quot;, not logged in&quot;);</span>
<a href="#l45.51"></a><span id="l45.51">         }</span>
<a href="#l45.52"></a><span id="l45.52">         return str;</span>
<a href="#l45.53"></a><span id="l45.53">     },</span>
<a href="#l45.54"></a><span id="l45.54">     notifyError: function calWcapSession_notifyError(err) {</span>
<a href="#l45.55"></a><span id="l45.55">         if (this.defaultCalendar) {</span>
<a href="#l45.56"></a><span id="l45.56">             this.defaultCalendar.notifyError_(err, null, this);</span>
<a href="#l45.57"></a><span id="l45.57">         } else {</span>
<a href="#l45.58"></a><span id="l45.58">             logError(&quot;no default calendar!&quot;, this);</span>
<a href="#l45.59"></a><span id="l45.59" class="difflineat">@@ -193,17 +192,17 @@ calWcapSession.prototype = {</span>
<a href="#l45.60"></a><span id="l45.60">     },</span>
<a href="#l45.61"></a><span id="l45.61"> </span>
<a href="#l45.62"></a><span id="l45.62">     m_sessionId: null,</span>
<a href="#l45.63"></a><span id="l45.63">     m_loginQueue: null,</span>
<a href="#l45.64"></a><span id="l45.64">     m_loginLock: false,</span>
<a href="#l45.65"></a><span id="l45.65"> </span>
<a href="#l45.66"></a><span id="l45.66">     getSessionId:</span>
<a href="#l45.67"></a><span id="l45.67">     function calWcapSession_getSessionId(request, respFunc, timedOutSessionId) {</span>
<a href="#l45.68"></a><span id="l45.68" class="difflineminus">-        if (getIOService().offline) {</span>
<a href="#l45.69"></a><span id="l45.69" class="difflineplus">+        if (Services.io.offline) {</span>
<a href="#l45.70"></a><span id="l45.70">             log(&quot;in offline mode.&quot;, this);</span>
<a href="#l45.71"></a><span id="l45.71">             respFunc(new Components.Exception(errorToString(NS_ERROR_OFFLINE), NS_ERROR_OFFLINE));</span>
<a href="#l45.72"></a><span id="l45.72">             return;</span>
<a href="#l45.73"></a><span id="l45.73">         }</span>
<a href="#l45.74"></a><span id="l45.74"> </span>
<a href="#l45.75"></a><span id="l45.75">         log(&quot;login queue lock: &quot; + this.m_loginLock + &quot;, length: &quot; + this.m_loginQueue.length, this);</span>
<a href="#l45.76"></a><span id="l45.76"> </span>
<a href="#l45.77"></a><span id="l45.77">         if (this.m_loginLock) {</span>
<a href="#l45.78"></a><span id="l45.78" class="difflineat">@@ -455,17 +454,17 @@ calWcapSession.prototype = {</span>
<a href="#l45.79"></a><span id="l45.79">                         var strVers = prop.value;</span>
<a href="#l45.80"></a><span id="l45.80">                         var vars = [this_.sessionUri.hostPort];</span>
<a href="#l45.81"></a><span id="l45.81">                         prop = icalRootComp.getFirstProperty(&quot;PRODID&quot;);</span>
<a href="#l45.82"></a><span id="l45.82">                         vars.push(prop ? prop.value : &quot;&lt;unknown&gt;&quot;);</span>
<a href="#l45.83"></a><span id="l45.83">                         prop = icalRootComp.getFirstProperty(&quot;X-NSCP-SERVERVERSION&quot;);</span>
<a href="#l45.84"></a><span id="l45.84">                         vars.push(prop ? prop.value : &quot;&lt;unknown&gt;&quot;);</span>
<a href="#l45.85"></a><span id="l45.85">                         vars.push(strVers);</span>
<a href="#l45.86"></a><span id="l45.86"> </span>
<a href="#l45.87"></a><span id="l45.87" class="difflineminus">-                        var prompt = getWindowWatcher().getNewPrompter(null);</span>
<a href="#l45.88"></a><span id="l45.88" class="difflineplus">+                        var prompt = Services.ww.getNewPrompter(null);</span>
<a href="#l45.89"></a><span id="l45.89">                         var labelText = cal.calGetString(&quot;wcap&quot;, &quot;insufficientWcapVersionConfirmation.label&quot;);</span>
<a href="#l45.90"></a><span id="l45.90">                         if (!prompt.confirm(labelText,</span>
<a href="#l45.91"></a><span id="l45.91">                                             cal.calGetString(&quot;wcap&quot;, &quot;insufficientWcapVersionConfirmation.text&quot;, vars))) {</span>
<a href="#l45.92"></a><span id="l45.92">                             throw new Components.Exception(labelText, calIWcapErrors.WCAP_LOGIN_FAILED);</span>
<a href="#l45.93"></a><span id="l45.93">                         }</span>
<a href="#l45.94"></a><span id="l45.94">                     }</span>
<a href="#l45.95"></a><span id="l45.95"> </span>
<a href="#l45.96"></a><span id="l45.96">                 } catch (exc) {</span>
<a href="#l45.97"></a><span id="l45.97" class="difflineat">@@ -1052,19 +1051,17 @@ calWcapSession.prototype = {</span>
<a href="#l45.98"></a><span id="l45.98">     // nsIObserver:</span>
<a href="#l45.99"></a><span id="l45.99">     observe: function calWcapSession_observer(subject, topic, data) {</span>
<a href="#l45.100"></a><span id="l45.100">         log(&quot;observing: &quot; + topic + &quot;, data: &quot; + data, this);</span>
<a href="#l45.101"></a><span id="l45.101">         if (topic == &quot;quit-application&quot;) {</span>
<a href="#l45.102"></a><span id="l45.102">             g_bShutdown = true;</span>
<a href="#l45.103"></a><span id="l45.103">             this.logout(null);</span>
<a href="#l45.104"></a><span id="l45.104">             // xxx todo: valid upon notification?</span>
<a href="#l45.105"></a><span id="l45.105">             cal.getCalendarManager().removeObserver(this);</span>
<a href="#l45.106"></a><span id="l45.106" class="difflineminus">-            var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l45.107"></a><span id="l45.107" class="difflineminus">-                                            .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l45.108"></a><span id="l45.108" class="difflineminus">-            observerService.removeObserver(this, &quot;quit-application&quot;);</span>
<a href="#l45.109"></a><span id="l45.109" class="difflineplus">+            Services.obs.removeObserver(this, &quot;quit-application&quot;);</span>
<a href="#l45.110"></a><span id="l45.110">         }</span>
<a href="#l45.111"></a><span id="l45.111">     },</span>
<a href="#l45.112"></a><span id="l45.112"> </span>
<a href="#l45.113"></a><span id="l45.113">     // calICalendarManagerObserver:</span>
<a href="#l45.114"></a><span id="l45.114"> </span>
<a href="#l45.115"></a><span id="l45.115">     // called after the calendar is registered</span>
<a href="#l45.116"></a><span id="l45.116">     onCalendarRegistered: function calWcapSession_onCalendarRegistered(aCalendar) {</span>
<a href="#l45.117"></a><span id="l45.117">         try {</span>
<a href="#l45.118"></a><span id="l45.118" class="difflineat">@@ -1145,17 +1142,17 @@ function confirmInsecureLogin(uri)</span>
<a href="#l45.119"></a><span id="l45.119">     var bConfirmed = false;</span>
<a href="#l45.120"></a><span id="l45.120"> </span>
<a href="#l45.121"></a><span id="l45.121">     var host = uri.hostPort;</span>
<a href="#l45.122"></a><span id="l45.122">     var encodedHost = encodeURIComponent(host);</span>
<a href="#l45.123"></a><span id="l45.123">     var confirmedEntry = confirmInsecureLogin.m_confirmedHttpLogins[encodedHost];</span>
<a href="#l45.124"></a><span id="l45.124">     if (confirmedEntry) {</span>
<a href="#l45.125"></a><span id="l45.125">         bConfirmed = (confirmedEntry == &quot;1&quot;);</span>
<a href="#l45.126"></a><span id="l45.126">     } else {</span>
<a href="#l45.127"></a><span id="l45.127" class="difflineminus">-        var prompt = getWindowWatcher().getNewPrompter(null);</span>
<a href="#l45.128"></a><span id="l45.128" class="difflineplus">+        var prompt = Services.ww.getNewPrompter(null);</span>
<a href="#l45.129"></a><span id="l45.129">         var out_dontAskAgain = { value: false };</span>
<a href="#l45.130"></a><span id="l45.130">         var bConfirmed = prompt.confirmCheck(</span>
<a href="#l45.131"></a><span id="l45.131">             cal.calGetString(&quot;wcap&quot;, &quot;noHttpsConfirmation.label&quot;),</span>
<a href="#l45.132"></a><span id="l45.132">             cal.calGetString(&quot;wcap&quot;, &quot;noHttpsConfirmation.text&quot;, [host]),</span>
<a href="#l45.133"></a><span id="l45.133">             cal.calGetString(&quot;wcap&quot;, &quot;noHttpsConfirmation.check.text&quot;),</span>
<a href="#l45.134"></a><span id="l45.134">             out_dontAskAgain);</span>
<a href="#l45.135"></a><span id="l45.135"> </span>
<a href="#l45.136"></a><span id="l45.136">         if (out_dontAskAgain.value) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapUtils.js</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapUtils.js</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineat">@@ -1,13 +1,14 @@</span>
<a href="#l46.4"></a><span id="l46.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l46.5"></a><span id="l46.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l46.6"></a><span id="l46.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l46.7"></a><span id="l46.7"> </span>
<a href="#l46.8"></a><span id="l46.8"> Components.utils.import(&quot;resource://calendar/modules/calIteratorUtils.jsm&quot;);</span>
<a href="#l46.9"></a><span id="l46.9" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l46.10"></a><span id="l46.10"> </span>
<a href="#l46.11"></a><span id="l46.11"> var g_bShutdown = false;</span>
<a href="#l46.12"></a><span id="l46.12"> </span>
<a href="#l46.13"></a><span id="l46.13"> function initLogging() {</span>
<a href="#l46.14"></a><span id="l46.14">     initLogging.mLogTimezone = calendarDefaultTimezone();</span>
<a href="#l46.15"></a><span id="l46.15">     if (initLogging.mLogFilestream) {</span>
<a href="#l46.16"></a><span id="l46.16">         try {</span>
<a href="#l46.17"></a><span id="l46.17">             initLogging.mLogFilestream.close();</span>
<a href="#l46.18"></a><span id="l46.18" class="difflineat">@@ -58,32 +59,28 @@ function initLogging() {</span>
<a href="#l46.19"></a><span id="l46.19">                         case &quot;calendar.wcap.log_file&quot;:</span>
<a href="#l46.20"></a><span id="l46.20">                         case &quot;calendar.debug.log&quot;:</span>
<a href="#l46.21"></a><span id="l46.21">                             initLogging();</span>
<a href="#l46.22"></a><span id="l46.22">                             break;</span>
<a href="#l46.23"></a><span id="l46.23">                     }</span>
<a href="#l46.24"></a><span id="l46.24">                 }</span>
<a href="#l46.25"></a><span id="l46.25">             }</span>
<a href="#l46.26"></a><span id="l46.26">         };</span>
<a href="#l46.27"></a><span id="l46.27" class="difflineminus">-        var prefBranch = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l46.28"></a><span id="l46.28" class="difflineminus">-                                   .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l46.29"></a><span id="l46.29" class="difflineminus">-        prefBranch.addObserver(&quot;calendar.wcap.log_level&quot;, initLogging.mLogPrefObserver, false);</span>
<a href="#l46.30"></a><span id="l46.30" class="difflineminus">-        prefBranch.addObserver(&quot;calendar.wcap.log_file&quot;, initLogging.mLogPrefObserver, false);</span>
<a href="#l46.31"></a><span id="l46.31" class="difflineminus">-        prefBranch.addObserver(&quot;calendar.debug.log&quot;, initLogging.mLogPrefObserver, false);</span>
<a href="#l46.32"></a><span id="l46.32" class="difflineplus">+        Services.prefs.addObserver(&quot;calendar.wcap.log_level&quot;, initLogging.mLogPrefObserver, false);</span>
<a href="#l46.33"></a><span id="l46.33" class="difflineplus">+        Services.prefs.addObserver(&quot;calendar.wcap.log_file&quot;, initLogging.mLogPrefObserver, false);</span>
<a href="#l46.34"></a><span id="l46.34" class="difflineplus">+        Services.prefs.addObserver(&quot;calendar.debug.log&quot;, initLogging.mLogPrefObserver, false);</span>
<a href="#l46.35"></a><span id="l46.35"> </span>
<a href="#l46.36"></a><span id="l46.36" class="difflineminus">-        var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l46.37"></a><span id="l46.37" class="difflineminus">-                                        .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l46.38"></a><span id="l46.38">         var appObserver = { // nsIObserver:</span>
<a href="#l46.39"></a><span id="l46.39">             observe: function app_observe(subject, topic, data) {</span>
<a href="#l46.40"></a><span id="l46.40">                 if (topic == &quot;quit-application&quot;) {</span>
<a href="#l46.41"></a><span id="l46.41" class="difflineminus">-                    prefBranch.removeObserver(&quot;calendar.&quot;, initLogging.mLogPrefObserver);</span>
<a href="#l46.42"></a><span id="l46.42" class="difflineplus">+                    Services.prefs.removeObserver(&quot;calendar.&quot;, initLogging.mLogPrefObserver);</span>
<a href="#l46.43"></a><span id="l46.43">                 }</span>
<a href="#l46.44"></a><span id="l46.44">             }</span>
<a href="#l46.45"></a><span id="l46.45">         };</span>
<a href="#l46.46"></a><span id="l46.46" class="difflineminus">-        observerService.addObserver(appObserver, &quot;quit-application&quot;, false);</span>
<a href="#l46.47"></a><span id="l46.47" class="difflineplus">+        Services.obs.addObserver(appObserver, &quot;quit-application&quot;, false);</span>
<a href="#l46.48"></a><span id="l46.48">     }</span>
<a href="#l46.49"></a><span id="l46.49"> }</span>
<a href="#l46.50"></a><span id="l46.50"> </span>
<a href="#l46.51"></a><span id="l46.51"> function log(msg, context, bForce) {</span>
<a href="#l46.52"></a><span id="l46.52">     if (bForce || LOG_LEVEL &gt; 0) {</span>
<a href="#l46.53"></a><span id="l46.53">         var ret = &quot;&quot;;</span>
<a href="#l46.54"></a><span id="l46.54">         if (context) {</span>
<a href="#l46.55"></a><span id="l46.55">             ret += (&quot;[&quot; + context + &quot;]&quot;);</span>
<a href="#l46.56"></a><span id="l46.56" class="difflineat">@@ -92,28 +89,28 @@ function log(msg, context, bForce) {</span>
<a href="#l46.57"></a><span id="l46.57">             ret += &quot;\n&quot;;</span>
<a href="#l46.58"></a><span id="l46.58">         }</span>
<a href="#l46.59"></a><span id="l46.59">         ret += msg;</span>
<a href="#l46.60"></a><span id="l46.60">         var now = getTime();</span>
<a href="#l46.61"></a><span id="l46.61">         if (now &amp;&amp; initLogging.mLogTimezone) {</span>
<a href="#l46.62"></a><span id="l46.62">             now = now.getInTimezone(initLogging.mLogTimezone);</span>
<a href="#l46.63"></a><span id="l46.63">         }</span>
<a href="#l46.64"></a><span id="l46.64">         var str = (&quot;### WCAP log entry: &quot; + now + &quot;\n&quot; + ret);</span>
<a href="#l46.65"></a><span id="l46.65" class="difflineminus">-        getConsoleService().logStringMessage(str);</span>
<a href="#l46.66"></a><span id="l46.66" class="difflineplus">+        Services.console.logStringMessage(str);</span>
<a href="#l46.67"></a><span id="l46.67">         str = (&quot;\n&quot; + str + &quot;\n&quot;);</span>
<a href="#l46.68"></a><span id="l46.68">         dump(str);</span>
<a href="#l46.69"></a><span id="l46.69">         if (initLogging.mLogFilestream) {</span>
<a href="#l46.70"></a><span id="l46.70">             try {</span>
<a href="#l46.71"></a><span id="l46.71">                 // xxx todo?</span>
<a href="#l46.72"></a><span id="l46.72">                 // assuming ANSI chars here, for logging sufficient:</span>
<a href="#l46.73"></a><span id="l46.73">                 initLogging.mLogFilestream.write(str, str.length);</span>
<a href="#l46.74"></a><span id="l46.74">             } catch (exc) { // catching any io errors here:</span>
<a href="#l46.75"></a><span id="l46.75">                 var err = (&quot;error writing log file: &quot; + errorToString(exc));</span>
<a href="#l46.76"></a><span id="l46.76">                 Components.utils.reportError(exc);</span>
<a href="#l46.77"></a><span id="l46.77" class="difflineminus">-                getConsoleService().logStringMessage(err);</span>
<a href="#l46.78"></a><span id="l46.78" class="difflineplus">+                Services.console.logStringMessage(err);</span>
<a href="#l46.79"></a><span id="l46.79">                 dump(err  + &quot;\n\n&quot;);</span>
<a href="#l46.80"></a><span id="l46.80">             }</span>
<a href="#l46.81"></a><span id="l46.81">         }</span>
<a href="#l46.82"></a><span id="l46.82">         return ret;</span>
<a href="#l46.83"></a><span id="l46.83">     } else {</span>
<a href="#l46.84"></a><span id="l46.84">         return msg;</span>
<a href="#l46.85"></a><span id="l46.85">     }</span>
<a href="#l46.86"></a><span id="l46.86"> }</span>
<a href="#l46.87"></a><span id="l46.87" class="difflineat">@@ -121,37 +118,29 @@ function log(msg, context, bForce) {</span>
<a href="#l46.88"></a><span id="l46.88"> function logWarning(err, context) {</span>
<a href="#l46.89"></a><span id="l46.89">     var msg = errorToString(err);</span>
<a href="#l46.90"></a><span id="l46.90">     var scriptError = Components.classes[&quot;@mozilla.org/scripterror;1&quot;]</span>
<a href="#l46.91"></a><span id="l46.91">                                 .createInstance(Components.interfaces.nsIScriptError);</span>
<a href="#l46.92"></a><span id="l46.92">     scriptError.init(log(&quot;warning: &quot; + msg, context, true),</span>
<a href="#l46.93"></a><span id="l46.93">                      null, null, 0, 0,</span>
<a href="#l46.94"></a><span id="l46.94">                      Components.interfaces.nsIScriptError.warningFlag,</span>
<a href="#l46.95"></a><span id="l46.95">                      &quot;component javascript&quot;);</span>
<a href="#l46.96"></a><span id="l46.96" class="difflineminus">-    getConsoleService().logMessage(scriptError);</span>
<a href="#l46.97"></a><span id="l46.97" class="difflineplus">+    Services.console.logMessage(scriptError);</span>
<a href="#l46.98"></a><span id="l46.98">     return msg;</span>
<a href="#l46.99"></a><span id="l46.99"> }</span>
<a href="#l46.100"></a><span id="l46.100"> </span>
<a href="#l46.101"></a><span id="l46.101"> function logError(err, context) {</span>
<a href="#l46.102"></a><span id="l46.102">     var msg = errorToString(err);</span>
<a href="#l46.103"></a><span id="l46.103">     Components.utils.reportError(log(&quot;error: &quot; + msg + &quot;\nstack:\n&quot; + STACK(10), context, true));</span>
<a href="#l46.104"></a><span id="l46.104">     debugger;</span>
<a href="#l46.105"></a><span id="l46.105">     return msg;</span>
<a href="#l46.106"></a><span id="l46.106"> }</span>
<a href="#l46.107"></a><span id="l46.107"> </span>
<a href="#l46.108"></a><span id="l46.108"> // late-inited service accessors:</span>
<a href="#l46.109"></a><span id="l46.109"> </span>
<a href="#l46.110"></a><span id="l46.110" class="difflineminus">-function getWindowWatcher() {</span>
<a href="#l46.111"></a><span id="l46.111" class="difflineminus">-    if (!getWindowWatcher.m_obj) {</span>
<a href="#l46.112"></a><span id="l46.112" class="difflineminus">-        getWindowWatcher.m_obj = Components.classes[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l46.113"></a><span id="l46.113" class="difflineminus">-                                           .getService(Components.interfaces.nsIWindowWatcher);</span>
<a href="#l46.114"></a><span id="l46.114" class="difflineminus">-    }</span>
<a href="#l46.115"></a><span id="l46.115" class="difflineminus">-    return getWindowWatcher.m_obj;</span>
<a href="#l46.116"></a><span id="l46.116" class="difflineminus">-}</span>
<a href="#l46.117"></a><span id="l46.117" class="difflineminus">-</span>
<a href="#l46.118"></a><span id="l46.118"> function getCalendarSearchService() {</span>
<a href="#l46.119"></a><span id="l46.119">     if (!getCalendarSearchService.m_obj) {</span>
<a href="#l46.120"></a><span id="l46.120">         getCalendarSearchService.m_obj = Components.classes[&quot;@mozilla.org/calendar/calendarsearch-service;1&quot;]</span>
<a href="#l46.121"></a><span id="l46.121">                                                    .getService(Components.interfaces.calICalendarSearchService);</span>
<a href="#l46.122"></a><span id="l46.122">     }</span>
<a href="#l46.123"></a><span id="l46.123">     return getCalendarSearchService.m_obj;</span>
<a href="#l46.124"></a><span id="l46.124"> }</span>
<a href="#l46.125"></a><span id="l46.125"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1" class="difflineminus">--- a/calendar/resources/content/calendar.js</span>
<a href="#l47.2"></a><span id="l47.2" class="difflineplus">+++ b/calendar/resources/content/calendar.js</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineat">@@ -1,15 +1,18 @@</span>
<a href="#l47.4"></a><span id="l47.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l47.5"></a><span id="l47.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l47.6"></a><span id="l47.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l47.7"></a><span id="l47.7"> </span>
<a href="#l47.8"></a><span id="l47.8"> /**</span>
<a href="#l47.9"></a><span id="l47.9">  * Called from calendar.xul window onload.</span>
<a href="#l47.10"></a><span id="l47.10">  */</span>
<a href="#l47.11"></a><span id="l47.11" class="difflineplus">+</span>
<a href="#l47.12"></a><span id="l47.12" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l47.13"></a><span id="l47.13" class="difflineplus">+</span>
<a href="#l47.14"></a><span id="l47.14"> function calendarInit() {</span>
<a href="#l47.15"></a><span id="l47.15">     // Take care of common initialization</span>
<a href="#l47.16"></a><span id="l47.16">     commonInitCalendar();</span>
<a href="#l47.17"></a><span id="l47.17"> </span>
<a href="#l47.18"></a><span id="l47.18">     var toolbox = document.getElementById(&quot;calendar-toolbox&quot;);</span>
<a href="#l47.19"></a><span id="l47.19">     toolbox.customizeDone = CalendarToolboxCustomizeDone;</span>
<a href="#l47.20"></a><span id="l47.20"> </span>
<a href="#l47.21"></a><span id="l47.21">     // Setup the offline manager</span>
<a href="#l47.22"></a><span id="l47.22" class="difflineat">@@ -125,20 +128,17 @@ function calendarFinish() {</span>
<a href="#l47.23"></a><span id="l47.23"> }</span>
<a href="#l47.24"></a><span id="l47.24"> </span>
<a href="#l47.25"></a><span id="l47.25"> function closeCalendar() {</span>
<a href="#l47.26"></a><span id="l47.26">     self.close();</span>
<a href="#l47.27"></a><span id="l47.27"> }</span>
<a href="#l47.28"></a><span id="l47.28"> </span>
<a href="#l47.29"></a><span id="l47.29"> function openPreferences() {</span>
<a href="#l47.30"></a><span id="l47.30">     // Check to see if the prefwindow is already open</span>
<a href="#l47.31"></a><span id="l47.31" class="difflineminus">-    var wm = Components.classes[&quot;@mozilla.org/appshell/window-mediator;1&quot;]</span>
<a href="#l47.32"></a><span id="l47.32" class="difflineminus">-                       .getService(Components.interfaces.nsIWindowMediator);</span>
<a href="#l47.33"></a><span id="l47.33" class="difflineminus">-</span>
<a href="#l47.34"></a><span id="l47.34" class="difflineminus">-    var win = wm.getMostRecentWindow(&quot;Calendar:Preferences&quot;);</span>
<a href="#l47.35"></a><span id="l47.35" class="difflineplus">+    var win = Services.wm.getMostRecentWindow(&quot;Calendar:Preferences&quot;);</span>
<a href="#l47.36"></a><span id="l47.36"> </span>
<a href="#l47.37"></a><span id="l47.37">     if (win) {</span>
<a href="#l47.38"></a><span id="l47.38">         win.focus();</span>
<a href="#l47.39"></a><span id="l47.39">     } else {</span>
<a href="#l47.40"></a><span id="l47.40">         // The prefwindow should only be modal on non-instant-apply platforms</span>
<a href="#l47.41"></a><span id="l47.41">         var instApply = getPrefSafe(&quot;browser.preferences.instantApply&quot;, false);</span>
<a href="#l47.42"></a><span id="l47.42"> </span>
<a href="#l47.43"></a><span id="l47.43">         var features = &quot;chrome,titlebar,toolbar,centerscreen,&quot; +</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1" class="difflineminus">--- a/calendar/resources/content/calendarService.js</span>
<a href="#l48.2"></a><span id="l48.2" class="difflineplus">+++ b/calendar/resources/content/calendarService.js</span>
<a href="#l48.3"></a><span id="l48.3" class="difflineat">@@ -9,16 +9,17 @@</span>
<a href="#l48.4"></a><span id="l48.4">  * 2. Content handler for responding to content of type text/calendar</span>
<a href="#l48.5"></a><span id="l48.5">  *    (ICALContentHandler)</span>
<a href="#l48.6"></a><span id="l48.6">  * 3. Protocol handler for supplying a channel to the browser when an webcal://</span>
<a href="#l48.7"></a><span id="l48.7">  *    link is clicked. (ICALProtocolHandler)</span>
<a href="#l48.8"></a><span id="l48.8">  * 4. A (nearly empty) imeplementation of nsIChannel for telling the browser</span>
<a href="#l48.9"></a><span id="l48.9">  *    that webcal:// links have the content type text/calendar (BogusChannel)</span>
<a href="#l48.10"></a><span id="l48.10">  */</span>
<a href="#l48.11"></a><span id="l48.11"> </span>
<a href="#l48.12"></a><span id="l48.12" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l48.13"></a><span id="l48.13"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l48.14"></a><span id="l48.14"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l48.15"></a><span id="l48.15"> </span>
<a href="#l48.16"></a><span id="l48.16"> /* Command Line handler service */</span>
<a href="#l48.17"></a><span id="l48.17"> function CLineService() {</span>
<a href="#l48.18"></a><span id="l48.18"> }</span>
<a href="#l48.19"></a><span id="l48.19"> </span>
<a href="#l48.20"></a><span id="l48.20"> CLineService.prototype = {</span>
<a href="#l48.21"></a><span id="l48.21" class="difflineat">@@ -46,20 +47,18 @@ CLineService.prototype = {</span>
<a href="#l48.22"></a><span id="l48.22">     QueryInterface: function QueryInterface(aIID) {</span>
<a href="#l48.23"></a><span id="l48.23">         return cal.doQueryInterface(this, CLineService.prototype, aIID, null, this);</span>
<a href="#l48.24"></a><span id="l48.24">     },</span>
<a href="#l48.25"></a><span id="l48.25"> </span>
<a href="#l48.26"></a><span id="l48.26">     /* nsICommandLineHandler */</span>
<a href="#l48.27"></a><span id="l48.27">     handle : function service_handle(cmdLine) {</span>
<a href="#l48.28"></a><span id="l48.28">         if (!cmdLine.preventDefault) {</span>
<a href="#l48.29"></a><span id="l48.29">             // just pass all arguments on to the Sunbird window</span>
<a href="#l48.30"></a><span id="l48.30" class="difflineminus">-            let wwatch = Components.classes[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l48.31"></a><span id="l48.31" class="difflineminus">-                                   .getService(Components.interfaces.nsIWindowWatcher);</span>
<a href="#l48.32"></a><span id="l48.32" class="difflineminus">-            wwatch.openWindow(null, &quot;chrome://sunbird/content/calendar.xul&quot;,</span>
<a href="#l48.33"></a><span id="l48.33" class="difflineminus">-                                  &quot;_blank&quot;, &quot;chrome,dialog=no,all&quot;, cmdLine);</span>
<a href="#l48.34"></a><span id="l48.34" class="difflineplus">+            Services.ww.openWindow(null, &quot;chrome://sunbird/content/calendar.xul&quot;,</span>
<a href="#l48.35"></a><span id="l48.35" class="difflineplus">+                                   &quot;_blank&quot;, &quot;chrome,dialog=no,all&quot;, cmdLine);</span>
<a href="#l48.36"></a><span id="l48.36">             cmdLine.preventDefault = true;</span>
<a href="#l48.37"></a><span id="l48.37">         }</span>
<a href="#l48.38"></a><span id="l48.38">     },</span>
<a href="#l48.39"></a><span id="l48.39"> </span>
<a href="#l48.40"></a><span id="l48.40">     helpInfo : &quot;  -subscribe or -url   Pass in a path pointing to a calendar\n&quot; +</span>
<a href="#l48.41"></a><span id="l48.41">                &quot;                       to subscribe to.\n&quot; +</span>
<a href="#l48.42"></a><span id="l48.42">                &quot;  -showdate            Pass in a value for a javascript date\n&quot; +</span>
<a href="#l48.43"></a><span id="l48.43">                &quot;                       to show this date on startup.\n&quot;</span>
<a href="#l48.44"></a><span id="l48.44" class="difflineat">@@ -112,19 +111,17 @@ ICALContentHandler.prototype = {</span>
<a href="#l48.45"></a><span id="l48.45">         calendarManager.registerCalendar(newCalendar);</span>
<a href="#l48.46"></a><span id="l48.46"> </span>
<a href="#l48.47"></a><span id="l48.47">         // ... and open or focus a calendar window.</span>
<a href="#l48.48"></a><span id="l48.48">         let w = cal.getCalendarWindow();</span>
<a href="#l48.49"></a><span id="l48.49"> </span>
<a href="#l48.50"></a><span id="l48.50">         if (w) {</span>
<a href="#l48.51"></a><span id="l48.51">             w.focus();</span>
<a href="#l48.52"></a><span id="l48.52">         } else {</span>
<a href="#l48.53"></a><span id="l48.53" class="difflineminus">-            let ass = Components.classes[&quot;@mozilla.org/appshell/appShellService;1&quot;]</span>
<a href="#l48.54"></a><span id="l48.54" class="difflineminus">-                                .getService(Components.interfaces.nsIAppShellService);</span>
<a href="#l48.55"></a><span id="l48.55" class="difflineminus">-            w = ass.hiddenDOMWindow;</span>
<a href="#l48.56"></a><span id="l48.56" class="difflineplus">+            w = Services.appshell.hiddenDOMWindow;</span>
<a href="#l48.57"></a><span id="l48.57"> </span>
<a href="#l48.58"></a><span id="l48.58">             let args = {};</span>
<a href="#l48.59"></a><span id="l48.59">             args.channel = channel;</span>
<a href="#l48.60"></a><span id="l48.60">             w.openDialog(&quot;chrome://sunbird/content/calendar.xul&quot;,</span>
<a href="#l48.61"></a><span id="l48.61">                          &quot;calendar&quot;,</span>
<a href="#l48.62"></a><span id="l48.62">                          &quot;chrome,menubar,resizable,scrollbars,status,toolbar,dialog=no&quot;,</span>
<a href="#l48.63"></a><span id="l48.63">                          args);</span>
<a href="#l48.64"></a><span id="l48.64">         }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l49.1"></a><span id="l49.1" class="difflineminus">--- a/calendar/resources/content/publish.js</span>
<a href="#l49.2"></a><span id="l49.2" class="difflineplus">+++ b/calendar/resources/content/publish.js</span>
<a href="#l49.3"></a><span id="l49.3" class="difflineat">@@ -1,13 +1,14 @@</span>
<a href="#l49.4"></a><span id="l49.4"> /* -*- Mode: Java; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l49.5"></a><span id="l49.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l49.6"></a><span id="l49.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l49.7"></a><span id="l49.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l49.8"></a><span id="l49.8"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l49.9"></a><span id="l49.9" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l49.10"></a><span id="l49.10"> </span>
<a href="#l49.11"></a><span id="l49.11"> /**</span>
<a href="#l49.12"></a><span id="l49.12">  * publishCalendarData</span>
<a href="#l49.13"></a><span id="l49.13">  * Show publish dialog, ask for URL and publish all selected items.</span>
<a href="#l49.14"></a><span id="l49.14">  */</span>
<a href="#l49.15"></a><span id="l49.15"> function publishCalendarData()</span>
<a href="#l49.16"></a><span id="l49.16"> {</span>
<a href="#l49.17"></a><span id="l49.17">    var args = new Object();</span>
<a href="#l49.18"></a><span id="l49.18" class="difflineat">@@ -120,17 +121,17 @@ function publishEntireCalendarDialogResp</span>
<a href="#l49.19"></a><span id="l49.19"> </span>
<a href="#l49.20"></a><span id="l49.20"> function publishItemArray(aItemArray, aPath, aProgressDialog) {</span>
<a href="#l49.21"></a><span id="l49.21">     var outputStream;</span>
<a href="#l49.22"></a><span id="l49.22">     var inputStream;</span>
<a href="#l49.23"></a><span id="l49.23">     var storageStream;</span>
<a href="#l49.24"></a><span id="l49.24"> </span>
<a href="#l49.25"></a><span id="l49.25">     var icsURL = makeURL(aPath);</span>
<a href="#l49.26"></a><span id="l49.26"> </span>
<a href="#l49.27"></a><span id="l49.27" class="difflineminus">-    var channel = cal.getIOService().newChannelFromURI(icsURL);</span>
<a href="#l49.28"></a><span id="l49.28" class="difflineplus">+    var channel = Services.io.newChannelFromURI(icsURL);</span>
<a href="#l49.29"></a><span id="l49.29">     if (icsURL.schemeIs('webcal'))</span>
<a href="#l49.30"></a><span id="l49.30">         icsURL.scheme = 'http';</span>
<a href="#l49.31"></a><span id="l49.31">     if (icsURL.schemeIs('webcals'))</span>
<a href="#l49.32"></a><span id="l49.32">         icsURL.scheme = 'https';</span>
<a href="#l49.33"></a><span id="l49.33"> </span>
<a href="#l49.34"></a><span id="l49.34">     switch(icsURL.scheme) {</span>
<a href="#l49.35"></a><span id="l49.35">         case 'http':</span>
<a href="#l49.36"></a><span id="l49.36">         case 'https':</span>
<a href="#l49.37"></a><span id="l49.37" class="difflineat">@@ -167,36 +168,30 @@ function publishItemArray(aItemArray, aP</span>
<a href="#l49.38"></a><span id="l49.38"> </span>
<a href="#l49.39"></a><span id="l49.39">     inputStream = storageStream.newInputStream(0);</span>
<a href="#l49.40"></a><span id="l49.40"> </span>
<a href="#l49.41"></a><span id="l49.41">     uploadChannel.setUploadStream(inputStream,</span>
<a href="#l49.42"></a><span id="l49.42">                                   &quot;text/calendar&quot;, -1);</span>
<a href="#l49.43"></a><span id="l49.43">     try {</span>
<a href="#l49.44"></a><span id="l49.44">         channel.asyncOpen(publishingListener, aProgressDialog);</span>
<a href="#l49.45"></a><span id="l49.45">     } catch (e) {</span>
<a href="#l49.46"></a><span id="l49.46" class="difflineminus">-        var sbs = Components.classes[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l49.47"></a><span id="l49.47" class="difflineminus">-                        .getService(Components.interfaces.nsIStringBundleService);</span>
<a href="#l49.48"></a><span id="l49.48" class="difflineminus">-        var props = sbs.createBundle(&quot;chrome://calendar/locale/calendar.properties&quot;);</span>
<a href="#l49.49"></a><span id="l49.49" class="difflineminus">-        var promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l49.50"></a><span id="l49.50" class="difflineminus">-                                      .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l49.51"></a><span id="l49.51" class="difflineminus">-        promptService.alert(null, calGetString(&quot;calendar&quot;, &quot;genericErrorTitle&quot;),</span>
<a href="#l49.52"></a><span id="l49.52" class="difflineminus">-                            props.formatStringFromName('otherPutError',[e.message],1));</span>
<a href="#l49.53"></a><span id="l49.53" class="difflineplus">+        var props = Services.strings.createBundle(&quot;chrome://calendar/locale/calendar.properties&quot;);</span>
<a href="#l49.54"></a><span id="l49.54" class="difflineplus">+        Services.prompt.alert(null, calGetString(&quot;calendar&quot;, &quot;genericErrorTitle&quot;),</span>
<a href="#l49.55"></a><span id="l49.55" class="difflineplus">+                              props.formatStringFromName('otherPutError',[e.message],1));</span>
<a href="#l49.56"></a><span id="l49.56">     }</span>
<a href="#l49.57"></a><span id="l49.57"> }</span>
<a href="#l49.58"></a><span id="l49.58"> </span>
<a href="#l49.59"></a><span id="l49.59"> </span>
<a href="#l49.60"></a><span id="l49.60"> var notificationCallbacks =</span>
<a href="#l49.61"></a><span id="l49.61"> {</span>
<a href="#l49.62"></a><span id="l49.62">     // nsIInterfaceRequestor interface</span>
<a href="#l49.63"></a><span id="l49.63">     getInterface: function(iid, instance) {</span>
<a href="#l49.64"></a><span id="l49.64">         if (iid.equals(Components.interfaces.nsIAuthPrompt)) {</span>
<a href="#l49.65"></a><span id="l49.65">             // use the window watcher service to get a nsIAuthPrompt impl</span>
<a href="#l49.66"></a><span id="l49.66" class="difflineminus">-            var ww = Components.classes[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l49.67"></a><span id="l49.67" class="difflineminus">-                               .getService(Components.interfaces.nsIWindowWatcher);</span>
<a href="#l49.68"></a><span id="l49.68" class="difflineminus">-            return ww.getNewAuthPrompter(null);</span>
<a href="#l49.69"></a><span id="l49.69" class="difflineplus">+            return Services.ww.getNewAuthPrompter(null);</span>
<a href="#l49.70"></a><span id="l49.70">         }</span>
<a href="#l49.71"></a><span id="l49.71"> </span>
<a href="#l49.72"></a><span id="l49.72">         throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l49.73"></a><span id="l49.73">     }</span>
<a href="#l49.74"></a><span id="l49.74"> }</span>
<a href="#l49.75"></a><span id="l49.75"> </span>
<a href="#l49.76"></a><span id="l49.76"> </span>
<a href="#l49.77"></a><span id="l49.77"> var publishingListener =</span>
<a href="#l49.78"></a><span id="l49.78" class="difflineat">@@ -214,34 +209,30 @@ var publishingListener =</span>
<a href="#l49.79"></a><span id="l49.79">     {</span>
<a href="#l49.80"></a><span id="l49.80">     },</span>
<a href="#l49.81"></a><span id="l49.81"> </span>
<a href="#l49.82"></a><span id="l49.82">     onStopRequest: function(request, ctxt, status, errorMsg)</span>
<a href="#l49.83"></a><span id="l49.83">     {</span>
<a href="#l49.84"></a><span id="l49.84">         ctxt.wrappedJSObject.onStopUpload();</span>
<a href="#l49.85"></a><span id="l49.85"> </span>
<a href="#l49.86"></a><span id="l49.86">         let channel;</span>
<a href="#l49.87"></a><span id="l49.87" class="difflineminus">-        let sbs = Components.classes[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l49.88"></a><span id="l49.88" class="difflineminus">-                        .getService(Components.interfaces.nsIStringBundleService);</span>
<a href="#l49.89"></a><span id="l49.89" class="difflineminus">-        let props = sbs.createBundle(&quot;chrome://calendar/locale/calendar.properties&quot;);</span>
<a href="#l49.90"></a><span id="l49.90" class="difflineminus">-        let promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l49.91"></a><span id="l49.91" class="difflineminus">-                                      .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l49.92"></a><span id="l49.92" class="difflineplus">+        let props = Services.strings.createBundle(&quot;chrome://calendar/locale/calendar.properties&quot;);</span>
<a href="#l49.93"></a><span id="l49.93">         let requestSucceeded;</span>
<a href="#l49.94"></a><span id="l49.94">         try {</span>
<a href="#l49.95"></a><span id="l49.95">             channel = request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l49.96"></a><span id="l49.96">             requestSucceeded = channel.requestSucceeded;</span>
<a href="#l49.97"></a><span id="l49.97">         } catch(e) {</span>
<a href="#l49.98"></a><span id="l49.98">         }</span>
<a href="#l49.99"></a><span id="l49.99">         if (channel &amp;&amp; !requestSucceeded) {</span>
<a href="#l49.100"></a><span id="l49.100" class="difflineminus">-            promptService.alert(null, calGetString(&quot;calendar&quot;, &quot;genericErrorTitle&quot;),</span>
<a href="#l49.101"></a><span id="l49.101" class="difflineminus">-                                props.formatStringFromName('httpPutError',[channel.responseStatus, channel.responseStatusText],2));</span>
<a href="#l49.102"></a><span id="l49.102" class="difflineplus">+            Services.prompt.alert(null, calGetString(&quot;calendar&quot;, &quot;genericErrorTitle&quot;),</span>
<a href="#l49.103"></a><span id="l49.103" class="difflineplus">+                                  props.formatStringFromName('httpPutError',[channel.responseStatus, channel.responseStatusText],2));</span>
<a href="#l49.104"></a><span id="l49.104">         } else if (!channel &amp;&amp; !Components.isSuccessCode(request.status)) {</span>
<a href="#l49.105"></a><span id="l49.105">             // XXX this should be made human-readable.</span>
<a href="#l49.106"></a><span id="l49.106" class="difflineminus">-            promptService.alert(null, calGetString(&quot;calendar&quot;, &quot;genericErrorTitle&quot;),</span>
<a href="#l49.107"></a><span id="l49.107" class="difflineminus">-                                props.formatStringFromName('otherPutError',[request.status.toString(16)],1));</span>
<a href="#l49.108"></a><span id="l49.108" class="difflineplus">+            Services.prompt.alert(null, calGetString(&quot;calendar&quot;, &quot;genericErrorTitle&quot;),</span>
<a href="#l49.109"></a><span id="l49.109" class="difflineplus">+                                  props.formatStringFromName('otherPutError',[request.status.toString(16)],1));</span>
<a href="#l49.110"></a><span id="l49.110">         }</span>
<a href="#l49.111"></a><span id="l49.111">     },</span>
<a href="#l49.112"></a><span id="l49.112"> </span>
<a href="#l49.113"></a><span id="l49.113">     onDataAvailable: function(request, ctxt, inStream, sourceOffset, count)</span>
<a href="#l49.114"></a><span id="l49.114">     {</span>
<a href="#l49.115"></a><span id="l49.115">     }</span>
<a href="#l49.116"></a><span id="l49.116"> }</span>
<a href="#l49.117"></a><span id="l49.117"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l50.1"></a><span id="l50.1" class="difflineminus">--- a/calendar/sunbird/base/content/applicationUtil.js</span>
<a href="#l50.2"></a><span id="l50.2" class="difflineplus">+++ b/calendar/sunbird/base/content/applicationUtil.js</span>
<a href="#l50.3"></a><span id="l50.3" class="difflineat">@@ -1,19 +1,20 @@</span>
<a href="#l50.4"></a><span id="l50.4"> /* -*- Mode: javascript; tab-width: 20; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l50.5"></a><span id="l50.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l50.6"></a><span id="l50.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l50.7"></a><span id="l50.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l50.8"></a><span id="l50.8"> </span>
<a href="#l50.9"></a><span id="l50.9" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l50.10"></a><span id="l50.10"> </span>
<a href="#l50.11"></a><span id="l50.11"> const nsIWindowMediator = Components.interfaces.nsIWindowMediator;</span>
<a href="#l50.12"></a><span id="l50.12"> </span>
<a href="#l50.13"></a><span id="l50.13"> function toOpenWindowByType(inType, uri)</span>
<a href="#l50.14"></a><span id="l50.14"> {</span>
<a href="#l50.15"></a><span id="l50.15" class="difflineminus">-    var windowManager = Components.classes['@mozilla.org/appshell/window-mediator;1'].getService();</span>
<a href="#l50.16"></a><span id="l50.16" class="difflineplus">+    var windowManager = Services.wm.getService();</span>
<a href="#l50.17"></a><span id="l50.17">     var windowManagerInterface = windowManager.QueryInterface(nsIWindowMediator);</span>
<a href="#l50.18"></a><span id="l50.18">     var topWindow = windowManagerInterface.getMostRecentWindow(inType);</span>
<a href="#l50.19"></a><span id="l50.19"> </span>
<a href="#l50.20"></a><span id="l50.20">     if (topWindow)</span>
<a href="#l50.21"></a><span id="l50.21">         topWindow.focus();</span>
<a href="#l50.22"></a><span id="l50.22">     else</span>
<a href="#l50.23"></a><span id="l50.23">         window.open(uri, &quot;_blank&quot;, &quot;chrome,extrachrome,menubar,resizable,scrollbars,status,toolbar&quot;);</span>
<a href="#l50.24"></a><span id="l50.24"> }</span>
<a href="#l50.25"></a><span id="l50.25" class="difflineat">@@ -37,19 +38,17 @@ function goToggleToolbar(id, elementID)</span>
<a href="#l50.26"></a><span id="l50.26">         }</span>
<a href="#l50.27"></a><span id="l50.27">     }</span>
<a href="#l50.28"></a><span id="l50.28"> }</span>
<a href="#l50.29"></a><span id="l50.29"> </span>
<a href="#l50.30"></a><span id="l50.30"> </span>
<a href="#l50.31"></a><span id="l50.31"> function goOpenAddons()</span>
<a href="#l50.32"></a><span id="l50.32"> {</span>
<a href="#l50.33"></a><span id="l50.33">     const EMTYPE = &quot;Extension:Manager&quot;;</span>
<a href="#l50.34"></a><span id="l50.34" class="difflineminus">-    var wm = Components.classes[&quot;@mozilla.org/appshell/window-mediator;1&quot;]</span>
<a href="#l50.35"></a><span id="l50.35" class="difflineminus">-                       .getService(Components.interfaces.nsIWindowMediator);</span>
<a href="#l50.36"></a><span id="l50.36" class="difflineminus">-    var theEM = wm.getMostRecentWindow(EMTYPE);</span>
<a href="#l50.37"></a><span id="l50.37" class="difflineplus">+    var theEM = Services.wm.getMostRecentWindow(EMTYPE);</span>
<a href="#l50.38"></a><span id="l50.38">     if (theEM) {</span>
<a href="#l50.39"></a><span id="l50.39">         theEM.focus();</span>
<a href="#l50.40"></a><span id="l50.40">         return;</span>
<a href="#l50.41"></a><span id="l50.41">     }</span>
<a href="#l50.42"></a><span id="l50.42"> </span>
<a href="#l50.43"></a><span id="l50.43">     const EMURL = &quot;chrome://mozapps/content/extensions/extensions.xul&quot;;</span>
<a href="#l50.44"></a><span id="l50.44">     const EMFEATURES = &quot;chrome,menubar,extra-chrome,toolbar,dialog=no,resizable&quot;;</span>
<a href="#l50.45"></a><span id="l50.45">     window.openDialog(EMURL, &quot;&quot;, EMFEATURES);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l51.1"></a><span id="l51.1" class="difflineminus">--- a/calendar/sunbird/base/content/calendar-offline.js</span>
<a href="#l51.2"></a><span id="l51.2" class="difflineplus">+++ b/calendar/sunbird/base/content/calendar-offline.js</span>
<a href="#l51.3"></a><span id="l51.3" class="difflineat">@@ -1,12 +1,14 @@</span>
<a href="#l51.4"></a><span id="l51.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l51.5"></a><span id="l51.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l51.6"></a><span id="l51.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l51.7"></a><span id="l51.7"> </span>
<a href="#l51.8"></a><span id="l51.8" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l51.9"></a><span id="l51.9" class="difflineplus">+</span>
<a href="#l51.10"></a><span id="l51.10"> if (!calendarOfflineManager) {</span>
<a href="#l51.11"></a><span id="l51.11">     Components.utils.reportError(&quot;calendar-management.js not included!&quot;);</span>
<a href="#l51.12"></a><span id="l51.12"> }</span>
<a href="#l51.13"></a><span id="l51.13"> </span>
<a href="#l51.14"></a><span id="l51.14"> // In addition to what the base calendar offline manager does, we need to make</span>
<a href="#l51.15"></a><span id="l51.15"> // the offline commands work in sunbird. Extend the offline manager here.</span>
<a href="#l51.16"></a><span id="l51.16"> var baseUpdateOfflineUI = calendarOfflineManager.updateOfflineUI;</span>
<a href="#l51.17"></a><span id="l51.17"> calendarOfflineManager.updateOfflineUI = function sunbird_updateOfflineUI(aIsOffline) {</span>
<a href="#l51.18"></a><span id="l51.18" class="difflineat">@@ -15,17 +17,17 @@ calendarOfflineManager.updateOfflineUI =</span>
<a href="#l51.19"></a><span id="l51.19"> </span>
<a href="#l51.20"></a><span id="l51.20">     setElementValue(&quot;offline-status&quot;, aIsOffline &amp;&amp; &quot;true&quot;, &quot;offline&quot;);</span>
<a href="#l51.21"></a><span id="l51.21">     setElementValue(&quot;offline-status&quot;, tooltip, &quot;tooltiptext&quot;);</span>
<a href="#l51.22"></a><span id="l51.22"> </span>
<a href="#l51.23"></a><span id="l51.23">     baseUpdateOfflineUI(aIsOffline);</span>
<a href="#l51.24"></a><span id="l51.24"> };</span>
<a href="#l51.25"></a><span id="l51.25"> </span>
<a href="#l51.26"></a><span id="l51.26"> calendarOfflineManager.toggleOfflineStatus = function sunbird_toggleOfflineStatus() {</span>
<a href="#l51.27"></a><span id="l51.27" class="difflineminus">-    var ioService = getIOService();</span>
<a href="#l51.28"></a><span id="l51.28" class="difflineplus">+    var ioService = Services.io;</span>
<a href="#l51.29"></a><span id="l51.29">     if (ioService.offline) {</span>
<a href="#l51.30"></a><span id="l51.30">         // Going online</span>
<a href="#l51.31"></a><span id="l51.31">         ioService.offline = false;</span>
<a href="#l51.32"></a><span id="l51.32">         try {</span>
<a href="#l51.33"></a><span id="l51.33">             // Alternatively we could check for @mozilla.org/network/network-link-service;1 here</span>
<a href="#l51.34"></a><span id="l51.34">             // instead of using a try-catch block, but the dependency on that service is rather an</span>
<a href="#l51.35"></a><span id="l51.35">             // implementation detail of the IO service.</span>
<a href="#l51.36"></a><span id="l51.36">             ioService.manageOfflineStatus = getPrefSafe(&quot;offline.autoDetect&quot;, true);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l52.1"></a><span id="l52.1" class="difflineminus">--- a/calendar/test/mozmill/testAlarmDefaultValue.js</span>
<a href="#l52.2"></a><span id="l52.2" class="difflineplus">+++ b/calendar/test/mozmill/testAlarmDefaultValue.js</span>
<a href="#l52.3"></a><span id="l52.3" class="difflineat">@@ -4,17 +4,17 @@</span>
<a href="#l52.4"></a><span id="l52.4"> </span>
<a href="#l52.5"></a><span id="l52.5"> /**</span>
<a href="#l52.6"></a><span id="l52.6">  * @title Test default alarm settings for events and tasks</span>
<a href="#l52.7"></a><span id="l52.7">  * @litmus 2510</span>
<a href="#l52.8"></a><span id="l52.8">  */</span>
<a href="#l52.9"></a><span id="l52.9"> </span>
<a href="#l52.10"></a><span id="l52.10"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l52.11"></a><span id="l52.11"> Components.utils.import(&quot;resource:///modules/PluralForm.jsm&quot;);</span>
<a href="#l52.12"></a><span id="l52.12" class="difflineminus">-Components.utils.import(&quot;resource:///modules/Services.jsm&quot;);</span>
<a href="#l52.13"></a><span id="l52.13" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l52.14"></a><span id="l52.14"> </span>
<a href="#l52.15"></a><span id="l52.15"> var MODULE_NAME = &quot;testAlarmDefaultValue&quot;;</span>
<a href="#l52.16"></a><span id="l52.16"> var RELATIVE_ROOT = &quot;./shared-modules&quot;;</span>
<a href="#l52.17"></a><span id="l52.17"> var MODULE_REQUIRES = [&quot;calendar-utils&quot;];</span>
<a href="#l52.18"></a><span id="l52.18"> </span>
<a href="#l52.19"></a><span id="l52.19"> var calendarController;</span>
<a href="#l52.20"></a><span id="l52.20"> var calUtils = require(&quot;shared-modules/calendar-utils&quot;);</span>
<a href="#l52.21"></a><span id="l52.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l53.1"></a><span id="l53.1" class="difflineminus">--- a/calendar/test/mozmill/testLocalICS.js</span>
<a href="#l53.2"></a><span id="l53.2" class="difflineplus">+++ b/calendar/test/mozmill/testLocalICS.js</span>
<a href="#l53.3"></a><span id="l53.3" class="difflineat">@@ -4,16 +4,17 @@</span>
<a href="#l53.4"></a><span id="l53.4"> </span>
<a href="#l53.5"></a><span id="l53.5"> const MODULE_NAME = &quot;testLocalICS&quot;;</span>
<a href="#l53.6"></a><span id="l53.6"> const RELATIVE_ROOT = &quot;./shared-modules&quot;;</span>
<a href="#l53.7"></a><span id="l53.7"> const MODULE_REQUIRES = [&quot;calendar-utils&quot;, &quot;window-helpers&quot;];</span>
<a href="#l53.8"></a><span id="l53.8"> </span>
<a href="#l53.9"></a><span id="l53.9"> var calUtils = require(&quot;./shared-modules/calendar-utils&quot;);</span>
<a href="#l53.10"></a><span id="l53.10"> var modalDialog; // Initialized in setupModule</span>
<a href="#l53.11"></a><span id="l53.11"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l53.12"></a><span id="l53.12" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l53.13"></a><span id="l53.13"> </span>
<a href="#l53.14"></a><span id="l53.14"> const sleep = 500;</span>
<a href="#l53.15"></a><span id="l53.15"> const TIMEOUT_MODAL_DIALOG = 30000;</span>
<a href="#l53.16"></a><span id="l53.16"> var hour = 8;</span>
<a href="#l53.17"></a><span id="l53.17"> var calendar;</span>
<a href="#l53.18"></a><span id="l53.18"> var uri;</span>
<a href="#l53.19"></a><span id="l53.19"> var file;</span>
<a href="#l53.20"></a><span id="l53.20"> var title;</span>
<a href="#l53.21"></a><span id="l53.21" class="difflineat">@@ -27,17 +28,17 @@ var setupModule = function(module) {</span>
<a href="#l53.22"></a><span id="l53.22">   let time = (new Date()).getTime() + '';</span>
<a href="#l53.23"></a><span id="l53.23">   calendar = time;</span>
<a href="#l53.24"></a><span id="l53.24">   title = time;</span>
<a href="#l53.25"></a><span id="l53.25">   </span>
<a href="#l53.26"></a><span id="l53.26">   file = Components.classes[&quot;@mozilla.org/file/directory_service;1&quot;]</span>
<a href="#l53.27"></a><span id="l53.27">                    .getService(Components.interfaces.nsIProperties)</span>
<a href="#l53.28"></a><span id="l53.28">                    .get(&quot;TmpD&quot;, Components.interfaces.nsIFile);</span>
<a href="#l53.29"></a><span id="l53.29">   file.append(calendar + &quot;.ics&quot;);</span>
<a href="#l53.30"></a><span id="l53.30" class="difflineminus">-  let fileURI = cal.getIOService().newFileURI(file);</span>
<a href="#l53.31"></a><span id="l53.31" class="difflineplus">+  let fileURI = Services.io.newFileURI(file);</span>
<a href="#l53.32"></a><span id="l53.32">   uri = fileURI.prePath + fileURI.path;</span>
<a href="#l53.33"></a><span id="l53.33"> }</span>
<a href="#l53.34"></a><span id="l53.34"> </span>
<a href="#l53.35"></a><span id="l53.35"> var testLocalICS = function () {</span>
<a href="#l53.36"></a><span id="l53.36">   controller.click(new elementslib.ID(controller.window.document,&quot;calendar-tab-button&quot;));</span>
<a href="#l53.37"></a><span id="l53.37">   calUtils.switchToView(controller, &quot;day&quot;);</span>
<a href="#l53.38"></a><span id="l53.38">   </span>
<a href="#l53.39"></a><span id="l53.39">   modalDialog.plan_for_modal_dialog(&quot;Calendar:NewCalendarWizard&quot;, handleNewCalendarWizard);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l54.1"></a><span id="l54.1" class="difflineminus">--- a/calendar/test/unit/head_consts.js</span>
<a href="#l54.2"></a><span id="l54.2" class="difflineplus">+++ b/calendar/test/unit/head_consts.js</span>
<a href="#l54.3"></a><span id="l54.3" class="difflineat">@@ -1,12 +1,14 @@</span>
<a href="#l54.4"></a><span id="l54.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l54.5"></a><span id="l54.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l54.6"></a><span id="l54.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l54.7"></a><span id="l54.7"> </span>
<a href="#l54.8"></a><span id="l54.8" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l54.9"></a><span id="l54.9" class="difflineplus">+</span>
<a href="#l54.10"></a><span id="l54.10"> const Cc = Components.classes;</span>
<a href="#l54.11"></a><span id="l54.11"> const Ci = Components.interfaces;</span>
<a href="#l54.12"></a><span id="l54.12"> </span>
<a href="#l54.13"></a><span id="l54.13"> (function load_lightning_manifest() {</span>
<a href="#l54.14"></a><span id="l54.14">   let bindir = Components.classes[&quot;@mozilla.org/file/directory_service;1&quot;]</span>
<a href="#l54.15"></a><span id="l54.15">                          .getService(Components.interfaces.nsIProperties)</span>
<a href="#l54.16"></a><span id="l54.16">                          .get(&quot;CurProcD&quot;, Components.interfaces.nsIFile);</span>
<a href="#l54.17"></a><span id="l54.17">   bindir.append(&quot;extensions&quot;);</span>
<a href="#l54.18"></a><span id="l54.18" class="difflineat">@@ -74,17 +76,17 @@ function getMemoryCal() {</span>
<a href="#l54.19"></a><span id="l54.19"> </span>
<a href="#l54.20"></a><span id="l54.20"> function getStorageCal() {</span>
<a href="#l54.21"></a><span id="l54.21">     var dirSvc = Cc[&quot;@mozilla.org/file/directory_service;1&quot;]</span>
<a href="#l54.22"></a><span id="l54.22">                  .getService(Ci.nsIProperties);</span>
<a href="#l54.23"></a><span id="l54.23">     var db = dirSvc.get(&quot;TmpD&quot;, Ci.nsIFile);</span>
<a href="#l54.24"></a><span id="l54.24">     db.append(&quot;test_storage.sqlite&quot;);</span>
<a href="#l54.25"></a><span id="l54.25"> </span>
<a href="#l54.26"></a><span id="l54.26">     // create URI</span>
<a href="#l54.27"></a><span id="l54.27" class="difflineminus">-    var uri = cal.getIOService().newFileURI(db);</span>
<a href="#l54.28"></a><span id="l54.28" class="difflineplus">+    var uri = Services.io.newFileURI(db);</span>
<a href="#l54.29"></a><span id="l54.29"> </span>
<a href="#l54.30"></a><span id="l54.30">     // Make sure timezone service is initialized</span>
<a href="#l54.31"></a><span id="l54.31">     Components.classes[&quot;@mozilla.org/calendar/timezone-service;1&quot;]</span>
<a href="#l54.32"></a><span id="l54.32">               .getService(Components.interfaces.calIStartupService)</span>
<a href="#l54.33"></a><span id="l54.33">               .startup(null);</span>
<a href="#l54.34"></a><span id="l54.34"> </span>
<a href="#l54.35"></a><span id="l54.35">     // create storage calendar</span>
<a href="#l54.36"></a><span id="l54.36">     var stor = Cc[&quot;@mozilla.org/calendar/calendar;1?type=storage&quot;]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l55.1"></a><span id="l55.1" class="difflineminus">--- a/calendar/test/unit/test_calmgr.js</span>
<a href="#l55.2"></a><span id="l55.2" class="difflineplus">+++ b/calendar/test/unit/test_calmgr.js</span>
<a href="#l55.3"></a><span id="l55.3" class="difflineat">@@ -1,14 +1,14 @@</span>
<a href="#l55.4"></a><span id="l55.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l55.5"></a><span id="l55.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l55.6"></a><span id="l55.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l55.7"></a><span id="l55.7"> </span>
<a href="#l55.8"></a><span id="l55.8"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l55.9"></a><span id="l55.9" class="difflineminus">-Components.utils.import(&quot;resource:///modules/Services.jsm&quot;);</span>
<a href="#l55.10"></a><span id="l55.10" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l55.11"></a><span id="l55.11"> </span>
<a href="#l55.12"></a><span id="l55.12"> /**</span>
<a href="#l55.13"></a><span id="l55.13">  * Tests the calICalendarManager interface</span>
<a href="#l55.14"></a><span id="l55.14">  */</span>
<a href="#l55.15"></a><span id="l55.15"> function run_test() {</span>
<a href="#l55.16"></a><span id="l55.16">     do_get_profile();</span>
<a href="#l55.17"></a><span id="l55.17">     add_test(test_registration);</span>
<a href="#l55.18"></a><span id="l55.18">     add_test(test_calobserver);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l56.1"></a><span id="l56.1" class="difflineminus">--- a/calendar/test/unit/test_webcal.js</span>
<a href="#l56.2"></a><span id="l56.2" class="difflineplus">+++ b/calendar/test/unit/test_webcal.js</span>
<a href="#l56.3"></a><span id="l56.3" class="difflineat">@@ -1,12 +1,14 @@</span>
<a href="#l56.4"></a><span id="l56.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l56.5"></a><span id="l56.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l56.6"></a><span id="l56.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l56.7"></a><span id="l56.7"> </span>
<a href="#l56.8"></a><span id="l56.8" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l56.9"></a><span id="l56.9" class="difflineplus">+</span>
<a href="#l56.10"></a><span id="l56.10"> do_load_httpd_js();</span>
<a href="#l56.11"></a><span id="l56.11"> </span>
<a href="#l56.12"></a><span id="l56.12"> var httpserver = null;</span>
<a href="#l56.13"></a><span id="l56.13"> </span>
<a href="#l56.14"></a><span id="l56.14"> // TODO webcals doesn't work since httpd.js doesn't support ssl without ssltunnel</span>
<a href="#l56.15"></a><span id="l56.15"> var testUris = [&quot;webcal://localhost:4444/test_webcal&quot;  /* ,</span>
<a href="#l56.16"></a><span id="l56.16">                 &quot;webcals://localhost:4445/test_webcals&quot; */</span>
<a href="#l56.17"></a><span id="l56.17">                ];</span>
<a href="#l56.18"></a><span id="l56.18" class="difflineat">@@ -29,17 +31,17 @@ var testListener = {</span>
<a href="#l56.19"></a><span id="l56.19">         startNextTest();</span>
<a href="#l56.20"></a><span id="l56.20">         do_test_finished();</span>
<a href="#l56.21"></a><span id="l56.21">     }</span>
<a href="#l56.22"></a><span id="l56.22"> };</span>
<a href="#l56.23"></a><span id="l56.23"> </span>
<a href="#l56.24"></a><span id="l56.24"> function startNextTest() {</span>
<a href="#l56.25"></a><span id="l56.25">     let nextUri = testUris.shift();</span>
<a href="#l56.26"></a><span id="l56.26">     if (nextUri) {</span>
<a href="#l56.27"></a><span id="l56.27" class="difflineminus">-        let chan = cal.getIOService().newChannel(nextUri, null, null);</span>
<a href="#l56.28"></a><span id="l56.28" class="difflineplus">+        let chan = Services.io.newChannel(nextUri, null, null);</span>
<a href="#l56.29"></a><span id="l56.29">         chan.asyncOpen(testListener, null);</span>
<a href="#l56.30"></a><span id="l56.30">         do_test_pending();</span>
<a href="#l56.31"></a><span id="l56.31">     } else {</span>
<a href="#l56.32"></a><span id="l56.32">         do_test_pending();</span>
<a href="#l56.33"></a><span id="l56.33">         httpserv.stop(do_test_finished);</span>
<a href="#l56.34"></a><span id="l56.34">     }</span>
<a href="#l56.35"></a><span id="l56.35"> }</span>
<a href="#l56.36"></a><span id="l56.36"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l57.1"></a><span id="l57.1" class="difflineminus">--- a/calendar/timezones/update.js</span>
<a href="#l57.2"></a><span id="l57.2" class="difflineplus">+++ b/calendar/timezones/update.js</span>
<a href="#l57.3"></a><span id="l57.3" class="difflineat">@@ -10,16 +10,18 @@</span>
<a href="#l57.4"></a><span id="l57.4">  * below.</span>
<a href="#l57.5"></a><span id="l57.5">  *</span>
<a href="#l57.6"></a><span id="l57.6">  * The update process is partially automated in the Makefile, please read its</span>
<a href="#l57.7"></a><span id="l57.7">  * header.</span>
<a href="#l57.8"></a><span id="l57.8">  *</span>
<a href="#l57.9"></a><span id="l57.9">  * args: &lt;path-to-zones.tab-file&gt; &lt;moz-root&gt; &lt;version&gt;</span>
<a href="#l57.10"></a><span id="l57.10">  */</span>
<a href="#l57.11"></a><span id="l57.11"> </span>
<a href="#l57.12"></a><span id="l57.12" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l57.13"></a><span id="l57.13" class="difflineplus">+</span>
<a href="#l57.14"></a><span id="l57.14"> function createFile(path) {</span>
<a href="#l57.15"></a><span id="l57.15">     var file = Components.classes[&quot;@mozilla.org/file/local;1&quot;]</span>
<a href="#l57.16"></a><span id="l57.16">                          .createInstance(Components.interfaces.nsILocalFile);</span>
<a href="#l57.17"></a><span id="l57.17">     file.initWithPath(path);</span>
<a href="#l57.18"></a><span id="l57.18">     return file;</span>
<a href="#l57.19"></a><span id="l57.19"> }</span>
<a href="#l57.20"></a><span id="l57.20"> </span>
<a href="#l57.21"></a><span id="l57.21"> function appendSegmentsToFile(file, segments) {</span>
<a href="#l57.22"></a><span id="l57.22" class="difflineat">@@ -121,21 +123,17 @@ try {</span>
<a href="#l57.23"></a><span id="l57.23">     // Read out timezone locale props:</span>
<a href="#l57.24"></a><span id="l57.24">     var localeProps = {};</span>
<a href="#l57.25"></a><span id="l57.25">     var bundleFile = createFile(arguments[1]);</span>
<a href="#l57.26"></a><span id="l57.26">     appendSegmentsToFile(bundleFile, [&quot;calendar&quot;, &quot;locales&quot;, &quot;en-US&quot;, &quot;chrome&quot;,</span>
<a href="#l57.27"></a><span id="l57.27">                                       &quot;calendar&quot;, &quot;timezones.properties&quot;]);</span>
<a href="#l57.28"></a><span id="l57.28">     if (!bundleFile.exists()) {</span>
<a href="#l57.29"></a><span id="l57.29">         throw &quot;No &quot; + bundleFile.path;</span>
<a href="#l57.30"></a><span id="l57.30">     }</span>
<a href="#l57.31"></a><span id="l57.31" class="difflineminus">-    var ioService = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l57.32"></a><span id="l57.32" class="difflineminus">-                              .getService(Components.interfaces.nsIIOService2);</span>
<a href="#l57.33"></a><span id="l57.33" class="difflineminus">-    var bundleService = Components.classes[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l57.34"></a><span id="l57.34" class="difflineminus">-                                  .getService(Components.interfaces.nsIStringBundleService);</span>
<a href="#l57.35"></a><span id="l57.35" class="difflineminus">-    var bundle = bundleService.createBundle(ioService.newFileURI(bundleFile).spec);</span>
<a href="#l57.36"></a><span id="l57.36" class="difflineplus">+    var bundle = Services.strings.createBundle(Services.io.newFileURI(bundleFile).spec);</span>
<a href="#l57.37"></a><span id="l57.37">     var enumerator = bundle.getSimpleEnumeration();</span>
<a href="#l57.38"></a><span id="l57.38">     while (enumerator.hasMoreElements()) {</span>
<a href="#l57.39"></a><span id="l57.39">         var prop = enumerator.getNext().QueryInterface(Components.interfaces.nsIPropertyElement);</span>
<a href="#l57.40"></a><span id="l57.40">         var name = prop.key;</span>
<a href="#l57.41"></a><span id="l57.41">         if (name.indexOf(&quot;pref.timezone.&quot;) == 0 &amp;&amp;</span>
<a href="#l57.42"></a><span id="l57.42">             name != &quot;pref.timezone.floating&quot; &amp;&amp;</span>
<a href="#l57.43"></a><span id="l57.43">             name != &quot;pref.timezone.UTC&quot;) {</span>
<a href="#l57.44"></a><span id="l57.44">             localeProps[name.substr(&quot;pref.timezone.&quot;.length).replace(/\./g, &quot;/&quot;)] = (name + &quot;=&quot; + prop.value);</span>
<a href="#l57.45"></a><span id="l57.45" class="difflineat">@@ -171,19 +169,17 @@ try {</span>
<a href="#l57.46"></a><span id="l57.46">             }</span>
<a href="#l57.47"></a><span id="l57.47">         }</span>
<a href="#l57.48"></a><span id="l57.48">     }</span>
<a href="#l57.49"></a><span id="l57.49">     print(&quot;---\n\n&quot;);</span>
<a href="#l57.50"></a><span id="l57.50"> </span>
<a href="#l57.51"></a><span id="l57.51">     // then read old set:</span>
<a href="#l57.52"></a><span id="l57.52">     var oldSet = {};</span>
<a href="#l57.53"></a><span id="l57.53"> </span>
<a href="#l57.54"></a><span id="l57.54" class="difflineminus">-    var dbService = Components.classes[&quot;@mozilla.org/storage/service;1&quot;]</span>
<a href="#l57.55"></a><span id="l57.55" class="difflineminus">-                              .getService(Components.interfaces.mozIStorageService);</span>
<a href="#l57.56"></a><span id="l57.56" class="difflineminus">-    var db = dbService.openDatabase(sqlTzFile);</span>
<a href="#l57.57"></a><span id="l57.57" class="difflineplus">+    var db = Services.storage.openDatabase(sqlTzFile);</span>
<a href="#l57.58"></a><span id="l57.58"> </span>
<a href="#l57.59"></a><span id="l57.59">     let statement;</span>
<a href="#l57.60"></a><span id="l57.60">     try {</span>
<a href="#l57.61"></a><span id="l57.61">         statement = db.createStatement(&quot;SELECT * FROM tz_data WHERE alias IS NULL&quot;);</span>
<a href="#l57.62"></a><span id="l57.62">         while (statement.executeStep()) {</span>
<a href="#l57.63"></a><span id="l57.63">             var row = statement.row;</span>
<a href="#l57.64"></a><span id="l57.64">             oldSet[row.tzid] = new calIntrinsicTimezone(row.latitude,</span>
<a href="#l57.65"></a><span id="l57.65">                                                         row.longitude,</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

