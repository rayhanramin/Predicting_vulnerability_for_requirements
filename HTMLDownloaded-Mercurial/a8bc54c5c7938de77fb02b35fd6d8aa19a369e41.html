<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 29515:a8bc54c5c7938de77fb02b35fd6d8aa19a369e41</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ a8bc54c5c7938de77fb02b35fd6d8aa19a369e41" />
<meta property="og:url" content="/comm-central/rev/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41" />
<meta property="og:description" content="Bug 1636019 - Remove the remaining uses of nsIAbView, then remove it and nsAbView. r=mkmelin DONTBUILD" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / a8bc54c5c7938de77fb02b35fd6d8aa19a369e41 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41">shortlog</a> |
<a href="/comm-central/log/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41">files</a> |
changeset |
<a href="/comm-central/raw-rev/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41">raw</a>  | <a href="/comm-central/archive/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1636019">Bug 1636019</a> - Remove the remaining uses of nsIAbView, then remove it and nsAbView. r=mkmelin DONTBUILD
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 07 May 2020 15:13:24 +1200</td></tr>

<tr>
 <td>changeset 29515</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41">a8bc54c5c7938de77fb02b35fd6d8aa19a369e41</a></td>
</tr>



<tr>
<td>parent 29514</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/2420430174e2f1e4a4e76d6af3a29f67258c564a">2420430174e2f1e4a4e76d6af3a29f67258c564a</a>
</td>
</tr>

<tr>
<td>child 29516</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/01d4d3db44e6c509076df5fda8f37064d9652c78">01d4d3db44e6c509076df5fda8f37064d9652c78</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=a8bc54c5c7938de77fb02b35fd6d8aa19a369e41">17410</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Fri, 08 May 2020 09:04:58 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@a8bc54c5c793 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a8bc54c5c7938de77fb02b35fd6d8aa19a369e41">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a8bc54c5c7938de77fb02b35fd6d8aa19a369e41&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a8bc54c5c7938de77fb02b35fd6d8aa19a369e41&newProject=comm-central&newRevision=2420430174e2f1e4a4e76d6af3a29f67258c564a&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a8bc54c5c7938de77fb02b35fd6d8aa19a369e41&newProject=comm-central&newRevision=2420430174e2f1e4a4e76d6af3a29f67258c564a&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a8bc54c5c7938de77fb02b35fd6d8aa19a369e41&newProject=comm-central&newRevision=2420430174e2f1e4a4e76d6af3a29f67258c564a&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1636019">1636019</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1636019">Bug 1636019</a> - Remove the remaining uses of nsIAbView, then remove it and nsAbView. r=mkmelin DONTBUILD</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mail/base/content/mailCommands.js">mail/base/content/mailCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mail/base/content/mailCommands.js">file</a> |
<a href="/comm-central/annotate/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mail/base/content/mailCommands.js">annotate</a> |
<a href="/comm-central/diff/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mail/base/content/mailCommands.js">diff</a> |
<a href="/comm-central/comparison/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mail/base/content/mailCommands.js">comparison</a> |
<a href="/comm-central/log/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mail/base/content/mailCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mail/components/addrbook/content/abContactsPanel.xhtml">mail/components/addrbook/content/abContactsPanel.xhtml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mail/components/addrbook/content/abContactsPanel.xhtml">file</a> |
<a href="/comm-central/annotate/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mail/components/addrbook/content/abContactsPanel.xhtml">annotate</a> |
<a href="/comm-central/diff/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mail/components/addrbook/content/abContactsPanel.xhtml">diff</a> |
<a href="/comm-central/comparison/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mail/components/addrbook/content/abContactsPanel.xhtml">comparison</a> |
<a href="/comm-central/log/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mail/components/addrbook/content/abContactsPanel.xhtml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mail/components/addrbook/content/addressbook.xhtml">mail/components/addrbook/content/addressbook.xhtml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mail/components/addrbook/content/addressbook.xhtml">file</a> |
<a href="/comm-central/annotate/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mail/components/addrbook/content/addressbook.xhtml">annotate</a> |
<a href="/comm-central/diff/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mail/components/addrbook/content/addressbook.xhtml">diff</a> |
<a href="/comm-central/comparison/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mail/components/addrbook/content/addressbook.xhtml">comparison</a> |
<a href="/comm-central/log/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mail/components/addrbook/content/addressbook.xhtml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mail/components/addrbook/test/browser/browser_contact_tree.js">mail/components/addrbook/test/browser/browser_contact_tree.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mail/components/addrbook/test/browser/browser_contact_tree.js">file</a> |
<a href="/comm-central/annotate/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mail/components/addrbook/test/browser/browser_contact_tree.js">annotate</a> |
<a href="/comm-central/diff/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mail/components/addrbook/test/browser/browser_contact_tree.js">diff</a> |
<a href="/comm-central/comparison/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mail/components/addrbook/test/browser/browser_contact_tree.js">comparison</a> |
<a href="/comm-central/log/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mail/components/addrbook/test/browser/browser_contact_tree.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mail/components/addrbook/test/browser/browser_search.js">mail/components/addrbook/test/browser/browser_search.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mail/components/addrbook/test/browser/browser_search.js">file</a> |
<a href="/comm-central/annotate/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mail/components/addrbook/test/browser/browser_search.js">annotate</a> |
<a href="/comm-central/diff/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mail/components/addrbook/test/browser/browser_search.js">diff</a> |
<a href="/comm-central/comparison/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mail/components/addrbook/test/browser/browser_search.js">comparison</a> |
<a href="/comm-central/log/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mail/components/addrbook/test/browser/browser_search.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mail/locales/en-US/chrome/messenger/addressbook/abMainWindow.dtd">mail/locales/en-US/chrome/messenger/addressbook/abMainWindow.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mail/locales/en-US/chrome/messenger/addressbook/abMainWindow.dtd">file</a> |
<a href="/comm-central/annotate/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mail/locales/en-US/chrome/messenger/addressbook/abMainWindow.dtd">annotate</a> |
<a href="/comm-central/diff/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mail/locales/en-US/chrome/messenger/addressbook/abMainWindow.dtd">diff</a> |
<a href="/comm-central/comparison/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mail/locales/en-US/chrome/messenger/addressbook/abMainWindow.dtd">comparison</a> |
<a href="/comm-central/log/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mail/locales/en-US/chrome/messenger/addressbook/abMainWindow.dtd">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/content/abResultsPane.js">mailnews/addrbook/content/abResultsPane.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/content/abResultsPane.js">file</a> |
<a href="/comm-central/annotate/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/content/abResultsPane.js">annotate</a> |
<a href="/comm-central/diff/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/content/abResultsPane.js">diff</a> |
<a href="/comm-central/comparison/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/content/abResultsPane.js">comparison</a> |
<a href="/comm-central/log/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/content/abResultsPane.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/content/abView.js">mailnews/addrbook/content/abView.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/content/abView.js">file</a> |
<a href="/comm-central/annotate/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/content/abView.js">annotate</a> |
<a href="/comm-central/diff/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/content/abView.js">diff</a> |
<a href="/comm-central/comparison/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/content/abView.js">comparison</a> |
<a href="/comm-central/log/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/content/abView.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/public/moz.build">mailnews/addrbook/public/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/public/moz.build">file</a> |
<a href="/comm-central/annotate/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/public/moz.build">annotate</a> |
<a href="/comm-central/diff/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/public/moz.build">diff</a> |
<a href="/comm-central/comparison/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/public/moz.build">comparison</a> |
<a href="/comm-central/log/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/public/moz.build">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/public/nsAbBaseCID.h">mailnews/addrbook/public/nsAbBaseCID.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/public/nsAbBaseCID.h">file</a> |
<a href="/comm-central/annotate/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/public/nsAbBaseCID.h">annotate</a> |
<a href="/comm-central/diff/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/public/nsAbBaseCID.h">diff</a> |
<a href="/comm-central/comparison/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/public/nsAbBaseCID.h">comparison</a> |
<a href="/comm-central/log/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/public/nsAbBaseCID.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/public/nsIAbView.idl">mailnews/addrbook/public/nsIAbView.idl</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/public/nsIAbView.idl">diff</a> |
<a href="/comm-central/comparison/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/public/nsIAbView.idl">comparison</a> |
<a href="/comm-central/log/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/public/nsIAbView.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/src/moz.build">mailnews/addrbook/src/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/src/moz.build">file</a> |
<a href="/comm-central/annotate/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/src/moz.build">annotate</a> |
<a href="/comm-central/diff/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/src/moz.build">diff</a> |
<a href="/comm-central/comparison/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/src/moz.build">comparison</a> |
<a href="/comm-central/log/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/src/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/src/nsAbView.cpp">mailnews/addrbook/src/nsAbView.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/src/nsAbView.cpp">diff</a> |
<a href="/comm-central/comparison/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/src/nsAbView.cpp">comparison</a> |
<a href="/comm-central/log/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/src/nsAbView.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/src/nsAbView.h">mailnews/addrbook/src/nsAbView.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/src/nsAbView.h">diff</a> |
<a href="/comm-central/comparison/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/src/nsAbView.h">comparison</a> |
<a href="/comm-central/log/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/src/nsAbView.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp">mailnews/addrbook/src/nsAddbookProtocolHandler.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp">file</a> |
<a href="/comm-central/annotate/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp">annotate</a> |
<a href="/comm-central/diff/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp">diff</a> |
<a href="/comm-central/comparison/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp">comparison</a> |
<a href="/comm-central/log/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/build/nsMailModule.cpp">mailnews/build/nsMailModule.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/build/nsMailModule.cpp">file</a> |
<a href="/comm-central/annotate/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/build/nsMailModule.cpp">annotate</a> |
<a href="/comm-central/diff/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/build/nsMailModule.cpp">diff</a> |
<a href="/comm-central/comparison/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/build/nsMailModule.cpp">comparison</a> |
<a href="/comm-central/log/a8bc54c5c7938de77fb02b35fd6d8aa19a369e41/mailnews/build/nsMailModule.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/mailCommands.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/mailCommands.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -167,36 +167,25 @@ function ComposeMessage(type, format, fo</span>
<a href="#l1.4"></a><span id="l1.4">   }</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6">   // dump(&quot;\nComposeMessage from XUL: &quot; + identity + &quot;\n&quot;);</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8">   switch (type) {</span>
<a href="#l1.9"></a><span id="l1.9">     case msgComposeType.New: // new message</span>
<a href="#l1.10"></a><span id="l1.10">       // dump(&quot;OpenComposeWindow with &quot; + identity + &quot;\n&quot;);</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-      // If the addressbook sidebar panel is open and has focus, get</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-      // the selected addresses from it.</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-      if (</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-        document.commandDispatcher.focusedWindow &amp;&amp;</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-        document.commandDispatcher.focusedWindow.document.documentElement.hasAttribute(</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-          &quot;selectedaddresses&quot;</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-        )</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineminus">-      ) {</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">-        NewMessageToSelectedAddresses(type, format, identity);</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineminus">-      } else {</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineminus">-        MailServices.compose.OpenComposeWindow(</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineminus">-          null,</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineminus">-          null,</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineminus">-          null,</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineminus">-          type,</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineminus">-          format,</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">-          identity,</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineminus">-          msgWindow</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-        );</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-      }</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+      MailServices.compose.OpenComposeWindow(</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+        null,</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+        null,</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+        null,</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+        type,</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+        format,</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+        identity,</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+        msgWindow</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+      );</span>
<a href="#l1.41"></a><span id="l1.41">       return;</span>
<a href="#l1.42"></a><span id="l1.42">     case msgComposeType.NewsPost:</span>
<a href="#l1.43"></a><span id="l1.43">       // dump(&quot;OpenComposeWindow with &quot; + identity + &quot; and &quot; + newsgroup + &quot;\n&quot;);</span>
<a href="#l1.44"></a><span id="l1.44">       MailServices.compose.OpenComposeWindow(</span>
<a href="#l1.45"></a><span id="l1.45">         null,</span>
<a href="#l1.46"></a><span id="l1.46">         null,</span>
<a href="#l1.47"></a><span id="l1.47">         newsgroup,</span>
<a href="#l1.48"></a><span id="l1.48">         type,</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineat">@@ -272,45 +261,16 @@ function ComposeMessage(type, format, fo</span>
<a href="#l1.50"></a><span id="l1.50">             msgWindow</span>
<a href="#l1.51"></a><span id="l1.51">           );</span>
<a href="#l1.52"></a><span id="l1.52">         }</span>
<a href="#l1.53"></a><span id="l1.53">       }</span>
<a href="#l1.54"></a><span id="l1.54">   }</span>
<a href="#l1.55"></a><span id="l1.55"> }</span>
<a href="#l1.56"></a><span id="l1.56"> /* eslint-enable complexity */</span>
<a href="#l1.57"></a><span id="l1.57"> </span>
<a href="#l1.58"></a><span id="l1.58" class="difflineminus">-function NewMessageToSelectedAddresses(type, format, identity) {</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineminus">-  var abSidebarPanel = document.commandDispatcher.focusedWindow;</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-  var abResultsTree = abSidebarPanel.document.getElementById(&quot;abResultsTree&quot;);</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineminus">-  var abView = abResultsTree.view;</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineminus">-  abView = abView.QueryInterface(Ci.nsIAbView);</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineminus">-  var addresses = abView.selectedAddresses;</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineminus">-  var params = Cc[</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineminus">-    &quot;@mozilla.org/messengercompose/composeparams;1&quot;</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineminus">-  ].createInstance(Ci.nsIMsgComposeParams);</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineminus">-  if (params) {</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineminus">-    params.type = type;</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineminus">-    params.format = format;</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineminus">-    params.identity = identity;</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineminus">-    var composeFields = Cc[</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineminus">-      &quot;@mozilla.org/messengercompose/composefields;1&quot;</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineminus">-    ].createInstance(Ci.nsIMsgCompFields);</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineminus">-    if (composeFields) {</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineminus">-      let addressList = [];</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineminus">-      const nsISupportsString = Ci.nsISupportsString;</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineminus">-      for (let i = 0; i &lt; addresses.length; i++) {</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineminus">-        addressList.push(addresses.queryElementAt(i, nsISupportsString).data);</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineminus">-      }</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineminus">-      composeFields.to = addressList.join(&quot;,&quot;);</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineminus">-      params.composeFields = composeFields;</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineminus">-      MailServices.compose.OpenComposeWindowWithParams(null, params);</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineminus">-    }</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineminus">-  }</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineminus">-}</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineminus">-</span>
<a href="#l1.87"></a><span id="l1.87"> function Subscribe(preselectedMsgFolder) {</span>
<a href="#l1.88"></a><span id="l1.88">   window.openDialog(</span>
<a href="#l1.89"></a><span id="l1.89">     &quot;chrome://messenger/content/subscribe.xhtml&quot;,</span>
<a href="#l1.90"></a><span id="l1.90">     &quot;subscribe&quot;,</span>
<a href="#l1.91"></a><span id="l1.91">     &quot;chrome,modal,titlebar,resizable=yes&quot;,</span>
<a href="#l1.92"></a><span id="l1.92">     {</span>
<a href="#l1.93"></a><span id="l1.93">       folder: preselectedMsgFolder,</span>
<a href="#l1.94"></a><span id="l1.94">       okCallback: SubscribeOKCallback,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/components/addrbook/content/abContactsPanel.xhtml</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/components/addrbook/content/abContactsPanel.xhtml</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -12,18 +12,17 @@</span>
<a href="#l2.4"></a><span id="l2.4"> %abResultsPaneDTD;</span>
<a href="#l2.5"></a><span id="l2.5"> &lt;!ENTITY % abContactsPanelDTD SYSTEM &quot;chrome://messenger/locale/addressbook/abContactsPanel.dtd&quot; &gt;</span>
<a href="#l2.6"></a><span id="l2.6"> %abContactsPanelDTD;</span>
<a href="#l2.7"></a><span id="l2.7"> ]&gt;</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9"> &lt;window id=&quot;abContactsPanel&quot;</span>
<a href="#l2.10"></a><span id="l2.10">         xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot; xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;</span>
<a href="#l2.11"></a><span id="l2.11">         onload=&quot;AbPanelLoad();&quot;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-        onunload=&quot;AbPanelUnload();&quot;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-        selectedaddresses=&quot;true&quot;&gt;</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+        onunload=&quot;AbPanelUnload();&quot;&gt;</span>
<a href="#l2.15"></a><span id="l2.15"> </span>
<a href="#l2.16"></a><span id="l2.16">   &lt;stringbundle id=&quot;bundle_addressBook&quot; src=&quot;chrome://messenger/locale/addressbook/addressBook.properties&quot;/&gt;</span>
<a href="#l2.17"></a><span id="l2.17"> </span>
<a href="#l2.18"></a><span id="l2.18">   &lt;script src=&quot;chrome://global/content/globalOverlay.js&quot;/&gt;</span>
<a href="#l2.19"></a><span id="l2.19">   &lt;script src=&quot;chrome://global/content/editMenuOverlay.js&quot;/&gt;</span>
<a href="#l2.20"></a><span id="l2.20">   &lt;script src=&quot;chrome://communicator/content/utilityOverlay.js&quot;/&gt;</span>
<a href="#l2.21"></a><span id="l2.21">   &lt;script src=&quot;chrome://messenger/content/addressbook/addressbook.js&quot;/&gt;</span>
<a href="#l2.22"></a><span id="l2.22">   &lt;script src=&quot;chrome://messenger/content/addressbook/abDragDrop.js&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/components/addrbook/content/addressbook.xhtml</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/components/addrbook/content/addressbook.xhtml</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -430,21 +430,16 @@</span>
<a href="#l3.4"></a><span id="l3.4">             &lt;menuitem id=&quot;menu_search_addresses&quot;</span>
<a href="#l3.5"></a><span id="l3.5">                       label=&quot;&amp;searchAddressesCmd.label;&quot;</span>
<a href="#l3.6"></a><span id="l3.6">                       accesskey=&quot;&amp;searchAddressesCmd.accesskey;&quot;</span>
<a href="#l3.7"></a><span id="l3.7">                       key=&quot;key_searchAddresses&quot;</span>
<a href="#l3.8"></a><span id="l3.8">                       oncommand=&quot;onAdvancedAbSearch();&quot;</span>
<a href="#l3.9"></a><span id="l3.9">                       class=&quot;menuitem-iconic&quot;/&gt;</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11">             &lt;menuseparator/&gt;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-            &lt;!-- LOCALIZATION NOTE: set &quot;hideSwapFnLnUI&quot; to false in .dtd to enable the UI --&gt;</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-            &lt;menuitem label=&quot;&amp;swapFirstNameLastNameCmd.label;&quot;</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-                      accesskey=&quot;&amp;swapFirstNameLastNameCmd.accesskey;&quot;</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-                      hidden=&quot;&amp;hideSwapFnLnUI;&quot;</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-                      oncommand=&quot;AbSwapFirstNameLastName()&quot;/&gt;</span>
<a href="#l3.17"></a><span id="l3.17">             &lt;menuitem id=&quot;menu_properties&quot;</span>
<a href="#l3.18"></a><span id="l3.18">                       key=&quot;key_properties&quot;</span>
<a href="#l3.19"></a><span id="l3.19">                       command=&quot;cmd_properties&quot;</span>
<a href="#l3.20"></a><span id="l3.20">                       label=&quot;&amp;propertiesContext.label;&quot;</span>
<a href="#l3.21"></a><span id="l3.21">                       accesskey=&quot;&amp;propertiesContext.accesskey;&quot;</span>
<a href="#l3.22"></a><span id="l3.22">                       valueGeneric=&quot;&amp;propertiesMenu.label;&quot;</span>
<a href="#l3.23"></a><span id="l3.23">                       valueGenericAccessKey=&quot;&amp;propertiesMenu.accesskey;&quot;</span>
<a href="#l3.24"></a><span id="l3.24">                       valueAddressBook=&quot;&amp;abPropertiesMenu.label;&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/components/addrbook/test/browser/browser_contact_tree.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/components/addrbook/test/browser/browser_contact_tree.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -93,31 +93,30 @@ add_task(async () =&gt; {</span>
<a href="#l4.4"></a><span id="l4.4">   function deleteRowWithPrompt(row) {</span>
<a href="#l4.5"></a><span id="l4.5">     let promptPromise = BrowserTestUtils.promiseAlertDialogOpen(&quot;accept&quot;);</span>
<a href="#l4.6"></a><span id="l4.6">     mailTestUtils.treeClick(EventUtils, abWindow, abContactTree, row, 0, {});</span>
<a href="#l4.7"></a><span id="l4.7">     EventUtils.synthesizeKey(&quot;VK_DELETE&quot;, {}, abWindow);</span>
<a href="#l4.8"></a><span id="l4.8">     return promptPromise;</span>
<a href="#l4.9"></a><span id="l4.9">   }</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11">   function checkRows(...expectedCards) {</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    abContactTree.view.QueryInterface(Ci.nsIAbView);</span>
<a href="#l4.13"></a><span id="l4.13">     Assert.equal(</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-      abContactTree.view.rowCount,</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+      abWindow.gAbView.rowCount,</span>
<a href="#l4.16"></a><span id="l4.16">       expectedCards.length,</span>
<a href="#l4.17"></a><span id="l4.17">       &quot;rowCount correct&quot;</span>
<a href="#l4.18"></a><span id="l4.18">     );</span>
<a href="#l4.19"></a><span id="l4.19">     for (let i = 0; i &lt; expectedCards.length; i++) {</span>
<a href="#l4.20"></a><span id="l4.20">       if (expectedCards[i].isMailList) {</span>
<a href="#l4.21"></a><span id="l4.21">         Assert.equal(</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineminus">-          abContactTree.view.getCardFromRow(i).displayName,</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+          abWindow.gAbView.getCardFromRow(i).displayName,</span>
<a href="#l4.24"></a><span id="l4.24">           expectedCards[i].dirName</span>
<a href="#l4.25"></a><span id="l4.25">         );</span>
<a href="#l4.26"></a><span id="l4.26">       } else {</span>
<a href="#l4.27"></a><span id="l4.27">         Assert.equal(</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineminus">-          abContactTree.view.getCardFromRow(i).displayName,</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+          abWindow.gAbView.getCardFromRow(i).displayName,</span>
<a href="#l4.30"></a><span id="l4.30">           expectedCards[i].displayName</span>
<a href="#l4.31"></a><span id="l4.31">         );</span>
<a href="#l4.32"></a><span id="l4.32">       }</span>
<a href="#l4.33"></a><span id="l4.33">     }</span>
<a href="#l4.34"></a><span id="l4.34">   }</span>
<a href="#l4.35"></a><span id="l4.35"> </span>
<a href="#l4.36"></a><span id="l4.36">   let bookA = createAddressBook(&quot;book A&quot;);</span>
<a href="#l4.37"></a><span id="l4.37">   let contactA1 = bookA.addCard(createContact(&quot;contact&quot;, &quot;A1&quot;));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/components/addrbook/test/browser/browser_search.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/components/addrbook/test/browser/browser_search.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -27,18 +27,17 @@ add_task(async () =&gt; {</span>
<a href="#l5.4"></a><span id="l5.4">       }</span>
<a href="#l5.5"></a><span id="l5.5">     });</span>
<a href="#l5.6"></a><span id="l5.6">   }</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8">   function checkRows(...expectedCards) {</span>
<a href="#l5.9"></a><span id="l5.9">     is(resultsTree.view.rowCount, expectedCards.length, &quot;rowCount correct&quot;);</span>
<a href="#l5.10"></a><span id="l5.10">     for (let i = 0; i &lt; expectedCards.length; i++) {</span>
<a href="#l5.11"></a><span id="l5.11">       is(</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-        resultsTree.view.QueryInterface(Ci.nsIAbView).getCardFromRow(i)</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-          .displayName,</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+        abWindow.gAbView.getCardFromRow(i).displayName,</span>
<a href="#l5.15"></a><span id="l5.15">         expectedCards[i].displayName,</span>
<a href="#l5.16"></a><span id="l5.16">         `row ${i} has the right contact`</span>
<a href="#l5.17"></a><span id="l5.17">       );</span>
<a href="#l5.18"></a><span id="l5.18">     }</span>
<a href="#l5.19"></a><span id="l5.19">   }</span>
<a href="#l5.20"></a><span id="l5.20"> </span>
<a href="#l5.21"></a><span id="l5.21">   let personalBook = MailServices.ab.getDirectoryFromId(&quot;ldap_2.servers.pab&quot;);</span>
<a href="#l5.22"></a><span id="l5.22">   let historyBook = MailServices.ab.getDirectoryFromId(</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/addressbook/abMainWindow.dtd</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/addressbook/abMainWindow.dtd</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -47,21 +47,16 @@</span>
<a href="#l6.4"></a><span id="l6.4"> &lt;!ENTITY deleteCmd.label                                &quot;Delete&quot;&gt;</span>
<a href="#l6.5"></a><span id="l6.5"> &lt;!ENTITY deleteAbCmd.label                              &quot;Delete Address Book&quot;&gt;</span>
<a href="#l6.6"></a><span id="l6.6"> &lt;!ENTITY deleteContactCmd.label                         &quot;Delete Contact&quot;&gt;</span>
<a href="#l6.7"></a><span id="l6.7"> &lt;!ENTITY deleteContactsCmd.label                        &quot;Delete Contacts&quot;&gt;</span>
<a href="#l6.8"></a><span id="l6.8"> &lt;!ENTITY deleteListCmd.label                            &quot;Delete List&quot;&gt;</span>
<a href="#l6.9"></a><span id="l6.9"> &lt;!ENTITY deleteListsCmd.label                           &quot;Delete Lists&quot;&gt;</span>
<a href="#l6.10"></a><span id="l6.10"> &lt;!ENTITY deleteItemsCmd.label                           &quot;Delete Items&quot;&gt;</span>
<a href="#l6.11"></a><span id="l6.11"> &lt;!ENTITY searchAddressesCmd.key                         &quot;f&quot;&gt;</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-&lt;!ENTITY swapFirstNameLastNameCmd.label                 &quot;Swap First/Last Name&quot;&gt;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-&lt;!ENTITY swapFirstNameLastNameCmd.accesskey             &quot;w&quot;&gt;</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-&lt;!-- LOCALIZATION NOTE (hideSwapFnLnUI) : DONT_TRANSLATE --&gt;</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-&lt;!-- Swap FN/LN UI  Set to &quot;false&quot; to show swap fn/ln UI --&gt;</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-&lt;!ENTITY hideSwapFnLnUI &quot;true&quot;&gt;</span>
<a href="#l6.17"></a><span id="l6.17"> &lt;!ENTITY propertiesMenu.label                           &quot;Properties&quot;&gt;</span>
<a href="#l6.18"></a><span id="l6.18"> &lt;!ENTITY propertiesMenu.accesskey                       &quot;i&quot;&gt;</span>
<a href="#l6.19"></a><span id="l6.19"> &lt;!ENTITY propertiesCmd.key                              &quot;i&quot;&gt;</span>
<a href="#l6.20"></a><span id="l6.20"> &lt;!ENTITY abPropertiesMenu.label                         &quot;Address Book Properties&quot;&gt;</span>
<a href="#l6.21"></a><span id="l6.21"> &lt;!ENTITY abPropertiesMenu.accesskey                     &quot;i&quot;&gt;</span>
<a href="#l6.22"></a><span id="l6.22"> &lt;!ENTITY contactPropertiesMenu.label                    &quot;Contact Properties&quot;&gt;</span>
<a href="#l6.23"></a><span id="l6.23"> &lt;!ENTITY contactPropertiesMenu.accesskey                &quot;i&quot;&gt;</span>
<a href="#l6.24"></a><span id="l6.24"> &lt;!ENTITY mailingListPropertiesMenu.label                &quot;Mailing List Properties&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/addrbook/content/abResultsPane.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/addrbook/content/abResultsPane.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -31,28 +31,29 @@</span>
<a href="#l7.4"></a><span id="l7.4"> var kNothingSelected = 0;</span>
<a href="#l7.5"></a><span id="l7.5"> var kListsAndCards = 1;</span>
<a href="#l7.6"></a><span id="l7.6"> var kMultipleListsOnly = 2;</span>
<a href="#l7.7"></a><span id="l7.7"> var kSingleListOnly = 3;</span>
<a href="#l7.8"></a><span id="l7.8"> var kCardsOnly = 4;</span>
<a href="#l7.9"></a><span id="l7.9"> </span>
<a href="#l7.10"></a><span id="l7.10"> // Global Variables</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-// gAbView holds an object with an nsIAbView interface</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-var gAbView = null;</span>
<a href="#l7.14"></a><span id="l7.14"> // Holds a reference to the &quot;abResultsTree&quot; document element. Initially</span>
<a href="#l7.15"></a><span id="l7.15"> // set up by SetAbView.</span>
<a href="#l7.16"></a><span id="l7.16"> var gAbResultsTree = null;</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+// gAbView is the current value of gAbResultsTree.view, without passing</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+// through XPCOM, so we can access extra functions if necessary.</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+var gAbView = null;</span>
<a href="#l7.20"></a><span id="l7.20"> </span>
<a href="#l7.21"></a><span id="l7.21"> function SetAbView(aURI, aSearchQuery) {</span>
<a href="#l7.22"></a><span id="l7.22">   // If we don't have a URI, just clear the view and leave everything else</span>
<a href="#l7.23"></a><span id="l7.23">   // alone.</span>
<a href="#l7.24"></a><span id="l7.24">   if (!aURI) {</span>
<a href="#l7.25"></a><span id="l7.25">     if (gAbView) {</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-      gAbView.clearView();</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+      CloseAbView();</span>
<a href="#l7.28"></a><span id="l7.28">     }</span>
<a href="#l7.29"></a><span id="l7.29">     return;</span>
<a href="#l7.30"></a><span id="l7.30">   }</span>
<a href="#l7.31"></a><span id="l7.31"> </span>
<a href="#l7.32"></a><span id="l7.32">   // If we do have a URI, we want to allow updating the review even if the</span>
<a href="#l7.33"></a><span id="l7.33">   // URI is the same, as the search results may be different.</span>
<a href="#l7.34"></a><span id="l7.34"> </span>
<a href="#l7.35"></a><span id="l7.35">   var sortColumn = kDefaultSortColumn;</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineat">@@ -266,22 +267,16 @@ function GetSelectedRows() {</span>
<a href="#l7.37"></a><span id="l7.37">       }</span>
<a href="#l7.38"></a><span id="l7.38">       selectedRows += j;</span>
<a href="#l7.39"></a><span id="l7.39">     }</span>
<a href="#l7.40"></a><span id="l7.40">   }</span>
<a href="#l7.41"></a><span id="l7.41"> </span>
<a href="#l7.42"></a><span id="l7.42">   return selectedRows;</span>
<a href="#l7.43"></a><span id="l7.43"> }</span>
<a href="#l7.44"></a><span id="l7.44"> </span>
<a href="#l7.45"></a><span id="l7.45" class="difflineminus">-function AbSwapFirstNameLastName() {</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineminus">-  if (gAbView) {</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineminus">-    gAbView.swapFirstNameLastName();</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineminus">-  }</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-}</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-</span>
<a href="#l7.51"></a><span id="l7.51"> function AbEditSelectedCard() {</span>
<a href="#l7.52"></a><span id="l7.52">   AbEditCard(GetSelectedCard());</span>
<a href="#l7.53"></a><span id="l7.53"> }</span>
<a href="#l7.54"></a><span id="l7.54"> </span>
<a href="#l7.55"></a><span id="l7.55"> function AbResultsPaneOnClick(event) {</span>
<a href="#l7.56"></a><span id="l7.56">   // we only care about button 0 (left click) events</span>
<a href="#l7.57"></a><span id="l7.57">   if (event.button != 0) {</span>
<a href="#l7.58"></a><span id="l7.58">     return;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/addrbook/content/abView.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/addrbook/content/abView.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -25,54 +25,38 @@ function ABView(directory, searchQuery, </span>
<a href="#l8.4"></a><span id="l8.4">       this.listener.onCountChanged(this.rowCount);</span>
<a href="#l8.5"></a><span id="l8.5">     }</span>
<a href="#l8.6"></a><span id="l8.6">   }</span>
<a href="#l8.7"></a><span id="l8.7">   this.sortBy(sortColumn, sortDirection);</span>
<a href="#l8.8"></a><span id="l8.8"> }</span>
<a href="#l8.9"></a><span id="l8.9"> ABView.prototype = {</span>
<a href="#l8.10"></a><span id="l8.10">   QueryInterface: ChromeUtils.generateQI([</span>
<a href="#l8.11"></a><span id="l8.11">     Ci.nsITreeView,</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-    Ci.nsIAbView,</span>
<a href="#l8.13"></a><span id="l8.13">     Ci.nsIAbDirSearchListener,</span>
<a href="#l8.14"></a><span id="l8.14">     Ci.nsIObserver,</span>
<a href="#l8.15"></a><span id="l8.15">     Ci.nsISupportsWeakReference,</span>
<a href="#l8.16"></a><span id="l8.16">   ]),</span>
<a href="#l8.17"></a><span id="l8.17"> </span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+  directory: null,</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+  listener: null,</span>
<a href="#l8.20"></a><span id="l8.20">   _notifications: [</span>
<a href="#l8.21"></a><span id="l8.21">     &quot;addrbook-contact-created&quot;,</span>
<a href="#l8.22"></a><span id="l8.22">     &quot;addrbook-contact-deleted&quot;,</span>
<a href="#l8.23"></a><span id="l8.23">     &quot;addrbook-list-member-added&quot;,</span>
<a href="#l8.24"></a><span id="l8.24">     &quot;addrbook-list-member-removed&quot;,</span>
<a href="#l8.25"></a><span id="l8.25">   ],</span>
<a href="#l8.26"></a><span id="l8.26"> </span>
<a href="#l8.27"></a><span id="l8.27" class="difflineminus">-  // nsITreeView</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineminus">-</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineminus">-  selectionChanged() {</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-    if (this.listener) {</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-      this.listener.onSelectionChanged();</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-    }</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-  },</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">-  setTree(tree) {</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineminus">-    this.tree = tree;</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineminus">-    for (let topic of this._notifications) {</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">-      if (tree) {</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">-        Services.obs.addObserver(this, topic, true);</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">-      } else {</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineminus">-        Services.obs.removeObserver(this, topic);</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineminus">-      }</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineminus">-    }</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineminus">-  },</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineminus">-</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineminus">-  // nsIAbView</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+  sortColumn: &quot;&quot;,</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+  sortDirection: &quot;&quot;,</span>
<a href="#l8.48"></a><span id="l8.48"> </span>
<a href="#l8.49"></a><span id="l8.49">   deleteSelectedCards() {</span>
<a href="#l8.50"></a><span id="l8.50">     let directoryMap = new Map();</span>
<a href="#l8.51"></a><span id="l8.51">     for (let i = 0; i &lt; this.selection.getRangeCount(); i++) {</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineminus">-      let start = {},</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineminus">-        finish = {};</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+      let start = {};</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+      let finish = {};</span>
<a href="#l8.56"></a><span id="l8.56">       this.selection.getRangeAt(i, start, finish);</span>
<a href="#l8.57"></a><span id="l8.57">       for (let j = start.value; j &lt;= finish.value; j++) {</span>
<a href="#l8.58"></a><span id="l8.58">         let card = this.getCardFromRow(j);</span>
<a href="#l8.59"></a><span id="l8.59">         let directoryId = card.directoryId.split(&quot;&amp;&quot;)[0];</span>
<a href="#l8.60"></a><span id="l8.60">         let cardSet = directoryMap.get(directoryId);</span>
<a href="#l8.61"></a><span id="l8.61">         if (!cardSet) {</span>
<a href="#l8.62"></a><span id="l8.62">           cardSet = new Set();</span>
<a href="#l8.63"></a><span id="l8.63">           directoryMap.set(directoryId, cardSet);</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineat">@@ -92,23 +76,19 @@ ABView.prototype = {</span>
<a href="#l8.65"></a><span id="l8.65"> </span>
<a href="#l8.66"></a><span id="l8.66">       cardSet = [...cardSet];</span>
<a href="#l8.67"></a><span id="l8.67">       directory.deleteCards(cardSet.filter(card =&gt; !card.isMailList));</span>
<a href="#l8.68"></a><span id="l8.68">       for (let card of cardSet.filter(card =&gt; card.isMailList)) {</span>
<a href="#l8.69"></a><span id="l8.69">         MailServices.ab.deleteAddressBook(card.mailListURI);</span>
<a href="#l8.70"></a><span id="l8.70">       }</span>
<a href="#l8.71"></a><span id="l8.71">     }</span>
<a href="#l8.72"></a><span id="l8.72">   },</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineminus">-</span>
<a href="#l8.74"></a><span id="l8.74">   getCardFromRow(row) {</span>
<a href="#l8.75"></a><span id="l8.75">     return this._rowMap[row] ? this._rowMap[row].card : null;</span>
<a href="#l8.76"></a><span id="l8.76">   },</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineminus">-</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineminus">-  sortColumn: &quot;&quot;,</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineminus">-  sortDirection: &quot;&quot;,</span>
<a href="#l8.80"></a><span id="l8.80">   sortBy(sortColumn, sortDirection, resort) {</span>
<a href="#l8.81"></a><span id="l8.81">     if (sortColumn == this.sortColumn &amp;&amp; !resort) {</span>
<a href="#l8.82"></a><span id="l8.82">       if (sortDirection == this.sortDirection) {</span>
<a href="#l8.83"></a><span id="l8.83">         return;</span>
<a href="#l8.84"></a><span id="l8.84">       }</span>
<a href="#l8.85"></a><span id="l8.85">       this._rowMap.reverse();</span>
<a href="#l8.86"></a><span id="l8.86">     } else {</span>
<a href="#l8.87"></a><span id="l8.87">       this._rowMap.sort((a, b) =&gt; {</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineat">@@ -123,16 +103,34 @@ ABView.prototype = {</span>
<a href="#l8.89"></a><span id="l8.89"> </span>
<a href="#l8.90"></a><span id="l8.90">     if (this.tree) {</span>
<a href="#l8.91"></a><span id="l8.91">       this.tree.invalidate();</span>
<a href="#l8.92"></a><span id="l8.92">     }</span>
<a href="#l8.93"></a><span id="l8.93">     this.sortColumn = sortColumn;</span>
<a href="#l8.94"></a><span id="l8.94">     this.sortDirection = sortDirection;</span>
<a href="#l8.95"></a><span id="l8.95">   },</span>
<a href="#l8.96"></a><span id="l8.96"> </span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+  // nsITreeView</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineplus">+</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineplus">+  selectionChanged() {</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineplus">+    if (this.listener) {</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+      this.listener.onSelectionChanged();</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineplus">+    }</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineplus">+  },</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineplus">+  setTree(tree) {</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineplus">+    this.tree = tree;</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineplus">+    for (let topic of this._notifications) {</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineplus">+      if (tree) {</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineplus">+        Services.obs.addObserver(this, topic, true);</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineplus">+      } else {</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineplus">+        Services.obs.removeObserver(this, topic);</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+      }</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineplus">+    }</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineplus">+  },</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineplus">+</span>
<a href="#l8.115"></a><span id="l8.115">   // nsIAbDirSearchListener</span>
<a href="#l8.116"></a><span id="l8.116"> </span>
<a href="#l8.117"></a><span id="l8.117">   onSearchFoundCard(card) {</span>
<a href="#l8.118"></a><span id="l8.118">     this._rowMap.push(new abViewCard(card));</span>
<a href="#l8.119"></a><span id="l8.119">   },</span>
<a href="#l8.120"></a><span id="l8.120">   onSearchFinished(result, errorMsg) {</span>
<a href="#l8.121"></a><span id="l8.121">     this.sortBy(this.sortColumn, this.sortDirection, true);</span>
<a href="#l8.122"></a><span id="l8.122">     if (this.listener) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/addrbook/public/moz.build</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/addrbook/public/moz.build</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -11,17 +11,16 @@ XPIDL_SOURCES += [</span>
<a href="#l9.4"></a><span id="l9.4">     'nsIAbDirectory.idl',</span>
<a href="#l9.5"></a><span id="l9.5">     'nsIAbDirectoryQuery.idl',</span>
<a href="#l9.6"></a><span id="l9.6">     'nsIAbDirectoryQueryProxy.idl',</span>
<a href="#l9.7"></a><span id="l9.7">     'nsIAbDirSearchListener.idl',</span>
<a href="#l9.8"></a><span id="l9.8">     'nsIAbLDAPAttributeMap.idl',</span>
<a href="#l9.9"></a><span id="l9.9">     'nsIAbLDIFService.idl',</span>
<a href="#l9.10"></a><span id="l9.10">     'nsIAbListener.idl',</span>
<a href="#l9.11"></a><span id="l9.11">     'nsIAbManager.idl',</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-    'nsIAbView.idl',</span>
<a href="#l9.13"></a><span id="l9.13">     'nsIAddbookUrl.idl',</span>
<a href="#l9.14"></a><span id="l9.14">     'nsIAddrDatabase.idl',</span>
<a href="#l9.15"></a><span id="l9.15">     'nsIMsgVCardService.idl',</span>
<a href="#l9.16"></a><span id="l9.16"> ]</span>
<a href="#l9.17"></a><span id="l9.17"> </span>
<a href="#l9.18"></a><span id="l9.18"> if CONFIG['MOZ_LDAP_XPCOM']:</span>
<a href="#l9.19"></a><span id="l9.19">     XPIDL_SOURCES += [</span>
<a href="#l9.20"></a><span id="l9.20">         'nsIAbLDAPCard.idl',</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/addrbook/public/nsAbBaseCID.h</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/addrbook/public/nsAbBaseCID.h</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -327,26 +327,16 @@</span>
<a href="#l10.4"></a><span id="l10.4">     0x63e11d52, 0x3c9b, 0x11d6, {                   \</span>
<a href="#l10.5"></a><span id="l10.5">       0xb7, 0xb9, 0x0, 0xb0, 0xd0, 0x6e, 0x5f, 0x27 \</span>
<a href="#l10.6"></a><span id="l10.6">     }                                               \</span>
<a href="#l10.7"></a><span id="l10.7">   }</span>
<a href="#l10.8"></a><span id="l10.8"> </span>
<a href="#l10.9"></a><span id="l10.9"> #define NS_ABLDAP_PROCESSCHANGELOGDATA_CONTRACTID \</span>
<a href="#l10.10"></a><span id="l10.10">   &quot;@mozilla.org/addressbook/ldap-process-changelog-data;1&quot;</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-// nsABView</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-#define NS_ABVIEW_CID                                \</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-  {                                                  \</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-    0xc5eb5d6a, 0x1dd1, 0x11b2, {                    \</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">-      0xa0, 0x25, 0x94, 0xd1, 0x18, 0x1f, 0xc5, 0x9c \</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineminus">-    }                                                \</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineminus">-  }</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">-</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineminus">-#define NS_ABVIEW_CONTRACTID &quot;@mozilla.org/addressbook/abview;1&quot;</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">-</span>
<a href="#l10.22"></a><span id="l10.22"> #ifdef XP_MACOSX</span>
<a href="#l10.23"></a><span id="l10.23"> //</span>
<a href="#l10.24"></a><span id="l10.24"> // nsAbOSXDirectory</span>
<a href="#l10.25"></a><span id="l10.25"> //</span>
<a href="#l10.26"></a><span id="l10.26"> #  define NS_ABOSXDIRECTORY_PREFIX &quot;moz-abosxdirectory&quot;</span>
<a href="#l10.27"></a><span id="l10.27"> #  define NS_ABOSXCARD_PREFIX &quot;moz-abosxcard&quot;</span>
<a href="#l10.28"></a><span id="l10.28"> </span>
<a href="#l10.29"></a><span id="l10.29"> #  define NS_ABOSXDIRECTORY_CONTRACTID \</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">deleted file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- a/mailnews/addrbook/public/nsIAbView.idl</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ /dev/null</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -1,109 +0,0 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineminus">-/* -*- Mode: IDL; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineminus">-</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineminus">-#include &quot;nsISupports.idl&quot;</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineminus">-</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-interface nsIAbCard;</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-interface nsIAbDirectory;</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-interface nsIArray;</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">-/// Define a class using this interface to listen to updates from nsIAbView.</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineminus">-[scriptable, uuid(79ad5d6e-1dd2-11b2-addd-f547dab50d75)]</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineminus">-interface nsIAbViewListener : nsISupports</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineminus">-{</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineminus">-  /// Called when the selection is changed in the tree</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-  void onSelectionChanged();</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineminus">-</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-  /// Called when the total count of cards is changed.</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineminus">-  void onCountChanged(in long total);</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineminus">-};</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineminus">-</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineminus">-/**</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">- * This interface and its associated nsAbView object provides an interface</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineminus">- * to allow a tree to be associated with an address book, and the results</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">- * to be displayed in that tree.</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">- *</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">- * If you wish for the tree to display the results of a different address</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">- * book, then call setView again. There is no need to delete and recreate the</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">- * nsAbView object. If you wish to clear the view, then just call clearView.</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineminus">- */</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineminus">-[scriptable, uuid(45e2fa9f-0b59-4090-a2fa-fb7042cf64a2)]</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineminus">-interface nsIAbView : nsISupports</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineminus">-{</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-  /**</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineminus">-   * Sets up the nsIAbView to look at the specified directory. This may be</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineminus">-   * called multiple times.</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineminus">-   *</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineminus">-   * @param aDirectory      The directory to search, this may be a directory</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineminus">-   *                        with a query string.</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineminus">-   * @param aViewListener   An optional listener.</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineminus">-   * @param aSortColumn     The column to sort by. See the xul element with</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineminus">-   *                        id abResultsTreeCols for possible values.</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineminus">-   * @param aSortDirection  The sort direction to use (&quot;ascending&quot;/&quot;descending&quot;)</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineminus">-   * @return                The actual sortColumn (various switching of apps</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineminus">-   *                        could cause the persisted sortColumn to be bogus).</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineminus">-   */</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineminus">-  AString setView(in nsIAbDirectory aAddressBook,</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineminus">-                  in nsIAbViewListener aAbViewListener,</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineminus">-                  in AString aSortColumn,</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineminus">-                  in AString aSortDirection);</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineminus">-</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineminus">-  /**</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineminus">-   * Clears the view and releases any locally held copies of the address book</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineminus">-   * directory. This should be called when the view is no longer required, e.g.</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineminus">-   * on unload.</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineminus">-   */</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineminus">-  void clearView();</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineminus">-</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineminus">-  /**</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineminus">-   * Sorts the tree by the specified parameters.</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineminus">-   *</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineminus">-   * @param aSortColumn     The column to sort by. See the xul element with</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineminus">-   *                        id abResultsTreeCols for possible values.</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineminus">-   * @param aSortDirection  The sort direction to use (&quot;ascending&quot;/&quot;descending&quot;)</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineminus">-   * @param aResort         The function DOES optimize for the case when sortColumn</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineminus">-   *                        and sortDirection is identical since the last call.</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineminus">-   *                        If an unconditional resort is needed, set this to true.</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineminus">-   */</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineminus">-  void sortBy(in wstring aSortColumn, in wstring aSortDirection,</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineminus">-              [optional] in boolean aResort);</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineminus">-</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineminus">-  /// Returns the current sort column</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineminus">-  readonly attribute AString sortColumn;</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineminus">-</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineminus">-  /// Returns the current sort direction</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineminus">-  readonly attribute AString sortDirection;</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineminus">-</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineminus">-  /**</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineminus">-   * Returns the current directory that this view is hooked up to. May be</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineminus">-   * null if no directory has been set.</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineminus">-   */</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineminus">-  readonly attribute nsIAbDirectory directory;</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineminus">-</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineminus">-  /**</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineminus">-   * Returns the card associated with the given row.</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineminus">-   *</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineminus">-   * @param aRow  The row from which to return the card.</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineminus">-   * @return      A card associated with the row, or null if row is not valid.</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineminus">-   */</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineminus">-  nsIAbCard getCardFromRow(in long aRow);</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineminus">-</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineminus">-  /// Selects all rows in the view.</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineminus">-  void selectAll();</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineminus">-</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineminus">-  /// Deletes all the selected cards (no prompts are given).</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineminus">-  void deleteSelectedCards();</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineminus">-</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineminus">-  /**</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineminus">-   * Swaps the first and last name order, and updates the appropriate</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineminus">-   * preference.</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineminus">-   */</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineminus">-  void swapFirstNameLastName();</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineminus">-</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineminus">-  /**</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineminus">-   *  Returns an array of the currently selected addresses.</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineminus">-   */</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineminus">-  readonly attribute nsIArray selectedAddresses;</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/addrbook/src/moz.build</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/addrbook/src/moz.build</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -14,17 +14,16 @@ SOURCES += [</span>
<a href="#l12.4"></a><span id="l12.4">     'nsAbBooleanExpression.cpp',</span>
<a href="#l12.5"></a><span id="l12.5">     'nsAbCardProperty.cpp',</span>
<a href="#l12.6"></a><span id="l12.6">     'nsAbContentHandler.cpp',</span>
<a href="#l12.7"></a><span id="l12.7">     'nsAbDirectoryQuery.cpp',</span>
<a href="#l12.8"></a><span id="l12.8">     'nsAbDirectoryQueryProxy.cpp',</span>
<a href="#l12.9"></a><span id="l12.9">     'nsAbDirProperty.cpp',</span>
<a href="#l12.10"></a><span id="l12.10">     'nsAbLDIFService.cpp',</span>
<a href="#l12.11"></a><span id="l12.11">     'nsAbQueryStringToExpression.cpp',</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-    'nsAbView.cpp',</span>
<a href="#l12.13"></a><span id="l12.13">     'nsAddbookProtocolHandler.cpp',</span>
<a href="#l12.14"></a><span id="l12.14">     'nsAddbookUrl.cpp',</span>
<a href="#l12.15"></a><span id="l12.15">     'nsAddrDatabase.cpp',</span>
<a href="#l12.16"></a><span id="l12.16">     'nsMsgVCardService.cpp',</span>
<a href="#l12.17"></a><span id="l12.17">     'nsVCard.cpp',</span>
<a href="#l12.18"></a><span id="l12.18">     'nsVCardObj.cpp',</span>
<a href="#l12.19"></a><span id="l12.19"> ]</span>
<a href="#l12.20"></a><span id="l12.20"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">deleted file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- a/mailnews/addrbook/src/nsAbView.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ /dev/null</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -1,1313 +0,0 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineminus">-</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineminus">-#include &quot;mozilla/DebugOnly.h&quot;</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineminus">-</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-#include &quot;nsAbView.h&quot;</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-#include &quot;nsISupports.h&quot;</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineminus">-#include &quot;nsIAbCard.h&quot;</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineminus">-#include &quot;prmem.h&quot;</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineminus">-#include &quot;nsCollationCID.h&quot;</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineminus">-#include &quot;nsIAbManager.h&quot;</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineminus">-#include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineminus">-#include &quot;nsXPCOM.h&quot;</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineminus">-#include &quot;nsTreeColumns.h&quot;</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineminus">-#include &quot;nsCRTGlue.h&quot;</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineminus">-#include &quot;nsIMutableArray.h&quot;</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineminus">-#include &quot;nsIPrefService.h&quot;</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineminus">-#include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineminus">-#include &quot;nsIStringBundle.h&quot;</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineminus">-#include &quot;nsIPrefLocalizedString.h&quot;</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineminus">-#include &quot;nsArrayUtils.h&quot;</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineminus">-#include &quot;nsIAddrDatabase.h&quot;  // for kPhoneticNameColumn</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineminus">-#include &quot;nsMsgUtils.h&quot;</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-#include &quot;mozilla/Services.h&quot;</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-#include &quot;mozilla/dom/DataTransfer.h&quot;</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineminus">-using namespace mozilla;</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineminus">-</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineminus">-#define CARD_NOT_FOUND -1</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineminus">-#define ALL_ROWS -1</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineminus">-</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineminus">-#define PREF_MAIL_ADDR_BOOK_LASTNAMEFIRST &quot;mail.addr_book.lastnamefirst&quot;</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineminus">-#define PREF_MAIL_ADDR_BOOK_DISPLAYNAME_AUTOGENERATION \</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineminus">-  &quot;mail.addr_book.displayName.autoGeneration&quot;</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineminus">-#define PREF_MAIL_ADDR_BOOK_DISPLAYNAME_LASTNAMEFIRST \</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineminus">-  &quot;mail.addr_book.displayName.lastnamefirst&quot;</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineminus">-</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineminus">-// Also, our default primary sort</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineminus">-#define GENERATED_NAME_COLUMN_ID &quot;GeneratedName&quot;</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineminus">-</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineminus">-NS_IMPL_ISUPPORTS(nsAbView, nsIAbView, nsITreeView, nsIAbListener, nsIObserver)</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineminus">-</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineminus">-nsAbView::nsAbView()</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineminus">-    : mInitialized(false),</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineminus">-      mIsAllDirectoryRootView(false),</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineminus">-      mSuppressSelectionChange(false),</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineminus">-      mSuppressCountChange(false),</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineminus">-      mGeneratedNameFormat(0) {}</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineminus">-</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineminus">-nsAbView::~nsAbView() {</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineminus">-  if (mInitialized) {</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(ClearView()), &quot;failed to close view&quot;);</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineminus">-  }</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineminus">-}</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineminus">-</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineminus">-NS_IMETHODIMP nsAbView::ClearView() {</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineminus">-  mDirectory = nullptr;</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineminus">-  mAbViewListener = nullptr;</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineminus">-  if (mTree) {</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineminus">-    IgnoredErrorResult rv2;</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineminus">-    mTree-&gt;SetView(nullptr, mozilla::dom::CallerType::System, rv2);</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineminus">-  }</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineminus">-  mTree = nullptr;</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineminus">-  mTreeSelection = nullptr;</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineminus">-</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineminus">-  if (mInitialized) {</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineminus">-    nsresult rv;</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineminus">-    mInitialized = false;</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineminus">-    nsCOMPtr&lt;nsIPrefBranch&gt; pbi(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineminus">-</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineminus">-    rv = pbi-&gt;RemoveObserver(PREF_MAIL_ADDR_BOOK_LASTNAMEFIRST, this);</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineminus">-</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineminus">-    nsCOMPtr&lt;nsIAbManager&gt; abManager(</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineminus">-        do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l13.84"></a><span id="l13.84" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineminus">-</span>
<a href="#l13.86"></a><span id="l13.86" class="difflineminus">-    rv = abManager-&gt;RemoveAddressBookListener(this);</span>
<a href="#l13.87"></a><span id="l13.87" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineminus">-  }</span>
<a href="#l13.89"></a><span id="l13.89" class="difflineminus">-</span>
<a href="#l13.90"></a><span id="l13.90" class="difflineminus">-  int32_t i = mCards.Length();</span>
<a href="#l13.91"></a><span id="l13.91" class="difflineminus">-  while (i-- &gt; 0)</span>
<a href="#l13.92"></a><span id="l13.92" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(RemoveCardAt(i)), &quot;remove card failed&quot;);</span>
<a href="#l13.93"></a><span id="l13.93" class="difflineminus">-</span>
<a href="#l13.94"></a><span id="l13.94" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.95"></a><span id="l13.95" class="difflineminus">-}</span>
<a href="#l13.96"></a><span id="l13.96" class="difflineminus">-</span>
<a href="#l13.97"></a><span id="l13.97" class="difflineminus">-nsresult nsAbView::RemoveCardAt(int32_t row) {</span>
<a href="#l13.98"></a><span id="l13.98" class="difflineminus">-  nsresult rv;</span>
<a href="#l13.99"></a><span id="l13.99" class="difflineminus">-</span>
<a href="#l13.100"></a><span id="l13.100" class="difflineminus">-  AbCard *abcard = mCards.ElementAt(row);</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineminus">-  mCards.RemoveElementAt(row);</span>
<a href="#l13.102"></a><span id="l13.102" class="difflineminus">-  delete abcard;</span>
<a href="#l13.103"></a><span id="l13.103" class="difflineminus">-</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineminus">-  // This needs to happen after we remove the card, as RowCountChanged() will</span>
<a href="#l13.105"></a><span id="l13.105" class="difflineminus">-  // call GetRowCount()</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineminus">-  if (mTree) {</span>
<a href="#l13.107"></a><span id="l13.107" class="difflineminus">-    mTree-&gt;RowCountChanged(row, -1);</span>
<a href="#l13.108"></a><span id="l13.108" class="difflineminus">-  }</span>
<a href="#l13.109"></a><span id="l13.109" class="difflineminus">-</span>
<a href="#l13.110"></a><span id="l13.110" class="difflineminus">-  if (mAbViewListener &amp;&amp; !mSuppressCountChange) {</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineminus">-    rv = mAbViewListener-&gt;OnCountChanged(mCards.Length());</span>
<a href="#l13.112"></a><span id="l13.112" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.113"></a><span id="l13.113" class="difflineminus">-  }</span>
<a href="#l13.114"></a><span id="l13.114" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.115"></a><span id="l13.115" class="difflineminus">-}</span>
<a href="#l13.116"></a><span id="l13.116" class="difflineminus">-</span>
<a href="#l13.117"></a><span id="l13.117" class="difflineminus">-nsresult nsAbView::SetGeneratedNameFormatFromPrefs() {</span>
<a href="#l13.118"></a><span id="l13.118" class="difflineminus">-  nsresult rv;</span>
<a href="#l13.119"></a><span id="l13.119" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranchInt(</span>
<a href="#l13.120"></a><span id="l13.120" class="difflineminus">-      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l13.121"></a><span id="l13.121" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.122"></a><span id="l13.122" class="difflineminus">-</span>
<a href="#l13.123"></a><span id="l13.123" class="difflineminus">-  return prefBranchInt-&gt;GetIntPref(PREF_MAIL_ADDR_BOOK_LASTNAMEFIRST,</span>
<a href="#l13.124"></a><span id="l13.124" class="difflineminus">-                                   &amp;mGeneratedNameFormat);</span>
<a href="#l13.125"></a><span id="l13.125" class="difflineminus">-}</span>
<a href="#l13.126"></a><span id="l13.126" class="difflineminus">-</span>
<a href="#l13.127"></a><span id="l13.127" class="difflineminus">-nsresult nsAbView::Initialize() {</span>
<a href="#l13.128"></a><span id="l13.128" class="difflineminus">-  if (mInitialized) return NS_OK;</span>
<a href="#l13.129"></a><span id="l13.129" class="difflineminus">-</span>
<a href="#l13.130"></a><span id="l13.130" class="difflineminus">-  mInitialized = true;</span>
<a href="#l13.131"></a><span id="l13.131" class="difflineminus">-</span>
<a href="#l13.132"></a><span id="l13.132" class="difflineminus">-  nsresult rv;</span>
<a href="#l13.133"></a><span id="l13.133" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt; abManager(do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l13.134"></a><span id="l13.134" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.135"></a><span id="l13.135" class="difflineminus">-</span>
<a href="#l13.136"></a><span id="l13.136" class="difflineminus">-  rv = abManager-&gt;AddAddressBookListener(this, nsIAbListener::all);</span>
<a href="#l13.137"></a><span id="l13.137" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.138"></a><span id="l13.138" class="difflineminus">-</span>
<a href="#l13.139"></a><span id="l13.139" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; pbi(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l13.140"></a><span id="l13.140" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.141"></a><span id="l13.141" class="difflineminus">-</span>
<a href="#l13.142"></a><span id="l13.142" class="difflineminus">-  rv = pbi-&gt;AddObserver(PREF_MAIL_ADDR_BOOK_LASTNAMEFIRST, this, false);</span>
<a href="#l13.143"></a><span id="l13.143" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.144"></a><span id="l13.144" class="difflineminus">-</span>
<a href="#l13.145"></a><span id="l13.145" class="difflineminus">-  if (!mABBundle) {</span>
<a href="#l13.146"></a><span id="l13.146" class="difflineminus">-    nsCOMPtr&lt;nsIStringBundleService&gt; stringBundleService =</span>
<a href="#l13.147"></a><span id="l13.147" class="difflineminus">-        mozilla::services::GetStringBundleService();</span>
<a href="#l13.148"></a><span id="l13.148" class="difflineminus">-    NS_ENSURE_TRUE(stringBundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l13.149"></a><span id="l13.149" class="difflineminus">-</span>
<a href="#l13.150"></a><span id="l13.150" class="difflineminus">-    rv = stringBundleService-&gt;CreateBundle(</span>
<a href="#l13.151"></a><span id="l13.151" class="difflineminus">-        &quot;chrome://messenger/locale/addressbook/addressBook.properties&quot;,</span>
<a href="#l13.152"></a><span id="l13.152" class="difflineminus">-        getter_AddRefs(mABBundle));</span>
<a href="#l13.153"></a><span id="l13.153" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.154"></a><span id="l13.154" class="difflineminus">-  }</span>
<a href="#l13.155"></a><span id="l13.155" class="difflineminus">-</span>
<a href="#l13.156"></a><span id="l13.156" class="difflineminus">-  return SetGeneratedNameFormatFromPrefs();</span>
<a href="#l13.157"></a><span id="l13.157" class="difflineminus">-}</span>
<a href="#l13.158"></a><span id="l13.158" class="difflineminus">-</span>
<a href="#l13.159"></a><span id="l13.159" class="difflineminus">-NS_IMETHODIMP nsAbView::SetView(nsIAbDirectory *aAddressBook,</span>
<a href="#l13.160"></a><span id="l13.160" class="difflineminus">-                                nsIAbViewListener *aAbViewListener,</span>
<a href="#l13.161"></a><span id="l13.161" class="difflineminus">-                                const nsAString &amp;aSortColumn,</span>
<a href="#l13.162"></a><span id="l13.162" class="difflineminus">-                                const nsAString &amp;aSortDirection,</span>
<a href="#l13.163"></a><span id="l13.163" class="difflineminus">-                                nsAString &amp;aResult) {</span>
<a href="#l13.164"></a><span id="l13.164" class="difflineminus">-  // Ensure we are initialized</span>
<a href="#l13.165"></a><span id="l13.165" class="difflineminus">-  nsresult rv = Initialize();</span>
<a href="#l13.166"></a><span id="l13.166" class="difflineminus">-</span>
<a href="#l13.167"></a><span id="l13.167" class="difflineminus">-  mAbViewListener = nullptr;</span>
<a href="#l13.168"></a><span id="l13.168" class="difflineminus">-  if (mTree) {</span>
<a href="#l13.169"></a><span id="l13.169" class="difflineminus">-    // Try and speed deletion of old cards by disconnecting the tree from us.</span>
<a href="#l13.170"></a><span id="l13.170" class="difflineminus">-    mTreeSelection-&gt;ClearSelection();</span>
<a href="#l13.171"></a><span id="l13.171" class="difflineminus">-    IgnoredErrorResult rv2;</span>
<a href="#l13.172"></a><span id="l13.172" class="difflineminus">-    mTree-&gt;SetView(nullptr, mozilla::dom::CallerType::System, rv2);</span>
<a href="#l13.173"></a><span id="l13.173" class="difflineminus">-  }</span>
<a href="#l13.174"></a><span id="l13.174" class="difflineminus">-</span>
<a href="#l13.175"></a><span id="l13.175" class="difflineminus">-  // Clear out old cards</span>
<a href="#l13.176"></a><span id="l13.176" class="difflineminus">-  int32_t i = mCards.Length();</span>
<a href="#l13.177"></a><span id="l13.177" class="difflineminus">-  while (i-- &gt; 0) {</span>
<a href="#l13.178"></a><span id="l13.178" class="difflineminus">-    rv = RemoveCardAt(i);</span>
<a href="#l13.179"></a><span id="l13.179" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;remove card failed&quot;);</span>
<a href="#l13.180"></a><span id="l13.180" class="difflineminus">-  }</span>
<a href="#l13.181"></a><span id="l13.181" class="difflineminus">-</span>
<a href="#l13.182"></a><span id="l13.182" class="difflineminus">-  // We replace all cards so any sorting is no longer valid.</span>
<a href="#l13.183"></a><span id="l13.183" class="difflineminus">-  mSortColumn.AssignLiteral(&quot;&quot;);</span>
<a href="#l13.184"></a><span id="l13.184" class="difflineminus">-  mSortDirection.AssignLiteral(&quot;&quot;);</span>
<a href="#l13.185"></a><span id="l13.185" class="difflineminus">-</span>
<a href="#l13.186"></a><span id="l13.186" class="difflineminus">-  if (aAddressBook) {</span>
<a href="#l13.187"></a><span id="l13.187" class="difflineminus">-    nsCString uri;</span>
<a href="#l13.188"></a><span id="l13.188" class="difflineminus">-    aAddressBook-&gt;GetURI(uri);</span>
<a href="#l13.189"></a><span id="l13.189" class="difflineminus">-</span>
<a href="#l13.190"></a><span id="l13.190" class="difflineminus">-    mIsAllDirectoryRootView = false;</span>
<a href="#l13.191"></a><span id="l13.191" class="difflineminus">-    mDirectory = aAddressBook;</span>
<a href="#l13.192"></a><span id="l13.192" class="difflineminus">-    rv = EnumerateCards();</span>
<a href="#l13.193"></a><span id="l13.193" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.194"></a><span id="l13.194" class="difflineminus">-  } else {</span>
<a href="#l13.195"></a><span id="l13.195" class="difflineminus">-    mIsAllDirectoryRootView = true;</span>
<a href="#l13.196"></a><span id="l13.196" class="difflineminus">-</span>
<a href="#l13.197"></a><span id="l13.197" class="difflineminus">-    nsCOMPtr&lt;nsIAbManager&gt; abManager(</span>
<a href="#l13.198"></a><span id="l13.198" class="difflineminus">-        do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l13.199"></a><span id="l13.199" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.200"></a><span id="l13.200" class="difflineminus">-    nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l13.201"></a><span id="l13.201" class="difflineminus">-    rv = abManager-&gt;GetDirectories(getter_AddRefs(enumerator));</span>
<a href="#l13.202"></a><span id="l13.202" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.203"></a><span id="l13.203" class="difflineminus">-</span>
<a href="#l13.204"></a><span id="l13.204" class="difflineminus">-    bool hasMore = false;</span>
<a href="#l13.205"></a><span id="l13.205" class="difflineminus">-    nsCOMPtr&lt;nsISupports&gt; support;</span>
<a href="#l13.206"></a><span id="l13.206" class="difflineminus">-    nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l13.207"></a><span id="l13.207" class="difflineminus">-    while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l13.208"></a><span id="l13.208" class="difflineminus">-      rv = enumerator-&gt;GetNext(getter_AddRefs(support));</span>
<a href="#l13.209"></a><span id="l13.209" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.210"></a><span id="l13.210" class="difflineminus">-      directory = do_QueryInterface(support, &amp;rv);</span>
<a href="#l13.211"></a><span id="l13.211" class="difflineminus">-</span>
<a href="#l13.212"></a><span id="l13.212" class="difflineminus">-      // If, for some reason, we are unable to get a directory, we continue.</span>
<a href="#l13.213"></a><span id="l13.213" class="difflineminus">-      if (NS_FAILED(rv)) continue;</span>
<a href="#l13.214"></a><span id="l13.214" class="difflineminus">-</span>
<a href="#l13.215"></a><span id="l13.215" class="difflineminus">-      mDirectory = directory;</span>
<a href="#l13.216"></a><span id="l13.216" class="difflineminus">-      rv = EnumerateCards();</span>
<a href="#l13.217"></a><span id="l13.217" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.218"></a><span id="l13.218" class="difflineminus">-    }</span>
<a href="#l13.219"></a><span id="l13.219" class="difflineminus">-  }</span>
<a href="#l13.220"></a><span id="l13.220" class="difflineminus">-</span>
<a href="#l13.221"></a><span id="l13.221" class="difflineminus">-  NS_NAMED_LITERAL_STRING(generatedNameColumnId, GENERATED_NAME_COLUMN_ID);</span>
<a href="#l13.222"></a><span id="l13.222" class="difflineminus">-</span>
<a href="#l13.223"></a><span id="l13.223" class="difflineminus">-  // See if the persisted sortColumn is valid.</span>
<a href="#l13.224"></a><span id="l13.224" class="difflineminus">-  // It may not be, if you migrated from older versions, or switched between</span>
<a href="#l13.225"></a><span id="l13.225" class="difflineminus">-  // a mozilla build and a commercial build, which have different columns.</span>
<a href="#l13.226"></a><span id="l13.226" class="difflineminus">-  nsAutoString actualSortColumn;</span>
<a href="#l13.227"></a><span id="l13.227" class="difflineminus">-  if (!generatedNameColumnId.Equals(aSortColumn) &amp;&amp; mCards.Length()) {</span>
<a href="#l13.228"></a><span id="l13.228" class="difflineminus">-    nsIAbCard *card = mCards.ElementAt(0)-&gt;card;</span>
<a href="#l13.229"></a><span id="l13.229" class="difflineminus">-    nsString value;</span>
<a href="#l13.230"></a><span id="l13.230" class="difflineminus">-    // XXX todo</span>
<a href="#l13.231"></a><span id="l13.231" class="difflineminus">-    // Need to check if _Generic is valid.  GetCardValue() will always return</span>
<a href="#l13.232"></a><span id="l13.232" class="difflineminus">-    // NS_OK for _Generic We're going to have to ask mDirectory if it is. It</span>
<a href="#l13.233"></a><span id="l13.233" class="difflineminus">-    // might not be.  example:  _ScreenName is valid in Netscape, but not</span>
<a href="#l13.234"></a><span id="l13.234" class="difflineminus">-    // Mozilla.</span>
<a href="#l13.235"></a><span id="l13.235" class="difflineminus">-    rv = GetCardValue(card, aSortColumn, value);</span>
<a href="#l13.236"></a><span id="l13.236" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l13.237"></a><span id="l13.237" class="difflineminus">-      actualSortColumn = generatedNameColumnId;</span>
<a href="#l13.238"></a><span id="l13.238" class="difflineminus">-    else</span>
<a href="#l13.239"></a><span id="l13.239" class="difflineminus">-      actualSortColumn = aSortColumn;</span>
<a href="#l13.240"></a><span id="l13.240" class="difflineminus">-  } else</span>
<a href="#l13.241"></a><span id="l13.241" class="difflineminus">-    actualSortColumn = aSortColumn;</span>
<a href="#l13.242"></a><span id="l13.242" class="difflineminus">-</span>
<a href="#l13.243"></a><span id="l13.243" class="difflineminus">-  rv = SortBy(actualSortColumn.get(), PromiseFlatString(aSortDirection).get(),</span>
<a href="#l13.244"></a><span id="l13.244" class="difflineminus">-              false);</span>
<a href="#l13.245"></a><span id="l13.245" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.246"></a><span id="l13.246" class="difflineminus">-</span>
<a href="#l13.247"></a><span id="l13.247" class="difflineminus">-  mAbViewListener = aAbViewListener;</span>
<a href="#l13.248"></a><span id="l13.248" class="difflineminus">-  if (mAbViewListener &amp;&amp; !mSuppressCountChange) {</span>
<a href="#l13.249"></a><span id="l13.249" class="difflineminus">-    rv = mAbViewListener-&gt;OnCountChanged(mCards.Length());</span>
<a href="#l13.250"></a><span id="l13.250" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.251"></a><span id="l13.251" class="difflineminus">-  }</span>
<a href="#l13.252"></a><span id="l13.252" class="difflineminus">-</span>
<a href="#l13.253"></a><span id="l13.253" class="difflineminus">-  aResult = actualSortColumn;</span>
<a href="#l13.254"></a><span id="l13.254" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.255"></a><span id="l13.255" class="difflineminus">-}</span>
<a href="#l13.256"></a><span id="l13.256" class="difflineminus">-</span>
<a href="#l13.257"></a><span id="l13.257" class="difflineminus">-NS_IMETHODIMP nsAbView::GetDirectory(nsIAbDirectory **aDirectory) {</span>
<a href="#l13.258"></a><span id="l13.258" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aDirectory);</span>
<a href="#l13.259"></a><span id="l13.259" class="difflineminus">-  NS_IF_ADDREF(*aDirectory = mDirectory);</span>
<a href="#l13.260"></a><span id="l13.260" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.261"></a><span id="l13.261" class="difflineminus">-}</span>
<a href="#l13.262"></a><span id="l13.262" class="difflineminus">-</span>
<a href="#l13.263"></a><span id="l13.263" class="difflineminus">-nsresult nsAbView::EnumerateCards() {</span>
<a href="#l13.264"></a><span id="l13.264" class="difflineminus">-  nsresult rv;</span>
<a href="#l13.265"></a><span id="l13.265" class="difflineminus">-  nsCOMPtr&lt;nsISimpleEnumerator&gt; cardsEnumerator;</span>
<a href="#l13.266"></a><span id="l13.266" class="difflineminus">-  nsCOMPtr&lt;nsIAbCard&gt; card;</span>
<a href="#l13.267"></a><span id="l13.267" class="difflineminus">-</span>
<a href="#l13.268"></a><span id="l13.268" class="difflineminus">-  if (!mDirectory) return NS_ERROR_UNEXPECTED;</span>
<a href="#l13.269"></a><span id="l13.269" class="difflineminus">-</span>
<a href="#l13.270"></a><span id="l13.270" class="difflineminus">-  rv = mDirectory-&gt;GetChildCards(getter_AddRefs(cardsEnumerator));</span>
<a href="#l13.271"></a><span id="l13.271" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; cardsEnumerator) {</span>
<a href="#l13.272"></a><span id="l13.272" class="difflineminus">-    nsCOMPtr&lt;nsISupports&gt; item;</span>
<a href="#l13.273"></a><span id="l13.273" class="difflineminus">-    bool more;</span>
<a href="#l13.274"></a><span id="l13.274" class="difflineminus">-    while (NS_SUCCEEDED(cardsEnumerator-&gt;HasMoreElements(&amp;more)) &amp;&amp; more) {</span>
<a href="#l13.275"></a><span id="l13.275" class="difflineminus">-      rv = cardsEnumerator-&gt;GetNext(getter_AddRefs(item));</span>
<a href="#l13.276"></a><span id="l13.276" class="difflineminus">-      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l13.277"></a><span id="l13.277" class="difflineminus">-        nsCOMPtr&lt;nsIAbCard&gt; card = do_QueryInterface(item);</span>
<a href="#l13.278"></a><span id="l13.278" class="difflineminus">-        AbCard *abcard = new AbCard(card);</span>
<a href="#l13.279"></a><span id="l13.279" class="difflineminus">-</span>
<a href="#l13.280"></a><span id="l13.280" class="difflineminus">-        // XXX todo</span>
<a href="#l13.281"></a><span id="l13.281" class="difflineminus">-        // Would it be better to do an insertion sort, than append and sort?</span>
<a href="#l13.282"></a><span id="l13.282" class="difflineminus">-        // XXX todo</span>
<a href="#l13.283"></a><span id="l13.283" class="difflineminus">-        // If we knew how many cards there was going to be</span>
<a href="#l13.284"></a><span id="l13.284" class="difflineminus">-        // we could allocate an array of the size,</span>
<a href="#l13.285"></a><span id="l13.285" class="difflineminus">-        // instead of growing and copying as we append.</span>
<a href="#l13.286"></a><span id="l13.286" class="difflineminus">-        mCards.AppendElement(abcard);</span>
<a href="#l13.287"></a><span id="l13.287" class="difflineminus">-      }</span>
<a href="#l13.288"></a><span id="l13.288" class="difflineminus">-    }</span>
<a href="#l13.289"></a><span id="l13.289" class="difflineminus">-  }</span>
<a href="#l13.290"></a><span id="l13.290" class="difflineminus">-</span>
<a href="#l13.291"></a><span id="l13.291" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.292"></a><span id="l13.292" class="difflineminus">-}</span>
<a href="#l13.293"></a><span id="l13.293" class="difflineminus">-</span>
<a href="#l13.294"></a><span id="l13.294" class="difflineminus">-NS_IMETHODIMP nsAbView::GetRowCount(int32_t *aRowCount) {</span>
<a href="#l13.295"></a><span id="l13.295" class="difflineminus">-  *aRowCount = mCards.Length();</span>
<a href="#l13.296"></a><span id="l13.296" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.297"></a><span id="l13.297" class="difflineminus">-}</span>
<a href="#l13.298"></a><span id="l13.298" class="difflineminus">-</span>
<a href="#l13.299"></a><span id="l13.299" class="difflineminus">-NS_IMETHODIMP nsAbView::GetSelection(nsITreeSelection **aSelection) {</span>
<a href="#l13.300"></a><span id="l13.300" class="difflineminus">-  NS_IF_ADDREF(*aSelection = mTreeSelection);</span>
<a href="#l13.301"></a><span id="l13.301" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.302"></a><span id="l13.302" class="difflineminus">-}</span>
<a href="#l13.303"></a><span id="l13.303" class="difflineminus">-</span>
<a href="#l13.304"></a><span id="l13.304" class="difflineminus">-NS_IMETHODIMP nsAbView::SetSelection(nsITreeSelection *aSelection) {</span>
<a href="#l13.305"></a><span id="l13.305" class="difflineminus">-  mTreeSelection = aSelection;</span>
<a href="#l13.306"></a><span id="l13.306" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.307"></a><span id="l13.307" class="difflineminus">-}</span>
<a href="#l13.308"></a><span id="l13.308" class="difflineminus">-</span>
<a href="#l13.309"></a><span id="l13.309" class="difflineminus">-NS_IMETHODIMP nsAbView::GetRowProperties(int32_t index, nsAString &amp;properties) {</span>
<a href="#l13.310"></a><span id="l13.310" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.311"></a><span id="l13.311" class="difflineminus">-}</span>
<a href="#l13.312"></a><span id="l13.312" class="difflineminus">-</span>
<a href="#l13.313"></a><span id="l13.313" class="difflineminus">-NS_IMETHODIMP nsAbView::GetCellProperties(int32_t row, nsTreeColumn *col,</span>
<a href="#l13.314"></a><span id="l13.314" class="difflineminus">-                                          nsAString &amp;properties) {</span>
<a href="#l13.315"></a><span id="l13.315" class="difflineminus">-  NS_ENSURE_TRUE(row &gt;= 0, NS_ERROR_UNEXPECTED);</span>
<a href="#l13.316"></a><span id="l13.316" class="difflineminus">-</span>
<a href="#l13.317"></a><span id="l13.317" class="difflineminus">-  if (mCards.Length() &lt;= (size_t)row) return NS_OK;</span>
<a href="#l13.318"></a><span id="l13.318" class="difflineminus">-</span>
<a href="#l13.319"></a><span id="l13.319" class="difflineminus">-  const nsAString &amp;colID = col-&gt;GetId();</span>
<a href="#l13.320"></a><span id="l13.320" class="difflineminus">-  // &quot;G&quot; == &quot;GeneratedName&quot;</span>
<a href="#l13.321"></a><span id="l13.321" class="difflineminus">-  if (colID.IsEmpty() || colID.First() != 'G') return NS_OK;</span>
<a href="#l13.322"></a><span id="l13.322" class="difflineminus">-</span>
<a href="#l13.323"></a><span id="l13.323" class="difflineminus">-  nsIAbCard *card = mCards.ElementAt(row)-&gt;card;</span>
<a href="#l13.324"></a><span id="l13.324" class="difflineminus">-</span>
<a href="#l13.325"></a><span id="l13.325" class="difflineminus">-  bool isMailList;</span>
<a href="#l13.326"></a><span id="l13.326" class="difflineminus">-  nsresult rv = card-&gt;GetIsMailList(&amp;isMailList);</span>
<a href="#l13.327"></a><span id="l13.327" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.328"></a><span id="l13.328" class="difflineminus">-</span>
<a href="#l13.329"></a><span id="l13.329" class="difflineminus">-  if (isMailList) properties.AssignLiteral(&quot;MailList&quot;);</span>
<a href="#l13.330"></a><span id="l13.330" class="difflineminus">-</span>
<a href="#l13.331"></a><span id="l13.331" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.332"></a><span id="l13.332" class="difflineminus">-}</span>
<a href="#l13.333"></a><span id="l13.333" class="difflineminus">-</span>
<a href="#l13.334"></a><span id="l13.334" class="difflineminus">-NS_IMETHODIMP nsAbView::GetColumnProperties(nsTreeColumn *col,</span>
<a href="#l13.335"></a><span id="l13.335" class="difflineminus">-                                            nsAString &amp;properties) {</span>
<a href="#l13.336"></a><span id="l13.336" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.337"></a><span id="l13.337" class="difflineminus">-}</span>
<a href="#l13.338"></a><span id="l13.338" class="difflineminus">-</span>
<a href="#l13.339"></a><span id="l13.339" class="difflineminus">-NS_IMETHODIMP nsAbView::IsContainer(int32_t index, bool *_retval) {</span>
<a href="#l13.340"></a><span id="l13.340" class="difflineminus">-  *_retval = false;</span>
<a href="#l13.341"></a><span id="l13.341" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.342"></a><span id="l13.342" class="difflineminus">-}</span>
<a href="#l13.343"></a><span id="l13.343" class="difflineminus">-</span>
<a href="#l13.344"></a><span id="l13.344" class="difflineminus">-NS_IMETHODIMP nsAbView::IsContainerOpen(int32_t index, bool *_retval) {</span>
<a href="#l13.345"></a><span id="l13.345" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l13.346"></a><span id="l13.346" class="difflineminus">-}</span>
<a href="#l13.347"></a><span id="l13.347" class="difflineminus">-</span>
<a href="#l13.348"></a><span id="l13.348" class="difflineminus">-NS_IMETHODIMP nsAbView::IsContainerEmpty(int32_t index, bool *_retval) {</span>
<a href="#l13.349"></a><span id="l13.349" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l13.350"></a><span id="l13.350" class="difflineminus">-}</span>
<a href="#l13.351"></a><span id="l13.351" class="difflineminus">-</span>
<a href="#l13.352"></a><span id="l13.352" class="difflineminus">-NS_IMETHODIMP nsAbView::IsSeparator(int32_t index, bool *_retval) {</span>
<a href="#l13.353"></a><span id="l13.353" class="difflineminus">-  *_retval = false;</span>
<a href="#l13.354"></a><span id="l13.354" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.355"></a><span id="l13.355" class="difflineminus">-}</span>
<a href="#l13.356"></a><span id="l13.356" class="difflineminus">-</span>
<a href="#l13.357"></a><span id="l13.357" class="difflineminus">-NS_IMETHODIMP nsAbView::IsSorted(bool *_retval) {</span>
<a href="#l13.358"></a><span id="l13.358" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l13.359"></a><span id="l13.359" class="difflineminus">-}</span>
<a href="#l13.360"></a><span id="l13.360" class="difflineminus">-</span>
<a href="#l13.361"></a><span id="l13.361" class="difflineminus">-NS_IMETHODIMP nsAbView::CanDrop(int32_t index, int32_t orientation,</span>
<a href="#l13.362"></a><span id="l13.362" class="difflineminus">-                                mozilla::dom::DataTransfer *dataTransfer,</span>
<a href="#l13.363"></a><span id="l13.363" class="difflineminus">-                                bool *_retval) {</span>
<a href="#l13.364"></a><span id="l13.364" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l13.365"></a><span id="l13.365" class="difflineminus">-}</span>
<a href="#l13.366"></a><span id="l13.366" class="difflineminus">-</span>
<a href="#l13.367"></a><span id="l13.367" class="difflineminus">-NS_IMETHODIMP nsAbView::Drop(int32_t row, int32_t orientation,</span>
<a href="#l13.368"></a><span id="l13.368" class="difflineminus">-                             mozilla::dom::DataTransfer *dataTransfer) {</span>
<a href="#l13.369"></a><span id="l13.369" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l13.370"></a><span id="l13.370" class="difflineminus">-}</span>
<a href="#l13.371"></a><span id="l13.371" class="difflineminus">-</span>
<a href="#l13.372"></a><span id="l13.372" class="difflineminus">-NS_IMETHODIMP nsAbView::GetParentIndex(int32_t rowIndex, int32_t *_retval) {</span>
<a href="#l13.373"></a><span id="l13.373" class="difflineminus">-  *_retval = -1;</span>
<a href="#l13.374"></a><span id="l13.374" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.375"></a><span id="l13.375" class="difflineminus">-}</span>
<a href="#l13.376"></a><span id="l13.376" class="difflineminus">-</span>
<a href="#l13.377"></a><span id="l13.377" class="difflineminus">-NS_IMETHODIMP nsAbView::HasNextSibling(int32_t rowIndex, int32_t afterIndex,</span>
<a href="#l13.378"></a><span id="l13.378" class="difflineminus">-                                       bool *_retval) {</span>
<a href="#l13.379"></a><span id="l13.379" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l13.380"></a><span id="l13.380" class="difflineminus">-}</span>
<a href="#l13.381"></a><span id="l13.381" class="difflineminus">-</span>
<a href="#l13.382"></a><span id="l13.382" class="difflineminus">-NS_IMETHODIMP nsAbView::GetLevel(int32_t index, int32_t *_retval) {</span>
<a href="#l13.383"></a><span id="l13.383" class="difflineminus">-  *_retval = 0;</span>
<a href="#l13.384"></a><span id="l13.384" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.385"></a><span id="l13.385" class="difflineminus">-}</span>
<a href="#l13.386"></a><span id="l13.386" class="difflineminus">-</span>
<a href="#l13.387"></a><span id="l13.387" class="difflineminus">-NS_IMETHODIMP nsAbView::GetImageSrc(int32_t row, nsTreeColumn *col,</span>
<a href="#l13.388"></a><span id="l13.388" class="difflineminus">-                                    nsAString &amp;_retval) {</span>
<a href="#l13.389"></a><span id="l13.389" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.390"></a><span id="l13.390" class="difflineminus">-}</span>
<a href="#l13.391"></a><span id="l13.391" class="difflineminus">-</span>
<a href="#l13.392"></a><span id="l13.392" class="difflineminus">-NS_IMETHODIMP nsAbView::GetCellValue(int32_t row, nsTreeColumn *col,</span>
<a href="#l13.393"></a><span id="l13.393" class="difflineminus">-                                     nsAString &amp;_retval) {</span>
<a href="#l13.394"></a><span id="l13.394" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.395"></a><span id="l13.395" class="difflineminus">-}</span>
<a href="#l13.396"></a><span id="l13.396" class="difflineminus">-</span>
<a href="#l13.397"></a><span id="l13.397" class="difflineminus">-nsresult nsAbView::GetCardValue(nsIAbCard *card, const nsAString &amp;colID,</span>
<a href="#l13.398"></a><span id="l13.398" class="difflineminus">-                                nsAString &amp;_retval) {</span>
<a href="#l13.399"></a><span id="l13.399" class="difflineminus">-  if (colID.EqualsLiteral(&quot;addrbook&quot;)) {</span>
<a href="#l13.400"></a><span id="l13.400" class="difflineminus">-    nsCString dirID;</span>
<a href="#l13.401"></a><span id="l13.401" class="difflineminus">-    nsresult rv = card-&gt;GetDirectoryId(dirID);</span>
<a href="#l13.402"></a><span id="l13.402" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l13.403"></a><span id="l13.403" class="difflineminus">-      CopyUTF8toUTF16(Substring(dirID, dirID.FindChar('&amp;') + 1), _retval);</span>
<a href="#l13.404"></a><span id="l13.404" class="difflineminus">-</span>
<a href="#l13.405"></a><span id="l13.405" class="difflineminus">-    return rv;</span>
<a href="#l13.406"></a><span id="l13.406" class="difflineminus">-  }</span>
<a href="#l13.407"></a><span id="l13.407" class="difflineminus">-</span>
<a href="#l13.408"></a><span id="l13.408" class="difflineminus">-  // &quot;G&quot; == &quot;GeneratedName&quot;, &quot;_P&quot; == &quot;_PhoneticName&quot;</span>
<a href="#l13.409"></a><span id="l13.409" class="difflineminus">-  // else, standard column (like PrimaryEmail and _AimScreenName)</span>
<a href="#l13.410"></a><span id="l13.410" class="difflineminus">-  if (colID[0] == char16_t('G'))</span>
<a href="#l13.411"></a><span id="l13.411" class="difflineminus">-    return card-&gt;GenerateName(mGeneratedNameFormat, mABBundle, _retval);</span>
<a href="#l13.412"></a><span id="l13.412" class="difflineminus">-</span>
<a href="#l13.413"></a><span id="l13.413" class="difflineminus">-  if (colID[0] == char16_t('_') &amp;&amp; colID[1] == char16_t('P'))</span>
<a href="#l13.414"></a><span id="l13.414" class="difflineminus">-    // Use LN/FN order for the phonetic name</span>
<a href="#l13.415"></a><span id="l13.415" class="difflineminus">-    return card-&gt;GeneratePhoneticName(true, _retval);</span>
<a href="#l13.416"></a><span id="l13.416" class="difflineminus">-</span>
<a href="#l13.417"></a><span id="l13.417" class="difflineminus">-  if (colID.EqualsLiteral(&quot;ChatName&quot;)) return card-&gt;GenerateChatName(_retval);</span>
<a href="#l13.418"></a><span id="l13.418" class="difflineminus">-</span>
<a href="#l13.419"></a><span id="l13.419" class="difflineminus">-  nsresult rv =</span>
<a href="#l13.420"></a><span id="l13.420" class="difflineminus">-      card-&gt;GetPropertyAsAString(NS_ConvertUTF16toUTF8(colID).get(), _retval);</span>
<a href="#l13.421"></a><span id="l13.421" class="difflineminus">-  if (rv == NS_ERROR_NOT_AVAILABLE) {</span>
<a href="#l13.422"></a><span id="l13.422" class="difflineminus">-    rv = NS_OK;</span>
<a href="#l13.423"></a><span id="l13.423" class="difflineminus">-    _retval.Truncate();</span>
<a href="#l13.424"></a><span id="l13.424" class="difflineminus">-  }</span>
<a href="#l13.425"></a><span id="l13.425" class="difflineminus">-  return rv;</span>
<a href="#l13.426"></a><span id="l13.426" class="difflineminus">-}</span>
<a href="#l13.427"></a><span id="l13.427" class="difflineminus">-</span>
<a href="#l13.428"></a><span id="l13.428" class="difflineminus">-nsresult nsAbView::RefreshTree() {</span>
<a href="#l13.429"></a><span id="l13.429" class="difflineminus">-  nsresult rv;</span>
<a href="#l13.430"></a><span id="l13.430" class="difflineminus">-</span>
<a href="#l13.431"></a><span id="l13.431" class="difflineminus">-  // The PREF_MAIL_ADDR_BOOK_LASTNAMEFIRST pref affects how the GeneratedName</span>
<a href="#l13.432"></a><span id="l13.432" class="difflineminus">-  // column looks. so if the GeneratedName is our primary or secondary sort, we</span>
<a href="#l13.433"></a><span id="l13.433" class="difflineminus">-  // need to resort. the same applies for kPhoneticNameColumn</span>
<a href="#l13.434"></a><span id="l13.434" class="difflineminus">-  //</span>
<a href="#l13.435"></a><span id="l13.435" class="difflineminus">-  // XXX optimize me</span>
<a href="#l13.436"></a><span id="l13.436" class="difflineminus">-  // PrimaryEmail is always the secondary sort, unless it is currently the</span>
<a href="#l13.437"></a><span id="l13.437" class="difflineminus">-  // primary sort.  So, if PrimaryEmail is the primary sort,</span>
<a href="#l13.438"></a><span id="l13.438" class="difflineminus">-  // GeneratedName might be the secondary sort.</span>
<a href="#l13.439"></a><span id="l13.439" class="difflineminus">-  //</span>
<a href="#l13.440"></a><span id="l13.440" class="difflineminus">-  // One day, we can get fancy and remember what the secondary sort is.</span>
<a href="#l13.441"></a><span id="l13.441" class="difflineminus">-  // We do that, we can fix this code. At best, it will turn a sort into a</span>
<a href="#l13.442"></a><span id="l13.442" class="difflineminus">-  // invalidate.</span>
<a href="#l13.443"></a><span id="l13.443" class="difflineminus">-  //</span>
<a href="#l13.444"></a><span id="l13.444" class="difflineminus">-  // If neither the primary nor the secondary sorts are GeneratedName (or</span>
<a href="#l13.445"></a><span id="l13.445" class="difflineminus">-  // kPhoneticNameColumn), all we have to do is invalidate (to show the new</span>
<a href="#l13.446"></a><span id="l13.446" class="difflineminus">-  // GeneratedNames), but the sort will not change.</span>
<a href="#l13.447"></a><span id="l13.447" class="difflineminus">-  if (mSortColumn.EqualsLiteral(GENERATED_NAME_COLUMN_ID) ||</span>
<a href="#l13.448"></a><span id="l13.448" class="difflineminus">-      mSortColumn.EqualsLiteral(kPriEmailProperty) ||</span>
<a href="#l13.449"></a><span id="l13.449" class="difflineminus">-      mSortColumn.EqualsLiteral(kPhoneticNameColumn)) {</span>
<a href="#l13.450"></a><span id="l13.450" class="difflineminus">-    rv = SortBy(mSortColumn.get(), mSortDirection.get(), true);</span>
<a href="#l13.451"></a><span id="l13.451" class="difflineminus">-  } else {</span>
<a href="#l13.452"></a><span id="l13.452" class="difflineminus">-    rv = InvalidateTree(ALL_ROWS);</span>
<a href="#l13.453"></a><span id="l13.453" class="difflineminus">-</span>
<a href="#l13.454"></a><span id="l13.454" class="difflineminus">-    // Although the selection hasn't changed, the card that is selected may need</span>
<a href="#l13.455"></a><span id="l13.455" class="difflineminus">-    // to be displayed differently, therefore pretend that the selection has</span>
<a href="#l13.456"></a><span id="l13.456" class="difflineminus">-    // changed to force that update.</span>
<a href="#l13.457"></a><span id="l13.457" class="difflineminus">-    SelectionChangedXPCOM();</span>
<a href="#l13.458"></a><span id="l13.458" class="difflineminus">-  }</span>
<a href="#l13.459"></a><span id="l13.459" class="difflineminus">-</span>
<a href="#l13.460"></a><span id="l13.460" class="difflineminus">-  return rv;</span>
<a href="#l13.461"></a><span id="l13.461" class="difflineminus">-}</span>
<a href="#l13.462"></a><span id="l13.462" class="difflineminus">-</span>
<a href="#l13.463"></a><span id="l13.463" class="difflineminus">-NS_IMETHODIMP nsAbView::GetCellText(int32_t row, nsTreeColumn *col,</span>
<a href="#l13.464"></a><span id="l13.464" class="difflineminus">-                                    nsAString &amp;_retval) {</span>
<a href="#l13.465"></a><span id="l13.465" class="difflineminus">-  NS_ENSURE_TRUE(row &gt;= 0 &amp;&amp; (size_t)row &lt; mCards.Length(),</span>
<a href="#l13.466"></a><span id="l13.466" class="difflineminus">-                 NS_ERROR_UNEXPECTED);</span>
<a href="#l13.467"></a><span id="l13.467" class="difflineminus">-</span>
<a href="#l13.468"></a><span id="l13.468" class="difflineminus">-  nsIAbCard *card = mCards.ElementAt(row)-&gt;card;</span>
<a href="#l13.469"></a><span id="l13.469" class="difflineminus">-  const nsAString &amp;colID = col-&gt;GetId();</span>
<a href="#l13.470"></a><span id="l13.470" class="difflineminus">-  return GetCardValue(card, colID, _retval);</span>
<a href="#l13.471"></a><span id="l13.471" class="difflineminus">-}</span>
<a href="#l13.472"></a><span id="l13.472" class="difflineminus">-</span>
<a href="#l13.473"></a><span id="l13.473" class="difflineminus">-NS_IMETHODIMP nsAbView::SetTree(mozilla::dom::XULTreeElement *tree) {</span>
<a href="#l13.474"></a><span id="l13.474" class="difflineminus">-  mTree = tree;</span>
<a href="#l13.475"></a><span id="l13.475" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.476"></a><span id="l13.476" class="difflineminus">-}</span>
<a href="#l13.477"></a><span id="l13.477" class="difflineminus">-</span>
<a href="#l13.478"></a><span id="l13.478" class="difflineminus">-NS_IMETHODIMP nsAbView::ToggleOpenState(int32_t index) {</span>
<a href="#l13.479"></a><span id="l13.479" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l13.480"></a><span id="l13.480" class="difflineminus">-}</span>
<a href="#l13.481"></a><span id="l13.481" class="difflineminus">-</span>
<a href="#l13.482"></a><span id="l13.482" class="difflineminus">-NS_IMETHODIMP nsAbView::CycleHeader(nsTreeColumn *col) { return NS_OK; }</span>
<a href="#l13.483"></a><span id="l13.483" class="difflineminus">-</span>
<a href="#l13.484"></a><span id="l13.484" class="difflineminus">-nsresult nsAbView::InvalidateTree(int32_t row) {</span>
<a href="#l13.485"></a><span id="l13.485" class="difflineminus">-  if (!mTree) return NS_OK;</span>
<a href="#l13.486"></a><span id="l13.486" class="difflineminus">-</span>
<a href="#l13.487"></a><span id="l13.487" class="difflineminus">-  if (row == ALL_ROWS)</span>
<a href="#l13.488"></a><span id="l13.488" class="difflineminus">-    mTree-&gt;Invalidate();</span>
<a href="#l13.489"></a><span id="l13.489" class="difflineminus">-  else</span>
<a href="#l13.490"></a><span id="l13.490" class="difflineminus">-    mTree-&gt;InvalidateRow(row);</span>
<a href="#l13.491"></a><span id="l13.491" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.492"></a><span id="l13.492" class="difflineminus">-}</span>
<a href="#l13.493"></a><span id="l13.493" class="difflineminus">-</span>
<a href="#l13.494"></a><span id="l13.494" class="difflineminus">-NS_IMETHODIMP nsAbView::SelectionChangedXPCOM() {</span>
<a href="#l13.495"></a><span id="l13.495" class="difflineminus">-  if (mAbViewListener &amp;&amp; !mSuppressSelectionChange) {</span>
<a href="#l13.496"></a><span id="l13.496" class="difflineminus">-    nsresult rv = mAbViewListener-&gt;OnSelectionChanged();</span>
<a href="#l13.497"></a><span id="l13.497" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.498"></a><span id="l13.498" class="difflineminus">-  }</span>
<a href="#l13.499"></a><span id="l13.499" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.500"></a><span id="l13.500" class="difflineminus">-}</span>
<a href="#l13.501"></a><span id="l13.501" class="difflineminus">-</span>
<a href="#l13.502"></a><span id="l13.502" class="difflineminus">-NS_IMETHODIMP nsAbView::CycleCell(int32_t row, nsTreeColumn *col) {</span>
<a href="#l13.503"></a><span id="l13.503" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l13.504"></a><span id="l13.504" class="difflineminus">-}</span>
<a href="#l13.505"></a><span id="l13.505" class="difflineminus">-</span>
<a href="#l13.506"></a><span id="l13.506" class="difflineminus">-NS_IMETHODIMP nsAbView::IsEditable(int32_t row, nsTreeColumn *col,</span>
<a href="#l13.507"></a><span id="l13.507" class="difflineminus">-                                   bool *_retval) {</span>
<a href="#l13.508"></a><span id="l13.508" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l13.509"></a><span id="l13.509" class="difflineminus">-}</span>
<a href="#l13.510"></a><span id="l13.510" class="difflineminus">-</span>
<a href="#l13.511"></a><span id="l13.511" class="difflineminus">-NS_IMETHODIMP nsAbView::SetCellValue(int32_t row, nsTreeColumn *col,</span>
<a href="#l13.512"></a><span id="l13.512" class="difflineminus">-                                     const nsAString &amp;value) {</span>
<a href="#l13.513"></a><span id="l13.513" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l13.514"></a><span id="l13.514" class="difflineminus">-}</span>
<a href="#l13.515"></a><span id="l13.515" class="difflineminus">-</span>
<a href="#l13.516"></a><span id="l13.516" class="difflineminus">-NS_IMETHODIMP nsAbView::SetCellText(int32_t row, nsTreeColumn *col,</span>
<a href="#l13.517"></a><span id="l13.517" class="difflineminus">-                                    const nsAString &amp;value) {</span>
<a href="#l13.518"></a><span id="l13.518" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l13.519"></a><span id="l13.519" class="difflineminus">-}</span>
<a href="#l13.520"></a><span id="l13.520" class="difflineminus">-</span>
<a href="#l13.521"></a><span id="l13.521" class="difflineminus">-NS_IMETHODIMP nsAbView::GetCardFromRow(int32_t row, nsIAbCard **aCard) {</span>
<a href="#l13.522"></a><span id="l13.522" class="difflineminus">-  *aCard = nullptr;</span>
<a href="#l13.523"></a><span id="l13.523" class="difflineminus">-  NS_ENSURE_TRUE(row &gt;= 0, NS_ERROR_UNEXPECTED);</span>
<a href="#l13.524"></a><span id="l13.524" class="difflineminus">-  if (mCards.Length() &lt;= (size_t)row) {</span>
<a href="#l13.525"></a><span id="l13.525" class="difflineminus">-    return NS_OK;</span>
<a href="#l13.526"></a><span id="l13.526" class="difflineminus">-  }</span>
<a href="#l13.527"></a><span id="l13.527" class="difflineminus">-</span>
<a href="#l13.528"></a><span id="l13.528" class="difflineminus">-  AbCard *a = mCards.ElementAt(row);</span>
<a href="#l13.529"></a><span id="l13.529" class="difflineminus">-  if (!a) return NS_OK;</span>
<a href="#l13.530"></a><span id="l13.530" class="difflineminus">-</span>
<a href="#l13.531"></a><span id="l13.531" class="difflineminus">-  NS_IF_ADDREF(*aCard = a-&gt;card);</span>
<a href="#l13.532"></a><span id="l13.532" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.533"></a><span id="l13.533" class="difflineminus">-}</span>
<a href="#l13.534"></a><span id="l13.534" class="difflineminus">-</span>
<a href="#l13.535"></a><span id="l13.535" class="difflineminus">-#define DESCENDING_SORT_FACTOR -1</span>
<a href="#l13.536"></a><span id="l13.536" class="difflineminus">-#define ASCENDING_SORT_FACTOR 1</span>
<a href="#l13.537"></a><span id="l13.537" class="difflineminus">-</span>
<a href="#l13.538"></a><span id="l13.538" class="difflineminus">-typedef struct SortClosure {</span>
<a href="#l13.539"></a><span id="l13.539" class="difflineminus">-  const char16_t *colID;</span>
<a href="#l13.540"></a><span id="l13.540" class="difflineminus">-  int32_t factor;</span>
<a href="#l13.541"></a><span id="l13.541" class="difflineminus">-  nsAbView *abView;</span>
<a href="#l13.542"></a><span id="l13.542" class="difflineminus">-} SortClosure;</span>
<a href="#l13.543"></a><span id="l13.543" class="difflineminus">-</span>
<a href="#l13.544"></a><span id="l13.544" class="difflineminus">-static int inplaceSortCallback(const AbCard *card1, const AbCard *card2,</span>
<a href="#l13.545"></a><span id="l13.545" class="difflineminus">-                               SortClosure *closure) {</span>
<a href="#l13.546"></a><span id="l13.546" class="difflineminus">-  int32_t sortValue;</span>
<a href="#l13.547"></a><span id="l13.547" class="difflineminus">-</span>
<a href="#l13.548"></a><span id="l13.548" class="difflineminus">-  // If we are sorting the &quot;PrimaryEmail&quot;, swap the collation keys, as the</span>
<a href="#l13.549"></a><span id="l13.549" class="difflineminus">-  // secondary is always the PrimaryEmail. Use the last primary key as the</span>
<a href="#l13.550"></a><span id="l13.550" class="difflineminus">-  // secondary key.</span>
<a href="#l13.551"></a><span id="l13.551" class="difflineminus">-  //</span>
<a href="#l13.552"></a><span id="l13.552" class="difflineminus">-  // &quot;Pr&quot; to distinguish &quot;PrimaryEmail&quot; from &quot;PagerNumber&quot;</span>
<a href="#l13.553"></a><span id="l13.553" class="difflineminus">-  if (closure-&gt;colID[0] == char16_t('P') &amp;&amp;</span>
<a href="#l13.554"></a><span id="l13.554" class="difflineminus">-      closure-&gt;colID[1] == char16_t('r')) {</span>
<a href="#l13.555"></a><span id="l13.555" class="difflineminus">-    sortValue = closure-&gt;abView-&gt;CompareCollationKeys(</span>
<a href="#l13.556"></a><span id="l13.556" class="difflineminus">-        card1-&gt;secondaryCollationKey, card2-&gt;secondaryCollationKey);</span>
<a href="#l13.557"></a><span id="l13.557" class="difflineminus">-    if (sortValue)</span>
<a href="#l13.558"></a><span id="l13.558" class="difflineminus">-      return sortValue * closure-&gt;factor;</span>
<a href="#l13.559"></a><span id="l13.559" class="difflineminus">-    else</span>
<a href="#l13.560"></a><span id="l13.560" class="difflineminus">-      return closure-&gt;abView-&gt;CompareCollationKeys(card1-&gt;primaryCollationKey,</span>
<a href="#l13.561"></a><span id="l13.561" class="difflineminus">-                                                   card2-&gt;primaryCollationKey) *</span>
<a href="#l13.562"></a><span id="l13.562" class="difflineminus">-             (closure-&gt;factor);</span>
<a href="#l13.563"></a><span id="l13.563" class="difflineminus">-  } else {</span>
<a href="#l13.564"></a><span id="l13.564" class="difflineminus">-    sortValue = closure-&gt;abView-&gt;CompareCollationKeys(</span>
<a href="#l13.565"></a><span id="l13.565" class="difflineminus">-        card1-&gt;primaryCollationKey, card2-&gt;primaryCollationKey);</span>
<a href="#l13.566"></a><span id="l13.566" class="difflineminus">-    if (sortValue)</span>
<a href="#l13.567"></a><span id="l13.567" class="difflineminus">-      return sortValue * (closure-&gt;factor);</span>
<a href="#l13.568"></a><span id="l13.568" class="difflineminus">-    else</span>
<a href="#l13.569"></a><span id="l13.569" class="difflineminus">-      return closure-&gt;abView-&gt;CompareCollationKeys(</span>
<a href="#l13.570"></a><span id="l13.570" class="difflineminus">-                 card1-&gt;secondaryCollationKey, card2-&gt;secondaryCollationKey) *</span>
<a href="#l13.571"></a><span id="l13.571" class="difflineminus">-             (closure-&gt;factor);</span>
<a href="#l13.572"></a><span id="l13.572" class="difflineminus">-  }</span>
<a href="#l13.573"></a><span id="l13.573" class="difflineminus">-}</span>
<a href="#l13.574"></a><span id="l13.574" class="difflineminus">-</span>
<a href="#l13.575"></a><span id="l13.575" class="difflineminus">-static void SetSortClosure(const char16_t *sortColumn,</span>
<a href="#l13.576"></a><span id="l13.576" class="difflineminus">-                           const char16_t *sortDirection, nsAbView *abView,</span>
<a href="#l13.577"></a><span id="l13.577" class="difflineminus">-                           SortClosure *closure) {</span>
<a href="#l13.578"></a><span id="l13.578" class="difflineminus">-  closure-&gt;colID = sortColumn;</span>
<a href="#l13.579"></a><span id="l13.579" class="difflineminus">-</span>
<a href="#l13.580"></a><span id="l13.580" class="difflineminus">-  if (sortDirection &amp;&amp; !NS_strcmp(sortDirection, u&quot;descending&quot;))</span>
<a href="#l13.581"></a><span id="l13.581" class="difflineminus">-    closure-&gt;factor = DESCENDING_SORT_FACTOR;</span>
<a href="#l13.582"></a><span id="l13.582" class="difflineminus">-  else</span>
<a href="#l13.583"></a><span id="l13.583" class="difflineminus">-    closure-&gt;factor = ASCENDING_SORT_FACTOR;</span>
<a href="#l13.584"></a><span id="l13.584" class="difflineminus">-</span>
<a href="#l13.585"></a><span id="l13.585" class="difflineminus">-  closure-&gt;abView = abView;</span>
<a href="#l13.586"></a><span id="l13.586" class="difflineminus">-  return;</span>
<a href="#l13.587"></a><span id="l13.587" class="difflineminus">-}</span>
<a href="#l13.588"></a><span id="l13.588" class="difflineminus">-</span>
<a href="#l13.589"></a><span id="l13.589" class="difflineminus">-class CardComparator {</span>
<a href="#l13.590"></a><span id="l13.590" class="difflineminus">- public:</span>
<a href="#l13.591"></a><span id="l13.591" class="difflineminus">-  void SetClosure(SortClosure *closure) { m_closure = closure; };</span>
<a href="#l13.592"></a><span id="l13.592" class="difflineminus">-</span>
<a href="#l13.593"></a><span id="l13.593" class="difflineminus">-  bool Equals(const AbCard *a, const AbCard *b) const {</span>
<a href="#l13.594"></a><span id="l13.594" class="difflineminus">-    return inplaceSortCallback(a, b, m_closure) == 0;</span>
<a href="#l13.595"></a><span id="l13.595" class="difflineminus">-  }</span>
<a href="#l13.596"></a><span id="l13.596" class="difflineminus">-  bool LessThan(const AbCard *a, const AbCard *b) const {</span>
<a href="#l13.597"></a><span id="l13.597" class="difflineminus">-    return inplaceSortCallback(a, b, m_closure) &lt; 0;</span>
<a href="#l13.598"></a><span id="l13.598" class="difflineminus">-  }</span>
<a href="#l13.599"></a><span id="l13.599" class="difflineminus">-</span>
<a href="#l13.600"></a><span id="l13.600" class="difflineminus">- private:</span>
<a href="#l13.601"></a><span id="l13.601" class="difflineminus">-  SortClosure *m_closure;</span>
<a href="#l13.602"></a><span id="l13.602" class="difflineminus">-};</span>
<a href="#l13.603"></a><span id="l13.603" class="difflineminus">-</span>
<a href="#l13.604"></a><span id="l13.604" class="difflineminus">-NS_IMETHODIMP nsAbView::SortBy(const char16_t *colID, const char16_t *sortDir,</span>
<a href="#l13.605"></a><span id="l13.605" class="difflineminus">-                               bool aResort = false) {</span>
<a href="#l13.606"></a><span id="l13.606" class="difflineminus">-  nsresult rv;</span>
<a href="#l13.607"></a><span id="l13.607" class="difflineminus">-</span>
<a href="#l13.608"></a><span id="l13.608" class="difflineminus">-  int32_t count = mCards.Length();</span>
<a href="#l13.609"></a><span id="l13.609" class="difflineminus">-</span>
<a href="#l13.610"></a><span id="l13.610" class="difflineminus">-  nsAutoString sortColumn;</span>
<a href="#l13.611"></a><span id="l13.611" class="difflineminus">-  if (!colID)</span>
<a href="#l13.612"></a><span id="l13.612" class="difflineminus">-    sortColumn =</span>
<a href="#l13.613"></a><span id="l13.613" class="difflineminus">-        NS_LITERAL_STRING(GENERATED_NAME_COLUMN_ID);  // default sort column</span>
<a href="#l13.614"></a><span id="l13.614" class="difflineminus">-  else</span>
<a href="#l13.615"></a><span id="l13.615" class="difflineminus">-    sortColumn = colID;</span>
<a href="#l13.616"></a><span id="l13.616" class="difflineminus">-</span>
<a href="#l13.617"></a><span id="l13.617" class="difflineminus">-  nsAutoString sortDirection;</span>
<a href="#l13.618"></a><span id="l13.618" class="difflineminus">-  if (!sortDir)</span>
<a href="#l13.619"></a><span id="l13.619" class="difflineminus">-    sortDirection = NS_LITERAL_STRING(&quot;ascending&quot;);  // default direction</span>
<a href="#l13.620"></a><span id="l13.620" class="difflineminus">-  else</span>
<a href="#l13.621"></a><span id="l13.621" class="difflineminus">-    sortDirection = sortDir;</span>
<a href="#l13.622"></a><span id="l13.622" class="difflineminus">-</span>
<a href="#l13.623"></a><span id="l13.623" class="difflineminus">-  if (mSortColumn.Equals(sortColumn) &amp;&amp; !aResort) {</span>
<a href="#l13.624"></a><span id="l13.624" class="difflineminus">-    if (mSortDirection.Equals(sortDir)) {</span>
<a href="#l13.625"></a><span id="l13.625" class="difflineminus">-      // If sortColumn and sortDirection are identical since the last call, do</span>
<a href="#l13.626"></a><span id="l13.626" class="difflineminus">-      // nothing.</span>
<a href="#l13.627"></a><span id="l13.627" class="difflineminus">-      return NS_OK;</span>
<a href="#l13.628"></a><span id="l13.628" class="difflineminus">-    } else {</span>
<a href="#l13.629"></a><span id="l13.629" class="difflineminus">-      // If we are sorting by how we are already sorted,</span>
<a href="#l13.630"></a><span id="l13.630" class="difflineminus">-      // and just the sort direction changes, just reverse.</span>
<a href="#l13.631"></a><span id="l13.631" class="difflineminus">-      int32_t halfPoint = count / 2;</span>
<a href="#l13.632"></a><span id="l13.632" class="difflineminus">-      for (int32_t i = 0; i &lt; halfPoint; i++) {</span>
<a href="#l13.633"></a><span id="l13.633" class="difflineminus">-        // Swap the elements.</span>
<a href="#l13.634"></a><span id="l13.634" class="difflineminus">-        AbCard *ptr1 = mCards.ElementAt(i);</span>
<a href="#l13.635"></a><span id="l13.635" class="difflineminus">-        AbCard *ptr2 = mCards.ElementAt(count - i - 1);</span>
<a href="#l13.636"></a><span id="l13.636" class="difflineminus">-        mCards.ReplaceElementAt(i, ptr2);</span>
<a href="#l13.637"></a><span id="l13.637" class="difflineminus">-        mCards.ReplaceElementAt(count - i - 1, ptr1);</span>
<a href="#l13.638"></a><span id="l13.638" class="difflineminus">-      }</span>
<a href="#l13.639"></a><span id="l13.639" class="difflineminus">-      mSortDirection = sortDir;</span>
<a href="#l13.640"></a><span id="l13.640" class="difflineminus">-    }</span>
<a href="#l13.641"></a><span id="l13.641" class="difflineminus">-  } else {</span>
<a href="#l13.642"></a><span id="l13.642" class="difflineminus">-    // Generate collation keys</span>
<a href="#l13.643"></a><span id="l13.643" class="difflineminus">-    for (int32_t i = 0; i &lt; count; i++) {</span>
<a href="#l13.644"></a><span id="l13.644" class="difflineminus">-      AbCard *abcard = mCards.ElementAt(i);</span>
<a href="#l13.645"></a><span id="l13.645" class="difflineminus">-</span>
<a href="#l13.646"></a><span id="l13.646" class="difflineminus">-      rv = GenerateCollationKeysForCard(sortColumn, abcard);</span>
<a href="#l13.647"></a><span id="l13.647" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.648"></a><span id="l13.648" class="difflineminus">-    }</span>
<a href="#l13.649"></a><span id="l13.649" class="difflineminus">-</span>
<a href="#l13.650"></a><span id="l13.650" class="difflineminus">-    // We need to do full sort.</span>
<a href="#l13.651"></a><span id="l13.651" class="difflineminus">-    SortClosure closure;</span>
<a href="#l13.652"></a><span id="l13.652" class="difflineminus">-    SetSortClosure(sortColumn.get(), sortDirection.get(), this, &amp;closure);</span>
<a href="#l13.653"></a><span id="l13.653" class="difflineminus">-</span>
<a href="#l13.654"></a><span id="l13.654" class="difflineminus">-    nsCOMPtr&lt;nsIMutableArray&gt; selectedCards =</span>
<a href="#l13.655"></a><span id="l13.655" class="difflineminus">-        do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l13.656"></a><span id="l13.656" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.657"></a><span id="l13.657" class="difflineminus">-</span>
<a href="#l13.658"></a><span id="l13.658" class="difflineminus">-    rv = GetSelectedCards(selectedCards);</span>
<a href="#l13.659"></a><span id="l13.659" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.660"></a><span id="l13.660" class="difflineminus">-</span>
<a href="#l13.661"></a><span id="l13.661" class="difflineminus">-    nsCOMPtr&lt;nsIAbCard&gt; indexCard;</span>
<a href="#l13.662"></a><span id="l13.662" class="difflineminus">-</span>
<a href="#l13.663"></a><span id="l13.663" class="difflineminus">-    if (mTreeSelection) {</span>
<a href="#l13.664"></a><span id="l13.664" class="difflineminus">-      int32_t currentIndex = -1;</span>
<a href="#l13.665"></a><span id="l13.665" class="difflineminus">-</span>
<a href="#l13.666"></a><span id="l13.666" class="difflineminus">-      rv = mTreeSelection-&gt;GetCurrentIndex(&amp;currentIndex);</span>
<a href="#l13.667"></a><span id="l13.667" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.668"></a><span id="l13.668" class="difflineminus">-</span>
<a href="#l13.669"></a><span id="l13.669" class="difflineminus">-      if (currentIndex != -1) {</span>
<a href="#l13.670"></a><span id="l13.670" class="difflineminus">-        rv = GetCardFromRow(currentIndex, getter_AddRefs(indexCard));</span>
<a href="#l13.671"></a><span id="l13.671" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.672"></a><span id="l13.672" class="difflineminus">-      }</span>
<a href="#l13.673"></a><span id="l13.673" class="difflineminus">-    }</span>
<a href="#l13.674"></a><span id="l13.674" class="difflineminus">-</span>
<a href="#l13.675"></a><span id="l13.675" class="difflineminus">-    CardComparator cardComparator;</span>
<a href="#l13.676"></a><span id="l13.676" class="difflineminus">-    cardComparator.SetClosure(&amp;closure);</span>
<a href="#l13.677"></a><span id="l13.677" class="difflineminus">-    mCards.Sort(cardComparator);</span>
<a href="#l13.678"></a><span id="l13.678" class="difflineminus">-</span>
<a href="#l13.679"></a><span id="l13.679" class="difflineminus">-    rv = ReselectCards(selectedCards, indexCard);</span>
<a href="#l13.680"></a><span id="l13.680" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.681"></a><span id="l13.681" class="difflineminus">-</span>
<a href="#l13.682"></a><span id="l13.682" class="difflineminus">-    mSortColumn = sortColumn;</span>
<a href="#l13.683"></a><span id="l13.683" class="difflineminus">-    mSortDirection = sortDirection;</span>
<a href="#l13.684"></a><span id="l13.684" class="difflineminus">-  }</span>
<a href="#l13.685"></a><span id="l13.685" class="difflineminus">-</span>
<a href="#l13.686"></a><span id="l13.686" class="difflineminus">-  rv = InvalidateTree(ALL_ROWS);</span>
<a href="#l13.687"></a><span id="l13.687" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.688"></a><span id="l13.688" class="difflineminus">-  return rv;</span>
<a href="#l13.689"></a><span id="l13.689" class="difflineminus">-}</span>
<a href="#l13.690"></a><span id="l13.690" class="difflineminus">-</span>
<a href="#l13.691"></a><span id="l13.691" class="difflineminus">-int32_t nsAbView::CompareCollationKeys(const nsTArray&lt;uint8_t&gt; &amp;key1,</span>
<a href="#l13.692"></a><span id="l13.692" class="difflineminus">-                                       const nsTArray&lt;uint8_t&gt; &amp;key2) {</span>
<a href="#l13.693"></a><span id="l13.693" class="difflineminus">-  NS_ASSERTION(mCollationKeyGenerator, &quot;no key generator&quot;);</span>
<a href="#l13.694"></a><span id="l13.694" class="difflineminus">-  if (!mCollationKeyGenerator) return 0;</span>
<a href="#l13.695"></a><span id="l13.695" class="difflineminus">-</span>
<a href="#l13.696"></a><span id="l13.696" class="difflineminus">-  int32_t result;</span>
<a href="#l13.697"></a><span id="l13.697" class="difflineminus">-</span>
<a href="#l13.698"></a><span id="l13.698" class="difflineminus">-  nsresult rv = mCollationKeyGenerator-&gt;CompareRawSortKey(key1, key2, &amp;result);</span>
<a href="#l13.699"></a><span id="l13.699" class="difflineminus">-  NS_ASSERTION(NS_SUCCEEDED(rv), &quot;key compare failed&quot;);</span>
<a href="#l13.700"></a><span id="l13.700" class="difflineminus">-  if (NS_FAILED(rv)) result = 0;</span>
<a href="#l13.701"></a><span id="l13.701" class="difflineminus">-  return result;</span>
<a href="#l13.702"></a><span id="l13.702" class="difflineminus">-}</span>
<a href="#l13.703"></a><span id="l13.703" class="difflineminus">-</span>
<a href="#l13.704"></a><span id="l13.704" class="difflineminus">-nsresult nsAbView::GenerateCollationKeysForCard(const nsAString &amp;colID,</span>
<a href="#l13.705"></a><span id="l13.705" class="difflineminus">-                                                AbCard *abcard) {</span>
<a href="#l13.706"></a><span id="l13.706" class="difflineminus">-  nsresult rv;</span>
<a href="#l13.707"></a><span id="l13.707" class="difflineminus">-  nsString value;</span>
<a href="#l13.708"></a><span id="l13.708" class="difflineminus">-</span>
<a href="#l13.709"></a><span id="l13.709" class="difflineminus">-  if (!mCollationKeyGenerator) {</span>
<a href="#l13.710"></a><span id="l13.710" class="difflineminus">-    nsCOMPtr&lt;nsICollationFactory&gt; factory =</span>
<a href="#l13.711"></a><span id="l13.711" class="difflineminus">-        do_CreateInstance(NS_COLLATIONFACTORY_CONTRACTID, &amp;rv);</span>
<a href="#l13.712"></a><span id="l13.712" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.713"></a><span id="l13.713" class="difflineminus">-</span>
<a href="#l13.714"></a><span id="l13.714" class="difflineminus">-    rv = factory-&gt;CreateCollation(getter_AddRefs(mCollationKeyGenerator));</span>
<a href="#l13.715"></a><span id="l13.715" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.716"></a><span id="l13.716" class="difflineminus">-  }</span>
<a href="#l13.717"></a><span id="l13.717" class="difflineminus">-</span>
<a href="#l13.718"></a><span id="l13.718" class="difflineminus">-  rv = GetCardValue(abcard-&gt;card, colID, value);</span>
<a href="#l13.719"></a><span id="l13.719" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.720"></a><span id="l13.720" class="difflineminus">-</span>
<a href="#l13.721"></a><span id="l13.721" class="difflineminus">-  rv = mCollationKeyGenerator-&gt;AllocateRawSortKey(</span>
<a href="#l13.722"></a><span id="l13.722" class="difflineminus">-      nsICollation::kCollationCaseInSensitive, value,</span>
<a href="#l13.723"></a><span id="l13.723" class="difflineminus">-      abcard-&gt;primaryCollationKey);</span>
<a href="#l13.724"></a><span id="l13.724" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.725"></a><span id="l13.725" class="difflineminus">-</span>
<a href="#l13.726"></a><span id="l13.726" class="difflineminus">-  // Hardcode email to be our secondary key. As we are doing this, just call</span>
<a href="#l13.727"></a><span id="l13.727" class="difflineminus">-  // the card's GetCardValue direct, rather than our own function which will</span>
<a href="#l13.728"></a><span id="l13.728" class="difflineminus">-  // end up doing the same as then we can save a bit of time.</span>
<a href="#l13.729"></a><span id="l13.729" class="difflineminus">-  rv = abcard-&gt;card-&gt;GetPrimaryEmail(value);</span>
<a href="#l13.730"></a><span id="l13.730" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.731"></a><span id="l13.731" class="difflineminus">-  rv = mCollationKeyGenerator-&gt;AllocateRawSortKey(</span>
<a href="#l13.732"></a><span id="l13.732" class="difflineminus">-      nsICollation::kCollationCaseInSensitive, value,</span>
<a href="#l13.733"></a><span id="l13.733" class="difflineminus">-      abcard-&gt;secondaryCollationKey);</span>
<a href="#l13.734"></a><span id="l13.734" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.735"></a><span id="l13.735" class="difflineminus">-  return rv;</span>
<a href="#l13.736"></a><span id="l13.736" class="difflineminus">-}</span>
<a href="#l13.737"></a><span id="l13.737" class="difflineminus">-</span>
<a href="#l13.738"></a><span id="l13.738" class="difflineminus">-// A helper method currently returns true if the directory is an LDAP.</span>
<a href="#l13.739"></a><span id="l13.739" class="difflineminus">-// We can tweak this to return true for all Remote Address Books where the</span>
<a href="#l13.740"></a><span id="l13.740" class="difflineminus">-// search is asynchronous.</span>
<a href="#l13.741"></a><span id="l13.741" class="difflineminus">-bool isDirectoryRemote(nsCOMPtr&lt;nsIAbDirectory&gt; aDir) {</span>
<a href="#l13.742"></a><span id="l13.742" class="difflineminus">-  nsCString uri;</span>
<a href="#l13.743"></a><span id="l13.743" class="difflineminus">-  aDir-&gt;GetURI(uri);</span>
<a href="#l13.744"></a><span id="l13.744" class="difflineminus">-  return (uri.Find(&quot;moz-abldapdirectory&quot;) != kNotFound);</span>
<a href="#l13.745"></a><span id="l13.745" class="difflineminus">-}</span>
<a href="#l13.746"></a><span id="l13.746" class="difflineminus">-</span>
<a href="#l13.747"></a><span id="l13.747" class="difflineminus">-// A helper method to get the query string for nsIAbDirectory.</span>
<a href="#l13.748"></a><span id="l13.748" class="difflineminus">-nsCString getQuery(nsCOMPtr&lt;nsIAbDirectory&gt; aDir) {</span>
<a href="#l13.749"></a><span id="l13.749" class="difflineminus">-  nsCString uri;</span>
<a href="#l13.750"></a><span id="l13.750" class="difflineminus">-  aDir-&gt;GetURI(uri);</span>
<a href="#l13.751"></a><span id="l13.751" class="difflineminus">-  int32_t searchBegin = uri.FindChar('?');</span>
<a href="#l13.752"></a><span id="l13.752" class="difflineminus">-  if (searchBegin == kNotFound) return EmptyCString();</span>
<a href="#l13.753"></a><span id="l13.753" class="difflineminus">-</span>
<a href="#l13.754"></a><span id="l13.754" class="difflineminus">-  return nsCString(Substring(uri, searchBegin));</span>
<a href="#l13.755"></a><span id="l13.755" class="difflineminus">-}</span>
<a href="#l13.756"></a><span id="l13.756" class="difflineminus">-</span>
<a href="#l13.757"></a><span id="l13.757" class="difflineminus">-NS_IMETHODIMP nsAbView::OnItemAdded(nsISupports *parentDir, nsISupports *item) {</span>
<a href="#l13.758"></a><span id="l13.758" class="difflineminus">-  if (!parentDir) return NS_OK;</span>
<a href="#l13.759"></a><span id="l13.759" class="difflineminus">-  if (!mDirectory)  // No address book selected.</span>
<a href="#l13.760"></a><span id="l13.760" class="difflineminus">-    return NS_OK;</span>
<a href="#l13.761"></a><span id="l13.761" class="difflineminus">-</span>
<a href="#l13.762"></a><span id="l13.762" class="difflineminus">-  nsresult rv;</span>
<a href="#l13.763"></a><span id="l13.763" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectory&gt; directory = do_QueryInterface(parentDir, &amp;rv);</span>
<a href="#l13.764"></a><span id="l13.764" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.765"></a><span id="l13.765" class="difflineminus">-</span>
<a href="#l13.766"></a><span id="l13.766" class="difflineminus">-  bool isRemote = isDirectoryRemote(directory);</span>
<a href="#l13.767"></a><span id="l13.767" class="difflineminus">-  // If the search is performed on All Address books, its possible that the LDAP</span>
<a href="#l13.768"></a><span id="l13.768" class="difflineminus">-  // results start coming when mDirectory has changed (LDAP search works in an</span>
<a href="#l13.769"></a><span id="l13.769" class="difflineminus">-  // asynchronous manner).</span>
<a href="#l13.770"></a><span id="l13.770" class="difflineminus">-  // Since the listeners are being added to all nsAbView instances, we need to</span>
<a href="#l13.771"></a><span id="l13.771" class="difflineminus">-  // make sure that all the views aren't updated by the listeners.</span>
<a href="#l13.772"></a><span id="l13.772" class="difflineminus">-  bool isDirectoryQuery = false;</span>
<a href="#l13.773"></a><span id="l13.773" class="difflineminus">-  bool isMDirectoryQuery = false;</span>
<a href="#l13.774"></a><span id="l13.774" class="difflineminus">-  // See if current parent directory to which the item is added is a query</span>
<a href="#l13.775"></a><span id="l13.775" class="difflineminus">-  // directory.</span>
<a href="#l13.776"></a><span id="l13.776" class="difflineminus">-  directory-&gt;GetIsQuery(&amp;isDirectoryQuery);</span>
<a href="#l13.777"></a><span id="l13.777" class="difflineminus">-  // Get the query string for the directory in Advanced AB Search window.</span>
<a href="#l13.778"></a><span id="l13.778" class="difflineminus">-  nsCString directoryQuery(getQuery(directory));</span>
<a href="#l13.779"></a><span id="l13.779" class="difflineminus">-  // See if the selected directory in Address book main window is a query</span>
<a href="#l13.780"></a><span id="l13.780" class="difflineminus">-  // directory.</span>
<a href="#l13.781"></a><span id="l13.781" class="difflineminus">-  mDirectory-&gt;GetIsQuery(&amp;isMDirectoryQuery);</span>
<a href="#l13.782"></a><span id="l13.782" class="difflineminus">-  // Get the query string for the selected directory in the main AB window.</span>
<a href="#l13.783"></a><span id="l13.783" class="difflineminus">-  nsCString mDirectoryQuery(getQuery(mDirectory));</span>
<a href="#l13.784"></a><span id="l13.784" class="difflineminus">-  if ((mIsAllDirectoryRootView &amp;&amp; isRemote &amp;&amp; isDirectoryQuery &amp;&amp;</span>
<a href="#l13.785"></a><span id="l13.785" class="difflineminus">-       isMDirectoryQuery &amp;&amp; directoryQuery.Equals(mDirectoryQuery)) ||</span>
<a href="#l13.786"></a><span id="l13.786" class="difflineminus">-      directory.get() == mDirectory.get()) {</span>
<a href="#l13.787"></a><span id="l13.787" class="difflineminus">-    nsCOMPtr&lt;nsIAbCard&gt; addedCard = do_QueryInterface(item);</span>
<a href="#l13.788"></a><span id="l13.788" class="difflineminus">-    if (addedCard) {</span>
<a href="#l13.789"></a><span id="l13.789" class="difflineminus">-      AbCard *abcard = new AbCard(addedCard);</span>
<a href="#l13.790"></a><span id="l13.790" class="difflineminus">-      rv = GenerateCollationKeysForCard(mSortColumn, abcard);</span>
<a href="#l13.791"></a><span id="l13.791" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.792"></a><span id="l13.792" class="difflineminus">-</span>
<a href="#l13.793"></a><span id="l13.793" class="difflineminus">-      int32_t index;</span>
<a href="#l13.794"></a><span id="l13.794" class="difflineminus">-      rv = AddCard(abcard, false /* select card */, &amp;index);</span>
<a href="#l13.795"></a><span id="l13.795" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.796"></a><span id="l13.796" class="difflineminus">-    }</span>
<a href="#l13.797"></a><span id="l13.797" class="difflineminus">-  }</span>
<a href="#l13.798"></a><span id="l13.798" class="difflineminus">-  return rv;</span>
<a href="#l13.799"></a><span id="l13.799" class="difflineminus">-}</span>
<a href="#l13.800"></a><span id="l13.800" class="difflineminus">-</span>
<a href="#l13.801"></a><span id="l13.801" class="difflineminus">-NS_IMETHODIMP nsAbView::Observe(nsISupports *aSubject, const char *aTopic,</span>
<a href="#l13.802"></a><span id="l13.802" class="difflineminus">-                                const char16_t *someData) {</span>
<a href="#l13.803"></a><span id="l13.803" class="difflineminus">-  if (!strcmp(aTopic, NS_PREFBRANCH_PREFCHANGE_TOPIC_ID)) {</span>
<a href="#l13.804"></a><span id="l13.804" class="difflineminus">-    if (nsDependentString(someData).EqualsLiteral(</span>
<a href="#l13.805"></a><span id="l13.805" class="difflineminus">-            PREF_MAIL_ADDR_BOOK_LASTNAMEFIRST)) {</span>
<a href="#l13.806"></a><span id="l13.806" class="difflineminus">-      nsresult rv = SetGeneratedNameFormatFromPrefs();</span>
<a href="#l13.807"></a><span id="l13.807" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.808"></a><span id="l13.808" class="difflineminus">-</span>
<a href="#l13.809"></a><span id="l13.809" class="difflineminus">-      rv = RefreshTree();</span>
<a href="#l13.810"></a><span id="l13.810" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.811"></a><span id="l13.811" class="difflineminus">-    }</span>
<a href="#l13.812"></a><span id="l13.812" class="difflineminus">-  }</span>
<a href="#l13.813"></a><span id="l13.813" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.814"></a><span id="l13.814" class="difflineminus">-}</span>
<a href="#l13.815"></a><span id="l13.815" class="difflineminus">-</span>
<a href="#l13.816"></a><span id="l13.816" class="difflineminus">-// Adds a card into our internal mCards array.</span>
<a href="#l13.817"></a><span id="l13.817" class="difflineminus">-// mCards takes ownership of abcard.</span>
<a href="#l13.818"></a><span id="l13.818" class="difflineminus">-nsresult nsAbView::AddCard(AbCard *abcard, bool selectCardAfterAdding,</span>
<a href="#l13.819"></a><span id="l13.819" class="difflineminus">-                           int32_t *index) {</span>
<a href="#l13.820"></a><span id="l13.820" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l13.821"></a><span id="l13.821" class="difflineminus">-  NS_ENSURE_ARG_POINTER(abcard);</span>
<a href="#l13.822"></a><span id="l13.822" class="difflineminus">-</span>
<a href="#l13.823"></a><span id="l13.823" class="difflineminus">-  *index = FindIndexForInsert(abcard);</span>
<a href="#l13.824"></a><span id="l13.824" class="difflineminus">-  mCards.InsertElementAt(*index, abcard);</span>
<a href="#l13.825"></a><span id="l13.825" class="difflineminus">-</span>
<a href="#l13.826"></a><span id="l13.826" class="difflineminus">-  // This needs to happen after we insert the card, as RowCountChanged() will</span>
<a href="#l13.827"></a><span id="l13.827" class="difflineminus">-  // call GetRowCount()</span>
<a href="#l13.828"></a><span id="l13.828" class="difflineminus">-  if (mTree) mTree-&gt;RowCountChanged(*index, 1);</span>
<a href="#l13.829"></a><span id="l13.829" class="difflineminus">-</span>
<a href="#l13.830"></a><span id="l13.830" class="difflineminus">-  // Checking for mTree here works around core bug 399227</span>
<a href="#l13.831"></a><span id="l13.831" class="difflineminus">-  if (selectCardAfterAdding &amp;&amp; mTreeSelection &amp;&amp; mTree) {</span>
<a href="#l13.832"></a><span id="l13.832" class="difflineminus">-    mTreeSelection-&gt;SetCurrentIndex(*index);</span>
<a href="#l13.833"></a><span id="l13.833" class="difflineminus">-    mTreeSelection-&gt;RangedSelect(*index, *index, false /* augment */);</span>
<a href="#l13.834"></a><span id="l13.834" class="difflineminus">-  }</span>
<a href="#l13.835"></a><span id="l13.835" class="difflineminus">-</span>
<a href="#l13.836"></a><span id="l13.836" class="difflineminus">-  if (mAbViewListener &amp;&amp; !mSuppressCountChange) {</span>
<a href="#l13.837"></a><span id="l13.837" class="difflineminus">-    rv = mAbViewListener-&gt;OnCountChanged(mCards.Length());</span>
<a href="#l13.838"></a><span id="l13.838" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.839"></a><span id="l13.839" class="difflineminus">-  }</span>
<a href="#l13.840"></a><span id="l13.840" class="difflineminus">-</span>
<a href="#l13.841"></a><span id="l13.841" class="difflineminus">-  return rv;</span>
<a href="#l13.842"></a><span id="l13.842" class="difflineminus">-}</span>
<a href="#l13.843"></a><span id="l13.843" class="difflineminus">-</span>
<a href="#l13.844"></a><span id="l13.844" class="difflineminus">-int32_t nsAbView::FindIndexForInsert(AbCard *abcard) {</span>
<a href="#l13.845"></a><span id="l13.845" class="difflineminus">-  int32_t count = mCards.Length();</span>
<a href="#l13.846"></a><span id="l13.846" class="difflineminus">-  int32_t i;</span>
<a href="#l13.847"></a><span id="l13.847" class="difflineminus">-</span>
<a href="#l13.848"></a><span id="l13.848" class="difflineminus">-  SortClosure closure;</span>
<a href="#l13.849"></a><span id="l13.849" class="difflineminus">-  SetSortClosure(mSortColumn.get(), mSortDirection.get(), this, &amp;closure);</span>
<a href="#l13.850"></a><span id="l13.850" class="difflineminus">-</span>
<a href="#l13.851"></a><span id="l13.851" class="difflineminus">-  // XXX todo</span>
<a href="#l13.852"></a><span id="l13.852" class="difflineminus">-  // Make this a binary search</span>
<a href="#l13.853"></a><span id="l13.853" class="difflineminus">-  for (i = 0; i &lt; count; i++) {</span>
<a href="#l13.854"></a><span id="l13.854" class="difflineminus">-    int32_t value = inplaceSortCallback(abcard, mCards.ElementAt(i), &amp;closure);</span>
<a href="#l13.855"></a><span id="l13.855" class="difflineminus">-    // XXX Fix me, this is not right for both ascending and descending</span>
<a href="#l13.856"></a><span id="l13.856" class="difflineminus">-    if (value &lt;= 0) break;</span>
<a href="#l13.857"></a><span id="l13.857" class="difflineminus">-  }</span>
<a href="#l13.858"></a><span id="l13.858" class="difflineminus">-  return i;</span>
<a href="#l13.859"></a><span id="l13.859" class="difflineminus">-}</span>
<a href="#l13.860"></a><span id="l13.860" class="difflineminus">-</span>
<a href="#l13.861"></a><span id="l13.861" class="difflineminus">-NS_IMETHODIMP nsAbView::OnItemRemoved(nsISupports *parentDir,</span>
<a href="#l13.862"></a><span id="l13.862" class="difflineminus">-                                      nsISupports *item) {</span>
<a href="#l13.863"></a><span id="l13.863" class="difflineminus">-  if (!parentDir) return NS_OK;</span>
<a href="#l13.864"></a><span id="l13.864" class="difflineminus">-</span>
<a href="#l13.865"></a><span id="l13.865" class="difflineminus">-  nsresult rv;</span>
<a href="#l13.866"></a><span id="l13.866" class="difflineminus">-</span>
<a href="#l13.867"></a><span id="l13.867" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectory&gt; directory = do_QueryInterface(parentDir, &amp;rv);</span>
<a href="#l13.868"></a><span id="l13.868" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.869"></a><span id="l13.869" class="difflineminus">-</span>
<a href="#l13.870"></a><span id="l13.870" class="difflineminus">-  if (directory.get() == mDirectory.get())</span>
<a href="#l13.871"></a><span id="l13.871" class="difflineminus">-    return RemoveCardAndSelectNextCard(item);</span>
<a href="#l13.872"></a><span id="l13.872" class="difflineminus">-</span>
<a href="#l13.873"></a><span id="l13.873" class="difflineminus">-  // The pointers aren't the same, are the URI strings similar? This is most</span>
<a href="#l13.874"></a><span id="l13.874" class="difflineminus">-  // likely the case if the current directory is a search on a directory.</span>
<a href="#l13.875"></a><span id="l13.875" class="difflineminus">-  nsCString currentURI;</span>
<a href="#l13.876"></a><span id="l13.876" class="difflineminus">-  rv = mDirectory-&gt;GetURI(currentURI);</span>
<a href="#l13.877"></a><span id="l13.877" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.878"></a><span id="l13.878" class="difflineminus">-</span>
<a href="#l13.879"></a><span id="l13.879" class="difflineminus">-  // If it is a search, it will have something like ?(or(PrimaryEmail...</span>
<a href="#l13.880"></a><span id="l13.880" class="difflineminus">-  // on the end of the string, so remove that before comparing</span>
<a href="#l13.881"></a><span id="l13.881" class="difflineminus">-  int32_t pos = currentURI.FindChar('?');</span>
<a href="#l13.882"></a><span id="l13.882" class="difflineminus">-  if (pos != -1) currentURI.SetLength(pos);</span>
<a href="#l13.883"></a><span id="l13.883" class="difflineminus">-</span>
<a href="#l13.884"></a><span id="l13.884" class="difflineminus">-  nsCString notifiedURI;</span>
<a href="#l13.885"></a><span id="l13.885" class="difflineminus">-  rv = directory-&gt;GetURI(notifiedURI);</span>
<a href="#l13.886"></a><span id="l13.886" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.887"></a><span id="l13.887" class="difflineminus">-</span>
<a href="#l13.888"></a><span id="l13.888" class="difflineminus">-  if (currentURI.Equals(notifiedURI)) return RemoveCardAndSelectNextCard(item);</span>
<a href="#l13.889"></a><span id="l13.889" class="difflineminus">-</span>
<a href="#l13.890"></a><span id="l13.890" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.891"></a><span id="l13.891" class="difflineminus">-}</span>
<a href="#l13.892"></a><span id="l13.892" class="difflineminus">-</span>
<a href="#l13.893"></a><span id="l13.893" class="difflineminus">-nsresult nsAbView::RemoveCardAndSelectNextCard(nsISupports *item) {</span>
<a href="#l13.894"></a><span id="l13.894" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l13.895"></a><span id="l13.895" class="difflineminus">-  nsCOMPtr&lt;nsIAbCard&gt; card = do_QueryInterface(item);</span>
<a href="#l13.896"></a><span id="l13.896" class="difflineminus">-  if (card) {</span>
<a href="#l13.897"></a><span id="l13.897" class="difflineminus">-    int32_t index = FindIndexForCard(card);</span>
<a href="#l13.898"></a><span id="l13.898" class="difflineminus">-    if (index != CARD_NOT_FOUND) {</span>
<a href="#l13.899"></a><span id="l13.899" class="difflineminus">-      bool selectNextCard = false;</span>
<a href="#l13.900"></a><span id="l13.900" class="difflineminus">-      if (mTreeSelection) {</span>
<a href="#l13.901"></a><span id="l13.901" class="difflineminus">-        int32_t selectedIndex;</span>
<a href="#l13.902"></a><span id="l13.902" class="difflineminus">-        // XXX todo</span>
<a href="#l13.903"></a><span id="l13.903" class="difflineminus">-        // Make sure it works if nothing selected</span>
<a href="#l13.904"></a><span id="l13.904" class="difflineminus">-        mTreeSelection-&gt;GetCurrentIndex(&amp;selectedIndex);</span>
<a href="#l13.905"></a><span id="l13.905" class="difflineminus">-        if (index == selectedIndex) selectNextCard = true;</span>
<a href="#l13.906"></a><span id="l13.906" class="difflineminus">-      }</span>
<a href="#l13.907"></a><span id="l13.907" class="difflineminus">-</span>
<a href="#l13.908"></a><span id="l13.908" class="difflineminus">-      rv = RemoveCardAt(index);</span>
<a href="#l13.909"></a><span id="l13.909" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.910"></a><span id="l13.910" class="difflineminus">-</span>
<a href="#l13.911"></a><span id="l13.911" class="difflineminus">-      if (selectNextCard) {</span>
<a href="#l13.912"></a><span id="l13.912" class="difflineminus">-        int32_t count = mCards.Length();</span>
<a href="#l13.913"></a><span id="l13.913" class="difflineminus">-        if (count &amp;&amp; mTreeSelection) {</span>
<a href="#l13.914"></a><span id="l13.914" class="difflineminus">-          // If we deleted the last card, adjust so we select the new &quot;last&quot;</span>
<a href="#l13.915"></a><span id="l13.915" class="difflineminus">-          // card</span>
<a href="#l13.916"></a><span id="l13.916" class="difflineminus">-          if (index &gt;= (count - 1)) {</span>
<a href="#l13.917"></a><span id="l13.917" class="difflineminus">-            index = count - 1;</span>
<a href="#l13.918"></a><span id="l13.918" class="difflineminus">-          }</span>
<a href="#l13.919"></a><span id="l13.919" class="difflineminus">-          mTreeSelection-&gt;SetCurrentIndex(index);</span>
<a href="#l13.920"></a><span id="l13.920" class="difflineminus">-          mTreeSelection-&gt;RangedSelect(index, index, false /* augment */);</span>
<a href="#l13.921"></a><span id="l13.921" class="difflineminus">-        }</span>
<a href="#l13.922"></a><span id="l13.922" class="difflineminus">-      }</span>
<a href="#l13.923"></a><span id="l13.923" class="difflineminus">-    }</span>
<a href="#l13.924"></a><span id="l13.924" class="difflineminus">-  }</span>
<a href="#l13.925"></a><span id="l13.925" class="difflineminus">-  return rv;</span>
<a href="#l13.926"></a><span id="l13.926" class="difflineminus">-}</span>
<a href="#l13.927"></a><span id="l13.927" class="difflineminus">-</span>
<a href="#l13.928"></a><span id="l13.928" class="difflineminus">-int32_t nsAbView::FindIndexForCard(nsIAbCard *card) {</span>
<a href="#l13.929"></a><span id="l13.929" class="difflineminus">-  int32_t count = mCards.Length();</span>
<a href="#l13.930"></a><span id="l13.930" class="difflineminus">-  int32_t i;</span>
<a href="#l13.931"></a><span id="l13.931" class="difflineminus">-</span>
<a href="#l13.932"></a><span id="l13.932" class="difflineminus">-  // You can't implement the binary search here, as all you have is the</span>
<a href="#l13.933"></a><span id="l13.933" class="difflineminus">-  // nsIAbCard you might be here because one of the card properties has changed,</span>
<a href="#l13.934"></a><span id="l13.934" class="difflineminus">-  // and that property could be the collation key.</span>
<a href="#l13.935"></a><span id="l13.935" class="difflineminus">-  for (i = 0; i &lt; count; i++) {</span>
<a href="#l13.936"></a><span id="l13.936" class="difflineminus">-    AbCard *abcard = mCards.ElementAt(i);</span>
<a href="#l13.937"></a><span id="l13.937" class="difflineminus">-    bool equals;</span>
<a href="#l13.938"></a><span id="l13.938" class="difflineminus">-    nsresult rv = card-&gt;Equals(abcard-&gt;card, &amp;equals);</span>
<a href="#l13.939"></a><span id="l13.939" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; equals) {</span>
<a href="#l13.940"></a><span id="l13.940" class="difflineminus">-      return i;</span>
<a href="#l13.941"></a><span id="l13.941" class="difflineminus">-    }</span>
<a href="#l13.942"></a><span id="l13.942" class="difflineminus">-  }</span>
<a href="#l13.943"></a><span id="l13.943" class="difflineminus">-  return CARD_NOT_FOUND;</span>
<a href="#l13.944"></a><span id="l13.944" class="difflineminus">-}</span>
<a href="#l13.945"></a><span id="l13.945" class="difflineminus">-</span>
<a href="#l13.946"></a><span id="l13.946" class="difflineminus">-NS_IMETHODIMP nsAbView::OnItemPropertyChanged(nsISupports *item,</span>
<a href="#l13.947"></a><span id="l13.947" class="difflineminus">-                                              const char *property,</span>
<a href="#l13.948"></a><span id="l13.948" class="difflineminus">-                                              const nsAString &amp;oldValue,</span>
<a href="#l13.949"></a><span id="l13.949" class="difflineminus">-                                              const nsAString &amp;newValue) {</span>
<a href="#l13.950"></a><span id="l13.950" class="difflineminus">-  nsresult rv;</span>
<a href="#l13.951"></a><span id="l13.951" class="difflineminus">-</span>
<a href="#l13.952"></a><span id="l13.952" class="difflineminus">-  nsCOMPtr&lt;nsIAbCard&gt; card = do_QueryInterface(item);</span>
<a href="#l13.953"></a><span id="l13.953" class="difflineminus">-  if (!card) return NS_OK;</span>
<a href="#l13.954"></a><span id="l13.954" class="difflineminus">-</span>
<a href="#l13.955"></a><span id="l13.955" class="difflineminus">-  int32_t index = FindIndexForCard(card);</span>
<a href="#l13.956"></a><span id="l13.956" class="difflineminus">-  if (index == -1) return NS_OK;</span>
<a href="#l13.957"></a><span id="l13.957" class="difflineminus">-</span>
<a href="#l13.958"></a><span id="l13.958" class="difflineminus">-  AbCard *oldCard = mCards.ElementAt(index);</span>
<a href="#l13.959"></a><span id="l13.959" class="difflineminus">-  AbCard *newCard = new AbCard(card);</span>
<a href="#l13.960"></a><span id="l13.960" class="difflineminus">-</span>
<a href="#l13.961"></a><span id="l13.961" class="difflineminus">-  rv = GenerateCollationKeysForCard(mSortColumn, newCard);</span>
<a href="#l13.962"></a><span id="l13.962" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.963"></a><span id="l13.963" class="difflineminus">-</span>
<a href="#l13.964"></a><span id="l13.964" class="difflineminus">-  bool cardWasSelected = false;</span>
<a href="#l13.965"></a><span id="l13.965" class="difflineminus">-</span>
<a href="#l13.966"></a><span id="l13.966" class="difflineminus">-  if (mTreeSelection) {</span>
<a href="#l13.967"></a><span id="l13.967" class="difflineminus">-    rv = mTreeSelection-&gt;IsSelected(index, &amp;cardWasSelected);</span>
<a href="#l13.968"></a><span id="l13.968" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.969"></a><span id="l13.969" class="difflineminus">-  }</span>
<a href="#l13.970"></a><span id="l13.970" class="difflineminus">-</span>
<a href="#l13.971"></a><span id="l13.971" class="difflineminus">-  if (!CompareCollationKeys(newCard-&gt;primaryCollationKey,</span>
<a href="#l13.972"></a><span id="l13.972" class="difflineminus">-                            oldCard-&gt;primaryCollationKey) &amp;&amp;</span>
<a href="#l13.973"></a><span id="l13.973" class="difflineminus">-      CompareCollationKeys(newCard-&gt;secondaryCollationKey,</span>
<a href="#l13.974"></a><span id="l13.974" class="difflineminus">-                           oldCard-&gt;secondaryCollationKey)) {</span>
<a href="#l13.975"></a><span id="l13.975" class="difflineminus">-    // No need to remove and add, since the collation keys haven't changed.</span>
<a href="#l13.976"></a><span id="l13.976" class="difflineminus">-    // Since they haven't changed, the card will sort to the same place.</span>
<a href="#l13.977"></a><span id="l13.977" class="difflineminus">-    // We just need to clean up what we allocated.</span>
<a href="#l13.978"></a><span id="l13.978" class="difflineminus">-    delete newCard;</span>
<a href="#l13.979"></a><span id="l13.979" class="difflineminus">-</span>
<a href="#l13.980"></a><span id="l13.980" class="difflineminus">-    // Still need to invalidate, as the other columns may have changed.</span>
<a href="#l13.981"></a><span id="l13.981" class="difflineminus">-    rv = InvalidateTree(index);</span>
<a href="#l13.982"></a><span id="l13.982" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.983"></a><span id="l13.983" class="difflineminus">-  } else {</span>
<a href="#l13.984"></a><span id="l13.984" class="difflineminus">-    mSuppressSelectionChange = true;</span>
<a href="#l13.985"></a><span id="l13.985" class="difflineminus">-    mSuppressCountChange = true;</span>
<a href="#l13.986"></a><span id="l13.986" class="difflineminus">-</span>
<a href="#l13.987"></a><span id="l13.987" class="difflineminus">-    // Remove the old card.</span>
<a href="#l13.988"></a><span id="l13.988" class="difflineminus">-    rv = RemoveCardAt(index);</span>
<a href="#l13.989"></a><span id="l13.989" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;remove card failed&quot;);</span>
<a href="#l13.990"></a><span id="l13.990" class="difflineminus">-</span>
<a href="#l13.991"></a><span id="l13.991" class="difflineminus">-    // Add the card we created, and select it (to restore selection) if it was</span>
<a href="#l13.992"></a><span id="l13.992" class="difflineminus">-    // selected.</span>
<a href="#l13.993"></a><span id="l13.993" class="difflineminus">-    rv = AddCard(newCard, cardWasSelected /* select card */, &amp;index);</span>
<a href="#l13.994"></a><span id="l13.994" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;add card failed&quot;);</span>
<a href="#l13.995"></a><span id="l13.995" class="difflineminus">-</span>
<a href="#l13.996"></a><span id="l13.996" class="difflineminus">-    mSuppressSelectionChange = false;</span>
<a href="#l13.997"></a><span id="l13.997" class="difflineminus">-    mSuppressCountChange = false;</span>
<a href="#l13.998"></a><span id="l13.998" class="difflineminus">-</span>
<a href="#l13.999"></a><span id="l13.999" class="difflineminus">-    // Ensure restored selection is visible</span>
<a href="#l13.1000"></a><span id="l13.1000" class="difflineminus">-    if (cardWasSelected &amp;&amp; mTree) mTree-&gt;EnsureRowIsVisible(index);</span>
<a href="#l13.1001"></a><span id="l13.1001" class="difflineminus">-  }</span>
<a href="#l13.1002"></a><span id="l13.1002" class="difflineminus">-</span>
<a href="#l13.1003"></a><span id="l13.1003" class="difflineminus">-  // Although the selection hasn't changed, the card that is selected may need</span>
<a href="#l13.1004"></a><span id="l13.1004" class="difflineminus">-  // to be displayed differently, therefore pretend that the selection has</span>
<a href="#l13.1005"></a><span id="l13.1005" class="difflineminus">-  // changed to force that update.</span>
<a href="#l13.1006"></a><span id="l13.1006" class="difflineminus">-  if (cardWasSelected) SelectionChangedXPCOM();</span>
<a href="#l13.1007"></a><span id="l13.1007" class="difflineminus">-</span>
<a href="#l13.1008"></a><span id="l13.1008" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.1009"></a><span id="l13.1009" class="difflineminus">-}</span>
<a href="#l13.1010"></a><span id="l13.1010" class="difflineminus">-</span>
<a href="#l13.1011"></a><span id="l13.1011" class="difflineminus">-NS_IMETHODIMP nsAbView::SelectAll() {</span>
<a href="#l13.1012"></a><span id="l13.1012" class="difflineminus">-  if (mTreeSelection &amp;&amp; mTree) {</span>
<a href="#l13.1013"></a><span id="l13.1013" class="difflineminus">-    mTreeSelection-&gt;SelectAll();</span>
<a href="#l13.1014"></a><span id="l13.1014" class="difflineminus">-    mTree-&gt;Invalidate();</span>
<a href="#l13.1015"></a><span id="l13.1015" class="difflineminus">-  }</span>
<a href="#l13.1016"></a><span id="l13.1016" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.1017"></a><span id="l13.1017" class="difflineminus">-}</span>
<a href="#l13.1018"></a><span id="l13.1018" class="difflineminus">-</span>
<a href="#l13.1019"></a><span id="l13.1019" class="difflineminus">-NS_IMETHODIMP nsAbView::GetSortDirection(nsAString &amp;aDirection) {</span>
<a href="#l13.1020"></a><span id="l13.1020" class="difflineminus">-  aDirection = mSortDirection;</span>
<a href="#l13.1021"></a><span id="l13.1021" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.1022"></a><span id="l13.1022" class="difflineminus">-}</span>
<a href="#l13.1023"></a><span id="l13.1023" class="difflineminus">-</span>
<a href="#l13.1024"></a><span id="l13.1024" class="difflineminus">-NS_IMETHODIMP nsAbView::GetSortColumn(nsAString &amp;aColumn) {</span>
<a href="#l13.1025"></a><span id="l13.1025" class="difflineminus">-  aColumn = mSortColumn;</span>
<a href="#l13.1026"></a><span id="l13.1026" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.1027"></a><span id="l13.1027" class="difflineminus">-}</span>
<a href="#l13.1028"></a><span id="l13.1028" class="difflineminus">-</span>
<a href="#l13.1029"></a><span id="l13.1029" class="difflineminus">-nsresult nsAbView::ReselectCards(nsIArray *aCards, nsIAbCard *aIndexCard) {</span>
<a href="#l13.1030"></a><span id="l13.1030" class="difflineminus">-  uint32_t count;</span>
<a href="#l13.1031"></a><span id="l13.1031" class="difflineminus">-  uint32_t i;</span>
<a href="#l13.1032"></a><span id="l13.1032" class="difflineminus">-</span>
<a href="#l13.1033"></a><span id="l13.1033" class="difflineminus">-  if (!mTreeSelection || !aCards) return NS_OK;</span>
<a href="#l13.1034"></a><span id="l13.1034" class="difflineminus">-</span>
<a href="#l13.1035"></a><span id="l13.1035" class="difflineminus">-  nsresult rv = mTreeSelection-&gt;ClearSelection();</span>
<a href="#l13.1036"></a><span id="l13.1036" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.1037"></a><span id="l13.1037" class="difflineminus">-</span>
<a href="#l13.1038"></a><span id="l13.1038" class="difflineminus">-  rv = aCards-&gt;GetLength(&amp;count);</span>
<a href="#l13.1039"></a><span id="l13.1039" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.1040"></a><span id="l13.1040" class="difflineminus">-</span>
<a href="#l13.1041"></a><span id="l13.1041" class="difflineminus">-  // If we don't have any cards selected, nothing else to do.</span>
<a href="#l13.1042"></a><span id="l13.1042" class="difflineminus">-  if (!count) return NS_OK;</span>
<a href="#l13.1043"></a><span id="l13.1043" class="difflineminus">-</span>
<a href="#l13.1044"></a><span id="l13.1044" class="difflineminus">-  for (i = 0; i &lt; count; i++) {</span>
<a href="#l13.1045"></a><span id="l13.1045" class="difflineminus">-    nsCOMPtr&lt;nsIAbCard&gt; card = do_QueryElementAt(aCards, i);</span>
<a href="#l13.1046"></a><span id="l13.1046" class="difflineminus">-    if (card) {</span>
<a href="#l13.1047"></a><span id="l13.1047" class="difflineminus">-      int32_t index = FindIndexForCard(card);</span>
<a href="#l13.1048"></a><span id="l13.1048" class="difflineminus">-      if (index != CARD_NOT_FOUND) {</span>
<a href="#l13.1049"></a><span id="l13.1049" class="difflineminus">-        mTreeSelection-&gt;RangedSelect(index, index, true /* augment */);</span>
<a href="#l13.1050"></a><span id="l13.1050" class="difflineminus">-      }</span>
<a href="#l13.1051"></a><span id="l13.1051" class="difflineminus">-    }</span>
<a href="#l13.1052"></a><span id="l13.1052" class="difflineminus">-  }</span>
<a href="#l13.1053"></a><span id="l13.1053" class="difflineminus">-</span>
<a href="#l13.1054"></a><span id="l13.1054" class="difflineminus">-  // Reset the index card, and ensure it is visible.</span>
<a href="#l13.1055"></a><span id="l13.1055" class="difflineminus">-  if (aIndexCard) {</span>
<a href="#l13.1056"></a><span id="l13.1056" class="difflineminus">-    int32_t currentIndex = FindIndexForCard(aIndexCard);</span>
<a href="#l13.1057"></a><span id="l13.1057" class="difflineminus">-    rv = mTreeSelection-&gt;SetCurrentIndex(currentIndex);</span>
<a href="#l13.1058"></a><span id="l13.1058" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.1059"></a><span id="l13.1059" class="difflineminus">-</span>
<a href="#l13.1060"></a><span id="l13.1060" class="difflineminus">-    if (mTree) {</span>
<a href="#l13.1061"></a><span id="l13.1061" class="difflineminus">-      mTree-&gt;EnsureRowIsVisible(currentIndex);</span>
<a href="#l13.1062"></a><span id="l13.1062" class="difflineminus">-    }</span>
<a href="#l13.1063"></a><span id="l13.1063" class="difflineminus">-  }</span>
<a href="#l13.1064"></a><span id="l13.1064" class="difflineminus">-</span>
<a href="#l13.1065"></a><span id="l13.1065" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.1066"></a><span id="l13.1066" class="difflineminus">-}</span>
<a href="#l13.1067"></a><span id="l13.1067" class="difflineminus">-</span>
<a href="#l13.1068"></a><span id="l13.1068" class="difflineminus">-NS_IMETHODIMP nsAbView::DeleteSelectedCards() {</span>
<a href="#l13.1069"></a><span id="l13.1069" class="difflineminus">-  nsresult rv;</span>
<a href="#l13.1070"></a><span id="l13.1070" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; cardsToDelete =</span>
<a href="#l13.1071"></a><span id="l13.1071" class="difflineminus">-      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l13.1072"></a><span id="l13.1072" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.1073"></a><span id="l13.1073" class="difflineminus">-</span>
<a href="#l13.1074"></a><span id="l13.1074" class="difflineminus">-  rv = GetSelectedCards(cardsToDelete);</span>
<a href="#l13.1075"></a><span id="l13.1075" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.1076"></a><span id="l13.1076" class="difflineminus">-</span>
<a href="#l13.1077"></a><span id="l13.1077" class="difflineminus">-  // mDirectory should not be null</span>
<a href="#l13.1078"></a><span id="l13.1078" class="difflineminus">-  // Bullet proof (and assert) to help figure out bug #127748</span>
<a href="#l13.1079"></a><span id="l13.1079" class="difflineminus">-  NS_ENSURE_TRUE(mDirectory, NS_ERROR_UNEXPECTED);</span>
<a href="#l13.1080"></a><span id="l13.1080" class="difflineminus">-</span>
<a href="#l13.1081"></a><span id="l13.1081" class="difflineminus">-  rv = mDirectory-&gt;DeleteCards(cardsToDelete);</span>
<a href="#l13.1082"></a><span id="l13.1082" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.1083"></a><span id="l13.1083" class="difflineminus">-  return rv;</span>
<a href="#l13.1084"></a><span id="l13.1084" class="difflineminus">-}</span>
<a href="#l13.1085"></a><span id="l13.1085" class="difflineminus">-</span>
<a href="#l13.1086"></a><span id="l13.1086" class="difflineminus">-nsresult nsAbView::GetSelectedCards(nsCOMPtr&lt;nsIMutableArray&gt; &amp;aSelectedCards) {</span>
<a href="#l13.1087"></a><span id="l13.1087" class="difflineminus">-  if (!mTreeSelection) return NS_OK;</span>
<a href="#l13.1088"></a><span id="l13.1088" class="difflineminus">-</span>
<a href="#l13.1089"></a><span id="l13.1089" class="difflineminus">-  int32_t selectionCount;</span>
<a href="#l13.1090"></a><span id="l13.1090" class="difflineminus">-  nsresult rv = mTreeSelection-&gt;GetRangeCount(&amp;selectionCount);</span>
<a href="#l13.1091"></a><span id="l13.1091" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.1092"></a><span id="l13.1092" class="difflineminus">-</span>
<a href="#l13.1093"></a><span id="l13.1093" class="difflineminus">-  if (!selectionCount) return NS_OK;</span>
<a href="#l13.1094"></a><span id="l13.1094" class="difflineminus">-</span>
<a href="#l13.1095"></a><span id="l13.1095" class="difflineminus">-  for (int32_t i = 0; i &lt; selectionCount; i++) {</span>
<a href="#l13.1096"></a><span id="l13.1096" class="difflineminus">-    int32_t startRange;</span>
<a href="#l13.1097"></a><span id="l13.1097" class="difflineminus">-    int32_t endRange;</span>
<a href="#l13.1098"></a><span id="l13.1098" class="difflineminus">-    rv = mTreeSelection-&gt;GetRangeAt(i, &amp;startRange, &amp;endRange);</span>
<a href="#l13.1099"></a><span id="l13.1099" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, NS_OK);</span>
<a href="#l13.1100"></a><span id="l13.1100" class="difflineminus">-    int32_t totalCards = mCards.Length();</span>
<a href="#l13.1101"></a><span id="l13.1101" class="difflineminus">-    if (startRange &gt;= 0 &amp;&amp; startRange &lt; totalCards) {</span>
<a href="#l13.1102"></a><span id="l13.1102" class="difflineminus">-      for (int32_t rangeIndex = startRange;</span>
<a href="#l13.1103"></a><span id="l13.1103" class="difflineminus">-           rangeIndex &lt;= endRange &amp;&amp; rangeIndex &lt; totalCards; rangeIndex++) {</span>
<a href="#l13.1104"></a><span id="l13.1104" class="difflineminus">-        nsCOMPtr&lt;nsIAbCard&gt; abCard;</span>
<a href="#l13.1105"></a><span id="l13.1105" class="difflineminus">-        rv = GetCardFromRow(rangeIndex, getter_AddRefs(abCard));</span>
<a href="#l13.1106"></a><span id="l13.1106" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.1107"></a><span id="l13.1107" class="difflineminus">-</span>
<a href="#l13.1108"></a><span id="l13.1108" class="difflineminus">-        rv = aSelectedCards-&gt;AppendElement(abCard);</span>
<a href="#l13.1109"></a><span id="l13.1109" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.1110"></a><span id="l13.1110" class="difflineminus">-      }</span>
<a href="#l13.1111"></a><span id="l13.1111" class="difflineminus">-    }</span>
<a href="#l13.1112"></a><span id="l13.1112" class="difflineminus">-  }</span>
<a href="#l13.1113"></a><span id="l13.1113" class="difflineminus">-</span>
<a href="#l13.1114"></a><span id="l13.1114" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.1115"></a><span id="l13.1115" class="difflineminus">-}</span>
<a href="#l13.1116"></a><span id="l13.1116" class="difflineminus">-</span>
<a href="#l13.1117"></a><span id="l13.1117" class="difflineminus">-NS_IMETHODIMP nsAbView::SwapFirstNameLastName() {</span>
<a href="#l13.1118"></a><span id="l13.1118" class="difflineminus">-  if (!mTreeSelection) return NS_OK;</span>
<a href="#l13.1119"></a><span id="l13.1119" class="difflineminus">-</span>
<a href="#l13.1120"></a><span id="l13.1120" class="difflineminus">-  int32_t selectionCount;</span>
<a href="#l13.1121"></a><span id="l13.1121" class="difflineminus">-  nsresult rv = mTreeSelection-&gt;GetRangeCount(&amp;selectionCount);</span>
<a href="#l13.1122"></a><span id="l13.1122" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.1123"></a><span id="l13.1123" class="difflineminus">-</span>
<a href="#l13.1124"></a><span id="l13.1124" class="difflineminus">-  if (!selectionCount) return NS_OK;</span>
<a href="#l13.1125"></a><span id="l13.1125" class="difflineminus">-</span>
<a href="#l13.1126"></a><span id="l13.1126" class="difflineminus">-  // Prepare for displayname generation</span>
<a href="#l13.1127"></a><span id="l13.1127" class="difflineminus">-  // No cache for pref and bundle since the swap operation is not executed</span>
<a href="#l13.1128"></a><span id="l13.1128" class="difflineminus">-  // frequently</span>
<a href="#l13.1129"></a><span id="l13.1129" class="difflineminus">-  bool displayNameAutoGeneration;</span>
<a href="#l13.1130"></a><span id="l13.1130" class="difflineminus">-  bool displayNameLastnamefirst = false;</span>
<a href="#l13.1131"></a><span id="l13.1131" class="difflineminus">-</span>
<a href="#l13.1132"></a><span id="l13.1132" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranchInt(</span>
<a href="#l13.1133"></a><span id="l13.1133" class="difflineminus">-      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l13.1134"></a><span id="l13.1134" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.1135"></a><span id="l13.1135" class="difflineminus">-</span>
<a href="#l13.1136"></a><span id="l13.1136" class="difflineminus">-  rv = pPrefBranchInt-&gt;GetBoolPref(</span>
<a href="#l13.1137"></a><span id="l13.1137" class="difflineminus">-      PREF_MAIL_ADDR_BOOK_DISPLAYNAME_AUTOGENERATION,</span>
<a href="#l13.1138"></a><span id="l13.1138" class="difflineminus">-      &amp;displayNameAutoGeneration);</span>
<a href="#l13.1139"></a><span id="l13.1139" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.1140"></a><span id="l13.1140" class="difflineminus">-</span>
<a href="#l13.1141"></a><span id="l13.1141" class="difflineminus">-  nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l13.1142"></a><span id="l13.1142" class="difflineminus">-  if (displayNameAutoGeneration) {</span>
<a href="#l13.1143"></a><span id="l13.1143" class="difflineminus">-    nsCOMPtr&lt;nsIPrefLocalizedString&gt; pls;</span>
<a href="#l13.1144"></a><span id="l13.1144" class="difflineminus">-    rv = pPrefBranchInt-&gt;GetComplexValue(</span>
<a href="#l13.1145"></a><span id="l13.1145" class="difflineminus">-        PREF_MAIL_ADDR_BOOK_DISPLAYNAME_LASTNAMEFIRST,</span>
<a href="#l13.1146"></a><span id="l13.1146" class="difflineminus">-        NS_GET_IID(nsIPrefLocalizedString), getter_AddRefs(pls));</span>
<a href="#l13.1147"></a><span id="l13.1147" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.1148"></a><span id="l13.1148" class="difflineminus">-</span>
<a href="#l13.1149"></a><span id="l13.1149" class="difflineminus">-    nsString str;</span>
<a href="#l13.1150"></a><span id="l13.1150" class="difflineminus">-    pls-&gt;ToString(getter_Copies(str));</span>
<a href="#l13.1151"></a><span id="l13.1151" class="difflineminus">-    displayNameLastnamefirst = str.EqualsLiteral(&quot;true&quot;);</span>
<a href="#l13.1152"></a><span id="l13.1152" class="difflineminus">-    nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l13.1153"></a><span id="l13.1153" class="difflineminus">-        mozilla::services::GetStringBundleService();</span>
<a href="#l13.1154"></a><span id="l13.1154" class="difflineminus">-    NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l13.1155"></a><span id="l13.1155" class="difflineminus">-</span>
<a href="#l13.1156"></a><span id="l13.1156" class="difflineminus">-    rv = bundleService-&gt;CreateBundle(</span>
<a href="#l13.1157"></a><span id="l13.1157" class="difflineminus">-        &quot;chrome://messenger/locale/addressbook/addressBook.properties&quot;,</span>
<a href="#l13.1158"></a><span id="l13.1158" class="difflineminus">-        getter_AddRefs(bundle));</span>
<a href="#l13.1159"></a><span id="l13.1159" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.1160"></a><span id="l13.1160" class="difflineminus">-  }</span>
<a href="#l13.1161"></a><span id="l13.1161" class="difflineminus">-</span>
<a href="#l13.1162"></a><span id="l13.1162" class="difflineminus">-  for (int32_t i = 0; i &lt; selectionCount; i++) {</span>
<a href="#l13.1163"></a><span id="l13.1163" class="difflineminus">-    int32_t startRange;</span>
<a href="#l13.1164"></a><span id="l13.1164" class="difflineminus">-    int32_t endRange;</span>
<a href="#l13.1165"></a><span id="l13.1165" class="difflineminus">-    rv = mTreeSelection-&gt;GetRangeAt(i, &amp;startRange, &amp;endRange);</span>
<a href="#l13.1166"></a><span id="l13.1166" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, NS_OK);</span>
<a href="#l13.1167"></a><span id="l13.1167" class="difflineminus">-    int32_t totalCards = mCards.Length();</span>
<a href="#l13.1168"></a><span id="l13.1168" class="difflineminus">-    if (startRange &gt;= 0 &amp;&amp; startRange &lt; totalCards) {</span>
<a href="#l13.1169"></a><span id="l13.1169" class="difflineminus">-      for (int32_t rangeIndex = startRange;</span>
<a href="#l13.1170"></a><span id="l13.1170" class="difflineminus">-           rangeIndex &lt;= endRange &amp;&amp; rangeIndex &lt; totalCards; rangeIndex++) {</span>
<a href="#l13.1171"></a><span id="l13.1171" class="difflineminus">-        nsCOMPtr&lt;nsIAbCard&gt; abCard;</span>
<a href="#l13.1172"></a><span id="l13.1172" class="difflineminus">-        rv = GetCardFromRow(rangeIndex, getter_AddRefs(abCard));</span>
<a href="#l13.1173"></a><span id="l13.1173" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.1174"></a><span id="l13.1174" class="difflineminus">-</span>
<a href="#l13.1175"></a><span id="l13.1175" class="difflineminus">-        // Swap FN/LN</span>
<a href="#l13.1176"></a><span id="l13.1176" class="difflineminus">-        nsAutoString fn, ln;</span>
<a href="#l13.1177"></a><span id="l13.1177" class="difflineminus">-        abCard-&gt;GetFirstName(fn);</span>
<a href="#l13.1178"></a><span id="l13.1178" class="difflineminus">-        abCard-&gt;GetLastName(ln);</span>
<a href="#l13.1179"></a><span id="l13.1179" class="difflineminus">-        if (!fn.IsEmpty() || !ln.IsEmpty()) {</span>
<a href="#l13.1180"></a><span id="l13.1180" class="difflineminus">-          abCard-&gt;SetFirstName(ln);</span>
<a href="#l13.1181"></a><span id="l13.1181" class="difflineminus">-          abCard-&gt;SetLastName(fn);</span>
<a href="#l13.1182"></a><span id="l13.1182" class="difflineminus">-</span>
<a href="#l13.1183"></a><span id="l13.1183" class="difflineminus">-          // Generate display name using the new order</span>
<a href="#l13.1184"></a><span id="l13.1184" class="difflineminus">-          if (displayNameAutoGeneration &amp;&amp; !fn.IsEmpty() &amp;&amp; !ln.IsEmpty()) {</span>
<a href="#l13.1185"></a><span id="l13.1185" class="difflineminus">-            nsString dnLnFn;</span>
<a href="#l13.1186"></a><span id="l13.1186" class="difflineminus">-            nsString dnFnLn;</span>
<a href="#l13.1187"></a><span id="l13.1187" class="difflineminus">-            AutoTArray&lt;nsString, 2&gt; nameString;</span>
<a href="#l13.1188"></a><span id="l13.1188" class="difflineminus">-            const char *formatString;</span>
<a href="#l13.1189"></a><span id="l13.1189" class="difflineminus">-</span>
<a href="#l13.1190"></a><span id="l13.1190" class="difflineminus">-            // The format should stays the same before/after we swap the names</span>
<a href="#l13.1191"></a><span id="l13.1191" class="difflineminus">-            formatString = displayNameLastnamefirst ? &quot;lastFirstFormat&quot;</span>
<a href="#l13.1192"></a><span id="l13.1192" class="difflineminus">-                                                    : &quot;firstLastFormat&quot;;</span>
<a href="#l13.1193"></a><span id="l13.1193" class="difflineminus">-</span>
<a href="#l13.1194"></a><span id="l13.1194" class="difflineminus">-            // Generate both ln/fn and fn/ln combination since we need both</span>
<a href="#l13.1195"></a><span id="l13.1195" class="difflineminus">-            // later to check to see if the current display name was edited note</span>
<a href="#l13.1196"></a><span id="l13.1196" class="difflineminus">-            // that fn/ln still hold the values before the swap</span>
<a href="#l13.1197"></a><span id="l13.1197" class="difflineminus">-            nameString.AppendElement(ln);</span>
<a href="#l13.1198"></a><span id="l13.1198" class="difflineminus">-            nameString.AppendElement(fn);</span>
<a href="#l13.1199"></a><span id="l13.1199" class="difflineminus">-            rv = bundle-&gt;FormatStringFromName(formatString, nameString, dnLnFn);</span>
<a href="#l13.1200"></a><span id="l13.1200" class="difflineminus">-            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.1201"></a><span id="l13.1201" class="difflineminus">-            nameString[0] = fn;</span>
<a href="#l13.1202"></a><span id="l13.1202" class="difflineminus">-            nameString[1] = ln;</span>
<a href="#l13.1203"></a><span id="l13.1203" class="difflineminus">-            rv = bundle-&gt;FormatStringFromName(formatString, nameString, dnFnLn);</span>
<a href="#l13.1204"></a><span id="l13.1204" class="difflineminus">-            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.1205"></a><span id="l13.1205" class="difflineminus">-</span>
<a href="#l13.1206"></a><span id="l13.1206" class="difflineminus">-            // Get the current display name</span>
<a href="#l13.1207"></a><span id="l13.1207" class="difflineminus">-            nsAutoString dn;</span>
<a href="#l13.1208"></a><span id="l13.1208" class="difflineminus">-            rv = abCard-&gt;GetDisplayName(dn);</span>
<a href="#l13.1209"></a><span id="l13.1209" class="difflineminus">-            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.1210"></a><span id="l13.1210" class="difflineminus">-</span>
<a href="#l13.1211"></a><span id="l13.1211" class="difflineminus">-            // Swap the display name if not edited</span>
<a href="#l13.1212"></a><span id="l13.1212" class="difflineminus">-            if (displayNameLastnamefirst) {</span>
<a href="#l13.1213"></a><span id="l13.1213" class="difflineminus">-              if (dn.Equals(dnLnFn)) abCard-&gt;SetDisplayName(dnFnLn);</span>
<a href="#l13.1214"></a><span id="l13.1214" class="difflineminus">-            } else {</span>
<a href="#l13.1215"></a><span id="l13.1215" class="difflineminus">-              if (dn.Equals(dnFnLn)) abCard-&gt;SetDisplayName(dnLnFn);</span>
<a href="#l13.1216"></a><span id="l13.1216" class="difflineminus">-            }</span>
<a href="#l13.1217"></a><span id="l13.1217" class="difflineminus">-          }</span>
<a href="#l13.1218"></a><span id="l13.1218" class="difflineminus">-</span>
<a href="#l13.1219"></a><span id="l13.1219" class="difflineminus">-          // Swap phonetic names</span>
<a href="#l13.1220"></a><span id="l13.1220" class="difflineminus">-          rv = abCard-&gt;GetPropertyAsAString(kPhoneticFirstNameProperty, fn);</span>
<a href="#l13.1221"></a><span id="l13.1221" class="difflineminus">-          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.1222"></a><span id="l13.1222" class="difflineminus">-          rv = abCard-&gt;GetPropertyAsAString(kPhoneticLastNameProperty, ln);</span>
<a href="#l13.1223"></a><span id="l13.1223" class="difflineminus">-          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.1224"></a><span id="l13.1224" class="difflineminus">-          if (!fn.IsEmpty() || !ln.IsEmpty()) {</span>
<a href="#l13.1225"></a><span id="l13.1225" class="difflineminus">-            abCard-&gt;SetPropertyAsAString(kPhoneticFirstNameProperty, ln);</span>
<a href="#l13.1226"></a><span id="l13.1226" class="difflineminus">-            abCard-&gt;SetPropertyAsAString(kPhoneticLastNameProperty, fn);</span>
<a href="#l13.1227"></a><span id="l13.1227" class="difflineminus">-          }</span>
<a href="#l13.1228"></a><span id="l13.1228" class="difflineminus">-        }</span>
<a href="#l13.1229"></a><span id="l13.1229" class="difflineminus">-      }</span>
<a href="#l13.1230"></a><span id="l13.1230" class="difflineminus">-    }</span>
<a href="#l13.1231"></a><span id="l13.1231" class="difflineminus">-  }</span>
<a href="#l13.1232"></a><span id="l13.1232" class="difflineminus">-  // Update the tree</span>
<a href="#l13.1233"></a><span id="l13.1233" class="difflineminus">-  // Re-sort if either generated or phonetic name is primary or secondary sort,</span>
<a href="#l13.1234"></a><span id="l13.1234" class="difflineminus">-  // otherwise invalidate to reflect the change</span>
<a href="#l13.1235"></a><span id="l13.1235" class="difflineminus">-  rv = RefreshTree();</span>
<a href="#l13.1236"></a><span id="l13.1236" class="difflineminus">-</span>
<a href="#l13.1237"></a><span id="l13.1237" class="difflineminus">-  return rv;</span>
<a href="#l13.1238"></a><span id="l13.1238" class="difflineminus">-}</span>
<a href="#l13.1239"></a><span id="l13.1239" class="difflineminus">-</span>
<a href="#l13.1240"></a><span id="l13.1240" class="difflineminus">-NS_IMETHODIMP nsAbView::GetSelectedAddresses(nsIArray **_retval) {</span>
<a href="#l13.1241"></a><span id="l13.1241" class="difflineminus">-  NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l13.1242"></a><span id="l13.1242" class="difflineminus">-</span>
<a href="#l13.1243"></a><span id="l13.1243" class="difflineminus">-  nsresult rv;</span>
<a href="#l13.1244"></a><span id="l13.1244" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; selectedCards =</span>
<a href="#l13.1245"></a><span id="l13.1245" class="difflineminus">-      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l13.1246"></a><span id="l13.1246" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.1247"></a><span id="l13.1247" class="difflineminus">-</span>
<a href="#l13.1248"></a><span id="l13.1248" class="difflineminus">-  rv = GetSelectedCards(selectedCards);</span>
<a href="#l13.1249"></a><span id="l13.1249" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.1250"></a><span id="l13.1250" class="difflineminus">-</span>
<a href="#l13.1251"></a><span id="l13.1251" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; addresses =</span>
<a href="#l13.1252"></a><span id="l13.1252" class="difflineminus">-      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l13.1253"></a><span id="l13.1253" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.1254"></a><span id="l13.1254" class="difflineminus">-  uint32_t count;</span>
<a href="#l13.1255"></a><span id="l13.1255" class="difflineminus">-  selectedCards-&gt;GetLength(&amp;count);</span>
<a href="#l13.1256"></a><span id="l13.1256" class="difflineminus">-</span>
<a href="#l13.1257"></a><span id="l13.1257" class="difflineminus">-  for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l13.1258"></a><span id="l13.1258" class="difflineminus">-    nsCOMPtr&lt;nsIAbCard&gt; card(do_QueryElementAt(selectedCards, i, &amp;rv));</span>
<a href="#l13.1259"></a><span id="l13.1259" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.1260"></a><span id="l13.1260" class="difflineminus">-</span>
<a href="#l13.1261"></a><span id="l13.1261" class="difflineminus">-    bool isMailList;</span>
<a href="#l13.1262"></a><span id="l13.1262" class="difflineminus">-    card-&gt;GetIsMailList(&amp;isMailList);</span>
<a href="#l13.1263"></a><span id="l13.1263" class="difflineminus">-    nsAutoString primaryEmail;</span>
<a href="#l13.1264"></a><span id="l13.1264" class="difflineminus">-    if (isMailList) {</span>
<a href="#l13.1265"></a><span id="l13.1265" class="difflineminus">-      nsCOMPtr&lt;nsIAbManager&gt; abManager(</span>
<a href="#l13.1266"></a><span id="l13.1266" class="difflineminus">-          do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l13.1267"></a><span id="l13.1267" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.1268"></a><span id="l13.1268" class="difflineminus">-</span>
<a href="#l13.1269"></a><span id="l13.1269" class="difflineminus">-      nsCString mailListURI;</span>
<a href="#l13.1270"></a><span id="l13.1270" class="difflineminus">-      rv = card-&gt;GetMailListURI(getter_Copies(mailListURI));</span>
<a href="#l13.1271"></a><span id="l13.1271" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.1272"></a><span id="l13.1272" class="difflineminus">-</span>
<a href="#l13.1273"></a><span id="l13.1273" class="difflineminus">-      nsCOMPtr&lt;nsIAbDirectory&gt; mailList;</span>
<a href="#l13.1274"></a><span id="l13.1274" class="difflineminus">-      rv = abManager-&gt;GetDirectory(mailListURI, getter_AddRefs(mailList));</span>
<a href="#l13.1275"></a><span id="l13.1275" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.1276"></a><span id="l13.1276" class="difflineminus">-</span>
<a href="#l13.1277"></a><span id="l13.1277" class="difflineminus">-      nsCOMPtr&lt;nsISimpleEnumerator&gt; mailListAddresses;</span>
<a href="#l13.1278"></a><span id="l13.1278" class="difflineminus">-      rv = mailList-&gt;GetChildCards(getter_AddRefs(mailListAddresses));</span>
<a href="#l13.1279"></a><span id="l13.1279" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.1280"></a><span id="l13.1280" class="difflineminus">-</span>
<a href="#l13.1281"></a><span id="l13.1281" class="difflineminus">-      bool hasMore = false;</span>
<a href="#l13.1282"></a><span id="l13.1282" class="difflineminus">-      nsCOMPtr&lt;nsISupports&gt; support;</span>
<a href="#l13.1283"></a><span id="l13.1283" class="difflineminus">-      nsCOMPtr&lt;nsIAbCard&gt; mailListCard;</span>
<a href="#l13.1284"></a><span id="l13.1284" class="difflineminus">-      while (NS_SUCCEEDED(mailListAddresses-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp;</span>
<a href="#l13.1285"></a><span id="l13.1285" class="difflineminus">-             hasMore) {</span>
<a href="#l13.1286"></a><span id="l13.1286" class="difflineminus">-        rv = mailListAddresses-&gt;GetNext(getter_AddRefs(support));</span>
<a href="#l13.1287"></a><span id="l13.1287" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.1288"></a><span id="l13.1288" class="difflineminus">-        mailListCard = do_QueryInterface(support, &amp;rv);</span>
<a href="#l13.1289"></a><span id="l13.1289" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.1290"></a><span id="l13.1290" class="difflineminus">-</span>
<a href="#l13.1291"></a><span id="l13.1291" class="difflineminus">-        rv = mailListCard-&gt;GetPrimaryEmail(primaryEmail);</span>
<a href="#l13.1292"></a><span id="l13.1292" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.1293"></a><span id="l13.1293" class="difflineminus">-</span>
<a href="#l13.1294"></a><span id="l13.1294" class="difflineminus">-        if (!primaryEmail.IsEmpty()) {</span>
<a href="#l13.1295"></a><span id="l13.1295" class="difflineminus">-          nsCOMPtr&lt;nsISupportsString&gt; supportsEmail(</span>
<a href="#l13.1296"></a><span id="l13.1296" class="difflineminus">-              do_CreateInstance(NS_SUPPORTS_STRING_CONTRACTID));</span>
<a href="#l13.1297"></a><span id="l13.1297" class="difflineminus">-          supportsEmail-&gt;SetData(primaryEmail);</span>
<a href="#l13.1298"></a><span id="l13.1298" class="difflineminus">-          addresses-&gt;AppendElement(supportsEmail);</span>
<a href="#l13.1299"></a><span id="l13.1299" class="difflineminus">-        }</span>
<a href="#l13.1300"></a><span id="l13.1300" class="difflineminus">-      }</span>
<a href="#l13.1301"></a><span id="l13.1301" class="difflineminus">-    } else {</span>
<a href="#l13.1302"></a><span id="l13.1302" class="difflineminus">-      rv = card-&gt;GetPrimaryEmail(primaryEmail);</span>
<a href="#l13.1303"></a><span id="l13.1303" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.1304"></a><span id="l13.1304" class="difflineminus">-</span>
<a href="#l13.1305"></a><span id="l13.1305" class="difflineminus">-      if (!primaryEmail.IsEmpty()) {</span>
<a href="#l13.1306"></a><span id="l13.1306" class="difflineminus">-        nsCOMPtr&lt;nsISupportsString&gt; supportsEmail(</span>
<a href="#l13.1307"></a><span id="l13.1307" class="difflineminus">-            do_CreateInstance(NS_SUPPORTS_STRING_CONTRACTID));</span>
<a href="#l13.1308"></a><span id="l13.1308" class="difflineminus">-        supportsEmail-&gt;SetData(primaryEmail);</span>
<a href="#l13.1309"></a><span id="l13.1309" class="difflineminus">-        addresses-&gt;AppendElement(supportsEmail);</span>
<a href="#l13.1310"></a><span id="l13.1310" class="difflineminus">-      }</span>
<a href="#l13.1311"></a><span id="l13.1311" class="difflineminus">-    }</span>
<a href="#l13.1312"></a><span id="l13.1312" class="difflineminus">-  }</span>
<a href="#l13.1313"></a><span id="l13.1313" class="difflineminus">-</span>
<a href="#l13.1314"></a><span id="l13.1314" class="difflineminus">-  addresses.forget(_retval);</span>
<a href="#l13.1315"></a><span id="l13.1315" class="difflineminus">-</span>
<a href="#l13.1316"></a><span id="l13.1316" class="difflineminus">-  return NS_OK;</span>
<a href="#l13.1317"></a><span id="l13.1317" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">deleted file mode 100644</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineminus">--- a/mailnews/addrbook/src/nsAbView.h</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineplus">+++ /dev/null</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineat">@@ -1,83 +0,0 @@</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l14.7"></a><span id="l14.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l14.9"></a><span id="l14.9" class="difflineminus">-</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineminus">-#ifndef _nsAbView_H_</span>
<a href="#l14.11"></a><span id="l14.11" class="difflineminus">-#define _nsAbView_H_</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-#include &quot;nsISupports.h&quot;</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineminus">-#include &quot;nsIAbView.h&quot;</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineminus">-#include &quot;nsITreeView.h&quot;</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineminus">-#include &quot;mozilla/dom/XULTreeElement.h&quot;</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineminus">-#include &quot;nsITreeSelection.h&quot;</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineminus">-#include &quot;nsTArray.h&quot;</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineminus">-#include &quot;nsIAbDirectory.h&quot;</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineminus">-#include &quot;nsICollation.h&quot;</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineminus">-#include &quot;nsIAbListener.h&quot;</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineminus">-#include &quot;nsIObserver.h&quot;</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineminus">-#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineminus">-#include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineminus">-#include &quot;nsMemory.h&quot;</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineminus">-#include &quot;nsIStringBundle.h&quot;</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineminus">-</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineminus">-typedef struct AbCard {</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineminus">-  explicit AbCard(nsIAbCard *c) : card(c) {}</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-  nsCOMPtr&lt;nsIAbCard&gt; card;</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">-  nsTArray&lt;uint8_t&gt; primaryCollationKey;</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineminus">-  nsTArray&lt;uint8_t&gt; secondaryCollationKey;</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineminus">-} AbCard;</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineminus">-</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineminus">-class nsAbView : public nsIAbView,</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineminus">-                 public nsITreeView,</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineminus">-                 public nsIAbListener,</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineminus">-                 public nsIObserver {</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineminus">- public:</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineminus">-  nsAbView();</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineminus">-</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineminus">-  NS_DECL_ISUPPORTS</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineminus">-  NS_DECL_NSIABVIEW</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineminus">-  NS_DECL_NSITREEVIEW</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineminus">-  NS_DECL_NSIABLISTENER</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineminus">-  NS_DECL_NSIOBSERVER</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineminus">-</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineminus">-  int32_t CompareCollationKeys(const nsTArray&lt;uint8_t&gt; &amp;key1,</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineminus">-                               const nsTArray&lt;uint8_t&gt; &amp;key2);</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineminus">-</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineminus">- private:</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineminus">-  virtual ~nsAbView();</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineminus">-  nsresult Initialize();</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineminus">-  int32_t FindIndexForInsert(AbCard *abcard);</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineminus">-  int32_t FindIndexForCard(nsIAbCard *card);</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineminus">-  nsresult GenerateCollationKeysForCard(const nsAString &amp;colID, AbCard *abcard);</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineminus">-  nsresult InvalidateTree(int32_t row);</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineminus">-  nsresult RemoveCardAt(int32_t row);</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineminus">-  nsresult AddCard(AbCard *abcard, bool selectCardAfterAdding, int32_t *index);</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineminus">-  nsresult RemoveCardAndSelectNextCard(nsISupports *item);</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineminus">-  nsresult EnumerateCards();</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineminus">-  nsresult SetGeneratedNameFormatFromPrefs();</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineminus">-  nsresult GetSelectedCards(nsCOMPtr&lt;nsIMutableArray&gt; &amp;aSelectedCards);</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineminus">-  nsresult ReselectCards(nsIArray *aCards, nsIAbCard *aIndexCard);</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineminus">-  nsresult GetCardValue(nsIAbCard *card, const nsAString &amp;colID,</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineminus">-                        nsAString &amp;_retval);</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineminus">-  nsresult RefreshTree();</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineminus">-</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineminus">-  RefPtr&lt;mozilla::dom::XULTreeElement&gt; mTree;</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineminus">-  nsCOMPtr&lt;nsITreeSelection&gt; mTreeSelection;</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectory&gt; mDirectory;</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineminus">-  nsTArray&lt;AbCard *&gt; mCards;</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineminus">-  nsString mSortColumn;</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineminus">-  nsString mSortDirection;</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineminus">-  nsCOMPtr&lt;nsICollation&gt; mCollationKeyGenerator;</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineminus">-  nsCOMPtr&lt;nsIAbViewListener&gt; mAbViewListener;</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineminus">-  nsCOMPtr&lt;nsIStringBundle&gt; mABBundle;</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineminus">-</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineminus">-  bool mInitialized;</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineminus">-  bool mIsAllDirectoryRootView;</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineminus">-  bool mSuppressSelectionChange;</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineminus">-  bool mSuppressCountChange;</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineminus">-  int32_t mGeneratedNameFormat;</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineminus">-};</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineminus">-</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineminus">-#endif /* _nsAbView_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -12,25 +12,25 @@</span>
<a href="#l15.4"></a><span id="l15.4"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l15.5"></a><span id="l15.5"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l15.6"></a><span id="l15.6"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l15.7"></a><span id="l15.7"> #include &quot;nsStringStream.h&quot;</span>
<a href="#l15.8"></a><span id="l15.8"> #include &quot;nsIAbCard.h&quot;</span>
<a href="#l15.9"></a><span id="l15.9"> #include &quot;nsIAbDirectory.h&quot;</span>
<a href="#l15.10"></a><span id="l15.10"> #include &quot;nsIAbManager.h&quot;</span>
<a href="#l15.11"></a><span id="l15.11"> #include &quot;prmem.h&quot;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-#include &quot;nsIAbView.h&quot;</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-#include &quot;nsITreeView.h&quot;</span>
<a href="#l15.14"></a><span id="l15.14"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l15.15"></a><span id="l15.15"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l15.16"></a><span id="l15.16"> #include &quot;nsIAsyncInputStream.h&quot;</span>
<a href="#l15.17"></a><span id="l15.17"> #include &quot;nsIAsyncOutputStream.h&quot;</span>
<a href="#l15.18"></a><span id="l15.18"> #include &quot;nsIPipe.h&quot;</span>
<a href="#l15.19"></a><span id="l15.19"> #include &quot;nsIPrincipal.h&quot;</span>
<a href="#l15.20"></a><span id="l15.20"> #include &quot;nsIInputStream.h&quot;</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineplus">+#include &quot;nsCollationCID.h&quot;</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineplus">+#include &quot;nsICollation.h&quot;</span>
<a href="#l15.23"></a><span id="l15.23"> </span>
<a href="#l15.24"></a><span id="l15.24"> nsAddbookProtocolHandler::nsAddbookProtocolHandler() {</span>
<a href="#l15.25"></a><span id="l15.25">   mAddbookOperation = nsIAddbookUrlOperation::InvalidUrl;</span>
<a href="#l15.26"></a><span id="l15.26"> }</span>
<a href="#l15.27"></a><span id="l15.27"> </span>
<a href="#l15.28"></a><span id="l15.28"> nsAddbookProtocolHandler::~nsAddbookProtocolHandler() {}</span>
<a href="#l15.29"></a><span id="l15.29"> </span>
<a href="#l15.30"></a><span id="l15.30"> NS_IMPL_ISUPPORTS(nsAddbookProtocolHandler, nsIProtocolHandler)</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineat">@@ -222,16 +222,72 @@ nsresult nsAddbookProtocolHandler::Gener</span>
<a href="#l15.32"></a><span id="l15.32">   }</span>
<a href="#l15.33"></a><span id="l15.33"> </span>
<a href="#l15.34"></a><span id="l15.34">   rv = BuildDirectoryXML(directory, aOutput);</span>
<a href="#l15.35"></a><span id="l15.35">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.36"></a><span id="l15.36"> </span>
<a href="#l15.37"></a><span id="l15.37">   return NS_OK;</span>
<a href="#l15.38"></a><span id="l15.38"> }</span>
<a href="#l15.39"></a><span id="l15.39"> </span>
<a href="#l15.40"></a><span id="l15.40" class="difflineplus">+typedef struct CardEnclosure {</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineplus">+  nsCOMPtr&lt;nsIAbCard&gt; card;</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineplus">+  nsString generatedName;</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineplus">+} CardEnclosure;</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineplus">+</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineplus">+class CardComparator {</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineplus">+ private:</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineplus">+  nsCOMPtr&lt;nsICollation&gt; mCollation;</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineplus">+</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineplus">+  int cmp(CardEnclosure a, CardEnclosure b) const {</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineplus">+    int32_t result;</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+    mCollation-&gt;CompareString(nsICollation::kCollationCaseInSensitive,</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineplus">+                              a.generatedName, b.generatedName, &amp;result);</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineplus">+    return result;</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineplus">+  }</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineplus">+</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineplus">+ public:</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineplus">+  CardComparator() {</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineplus">+    nsCOMPtr&lt;nsICollationFactory&gt; factory =</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineplus">+        do_CreateInstance(NS_COLLATIONFACTORY_CONTRACTID);</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineplus">+    factory-&gt;CreateCollation(getter_AddRefs(mCollation));</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineplus">+  }</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineplus">+</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineplus">+  bool Equals(CardEnclosure a, CardEnclosure b) const { return cmp(a, b) == 0; }</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineplus">+  bool LessThan(CardEnclosure a, CardEnclosure b) const {</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineplus">+    return cmp(a, b) &lt; 0;</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineplus">+  }</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineplus">+};</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineplus">+</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineplus">+nsresult EnumerateCards(nsIAbDirectory *aDirectory,</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineplus">+                        nsTArray&lt;CardEnclosure&gt; &amp;aCards,</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineplus">+                        nsIStringBundle *aBundle) {</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineplus">+  if (!aDirectory) return NS_ERROR_UNEXPECTED;</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineplus">+</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineplus">+  nsCOMPtr&lt;nsISimpleEnumerator&gt; cardsEnumerator;</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineplus">+  nsCOMPtr&lt;nsIAbCard&gt; card;</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineplus">+</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineplus">+  nsresult rv = aDirectory-&gt;GetChildCards(getter_AddRefs(cardsEnumerator));</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; cardsEnumerator) {</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineplus">+    nsCOMPtr&lt;nsISupports&gt; item;</span>
<a href="#l15.80"></a><span id="l15.80" class="difflineplus">+    bool more;</span>
<a href="#l15.81"></a><span id="l15.81" class="difflineplus">+    while (NS_SUCCEEDED(cardsEnumerator-&gt;HasMoreElements(&amp;more)) &amp;&amp; more) {</span>
<a href="#l15.82"></a><span id="l15.82" class="difflineplus">+      rv = cardsEnumerator-&gt;GetNext(getter_AddRefs(item));</span>
<a href="#l15.83"></a><span id="l15.83" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l15.84"></a><span id="l15.84" class="difflineplus">+        nsCOMPtr&lt;nsIAbCard&gt; card = do_QueryInterface(item);</span>
<a href="#l15.85"></a><span id="l15.85" class="difflineplus">+        CardEnclosure enclosure = CardEnclosure();</span>
<a href="#l15.86"></a><span id="l15.86" class="difflineplus">+        enclosure.card = card;</span>
<a href="#l15.87"></a><span id="l15.87" class="difflineplus">+        card-&gt;GenerateName(0, aBundle, enclosure.generatedName);</span>
<a href="#l15.88"></a><span id="l15.88" class="difflineplus">+        aCards.AppendElement(enclosure);</span>
<a href="#l15.89"></a><span id="l15.89" class="difflineplus">+      }</span>
<a href="#l15.90"></a><span id="l15.90" class="difflineplus">+    }</span>
<a href="#l15.91"></a><span id="l15.91" class="difflineplus">+  }</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineplus">+</span>
<a href="#l15.93"></a><span id="l15.93" class="difflineplus">+  return NS_OK;</span>
<a href="#l15.94"></a><span id="l15.94" class="difflineplus">+}</span>
<a href="#l15.95"></a><span id="l15.95" class="difflineplus">+</span>
<a href="#l15.96"></a><span id="l15.96"> nsresult nsAddbookProtocolHandler::BuildDirectoryXML(nsIAbDirectory *aDirectory,</span>
<a href="#l15.97"></a><span id="l15.97">                                                      nsString &amp;aOutput) {</span>
<a href="#l15.98"></a><span id="l15.98">   nsresult rv;</span>
<a href="#l15.99"></a><span id="l15.99"> </span>
<a href="#l15.100"></a><span id="l15.100">   aOutput.AppendLiteral(</span>
<a href="#l15.101"></a><span id="l15.101">       &quot;&lt;?xml version=\&quot;1.0\&quot;?&gt;\n&quot;</span>
<a href="#l15.102"></a><span id="l15.102">       &quot;&lt;?xml-stylesheet type=\&quot;text/css\&quot; &quot;</span>
<a href="#l15.103"></a><span id="l15.103">       &quot;href=\&quot;chrome://messagebody/content/addressbook/print.css\&quot;?&gt;\n&quot;</span>
<a href="#l15.104"></a><span id="l15.104" class="difflineat">@@ -251,42 +307,55 @@ nsresult nsAddbookProtocolHandler::Build</span>
<a href="#l15.105"></a><span id="l15.105">       if (NS_SUCCEEDED(rv)) {</span>
<a href="#l15.106"></a><span id="l15.106">         aOutput.AppendLiteral(&quot;&lt;title xmlns=\&quot;http://www.w3.org/1999/xhtml\&quot;&gt;&quot;);</span>
<a href="#l15.107"></a><span id="l15.107">         aOutput.Append(addrBook);</span>
<a href="#l15.108"></a><span id="l15.108">         aOutput.AppendLiteral(&quot;&lt;/title&gt;\n&quot;);</span>
<a href="#l15.109"></a><span id="l15.109">       }</span>
<a href="#l15.110"></a><span id="l15.110">     }</span>
<a href="#l15.111"></a><span id="l15.111">   }</span>
<a href="#l15.112"></a><span id="l15.112"> </span>
<a href="#l15.113"></a><span id="l15.113" class="difflineminus">-  // create a view and init it with the generated name sort order. Then, iterate</span>
<a href="#l15.114"></a><span id="l15.114" class="difflineminus">-  // over the view, getting the card for each row, and printing them.</span>
<a href="#l15.115"></a><span id="l15.115" class="difflineminus">-  nsString sortColumn;</span>
<a href="#l15.116"></a><span id="l15.116" class="difflineminus">-  nsCOMPtr&lt;nsIAbView&gt; view =</span>
<a href="#l15.117"></a><span id="l15.117" class="difflineminus">-      do_CreateInstance(&quot;@mozilla.org/addressbook/abview;1&quot;, &amp;rv);</span>
<a href="#l15.118"></a><span id="l15.118" class="difflineminus">-</span>
<a href="#l15.119"></a><span id="l15.119" class="difflineminus">-  view-&gt;SetView(aDirectory, nullptr, NS_LITERAL_STRING(&quot;GeneratedName&quot;),</span>
<a href="#l15.120"></a><span id="l15.120" class="difflineminus">-                NS_LITERAL_STRING(&quot;ascending&quot;), sortColumn);</span>
<a href="#l15.121"></a><span id="l15.121" class="difflineplus">+  nsTArray&lt;CardEnclosure&gt; cards;</span>
<a href="#l15.122"></a><span id="l15.122" class="difflineplus">+  if (aDirectory) {</span>
<a href="#l15.123"></a><span id="l15.123" class="difflineplus">+    EnumerateCards(aDirectory, cards, bundle);</span>
<a href="#l15.124"></a><span id="l15.124" class="difflineplus">+  } else {</span>
<a href="#l15.125"></a><span id="l15.125" class="difflineplus">+    nsCOMPtr&lt;nsIAbManager&gt; abManager(</span>
<a href="#l15.126"></a><span id="l15.126" class="difflineplus">+        do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l15.127"></a><span id="l15.127" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.128"></a><span id="l15.128" class="difflineplus">+    nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l15.129"></a><span id="l15.129" class="difflineplus">+    rv = abManager-&gt;GetDirectories(getter_AddRefs(enumerator));</span>
<a href="#l15.130"></a><span id="l15.130" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.131"></a><span id="l15.131"> </span>
<a href="#l15.132"></a><span id="l15.132" class="difflineminus">-  int32_t numRows;</span>
<a href="#l15.133"></a><span id="l15.133" class="difflineminus">-  nsCOMPtr&lt;nsITreeView&gt; treeView = do_QueryInterface(view, &amp;rv);</span>
<a href="#l15.134"></a><span id="l15.134" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.135"></a><span id="l15.135" class="difflineminus">-  treeView-&gt;GetRowCount(&amp;numRows);</span>
<a href="#l15.136"></a><span id="l15.136" class="difflineplus">+    bool hasMore = false;</span>
<a href="#l15.137"></a><span id="l15.137" class="difflineplus">+    nsCOMPtr&lt;nsISupports&gt; support;</span>
<a href="#l15.138"></a><span id="l15.138" class="difflineplus">+    nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l15.139"></a><span id="l15.139" class="difflineplus">+    while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l15.140"></a><span id="l15.140" class="difflineplus">+      rv = enumerator-&gt;GetNext(getter_AddRefs(support));</span>
<a href="#l15.141"></a><span id="l15.141" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.142"></a><span id="l15.142" class="difflineplus">+      directory = do_QueryInterface(support, &amp;rv);</span>
<a href="#l15.143"></a><span id="l15.143" class="difflineplus">+</span>
<a href="#l15.144"></a><span id="l15.144" class="difflineplus">+      // If, for some reason, we are unable to get a directory, we continue.</span>
<a href="#l15.145"></a><span id="l15.145" class="difflineplus">+      if (NS_FAILED(rv)) continue;</span>
<a href="#l15.146"></a><span id="l15.146"> </span>
<a href="#l15.147"></a><span id="l15.147" class="difflineminus">-  for (int32_t row = 0; row &lt; numRows; row++) {</span>
<a href="#l15.148"></a><span id="l15.148" class="difflineminus">-    nsCOMPtr&lt;nsIAbCard&gt; card;</span>
<a href="#l15.149"></a><span id="l15.149" class="difflineminus">-    view-&gt;GetCardFromRow(row, getter_AddRefs(card));</span>
<a href="#l15.150"></a><span id="l15.150" class="difflineplus">+      rv = EnumerateCards(directory, cards, bundle);</span>
<a href="#l15.151"></a><span id="l15.151" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.152"></a><span id="l15.152" class="difflineplus">+    }</span>
<a href="#l15.153"></a><span id="l15.153" class="difflineplus">+  }</span>
<a href="#l15.154"></a><span id="l15.154"> </span>
<a href="#l15.155"></a><span id="l15.155" class="difflineplus">+  CardComparator cardComparator = CardComparator();</span>
<a href="#l15.156"></a><span id="l15.156" class="difflineplus">+  cards.Sort(cardComparator);</span>
<a href="#l15.157"></a><span id="l15.157" class="difflineplus">+</span>
<a href="#l15.158"></a><span id="l15.158" class="difflineplus">+  for (CardEnclosure enclosure : cards) {</span>
<a href="#l15.159"></a><span id="l15.159">     bool isMailList;</span>
<a href="#l15.160"></a><span id="l15.160" class="difflineminus">-    if (NS_FAILED(card-&gt;GetIsMailList(&amp;isMailList)) || isMailList) {</span>
<a href="#l15.161"></a><span id="l15.161" class="difflineplus">+    if (NS_FAILED(enclosure.card-&gt;GetIsMailList(&amp;isMailList)) || isMailList) {</span>
<a href="#l15.162"></a><span id="l15.162">       continue;</span>
<a href="#l15.163"></a><span id="l15.163">     }</span>
<a href="#l15.164"></a><span id="l15.164"> </span>
<a href="#l15.165"></a><span id="l15.165">     nsCString xmlSubstr;</span>
<a href="#l15.166"></a><span id="l15.166"> </span>
<a href="#l15.167"></a><span id="l15.167" class="difflineminus">-    rv = card-&gt;TranslateTo(NS_LITERAL_CSTRING(&quot;xml&quot;), xmlSubstr);</span>
<a href="#l15.168"></a><span id="l15.168" class="difflineplus">+    rv = enclosure.card-&gt;TranslateTo(NS_LITERAL_CSTRING(&quot;xml&quot;), xmlSubstr);</span>
<a href="#l15.169"></a><span id="l15.169">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.170"></a><span id="l15.170"> </span>
<a href="#l15.171"></a><span id="l15.171">     aOutput.AppendLiteral(&quot;&lt;separator/&gt;&quot;);</span>
<a href="#l15.172"></a><span id="l15.172">     aOutput.Append(NS_ConvertUTF8toUTF16(xmlSubstr));</span>
<a href="#l15.173"></a><span id="l15.173">     aOutput.AppendLiteral(&quot;&lt;separator/&gt;&quot;);</span>
<a href="#l15.174"></a><span id="l15.174">   }</span>
<a href="#l15.175"></a><span id="l15.175"> </span>
<a href="#l15.176"></a><span id="l15.176">   aOutput.AppendLiteral(&quot;&lt;/directory&gt;\n&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/build/nsMailModule.cpp</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/build/nsMailModule.cpp</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -116,17 +116,16 @@</span>
<a href="#l16.4"></a><span id="l16.4"> #include &quot;nsAbDirProperty.h&quot;</span>
<a href="#l16.5"></a><span id="l16.5"> #include &quot;nsAbAddressCollector.h&quot;</span>
<a href="#l16.6"></a><span id="l16.6"> #include &quot;nsAddbookProtocolHandler.h&quot;</span>
<a href="#l16.7"></a><span id="l16.7"> #include &quot;nsAddbookUrl.h&quot;</span>
<a href="#l16.8"></a><span id="l16.8"> </span>
<a href="#l16.9"></a><span id="l16.9"> #include &quot;nsAbDirectoryQuery.h&quot;</span>
<a href="#l16.10"></a><span id="l16.10"> #include &quot;nsAbBooleanExpression.h&quot;</span>
<a href="#l16.11"></a><span id="l16.11"> #include &quot;nsAbDirectoryQueryProxy.h&quot;</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-#include &quot;nsAbView.h&quot;</span>
<a href="#l16.13"></a><span id="l16.13"> #include &quot;nsMsgVCardService.h&quot;</span>
<a href="#l16.14"></a><span id="l16.14"> #include &quot;nsAbLDIFService.h&quot;</span>
<a href="#l16.15"></a><span id="l16.15"> </span>
<a href="#l16.16"></a><span id="l16.16"> #if defined(MOZ_LDAP_XPCOM)</span>
<a href="#l16.17"></a><span id="l16.17"> #  include &quot;nsAbLDAPDirectory.h&quot;</span>
<a href="#l16.18"></a><span id="l16.18"> #  include &quot;nsAbLDAPDirectoryQuery.h&quot;</span>
<a href="#l16.19"></a><span id="l16.19"> #  include &quot;nsAbLDAPCard.h&quot;</span>
<a href="#l16.20"></a><span id="l16.20"> #  include &quot;nsAbLDAPReplicationService.h&quot;</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineat">@@ -455,17 +454,16 @@ NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbLDAPR</span>
<a href="#l16.22"></a><span id="l16.22"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbLDAPProcessReplicationData)</span>
<a href="#l16.23"></a><span id="l16.23"> // XXX These files are not being built as they don't work. Bug 311632 should</span>
<a href="#l16.24"></a><span id="l16.24"> // fix them.</span>
<a href="#l16.25"></a><span id="l16.25"> // NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbLDAPChangeLogQuery)</span>
<a href="#l16.26"></a><span id="l16.26"> // NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbLDAPProcessChangeLogData)</span>
<a href="#l16.27"></a><span id="l16.27"> #endif</span>
<a href="#l16.28"></a><span id="l16.28"> </span>
<a href="#l16.29"></a><span id="l16.29"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbDirectoryQueryProxy)</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineminus">-NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbView)</span>
<a href="#l16.31"></a><span id="l16.31"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgVCardService)</span>
<a href="#l16.32"></a><span id="l16.32"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbLDIFService)</span>
<a href="#l16.33"></a><span id="l16.33"> </span>
<a href="#l16.34"></a><span id="l16.34"> #ifdef XP_MACOSX</span>
<a href="#l16.35"></a><span id="l16.35"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbOSXDirectory)</span>
<a href="#l16.36"></a><span id="l16.36"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbOSXCard)</span>
<a href="#l16.37"></a><span id="l16.37"> #endif</span>
<a href="#l16.38"></a><span id="l16.38"> </span>
<a href="#l16.39"></a><span id="l16.39" class="difflineat">@@ -492,17 +490,16 @@ NS_DEFINE_NAMED_CID(NS_ABLDAP_REPLICATIO</span>
<a href="#l16.40"></a><span id="l16.40"> NS_DEFINE_NAMED_CID(NS_ABLDAP_REPLICATIONQUERY_CID);</span>
<a href="#l16.41"></a><span id="l16.41"> NS_DEFINE_NAMED_CID(NS_ABLDAP_PROCESSREPLICATIONDATA_CID);</span>
<a href="#l16.42"></a><span id="l16.42"> #endif</span>
<a href="#l16.43"></a><span id="l16.43"> NS_DEFINE_NAMED_CID(NS_ABDIRECTORYQUERYPROXY_CID);</span>
<a href="#l16.44"></a><span id="l16.44"> #ifdef XP_MACOSX</span>
<a href="#l16.45"></a><span id="l16.45"> NS_DEFINE_NAMED_CID(NS_ABOSXDIRECTORY_CID);</span>
<a href="#l16.46"></a><span id="l16.46"> NS_DEFINE_NAMED_CID(NS_ABOSXCARD_CID);</span>
<a href="#l16.47"></a><span id="l16.47"> #endif</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineminus">-NS_DEFINE_NAMED_CID(NS_ABVIEW_CID);</span>
<a href="#l16.49"></a><span id="l16.49"> NS_DEFINE_NAMED_CID(NS_MSGVCARDSERVICE_CID);</span>
<a href="#l16.50"></a><span id="l16.50"> NS_DEFINE_NAMED_CID(NS_ABLDIFSERVICE_CID);</span>
<a href="#l16.51"></a><span id="l16.51"> </span>
<a href="#l16.52"></a><span id="l16.52"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l16.53"></a><span id="l16.53"> // bayesian spam filter factories</span>
<a href="#l16.54"></a><span id="l16.54"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l16.55"></a><span id="l16.55"> NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsBayesianFilter, Init)</span>
<a href="#l16.56"></a><span id="l16.56"> </span>
<a href="#l16.57"></a><span id="l16.57" class="difflineat">@@ -913,17 +910,16 @@ const mozilla::Module::CIDEntry kMailNew</span>
<a href="#l16.58"></a><span id="l16.58">      nsAbLDAPProcessReplicationDataConstructor},</span>
<a href="#l16.59"></a><span id="l16.59"> #endif</span>
<a href="#l16.60"></a><span id="l16.60">     {&amp;kNS_ABDIRECTORYQUERYPROXY_CID, false, NULL,</span>
<a href="#l16.61"></a><span id="l16.61">      nsAbDirectoryQueryProxyConstructor},</span>
<a href="#l16.62"></a><span id="l16.62"> #ifdef XP_MACOSX</span>
<a href="#l16.63"></a><span id="l16.63">     {&amp;kNS_ABOSXDIRECTORY_CID, false, NULL, nsAbOSXDirectoryConstructor},</span>
<a href="#l16.64"></a><span id="l16.64">     {&amp;kNS_ABOSXCARD_CID, false, NULL, nsAbOSXCardConstructor},</span>
<a href="#l16.65"></a><span id="l16.65"> #endif</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineminus">-    {&amp;kNS_ABVIEW_CID, false, NULL, nsAbViewConstructor},</span>
<a href="#l16.67"></a><span id="l16.67">     {&amp;kNS_MSGVCARDSERVICE_CID, false, NULL, nsMsgVCardServiceConstructor},</span>
<a href="#l16.68"></a><span id="l16.68">     {&amp;kNS_ABLDIFSERVICE_CID, false, NULL, nsAbLDIFServiceConstructor},</span>
<a href="#l16.69"></a><span id="l16.69">     // Bayesian Filter Entries</span>
<a href="#l16.70"></a><span id="l16.70">     {&amp;kNS_BAYESIANFILTER_CID, false, NULL, nsBayesianFilterConstructor},</span>
<a href="#l16.71"></a><span id="l16.71">     // Compose Entries</span>
<a href="#l16.72"></a><span id="l16.72">     {&amp;kNS_MSGCOMPOSE_CID, false, NULL, nsMsgComposeConstructor},</span>
<a href="#l16.73"></a><span id="l16.73">     {&amp;kNS_MSGCOMPOSESERVICE_CID, false, NULL, nsMsgComposeServiceConstructor},</span>
<a href="#l16.74"></a><span id="l16.74">     {&amp;kNS_MSGCOMPOSECONTENTHANDLER_CID, false, NULL,</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineat">@@ -1146,17 +1142,16 @@ const mozilla::Module::ContractIDEntry k</span>
<a href="#l16.76"></a><span id="l16.76">      &amp;kNS_ABLDAP_PROCESSREPLICATIONDATA_CID},</span>
<a href="#l16.77"></a><span id="l16.77"> #endif</span>
<a href="#l16.78"></a><span id="l16.78"> </span>
<a href="#l16.79"></a><span id="l16.79">     {NS_ABDIRECTORYQUERYPROXY_CONTRACTID, &amp;kNS_ABDIRECTORYQUERYPROXY_CID},</span>
<a href="#l16.80"></a><span id="l16.80"> #ifdef XP_MACOSX</span>
<a href="#l16.81"></a><span id="l16.81">     {NS_ABOSXDIRECTORY_CONTRACTID, &amp;kNS_ABOSXDIRECTORY_CID},</span>
<a href="#l16.82"></a><span id="l16.82">     {NS_ABOSXCARD_CONTRACTID, &amp;kNS_ABOSXCARD_CID},</span>
<a href="#l16.83"></a><span id="l16.83"> #endif</span>
<a href="#l16.84"></a><span id="l16.84" class="difflineminus">-    {NS_ABVIEW_CONTRACTID, &amp;kNS_ABVIEW_CID},</span>
<a href="#l16.85"></a><span id="l16.85">     {NS_MSGVCARDSERVICE_CONTRACTID, &amp;kNS_MSGVCARDSERVICE_CID},</span>
<a href="#l16.86"></a><span id="l16.86">     {NS_ABLDIFSERVICE_CONTRACTID, &amp;kNS_ABLDIFSERVICE_CID},</span>
<a href="#l16.87"></a><span id="l16.87">     // Bayesian Filter Entries</span>
<a href="#l16.88"></a><span id="l16.88">     {NS_BAYESIANFILTER_CONTRACTID, &amp;kNS_BAYESIANFILTER_CID},</span>
<a href="#l16.89"></a><span id="l16.89">     // Compose Entries</span>
<a href="#l16.90"></a><span id="l16.90">     {NS_MSGCOMPOSE_CONTRACTID, &amp;kNS_MSGCOMPOSE_CID},</span>
<a href="#l16.91"></a><span id="l16.91">     {NS_MSGCOMPOSESERVICE_CONTRACTID, &amp;kNS_MSGCOMPOSESERVICE_CID},</span>
<a href="#l16.92"></a><span id="l16.92">     {NS_MSGCOMPOSESTARTUPHANDLER_CONTRACTID, &amp;kNS_MSGCOMPOSESERVICE_CID},</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

