<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 3862:21d89cf4c6c00431a938acb796eb5ba26c968583</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 21d89cf4c6c00431a938acb796eb5ba26c968583" />
<meta property="og:url" content="/comm-central/rev/21d89cf4c6c00431a938acb796eb5ba26c968583" />
<meta property="og:description" content="Bug 517244 - collapsing folder pane doesn't persist tab switches. Implement folder pane persistence. r=asuth, a=blocking-tb3+" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 21d89cf4c6c00431a938acb796eb5ba26c968583 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/21d89cf4c6c00431a938acb796eb5ba26c968583">shortlog</a> |
<a href="/comm-central/log/21d89cf4c6c00431a938acb796eb5ba26c968583">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/21d89cf4c6c00431a938acb796eb5ba26c968583">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/21d89cf4c6c00431a938acb796eb5ba26c968583">files</a> |
changeset |
<a href="/comm-central/raw-rev/21d89cf4c6c00431a938acb796eb5ba26c968583">raw</a>  | <a href="/comm-central/archive/21d89cf4c6c00431a938acb796eb5ba26c968583.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=517244">Bug 517244</a> - collapsing folder pane doesn't persist tab switches. Implement folder pane persistence. r=asuth, a=blocking-tb3+
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#83;&#105;&#100;&#100;&#104;&#97;&#114;&#116;&#104;&#32;&#65;&#103;&#97;&#114;&#119;&#97;&#108;&#32;&#60;&#115;&#105;&#100;&#46;&#98;&#117;&#103;&#122;&#105;&#108;&#108;&#97;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 21 Sep 2009 15:28:19 +0530</td></tr>

<tr>
 <td>changeset 3862</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/21d89cf4c6c00431a938acb796eb5ba26c968583">21d89cf4c6c00431a938acb796eb5ba26c968583</a></td>
</tr>



<tr>
<td>parent 3861</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/71899800bdf914e8c9a9d8afb9d58317b747ffff">71899800bdf914e8c9a9d8afb9d58317b747ffff</a>
</td>
</tr>

<tr>
<td>child 3863</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/66a98178ec65db12a2fc93c199c2e7500043a57b">66a98178ec65db12a2fc93c199c2e7500043a57b</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=21d89cf4c6c00431a938acb796eb5ba26c968583">3021</a></td></tr>
<tr><td>push user</td><td>sid.bugzilla@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Mon, 21 Sep 2009 10:00:16 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@21d89cf4c6c0 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=21d89cf4c6c00431a938acb796eb5ba26c968583">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=21d89cf4c6c00431a938acb796eb5ba26c968583&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=21d89cf4c6c00431a938acb796eb5ba26c968583&newProject=comm-central&newRevision=21d89cf4c6c00431a938acb796eb5ba26c968583&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=21d89cf4c6c00431a938acb796eb5ba26c968583&newProject=comm-central&newRevision=21d89cf4c6c00431a938acb796eb5ba26c968583&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=21d89cf4c6c00431a938acb796eb5ba26c968583&newProject=comm-central&newRevision=21d89cf4c6c00431a938acb796eb5ba26c968583&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28asuth%29&revcount=50">asuth</a>, <a href="/comm-central/log?rev=reviewer%28blocking-tb3%29&revcount=50">blocking-tb3</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=517244">517244</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=517244">Bug 517244</a> - collapsing folder pane doesn't persist tab switches. Implement folder pane persistence. r=asuth, a=blocking-tb3+</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/21d89cf4c6c00431a938acb796eb5ba26c968583/mail/base/content/folderDisplay.js">mail/base/content/folderDisplay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/21d89cf4c6c00431a938acb796eb5ba26c968583/mail/base/content/folderDisplay.js">file</a> |
<a href="/comm-central/annotate/21d89cf4c6c00431a938acb796eb5ba26c968583/mail/base/content/folderDisplay.js">annotate</a> |
<a href="/comm-central/diff/21d89cf4c6c00431a938acb796eb5ba26c968583/mail/base/content/folderDisplay.js">diff</a> |
<a href="/comm-central/comparison/21d89cf4c6c00431a938acb796eb5ba26c968583/mail/base/content/folderDisplay.js">comparison</a> |
<a href="/comm-central/log/21d89cf4c6c00431a938acb796eb5ba26c968583/mail/base/content/folderDisplay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/21d89cf4c6c00431a938acb796eb5ba26c968583/mail/base/content/mailTabs.js">mail/base/content/mailTabs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/21d89cf4c6c00431a938acb796eb5ba26c968583/mail/base/content/mailTabs.js">file</a> |
<a href="/comm-central/annotate/21d89cf4c6c00431a938acb796eb5ba26c968583/mail/base/content/mailTabs.js">annotate</a> |
<a href="/comm-central/diff/21d89cf4c6c00431a938acb796eb5ba26c968583/mail/base/content/mailTabs.js">diff</a> |
<a href="/comm-central/comparison/21d89cf4c6c00431a938acb796eb5ba26c968583/mail/base/content/mailTabs.js">comparison</a> |
<a href="/comm-central/log/21d89cf4c6c00431a938acb796eb5ba26c968583/mail/base/content/mailTabs.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/21d89cf4c6c00431a938acb796eb5ba26c968583/mail/base/content/messenger.xul">mail/base/content/messenger.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/21d89cf4c6c00431a938acb796eb5ba26c968583/mail/base/content/messenger.xul">file</a> |
<a href="/comm-central/annotate/21d89cf4c6c00431a938acb796eb5ba26c968583/mail/base/content/messenger.xul">annotate</a> |
<a href="/comm-central/diff/21d89cf4c6c00431a938acb796eb5ba26c968583/mail/base/content/messenger.xul">diff</a> |
<a href="/comm-central/comparison/21d89cf4c6c00431a938acb796eb5ba26c968583/mail/base/content/messenger.xul">comparison</a> |
<a href="/comm-central/log/21d89cf4c6c00431a938acb796eb5ba26c968583/mail/base/content/messenger.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/21d89cf4c6c00431a938acb796eb5ba26c968583/mail/test/mozmill/folder-display/test-folder-pane-visibility.js">mail/test/mozmill/folder-display/test-folder-pane-visibility.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/21d89cf4c6c00431a938acb796eb5ba26c968583/mail/test/mozmill/folder-display/test-folder-pane-visibility.js">file</a> |
<a href="/comm-central/annotate/21d89cf4c6c00431a938acb796eb5ba26c968583/mail/test/mozmill/folder-display/test-folder-pane-visibility.js">annotate</a> |
<a href="/comm-central/diff/21d89cf4c6c00431a938acb796eb5ba26c968583/mail/test/mozmill/folder-display/test-folder-pane-visibility.js">diff</a> |
<a href="/comm-central/comparison/21d89cf4c6c00431a938acb796eb5ba26c968583/mail/test/mozmill/folder-display/test-folder-pane-visibility.js">comparison</a> |
<a href="/comm-central/log/21d89cf4c6c00431a938acb796eb5ba26c968583/mail/test/mozmill/folder-display/test-folder-pane-visibility.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/folderDisplay.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/folderDisplay.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1374,16 +1374,44 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5">     let pendingNotifications = this._notificationsPendingActivation;</span>
<a href="#l1.6"></a><span id="l1.6">     this._notificationsPendingActivation = [];</span>
<a href="#l1.7"></a><span id="l1.7">     for each (let [, notif] in Iterator(pendingNotifications)) {</span>
<a href="#l1.8"></a><span id="l1.8">       notif.call(this);</span>
<a href="#l1.9"></a><span id="l1.9">     }</span>
<a href="#l1.10"></a><span id="l1.10">   },</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+  /// This is not guaranteed to be up to date if the folder display is active</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+  _folderPaneVisible: null,</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+  /**</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+   * Whether the folder pane is visible. When we're inactive, we stash the value</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+   * in |this._folderPaneVisible|.</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+   */</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+  get folderPaneVisible FolderDisplayWidget_get_folderPaneVisible() {</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+    if (this._active) {</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+      let folderPaneBox = document.getElementById(&quot;folderPaneBox&quot;);</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+      if (folderPaneBox)</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+        return !folderPaneBox.collapsed;</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+    }</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+    else {</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+      return this._folderPaneVisible;</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+    }</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+    return null;</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+  },</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+  /**</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+   * Sets the visibility of the folder pane. This should reflect reality and</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+   * not define it (for active tabs at least).</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+   */</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+  set folderPaneVisible FolderDisplayWidget_set_folderPaneVisible(aVisible) {</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+    this._folderPaneVisible = aVisible;</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+  },</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+</span>
<a href="#l1.40"></a><span id="l1.40">   get active() {</span>
<a href="#l1.41"></a><span id="l1.41">     return this._active;</span>
<a href="#l1.42"></a><span id="l1.42">   },</span>
<a href="#l1.43"></a><span id="l1.43"> </span>
<a href="#l1.44"></a><span id="l1.44">   /**</span>
<a href="#l1.45"></a><span id="l1.45">    * Make this FolderDisplayWidget the 'active' widget by updating globals and</span>
<a href="#l1.46"></a><span id="l1.46">    *  linking us up to the UI widgets.  This is intended for use by the tabbing</span>
<a href="#l1.47"></a><span id="l1.47">    *  logic.</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineat">@@ -1396,16 +1424,20 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l1.49"></a><span id="l1.49">     gFolderDisplay = this;</span>
<a href="#l1.50"></a><span id="l1.50">     gMessageDisplay = this.messageDisplay;</span>
<a href="#l1.51"></a><span id="l1.51">     gDBView = this.view.dbView;</span>
<a href="#l1.52"></a><span id="l1.52">     messenger = this.messenger;</span>
<a href="#l1.53"></a><span id="l1.53"> </span>
<a href="#l1.54"></a><span id="l1.54">     // update singleton globals' state</span>
<a href="#l1.55"></a><span id="l1.55">     msgWindow.openFolder = this.view.displayedFolder;</span>
<a href="#l1.56"></a><span id="l1.56"> </span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+    // This depends on us being active, so get it before we're marked active.</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+    // We don't get this._folderPaneActive directly for idempotence's sake.</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+    let folderPaneVisible = this.folderPaneVisible;</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+</span>
<a href="#l1.61"></a><span id="l1.61">     this._active = true;</span>
<a href="#l1.62"></a><span id="l1.62">     this._runNotificationsPendingActivation();</span>
<a href="#l1.63"></a><span id="l1.63"> </span>
<a href="#l1.64"></a><span id="l1.64">     // Make sure we get rid of this._fakeTreeSelection, whether we use it below</span>
<a href="#l1.65"></a><span id="l1.65">     // or not.</span>
<a href="#l1.66"></a><span id="l1.66">     let fakeTreeSelection = this._fakeTreeSelection;</span>
<a href="#l1.67"></a><span id="l1.67">     this._fakeTreeSelection = null;</span>
<a href="#l1.68"></a><span id="l1.68"> </span>
<a href="#l1.69"></a><span id="l1.69" class="difflineat">@@ -1461,30 +1493,30 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l1.70"></a><span id="l1.70">       // Always restore the column state if we have persisted state.  We restore</span>
<a href="#l1.71"></a><span id="l1.71">       //  state on folder entry, in which case we were probably not inactive.</span>
<a href="#l1.72"></a><span id="l1.72">       this._restoreColumnStates();</span>
<a href="#l1.73"></a><span id="l1.73"> </span>
<a href="#l1.74"></a><span id="l1.74">       // the tab mode knows whether we are folder or message display, which</span>
<a href="#l1.75"></a><span id="l1.75">       //  impacts the legal modes</span>
<a href="#l1.76"></a><span id="l1.76">       if (this._tabInfo)</span>
<a href="#l1.77"></a><span id="l1.77">         mailTabType._setPaneStates(this._tabInfo.mode.legalPanes,</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineminus">-          {folder: !this._tabInfo.folderPaneCollapsed,</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineplus">+          {folder: folderPaneVisible,</span>
<a href="#l1.80"></a><span id="l1.80">            message: this.messageDisplay.visible});</span>
<a href="#l1.81"></a><span id="l1.81"> </span>
<a href="#l1.82"></a><span id="l1.82">       // update the columns and such that live inside the thread pane</span>
<a href="#l1.83"></a><span id="l1.83">       this._updateThreadDisplay();</span>
<a href="#l1.84"></a><span id="l1.84"> </span>
<a href="#l1.85"></a><span id="l1.85">       this.messageDisplay.makeActive(dontReloadMessage);</span>
<a href="#l1.86"></a><span id="l1.86">     }</span>
<a href="#l1.87"></a><span id="l1.87">     // account central stuff when we don't have a dbview</span>
<a href="#l1.88"></a><span id="l1.88">     else {</span>
<a href="#l1.89"></a><span id="l1.89">       this._showAccountCentral();</span>
<a href="#l1.90"></a><span id="l1.90">       if (this._tabInfo)</span>
<a href="#l1.91"></a><span id="l1.91">         mailTabType._setPaneStates(this._tabInfo.mode.accountCentralLegalPanes,</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineminus">-          {folder: !this._tabInfo.folderPaneCollapsed});</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineplus">+          {folder: folderPaneVisible});</span>
<a href="#l1.94"></a><span id="l1.94">     }</span>
<a href="#l1.95"></a><span id="l1.95"> </span>
<a href="#l1.96"></a><span id="l1.96">     this._updateContextDisplay();</span>
<a href="#l1.97"></a><span id="l1.97">   },</span>
<a href="#l1.98"></a><span id="l1.98"> </span>
<a href="#l1.99"></a><span id="l1.99">   /**</span>
<a href="#l1.100"></a><span id="l1.100">    * Cause the displayDeck to display the thread pane.</span>
<a href="#l1.101"></a><span id="l1.101">    */</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineat">@@ -1519,18 +1551,18 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l1.103"></a><span id="l1.103">     //  used by _saveColumnStates) so we must do this before marking inactive.</span>
<a href="#l1.104"></a><span id="l1.104">     this._saveColumnStates();</span>
<a href="#l1.105"></a><span id="l1.105"> </span>
<a href="#l1.106"></a><span id="l1.106">     // - mark us inactive</span>
<a href="#l1.107"></a><span id="l1.107">     this._active = false;</span>
<a href="#l1.108"></a><span id="l1.108"> </span>
<a href="#l1.109"></a><span id="l1.109">     // - (everything after this point doesn't care that we are marked inactive)</span>
<a href="#l1.110"></a><span id="l1.110">     // save the folder pane's state always</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineminus">-    this.folderPaneCollapsed =</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineminus">-      document.getElementById(&quot;folderPaneBox&quot;).collapsed;</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineplus">+    this._folderPaneVisible =</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineplus">+      !document.getElementById(&quot;folderPaneBox&quot;).collapsed;</span>
<a href="#l1.115"></a><span id="l1.115"> </span>
<a href="#l1.116"></a><span id="l1.116">     if (this.view.dbView) {</span>
<a href="#l1.117"></a><span id="l1.117">       if (this.treeBox)</span>
<a href="#l1.118"></a><span id="l1.118">         this._savedFirstVisibleRow = this.treeBox.getFirstVisibleRow();</span>
<a href="#l1.119"></a><span id="l1.119"> </span>
<a href="#l1.120"></a><span id="l1.120">       // save the message pane's state only when it is potentially visible</span>
<a href="#l1.121"></a><span id="l1.121">       this.messagePaneCollapsed =</span>
<a href="#l1.122"></a><span id="l1.122">         document.getElementById(&quot;messagepanebox&quot;).collapsed;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/content/mailTabs.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/content/mailTabs.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -102,17 +102,17 @@ let mailTabType = {</span>
<a href="#l2.4"></a><span id="l2.4">       },</span>
<a href="#l2.5"></a><span id="l2.5">       /// The set of panes that are legal when we are showing account central</span>
<a href="#l2.6"></a><span id="l2.6">       accountCentralLegalPanes: {</span>
<a href="#l2.7"></a><span id="l2.7">         folder: true,</span>
<a href="#l2.8"></a><span id="l2.8">         accountCentral: true,</span>
<a href="#l2.9"></a><span id="l2.9">         message: false</span>
<a href="#l2.10"></a><span id="l2.10">       },</span>
<a href="#l2.11"></a><span id="l2.11">       openFirstTab: function(aTab) {</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-        this.openTab(aTab, true, new MessagePaneDisplayWidget());</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+        this.openTab(aTab, true, new MessagePaneDisplayWidget(), true);</span>
<a href="#l2.14"></a><span id="l2.14">         // persistence and restoreTab wants to know if we are the magic first tab</span>
<a href="#l2.15"></a><span id="l2.15">         aTab.firstTab = true;</span>
<a href="#l2.16"></a><span id="l2.16">         aTab.folderDisplay.makeActive();</span>
<a href="#l2.17"></a><span id="l2.17">       },</span>
<a href="#l2.18"></a><span id="l2.18">       /**</span>
<a href="#l2.19"></a><span id="l2.19">        * @param aFolder The nsIMsgFolder to display.</span>
<a href="#l2.20"></a><span id="l2.20">        * @param aMsgHdr Optional message header to display.</span>
<a href="#l2.21"></a><span id="l2.21">        */</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -121,38 +121,48 @@ let mailTabType = {</span>
<a href="#l2.23"></a><span id="l2.23">         aTab.firstTab = false;</span>
<a href="#l2.24"></a><span id="l2.24"> </span>
<a href="#l2.25"></a><span id="l2.25">         // Get a tab that we can initialize our user preferences from.</span>
<a href="#l2.26"></a><span id="l2.26">         // (We don't want to assume that our immediate predecessor was a</span>
<a href="#l2.27"></a><span id="l2.27">         //  &quot;folder&quot; tab.)</span>
<a href="#l2.28"></a><span id="l2.28">         let modelTab = document.getElementById(&quot;tabmail&quot;)</span>
<a href="#l2.29"></a><span id="l2.29">                          .getTabInfoForCurrentOrFirstModeInstance(aTab.mode);</span>
<a href="#l2.30"></a><span id="l2.30"> </span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-        if (modelTab)</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-          aTab.folderPaneCollapsed = modelTab.folderPaneCollapsed;</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-</span>
<a href="#l2.34"></a><span id="l2.34">         if (&quot;searchMode&quot; in aArgs)</span>
<a href="#l2.35"></a><span id="l2.35">           aTab.searchState = {'mode': aArgs.searchMode, 'string': ''};</span>
<a href="#l2.36"></a><span id="l2.36">         else if (modelTab)</span>
<a href="#l2.37"></a><span id="l2.37">           aTab.searchState = {'mode': modelTab.searchMode, 'string': ''};</span>
<a href="#l2.38"></a><span id="l2.38"> </span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+        // - figure out whether to show the folder pane</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+        let folderPaneShouldBeVisible;</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+        // explicitly told to us?</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+        if (&quot;folderPaneVisible&quot; in aArgs)</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+          folderPaneShouldBeVisible = aArgs.folderPaneVisible;</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+        // inherit from the previous tab (if we've got one)</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+        else if (modelTab)</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+          folderPaneShouldBeVisible = modelTab.folderDisplay.folderPaneVisible;</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+        // who doesn't love a folder pane?</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+        else</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+          folderPaneShouldBeVisible = true;</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+</span>
<a href="#l2.51"></a><span id="l2.51">         // - figure out whether to show the message pane</span>
<a href="#l2.52"></a><span id="l2.52">         let messagePaneShouldBeVisible;</span>
<a href="#l2.53"></a><span id="l2.53">         // explicitly told to us?</span>
<a href="#l2.54"></a><span id="l2.54">         if (&quot;messagePaneVisible&quot; in aArgs)</span>
<a href="#l2.55"></a><span id="l2.55">           messagePaneShouldBeVisible = aArgs.messagePaneVisible;</span>
<a href="#l2.56"></a><span id="l2.56">         // inherit from the previous tab (if we've got one)</span>
<a href="#l2.57"></a><span id="l2.57">         else if (modelTab)</span>
<a href="#l2.58"></a><span id="l2.58">           messagePaneShouldBeVisible = modelTab.messageDisplay.visible;</span>
<a href="#l2.59"></a><span id="l2.59">         // who does't love a message pane?</span>
<a href="#l2.60"></a><span id="l2.60">         else</span>
<a href="#l2.61"></a><span id="l2.61">           messagePaneShouldBeVisible = true;</span>
<a href="#l2.62"></a><span id="l2.62"> </span>
<a href="#l2.63"></a><span id="l2.63">         this.openTab(aTab, false,</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineminus">-                     new MessagePaneDisplayWidget(messagePaneShouldBeVisible));</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+                     new MessagePaneDisplayWidget(messagePaneShouldBeVisible),</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+                     folderPaneShouldBeVisible);</span>
<a href="#l2.67"></a><span id="l2.67"> </span>
<a href="#l2.68"></a><span id="l2.68">         let background = (&quot;background&quot; in aArgs) &amp;&amp; aArgs.background;</span>
<a href="#l2.69"></a><span id="l2.69">         let msgHdr = (&quot;msgHdr&quot; in aArgs) &amp;&amp; aArgs.msgHdr;</span>
<a href="#l2.70"></a><span id="l2.70"> </span>
<a href="#l2.71"></a><span id="l2.71">         if (!background) {</span>
<a href="#l2.72"></a><span id="l2.72">           aTab.folderDisplay.makeActive();</span>
<a href="#l2.73"></a><span id="l2.73">           // HACK: Since we've switched away from the tab, we need to bring</span>
<a href="#l2.74"></a><span id="l2.74">           // back the real selection before selecting the folder, so do that</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineat">@@ -178,34 +188,46 @@ let mailTabType = {</span>
<a href="#l2.76"></a><span id="l2.76"> </span>
<a href="#l2.77"></a><span id="l2.77">         aTab.mode.onTitleChanged.call(this, aTab, aTab.tabNode);</span>
<a href="#l2.78"></a><span id="l2.78">       },</span>
<a href="#l2.79"></a><span id="l2.79">       persistTab: function(aTab) {</span>
<a href="#l2.80"></a><span id="l2.80">         if (!aTab.folderDisplay.displayedFolder)</span>
<a href="#l2.81"></a><span id="l2.81">           return null;</span>
<a href="#l2.82"></a><span id="l2.82">         return {</span>
<a href="#l2.83"></a><span id="l2.83">           folderURI: aTab.folderDisplay.displayedFolder.URI,</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+          // if the folder pane is active, then we need to look at</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineplus">+          // whether the box is collapsed</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineplus">+          folderPaneVisible: aTab.folderDisplay.folderPaneVisible,</span>
<a href="#l2.87"></a><span id="l2.87">           messagePaneVisible: aTab.messageDisplay.visible,</span>
<a href="#l2.88"></a><span id="l2.88">           firstTab: aTab.firstTab,</span>
<a href="#l2.89"></a><span id="l2.89">           searchMode: aTab.searchState['mode']</span>
<a href="#l2.90"></a><span id="l2.90">         };</span>
<a href="#l2.91"></a><span id="l2.91">       },</span>
<a href="#l2.92"></a><span id="l2.92">       restoreTab: function(aTabmail, aPersistedState) {</span>
<a href="#l2.93"></a><span id="l2.93">       try {</span>
<a href="#l2.94"></a><span id="l2.94">         let rdfService = Components.classes['@mozilla.org/rdf/rdf-service;1']</span>
<a href="#l2.95"></a><span id="l2.95">                            .getService(Components.interfaces.nsIRDFService);</span>
<a href="#l2.96"></a><span id="l2.96">         let folder = rdfService.GetResource(aPersistedState.folderURI)</span>
<a href="#l2.97"></a><span id="l2.97">                        .QueryInterface(Components.interfaces.nsIMsgFolder);</span>
<a href="#l2.98"></a><span id="l2.98">         // if the folder no longer exists, we can't restore the tab</span>
<a href="#l2.99"></a><span id="l2.99">         if (folder) {</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineplus">+          let folderPaneVisible = (&quot;folderPaneVisible&quot; in aPersistedState) ?</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineplus">+                                    aPersistedState.folderPaneVisible :</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineplus">+                                    true;</span>
<a href="#l2.103"></a><span id="l2.103">           // If we are talking about the first tab, it already exists and we</span>
<a href="#l2.104"></a><span id="l2.104">           //  should poke it.  We are assuming it is the currently displayed</span>
<a href="#l2.105"></a><span id="l2.105">           //  tab because we are privvy to the implementation details and know</span>
<a href="#l2.106"></a><span id="l2.106">           //  it to be true.</span>
<a href="#l2.107"></a><span id="l2.107">           if (aPersistedState.firstTab) {</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineplus">+            // Poke the folder pane box and splitter</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineplus">+            document.getElementById(&quot;folderPaneBox&quot;).collapsed =</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineplus">+              !folderPaneVisible;</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineplus">+            document.getElementById(&quot;folderpane_splitter&quot;).setAttribute(&quot;state&quot;,</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineplus">+              (folderPaneVisible ? &quot;open&quot; : &quot;collapsed&quot;));</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineplus">+</span>
<a href="#l2.114"></a><span id="l2.114">             if (gMessageDisplay.visible != aPersistedState.messagePaneVisible) {</span>
<a href="#l2.115"></a><span id="l2.115">               MsgToggleMessagePane();</span>
<a href="#l2.116"></a><span id="l2.116">               // For reasons that are not immediately obvious, sometimes the</span>
<a href="#l2.117"></a><span id="l2.117">               //  message display is not active at this time.  In that case, we</span>
<a href="#l2.118"></a><span id="l2.118">               //  need to explicitly set the _visible value because otherwise it</span>
<a href="#l2.119"></a><span id="l2.119">               //  misses out on the toggle event.</span>
<a href="#l2.120"></a><span id="l2.120">               if (!gMessageDisplay._active)</span>
<a href="#l2.121"></a><span id="l2.121">                 gMessageDisplay._visible = aPersistedState.messagePaneVisible;</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineat">@@ -213,16 +235,17 @@ let mailTabType = {</span>
<a href="#l2.123"></a><span id="l2.123">             if (&quot;searchMode&quot; in aPersistedState)</span>
<a href="#l2.124"></a><span id="l2.124">               document.getElementById('searchInput').searchMode =</span>
<a href="#l2.125"></a><span id="l2.125">                 aPersistedState.searchMode;</span>
<a href="#l2.126"></a><span id="l2.126">             gFolderTreeView.selectFolder(folder);</span>
<a href="#l2.127"></a><span id="l2.127">           }</span>
<a href="#l2.128"></a><span id="l2.128">           else {</span>
<a href="#l2.129"></a><span id="l2.129">             let tabArgs = {</span>
<a href="#l2.130"></a><span id="l2.130">               folder: folder,</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineplus">+              folderPaneVisible: folderPaneVisible,</span>
<a href="#l2.132"></a><span id="l2.132">               messagePaneVisible: aPersistedState.messagePaneVisible,</span>
<a href="#l2.133"></a><span id="l2.133">               background: true</span>
<a href="#l2.134"></a><span id="l2.134">             };</span>
<a href="#l2.135"></a><span id="l2.135">             if (&quot;searchMode&quot; in aPersistedState)</span>
<a href="#l2.136"></a><span id="l2.136">               tabArgs.searchMode = aPersistedState.searchMode;</span>
<a href="#l2.137"></a><span id="l2.137">             aTabmail.openTab(&quot;folder&quot;, tabArgs);</span>
<a href="#l2.138"></a><span id="l2.138">           }</span>
<a href="#l2.139"></a><span id="l2.139">         }</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineat">@@ -267,17 +290,17 @@ let mailTabType = {</span>
<a href="#l2.141"></a><span id="l2.141">       type: &quot;message&quot;,</span>
<a href="#l2.142"></a><span id="l2.142">       /// The set of panes that are legal to be displayed in this mode</span>
<a href="#l2.143"></a><span id="l2.143">       legalPanes: {</span>
<a href="#l2.144"></a><span id="l2.144">         folder: false,</span>
<a href="#l2.145"></a><span id="l2.145">         thread: false,</span>
<a href="#l2.146"></a><span id="l2.146">         message: true</span>
<a href="#l2.147"></a><span id="l2.147">       },</span>
<a href="#l2.148"></a><span id="l2.148">       openTab: function(aTab, aArgs) {</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineminus">-        this.openTab(aTab, false, new MessageTabDisplayWidget());</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineplus">+        this.openTab(aTab, false, new MessageTabDisplayWidget(), false);</span>
<a href="#l2.151"></a><span id="l2.151"> </span>
<a href="#l2.152"></a><span id="l2.152">         let viewWrapperToClone = (&quot;viewWrapperToClone&quot; in aArgs) &amp;&amp;</span>
<a href="#l2.153"></a><span id="l2.153">                                  aArgs.viewWrapperToClone;</span>
<a href="#l2.154"></a><span id="l2.154">         let background = (&quot;background&quot; in aArgs) &amp;&amp; aArgs.background;</span>
<a href="#l2.155"></a><span id="l2.155"> </span>
<a href="#l2.156"></a><span id="l2.156">         if (viewWrapperToClone) {</span>
<a href="#l2.157"></a><span id="l2.157">           aTab.folderDisplay.cloneView(viewWrapperToClone);</span>
<a href="#l2.158"></a><span id="l2.158">         }</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineat">@@ -399,17 +422,17 @@ let mailTabType = {</span>
<a href="#l2.160"></a><span id="l2.160">        *     are using a localized string.</span>
<a href="#l2.161"></a><span id="l2.161">        *</span>
<a href="#l2.162"></a><span id="l2.162">        * XXX This needs to handle opening in the background</span>
<a href="#l2.163"></a><span id="l2.163">        */</span>
<a href="#l2.164"></a><span id="l2.164">       openTab: function(aTab, aArgs) {</span>
<a href="#l2.165"></a><span id="l2.165">         aTab.glodaSynView = new GlodaSyntheticView(aArgs);</span>
<a href="#l2.166"></a><span id="l2.166">         aTab.title = aArgs.title;</span>
<a href="#l2.167"></a><span id="l2.167"> </span>
<a href="#l2.168"></a><span id="l2.168" class="difflineminus">-        this.openTab(aTab, false, new MessagePaneDisplayWidget());</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineplus">+        this.openTab(aTab, false, new MessagePaneDisplayWidget(), false);</span>
<a href="#l2.170"></a><span id="l2.170">         aTab.folderDisplay.show(aTab.glodaSynView);</span>
<a href="#l2.171"></a><span id="l2.171">         // XXX persist column states in preferences or session store or other</span>
<a href="#l2.172"></a><span id="l2.172">         aTab.folderDisplay.setColumnStates(aTab.mode.desiredColumnStates);</span>
<a href="#l2.173"></a><span id="l2.173">         aTab.folderDisplay.view.showThreaded = true;</span>
<a href="#l2.174"></a><span id="l2.174"> </span>
<a href="#l2.175"></a><span id="l2.175">         let background = (&quot;background&quot; in aArgs) &amp;&amp; aArgs.background;</span>
<a href="#l2.176"></a><span id="l2.176">         if (!background)</span>
<a href="#l2.177"></a><span id="l2.177">           aTab.folderDisplay.makeActive();</span>
<a href="#l2.178"></a><span id="l2.178" class="difflineat">@@ -435,27 +458,28 @@ let mailTabType = {</span>
<a href="#l2.179"></a><span id="l2.179">     let accountCount = mgr.accounts.Count();</span>
<a href="#l2.180"></a><span id="l2.180">     // If we have an account, we also always have a &quot;Local Folders&quot; account.</span>
<a href="#l2.181"></a><span id="l2.181">     return accountCount &gt; 0 ? (accountCount - 1) : 0;</span>
<a href="#l2.182"></a><span id="l2.182">   },</span>
<a href="#l2.183"></a><span id="l2.183"> </span>
<a href="#l2.184"></a><span id="l2.184">   /**</span>
<a href="#l2.185"></a><span id="l2.185">    * Common tab opening code shared by the various tab modes.</span>
<a href="#l2.186"></a><span id="l2.186">    */</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineminus">-  openTab: function(aTab, aIsFirstTab, aMessageDisplay) {</span>
<a href="#l2.188"></a><span id="l2.188" class="difflineplus">+  openTab: function(aTab, aIsFirstTab, aMessageDisplay, aFolderPaneVisible) {</span>
<a href="#l2.189"></a><span id="l2.189">     // Set the messagepane as the primary browser for content.</span>
<a href="#l2.190"></a><span id="l2.190">     document.getElementById(&quot;messagepane&quot;).setAttribute(&quot;type&quot;,</span>
<a href="#l2.191"></a><span id="l2.191">                                                         &quot;content-primary&quot;);</span>
<a href="#l2.192"></a><span id="l2.192"> </span>
<a href="#l2.193"></a><span id="l2.193">     aTab.messageDisplay = aMessageDisplay;</span>
<a href="#l2.194"></a><span id="l2.194">     aTab.folderDisplay = new FolderDisplayWidget(aTab, aTab.messageDisplay);</span>
<a href="#l2.195"></a><span id="l2.195">     aTab.folderDisplay.msgWindow = msgWindow;</span>
<a href="#l2.196"></a><span id="l2.196">     aTab.folderDisplay.tree = document.getElementById(&quot;threadTree&quot;);</span>
<a href="#l2.197"></a><span id="l2.197">     aTab.folderDisplay.treeBox = aTab.folderDisplay.tree.boxObject.QueryInterface(</span>
<a href="#l2.198"></a><span id="l2.198">                                    Components.interfaces.nsITreeBoxObject);</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineplus">+    aTab.folderDisplay.folderPaneVisible = aFolderPaneVisible;</span>
<a href="#l2.200"></a><span id="l2.200"> </span>
<a href="#l2.201"></a><span id="l2.201">     if (aIsFirstTab) {</span>
<a href="#l2.202"></a><span id="l2.202">       aTab.folderDisplay.messenger = messenger;</span>
<a href="#l2.203"></a><span id="l2.203">     }</span>
<a href="#l2.204"></a><span id="l2.204">     else {</span>
<a href="#l2.205"></a><span id="l2.205">       // Each tab gets its own messenger instance; this provides each tab with</span>
<a href="#l2.206"></a><span id="l2.206">       // its own undo/redo stack and back/forward navigation history.</span>
<a href="#l2.207"></a><span id="l2.207">       // If this is a foreground tab, folderDisplay.makeActive() is going to</span>
<a href="#l2.208"></a><span id="l2.208" class="difflineat">@@ -599,21 +623,25 @@ let mailTabType = {</span>
<a href="#l2.209"></a><span id="l2.209">     }</span>
<a href="#l2.210"></a><span id="l2.210"> </span>
<a href="#l2.211"></a><span id="l2.211">     // -- folder pane</span>
<a href="#l2.212"></a><span id="l2.212">     // collapse the splitter when not legal</span>
<a href="#l2.213"></a><span id="l2.213">     document.getElementById(&quot;folderpane_splitter&quot;).collapsed =</span>
<a href="#l2.214"></a><span id="l2.214">       !aLegalStates.folder;</span>
<a href="#l2.215"></a><span id="l2.215">     // collapse the folder pane when not visible</span>
<a href="#l2.216"></a><span id="l2.216">     document.getElementById(&quot;folderPaneBox&quot;).collapsed =</span>
<a href="#l2.217"></a><span id="l2.217" class="difflineminus">-      !aLegalStates.folder || !aVisibleStates.folder;</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineminus">-    try {</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineminus">-      // The folder-location-toolbar is like the folder pane.</span>
<a href="#l2.220"></a><span id="l2.220" class="difflineplus">+     !aLegalStates.folder || !aVisibleStates.folder;</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineplus">+    // let the splitter know as well</span>
<a href="#l2.222"></a><span id="l2.222" class="difflineplus">+    document.getElementById(&quot;folderpane_splitter&quot;).setAttribute(&quot;state&quot;,</span>
<a href="#l2.223"></a><span id="l2.223" class="difflineplus">+     (!aLegalStates.folder || !aVisibleStates.folder) ? &quot;collapsed&quot; : &quot;open&quot;);</span>
<a href="#l2.224"></a><span id="l2.224" class="difflineplus">+    try {      </span>
<a href="#l2.225"></a><span id="l2.225" class="difflineplus">+      // The folder-location-toolbar should be hidden if the folder</span>
<a href="#l2.226"></a><span id="l2.226" class="difflineplus">+      // pane is illegal. Otherwise we shouldn't touch it</span>
<a href="#l2.227"></a><span id="l2.227">       document.getElementById(&quot;folder-location-container&quot;).collapsed =</span>
<a href="#l2.228"></a><span id="l2.228" class="difflineminus">-        !aLegalStates.folder || !aVisibleStates.folder;</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineplus">+        !aLegalStates.folder;</span>
<a href="#l2.230"></a><span id="l2.230">     } catch (ex) {}</span>
<a href="#l2.231"></a><span id="l2.231"> </span>
<a href="#l2.232"></a><span id="l2.232">     // -- display deck (thread pane / account central)</span>
<a href="#l2.233"></a><span id="l2.233">     // in a vertical view, the threadContentArea sits in the #threadPaneBox</span>
<a href="#l2.234"></a><span id="l2.234">     //  next to the message pane and its splitter.</span>
<a href="#l2.235"></a><span id="l2.235">     if (layout == kVerticalMailLayout)</span>
<a href="#l2.236"></a><span id="l2.236">       document.getElementById(&quot;threadContentArea&quot;).collapsed =</span>
<a href="#l2.237"></a><span id="l2.237">         !displayDeckLegal;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/base/content/messenger.xul</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/base/content/messenger.xul</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -216,17 +216,17 @@</span>
<a href="#l3.4"></a><span id="l3.4">         &lt;!-- mailContent is the container used for the &quot;wide&quot; layout. Normally,</span>
<a href="#l3.5"></a><span id="l3.5">              all it contains is the &quot;messengerBox&quot; box.  However, in &quot;wide&quot; mode</span>
<a href="#l3.6"></a><span id="l3.6">              the message pane and its splitter transplant themselves into the box</span>
<a href="#l3.7"></a><span id="l3.7">              (respectively, messagepanebox and threadpane-splitter).  This gives us</span>
<a href="#l3.8"></a><span id="l3.8">              the folder pane next to the thread view, with the message pane/reader</span>
<a href="#l3.9"></a><span id="l3.9">              beneath both of them. --&gt;</span>
<a href="#l3.10"></a><span id="l3.10">         &lt;box id=&quot;mailContent&quot; orient=&quot;vertical&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l3.11"></a><span id="l3.11">           &lt;box id=&quot;messengerBox&quot; orient=&quot;horizontal&quot; flex=&quot;1&quot; minheight=&quot;100&quot; height=&quot;100&quot; persist=&quot;height&quot;&gt;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-            &lt;vbox id=&quot;folderPaneBox&quot; minwidth=&quot;100&quot; width=&quot;200&quot; persist=&quot;collapsed width&quot;&gt;</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+            &lt;vbox id=&quot;folderPaneBox&quot; minwidth=&quot;100&quot; width=&quot;200&quot; persist=&quot;width&quot;&gt;</span>
<a href="#l3.14"></a><span id="l3.14">               &lt;label id=&quot;folderColumnLabel&quot; hidden=&quot;true&quot; value=&quot;&amp;folderColumn.label;&quot;/&gt;</span>
<a href="#l3.15"></a><span id="l3.15">               &lt;sidebarheader id=&quot;folderPaneHeader&quot; align=&quot;center&quot;&gt;</span>
<a href="#l3.16"></a><span id="l3.16">                 &lt;label id=&quot;folderpane-title&quot;/&gt;</span>
<a href="#l3.17"></a><span id="l3.17">                 &lt;spacer flex=&quot;1&quot;/&gt;</span>
<a href="#l3.18"></a><span id="l3.18">                 &lt;toolbarbutton id=&quot;folderview-cycler-prev&quot;</span>
<a href="#l3.19"></a><span id="l3.19">                                chromedir=&quot;&amp;locale.dir;&quot;</span>
<a href="#l3.20"></a><span id="l3.20">                                dir=&quot;prev&quot;</span>
<a href="#l3.21"></a><span id="l3.21">                                class=&quot;folderview-cycler&quot;</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineat">@@ -259,17 +259,17 @@</span>
<a href="#l3.23"></a><span id="l3.23">                            sortDirection=&quot;ascending&quot;/&gt;</span>
<a href="#l3.24"></a><span id="l3.24">                 &lt;/treecols&gt;</span>
<a href="#l3.25"></a><span id="l3.25">                 &lt;treechildren tooltip=&quot;folderpopup&quot;</span>
<a href="#l3.26"></a><span id="l3.26">                               onoverflow=&quot;document.getElementById('folderPaneHeader').setAttribute('overflowing', 'true');&quot;</span>
<a href="#l3.27"></a><span id="l3.27">                               onunderflow=&quot;document.getElementById('folderPaneHeader').setAttribute('overflowing', 'false');&quot;/&gt;</span>
<a href="#l3.28"></a><span id="l3.28">               &lt;/tree&gt;</span>
<a href="#l3.29"></a><span id="l3.29">             &lt;/vbox&gt;</span>
<a href="#l3.30"></a><span id="l3.30"> </span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-            &lt;splitter id=&quot;folderpane_splitter&quot; collapse=&quot;before&quot; persist=&quot;state&quot;/&gt;</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+            &lt;splitter id=&quot;folderpane_splitter&quot; collapse=&quot;before&quot;/&gt;</span>
<a href="#l3.33"></a><span id="l3.33"> </span>
<a href="#l3.34"></a><span id="l3.34">             &lt;vbox flex=&quot;1&quot;&gt;</span>
<a href="#l3.35"></a><span id="l3.35">               &lt;box orient=&quot;vertical&quot; id=&quot;messagesBox&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l3.36"></a><span id="l3.36">                 &lt;deck id=&quot;displayDeck&quot; flex=&quot;1&quot; selectedIndex=&quot;0&quot;</span>
<a href="#l3.37"></a><span id="l3.37">                       minheight=&quot;100&quot; height=&quot;100&quot; persist=&quot;height&quot;</span>
<a href="#l3.38"></a><span id="l3.38">                       &gt;</span>
<a href="#l3.39"></a><span id="l3.39">                   &lt;!-- first panel in displayDeck is Account Central --&gt;</span>
<a href="#l3.40"></a><span id="l3.40">                   &lt;vbox id=&quot;accountCentralBox&quot; flex=&quot;1&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">new file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- /dev/null</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-folder-pane-visibility.js</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -0,0 +1,275 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineplus">+ *</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+ *</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+ * License.</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+ *</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+ *</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+ *</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+ *   Siddharth Agarwal &lt;sid.bugzilla@gmail.com&gt;</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+ *</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+ *</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+/*</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+ * Test that the folder pane collapses properly, stays collapsed amongst tab</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+ * changes, and that persistence works (to a first approximation).</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+ */</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+var MODULE_NAME = &quot;test-folder-pane-visibility&quot;;</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+var folder;</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+function setupModule(module) {</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+  fdh.installInto(module);</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+  let wh = collector.getModule('window-helpers');</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+  wh.installInto(module);</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+  folder = create_folder(&quot;FolderPaneVisibility&quot;);</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+  make_new_sets_in_folder(folder, [{count: 3}]);</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+}</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+/**</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+ * When displaying a folder, assert that the folder pane is visible and all the</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+ * menus, splitters, etc. are set up right.</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+ */</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+function assert_folder_pane_visible() {</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+  if (!mc.folderDisplay.folderPaneVisible)</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+    throw new Error(&quot;The folder display does not think that the folder pane &quot; +</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+                    &quot;is visible, but it should!&quot;);</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+  // - folder pane should be visible</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+  if (mc.e(&quot;folderPaneBox&quot;).collapsed === true)</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+    throw new Error(&quot;folderPaneBox should not be collapsed!&quot;);</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+  // - the folder pane splitter should not be collapsed</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+  if (mc.e(&quot;folderpane_splitter&quot;).collapsed === true)</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+    throw new Error(&quot;folderpane_splitter should not be collapsed!&quot;);</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+}</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+/**</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+ * When displaying a folder, assert that the folder pane is hidden and all the</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+ * menus, splitters, etc. are set up right.</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+ *</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+ * @param aFolderPaneIllegal Is the folder pane illegal to display at this time?</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+ *     This impacts whether the folder pane splitter should be visible.</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+ */</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+function assert_folder_pane_hidden(aFolderPaneIllegal) {</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+  if (mc.folderDisplay.folderPaneVisible)</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+    throw new Error(&quot;The folder display thinks that the folder pane is &quot; +</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+                    &quot;visible, but it shouldn't!&quot;);</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+  // - folder pane shouldn't be visible</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+  if (mc.e(&quot;folderPaneBox&quot;).collapsed === false)</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+    throw new Error(&quot;folderPaneBox should be collapsed!&quot;);</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+  // - the folder pane splitter should or should not be collapsed, depending on</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+  //   aFolderPaneIllegal</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+  if (aFolderPaneIllegal) {</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+    if (mc.e(&quot;folderpane_splitter&quot;).collapsed === false)</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+      throw new Error(&quot;folderpane_splitter should be collapsed!&quot;);</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+  }</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+  else {</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+    if (mc.e(&quot;folderpane_splitter&quot;).collapsed === true)</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+      throw new Error(&quot;folderpane_splitter should not be collapsed!&quot;);</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+  }</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+}</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineplus">+function toggle_folder_pane() {</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+  // Since we don't have a shortcut to toggle the folder pane, we're going to</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+  // have to collapse it ourselves</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+  let folderPaneBox = mc.e(&quot;folderPaneBox&quot;);</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineplus">+  let currentState = folderPaneBox.collapsed;</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+  folderPaneBox.collapsed = !currentState;</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+}</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineplus">+/**</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineplus">+ * By default, the folder pane should be visible.</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineplus">+ */</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineplus">+function test_folder_pane_visible_state_is_right() {</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+  assert_folder_pane_visible();</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineplus">+}</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineplus">+</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineplus">+/**</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineplus">+ * Toggle the folder pane off.</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineplus">+ */</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineplus">+function test_toggle_folder_pane_off() {</span>
<a href="#l4.132"></a><span id="l4.132" class="difflineplus">+  toggle_folder_pane();</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineplus">+  assert_folder_pane_hidden();</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineplus">+}</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineplus">+</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineplus">+/**</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineplus">+ * Toggle the folder pane on.</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineplus">+ */</span>
<a href="#l4.139"></a><span id="l4.139" class="difflineplus">+function test_toggle_folder_pane_on() {</span>
<a href="#l4.140"></a><span id="l4.140" class="difflineplus">+  toggle_folder_pane();</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineplus">+  assert_folder_pane_visible();</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineplus">+}</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineplus">+</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineplus">+/**</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineplus">+ * Make sure that switching to message tabs of folder tabs with a different</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineplus">+ * folder pane state does not break. This test should cover all transition</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineplus">+ * states.</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineplus">+ */</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineplus">+function test_folder_pane_is_sticky() {</span>
<a href="#l4.150"></a><span id="l4.150" class="difflineplus">+  let tabFolderA = be_in_folder(folder);</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineplus">+  assert_folder_pane_visible();</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineplus">+</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineplus">+  // [folder+ =&gt; (new) message]</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineplus">+  select_click_row(0);</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineplus">+  let tabMessage = open_selected_message_in_new_tab();</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineplus">+  assert_folder_pane_hidden(true);</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineplus">+</span>
<a href="#l4.158"></a><span id="l4.158" class="difflineplus">+  // [message =&gt; folder+]</span>
<a href="#l4.159"></a><span id="l4.159" class="difflineplus">+  switch_tab(tabFolderA);</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineplus">+  assert_folder_pane_visible();</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineplus">+</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineplus">+  // [folder+ =&gt; (new) folder+]</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineplus">+  let tabFolderB = open_folder_in_new_tab(folder);</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineplus">+  assert_folder_pane_visible();</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineplus">+</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineplus">+  // [folder pane toggle + =&gt; -]</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineplus">+  toggle_folder_pane();</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineplus">+  assert_folder_pane_hidden();</span>
<a href="#l4.169"></a><span id="l4.169" class="difflineplus">+</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineplus">+  // [folder- =&gt; folder+]</span>
<a href="#l4.171"></a><span id="l4.171" class="difflineplus">+  switch_tab(tabFolderA);</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineplus">+  assert_folder_pane_visible();</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineplus">+</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineplus">+  // (redundant) [ folder pane toggle + =&gt; -]</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineplus">+  toggle_folder_pane();</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineplus">+  assert_folder_pane_hidden();</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineplus">+</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineplus">+  // [folder- =&gt; message]</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineplus">+  switch_tab(tabMessage);</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineplus">+  assert_folder_pane_hidden(true);</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineplus">+</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineplus">+  // [message =&gt; folder-]</span>
<a href="#l4.183"></a><span id="l4.183" class="difflineplus">+  close_tab(tabMessage);</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineplus">+  assert_folder_pane_hidden();</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineplus">+</span>
<a href="#l4.186"></a><span id="l4.186" class="difflineplus">+  // [folder- =&gt; (new) folder-]</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineplus">+  // (we are testing inheritance here)</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineplus">+  let tabFolderC = open_folder_in_new_tab(folder);</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineplus">+  assert_folder_pane_hidden();</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineplus">+</span>
<a href="#l4.191"></a><span id="l4.191" class="difflineplus">+  // [folder- =&gt; folder-]</span>
<a href="#l4.192"></a><span id="l4.192" class="difflineplus">+  close_tab(tabFolderC);</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineplus">+  // the tab we are on now doesn't matter, so we don't care</span>
<a href="#l4.194"></a><span id="l4.194" class="difflineplus">+  assert_folder_pane_hidden();</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineplus">+  switch_tab(tabFolderB);</span>
<a href="#l4.196"></a><span id="l4.196" class="difflineplus">+</span>
<a href="#l4.197"></a><span id="l4.197" class="difflineplus">+  // [ folder pane toggle - =&gt; + ]</span>
<a href="#l4.198"></a><span id="l4.198" class="difflineplus">+  toggle_folder_pane();</span>
<a href="#l4.199"></a><span id="l4.199" class="difflineplus">+  assert_folder_pane_visible();</span>
<a href="#l4.200"></a><span id="l4.200" class="difflineplus">+</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineplus">+  // [folder+ =&gt; folder-]</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineplus">+  close_tab(tabFolderB);</span>
<a href="#l4.203"></a><span id="l4.203" class="difflineplus">+  assert_folder_pane_hidden();</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineplus">+</span>
<a href="#l4.205"></a><span id="l4.205" class="difflineplus">+  // (redundant) [ folder pane toggle - =&gt; + ]</span>
<a href="#l4.206"></a><span id="l4.206" class="difflineplus">+  toggle_folder_pane();</span>
<a href="#l4.207"></a><span id="l4.207" class="difflineplus">+  assert_folder_pane_visible();</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineplus">+}</span>
<a href="#l4.209"></a><span id="l4.209" class="difflineplus">+</span>
<a href="#l4.210"></a><span id="l4.210" class="difflineplus">+/**</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineplus">+ * Test that if we serialize and restore the tabs then the folder pane is in the</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineplus">+ * expected collapsed/non-collapsed state. Because of the special &quot;first tab&quot;</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineplus">+ * situation, we need to do this twice to test each case for the first tab.  For</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineplus">+ * additional thoroughness we also flip the state we have the other tabs be in.</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineplus">+ */</span>
<a href="#l4.216"></a><span id="l4.216" class="difflineplus">+function test_folder_pane_persistence_generally_works() {</span>
<a href="#l4.217"></a><span id="l4.217" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineplus">+</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineplus">+  // helper to open tabs with the folder pane in the desired states (1 for</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineplus">+  //  visible, 0 for hidden)</span>
<a href="#l4.221"></a><span id="l4.221" class="difflineplus">+  function openTabs(aConfig) {</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineplus">+    let curState;</span>
<a href="#l4.223"></a><span id="l4.223" class="difflineplus">+    for (let [iTab, folderPaneVisible] in Iterator(aConfig)) {</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineplus">+      if (iTab == 0) {</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineplus">+        curState = folderPaneVisible;</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineplus">+      }</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineplus">+      else {</span>
<a href="#l4.228"></a><span id="l4.228" class="difflineplus">+        open_folder_in_new_tab(folder);</span>
<a href="#l4.229"></a><span id="l4.229" class="difflineplus">+        if (curState != folderPaneVisible) {</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineplus">+          toggle_folder_pane();</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineplus">+          curState = folderPaneVisible;</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineplus">+        }</span>
<a href="#l4.233"></a><span id="l4.233" class="difflineplus">+      }</span>
<a href="#l4.234"></a><span id="l4.234" class="difflineplus">+    }</span>
<a href="#l4.235"></a><span id="l4.235" class="difflineplus">+  }</span>
<a href="#l4.236"></a><span id="l4.236" class="difflineplus">+</span>
<a href="#l4.237"></a><span id="l4.237" class="difflineplus">+  // close everything but the first tab.</span>
<a href="#l4.238"></a><span id="l4.238" class="difflineplus">+  function closeTabs() {</span>
<a href="#l4.239"></a><span id="l4.239" class="difflineplus">+    while (mc.tabmail.tabInfo.length &gt; 1)</span>
<a href="#l4.240"></a><span id="l4.240" class="difflineplus">+      mc.tabmail.closeTab(1);</span>
<a href="#l4.241"></a><span id="l4.241" class="difflineplus">+  }</span>
<a href="#l4.242"></a><span id="l4.242" class="difflineplus">+</span>
<a href="#l4.243"></a><span id="l4.243" class="difflineplus">+  function verifyTabs(aConfig) {</span>
<a href="#l4.244"></a><span id="l4.244" class="difflineplus">+    for (let [iTab, folderPaneVisible] in Iterator(aConfig)) {</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineplus">+      switch_tab(iTab);</span>
<a href="#l4.246"></a><span id="l4.246" class="difflineplus">+      dump(&quot; checking tab: &quot; + iTab + &quot;\n&quot;);</span>
<a href="#l4.247"></a><span id="l4.247" class="difflineplus">+      if (folderPaneVisible)</span>
<a href="#l4.248"></a><span id="l4.248" class="difflineplus">+        assert_folder_pane_visible();</span>
<a href="#l4.249"></a><span id="l4.249" class="difflineplus">+      else</span>
<a href="#l4.250"></a><span id="l4.250" class="difflineplus">+        assert_folder_pane_hidden();</span>
<a href="#l4.251"></a><span id="l4.251" class="difflineplus">+    }</span>
<a href="#l4.252"></a><span id="l4.252" class="difflineplus">+  }</span>
<a href="#l4.253"></a><span id="l4.253" class="difflineplus">+</span>
<a href="#l4.254"></a><span id="l4.254" class="difflineplus">+  let configs = [</span>
<a href="#l4.255"></a><span id="l4.255" class="difflineplus">+    // 1st time: [+ - - + +]</span>
<a href="#l4.256"></a><span id="l4.256" class="difflineplus">+    [1, 0, 0, 1, 1],</span>
<a href="#l4.257"></a><span id="l4.257" class="difflineplus">+    // 2nd time: [- + + - -]</span>
<a href="#l4.258"></a><span id="l4.258" class="difflineplus">+    [0, 1, 1, 0, 0]</span>
<a href="#l4.259"></a><span id="l4.259" class="difflineplus">+  ];</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineplus">+</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineplus">+  for each (let [, config] in Iterator(configs)) {</span>
<a href="#l4.262"></a><span id="l4.262" class="difflineplus">+    openTabs(config);</span>
<a href="#l4.263"></a><span id="l4.263" class="difflineplus">+    verifyTabs(config); // make sure openTabs did its job right</span>
<a href="#l4.264"></a><span id="l4.264" class="difflineplus">+    let state = mc.tabmail.persistTabs();</span>
<a href="#l4.265"></a><span id="l4.265" class="difflineplus">+    closeTabs();</span>
<a href="#l4.266"></a><span id="l4.266" class="difflineplus">+    // toggle the state for the current tab so we can be sure that it knows how</span>
<a href="#l4.267"></a><span id="l4.267" class="difflineplus">+    // to change things.</span>
<a href="#l4.268"></a><span id="l4.268" class="difflineplus">+    toggle_folder_pane();</span>
<a href="#l4.269"></a><span id="l4.269" class="difflineplus">+    mc.tabmail.restoreTabs(state);</span>
<a href="#l4.270"></a><span id="l4.270" class="difflineplus">+    verifyTabs(config);</span>
<a href="#l4.271"></a><span id="l4.271" class="difflineplus">+    closeTabs();</span>
<a href="#l4.272"></a><span id="l4.272" class="difflineplus">+</span>
<a href="#l4.273"></a><span id="l4.273" class="difflineplus">+    // toggle the first tab again.  This sets - properly for the second pass and</span>
<a href="#l4.274"></a><span id="l4.274" class="difflineplus">+    // restores it to + for when we are done.</span>
<a href="#l4.275"></a><span id="l4.275" class="difflineplus">+    toggle_folder_pane();</span>
<a href="#l4.276"></a><span id="l4.276" class="difflineplus">+  }</span>
<a href="#l4.277"></a><span id="l4.277" class="difflineplus">+  // For one last time, make sure.</span>
<a href="#l4.278"></a><span id="l4.278" class="difflineplus">+  assert_folder_pane_visible();</span>
<a href="#l4.279"></a><span id="l4.279" class="difflineplus">+}</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

