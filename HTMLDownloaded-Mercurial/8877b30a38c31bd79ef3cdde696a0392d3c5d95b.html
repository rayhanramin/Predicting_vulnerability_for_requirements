<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 16281:8877b30a38c31bd79ef3cdde696a0392d3c5d95b</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 8877b30a38c31bd79ef3cdde696a0392d3c5d95b" />
<meta property="og:url" content="/comm-central/rev/8877b30a38c31bd79ef3cdde696a0392d3c5d95b" />
<meta property="og:description" content="Bug 790855, part 2: Implement nsIMimeConverter in JS, r=irving, a=me" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 8877b30a38c31bd79ef3cdde696a0392d3c5d95b 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/8877b30a38c31bd79ef3cdde696a0392d3c5d95b">shortlog</a> |
<a href="/comm-central/log/8877b30a38c31bd79ef3cdde696a0392d3c5d95b">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/8877b30a38c31bd79ef3cdde696a0392d3c5d95b">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/8877b30a38c31bd79ef3cdde696a0392d3c5d95b">files</a> |
changeset |
<a href="/comm-central/raw-rev/8877b30a38c31bd79ef3cdde696a0392d3c5d95b">raw</a>  | <a href="/comm-central/archive/8877b30a38c31bd79ef3cdde696a0392d3c5d95b.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=790855">Bug 790855</a>, part 2: Implement nsIMimeConverter in JS, r=irving, a=me
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#115;&#104;&#117;&#97;&#32;&#67;&#114;&#97;&#110;&#109;&#101;&#114;&#32;&#60;&#80;&#105;&#100;&#103;&#101;&#111;&#116;&#49;&#56;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 04 Jun 2014 09:51:36 -0500</td></tr>

<tr>
 <td>changeset 16281</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/8877b30a38c31bd79ef3cdde696a0392d3c5d95b">8877b30a38c31bd79ef3cdde696a0392d3c5d95b</a></td>
</tr>



<tr>
<td>parent 16280</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/29d10e5f69abeb6109790c23b74a6e49c6755224">29d10e5f69abeb6109790c23b74a6e49c6755224</a>
</td>
</tr>

<tr>
<td>child 16282</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/2608fae8b13be280012b5561bbdab12824a8f95a">2608fae8b13be280012b5561bbdab12824a8f95a</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=8877b30a38c31bd79ef3cdde696a0392d3c5d95b">10173</a></td></tr>
<tr><td>push user</td><td>Pidgeot18@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Wed, 04 Jun 2014 16:44:46 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@8877b30a38c3 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=8877b30a38c31bd79ef3cdde696a0392d3c5d95b">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=8877b30a38c31bd79ef3cdde696a0392d3c5d95b&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=8877b30a38c31bd79ef3cdde696a0392d3c5d95b&newProject=comm-central&newRevision=a8d1e10d39b77de6b13e9fff8843feb3d27ec12e&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=8877b30a38c31bd79ef3cdde696a0392d3c5d95b&newProject=comm-central&newRevision=a8d1e10d39b77de6b13e9fff8843feb3d27ec12e&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=8877b30a38c31bd79ef3cdde696a0392d3c5d95b&newProject=comm-central&newRevision=a8d1e10d39b77de6b13e9fff8843feb3d27ec12e&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28irving%29&revcount=50">irving</a>, <a href="/comm-central/log?rev=reviewer%28me%29&revcount=50">me</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=790855">790855</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=790855">Bug 790855</a>, part 2: Implement nsIMimeConverter in JS, r=irving, a=me</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/build/nsMailModule.cpp">mailnews/build/nsMailModule.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/build/nsMailModule.cpp">file</a> |
<a href="/comm-central/annotate/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/build/nsMailModule.cpp">annotate</a> |
<a href="/comm-central/diff/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/build/nsMailModule.cpp">diff</a> |
<a href="/comm-central/comparison/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/build/nsMailModule.cpp">comparison</a> |
<a href="/comm-central/log/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/build/nsMailModule.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/compose/src/nsURLFetcher.cpp">mailnews/compose/src/nsURLFetcher.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/compose/src/nsURLFetcher.cpp">file</a> |
<a href="/comm-central/annotate/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/compose/src/nsURLFetcher.cpp">annotate</a> |
<a href="/comm-central/diff/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/compose/src/nsURLFetcher.cpp">diff</a> |
<a href="/comm-central/comparison/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/compose/src/nsURLFetcher.cpp">comparison</a> |
<a href="/comm-central/log/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/compose/src/nsURLFetcher.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/compose/test/unit/test_attachment.js">mailnews/compose/test/unit/test_attachment.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/compose/test/unit/test_attachment.js">file</a> |
<a href="/comm-central/annotate/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/compose/test/unit/test_attachment.js">annotate</a> |
<a href="/comm-central/diff/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/compose/test/unit/test_attachment.js">diff</a> |
<a href="/comm-central/comparison/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/compose/test/unit/test_attachment.js">comparison</a> |
<a href="/comm-central/log/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/compose/test/unit/test_attachment.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/jsmime/jsmime.js">mailnews/mime/jsmime/jsmime.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/jsmime/jsmime.js">file</a> |
<a href="/comm-central/annotate/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/jsmime/jsmime.js">annotate</a> |
<a href="/comm-central/diff/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/jsmime/jsmime.js">diff</a> |
<a href="/comm-central/comparison/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/jsmime/jsmime.js">comparison</a> |
<a href="/comm-central/log/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/jsmime/jsmime.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/public/nsIMimeConverter.idl">mailnews/mime/public/nsIMimeConverter.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/public/nsIMimeConverter.idl">file</a> |
<a href="/comm-central/annotate/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/public/nsIMimeConverter.idl">annotate</a> |
<a href="/comm-central/diff/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/public/nsIMimeConverter.idl">diff</a> |
<a href="/comm-central/comparison/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/public/nsIMimeConverter.idl">comparison</a> |
<a href="/comm-central/log/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/public/nsIMimeConverter.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/public/nsMsgMimeCID.h">mailnews/mime/public/nsMsgMimeCID.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/public/nsMsgMimeCID.h">file</a> |
<a href="/comm-central/annotate/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/public/nsMsgMimeCID.h">annotate</a> |
<a href="/comm-central/diff/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/public/nsMsgMimeCID.h">diff</a> |
<a href="/comm-central/comparison/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/public/nsMsgMimeCID.h">comparison</a> |
<a href="/comm-central/log/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/public/nsMsgMimeCID.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/comi18n.cpp">mailnews/mime/src/comi18n.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/comi18n.cpp">file</a> |
<a href="/comm-central/annotate/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/comi18n.cpp">annotate</a> |
<a href="/comm-central/diff/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/comi18n.cpp">diff</a> |
<a href="/comm-central/comparison/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/comi18n.cpp">comparison</a> |
<a href="/comm-central/log/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/comi18n.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/comi18n.h">mailnews/mime/src/comi18n.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/comi18n.h">file</a> |
<a href="/comm-central/annotate/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/comi18n.h">annotate</a> |
<a href="/comm-central/diff/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/comi18n.h">diff</a> |
<a href="/comm-central/comparison/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/comi18n.h">comparison</a> |
<a href="/comm-central/log/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/comi18n.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/mimeJSComponents.js">mailnews/mime/src/mimeJSComponents.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/mimeJSComponents.js">file</a> |
<a href="/comm-central/annotate/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/mimeJSComponents.js">annotate</a> |
<a href="/comm-central/diff/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/mimeJSComponents.js">diff</a> |
<a href="/comm-central/comparison/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/mimeJSComponents.js">comparison</a> |
<a href="/comm-central/log/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/mimeJSComponents.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/mimei.cpp">mailnews/mime/src/mimei.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/mimei.cpp">file</a> |
<a href="/comm-central/annotate/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/mimei.cpp">annotate</a> |
<a href="/comm-central/diff/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/mimei.cpp">diff</a> |
<a href="/comm-central/comparison/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/mimei.cpp">comparison</a> |
<a href="/comm-central/log/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/mimei.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/mimemoz2.cpp">mailnews/mime/src/mimemoz2.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/mimemoz2.cpp">file</a> |
<a href="/comm-central/annotate/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/mimemoz2.cpp">annotate</a> |
<a href="/comm-central/diff/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/mimemoz2.cpp">diff</a> |
<a href="/comm-central/comparison/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/mimemoz2.cpp">comparison</a> |
<a href="/comm-central/log/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/mimemoz2.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/moz.build">mailnews/mime/src/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/moz.build">file</a> |
<a href="/comm-central/annotate/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/moz.build">annotate</a> |
<a href="/comm-central/diff/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/moz.build">diff</a> |
<a href="/comm-central/comparison/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/moz.build">comparison</a> |
<a href="/comm-central/log/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/msgMime.manifest">mailnews/mime/src/msgMime.manifest</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/msgMime.manifest">file</a> |
<a href="/comm-central/annotate/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/msgMime.manifest">annotate</a> |
<a href="/comm-central/diff/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/msgMime.manifest">diff</a> |
<a href="/comm-central/comparison/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/msgMime.manifest">comparison</a> |
<a href="/comm-central/log/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/msgMime.manifest">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/nsMimeConverter.cpp">mailnews/mime/src/nsMimeConverter.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/nsMimeConverter.cpp">diff</a> |
<a href="/comm-central/comparison/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/nsMimeConverter.cpp">comparison</a> |
<a href="/comm-central/log/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/nsMimeConverter.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/nsMimeConverter.h">mailnews/mime/src/nsMimeConverter.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/nsMimeConverter.h">diff</a> |
<a href="/comm-central/comparison/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/nsMimeConverter.h">comparison</a> |
<a href="/comm-central/log/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/nsMimeConverter.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/nsStreamConverter.cpp">mailnews/mime/src/nsStreamConverter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/nsStreamConverter.cpp">file</a> |
<a href="/comm-central/annotate/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/nsStreamConverter.cpp">annotate</a> |
<a href="/comm-central/diff/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/nsStreamConverter.cpp">diff</a> |
<a href="/comm-central/comparison/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/nsStreamConverter.cpp">comparison</a> |
<a href="/comm-central/log/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/src/nsStreamConverter.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/test/unit/test_EncodeMimePartIIStr_UTF8.js">mailnews/mime/test/unit/test_EncodeMimePartIIStr_UTF8.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/test/unit/test_EncodeMimePartIIStr_UTF8.js">file</a> |
<a href="/comm-central/annotate/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/test/unit/test_EncodeMimePartIIStr_UTF8.js">annotate</a> |
<a href="/comm-central/diff/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/test/unit/test_EncodeMimePartIIStr_UTF8.js">diff</a> |
<a href="/comm-central/comparison/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/test/unit/test_EncodeMimePartIIStr_UTF8.js">comparison</a> |
<a href="/comm-central/log/8877b30a38c31bd79ef3cdde696a0392d3c5d95b/mailnews/mime/test/unit/test_EncodeMimePartIIStr_UTF8.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/build/nsMailModule.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/build/nsMailModule.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -232,17 +232,16 @@</span>
<a href="#l1.4"></a><span id="l1.4"> #include &quot;nsImapMailDatabase.h&quot;</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l1.7"></a><span id="l1.7"> // mime includes</span>
<a href="#l1.8"></a><span id="l1.8"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l1.9"></a><span id="l1.9"> #include &quot;nsMsgMimeCID.h&quot;</span>
<a href="#l1.10"></a><span id="l1.10"> #include &quot;nsStreamConverter.h&quot;</span>
<a href="#l1.11"></a><span id="l1.11"> #include &quot;nsMimeObjectClassAccess.h&quot;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-#include &quot;nsMimeConverter.h&quot;</span>
<a href="#l1.13"></a><span id="l1.13"> </span>
<a href="#l1.14"></a><span id="l1.14"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l1.15"></a><span id="l1.15"> // mime emitter includes</span>
<a href="#l1.16"></a><span id="l1.16"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l1.17"></a><span id="l1.17"> #include &quot;nsMimeEmitterCID.h&quot;</span>
<a href="#l1.18"></a><span id="l1.18"> #include &quot;nsIMimeEmitter.h&quot;</span>
<a href="#l1.19"></a><span id="l1.19"> #include &quot;nsMimeHtmlEmitter.h&quot;</span>
<a href="#l1.20"></a><span id="l1.20"> #include &quot;nsMimeRawEmitter.h&quot;</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineat">@@ -664,21 +663,19 @@ NS_DEFINE_NAMED_CID(NS_IMAPDB_CID);</span>
<a href="#l1.22"></a><span id="l1.22"> NS_DEFINE_NAMED_CID(NS_MSG_RETENTIONSETTINGS_CID);</span>
<a href="#l1.23"></a><span id="l1.23"> NS_DEFINE_NAMED_CID(NS_MSG_DOWNLOADSETTINGS_CID);</span>
<a href="#l1.24"></a><span id="l1.24"> NS_DEFINE_NAMED_CID(NS_MSGDB_SERVICE_CID);</span>
<a href="#l1.25"></a><span id="l1.25"> </span>
<a href="#l1.26"></a><span id="l1.26"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l1.27"></a><span id="l1.27"> // mime factories</span>
<a href="#l1.28"></a><span id="l1.28"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l1.29"></a><span id="l1.29"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMimeObjectClassAccess)</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-NS_GENERIC_FACTORY_CONSTRUCTOR(nsMimeConverter)</span>
<a href="#l1.31"></a><span id="l1.31"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsStreamConverter)</span>
<a href="#l1.32"></a><span id="l1.32"> </span>
<a href="#l1.33"></a><span id="l1.33"> NS_DEFINE_NAMED_CID(NS_MIME_OBJECT_CLASS_ACCESS_CID);</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-NS_DEFINE_NAMED_CID(NS_MIME_CONVERTER_CID);</span>
<a href="#l1.35"></a><span id="l1.35"> NS_DEFINE_NAMED_CID(NS_MAILNEWS_MIME_STREAM_CONVERTER_CID);</span>
<a href="#l1.36"></a><span id="l1.36"> </span>
<a href="#l1.37"></a><span id="l1.37"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l1.38"></a><span id="l1.38"> // mime emitter factories</span>
<a href="#l1.39"></a><span id="l1.39"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l1.40"></a><span id="l1.40"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMimeRawEmitter)</span>
<a href="#l1.41"></a><span id="l1.41"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMimeXmlEmitter)</span>
<a href="#l1.42"></a><span id="l1.42"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMimePlainEmitter)</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineat">@@ -995,17 +992,16 @@ const mozilla::Module::CIDEntry kMailNew</span>
<a href="#l1.44"></a><span id="l1.44">   { &amp;kNS_MAILDB_CID, false, NULL, nsMailDatabaseConstructor },</span>
<a href="#l1.45"></a><span id="l1.45">   { &amp;kNS_NEWSDB_CID, false, NULL, nsNewsDatabaseConstructor },</span>
<a href="#l1.46"></a><span id="l1.46">   { &amp;kNS_IMAPDB_CID, false, NULL, nsImapMailDatabaseConstructor },</span>
<a href="#l1.47"></a><span id="l1.47">   { &amp;kNS_MSG_RETENTIONSETTINGS_CID, false, NULL, nsMsgRetentionSettingsConstructor },</span>
<a href="#l1.48"></a><span id="l1.48">   { &amp;kNS_MSG_DOWNLOADSETTINGS_CID, false, NULL, nsMsgDownloadSettingsConstructor },</span>
<a href="#l1.49"></a><span id="l1.49">   { &amp;kNS_MSGDB_SERVICE_CID, false, NULL, nsMsgDBServiceConstructor },</span>
<a href="#l1.50"></a><span id="l1.50">   // Mime Entries</span>
<a href="#l1.51"></a><span id="l1.51">   { &amp;kNS_MIME_OBJECT_CLASS_ACCESS_CID, false, NULL, nsMimeObjectClassAccessConstructor },</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-  { &amp;kNS_MIME_CONVERTER_CID, false, NULL, nsMimeConverterConstructor },</span>
<a href="#l1.53"></a><span id="l1.53">   { &amp;kNS_MAILNEWS_MIME_STREAM_CONVERTER_CID, false, NULL, nsStreamConverterConstructor },</span>
<a href="#l1.54"></a><span id="l1.54">   { &amp;kNS_HTML_MIME_EMITTER_CID, false, NULL, nsMimeHtmlDisplayEmitterConstructor},</span>
<a href="#l1.55"></a><span id="l1.55">   { &amp;kNS_XML_MIME_EMITTER_CID, false, NULL, nsMimeXmlEmitterConstructor},</span>
<a href="#l1.56"></a><span id="l1.56">   { &amp;kNS_PLAIN_MIME_EMITTER_CID, false, NULL, nsMimePlainEmitterConstructor},</span>
<a href="#l1.57"></a><span id="l1.57">   { &amp;kNS_RAW_MIME_EMITTER_CID, false, NULL, nsMimeRawEmitterConstructor},</span>
<a href="#l1.58"></a><span id="l1.58">   // Fts 3</span>
<a href="#l1.59"></a><span id="l1.59">   { &amp;kNS_FTS3TOKENIZER_CID, false, NULL, nsFts3TokenizerConstructor },</span>
<a href="#l1.60"></a><span id="l1.60">   // News Entries</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineat">@@ -1219,17 +1215,16 @@ const mozilla::Module::ContractIDEntry k</span>
<a href="#l1.62"></a><span id="l1.62">   { NS_MAILBOXDB_CONTRACTID, &amp;kNS_MAILDB_CID },</span>
<a href="#l1.63"></a><span id="l1.63">   { NS_NEWSDB_CONTRACTID, &amp;kNS_NEWSDB_CID },</span>
<a href="#l1.64"></a><span id="l1.64">   { NS_IMAPDB_CONTRACTID, &amp;kNS_IMAPDB_CID },</span>
<a href="#l1.65"></a><span id="l1.65">   { NS_MSG_RETENTIONSETTINGS_CONTRACTID, &amp;kNS_MSG_RETENTIONSETTINGS_CID },</span>
<a href="#l1.66"></a><span id="l1.66">   { NS_MSG_DOWNLOADSETTINGS_CONTRACTID, &amp;kNS_MSG_DOWNLOADSETTINGS_CID },</span>
<a href="#l1.67"></a><span id="l1.67">   { NS_MSGDB_SERVICE_CONTRACTID, &amp;kNS_MSGDB_SERVICE_CID },</span>
<a href="#l1.68"></a><span id="l1.68">   // Mime Entries</span>
<a href="#l1.69"></a><span id="l1.69">   { NS_MIME_OBJECT_CONTRACTID, &amp;kNS_MIME_OBJECT_CLASS_ACCESS_CID },</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineminus">-  { NS_MIME_CONVERTER_CONTRACTID, &amp;kNS_MIME_CONVERTER_CID },</span>
<a href="#l1.71"></a><span id="l1.71">   { NS_MAILNEWS_MIME_STREAM_CONVERTER_CONTRACTID, &amp;kNS_MAILNEWS_MIME_STREAM_CONVERTER_CID },</span>
<a href="#l1.72"></a><span id="l1.72">   { NS_MAILNEWS_MIME_STREAM_CONVERTER_CONTRACTID1, &amp;kNS_MAILNEWS_MIME_STREAM_CONVERTER_CID },</span>
<a href="#l1.73"></a><span id="l1.73">   { NS_MAILNEWS_MIME_STREAM_CONVERTER_CONTRACTID2, &amp;kNS_MAILNEWS_MIME_STREAM_CONVERTER_CID },</span>
<a href="#l1.74"></a><span id="l1.74">   { NS_HTML_MIME_EMITTER_CONTRACTID, &amp;kNS_HTML_MIME_EMITTER_CID },</span>
<a href="#l1.75"></a><span id="l1.75">   { NS_XML_MIME_EMITTER_CONTRACTID, &amp;kNS_XML_MIME_EMITTER_CID },</span>
<a href="#l1.76"></a><span id="l1.76">   { NS_PLAIN_MIME_EMITTER_CONTRACTID, &amp;kNS_PLAIN_MIME_EMITTER_CID },</span>
<a href="#l1.77"></a><span id="l1.77">   { NS_RAW_MIME_EMITTER_CONTRACTID, &amp;kNS_RAW_MIME_EMITTER_CID },</span>
<a href="#l1.78"></a><span id="l1.78">   // FTS3</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/compose/src/nsURLFetcher.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/compose/src/nsURLFetcher.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -6,17 +6,16 @@</span>
<a href="#l2.4"></a><span id="l2.4"> #include &quot;nsURLFetcher.h&quot;</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6"> #include &quot;msgCore.h&quot; // for pre-compiled headers</span>
<a href="#l2.7"></a><span id="l2.7"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l2.8"></a><span id="l2.8"> #include &lt;stdio.h&gt;</span>
<a href="#l2.9"></a><span id="l2.9"> #include &quot;nscore.h&quot;</span>
<a href="#l2.10"></a><span id="l2.10"> #include &quot;nsIFactory.h&quot;</span>
<a href="#l2.11"></a><span id="l2.11"> #include &quot;nsISupports.h&quot;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-#include &quot;comi18n.h&quot;</span>
<a href="#l2.13"></a><span id="l2.13"> #include &quot;prmem.h&quot;</span>
<a href="#l2.14"></a><span id="l2.14"> #include &quot;plstr.h&quot;</span>
<a href="#l2.15"></a><span id="l2.15"> #include &quot;nsIComponentManager.h&quot;</span>
<a href="#l2.16"></a><span id="l2.16"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l2.17"></a><span id="l2.17"> #include &quot;nsIIOService.h&quot;</span>
<a href="#l2.18"></a><span id="l2.18"> #include &quot;nsIChannel.h&quot;</span>
<a href="#l2.19"></a><span id="l2.19"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l2.20"></a><span id="l2.20"> #include &quot;nsMimeTypes.h&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_attachment.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_attachment.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -14,68 +14,72 @@ const input0 = &quot; !\&quot;#$%&amp;'()*+,-./0123456</span>
<a href="#l3.4"></a><span id="l3.4">     &quot;\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf&quot;+</span>
<a href="#l3.5"></a><span id="l3.5">     &quot;\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef&quot;+</span>
<a href="#l3.6"></a><span id="l3.6">     &quot;\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff.txt&quot;</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8"> // ascii only</span>
<a href="#l3.9"></a><span id="l3.9"> const input1 = &quot; !\&quot;#$%&amp;'()*+,-./0123456789:;&lt;=&gt;?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_&quot;+</span>
<a href="#l3.10"></a><span id="l3.10">     &quot;`abcdefghijklmnopqrstuvwxyz{|}~.txt&quot;</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-const expectedCD0 = &quot;Content-Disposition: attachment;\r\n&quot;+</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-    &quot; filename*0*=ISO-8859-1''%20%21%22%23%24%25%26%27%28%29%2A%2B%2C%2D%2E%2F;\r\n&quot;+</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-    &quot; filename*1*=%30%31%32%33%34%35%36%37%38%39%3A%3B%3C%3D%3E%3F%40%41%42%43;\r\n&quot;+</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-    &quot; filename*2*=%44%45%46%47%48%49%4A%4B%4C%4D%4E%4F%50%51%52%53%54%55%56%57;\r\n&quot;+</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-    &quot; filename*3*=%58%59%5A%5B%5C%5D%5E%5F%60%61%62%63%64%65%66%67%68%69%6A%6B;\r\n&quot;+</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-    &quot; filename*4*=%6C%6D%6E%6F%70%71%72%73%74%75%76%77%78%79%7A%7B%7C%7D%7E%A0;\r\n&quot;+</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-    &quot; filename*5*=%A1%A2%A3%A4%A5%A6%A7%A8%A9%AA%AB%AC%AD%AE%AF%B0%B1%B2%B3%B4;\r\n&quot;+</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-    &quot; filename*6*=%B5%B6%B7%B8%B9%BA%BB%BC%BD%BE%BF%C0%C1%C2%C3%C4%C5%C6%C7%C8;\r\n&quot;+</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-    &quot; filename*7*=%C9%CA%CB%CC%CD%CE%CF%D0%D1%D2%D3%D4%D5%D6%D7%D8%D9%DA%DB%DC;\r\n&quot;+</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-    &quot; filename*8*=%DD%DE%DF%E0%E1%E2%E3%E4%E5%E6%E7%E8%E9%EA%EB%EC%ED%EE%EF%F0;\r\n&quot;+</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-    &quot; filename*9*=%F1%F2%F3%F4%F5%F6%F7%F8%F9%FA%FB%FC%FD%FE%FF%2E%74%78%74\r\n&quot;;</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+const expectedCD0 = [&quot;Content-Disposition: attachment;&quot;,</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+  &quot; filename*0*=UTF-8''%20%21%22%23%24%25%26%27%28%29%2A%2B%2C%2D%2E%2F%30%31;&quot;,</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+  &quot; filename*1*=%32%33%34%35%36%37%38%39%3A%3B%3C%3D%3E%3F%40%41%42%43%44%45;&quot;,</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+  &quot; filename*2*=%46%47%48%49%4A%4B%4C%4D%4E%4F%50%51%52%53%54%55%56%57%58%59;&quot;,</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+  &quot; filename*3*=%5A%5B%5C%5D%5E%5F%60%61%62%63%64%65%66%67%68%69%6A%6B%6C%6D;&quot;,</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+  &quot; filename*4*=%6E%6F%70%71%72%73%74%75%76%77%78%79%7A%7B%7C%7D%7E%C2%A0%C2;&quot;,</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+  &quot; filename*5*=%A1%C2%A2%C2%A3%C2%A4%C2%A5%C2%A6%C2%A7%C2%A8%C2%A9%C2%AA%C2;&quot;,</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+  &quot; filename*6*=%AB%C2%AC%C2%AD%C2%AE%C2%AF%C2%B0%C2%B1%C2%B2%C2%B3%C2%B4%C2;&quot;,</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+  &quot; filename*7*=%B5%C2%B6%C2%B7%C2%B8%C2%B9%C2%BA%C2%BB%C2%BC%C2%BD%C2%BE%C2;&quot;,</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+  &quot; filename*8*=%BF%C3%80%C3%81%C3%82%C3%83%C3%84%C3%85%C3%86%C3%87%C3%88%C3;&quot;,</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+  &quot; filename*9*=%89%C3%8A%C3%8B%C3%8C%C3%8D%C3%8E%C3%8F%C3%90%C3%91%C3%92%C3;&quot;,</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+  &quot; filename*10*=%93%C3%94%C3%95%C3%96%C3%97%C3%98%C3%99%C3%9A%C3%9B%C3%9C;&quot;,</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+  &quot; filename*11*=%C3%9D%C3%9E%C3%9F%C3%A0%C3%A1%C3%A2%C3%A3%C3%A4%C3%A5%C3;&quot;,</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+  &quot; filename*12*=%A6%C3%A7%C3%A8%C3%A9%C3%AA%C3%AB%C3%AC%C3%AD%C3%AE%C3%AF;&quot;,</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+  &quot; filename*13*=%C3%B0%C3%B1%C3%B2%C3%B3%C3%B4%C3%B5%C3%B6%C3%B7%C3%B8%C3;&quot;,</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+  &quot; filename*14*=%B9%C3%BA%C3%BB%C3%BC%C3%BD%C3%BE%C3%BF%2E%74%78%74&quot;,</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+  &quot;&quot;].join(&quot;\r\n&quot;);</span>
<a href="#l3.40"></a><span id="l3.40"> </span>
<a href="#l3.41"></a><span id="l3.41"> const expectedCD1 = &quot;Content-Disposition: attachment;\r\n&quot;+</span>
<a href="#l3.42"></a><span id="l3.42">     ' filename*0=&quot; !\\&quot;#$%&amp;\'()*+,-./0123456789:;&lt;=&gt;?@ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;;\r\n'+</span>
<a href="#l3.43"></a><span id="l3.43">     ' filename*1=&quot;[\\\\]^_`abcdefghijklmnopqrstuvwxyz{|}~.txt&quot;\r\n';</span>
<a href="#l3.44"></a><span id="l3.44"> </span>
<a href="#l3.45"></a><span id="l3.45"> const ParamFoldingPref = {</span>
<a href="#l3.46"></a><span id="l3.46">   RFC2047: 0,</span>
<a href="#l3.47"></a><span id="l3.47">   RFC2047WithCRLF: 1,</span>
<a href="#l3.48"></a><span id="l3.48">   RFC2231: 2</span>
<a href="#l3.49"></a><span id="l3.49"> }</span>
<a href="#l3.50"></a><span id="l3.50"> </span>
<a href="#l3.51"></a><span id="l3.51"> const expectedCTList0 = {</span>
<a href="#l3.52"></a><span id="l3.52">   RFC2047: 'Content-Type: text/plain; charset=US-ASCII;\r\n'+</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">-           ' name=&quot; =?ISO-8859-1?Q?!=22=23=24=25=26=27=28=29*+=2C-=2E/0123456789=3A=3B=3C=3D?='+</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-           '=?ISO-8859-1?Q?=3E=3F=40ABCDEFGHIJKLMNOPQRSTUVWXYZ=5B=5C=5D=5E=5F=60abcd?='+</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineminus">-           '=?ISO-8859-1?Q?efghijklmnopqrstuvwxyz=7B=7C=7D=7E=A0=A1=A2=A3=A4=A5=A6=A7?='+</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineminus">-           '=?ISO-8859-1?Q?=A8=A9=AA=AB=AC=AD=AE=AF=B0=B1=B2=B3=B4=B5=B6=B7=B8=B9=BA?='+</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">-           '=?ISO-8859-1?Q?=BB=BC=BD=BE=BF=C0=C1=C2=C3=C4=C5=C6=C7=C8=C9=CA=CB=CC=CD?='+</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">-           '=?ISO-8859-1?Q?=CE=CF=D0=D1=D2=D3=D4=D5=D6=D7=D8=D9=DA=DB=DC=DD=DE=DF=E0?='+</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineminus">-           '=?ISO-8859-1?Q?=E1=E2=E3=E4=E5=E6=E7=E8=E9=EA=EB=EC=ED=EE=EF=F0=F1=F2=F3?='+</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineminus">-           '=?ISO-8859-1?Q?=F4=F5=F6=F7=F8=F9=FA=FB=FC=FD=FE=FF=2Etxt?=&quot;\r\n',</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+           ' name=&quot;=?UTF-8?Q?_!=22#$%&amp;\'=28=29*+,-./0123456789:;&lt;=3d&gt;=3f@ABCDEFGHIJKLMNO?='+</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+           '=?UTF-8?Q?PQRSTUVWXYZ[\\\\]^=5f`abcdefghijklmnopqrstuvwxyz{|}~=c2=a0?='+</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+           '=?UTF-8?B?wqHCosKjwqTCpcKmwqfCqMKpwqrCq8Kswq3CrsKvwrDCscKywrPCtMK1?='+</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+           '=?UTF-8?B?wrbCt8K4wrnCusK7wrzCvcK+wr/DgMOBw4LDg8OEw4XDhsOHw4jDicOK?='+</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+           '=?UTF-8?B?w4vDjMONw47Dj8OQw5HDksOTw5TDlcOWw5fDmMOZw5rDm8Ocw53DnsOf?='+</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+           '=?UTF-8?B?w6DDocOiw6PDpMOlw6bDp8Oow6nDqsOrw6zDrcOuw6/DsMOxw7LDs8O0?='+</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+           '=?UTF-8?B?w7XDtsO3w7jDucO6w7vDvMO9w77Dvy50eHQ=?=&quot;\r\n',</span>
<a href="#l3.68"></a><span id="l3.68"> </span>
<a href="#l3.69"></a><span id="l3.69">   RFC2047WithCRLF: 'Content-Type: text/plain; charset=US-ASCII;\r\n'+</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineminus">-                   ' name=&quot; =?ISO-8859-1?Q?!=22=23=24=25=26=27=28=29*+=2C-=2E/0123456789=3A=3B=3C=3D?=\r\n'+</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineminus">-                   ' =?ISO-8859-1?Q?=3E=3F=40ABCDEFGHIJKLMNOPQRSTUVWXYZ=5B=5C=5D=5E=5F=60abcd?=\r\n'+</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineminus">-                   ' =?ISO-8859-1?Q?efghijklmnopqrstuvwxyz=7B=7C=7D=7E=A0=A1=A2=A3=A4=A5=A6=A7?=\r\n'+</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineminus">-                   ' =?ISO-8859-1?Q?=A8=A9=AA=AB=AC=AD=AE=AF=B0=B1=B2=B3=B4=B5=B6=B7=B8=B9=BA?=\r\n'+</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineminus">-                   ' =?ISO-8859-1?Q?=BB=BC=BD=BE=BF=C0=C1=C2=C3=C4=C5=C6=C7=C8=C9=CA=CB=CC=CD?=\r\n'+</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineminus">-                   ' =?ISO-8859-1?Q?=CE=CF=D0=D1=D2=D3=D4=D5=D6=D7=D8=D9=DA=DB=DC=DD=DE=DF=E0?=\r\n'+</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineminus">-                   ' =?ISO-8859-1?Q?=E1=E2=E3=E4=E5=E6=E7=E8=E9=EA=EB=EC=ED=EE=EF=F0=F1=F2=F3?=\r\n'+</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineminus">-                   ' =?ISO-8859-1?Q?=F4=F5=F6=F7=F8=F9=FA=FB=FC=FD=FE=FF=2Etxt?=&quot;\r\n',</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+                   ' name=&quot;=?UTF-8?Q?_!=22#$%&amp;\'=28=29*+,-./0123456789:;&lt;=3d&gt;=3f@ABCDEFGHIJKLMNO?=\r\n'+</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+                   ' =?UTF-8?Q?PQRSTUVWXYZ[\\\\]^=5f`abcdefghijklmnopqrstuvwxyz{|}~=c2=a0?=\r\n'+</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+                   ' =?UTF-8?B?wqHCosKjwqTCpcKmwqfCqMKpwqrCq8Kswq3CrsKvwrDCscKywrPCtMK1?=\r\n'+</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+                   ' =?UTF-8?B?wrbCt8K4wrnCusK7wrzCvcK+wr/DgMOBw4LDg8OEw4XDhsOHw4jDicOK?=\r\n'+</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+                   ' =?UTF-8?B?w4vDjMONw47Dj8OQw5HDksOTw5TDlcOWw5fDmMOZw5rDm8Ocw53DnsOf?=\r\n'+</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+                   ' =?UTF-8?B?w6DDocOiw6PDpMOlw6bDp8Oow6nDqsOrw6zDrcOuw6/DsMOxw7LDs8O0?=\r\n'+</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+                   ' =?UTF-8?B?w7XDtsO3w7jDucO6w7vDvMO9w77Dvy50eHQ=?=&quot;\r\n',</span>
<a href="#l3.85"></a><span id="l3.85"> </span>
<a href="#l3.86"></a><span id="l3.86">   RFC2231: 'Content-Type: text/plain; charset=US-ASCII\r\n'</span>
<a href="#l3.87"></a><span id="l3.87"> }</span>
<a href="#l3.88"></a><span id="l3.88"> </span>
<a href="#l3.89"></a><span id="l3.89"> const expectedCTList1 = {</span>
<a href="#l3.90"></a><span id="l3.90">   RFC2047: 'Content-Type: text/plain; charset=US-ASCII;\r\n'+</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineminus">-           ' name=&quot; !\\&quot;#$%&amp;\'()*+,-./0123456789:;&lt;=&gt;?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\\\]^_`abcdefghijklmnopqrstuvwxyz{|}~.txt&quot;\r\n',</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+           ' name=&quot;!\\&quot;#$%&amp;\'()*+,-./0123456789:;&lt;=&gt;?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\\\]^_`abcdefghijklmnopqrstuvwxyz{|}~.txt&quot;\r\n',</span>
<a href="#l3.93"></a><span id="l3.93"> </span>
<a href="#l3.94"></a><span id="l3.94">   RFC2047WithCRLF: 'Content-Type: text/plain; charset=US-ASCII;\r\n'+</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineminus">-                   ' name=&quot; !\\&quot;#$%&amp;\'()*+,-./0123456789:;&lt;=&gt;?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\\\]^_`abcdefghijklmnopqrstuvwxyz{|}~.txt&quot;\r\n',</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+                   ' name=&quot;\r\n !\\&quot;#$%&amp;\'()*+,-./0123456789:;&lt;=&gt;?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\\\]^_`abcdefghijklmnopqrstuvwxyz{|}~.txt&quot;\r\n',</span>
<a href="#l3.97"></a><span id="l3.97"> </span>
<a href="#l3.98"></a><span id="l3.98">   RFC2231: 'Content-Type: text/plain; charset=US-ASCII\r\n'</span>
<a href="#l3.99"></a><span id="l3.99"> }</span>
<a href="#l3.100"></a><span id="l3.100"> </span>
<a href="#l3.101"></a><span id="l3.101"> function checkAttachment(expectedCD, expectedCT) {</span>
<a href="#l3.102"></a><span id="l3.102">   let msgData = mailTestUtils</span>
<a href="#l3.103"></a><span id="l3.103">     .loadMessageToString(gDraftFolder, mailTestUtils.firstMsgHdr(gDraftFolder));</span>
<a href="#l3.104"></a><span id="l3.104">   let pos = msgData.indexOf(&quot;Content-Disposition:&quot;);</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineat">@@ -126,21 +130,11 @@ function testInput1() {</span>
<a href="#l3.106"></a><span id="l3.106"> }</span>
<a href="#l3.107"></a><span id="l3.107"> </span>
<a href="#l3.108"></a><span id="l3.108"> var tests = [</span>
<a href="#l3.109"></a><span id="l3.109">   testInput0,</span>
<a href="#l3.110"></a><span id="l3.110">   testInput1</span>
<a href="#l3.111"></a><span id="l3.111"> ]</span>
<a href="#l3.112"></a><span id="l3.112"> </span>
<a href="#l3.113"></a><span id="l3.113"> function run_test() {</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineminus">-  // This test assumes mailnews.send_default_charset ISO-8859-1...</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineminus">-  let str = Components.classes[&quot;@mozilla.org/pref-localizedstring;1&quot;]</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineminus">-                      .createInstance(Components.interfaces.nsIPrefLocalizedString);</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineminus">-  str.data = &quot;ISO-8859-1&quot;;</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineminus">-  Services.prefs.setComplexValue(&quot;mailnews.send_default_charset&quot;,</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineminus">-                                 Components.interfaces.nsIPrefLocalizedString, str);</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineminus">-  do_register_cleanup(function() {</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineminus">-    Services.prefs.clearUserPref(&quot;mailnews.send_default_charset&quot;);</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineminus">-  });</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineminus">-</span>
<a href="#l3.124"></a><span id="l3.124">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l3.125"></a><span id="l3.125">   async_run_tests(tests);</span>
<a href="#l3.126"></a><span id="l3.126"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/mime/jsmime/jsmime.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/mime/jsmime/jsmime.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -2806,16 +2806,19 @@ HeaderEmitter.prototype.addAddresses = f</span>
<a href="#l4.4"></a><span id="l4.4">  * Add an unstructured header value to the output. This effectively means only</span>
<a href="#l4.5"></a><span id="l4.5">  * inserting line breaks were necessary, and using RFC 2047 encoding where</span>
<a href="#l4.6"></a><span id="l4.6">  * necessary.</span>
<a href="#l4.7"></a><span id="l4.7">  *</span>
<a href="#l4.8"></a><span id="l4.8">  * @public</span>
<a href="#l4.9"></a><span id="l4.9">  * @param {String} text The text to add to the output.</span>
<a href="#l4.10"></a><span id="l4.10">  */</span>
<a href="#l4.11"></a><span id="l4.11"> HeaderEmitter.prototype.addUnstructured = function (text) {</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+  if (text.length == 0)</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+    return;</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+</span>
<a href="#l4.15"></a><span id="l4.15">   // Unstructured text is basically a phrase that can't be quoted. So, if we</span>
<a href="#l4.16"></a><span id="l4.16">   // have nothing in qchars, nothing should be quoted.</span>
<a href="#l4.17"></a><span id="l4.17">   this.addPhrase(text, &quot;&quot;, false);</span>
<a href="#l4.18"></a><span id="l4.18"> };</span>
<a href="#l4.19"></a><span id="l4.19"> </span>
<a href="#l4.20"></a><span id="l4.20"> /**</span>
<a href="#l4.21"></a><span id="l4.21">  * Signal that the current header has been finished encoding.</span>
<a href="#l4.22"></a><span id="l4.22">  *</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/mime/public/nsIMimeConverter.idl</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/mime/public/nsIMimeConverter.idl</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -6,43 +6,42 @@</span>
<a href="#l5.4"></a><span id="l5.4"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l5.5"></a><span id="l5.5"> </span>
<a href="#l5.6"></a><span id="l5.6"> /**</span>
<a href="#l5.7"></a><span id="l5.7">  * Encode/decode mail headers (via libmime).</span>
<a href="#l5.8"></a><span id="l5.8">  */</span>
<a href="#l5.9"></a><span id="l5.9"> [scriptable, uuid(0d3f5531-2dbe-40d3-9280-f6ac45a6f5e0)]</span>
<a href="#l5.10"></a><span id="l5.10"> interface nsIMimeConverter : nsISupports {</span>
<a href="#l5.11"></a><span id="l5.11">   /**</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-   * Suggested byte length limit for use when calling</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-   * encodeMimePartIIStr(_UTF8).</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+   * Suggested byte length limit for use when calling encodeMimePartIIStr_UTF8.</span>
<a href="#l5.15"></a><span id="l5.15">    */</span>
<a href="#l5.16"></a><span id="l5.16">   const long MIME_ENCODED_WORD_SIZE = 72;</span>
<a href="#l5.17"></a><span id="l5.17">   const long MAX_CHARSET_NAME_LENGTH = 64;</span>
<a href="#l5.18"></a><span id="l5.18"> </span>
<a href="#l5.19"></a><span id="l5.19">   /**</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineminus">-   * Encode a UTF-8 CString into RFC 2047 form (&quot;=?&quot; charset &quot;?&quot; encoding &quot;?&quot;</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineminus">-   * encoded-text &quot;?=&quot;, where encoding is either &quot;B&quot; for BASE64 (RFC 2045) or</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineminus">-   * &quot;Q&quot; for quoted-printable-ish (RFC 2045)).</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+   * Encode a UTF-8 string into a form containing only ASCII characters using</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+   * RFC 2047 encoded words where necessary.</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+   *</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+   * Note that, although allowed for the present time, encoding to charsets</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+   * other than UTF-8 is considered deprecated.</span>
<a href="#l5.28"></a><span id="l5.28">    *</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineminus">-   * @param header UTF-8 header to encode.</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-   * @param structured Is the header's field-body a &quot;structured&quot; field?</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-   *     (Encoded words are only allowed in comment/phrase portions of</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-   *     structured field bodies.)</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-   * @param mailCharset Charset name to convert (as an ASCII C string).</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-   * @param fieldnamelen Header field name lengt (ex: &quot;From: &quot; = 6)</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-   * @param encodedWordSize Byte length limit of the output, usually 72. (Use</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineminus">-   *     MIME_ENCODED_WORD_SIZE.)</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+   * @param aHeader           UTF-8 header to encode.</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+   * @param aAddressingHeader Is the header a list of email addresses?</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+   * @param aMailCharset      Charset to use when encoding (see above for note).</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+   * @param aFieldNameLen     Header field name length (ex: &quot;From: &quot; = 6)</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+   * @param aMaxLineLen       Maximum length of an individual line. Use</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+   *                          MIME_ENCODED_WORD_SIZE for best results.</span>
<a href="#l5.43"></a><span id="l5.43">    *</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-   * @return The encoded buffer (as a C string).</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+   * @return                  The encoded header.</span>
<a href="#l5.46"></a><span id="l5.46">    */</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineminus">-  AUTF8String encodeMimePartIIStr_UTF8(in AUTF8String header,</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineminus">-                                       in boolean     structured,</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineminus">-                                       in string      mailCharset,</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineminus">-                                       in long        fieldnamelen,</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineminus">-                                       in long        encodedWordSize);</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+  AUTF8String encodeMimePartIIStr_UTF8(in AUTF8String aHeader,</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+                                       in boolean     aAddressingHeader,</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+                                       in string      aMailCharset,</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+                                       in long        aFieldNameLen,</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+                                       in long        aMaxLineLen);</span>
<a href="#l5.57"></a><span id="l5.57"> </span>
<a href="#l5.58"></a><span id="l5.58">   /**</span>
<a href="#l5.59"></a><span id="l5.59">    * Decode a MIME header to UTF-8 if conversion is required.  Marked as</span>
<a href="#l5.60"></a><span id="l5.60">    * noscript because the return value may contain non-ASCII characters.</span>
<a href="#l5.61"></a><span id="l5.61">    *</span>
<a href="#l5.62"></a><span id="l5.62">    * @param header A (possibly encoded) header to decode.</span>
<a href="#l5.63"></a><span id="l5.63">    * @param default_charset The charset to apply to un-labeled non-UTF-8 data.</span>
<a href="#l5.64"></a><span id="l5.64">    * @param override_charset If true, default_charset is used instead of any</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/mime/public/nsMsgMimeCID.h</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/mime/public/nsMsgMimeCID.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -17,21 +17,16 @@</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5"> #define NS_MAILNEWS_MIME_STREAM_CONVERTER_CID                    \</span>
<a href="#l6.6"></a><span id="l6.6"> { /* FAF4F9A6-60AD-11d3-989A-001083010E9B */         \</span>
<a href="#l6.7"></a><span id="l6.7">  0xfaf4f9a6, 0x60ad, 0x11d3, { 0x98, 0x9a, 0x0, 0x10, 0x83, 0x1, 0xe, 0x9b } }</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9"> #define NS_MIME_CONVERTER_CONTRACTID \</span>
<a href="#l6.10"></a><span id="l6.10">   &quot;@mozilla.org/messenger/mimeconverter;1&quot;</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-// {866A1E11-D0B9-11d2-B373-525400E2D63A}</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-#define NS_MIME_CONVERTER_CID   \</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-        { 0x866a1e11, 0xd0b9, 0x11d2,         \</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-        { 0xb3, 0x73, 0x52, 0x54, 0x0, 0xe2, 0xd6, 0x3a } }</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-</span>
<a href="#l6.17"></a><span id="l6.17"> // {403B0540-B7C3-11d2-B35E-525400E2D63A}</span>
<a href="#l6.18"></a><span id="l6.18"> #define NS_MIME_OBJECT_CLASS_ACCESS_CID   \</span>
<a href="#l6.19"></a><span id="l6.19">         { 0x403b0540, 0xb7c3, 0x11d2,         \</span>
<a href="#l6.20"></a><span id="l6.20">         { 0xb3, 0x5e, 0x52, 0x54, 0x0, 0xe2, 0xd6, 0x3a } }</span>
<a href="#l6.21"></a><span id="l6.21"> </span>
<a href="#l6.22"></a><span id="l6.22"> #define NS_MIME_OBJECT_CONTRACTID \</span>
<a href="#l6.23"></a><span id="l6.23">   &quot;@mozilla.org/messenger/mimeobject;1&quot;</span>
<a href="#l6.24"></a><span id="l6.24"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/mime/src/comi18n.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/mime/src/comi18n.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1,687 +1,24 @@</span>
<a href="#l7.4"></a><span id="l7.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l7.5"></a><span id="l7.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.6"></a><span id="l7.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.7"></a><span id="l7.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9" class="difflineminus">-#include &quot;nsICharsetConverterManager.h&quot;</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineminus">-#include &lt;stdio.h&gt;</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineminus">-#include &lt;stdlib.h&gt;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-#include &lt;string.h&gt;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-#include &lt;assert.h&gt;</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-#include &quot;prmem.h&quot;</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-#include &quot;prlog.h&quot;</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-#include &quot;prprf.h&quot;</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-#include &quot;plstr.h&quot;</span>
<a href="#l7.18"></a><span id="l7.18"> #include &quot;comi18n.h&quot;</span>
<a href="#l7.19"></a><span id="l7.19"> #include &quot;nsIStringCharsetDetector.h&quot;</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">-#include &quot;nsIPrefService.h&quot;</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">-#include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l7.22"></a><span id="l7.22"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-#include &quot;mimebuf.h&quot;</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">-#include &quot;nsIMimeConverter.h&quot;</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineminus">-#include &quot;nsMsgI18N.h&quot;</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-#include &quot;nsMimeTypes.h&quot;</span>
<a href="#l7.27"></a><span id="l7.27"> #include &quot;nsICharsetConverterManager.h&quot;</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-#include &quot;nsISaveAsCharset.h&quot;</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-#include &quot;mimehdrs.h&quot;</span>
<a href="#l7.30"></a><span id="l7.30"> #include &quot;nsIMIMEHeaderParam.h&quot;</span>
<a href="#l7.31"></a><span id="l7.31"> #include &quot;nsNetCID.h&quot;</span>
<a href="#l7.32"></a><span id="l7.32"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l7.33"></a><span id="l7.33"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-#include &quot;nsMemory.h&quot;</span>
<a href="#l7.35"></a><span id="l7.35"> </span>
<a href="#l7.36"></a><span id="l7.36"> </span>
<a href="#l7.37"></a><span id="l7.37"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineminus">-</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-static char basis_64[] =</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">-   &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;;</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineminus">-</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineminus">-#define NO_Q_ENCODING_NEEDED(ch)  \</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-  (((ch) &gt;= 'a' &amp;&amp; (ch) &lt;= 'z') || ((ch) &gt;= 'A' &amp;&amp; (ch) &lt;= 'Z') || \</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineminus">-   ((ch) &gt;= '0' &amp;&amp; (ch) &lt;= '9') ||  (ch) == '!' || (ch) == '*' ||  \</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineminus">-    (ch) == '+' || (ch) == '-' || (ch) == '/')</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineminus">-</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineminus">-static const char hexdigits[] = &quot;0123456789ABCDEF&quot;;</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineminus">-</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-static int32_t</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-intlmime_encode_q(const unsigned char *src, int32_t srcsize, char *out)</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-{</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-  const unsigned char *in = (unsigned char *) src;</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-  const unsigned char *end = in + srcsize;</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-  char *head = out;</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineminus">-</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineminus">-  for (; in &lt; end; in++) {</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineminus">-    if (NO_Q_ENCODING_NEEDED(*in)) {</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineminus">-      *out++ = *in;</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineminus">-    }</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineminus">-    else if (*in == ' ') {</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineminus">-      *out++ = '_';</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineminus">-    }</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineminus">-    else {</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineminus">-      *out++ = '=';</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineminus">-      *out++ = hexdigits[*in &gt;&gt; 4];</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineminus">-      *out++ = hexdigits[*in &amp; 0xF];</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineminus">-    }</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineminus">-  }</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineminus">-  *out = '\0';</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineminus">-  return (out - head);</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineminus">-}</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineminus">-</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineminus">-static void</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineminus">-encodeChunk(const unsigned char* chunk, char* output)</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineminus">-{</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineminus">-  register int32_t offset;</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineminus">-</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineminus">-  offset = *chunk &gt;&gt; 2;</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineminus">-  *output++ = basis_64[offset];</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineminus">-</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineminus">-  offset = ((*chunk &lt;&lt; 4) &amp; 0x30) + (*(chunk+1) &gt;&gt; 4);</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineminus">-  *output++ = basis_64[offset];</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineminus">-</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineminus">-  if (*(chunk+1)) {</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineminus">-    offset = ((*(chunk+1) &amp; 0x0f) &lt;&lt; 2) + ((*(chunk+2) &amp; 0xc0) &gt;&gt; 6);</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineminus">-    *output++ = basis_64[offset];</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineminus">-  }</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineminus">-  else</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineminus">-    *output++ = '=';</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineminus">-</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineminus">-  if (*(chunk+2)) {</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineminus">-    offset = *(chunk+2) &amp; 0x3f;</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineminus">-    *output++ = basis_64[offset];</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineminus">-  }</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineminus">-  else</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineminus">-    *output++ = '=';</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineminus">-}</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineminus">-</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineminus">-static int32_t</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineminus">-intlmime_encode_b(const unsigned char* input, int32_t inlen, char* output)</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineminus">-{</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineminus">-  unsigned char  chunk[3];</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineminus">-  int32_t   i, len;</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineminus">-  char *head = output;</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineminus">-</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineminus">-  for (len = 0; inlen &gt;=3 ; inlen -= 3) {</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineminus">-    for (i = 0; i &lt; 3; i++)</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineminus">-      chunk[i] = *input++;</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineminus">-    encodeChunk(chunk, output);</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineminus">-    output += 4;</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineminus">-    len += 4;</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineminus">-  }</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineminus">-</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineminus">-  if (inlen &gt; 0) {</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineminus">-    for (i = 0; i &lt; inlen; i++)</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineminus">-      chunk[i] = *input++;</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineminus">-    for (; i &lt; 3; i++)</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineminus">-      chunk[i] = 0;</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineminus">-    encodeChunk(chunk, output);</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineminus">-    output += 4;</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineminus">-  }</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineminus">-</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineminus">-  *output = 0;</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineminus">-  return (output - head);</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineminus">-}</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineminus">-</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineminus">-</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineminus">-/*      some utility function used by this file */</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineminus">-static bool intlmime_only_ascii_str(const char *s)</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineminus">-{</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineminus">-  for(; *s; s++)</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineminus">-    if(*s &amp; 0x80)</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineminus">-      return false;</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineminus">-  return true;</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineminus">-}</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineminus">-</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineminus">-</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineminus">-#define IS_UTF8_HEADER(s, h) ((*(s) &amp; (~(~(h) &gt;&gt; 1))) == (h))</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineminus">-#define IS_UTF8_SUBBYTE(s) ((*(s) &amp; 0xC0) == 0x80)</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineminus">-static unsigned char * utf8_nextchar(unsigned char *str)</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineminus">-{</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineminus">-  if (*str &lt; 0x80)</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineminus">-    return (str + 1);</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineminus">-  if (IS_UTF8_HEADER(str, 0xC0) &amp;&amp;</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineminus">-      IS_UTF8_SUBBYTE(str + 1))</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineminus">-    return (str + 2);</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineminus">-  if (IS_UTF8_HEADER(str, 0xE0) &amp;&amp;</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineminus">-      IS_UTF8_SUBBYTE(str + 1) &amp;&amp;</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineminus">-      IS_UTF8_SUBBYTE(str + 2) )</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineminus">-    return (str + 3);</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineminus">-  if (IS_UTF8_HEADER(str, 0xF0) &amp;&amp;</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineminus">-      IS_UTF8_SUBBYTE(str + 1) &amp;&amp;</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineminus">-      IS_UTF8_SUBBYTE(str + 2) &amp;&amp;</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineminus">-      IS_UTF8_SUBBYTE(str + 3) )</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineminus">-    return (str + 4);</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineminus">-  // error, return + 1 to avoid infinite loop</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineminus">-  return (str + 1); </span>
<a href="#l7.158"></a><span id="l7.158" class="difflineminus">-}</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineminus">-#undef IS_UTF8_HEADER</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineminus">-#undef IS_UTF8_SUBBYTE</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineminus">-</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineminus">-/* -------------- */</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineminus">-</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineminus">-static</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineminus">-int32_t generate_encodedwords(char *pUTF8, const char *charset, char method, char *output, int32_t outlen, int32_t output_carryoverlen, int32_t foldlen, bool foldingonly)</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineminus">-{</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineminus">-  nsCOMPtr &lt;nsISaveAsCharset&gt; conv;</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineminus">-  char16_t *_pUCS2 = nullptr, *pUCS2 = nullptr, *pUCS2Head = nullptr, cUCS2Tmp = 0;</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineminus">-  char  *ibuf, *o = output;</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineminus">-  char  encodedword_head[nsIMimeConverter::MAX_CHARSET_NAME_LENGTH+4+1];</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineminus">-  nsAutoCString _charset;</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineminus">-  char  *pUTF8Head = nullptr, cUTF8Tmp = 0;</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineminus">-  int32_t   olen = 0, obufsize = outlen, offset, linelen = output_carryoverlen, convlen = 0;</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineminus">-  int32_t   encodedword_headlen = 0, encodedword_taillen = foldingonly ? 0 : 2; // &quot;?=&quot;</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineminus">-  nsresult rv;</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineminus">-</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineminus">-  encodedword_head[0] = 0;</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineminus">-</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineminus">-  if (!foldingonly) {</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineminus">-</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineminus">-    // Deal with UCS2 pointer</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineminus">-    pUCS2 = _pUCS2 = ToNewUnicode(NS_ConvertUTF8toUTF16(pUTF8));</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineminus">-    if (!pUCS2)</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineminus">-      return -1;</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineminus">-</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineminus">-    // Resolve charset alias</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineminus">-    {</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineminus">-      nsCOMPtr&lt;nsICharsetConverterManager&gt; ccm =</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineminus">-        do_GetService(NS_CHARSETCONVERTERMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineminus">-</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineminus">-      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineminus">-        charset = !PL_strcasecmp(charset, &quot;us-ascii&quot;) ? &quot;ISO-8859-1&quot; : charset;</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineminus">-        rv = ccm-&gt;GetCharsetAlias(charset, _charset);</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineminus">-      }</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineminus">-      if (NS_FAILED(rv)) {</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineminus">-        if (_pUCS2)</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineminus">-          nsMemory::Free(_pUCS2);</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineminus">-        return -1;</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineminus">-      }</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineminus">-</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineminus">-      // this is so nasty, but _charset won't be going away..</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineminus">-      charset = _charset.get();</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineminus">-    }</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineminus">-</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineminus">-    // Prepare MIME encoded-word head with official charset name</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineminus">-    if (!PR_snprintf(encodedword_head, sizeof(encodedword_head)-1, &quot;=?%s?%c?&quot;, charset, method)) {</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineminus">-      if (_pUCS2)</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineminus">-        nsMemory::Free(_pUCS2);</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineminus">-      return -1;</span>
<a href="#l7.210"></a><span id="l7.210" class="difflineminus">-    }</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineminus">-    encodedword_headlen = strlen(encodedword_head);</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineminus">-</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineminus">-    // Create an instance of charset converter and initialize it</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineminus">-    conv = do_CreateInstance(NS_SAVEASCHARSET_CONTRACTID, &amp;rv);</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineminus">-    if(NS_SUCCEEDED(rv)) {</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineminus">-      rv = conv-&gt;Init(charset,</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineminus">-                       nsISaveAsCharset::attr_FallbackQuestionMark + nsISaveAsCharset::attr_EntityAfterCharsetConv,</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineminus">-                       nsIEntityConverter::transliterate);</span>
<a href="#l7.219"></a><span id="l7.219" class="difflineminus">-    }</span>
<a href="#l7.220"></a><span id="l7.220" class="difflineminus">-    if (NS_FAILED(rv)) {</span>
<a href="#l7.221"></a><span id="l7.221" class="difflineminus">-      if (_pUCS2)</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineminus">-        nsMemory::Free(_pUCS2);</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineminus">-      return -1;</span>
<a href="#l7.224"></a><span id="l7.224" class="difflineminus">-    }</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineminus">-  } // if (!foldingonly)</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineminus">-</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineminus">-  /*</span>
<a href="#l7.228"></a><span id="l7.228" class="difflineminus">-     See if folding needs to happen.</span>
<a href="#l7.229"></a><span id="l7.229" class="difflineminus">-     If carried over length is already too long to hold</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineminus">-     encoded-word header and trailer length, it's too obvious</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineminus">-     that we need to fold.  So, don't waste time for calculation.</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineminus">-  */</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineminus">-  if (linelen + encodedword_headlen + encodedword_taillen &lt; foldlen) {</span>
<a href="#l7.234"></a><span id="l7.234" class="difflineminus">-    if (foldingonly) {</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineminus">-      offset = strlen(pUTF8Head = pUTF8);</span>
<a href="#l7.236"></a><span id="l7.236" class="difflineminus">-      pUTF8 += offset;</span>
<a href="#l7.237"></a><span id="l7.237" class="difflineminus">-    }</span>
<a href="#l7.238"></a><span id="l7.238" class="difflineminus">-    else {</span>
<a href="#l7.239"></a><span id="l7.239" class="difflineminus">-      rv = conv-&gt;Convert(pUCS2, &amp;ibuf);</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineminus">-      if (NS_FAILED(rv) || ibuf == nullptr) {</span>
<a href="#l7.241"></a><span id="l7.241" class="difflineminus">-        if (_pUCS2)</span>
<a href="#l7.242"></a><span id="l7.242" class="difflineminus">-          nsMemory::Free(_pUCS2);</span>
<a href="#l7.243"></a><span id="l7.243" class="difflineminus">-        return -1; //error</span>
<a href="#l7.244"></a><span id="l7.244" class="difflineminus">-      }</span>
<a href="#l7.245"></a><span id="l7.245" class="difflineminus">-      if (method == 'B') {</span>
<a href="#l7.246"></a><span id="l7.246" class="difflineminus">-        /* 4 / 3 = B encoding multiplier */</span>
<a href="#l7.247"></a><span id="l7.247" class="difflineminus">-        offset = strlen(ibuf) * 4 / 3;</span>
<a href="#l7.248"></a><span id="l7.248" class="difflineminus">-      }</span>
<a href="#l7.249"></a><span id="l7.249" class="difflineminus">-      else {</span>
<a href="#l7.250"></a><span id="l7.250" class="difflineminus">-        /* 3 = Q encoding multiplier */</span>
<a href="#l7.251"></a><span id="l7.251" class="difflineminus">-        offset = 0;</span>
<a href="#l7.252"></a><span id="l7.252" class="difflineminus">-        for (int32_t i = 0; *(ibuf+i); i++)</span>
<a href="#l7.253"></a><span id="l7.253" class="difflineminus">-          offset += NO_Q_ENCODING_NEEDED(*(ibuf+i)) ? 1 : 3;</span>
<a href="#l7.254"></a><span id="l7.254" class="difflineminus">-      }</span>
<a href="#l7.255"></a><span id="l7.255" class="difflineminus">-    }</span>
<a href="#l7.256"></a><span id="l7.256" class="difflineminus">-    if (linelen + encodedword_headlen + offset + encodedword_taillen &gt; foldlen) {</span>
<a href="#l7.257"></a><span id="l7.257" class="difflineminus">-      /* folding has to happen */</span>
<a href="#l7.258"></a><span id="l7.258" class="difflineminus">-      if (foldingonly) {</span>
<a href="#l7.259"></a><span id="l7.259" class="difflineminus">-        pUTF8 = pUTF8Head;</span>
<a href="#l7.260"></a><span id="l7.260" class="difflineminus">-        pUTF8Head = nullptr;</span>
<a href="#l7.261"></a><span id="l7.261" class="difflineminus">-      }</span>
<a href="#l7.262"></a><span id="l7.262" class="difflineminus">-      else</span>
<a href="#l7.263"></a><span id="l7.263" class="difflineminus">-        PR_Free(ibuf);</span>
<a href="#l7.264"></a><span id="l7.264" class="difflineminus">-    }</span>
<a href="#l7.265"></a><span id="l7.265" class="difflineminus">-    else {</span>
<a href="#l7.266"></a><span id="l7.266" class="difflineminus">-      /* no folding needed, let's fall thru */</span>
<a href="#l7.267"></a><span id="l7.267" class="difflineminus">-      PL_strncpyz(o, encodedword_head, obufsize);</span>
<a href="#l7.268"></a><span id="l7.268" class="difflineminus">-      olen += encodedword_headlen;</span>
<a href="#l7.269"></a><span id="l7.269" class="difflineminus">-      linelen += encodedword_headlen;</span>
<a href="#l7.270"></a><span id="l7.270" class="difflineminus">-      obufsize -= encodedword_headlen;</span>
<a href="#l7.271"></a><span id="l7.271" class="difflineminus">-      o += encodedword_headlen;</span>
<a href="#l7.272"></a><span id="l7.272" class="difflineminus">-      if (!foldingonly)</span>
<a href="#l7.273"></a><span id="l7.273" class="difflineminus">-        *pUCS2 = 0;</span>
<a href="#l7.274"></a><span id="l7.274" class="difflineminus">-    }</span>
<a href="#l7.275"></a><span id="l7.275" class="difflineminus">-  }</span>
<a href="#l7.276"></a><span id="l7.276" class="difflineminus">-  else {</span>
<a href="#l7.277"></a><span id="l7.277" class="difflineminus">-    PL_strncpyz(o, &quot;\r\n &quot;, obufsize);</span>
<a href="#l7.278"></a><span id="l7.278" class="difflineminus">-    olen += 3;</span>
<a href="#l7.279"></a><span id="l7.279" class="difflineminus">-    o += 3;</span>
<a href="#l7.280"></a><span id="l7.280" class="difflineminus">-    obufsize -= 3;</span>
<a href="#l7.281"></a><span id="l7.281" class="difflineminus">-    linelen = 1;</span>
<a href="#l7.282"></a><span id="l7.282" class="difflineminus">-  }</span>
<a href="#l7.283"></a><span id="l7.283" class="difflineminus">-</span>
<a href="#l7.284"></a><span id="l7.284" class="difflineminus">-  /*</span>
<a href="#l7.285"></a><span id="l7.285" class="difflineminus">-    Let's do the nasty RFC-2047 &amp; folding stuff</span>
<a href="#l7.286"></a><span id="l7.286" class="difflineminus">-  */</span>
<a href="#l7.287"></a><span id="l7.287" class="difflineminus">-</span>
<a href="#l7.288"></a><span id="l7.288" class="difflineminus">-  while ((foldingonly ? *pUTF8 : *pUCS2) &amp;&amp; (olen &lt; outlen)) {</span>
<a href="#l7.289"></a><span id="l7.289" class="difflineminus">-    PL_strncpyz(o, encodedword_head, obufsize);</span>
<a href="#l7.290"></a><span id="l7.290" class="difflineminus">-    olen += encodedword_headlen;</span>
<a href="#l7.291"></a><span id="l7.291" class="difflineminus">-    linelen += encodedword_headlen;</span>
<a href="#l7.292"></a><span id="l7.292" class="difflineminus">-    obufsize -= encodedword_headlen;</span>
<a href="#l7.293"></a><span id="l7.293" class="difflineminus">-    o += encodedword_headlen;</span>
<a href="#l7.294"></a><span id="l7.294" class="difflineminus">-    olen += encodedword_taillen;</span>
<a href="#l7.295"></a><span id="l7.295" class="difflineminus">-    if (foldingonly)</span>
<a href="#l7.296"></a><span id="l7.296" class="difflineminus">-      pUTF8Head = pUTF8;</span>
<a href="#l7.297"></a><span id="l7.297" class="difflineminus">-    else</span>
<a href="#l7.298"></a><span id="l7.298" class="difflineminus">-      pUCS2Head = pUCS2;</span>
<a href="#l7.299"></a><span id="l7.299" class="difflineminus">-</span>
<a href="#l7.300"></a><span id="l7.300" class="difflineminus">-    while ((foldingonly ? *pUTF8 : *pUCS2) &amp;&amp; (olen &lt; outlen)) {</span>
<a href="#l7.301"></a><span id="l7.301" class="difflineminus">-      if (foldingonly) {</span>
<a href="#l7.302"></a><span id="l7.302" class="difflineminus">-        ++pUTF8;</span>
<a href="#l7.303"></a><span id="l7.303" class="difflineminus">-        for (;;) {</span>
<a href="#l7.304"></a><span id="l7.304" class="difflineminus">-          if (*pUTF8 == ' ' || *pUTF8 == '\t' || !*pUTF8) {</span>
<a href="#l7.305"></a><span id="l7.305" class="difflineminus">-            offset = pUTF8 - pUTF8Head;</span>
<a href="#l7.306"></a><span id="l7.306" class="difflineminus">-            cUTF8Tmp = *pUTF8;</span>
<a href="#l7.307"></a><span id="l7.307" class="difflineminus">-            *pUTF8 = 0;</span>
<a href="#l7.308"></a><span id="l7.308" class="difflineminus">-            break;</span>
<a href="#l7.309"></a><span id="l7.309" class="difflineminus">-          }</span>
<a href="#l7.310"></a><span id="l7.310" class="difflineminus">-          ++pUTF8;</span>
<a href="#l7.311"></a><span id="l7.311" class="difflineminus">-        }</span>
<a href="#l7.312"></a><span id="l7.312" class="difflineminus">-      }</span>
<a href="#l7.313"></a><span id="l7.313" class="difflineminus">-      else {</span>
<a href="#l7.314"></a><span id="l7.314" class="difflineminus">-        convlen = ++pUCS2 - pUCS2Head;</span>
<a href="#l7.315"></a><span id="l7.315" class="difflineminus">-        cUCS2Tmp = *(pUCS2Head + convlen);</span>
<a href="#l7.316"></a><span id="l7.316" class="difflineminus">-        *(pUCS2Head + convlen) = 0;</span>
<a href="#l7.317"></a><span id="l7.317" class="difflineminus">-        rv = conv-&gt;Convert(pUCS2Head, &amp;ibuf);</span>
<a href="#l7.318"></a><span id="l7.318" class="difflineminus">-        *(pUCS2Head + convlen) = cUCS2Tmp;</span>
<a href="#l7.319"></a><span id="l7.319" class="difflineminus">-        if (NS_FAILED(rv) || ibuf == nullptr) {</span>
<a href="#l7.320"></a><span id="l7.320" class="difflineminus">-          if (_pUCS2)</span>
<a href="#l7.321"></a><span id="l7.321" class="difflineminus">-            nsMemory::Free(_pUCS2);</span>
<a href="#l7.322"></a><span id="l7.322" class="difflineminus">-          return -1; //error</span>
<a href="#l7.323"></a><span id="l7.323" class="difflineminus">-        }</span>
<a href="#l7.324"></a><span id="l7.324" class="difflineminus">-        if (method == 'B') {</span>
<a href="#l7.325"></a><span id="l7.325" class="difflineminus">-          /* 4 / 3 = B encoding multiplier */</span>
<a href="#l7.326"></a><span id="l7.326" class="difflineminus">-          offset = strlen(ibuf) * 4 / 3;</span>
<a href="#l7.327"></a><span id="l7.327" class="difflineminus">-        }</span>
<a href="#l7.328"></a><span id="l7.328" class="difflineminus">-        else {</span>
<a href="#l7.329"></a><span id="l7.329" class="difflineminus">-          /* 3 = Q encoding multiplier */</span>
<a href="#l7.330"></a><span id="l7.330" class="difflineminus">-          offset = 0;</span>
<a href="#l7.331"></a><span id="l7.331" class="difflineminus">-          for (int32_t i = 0; *(ibuf+i); i++)</span>
<a href="#l7.332"></a><span id="l7.332" class="difflineminus">-            offset += NO_Q_ENCODING_NEEDED(*(ibuf+i)) ? 1 : 3;</span>
<a href="#l7.333"></a><span id="l7.333" class="difflineminus">-        }</span>
<a href="#l7.334"></a><span id="l7.334" class="difflineminus">-      }</span>
<a href="#l7.335"></a><span id="l7.335" class="difflineminus">-      if (linelen + offset &gt; foldlen) {</span>
<a href="#l7.336"></a><span id="l7.336" class="difflineminus">-process_lastline:</span>
<a href="#l7.337"></a><span id="l7.337" class="difflineminus">-        int32_t enclen;</span>
<a href="#l7.338"></a><span id="l7.338" class="difflineminus">-        if (foldingonly) {</span>
<a href="#l7.339"></a><span id="l7.339" class="difflineminus">-          PL_strncpyz(o, pUTF8Head, obufsize);</span>
<a href="#l7.340"></a><span id="l7.340" class="difflineminus">-          enclen = strlen(o);</span>
<a href="#l7.341"></a><span id="l7.341" class="difflineminus">-          obufsize -= enclen;</span>
<a href="#l7.342"></a><span id="l7.342" class="difflineminus">-          o += enclen;</span>
<a href="#l7.343"></a><span id="l7.343" class="difflineminus">-          *pUTF8 = cUTF8Tmp;</span>
<a href="#l7.344"></a><span id="l7.344" class="difflineminus">-        }</span>
<a href="#l7.345"></a><span id="l7.345" class="difflineminus">-        else {</span>
<a href="#l7.346"></a><span id="l7.346" class="difflineminus">-          if (method == 'B')</span>
<a href="#l7.347"></a><span id="l7.347" class="difflineminus">-            enclen = intlmime_encode_b((const unsigned char *)ibuf, strlen(ibuf), o);</span>
<a href="#l7.348"></a><span id="l7.348" class="difflineminus">-          else</span>
<a href="#l7.349"></a><span id="l7.349" class="difflineminus">-            enclen = intlmime_encode_q((const unsigned char *)ibuf, strlen(ibuf), o);</span>
<a href="#l7.350"></a><span id="l7.350" class="difflineminus">-          PR_Free(ibuf);</span>
<a href="#l7.351"></a><span id="l7.351" class="difflineminus">-          o += enclen;</span>
<a href="#l7.352"></a><span id="l7.352" class="difflineminus">-          obufsize -= enclen;</span>
<a href="#l7.353"></a><span id="l7.353" class="difflineminus">-          PL_strncpyz(o, &quot;?=&quot;, obufsize);</span>
<a href="#l7.354"></a><span id="l7.354" class="difflineminus">-        }</span>
<a href="#l7.355"></a><span id="l7.355" class="difflineminus">-        o += encodedword_taillen;</span>
<a href="#l7.356"></a><span id="l7.356" class="difflineminus">-        obufsize -= encodedword_taillen;</span>
<a href="#l7.357"></a><span id="l7.357" class="difflineminus">-        olen += enclen;</span>
<a href="#l7.358"></a><span id="l7.358" class="difflineminus">-        if (foldingonly ? *pUTF8 : *pUCS2) { /* not last line */</span>
<a href="#l7.359"></a><span id="l7.359" class="difflineminus">-          PL_strncpyz(o, &quot;\r\n &quot;, obufsize);</span>
<a href="#l7.360"></a><span id="l7.360" class="difflineminus">-          obufsize -= 3;</span>
<a href="#l7.361"></a><span id="l7.361" class="difflineminus">-          o += 3;</span>
<a href="#l7.362"></a><span id="l7.362" class="difflineminus">-          olen += 3;</span>
<a href="#l7.363"></a><span id="l7.363" class="difflineminus">-          linelen = 1;</span>
<a href="#l7.364"></a><span id="l7.364" class="difflineminus">-          if (foldingonly) {</span>
<a href="#l7.365"></a><span id="l7.365" class="difflineminus">-            pUTF8Head = nullptr;</span>
<a href="#l7.366"></a><span id="l7.366" class="difflineminus">-            if (*pUTF8 == ' ' || *pUTF8 == '\t') {</span>
<a href="#l7.367"></a><span id="l7.367" class="difflineminus">-              ++pUTF8;</span>
<a href="#l7.368"></a><span id="l7.368" class="difflineminus">-              if (!*pUTF8)</span>
<a href="#l7.369"></a><span id="l7.369" class="difflineminus">-                return 0;</span>
<a href="#l7.370"></a><span id="l7.370" class="difflineminus">-            }</span>
<a href="#l7.371"></a><span id="l7.371" class="difflineminus">-          }</span>
<a href="#l7.372"></a><span id="l7.372" class="difflineminus">-        }</span>
<a href="#l7.373"></a><span id="l7.373" class="difflineminus">-        else {</span>
<a href="#l7.374"></a><span id="l7.374" class="difflineminus">-          if (_pUCS2)</span>
<a href="#l7.375"></a><span id="l7.375" class="difflineminus">-            nsMemory::Free(_pUCS2);</span>
<a href="#l7.376"></a><span id="l7.376" class="difflineminus">-          return linelen + enclen + encodedword_taillen;</span>
<a href="#l7.377"></a><span id="l7.377" class="difflineminus">-        }</span>
<a href="#l7.378"></a><span id="l7.378" class="difflineminus">-        break;</span>
<a href="#l7.379"></a><span id="l7.379" class="difflineminus">-      }</span>
<a href="#l7.380"></a><span id="l7.380" class="difflineminus">-      else {</span>
<a href="#l7.381"></a><span id="l7.381" class="difflineminus">-        if (foldingonly)</span>
<a href="#l7.382"></a><span id="l7.382" class="difflineminus">-          *pUTF8 = cUTF8Tmp;</span>
<a href="#l7.383"></a><span id="l7.383" class="difflineminus">-        else {</span>
<a href="#l7.384"></a><span id="l7.384" class="difflineminus">-          if (*pUCS2)</span>
<a href="#l7.385"></a><span id="l7.385" class="difflineminus">-            PR_Free(ibuf);</span>
<a href="#l7.386"></a><span id="l7.386" class="difflineminus">-        }</span>
<a href="#l7.387"></a><span id="l7.387" class="difflineminus">-      }</span>
<a href="#l7.388"></a><span id="l7.388" class="difflineminus">-    }</span>
<a href="#l7.389"></a><span id="l7.389" class="difflineminus">-  }</span>
<a href="#l7.390"></a><span id="l7.390" class="difflineminus">-</span>
<a href="#l7.391"></a><span id="l7.391" class="difflineminus">-  goto process_lastline;</span>
<a href="#l7.392"></a><span id="l7.392" class="difflineminus">-}</span>
<a href="#l7.393"></a><span id="l7.393" class="difflineminus">-</span>
<a href="#l7.394"></a><span id="l7.394" class="difflineminus">-typedef struct _RFC822AddressList {</span>
<a href="#l7.395"></a><span id="l7.395" class="difflineminus">-  char        *displayname;</span>
<a href="#l7.396"></a><span id="l7.396" class="difflineminus">-  bool        asciionly;</span>
<a href="#l7.397"></a><span id="l7.397" class="difflineminus">-  char        *addrspec;</span>
<a href="#l7.398"></a><span id="l7.398" class="difflineminus">-  struct _RFC822AddressList *next;</span>
<a href="#l7.399"></a><span id="l7.399" class="difflineminus">-} RFC822AddressList;</span>
<a href="#l7.400"></a><span id="l7.400" class="difflineminus">-</span>
<a href="#l7.401"></a><span id="l7.401" class="difflineminus">-static</span>
<a href="#l7.402"></a><span id="l7.402" class="difflineminus">-void destroy_addresslist(RFC822AddressList *p)</span>
<a href="#l7.403"></a><span id="l7.403" class="difflineminus">-{</span>
<a href="#l7.404"></a><span id="l7.404" class="difflineminus">-  if (p-&gt;next)</span>
<a href="#l7.405"></a><span id="l7.405" class="difflineminus">-    destroy_addresslist(p-&gt;next);</span>
<a href="#l7.406"></a><span id="l7.406" class="difflineminus">-  PR_FREEIF(p-&gt;displayname);</span>
<a href="#l7.407"></a><span id="l7.407" class="difflineminus">-  PR_FREEIF(p-&gt;addrspec);</span>
<a href="#l7.408"></a><span id="l7.408" class="difflineminus">-  PR_Free(p);</span>
<a href="#l7.409"></a><span id="l7.409" class="difflineminus">-  return;</span>
<a href="#l7.410"></a><span id="l7.410" class="difflineminus">-}</span>
<a href="#l7.411"></a><span id="l7.411" class="difflineminus">-</span>
<a href="#l7.412"></a><span id="l7.412" class="difflineminus">-static</span>
<a href="#l7.413"></a><span id="l7.413" class="difflineminus">-RFC822AddressList * construct_addresslist(char *s)</span>
<a href="#l7.414"></a><span id="l7.414" class="difflineminus">-{</span>
<a href="#l7.415"></a><span id="l7.415" class="difflineminus">-  bool    quoted = false, angle_addr = false;</span>
<a href="#l7.416"></a><span id="l7.416" class="difflineminus">-  int32_t  comment = 0;</span>
<a href="#l7.417"></a><span id="l7.417" class="difflineminus">-  char *displayname = nullptr, *addrspec = nullptr;</span>
<a href="#l7.418"></a><span id="l7.418" class="difflineminus">-  static RFC822AddressList  listinit;</span>
<a href="#l7.419"></a><span id="l7.419" class="difflineminus">-  RFC822AddressList  *listhead = (RFC822AddressList *)PR_Malloc(sizeof(RFC822AddressList));</span>
<a href="#l7.420"></a><span id="l7.420" class="difflineminus">-  RFC822AddressList  *list = listhead;</span>
<a href="#l7.421"></a><span id="l7.421" class="difflineminus">-</span>
<a href="#l7.422"></a><span id="l7.422" class="difflineminus">-  if (!list)</span>
<a href="#l7.423"></a><span id="l7.423" class="difflineminus">-    return nullptr;</span>
<a href="#l7.424"></a><span id="l7.424" class="difflineminus">-</span>
<a href="#l7.425"></a><span id="l7.425" class="difflineminus">-  while (*s == ' ' || *s == '\t')</span>
<a href="#l7.426"></a><span id="l7.426" class="difflineminus">-    ++s;</span>
<a href="#l7.427"></a><span id="l7.427" class="difflineminus">-</span>
<a href="#l7.428"></a><span id="l7.428" class="difflineminus">-  for (*list = listinit; *s; ++s) {</span>
<a href="#l7.429"></a><span id="l7.429" class="difflineminus">-    if (*s == '\\') {</span>
<a href="#l7.430"></a><span id="l7.430" class="difflineminus">-      if (quoted || comment) {</span>
<a href="#l7.431"></a><span id="l7.431" class="difflineminus">-        ++s;</span>
<a href="#l7.432"></a><span id="l7.432" class="difflineminus">-        continue;</span>
<a href="#l7.433"></a><span id="l7.433" class="difflineminus">-      }</span>
<a href="#l7.434"></a><span id="l7.434" class="difflineminus">-    }</span>
<a href="#l7.435"></a><span id="l7.435" class="difflineminus">-    else if (*s == '(' || *s == ')') {</span>
<a href="#l7.436"></a><span id="l7.436" class="difflineminus">-      if (!quoted) {</span>
<a href="#l7.437"></a><span id="l7.437" class="difflineminus">-        if (*s == '(') {</span>
<a href="#l7.438"></a><span id="l7.438" class="difflineminus">-          if (comment++ == 0)</span>
<a href="#l7.439"></a><span id="l7.439" class="difflineminus">-            displayname = s + 1;</span>
<a href="#l7.440"></a><span id="l7.440" class="difflineminus">-        }</span>
<a href="#l7.441"></a><span id="l7.441" class="difflineminus">-        else {</span>
<a href="#l7.442"></a><span id="l7.442" class="difflineminus">-          if (--comment == 0) {</span>
<a href="#l7.443"></a><span id="l7.443" class="difflineminus">-            *s = '\0';</span>
<a href="#l7.444"></a><span id="l7.444" class="difflineminus">-            PR_FREEIF(list-&gt;displayname);</span>
<a href="#l7.445"></a><span id="l7.445" class="difflineminus">-            list-&gt;displayname = displayname ? strdup(displayname) : nullptr;</span>
<a href="#l7.446"></a><span id="l7.446" class="difflineminus">-            list-&gt;asciionly = intlmime_only_ascii_str(displayname);</span>
<a href="#l7.447"></a><span id="l7.447" class="difflineminus">-            *s = ')';</span>
<a href="#l7.448"></a><span id="l7.448" class="difflineminus">-          }</span>
<a href="#l7.449"></a><span id="l7.449" class="difflineminus">-        }</span>
<a href="#l7.450"></a><span id="l7.450" class="difflineminus">-        continue;</span>
<a href="#l7.451"></a><span id="l7.451" class="difflineminus">-      }</span>
<a href="#l7.452"></a><span id="l7.452" class="difflineminus">-    }</span>
<a href="#l7.453"></a><span id="l7.453" class="difflineminus">-    else if (*s == '&quot;') {</span>
<a href="#l7.454"></a><span id="l7.454" class="difflineminus">-      if (!comment &amp;&amp; !angle_addr) {</span>
<a href="#l7.455"></a><span id="l7.455" class="difflineminus">-        quoted = !quoted;</span>
<a href="#l7.456"></a><span id="l7.456" class="difflineminus">-        if (quoted)</span>
<a href="#l7.457"></a><span id="l7.457" class="difflineminus">-          displayname = s;</span>
<a href="#l7.458"></a><span id="l7.458" class="difflineminus">-        else {</span>
<a href="#l7.459"></a><span id="l7.459" class="difflineminus">-          char tmp = *(s+1);</span>
<a href="#l7.460"></a><span id="l7.460" class="difflineminus">-          *(s+1) = '\0';</span>
<a href="#l7.461"></a><span id="l7.461" class="difflineminus">-          PR_FREEIF(list-&gt;displayname);</span>
<a href="#l7.462"></a><span id="l7.462" class="difflineminus">-          list-&gt;displayname = displayname ? strdup(displayname) : nullptr;</span>
<a href="#l7.463"></a><span id="l7.463" class="difflineminus">-          list-&gt;asciionly = intlmime_only_ascii_str(displayname);</span>
<a href="#l7.464"></a><span id="l7.464" class="difflineminus">-          *(s+1) = tmp;</span>
<a href="#l7.465"></a><span id="l7.465" class="difflineminus">-        }</span>
<a href="#l7.466"></a><span id="l7.466" class="difflineminus">-        continue;</span>
<a href="#l7.467"></a><span id="l7.467" class="difflineminus">-      }</span>
<a href="#l7.468"></a><span id="l7.468" class="difflineminus">-    }</span>
<a href="#l7.469"></a><span id="l7.469" class="difflineminus">-    else if (*s == '&lt;' || *s == '&gt;') {</span>
<a href="#l7.470"></a><span id="l7.470" class="difflineminus">-      if (!quoted &amp;&amp; !comment) {</span>
<a href="#l7.471"></a><span id="l7.471" class="difflineminus">-        if (*s == '&lt;') {</span>
<a href="#l7.472"></a><span id="l7.472" class="difflineminus">-          angle_addr = true;</span>
<a href="#l7.473"></a><span id="l7.473" class="difflineminus">-          addrspec = s;</span>
<a href="#l7.474"></a><span id="l7.474" class="difflineminus">-          if (displayname) {</span>
<a href="#l7.475"></a><span id="l7.475" class="difflineminus">-            char *e = s - 1, tmp;</span>
<a href="#l7.476"></a><span id="l7.476" class="difflineminus">-            while (*e == '\t' || *e == ' ')</span>
<a href="#l7.477"></a><span id="l7.477" class="difflineminus">-              --e;</span>
<a href="#l7.478"></a><span id="l7.478" class="difflineminus">-            tmp = *++e;</span>
<a href="#l7.479"></a><span id="l7.479" class="difflineminus">-            *e = '\0';</span>
<a href="#l7.480"></a><span id="l7.480" class="difflineminus">-            PR_FREEIF(list-&gt;displayname);</span>
<a href="#l7.481"></a><span id="l7.481" class="difflineminus">-            list-&gt;displayname = displayname ? strdup(displayname) : nullptr;</span>
<a href="#l7.482"></a><span id="l7.482" class="difflineminus">-            list-&gt;asciionly = intlmime_only_ascii_str(displayname);</span>
<a href="#l7.483"></a><span id="l7.483" class="difflineminus">-            *e = tmp;</span>
<a href="#l7.484"></a><span id="l7.484" class="difflineminus">-          }</span>
<a href="#l7.485"></a><span id="l7.485" class="difflineminus">-        }</span>
<a href="#l7.486"></a><span id="l7.486" class="difflineminus">-        else {</span>
<a href="#l7.487"></a><span id="l7.487" class="difflineminus">-          char tmp;</span>
<a href="#l7.488"></a><span id="l7.488" class="difflineminus">-          angle_addr = false;</span>
<a href="#l7.489"></a><span id="l7.489" class="difflineminus">-          tmp = *(s+1);</span>
<a href="#l7.490"></a><span id="l7.490" class="difflineminus">-          *(s+1) = '\0';</span>
<a href="#l7.491"></a><span id="l7.491" class="difflineminus">-          PR_FREEIF(list-&gt;addrspec);</span>
<a href="#l7.492"></a><span id="l7.492" class="difflineminus">-          list-&gt;addrspec = addrspec ? strdup(addrspec) : nullptr;</span>
<a href="#l7.493"></a><span id="l7.493" class="difflineminus">-          *(s+1) = tmp;</span>
<a href="#l7.494"></a><span id="l7.494" class="difflineminus">-        }</span>
<a href="#l7.495"></a><span id="l7.495" class="difflineminus">-        continue;</span>
<a href="#l7.496"></a><span id="l7.496" class="difflineminus">-      }</span>
<a href="#l7.497"></a><span id="l7.497" class="difflineminus">-    }</span>
<a href="#l7.498"></a><span id="l7.498" class="difflineminus">-    if (!quoted &amp;&amp; !comment &amp;&amp; !angle_addr) {</span>
<a href="#l7.499"></a><span id="l7.499" class="difflineminus">-      /* address-list separator. end of this address */</span>
<a href="#l7.500"></a><span id="l7.500" class="difflineminus">-      if (*s == ',') {</span>
<a href="#l7.501"></a><span id="l7.501" class="difflineminus">-        /* deal with addr-spec only address */</span>
<a href="#l7.502"></a><span id="l7.502" class="difflineminus">-        if (!addrspec &amp;&amp; displayname) {</span>
<a href="#l7.503"></a><span id="l7.503" class="difflineminus">-          *s = '\0';</span>
<a href="#l7.504"></a><span id="l7.504" class="difflineminus">-          list-&gt;addrspec = strdup(displayname);</span>
<a href="#l7.505"></a><span id="l7.505" class="difflineminus">-          /* and don't forget to free the display name in the list, in that case it's bogus */</span>
<a href="#l7.506"></a><span id="l7.506" class="difflineminus">-          PR_FREEIF(list-&gt;displayname);</span>
<a href="#l7.507"></a><span id="l7.507" class="difflineminus">-        }</span>
<a href="#l7.508"></a><span id="l7.508" class="difflineminus">-        /* prepare for next address */</span>
<a href="#l7.509"></a><span id="l7.509" class="difflineminus">-        addrspec = displayname = nullptr;</span>
<a href="#l7.510"></a><span id="l7.510" class="difflineminus">-        list-&gt;next = (RFC822AddressList *)PR_Malloc(sizeof(RFC822AddressList));</span>
<a href="#l7.511"></a><span id="l7.511" class="difflineminus">-        list = list-&gt;next;</span>
<a href="#l7.512"></a><span id="l7.512" class="difflineminus">-        *list = listinit;</span>
<a href="#l7.513"></a><span id="l7.513" class="difflineminus">-        /* eat spaces */</span>
<a href="#l7.514"></a><span id="l7.514" class="difflineminus">-        ++s;</span>
<a href="#l7.515"></a><span id="l7.515" class="difflineminus">-        while (*s == ' ' || *s == '\t')</span>
<a href="#l7.516"></a><span id="l7.516" class="difflineminus">-          ++s;</span>
<a href="#l7.517"></a><span id="l7.517" class="difflineminus">-        if (*s == '\r' &amp;&amp; *(s+1) == '\n' &amp;&amp; (*(s+2) == ' ' || *(s+2) == '\t'))</span>
<a href="#l7.518"></a><span id="l7.518" class="difflineminus">-          s += 2;</span>
<a href="#l7.519"></a><span id="l7.519" class="difflineminus">-        else</span>
<a href="#l7.520"></a><span id="l7.520" class="difflineminus">-          --s;</span>
<a href="#l7.521"></a><span id="l7.521" class="difflineminus">-      }</span>
<a href="#l7.522"></a><span id="l7.522" class="difflineminus">-      else if (!displayname &amp;&amp; *s != ' ' &amp;&amp; *s != '\t')</span>
<a href="#l7.523"></a><span id="l7.523" class="difflineminus">-        displayname = s;</span>
<a href="#l7.524"></a><span id="l7.524" class="difflineminus">-    }</span>
<a href="#l7.525"></a><span id="l7.525" class="difflineminus">-  }</span>
<a href="#l7.526"></a><span id="l7.526" class="difflineminus">-</span>
<a href="#l7.527"></a><span id="l7.527" class="difflineminus">-  /* deal with addr-spec only address comes at last */</span>
<a href="#l7.528"></a><span id="l7.528" class="difflineminus">-  if (!addrspec &amp;&amp; displayname)</span>
<a href="#l7.529"></a><span id="l7.529" class="difflineminus">-  {</span>
<a href="#l7.530"></a><span id="l7.530" class="difflineminus">-    list-&gt;addrspec = strdup(displayname);</span>
<a href="#l7.531"></a><span id="l7.531" class="difflineminus">-    /* and don't forget to free the display name in the list, in that case it's bogus */</span>
<a href="#l7.532"></a><span id="l7.532" class="difflineminus">-    PR_FREEIF(list-&gt;displayname);</span>
<a href="#l7.533"></a><span id="l7.533" class="difflineminus">-  }</span>
<a href="#l7.534"></a><span id="l7.534" class="difflineminus">-</span>
<a href="#l7.535"></a><span id="l7.535" class="difflineminus">-  return listhead;</span>
<a href="#l7.536"></a><span id="l7.536" class="difflineminus">-}</span>
<a href="#l7.537"></a><span id="l7.537" class="difflineminus">-</span>
<a href="#l7.538"></a><span id="l7.538" class="difflineminus">-static</span>
<a href="#l7.539"></a><span id="l7.539" class="difflineminus">-char * apply_rfc2047_encoding(const char *_src, bool structured, const char *charset, int32_t cursor, int32_t foldlen)</span>
<a href="#l7.540"></a><span id="l7.540" class="difflineminus">-{</span>
<a href="#l7.541"></a><span id="l7.541" class="difflineminus">-  RFC822AddressList  *listhead, *list;</span>
<a href="#l7.542"></a><span id="l7.542" class="difflineminus">-  int32_t   outputlen, usedlen;</span>
<a href="#l7.543"></a><span id="l7.543" class="difflineminus">-  char  *src, *src_head, *output, *outputtail;</span>
<a href="#l7.544"></a><span id="l7.544" class="difflineminus">-  char  method = nsMsgI18Nmultibyte_charset(charset) ? 'B' : 'Q';</span>
<a href="#l7.545"></a><span id="l7.545" class="difflineminus">-</span>
<a href="#l7.546"></a><span id="l7.546" class="difflineminus">-  if (!_src)</span>
<a href="#l7.547"></a><span id="l7.547" class="difflineminus">-    return nullptr;</span>
<a href="#l7.548"></a><span id="l7.548" class="difflineminus">-</span>
<a href="#l7.549"></a><span id="l7.549" class="difflineminus">-  //&lt;TAB&gt;=?&lt;charset&gt;?&lt;B/Q&gt;?...?=&lt;CRLF&gt;</span>
<a href="#l7.550"></a><span id="l7.550" class="difflineminus">-  int32_t perLineOverhead = strlen(charset) + 10;</span>
<a href="#l7.551"></a><span id="l7.551" class="difflineminus">-</span>
<a href="#l7.552"></a><span id="l7.552" class="difflineminus">-  if (perLineOverhead &gt;= foldlen || (src = src_head = strdup(_src)) == nullptr)</span>
<a href="#l7.553"></a><span id="l7.553" class="difflineminus">-    return nullptr;</span>
<a href="#l7.554"></a><span id="l7.554" class="difflineminus">-</span>
<a href="#l7.555"></a><span id="l7.555" class="difflineminus">-  /* allocate enough buffer for conversion, this way it can avoid</span>
<a href="#l7.556"></a><span id="l7.556" class="difflineminus">-     do another memory allocation which is expensive</span>
<a href="#l7.557"></a><span id="l7.557" class="difflineminus">-   */</span>
<a href="#l7.558"></a><span id="l7.558" class="difflineminus">-  int32_t encodedCharsPerLine = foldlen - perLineOverhead;</span>
<a href="#l7.559"></a><span id="l7.559" class="difflineminus">-  int32_t maxNumLines = (strlen(src) * 4 / encodedCharsPerLine) + 1;</span>
<a href="#l7.560"></a><span id="l7.560" class="difflineminus">-  outputlen = strlen(src) * 4 + (maxNumLines * perLineOverhead) + 20 /* fudge */;</span>
<a href="#l7.561"></a><span id="l7.561" class="difflineminus">-  if ((outputtail = output = (char *)PR_Malloc(outputlen)) == nullptr) {</span>
<a href="#l7.562"></a><span id="l7.562" class="difflineminus">-    PR_Free(src_head);</span>
<a href="#l7.563"></a><span id="l7.563" class="difflineminus">-    return nullptr;</span>
<a href="#l7.564"></a><span id="l7.564" class="difflineminus">-  }</span>
<a href="#l7.565"></a><span id="l7.565" class="difflineminus">-</span>
<a href="#l7.566"></a><span id="l7.566" class="difflineminus">-  if (structured) {</span>
<a href="#l7.567"></a><span id="l7.567" class="difflineminus">-    listhead = list = construct_addresslist(src);</span>
<a href="#l7.568"></a><span id="l7.568" class="difflineminus">-    if (!list) {</span>
<a href="#l7.569"></a><span id="l7.569" class="difflineminus">-      PR_Free(output);</span>
<a href="#l7.570"></a><span id="l7.570" class="difflineminus">-      output = nullptr;</span>
<a href="#l7.571"></a><span id="l7.571" class="difflineminus">-    }</span>
<a href="#l7.572"></a><span id="l7.572" class="difflineminus">-    else {</span>
<a href="#l7.573"></a><span id="l7.573" class="difflineminus">-      for (; list &amp;&amp; (outputlen &gt; 0); list = list-&gt;next) {</span>
<a href="#l7.574"></a><span id="l7.574" class="difflineminus">-        if (list-&gt;displayname) {</span>
<a href="#l7.575"></a><span id="l7.575" class="difflineminus">-          if (list-&gt;asciionly &amp;&amp; list-&gt;addrspec) {</span>
<a href="#l7.576"></a><span id="l7.576" class="difflineminus">-            int32_t len = cursor + strlen(list-&gt;displayname) + strlen(list-&gt;addrspec);</span>
<a href="#l7.577"></a><span id="l7.577" class="difflineminus">-            if (foldlen &lt; len &amp;&amp; len &lt; 998) { /* see RFC 2822 for magic number 998 */</span>
<a href="#l7.578"></a><span id="l7.578" class="difflineminus">-              if (!PR_snprintf(outputtail, outputlen - 1, </span>
<a href="#l7.579"></a><span id="l7.579" class="difflineminus">-                              (list == listhead || cursor == 1) ? &quot;%s %s%s&quot; : &quot;\r\n %s %s%s&quot;, </span>
<a href="#l7.580"></a><span id="l7.580" class="difflineminus">-                              list-&gt;displayname, list-&gt;addrspec, list-&gt;next ? &quot;,\r\n &quot; : &quot;&quot;))</span>
<a href="#l7.581"></a><span id="l7.581" class="difflineminus">-              {</span>
<a href="#l7.582"></a><span id="l7.582" class="difflineminus">-                PR_Free(output);</span>
<a href="#l7.583"></a><span id="l7.583" class="difflineminus">-                return nullptr;</span>
<a href="#l7.584"></a><span id="l7.584" class="difflineminus">-              }</span>
<a href="#l7.585"></a><span id="l7.585" class="difflineminus">-              usedlen = strlen(outputtail);</span>
<a href="#l7.586"></a><span id="l7.586" class="difflineminus">-              outputtail += usedlen;</span>
<a href="#l7.587"></a><span id="l7.587" class="difflineminus">-              outputlen -= usedlen;</span>
<a href="#l7.588"></a><span id="l7.588" class="difflineminus">-              cursor = 1;</span>
<a href="#l7.589"></a><span id="l7.589" class="difflineminus">-              continue;</span>
<a href="#l7.590"></a><span id="l7.590" class="difflineminus">-            }</span>
<a href="#l7.591"></a><span id="l7.591" class="difflineminus">-          }</span>
<a href="#l7.592"></a><span id="l7.592" class="difflineminus">-          cursor = generate_encodedwords(list-&gt;displayname, charset, method, outputtail, outputlen, cursor, foldlen, list-&gt;asciionly);</span>
<a href="#l7.593"></a><span id="l7.593" class="difflineminus">-          if (cursor &lt; 0) {</span>
<a href="#l7.594"></a><span id="l7.594" class="difflineminus">-            PR_Free(output);</span>
<a href="#l7.595"></a><span id="l7.595" class="difflineminus">-            output = nullptr;</span>
<a href="#l7.596"></a><span id="l7.596" class="difflineminus">-            break;</span>
<a href="#l7.597"></a><span id="l7.597" class="difflineminus">-          }</span>
<a href="#l7.598"></a><span id="l7.598" class="difflineminus">-          usedlen = strlen(outputtail);</span>
<a href="#l7.599"></a><span id="l7.599" class="difflineminus">-          outputtail += usedlen;</span>
<a href="#l7.600"></a><span id="l7.600" class="difflineminus">-          outputlen -= usedlen;</span>
<a href="#l7.601"></a><span id="l7.601" class="difflineminus">-        }</span>
<a href="#l7.602"></a><span id="l7.602" class="difflineminus">-        if (list-&gt;addrspec) {</span>
<a href="#l7.603"></a><span id="l7.603" class="difflineminus">-          usedlen = strlen(list-&gt;addrspec);</span>
<a href="#l7.604"></a><span id="l7.604" class="difflineminus">-          if (cursor + usedlen &gt; foldlen) {</span>
<a href="#l7.605"></a><span id="l7.605" class="difflineminus">-            if (!PR_snprintf(outputtail, outputlen - 1, &quot;\r\n %s&quot;, list-&gt;addrspec)) {</span>
<a href="#l7.606"></a><span id="l7.606" class="difflineminus">-              PR_Free(output);</span>
<a href="#l7.607"></a><span id="l7.607" class="difflineminus">-              destroy_addresslist(listhead);</span>
<a href="#l7.608"></a><span id="l7.608" class="difflineminus">-              return nullptr;</span>
<a href="#l7.609"></a><span id="l7.609" class="difflineminus">-            }</span>
<a href="#l7.610"></a><span id="l7.610" class="difflineminus">-            usedlen += 3;         /* FWS + addr-spec */</span>
<a href="#l7.611"></a><span id="l7.611" class="difflineminus">-            cursor = usedlen - 2; /* \r\n */</span>
<a href="#l7.612"></a><span id="l7.612" class="difflineminus">-          }</span>
<a href="#l7.613"></a><span id="l7.613" class="difflineminus">-          else {</span>
<a href="#l7.614"></a><span id="l7.614" class="difflineminus">-            if (!PR_snprintf(outputtail, outputlen - 1, list-&gt;displayname ? &quot; %s&quot; : &quot;%s&quot;, list-&gt;addrspec)) {</span>
<a href="#l7.615"></a><span id="l7.615" class="difflineminus">-              PR_Free(output);</span>
<a href="#l7.616"></a><span id="l7.616" class="difflineminus">-              destroy_addresslist(listhead);</span>
<a href="#l7.617"></a><span id="l7.617" class="difflineminus">-              return nullptr;</span>
<a href="#l7.618"></a><span id="l7.618" class="difflineminus">-            }</span>
<a href="#l7.619"></a><span id="l7.619" class="difflineminus">-            if (list-&gt;displayname)</span>
<a href="#l7.620"></a><span id="l7.620" class="difflineminus">-              usedlen++;</span>
<a href="#l7.621"></a><span id="l7.621" class="difflineminus">-            cursor += usedlen;</span>
<a href="#l7.622"></a><span id="l7.622" class="difflineminus">-          }</span>
<a href="#l7.623"></a><span id="l7.623" class="difflineminus">-          outputtail += usedlen;</span>
<a href="#l7.624"></a><span id="l7.624" class="difflineminus">-          outputlen -= usedlen;</span>
<a href="#l7.625"></a><span id="l7.625" class="difflineminus">-        }</span>
<a href="#l7.626"></a><span id="l7.626" class="difflineminus">-        else {</span>
<a href="#l7.627"></a><span id="l7.627" class="difflineminus">-          PR_Free(output);</span>
<a href="#l7.628"></a><span id="l7.628" class="difflineminus">-          output = nullptr;</span>
<a href="#l7.629"></a><span id="l7.629" class="difflineminus">-          break;</span>
<a href="#l7.630"></a><span id="l7.630" class="difflineminus">-        }</span>
<a href="#l7.631"></a><span id="l7.631" class="difflineminus">-        if (list-&gt;next) {</span>
<a href="#l7.632"></a><span id="l7.632" class="difflineminus">-          PL_strncpyz(outputtail, &quot;, &quot;, outputlen);</span>
<a href="#l7.633"></a><span id="l7.633" class="difflineminus">-          cursor += 2;</span>
<a href="#l7.634"></a><span id="l7.634" class="difflineminus">-          outputtail += 2;</span>
<a href="#l7.635"></a><span id="l7.635" class="difflineminus">-          outputlen -= 2;</span>
<a href="#l7.636"></a><span id="l7.636" class="difflineminus">-        }</span>
<a href="#l7.637"></a><span id="l7.637" class="difflineminus">-      }</span>
<a href="#l7.638"></a><span id="l7.638" class="difflineminus">-      destroy_addresslist(listhead);</span>
<a href="#l7.639"></a><span id="l7.639" class="difflineminus">-    }</span>
<a href="#l7.640"></a><span id="l7.640" class="difflineminus">-  }</span>
<a href="#l7.641"></a><span id="l7.641" class="difflineminus">-  else {</span>
<a href="#l7.642"></a><span id="l7.642" class="difflineminus">-    char *spacepos = nullptr, *org_output = output;</span>
<a href="#l7.643"></a><span id="l7.643" class="difflineminus">-    /* show some mercy to stupid ML systems which don't know</span>
<a href="#l7.644"></a><span id="l7.644" class="difflineminus">-       how to respect MIME encoded subject */</span>
<a href="#l7.645"></a><span id="l7.645" class="difflineminus">-    for (char *p = src; *p &amp;&amp; !(*p &amp; 0x80); p++) {</span>
<a href="#l7.646"></a><span id="l7.646" class="difflineminus">-      if (*p == 0x20 || *p == '\t')</span>
<a href="#l7.647"></a><span id="l7.647" class="difflineminus">-        spacepos = p;</span>
<a href="#l7.648"></a><span id="l7.648" class="difflineminus">-    }</span>
<a href="#l7.649"></a><span id="l7.649" class="difflineminus">-    if (spacepos) {</span>
<a href="#l7.650"></a><span id="l7.650" class="difflineminus">-      char head[nsIMimeConverter::MAX_CHARSET_NAME_LENGTH+4+1];</span>
<a href="#l7.651"></a><span id="l7.651" class="difflineminus">-      int32_t  overhead, skiplen;</span>
<a href="#l7.652"></a><span id="l7.652" class="difflineminus">-      if (!PR_snprintf(head, sizeof(head) - 1, &quot;=?%s?%c?&quot;, charset, method)) {</span>
<a href="#l7.653"></a><span id="l7.653" class="difflineminus">-        PR_Free(output);</span>
<a href="#l7.654"></a><span id="l7.654" class="difflineminus">-        return nullptr;</span>
<a href="#l7.655"></a><span id="l7.655" class="difflineminus">-      }</span>
<a href="#l7.656"></a><span id="l7.656" class="difflineminus">-      overhead = strlen(head) + 2 + 4; // 2 : &quot;?=&quot;, 4 : a B-encoded chunk</span>
<a href="#l7.657"></a><span id="l7.657" class="difflineminus">-      skiplen = spacepos + 1 - src;</span>
<a href="#l7.658"></a><span id="l7.658" class="difflineminus">-      if (cursor + skiplen + overhead &lt; foldlen) {</span>
<a href="#l7.659"></a><span id="l7.659" class="difflineminus">-        char tmp = *(spacepos + 1);</span>
<a href="#l7.660"></a><span id="l7.660" class="difflineminus">-        *(spacepos + 1) = '\0';</span>
<a href="#l7.661"></a><span id="l7.661" class="difflineminus">-        PL_strncpyz(output, src, outputlen);</span>
<a href="#l7.662"></a><span id="l7.662" class="difflineminus">-        output += skiplen;</span>
<a href="#l7.663"></a><span id="l7.663" class="difflineminus">-        outputlen -= skiplen;</span>
<a href="#l7.664"></a><span id="l7.664" class="difflineminus">-        cursor += skiplen;</span>
<a href="#l7.665"></a><span id="l7.665" class="difflineminus">-        src += skiplen;</span>
<a href="#l7.666"></a><span id="l7.666" class="difflineminus">-        *src = tmp;</span>
<a href="#l7.667"></a><span id="l7.667" class="difflineminus">-      }</span>
<a href="#l7.668"></a><span id="l7.668" class="difflineminus">-    }</span>
<a href="#l7.669"></a><span id="l7.669" class="difflineminus">-    bool asciionly = intlmime_only_ascii_str(src);</span>
<a href="#l7.670"></a><span id="l7.670" class="difflineminus">-    if (generate_encodedwords(src, charset, method, output, outputlen, cursor, foldlen, asciionly) &lt; 0) {</span>
<a href="#l7.671"></a><span id="l7.671" class="difflineminus">-      PR_Free(org_output);</span>
<a href="#l7.672"></a><span id="l7.672" class="difflineminus">-      org_output = nullptr;</span>
<a href="#l7.673"></a><span id="l7.673" class="difflineminus">-    }</span>
<a href="#l7.674"></a><span id="l7.674" class="difflineminus">-    output = org_output;</span>
<a href="#l7.675"></a><span id="l7.675" class="difflineminus">-  }</span>
<a href="#l7.676"></a><span id="l7.676" class="difflineminus">-</span>
<a href="#l7.677"></a><span id="l7.677" class="difflineminus">-  PR_Free(src_head);</span>
<a href="#l7.678"></a><span id="l7.678" class="difflineminus">-</span>
<a href="#l7.679"></a><span id="l7.679" class="difflineminus">-  return output;</span>
<a href="#l7.680"></a><span id="l7.680" class="difflineminus">-}</span>
<a href="#l7.681"></a><span id="l7.681" class="difflineminus">-</span>
<a href="#l7.682"></a><span id="l7.682" class="difflineminus">-////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l7.683"></a><span id="l7.683"> // BEGIN PUBLIC INTERFACE</span>
<a href="#l7.684"></a><span id="l7.684"> extern &quot;C&quot; {</span>
<a href="#l7.685"></a><span id="l7.685"> </span>
<a href="#l7.686"></a><span id="l7.686"> </span>
<a href="#l7.687"></a><span id="l7.687"> void MIME_DecodeMimeHeader(const char *header, const char *default_charset,</span>
<a href="#l7.688"></a><span id="l7.688">                            bool override_charset, bool eatContinuations,</span>
<a href="#l7.689"></a><span id="l7.689">                            nsACString &amp;result)</span>
<a href="#l7.690"></a><span id="l7.690"> {</span>
<a href="#l7.691"></a><span id="l7.691" class="difflineat">@@ -691,28 +28,17 @@ void MIME_DecodeMimeHeader(const char *h</span>
<a href="#l7.692"></a><span id="l7.692">   {</span>
<a href="#l7.693"></a><span id="l7.693">     result.Truncate();</span>
<a href="#l7.694"></a><span id="l7.694">     return;</span>
<a href="#l7.695"></a><span id="l7.695">   }</span>
<a href="#l7.696"></a><span id="l7.696">   mimehdrpar-&gt;DecodeRFC2047Header(header, default_charset, override_charset,</span>
<a href="#l7.697"></a><span id="l7.697">                                   eatContinuations, result);</span>
<a href="#l7.698"></a><span id="l7.698"> }</span>
<a href="#l7.699"></a><span id="l7.699"> </span>
<a href="#l7.700"></a><span id="l7.700" class="difflineminus">-char *MIME_EncodeMimePartIIStr(const char* header, bool structured, const char* mailCharset, const int32_t fieldNameLen, const int32_t encodedWordSize)</span>
<a href="#l7.701"></a><span id="l7.701" class="difflineminus">-{</span>
<a href="#l7.702"></a><span id="l7.702" class="difflineminus">-  return apply_rfc2047_encoding(header, structured, mailCharset, fieldNameLen, encodedWordSize);</span>
<a href="#l7.703"></a><span id="l7.703" class="difflineminus">-}</span>
<a href="#l7.704"></a><span id="l7.704" class="difflineminus">-</span>
<a href="#l7.705"></a><span id="l7.705"> // UTF-8 utility functions.</span>
<a href="#l7.706"></a><span id="l7.706" class="difflineminus">-</span>
<a href="#l7.707"></a><span id="l7.707" class="difflineminus">-char * NextChar_UTF8(char *str)</span>
<a href="#l7.708"></a><span id="l7.708" class="difflineminus">-{</span>
<a href="#l7.709"></a><span id="l7.709" class="difflineminus">-  return (char *) utf8_nextchar((unsigned char *) str);</span>
<a href="#l7.710"></a><span id="l7.710" class="difflineminus">-}</span>
<a href="#l7.711"></a><span id="l7.711" class="difflineminus">-</span>
<a href="#l7.712"></a><span id="l7.712"> //detect charset soly based on aBuf. return in aCharset</span>
<a href="#l7.713"></a><span id="l7.713"> nsresult</span>
<a href="#l7.714"></a><span id="l7.714"> MIME_detect_charset(const char *aBuf, int32_t aLength, const char** aCharset)</span>
<a href="#l7.715"></a><span id="l7.715"> {</span>
<a href="#l7.716"></a><span id="l7.716">   nsresult res = NS_ERROR_UNEXPECTED;</span>
<a href="#l7.717"></a><span id="l7.717">   nsString detector_name;</span>
<a href="#l7.718"></a><span id="l7.718">   *aCharset = nullptr;</span>
<a href="#l7.719"></a><span id="l7.719"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/mime/src/comi18n.h</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/mime/src/comi18n.h</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -4,17 +4,16 @@</span>
<a href="#l8.4"></a><span id="l8.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.5"></a><span id="l8.5"> #ifndef _COMI18N_LOADED_H_</span>
<a href="#l8.6"></a><span id="l8.6"> #define _COMI18N_LOADED_H_</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8"> #include &quot;msgCore.h&quot;</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10"> class nsIUnicodeDecoder;</span>
<a href="#l8.11"></a><span id="l8.11"> class nsIUnicodeEncoder;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-class nsIStringCharsetDetector;</span>
<a href="#l8.13"></a><span id="l8.13"> </span>
<a href="#l8.14"></a><span id="l8.14"> </span>
<a href="#l8.15"></a><span id="l8.15"> #ifdef __cplusplus</span>
<a href="#l8.16"></a><span id="l8.16"> extern &quot;C&quot; {</span>
<a href="#l8.17"></a><span id="l8.17"> #endif /* __cplusplus */</span>
<a href="#l8.18"></a><span id="l8.18"> </span>
<a href="#l8.19"></a><span id="l8.19"> /**</span>
<a href="#l8.20"></a><span id="l8.20">  * Decode MIME header to UTF-8.</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineat">@@ -26,42 +25,16 @@ extern &quot;C&quot; {</span>
<a href="#l8.22"></a><span id="l8.22">  * @param override_charset    [IN] If true, default_charset used instead of any charset labeling other than UTF-8</span>
<a href="#l8.23"></a><span id="l8.23">  * @param eatContinuations    [IN] If true, unfold headers</span>
<a href="#l8.24"></a><span id="l8.24">  * @param result      [OUT] Decoded buffer</span>
<a href="#l8.25"></a><span id="l8.25">  */</span>
<a href="#l8.26"></a><span id="l8.26"> void MIME_DecodeMimeHeader(const char *header, const char *default_charset,</span>
<a href="#l8.27"></a><span id="l8.27">                            bool override_charset, bool eatContinuations,</span>
<a href="#l8.28"></a><span id="l8.28">                            nsACString &amp;result);</span>
<a href="#l8.29"></a><span id="l8.29"> </span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-/**</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">- * Encode an input string into RFC 2047 form.</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">- * This is a replacement for INTL_EncodeMimePartIIStr.</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">- * Unlike INTL_EncodeMimePartIIStr, this does not apply any charset conversion.</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">- * Use MIME_ConvertCharset in advance if the encoding string needs a conversion.</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineminus">- *</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineminus">- *</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">- * @param header          [IN] A header to encode (utf-8 Cstring).</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">- * @param structured      [IN] A boolean to swtich between structured field body and non-structured field body.</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">- * @param mailCharset     [IN] Charset name (in C string) to convert.</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineminus">- * @param fieldNameLen    [IN] Header field name length (e.g. &quot;From: &quot; -&gt; 6)</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineminus">- * @param encodedWordSize [IN] Byte length limit of the output, ususally 72 (use kMIME_ENCODED_WORD_SIZE).</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineminus">- * @return            Encoded buffer (in C string) or NULL in case of error.</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineminus">- */</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineminus">-char *MIME_EncodeMimePartIIStr(const char *header, bool structured, const char* mailCharset, const int32_t fieldNameLen, const int32_t encodedWordSize);</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineminus">-</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineminus">-/**</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineminus">- * Get a next character position in an UTF-8 string.</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineminus">- * Example: s = NextChar_UTF8(s);  // get a pointer for the next character</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineminus">- *</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">- *</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineminus">- * @param str          [IN] An input C string (UTF-8).</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineminus">- * @return             A pointer to the next character.</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineminus">- */</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineminus">-char * NextChar_UTF8(char *str);</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineminus">-</span>
<a href="#l8.56"></a><span id="l8.56"> nsresult MIME_detect_charset(const char *aBuf, int32_t aLength, const char** aCharset);</span>
<a href="#l8.57"></a><span id="l8.57"> nsresult MIME_get_unicode_decoder(const char* aInputCharset, nsIUnicodeDecoder **aDecoder);</span>
<a href="#l8.58"></a><span id="l8.58"> nsresult MIME_get_unicode_encoder(const char* aOutputCharset, nsIUnicodeEncoder **aEncoder);</span>
<a href="#l8.59"></a><span id="l8.59"> </span>
<a href="#l8.60"></a><span id="l8.60"> #ifdef __cplusplus</span>
<a href="#l8.61"></a><span id="l8.61"> } /* extern &quot;C&quot; */</span>
<a href="#l8.62"></a><span id="l8.62"> #endif /* __cplusplus */</span>
<a href="#l8.63"></a><span id="l8.63"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/mime/src/mimeJSComponents.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/mime/src/mimeJSComponents.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1,16 +1,23 @@</span>
<a href="#l9.4"></a><span id="l9.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.5"></a><span id="l9.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.6"></a><span id="l9.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8" class="difflineplus">+Components.utils.import(&quot;resource:///modules/Deprecated.jsm&quot;);</span>
<a href="#l9.9"></a><span id="l9.9"> Components.utils.import(&quot;resource:///modules/jsmime.jsm&quot;);</span>
<a href="#l9.10"></a><span id="l9.10"> Components.utils.import(&quot;resource:///modules/mimeParser.jsm&quot;);</span>
<a href="#l9.11"></a><span id="l9.11"> Components.utils.import(&quot;resource:///modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l9.12"></a><span id="l9.12"> </span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+function HeaderHandler() {</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+  this.value = &quot;&quot;;</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+  this.deliverData = function (str) { this.value += str; };</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+  this.deliverEOF = function () {};</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+}</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+</span>
<a href="#l9.19"></a><span id="l9.19"> function MimeHeaders() {</span>
<a href="#l9.20"></a><span id="l9.20"> }</span>
<a href="#l9.21"></a><span id="l9.21"> MimeHeaders.prototype = {</span>
<a href="#l9.22"></a><span id="l9.22">   classDescription: &quot;Mime headers implementation&quot;,</span>
<a href="#l9.23"></a><span id="l9.23">   classID: Components.ID(&quot;d1258011-f391-44fd-992e-c6f4b461a42f&quot;),</span>
<a href="#l9.24"></a><span id="l9.24">   contractID: &quot;@mozilla.org/messenger/mimeheaders;1&quot;,</span>
<a href="#l9.25"></a><span id="l9.25">   QueryInterface: XPCOMUtils.generateQI([Components.interfaces.nsIMimeHeaders]),</span>
<a href="#l9.26"></a><span id="l9.26"> </span>
<a href="#l9.27"></a><span id="l9.27" class="difflineat">@@ -48,19 +55,17 @@ var EmailGroup = {</span>
<a href="#l9.28"></a><span id="l9.28">   toString: function () {</span>
<a href="#l9.29"></a><span id="l9.29">     return this.name + &quot;: &quot; + [x.toString() for (x of this.group)].join(&quot;, &quot;);</span>
<a href="#l9.30"></a><span id="l9.30">   }</span>
<a href="#l9.31"></a><span id="l9.31"> };</span>
<a href="#l9.32"></a><span id="l9.32"> </span>
<a href="#l9.33"></a><span id="l9.33"> function MimeAddressParser() {</span>
<a href="#l9.34"></a><span id="l9.34"> }</span>
<a href="#l9.35"></a><span id="l9.35"> MimeAddressParser.prototype = {</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-  classDescription: &quot;Mime message header parser implementation&quot;,</span>
<a href="#l9.37"></a><span id="l9.37">   classID: Components.ID(&quot;96bd8769-2d0e-4440-963d-22b97fb3ba77&quot;),</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineminus">-  contractID: &quot;@mozilla.org/messenger/headerparser;1&quot;,</span>
<a href="#l9.39"></a><span id="l9.39">   QueryInterface: XPCOMUtils.generateQI([Components.interfaces.nsIMsgHeaderParser]),</span>
<a href="#l9.40"></a><span id="l9.40"> </span>
<a href="#l9.41"></a><span id="l9.41">   parseEncodedHeader: function (aHeader, aCharset, aPreserveGroups, count) {</span>
<a href="#l9.42"></a><span id="l9.42">     aHeader = aHeader || &quot;&quot;;</span>
<a href="#l9.43"></a><span id="l9.43">     let value = MimeParser.parseHeaderField(aHeader,</span>
<a href="#l9.44"></a><span id="l9.44">       MimeParser.HEADER_ADDRESS | MimeParser.HEADER_OPTION_ALL_I18N, aCharset);</span>
<a href="#l9.45"></a><span id="l9.45">     return this._fixArray(value, aPreserveGroups, count);</span>
<a href="#l9.46"></a><span id="l9.46">   },</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineat">@@ -106,21 +111,17 @@ MimeAddressParser.prototype = {</span>
<a href="#l9.48"></a><span id="l9.48">   makeMimeHeader: function (addresses, length) {</span>
<a href="#l9.49"></a><span id="l9.49">     // Don't output any necessary continuations, so make line length as large as</span>
<a href="#l9.50"></a><span id="l9.50">     // possible first.</span>
<a href="#l9.51"></a><span id="l9.51">     let options = {</span>
<a href="#l9.52"></a><span id="l9.52">       softMargin: 900,</span>
<a href="#l9.53"></a><span id="l9.53">       hardMargin: 900,</span>
<a href="#l9.54"></a><span id="l9.54">       useASCII: false // We don't want RFC 2047 encoding here.</span>
<a href="#l9.55"></a><span id="l9.55">     };</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineminus">-    let handler = {</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineminus">-      value: &quot;&quot;,</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineminus">-      deliverData: function (str) { this.value += str; },</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineminus">-      deliverEOF: function () {}</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineminus">-    };</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+    let handler = new HeaderHandler();</span>
<a href="#l9.62"></a><span id="l9.62">     let emitter = new jsmime.headeremitter.makeStreamingEmitter(handler,</span>
<a href="#l9.63"></a><span id="l9.63">       options);</span>
<a href="#l9.64"></a><span id="l9.64">     emitter.addAddresses(addresses);</span>
<a href="#l9.65"></a><span id="l9.65">     emitter.finish(true);</span>
<a href="#l9.66"></a><span id="l9.66">     return handler.value.replace(/\r\n( |$)/g, '');</span>
<a href="#l9.67"></a><span id="l9.67">   },</span>
<a href="#l9.68"></a><span id="l9.68"> </span>
<a href="#l9.69"></a><span id="l9.69">   extractFirstName: function (aHeader) {</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineat">@@ -255,11 +256,83 @@ MimeAddressParser.prototype = {</span>
<a href="#l9.71"></a><span id="l9.71">   },</span>
<a href="#l9.72"></a><span id="l9.72"> </span>
<a href="#l9.73"></a><span id="l9.73">   makeMimeAddress: function (aName, aEmail) {</span>
<a href="#l9.74"></a><span id="l9.74">     let object = this.makeMailboxObject(aName, aEmail);</span>
<a href="#l9.75"></a><span id="l9.75">     return this.makeMimeHeader([object]);</span>
<a href="#l9.76"></a><span id="l9.76">   },</span>
<a href="#l9.77"></a><span id="l9.77"> };</span>
<a href="#l9.78"></a><span id="l9.78"> </span>
<a href="#l9.79"></a><span id="l9.79" class="difflineplus">+function MimeConverter() {</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineplus">+}</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineplus">+MimeConverter.prototype = {</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineplus">+  classID: Components.ID(&quot;93f8c049-80ed-4dda-9000-94ad8daba44c&quot;),</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineplus">+  QueryInterface: XPCOMUtils.generateQI([Components.interfaces.nsIMimeConverter]),</span>
<a href="#l9.84"></a><span id="l9.84"> </span>
<a href="#l9.85"></a><span id="l9.85" class="difflineminus">-var components = [MimeHeaders, MimeAddressParser];</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineplus">+  encodeMimePartIIStr_UTF8: function (aHeader, aStructured, aCharset,</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineplus">+      aFieldNameLen, aLineLength) {</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineplus">+    // The JSMime encoder only works in UTF-8, so if someone requests to not do</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineplus">+    // it, they need to change their code.</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineplus">+    if (aCharset.toLowerCase() != &quot;utf-8&quot;) {</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineplus">+      Deprecated.warning(&quot;Encoding to non-UTF-8 values is obsolete&quot;,</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineplus">+        &quot;http://bugzilla.mozilla.org/show_bug.cgi?id=790855&quot;);</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineplus">+    }</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineplus">+</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineplus">+    // Compute the encoding options. The way our API is structured in this</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineplus">+    // method is really horrendous and does not align with the way that JSMime</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineplus">+    // handles it. Instead, we'll need to create a fake header to take into</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineplus">+    // account the aFieldNameLen parameter.</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineplus">+    let fakeHeader = '*'.repeat(aFieldNameLen);</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineplus">+    let options = {</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineplus">+      softMargin: aLineLength,</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineplus">+      useASCII: true,</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineplus">+    };</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineplus">+    let handler = new HeaderHandler();</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineplus">+    let emitter = new jsmime.headeremitter.makeStreamingEmitter(handler,</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineplus">+      options);</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineplus">+</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineplus">+    // Add the text to the be encoded.</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineplus">+    emitter.addHeaderName(fakeHeader);</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineplus">+    if (aStructured) {</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineplus">+      // Structured really means &quot;this is an addressing header&quot;</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineplus">+      let addresses = MimeParser.parseHeaderField(aHeader,</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineplus">+        MimeParser.HEADER_ADDRESS);</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineplus">+      // This happens in one of our tests if there is a &quot;bare&quot; email but no</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineplus">+      // @ sign. Without it, the result disappears since our emission code</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineplus">+      // assumes that an empty email is not worth emitting.</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineplus">+      if (addresses.length === 1 &amp;&amp; addresses[0].email === &quot;&quot; &amp;&amp;</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineplus">+          addresses[0].name !== &quot;&quot;) {</span>
<a href="#l9.119"></a><span id="l9.119" class="difflineplus">+        addresses[0].email = addresses[0].name;</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineplus">+        addresses[0].name = &quot;&quot;;</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineplus">+      }</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineplus">+      emitter.addAddresses(addresses);</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineplus">+    } else {</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineplus">+      emitter.addUnstructured(aHeader);</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineplus">+    }</span>
<a href="#l9.126"></a><span id="l9.126" class="difflineplus">+</span>
<a href="#l9.127"></a><span id="l9.127" class="difflineplus">+    // Compute the output. We need to strip off the fake prefix added earlier</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineplus">+    // and the extra CRLF at the end.</span>
<a href="#l9.129"></a><span id="l9.129" class="difflineplus">+    emitter.finish(true);</span>
<a href="#l9.130"></a><span id="l9.130" class="difflineplus">+    let value = handler.value;</span>
<a href="#l9.131"></a><span id="l9.131" class="difflineplus">+    value = value.substring(value.indexOf(': ') + 2);</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineplus">+    return value.substring(0, value.length - 2);</span>
<a href="#l9.133"></a><span id="l9.133" class="difflineplus">+  },</span>
<a href="#l9.134"></a><span id="l9.134" class="difflineplus">+</span>
<a href="#l9.135"></a><span id="l9.135" class="difflineplus">+  decodeMimeHeader: function (aHeader, aDefaultCharset, aOverride, aUnfold) {</span>
<a href="#l9.136"></a><span id="l9.136" class="difflineplus">+    let value = MimeParser.parseHeaderField(aHeader,</span>
<a href="#l9.137"></a><span id="l9.137" class="difflineplus">+      MimeParser.HEADER_UNSTRUCTURED | MimeParser.HEADER_OPTION_ALL_I18N,</span>
<a href="#l9.138"></a><span id="l9.138" class="difflineplus">+      aDefaultCharset);</span>
<a href="#l9.139"></a><span id="l9.139" class="difflineplus">+    if (aUnfold) {</span>
<a href="#l9.140"></a><span id="l9.140" class="difflineplus">+      value = value.replace(/[\r\n]\t/g, ' ')</span>
<a href="#l9.141"></a><span id="l9.141" class="difflineplus">+                   .replace(/[\r\n]/g, '');</span>
<a href="#l9.142"></a><span id="l9.142" class="difflineplus">+    }</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineplus">+    return value;</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineplus">+  },</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineplus">+</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineplus">+  // This is identical to the above, except for factors that are handled by the</span>
<a href="#l9.147"></a><span id="l9.147" class="difflineplus">+  // xpconnect conversion process</span>
<a href="#l9.148"></a><span id="l9.148" class="difflineplus">+  decodeMimeHeaderToUTF8: function () {</span>
<a href="#l9.149"></a><span id="l9.149" class="difflineplus">+    return this.decodeMimeHeader.apply(this, arguments);</span>
<a href="#l9.150"></a><span id="l9.150" class="difflineplus">+  },</span>
<a href="#l9.151"></a><span id="l9.151" class="difflineplus">+};</span>
<a href="#l9.152"></a><span id="l9.152" class="difflineplus">+</span>
<a href="#l9.153"></a><span id="l9.153" class="difflineplus">+var components = [MimeHeaders, MimeAddressParser, MimeConverter];</span>
<a href="#l9.154"></a><span id="l9.154"> var NSGetFactory = XPCOMUtils.generateNSGetFactory(components);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/mime/src/mimei.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/mime/src/mimei.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -51,17 +51,16 @@</span>
<a href="#l10.4"></a><span id="l10.4"> #include &quot;prenv.h&quot;</span>
<a href="#l10.5"></a><span id="l10.5"> #include &quot;plstr.h&quot;</span>
<a href="#l10.6"></a><span id="l10.6"> #include &quot;prlink.h&quot;</span>
<a href="#l10.7"></a><span id="l10.7"> #include &quot;prprf.h&quot;</span>
<a href="#l10.8"></a><span id="l10.8"> #include &quot;mimecth.h&quot;</span>
<a href="#l10.9"></a><span id="l10.9"> #include &quot;mimebuf.h&quot;</span>
<a href="#l10.10"></a><span id="l10.10"> #include &quot;nsIServiceManager.h&quot;</span>
<a href="#l10.11"></a><span id="l10.11"> #include &quot;mimemoz2.h&quot;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-#include &quot;comi18n.h&quot;</span>
<a href="#l10.13"></a><span id="l10.13"> #include &quot;nsIMimeContentTypeHandler.h&quot;</span>
<a href="#l10.14"></a><span id="l10.14"> #include &quot;nsIComponentManager.h&quot;</span>
<a href="#l10.15"></a><span id="l10.15"> #include &quot;nsCategoryManagerUtils.h&quot;</span>
<a href="#l10.16"></a><span id="l10.16"> #include &quot;nsXPCOMCID.h&quot;</span>
<a href="#l10.17"></a><span id="l10.17"> #include &quot;nsISimpleMimeConverter.h&quot;</span>
<a href="#l10.18"></a><span id="l10.18"> #include &quot;nsSimpleMimeConverterStub.h&quot;</span>
<a href="#l10.19"></a><span id="l10.19"> #include &quot;nsVoidArray.h&quot;</span>
<a href="#l10.20"></a><span id="l10.20"> #include &quot;nsMimeStringResources.h&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/mime/src/mimemoz2.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/mime/src/mimemoz2.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -19,17 +19,16 @@</span>
<a href="#l11.4"></a><span id="l11.4"> #include &quot;mimebuf.h&quot;</span>
<a href="#l11.5"></a><span id="l11.5"> #include &quot;prmem.h&quot;</span>
<a href="#l11.6"></a><span id="l11.6"> #include &quot;plstr.h&quot;</span>
<a href="#l11.7"></a><span id="l11.7"> #include &quot;prmem.h&quot;</span>
<a href="#l11.8"></a><span id="l11.8"> #include &quot;mimemoz2.h&quot;</span>
<a href="#l11.9"></a><span id="l11.9"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l11.10"></a><span id="l11.10"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l11.11"></a><span id="l11.11"> #include &quot;nsIServiceManager.h&quot;</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-#include &quot;comi18n.h&quot;</span>
<a href="#l11.13"></a><span id="l11.13"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l11.14"></a><span id="l11.14"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l11.15"></a><span id="l11.15"> #include &quot;nsMimeStringResources.h&quot;</span>
<a href="#l11.16"></a><span id="l11.16"> #include &quot;nsStreamConverter.h&quot;</span>
<a href="#l11.17"></a><span id="l11.17"> #include &quot;nsIMsgSend.h&quot;</span>
<a href="#l11.18"></a><span id="l11.18"> #include &quot;nsIMsgMailNewsUrl.h&quot;</span>
<a href="#l11.19"></a><span id="l11.19"> #include &quot;mozITXTToHTMLConv.h&quot;</span>
<a href="#l11.20"></a><span id="l11.20"> #include &quot;nsCExternalHandlerService.h&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/mime/src/moz.build</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/mime/src/moz.build</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -1,15 +1,14 @@</span>
<a href="#l12.4"></a><span id="l12.4"> # vim: set filetype=python:</span>
<a href="#l12.5"></a><span id="l12.5"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l12.6"></a><span id="l12.6"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l12.7"></a><span id="l12.7"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l12.8"></a><span id="l12.8"> </span>
<a href="#l12.9"></a><span id="l12.9"> EXPORTS += [</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineminus">-    'comi18n.h',</span>
<a href="#l12.11"></a><span id="l12.11">     'mimecont.h',</span>
<a href="#l12.12"></a><span id="l12.12">     'mimecryp.h',</span>
<a href="#l12.13"></a><span id="l12.13">     'mimecth.h',</span>
<a href="#l12.14"></a><span id="l12.14">     'mimehdrs.h',</span>
<a href="#l12.15"></a><span id="l12.15">     'mimei.h',</span>
<a href="#l12.16"></a><span id="l12.16">     'mimeleaf.h',</span>
<a href="#l12.17"></a><span id="l12.17">     'mimemoz2.h',</span>
<a href="#l12.18"></a><span id="l12.18">     'mimemsig.h',</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineat">@@ -58,17 +57,16 @@ SOURCES += [</span>
<a href="#l12.20"></a><span id="l12.20">     'mimetext.cpp',</span>
<a href="#l12.21"></a><span id="l12.21">     'mimethpl.cpp',</span>
<a href="#l12.22"></a><span id="l12.22">     'mimethsa.cpp',</span>
<a href="#l12.23"></a><span id="l12.23">     'mimethtm.cpp',</span>
<a href="#l12.24"></a><span id="l12.24">     'mimetpfl.cpp',</span>
<a href="#l12.25"></a><span id="l12.25">     'mimetpla.cpp',</span>
<a href="#l12.26"></a><span id="l12.26">     'mimetric.cpp',</span>
<a href="#l12.27"></a><span id="l12.27">     'mimeunty.cpp',</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineminus">-    'nsMimeConverter.cpp',</span>
<a href="#l12.29"></a><span id="l12.29">     'nsMimeObjectClassAccess.cpp',</span>
<a href="#l12.30"></a><span id="l12.30">     'nsSimpleMimeConverterStub.cpp',</span>
<a href="#l12.31"></a><span id="l12.31">     'nsStreamConverter.cpp',</span>
<a href="#l12.32"></a><span id="l12.32"> ]</span>
<a href="#l12.33"></a><span id="l12.33"> </span>
<a href="#l12.34"></a><span id="l12.34"> EXTRA_COMPONENTS += [</span>
<a href="#l12.35"></a><span id="l12.35">     'mimeJSComponents.js',</span>
<a href="#l12.36"></a><span id="l12.36">     'msgMime.manifest',</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/mime/src/msgMime.manifest</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/mime/src/msgMime.manifest</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -1,4 +1,6 @@</span>
<a href="#l13.4"></a><span id="l13.4"> component {d1258011-f391-44fd-992e-c6f4b461a42f} mimeJSComponents.js</span>
<a href="#l13.5"></a><span id="l13.5"> component {96bd8769-2d0e-4440-963d-22b97fb3ba77} mimeJSComponents.js</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineplus">+component {93f8c049-80ed-4dda-9000-94ad8daba44c} mimeJSComponents.js</span>
<a href="#l13.7"></a><span id="l13.7"> contract @mozilla.org/messenger/mimeheaders;1 {d1258011-f391-44fd-992e-c6f4b461a42f}</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineplus">+contract @mozilla.org/messenger/mimeconverter;1 {93f8c049-80ed-4dda-9000-94ad8daba44c}</span>
<a href="#l13.9"></a><span id="l13.9"> contract @mozilla.org/messenger/headerparser;1 {96bd8769-2d0e-4440-963d-22b97fb3ba77}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">deleted file mode 100644</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineminus">--- a/mailnews/mime/src/nsMimeConverter.cpp</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineplus">+++ /dev/null</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineat">@@ -1,76 +0,0 @@</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l14.7"></a><span id="l14.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l14.9"></a><span id="l14.9" class="difflineminus">-#include &lt;stdio.h&gt;</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineminus">-#include &quot;mimecom.h&quot;</span>
<a href="#l14.11"></a><span id="l14.11" class="difflineminus">-#include &quot;modmimee.h&quot;</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-#include &quot;nscore.h&quot;</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-#include &quot;nsMimeConverter.h&quot;</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">-#include &quot;comi18n.h&quot;</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineminus">-#include &quot;nsMsgI18N.h&quot;</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineminus">-#include &quot;prmem.h&quot;</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineminus">-#include &quot;plstr.h&quot;</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineminus">-</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineminus">-NS_IMPL_ISUPPORTS(nsMimeConverter, nsIMimeConverter)</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineminus">-</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineminus">-/*</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineminus">- * nsMimeConverter definitions....</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineminus">- */</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineminus">-</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineminus">-/* </span>
<a href="#l14.26"></a><span id="l14.26" class="difflineminus">- * Inherited methods for nsMimeConverter</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineminus">- */</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineminus">-nsMimeConverter::nsMimeConverter()</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineminus">-{</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineminus">-}</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">-nsMimeConverter::~nsMimeConverter()</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineminus">-{</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineminus">-}</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineminus">-</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineminus">-nsresult</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineminus">-nsMimeConverter::DecodeMimeHeaderToUTF8(const nsACString &amp;header,</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineminus">-                                        const char *default_charset,</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineminus">-                                        bool override_charset,</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineminus">-                                        bool eatContinuations,</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineminus">-                                        nsACString &amp;result)</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineminus">-{</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineminus">-  MIME_DecodeMimeHeader(PromiseFlatCString(header).get(), default_charset,</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineminus">-                        override_charset, eatContinuations, result);</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineminus">-  return NS_OK;</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineminus">-}</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineminus">-</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineminus">-// Decode routine (also converts output to unicode)</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineminus">-nsresult</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineminus">-nsMimeConverter::DecodeMimeHeader(const char *header,</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineminus">-                                  const char *default_charset,</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineminus">-                                  bool override_charset,</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineminus">-                                  bool eatContinuations,</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineminus">-                                  nsAString&amp; decodedString)</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineminus">-{</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineminus">-  NS_ENSURE_ARG_POINTER(header);</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineminus">-</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineminus">-  // apply MIME decode.</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineminus">-  nsCString decodedCString;</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineminus">-  MIME_DecodeMimeHeader(header, default_charset, override_charset,</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineminus">-                        eatContinuations, decodedCString);</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineminus">-  CopyUTF8toUTF16(decodedCString.IsEmpty() ? nsDependentCString(header)</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineminus">-                                           : decodedCString,</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineminus">-                  decodedString);</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineminus">-  return NS_OK;</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineminus">-}</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineminus">-</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineminus">-nsresult</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineminus">-nsMimeConverter::EncodeMimePartIIStr_UTF8(const nsACString &amp;header,</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineminus">-                                          bool             structured,</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineminus">-                                          const char       *mailCharset,</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineminus">-                                          int32_t          fieldnamelen,</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineminus">-                                          int32_t          encodedWordSize,</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineminus">-                                          nsACString       &amp;encodedString)</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineminus">-{</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineminus">-  encodedString.Adopt(MIME_EncodeMimePartIIStr(PromiseFlatCString(header).get(),</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineminus">-                                               structured, mailCharset,</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineminus">-                                               fieldnamelen, encodedWordSize));</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineminus">-  return encodedString.IsVoid() ? NS_ERROR_FAILURE : NS_OK;</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1">deleted file mode 100644</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineminus">--- a/mailnews/mime/src/nsMimeConverter.h</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineplus">+++ /dev/null</span>
<a href="#l15.4"></a><span id="l15.4" class="difflineat">@@ -1,38 +0,0 @@</span>
<a href="#l15.5"></a><span id="l15.5" class="difflineminus">-/* -*- Mode: C; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l15.6"></a><span id="l15.6" class="difflineminus">- *</span>
<a href="#l15.7"></a><span id="l15.7" class="difflineminus">- * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l15.8"></a><span id="l15.8" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l15.9"></a><span id="l15.9" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l15.10"></a><span id="l15.10" class="difflineminus">- * This Original Code has been modified by IBM Corporation. Modifications made by IBM </span>
<a href="#l15.11"></a><span id="l15.11" class="difflineminus">- * described herein are Copyright (c) International Business Machines Corporation, 2000.</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">- * Modifications to Mozilla code or documentation identified per MPL Section 3.3</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">- *</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineminus">- * Date             Modified by     Description of modification</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineminus">- * 04/20/2000       IBM Corp.      OS/2 VisualAge build.</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineminus">- */</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineminus">- </span>
<a href="#l15.18"></a><span id="l15.18" class="difflineminus">-/*</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineminus">- * This interface is implemented by libmime. This interface is used by </span>
<a href="#l15.20"></a><span id="l15.20" class="difflineminus">- * a Content-Type handler &quot;Plug In&quot; (i.e. vCard) for accessing various </span>
<a href="#l15.21"></a><span id="l15.21" class="difflineminus">- * internal information about the object class system of libmime. When </span>
<a href="#l15.22"></a><span id="l15.22" class="difflineminus">- * libmime progresses to a C++ object class, this would probably change.</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineminus">- */</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineminus">-#ifndef nsMimeConverter_h_</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineminus">-#define nsMimeConverter_h_</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineminus">-</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineminus">-#include &quot;nsISupports.h&quot;</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineminus">-#include &quot;nsIMimeConverter.h&quot;</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineminus">-#include &quot;nsICharsetConverterManager.h&quot;</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">-</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineminus">-class nsMimeConverter : public nsIMimeConverter {</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineminus">-public:</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineminus">-  nsMimeConverter();</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineminus">-  virtual ~nsMimeConverter();</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineminus">-</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineminus">-  /* this macro defines QueryInterface, AddRef and Release for this class */</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineminus">-  NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineminus">-  NS_DECL_NSIMIMECONVERTER</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineminus">-};</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineminus">-</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineminus">-#endif /* nsMimeConverter_h_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/mime/src/nsStreamConverter.cpp</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/mime/src/nsStreamConverter.cpp</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -3,17 +3,16 @@</span>
<a href="#l16.4"></a><span id="l16.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l16.5"></a><span id="l16.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l16.6"></a><span id="l16.6"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l16.7"></a><span id="l16.7"> #include &lt;stdio.h&gt;</span>
<a href="#l16.8"></a><span id="l16.8"> #include &quot;mimecom.h&quot;</span>
<a href="#l16.9"></a><span id="l16.9"> #include &quot;modmimee.h&quot;</span>
<a href="#l16.10"></a><span id="l16.10"> #include &quot;nscore.h&quot;</span>
<a href="#l16.11"></a><span id="l16.11"> #include &quot;nsStreamConverter.h&quot;</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-#include &quot;comi18n.h&quot;</span>
<a href="#l16.13"></a><span id="l16.13"> #include &quot;prmem.h&quot;</span>
<a href="#l16.14"></a><span id="l16.14"> #include &quot;prprf.h&quot;</span>
<a href="#l16.15"></a><span id="l16.15"> #include &quot;prlog.h&quot;</span>
<a href="#l16.16"></a><span id="l16.16"> #include &quot;plstr.h&quot;</span>
<a href="#l16.17"></a><span id="l16.17"> #include &quot;mimemoz2.h&quot;</span>
<a href="#l16.18"></a><span id="l16.18"> #include &quot;nsMimeTypes.h&quot;</span>
<a href="#l16.19"></a><span id="l16.19"> #include &quot;nsIComponentManager.h&quot;</span>
<a href="#l16.20"></a><span id="l16.20"> #include &quot;nsIURL.h&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/mime/test/unit/test_EncodeMimePartIIStr_UTF8.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/mime/test/unit/test_EncodeMimePartIIStr_UTF8.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -10,17 +10,17 @@ function run_test() {</span>
<a href="#l17.4"></a><span id="l17.4">   var i;</span>
<a href="#l17.5"></a><span id="l17.5"> </span>
<a href="#l17.6"></a><span id="l17.6">   var checks =</span>
<a href="#l17.7"></a><span id="l17.7">   [</span>
<a href="#l17.8"></a><span id="l17.8">     [&quot;&quot;, false, &quot;&quot;],</span>
<a href="#l17.9"></a><span id="l17.9">     [&quot;\u0436&quot;, false, &quot;=?UTF-8?B?0LY=?=&quot;], //CYRILLIC SMALL LETTER ZHE</span>
<a href="#l17.10"></a><span id="l17.10">     [&quot;IamASCII&quot;, false, &quot;IamASCII&quot;],</span>
<a href="#l17.11"></a><span id="l17.11">     // Although an invalid email, we shouldn't crash on it (bug 479206)</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-    [&quot;crash test@foo.invalid&gt;&quot;, true, &quot;crash test@foo.invalid&gt;&quot;],</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+    [&quot;crash test@foo.invalid&gt;&quot;, true, &quot;\&quot;crash test\&quot;@foo.invalid&quot;],</span>
<a href="#l17.14"></a><span id="l17.14">   ];</span>
<a href="#l17.15"></a><span id="l17.15"> </span>
<a href="#l17.16"></a><span id="l17.16">   for (i = 0; i &lt; checks.length; ++i)</span>
<a href="#l17.17"></a><span id="l17.17">   {</span>
<a href="#l17.18"></a><span id="l17.18">     do_check_eq(</span>
<a href="#l17.19"></a><span id="l17.19">       MailServices.mimeConverter.encodeMimePartIIStr_UTF8(checks[i][0], checks[i][1], &quot;UTF-8&quot;, 0, 72),</span>
<a href="#l17.20"></a><span id="l17.20">       checks[i][2]);</span>
<a href="#l17.21"></a><span id="l17.21">   }</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

