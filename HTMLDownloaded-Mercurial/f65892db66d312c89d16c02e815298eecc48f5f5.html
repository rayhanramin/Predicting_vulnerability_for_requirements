<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 12229:f65892db66d312c89d16c02e815298eecc48f5f5</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ f65892db66d312c89d16c02e815298eecc48f5f5" />
<meta property="og:url" content="/comm-central/rev/f65892db66d312c89d16c02e815298eecc48f5f5" />
<meta property="og:description" content="Bug 852690 - Remaining conversion to mailServices.js in /mail/ and /mailnews/: internals. r=Standard8" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / f65892db66d312c89d16c02e815298eecc48f5f5 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/f65892db66d312c89d16c02e815298eecc48f5f5">shortlog</a> |
<a href="/comm-central/log/f65892db66d312c89d16c02e815298eecc48f5f5">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/f65892db66d312c89d16c02e815298eecc48f5f5">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/f65892db66d312c89d16c02e815298eecc48f5f5">files</a> |
changeset |
<a href="/comm-central/raw-rev/f65892db66d312c89d16c02e815298eecc48f5f5">raw</a>  | <a href="/comm-central/archive/f65892db66d312c89d16c02e815298eecc48f5f5.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=852690">Bug 852690</a> - Remaining conversion to mailServices.js in /mail/ and /mailnews/: internals. r=Standard8
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#83;&#101;&#98;&#97;&#115;&#116;&#105;&#97;&#110;&#32;&#72;&#101;&#110;&#103;&#115;&#116;&#32;&#60;&#97;&#114;&#99;&#104;&#97;&#101;&#111;&#112;&#116;&#101;&#114;&#121;&#120;&#64;&#99;&#111;&#111;&#108;&#101;&#45;&#102;&#105;&#108;&#101;&#115;&#46;&#100;&#101;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 29 Mar 2013 10:58:16 +0100</td></tr>

<tr>
 <td>changeset 12229</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/f65892db66d312c89d16c02e815298eecc48f5f5">f65892db66d312c89d16c02e815298eecc48f5f5</a></td>
</tr>



<tr>
<td>parent 12228</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/3a6a45f4bf240bc0e87d14e1069dbb60c2692e38">3a6a45f4bf240bc0e87d14e1069dbb60c2692e38</a>
</td>
</tr>

<tr>
<td>child 12230</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/5455891552e48fb6fac187c36fda444c9bde449d">5455891552e48fb6fac187c36fda444c9bde449d</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=f65892db66d312c89d16c02e815298eecc48f5f5">9052</a></td></tr>
<tr><td>push user</td><td>ryanvm@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Fri, 29 Mar 2013 18:51:13 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@0e410a62d2d8 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0e410a62d2d81576f3fe043548d65cd73ab8af03">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0e410a62d2d81576f3fe043548d65cd73ab8af03&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0e410a62d2d81576f3fe043548d65cd73ab8af03&newProject=comm-central&newRevision=006a18264170c6b44c66df01a863303f605343bf&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0e410a62d2d81576f3fe043548d65cd73ab8af03&newProject=comm-central&newRevision=006a18264170c6b44c66df01a863303f605343bf&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0e410a62d2d81576f3fe043548d65cd73ab8af03&newProject=comm-central&newRevision=006a18264170c6b44c66df01a863303f605343bf&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Standard8%29&revcount=50">Standard8</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=852690">852690</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=852690">Bug 852690</a> - Remaining conversion to mailServices.js in /mail/ and /mailnews/: internals. r=Standard8</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mail/base/modules/MailUtils.js">mail/base/modules/MailUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f65892db66d312c89d16c02e815298eecc48f5f5/mail/base/modules/MailUtils.js">file</a> |
<a href="/comm-central/annotate/f65892db66d312c89d16c02e815298eecc48f5f5/mail/base/modules/MailUtils.js">annotate</a> |
<a href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mail/base/modules/MailUtils.js">diff</a> |
<a href="/comm-central/comparison/f65892db66d312c89d16c02e815298eecc48f5f5/mail/base/modules/MailUtils.js">comparison</a> |
<a href="/comm-central/log/f65892db66d312c89d16c02e815298eecc48f5f5/mail/base/modules/MailUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mail/base/modules/dbViewWrapper.js">mail/base/modules/dbViewWrapper.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f65892db66d312c89d16c02e815298eecc48f5f5/mail/base/modules/dbViewWrapper.js">file</a> |
<a href="/comm-central/annotate/f65892db66d312c89d16c02e815298eecc48f5f5/mail/base/modules/dbViewWrapper.js">annotate</a> |
<a href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mail/base/modules/dbViewWrapper.js">diff</a> |
<a href="/comm-central/comparison/f65892db66d312c89d16c02e815298eecc48f5f5/mail/base/modules/dbViewWrapper.js">comparison</a> |
<a href="/comm-central/log/f65892db66d312c89d16c02e815298eecc48f5f5/mail/base/modules/dbViewWrapper.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mail/base/modules/mailInstrumentation.js">mail/base/modules/mailInstrumentation.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f65892db66d312c89d16c02e815298eecc48f5f5/mail/base/modules/mailInstrumentation.js">file</a> |
<a href="/comm-central/annotate/f65892db66d312c89d16c02e815298eecc48f5f5/mail/base/modules/mailInstrumentation.js">annotate</a> |
<a href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mail/base/modules/mailInstrumentation.js">diff</a> |
<a href="/comm-central/comparison/f65892db66d312c89d16c02e815298eecc48f5f5/mail/base/modules/mailInstrumentation.js">comparison</a> |
<a href="/comm-central/log/f65892db66d312c89d16c02e815298eecc48f5f5/mail/base/modules/mailInstrumentation.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mail/base/test/unit/test_alertHook.js">mail/base/test/unit/test_alertHook.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f65892db66d312c89d16c02e815298eecc48f5f5/mail/base/test/unit/test_alertHook.js">file</a> |
<a href="/comm-central/annotate/f65892db66d312c89d16c02e815298eecc48f5f5/mail/base/test/unit/test_alertHook.js">annotate</a> |
<a href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mail/base/test/unit/test_alertHook.js">diff</a> |
<a href="/comm-central/comparison/f65892db66d312c89d16c02e815298eecc48f5f5/mail/base/test/unit/test_alertHook.js">comparison</a> |
<a href="/comm-central/log/f65892db66d312c89d16c02e815298eecc48f5f5/mail/base/test/unit/test_alertHook.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mail/components/nsMailDefaultHandler.js">mail/components/nsMailDefaultHandler.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f65892db66d312c89d16c02e815298eecc48f5f5/mail/components/nsMailDefaultHandler.js">file</a> |
<a href="/comm-central/annotate/f65892db66d312c89d16c02e815298eecc48f5f5/mail/components/nsMailDefaultHandler.js">annotate</a> |
<a href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mail/components/nsMailDefaultHandler.js">diff</a> |
<a href="/comm-central/comparison/f65892db66d312c89d16c02e815298eecc48f5f5/mail/components/nsMailDefaultHandler.js">comparison</a> |
<a href="/comm-central/log/f65892db66d312c89d16c02e815298eecc48f5f5/mail/components/nsMailDefaultHandler.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mail/test/mozmill/instrumentation/test-instrument-setup.js">mail/test/mozmill/instrumentation/test-instrument-setup.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f65892db66d312c89d16c02e815298eecc48f5f5/mail/test/mozmill/instrumentation/test-instrument-setup.js">file</a> |
<a href="/comm-central/annotate/f65892db66d312c89d16c02e815298eecc48f5f5/mail/test/mozmill/instrumentation/test-instrument-setup.js">annotate</a> |
<a href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mail/test/mozmill/instrumentation/test-instrument-setup.js">diff</a> |
<a href="/comm-central/comparison/f65892db66d312c89d16c02e815298eecc48f5f5/mail/test/mozmill/instrumentation/test-instrument-setup.js">comparison</a> |
<a href="/comm-central/log/f65892db66d312c89d16c02e815298eecc48f5f5/mail/test/mozmill/instrumentation/test-instrument-setup.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/src/newMailNotificationService.js">mailnews/base/src/newMailNotificationService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/src/newMailNotificationService.js">file</a> |
<a href="/comm-central/annotate/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/src/newMailNotificationService.js">annotate</a> |
<a href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/src/newMailNotificationService.js">diff</a> |
<a href="/comm-central/comparison/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/src/newMailNotificationService.js">comparison</a> |
<a href="/comm-central/log/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/src/newMailNotificationService.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_bug404489.js">mailnews/base/test/unit/test_bug404489.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_bug404489.js">file</a> |
<a href="/comm-central/annotate/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_bug404489.js">annotate</a> |
<a href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_bug404489.js">diff</a> |
<a href="/comm-central/comparison/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_bug404489.js">comparison</a> |
<a href="/comm-central/log/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_bug404489.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_bug428427.js">mailnews/base/test/unit/test_bug428427.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_bug428427.js">file</a> |
<a href="/comm-central/annotate/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_bug428427.js">annotate</a> |
<a href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_bug428427.js">diff</a> |
<a href="/comm-central/comparison/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_bug428427.js">comparison</a> |
<a href="/comm-central/log/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_bug428427.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_bug465805.js">mailnews/base/test/unit/test_bug465805.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_bug465805.js">file</a> |
<a href="/comm-central/annotate/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_bug465805.js">annotate</a> |
<a href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_bug465805.js">diff</a> |
<a href="/comm-central/comparison/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_bug465805.js">comparison</a> |
<a href="/comm-central/log/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_bug465805.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_bug471682.js">mailnews/base/test/unit/test_bug471682.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_bug471682.js">file</a> |
<a href="/comm-central/annotate/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_bug471682.js">annotate</a> |
<a href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_bug471682.js">diff</a> |
<a href="/comm-central/comparison/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_bug471682.js">comparison</a> |
<a href="/comm-central/log/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_bug471682.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_copyChaining.js">mailnews/base/test/unit/test_copyChaining.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_copyChaining.js">file</a> |
<a href="/comm-central/annotate/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_copyChaining.js">annotate</a> |
<a href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_copyChaining.js">diff</a> |
<a href="/comm-central/comparison/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_copyChaining.js">comparison</a> |
<a href="/comm-central/log/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_copyChaining.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_copyThenMoveManual.js">mailnews/base/test/unit/test_copyThenMoveManual.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_copyThenMoveManual.js">file</a> |
<a href="/comm-central/annotate/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_copyThenMoveManual.js">annotate</a> |
<a href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_copyThenMoveManual.js">diff</a> |
<a href="/comm-central/comparison/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_copyThenMoveManual.js">comparison</a> |
<a href="/comm-central/log/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_copyThenMoveManual.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_detachToFile.js">mailnews/base/test/unit/test_detachToFile.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_detachToFile.js">file</a> |
<a href="/comm-central/annotate/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_detachToFile.js">annotate</a> |
<a href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_detachToFile.js">diff</a> |
<a href="/comm-central/comparison/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_detachToFile.js">comparison</a> |
<a href="/comm-central/log/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_detachToFile.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_fix_deferred_accounts.js">mailnews/base/test/unit/test_fix_deferred_accounts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_fix_deferred_accounts.js">file</a> |
<a href="/comm-central/annotate/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_fix_deferred_accounts.js">annotate</a> |
<a href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_fix_deferred_accounts.js">diff</a> |
<a href="/comm-central/comparison/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_fix_deferred_accounts.js">comparison</a> |
<a href="/comm-central/log/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_fix_deferred_accounts.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_folderCompact.js">mailnews/base/test/unit/test_folderCompact.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_folderCompact.js">file</a> |
<a href="/comm-central/annotate/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_folderCompact.js">annotate</a> |
<a href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_folderCompact.js">diff</a> |
<a href="/comm-central/comparison/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_folderCompact.js">comparison</a> |
<a href="/comm-central/log/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_folderCompact.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_mimemaltdetach.js">mailnews/base/test/unit/test_mimemaltdetach.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_mimemaltdetach.js">file</a> |
<a href="/comm-central/annotate/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_mimemaltdetach.js">annotate</a> |
<a href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_mimemaltdetach.js">diff</a> |
<a href="/comm-central/comparison/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_mimemaltdetach.js">comparison</a> |
<a href="/comm-central/log/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_mimemaltdetach.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_nsIMsgFolder.js">mailnews/base/test/unit/test_nsIMsgFolder.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_nsIMsgFolder.js">file</a> |
<a href="/comm-central/annotate/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_nsIMsgFolder.js">annotate</a> |
<a href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_nsIMsgFolder.js">diff</a> |
<a href="/comm-central/comparison/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_nsIMsgFolder.js">comparison</a> |
<a href="/comm-central/log/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_nsIMsgFolder.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_nsIMsgFolderListener.js">mailnews/base/test/unit/test_nsIMsgFolderListener.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_nsIMsgFolderListener.js">file</a> |
<a href="/comm-central/annotate/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_nsIMsgFolderListener.js">annotate</a> |
<a href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_nsIMsgFolderListener.js">diff</a> |
<a href="/comm-central/comparison/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_nsIMsgFolderListener.js">comparison</a> |
<a href="/comm-central/log/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_nsIMsgFolderListener.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_nsIMsgTagService.js">mailnews/base/test/unit/test_nsIMsgTagService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_nsIMsgTagService.js">file</a> |
<a href="/comm-central/annotate/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_nsIMsgTagService.js">annotate</a> |
<a href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_nsIMsgTagService.js">diff</a> |
<a href="/comm-central/comparison/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_nsIMsgTagService.js">comparison</a> |
<a href="/comm-central/log/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_nsIMsgTagService.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_nsMsgMailSession_Alerts.js">mailnews/base/test/unit/test_nsMsgMailSession_Alerts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_nsMsgMailSession_Alerts.js">file</a> |
<a href="/comm-central/annotate/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_nsMsgMailSession_Alerts.js">annotate</a> |
<a href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_nsMsgMailSession_Alerts.js">diff</a> |
<a href="/comm-central/comparison/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_nsMsgMailSession_Alerts.js">comparison</a> |
<a href="/comm-central/log/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_nsMsgMailSession_Alerts.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_nsMsgMailSession_Listeners.js">mailnews/base/test/unit/test_nsMsgMailSession_Listeners.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_nsMsgMailSession_Listeners.js">file</a> |
<a href="/comm-central/annotate/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_nsMsgMailSession_Listeners.js">annotate</a> |
<a href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_nsMsgMailSession_Listeners.js">diff</a> |
<a href="/comm-central/comparison/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_nsMsgMailSession_Listeners.js">comparison</a> |
<a href="/comm-central/log/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_nsMsgMailSession_Listeners.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_postPluginFilters.js">mailnews/base/test/unit/test_postPluginFilters.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_postPluginFilters.js">file</a> |
<a href="/comm-central/annotate/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_postPluginFilters.js">annotate</a> |
<a href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_postPluginFilters.js">diff</a> |
<a href="/comm-central/comparison/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_postPluginFilters.js">comparison</a> |
<a href="/comm-central/log/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_postPluginFilters.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_quarantineFilterMove.js">mailnews/base/test/unit/test_quarantineFilterMove.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_quarantineFilterMove.js">file</a> |
<a href="/comm-central/annotate/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_quarantineFilterMove.js">annotate</a> |
<a href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_quarantineFilterMove.js">diff</a> |
<a href="/comm-central/comparison/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_quarantineFilterMove.js">comparison</a> |
<a href="/comm-central/log/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/test/unit/test_quarantineFilterMove.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/util/iteratorUtils.jsm">mailnews/base/util/iteratorUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/util/iteratorUtils.jsm">file</a> |
<a href="/comm-central/annotate/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/util/iteratorUtils.jsm">annotate</a> |
<a href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/util/iteratorUtils.jsm">diff</a> |
<a href="/comm-central/comparison/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/util/iteratorUtils.jsm">comparison</a> |
<a href="/comm-central/log/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/util/iteratorUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/util/msgDBCacheManager.js">mailnews/base/util/msgDBCacheManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/util/msgDBCacheManager.js">file</a> |
<a href="/comm-central/annotate/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/util/msgDBCacheManager.js">annotate</a> |
<a href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/util/msgDBCacheManager.js">diff</a> |
<a href="/comm-central/comparison/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/util/msgDBCacheManager.js">comparison</a> |
<a href="/comm-central/log/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/base/util/msgDBCacheManager.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/db/msgdb/test/unit/test_enumerator_cleanup.js">mailnews/db/msgdb/test/unit/test_enumerator_cleanup.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/db/msgdb/test/unit/test_enumerator_cleanup.js">file</a> |
<a href="/comm-central/annotate/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/db/msgdb/test/unit/test_enumerator_cleanup.js">annotate</a> |
<a href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/db/msgdb/test/unit/test_enumerator_cleanup.js">diff</a> |
<a href="/comm-central/comparison/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/db/msgdb/test/unit/test_enumerator_cleanup.js">comparison</a> |
<a href="/comm-central/log/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/db/msgdb/test/unit/test_enumerator_cleanup.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/db/msgdb/test/unit/test_propertyEnumerator.js">mailnews/db/msgdb/test/unit/test_propertyEnumerator.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/db/msgdb/test/unit/test_propertyEnumerator.js">file</a> |
<a href="/comm-central/annotate/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/db/msgdb/test/unit/test_propertyEnumerator.js">annotate</a> |
<a href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/db/msgdb/test/unit/test_propertyEnumerator.js">diff</a> |
<a href="/comm-central/comparison/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/db/msgdb/test/unit/test_propertyEnumerator.js">comparison</a> |
<a href="/comm-central/log/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/db/msgdb/test/unit/test_propertyEnumerator.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/db/msgdb/test/unit/test_references_parsing.js">mailnews/db/msgdb/test/unit/test_references_parsing.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/db/msgdb/test/unit/test_references_parsing.js">file</a> |
<a href="/comm-central/annotate/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/db/msgdb/test/unit/test_references_parsing.js">annotate</a> |
<a href="/comm-central/diff/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/db/msgdb/test/unit/test_references_parsing.js">diff</a> |
<a href="/comm-central/comparison/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/db/msgdb/test/unit/test_references_parsing.js">comparison</a> |
<a href="/comm-central/log/f65892db66d312c89d16c02e815298eecc48f5f5/mailnews/db/msgdb/test/unit/test_references_parsing.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/modules/MailUtils.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/modules/MailUtils.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -4,35 +4,34 @@</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5"> var EXPORTED_SYMBOLS = [&quot;MailUtils&quot;];</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> const Cc = Components.classes;</span>
<a href="#l1.8"></a><span id="l1.8"> const Ci = Components.interfaces;</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10"> Components.utils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l1.11"></a><span id="l1.11"> Components.utils.import(&quot;resource:///modules/MailConsts.js&quot;);</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l1.13"></a><span id="l1.13"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l1.14"></a><span id="l1.14"> const MC = MailConsts;</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16"> /**</span>
<a href="#l1.17"></a><span id="l1.17">  * This module has several utility functions for use by both core and</span>
<a href="#l1.18"></a><span id="l1.18">  * third-party code. Some functions are aimed at code that doesn't have a</span>
<a href="#l1.19"></a><span id="l1.19">  * window context, while others can be used anywhere.</span>
<a href="#l1.20"></a><span id="l1.20">  */</span>
<a href="#l1.21"></a><span id="l1.21"> var MailUtils =</span>
<a href="#l1.22"></a><span id="l1.22"> {</span>
<a href="#l1.23"></a><span id="l1.23">   /**</span>
<a href="#l1.24"></a><span id="l1.24">    * Discover all folders. This is useful during startup, when you have code</span>
<a href="#l1.25"></a><span id="l1.25">    * that deals with folders and that executes before the main 3pane window is</span>
<a href="#l1.26"></a><span id="l1.26">    * open (the folder tree wouldn't have been initialized yet).</span>
<a href="#l1.27"></a><span id="l1.27">    */</span>
<a href="#l1.28"></a><span id="l1.28">   discoverFolders: function MailUtils_discoverFolders() {</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineminus">-    let accountManager = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-                           .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-    let servers = accountManager.allServers;</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+    let servers = MailServices.accounts.allServers;</span>
<a href="#l1.33"></a><span id="l1.33">     for each (let server in fixIterator(servers, Ci.nsIMsgIncomingServer)) {</span>
<a href="#l1.34"></a><span id="l1.34">       // Bug 466311 Sometimes this can throw file not found, we're unsure</span>
<a href="#l1.35"></a><span id="l1.35">       // why, but catch it and log the fact.</span>
<a href="#l1.36"></a><span id="l1.36">       try {</span>
<a href="#l1.37"></a><span id="l1.37">         server.rootFolder.subFolders;</span>
<a href="#l1.38"></a><span id="l1.38">       }</span>
<a href="#l1.39"></a><span id="l1.39">       catch (ex) {</span>
<a href="#l1.40"></a><span id="l1.40">         Services.console.logStringMessage(&quot;Discovering folders for account failed with &quot; +</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineat">@@ -50,19 +49,17 @@ var MailUtils =</span>
<a href="#l1.42"></a><span id="l1.42">    * out the folder using the file's path.</span>
<a href="#l1.43"></a><span id="l1.43">    *</span>
<a href="#l1.44"></a><span id="l1.44">    * @param aFile the nsILocalFile to convert to a folder</span>
<a href="#l1.45"></a><span id="l1.45">    * @returns the nsIMsgFolder corresponding to aFile, or null if the folder</span>
<a href="#l1.46"></a><span id="l1.46">    *          isn't found</span>
<a href="#l1.47"></a><span id="l1.47">    */</span>
<a href="#l1.48"></a><span id="l1.48">   getFolderForFileInProfile:</span>
<a href="#l1.49"></a><span id="l1.49">       function MailUtils_getFolderForFileInProfile(aFile) {</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-    let accountManager = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineminus">-                           .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-    let folders = accountManager.allFolders;</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+    let folders = MailServices.accounts.allFolders;</span>
<a href="#l1.54"></a><span id="l1.54"> </span>
<a href="#l1.55"></a><span id="l1.55">     for (let folder in fixIterator(folders, Ci.nsIMsgFolder)) {</span>
<a href="#l1.56"></a><span id="l1.56">       if (folder.filePath.equals(aFile))</span>
<a href="#l1.57"></a><span id="l1.57">         return folder;</span>
<a href="#l1.58"></a><span id="l1.58">     }</span>
<a href="#l1.59"></a><span id="l1.59">     return null;</span>
<a href="#l1.60"></a><span id="l1.60">   },</span>
<a href="#l1.61"></a><span id="l1.61"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/modules/dbViewWrapper.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/modules/dbViewWrapper.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -4,16 +4,17 @@</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5"> const EXPORTED_SYMBOLS = ['DBViewWrapper', 'IDBViewWrapperListener'];</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7"> const Cc = Components.classes;</span>
<a href="#l2.8"></a><span id="l2.8"> const Ci = Components.interfaces;</span>
<a href="#l2.9"></a><span id="l2.9"> const Cr = Components.results;</span>
<a href="#l2.10"></a><span id="l2.10"> const Cu = Components.utils;</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+Cu.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l2.13"></a><span id="l2.13"> Cu.import(&quot;resource:///modules/mailViewManager.js&quot;);</span>
<a href="#l2.14"></a><span id="l2.14"> Cu.import(&quot;resource:///modules/searchSpec.js&quot;);</span>
<a href="#l2.15"></a><span id="l2.15"> Cu.import(&quot;resource:///modules/virtualFolderWrapper.js&quot;);</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17"> const nsMsgFolderFlags = Ci.nsMsgFolderFlags;</span>
<a href="#l2.18"></a><span id="l2.18"> const nsMsgViewType = Ci.nsMsgViewType;</span>
<a href="#l2.19"></a><span id="l2.19"> const nsMsgViewFlagsType = Ci.nsMsgViewFlagsType;</span>
<a href="#l2.20"></a><span id="l2.20"> const nsMsgViewSortType = Ci.nsMsgViewSortType;</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineat">@@ -55,28 +56,22 @@ var FolderNotificationHelper = {</span>
<a href="#l2.22"></a><span id="l2.22"> </span>
<a href="#l2.23"></a><span id="l2.23">   /**</span>
<a href="#l2.24"></a><span id="l2.24">    * Initialize our listeners.  We currently don't bother cleaning these up</span>
<a href="#l2.25"></a><span id="l2.25">    *  because we are a singleton and if anyone imports us, they probably want</span>
<a href="#l2.26"></a><span id="l2.26">    *  us for as long as their application so shall live.</span>
<a href="#l2.27"></a><span id="l2.27">    */</span>
<a href="#l2.28"></a><span id="l2.28">   _init: function FolderNotificationHelper__init() {</span>
<a href="#l2.29"></a><span id="l2.29">     // register with the session for our folded loaded notifications</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-    let mailSession =</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-      Cc[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-        .getService(Ci.nsIMsgMailSession);</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-    mailSession.AddFolderListener(this,</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-                                  Ci.nsIFolderListener.event |</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-                                  Ci.nsIFolderListener.intPropertyChanged);</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+    MailServices.mailSession.AddFolderListener(this,</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+                                               Ci.nsIFolderListener.event |</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+                                               Ci.nsIFolderListener.intPropertyChanged);</span>
<a href="#l2.39"></a><span id="l2.39"> </span>
<a href="#l2.40"></a><span id="l2.40">     // register with the notification service for deleted folder notifications</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-    let notificationService =</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineminus">-      Cc[&quot;@mozilla.org/messenger/msgnotificationservice;1&quot;]</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineminus">-        .getService(Ci.nsIMsgFolderNotificationService);</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-    notificationService.addListener(this,</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+    MailServices.mfn.addListener(this,</span>
<a href="#l2.46"></a><span id="l2.46">       Ci.nsIMsgFolderNotificationService.folderDeleted |</span>
<a href="#l2.47"></a><span id="l2.47">       // we need to track renames because we key off of URIs. frick.</span>
<a href="#l2.48"></a><span id="l2.48">       Ci.nsIMsgFolderNotificationService.folderRenamed |</span>
<a href="#l2.49"></a><span id="l2.49">       Ci.nsIMsgFolderNotificationService.folderMoveCopyCompleted);</span>
<a href="#l2.50"></a><span id="l2.50">   },</span>
<a href="#l2.51"></a><span id="l2.51"> </span>
<a href="#l2.52"></a><span id="l2.52">   /**</span>
<a href="#l2.53"></a><span id="l2.53">    * Call updateFolder, and assuming all goes well, request that the provided</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/base/modules/mailInstrumentation.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/base/modules/mailInstrumentation.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -10,18 +10,16 @@</span>
<a href="#l3.4"></a><span id="l3.4"> </span>
<a href="#l3.5"></a><span id="l3.5"> const EXPORTED_SYMBOLS = [&quot;mailInstrumentationManager&quot;];</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7"> const Cc = Components.classes;</span>
<a href="#l3.8"></a><span id="l3.8"> const Ci = Components.interfaces;</span>
<a href="#l3.9"></a><span id="l3.9"> const Cu = Components.utils;</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11"> const nsIMFNService = Ci.nsIMsgFolderNotificationService;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-var gMFNService = Cc[&quot;@mozilla.org/messenger/msgnotificationservice;1&quot;]</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-                     .getService(nsIMFNService);</span>
<a href="#l3.14"></a><span id="l3.14"> </span>
<a href="#l3.15"></a><span id="l3.15"> Cu.import(&quot;resource:///modules/IOUtils.js&quot;);</span>
<a href="#l3.16"></a><span id="l3.16"> Cu.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l3.17"></a><span id="l3.17"> Cu.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l3.18"></a><span id="l3.18"> </span>
<a href="#l3.19"></a><span id="l3.19"> /* :::::::: The Module ::::::::::::::: */</span>
<a href="#l3.20"></a><span id="l3.20"> </span>
<a href="#l3.21"></a><span id="l3.21"> var mailInstrumentationManager =</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineat">@@ -44,17 +42,17 @@ var mailInstrumentationManager =</span>
<a href="#l3.23"></a><span id="l3.23">   observe: function (aSubject, aTopic, aState) {</span>
<a href="#l3.24"></a><span id="l3.24">     if (aTopic == &quot;mail:composeSendSucceeded&quot;)</span>
<a href="#l3.25"></a><span id="l3.25">       mailInstrumentationManager.addEvent(&quot;msgSent&quot;, true);</span>
<a href="#l3.26"></a><span id="l3.26">     else if (aTopic == &quot;mail:setAsDefault&quot;)</span>
<a href="#l3.27"></a><span id="l3.27">       mailInstrumentationManager.addEvent(&quot;setAsDefault&quot;, true);</span>
<a href="#l3.28"></a><span id="l3.28"> </span>
<a href="#l3.29"></a><span id="l3.29">   },</span>
<a href="#l3.30"></a><span id="l3.30">   msgAdded: function (aMsg) {</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-    gMFNService.removeListener(this);</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+    MailServices.mfn.removeListener(this);</span>
<a href="#l3.33"></a><span id="l3.33">     this._mfnListener = false;</span>
<a href="#l3.34"></a><span id="l3.34">     mailInstrumentationManager.addEvent(&quot;msgDownloaded&quot;, true);</span>
<a href="#l3.35"></a><span id="l3.35">   },</span>
<a href="#l3.36"></a><span id="l3.36"> </span>
<a href="#l3.37"></a><span id="l3.37">   _accountsChanged: function() {</span>
<a href="#l3.38"></a><span id="l3.38">     // check if there are at least two accounts - one is local folders account</span>
<a href="#l3.39"></a><span id="l3.39">     if (Services.prefs.getCharPref(&quot;mail.accountmanager.accounts&quot;).contains(',', 1)) {</span>
<a href="#l3.40"></a><span id="l3.40">       mailInstrumentationManager.addEvent(&quot;accountAdded&quot;, true);</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineat">@@ -194,27 +192,27 @@ var mailInstrumentationManager =</span>
<a href="#l3.42"></a><span id="l3.42">     this._loadState();</span>
<a href="#l3.43"></a><span id="l3.43">     Services.obs.addObserver(this, &quot;mail:composeSendSucceeded&quot;, false);</span>
<a href="#l3.44"></a><span id="l3.44">     Services.obs.addObserver(this, &quot;mail:setAsDefault&quot;, false);</span>
<a href="#l3.45"></a><span id="l3.45">     Services.prefs.addObserver(&quot;mail.accountmanager.accounts&quot;,</span>
<a href="#l3.46"></a><span id="l3.46">                                this._accountsChanged, false);</span>
<a href="#l3.47"></a><span id="l3.47">     Services.prefs.addObserver(&quot;mail.instrumentation.userOptedIn&quot;,</span>
<a href="#l3.48"></a><span id="l3.48">                                this._userOptedIn, false);</span>
<a href="#l3.49"></a><span id="l3.49">     Services.prefs.addObserver(&quot;mail.smtpservers&quot;, this._smtpServerAdded, false);</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-    gMFNService.addListener(this, nsIMFNService.msgAdded);</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+    MailServices.mfn.addListener(this, nsIMFNService.msgAdded);</span>
<a href="#l3.52"></a><span id="l3.52">     this._observersRegistered = true;</span>
<a href="#l3.53"></a><span id="l3.53">     this._mfnListener = true;</span>
<a href="#l3.54"></a><span id="l3.54">   },</span>
<a href="#l3.55"></a><span id="l3.55">   uninit: function() {</span>
<a href="#l3.56"></a><span id="l3.56">     if (!this._observersRegistered)</span>
<a href="#l3.57"></a><span id="l3.57">       return;</span>
<a href="#l3.58"></a><span id="l3.58">     Services.obs.removeObserver(this, &quot;mail:composeSendSucceeded&quot;);</span>
<a href="#l3.59"></a><span id="l3.59">     Services.obs.removeObserver(this, &quot;mail:setAsDefault&quot;);</span>
<a href="#l3.60"></a><span id="l3.60">     if (this._mfnListener)</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineminus">-      gMFNService.removeListener(this);</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+      MailServices.mfn.removeListener(this);</span>
<a href="#l3.63"></a><span id="l3.63">     Services.prefs.removeObserver(&quot;mail.accountmanager.accounts&quot;, this);</span>
<a href="#l3.64"></a><span id="l3.64">     Services.prefs.removeObserver(&quot;mail.instrumentation.userOptedIn&quot;, this);</span>
<a href="#l3.65"></a><span id="l3.65">     Services.prefs.removeObserver(&quot;mail.smtpservers&quot;, this);</span>
<a href="#l3.66"></a><span id="l3.66">   },</span>
<a href="#l3.67"></a><span id="l3.67">   /**</span>
<a href="#l3.68"></a><span id="l3.68">    * This adds an event to the current state, if it doesn't exist.</span>
<a href="#l3.69"></a><span id="l3.69">    */</span>
<a href="#l3.70"></a><span id="l3.70">   addEvent: function minst_addEvent(aEventKey, aData) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/base/test/unit/test_alertHook.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/base/test/unit/test_alertHook.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1,14 +1,15 @@</span>
<a href="#l4.4"></a><span id="l4.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.5"></a><span id="l4.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.6"></a><span id="l4.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l4.9"></a><span id="l4.9"> Components.utils.import(&quot;resource:///modules/activity/alertHook.js&quot;);</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l4.11"></a><span id="l4.11"> alertHook.init();</span>
<a href="#l4.12"></a><span id="l4.12"> </span>
<a href="#l4.13"></a><span id="l4.13"> // Replace the alerts service with our own. This will let us check if we're</span>
<a href="#l4.14"></a><span id="l4.14"> // prompting or not.</span>
<a href="#l4.15"></a><span id="l4.15"> var gAlertShown = false;</span>
<a href="#l4.16"></a><span id="l4.16"> </span>
<a href="#l4.17"></a><span id="l4.17"> var mockAlertsService = {</span>
<a href="#l4.18"></a><span id="l4.18">   QueryInterface: XPCOMUtils.generateQI([Ci.nsIAlertsService]),</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineat">@@ -44,33 +45,30 @@ var mailnewsURL = {</span>
<a href="#l4.20"></a><span id="l4.20"> </span>
<a href="#l4.21"></a><span id="l4.21"> function run_test() {</span>
<a href="#l4.22"></a><span id="l4.22">   // First register the mock alerts service</span>
<a href="#l4.23"></a><span id="l4.23">   Components.manager.QueryInterface(Ci.nsIComponentRegistrar)</span>
<a href="#l4.24"></a><span id="l4.24">     .registerFactory(Components.ID(&quot;{1bda6c33-b089-43df-a8fd-111907d6385a}&quot;),</span>
<a href="#l4.25"></a><span id="l4.25">                      &quot;Mock Alerts Service&quot;, &quot;@mozilla.org/alerts-service;1&quot;,</span>
<a href="#l4.26"></a><span id="l4.26">                      mockAlertsServiceFactory);</span>
<a href="#l4.27"></a><span id="l4.27"> </span>
<a href="#l4.28"></a><span id="l4.28" class="difflineminus">-  let msgMailSession = Cc[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineminus">-                         .getService(Ci.nsIMsgMailSession);</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-</span>
<a href="#l4.31"></a><span id="l4.31">   // Just text, no url or window =&gt; expect no error shown to user</span>
<a href="#l4.32"></a><span id="l4.32">   gAlertShown = false;</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-  msgMailSession.alertUser(&quot;test error&quot;);</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+  MailServices.mailSession.alertUser(&quot;test error&quot;);</span>
<a href="#l4.35"></a><span id="l4.35">   do_check_false(gAlertShown);</span>
<a href="#l4.36"></a><span id="l4.36"> </span>
<a href="#l4.37"></a><span id="l4.37">   // Text, url and window =&gt; expect error shown to user</span>
<a href="#l4.38"></a><span id="l4.38">   gAlertShown = false;</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineminus">-  msgMailSession.alertUser(&quot;test error 2&quot;, mailnewsURL);</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+  MailServices.mailSession.alertUser(&quot;test error 2&quot;, mailnewsURL);</span>
<a href="#l4.41"></a><span id="l4.41">   do_check_true(gAlertShown);</span>
<a href="#l4.42"></a><span id="l4.42"> </span>
<a href="#l4.43"></a><span id="l4.43">   // Text, url and no window =&gt; export no error shown to user</span>
<a href="#l4.44"></a><span id="l4.44">   gAlertShown = false;</span>
<a href="#l4.45"></a><span id="l4.45">   gMsgWindow = null;</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineminus">-  msgMailSession.alertUser(&quot;test error 2&quot;, mailnewsURL);</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+  MailServices.mailSession.alertUser(&quot;test error 2&quot;, mailnewsURL);</span>
<a href="#l4.48"></a><span id="l4.48">   do_check_false(gAlertShown);</span>
<a href="#l4.49"></a><span id="l4.49"> </span>
<a href="#l4.50"></a><span id="l4.50">   // XXX There appears to be a shutdown leak within the activity manager when</span>
<a href="#l4.51"></a><span id="l4.51">   // unless it is cleaned up, however as it is only shutdown, it doesn't really</span>
<a href="#l4.52"></a><span id="l4.52">   // matter, so we'll just ignore it here.</span>
<a href="#l4.53"></a><span id="l4.53">   Cc[&quot;@mozilla.org/activity-manager;1&quot;]</span>
<a href="#l4.54"></a><span id="l4.54">     .getService(Ci.nsIActivityManager)</span>
<a href="#l4.55"></a><span id="l4.55">     .cleanUp();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/components/nsMailDefaultHandler.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/components/nsMailDefaultHandler.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -376,18 +376,16 @@ var nsMailDefaultHandler = {</span>
<a href="#l5.4"></a><span id="l5.4">               &quot;_blank&quot;,</span>
<a href="#l5.5"></a><span id="l5.5">               &quot;chrome,resizable=no,titlebar,modal,centerscreen&quot;,</span>
<a href="#l5.6"></a><span id="l5.6">               card);</span>
<a href="#l5.7"></a><span id="l5.7">           });</span>
<a href="#l5.8"></a><span id="l5.8">         }</span>
<a href="#l5.9"></a><span id="l5.9">       }</span>
<a href="#l5.10"></a><span id="l5.10">       else {</span>
<a href="#l5.11"></a><span id="l5.11">         // This must be a regular filename. Use it to create a new message with attachment.</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-        let msgComposeService = Components.classes[&quot;@mozilla.org/messengercompose;1&quot;]</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-                                          .getService(Components.interfaces.nsIMsgComposeService);</span>
<a href="#l5.14"></a><span id="l5.14">         let msgParams = Components.classes[&quot;@mozilla.org/messengercompose/composeparams;1&quot;]</span>
<a href="#l5.15"></a><span id="l5.15">                                   .createInstance(Components.interfaces.nsIMsgComposeParams);</span>
<a href="#l5.16"></a><span id="l5.16">         let composeFields = Components.classes[&quot;@mozilla.org/messengercompose/composefields;1&quot;]</span>
<a href="#l5.17"></a><span id="l5.17">                                       .createInstance(Components.interfaces.nsIMsgCompFields);</span>
<a href="#l5.18"></a><span id="l5.18">         let attachment = Components.classes[&quot;@mozilla.org/messengercompose/attachment;1&quot;]</span>
<a href="#l5.19"></a><span id="l5.19">                                    .createInstance(Components.interfaces.nsIMsgAttachment);</span>
<a href="#l5.20"></a><span id="l5.20">         let localFile = Components.classes[&quot;@mozilla.org/file/local;1&quot;]</span>
<a href="#l5.21"></a><span id="l5.21">                                   .createInstance(Components.interfaces.nsILocalFile);</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineat">@@ -399,17 +397,17 @@ var nsMailDefaultHandler = {</span>
<a href="#l5.23"></a><span id="l5.23">           localFile.initWithPath(unescape(uri));</span>
<a href="#l5.24"></a><span id="l5.24">           attachment.url = fileHandler.getURLSpecFromFile(localFile);</span>
<a href="#l5.25"></a><span id="l5.25">           composeFields.addAttachment(attachment);</span>
<a href="#l5.26"></a><span id="l5.26"> </span>
<a href="#l5.27"></a><span id="l5.27">           msgParams.type = Components.interfaces.nsIMsgCompType.New;</span>
<a href="#l5.28"></a><span id="l5.28">           msgParams.format = Components.interfaces.nsIMsgCompFormat.Default;</span>
<a href="#l5.29"></a><span id="l5.29">           msgParams.composeFields = composeFields;</span>
<a href="#l5.30"></a><span id="l5.30"> </span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-          msgComposeService.OpenComposeWindowWithParams(null, msgParams);</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+          MailServices.compose.OpenComposeWindowWithParams(null, msgParams);</span>
<a href="#l5.33"></a><span id="l5.33">         } catch (e) {</span>
<a href="#l5.34"></a><span id="l5.34">           openURI(cmdLine.resolveURI(uri));</span>
<a href="#l5.35"></a><span id="l5.35">         }</span>
<a href="#l5.36"></a><span id="l5.36">       }</span>
<a href="#l5.37"></a><span id="l5.37">     } else {</span>
<a href="#l5.38"></a><span id="l5.38">       var argstring = Components.classes[&quot;@mozilla.org/supports-string;1&quot;]</span>
<a href="#l5.39"></a><span id="l5.39">                                 .createInstance(nsISupportsString);</span>
<a href="#l5.40"></a><span id="l5.40"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/test/mozmill/instrumentation/test-instrument-setup.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/test/mozmill/instrumentation/test-instrument-setup.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -81,23 +81,18 @@ function test_mail_account_setup() {</span>
<a href="#l6.4"></a><span id="l6.4">   if (! (events[&quot;accountAdded&quot;].data))</span>
<a href="#l6.5"></a><span id="l6.5">     throw new Error(&quot;failed to add an account&quot;);</span>
<a href="#l6.6"></a><span id="l6.6">   else if (! (events[&quot;smtpServerAdded&quot;].data))</span>
<a href="#l6.7"></a><span id="l6.7">     throw new Error(&quot;failed to add an smtp server&quot;);</span>
<a href="#l6.8"></a><span id="l6.8"> }</span>
<a href="#l6.9"></a><span id="l6.9"> </span>
<a href="#l6.10"></a><span id="l6.10"> // Remove the account we added.</span>
<a href="#l6.11"></a><span id="l6.11"> function remove_account() {</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  let am = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-      .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-  let smtpService = Cc[&quot;@mozilla.org/messengercompose/smtp;1&quot;]</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-                     .getService(Ci.nsISmtpService);</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-  let incomingServer = am.FindServer(&quot;roger.sterling&quot;, &quot;testin.example.com&quot;, &quot;pop3&quot;);</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-  let account = am.FindAccountForServer(incomingServer)</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+  let incomingServer = MailServices.accounts.FindServer(&quot;roger.sterling&quot;, &quot;testin.example.com&quot;, &quot;pop3&quot;);</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+  let account = MailServices.accounts.FindAccountForServer(incomingServer)</span>
<a href="#l6.21"></a><span id="l6.21"> </span>
<a href="#l6.22"></a><span id="l6.22">   let identity = account.defaultIdentity;</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineminus">-  am.removeIncomingServer(incomingServer, true);</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-  outgoing = smtpService.getServerByKey(identity.smtpServerKey);</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineminus">-  smtpService.deleteServer(outgoing);</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineminus">-  am.removeAccount(account);</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+  MailServices.accounts.removeIncomingServer(incomingServer, true);</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+  outgoing = MailServices.smtp.getServerByKey(identity.smtpServerKey);</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+  MailServices.smtp.deleteServer(outgoing);</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+  MailServices.accounts.removeAccount(account);</span>
<a href="#l6.31"></a><span id="l6.31"> }</span>
<a href="#l6.32"></a><span id="l6.32"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/base/src/newMailNotificationService.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/base/src/newMailNotificationService.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -11,21 +11,21 @@</span>
<a href="#l7.4"></a><span id="l7.4">  * preferences &quot;mail.notification.logging.console&quot; (for the error console) or</span>
<a href="#l7.5"></a><span id="l7.5">  * &quot;mail.notification.logging.dump&quot; (for stderr) to the string indicating the level you want.</span>
<a href="#l7.6"></a><span id="l7.6">  */</span>
<a href="#l7.7"></a><span id="l7.7"> </span>
<a href="#l7.8"></a><span id="l7.8"> const Cc = Components.classes;</span>
<a href="#l7.9"></a><span id="l7.9"> const Ci = Components.interfaces;</span>
<a href="#l7.10"></a><span id="l7.10"> const Cu = Components.utils;</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-Cu.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+Cu.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+Cu.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l7.15"></a><span id="l7.15"> Cu.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l7.16"></a><span id="l7.16"> Cu.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-Cu.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">-Cu.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+Cu.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l7.20"></a><span id="l7.20"> </span>
<a href="#l7.21"></a><span id="l7.21"> const NMNS = Ci.mozINewMailNotificationService;</span>
<a href="#l7.22"></a><span id="l7.22"> </span>
<a href="#l7.23"></a><span id="l7.23"> const countInboxesPref = &quot;mail.notification.count.inbox_only&quot;;</span>
<a href="#l7.24"></a><span id="l7.24"> // Old name for pref</span>
<a href="#l7.25"></a><span id="l7.25"> const countNewMessagesPref = &quot;mail.biff.use_new_count_in_mac_dock&quot;;</span>
<a href="#l7.26"></a><span id="l7.26"> // When we go cross-platform we should migrate to</span>
<a href="#l7.27"></a><span id="l7.27"> // const countNewMessagesPref = &quot;mail.notification.count.new&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/base/test/unit/test_bug404489.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_bug404489.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1,16 +1,15 @@</span>
<a href="#l8.4"></a><span id="l8.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.5"></a><span id="l8.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.6"></a><span id="l8.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8"> // Tests that custom headers like &quot;Sender&quot; work (bug 404489)</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10" class="difflineminus">-const copyService = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineminus">-                      .getService(Ci.nsIMsgCopyService);</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l8.13"></a><span id="l8.13"> </span>
<a href="#l8.14"></a><span id="l8.14"> const nsMsgSearchScope = Ci.nsMsgSearchScope;</span>
<a href="#l8.15"></a><span id="l8.15"> const nsMsgSearchAttrib = Ci.nsMsgSearchAttrib;</span>
<a href="#l8.16"></a><span id="l8.16"> const nsMsgSearchOp = Ci.nsMsgSearchOp;</span>
<a href="#l8.17"></a><span id="l8.17"> const Contains = nsMsgSearchOp.Contains;</span>
<a href="#l8.18"></a><span id="l8.18"> const offlineMail = nsMsgSearchScope.offlineMail;</span>
<a href="#l8.19"></a><span id="l8.19"> const gArrayHdrs = [&quot;X-Bugzilla-Who&quot;, &quot;Sender&quot;];</span>
<a href="#l8.20"></a><span id="l8.20"> const gFirstHeader = nsMsgSearchAttrib.OtherHeader + 1;</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineat">@@ -68,18 +67,18 @@ function run_test()</span>
<a href="#l8.22"></a><span id="l8.22">     hdrs = gArrayHdrs;</span>
<a href="#l8.23"></a><span id="l8.23">   else</span>
<a href="#l8.24"></a><span id="l8.24">     hdrs = gArrayHdrs.join(&quot;: &quot;);</span>
<a href="#l8.25"></a><span id="l8.25">   Services.prefs.setCharPref(&quot;mailnews.customHeaders&quot;, hdrs);</span>
<a href="#l8.26"></a><span id="l8.26"> </span>
<a href="#l8.27"></a><span id="l8.27">   // Get a message into the local filestore. function continue_test() continues the testing after the copy.</span>
<a href="#l8.28"></a><span id="l8.28">   do_test_pending();</span>
<a href="#l8.29"></a><span id="l8.29">   var file = do_get_file(fileName);</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-  copyService.CopyFileMessage(file, gLocalInboxFolder, null, false, 0,</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-                              &quot;&quot;, copyListener, null);</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+  MailServices.copy.CopyFileMessage(file, gLocalInboxFolder, null, false, 0,</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+                                    &quot;&quot;, copyListener, null);</span>
<a href="#l8.34"></a><span id="l8.34">   return true;</span>
<a href="#l8.35"></a><span id="l8.35"> }</span>
<a href="#l8.36"></a><span id="l8.36"> </span>
<a href="#l8.37"></a><span id="l8.37"> var copyListener =</span>
<a href="#l8.38"></a><span id="l8.38"> {</span>
<a href="#l8.39"></a><span id="l8.39">   OnStartCopy: function() {},</span>
<a href="#l8.40"></a><span id="l8.40">   OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l8.41"></a><span id="l8.41">   SetMessageKey: function(aKey) { },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/base/test/unit/test_bug428427.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_bug428427.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1,18 +1,16 @@</span>
<a href="#l9.4"></a><span id="l9.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.5"></a><span id="l9.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.6"></a><span id="l9.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8"> // Test of message count changes in virtual folder views</span>
<a href="#l9.9"></a><span id="l9.9"> </span>
<a href="#l9.10"></a><span id="l9.10" class="difflineminus">-const copyService = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineminus">-                      .getService(Ci.nsIMsgCopyService);</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-const tagService = Cc[&quot;@mozilla.org/messenger/tagservice;1&quot;]</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-                     .getService(Ci.nsIMsgTagService);</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+</span>
<a href="#l9.16"></a><span id="l9.16"> const dbviewContractId = &quot;@mozilla.org/messenger/msgdbview;1?type=&quot; + &quot;quicksearch&quot;;</span>
<a href="#l9.17"></a><span id="l9.17"> const dbView = Cc[dbviewContractId].createInstance(Ci.nsIMsgDBView);</span>
<a href="#l9.18"></a><span id="l9.18"> const bugmail1 = do_get_file(&quot;../../../data/bugmail1&quot;);</span>
<a href="#l9.19"></a><span id="l9.19"> // main test</span>
<a href="#l9.20"></a><span id="l9.20"> </span>
<a href="#l9.21"></a><span id="l9.21"> // the headers for the test messages. All messages are identical, but</span>
<a href="#l9.22"></a><span id="l9.22"> // have different properties set on them.</span>
<a href="#l9.23"></a><span id="l9.23"> var hdrs = [];</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineat">@@ -27,35 +25,35 @@ function run_test()</span>
<a href="#l9.25"></a><span id="l9.25"> {</span>
<a href="#l9.26"></a><span id="l9.26"> </span>
<a href="#l9.27"></a><span id="l9.27">   loadLocalMailAccount();</span>
<a href="#l9.28"></a><span id="l9.28">     </span>
<a href="#l9.29"></a><span id="l9.29">   // Get messageCount messages into the local filestore.</span>
<a href="#l9.30"></a><span id="l9.30">   do_test_pending();</span>
<a href="#l9.31"></a><span id="l9.31"> </span>
<a href="#l9.32"></a><span id="l9.32">   // function setupVirtualFolder() continues the testing after CopyFileMessage.</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineminus">-  copyService.CopyFileMessage(bugmail1, gLocalInboxFolder, null, false, 0,</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineminus">-                              &quot;&quot;, copyListener, null);</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineplus">+  MailServices.copy.CopyFileMessage(bugmail1, gLocalInboxFolder, null, false, 0,</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+                                    &quot;&quot;, copyListener, null);</span>
<a href="#l9.37"></a><span id="l9.37">   return true;</span>
<a href="#l9.38"></a><span id="l9.38"> }</span>
<a href="#l9.39"></a><span id="l9.39"> </span>
<a href="#l9.40"></a><span id="l9.40"> // nsIMsgCopyServiceListener implementation</span>
<a href="#l9.41"></a><span id="l9.41"> var copyListener = </span>
<a href="#l9.42"></a><span id="l9.42"> {</span>
<a href="#l9.43"></a><span id="l9.43">   OnStartCopy: function() {},</span>
<a href="#l9.44"></a><span id="l9.44">   OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l9.45"></a><span id="l9.45">   SetMessageKey: function(aKey)</span>
<a href="#l9.46"></a><span id="l9.46">   {</span>
<a href="#l9.47"></a><span id="l9.47">     hdrs.push(gLocalInboxFolder.GetMessageHeader(aKey));</span>
<a href="#l9.48"></a><span id="l9.48">   },</span>
<a href="#l9.49"></a><span id="l9.49">   SetMessageId: function(aMessageId) {},</span>
<a href="#l9.50"></a><span id="l9.50">   OnStopCopy: function(aStatus)</span>
<a href="#l9.51"></a><span id="l9.51">   {</span>
<a href="#l9.52"></a><span id="l9.52">     if (--messageCount)</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineminus">-      copyService.CopyFileMessage(bugmail1, gLocalInboxFolder, null, false, 0,</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+      MailServices.copy.CopyFileMessage(bugmail1, gLocalInboxFolder, null, false, 0,</span>
<a href="#l9.55"></a><span id="l9.55">                                   &quot;&quot;, copyListener, null);</span>
<a href="#l9.56"></a><span id="l9.56">     else {</span>
<a href="#l9.57"></a><span id="l9.57">       try {</span>
<a href="#l9.58"></a><span id="l9.58">       setupVirtualFolder();</span>
<a href="#l9.59"></a><span id="l9.59">       } catch (ex) {dump(ex);}</span>
<a href="#l9.60"></a><span id="l9.60">     }</span>
<a href="#l9.61"></a><span id="l9.61">   }</span>
<a href="#l9.62"></a><span id="l9.62"> };</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineat">@@ -63,17 +61,17 @@ var copyListener =</span>
<a href="#l9.64"></a><span id="l9.64"> var virtualFolder;</span>
<a href="#l9.65"></a><span id="l9.65"> var numTotalMessages; </span>
<a href="#l9.66"></a><span id="l9.66"> var numUnreadMessages;</span>
<a href="#l9.67"></a><span id="l9.67"> </span>
<a href="#l9.68"></a><span id="l9.68"> // virtual folder setup</span>
<a href="#l9.69"></a><span id="l9.69"> function setupVirtualFolder()</span>
<a href="#l9.70"></a><span id="l9.70"> {</span>
<a href="#l9.71"></a><span id="l9.71">   // add as valid tag tag1, though probably not really necessary</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineminus">-  tagService.addTagForKey(tag1, tag1, null, null);</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineplus">+  MailServices.tags.addTagForKey(tag1, tag1, null, null);</span>
<a href="#l9.74"></a><span id="l9.74">   </span>
<a href="#l9.75"></a><span id="l9.75">   // add tag1 to 4 messages</span>
<a href="#l9.76"></a><span id="l9.76">   var messages0to3 = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l9.77"></a><span id="l9.77">   for (var i = 0; i &lt;= 3; i++)</span>
<a href="#l9.78"></a><span id="l9.78">     messages0to3.appendElement(hdrs[i], false);</span>
<a href="#l9.79"></a><span id="l9.79">   gLocalInboxFolder.addKeywordsToMessages(messages0to3, tag1);</span>
<a href="#l9.80"></a><span id="l9.80"> </span>
<a href="#l9.81"></a><span id="l9.81">   // set 3 messages unread, 2 messages read</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineat">@@ -186,22 +184,20 @@ function CreateVirtualFolder(newName, pa</span>
<a href="#l9.83"></a><span id="l9.83">   </span>
<a href="#l9.84"></a><span id="l9.84">   var dbFolderInfo = vfdb.dBFolderInfo;</span>
<a href="#l9.85"></a><span id="l9.85">   // set the view string as a property of the db folder info</span>
<a href="#l9.86"></a><span id="l9.86">   // set the original folder name as well.</span>
<a href="#l9.87"></a><span id="l9.87">   dbFolderInfo.setCharProperty(&quot;searchStr&quot;, searchTermString);</span>
<a href="#l9.88"></a><span id="l9.88">   dbFolderInfo.setCharProperty(&quot;searchFolderUri&quot;, searchFolderURIs);</span>
<a href="#l9.89"></a><span id="l9.89">   dbFolderInfo.setBooleanProperty(&quot;searchOnline&quot;, searchOnline);</span>
<a href="#l9.90"></a><span id="l9.90">   // This fails because the folder doesn't exist - why were we doing it?</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineminus">-//  vfdb.summaryValid = true;</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineplus">+  //  vfdb.summaryValid = true;</span>
<a href="#l9.93"></a><span id="l9.93">   vfdb.Close(true);</span>
<a href="#l9.94"></a><span id="l9.94">   // use acctMgr to setup the virtual folder listener</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineminus">-  var acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineminus">-                  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineminus">-  acctMgr = acctMgr.QueryInterface(Ci.nsIFolderListener);</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineplus">+  acctMgr = MailServices.accounts.QueryInterface(Ci.nsIFolderListener);</span>
<a href="#l9.99"></a><span id="l9.99">   //print(acctMgr);</span>
<a href="#l9.100"></a><span id="l9.100">   acctMgr.OnItemAdded(null, newFolder);</span>
<a href="#l9.101"></a><span id="l9.101">   return newFolder;</span>
<a href="#l9.102"></a><span id="l9.102"> }</span>
<a href="#l9.103"></a><span id="l9.103"> </span>
<a href="#l9.104"></a><span id="l9.104"> function getSearchTermString(term)</span>
<a href="#l9.105"></a><span id="l9.105"> {</span>
<a href="#l9.106"></a><span id="l9.106">   var condition = &quot;&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/base/test/unit/test_bug465805.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_bug465805.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -2,18 +2,17 @@</span>
<a href="#l10.4"></a><span id="l10.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l10.5"></a><span id="l10.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l10.6"></a><span id="l10.6"> </span>
<a href="#l10.7"></a><span id="l10.7"> // This tests that we do not crash when loading the email bodySearchCrash,</span>
<a href="#l10.8"></a><span id="l10.8"> // which was fixed in bug 465805</span>
<a href="#l10.9"></a><span id="l10.9"> </span>
<a href="#l10.10"></a><span id="l10.10"> load(&quot;../../../resources/searchTestUtils.js&quot;);</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-const copyService = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;].</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-                      getService(Ci.nsIMsgCopyService);</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l10.15"></a><span id="l10.15"> </span>
<a href="#l10.16"></a><span id="l10.16"> const nsMsgSearchScope = Ci.nsMsgSearchScope;</span>
<a href="#l10.17"></a><span id="l10.17"> const nsMsgSearchAttrib = Ci.nsMsgSearchAttrib;</span>
<a href="#l10.18"></a><span id="l10.18"> const nsMsgSearchOp = Ci.nsMsgSearchOp;</span>
<a href="#l10.19"></a><span id="l10.19"> </span>
<a href="#l10.20"></a><span id="l10.20"> const Contains = nsMsgSearchOp.Contains;</span>
<a href="#l10.21"></a><span id="l10.21"> </span>
<a href="#l10.22"></a><span id="l10.22"> const offlineMail = nsMsgSearchScope.offlineMail;</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineat">@@ -52,22 +51,22 @@ function run_test()</span>
<a href="#l10.24"></a><span id="l10.24"> var copyListener = </span>
<a href="#l10.25"></a><span id="l10.25"> {</span>
<a href="#l10.26"></a><span id="l10.26">   OnStartCopy: function() {},</span>
<a href="#l10.27"></a><span id="l10.27">   OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l10.28"></a><span id="l10.28">   SetMessageKey: function(aKey) {},</span>
<a href="#l10.29"></a><span id="l10.29">   SetMessageId: function(aMessageId) {},</span>
<a href="#l10.30"></a><span id="l10.30">   OnStopCopy: function(aStatus) </span>
<a href="#l10.31"></a><span id="l10.31">   {</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-    var fileName = Files.shift();</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+    let fileName = Files.shift();</span>
<a href="#l10.34"></a><span id="l10.34">     if (fileName)</span>
<a href="#l10.35"></a><span id="l10.35">     { </span>
<a href="#l10.36"></a><span id="l10.36" class="difflineminus">-      var file = do_get_file(fileName);</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-      copyService.CopyFileMessage(file, gLocalInboxFolder, null, false, 0,</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineminus">-                              &quot;&quot;, copyListener, null);</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+      let file = do_get_file(fileName);</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+      MailServices.copy.CopyFileMessage(file, gLocalInboxFolder, null, false, 0,</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+                                        &quot;&quot;, copyListener, null);</span>
<a href="#l10.42"></a><span id="l10.42">     }</span>
<a href="#l10.43"></a><span id="l10.43">     else</span>
<a href="#l10.44"></a><span id="l10.44">       testBodySearch();</span>
<a href="#l10.45"></a><span id="l10.45">   }</span>
<a href="#l10.46"></a><span id="l10.46"> };</span>
<a href="#l10.47"></a><span id="l10.47"> </span>
<a href="#l10.48"></a><span id="l10.48"> // Runs at completion of copy</span>
<a href="#l10.49"></a><span id="l10.49"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/base/test/unit/test_bug471682.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_bug471682.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -3,18 +3,18 @@</span>
<a href="#l11.4"></a><span id="l11.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.5"></a><span id="l11.5"> </span>
<a href="#l11.6"></a><span id="l11.6"> /*</span>
<a href="#l11.7"></a><span id="l11.7">  * Test of message database validity on local copy from bug 471682. What</span>
<a href="#l11.8"></a><span id="l11.8">  * we want to do here is to copy a couple of message to a new folder, and</span>
<a href="#l11.9"></a><span id="l11.9">  * then compare the date and filesize of the folder file with the</span>
<a href="#l11.10"></a><span id="l11.10">  * stored result in dbfolderinfo. If they don't match, that's bad.</span>
<a href="#l11.11"></a><span id="l11.11">  */</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-const copyService = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-                      .getService(Ci.nsIMsgCopyService);</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+</span>
<a href="#l11.16"></a><span id="l11.16"> const bugmail1 = do_get_file(&quot;../../../data/bugmail1&quot;);</span>
<a href="#l11.17"></a><span id="l11.17"> var gHdr; // header of test message in local folder</span>
<a href="#l11.18"></a><span id="l11.18"> </span>
<a href="#l11.19"></a><span id="l11.19"> loadLocalMailAccount();</span>
<a href="#l11.20"></a><span id="l11.20"> // create a subfolder as a target for copies</span>
<a href="#l11.21"></a><span id="l11.21"> var gSubfolder = gLocalInboxFolder.createLocalSubfolder(&quot;subfolder&quot;);</span>
<a href="#l11.22"></a><span id="l11.22"> </span>
<a href="#l11.23"></a><span id="l11.23"> function run_test()</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineat">@@ -22,18 +22,18 @@ function run_test()</span>
<a href="#l11.25"></a><span id="l11.25">   // make sure we're using berkeley mailbox format here since this test</span>
<a href="#l11.26"></a><span id="l11.26">   // assumes berkeley mailbox format.</span>
<a href="#l11.27"></a><span id="l11.27">   if (Services.prefs.getCharPref(&quot;mail.serverDefaultStoreContractID&quot;) !=</span>
<a href="#l11.28"></a><span id="l11.28">       &quot;@mozilla.org/msgstore/berkeleystore;1&quot;)</span>
<a href="#l11.29"></a><span id="l11.29">     return;</span>
<a href="#l11.30"></a><span id="l11.30"> </span>
<a href="#l11.31"></a><span id="l11.31">   do_test_pending();</span>
<a href="#l11.32"></a><span id="l11.32">   // step 1: copy a message into the local inbox</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-  copyService.CopyFileMessage(bugmail1, gLocalInboxFolder, null, false, 0,</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-                              &quot;&quot;, step2, null);</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+  MailServices.copy.CopyFileMessage(bugmail1, gLocalInboxFolder, null,</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+                                    false, 0, &quot;&quot;, step2, null);</span>
<a href="#l11.37"></a><span id="l11.37">   return;</span>
<a href="#l11.38"></a><span id="l11.38"> }</span>
<a href="#l11.39"></a><span id="l11.39"> </span>
<a href="#l11.40"></a><span id="l11.40"> // step 2: copy one message into a subfolder to establish an</span>
<a href="#l11.41"></a><span id="l11.41"> //         mbox file time and size</span>
<a href="#l11.42"></a><span id="l11.42"> // nsIMsgCopyServiceListener implementation</span>
<a href="#l11.43"></a><span id="l11.43"> var step2 = </span>
<a href="#l11.44"></a><span id="l11.44"> {</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineat">@@ -46,18 +46,18 @@ var step2 =</span>
<a href="#l11.46"></a><span id="l11.46">   },</span>
<a href="#l11.47"></a><span id="l11.47">   SetMessageId: function(aMessageId) {},</span>
<a href="#l11.48"></a><span id="l11.48">   OnStopCopy: function(aStatus)</span>
<a href="#l11.49"></a><span id="l11.49">   {</span>
<a href="#l11.50"></a><span id="l11.50">     do_check_neq(gHdr, null);</span>
<a href="#l11.51"></a><span id="l11.51">     // copy the message into the subfolder</span>
<a href="#l11.52"></a><span id="l11.52">     var messages = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l11.53"></a><span id="l11.53">     messages.appendElement(gHdr, false);</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineminus">-    copyService.CopyMessages(gLocalInboxFolder, messages, gSubfolder, false,</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineminus">-                             step3, null, false);</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineplus">+    MailServices.copy.CopyMessages(gLocalInboxFolder, messages, gSubfolder,</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+                                   false, step3, null, false);</span>
<a href="#l11.58"></a><span id="l11.58">   }</span>
<a href="#l11.59"></a><span id="l11.59"> };</span>
<a href="#l11.60"></a><span id="l11.60"> </span>
<a href="#l11.61"></a><span id="l11.61"> // step 3: after the copy, delay to allow copy to complete and allow possible</span>
<a href="#l11.62"></a><span id="l11.62"> //         file error time</span>
<a href="#l11.63"></a><span id="l11.63"> // nsIMsgCopyServiceListener implementation</span>
<a href="#l11.64"></a><span id="l11.64"> var step3 = </span>
<a href="#l11.65"></a><span id="l11.65"> {</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineat">@@ -71,18 +71,18 @@ var step3 =</span>
<a href="#l11.67"></a><span id="l11.67">   }</span>
<a href="#l11.68"></a><span id="l11.68"> }</span>
<a href="#l11.69"></a><span id="l11.69"> </span>
<a href="#l11.70"></a><span id="l11.70"> // step 4: start a second copy</span>
<a href="#l11.71"></a><span id="l11.71"> function step4()</span>
<a href="#l11.72"></a><span id="l11.72"> {</span>
<a href="#l11.73"></a><span id="l11.73">   var messages = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l11.74"></a><span id="l11.74">   messages.appendElement(gHdr, false);</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineminus">-  copyService.CopyMessages(gLocalInboxFolder, messages, gSubfolder, false,</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineminus">-                           step5, null, false);</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineplus">+  MailServices.copy.CopyMessages(gLocalInboxFolder, messages, gSubfolder,</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineplus">+                                 false, step5, null, false);</span>
<a href="#l11.79"></a><span id="l11.79"> }</span>
<a href="#l11.80"></a><span id="l11.80"> </span>
<a href="#l11.81"></a><span id="l11.81"> // step 5:  actual tests of file size and date</span>
<a href="#l11.82"></a><span id="l11.82"> // nsIMsgCopyServiceListener implementation</span>
<a href="#l11.83"></a><span id="l11.83"> var step5 = </span>
<a href="#l11.84"></a><span id="l11.84"> {</span>
<a href="#l11.85"></a><span id="l11.85">   OnStartCopy: function() {},</span>
<a href="#l11.86"></a><span id="l11.86">   OnProgress: function(aProgress, aProgressMax) {},</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/base/test/unit/test_copyChaining.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_copyChaining.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -1,18 +1,17 @@</span>
<a href="#l12.4"></a><span id="l12.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l12.5"></a><span id="l12.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l12.6"></a><span id="l12.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8"> // Test of chaining copies between the same folders</span>
<a href="#l12.9"></a><span id="l12.9"> </span>
<a href="#l12.10"></a><span id="l12.10" class="difflineminus">-const copyService = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineminus">-                      .getService(Ci.nsIMsgCopyService);</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l12.13"></a><span id="l12.13"> </span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l12.16"></a><span id="l12.16"> </span>
<a href="#l12.17"></a><span id="l12.17"> var gCopySource;</span>
<a href="#l12.18"></a><span id="l12.18"> var gCopyDest;</span>
<a href="#l12.19"></a><span id="l12.19"> var gMsgEnumerator;</span>
<a href="#l12.20"></a><span id="l12.20"> var gCurTestNum = 1;</span>
<a href="#l12.21"></a><span id="l12.21"> </span>
<a href="#l12.22"></a><span id="l12.22"> // main test</span>
<a href="#l12.23"></a><span id="l12.23"> </span>
<a href="#l12.24"></a><span id="l12.24" class="difflineat">@@ -37,18 +36,18 @@ const gTestArray =</span>
<a href="#l12.25"></a><span id="l12.25"> </span>
<a href="#l12.26"></a><span id="l12.26"> function CopyNextMessage()</span>
<a href="#l12.27"></a><span id="l12.27"> {</span>
<a href="#l12.28"></a><span id="l12.28">   if (gMsgEnumerator.hasMoreElements()) {</span>
<a href="#l12.29"></a><span id="l12.29">     let msgHdr = gMsgEnumerator.getNext().QueryInterface(</span>
<a href="#l12.30"></a><span id="l12.30">       Components.interfaces.nsIMsgDBHdr);</span>
<a href="#l12.31"></a><span id="l12.31">     var messages = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l12.32"></a><span id="l12.32">     messages.appendElement(msgHdr, false);</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineminus">-    copyService.CopyMessages(gCopySource, messages, gCopyDest, true,</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineminus">-                             copyListener, null, false);</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+    MailServices.copy.CopyMessages(gCopySource, messages, gCopyDest, true,</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+                                   copyListener, null, false);</span>
<a href="#l12.37"></a><span id="l12.37">   }</span>
<a href="#l12.38"></a><span id="l12.38">   else</span>
<a href="#l12.39"></a><span id="l12.39">     do_throw ('TEST FAILED - out of messages');</span>
<a href="#l12.40"></a><span id="l12.40"> }</span>
<a href="#l12.41"></a><span id="l12.41"> </span>
<a href="#l12.42"></a><span id="l12.42"> function run_test()</span>
<a href="#l12.43"></a><span id="l12.43"> {</span>
<a href="#l12.44"></a><span id="l12.44"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/base/test/unit/test_copyThenMoveManual.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_copyThenMoveManual.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -1,24 +1,25 @@</span>
<a href="#l13.4"></a><span id="l13.4"> /*</span>
<a href="#l13.5"></a><span id="l13.5">  * This file tests copy followed by a move in a single filter.</span>
<a href="#l13.6"></a><span id="l13.6">  * Tests fix from bug 448337.</span>
<a href="#l13.7"></a><span id="l13.7">  *</span>
<a href="#l13.8"></a><span id="l13.8">  * Original author: Kent James &lt;kent@caspia.com&gt;</span>
<a href="#l13.9"></a><span id="l13.9">  */</span>
<a href="#l13.10"></a><span id="l13.10"> </span>
<a href="#l13.11"></a><span id="l13.11"> load(&quot;../../../resources/POP3pump.js&quot;);</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+</span>
<a href="#l13.15"></a><span id="l13.15"> const gFiles = [&quot;../../../data/bugmail1&quot;];</span>
<a href="#l13.16"></a><span id="l13.16"> var gCopyFolder;</span>
<a href="#l13.17"></a><span id="l13.17"> var gMoveFolder;</span>
<a href="#l13.18"></a><span id="l13.18"> var gFilter; // the test filter</span>
<a href="#l13.19"></a><span id="l13.19"> var gFilterList;</span>
<a href="#l13.20"></a><span id="l13.20"> var gCurTestNum = 1;</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineminus">-var gFilterService = Cc[&quot;@mozilla.org/messenger/services/filters;1&quot;]</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineminus">-                       .getService(Ci.nsIMsgFilterService);</span>
<a href="#l13.23"></a><span id="l13.23"> const gTestArray =</span>
<a href="#l13.24"></a><span id="l13.24"> [</span>
<a href="#l13.25"></a><span id="l13.25">   function createFilters() {</span>
<a href="#l13.26"></a><span id="l13.26">     // setup manual copy then move mail filters on the inbox</span>
<a href="#l13.27"></a><span id="l13.27">     gFilterList = gLocalIncomingServer.getFilterList(null);</span>
<a href="#l13.28"></a><span id="l13.28">     gFilter = gFilterList.createFilter(&quot;copyThenMoveAll&quot;);</span>
<a href="#l13.29"></a><span id="l13.29">     let searchTerm = gFilter.createTerm();</span>
<a href="#l13.30"></a><span id="l13.30">     searchTerm.matchAll = true;</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineat">@@ -45,18 +46,18 @@ const gTestArray =</span>
<a href="#l13.32"></a><span id="l13.32">     gPOP3Pump.run();</span>
<a href="#l13.33"></a><span id="l13.33">   },</span>
<a href="#l13.34"></a><span id="l13.34">   // test applying filters to a message header</span>
<a href="#l13.35"></a><span id="l13.35">   function applyFilters() {</span>
<a href="#l13.36"></a><span id="l13.36">     let messages = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l13.37"></a><span id="l13.37">                      .createInstance(Ci.nsIMutableArray);</span>
<a href="#l13.38"></a><span id="l13.38">     messages.appendElement(gLocalInboxFolder.firstNewMessage, false);</span>
<a href="#l13.39"></a><span id="l13.39">     ++gCurTestNum;</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineminus">-    gFilterService.applyFilters(Ci.nsMsgFilterType.Manual,</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineminus">-                                messages, gLocalInboxFolder, null);</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+    MailServices.filters.applyFilters(Ci.nsMsgFilterType.Manual,</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+                                      messages, gLocalInboxFolder, null);</span>
<a href="#l13.44"></a><span id="l13.44">   },</span>
<a href="#l13.45"></a><span id="l13.45">   function verifyFolders1() {</span>
<a href="#l13.46"></a><span id="l13.46">     // Copy and Move should each now have 1 message in them.</span>
<a href="#l13.47"></a><span id="l13.47">     do_check_eq(folderCount(gCopyFolder), 1);</span>
<a href="#l13.48"></a><span id="l13.48">     do_check_eq(folderCount(gMoveFolder), 1);</span>
<a href="#l13.49"></a><span id="l13.49">     // the local inbox folder should now be empty, since the second</span>
<a href="#l13.50"></a><span id="l13.50">     // operation was a move</span>
<a href="#l13.51"></a><span id="l13.51">     do_check_eq(folderCount(gLocalInboxFolder), 0);</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineat">@@ -71,17 +72,17 @@ const gTestArray =</span>
<a href="#l13.53"></a><span id="l13.53">     gPOP3Pump.run();</span>
<a href="#l13.54"></a><span id="l13.54">   },</span>
<a href="#l13.55"></a><span id="l13.55">   // use the alternate call into the filter service</span>
<a href="#l13.56"></a><span id="l13.56">   function applyFiltersToFolders() {</span>
<a href="#l13.57"></a><span id="l13.57">     let folders = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l13.58"></a><span id="l13.58">                     .createInstance(Ci.nsIMutableArray);</span>
<a href="#l13.59"></a><span id="l13.59">     folders.appendElement(gLocalInboxFolder, false);</span>
<a href="#l13.60"></a><span id="l13.60">     ++gCurTestNum;</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineminus">-    gFilterService.applyFiltersToFolders(gFilterList, folders, null);</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineplus">+    MailServices.filters.applyFiltersToFolders(gFilterList, folders, null);</span>
<a href="#l13.63"></a><span id="l13.63">   },</span>
<a href="#l13.64"></a><span id="l13.64">   function verifyFolders2() {</span>
<a href="#l13.65"></a><span id="l13.65">     // Copy and Move should each now have 2 message in them.</span>
<a href="#l13.66"></a><span id="l13.66">     do_check_eq(folderCount(gCopyFolder), 2);</span>
<a href="#l13.67"></a><span id="l13.67">     do_check_eq(folderCount(gMoveFolder), 2);</span>
<a href="#l13.68"></a><span id="l13.68">     // the local inbox folder should now be empty, since the second</span>
<a href="#l13.69"></a><span id="l13.69">     // operation was a move</span>
<a href="#l13.70"></a><span id="l13.70">     do_check_eq(folderCount(gLocalInboxFolder), 0);</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineat">@@ -104,22 +105,20 @@ function folderCount(folder)</span>
<a href="#l13.72"></a><span id="l13.72"> </span>
<a href="#l13.73"></a><span id="l13.73"> function run_test()</span>
<a href="#l13.74"></a><span id="l13.74"> {</span>
<a href="#l13.75"></a><span id="l13.75">   if (!gLocalInboxFolder)</span>
<a href="#l13.76"></a><span id="l13.76">     loadLocalMailAccount();</span>
<a href="#l13.77"></a><span id="l13.77"> </span>
<a href="#l13.78"></a><span id="l13.78">   gCopyFolder = gLocalIncomingServer.rootFolder.createLocalSubfolder(&quot;CopyFolder&quot;);</span>
<a href="#l13.79"></a><span id="l13.79">   gMoveFolder = gLocalIncomingServer.rootFolder.createLocalSubfolder(&quot;MoveFolder&quot;);</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineminus">-  const mailSession = Cc[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineminus">-                        .getService(Ci.nsIMsgMailSession);</span>
<a href="#l13.82"></a><span id="l13.82"> </span>
<a href="#l13.83"></a><span id="l13.83" class="difflineminus">-  mailSession.AddFolderListener(FolderListener, Ci.nsIFolderListener.event |</span>
<a href="#l13.84"></a><span id="l13.84" class="difflineminus">-                                                Ci.nsIFolderListener.added |</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineminus">-                                                Ci.nsIFolderListener.removed);</span>
<a href="#l13.86"></a><span id="l13.86" class="difflineplus">+  MailServices.mailSession.AddFolderListener(FolderListener, Ci.nsIFolderListener.event |</span>
<a href="#l13.87"></a><span id="l13.87" class="difflineplus">+                                                             Ci.nsIFolderListener.added |</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineplus">+                                                             Ci.nsIFolderListener.removed);</span>
<a href="#l13.89"></a><span id="l13.89"> </span>
<a href="#l13.90"></a><span id="l13.90">   // &quot;Master&quot; do_test_pending(), paired with a do_test_finished() at the end of</span>
<a href="#l13.91"></a><span id="l13.91">   // all the operations.</span>
<a href="#l13.92"></a><span id="l13.92">   do_test_pending();</span>
<a href="#l13.93"></a><span id="l13.93"> </span>
<a href="#l13.94"></a><span id="l13.94">   //start first test</span>
<a href="#l13.95"></a><span id="l13.95">   doTest();</span>
<a href="#l13.96"></a><span id="l13.96"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/base/test/unit/test_detachToFile.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_detachToFile.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -7,34 +7,32 @@</span>
<a href="#l14.4"></a><span id="l14.4">  */</span>
<a href="#l14.5"></a><span id="l14.5"> </span>
<a href="#l14.6"></a><span id="l14.6"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l14.7"></a><span id="l14.7"> load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l14.8"></a><span id="l14.8"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l14.9"></a><span id="l14.9"> </span>
<a href="#l14.10"></a><span id="l14.10"> // javascript mime emitter functions</span>
<a href="#l14.11"></a><span id="l14.11"> mimeMsg = {};</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l14.13"></a><span id="l14.13"> Components.utils.import(&quot;resource:///modules/gloda/mimemsg.js&quot;, mimeMsg);</span>
<a href="#l14.14"></a><span id="l14.14"> </span>
<a href="#l14.15"></a><span id="l14.15" class="difflineminus">-const copyService = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineminus">-                      .getService(Ci.nsIMsgCopyService);</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineminus">-</span>
<a href="#l14.18"></a><span id="l14.18"> var tests = [</span>
<a href="#l14.19"></a><span id="l14.19">   startCopy,</span>
<a href="#l14.20"></a><span id="l14.20">   startMime,</span>
<a href="#l14.21"></a><span id="l14.21">   startDetach,</span>
<a href="#l14.22"></a><span id="l14.22">   testDetach,</span>
<a href="#l14.23"></a><span id="l14.23"> ]</span>
<a href="#l14.24"></a><span id="l14.24"> </span>
<a href="#l14.25"></a><span id="l14.25"> function startCopy()</span>
<a href="#l14.26"></a><span id="l14.26"> {</span>
<a href="#l14.27"></a><span id="l14.27">   // Get a message into the local filestore.</span>
<a href="#l14.28"></a><span id="l14.28">   var mailFile = do_get_file(&quot;../../../data/external-attach-test&quot;);</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineminus">-  copyService.CopyFileMessage(mailFile, gLocalInboxFolder, null, false, 0,</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineminus">-                              &quot;&quot;, asyncCopyListener, null);</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+  MailServices.copy.CopyFileMessage(mailFile, gLocalInboxFolder, null, false, 0,</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+                                    &quot;&quot;, asyncCopyListener, null);</span>
<a href="#l14.33"></a><span id="l14.33">   yield false;</span>
<a href="#l14.34"></a><span id="l14.34"> }</span>
<a href="#l14.35"></a><span id="l14.35"> </span>
<a href="#l14.36"></a><span id="l14.36"> // process the message through mime</span>
<a href="#l14.37"></a><span id="l14.37"> function startMime()</span>
<a href="#l14.38"></a><span id="l14.38"> {</span>
<a href="#l14.39"></a><span id="l14.39">   let msgHdr = firstMsgHdr(gLocalInboxFolder);</span>
<a href="#l14.40"></a><span id="l14.40"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/base/test/unit/test_fix_deferred_accounts.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_fix_deferred_accounts.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -1,18 +1,17 @@</span>
<a href="#l15.4"></a><span id="l15.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l15.5"></a><span id="l15.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l15.6"></a><span id="l15.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l15.7"></a><span id="l15.7"> </span>
<a href="#l15.8"></a><span id="l15.8"> /**</span>
<a href="#l15.9"></a><span id="l15.9">  * This tests that we cleanup the account prefs when a pop3 account has</span>
<a href="#l15.10"></a><span id="l15.10">  * been deferred to a hidden account.</span>
<a href="#l15.11"></a><span id="l15.11">  */</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-const am = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-                     .getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l15.15"></a><span id="l15.15"> </span>
<a href="#l15.16"></a><span id="l15.16"> function run_test()</span>
<a href="#l15.17"></a><span id="l15.17"> {</span>
<a href="#l15.18"></a><span id="l15.18">   // Create account prefs with a pop3 account deferred to a hidden account.</span>
<a href="#l15.19"></a><span id="l15.19"> </span>
<a href="#l15.20"></a><span id="l15.20">   Services.prefs.setCharPref(&quot;mail.account.account1.identities&quot;, &quot;id1&quot;);</span>
<a href="#l15.21"></a><span id="l15.21">   Services.prefs.setCharPref(&quot;mail.account.account1.server&quot;, &quot;server1&quot;);</span>
<a href="#l15.22"></a><span id="l15.22">   Services.prefs.setCharPref(&quot;mail.account.account2.server&quot;, &quot;server2&quot;);</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineat">@@ -41,16 +40,16 @@ function run_test()</span>
<a href="#l15.24"></a><span id="l15.24">   Services.prefs.setCharPref(&quot;mail.accountmanager.accounts&quot;,</span>
<a href="#l15.25"></a><span id="l15.25">                              &quot;account1,account2,account4,account5&quot;);</span>
<a href="#l15.26"></a><span id="l15.26">   // Set the default account to one we're going to get rid of. The account manager</span>
<a href="#l15.27"></a><span id="l15.27">   // should recover relatively gracefully.</span>
<a href="#l15.28"></a><span id="l15.28">   Services.prefs.setCharPref(&quot;mail.accountmanager.defaultaccount&quot;,</span>
<a href="#l15.29"></a><span id="l15.29">                              &quot;account1&quot;);</span>
<a href="#l15.30"></a><span id="l15.30"> </span>
<a href="#l15.31"></a><span id="l15.31">   // This will force the load of the accounts setup above.</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineminus">-  do_check_eq(am.accounts.length, 3); // hidden account not included</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineminus">-  let server4 = am.getAccount(&quot;account4&quot;).incomingServer</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineminus">-                  .QueryInterface(Ci.nsIPop3IncomingServer);</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+  do_check_eq(MailServices.accounts.accounts.length, 3); // hidden account not included</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineplus">+  let server4 = MailServices.accounts.getAccount(&quot;account4&quot;).incomingServer</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+                            .QueryInterface(Ci.nsIPop3IncomingServer);</span>
<a href="#l15.38"></a><span id="l15.38">   do_check_eq(server4.deferredToAccount, &quot;account1&quot;);</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineminus">-  let server5 = am.getAccount(&quot;account5&quot;).incomingServer</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineminus">-                  .QueryInterface(Ci.nsIPop3IncomingServer);</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineplus">+  let server5 = MailServices.accounts.getAccount(&quot;account5&quot;).incomingServer</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineplus">+                            .QueryInterface(Ci.nsIPop3IncomingServer);</span>
<a href="#l15.43"></a><span id="l15.43">   do_check_eq(server5.deferredToAccount, &quot;account1&quot;);</span>
<a href="#l15.44"></a><span id="l15.44"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/base/test/unit/test_folderCompact.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_folderCompact.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -10,16 +10,18 @@</span>
<a href="#l16.4"></a><span id="l16.4">   * Test suite for folder compaction</span>
<a href="#l16.5"></a><span id="l16.5">   *</span>
<a href="#l16.6"></a><span id="l16.6">   * Currently tested:</span>
<a href="#l16.7"></a><span id="l16.7">   * - Compacting local folders</span>
<a href="#l16.8"></a><span id="l16.8">   * TODO</span>
<a href="#l16.9"></a><span id="l16.9">   * - Compacting imap offline stores.</span>
<a href="#l16.10"></a><span id="l16.10">   */</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+</span>
<a href="#l16.14"></a><span id="l16.14"> Services.prefs.setCharPref(&quot;mail.serverDefaultStoreContractID&quot;,</span>
<a href="#l16.15"></a><span id="l16.15">                            &quot;@mozilla.org/msgstore/berkeleystore;1&quot;);</span>
<a href="#l16.16"></a><span id="l16.16"> </span>
<a href="#l16.17"></a><span id="l16.17"> // Globals</span>
<a href="#l16.18"></a><span id="l16.18"> var gMsgFile1, gMsgFile2, gMsgFile3;</span>
<a href="#l16.19"></a><span id="l16.19"> var gLocalFolder2;</span>
<a href="#l16.20"></a><span id="l16.20"> var gLocalFolder3;</span>
<a href="#l16.21"></a><span id="l16.21"> var gLocalTrashFolder;</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineat">@@ -27,19 +29,16 @@ var gCurTestNum;</span>
<a href="#l16.23"></a><span id="l16.23"> // After a compact (or other operation), this is what we expect the </span>
<a href="#l16.24"></a><span id="l16.24"> // folder size to be.</span>
<a href="#l16.25"></a><span id="l16.25"> var gExpectedFolderSize;</span>
<a href="#l16.26"></a><span id="l16.26"> var gMsgHdrs = new Array();</span>
<a href="#l16.27"></a><span id="l16.27"> var gExpectedInboxSize;</span>
<a href="#l16.28"></a><span id="l16.28"> var gExpectedFolder2Size;</span>
<a href="#l16.29"></a><span id="l16.29"> var gExpectedFolder3Size;</span>
<a href="#l16.30"></a><span id="l16.30"> </span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-const gCopyService = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineminus">-                      .getService(Ci.nsIMsgCopyService);</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineminus">-</span>
<a href="#l16.34"></a><span id="l16.34"> // nsIMsgCopyServiceListener implementation</span>
<a href="#l16.35"></a><span id="l16.35"> var copyListener = </span>
<a href="#l16.36"></a><span id="l16.36"> {</span>
<a href="#l16.37"></a><span id="l16.37">   OnStartCopy: function() {},</span>
<a href="#l16.38"></a><span id="l16.38">   OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l16.39"></a><span id="l16.39">   SetMessageKey: function(aKey)</span>
<a href="#l16.40"></a><span id="l16.40">   {</span>
<a href="#l16.41"></a><span id="l16.41">     let hdr = gLocalInboxFolder.GetMessageHeader(aKey);</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineat">@@ -70,26 +69,26 @@ var urlListener =</span>
<a href="#l16.43"></a><span id="l16.43">     // can even cause tests to fail because they're still waiting for the listener</span>
<a href="#l16.44"></a><span id="l16.44">     // to return</span>
<a href="#l16.45"></a><span id="l16.45">     do_timeout(0, function(){doTest(++gCurTestNum);});</span>
<a href="#l16.46"></a><span id="l16.46">   }</span>
<a href="#l16.47"></a><span id="l16.47"> };</span>
<a href="#l16.48"></a><span id="l16.48"> </span>
<a href="#l16.49"></a><span id="l16.49"> function copyFileMessage(file, destFolder, isDraftOrTemplate)</span>
<a href="#l16.50"></a><span id="l16.50"> {</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineminus">-  gCopyService.CopyFileMessage(file, destFolder, null, isDraftOrTemplate, 0, &quot;&quot;, copyListener, null);</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineplus">+  MailServices.copy.CopyFileMessage(file, destFolder, null, isDraftOrTemplate, 0, &quot;&quot;, copyListener, null);</span>
<a href="#l16.53"></a><span id="l16.53"> }</span>
<a href="#l16.54"></a><span id="l16.54"> </span>
<a href="#l16.55"></a><span id="l16.55"> function copyMessages(items, isMove, srcFolder, destFolder)</span>
<a href="#l16.56"></a><span id="l16.56"> {</span>
<a href="#l16.57"></a><span id="l16.57">   var array = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l16.58"></a><span id="l16.58">   items.forEach(function (item) {</span>
<a href="#l16.59"></a><span id="l16.59">     array.appendElement(item, false);</span>
<a href="#l16.60"></a><span id="l16.60">   });</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineminus">-  gCopyService.CopyMessages(srcFolder, array, destFolder, isMove, copyListener, null, true);</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineplus">+  MailServices.copy.CopyMessages(srcFolder, array, destFolder, isMove, copyListener, null, true);</span>
<a href="#l16.63"></a><span id="l16.63"> }</span>
<a href="#l16.64"></a><span id="l16.64"> </span>
<a href="#l16.65"></a><span id="l16.65"> function deleteMessages(srcFolder, items)</span>
<a href="#l16.66"></a><span id="l16.66"> {</span>
<a href="#l16.67"></a><span id="l16.67">   var array = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l16.68"></a><span id="l16.68">   items.forEach(function (item) {</span>
<a href="#l16.69"></a><span id="l16.69">     array.appendElement(item, false);</span>
<a href="#l16.70"></a><span id="l16.70">   });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/base/test/unit/test_mimemaltdetach.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_mimemaltdetach.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -9,33 +9,31 @@</span>
<a href="#l17.4"></a><span id="l17.4"> </span>
<a href="#l17.5"></a><span id="l17.5"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l17.6"></a><span id="l17.6"> load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l17.7"></a><span id="l17.7"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l17.8"></a><span id="l17.8"> </span>
<a href="#l17.9"></a><span id="l17.9"> // javascript mime emitter functions</span>
<a href="#l17.10"></a><span id="l17.10"> mimeMsg = {};</span>
<a href="#l17.11"></a><span id="l17.11"> Components.utils.import(&quot;resource:///modules/gloda/mimemsg.js&quot;, mimeMsg);</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-const copyService = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">-                      .getService(Ci.nsIMsgCopyService);</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l17.16"></a><span id="l17.16"> </span>
<a href="#l17.17"></a><span id="l17.17"> var tests = [</span>
<a href="#l17.18"></a><span id="l17.18">   startCopy,</span>
<a href="#l17.19"></a><span id="l17.19">   startMime,</span>
<a href="#l17.20"></a><span id="l17.20">   startDetach,</span>
<a href="#l17.21"></a><span id="l17.21">   testDetach,</span>
<a href="#l17.22"></a><span id="l17.22"> ]</span>
<a href="#l17.23"></a><span id="l17.23"> </span>
<a href="#l17.24"></a><span id="l17.24"> function startCopy()</span>
<a href="#l17.25"></a><span id="l17.25"> {</span>
<a href="#l17.26"></a><span id="l17.26">   // Get a message into the local filestore.</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineminus">-  var mailFile = do_get_file(&quot;../../../data/multipartmalt-detach&quot;);</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineminus">-  copyService.CopyFileMessage(mailFile, gLocalInboxFolder, null, false, 0,</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineminus">-                              &quot;&quot;, asyncCopyListener, null);</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineplus">+  let mailFile = do_get_file(&quot;../../../data/multipartmalt-detach&quot;);</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+  MailServices.copy.CopyFileMessage(mailFile, gLocalInboxFolder, null, false, 0,</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+                                    &quot;&quot;, asyncCopyListener, null);</span>
<a href="#l17.33"></a><span id="l17.33">   yield false;</span>
<a href="#l17.34"></a><span id="l17.34"> }</span>
<a href="#l17.35"></a><span id="l17.35"> </span>
<a href="#l17.36"></a><span id="l17.36"> // process the message through mime</span>
<a href="#l17.37"></a><span id="l17.37"> function startMime()</span>
<a href="#l17.38"></a><span id="l17.38"> {</span>
<a href="#l17.39"></a><span id="l17.39">   let msgHdr = firstMsgHdr(gLocalInboxFolder);</span>
<a href="#l17.40"></a><span id="l17.40"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/base/test/unit/test_nsIMsgFolder.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_nsIMsgFolder.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -1,22 +1,21 @@</span>
<a href="#l18.4"></a><span id="l18.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l18.5"></a><span id="l18.5"> /*</span>
<a href="#l18.6"></a><span id="l18.6">  * Test suite for nsIMsgFolder functions.</span>
<a href="#l18.7"></a><span id="l18.7">  */</span>
<a href="#l18.8"></a><span id="l18.8"> </span>
<a href="#l18.9"></a><span id="l18.9" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l18.10"></a><span id="l18.10" class="difflineplus">+</span>
<a href="#l18.11"></a><span id="l18.11"> function run_test() {</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-  var acctMgr = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-                          .getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineminus">-</span>
<a href="#l18.15"></a><span id="l18.15">   // Create a local mail account (we need this first)</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineminus">-  acctMgr.createLocalMailAccount();</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineplus">+  MailServices.accounts.createLocalMailAccount();</span>
<a href="#l18.18"></a><span id="l18.18"> </span>
<a href="#l18.19"></a><span id="l18.19">   // Get the account</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineminus">-  var account = acctMgr.accounts.queryElementAt(0, Components.interfaces.nsIMsgAccount);</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineplus">+  let account = MailServices.accounts.accounts.queryElementAt(0, Components.interfaces.nsIMsgAccount);</span>
<a href="#l18.22"></a><span id="l18.22"> </span>
<a href="#l18.23"></a><span id="l18.23">   // Get the root folder</span>
<a href="#l18.24"></a><span id="l18.24">   var root = account.incomingServer.rootFolder;</span>
<a href="#l18.25"></a><span id="l18.25"> </span>
<a href="#l18.26"></a><span id="l18.26">   // Add a sub folder to ensure that we have some folders created</span>
<a href="#l18.27"></a><span id="l18.27">   root.createSubfolder(&quot;folder1&quot;, null);</span>
<a href="#l18.28"></a><span id="l18.28"> </span>
<a href="#l18.29"></a><span id="l18.29">   // Test - getChildNamed</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/base/test/unit/test_nsIMsgFolderListener.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_nsIMsgFolderListener.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -5,17 +5,18 @@</span>
<a href="#l19.4"></a><span id="l19.4">  * http://creativecommons.org/licenses/publicdomain/</span>
<a href="#l19.5"></a><span id="l19.5">  *</span>
<a href="#l19.6"></a><span id="l19.6">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l19.7"></a><span id="l19.7"> </span>
<a href="#l19.8"></a><span id="l19.8"> /*</span>
<a href="#l19.9"></a><span id="l19.9">  * Test suite for basic functionality with nsIMsgFolderListeners.</span>
<a href="#l19.10"></a><span id="l19.10">  */</span>
<a href="#l19.11"></a><span id="l19.11"> </span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-const mFNSContractID = &quot;@mozilla.org/messenger/msgnotificationservice;1&quot;;</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+</span>
<a href="#l19.15"></a><span id="l19.15"> const nsIMFNService = Ci.nsIMsgFolderNotificationService;</span>
<a href="#l19.16"></a><span id="l19.16"> const nsIMFListener = Ci.nsIMsgFolderListener;</span>
<a href="#l19.17"></a><span id="l19.17"> </span>
<a href="#l19.18"></a><span id="l19.18"> </span>
<a href="#l19.19"></a><span id="l19.19"> const gIndividualFlags =</span>
<a href="#l19.20"></a><span id="l19.20"> [</span>
<a href="#l19.21"></a><span id="l19.21">   nsIMFNService.msgAdded,</span>
<a href="#l19.22"></a><span id="l19.22">   nsIMFNService.msgsClassified,</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineat">@@ -24,127 +25,125 @@ const gIndividualFlags =</span>
<a href="#l19.24"></a><span id="l19.24">   nsIMFNService.msgKeyChanged,</span>
<a href="#l19.25"></a><span id="l19.25">   nsIMFNService.folderAdded,</span>
<a href="#l19.26"></a><span id="l19.26">   nsIMFNService.folderDeleted,</span>
<a href="#l19.27"></a><span id="l19.27">   nsIMFNService.folderMoveCopyCompleted,</span>
<a href="#l19.28"></a><span id="l19.28">   nsIMFNService.folderRenamed,</span>
<a href="#l19.29"></a><span id="l19.29">   nsIMFNService.itemEvent,</span>
<a href="#l19.30"></a><span id="l19.30"> ];</span>
<a href="#l19.31"></a><span id="l19.31"> </span>
<a href="#l19.32"></a><span id="l19.32" class="difflineminus">-var gMFNService = Cc[mFNSContractID].getService(nsIMFNService);</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineminus">-</span>
<a href="#l19.34"></a><span id="l19.34"> // Our listener, which captures events.</span>
<a href="#l19.35"></a><span id="l19.35"> function gMFListener() {}</span>
<a href="#l19.36"></a><span id="l19.36"> gMFListener.prototype =</span>
<a href="#l19.37"></a><span id="l19.37"> {</span>
<a href="#l19.38"></a><span id="l19.38">   mReceived: 0,</span>
<a href="#l19.39"></a><span id="l19.39">   mRemoveSelf: false,</span>
<a href="#l19.40"></a><span id="l19.40">   msgAdded: function (aMsg)</span>
<a href="#l19.41"></a><span id="l19.41">   {</span>
<a href="#l19.42"></a><span id="l19.42">     do_check_eq(this.mReceived &amp; nsIMFNService.msgAdded, 0);</span>
<a href="#l19.43"></a><span id="l19.43">     this.mReceived |= nsIMFNService.msgAdded;</span>
<a href="#l19.44"></a><span id="l19.44">     if (this.mRemoveSelf)</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineminus">-      gMFNService.removeListener(this);</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineplus">+      MailServices.mfn.removeListener(this);</span>
<a href="#l19.47"></a><span id="l19.47">   },</span>
<a href="#l19.48"></a><span id="l19.48"> </span>
<a href="#l19.49"></a><span id="l19.49">   msgsClassified: function (aMsgs, aJunkProcessed, aTraitProcessed)</span>
<a href="#l19.50"></a><span id="l19.50">   {</span>
<a href="#l19.51"></a><span id="l19.51">     do_check_eq(this.mReceived &amp; nsIMFNService.msgsClassified, 0);</span>
<a href="#l19.52"></a><span id="l19.52">     this.mReceived |= nsIMFNService.msgsClassified;</span>
<a href="#l19.53"></a><span id="l19.53">     if (this.mRemoveSelf)</span>
<a href="#l19.54"></a><span id="l19.54" class="difflineminus">-      gMFNService.removeListener(this);</span>
<a href="#l19.55"></a><span id="l19.55" class="difflineplus">+      MailServices.mfn.removeListener(this);</span>
<a href="#l19.56"></a><span id="l19.56">   },</span>
<a href="#l19.57"></a><span id="l19.57"> </span>
<a href="#l19.58"></a><span id="l19.58">   msgsDeleted: function (aMsgs)</span>
<a href="#l19.59"></a><span id="l19.59">   {</span>
<a href="#l19.60"></a><span id="l19.60">     do_check_eq(this.mReceived &amp; nsIMFNService.msgsDeleted, 0);</span>
<a href="#l19.61"></a><span id="l19.61">     this.mReceived |= nsIMFNService.msgsDeleted;</span>
<a href="#l19.62"></a><span id="l19.62">     if (this.mRemoveSelf)</span>
<a href="#l19.63"></a><span id="l19.63" class="difflineminus">-      gMFNService.removeListener(this);</span>
<a href="#l19.64"></a><span id="l19.64" class="difflineplus">+      MailServices.mfn.removeListener(this);</span>
<a href="#l19.65"></a><span id="l19.65">   },</span>
<a href="#l19.66"></a><span id="l19.66"> </span>
<a href="#l19.67"></a><span id="l19.67">   msgsMoveCopyCompleted: function (aMove, aSrcMsgs, aDestFolder, aDestMsgs)</span>
<a href="#l19.68"></a><span id="l19.68">   {</span>
<a href="#l19.69"></a><span id="l19.69">     do_check_eq(this.mReceived &amp; nsIMFNService.msgsMoveCopyCompleted, 0);</span>
<a href="#l19.70"></a><span id="l19.70">     this.mReceived |= nsIMFNService.msgsMoveCopyCompleted;</span>
<a href="#l19.71"></a><span id="l19.71">     if (this.mRemoveSelf)</span>
<a href="#l19.72"></a><span id="l19.72" class="difflineminus">-      gMFNService.removeListener(this);</span>
<a href="#l19.73"></a><span id="l19.73" class="difflineplus">+      MailServices.mfn.removeListener(this);</span>
<a href="#l19.74"></a><span id="l19.74">   },</span>
<a href="#l19.75"></a><span id="l19.75"> </span>
<a href="#l19.76"></a><span id="l19.76">   msgKeyChanged: function(aOldMsgKey, aNewMsgHdr)</span>
<a href="#l19.77"></a><span id="l19.77">   {</span>
<a href="#l19.78"></a><span id="l19.78">     do_check_eq(this.mReceived &amp; nsIMFNService.msgKeyChanged, 0);</span>
<a href="#l19.79"></a><span id="l19.79">     this.mReceived |= nsIMFNService.msgKeyChanged;</span>
<a href="#l19.80"></a><span id="l19.80">     if (this.mRemoveSelf)</span>
<a href="#l19.81"></a><span id="l19.81" class="difflineminus">-      gMFNService.removeListener(this);</span>
<a href="#l19.82"></a><span id="l19.82" class="difflineplus">+      MailServices.mfn.removeListener(this);</span>
<a href="#l19.83"></a><span id="l19.83">   },</span>
<a href="#l19.84"></a><span id="l19.84"> </span>
<a href="#l19.85"></a><span id="l19.85">   folderAdded: function (aFolder)</span>
<a href="#l19.86"></a><span id="l19.86">   {</span>
<a href="#l19.87"></a><span id="l19.87">     do_check_eq(this.mReceived &amp; nsIMFNService.folderAdded, 0);</span>
<a href="#l19.88"></a><span id="l19.88">     this.mReceived |= nsIMFNService.folderAdded;</span>
<a href="#l19.89"></a><span id="l19.89">     if (this.mRemoveSelf)</span>
<a href="#l19.90"></a><span id="l19.90" class="difflineminus">-      gMFNService.removeListener(this);</span>
<a href="#l19.91"></a><span id="l19.91" class="difflineplus">+      MailServices.mfn.removeListener(this);</span>
<a href="#l19.92"></a><span id="l19.92">   },</span>
<a href="#l19.93"></a><span id="l19.93"> </span>
<a href="#l19.94"></a><span id="l19.94">   folderDeleted: function (aFolder)</span>
<a href="#l19.95"></a><span id="l19.95">   {</span>
<a href="#l19.96"></a><span id="l19.96">     do_check_eq(this.mReceived &amp; nsIMFNService.folderDeleted, 0);</span>
<a href="#l19.97"></a><span id="l19.97">     this.mReceived |= nsIMFNService.folderDeleted;</span>
<a href="#l19.98"></a><span id="l19.98">     if (this.mRemoveSelf)</span>
<a href="#l19.99"></a><span id="l19.99" class="difflineminus">-      gMFNService.removeListener(this);</span>
<a href="#l19.100"></a><span id="l19.100" class="difflineplus">+      MailServices.mfn.removeListener(this);</span>
<a href="#l19.101"></a><span id="l19.101">   },</span>
<a href="#l19.102"></a><span id="l19.102"> </span>
<a href="#l19.103"></a><span id="l19.103">   folderMoveCopyCompleted: function (aMove, aSrcFolder, aDestFolder)</span>
<a href="#l19.104"></a><span id="l19.104">   {</span>
<a href="#l19.105"></a><span id="l19.105">     do_check_eq(this.mReceived &amp; nsIMFNService.folderMoveCopyCompleted, 0);</span>
<a href="#l19.106"></a><span id="l19.106">     this.mReceived |= nsIMFNService.folderMoveCopyCompleted;</span>
<a href="#l19.107"></a><span id="l19.107">     if (this.mRemoveSelf)</span>
<a href="#l19.108"></a><span id="l19.108" class="difflineminus">-      gMFNService.removeListener(this);</span>
<a href="#l19.109"></a><span id="l19.109" class="difflineplus">+      MailServices.mfn.removeListener(this);</span>
<a href="#l19.110"></a><span id="l19.110">   },</span>
<a href="#l19.111"></a><span id="l19.111"> </span>
<a href="#l19.112"></a><span id="l19.112">   folderRenamed: function (aOrigFolder, aNewFolder)</span>
<a href="#l19.113"></a><span id="l19.113">   {</span>
<a href="#l19.114"></a><span id="l19.114">     do_check_eq(this.mReceived &amp; nsIMFNService.folderRenamed, 0);</span>
<a href="#l19.115"></a><span id="l19.115">     this.mReceived |= nsIMFNService.folderRenamed;</span>
<a href="#l19.116"></a><span id="l19.116">     if (this.mRemoveSelf)</span>
<a href="#l19.117"></a><span id="l19.117" class="difflineminus">-      gMFNService.removeListener(this);</span>
<a href="#l19.118"></a><span id="l19.118" class="difflineplus">+      MailServices.mfn.removeListener(this);</span>
<a href="#l19.119"></a><span id="l19.119">   },</span>
<a href="#l19.120"></a><span id="l19.120"> </span>
<a href="#l19.121"></a><span id="l19.121">   itemEvent: function (aItem, aEvent, aData)</span>
<a href="#l19.122"></a><span id="l19.122">   {</span>
<a href="#l19.123"></a><span id="l19.123">     do_check_eq(this.mReceived &amp; nsIMFNService.itemEvent, 0);</span>
<a href="#l19.124"></a><span id="l19.124">     this.mReceived |= nsIMFNService.itemEvent;</span>
<a href="#l19.125"></a><span id="l19.125">     if (this.mRemoveSelf)</span>
<a href="#l19.126"></a><span id="l19.126" class="difflineminus">-      gMFNService.removeListener(this);</span>
<a href="#l19.127"></a><span id="l19.127" class="difflineplus">+      MailServices.mfn.removeListener(this);</span>
<a href="#l19.128"></a><span id="l19.128">   }</span>
<a href="#l19.129"></a><span id="l19.129"> };</span>
<a href="#l19.130"></a><span id="l19.130"> </span>
<a href="#l19.131"></a><span id="l19.131"> function NotifyMsgFolderListeners()</span>
<a href="#l19.132"></a><span id="l19.132"> {</span>
<a href="#l19.133"></a><span id="l19.133" class="difflineminus">-  gMFNService.notifyMsgAdded(null);</span>
<a href="#l19.134"></a><span id="l19.134" class="difflineminus">-  gMFNService.notifyMsgsClassified(null, null, null);</span>
<a href="#l19.135"></a><span id="l19.135" class="difflineminus">-  gMFNService.notifyMsgsDeleted(null);</span>
<a href="#l19.136"></a><span id="l19.136" class="difflineminus">-  gMFNService.notifyMsgsMoveCopyCompleted(null, null, null, null);</span>
<a href="#l19.137"></a><span id="l19.137" class="difflineminus">-  gMFNService.notifyMsgKeyChanged(null, null);</span>
<a href="#l19.138"></a><span id="l19.138" class="difflineminus">-  gMFNService.notifyFolderAdded(null);</span>
<a href="#l19.139"></a><span id="l19.139" class="difflineminus">-  gMFNService.notifyFolderDeleted(null);</span>
<a href="#l19.140"></a><span id="l19.140" class="difflineminus">-  gMFNService.notifyFolderMoveCopyCompleted(null, null, null);</span>
<a href="#l19.141"></a><span id="l19.141" class="difflineminus">-  gMFNService.notifyFolderRenamed(null, null);</span>
<a href="#l19.142"></a><span id="l19.142" class="difflineminus">-  gMFNService.notifyItemEvent(null, null, null);</span>
<a href="#l19.143"></a><span id="l19.143" class="difflineplus">+  MailServices.mfn.notifyMsgAdded(null);</span>
<a href="#l19.144"></a><span id="l19.144" class="difflineplus">+  MailServices.mfn.notifyMsgsClassified(null, null, null);</span>
<a href="#l19.145"></a><span id="l19.145" class="difflineplus">+  MailServices.mfn.notifyMsgsDeleted(null);</span>
<a href="#l19.146"></a><span id="l19.146" class="difflineplus">+  MailServices.mfn.notifyMsgsMoveCopyCompleted(null, null, null, null);</span>
<a href="#l19.147"></a><span id="l19.147" class="difflineplus">+  MailServices.mfn.notifyMsgKeyChanged(null, null);</span>
<a href="#l19.148"></a><span id="l19.148" class="difflineplus">+  MailServices.mfn.notifyFolderAdded(null);</span>
<a href="#l19.149"></a><span id="l19.149" class="difflineplus">+  MailServices.mfn.notifyFolderDeleted(null);</span>
<a href="#l19.150"></a><span id="l19.150" class="difflineplus">+  MailServices.mfn.notifyFolderMoveCopyCompleted(null, null, null);</span>
<a href="#l19.151"></a><span id="l19.151" class="difflineplus">+  MailServices.mfn.notifyFolderRenamed(null, null);</span>
<a href="#l19.152"></a><span id="l19.152" class="difflineplus">+  MailServices.mfn.notifyItemEvent(null, null, null);</span>
<a href="#l19.153"></a><span id="l19.153"> }</span>
<a href="#l19.154"></a><span id="l19.154"> </span>
<a href="#l19.155"></a><span id="l19.155"> function run_test()</span>
<a href="#l19.156"></a><span id="l19.156"> {</span>
<a href="#l19.157"></a><span id="l19.157">   // Test: Add listeners</span>
<a href="#l19.158"></a><span id="l19.158">   var singleListeners = [];</span>
<a href="#l19.159"></a><span id="l19.159"> </span>
<a href="#l19.160"></a><span id="l19.160">   var addAListener = function (flag) {</span>
<a href="#l19.161"></a><span id="l19.161">     var listener = new gMFListener();</span>
<a href="#l19.162"></a><span id="l19.162" class="difflineminus">-    gMFNService.addListener(listener, flag);</span>
<a href="#l19.163"></a><span id="l19.163" class="difflineplus">+    MailServices.mfn.addListener(listener, flag);</span>
<a href="#l19.164"></a><span id="l19.164">     singleListeners.push(listener);</span>
<a href="#l19.165"></a><span id="l19.165">   };</span>
<a href="#l19.166"></a><span id="l19.166"> </span>
<a href="#l19.167"></a><span id="l19.167">   gIndividualFlags.forEach(addAListener);</span>
<a href="#l19.168"></a><span id="l19.168"> </span>
<a href="#l19.169"></a><span id="l19.169">   // Test: Notify the listeners of all events.</span>
<a href="#l19.170"></a><span id="l19.170">   NotifyMsgFolderListeners();</span>
<a href="#l19.171"></a><span id="l19.171"> </span>
<a href="#l19.172"></a><span id="l19.172" class="difflineat">@@ -158,17 +157,17 @@ function run_test()</span>
<a href="#l19.173"></a><span id="l19.173">     singleListeners.push(listener);</span>
<a href="#l19.174"></a><span id="l19.174">   };</span>
<a href="#l19.175"></a><span id="l19.175">   gIndividualFlags.forEach(checkFlag);</span>
<a href="#l19.176"></a><span id="l19.176"> </span>
<a href="#l19.177"></a><span id="l19.177">   // We'll do one more set of notifications, and remove ourselves in the middle of them</span>
<a href="#l19.178"></a><span id="l19.178">   NotifyMsgFolderListeners();</span>
<a href="#l19.179"></a><span id="l19.179"> </span>
<a href="#l19.180"></a><span id="l19.180">   // Test: all listeners should be removed at this point</span>
<a href="#l19.181"></a><span id="l19.181" class="difflineminus">-  do_check_false(gMFNService.hasListeners);</span>
<a href="#l19.182"></a><span id="l19.182" class="difflineplus">+  do_check_false(MailServices.mfn.hasListeners);</span>
<a href="#l19.183"></a><span id="l19.183"> </span>
<a href="#l19.184"></a><span id="l19.184">   // Test: Send notifications again. Check that we don't receive any notifications.</span>
<a href="#l19.185"></a><span id="l19.185">   singleListeners.forEach(function (listener) { listener.mReceived = 0; });</span>
<a href="#l19.186"></a><span id="l19.186"> </span>
<a href="#l19.187"></a><span id="l19.187">   NotifyMsgFolderListeners();</span>
<a href="#l19.188"></a><span id="l19.188"> </span>
<a href="#l19.189"></a><span id="l19.189">   var checkNotReceived = function() {</span>
<a href="#l19.190"></a><span id="l19.190">     do_check_eq(singleListeners.shift().mReceived, 0);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/base/test/unit/test_nsIMsgTagService.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_nsIMsgTagService.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -4,76 +4,76 @@</span>
<a href="#l20.4"></a><span id="l20.4"> </span>
<a href="#l20.5"></a><span id="l20.5"> /*</span>
<a href="#l20.6"></a><span id="l20.6">  * Tests of nsIMsgTagService.</span>
<a href="#l20.7"></a><span id="l20.7">  *</span>
<a href="#l20.8"></a><span id="l20.8">  * Specifically tests changes implemented in bug 217034</span>
<a href="#l20.9"></a><span id="l20.9">  * Does not do comprehensive testing.</span>
<a href="#l20.10"></a><span id="l20.10">  *</span>
<a href="#l20.11"></a><span id="l20.11">  */</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-const tagService = Cc[&quot;@mozilla.org/messenger/tagservice;1&quot;]</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-                     .getService(Ci.nsIMsgTagService);</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineplus">+</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l20.16"></a><span id="l20.16"> </span>
<a href="#l20.17"></a><span id="l20.17"> function run_test()</span>
<a href="#l20.18"></a><span id="l20.18"> {</span>
<a href="#l20.19"></a><span id="l20.19">   // These are both tags and keys. Note keys are forced to be lower case</span>
<a href="#l20.20"></a><span id="l20.20">   const tag1 = &quot;istag&quot;;</span>
<a href="#l20.21"></a><span id="l20.21">   const tag2 = &quot;notistag&quot;;</span>
<a href="#l20.22"></a><span id="l20.22">   const tag3 = &quot;istagnot&quot;;</span>
<a href="#l20.23"></a><span id="l20.23">   const tag4 = &quot;istagtoo&quot;;</span>
<a href="#l20.24"></a><span id="l20.24"> </span>
<a href="#l20.25"></a><span id="l20.25">   // add a tag</span>
<a href="#l20.26"></a><span id="l20.26" class="difflineminus">-  tagService.addTagForKey(tag1, tag1, null, null);</span>
<a href="#l20.27"></a><span id="l20.27" class="difflineplus">+  MailServices.tags.addTagForKey(tag1, tag1, null, null);</span>
<a href="#l20.28"></a><span id="l20.28"> </span>
<a href="#l20.29"></a><span id="l20.29">   // delete any existing tags</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineminus">-  var tagArray = tagService.getAllTags({});</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineplus">+  let tagArray = MailServices.tags.getAllTags({});</span>
<a href="#l20.32"></a><span id="l20.32">   for (var i = 0; i &lt; tagArray.length; i++)</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineminus">-    tagService.deleteKey(tagArray[i].key);</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineplus">+    MailServices.tags.deleteKey(tagArray[i].key);</span>
<a href="#l20.35"></a><span id="l20.35"> </span>
<a href="#l20.36"></a><span id="l20.36">   // make sure added tag is now gone</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineminus">-  do_check_false(tagService.isValidKey(tag1));</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineplus">+  do_check_false(MailServices.tags.isValidKey(tag1));</span>
<a href="#l20.39"></a><span id="l20.39"> </span>
<a href="#l20.40"></a><span id="l20.40">   // add single tag, and check again</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineminus">-  tagService.addTagForKey(tag1, tag1, null, null);</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineminus">-  do_check_true(tagService.isValidKey(tag1));</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineminus">-  do_check_false(tagService.isValidKey(tag4));</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineplus">+  MailServices.tags.addTagForKey(tag1, tag1, null, null);</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineplus">+  do_check_true(MailServices.tags.isValidKey(tag1));</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineplus">+  do_check_false(MailServices.tags.isValidKey(tag4));</span>
<a href="#l20.47"></a><span id="l20.47"> </span>
<a href="#l20.48"></a><span id="l20.48">   // add second tag and check</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineminus">-  tagService.addTagForKey(tag4, tag4, null, null);</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineminus">-  do_check_true(tagService.isValidKey(tag1));</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineminus">-  do_check_false(tagService.isValidKey(tag2));</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineminus">-  do_check_false(tagService.isValidKey(tag3));</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineminus">-  do_check_true(tagService.isValidKey(tag4));</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineplus">+  MailServices.tags.addTagForKey(tag4, tag4, null, null);</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineplus">+  do_check_true(MailServices.tags.isValidKey(tag1));</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineplus">+  do_check_false(MailServices.tags.isValidKey(tag2));</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineplus">+  do_check_false(MailServices.tags.isValidKey(tag3));</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineplus">+  do_check_true(MailServices.tags.isValidKey(tag4));</span>
<a href="#l20.59"></a><span id="l20.59"> </span>
<a href="#l20.60"></a><span id="l20.60">   // delete a tag and check</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineminus">-  tagService.deleteKey(tag1);</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineminus">-  do_check_false(tagService.isValidKey(tag1));</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineminus">-  do_check_false(tagService.isValidKey(tag2));</span>
<a href="#l20.64"></a><span id="l20.64" class="difflineminus">-  do_check_false(tagService.isValidKey(tag3));</span>
<a href="#l20.65"></a><span id="l20.65" class="difflineminus">-  do_check_true(tagService.isValidKey(tag4));</span>
<a href="#l20.66"></a><span id="l20.66" class="difflineplus">+  MailServices.tags.deleteKey(tag1);</span>
<a href="#l20.67"></a><span id="l20.67" class="difflineplus">+  do_check_false(MailServices.tags.isValidKey(tag1));</span>
<a href="#l20.68"></a><span id="l20.68" class="difflineplus">+  do_check_false(MailServices.tags.isValidKey(tag2));</span>
<a href="#l20.69"></a><span id="l20.69" class="difflineplus">+  do_check_false(MailServices.tags.isValidKey(tag3));</span>
<a href="#l20.70"></a><span id="l20.70" class="difflineplus">+  do_check_true(MailServices.tags.isValidKey(tag4));</span>
<a href="#l20.71"></a><span id="l20.71"> </span>
<a href="#l20.72"></a><span id="l20.72">   // add many tags and check again</span>
<a href="#l20.73"></a><span id="l20.73">   for (i = 0; i &lt; 100; i++)</span>
<a href="#l20.74"></a><span id="l20.74" class="difflineminus">-    tagService.addTagForKey(i, &quot;lotsatags&quot; + i, null, null);</span>
<a href="#l20.75"></a><span id="l20.75" class="difflineminus">-  do_check_false(tagService.isValidKey(tag1));</span>
<a href="#l20.76"></a><span id="l20.76" class="difflineminus">-  do_check_false(tagService.isValidKey(tag2));</span>
<a href="#l20.77"></a><span id="l20.77" class="difflineminus">-  do_check_false(tagService.isValidKey(tag3));</span>
<a href="#l20.78"></a><span id="l20.78" class="difflineminus">-  do_check_true(tagService.isValidKey(tag4));</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineplus">+    MailServices.tags.addTagForKey(i, &quot;lotsatags&quot; + i, null, null);</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineplus">+  do_check_false(MailServices.tags.isValidKey(tag1));</span>
<a href="#l20.81"></a><span id="l20.81" class="difflineplus">+  do_check_false(MailServices.tags.isValidKey(tag2));</span>
<a href="#l20.82"></a><span id="l20.82" class="difflineplus">+  do_check_false(MailServices.tags.isValidKey(tag3));</span>
<a href="#l20.83"></a><span id="l20.83" class="difflineplus">+  do_check_true(MailServices.tags.isValidKey(tag4));</span>
<a href="#l20.84"></a><span id="l20.84"> </span>
<a href="#l20.85"></a><span id="l20.85">   for (i = 0; i &lt; 100; i++)</span>
<a href="#l20.86"></a><span id="l20.86">   {</span>
<a href="#l20.87"></a><span id="l20.87" class="difflineminus">-    do_check_true(tagService.isValidKey(i));</span>
<a href="#l20.88"></a><span id="l20.88" class="difflineplus">+    do_check_true(MailServices.tags.isValidKey(i));</span>
<a href="#l20.89"></a><span id="l20.89">     // make sure it knows the difference betweens tags and keys</span>
<a href="#l20.90"></a><span id="l20.90" class="difflineminus">-    do_check_false(tagService.isValidKey(&quot;lotsatags&quot; + i));</span>
<a href="#l20.91"></a><span id="l20.91" class="difflineplus">+    do_check_false(MailServices.tags.isValidKey(&quot;lotsatags&quot; + i));</span>
<a href="#l20.92"></a><span id="l20.92">     // are we confused by key at start of tag?</span>
<a href="#l20.93"></a><span id="l20.93" class="difflineminus">-    do_check_false(tagService.isValidKey(i + &quot;lotsatags&quot;));</span>
<a href="#l20.94"></a><span id="l20.94" class="difflineplus">+    do_check_false(MailServices.tags.isValidKey(i + &quot;lotsatags&quot;));</span>
<a href="#l20.95"></a><span id="l20.95">   }</span>
<a href="#l20.96"></a><span id="l20.96"> }</span>
<a href="#l20.97"></a><span id="l20.97"> </span>
<a href="#l20.98"></a><span id="l20.98"> /*  </span>
<a href="#l20.99"></a><span id="l20.99">   function printTags()</span>
<a href="#l20.100"></a><span id="l20.100">   {</span>
<a href="#l20.101"></a><span id="l20.101" class="difflineminus">-    var tags = tagService.getAllTags({});</span>
<a href="#l20.102"></a><span id="l20.102" class="difflineplus">+    let tags = MailServices.tags.getAllTags({});</span>
<a href="#l20.103"></a><span id="l20.103">     for (var i = 0; i &lt; tags.length; i++)</span>
<a href="#l20.104"></a><span id="l20.104">       print(&quot;# &quot; + i + &quot; key [&quot; + tags[i].key + &quot;] tag [&quot; + tags[i].tag + &quot;]&quot;);</span>
<a href="#l20.105"></a><span id="l20.105">   }</span>
<a href="#l20.106"></a><span id="l20.106">  */</span>
<a href="#l20.107"></a><span id="l20.107"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/base/test/unit/test_nsMsgMailSession_Alerts.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_nsMsgMailSession_Alerts.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -1,15 +1,17 @@</span>
<a href="#l21.4"></a><span id="l21.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l21.5"></a><span id="l21.5"> /*</span>
<a href="#l21.6"></a><span id="l21.6">  * Test suite for nsMsgMailSession functions relating to alerts and their</span>
<a href="#l21.7"></a><span id="l21.7">  * listeners.</span>
<a href="#l21.8"></a><span id="l21.8">  */</span>
<a href="#l21.9"></a><span id="l21.9"> </span>
<a href="#l21.10"></a><span id="l21.10" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l21.11"></a><span id="l21.11"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineplus">+</span>
<a href="#l21.13"></a><span id="l21.13"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l21.14"></a><span id="l21.14"> </span>
<a href="#l21.15"></a><span id="l21.15"> var gDialogTitle = null;</span>
<a href="#l21.16"></a><span id="l21.16"> var gText = null;</span>
<a href="#l21.17"></a><span id="l21.17"> </span>
<a href="#l21.18"></a><span id="l21.18"> function reset() {</span>
<a href="#l21.19"></a><span id="l21.19">   gDialogTitle = null;</span>
<a href="#l21.20"></a><span id="l21.20">   gText = null;</span>
<a href="#l21.21"></a><span id="l21.21" class="difflineat">@@ -61,89 +63,86 @@ alertListener.prototype = {</span>
<a href="#l21.22"></a><span id="l21.22">     this.mMsgWindow = aMsgWindow;</span>
<a href="#l21.23"></a><span id="l21.23"> </span>
<a href="#l21.24"></a><span id="l21.24">     return this.mReturn;</span>
<a href="#l21.25"></a><span id="l21.25">   }</span>
<a href="#l21.26"></a><span id="l21.26"> };</span>
<a href="#l21.27"></a><span id="l21.27"> </span>
<a href="#l21.28"></a><span id="l21.28"> function run_test()</span>
<a href="#l21.29"></a><span id="l21.29"> {</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineminus">-  var mailSession = Cc[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineminus">-    .getService(Ci.nsIMsgMailSession);</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineminus">-</span>
<a href="#l21.33"></a><span id="l21.33">   // Test - No listeners, check alert tries to alert the user.</span>
<a href="#l21.34"></a><span id="l21.34"> </span>
<a href="#l21.35"></a><span id="l21.35">   reset();</span>
<a href="#l21.36"></a><span id="l21.36"> </span>
<a href="#l21.37"></a><span id="l21.37">   msgUrl._msgWindow = msgWindow;</span>
<a href="#l21.38"></a><span id="l21.38"> </span>
<a href="#l21.39"></a><span id="l21.39" class="difflineminus">-  mailSession.alertUser(&quot;test message&quot;, msgUrl);</span>
<a href="#l21.40"></a><span id="l21.40" class="difflineplus">+  MailServices.mailSession.alertUser(&quot;test message&quot;, msgUrl);</span>
<a href="#l21.41"></a><span id="l21.41"> </span>
<a href="#l21.42"></a><span id="l21.42">   // The dialog title doesn't get set at the moment.</span>
<a href="#l21.43"></a><span id="l21.43">   do_check_eq(gDialogTitle, null);</span>
<a href="#l21.44"></a><span id="l21.44">   do_check_eq(gText, &quot;test message&quot;);</span>
<a href="#l21.45"></a><span id="l21.45"> </span>
<a href="#l21.46"></a><span id="l21.46">   // Test - No listeners and no msgWindow, check no alerts.</span>
<a href="#l21.47"></a><span id="l21.47"> </span>
<a href="#l21.48"></a><span id="l21.48">   reset();</span>
<a href="#l21.49"></a><span id="l21.49"> </span>
<a href="#l21.50"></a><span id="l21.50">   msgUrl._msgWindow = null;</span>
<a href="#l21.51"></a><span id="l21.51"> </span>
<a href="#l21.52"></a><span id="l21.52" class="difflineminus">-  mailSession.alertUser(&quot;test no message&quot;, msgUrl);</span>
<a href="#l21.53"></a><span id="l21.53" class="difflineplus">+  MailServices.mailSession.alertUser(&quot;test no message&quot;, msgUrl);</span>
<a href="#l21.54"></a><span id="l21.54"> </span>
<a href="#l21.55"></a><span id="l21.55">   // The dialog title doesn't get set at the moment.</span>
<a href="#l21.56"></a><span id="l21.56">   do_check_eq(gDialogTitle, null);</span>
<a href="#l21.57"></a><span id="l21.57">   do_check_eq(gText, null);</span>
<a href="#l21.58"></a><span id="l21.58"> </span>
<a href="#l21.59"></a><span id="l21.59">   // Test - One listener, returning false (prompt should still happen).</span>
<a href="#l21.60"></a><span id="l21.60"> </span>
<a href="#l21.61"></a><span id="l21.61">   reset();</span>
<a href="#l21.62"></a><span id="l21.62"> </span>
<a href="#l21.63"></a><span id="l21.63">   var listener1 = new alertListener();</span>
<a href="#l21.64"></a><span id="l21.64">   listener1.mReturn = false;</span>
<a href="#l21.65"></a><span id="l21.65"> </span>
<a href="#l21.66"></a><span id="l21.66" class="difflineminus">-  mailSession.addUserFeedbackListener(listener1);</span>
<a href="#l21.67"></a><span id="l21.67" class="difflineplus">+  MailServices.mailSession.addUserFeedbackListener(listener1);</span>
<a href="#l21.68"></a><span id="l21.68"> </span>
<a href="#l21.69"></a><span id="l21.69">   msgUrl._msgWindow = msgWindow;</span>
<a href="#l21.70"></a><span id="l21.70"> </span>
<a href="#l21.71"></a><span id="l21.71" class="difflineminus">-  mailSession.alertUser(&quot;message test&quot;, msgUrl);</span>
<a href="#l21.72"></a><span id="l21.72" class="difflineplus">+  MailServices.mailSession.alertUser(&quot;message test&quot;, msgUrl);</span>
<a href="#l21.73"></a><span id="l21.73"> </span>
<a href="#l21.74"></a><span id="l21.74">   do_check_eq(gDialogTitle, null);</span>
<a href="#l21.75"></a><span id="l21.75">   do_check_eq(gText, &quot;message test&quot;);</span>
<a href="#l21.76"></a><span id="l21.76"> </span>
<a href="#l21.77"></a><span id="l21.77">   do_check_eq(listener1.mMessage, &quot;message test&quot;);</span>
<a href="#l21.78"></a><span id="l21.78">   do_check_neq(listener1.mMsgWindow, null);</span>
<a href="#l21.79"></a><span id="l21.79"> </span>
<a href="#l21.80"></a><span id="l21.80">   // Test - One listener, returning false, no msg window (prompt shouldn't</span>
<a href="#l21.81"></a><span id="l21.81">   //        happen).</span>
<a href="#l21.82"></a><span id="l21.82"> </span>
<a href="#l21.83"></a><span id="l21.83">   reset();</span>
<a href="#l21.84"></a><span id="l21.84">   listener1.reset();</span>
<a href="#l21.85"></a><span id="l21.85"> </span>
<a href="#l21.86"></a><span id="l21.86" class="difflineminus">-  mailSession.alertUser(&quot;message test no prompt&quot;, null);</span>
<a href="#l21.87"></a><span id="l21.87" class="difflineplus">+  MailServices.mailSession.alertUser(&quot;message test no prompt&quot;, null);</span>
<a href="#l21.88"></a><span id="l21.88"> </span>
<a href="#l21.89"></a><span id="l21.89">   do_check_eq(gDialogTitle, null);</span>
<a href="#l21.90"></a><span id="l21.90">   do_check_eq(gText, null);</span>
<a href="#l21.91"></a><span id="l21.91"> </span>
<a href="#l21.92"></a><span id="l21.92">   do_check_eq(listener1.mMessage, &quot;message test no prompt&quot;);</span>
<a href="#l21.93"></a><span id="l21.93">   do_check_eq(listener1.mMsgWindow, null);</span>
<a href="#l21.94"></a><span id="l21.94"> </span>
<a href="#l21.95"></a><span id="l21.95">   // Test - Two listeners, both returning false (prompt should happen).</span>
<a href="#l21.96"></a><span id="l21.96"> </span>
<a href="#l21.97"></a><span id="l21.97">   reset();</span>
<a href="#l21.98"></a><span id="l21.98">   listener1.reset();</span>
<a href="#l21.99"></a><span id="l21.99"> </span>
<a href="#l21.100"></a><span id="l21.100">   var listener2 = new alertListener();</span>
<a href="#l21.101"></a><span id="l21.101">   listener2.mReturn = false;</span>
<a href="#l21.102"></a><span id="l21.102"> </span>
<a href="#l21.103"></a><span id="l21.103" class="difflineminus">-  mailSession.addUserFeedbackListener(listener2);</span>
<a href="#l21.104"></a><span id="l21.104" class="difflineplus">+  MailServices.mailSession.addUserFeedbackListener(listener2);</span>
<a href="#l21.105"></a><span id="l21.105"> </span>
<a href="#l21.106"></a><span id="l21.106">   msgUrl._msgWindow = msgWindow;</span>
<a href="#l21.107"></a><span id="l21.107"> </span>
<a href="#l21.108"></a><span id="l21.108" class="difflineminus">-  mailSession.alertUser(&quot;two listeners&quot;, msgUrl);</span>
<a href="#l21.109"></a><span id="l21.109" class="difflineplus">+  MailServices.mailSession.alertUser(&quot;two listeners&quot;, msgUrl);</span>
<a href="#l21.110"></a><span id="l21.110"> </span>
<a href="#l21.111"></a><span id="l21.111">   do_check_eq(gDialogTitle, null);</span>
<a href="#l21.112"></a><span id="l21.112">   do_check_eq(gText, &quot;two listeners&quot;);</span>
<a href="#l21.113"></a><span id="l21.113"> </span>
<a href="#l21.114"></a><span id="l21.114">   do_check_eq(listener1.mMessage, &quot;two listeners&quot;);</span>
<a href="#l21.115"></a><span id="l21.115">   do_check_neq(listener1.mMsgWindow, null);</span>
<a href="#l21.116"></a><span id="l21.116"> </span>
<a href="#l21.117"></a><span id="l21.117">   do_check_eq(listener2.mMessage, &quot;two listeners&quot;);</span>
<a href="#l21.118"></a><span id="l21.118" class="difflineat">@@ -154,59 +153,59 @@ function run_test()</span>
<a href="#l21.119"></a><span id="l21.119">   reset();</span>
<a href="#l21.120"></a><span id="l21.120">   listener1.reset();</span>
<a href="#l21.121"></a><span id="l21.121">   listener2.reset();</span>
<a href="#l21.122"></a><span id="l21.122"> </span>
<a href="#l21.123"></a><span id="l21.123">   listener2.mReturn = true;</span>
<a href="#l21.124"></a><span id="l21.124"> </span>
<a href="#l21.125"></a><span id="l21.125">   msgUrl._msgWindow = msgWindow;</span>
<a href="#l21.126"></a><span id="l21.126"> </span>
<a href="#l21.127"></a><span id="l21.127" class="difflineminus">-  mailSession.alertUser(&quot;no prompt&quot;, msgUrl);</span>
<a href="#l21.128"></a><span id="l21.128" class="difflineplus">+  MailServices.mailSession.alertUser(&quot;no prompt&quot;, msgUrl);</span>
<a href="#l21.129"></a><span id="l21.129"> </span>
<a href="#l21.130"></a><span id="l21.130">   do_check_eq(gDialogTitle, null);</span>
<a href="#l21.131"></a><span id="l21.131">   do_check_eq(gText, null);</span>
<a href="#l21.132"></a><span id="l21.132"> </span>
<a href="#l21.133"></a><span id="l21.133">   do_check_eq(listener1.mMessage, &quot;no prompt&quot;);</span>
<a href="#l21.134"></a><span id="l21.134">   do_check_neq(listener1.mMsgWindow, null);</span>
<a href="#l21.135"></a><span id="l21.135"> </span>
<a href="#l21.136"></a><span id="l21.136">   do_check_eq(listener2.mMessage, &quot;no prompt&quot;);</span>
<a href="#l21.137"></a><span id="l21.137">   do_check_neq(listener2.mMsgWindow, null);</span>
<a href="#l21.138"></a><span id="l21.138"> </span>
<a href="#l21.139"></a><span id="l21.139">   // Test - Remove a listener.</span>
<a href="#l21.140"></a><span id="l21.140"> </span>
<a href="#l21.141"></a><span id="l21.141">   reset();</span>
<a href="#l21.142"></a><span id="l21.142">   listener1.reset();</span>
<a href="#l21.143"></a><span id="l21.143">   listener2.reset();</span>
<a href="#l21.144"></a><span id="l21.144"> </span>
<a href="#l21.145"></a><span id="l21.145" class="difflineminus">-  mailSession.removeUserFeedbackListener(listener1);</span>
<a href="#l21.146"></a><span id="l21.146" class="difflineplus">+  MailServices.mailSession.removeUserFeedbackListener(listener1);</span>
<a href="#l21.147"></a><span id="l21.147"> </span>
<a href="#l21.148"></a><span id="l21.148">   msgUrl._msgWindow = msgWindow;</span>
<a href="#l21.149"></a><span id="l21.149"> </span>
<a href="#l21.150"></a><span id="l21.150" class="difflineminus">-  mailSession.alertUser(&quot;remove listener&quot;, msgUrl);</span>
<a href="#l21.151"></a><span id="l21.151" class="difflineplus">+  MailServices.mailSession.alertUser(&quot;remove listener&quot;, msgUrl);</span>
<a href="#l21.152"></a><span id="l21.152"> </span>
<a href="#l21.153"></a><span id="l21.153">   do_check_eq(gDialogTitle, null);</span>
<a href="#l21.154"></a><span id="l21.154">   do_check_eq(gText, null);</span>
<a href="#l21.155"></a><span id="l21.155"> </span>
<a href="#l21.156"></a><span id="l21.156">   do_check_eq(listener1.mMessage, null);</span>
<a href="#l21.157"></a><span id="l21.157">   do_check_eq(listener1.mMsgWindow, null);</span>
<a href="#l21.158"></a><span id="l21.158"> </span>
<a href="#l21.159"></a><span id="l21.159">   do_check_eq(listener2.mMessage, &quot;remove listener&quot;);</span>
<a href="#l21.160"></a><span id="l21.160">   do_check_neq(listener2.mMsgWindow, null);</span>
<a href="#l21.161"></a><span id="l21.161"> </span>
<a href="#l21.162"></a><span id="l21.162">   // Test - Remove the other listener.</span>
<a href="#l21.163"></a><span id="l21.163"> </span>
<a href="#l21.164"></a><span id="l21.164">   reset();</span>
<a href="#l21.165"></a><span id="l21.165">   listener1.reset();</span>
<a href="#l21.166"></a><span id="l21.166">   listener2.reset();</span>
<a href="#l21.167"></a><span id="l21.167"> </span>
<a href="#l21.168"></a><span id="l21.168" class="difflineminus">-  mailSession.removeUserFeedbackListener(listener2);</span>
<a href="#l21.169"></a><span id="l21.169" class="difflineplus">+  MailServices.mailSession.removeUserFeedbackListener(listener2);</span>
<a href="#l21.170"></a><span id="l21.170"> </span>
<a href="#l21.171"></a><span id="l21.171">   msgUrl._msgWindow = msgWindow;</span>
<a href="#l21.172"></a><span id="l21.172"> </span>
<a href="#l21.173"></a><span id="l21.173" class="difflineminus">-  mailSession.alertUser(&quot;no listeners&quot;, msgUrl);</span>
<a href="#l21.174"></a><span id="l21.174" class="difflineplus">+  MailServices.mailSession.alertUser(&quot;no listeners&quot;, msgUrl);</span>
<a href="#l21.175"></a><span id="l21.175"> </span>
<a href="#l21.176"></a><span id="l21.176">   do_check_eq(gDialogTitle, null);</span>
<a href="#l21.177"></a><span id="l21.177">   do_check_eq(gText, &quot;no listeners&quot;);</span>
<a href="#l21.178"></a><span id="l21.178"> </span>
<a href="#l21.179"></a><span id="l21.179">   do_check_eq(listener1.mMessage, null);</span>
<a href="#l21.180"></a><span id="l21.180">   do_check_eq(listener1.mMsgWindow, null);</span>
<a href="#l21.181"></a><span id="l21.181"> </span>
<a href="#l21.182"></a><span id="l21.182">   do_check_eq(listener2.mMessage, null);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/base/test/unit/test_nsMsgMailSession_Listeners.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_nsMsgMailSession_Listeners.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -1,69 +1,68 @@</span>
<a href="#l22.4"></a><span id="l22.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l22.5"></a><span id="l22.5"> /*</span>
<a href="#l22.6"></a><span id="l22.6">  * Test suite for nsMsgMailSession functions relating to listeners.</span>
<a href="#l22.7"></a><span id="l22.7">  */</span>
<a href="#l22.8"></a><span id="l22.8"> </span>
<a href="#l22.9"></a><span id="l22.9" class="difflineminus">-const nsIMsgMailSession = Components.interfaces.nsIMsgMailSession;</span>
<a href="#l22.10"></a><span id="l22.10" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l22.11"></a><span id="l22.11" class="difflineplus">+</span>
<a href="#l22.12"></a><span id="l22.12"> const nsIFolderListener = Components.interfaces.nsIFolderListener;</span>
<a href="#l22.13"></a><span id="l22.13"> const numListenerFunctions = 8;</span>
<a href="#l22.14"></a><span id="l22.14"> </span>
<a href="#l22.15"></a><span id="l22.15" class="difflineminus">-var gMailSession = Components.classes[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineminus">-                             .getService(nsIMsgMailSession);</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineminus">-var gMailSessionNotifier = gMailSession.QueryInterface(nsIFolderListener);</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineplus">+var gMailSessionNotifier = MailServices.mailSession.QueryInterface(nsIFolderListener);</span>
<a href="#l22.19"></a><span id="l22.19"> </span>
<a href="#l22.20"></a><span id="l22.20"> var gFLAll;</span>
<a href="#l22.21"></a><span id="l22.21"> var gFLSingle = new Array(numListenerFunctions);</span>
<a href="#l22.22"></a><span id="l22.22"> </span>
<a href="#l22.23"></a><span id="l22.23"> function fL() {}</span>
<a href="#l22.24"></a><span id="l22.24"> </span>
<a href="#l22.25"></a><span id="l22.25"> fL.prototype = {</span>
<a href="#l22.26"></a><span id="l22.26">   mReceived: 0,</span>
<a href="#l22.27"></a><span id="l22.27">   mAutoRemoveItem: false,</span>
<a href="#l22.28"></a><span id="l22.28"> </span>
<a href="#l22.29"></a><span id="l22.29">   OnItemAdded: function (parentItem, item) {</span>
<a href="#l22.30"></a><span id="l22.30">     this.mReceived |= nsIFolderListener.added;</span>
<a href="#l22.31"></a><span id="l22.31">     if (this.mAutoRemoveItem)</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineminus">-      gMailSession.RemoveFolderListener(this);</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineplus">+      MailServices.mailSession.RemoveFolderListener(this);</span>
<a href="#l22.34"></a><span id="l22.34">   },</span>
<a href="#l22.35"></a><span id="l22.35">   OnItemRemoved: function (parentItem, item) {</span>
<a href="#l22.36"></a><span id="l22.36">     this.mReceived |= nsIFolderListener.removed;</span>
<a href="#l22.37"></a><span id="l22.37">     if (this.mAutoRemoveItem)</span>
<a href="#l22.38"></a><span id="l22.38" class="difflineminus">-      gMailSession.RemoveFolderListener(this);</span>
<a href="#l22.39"></a><span id="l22.39" class="difflineplus">+      MailServices.mailSession.RemoveFolderListener(this);</span>
<a href="#l22.40"></a><span id="l22.40">   },</span>
<a href="#l22.41"></a><span id="l22.41">   OnItemPropertyChanged: function (item, property, oldValue, newValue) {</span>
<a href="#l22.42"></a><span id="l22.42">     this.mReceived |= nsIFolderListener.propertyChanged;</span>
<a href="#l22.43"></a><span id="l22.43">     if (this.mAutoRemoveItem)</span>
<a href="#l22.44"></a><span id="l22.44" class="difflineminus">-      gMailSession.RemoveFolderListener(this);</span>
<a href="#l22.45"></a><span id="l22.45" class="difflineplus">+      MailServices.mailSession.RemoveFolderListener(this);</span>
<a href="#l22.46"></a><span id="l22.46">   },</span>
<a href="#l22.47"></a><span id="l22.47">   OnItemIntPropertyChanged: function (item, property, oldValue, newValue) {</span>
<a href="#l22.48"></a><span id="l22.48">     this.mReceived |= nsIFolderListener.intPropertyChanged;</span>
<a href="#l22.49"></a><span id="l22.49">     if (this.mAutoRemoveItem)</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineminus">-      gMailSession.RemoveFolderListener(this);</span>
<a href="#l22.51"></a><span id="l22.51" class="difflineplus">+      MailServices.mailSession.RemoveFolderListener(this);</span>
<a href="#l22.52"></a><span id="l22.52">   },</span>
<a href="#l22.53"></a><span id="l22.53">   OnItemBoolPropertyChanged: function (item, property, oldValue, newValue) {</span>
<a href="#l22.54"></a><span id="l22.54">     this.mReceived |= nsIFolderListener.boolPropertyChanged;</span>
<a href="#l22.55"></a><span id="l22.55">     if (this.mAutoRemoveItem)</span>
<a href="#l22.56"></a><span id="l22.56" class="difflineminus">-      gMailSession.RemoveFolderListener(this);</span>
<a href="#l22.57"></a><span id="l22.57" class="difflineplus">+      MailServices.mailSession.RemoveFolderListener(this);</span>
<a href="#l22.58"></a><span id="l22.58">   },</span>
<a href="#l22.59"></a><span id="l22.59">   OnItemUnicharPropertyChanged: function (item, property, oldValue, newValue) {</span>
<a href="#l22.60"></a><span id="l22.60">     this.mReceived |= nsIFolderListener.unicharPropertyChanged;</span>
<a href="#l22.61"></a><span id="l22.61">     if (this.mAutoRemoveItem)</span>
<a href="#l22.62"></a><span id="l22.62" class="difflineminus">-      gMailSession.RemoveFolderListener(this);</span>
<a href="#l22.63"></a><span id="l22.63" class="difflineplus">+      MailServices.mailSession.RemoveFolderListener(this);</span>
<a href="#l22.64"></a><span id="l22.64">   },</span>
<a href="#l22.65"></a><span id="l22.65">   OnItemPropertyFlagChanged: function (item, property, oldValue, newValue) {</span>
<a href="#l22.66"></a><span id="l22.66">     this.mReceived |= nsIFolderListener.propertyFlagChanged;</span>
<a href="#l22.67"></a><span id="l22.67">     if (this.mAutoRemoveItem)</span>
<a href="#l22.68"></a><span id="l22.68" class="difflineminus">-      gMailSession.RemoveFolderListener(this);</span>
<a href="#l22.69"></a><span id="l22.69" class="difflineplus">+      MailServices.mailSession.RemoveFolderListener(this);</span>
<a href="#l22.70"></a><span id="l22.70">   },</span>
<a href="#l22.71"></a><span id="l22.71">   OnItemEvent: function (parentItem, item) {</span>
<a href="#l22.72"></a><span id="l22.72">     this.mReceived |= nsIFolderListener.event;</span>
<a href="#l22.73"></a><span id="l22.73">     if (this.mAutoRemoveItem)</span>
<a href="#l22.74"></a><span id="l22.74" class="difflineminus">-      gMailSession.RemoveFolderListener(this);</span>
<a href="#l22.75"></a><span id="l22.75" class="difflineplus">+      MailServices.mailSession.RemoveFolderListener(this);</span>
<a href="#l22.76"></a><span id="l22.76">   }</span>
<a href="#l22.77"></a><span id="l22.77"> };</span>
<a href="#l22.78"></a><span id="l22.78"> </span>
<a href="#l22.79"></a><span id="l22.79"> function NotifyMailSession() {</span>
<a href="#l22.80"></a><span id="l22.80">     gMailSessionNotifier.OnItemAdded(null, null);</span>
<a href="#l22.81"></a><span id="l22.81">     gMailSessionNotifier.OnItemRemoved(null, null);</span>
<a href="#l22.82"></a><span id="l22.82">     gMailSessionNotifier.OnItemPropertyChanged(null, null, null, null);</span>
<a href="#l22.83"></a><span id="l22.83">     gMailSessionNotifier.OnItemIntPropertyChanged(null, null, null, null);</span>
<a href="#l22.84"></a><span id="l22.84" class="difflineat">@@ -71,27 +70,27 @@ function NotifyMailSession() {</span>
<a href="#l22.85"></a><span id="l22.85">     gMailSessionNotifier.OnItemUnicharPropertyChanged(null, null, null, null);</span>
<a href="#l22.86"></a><span id="l22.86">     gMailSessionNotifier.OnItemPropertyFlagChanged(null, null, null, null);</span>
<a href="#l22.87"></a><span id="l22.87">     gMailSessionNotifier.OnItemEvent(null, null);</span>
<a href="#l22.88"></a><span id="l22.88"> }</span>
<a href="#l22.89"></a><span id="l22.89"> </span>
<a href="#l22.90"></a><span id="l22.90"> function run_test() {</span>
<a href="#l22.91"></a><span id="l22.91">   var i;</span>
<a href="#l22.92"></a><span id="l22.92"> </span>
<a href="#l22.93"></a><span id="l22.93" class="difflineminus">-  do_check_true(gMailSession != null);</span>
<a href="#l22.94"></a><span id="l22.94" class="difflineplus">+  do_check_true(MailServices.mailSession != null);</span>
<a href="#l22.95"></a><span id="l22.95"> </span>
<a href="#l22.96"></a><span id="l22.96">   // Test - Add a listener</span>
<a href="#l22.97"></a><span id="l22.97"> </span>
<a href="#l22.98"></a><span id="l22.98">   gFLAll = new fL;</span>
<a href="#l22.99"></a><span id="l22.99"> </span>
<a href="#l22.100"></a><span id="l22.100" class="difflineminus">-  gMailSession.AddFolderListener(gFLAll, nsIFolderListener.all);</span>
<a href="#l22.101"></a><span id="l22.101" class="difflineplus">+  MailServices.mailSession.AddFolderListener(gFLAll, nsIFolderListener.all);</span>
<a href="#l22.102"></a><span id="l22.102"> </span>
<a href="#l22.103"></a><span id="l22.103">   for (i = 0; i &lt; numListenerFunctions; ++i) {</span>
<a href="#l22.104"></a><span id="l22.104">     gFLSingle[i] = new fL;</span>
<a href="#l22.105"></a><span id="l22.105" class="difflineminus">-    gMailSession.AddFolderListener(gFLSingle[i], Math.pow(2, i));</span>
<a href="#l22.106"></a><span id="l22.106" class="difflineplus">+    MailServices.mailSession.AddFolderListener(gFLSingle[i], Math.pow(2, i));</span>
<a href="#l22.107"></a><span id="l22.107">   }</span>
<a href="#l22.108"></a><span id="l22.108"> </span>
<a href="#l22.109"></a><span id="l22.109">   // Test - Notify listener on all available items</span>
<a href="#l22.110"></a><span id="l22.110"> </span>
<a href="#l22.111"></a><span id="l22.111">   NotifyMailSession();</span>
<a href="#l22.112"></a><span id="l22.112"> </span>
<a href="#l22.113"></a><span id="l22.113">   do_check_eq(gFLAll.mReceived, Math.pow(2, numListenerFunctions) - 1);</span>
<a href="#l22.114"></a><span id="l22.114">   gFLAll.mReceived = 0;</span>
<a href="#l22.115"></a><span id="l22.115" class="difflineat">@@ -125,10 +124,10 @@ function run_test() {</span>
<a href="#l22.116"></a><span id="l22.116">   do_check_eq(gFLAll.mReceived, Math.pow(2, numListenerFunctions) - 1);</span>
<a href="#l22.117"></a><span id="l22.117">   gFLAll.mReceived = 0;</span>
<a href="#l22.118"></a><span id="l22.118"> </span>
<a href="#l22.119"></a><span id="l22.119">   for (i = 0; i &lt; numListenerFunctions; ++i)</span>
<a href="#l22.120"></a><span id="l22.120">     do_check_eq(gFLSingle[i].mReceived, 0);</span>
<a href="#l22.121"></a><span id="l22.121"> </span>
<a href="#l22.122"></a><span id="l22.122">   // Test - Remove main listener</span>
<a href="#l22.123"></a><span id="l22.123"> </span>
<a href="#l22.124"></a><span id="l22.124" class="difflineminus">-  gMailSession.RemoveFolderListener(gFLAll);</span>
<a href="#l22.125"></a><span id="l22.125" class="difflineplus">+  MailServices.mailSession.RemoveFolderListener(gFLAll);</span>
<a href="#l22.126"></a><span id="l22.126"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/base/test/unit/test_postPluginFilters.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_postPluginFilters.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -5,20 +5,16 @@</span>
<a href="#l23.4"></a><span id="l23.4"> /*</span>
<a href="#l23.5"></a><span id="l23.5">  * tests post-plugin message filters as implemented in bug 198100</span>
<a href="#l23.6"></a><span id="l23.6">  */</span>
<a href="#l23.7"></a><span id="l23.7"> </span>
<a href="#l23.8"></a><span id="l23.8"> load(&quot;../../../resources/POP3pump.js&quot;);</span>
<a href="#l23.9"></a><span id="l23.9"> </span>
<a href="#l23.10"></a><span id="l23.10"> // Globals</span>
<a href="#l23.11"></a><span id="l23.11"> </span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-const nsIJunkMailPlugin =</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">-  Cc[&quot;@mozilla.org/messenger/filter-plugin;1?name=bayesianfilter&quot;]</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineminus">-    .getService(Ci.nsIJunkMailPlugin);</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineminus">-</span>
<a href="#l23.16"></a><span id="l23.16"> const gDbService = Cc[&quot;@mozilla.org/msgDatabase/msgDBService;1&quot;]</span>
<a href="#l23.17"></a><span id="l23.17">                      .getService(Ci.nsIMsgDBService);</span>
<a href="#l23.18"></a><span id="l23.18"> </span>
<a href="#l23.19"></a><span id="l23.19"> // command functions for test data</span>
<a href="#l23.20"></a><span id="l23.20"> const kTrain = 0;  // train a file as a trait</span>
<a href="#l23.21"></a><span id="l23.21"> const kClass = 1;  // classify files with traits</span>
<a href="#l23.22"></a><span id="l23.22"> </span>
<a href="#l23.23"></a><span id="l23.23"> var gTest; // currently active test</span>
<a href="#l23.24"></a><span id="l23.24" class="difflineat">@@ -32,22 +28,22 @@ const kPriorityHigh = 5;</span>
<a href="#l23.25"></a><span id="l23.25"> var gInboxListener; // database listener object</span>
<a href="#l23.26"></a><span id="l23.26"> </span>
<a href="#l23.27"></a><span id="l23.27"> var gTests =</span>
<a href="#l23.28"></a><span id="l23.28"> [</span>
<a href="#l23.29"></a><span id="l23.29">   // train two different messages</span>
<a href="#l23.30"></a><span id="l23.30">   {</span>
<a href="#l23.31"></a><span id="l23.31">     command: kTrain,</span>
<a href="#l23.32"></a><span id="l23.32">     fileName: kGoodFile,</span>
<a href="#l23.33"></a><span id="l23.33" class="difflineminus">-    traitId: nsIJunkMailPlugin.GOOD_TRAIT,</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineplus">+    traitId: MailServices.junk.GOOD_TRAIT,</span>
<a href="#l23.35"></a><span id="l23.35">   },</span>
<a href="#l23.36"></a><span id="l23.36">   {</span>
<a href="#l23.37"></a><span id="l23.37">     command: kTrain,</span>
<a href="#l23.38"></a><span id="l23.38">     fileName: kJunkFile,</span>
<a href="#l23.39"></a><span id="l23.39" class="difflineminus">-    traitId: nsIJunkMailPlugin.JUNK_TRAIT,</span>
<a href="#l23.40"></a><span id="l23.40" class="difflineplus">+    traitId: MailServices.junk.JUNK_TRAIT,</span>
<a href="#l23.41"></a><span id="l23.41">   },</span>
<a href="#l23.42"></a><span id="l23.42">   // test a filter that acts on GOOD messages</span>
<a href="#l23.43"></a><span id="l23.43">   {</span>
<a href="#l23.44"></a><span id="l23.44">     command: kClass,</span>
<a href="#l23.45"></a><span id="l23.45">     fileName: kGoodFile,</span>
<a href="#l23.46"></a><span id="l23.46">     test: function testClassGood() {</span>
<a href="#l23.47"></a><span id="l23.47">       do_check_eq(kPriorityHigh, gMsgHdr.priority);</span>
<a href="#l23.48"></a><span id="l23.48">     }</span>
<a href="#l23.49"></a><span id="l23.49" class="difflineat">@@ -73,17 +69,17 @@ function run_test()</span>
<a href="#l23.50"></a><span id="l23.50">   let filterList = gLocalIncomingServer.getFilterList(null);</span>
<a href="#l23.51"></a><span id="l23.51"> </span>
<a href="#l23.52"></a><span id="l23.52">   // junkIsLow filter</span>
<a href="#l23.53"></a><span id="l23.53">   let filter = filterList.createFilter(&quot;junkIsLow&quot;);</span>
<a href="#l23.54"></a><span id="l23.54">   let searchTerm = filter.createTerm();</span>
<a href="#l23.55"></a><span id="l23.55">   searchTerm.attrib = Ci.nsMsgSearchAttrib.JunkStatus;</span>
<a href="#l23.56"></a><span id="l23.56">   let value = searchTerm.value;</span>
<a href="#l23.57"></a><span id="l23.57">   value.attrib = Ci.nsMsgSearchAttrib.JunkStatus;</span>
<a href="#l23.58"></a><span id="l23.58" class="difflineminus">-  value.junkStatus = nsIJunkMailPlugin.JUNK;</span>
<a href="#l23.59"></a><span id="l23.59" class="difflineplus">+  value.junkStatus = MailServices.junk.JUNK;</span>
<a href="#l23.60"></a><span id="l23.60">   searchTerm.value = value;</span>
<a href="#l23.61"></a><span id="l23.61">   searchTerm.op = Ci.nsMsgSearchOp.Is;</span>
<a href="#l23.62"></a><span id="l23.62">   searchTerm.booleanAnd = false;</span>
<a href="#l23.63"></a><span id="l23.63">   filter.appendTerm(searchTerm);</span>
<a href="#l23.64"></a><span id="l23.64">   let action = filter.createAction();</span>
<a href="#l23.65"></a><span id="l23.65">   action.type = Ci.nsMsgFilterAction.ChangePriority;</span>
<a href="#l23.66"></a><span id="l23.66">   action.priority = kPriorityLow;</span>
<a href="#l23.67"></a><span id="l23.67">   filter.appendAction(action);</span>
<a href="#l23.68"></a><span id="l23.68" class="difflineat">@@ -92,17 +88,17 @@ function run_test()</span>
<a href="#l23.69"></a><span id="l23.69">   filterList.insertFilterAt(0, filter);</span>
<a href="#l23.70"></a><span id="l23.70"> </span>
<a href="#l23.71"></a><span id="l23.71">   // goodIsHigh filter</span>
<a href="#l23.72"></a><span id="l23.72">   let filter = filterList.createFilter(&quot;goodIsHigh&quot;);</span>
<a href="#l23.73"></a><span id="l23.73">   let searchTerm = filter.createTerm();</span>
<a href="#l23.74"></a><span id="l23.74">   searchTerm.attrib = Ci.nsMsgSearchAttrib.JunkStatus;</span>
<a href="#l23.75"></a><span id="l23.75">   let value = searchTerm.value;</span>
<a href="#l23.76"></a><span id="l23.76">   value.attrib = Ci.nsMsgSearchAttrib.JunkStatus;</span>
<a href="#l23.77"></a><span id="l23.77" class="difflineminus">-  value.junkStatus = nsIJunkMailPlugin.GOOD;</span>
<a href="#l23.78"></a><span id="l23.78" class="difflineplus">+  value.junkStatus = MailServices.junk.GOOD;</span>
<a href="#l23.79"></a><span id="l23.79">   searchTerm.value = value;</span>
<a href="#l23.80"></a><span id="l23.80">   searchTerm.op = Ci.nsMsgSearchOp.Is;</span>
<a href="#l23.81"></a><span id="l23.81">   searchTerm.booleanAnd = false;</span>
<a href="#l23.82"></a><span id="l23.82">   filter.appendTerm(searchTerm);</span>
<a href="#l23.83"></a><span id="l23.83">   let action = filter.createAction();</span>
<a href="#l23.84"></a><span id="l23.84">   action.type = Ci.nsMsgFilterAction.ChangePriority;</span>
<a href="#l23.85"></a><span id="l23.85">   action.priority = kPriorityHigh;</span>
<a href="#l23.86"></a><span id="l23.86">   filter.appendAction(action);</span>
<a href="#l23.87"></a><span id="l23.87" class="difflineat">@@ -225,17 +221,17 @@ function startCommand()</span>
<a href="#l23.88"></a><span id="l23.88">   gTest = gTests.shift();</span>
<a href="#l23.89"></a><span id="l23.89">   switch (gTest.command)</span>
<a href="#l23.90"></a><span id="l23.90">   {</span>
<a href="#l23.91"></a><span id="l23.91">     case kTrain:</span>
<a href="#l23.92"></a><span id="l23.92">       // train message</span>
<a href="#l23.93"></a><span id="l23.93">       var proArray = [];</span>
<a href="#l23.94"></a><span id="l23.94">       proArray.push(gTest.traitId);</span>
<a href="#l23.95"></a><span id="l23.95"> </span>
<a href="#l23.96"></a><span id="l23.96" class="difflineminus">-      nsIJunkMailPlugin.setMsgTraitClassification(</span>
<a href="#l23.97"></a><span id="l23.97" class="difflineplus">+      MailServices.junk.setMsgTraitClassification(</span>
<a href="#l23.98"></a><span id="l23.98">         getSpec(gTest.fileName), //in string aMsgURI</span>
<a href="#l23.99"></a><span id="l23.99">         0,</span>
<a href="#l23.100"></a><span id="l23.100">         null,         // in nsIArray aOldTraits</span>
<a href="#l23.101"></a><span id="l23.101">         proArray.length,</span>
<a href="#l23.102"></a><span id="l23.102">         proArray,     // in nsIArray aNewTraits</span>
<a href="#l23.103"></a><span id="l23.103">         classifyListener); // [optional] in nsIMsgTraitClassificationListener aTraitListener</span>
<a href="#l23.104"></a><span id="l23.104">         // null,      // [optional] in nsIMsgWindow aMsgWindow</span>
<a href="#l23.105"></a><span id="l23.105">         // null,      // [optional] in nsIJunkMailClassificationListener aJunkListener</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/base/test/unit/test_quarantineFilterMove.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_quarantineFilterMove.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -114,22 +114,20 @@ function run_test()</span>
<a href="#l24.4"></a><span id="l24.4">   Services.prefs.setBoolPref(&quot;mailnews.downloadToTempFile&quot;, true);</span>
<a href="#l24.5"></a><span id="l24.5">   if (!gLocalInboxFolder)</span>
<a href="#l24.6"></a><span id="l24.6">     loadLocalMailAccount();</span>
<a href="#l24.7"></a><span id="l24.7"> </span>
<a href="#l24.8"></a><span id="l24.8">   gMoveFolder = gLocalIncomingServer.rootMsgFolder</span>
<a href="#l24.9"></a><span id="l24.9">                   .createLocalSubfolder(&quot;MoveFolder&quot;);</span>
<a href="#l24.10"></a><span id="l24.10">   gMoveFolder2 = gLocalIncomingServer.rootMsgFolder</span>
<a href="#l24.11"></a><span id="l24.11">                   .createLocalSubfolder(&quot;MoveFolder2&quot;);</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-  const mailSession = Cc[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineminus">-                        .getService(Ci.nsIMsgMailSession);</span>
<a href="#l24.14"></a><span id="l24.14"> </span>
<a href="#l24.15"></a><span id="l24.15" class="difflineminus">-  mailSession.AddFolderListener(FolderListener, Ci.nsIFolderListener.event |</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineminus">-                                                Ci.nsIFolderListener.added |</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineminus">-                                                Ci.nsIFolderListener.removed);</span>
<a href="#l24.18"></a><span id="l24.18" class="difflineplus">+  MailServices.mailSession.AddFolderListener(FolderListener, Ci.nsIFolderListener.event |</span>
<a href="#l24.19"></a><span id="l24.19" class="difflineplus">+                                                             Ci.nsIFolderListener.added |</span>
<a href="#l24.20"></a><span id="l24.20" class="difflineplus">+                                                             Ci.nsIFolderListener.removed);</span>
<a href="#l24.21"></a><span id="l24.21"> </span>
<a href="#l24.22"></a><span id="l24.22">   // &quot;Master&quot; do_test_pending(), paired with a do_test_finished() at the end of</span>
<a href="#l24.23"></a><span id="l24.23">   // all the operations.</span>
<a href="#l24.24"></a><span id="l24.24">   do_test_pending();</span>
<a href="#l24.25"></a><span id="l24.25"> </span>
<a href="#l24.26"></a><span id="l24.26">   //start first test</span>
<a href="#l24.27"></a><span id="l24.27">   doTest();</span>
<a href="#l24.28"></a><span id="l24.28"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/base/util/iteratorUtils.jsm</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/base/util/iteratorUtils.jsm</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -21,17 +21,17 @@ const Ci = Components.interfaces;</span>
<a href="#l25.4"></a><span id="l25.4">  *   Iterator     (i.e toArray(fixIterator(enum))[4])</span>
<a href="#l25.5"></a><span id="l25.5">  *</span>
<a href="#l25.6"></a><span id="l25.6">  * @param aObj        The object to convert</span>
<a href="#l25.7"></a><span id="l25.7">  * @param aUseKeys    If true, an array of keys will be returned instead of the</span>
<a href="#l25.8"></a><span id="l25.8">  *                      values</span>
<a href="#l25.9"></a><span id="l25.9">  */</span>
<a href="#l25.10"></a><span id="l25.10"> function toArray(aObj, aUseKeys) {</span>
<a href="#l25.11"></a><span id="l25.11">   // - The Iterator object seems to be per-scope, so use a string-based check.</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-  //   We use indexOf because the constructor toString returns a function dump,</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+  //   We use contains because the constructor toString returns a function dump,</span>
<a href="#l25.14"></a><span id="l25.14">   //   which we don't actually care about.</span>
<a href="#l25.15"></a><span id="l25.15">   // - Not all iterators are instances of Iterator, so additionally use a</span>
<a href="#l25.16"></a><span id="l25.16">   //   duck-typing test.</span>
<a href="#l25.17"></a><span id="l25.17">   let constructor = aObj.constructor.toString();</span>
<a href="#l25.18"></a><span id="l25.18">   if (constructor.contains(&quot;Iterator&quot;)) {</span>
<a href="#l25.19"></a><span id="l25.19">     if (aUseKeys) {</span>
<a href="#l25.20"></a><span id="l25.20">       return [ a for (a in aObj) ];</span>
<a href="#l25.21"></a><span id="l25.21">     } else {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/base/util/msgDBCacheManager.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/base/util/msgDBCacheManager.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -9,16 +9,17 @@</span>
<a href="#l26.4"></a><span id="l26.4"> /* :::::::: Constants and Helpers ::::::::::::::: */</span>
<a href="#l26.5"></a><span id="l26.5"> </span>
<a href="#l26.6"></a><span id="l26.6"> const EXPORTED_SYMBOLS = [&quot;msgDBCacheManager&quot;];</span>
<a href="#l26.7"></a><span id="l26.7"> </span>
<a href="#l26.8"></a><span id="l26.8"> const Cc = Components.classes;</span>
<a href="#l26.9"></a><span id="l26.9"> const Ci = Components.interfaces;</span>
<a href="#l26.10"></a><span id="l26.10"> const Cu = Components.utils;</span>
<a href="#l26.11"></a><span id="l26.11"> </span>
<a href="#l26.12"></a><span id="l26.12" class="difflineplus">+Cu.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l26.13"></a><span id="l26.13"> Cu.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l26.14"></a><span id="l26.14"> </span>
<a href="#l26.15"></a><span id="l26.15"> /**</span>
<a href="#l26.16"></a><span id="l26.16">  */</span>
<a href="#l26.17"></a><span id="l26.17"> const DBCACHE_INTERVAL_DEFAULT_MS = 60000; // 1 minute</span>
<a href="#l26.18"></a><span id="l26.18"> </span>
<a href="#l26.19"></a><span id="l26.19"> /* :::::::: The Module ::::::::::::::: */</span>
<a href="#l26.20"></a><span id="l26.20"> </span>
<a href="#l26.21"></a><span id="l26.21" class="difflineat">@@ -98,29 +99,27 @@ var msgDBCacheManager =</span>
<a href="#l26.22"></a><span id="l26.22">                                    this._msgDBCacheTimerIntervalMS,</span>
<a href="#l26.23"></a><span id="l26.23">                                    Ci.nsITimer.TYPE_REPEATING_SLACK);</span>
<a href="#l26.24"></a><span id="l26.24">     }</span>
<a href="#l26.25"></a><span id="l26.25">   },</span>
<a href="#l26.26"></a><span id="l26.26">   checkCachedDBs : function ()</span>
<a href="#l26.27"></a><span id="l26.27">   {</span>
<a href="#l26.28"></a><span id="l26.28">     const gDbService = Cc[&quot;@mozilla.org/msgDatabase/msgDBService;1&quot;]</span>
<a href="#l26.29"></a><span id="l26.29">                          .getService(Ci.nsIMsgDBService);</span>
<a href="#l26.30"></a><span id="l26.30" class="difflineminus">-    const mailSession = Cc[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l26.31"></a><span id="l26.31" class="difflineminus">-                          .getService(Ci.nsIMsgMailSession);</span>
<a href="#l26.32"></a><span id="l26.32"> </span>
<a href="#l26.33"></a><span id="l26.33">     let idleLimit = Services.prefs.getIntPref(&quot;mail.db.idle_limit&quot;);</span>
<a href="#l26.34"></a><span id="l26.34">     let maxOpenDBs = Services.prefs.getIntPref(&quot;mail.db.max_open&quot;);</span>
<a href="#l26.35"></a><span id="l26.35"> </span>
<a href="#l26.36"></a><span id="l26.36">     let closeThreshold = Date.now() - idleLimit;</span>
<a href="#l26.37"></a><span id="l26.37">     const nsMsgFolderFlags = Ci.nsMsgFolderFlags;</span>
<a href="#l26.38"></a><span id="l26.38">     let cachedDBs = gDbService.openDBs;</span>
<a href="#l26.39"></a><span id="l26.39">     let numOpenDBs = 0;</span>
<a href="#l26.40"></a><span id="l26.40">     for (let i = 0; i &lt; cachedDBs.length; i++) {</span>
<a href="#l26.41"></a><span id="l26.41">       db = cachedDBs.queryElementAt(i, Ci.nsIMsgDatabase);</span>
<a href="#l26.42"></a><span id="l26.42" class="difflineminus">-      if (mailSession.IsFolderOpenInWindow(db.folder)) {</span>
<a href="#l26.43"></a><span id="l26.43" class="difflineplus">+      if (MailServices.mailSession.IsFolderOpenInWindow(db.folder)) {</span>
<a href="#l26.44"></a><span id="l26.44">         numOpenDBs++;</span>
<a href="#l26.45"></a><span id="l26.45">         continue;</span>
<a href="#l26.46"></a><span id="l26.46">       }</span>
<a href="#l26.47"></a><span id="l26.47">       let lruTime = db.lastUseTime / 1000;</span>
<a href="#l26.48"></a><span id="l26.48">       if (lruTime &lt; closeThreshold)</span>
<a href="#l26.49"></a><span id="l26.49">         db.folder.msgDatabase = null;</span>
<a href="#l26.50"></a><span id="l26.50">       numOpenDBs++;</span>
<a href="#l26.51"></a><span id="l26.51">     }</span>
<a href="#l26.52"></a><span id="l26.52" class="difflineat">@@ -130,17 +129,17 @@ var msgDBCacheManager =</span>
<a href="#l26.53"></a><span id="l26.53">       for (let i = 0; i &lt; openDBs.length; i++)</span>
<a href="#l26.54"></a><span id="l26.54">         dbs.push(openDBs.queryElementAt(i, Ci.nsIMsgDatabase));</span>
<a href="#l26.55"></a><span id="l26.55">       function sortByLastUse(a, b) {</span>
<a href="#l26.56"></a><span id="l26.56">         return a.lastUseTime &gt; b.lastUseTime;</span>
<a href="#l26.57"></a><span id="l26.57">       }</span>
<a href="#l26.58"></a><span id="l26.58">       dbs.sort(sortByLastUse);</span>
<a href="#l26.59"></a><span id="l26.59">       let dbsToClose = maxOpenDBs - dbs.length;</span>
<a href="#l26.60"></a><span id="l26.60">       for each (let [, db] in Iterator(dbs)) {</span>
<a href="#l26.61"></a><span id="l26.61" class="difflineminus">-        if (mailSession.IsFolderOpenInWindow(db.folder))</span>
<a href="#l26.62"></a><span id="l26.62" class="difflineplus">+        if (MailServices.mailSession.IsFolderOpenInWindow(db.folder))</span>
<a href="#l26.63"></a><span id="l26.63">           continue;</span>
<a href="#l26.64"></a><span id="l26.64">         db.folder.msgDatabase = null;</span>
<a href="#l26.65"></a><span id="l26.65">         if (--dbsToClose == 0)</span>
<a href="#l26.66"></a><span id="l26.66">           break;</span>
<a href="#l26.67"></a><span id="l26.67">       }</span>
<a href="#l26.68"></a><span id="l26.68">     }</span>
<a href="#l26.69"></a><span id="l26.69">   },</span>
<a href="#l26.70"></a><span id="l26.70"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/db/msgdb/test/unit/test_enumerator_cleanup.js</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/db/msgdb/test/unit/test_enumerator_cleanup.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -1,14 +1,14 @@</span>
<a href="#l27.4"></a><span id="l27.4"> /*</span>
<a href="#l27.5"></a><span id="l27.5">  * Test nsMsgDatabase's cleanup of nsMsgDBEnumerators</span>
<a href="#l27.6"></a><span id="l27.6">  */</span>
<a href="#l27.7"></a><span id="l27.7"> </span>
<a href="#l27.8"></a><span id="l27.8" class="difflineminus">-const copyService = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l27.9"></a><span id="l27.9" class="difflineminus">-                      .getService(Ci.nsIMsgCopyService);</span>
<a href="#l27.10"></a><span id="l27.10" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l27.11"></a><span id="l27.11" class="difflineplus">+</span>
<a href="#l27.12"></a><span id="l27.12"> const anyOldMessage = do_get_file(&quot;../../../../data/bugmail1&quot;);</span>
<a href="#l27.13"></a><span id="l27.13"> </span>
<a href="#l27.14"></a><span id="l27.14"> /**</span>
<a href="#l27.15"></a><span id="l27.15">  * Test closing a db with an outstanding enumerator.</span>
<a href="#l27.16"></a><span id="l27.16">  */</span>
<a href="#l27.17"></a><span id="l27.17"> function test_enumerator_cleanup() {</span>
<a href="#l27.18"></a><span id="l27.18">   let db = gLocalInboxFolder.msgDatabase;</span>
<a href="#l27.19"></a><span id="l27.19">   let enumerator = db.EnumerateMessages();</span>
<a href="#l27.20"></a><span id="l27.20" class="difflineat">@@ -25,18 +25,18 @@ function test_enumerator_cleanup() {</span>
<a href="#l27.21"></a><span id="l27.21"> /*</span>
<a href="#l27.22"></a><span id="l27.22">  * This infrastructure down here exists just to get</span>
<a href="#l27.23"></a><span id="l27.23">  *  test_references_header_parsing its message header.</span>
<a href="#l27.24"></a><span id="l27.24">  */</span>
<a href="#l27.25"></a><span id="l27.25"> </span>
<a href="#l27.26"></a><span id="l27.26"> function run_test() {</span>
<a href="#l27.27"></a><span id="l27.27">   loadLocalMailAccount();</span>
<a href="#l27.28"></a><span id="l27.28">   do_test_pending();</span>
<a href="#l27.29"></a><span id="l27.29" class="difflineminus">-  copyService.CopyFileMessage(anyOldMessage, gLocalInboxFolder, null, false, 0,</span>
<a href="#l27.30"></a><span id="l27.30" class="difflineminus">-                              &quot;&quot;, messageHeaderGetterListener, null);</span>
<a href="#l27.31"></a><span id="l27.31" class="difflineplus">+  MailServices.copy.CopyFileMessage(anyOldMessage, gLocalInboxFolder, null, false, 0,</span>
<a href="#l27.32"></a><span id="l27.32" class="difflineplus">+                                    &quot;&quot;, messageHeaderGetterListener, null);</span>
<a href="#l27.33"></a><span id="l27.33">   return true;</span>
<a href="#l27.34"></a><span id="l27.34"> }</span>
<a href="#l27.35"></a><span id="l27.35"> </span>
<a href="#l27.36"></a><span id="l27.36"> var messageHeaderGetterListener = {</span>
<a href="#l27.37"></a><span id="l27.37">   OnStartCopy: function() {},</span>
<a href="#l27.38"></a><span id="l27.38">   OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l27.39"></a><span id="l27.39">   GetMessageId: function (aMessageId) {},</span>
<a href="#l27.40"></a><span id="l27.40">   SetMessageKey: function(aKey) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/db/msgdb/test/unit/test_propertyEnumerator.js</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/db/msgdb/test/unit/test_propertyEnumerator.js</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -1,28 +1,28 @@</span>
<a href="#l28.4"></a><span id="l28.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l28.5"></a><span id="l28.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l28.6"></a><span id="l28.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l28.7"></a><span id="l28.7"> </span>
<a href="#l28.8"></a><span id="l28.8">  // tests propertyEnumerator in nsIMsgDBHdr;</span>
<a href="#l28.9"></a><span id="l28.9"> </span>
<a href="#l28.10"></a><span id="l28.10"> load(&quot;../../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l28.11"></a><span id="l28.11"> </span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-const copyService = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineminus">-                      .getService(Ci.nsIMsgCopyService);</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineplus">+</span>
<a href="#l28.16"></a><span id="l28.16"> var gHdr;</span>
<a href="#l28.17"></a><span id="l28.17"> </span>
<a href="#l28.18"></a><span id="l28.18"> function run_test() {</span>
<a href="#l28.19"></a><span id="l28.19">   loadLocalMailAccount();</span>
<a href="#l28.20"></a><span id="l28.20">   // Get a message into the local filestore.</span>
<a href="#l28.21"></a><span id="l28.21">   // Function continue_test() continues the testing after the copy.</span>
<a href="#l28.22"></a><span id="l28.22">   var bugmail1 = do_get_file(&quot;../../../../data/bugmail1&quot;);</span>
<a href="#l28.23"></a><span id="l28.23">   do_test_pending();</span>
<a href="#l28.24"></a><span id="l28.24" class="difflineminus">-  copyService.CopyFileMessage(bugmail1, gLocalInboxFolder, null, false, 0,</span>
<a href="#l28.25"></a><span id="l28.25" class="difflineminus">-                              &quot;&quot;, copyListener, null);</span>
<a href="#l28.26"></a><span id="l28.26" class="difflineplus">+  MailServices.copy.CopyFileMessage(bugmail1, gLocalInboxFolder, null, false, 0,</span>
<a href="#l28.27"></a><span id="l28.27" class="difflineplus">+                                    &quot;&quot;, copyListener, null);</span>
<a href="#l28.28"></a><span id="l28.28"> }</span>
<a href="#l28.29"></a><span id="l28.29"> </span>
<a href="#l28.30"></a><span id="l28.30"> var copyListener =</span>
<a href="#l28.31"></a><span id="l28.31"> {</span>
<a href="#l28.32"></a><span id="l28.32">   OnStartCopy: function() {},</span>
<a href="#l28.33"></a><span id="l28.33">   OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l28.34"></a><span id="l28.34">   SetMessageKey: function(aKey) { gHdr = gLocalInboxFolder.GetMessageHeader(aKey);},</span>
<a href="#l28.35"></a><span id="l28.35">   SetMessageId: function(aMessageId) {},</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mailnews/db/msgdb/test/unit/test_references_parsing.js</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mailnews/db/msgdb/test/unit/test_references_parsing.js</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -1,14 +1,14 @@</span>
<a href="#l29.4"></a><span id="l29.4"> /*</span>
<a href="#l29.5"></a><span id="l29.5">  * Test nsMsgHdr's In-Reply-To/References parsing logic.</span>
<a href="#l29.6"></a><span id="l29.6">  */</span>
<a href="#l29.7"></a><span id="l29.7"> </span>
<a href="#l29.8"></a><span id="l29.8" class="difflineminus">-const copyService = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l29.9"></a><span id="l29.9" class="difflineminus">-                      .getService(Ci.nsIMsgCopyService);</span>
<a href="#l29.10"></a><span id="l29.10" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l29.11"></a><span id="l29.11" class="difflineplus">+</span>
<a href="#l29.12"></a><span id="l29.12"> const anyOldMessage = do_get_file(&quot;../../../../data/bugmail1&quot;);</span>
<a href="#l29.13"></a><span id="l29.13"> </span>
<a href="#l29.14"></a><span id="l29.14"> var refsAndResults = [</span>
<a href="#l29.15"></a><span id="l29.15">   // an empty string is not a reference.</span>
<a href="#l29.16"></a><span id="l29.16">   [&quot;&quot;, []],</span>
<a href="#l29.17"></a><span id="l29.17">   // super valid things</span>
<a href="#l29.18"></a><span id="l29.18">   [&quot;&lt;abc@def&gt;&quot;, [&quot;abc@def&quot;]],</span>
<a href="#l29.19"></a><span id="l29.19">   [&quot;&lt;up@down&gt; &lt;left@right&gt; &lt;ying@yang&gt;&quot;,</span>
<a href="#l29.20"></a><span id="l29.20" class="difflineat">@@ -82,18 +82,18 @@ function test_references_header_parsing(</span>
<a href="#l29.21"></a><span id="l29.21"> /*</span>
<a href="#l29.22"></a><span id="l29.22">  * This infrastructure down here exists just to get</span>
<a href="#l29.23"></a><span id="l29.23">  *  test_references_header_parsing its message header.</span>
<a href="#l29.24"></a><span id="l29.24">  */</span>
<a href="#l29.25"></a><span id="l29.25"> </span>
<a href="#l29.26"></a><span id="l29.26"> function run_test() {</span>
<a href="#l29.27"></a><span id="l29.27">   loadLocalMailAccount();</span>
<a href="#l29.28"></a><span id="l29.28">   do_test_pending();</span>
<a href="#l29.29"></a><span id="l29.29" class="difflineminus">-  copyService.CopyFileMessage(anyOldMessage, gLocalInboxFolder, null, false, 0,</span>
<a href="#l29.30"></a><span id="l29.30" class="difflineminus">-                              &quot;&quot;, messageHeaderGetterListener, null);</span>
<a href="#l29.31"></a><span id="l29.31" class="difflineplus">+  MailServices.copy.CopyFileMessage(anyOldMessage, gLocalInboxFolder, null, false, 0,</span>
<a href="#l29.32"></a><span id="l29.32" class="difflineplus">+                                    &quot;&quot;, messageHeaderGetterListener, null);</span>
<a href="#l29.33"></a><span id="l29.33">   return true;</span>
<a href="#l29.34"></a><span id="l29.34"> }</span>
<a href="#l29.35"></a><span id="l29.35"> </span>
<a href="#l29.36"></a><span id="l29.36"> var messageHeaderGetterListener = {</span>
<a href="#l29.37"></a><span id="l29.37">   msgKey: null,</span>
<a href="#l29.38"></a><span id="l29.38">   </span>
<a href="#l29.39"></a><span id="l29.39">   OnStartCopy: function() {},</span>
<a href="#l29.40"></a><span id="l29.40">   OnProgress: function(aProgress, aProgressMax) {},</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

