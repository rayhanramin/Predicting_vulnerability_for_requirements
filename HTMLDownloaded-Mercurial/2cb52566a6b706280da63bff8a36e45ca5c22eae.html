<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 20761:2cb52566a6b706280da63bff8a36e45ca5c22eae</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 2cb52566a6b706280da63bff8a36e45ca5c22eae" />
<meta property="og:url" content="/comm-central/rev/2cb52566a6b706280da63bff8a36e45ca5c22eae" />
<meta property="og:description" content="Stop using nsISupportsArray for params that handle nsIArray. r=jorgk,philipp,aleth,IanN a=IanN DONTBUILD" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 2cb52566a6b706280da63bff8a36e45ca5c22eae 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/2cb52566a6b706280da63bff8a36e45ca5c22eae">shortlog</a> |
<a href="/comm-central/log/2cb52566a6b706280da63bff8a36e45ca5c22eae">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/2cb52566a6b706280da63bff8a36e45ca5c22eae">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/2cb52566a6b706280da63bff8a36e45ca5c22eae">files</a> |
changeset |
<a href="/comm-central/raw-rev/2cb52566a6b706280da63bff8a36e45ca5c22eae">raw</a>  | <a href="/comm-central/archive/2cb52566a6b706280da63bff8a36e45ca5c22eae.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Stop using nsISupportsArray for params that handle nsIArray. r=jorgk,philipp,aleth,IanN a=IanN DONTBUILD
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#69;&#114;&#105;&#99;&#32;&#82;&#97;&#104;&#109;&#32;&#60;&#101;&#114;&#97;&#104;&#109;&#64;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 15 Nov 2016 18:16:53 -0800</td></tr>

<tr>
 <td>changeset 20761</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/2cb52566a6b706280da63bff8a36e45ca5c22eae">2cb52566a6b706280da63bff8a36e45ca5c22eae</a></td>
</tr>



<tr>
<td>parent 20760</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/816d8be890433c3b3c8898705578d983aeb882f4">816d8be890433c3b3c8898705578d983aeb882f4</a>
</td>
</tr>

<tr>
<td>child 20762</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/707ecc6cda8411109910ebdd8f2fe551009dbb79">707ecc6cda8411109910ebdd8f2fe551009dbb79</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=2cb52566a6b706280da63bff8a36e45ca5c22eae">12574</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Sat, 26 Nov 2016 14:30:35 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@2cb52566a6b7 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=2cb52566a6b706280da63bff8a36e45ca5c22eae">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=2cb52566a6b706280da63bff8a36e45ca5c22eae&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=2cb52566a6b706280da63bff8a36e45ca5c22eae&newProject=comm-central&newRevision=2cb52566a6b706280da63bff8a36e45ca5c22eae&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=2cb52566a6b706280da63bff8a36e45ca5c22eae&newProject=comm-central&newRevision=2cb52566a6b706280da63bff8a36e45ca5c22eae&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=2cb52566a6b706280da63bff8a36e45ca5c22eae&newProject=comm-central&newRevision=2cb52566a6b706280da63bff8a36e45ca5c22eae&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28jorgk%29&revcount=50">jorgk</a>, <a href="/comm-central/log?rev=reviewer%28philipp%29&revcount=50">philipp</a>, <a href="/comm-central/log?rev=reviewer%28aleth%29&revcount=50">aleth</a>, <a href="/comm-central/log?rev=reviewer%28IanN%29&revcount=50">IanN</a>, <a href="/comm-central/log?rev=reviewer%28IanN%29&revcount=50">IanN</a></td></tr>





</table></div>

<div class="page_body description">Stop using nsISupportsArray for params that handle nsIArray. r=jorgk,philipp,aleth,IanN a=IanN DONTBUILD

This updates calls to interfaces that now take nsIArray to use an nsIArray
instead of an nsISupportsArray. Underneath the hood the concrete
implementation of nsISupportsArray also implements nsIArray so these
&quot;just work,&quot; but nsISupportsArray is deprecated and will be removed so the
calls should be updated.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2cb52566a6b706280da63bff8a36e45ca5c22eae/calendar/base/content/calendar-dnd-listener.js">calendar/base/content/calendar-dnd-listener.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2cb52566a6b706280da63bff8a36e45ca5c22eae/calendar/base/content/calendar-dnd-listener.js">file</a> |
<a href="/comm-central/annotate/2cb52566a6b706280da63bff8a36e45ca5c22eae/calendar/base/content/calendar-dnd-listener.js">annotate</a> |
<a href="/comm-central/diff/2cb52566a6b706280da63bff8a36e45ca5c22eae/calendar/base/content/calendar-dnd-listener.js">diff</a> |
<a href="/comm-central/comparison/2cb52566a6b706280da63bff8a36e45ca5c22eae/calendar/base/content/calendar-dnd-listener.js">comparison</a> |
<a href="/comm-central/log/2cb52566a6b706280da63bff8a36e45ca5c22eae/calendar/base/content/calendar-dnd-listener.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2cb52566a6b706280da63bff8a36e45ca5c22eae/im/content/tabbrowser.xml">im/content/tabbrowser.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2cb52566a6b706280da63bff8a36e45ca5c22eae/im/content/tabbrowser.xml">file</a> |
<a href="/comm-central/annotate/2cb52566a6b706280da63bff8a36e45ca5c22eae/im/content/tabbrowser.xml">annotate</a> |
<a href="/comm-central/diff/2cb52566a6b706280da63bff8a36e45ca5c22eae/im/content/tabbrowser.xml">diff</a> |
<a href="/comm-central/comparison/2cb52566a6b706280da63bff8a36e45ca5c22eae/im/content/tabbrowser.xml">comparison</a> |
<a href="/comm-central/log/2cb52566a6b706280da63bff8a36e45ca5c22eae/im/content/tabbrowser.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2cb52566a6b706280da63bff8a36e45ca5c22eae/mail/base/content/nsDragAndDrop.js">mail/base/content/nsDragAndDrop.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2cb52566a6b706280da63bff8a36e45ca5c22eae/mail/base/content/nsDragAndDrop.js">file</a> |
<a href="/comm-central/annotate/2cb52566a6b706280da63bff8a36e45ca5c22eae/mail/base/content/nsDragAndDrop.js">annotate</a> |
<a href="/comm-central/diff/2cb52566a6b706280da63bff8a36e45ca5c22eae/mail/base/content/nsDragAndDrop.js">diff</a> |
<a href="/comm-central/comparison/2cb52566a6b706280da63bff8a36e45ca5c22eae/mail/base/content/nsDragAndDrop.js">comparison</a> |
<a href="/comm-central/log/2cb52566a6b706280da63bff8a36e45ca5c22eae/mail/base/content/nsDragAndDrop.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2cb52566a6b706280da63bff8a36e45ca5c22eae/suite/common/directory/directory.js">suite/common/directory/directory.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2cb52566a6b706280da63bff8a36e45ca5c22eae/suite/common/directory/directory.js">file</a> |
<a href="/comm-central/annotate/2cb52566a6b706280da63bff8a36e45ca5c22eae/suite/common/directory/directory.js">annotate</a> |
<a href="/comm-central/diff/2cb52566a6b706280da63bff8a36e45ca5c22eae/suite/common/directory/directory.js">diff</a> |
<a href="/comm-central/comparison/2cb52566a6b706280da63bff8a36e45ca5c22eae/suite/common/directory/directory.js">comparison</a> |
<a href="/comm-central/log/2cb52566a6b706280da63bff8a36e45ca5c22eae/suite/common/directory/directory.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2cb52566a6b706280da63bff8a36e45ca5c22eae/suite/mailnews/nsDragAndDrop.js">suite/mailnews/nsDragAndDrop.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2cb52566a6b706280da63bff8a36e45ca5c22eae/suite/mailnews/nsDragAndDrop.js">file</a> |
<a href="/comm-central/annotate/2cb52566a6b706280da63bff8a36e45ca5c22eae/suite/mailnews/nsDragAndDrop.js">annotate</a> |
<a href="/comm-central/diff/2cb52566a6b706280da63bff8a36e45ca5c22eae/suite/mailnews/nsDragAndDrop.js">diff</a> |
<a href="/comm-central/comparison/2cb52566a6b706280da63bff8a36e45ca5c22eae/suite/mailnews/nsDragAndDrop.js">comparison</a> |
<a href="/comm-central/log/2cb52566a6b706280da63bff8a36e45ca5c22eae/suite/mailnews/nsDragAndDrop.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/content/calendar-dnd-listener.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/content/calendar-dnd-listener.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -574,22 +574,22 @@ function invokeEventDragSession(aItem, a</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5">     let supportsString = Components.classes[&quot;@mozilla.org/supports-string;1&quot;]</span>
<a href="#l1.6"></a><span id="l1.6">                          .createInstance(Components.interfaces.nsISupportsString);</span>
<a href="#l1.7"></a><span id="l1.7">     supportsString.data = serializer.serializeToString();</span>
<a href="#l1.8"></a><span id="l1.8">     transfer.setTransferData(&quot;text/calendar&quot;, supportsString, supportsString.data.length * 2);</span>
<a href="#l1.9"></a><span id="l1.9">     transfer.setTransferData(&quot;text/unicode&quot;, supportsString, supportsString.data.length * 2);</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11">     let action = Components.interfaces.nsIDragService.DRAGDROP_ACTION_MOVE;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    let supArray = Components.classes[&quot;@mozilla.org/supports-array;1&quot;]</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-                   .createInstance(Components.interfaces.nsISupportsArray);</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-    supArray.AppendElement(transfer);</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+    let mutArray = Components.classes[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+                   .createInstance(Components.interfaces.nsIMutableArray);</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+    mutArray.appendElement(transfer, /* weak = */ false);</span>
<a href="#l1.18"></a><span id="l1.18">     aXULBox.sourceObject = aItem;</span>
<a href="#l1.19"></a><span id="l1.19">     try {</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">-        cal.getDragService().invokeDragSession(aXULBox, supArray, null, action);</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+        cal.getDragService().invokeDragSession(aXULBox, mutArray, null, action);</span>
<a href="#l1.22"></a><span id="l1.22">     } catch (error) {</span>
<a href="#l1.23"></a><span id="l1.23">         // Nothing done here because we only have to catch an exception that occurs when dragging</span>
<a href="#l1.24"></a><span id="l1.24">         // is cancelled with ESC. This is an odd behaviour of the nativeDragService which we have</span>
<a href="#l1.25"></a><span id="l1.25">         // have to cover.</span>
<a href="#l1.26"></a><span id="l1.26">         // Therefore the DND API for calendar should be changed to the new DOM driven DND-API</span>
<a href="#l1.27"></a><span id="l1.27">         // sometime.</span>
<a href="#l1.28"></a><span id="l1.28">     }</span>
<a href="#l1.29"></a><span id="l1.29"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/im/content/tabbrowser.xml</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/im/content/tabbrowser.xml</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1189,26 +1189,26 @@</span>
<a href="#l2.4"></a><span id="l2.4">            in the current window, in which case this will do nothing. --&gt;</span>
<a href="#l2.5"></a><span id="l2.5">       &lt;method name=&quot;replaceTabsWithWindow&quot;&gt;</span>
<a href="#l2.6"></a><span id="l2.6">         &lt;parameter name=&quot;aTabs&quot;/&gt;</span>
<a href="#l2.7"></a><span id="l2.7">         &lt;body&gt;</span>
<a href="#l2.8"></a><span id="l2.8">           &lt;![CDATA[</span>
<a href="#l2.9"></a><span id="l2.9">             if (this.mTabs.length == 1)</span>
<a href="#l2.10"></a><span id="l2.10">               return null;</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-            var sa = Components.classes[&quot;@mozilla.org/supports-array;1&quot;]</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-                               .createInstance(Components.interfaces.nsISupportsArray);</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-            aTabs.forEach(function(aTab) { sa.AppendElement(aTab); });</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+            var ma = Components.classes[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+                               .createInstance(Components.interfaces.nsIMutableArray);</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+            aTabs.forEach(function(aTab) { ma.appendElement(aTab, /* weak = */ false); });</span>
<a href="#l2.18"></a><span id="l2.18"> </span>
<a href="#l2.19"></a><span id="l2.19">             // tell a new window to take the &quot;dropped&quot; tab</span>
<a href="#l2.20"></a><span id="l2.20">             return Services.ww.openWindow(window,</span>
<a href="#l2.21"></a><span id="l2.21">                                           getConvWindowURL(),</span>
<a href="#l2.22"></a><span id="l2.22">                                           null,</span>
<a href="#l2.23"></a><span id="l2.23">                                           &quot;chrome,dialog=no,all&quot;,</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineminus">-                                          sa);</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+                                          ma);</span>
<a href="#l2.26"></a><span id="l2.26">           ]]&gt;</span>
<a href="#l2.27"></a><span id="l2.27">         &lt;/body&gt;</span>
<a href="#l2.28"></a><span id="l2.28">       &lt;/method&gt;</span>
<a href="#l2.29"></a><span id="l2.29"> </span>
<a href="#l2.30"></a><span id="l2.30">       &lt;method name=&quot;_onDragLeave&quot;&gt;</span>
<a href="#l2.31"></a><span id="l2.31">         &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l2.32"></a><span id="l2.32">         &lt;body&gt;</span>
<a href="#l2.33"></a><span id="l2.33">           &lt;![CDATA[</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/base/content/nsDragAndDrop.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/base/content/nsDragAndDrop.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -3,184 +3,184 @@</span>
<a href="#l3.4"></a><span id="l3.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.5"></a><span id="l3.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.6"></a><span id="l3.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8"> ////////////////////////////////////////////////////////////////////////</span>
<a href="#l3.9"></a><span id="l3.9"> //</span>
<a href="#l3.10"></a><span id="l3.10"> // USE OF THIS API FOR DRAG AND DROP IS DEPRECATED!</span>
<a href="#l3.11"></a><span id="l3.11"> // Do not use this file for new code.</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-// </span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+//</span>
<a href="#l3.14"></a><span id="l3.14"> // Toolkit dropped nsDragAndDrop.js in bug 1162050.</span>
<a href="#l3.15"></a><span id="l3.15"> // Mapped to content/global/nsDragAndDrop.js until we can remove this usage.</span>
<a href="#l3.16"></a><span id="l3.16"> //</span>
<a href="#l3.17"></a><span id="l3.17"> // For documentation about what to use instead, see:</span>
<a href="#l3.18"></a><span id="l3.18"> //   http://developer.mozilla.org/En/DragDrop/Drag_and_Drop</span>
<a href="#l3.19"></a><span id="l3.19"> //</span>
<a href="#l3.20"></a><span id="l3.20"> ////////////////////////////////////////////////////////////////////////</span>
<a href="#l3.21"></a><span id="l3.21"> </span>
<a href="#l3.22"></a><span id="l3.22"> </span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-/** </span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+/**</span>
<a href="#l3.25"></a><span id="l3.25">  *  nsTransferable - a wrapper for nsITransferable that simplifies</span>
<a href="#l3.26"></a><span id="l3.26">  *                   javascript clipboard and drag&amp;drop. for use in</span>
<a href="#l3.27"></a><span id="l3.27">  *                   these situations you should use the nsClipboard</span>
<a href="#l3.28"></a><span id="l3.28">  *                   and nsDragAndDrop wrappers for more convenience</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">- **/ </span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">- </span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+ **/</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+</span>
<a href="#l3.33"></a><span id="l3.33"> var nsTransferable = {</span>
<a href="#l3.34"></a><span id="l3.34">   /**</span>
<a href="#l3.35"></a><span id="l3.35">    * nsITransferable set (TransferData aTransferData) ;</span>
<a href="#l3.36"></a><span id="l3.36">    *</span>
<a href="#l3.37"></a><span id="l3.37">    * Creates a transferable with data for a list of supported types (&quot;flavours&quot;)</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineminus">-   * </span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+   *</span>
<a href="#l3.40"></a><span id="l3.40">    * @param TransferData aTransferData</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineminus">-   *        a javascript object in the format described above </span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-   **/ </span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+   *        a javascript object in the format described above</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+   **/</span>
<a href="#l3.45"></a><span id="l3.45">   set: function (aTransferDataSet)</span>
<a href="#l3.46"></a><span id="l3.46">     {</span>
<a href="#l3.47"></a><span id="l3.47">       var trans = this.createTransferable();</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineminus">-      for (var i = 0; i &lt; aTransferDataSet.dataList.length; ++i) </span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+      for (var i = 0; i &lt; aTransferDataSet.dataList.length; ++i)</span>
<a href="#l3.50"></a><span id="l3.50">         {</span>
<a href="#l3.51"></a><span id="l3.51">           var currData = aTransferDataSet.dataList[i];</span>
<a href="#l3.52"></a><span id="l3.52">           var currFlavour = currData.flavour.contentType;</span>
<a href="#l3.53"></a><span id="l3.53">           trans.addDataFlavor(currFlavour);</span>
<a href="#l3.54"></a><span id="l3.54">           var supports = null; // nsISupports data</span>
<a href="#l3.55"></a><span id="l3.55">           var length = 0;</span>
<a href="#l3.56"></a><span id="l3.56">           if (currData.flavour.dataIIDKey == &quot;nsISupportsString&quot;)</span>
<a href="#l3.57"></a><span id="l3.57">             {</span>
<a href="#l3.58"></a><span id="l3.58">               supports = Components.classes[&quot;@mozilla.org/supports-string;1&quot;]</span>
<a href="#l3.59"></a><span id="l3.59">                                    .createInstance(Components.interfaces.nsISupportsString);</span>
<a href="#l3.60"></a><span id="l3.60"> </span>
<a href="#l3.61"></a><span id="l3.61">               supports.data = currData.supports;</span>
<a href="#l3.62"></a><span id="l3.62">               length = supports.data.length;</span>
<a href="#l3.63"></a><span id="l3.63">             }</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineminus">-          else </span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+          else</span>
<a href="#l3.66"></a><span id="l3.66">             {</span>
<a href="#l3.67"></a><span id="l3.67">               // non-string data.</span>
<a href="#l3.68"></a><span id="l3.68">               supports = currData.supports;</span>
<a href="#l3.69"></a><span id="l3.69">               length = 0; // kFlavorHasDataProvider</span>
<a href="#l3.70"></a><span id="l3.70">             }</span>
<a href="#l3.71"></a><span id="l3.71">           trans.setTransferData(currFlavour, supports, length * 2);</span>
<a href="#l3.72"></a><span id="l3.72">         }</span>
<a href="#l3.73"></a><span id="l3.73">       return trans;</span>
<a href="#l3.74"></a><span id="l3.74">     },</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineminus">-  </span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+</span>
<a href="#l3.77"></a><span id="l3.77">   /**</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineminus">-   * TransferData/TransferDataSet get (FlavourSet aFlavourSet, </span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+   * TransferData/TransferDataSet get (FlavourSet aFlavourSet,</span>
<a href="#l3.80"></a><span id="l3.80">    *                                   Function aRetrievalFunc, Boolean aAnyFlag) ;</span>
<a href="#l3.81"></a><span id="l3.81">    *</span>
<a href="#l3.82"></a><span id="l3.82">    * Retrieves data from the transferable provided in aRetrievalFunc, formatted</span>
<a href="#l3.83"></a><span id="l3.83">    * for more convenient access.</span>
<a href="#l3.84"></a><span id="l3.84">    *</span>
<a href="#l3.85"></a><span id="l3.85">    * @param FlavourSet aFlavourSet</span>
<a href="#l3.86"></a><span id="l3.86">    *        a FlavourSet object that contains a list of supported flavours.</span>
<a href="#l3.87"></a><span id="l3.87">    * @param Function aRetrievalFunc</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineminus">-   *        a reference to a function that returns a nsISupportsArray of nsITransferables</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+   *        a reference to a function that returns a nsIArray of nsITransferables</span>
<a href="#l3.90"></a><span id="l3.90">    *        for each item from the specified source (clipboard/drag&amp;drop etc)</span>
<a href="#l3.91"></a><span id="l3.91">    * @param Boolean aAnyFlag</span>
<a href="#l3.92"></a><span id="l3.92">    *        a flag specifying whether or not a specific flavour is requested. If false,</span>
<a href="#l3.93"></a><span id="l3.93">    *        data of the type of the first flavour in the flavourlist parameter is returned,</span>
<a href="#l3.94"></a><span id="l3.94">    *        otherwise the best flavour supported will be returned.</span>
<a href="#l3.95"></a><span id="l3.95">    **/</span>
<a href="#l3.96"></a><span id="l3.96">   get: function (aFlavourSet, aRetrievalFunc, aAnyFlag)</span>
<a href="#l3.97"></a><span id="l3.97">     {</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineminus">-      if (!aRetrievalFunc) </span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+      if (!aRetrievalFunc)</span>
<a href="#l3.100"></a><span id="l3.100">         throw &quot;No data retrieval handler provided!&quot;;</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineminus">-      </span>
<a href="#l3.102"></a><span id="l3.102" class="difflineminus">-      var supportsArray = aRetrievalFunc(aFlavourSet);</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+      var array = aRetrievalFunc(aFlavourSet);</span>
<a href="#l3.105"></a><span id="l3.105">       var dataArray = [];</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineminus">-      var count = supportsArray.Count();</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineminus">-      </span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+      var count = array.Count();</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineplus">+</span>
<a href="#l3.110"></a><span id="l3.110">       // Iterate over the number of items returned from aRetrievalFunc. For</span>
<a href="#l3.111"></a><span id="l3.111">       // clipboard operations, this is 1, for drag and drop (where multiple</span>
<a href="#l3.112"></a><span id="l3.112">       // items may have been dragged) this could be &gt;1.</span>
<a href="#l3.113"></a><span id="l3.113">       for (var i = 0; i &lt; count; i++)</span>
<a href="#l3.114"></a><span id="l3.114">         {</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineminus">-          var trans = supportsArray.GetElementAt(i);</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+          var trans = array.GetElementAt(i);</span>
<a href="#l3.117"></a><span id="l3.117">           if (!trans) continue;</span>
<a href="#l3.118"></a><span id="l3.118">           trans = trans.QueryInterface(Components.interfaces.nsITransferable);</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineminus">-            </span>
<a href="#l3.120"></a><span id="l3.120" class="difflineplus">+</span>
<a href="#l3.121"></a><span id="l3.121">           var data = { };</span>
<a href="#l3.122"></a><span id="l3.122">           var length = { };</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineminus">-          </span>
<a href="#l3.124"></a><span id="l3.124" class="difflineplus">+</span>
<a href="#l3.125"></a><span id="l3.125">           var currData = null;</span>
<a href="#l3.126"></a><span id="l3.126">           if (aAnyFlag)</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineminus">-            { </span>
<a href="#l3.128"></a><span id="l3.128" class="difflineplus">+            {</span>
<a href="#l3.129"></a><span id="l3.129">               var flavour = { };</span>
<a href="#l3.130"></a><span id="l3.130">               trans.getAnyTransferData(flavour, data, length);</span>
<a href="#l3.131"></a><span id="l3.131">               if (data &amp;&amp; flavour)</span>
<a href="#l3.132"></a><span id="l3.132">                 {</span>
<a href="#l3.133"></a><span id="l3.133">                   var selectedFlavour = aFlavourSet.flavourTable[flavour.value];</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineminus">-                  if (selectedFlavour) </span>
<a href="#l3.135"></a><span id="l3.135" class="difflineplus">+                  if (selectedFlavour)</span>
<a href="#l3.136"></a><span id="l3.136">                     dataArray[i] = FlavourToXfer(data.value, length.value, selectedFlavour);</span>
<a href="#l3.137"></a><span id="l3.137">                 }</span>
<a href="#l3.138"></a><span id="l3.138">             }</span>
<a href="#l3.139"></a><span id="l3.139">           else</span>
<a href="#l3.140"></a><span id="l3.140">             {</span>
<a href="#l3.141"></a><span id="l3.141">               var firstFlavour = aFlavourSet.flavours[0];</span>
<a href="#l3.142"></a><span id="l3.142">               trans.getTransferData(firstFlavour, data, length);</span>
<a href="#l3.143"></a><span id="l3.143">               if (data &amp;&amp; firstFlavour)</span>
<a href="#l3.144"></a><span id="l3.144">                 dataArray[i] = FlavourToXfer(data.value, length.value, firstFlavour);</span>
<a href="#l3.145"></a><span id="l3.145">             }</span>
<a href="#l3.146"></a><span id="l3.146">         }</span>
<a href="#l3.147"></a><span id="l3.147">       return new TransferDataSet(dataArray);</span>
<a href="#l3.148"></a><span id="l3.148">     },</span>
<a href="#l3.149"></a><span id="l3.149"> </span>
<a href="#l3.150"></a><span id="l3.150" class="difflineminus">-  /** </span>
<a href="#l3.151"></a><span id="l3.151" class="difflineplus">+  /**</span>
<a href="#l3.152"></a><span id="l3.152">    * nsITransferable createTransferable (void) ;</span>
<a href="#l3.153"></a><span id="l3.153">    *</span>
<a href="#l3.154"></a><span id="l3.154">    * Creates and returns a transferable object.</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineminus">-   **/    </span>
<a href="#l3.156"></a><span id="l3.156" class="difflineplus">+   **/</span>
<a href="#l3.157"></a><span id="l3.157">   createTransferable: function ()</span>
<a href="#l3.158"></a><span id="l3.158">     {</span>
<a href="#l3.159"></a><span id="l3.159">       const kXferableContractID = &quot;@mozilla.org/widget/transferable;1&quot;;</span>
<a href="#l3.160"></a><span id="l3.160">       const kXferableIID = Components.interfaces.nsITransferable;</span>
<a href="#l3.161"></a><span id="l3.161">       var trans = Components.classes[kXferableContractID].createInstance(kXferableIID);</span>
<a href="#l3.162"></a><span id="l3.162">       trans.init(null);</span>
<a href="#l3.163"></a><span id="l3.163">       return trans;</span>
<a href="#l3.164"></a><span id="l3.164">     }</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineminus">-};  </span>
<a href="#l3.166"></a><span id="l3.166" class="difflineplus">+};</span>
<a href="#l3.167"></a><span id="l3.167"> </span>
<a href="#l3.168"></a><span id="l3.168" class="difflineminus">-/** </span>
<a href="#l3.169"></a><span id="l3.169" class="difflineplus">+/**</span>
<a href="#l3.170"></a><span id="l3.170">  * A FlavourSet is a simple type that represents a collection of Flavour objects.</span>
<a href="#l3.171"></a><span id="l3.171">  * FlavourSet is constructed from an array of Flavours, and stores this list as</span>
<a href="#l3.172"></a><span id="l3.172">  * an array and a hashtable. The rationale for the dual storage is as follows:</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineminus">- * </span>
<a href="#l3.174"></a><span id="l3.174" class="difflineminus">- * Array: Ordering is important when adding data flavours to a transferable. </span>
<a href="#l3.175"></a><span id="l3.175" class="difflineminus">- *        Flavours added first are deemed to be 'preferred' by the client. </span>
<a href="#l3.176"></a><span id="l3.176" class="difflineplus">+ *</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineplus">+ * Array: Ordering is important when adding data flavours to a transferable.</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineplus">+ *        Flavours added first are deemed to be 'preferred' by the client.</span>
<a href="#l3.179"></a><span id="l3.179">  * Hash:  Convenient lookup of flavour data using the content type (MIME type)</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineminus">- *        of data as a key. </span>
<a href="#l3.181"></a><span id="l3.181" class="difflineplus">+ *        of data as a key.</span>
<a href="#l3.182"></a><span id="l3.182">  */</span>
<a href="#l3.183"></a><span id="l3.183"> function FlavourSet(aFlavourList)</span>
<a href="#l3.184"></a><span id="l3.184"> {</span>
<a href="#l3.185"></a><span id="l3.185">   this.flavours = aFlavourList || [];</span>
<a href="#l3.186"></a><span id="l3.186">   this.flavourTable = { };</span>
<a href="#l3.187"></a><span id="l3.187"> </span>
<a href="#l3.188"></a><span id="l3.188">   this._XferID = &quot;FlavourSet&quot;;</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineminus">-  </span>
<a href="#l3.190"></a><span id="l3.190" class="difflineplus">+</span>
<a href="#l3.191"></a><span id="l3.191">   for (var i = 0; i &lt; this.flavours.length; ++i)</span>
<a href="#l3.192"></a><span id="l3.192">     this.flavourTable[this.flavours[i].contentType] = this.flavours[i];</span>
<a href="#l3.193"></a><span id="l3.193"> }</span>
<a href="#l3.194"></a><span id="l3.194"> </span>
<a href="#l3.195"></a><span id="l3.195"> FlavourSet.prototype = {</span>
<a href="#l3.196"></a><span id="l3.196">   appendFlavour: function (aFlavour, aFlavourIIDKey)</span>
<a href="#l3.197"></a><span id="l3.197">   {</span>
<a href="#l3.198"></a><span id="l3.198">     var flavour = new Flavour (aFlavour, aFlavourIIDKey);</span>
<a href="#l3.199"></a><span id="l3.199">     this.flavours.push(flavour);</span>
<a href="#l3.200"></a><span id="l3.200">     this.flavourTable[flavour.contentType] = flavour;</span>
<a href="#l3.201"></a><span id="l3.201">   }</span>
<a href="#l3.202"></a><span id="l3.202"> };</span>
<a href="#l3.203"></a><span id="l3.203"> </span>
<a href="#l3.204"></a><span id="l3.204" class="difflineminus">-/** </span>
<a href="#l3.205"></a><span id="l3.205" class="difflineminus">- * A Flavour is a simple type that represents a data type that can be handled. </span>
<a href="#l3.206"></a><span id="l3.206" class="difflineplus">+/**</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineplus">+ * A Flavour is a simple type that represents a data type that can be handled.</span>
<a href="#l3.208"></a><span id="l3.208">  * It takes a content type (MIME type) which is used when storing data on the</span>
<a href="#l3.209"></a><span id="l3.209">  * system clipboard/drag and drop, and an IIDKey (string interface name</span>
<a href="#l3.210"></a><span id="l3.210">  * which is used to QI data to an appropriate form. The default interface is</span>
<a href="#l3.211"></a><span id="l3.211">  * assumed to be wide-string.</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineminus">- */ </span>
<a href="#l3.213"></a><span id="l3.213" class="difflineplus">+ */</span>
<a href="#l3.214"></a><span id="l3.214"> function Flavour(aContentType, aDataIIDKey)</span>
<a href="#l3.215"></a><span id="l3.215"> {</span>
<a href="#l3.216"></a><span id="l3.216">   this.contentType = aContentType;</span>
<a href="#l3.217"></a><span id="l3.217">   this.dataIIDKey = aDataIIDKey || &quot;nsISupportsString&quot;;</span>
<a href="#l3.218"></a><span id="l3.218"> </span>
<a href="#l3.219"></a><span id="l3.219">   this._XferID = &quot;Flavour&quot;;</span>
<a href="#l3.220"></a><span id="l3.220"> }</span>
<a href="#l3.221"></a><span id="l3.221"> </span>
<a href="#l3.222"></a><span id="l3.222" class="difflineat">@@ -192,86 +192,86 @@ TransferDataBase.prototype = {</span>
<a href="#l3.223"></a><span id="l3.223">   },</span>
<a href="#l3.224"></a><span id="l3.224"> </span>
<a href="#l3.225"></a><span id="l3.225">   get first ()</span>
<a href="#l3.226"></a><span id="l3.226">   {</span>
<a href="#l3.227"></a><span id="l3.227">     return &quot;dataList&quot; in this &amp;&amp; this.dataList.length ? this.dataList[0] : null;</span>
<a href="#l3.228"></a><span id="l3.228">   }</span>
<a href="#l3.229"></a><span id="l3.229"> };</span>
<a href="#l3.230"></a><span id="l3.230"> </span>
<a href="#l3.231"></a><span id="l3.231" class="difflineminus">-/** </span>
<a href="#l3.232"></a><span id="l3.232" class="difflineplus">+/**</span>
<a href="#l3.233"></a><span id="l3.233">  * TransferDataSet is a list (array) of TransferData objects, which represents</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineminus">- * data dragged from one or more elements. </span>
<a href="#l3.235"></a><span id="l3.235" class="difflineplus">+ * data dragged from one or more elements.</span>
<a href="#l3.236"></a><span id="l3.236">  */</span>
<a href="#l3.237"></a><span id="l3.237"> function TransferDataSet(aTransferDataList)</span>
<a href="#l3.238"></a><span id="l3.238"> {</span>
<a href="#l3.239"></a><span id="l3.239">   this.dataList = aTransferDataList || [];</span>
<a href="#l3.240"></a><span id="l3.240"> </span>
<a href="#l3.241"></a><span id="l3.241">   this._XferID = &quot;TransferDataSet&quot;;</span>
<a href="#l3.242"></a><span id="l3.242"> }</span>
<a href="#l3.243"></a><span id="l3.243"> TransferDataSet.prototype = TransferDataBase.prototype;</span>
<a href="#l3.244"></a><span id="l3.244"> </span>
<a href="#l3.245"></a><span id="l3.245" class="difflineminus">-/** </span>
<a href="#l3.246"></a><span id="l3.246" class="difflineplus">+/**</span>
<a href="#l3.247"></a><span id="l3.247">  * TransferData is a list (array) of FlavourData for all the applicable content</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineminus">- * types associated with a drag from a single item. </span>
<a href="#l3.249"></a><span id="l3.249" class="difflineplus">+ * types associated with a drag from a single item.</span>
<a href="#l3.250"></a><span id="l3.250">  */</span>
<a href="#l3.251"></a><span id="l3.251"> function TransferData(aFlavourDataList)</span>
<a href="#l3.252"></a><span id="l3.252"> {</span>
<a href="#l3.253"></a><span id="l3.253">   this.dataList = aFlavourDataList || [];</span>
<a href="#l3.254"></a><span id="l3.254"> </span>
<a href="#l3.255"></a><span id="l3.255">   this._XferID = &quot;TransferData&quot;;</span>
<a href="#l3.256"></a><span id="l3.256"> }</span>
<a href="#l3.257"></a><span id="l3.257"> TransferData.prototype = {</span>
<a href="#l3.258"></a><span id="l3.258">   __proto__: TransferDataBase.prototype,</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineminus">-  </span>
<a href="#l3.260"></a><span id="l3.260" class="difflineplus">+</span>
<a href="#l3.261"></a><span id="l3.261">   addDataForFlavour: function (aFlavourString, aData, aLength, aDataIIDKey)</span>
<a href="#l3.262"></a><span id="l3.262">   {</span>
<a href="#l3.263"></a><span id="l3.263" class="difflineminus">-    this.dataList.push(new FlavourData(aData, aLength, </span>
<a href="#l3.264"></a><span id="l3.264" class="difflineplus">+    this.dataList.push(new FlavourData(aData, aLength,</span>
<a href="#l3.265"></a><span id="l3.265">                        new Flavour(aFlavourString, aDataIIDKey)));</span>
<a href="#l3.266"></a><span id="l3.266">   }</span>
<a href="#l3.267"></a><span id="l3.267"> };</span>
<a href="#l3.268"></a><span id="l3.268"> </span>
<a href="#l3.269"></a><span id="l3.269" class="difflineminus">-/** </span>
<a href="#l3.270"></a><span id="l3.270" class="difflineminus">- * FlavourData is a type that represents data retrieved from the system </span>
<a href="#l3.271"></a><span id="l3.271" class="difflineplus">+/**</span>
<a href="#l3.272"></a><span id="l3.272" class="difflineplus">+ * FlavourData is a type that represents data retrieved from the system</span>
<a href="#l3.273"></a><span id="l3.273">  * clipboard or drag and drop. It is constructed internally by the Transferable</span>
<a href="#l3.274"></a><span id="l3.274">  * using the raw (nsISupports) data from the clipboard, the length of the data,</span>
<a href="#l3.275"></a><span id="l3.275">  * and an object of type Flavour representing the type. Clients implementing</span>
<a href="#l3.276"></a><span id="l3.276">  * IDragDropObserver receive an object of this type in their implementation of</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineminus">- * onDrop. They access the 'data' property to retrieve data, which is either data </span>
<a href="#l3.278"></a><span id="l3.278" class="difflineminus">- * QI'ed to a usable form, or unicode string. </span>
<a href="#l3.279"></a><span id="l3.279" class="difflineplus">+ * onDrop. They access the 'data' property to retrieve data, which is either data</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineplus">+ * QI'ed to a usable form, or unicode string.</span>
<a href="#l3.281"></a><span id="l3.281">  */</span>
<a href="#l3.282"></a><span id="l3.282" class="difflineminus">-function FlavourData(aData, aLength, aFlavour) </span>
<a href="#l3.283"></a><span id="l3.283" class="difflineplus">+function FlavourData(aData, aLength, aFlavour)</span>
<a href="#l3.284"></a><span id="l3.284"> {</span>
<a href="#l3.285"></a><span id="l3.285">   this.supports = aData;</span>
<a href="#l3.286"></a><span id="l3.286">   this.contentLength = aLength;</span>
<a href="#l3.287"></a><span id="l3.287">   this.flavour = aFlavour || null;</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineminus">-  </span>
<a href="#l3.289"></a><span id="l3.289" class="difflineplus">+</span>
<a href="#l3.290"></a><span id="l3.290">   this._XferID = &quot;FlavourData&quot;;</span>
<a href="#l3.291"></a><span id="l3.291"> }</span>
<a href="#l3.292"></a><span id="l3.292"> </span>
<a href="#l3.293"></a><span id="l3.293"> FlavourData.prototype = {</span>
<a href="#l3.294"></a><span id="l3.294">   get data ()</span>
<a href="#l3.295"></a><span id="l3.295">   {</span>
<a href="#l3.296"></a><span id="l3.296">     if (this.flavour &amp;&amp;</span>
<a href="#l3.297"></a><span id="l3.297">         this.flavour.dataIIDKey != &quot;nsISupportsString&quot;)</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineminus">-      return this.supports.QueryInterface(Components.interfaces[this.flavour.dataIIDKey]); </span>
<a href="#l3.299"></a><span id="l3.299" class="difflineplus">+      return this.supports.QueryInterface(Components.interfaces[this.flavour.dataIIDKey]);</span>
<a href="#l3.300"></a><span id="l3.300"> </span>
<a href="#l3.301"></a><span id="l3.301">     var supports = this.supports;</span>
<a href="#l3.302"></a><span id="l3.302">     if (supports instanceof Components.interfaces.nsISupportsString)</span>
<a href="#l3.303"></a><span id="l3.303">       return supports.data.substring(0, this.contentLength/2);</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineminus">-     </span>
<a href="#l3.305"></a><span id="l3.305" class="difflineplus">+</span>
<a href="#l3.306"></a><span id="l3.306">     return supports;</span>
<a href="#l3.307"></a><span id="l3.307">   }</span>
<a href="#l3.308"></a><span id="l3.308"> }</span>
<a href="#l3.309"></a><span id="l3.309"> </span>
<a href="#l3.310"></a><span id="l3.310" class="difflineminus">-/** </span>
<a href="#l3.311"></a><span id="l3.311" class="difflineminus">- * Create a TransferData object with a single FlavourData entry. Used when </span>
<a href="#l3.312"></a><span id="l3.312" class="difflineminus">- * unwrapping data of a specific flavour from the drag service. </span>
<a href="#l3.313"></a><span id="l3.313" class="difflineplus">+/**</span>
<a href="#l3.314"></a><span id="l3.314" class="difflineplus">+ * Create a TransferData object with a single FlavourData entry. Used when</span>
<a href="#l3.315"></a><span id="l3.315" class="difflineplus">+ * unwrapping data of a specific flavour from the drag service.</span>
<a href="#l3.316"></a><span id="l3.316">  */</span>
<a href="#l3.317"></a><span id="l3.317" class="difflineminus">-function FlavourToXfer(aData, aLength, aFlavour) </span>
<a href="#l3.318"></a><span id="l3.318" class="difflineplus">+function FlavourToXfer(aData, aLength, aFlavour)</span>
<a href="#l3.319"></a><span id="l3.319"> {</span>
<a href="#l3.320"></a><span id="l3.320">   return new TransferData([new FlavourData(aData, aLength, aFlavour)]);</span>
<a href="#l3.321"></a><span id="l3.321"> }</span>
<a href="#l3.322"></a><span id="l3.322"> </span>
<a href="#l3.323"></a><span id="l3.323"> var transferUtils = {</span>
<a href="#l3.324"></a><span id="l3.324"> </span>
<a href="#l3.325"></a><span id="l3.325">   retrieveURLFromData: function (aData, flavour)</span>
<a href="#l3.326"></a><span id="l3.326">   {</span>
<a href="#l3.327"></a><span id="l3.327" class="difflineat">@@ -284,52 +284,52 @@ var transferUtils = {</span>
<a href="#l3.328"></a><span id="l3.328">         return ((aData instanceof Components.interfaces.nsISupportsString) ? aData.toString() : aData).split(&quot;\n&quot;)[0];</span>
<a href="#l3.329"></a><span id="l3.329">       case &quot;application/x-moz-file&quot;:</span>
<a href="#l3.330"></a><span id="l3.330">         var ioService = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l3.331"></a><span id="l3.331">                                   .getService(Components.interfaces.nsIIOService);</span>
<a href="#l3.332"></a><span id="l3.332">         var fileHandler = ioService.getProtocolHandler(&quot;file&quot;)</span>
<a href="#l3.333"></a><span id="l3.333">                                    .QueryInterface(Components.interfaces.nsIFileProtocolHandler);</span>
<a href="#l3.334"></a><span id="l3.334">         return fileHandler.getURLSpecFromFile(aData);</span>
<a href="#l3.335"></a><span id="l3.335">     }</span>
<a href="#l3.336"></a><span id="l3.336" class="difflineminus">-    return null;                                                   </span>
<a href="#l3.337"></a><span id="l3.337" class="difflineplus">+    return null;</span>
<a href="#l3.338"></a><span id="l3.338">   }</span>
<a href="#l3.339"></a><span id="l3.339"> </span>
<a href="#l3.340"></a><span id="l3.340"> }</span>
<a href="#l3.341"></a><span id="l3.341"> </span>
<a href="#l3.342"></a><span id="l3.342"> /**</span>
<a href="#l3.343"></a><span id="l3.343">  * nsDragAndDrop - a convenience wrapper for nsTransferable, nsITransferable</span>
<a href="#l3.344"></a><span id="l3.344" class="difflineminus">- *                 and nsIDragService/nsIDragSession. </span>
<a href="#l3.345"></a><span id="l3.345" class="difflineplus">+ *                 and nsIDragService/nsIDragSession.</span>
<a href="#l3.346"></a><span id="l3.346">  *</span>
<a href="#l3.347"></a><span id="l3.347">  * Use: map the handler functions to the 'ondraggesture', 'ondragover' and</span>
<a href="#l3.348"></a><span id="l3.348" class="difflineminus">- *   'ondragdrop' event handlers on your XML element, e.g.                   </span>
<a href="#l3.349"></a><span id="l3.349" class="difflineminus">- *   &lt;xmlelement ondraggesture=&quot;nsDragAndDrop.startDrag(event, observer);&quot;   </span>
<a href="#l3.350"></a><span id="l3.350" class="difflineminus">- *               ondragover=&quot;nsDragAndDrop.dragOver(event, observer);&quot;      </span>
<a href="#l3.351"></a><span id="l3.351" class="difflineminus">- *               ondragdrop=&quot;nsDragAndDrop.drop(event, observer);&quot;/&gt;         </span>
<a href="#l3.352"></a><span id="l3.352" class="difflineminus">- *                                                                           </span>
<a href="#l3.353"></a><span id="l3.353" class="difflineminus">- *   You need to create an observer js object with the following member      </span>
<a href="#l3.354"></a><span id="l3.354" class="difflineminus">- *   functions:                                                              </span>
<a href="#l3.355"></a><span id="l3.355" class="difflineminus">- *     Object onDragStart (event)        // called when drag initiated,      </span>
<a href="#l3.356"></a><span id="l3.356" class="difflineminus">- *                                       // returns flavour list with data   </span>
<a href="#l3.357"></a><span id="l3.357" class="difflineminus">- *                                       // to stuff into transferable      </span>
<a href="#l3.358"></a><span id="l3.358" class="difflineminus">- *     void onDragOver (Object flavour)  // called when element is dragged   </span>
<a href="#l3.359"></a><span id="l3.359" class="difflineminus">- *                                       // over, so that it can perform     </span>
<a href="#l3.360"></a><span id="l3.360" class="difflineplus">+ *   'ondragdrop' event handlers on your XML element, e.g.</span>
<a href="#l3.361"></a><span id="l3.361" class="difflineplus">+ *   &lt;xmlelement ondraggesture=&quot;nsDragAndDrop.startDrag(event, observer);&quot;</span>
<a href="#l3.362"></a><span id="l3.362" class="difflineplus">+ *               ondragover=&quot;nsDragAndDrop.dragOver(event, observer);&quot;</span>
<a href="#l3.363"></a><span id="l3.363" class="difflineplus">+ *               ondragdrop=&quot;nsDragAndDrop.drop(event, observer);&quot;/&gt;</span>
<a href="#l3.364"></a><span id="l3.364" class="difflineplus">+ *</span>
<a href="#l3.365"></a><span id="l3.365" class="difflineplus">+ *   You need to create an observer js object with the following member</span>
<a href="#l3.366"></a><span id="l3.366" class="difflineplus">+ *   functions:</span>
<a href="#l3.367"></a><span id="l3.367" class="difflineplus">+ *     Object onDragStart (event)        // called when drag initiated,</span>
<a href="#l3.368"></a><span id="l3.368" class="difflineplus">+ *                                       // returns flavour list with data</span>
<a href="#l3.369"></a><span id="l3.369" class="difflineplus">+ *                                       // to stuff into transferable</span>
<a href="#l3.370"></a><span id="l3.370" class="difflineplus">+ *     void onDragOver (Object flavour)  // called when element is dragged</span>
<a href="#l3.371"></a><span id="l3.371" class="difflineplus">+ *                                       // over, so that it can perform</span>
<a href="#l3.372"></a><span id="l3.372">  *                                       // any drag-over feedback for provided</span>
<a href="#l3.373"></a><span id="l3.373" class="difflineminus">- *                                       // flavour                          </span>
<a href="#l3.374"></a><span id="l3.374" class="difflineminus">- *     void onDrop (Object data)         // formatted data object dropped.   </span>
<a href="#l3.375"></a><span id="l3.375" class="difflineminus">- *     Object getSupportedFlavours ()    // returns a flavour list so that   </span>
<a href="#l3.376"></a><span id="l3.376" class="difflineplus">+ *                                       // flavour</span>
<a href="#l3.377"></a><span id="l3.377" class="difflineplus">+ *     void onDrop (Object data)         // formatted data object dropped.</span>
<a href="#l3.378"></a><span id="l3.378" class="difflineplus">+ *     Object getSupportedFlavours ()    // returns a flavour list so that</span>
<a href="#l3.379"></a><span id="l3.379">  *                                       // nsTransferable can determine</span>
<a href="#l3.380"></a><span id="l3.380" class="difflineminus">- *                                       // whether or not to accept drop. </span>
<a href="#l3.381"></a><span id="l3.381" class="difflineminus">- **/   </span>
<a href="#l3.382"></a><span id="l3.382" class="difflineplus">+ *                                       // whether or not to accept drop.</span>
<a href="#l3.383"></a><span id="l3.383" class="difflineplus">+ **/</span>
<a href="#l3.384"></a><span id="l3.384"> </span>
<a href="#l3.385"></a><span id="l3.385"> var nsDragAndDrop = {</span>
<a href="#l3.386"></a><span id="l3.386" class="difflineminus">-  </span>
<a href="#l3.387"></a><span id="l3.387" class="difflineplus">+</span>
<a href="#l3.388"></a><span id="l3.388">   _mDS: null,</span>
<a href="#l3.389"></a><span id="l3.389">   get mDragService()</span>
<a href="#l3.390"></a><span id="l3.390">     {</span>
<a href="#l3.391"></a><span id="l3.391" class="difflineminus">-      if (!this._mDS) </span>
<a href="#l3.392"></a><span id="l3.392" class="difflineplus">+      if (!this._mDS)</span>
<a href="#l3.393"></a><span id="l3.393">         {</span>
<a href="#l3.394"></a><span id="l3.394">           const kDSContractID = &quot;@mozilla.org/widget/dragservice;1&quot;;</span>
<a href="#l3.395"></a><span id="l3.395">           const kDSIID = Components.interfaces.nsIDragService;</span>
<a href="#l3.396"></a><span id="l3.396">           this._mDS = Components.classes[kDSContractID].getService(kDSIID);</span>
<a href="#l3.397"></a><span id="l3.397">         }</span>
<a href="#l3.398"></a><span id="l3.398">       return this._mDS;</span>
<a href="#l3.399"></a><span id="l3.399">     },</span>
<a href="#l3.400"></a><span id="l3.400"> </span>
<a href="#l3.401"></a><span id="l3.401" class="difflineat">@@ -338,118 +338,118 @@ var nsDragAndDrop = {</span>
<a href="#l3.402"></a><span id="l3.402">    *</span>
<a href="#l3.403"></a><span id="l3.403">    * called when a drag on an element is started.</span>
<a href="#l3.404"></a><span id="l3.404">    *</span>
<a href="#l3.405"></a><span id="l3.405">    * @param DOMEvent aEvent</span>
<a href="#l3.406"></a><span id="l3.406">    *        the DOM event fired by the drag init</span>
<a href="#l3.407"></a><span id="l3.407">    * @param Object aDragDropObserver</span>
<a href="#l3.408"></a><span id="l3.408">    *        javascript object of format described above that specifies</span>
<a href="#l3.409"></a><span id="l3.409">    *        the way in which the element responds to drag events.</span>
<a href="#l3.410"></a><span id="l3.410" class="difflineminus">-   **/  </span>
<a href="#l3.411"></a><span id="l3.411" class="difflineplus">+   **/</span>
<a href="#l3.412"></a><span id="l3.412">   startDrag: function (aEvent, aDragDropObserver)</span>
<a href="#l3.413"></a><span id="l3.413">     {</span>
<a href="#l3.414"></a><span id="l3.414">       if (!(&quot;onDragStart&quot; in aDragDropObserver))</span>
<a href="#l3.415"></a><span id="l3.415">         return;</span>
<a href="#l3.416"></a><span id="l3.416"> </span>
<a href="#l3.417"></a><span id="l3.417">       const kDSIID = Components.interfaces.nsIDragService;</span>
<a href="#l3.418"></a><span id="l3.418">       var dragAction = { action: kDSIID.DRAGDROP_ACTION_COPY + kDSIID.DRAGDROP_ACTION_MOVE + kDSIID.DRAGDROP_ACTION_LINK };</span>
<a href="#l3.419"></a><span id="l3.419"> </span>
<a href="#l3.420"></a><span id="l3.420">       var transferData = { data: null };</span>
<a href="#l3.421"></a><span id="l3.421" class="difflineminus">-      try </span>
<a href="#l3.422"></a><span id="l3.422" class="difflineplus">+      try</span>
<a href="#l3.423"></a><span id="l3.423">         {</span>
<a href="#l3.424"></a><span id="l3.424">           aDragDropObserver.onDragStart(aEvent, transferData, dragAction);</span>
<a href="#l3.425"></a><span id="l3.425">         }</span>
<a href="#l3.426"></a><span id="l3.426" class="difflineminus">-      catch (e) </span>
<a href="#l3.427"></a><span id="l3.427" class="difflineplus">+      catch (e)</span>
<a href="#l3.428"></a><span id="l3.428">         {</span>
<a href="#l3.429"></a><span id="l3.429">           return;  // not a draggable item, bail!</span>
<a href="#l3.430"></a><span id="l3.430">         }</span>
<a href="#l3.431"></a><span id="l3.431"> </span>
<a href="#l3.432"></a><span id="l3.432">       if (!transferData.data) return;</span>
<a href="#l3.433"></a><span id="l3.433">       transferData = transferData.data;</span>
<a href="#l3.434"></a><span id="l3.434"> </span>
<a href="#l3.435"></a><span id="l3.435">       var dt = aEvent.dataTransfer;</span>
<a href="#l3.436"></a><span id="l3.436">       var count = 0;</span>
<a href="#l3.437"></a><span id="l3.437">       do {</span>
<a href="#l3.438"></a><span id="l3.438" class="difflineminus">-        var tds = transferData._XferID == &quot;TransferData&quot; </span>
<a href="#l3.439"></a><span id="l3.439" class="difflineminus">-                                         ? transferData </span>
<a href="#l3.440"></a><span id="l3.440" class="difflineplus">+        var tds = transferData._XferID == &quot;TransferData&quot;</span>
<a href="#l3.441"></a><span id="l3.441" class="difflineplus">+                                         ? transferData</span>
<a href="#l3.442"></a><span id="l3.442">                                          : transferData.dataList[count]</span>
<a href="#l3.443"></a><span id="l3.443" class="difflineminus">-        for (var i = 0; i &lt; tds.dataList.length; ++i) </span>
<a href="#l3.444"></a><span id="l3.444" class="difflineplus">+        for (var i = 0; i &lt; tds.dataList.length; ++i)</span>
<a href="#l3.445"></a><span id="l3.445">         {</span>
<a href="#l3.446"></a><span id="l3.446">           var currData = tds.dataList[i];</span>
<a href="#l3.447"></a><span id="l3.447">           var currFlavour = currData.flavour.contentType;</span>
<a href="#l3.448"></a><span id="l3.448">           var value = currData.supports;</span>
<a href="#l3.449"></a><span id="l3.449">           if (value instanceof Components.interfaces.nsISupportsString)</span>
<a href="#l3.450"></a><span id="l3.450">             value = value.toString();</span>
<a href="#l3.451"></a><span id="l3.451">           dt.mozSetDataAt(currFlavour, value, count);</span>
<a href="#l3.452"></a><span id="l3.452">         }</span>
<a href="#l3.453"></a><span id="l3.453"> </span>
<a href="#l3.454"></a><span id="l3.454">         count++;</span>
<a href="#l3.455"></a><span id="l3.455">       }</span>
<a href="#l3.456"></a><span id="l3.456" class="difflineminus">-      while (transferData._XferID == &quot;TransferDataSet&quot; &amp;&amp; </span>
<a href="#l3.457"></a><span id="l3.457" class="difflineplus">+      while (transferData._XferID == &quot;TransferDataSet&quot; &amp;&amp;</span>
<a href="#l3.458"></a><span id="l3.458">              count &lt; transferData.dataList.length);</span>
<a href="#l3.459"></a><span id="l3.459"> </span>
<a href="#l3.460"></a><span id="l3.460">       dt.effectAllowed = &quot;all&quot;;</span>
<a href="#l3.461"></a><span id="l3.461">       // a drag targeted at a tree should instead use the treechildren so that</span>
<a href="#l3.462"></a><span id="l3.462">       // the current selection is used as the drag feedback</span>
<a href="#l3.463"></a><span id="l3.463">       dt.addElement(aEvent.originalTarget.localName == &quot;treechildren&quot; ?</span>
<a href="#l3.464"></a><span id="l3.464">                     aEvent.originalTarget : aEvent.target);</span>
<a href="#l3.465"></a><span id="l3.465">       aEvent.stopPropagation();</span>
<a href="#l3.466"></a><span id="l3.466">     },</span>
<a href="#l3.467"></a><span id="l3.467"> </span>
<a href="#l3.468"></a><span id="l3.468" class="difflineminus">-  /** </span>
<a href="#l3.469"></a><span id="l3.469" class="difflineplus">+  /**</span>
<a href="#l3.470"></a><span id="l3.470">    * void dragOver (DOMEvent aEvent, Object aDragDropObserver) ;</span>
<a href="#l3.471"></a><span id="l3.471">    *</span>
<a href="#l3.472"></a><span id="l3.472">    * called when a drag passes over this element</span>
<a href="#l3.473"></a><span id="l3.473">    *</span>
<a href="#l3.474"></a><span id="l3.474">    * @param DOMEvent aEvent</span>
<a href="#l3.475"></a><span id="l3.475">    *        the DOM event fired by passing over the element</span>
<a href="#l3.476"></a><span id="l3.476">    * @param Object aDragDropObserver</span>
<a href="#l3.477"></a><span id="l3.477">    *        javascript object of format described above that specifies</span>
<a href="#l3.478"></a><span id="l3.478">    *        the way in which the element responds to drag events.</span>
<a href="#l3.479"></a><span id="l3.479">    **/</span>
<a href="#l3.480"></a><span id="l3.480">   dragOver: function (aEvent, aDragDropObserver)</span>
<a href="#l3.481"></a><span id="l3.481" class="difflineminus">-    { </span>
<a href="#l3.482"></a><span id="l3.482" class="difflineminus">-      if (!(&quot;onDragOver&quot; in aDragDropObserver)) </span>
<a href="#l3.483"></a><span id="l3.483" class="difflineplus">+    {</span>
<a href="#l3.484"></a><span id="l3.484" class="difflineplus">+      if (!(&quot;onDragOver&quot; in aDragDropObserver))</span>
<a href="#l3.485"></a><span id="l3.485">         return;</span>
<a href="#l3.486"></a><span id="l3.486">       if (!this.checkCanDrop(aEvent, aDragDropObserver))</span>
<a href="#l3.487"></a><span id="l3.487">         return;</span>
<a href="#l3.488"></a><span id="l3.488">       var flavourSet = aDragDropObserver.getSupportedFlavours();</span>
<a href="#l3.489"></a><span id="l3.489">       for (var flavour in flavourSet.flavourTable)</span>
<a href="#l3.490"></a><span id="l3.490">         {</span>
<a href="#l3.491"></a><span id="l3.491">           if (this.mDragSession.isDataFlavorSupported(flavour))</span>
<a href="#l3.492"></a><span id="l3.492">             {</span>
<a href="#l3.493"></a><span id="l3.493" class="difflineminus">-              aDragDropObserver.onDragOver(aEvent, </span>
<a href="#l3.494"></a><span id="l3.494" class="difflineminus">-                                           flavourSet.flavourTable[flavour], </span>
<a href="#l3.495"></a><span id="l3.495" class="difflineplus">+              aDragDropObserver.onDragOver(aEvent,</span>
<a href="#l3.496"></a><span id="l3.496" class="difflineplus">+                                           flavourSet.flavourTable[flavour],</span>
<a href="#l3.497"></a><span id="l3.497">                                            this.mDragSession);</span>
<a href="#l3.498"></a><span id="l3.498">               aEvent.stopPropagation();</span>
<a href="#l3.499"></a><span id="l3.499">               aEvent.preventDefault();</span>
<a href="#l3.500"></a><span id="l3.500">               break;</span>
<a href="#l3.501"></a><span id="l3.501">             }</span>
<a href="#l3.502"></a><span id="l3.502">         }</span>
<a href="#l3.503"></a><span id="l3.503">     },</span>
<a href="#l3.504"></a><span id="l3.504"> </span>
<a href="#l3.505"></a><span id="l3.505">   mDragSession: null,</span>
<a href="#l3.506"></a><span id="l3.506"> </span>
<a href="#l3.507"></a><span id="l3.507" class="difflineminus">-  /** </span>
<a href="#l3.508"></a><span id="l3.508" class="difflineplus">+  /**</span>
<a href="#l3.509"></a><span id="l3.509">    * void drop (DOMEvent aEvent, Object aDragDropObserver) ;</span>
<a href="#l3.510"></a><span id="l3.510">    *</span>
<a href="#l3.511"></a><span id="l3.511">    * called when the user drops on the element</span>
<a href="#l3.512"></a><span id="l3.512">    *</span>
<a href="#l3.513"></a><span id="l3.513">    * @param DOMEvent aEvent</span>
<a href="#l3.514"></a><span id="l3.514">    *        the DOM event fired by the drop</span>
<a href="#l3.515"></a><span id="l3.515">    * @param Object aDragDropObserver</span>
<a href="#l3.516"></a><span id="l3.516">    *        javascript object of format described above that specifies</span>
<a href="#l3.517"></a><span id="l3.517">    *        the way in which the element responds to drag events.</span>
<a href="#l3.518"></a><span id="l3.518">    **/</span>
<a href="#l3.519"></a><span id="l3.519">   drop: function (aEvent, aDragDropObserver)</span>
<a href="#l3.520"></a><span id="l3.520">     {</span>
<a href="#l3.521"></a><span id="l3.521">       if (!(&quot;onDrop&quot; in aDragDropObserver))</span>
<a href="#l3.522"></a><span id="l3.522">         return;</span>
<a href="#l3.523"></a><span id="l3.523">       if (!this.checkCanDrop(aEvent, aDragDropObserver))</span>
<a href="#l3.524"></a><span id="l3.524" class="difflineminus">-        return;  </span>
<a href="#l3.525"></a><span id="l3.525" class="difflineplus">+        return;</span>
<a href="#l3.526"></a><span id="l3.526"> </span>
<a href="#l3.527"></a><span id="l3.527">       var flavourSet = aDragDropObserver.getSupportedFlavours();</span>
<a href="#l3.528"></a><span id="l3.528"> </span>
<a href="#l3.529"></a><span id="l3.529">       var dt = aEvent.dataTransfer;</span>
<a href="#l3.530"></a><span id="l3.530">       var dataArray = [];</span>
<a href="#l3.531"></a><span id="l3.531">       var count = dt.mozItemCount;</span>
<a href="#l3.532"></a><span id="l3.532">       for (var i = 0; i &lt; count; ++i) {</span>
<a href="#l3.533"></a><span id="l3.533">         var types = dt.mozTypesAt(i);</span>
<a href="#l3.534"></a><span id="l3.534" class="difflineat">@@ -476,71 +476,71 @@ var nsDragAndDrop = {</span>
<a href="#l3.535"></a><span id="l3.535"> </span>
<a href="#l3.536"></a><span id="l3.536">       // hand over to the client to respond to dropped data</span>
<a href="#l3.537"></a><span id="l3.537">       var multiple = &quot;canHandleMultipleItems&quot; in aDragDropObserver &amp;&amp; aDragDropObserver.canHandleMultipleItems;</span>
<a href="#l3.538"></a><span id="l3.538">       var dropData = multiple ? transferData : transferData.first.first;</span>
<a href="#l3.539"></a><span id="l3.539">       aDragDropObserver.onDrop(aEvent, dropData, this.mDragSession);</span>
<a href="#l3.540"></a><span id="l3.540">       aEvent.stopPropagation();</span>
<a href="#l3.541"></a><span id="l3.541">     },</span>
<a href="#l3.542"></a><span id="l3.542"> </span>
<a href="#l3.543"></a><span id="l3.543" class="difflineminus">-  /** </span>
<a href="#l3.544"></a><span id="l3.544" class="difflineplus">+  /**</span>
<a href="#l3.545"></a><span id="l3.545">    * void dragExit (DOMEvent aEvent, Object aDragDropObserver) ;</span>
<a href="#l3.546"></a><span id="l3.546">    *</span>
<a href="#l3.547"></a><span id="l3.547">    * called when a drag leaves this element</span>
<a href="#l3.548"></a><span id="l3.548">    *</span>
<a href="#l3.549"></a><span id="l3.549">    * @param DOMEvent aEvent</span>
<a href="#l3.550"></a><span id="l3.550">    *        the DOM event fired by leaving the element</span>
<a href="#l3.551"></a><span id="l3.551">    * @param Object aDragDropObserver</span>
<a href="#l3.552"></a><span id="l3.552">    *        javascript object of format described above that specifies</span>
<a href="#l3.553"></a><span id="l3.553">    *        the way in which the element responds to drag events.</span>
<a href="#l3.554"></a><span id="l3.554">    **/</span>
<a href="#l3.555"></a><span id="l3.555">   dragExit: function (aEvent, aDragDropObserver)</span>
<a href="#l3.556"></a><span id="l3.556">     {</span>
<a href="#l3.557"></a><span id="l3.557">       if (!this.checkCanDrop(aEvent, aDragDropObserver))</span>
<a href="#l3.558"></a><span id="l3.558">         return;</span>
<a href="#l3.559"></a><span id="l3.559">       if (&quot;onDragExit&quot; in aDragDropObserver)</span>
<a href="#l3.560"></a><span id="l3.560">         aDragDropObserver.onDragExit(aEvent, this.mDragSession);</span>
<a href="#l3.561"></a><span id="l3.561" class="difflineminus">-    },  </span>
<a href="#l3.562"></a><span id="l3.562" class="difflineminus">-    </span>
<a href="#l3.563"></a><span id="l3.563" class="difflineminus">-  /** </span>
<a href="#l3.564"></a><span id="l3.564" class="difflineplus">+    },</span>
<a href="#l3.565"></a><span id="l3.565" class="difflineplus">+</span>
<a href="#l3.566"></a><span id="l3.566" class="difflineplus">+  /**</span>
<a href="#l3.567"></a><span id="l3.567">    * void dragEnter (DOMEvent aEvent, Object aDragDropObserver) ;</span>
<a href="#l3.568"></a><span id="l3.568">    *</span>
<a href="#l3.569"></a><span id="l3.569">    * called when a drag enters in this element</span>
<a href="#l3.570"></a><span id="l3.570">    *</span>
<a href="#l3.571"></a><span id="l3.571">    * @param DOMEvent aEvent</span>
<a href="#l3.572"></a><span id="l3.572">    *        the DOM event fired by entering in the element</span>
<a href="#l3.573"></a><span id="l3.573">    * @param Object aDragDropObserver</span>
<a href="#l3.574"></a><span id="l3.574">    *        javascript object of format described above that specifies</span>
<a href="#l3.575"></a><span id="l3.575">    *        the way in which the element responds to drag events.</span>
<a href="#l3.576"></a><span id="l3.576">    **/</span>
<a href="#l3.577"></a><span id="l3.577">   dragEnter: function (aEvent, aDragDropObserver)</span>
<a href="#l3.578"></a><span id="l3.578">     {</span>
<a href="#l3.579"></a><span id="l3.579">       if (!this.checkCanDrop(aEvent, aDragDropObserver))</span>
<a href="#l3.580"></a><span id="l3.580">         return;</span>
<a href="#l3.581"></a><span id="l3.581">       if (&quot;onDragEnter&quot; in aDragDropObserver)</span>
<a href="#l3.582"></a><span id="l3.582">         aDragDropObserver.onDragEnter(aEvent, this.mDragSession);</span>
<a href="#l3.583"></a><span id="l3.583" class="difflineminus">-    },  </span>
<a href="#l3.584"></a><span id="l3.584" class="difflineplus">+    },</span>
<a href="#l3.585"></a><span id="l3.585"> </span>
<a href="#l3.586"></a><span id="l3.586" class="difflineminus">-  /** </span>
<a href="#l3.587"></a><span id="l3.587" class="difflineplus">+  /**</span>
<a href="#l3.588"></a><span id="l3.588">    * Boolean checkCanDrop (DOMEvent aEvent, Object aDragDropObserver) ;</span>
<a href="#l3.589"></a><span id="l3.589">    *</span>
<a href="#l3.590"></a><span id="l3.590">    * Sets the canDrop attribute for the drag session.</span>
<a href="#l3.591"></a><span id="l3.591">    * returns false if there is no current drag session.</span>
<a href="#l3.592"></a><span id="l3.592">    *</span>
<a href="#l3.593"></a><span id="l3.593">    * @param DOMEvent aEvent</span>
<a href="#l3.594"></a><span id="l3.594">    *        the DOM event fired by the drop</span>
<a href="#l3.595"></a><span id="l3.595">    * @param Object aDragDropObserver</span>
<a href="#l3.596"></a><span id="l3.596">    *        javascript object of format described above that specifies</span>
<a href="#l3.597"></a><span id="l3.597">    *        the way in which the element responds to drag events.</span>
<a href="#l3.598"></a><span id="l3.598">    **/</span>
<a href="#l3.599"></a><span id="l3.599">   checkCanDrop: function (aEvent, aDragDropObserver)</span>
<a href="#l3.600"></a><span id="l3.600">     {</span>
<a href="#l3.601"></a><span id="l3.601" class="difflineminus">-      if (!this.mDragSession) </span>
<a href="#l3.602"></a><span id="l3.602" class="difflineplus">+      if (!this.mDragSession)</span>
<a href="#l3.603"></a><span id="l3.603">         this.mDragSession = this.mDragService.getCurrentSession();</span>
<a href="#l3.604"></a><span id="l3.604" class="difflineminus">-      if (!this.mDragSession) </span>
<a href="#l3.605"></a><span id="l3.605" class="difflineplus">+      if (!this.mDragSession)</span>
<a href="#l3.606"></a><span id="l3.606">         return false;</span>
<a href="#l3.607"></a><span id="l3.607">       this.mDragSession.canDrop = this.mDragSession.sourceNode != aEvent.target;</span>
<a href="#l3.608"></a><span id="l3.608">       if (&quot;canDrop&quot; in aDragDropObserver)</span>
<a href="#l3.609"></a><span id="l3.609">         this.mDragSession.canDrop &amp;= aDragDropObserver.canDrop(aEvent, this.mDragSession);</span>
<a href="#l3.610"></a><span id="l3.610">       return true;</span>
<a href="#l3.611"></a><span id="l3.611">     },</span>
<a href="#l3.612"></a><span id="l3.612"> </span>
<a href="#l3.613"></a><span id="l3.613">   /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/suite/common/directory/directory.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/suite/common/directory/directory.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -6,31 +6,31 @@</span>
<a href="#l4.4"></a><span id="l4.4"> /*</span>
<a href="#l4.5"></a><span id="l4.5">    Script for the directory window</span>
<a href="#l4.6"></a><span id="l4.6"> */</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8"> const RDFSERVICE_CONTRACTID     = &quot;@mozilla.org/rdf/rdf-service;1&quot;;</span>
<a href="#l4.9"></a><span id="l4.9"> const DRAGSERVICE_CONTRACTID    = &quot;@mozilla.org/widget/dragservice;1&quot;;</span>
<a href="#l4.10"></a><span id="l4.10"> const TRANSFERABLE_CONTRACTID   = &quot;@mozilla.org/widget/transferable;1&quot;;</span>
<a href="#l4.11"></a><span id="l4.11"> const XULSORTSERVICE_CONTRACTID = &quot;@mozilla.org/xul/xul-sort-service;1&quot;;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-const ARRAY_CONTRACTID          = &quot;@mozilla.org/supports-array;1&quot;;</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+const ARRAY_CONTRACTID          = &quot;@mozilla.org/mutable-array;1&quot;;</span>
<a href="#l4.14"></a><span id="l4.14"> const WSTRING_CONTRACTID        = &quot;@mozilla.org/supports-string;1&quot;;</span>
<a href="#l4.15"></a><span id="l4.15"> </span>
<a href="#l4.16"></a><span id="l4.16"> const NC_NS                 = &quot;http://home.netscape.com/NC-rdf#&quot;;</span>
<a href="#l4.17"></a><span id="l4.17"> const NC_NAME               = NC_NS + &quot;Name&quot;;</span>
<a href="#l4.18"></a><span id="l4.18"> const NC_URL                = NC_NS + &quot;URL&quot;;</span>
<a href="#l4.19"></a><span id="l4.19"> const NC_LOADING            = NC_NS + &quot;loading&quot;;</span>
<a href="#l4.20"></a><span id="l4.20"> </span>
<a href="#l4.21"></a><span id="l4.21"> const nsIHTTPIndex          = Components.interfaces.nsIHTTPIndex;</span>
<a href="#l4.22"></a><span id="l4.22"> const nsIDragService        = Components.interfaces.nsIDragService;</span>
<a href="#l4.23"></a><span id="l4.23"> const nsITransferable       = Components.interfaces.nsITransferable;</span>
<a href="#l4.24"></a><span id="l4.24"> const nsIXULSortService     = Components.interfaces.nsIXULSortService;</span>
<a href="#l4.25"></a><span id="l4.25"> const nsIRDFService         = Components.interfaces.nsIRDFService;</span>
<a href="#l4.26"></a><span id="l4.26"> const nsIRDFLiteral         = Components.interfaces.nsIRDFLiteral;</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-const nsISupportsArray      = Components.interfaces.nsISupportsArray;</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+const nsIMutableArray      = Components.interfaces.nsIMutableArray;</span>
<a href="#l4.29"></a><span id="l4.29"> const nsISupportsString    = Components.interfaces.nsISupportsString;</span>
<a href="#l4.30"></a><span id="l4.30"> </span>
<a href="#l4.31"></a><span id="l4.31"> // By the time this runs, The 'HTTPIndex' variable will have been</span>
<a href="#l4.32"></a><span id="l4.32"> // magically set on the global object by the native code.</span>
<a href="#l4.33"></a><span id="l4.33"> </span>
<a href="#l4.34"></a><span id="l4.34"> function debug(msg)</span>
<a href="#l4.35"></a><span id="l4.35"> {</span>
<a href="#l4.36"></a><span id="l4.36">   // Uncomment to print out debug info.</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineat">@@ -239,21 +239,21 @@ function BeginDragTree (event)</span>
<a href="#l4.38"></a><span id="l4.38">     genDataHTML.data = &quot;&lt;a href=\&quot;&quot; + url + &quot;\&quot;&gt;&quot; + desc + &quot;&lt;/a&gt;&quot;;</span>
<a href="#l4.39"></a><span id="l4.39">     genData.data = url;</span>
<a href="#l4.40"></a><span id="l4.40"> </span>
<a href="#l4.41"></a><span id="l4.41">     transferable.setTransferData(&quot;text/x-moz-url&quot;, genDataURL, genDataURL.data.length * 2);</span>
<a href="#l4.42"></a><span id="l4.42">     transferable.setTransferData(&quot;text/html&quot;, genDataHTML, genDataHTML.data.length * 2);</span>
<a href="#l4.43"></a><span id="l4.43">     transferable.setTransferData(&quot;text/unicode&quot;, genData, genData.data.length * 2);</span>
<a href="#l4.44"></a><span id="l4.44"> </span>
<a href="#l4.45"></a><span id="l4.45">     var transArray =</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineminus">-      Components.classes[ARRAY_CONTRACTID].createInstance(nsISupportsArray);</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+      Components.classes[ARRAY_CONTRACTID].createInstance(nsIMutableArray);</span>
<a href="#l4.48"></a><span id="l4.48"> </span>
<a href="#l4.49"></a><span id="l4.49">     // put it into the transferable as an |nsISupports|</span>
<a href="#l4.50"></a><span id="l4.50">     var genTrans = transferable.QueryInterface(Components.interfaces.nsISupports);</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineminus">-    transArray.AppendElement(genTrans);</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+    transArray.appendElement(genTrans, /* weak = */ false);</span>
<a href="#l4.53"></a><span id="l4.53"> </span>
<a href="#l4.54"></a><span id="l4.54">     var dragService =</span>
<a href="#l4.55"></a><span id="l4.55">       Components.classes[DRAGSERVICE_CONTRACTID].getService(nsIDragService);</span>
<a href="#l4.56"></a><span id="l4.56"> </span>
<a href="#l4.57"></a><span id="l4.57">     dragService.invokeDragSession(event.target, transArray, null, nsIDragService.DRAGDROP_ACTION_COPY +</span>
<a href="#l4.58"></a><span id="l4.58">                                   nsIDragService.DRAGDROP_ACTION_MOVE);</span>
<a href="#l4.59"></a><span id="l4.59"> </span>
<a href="#l4.60"></a><span id="l4.60">     dragStarted = true;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/suite/mailnews/nsDragAndDrop.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/suite/mailnews/nsDragAndDrop.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -65,38 +65,38 @@ var nsTransferable = {</span>
<a href="#l5.4"></a><span id="l5.4">    *                                   Function aRetrievalFunc, Boolean aAnyFlag) ;</span>
<a href="#l5.5"></a><span id="l5.5">    *</span>
<a href="#l5.6"></a><span id="l5.6">    * Retrieves data from the transferable provided in aRetrievalFunc, formatted</span>
<a href="#l5.7"></a><span id="l5.7">    * for more convenient access.</span>
<a href="#l5.8"></a><span id="l5.8">    *</span>
<a href="#l5.9"></a><span id="l5.9">    * @param FlavourSet aFlavourSet</span>
<a href="#l5.10"></a><span id="l5.10">    *        a FlavourSet object that contains a list of supported flavours.</span>
<a href="#l5.11"></a><span id="l5.11">    * @param Function aRetrievalFunc</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-   *        a reference to a function that returns a nsISupportsArray of nsITransferables</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+   *        a reference to a function that returns a nsIArray of nsITransferables</span>
<a href="#l5.14"></a><span id="l5.14">    *        for each item from the specified source (clipboard/drag&amp;drop etc)</span>
<a href="#l5.15"></a><span id="l5.15">    * @param Boolean aAnyFlag</span>
<a href="#l5.16"></a><span id="l5.16">    *        a flag specifying whether or not a specific flavour is requested. If false,</span>
<a href="#l5.17"></a><span id="l5.17">    *        data of the type of the first flavour in the flavourlist parameter is returned,</span>
<a href="#l5.18"></a><span id="l5.18">    *        otherwise the best flavour supported will be returned.</span>
<a href="#l5.19"></a><span id="l5.19">    **/</span>
<a href="#l5.20"></a><span id="l5.20">   get: function (aFlavourSet, aRetrievalFunc, aAnyFlag)</span>
<a href="#l5.21"></a><span id="l5.21">     {</span>
<a href="#l5.22"></a><span id="l5.22">       if (!aRetrievalFunc)</span>
<a href="#l5.23"></a><span id="l5.23">         throw &quot;No data retrieval handler provided!&quot;;</span>
<a href="#l5.24"></a><span id="l5.24"> </span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">-      var supportsArray = aRetrievalFunc(aFlavourSet);</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+      var array = aRetrievalFunc(aFlavourSet);</span>
<a href="#l5.27"></a><span id="l5.27">       var dataArray = [];</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">-      var count = supportsArray.Count();</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+      var count = array.Count();</span>
<a href="#l5.30"></a><span id="l5.30"> </span>
<a href="#l5.31"></a><span id="l5.31">       // Iterate over the number of items returned from aRetrievalFunc. For</span>
<a href="#l5.32"></a><span id="l5.32">       // clipboard operations, this is 1, for drag and drop (where multiple</span>
<a href="#l5.33"></a><span id="l5.33">       // items may have been dragged) this could be &gt;1.</span>
<a href="#l5.34"></a><span id="l5.34">       for (var i = 0; i &lt; count; i++)</span>
<a href="#l5.35"></a><span id="l5.35">         {</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineminus">-          var trans = supportsArray.GetElementAt(i);</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+          var trans = array.GetElementAt(i);</span>
<a href="#l5.38"></a><span id="l5.38">           if (!trans) continue;</span>
<a href="#l5.39"></a><span id="l5.39">           trans = trans.QueryInterface(Components.interfaces.nsITransferable);</span>
<a href="#l5.40"></a><span id="l5.40"> </span>
<a href="#l5.41"></a><span id="l5.41">           var data = { };</span>
<a href="#l5.42"></a><span id="l5.42">           var length = { };</span>
<a href="#l5.43"></a><span id="l5.43"> </span>
<a href="#l5.44"></a><span id="l5.44">           var currData = null;</span>
<a href="#l5.45"></a><span id="l5.45">           if (aAnyFlag)</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

