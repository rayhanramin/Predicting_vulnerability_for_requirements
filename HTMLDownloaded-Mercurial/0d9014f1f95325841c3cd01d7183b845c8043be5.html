<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 9624:0d9014f1f95325841c3cd01d7183b845c8043be5</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 0d9014f1f95325841c3cd01d7183b845c8043be5" />
<meta property="og:url" content="/comm-central/rev/0d9014f1f95325841c3cd01d7183b845c8043be5" />
<meta property="og:description" content="add cloud file tests, r=bienvenu, bug 698925" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 0d9014f1f95325841c3cd01d7183b845c8043be5 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/0d9014f1f95325841c3cd01d7183b845c8043be5">shortlog</a> |
<a href="/comm-central/log/0d9014f1f95325841c3cd01d7183b845c8043be5">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/0d9014f1f95325841c3cd01d7183b845c8043be5">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/0d9014f1f95325841c3cd01d7183b845c8043be5">files</a> |
changeset |
<a href="/comm-central/raw-rev/0d9014f1f95325841c3cd01d7183b845c8043be5">raw</a>  | <a href="/comm-central/archive/0d9014f1f95325841c3cd01d7183b845c8043be5.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
add cloud file tests, r=bienvenu, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=698925">bug 698925</a>
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#77;&#105;&#107;&#101;&#32;&#67;&#111;&#110;&#108;&#101;&#121;&#32;&#60;&#109;&#99;&#111;&#110;&#108;&#101;&#121;&#64;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 12 Mar 2012 16:14:37 -0700</td></tr>

<tr>
 <td>changeset 9624</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/0d9014f1f95325841c3cd01d7183b845c8043be5">0d9014f1f95325841c3cd01d7183b845c8043be5</a></td>
</tr>



<tr>
<td>parent 9623</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/c995fdc3e91a5d53cd1d6f7b84c2dd9731bce25f">c995fdc3e91a5d53cd1d6f7b84c2dd9731bce25f</a>
</td>
</tr>

<tr>
<td>child 9625</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/42e362b0c7c6ae8185daa6e4bd033c9193d675b1">42e362b0c7c6ae8185daa6e4bd033c9193d675b1</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=0d9014f1f95325841c3cd01d7183b845c8043be5">7353</a></td></tr>
<tr><td>push user</td><td>bienvenu@nventure.com</td></tr>
<tr><td>push date</td><td class="date age">Mon, 12 Mar 2012 23:14:08 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@0d9014f1f953 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0d9014f1f95325841c3cd01d7183b845c8043be5">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0d9014f1f95325841c3cd01d7183b845c8043be5&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0d9014f1f95325841c3cd01d7183b845c8043be5&newProject=comm-central&newRevision=0d9014f1f95325841c3cd01d7183b845c8043be5&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0d9014f1f95325841c3cd01d7183b845c8043be5&newProject=comm-central&newRevision=0d9014f1f95325841c3cd01d7183b845c8043be5&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0d9014f1f95325841c3cd01d7183b845c8043be5&newProject=comm-central&newRevision=0d9014f1f95325841c3cd01d7183b845c8043be5&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28bienvenu%29&revcount=50">bienvenu</a>, <a href="/comm-central/log?rev=reviewer%28bug%29&revcount=50">bug</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=698925">698925</a></td></tr>




</table></div>

<div class="page_body description">add cloud file tests, r=bienvenu, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=698925">bug 698925</a></div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/cloudfile/data/testFile1">mail/test/mozmill/cloudfile/data/testFile1</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/cloudfile/data/testFile1">file</a> |
<a href="/comm-central/annotate/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/cloudfile/data/testFile1">annotate</a> |
<a href="/comm-central/diff/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/cloudfile/data/testFile1">diff</a> |
<a href="/comm-central/comparison/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/cloudfile/data/testFile1">comparison</a> |
<a href="/comm-central/log/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/cloudfile/data/testFile1">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/cloudfile/data/testFile2">mail/test/mozmill/cloudfile/data/testFile2</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/cloudfile/data/testFile2">file</a> |
<a href="/comm-central/annotate/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/cloudfile/data/testFile2">annotate</a> |
<a href="/comm-central/diff/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/cloudfile/data/testFile2">diff</a> |
<a href="/comm-central/comparison/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/cloudfile/data/testFile2">comparison</a> |
<a href="/comm-central/log/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/cloudfile/data/testFile2">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/cloudfile/data/testFile3">mail/test/mozmill/cloudfile/data/testFile3</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/cloudfile/data/testFile3">file</a> |
<a href="/comm-central/annotate/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/cloudfile/data/testFile3">annotate</a> |
<a href="/comm-central/diff/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/cloudfile/data/testFile3">diff</a> |
<a href="/comm-central/comparison/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/cloudfile/data/testFile3">comparison</a> |
<a href="/comm-central/log/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/cloudfile/data/testFile3">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/cloudfile/test-cloudfile-backend-dropbox.js">mail/test/mozmill/cloudfile/test-cloudfile-backend-dropbox.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/cloudfile/test-cloudfile-backend-dropbox.js">file</a> |
<a href="/comm-central/annotate/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/cloudfile/test-cloudfile-backend-dropbox.js">annotate</a> |
<a href="/comm-central/diff/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/cloudfile/test-cloudfile-backend-dropbox.js">diff</a> |
<a href="/comm-central/comparison/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/cloudfile/test-cloudfile-backend-dropbox.js">comparison</a> |
<a href="/comm-central/log/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/cloudfile/test-cloudfile-backend-dropbox.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/cloudfile/test-cloudfile-backend-yousendit.js">mail/test/mozmill/cloudfile/test-cloudfile-backend-yousendit.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/cloudfile/test-cloudfile-backend-yousendit.js">file</a> |
<a href="/comm-central/annotate/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/cloudfile/test-cloudfile-backend-yousendit.js">annotate</a> |
<a href="/comm-central/diff/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/cloudfile/test-cloudfile-backend-yousendit.js">diff</a> |
<a href="/comm-central/comparison/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/cloudfile/test-cloudfile-backend-yousendit.js">comparison</a> |
<a href="/comm-central/log/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/cloudfile/test-cloudfile-backend-yousendit.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/cloudfile/test-cloudfile-manager.js">mail/test/mozmill/cloudfile/test-cloudfile-manager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/cloudfile/test-cloudfile-manager.js">file</a> |
<a href="/comm-central/annotate/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/cloudfile/test-cloudfile-manager.js">annotate</a> |
<a href="/comm-central/diff/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/cloudfile/test-cloudfile-manager.js">diff</a> |
<a href="/comm-central/comparison/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/cloudfile/test-cloudfile-manager.js">comparison</a> |
<a href="/comm-central/log/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/cloudfile/test-cloudfile-manager.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js">mail/test/mozmill/cloudfile/test-cloudfile-notifications.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js">file</a> |
<a href="/comm-central/annotate/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js">annotate</a> |
<a href="/comm-central/diff/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js">diff</a> |
<a href="/comm-central/comparison/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js">comparison</a> |
<a href="/comm-central/log/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/mozmilltests.list">mail/test/mozmill/mozmilltests.list</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/mozmilltests.list">file</a> |
<a href="/comm-central/annotate/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/mozmilltests.list">annotate</a> |
<a href="/comm-central/diff/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/mozmilltests.list">diff</a> |
<a href="/comm-central/comparison/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/mozmilltests.list">comparison</a> |
<a href="/comm-central/log/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/mozmilltests.list">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/pref-window/test-attachments-pane.js">mail/test/mozmill/pref-window/test-attachments-pane.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/pref-window/test-attachments-pane.js">file</a> |
<a href="/comm-central/annotate/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/pref-window/test-attachments-pane.js">annotate</a> |
<a href="/comm-central/diff/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/pref-window/test-attachments-pane.js">diff</a> |
<a href="/comm-central/comparison/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/pref-window/test-attachments-pane.js">comparison</a> |
<a href="/comm-central/log/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/pref-window/test-attachments-pane.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/shared-modules/test-attachment-helpers.js">mail/test/mozmill/shared-modules/test-attachment-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/shared-modules/test-attachment-helpers.js">file</a> |
<a href="/comm-central/annotate/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/shared-modules/test-attachment-helpers.js">annotate</a> |
<a href="/comm-central/diff/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/shared-modules/test-attachment-helpers.js">diff</a> |
<a href="/comm-central/comparison/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/shared-modules/test-attachment-helpers.js">comparison</a> |
<a href="/comm-central/log/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/shared-modules/test-attachment-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/shared-modules/test-cloudfile-backend-helpers.js">mail/test/mozmill/shared-modules/test-cloudfile-backend-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/shared-modules/test-cloudfile-backend-helpers.js">file</a> |
<a href="/comm-central/annotate/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/shared-modules/test-cloudfile-backend-helpers.js">annotate</a> |
<a href="/comm-central/diff/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/shared-modules/test-cloudfile-backend-helpers.js">diff</a> |
<a href="/comm-central/comparison/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/shared-modules/test-cloudfile-backend-helpers.js">comparison</a> |
<a href="/comm-central/log/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/shared-modules/test-cloudfile-backend-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/shared-modules/test-cloudfile-dropbox-helpers.js">mail/test/mozmill/shared-modules/test-cloudfile-dropbox-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/shared-modules/test-cloudfile-dropbox-helpers.js">file</a> |
<a href="/comm-central/annotate/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/shared-modules/test-cloudfile-dropbox-helpers.js">annotate</a> |
<a href="/comm-central/diff/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/shared-modules/test-cloudfile-dropbox-helpers.js">diff</a> |
<a href="/comm-central/comparison/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/shared-modules/test-cloudfile-dropbox-helpers.js">comparison</a> |
<a href="/comm-central/log/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/shared-modules/test-cloudfile-dropbox-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">mail/test/mozmill/shared-modules/test-cloudfile-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">file</a> |
<a href="/comm-central/annotate/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">annotate</a> |
<a href="/comm-central/diff/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">diff</a> |
<a href="/comm-central/comparison/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">comparison</a> |
<a href="/comm-central/log/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/shared-modules/test-cloudfile-yousendit-helpers.js">mail/test/mozmill/shared-modules/test-cloudfile-yousendit-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/shared-modules/test-cloudfile-yousendit-helpers.js">file</a> |
<a href="/comm-central/annotate/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/shared-modules/test-cloudfile-yousendit-helpers.js">annotate</a> |
<a href="/comm-central/diff/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/shared-modules/test-cloudfile-yousendit-helpers.js">diff</a> |
<a href="/comm-central/comparison/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/shared-modules/test-cloudfile-yousendit-helpers.js">comparison</a> |
<a href="/comm-central/log/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/shared-modules/test-cloudfile-yousendit-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/shared-modules/test-mock-object-helpers.js">mail/test/mozmill/shared-modules/test-mock-object-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/shared-modules/test-mock-object-helpers.js">file</a> |
<a href="/comm-central/annotate/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/shared-modules/test-mock-object-helpers.js">annotate</a> |
<a href="/comm-central/diff/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/shared-modules/test-mock-object-helpers.js">diff</a> |
<a href="/comm-central/comparison/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/shared-modules/test-mock-object-helpers.js">comparison</a> |
<a href="/comm-central/log/0d9014f1f95325841c3cd01d7183b845c8043be5/mail/test/mozmill/shared-modules/test-mock-object-helpers.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1">new file mode 100644</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineminus">--- /dev/null</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineplus">+++ b/mail/test/mozmill/cloudfile/data/testFile1</span>
<a href="#l1.4"></a><span id="l1.4" class="difflineat">@@ -0,0 +1,1 @@</span>
<a href="#l1.5"></a><span id="l1.5" class="difflineplus">+Thundercats single-origin coffee culpa, irony minim vero sunt laborum synth aesthetic. Wayfarers photo booth dolore 8-bit, DIY four loko skateboard forage portland id consectetur. Aesthetic aliquip raw denim aute tofu consequat. Before they sold out etsy cliche marfa, magna seitan fixie brooklyn voluptate laborum messenger bag chillwave narwhal truffaut. Cray cupidatat PBR delectus aliqua synth cillum gentrify. Aesthetic do vegan etsy locavore. Veniam assumenda ea, cupidatat aute vero qui.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">new file mode 100644</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineminus">--- /dev/null</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineplus">+++ b/mail/test/mozmill/cloudfile/data/testFile2</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineat">@@ -0,0 +1,3 @@</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineplus">+Nesciunt odio minim, cupidatat photo booth non post-ironic street art banh mi salvia duis aesthetic squid single-origin coffee. Ex DIY trust fund butcher, esse mustache consequat authentic bushwick twee gentrify hella PBR kogi sustainable. PBR nihil VHS veniam, occaecat dreamcatcher odio iphone irony vero seitan mollit fanny pack adipisicing. Swag jean shorts labore, aesthetic dolore letterpress gluten-free lomo ex wes anderson. Et street art cred Austin velit, raw denim do blog godard leggings. Accusamus adipisicing excepteur occaecat cray sriracha. Leggings brunch artisan occaecat, 3 wolf moon forage mlkshk ad farm-to-table.</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineplus">+</span>
<a href="#l2.7"></a><span id="l2.7" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">new file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- /dev/null</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ b/mail/test/mozmill/cloudfile/data/testFile3</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -0,0 +1,3 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineplus">+Commodo et laborum fingerstache semiotics etsy. Organic locavore next level, master cleanse raw denim consectetur wes anderson ethical tempor photo booth quis. Leggings pop-up sed trust fund. Chillwave godard velit high life, typewriter umami trust fund. Laboris aliquip assumenda you probably haven't heard of them exercitation portland. Ea do selvage, stumptown dolore etsy commodo tattooed kogi assumenda. Aute tempor carles consequat cray locavore.</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineplus">+</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineplus">+Craft beer consectetur anim ex fap consequat, helvetica hella nihil retro before they sold out letterpress cillum mlkshk. Deserunt tempor scenester put a bird on it kale chips mlkshk occaecat, et umami artisan letterpress raw denim sapiente. Echo park pork belly marfa sunt. Iphone aesthetic fanny pack mollit. Irony pork belly bespoke, shoreditch locavore fixie iphone officia mollit mlkshk consequat hoodie mixtape. Nisi consectetur locavore, godard whatever occaecat id blog ethical wolf hoodie PBR. Trust fund sunt mustache, enim eiusmod aesthetic helvetica leggings pinterest laboris polaroid brooklyn.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">new file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- /dev/null</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ b/mail/test/mozmill/cloudfile/test-cloudfile-backend-dropbox.js</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -0,0 +1,192 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineplus">+  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineplus">+</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+/**</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+ * Tests the Dropbox Bigfile backend.</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+ */</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+let Cu = Components.utils;</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+let Cc = Components.classes;</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+let Ci = Components.interfaces;</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+const MODULE_NAME = 'test-cloudfile-backend-dropbox';</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+const RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+const MODULE_REQUIRES = ['folder-display-helpers',</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+                         'compose-helpers',</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+                         'cloudfile-dropbox-helpers',</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+                         'observer-helpers',];</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+Cu.import('resource://gre/modules/Services.jsm');</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+var gServer, gObsManager;</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+function setupModule(module) {</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+  fdh.installInto(module);</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+  let ch = collector.getModule('compose-helpers');</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+  ch.installInto(module);</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+  let cfh = collector.getModule('cloudfile-helpers');</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+  cfh.installInto(module);</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+  let cbh = collector.getModule('cloudfile-backend-helpers');</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+  cbh.installInto(module);</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+  let cdh = collector.getModule('cloudfile-dropbox-helpers');</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+  cdh.installInto(module);</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+  let oh = collector.getModule('observer-helpers');</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+  oh.installInto(module);</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+  gObsManager = new cbh.SimpleRequestObserverManager();</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+  // Enable logging for this test.</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+  Services.prefs.setCharPref(&quot;Dropbox.logging.dump&quot;, &quot;All&quot;);</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+  Services.prefs.setCharPref(&quot;TBOAuth.logging.dump&quot;, &quot;All&quot;);</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+};</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+function teardownModule() {</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+  Services.prefs.QueryInterface(Ci.nsIPrefBranch)</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+          .deleteBranch(&quot;mail.cloud_files.accounts&quot;);</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+  Services.prefs.clearUserPref(&quot;Dropbox.logging.dump&quot;);</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+  Services.prefs.clearUserPref(&quot;TBOAuth.logging.dump&quot;);</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+}</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+function setupTest() {</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+  gServer = new MockDropboxServer();</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+  gServer.init();</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+  gServer.start();</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+}</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+function teardownTest() {</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+  gObsManager.check();</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+  gObsManager.reset();</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+  gServer.stop(mc);</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+}</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+function test_simple_case() {</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+  const kExpectedUrl = &quot;http://www.example.com/expectedUrl&quot;;</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+  const kTopics = [kUploadFile, kGetFileURL];</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+  gServer.setupUser();</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+  gServer.planForUploadFile(&quot;testFile1&quot;);</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+  gServer.planForGetFileURL(&quot;testFile1&quot;, {url: kExpectedUrl});</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+  let obs = new ObservationRecorder();</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+  for each (let [, topic] in Iterator(kTopics)) {</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+    obs.planFor(topic);</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+    Services.obs.addObserver(obs, topic, false);</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+  }</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+  let requestObserver = gObsManager.create(&quot;test_simple_case - Upload 1&quot;);</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+  let file = getFile(&quot;./data/testFile1&quot;, __file__);</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+  let provider = gServer.getPreparedBackend(&quot;someAccountKey&quot;);</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+  provider.uploadFile(file, requestObserver);</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+  mc.waitFor(function () requestObserver.success);</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+  let urlForFile = provider.urlForFile(file);</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+  assert_equals(kExpectedUrl, urlForFile);</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+  assert_equals(1, obs.numSightings(kUploadFile));</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+  assert_equals(1, obs.numSightings(kGetFileURL));</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+  gServer.planForUploadFile(&quot;testFile1&quot;);</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+  gServer.planForGetFileURL(&quot;testFile1&quot;, {url: kExpectedUrl});</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+  requestObserver = gObsManager.create(&quot;test_simple_case - Upload 2&quot;);</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+  provider.uploadFile(file, requestObserver);</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+  mc.waitFor(function () requestObserver.success);</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+  urlForFile = provider.urlForFile(file);</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+  assert_equals(kExpectedUrl, urlForFile);</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+  assert_equals(2, obs.numSightings(kUploadFile));</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+  assert_equals(2, obs.numSightings(kGetFileURL));</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineplus">+  for each (let [, topic] in Iterator(kTopics)) {</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+    Services.obs.removeObserver(obs, topic);</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+  }</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+}</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineplus">+</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+function test_chained_uploads() {</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+  const kExpectedUrlRoot = &quot;http://www.example.com/&quot;;</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+  const kTopics = [kUploadFile, kGetFileURL];</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+  const kFilenames = [&quot;testFile1&quot;, &quot;testFile2&quot;, &quot;testFile3&quot;];</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineplus">+</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineplus">+  gServer.setupUser();</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineplus">+</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineplus">+  for each (let [, filename] in Iterator(kFilenames)) {</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineplus">+    let expectedUrl = kExpectedUrlRoot + filename;</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+    gServer.planForUploadFile(filename);</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineplus">+    gServer.planForGetFileURL(filename, {url: expectedUrl});</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineplus">+  }</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineplus">+</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineplus">+  let obs = new ObservationRecorder();</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineplus">+  for each (let [, topic] in Iterator(kTopics)) {</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineplus">+    obs.planFor(topic);</span>
<a href="#l4.132"></a><span id="l4.132" class="difflineplus">+    Services.obs.addObserver(obs, topic, false);</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineplus">+  }</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineplus">+</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineplus">+  let provider = gServer.getPreparedBackend(&quot;someAccountKey&quot;);</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineplus">+</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineplus">+  let files = [];</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineplus">+</span>
<a href="#l4.139"></a><span id="l4.139" class="difflineplus">+  let observers = kFilenames.map(function(aFilename) {</span>
<a href="#l4.140"></a><span id="l4.140" class="difflineplus">+    let requestObserver = gObsManager.create(&quot;test_chained_uploads for filename &quot; + aFilename);</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineplus">+    let file = getFile(&quot;./data/&quot; + aFilename, __file__);</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineplus">+    files.push(file);</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineplus">+    provider.uploadFile(file, requestObserver);</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineplus">+    return requestObserver;</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineplus">+  });</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineplus">+</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineplus">+  mc.waitFor(function() {</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineplus">+    return observers.every(function(aListener) aListener.success);</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineplus">+  }, &quot;Timed out waiting for chained uploads to complete.&quot;);</span>
<a href="#l4.150"></a><span id="l4.150" class="difflineplus">+</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineplus">+  assert_equals(kFilenames.length, obs.numSightings(kUploadFile));</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineplus">+</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineplus">+  for (let [index, filename] in Iterator(kFilenames)) {</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineplus">+    assert_equals(obs.data[kUploadFile][index], filename);</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineplus">+    let file = getFile(&quot;./data/&quot; + filename, __file__);</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineplus">+    let expectedUriForFile = kExpectedUrlRoot + filename;</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineplus">+    let uriForFile = provider.urlForFile(files[index]);</span>
<a href="#l4.158"></a><span id="l4.158" class="difflineplus">+    assert_equals(expectedUriForFile, uriForFile);</span>
<a href="#l4.159"></a><span id="l4.159" class="difflineplus">+  }</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineplus">+</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineplus">+  assert_equals(kFilenames.length, obs.numSightings(kGetFileURL));</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineplus">+</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineplus">+  for each (let [, topic] in Iterator(kTopics)) {</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineplus">+    Services.obs.removeObserver(obs, topic);</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineplus">+  }</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineplus">+}</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineplus">+</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineplus">+function test_deleting_uploads() {</span>
<a href="#l4.169"></a><span id="l4.169" class="difflineplus">+  const kFilename = &quot;testFile1&quot;;</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineplus">+  gServer.setupUser();</span>
<a href="#l4.171"></a><span id="l4.171" class="difflineplus">+  let provider = gServer.getPreparedBackend(&quot;someAccountKey&quot;);</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineplus">+  // Upload a file</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineplus">+</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineplus">+  let file = getFile(&quot;./data/&quot; + kFilename, __file__);</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineplus">+  gServer.planForUploadFile(kFilename);</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineplus">+  gServer.planForGetFileURL(kFilename,</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineplus">+                                {url: &quot;http://www.example.com/someFile&quot;});</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineplus">+  let requestObserver = gObsManager.create(&quot;test_deleting_uploads - upload 1&quot;);</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineplus">+  provider.uploadFile(file, requestObserver);</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineplus">+  mc.waitFor(function() requestObserver.success);</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineplus">+</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineplus">+  // Try deleting a file</span>
<a href="#l4.183"></a><span id="l4.183" class="difflineplus">+  let obs = new ObservationRecorder();</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineplus">+  obs.planFor(kDeleteFile)</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineplus">+  Services.obs.addObserver(obs, kDeleteFile, false);</span>
<a href="#l4.186"></a><span id="l4.186" class="difflineplus">+</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineplus">+  gServer.planForDeleteFile(kFilename);</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineplus">+  let deleteObserver = gObsManager.create(&quot;test_deleting_uploads - delete 1&quot;);</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineplus">+  provider.deleteFile(file, deleteObserver);</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineplus">+  mc.waitFor(function() deleteObserver.success);</span>
<a href="#l4.191"></a><span id="l4.191" class="difflineplus">+</span>
<a href="#l4.192"></a><span id="l4.192" class="difflineplus">+  // Check to make sure the file was deleted on the server</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineplus">+  assert_equals(1, obs.numSightings(kDeleteFile));</span>
<a href="#l4.194"></a><span id="l4.194" class="difflineplus">+  assert_equals(obs.data[kDeleteFile][0], kFilename);</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineplus">+  Services.obs.removeObserver(obs, kDeleteFile);</span>
<a href="#l4.196"></a><span id="l4.196" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">new file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- /dev/null</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ b/mail/test/mozmill/cloudfile/test-cloudfile-backend-yousendit.js</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -0,0 +1,235 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineplus">+  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineplus">+</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+/**</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+ * Tests the YouSendIt Bigfile backend.</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+ */</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+let Cu = Components.utils;</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+let Cc = Components.classes;</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+let Ci = Components.interfaces;</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+const MODULE_NAME = 'test-cloudfile-backend-yousendit';</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+const RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+const MODULE_REQUIRES = ['folder-display-helpers',</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+                         'compose-helpers',</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+                         'cloudfile-yousendit-helpers',</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+                         'observer-helpers',];</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+Cu.import('resource://gre/modules/Services.jsm');</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+var gServer, gObsManager;</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+function setupModule(module) {</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+  fdh.installInto(module);</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+  let ch = collector.getModule('compose-helpers');</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+  ch.installInto(module);</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+  let cfh = collector.getModule('cloudfile-helpers');</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+  cfh.installInto(module);</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+  let cbh = collector.getModule('cloudfile-backend-helpers');</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+  cbh.installInto(module);</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+  let cyh = collector.getModule('cloudfile-yousendit-helpers');</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+  cyh.installInto(module);</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+  let oh = collector.getModule('observer-helpers');</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+  oh.installInto(module);</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+  gObsManager = new cbh.SimpleRequestObserverManager();</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+  // Enable logging for this group of tests.</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+  Services.prefs.setCharPref(&quot;YouSendIt.logging.dump&quot;, &quot;All&quot;);</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+};</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+function teardownModule(module) {</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+  Services.prefs.clearUserPref(&quot;YouSendIt.logging.dump&quot;);</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+}</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+function setupTest() {</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+  gServer = new MockYouSendItServer();</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+  gServer.init();</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+  gServer.start();</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+}</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+function teardownTest() {</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+  Services.prefs.QueryInterface(Ci.nsIPrefBranch)</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+          .deleteBranch(&quot;mail.cloud_files.accounts&quot;);</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+  gObsManager.check();</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+  gObsManager.reset();</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+  gServer.stop(mc);</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineplus">+}</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineplus">+function test_simple_case() {</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineplus">+  const kExpectedUrl = &quot;http://www.example.com/expectedUrl&quot;;</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineplus">+  const kTopics = [kUploadFile, kGetFileURL];</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+  gServer.planForUploadFile(&quot;testFile1&quot;);</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineplus">+  gServer.planForGetFileURL(&quot;testFile1&quot;, {url: kExpectedUrl});</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineplus">+</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+  let obs = new ObservationRecorder();</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineplus">+  for each (let [, topic] in Iterator(kTopics)) {</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+    obs.planFor(topic);</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineplus">+    Services.obs.addObserver(obs, topic, false);</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+  }</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+  let requestObserver = gObsManager.create(&quot;test_simple_case - Upload 1&quot;);</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+  let file = getFile(&quot;./data/testFile1&quot;, __file__);</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+  let provider = gServer.getPreparedBackend(&quot;someAccountKey&quot;);</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineplus">+  provider.uploadFile(file, requestObserver);</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineplus">+  mc.waitFor(function () requestObserver.success);</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineplus">+</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineplus">+  let urlForFile = provider.urlForFile(file);</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+  assert_equals(kExpectedUrl, urlForFile);</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineplus">+  assert_equals(1, obs.numSightings(kUploadFile));</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineplus">+  assert_equals(1, obs.numSightings(kGetFileURL));</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineplus">+</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineplus">+  gServer.planForUploadFile(&quot;testFile1&quot;);</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineplus">+  gServer.planForGetFileURL(&quot;testFile1&quot;, {url: kExpectedUrl});</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineplus">+  requestObserver = gObsManager.create(&quot;test_simple_case - Upload 2&quot;);</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineplus">+  provider.uploadFile(file, requestObserver);</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineplus">+  mc.waitFor(function () requestObserver.success);</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineplus">+  urlForFile = provider.urlForFile(file);</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineplus">+  assert_equals(kExpectedUrl, urlForFile);</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineplus">+</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineplus">+  assert_equals(2, obs.numSightings(kUploadFile));</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineplus">+  assert_equals(2, obs.numSightings(kGetFileURL));</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineplus">+</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineplus">+  for each (let [, topic] in Iterator(kTopics)) {</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineplus">+    Services.obs.removeObserver(obs, topic);</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineplus">+  }</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineplus">+}</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineplus">+</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineplus">+function test_chained_uploads() {</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineplus">+  const kExpectedUrlRoot = &quot;http://www.example.com/&quot;;</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineplus">+  const kTopics = [kUploadFile, kGetFileURL];</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineplus">+  const kFilenames = [&quot;testFile1&quot;, &quot;testFile2&quot;, &quot;testFile3&quot;];</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineplus">+</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineplus">+  for each (let [, filename] in Iterator(kFilenames)) {</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineplus">+    let expectedUrl = kExpectedUrlRoot + filename;</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineplus">+    gServer.planForUploadFile(filename);</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineplus">+    gServer.planForGetFileURL(filename, {url: expectedUrl});</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineplus">+  }</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineplus">+</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineplus">+  let obs = new ObservationRecorder();</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineplus">+  for each (let [, topic] in Iterator(kTopics)) {</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineplus">+    obs.planFor(topic);</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineplus">+    Services.obs.addObserver(obs, topic, false);</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineplus">+  }</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineplus">+</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineplus">+  let provider = gServer.getPreparedBackend(&quot;someAccountKey&quot;);</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineplus">+</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineplus">+  let files = [];</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineplus">+</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineplus">+  let observers = kFilenames.map(function(aFilename) {</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineplus">+    let requestObserver = gObsManager.create(&quot;test_chained_uploads for filename &quot; + aFilename);</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineplus">+    let file = getFile(&quot;./data/&quot; + aFilename, __file__);</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineplus">+    files.push(file);</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineplus">+    provider.uploadFile(file, requestObserver);</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineplus">+    return requestObserver;</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineplus">+  });</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineplus">+</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineplus">+  mc.waitFor(function() {</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineplus">+    return observers.every(function(aListener) aListener.success);</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineplus">+  }, &quot;Timed out waiting for chained uploads to complete.&quot;);</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineplus">+</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineplus">+  assert_equals(kFilenames.length, obs.numSightings(kUploadFile));</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineplus">+</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineplus">+  for (let [index, filename] in Iterator(kFilenames)) {</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineplus">+    assert_equals(obs.data[kUploadFile][index], filename);</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineplus">+    let file = getFile(&quot;./data/&quot; + filename, __file__);</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineplus">+    let expectedUriForFile = kExpectedUrlRoot + filename;</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineplus">+    let uriForFile = provider.urlForFile(files[index]);</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineplus">+    assert_equals(expectedUriForFile, uriForFile);</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineplus">+  }</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineplus">+</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineplus">+  assert_equals(kFilenames.length, obs.numSightings(kGetFileURL));</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineplus">+</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineplus">+  for each (let [, topic] in Iterator(kTopics)) {</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineplus">+    Services.obs.removeObserver(obs, topic);</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineplus">+  }</span>
<a href="#l5.161"></a><span id="l5.161" class="difflineplus">+}</span>
<a href="#l5.162"></a><span id="l5.162" class="difflineplus">+</span>
<a href="#l5.163"></a><span id="l5.163" class="difflineplus">+function test_deleting_uploads() {</span>
<a href="#l5.164"></a><span id="l5.164" class="difflineplus">+  const kFilename = &quot;testFile1&quot;;</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineplus">+  let provider = gServer.getPreparedBackend(&quot;someAccountKey&quot;);</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineplus">+  // Upload a file</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineplus">+</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineplus">+  let file = getFile(&quot;./data/&quot; + kFilename, __file__);</span>
<a href="#l5.169"></a><span id="l5.169" class="difflineplus">+  gServer.planForUploadFile(kFilename);</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineplus">+  let requestObserver = gObsManager.create(&quot;test_deleting_uploads - upload 1&quot;);</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineplus">+  provider.uploadFile(file, requestObserver);</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineplus">+  mc.waitFor(function() requestObserver.success);</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineplus">+</span>
<a href="#l5.174"></a><span id="l5.174" class="difflineplus">+  // Try deleting a file</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineplus">+  let obs = new ObservationRecorder();</span>
<a href="#l5.176"></a><span id="l5.176" class="difflineplus">+  obs.planFor(kDeleteFile)</span>
<a href="#l5.177"></a><span id="l5.177" class="difflineplus">+  Services.obs.addObserver(obs, kDeleteFile, false);</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineplus">+</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineplus">+  gServer.planForDeleteFile(kFilename);</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineplus">+  let deleteObserver = gObsManager.create(&quot;test_deleting_uploads - delete 1&quot;);</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineplus">+  provider.deleteFile(file, deleteObserver);</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineplus">+  mc.waitFor(function() deleteObserver.success);</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineplus">+</span>
<a href="#l5.184"></a><span id="l5.184" class="difflineplus">+  // Check to make sure the file was deleted on the server</span>
<a href="#l5.185"></a><span id="l5.185" class="difflineplus">+  assert_equals(1, obs.numSightings(kDeleteFile));</span>
<a href="#l5.186"></a><span id="l5.186" class="difflineplus">+  assert_equals(obs.data[kDeleteFile][0], kFilename);</span>
<a href="#l5.187"></a><span id="l5.187" class="difflineplus">+  Services.obs.removeObserver(obs, kDeleteFile);</span>
<a href="#l5.188"></a><span id="l5.188" class="difflineplus">+}</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineplus">+</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineplus">+</span>
<a href="#l5.191"></a><span id="l5.191" class="difflineplus">+function test_delete_refreshes_stale_token() {</span>
<a href="#l5.192"></a><span id="l5.192" class="difflineplus">+  const kFilename = &quot;testFile1&quot;;</span>
<a href="#l5.193"></a><span id="l5.193" class="difflineplus">+  const kUserEmail = &quot;test@example.com&quot;;</span>
<a href="#l5.194"></a><span id="l5.194" class="difflineplus">+</span>
<a href="#l5.195"></a><span id="l5.195" class="difflineplus">+  // Stop the default YSI mock server, and create our own.</span>
<a href="#l5.196"></a><span id="l5.196" class="difflineplus">+  gServer.stop(mc);</span>
<a href="#l5.197"></a><span id="l5.197" class="difflineplus">+  gServer = new MockYouSendItServer();</span>
<a href="#l5.198"></a><span id="l5.198" class="difflineplus">+  // Replace the auth component with one that counts auth</span>
<a href="#l5.199"></a><span id="l5.199" class="difflineplus">+  // requests.</span>
<a href="#l5.200"></a><span id="l5.200" class="difflineplus">+  gServer.auth = new MockYouSendItAuthCounter(gServer);</span>
<a href="#l5.201"></a><span id="l5.201" class="difflineplus">+  // Replace the deleter component with one that returns the</span>
<a href="#l5.202"></a><span id="l5.202" class="difflineplus">+  // stale token error.</span>
<a href="#l5.203"></a><span id="l5.203" class="difflineplus">+  gServer.deleter = new MockYouSendItDeleterStaleToken(gServer);</span>
<a href="#l5.204"></a><span id="l5.204" class="difflineplus">+  // Fire up the server.</span>
<a href="#l5.205"></a><span id="l5.205" class="difflineplus">+  gServer.init();</span>
<a href="#l5.206"></a><span id="l5.206" class="difflineplus">+  gServer.start();</span>
<a href="#l5.207"></a><span id="l5.207" class="difflineplus">+</span>
<a href="#l5.208"></a><span id="l5.208" class="difflineplus">+  gServer.setupUser({email: kUserEmail});</span>
<a href="#l5.209"></a><span id="l5.209" class="difflineplus">+</span>
<a href="#l5.210"></a><span id="l5.210" class="difflineplus">+  // We're testing to make sure that we refresh on stale tokens</span>
<a href="#l5.211"></a><span id="l5.211" class="difflineplus">+  // iff a password has been remembered for the user, so make</span>
<a href="#l5.212"></a><span id="l5.212" class="difflineplus">+  // sure we remember a password...</span>
<a href="#l5.213"></a><span id="l5.213" class="difflineplus">+  remember_ysi_credentials(kUserEmail, &quot;somePassword&quot;);</span>
<a href="#l5.214"></a><span id="l5.214" class="difflineplus">+</span>
<a href="#l5.215"></a><span id="l5.215" class="difflineplus">+  // Get a prepared provider...</span>
<a href="#l5.216"></a><span id="l5.216" class="difflineplus">+  let provider = gServer.getPreparedBackend(&quot;someAccountKey&quot;);</span>
<a href="#l5.217"></a><span id="l5.217" class="difflineplus">+  let file = getFile(&quot;./data/&quot; + kFilename, __file__);</span>
<a href="#l5.218"></a><span id="l5.218" class="difflineplus">+  gServer.planForUploadFile(kFilename);</span>
<a href="#l5.219"></a><span id="l5.219" class="difflineplus">+  let requestObserver = gObsManager.create(&quot;test_delete_refreshes_stale_token - upload 1&quot;);</span>
<a href="#l5.220"></a><span id="l5.220" class="difflineplus">+  provider.uploadFile(file, requestObserver);</span>
<a href="#l5.221"></a><span id="l5.221" class="difflineplus">+  mc.waitFor(function() requestObserver.success);</span>
<a href="#l5.222"></a><span id="l5.222" class="difflineplus">+</span>
<a href="#l5.223"></a><span id="l5.223" class="difflineplus">+  // At this point, we should not have seen any auth attempts.</span>
<a href="#l5.224"></a><span id="l5.224" class="difflineplus">+  assert_equals(gServer.auth.count, 0,</span>
<a href="#l5.225"></a><span id="l5.225" class="difflineplus">+                &quot;Should not have seen any authorization attempts &quot;</span>
<a href="#l5.226"></a><span id="l5.226" class="difflineplus">+                + &quot;yet&quot;);</span>
<a href="#l5.227"></a><span id="l5.227" class="difflineplus">+</span>
<a href="#l5.228"></a><span id="l5.228" class="difflineplus">+  // Now delete the file, and get the stale auth token warning.</span>
<a href="#l5.229"></a><span id="l5.229" class="difflineplus">+  gServer.planForDeleteFile(kFilename);</span>
<a href="#l5.230"></a><span id="l5.230" class="difflineplus">+  // We have to pass an observer, so we'll just generate a dummy one.</span>
<a href="#l5.231"></a><span id="l5.231" class="difflineplus">+  let deleteObserver = new SimpleRequestObserver();</span>
<a href="#l5.232"></a><span id="l5.232" class="difflineplus">+  provider.deleteFile(file, deleteObserver);</span>
<a href="#l5.233"></a><span id="l5.233" class="difflineplus">+</span>
<a href="#l5.234"></a><span id="l5.234" class="difflineplus">+  // Now, since the token was stale, we should see us hit authentication</span>
<a href="#l5.235"></a><span id="l5.235" class="difflineplus">+  // again.</span>
<a href="#l5.236"></a><span id="l5.236" class="difflineplus">+  mc.waitFor(function() gServer.auth.count &gt; 0,</span>
<a href="#l5.237"></a><span id="l5.237" class="difflineplus">+             &quot;Timed out waiting for authorization attempt&quot;);</span>
<a href="#l5.238"></a><span id="l5.238" class="difflineplus">+}</span>
<a href="#l5.239"></a><span id="l5.239" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">new file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- /dev/null</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ b/mail/test/mozmill/cloudfile/test-cloudfile-manager.js</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -0,0 +1,114 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineplus">+ * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineplus">+</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineplus">+/**</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineplus">+ * Tests the richlistbox in the manager for attachment storage</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineplus">+ * services</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+ */</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+let Cu = Components.utils;</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+let Cc = Components.classes;</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+let Ci = Components.interfaces;</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+let MODULE_NAME = 'test-cloudfile-manager';</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+let RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+let MODULE_REQUIRES = ['folder-display-helpers',</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+                       'pref-window-helpers',</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+                       'window-helpers'];</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+Cu.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+const kTestAccountType = &quot;mock&quot;;</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+var cfh;</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+function setupModule(module) {</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+  fdh.installInto(module);</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+  let pwh = collector.getModule('pref-window-helpers');</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+  pwh.installInto(module);</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+  cfh = collector.getModule('cloudfile-helpers');</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+  cfh.installInto(module);</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+  cfh.gMockCloudfileManager.register();</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+  let wh = collector.getModule('window-helpers');</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+  wh.installInto(module);</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+  // Let's set up a few dummy accounts;</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+  create_dummy_account(&quot;someKey1&quot;, kTestAccountType,</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+                       &quot;carl's Account&quot;);</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+  create_dummy_account(&quot;someKey2&quot;, kTestAccountType,</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+                       &quot;Amber's Account&quot;);</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+  create_dummy_account(&quot;someKey3&quot;, kTestAccountType,</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+                       &quot;alice's Account&quot;);</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+  create_dummy_account(&quot;someKey4&quot;, kTestAccountType,</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+                       &quot;Bob's Account&quot;);</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+};</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+function teardownModule(module) {</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+  Services.prefs.QueryInterface(Ci.nsIPrefBranch)</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+          .deleteBranch(&quot;mail.cloud_files.accounts&quot;);</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+  cfh.gMockCloudfileManager.unregister();</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+}</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineplus">+</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+function create_dummy_account(aKey, aType, aDisplayName) {</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+  Services.prefs.setCharPref(&quot;mail.cloud_files.accounts.&quot; + aKey + &quot;.type&quot;,</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+                             aType);</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineplus">+</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+  Services.prefs.setCharPref(&quot;mail.cloud_files.accounts.&quot; + aKey + &quot;.displayName&quot;,</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+                             aDisplayName);</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+}</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+function destroy_account(aKey) {</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+  Services.prefs.clearUserPref(&quot;mail.cloud_files.accounts.&quot; + aKey);</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+}</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+/**</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+ * A helper function to open the preferences dialog and switch</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineplus">+ * to the attachments pane.</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineplus">+ *</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineplus">+ * @param aCallback the function to execute once we've switched</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineplus">+ *                  to the attachment pane.  This function takes</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineplus">+ *                  precisely one argument, which is the</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineplus">+ *                  augmented controller for the preferences</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineplus">+ *                  window.</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineplus">+ */</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineplus">+function open_cloudfile_manager(aCallback) {</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineplus">+  open_pref_window(&quot;paneApplications&quot;, function(w) {</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineplus">+    let tabbox = w.e(&quot;attachmentPrefs&quot;);</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineplus">+    tabbox.selectedIndex = 1;</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineplus">+    aCallback(w);</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineplus">+    close_window(w);</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineplus">+  });</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineplus">+}</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineplus">+</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineplus">+/**</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineplus">+ * Tests that we load the accounts and display them in the</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineplus">+ * account richlistbox in the correct order (by displayName,</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineplus">+ * case-insensitive)</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineplus">+ */</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineplus">+function test_load_accounts_and_properly_order() {</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineplus">+  open_cloudfile_manager(function(w) {</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineplus">+    let richList = w.e(&quot;cloudFileView&quot;);</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineplus">+    assert_equals(4, richList.itemCount,</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineplus">+                  &quot;Should be displaying 4 accounts&quot;);</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineplus">+</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineplus">+    // Since we're sorting alphabetically by the displayName,</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineplus">+    // case-insensitive, the items should be ordered with the</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineplus">+    // following accountKeys:</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineplus">+    //</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineplus">+    // someKey3, someKey2, someKey4, someKey1</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineplus">+    const kExpected = [&quot;someKey3&quot;, &quot;someKey2&quot;, &quot;someKey4&quot;,</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineplus">+                       &quot;someKey1&quot;];</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineplus">+</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineplus">+    for (let [index, expectedKey] in Iterator(kExpected)) {</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineplus">+      let item = richList.getItemAtIndex(index);</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineplus">+      assert_equals(expectedKey, item.value,</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineplus">+                    &quot;The account list is out of order&quot;);</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineplus">+    }</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineplus">+  });</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">new file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- /dev/null</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ b/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -0,0 +1,114 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineplus">+  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineplus">+</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineplus">+/**</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineplus">+ * Tests the get an account workflow.</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineplus">+ */</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+let Cu = Components.utils;</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+let Cc = Components.classes;</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+let Ci = Components.interfaces;</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+let MODULE_NAME = 'test-cloudfile-notifications';</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+let RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+let MODULE_REQUIRES = ['folder-display-helpers',</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+                       'compose-helpers'];</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+let controller = {};</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+let mozmill = {};</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+let elib = {};</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+Cu.import('resource://mozmill/modules/controller.js', controller);</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+Cu.import('resource://mozmill/modules/mozmill.js', mozmill);</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+Cu.import('resource://mozmill/modules/elementslib.js', elib);</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+Cu.import('resource://gre/modules/Services.jsm');</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+let maxSize;</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+function setupModule(module) {</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+  fdh.installInto(module);</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+  let ch = collector.getModule('compose-helpers');</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+  ch.installInto(module);</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+  maxSize = Services.prefs</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+                    .getIntPref(&quot;mail.compose.big_attachments.threshold_kb&quot;,</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+                                0) * 1024;</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+};</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+function assert_cloudfile_notification_displayed(aController, aDisplayed) {</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+  let nb = aController.window</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+                      .document</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+                      .getElementById(&quot;attachmentNotificationBox&quot;);</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+  let hasNotification = false;</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+  if (nb.getNotificationWithValue(&quot;bigAttachment&quot;))</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+    hasNotification = true;</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+  assert_equals(hasNotification, aDisplayed,</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+                &quot;Expected the notification to be &quot; +</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+                (aDisplayed ? &quot;shown&quot; : &quot;not shown&quot;));</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+}</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+function test_no_notification_for_small_file() {</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+  let cwc = open_compose_new_mail(mc);</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+  add_attachments(cwc, &quot;http://www.example.com/1&quot;, 0);</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+  assert_cloudfile_notification_displayed(cwc, false);</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+  add_attachments(cwc, &quot;http://www.example.com/2&quot;, 1);</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+  assert_cloudfile_notification_displayed(cwc, false);</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+  add_attachments(cwc, &quot;http://www.example.com/3&quot;, 100);</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+  assert_cloudfile_notification_displayed(cwc, false);</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+  add_attachments(cwc, &quot;http://www.example.com/4&quot;, 500);</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+  assert_cloudfile_notification_displayed(cwc, false);</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+}</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+function test_notification_for_big_files() {</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+  let cwc = open_compose_new_mail(mc);</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+  add_attachments(cwc, &quot;http://www.example.com/1&quot;, maxSize);</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+  assert_cloudfile_notification_displayed(cwc, true);</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+  add_attachments(cwc, &quot;http://www.example.com/2&quot;, maxSize + 1000);</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+  assert_cloudfile_notification_displayed(cwc, true);</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineplus">+  add_attachments(cwc, &quot;http://www.example.com/3&quot;, maxSize + 10000);</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineplus">+  assert_cloudfile_notification_displayed(cwc, true);</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineplus">+</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+  add_attachments(cwc, &quot;http://www.example.com/4&quot;, maxSize + 100000);</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+  assert_cloudfile_notification_displayed(cwc, true);</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+}</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+function test_graduate_to_notification() {</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+  let cwc = open_compose_new_mail(mc);</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+  add_attachments(cwc, &quot;http://www.example.com/1&quot;, maxSize - 100);</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+  assert_cloudfile_notification_displayed(cwc, false);</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+  add_attachments(cwc, &quot;http://www.example.com/2&quot;, maxSize - 25);</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+  assert_cloudfile_notification_displayed(cwc, false);</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineplus">+  add_attachments(cwc, &quot;http://www.example.com/3&quot;, maxSize);</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+  assert_cloudfile_notification_displayed(cwc, true);</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+}</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineplus">+function test_no_notification_if_disabled() {</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineplus">+  let cwc = open_compose_new_mail(mc);</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineplus">+</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.cloud_files.enabled&quot;, false);</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineplus">+  add_attachments(cwc, &quot;http://www.example.com/1&quot;, maxSize);</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineplus">+  assert_cloudfile_notification_displayed(cwc, false);</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineplus">+</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineplus">+  add_attachments(cwc, &quot;http://www.example.com/2&quot;, maxSize + 1000);</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineplus">+  assert_cloudfile_notification_displayed(cwc, false);</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+  add_attachments(cwc, &quot;http://www.example.com/3&quot;, maxSize + 10000);</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+  assert_cloudfile_notification_displayed(cwc, false);</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineplus">+</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineplus">+  add_attachments(cwc, &quot;http://www.example.com/4&quot;, maxSize + 100000);</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+  assert_cloudfile_notification_displayed(cwc, false);</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineplus">+</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.cloud_files.enabled&quot;, true);</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/test/mozmill/mozmilltests.list</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/test/mozmill/mozmilltests.list</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1,11 +1,12 @@</span>
<a href="#l8.4"></a><span id="l8.4"> account</span>
<a href="#l8.5"></a><span id="l8.5"> addrbook</span>
<a href="#l8.6"></a><span id="l8.6"> attachment</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineplus">+cloudfile</span>
<a href="#l8.8"></a><span id="l8.8"> composition</span>
<a href="#l8.9"></a><span id="l8.9"> content-policy</span>
<a href="#l8.10"></a><span id="l8.10"> content-tabs</span>
<a href="#l8.11"></a><span id="l8.11"> cookies</span>
<a href="#l8.12"></a><span id="l8.12"> folder-display</span>
<a href="#l8.13"></a><span id="l8.13"> folder-pane</span>
<a href="#l8.14"></a><span id="l8.14"> folder-tree-modes</span>
<a href="#l8.15"></a><span id="l8.15"> folder-widget</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">new file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- /dev/null</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ b/mail/test/mozmill/pref-window/test-attachments-pane.js</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -0,0 +1,71 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineplus">+  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineplus">+</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineplus">+/**</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineplus">+ * Tests the manager for attachment storage services</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineplus">+ */</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+let Cu = Components.utils;</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+let Cc = Components.classes;</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+let Ci = Components.interfaces;</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+let MODULE_NAME = 'test-attachments-pane';</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+let RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+let MODULE_REQUIRES = ['folder-display-helpers',</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+                       'pref-window-helpers',</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+                       'window-helpers'];</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+function setupModule(module) {</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineplus">+  fdh.installInto(module);</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineplus">+  let pwh = collector.getModule('pref-window-helpers');</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineplus">+  pwh.installInto(module);</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+  let wh = collector.getModule('window-helpers');</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+  wh.installInto(module);</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+};</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineplus">+/**</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+ * Test that if we come back to the Attachment pane, then</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+ * we'll automatically be viewing the same tab we were viewing</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+ * last time.</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+ */</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+function test_persist_tabs() {</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+  open_pref_window(&quot;paneApplications&quot;, function(w) {</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+    let tabbox = w.e(&quot;attachmentPrefs&quot;);</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+    // We should default to be viewing the first tab</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+    assert_equals(0, tabbox.selectedIndex,</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+                  &quot;The first tab should have been selected&quot;);</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+    // Switch to the second tab</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+    tabbox.selectedIndex = 1;</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+    close_window(w);</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+  });</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+  open_pref_window(&quot;paneApplications&quot;, function(w) {</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+    let tabbox = w.e(&quot;attachmentPrefs&quot;);</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+    // We should default to be viewing the second tab</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineplus">+    // now</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+    assert_equals(1, tabbox.selectedIndex,</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+                  &quot;The second tab selection should have been &quot;</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+                  + &quot;persisted&quot;);</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineplus">+    // Switch back to the first tab</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+    tabbox.selectedIndex = 0;</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineplus">+    close_window(w);</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineplus">+  });</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineplus">+</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+  open_pref_window(&quot;paneApplications&quot;, function(w) {</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineplus">+    let tabbox = w.e(&quot;attachmentPrefs&quot;);</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineplus">+</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineplus">+    // We should default to be viewing the first tab</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineplus">+    assert_equals(0, tabbox.selectedIndex,</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineplus">+                  &quot;The first tab selection should have been &quot;</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineplus">+                  + &quot;persisted&quot;);</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineplus">+    close_window(w);</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineplus">+  });</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineplus">+</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-attachment-helpers.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-attachment-helpers.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -35,30 +35,96 @@</span>
<a href="#l10.4"></a><span id="l10.4">  *</span>
<a href="#l10.5"></a><span id="l10.5">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l10.6"></a><span id="l10.6"> </span>
<a href="#l10.7"></a><span id="l10.7"> var Ci = Components.interfaces;</span>
<a href="#l10.8"></a><span id="l10.8"> var Cc = Components.classes;</span>
<a href="#l10.9"></a><span id="l10.9"> var Cu = Components.utils;</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11"> const MODULE_NAME = &quot;attachment-helpers&quot;;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+const RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+const MODULE_REQUIRES = ['mock-object-helpers'];</span>
<a href="#l10.14"></a><span id="l10.14"> </span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-const RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">-const MODULE_REQUIRES = [];</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+Cu.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+let gMockFilePickReg;</span>
<a href="#l10.20"></a><span id="l10.20"> </span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">-function setupModule() {</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+function setupModule(module) {</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+  let moh = collector.getModule('mock-object-helpers');</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+  gMockFilePickReg = new moh.MockObjectReplacer(&quot;@mozilla.org/filepicker;1&quot;,</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineplus">+                                                  MockFilePickerConstructor);</span>
<a href="#l10.27"></a><span id="l10.27"> }</span>
<a href="#l10.28"></a><span id="l10.28"> </span>
<a href="#l10.29"></a><span id="l10.29"> function installInto(module) {</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">-  setupModule();</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+  setupModule(module);</span>
<a href="#l10.32"></a><span id="l10.32"> </span>
<a href="#l10.33"></a><span id="l10.33">   // Now copy helper functions</span>
<a href="#l10.34"></a><span id="l10.34">   module.create_body_part = create_body_part;</span>
<a href="#l10.35"></a><span id="l10.35">   module.create_detached_attachment = create_detached_attachment;</span>
<a href="#l10.36"></a><span id="l10.36">   module.create_deleted_attachment = create_deleted_attachment;</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+  module.gMockFilePickReg = gMockFilePickReg;</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+  module.gMockFilePicker = gMockFilePicker;</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+}</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+function MockFilePickerConstructor() {</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+  return gMockFilePicker;</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+};</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+let gMockFilePicker = {</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineplus">+  QueryInterface: XPCOMUtils.generateQI([Ci.nsIFilePicker]),</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineplus">+  defaultExtension: &quot;&quot;,</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+  filterIndex: null,</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+  displayDirectory: null,</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+  returnFiles: [],</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+  addToRecentDocs: false,</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+  get defaultString() {</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineplus">+    throw Cr.NS_ERROR_FAILURE;</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+  },</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineplus">+</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineplus">+  get fileURL() {</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineplus">+    return null;</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineplus">+  },</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineplus">+</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+  get file() {</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+    if (this.returnFiles.length &gt;= 1)</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineplus">+      return this.returnFiles[0];</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineplus">+    return null;</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineplus">+  },</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineplus">+</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineplus">+  get files() {</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineplus">+    let self = this;</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineplus">+    return {</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineplus">+      index: 0,</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineplus">+      QueryInterface: XPCOMUtils.generateQI([Ci.nsISimpleEnumerator]),</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineplus">+      hasMoreElements: function() {</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineplus">+        return this.index &lt; self.returnFiles.length;</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineplus">+      },</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineplus">+      getNext: function() {</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineplus">+        return self.returnFiles[this.index++];</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineplus">+      }</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineplus">+    }</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineplus">+  },</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineplus">+</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineplus">+  init: function gMFP_init(aParent, aTitle, aMode) {</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineplus">+  },</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineplus">+</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineplus">+  appendFilters: function gMFP_appendFilters(aFilterMask) {</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineplus">+  },</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineplus">+</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineplus">+  appendFilter: function gMFP_appendFilter(aTitle, aFilter) {</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineplus">+  },</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineplus">+</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineplus">+  show: function gMFP_show() {</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineplus">+    return Ci.nsIFilePicker.returnOK;</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineplus">+  },</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineplus">+</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineplus">+  set defaultString(aVal) {</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineplus">+  },</span>
<a href="#l10.96"></a><span id="l10.96"> }</span>
<a href="#l10.97"></a><span id="l10.97"> </span>
<a href="#l10.98"></a><span id="l10.98"> /**</span>
<a href="#l10.99"></a><span id="l10.99">  * Create a body part with attachments for the message generator</span>
<a href="#l10.100"></a><span id="l10.100">  *</span>
<a href="#l10.101"></a><span id="l10.101">  * @param body the text of the main body of the message</span>
<a href="#l10.102"></a><span id="l10.102">  * @param attachments an array of attachment objects (as strings)</span>
<a href="#l10.103"></a><span id="l10.103">  * @param boundary an optional string defining the boundary of the parts</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">new file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- /dev/null</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-cloudfile-backend-helpers.js</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -0,0 +1,81 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineplus">+ * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineplus">+</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineplus">+let Cu = Components.utils;</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineplus">+let Cc = Components.classes;</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineplus">+let Ci = Components.interfaces;</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+const MODULE_NAME = 'cloudfile-backend-helpers';</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+const RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+const MODULE_REQUIRES = ['folder-display-helpers'];</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+const kUserAuthRequested = &quot;cloudfile:auth&quot;;</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+const kUserDataRequested = &quot;cloudfile:user&quot;;</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+const kUploadFile = &quot;cloudfile:uploadFile&quot;;</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+const kGetFileURL = &quot;cloudfile:getFileURL&quot;;</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+const kDeleteFile = &quot;cloudfile:deleteFile&quot;;</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+Cu.import('resource://mozmill/stdlib/os.js', os);</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+Cu.import('resource://gre/modules/XPCOMUtils.jsm');</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineplus">+var fdh;</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineplus">+</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineplus">+function installInto(module) {</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+  setupModule(module);</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+  module.kUserAuthRequested = kUserAuthRequested;</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+  module.kUserDataRequested = kUserDataRequested;</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+  module.kUploadFile = kUploadFile;</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+  module.kGetFileURL = kGetFileURL;</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+  module.kDeleteFile = kDeleteFile;</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+  module.SimpleRequestObserverManager = SimpleRequestObserverManager;</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+  module.SimpleRequestObserver = SimpleRequestObserver;</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineplus">+}</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+function setupModule(module) {</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+  fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+}</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+function SimpleRequestObserverManager() {</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineplus">+  this._observers = [];</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+}</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineplus">+</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+SimpleRequestObserverManager.prototype = {</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineplus">+  create: function(aName) {</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineplus">+    let obs = new SimpleRequestObserver(aName);</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+    this._observers.push(obs);</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineplus">+    return obs;</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+  },</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineplus">+</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+  check: function() {</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineplus">+    for each (let [, observer] in Iterator(this._observers)) {</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+      if (!observer.success)</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineplus">+        throw new Error(&quot;An observer named &quot; + observer.name + &quot; was leftover, &quot;</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineplus">+                        + &quot;with its success attribute set to: &quot;</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineplus">+                        + observer.success);</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineplus">+    }</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineplus">+  },</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineplus">+</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineplus">+  reset: function() {</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineplus">+    this._observers = [];</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+  }</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineplus">+}</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineplus">+</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineplus">+function SimpleRequestObserver(aName) {</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineplus">+  this.name = aName;</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+};</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineplus">+SimpleRequestObserver.prototype = {</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineplus">+  success: null,</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineplus">+  onStartRequest: function(aRequest, aContext) {},</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineplus">+  onStopRequest: function(aRequest, aContext, aStatusCode) {</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineplus">+    if (Components.isSuccessCode(aStatusCode)) {</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineplus">+      this.success = true;</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineplus">+    } else {</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineplus">+      this.success = false;</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineplus">+    }</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineplus">+  },</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineplus">+  QueryInterface: XPCOMUtils.generateQI([Ci.nsIRequestObserver,</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineplus">+                                         Ci.nsISupportsWeakReference]),</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">new file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- /dev/null</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-cloudfile-dropbox-helpers.js</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -0,0 +1,273 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineplus">+ * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineplus">+</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineplus">+let Cu = Components.utils;</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineplus">+let Cc = Components.classes;</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineplus">+let Ci = Components.interfaces;</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+const MODULE_NAME = 'cloudfile-dropbox-helpers';</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+const RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+const MODULE_REQUIRES = [];</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+let httpd = {};</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+Cu.import('resource://mozmill/stdlib/httpd.js', httpd);</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+Cu.import('resource://gre/modules/Services.jsm');</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineplus">+const kDefaultServerPort = 4444;</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineplus">+const kServerRoot = &quot;http://localhost:&quot; + kDefaultServerPort;</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+const kServerPath = &quot;/server/&quot;;</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+const kContentPath = &quot;/content/&quot;;</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+const kAuthPath = &quot;/auth/&quot;;</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineplus">+const kServerURL = kServerRoot + kServerPath;</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineplus">+const kContentURL = kServerRoot + kContentPath;</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineplus">+const kAuthURL = kServerRoot + kAuthPath;</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineplus">+const kOAuthTokenPath = &quot;oauth/request_token&quot;;</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+const kOAuthAuthorizePath = &quot;oauth/authorize&quot;;</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+const kOAuthAccessTokenPath = &quot;oauth/access_token&quot;;</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineplus">+const kUserInfoPath = &quot;account/info&quot;;</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+const kPutFilePath = &quot;files_put/sandbox/&quot;;</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+const kSharesPath = &quot;shares/sandbox/&quot;;</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+const kDeletePath = &quot;fileops/delete/&quot;;</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineplus">+</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+const kDefaultConfig = {</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+  port: kDefaultServerPort</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineplus">+}</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineplus">+const kAuthTokenString = &quot;oauth_token=requestkey&amp;oauth_token_secret=requestsecret&quot;;</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+const kDefaultUser = {</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+  referral_link: &quot;https://www.dropbox.com/referrals/r1a2n3d4m5s6t7&quot;,</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+  display_name: &quot;John P. User&quot;,</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+  uid: 12345678,</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+  country: &quot;US&quot;,</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+  quota_info: {</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+    shared: 253738410565,</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+    quota: 107374182400000,</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineplus">+    normal: 680031877871</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineplus">+  },</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineplus">+  email: &quot;john@example.com&quot;</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineplus">+}</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineplus">+const kDefaultFilePutReturn = {</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineplus">+  size: &quot;225.4KB&quot;,</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+  rev: &quot;35e97029684fe&quot;,</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineplus">+  thumb_exists: false,</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineplus">+  bytes: 230783,</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineplus">+  modified: &quot;Tue, 19 Jul 2011 21:55:38 +0000&quot;,</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineplus">+//  path: &quot;/Getting_Started.pdf&quot;,</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineplus">+  is_dir: false,</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineplus">+  icon: &quot;page_white_acrobat&quot;,</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineplus">+  root: &quot;dropbox&quot;,</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineplus">+  mime_type: &quot;application/pdf&quot;,</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineplus">+  revision: 220823</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineplus">+}</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineplus">+</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineplus">+const kDefaultShareReturn = {</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineplus">+  url: &quot;http://db.tt/APqhX1&quot;,</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineplus">+  expires: &quot;Wed, 17 Aug 2011 02:34:33 +0000&quot;</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineplus">+}</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineplus">+</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineplus">+const kDefaultReturnHeader = {</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineplus">+  statusCode: 200,</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineplus">+  statusString: &quot;OK&quot;,</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineplus">+  contentType: &quot;text/plain&quot;,</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+}</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineplus">+const kDefaultDeleteReturn = {</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineplus">+  size: &quot;0 bytes&quot;,</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineplus">+  is_deleted: true,</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineplus">+  bytes: 0,</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineplus">+  thumb_exists: false,</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineplus">+  rev: &quot;1f33043551f&quot;,</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineplus">+  modified: &quot;Wed, 10 Aug 2011 18:21:30 +0000&quot;,</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineplus">+//  path: &quot;/test .txt&quot;,</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineplus">+  is_dir: false,</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineplus">+  icon: &quot;page_white_text&quot;,</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineplus">+  root: &quot;dropbox&quot;,</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineplus">+  mime_type: &quot;text/plain&quot;,</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineplus">+  revision: 492341,</span>
<a href="#l12.95"></a><span id="l12.95" class="difflineplus">+}</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineplus">+</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineplus">+function installInto(module) {</span>
<a href="#l12.98"></a><span id="l12.98" class="difflineplus">+  module.MockDropboxServer = MockDropboxServer;</span>
<a href="#l12.99"></a><span id="l12.99" class="difflineplus">+}</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineplus">+</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineplus">+function MockDropboxServer() {}</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineplus">+</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineplus">+MockDropboxServer.prototype = {</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineplus">+  _server: null,</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineplus">+  _toDelete: [],</span>
<a href="#l12.106"></a><span id="l12.106" class="difflineplus">+</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineplus">+  getPreparedBackend: function MDBS_getPreparedBackend(aAccountKey) {</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineplus">+    let dropbox = Cc[&quot;@mozilla.org/mail/dropbox;1&quot;]</span>
<a href="#l12.109"></a><span id="l12.109" class="difflineplus">+                  .getService(Ci.nsIMsgCloudFileProvider);</span>
<a href="#l12.110"></a><span id="l12.110" class="difflineplus">+</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineplus">+    let urls = [kServerURL, kContentURL, kAuthURL];</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineplus">+    dropbox.overrideUrls(urls.length, urls);</span>
<a href="#l12.113"></a><span id="l12.113" class="difflineplus">+    dropbox.init(aAccountKey);</span>
<a href="#l12.114"></a><span id="l12.114" class="difflineplus">+    return dropbox;</span>
<a href="#l12.115"></a><span id="l12.115" class="difflineplus">+  },</span>
<a href="#l12.116"></a><span id="l12.116" class="difflineplus">+</span>
<a href="#l12.117"></a><span id="l12.117" class="difflineplus">+  init: function MDBS_init(aConfig) {</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineplus">+    this._config = kDefaultConfig;</span>
<a href="#l12.119"></a><span id="l12.119" class="difflineplus">+</span>
<a href="#l12.120"></a><span id="l12.120" class="difflineplus">+    for (let param in aConfig) {</span>
<a href="#l12.121"></a><span id="l12.121" class="difflineplus">+      this._config[param] = aConfig[param];</span>
<a href="#l12.122"></a><span id="l12.122" class="difflineplus">+    }</span>
<a href="#l12.123"></a><span id="l12.123" class="difflineplus">+</span>
<a href="#l12.124"></a><span id="l12.124" class="difflineplus">+    this._server = httpd.getServer(this._config.port, '');</span>
<a href="#l12.125"></a><span id="l12.125" class="difflineplus">+    this._wireOAuth();</span>
<a href="#l12.126"></a><span id="l12.126" class="difflineplus">+    this._wireDeleter();</span>
<a href="#l12.127"></a><span id="l12.127" class="difflineplus">+  },</span>
<a href="#l12.128"></a><span id="l12.128" class="difflineplus">+</span>
<a href="#l12.129"></a><span id="l12.129" class="difflineplus">+  start: function MDBS_start() {</span>
<a href="#l12.130"></a><span id="l12.130" class="difflineplus">+    this._server.start(this._config.port);</span>
<a href="#l12.131"></a><span id="l12.131" class="difflineplus">+  },</span>
<a href="#l12.132"></a><span id="l12.132" class="difflineplus">+</span>
<a href="#l12.133"></a><span id="l12.133" class="difflineplus">+  stop: function MDBS_stop(aController) {</span>
<a href="#l12.134"></a><span id="l12.134" class="difflineplus">+    let allDone = false;</span>
<a href="#l12.135"></a><span id="l12.135" class="difflineplus">+    this._server.stop(function() {</span>
<a href="#l12.136"></a><span id="l12.136" class="difflineplus">+      allDone = true;</span>
<a href="#l12.137"></a><span id="l12.137" class="difflineplus">+    });</span>
<a href="#l12.138"></a><span id="l12.138" class="difflineplus">+    aController.waitFor(function () allDone,</span>
<a href="#l12.139"></a><span id="l12.139" class="difflineplus">+                        &quot;Timed out waiting for Dropbox server to stop!&quot;);</span>
<a href="#l12.140"></a><span id="l12.140" class="difflineplus">+  },</span>
<a href="#l12.141"></a><span id="l12.141" class="difflineplus">+</span>
<a href="#l12.142"></a><span id="l12.142" class="difflineplus">+  setupUser: function MDBS_wireUser(aData) {</span>
<a href="#l12.143"></a><span id="l12.143" class="difflineplus">+    aData = this._overrideDefault(kDefaultUser, aData);</span>
<a href="#l12.144"></a><span id="l12.144" class="difflineplus">+</span>
<a href="#l12.145"></a><span id="l12.145" class="difflineplus">+    let userFunc = this._noteAndReturnString(&quot;cloudfile:user&quot;, &quot;&quot;,</span>
<a href="#l12.146"></a><span id="l12.146" class="difflineplus">+                                             JSON.stringify(aData));</span>
<a href="#l12.147"></a><span id="l12.147" class="difflineplus">+</span>
<a href="#l12.148"></a><span id="l12.148" class="difflineplus">+    this._server.registerPathHandler(kServerPath + kUserInfoPath,</span>
<a href="#l12.149"></a><span id="l12.149" class="difflineplus">+                                     userFunc);</span>
<a href="#l12.150"></a><span id="l12.150" class="difflineplus">+  },</span>
<a href="#l12.151"></a><span id="l12.151" class="difflineplus">+</span>
<a href="#l12.152"></a><span id="l12.152" class="difflineplus">+  planForUploadFile: function MDBS_planForUploadFile(aFileName, aData) {</span>
<a href="#l12.153"></a><span id="l12.153" class="difflineplus">+    let data = kDefaultFilePutReturn;</span>
<a href="#l12.154"></a><span id="l12.154" class="difflineplus">+    data.path = aFileName;</span>
<a href="#l12.155"></a><span id="l12.155" class="difflineplus">+    aData = this._overrideDefault(data, aData);</span>
<a href="#l12.156"></a><span id="l12.156" class="difflineplus">+</span>
<a href="#l12.157"></a><span id="l12.157" class="difflineplus">+    let putFileFunc = this._noteAndReturnString(&quot;cloudfile:uploadFile&quot;,</span>
<a href="#l12.158"></a><span id="l12.158" class="difflineplus">+                                                aFileName,</span>
<a href="#l12.159"></a><span id="l12.159" class="difflineplus">+                                                JSON.stringify(aData));</span>
<a href="#l12.160"></a><span id="l12.160" class="difflineplus">+    this._server.registerPathHandler(kContentPath + kPutFilePath + aFileName,</span>
<a href="#l12.161"></a><span id="l12.161" class="difflineplus">+                                     putFileFunc);</span>
<a href="#l12.162"></a><span id="l12.162" class="difflineplus">+  },</span>
<a href="#l12.163"></a><span id="l12.163" class="difflineplus">+</span>
<a href="#l12.164"></a><span id="l12.164" class="difflineplus">+  planForGetFileURL: function MDBS_planForGetShare(aFileName, aData) {</span>
<a href="#l12.165"></a><span id="l12.165" class="difflineplus">+    aData = this._overrideDefault(kDefaultShareReturn, aData);</span>
<a href="#l12.166"></a><span id="l12.166" class="difflineplus">+</span>
<a href="#l12.167"></a><span id="l12.167" class="difflineplus">+    let getShareFunc = this._noteAndReturnString(&quot;cloudfile:getFileURL&quot;,</span>
<a href="#l12.168"></a><span id="l12.168" class="difflineplus">+                                                 aFileName,</span>
<a href="#l12.169"></a><span id="l12.169" class="difflineplus">+                                                 JSON.stringify(aData));</span>
<a href="#l12.170"></a><span id="l12.170" class="difflineplus">+    this._server.registerPathHandler(kServerPath + kSharesPath + aFileName,</span>
<a href="#l12.171"></a><span id="l12.171" class="difflineplus">+                                     getShareFunc);</span>
<a href="#l12.172"></a><span id="l12.172" class="difflineplus">+  },</span>
<a href="#l12.173"></a><span id="l12.173" class="difflineplus">+</span>
<a href="#l12.174"></a><span id="l12.174" class="difflineplus">+  planForDeleteFile: function MDBS_planForDeleteFile(aFilename) {</span>
<a href="#l12.175"></a><span id="l12.175" class="difflineplus">+    this._toDelete.push(aFilename);</span>
<a href="#l12.176"></a><span id="l12.176" class="difflineplus">+  },</span>
<a href="#l12.177"></a><span id="l12.177" class="difflineplus">+</span>
<a href="#l12.178"></a><span id="l12.178" class="difflineplus">+  _wireDeleter: function MDBS__wireDeleter() {</span>
<a href="#l12.179"></a><span id="l12.179" class="difflineplus">+    this._server.registerPathHandler(kServerPath + kDeletePath,</span>
<a href="#l12.180"></a><span id="l12.180" class="difflineplus">+                                     this._delete.bind(this));</span>
<a href="#l12.181"></a><span id="l12.181" class="difflineplus">+  },</span>
<a href="#l12.182"></a><span id="l12.182" class="difflineplus">+</span>
<a href="#l12.183"></a><span id="l12.183" class="difflineplus">+  _delete: function MDBS__delete(aRequest, aResponse) {</span>
<a href="#l12.184"></a><span id="l12.184" class="difflineplus">+    // Extract the query params</span>
<a href="#l12.185"></a><span id="l12.185" class="difflineplus">+    let params = parseQueryString(aRequest.queryString);</span>
<a href="#l12.186"></a><span id="l12.186" class="difflineplus">+    let pathIndex = this._toDelete.indexOf(params.path);</span>
<a href="#l12.187"></a><span id="l12.187" class="difflineplus">+</span>
<a href="#l12.188"></a><span id="l12.188" class="difflineplus">+    if (pathIndex == -1) {</span>
<a href="#l12.189"></a><span id="l12.189" class="difflineplus">+      aResponse.setStatusLine(null, 500, &quot;Bad request&quot;);</span>
<a href="#l12.190"></a><span id="l12.190" class="difflineplus">+      aResponse.write(&quot;Was not prepared to delete a file at path: &quot;</span>
<a href="#l12.191"></a><span id="l12.191" class="difflineplus">+                      + params.path);</span>
<a href="#l12.192"></a><span id="l12.192" class="difflineplus">+      return;</span>
<a href="#l12.193"></a><span id="l12.193" class="difflineplus">+    }</span>
<a href="#l12.194"></a><span id="l12.194" class="difflineplus">+</span>
<a href="#l12.195"></a><span id="l12.195" class="difflineplus">+    this._toDelete.splice(pathIndex, 1);</span>
<a href="#l12.196"></a><span id="l12.196" class="difflineplus">+</span>
<a href="#l12.197"></a><span id="l12.197" class="difflineplus">+    Services.obs.notifyObservers(null, &quot;cloudfile:deleteFile&quot;,</span>
<a href="#l12.198"></a><span id="l12.198" class="difflineplus">+                                 params.path);</span>
<a href="#l12.199"></a><span id="l12.199" class="difflineplus">+</span>
<a href="#l12.200"></a><span id="l12.200" class="difflineplus">+    let data = kDefaultDeleteReturn;</span>
<a href="#l12.201"></a><span id="l12.201" class="difflineplus">+    data.path = params.path;</span>
<a href="#l12.202"></a><span id="l12.202" class="difflineplus">+</span>
<a href="#l12.203"></a><span id="l12.203" class="difflineplus">+    aResponse.setStatusLine(null, 200, &quot;OK&quot;);</span>
<a href="#l12.204"></a><span id="l12.204" class="difflineplus">+    aResponse.setHeader(&quot;Content-Type&quot;, &quot;text/plain&quot;);</span>
<a href="#l12.205"></a><span id="l12.205" class="difflineplus">+    aResponse.write(JSON.stringify(data));</span>
<a href="#l12.206"></a><span id="l12.206" class="difflineplus">+  },</span>
<a href="#l12.207"></a><span id="l12.207" class="difflineplus">+</span>
<a href="#l12.208"></a><span id="l12.208" class="difflineplus">+  _noteAndReturnString: function MDBS__noteAndReturnString(aKey, aValue,</span>
<a href="#l12.209"></a><span id="l12.209" class="difflineplus">+                                                           aString,</span>
<a href="#l12.210"></a><span id="l12.210" class="difflineplus">+                                                           aOptions) {</span>
<a href="#l12.211"></a><span id="l12.211" class="difflineplus">+</span>
<a href="#l12.212"></a><span id="l12.212" class="difflineplus">+    aOptions = this._overrideDefault(kDefaultReturnHeader, aOptions);</span>
<a href="#l12.213"></a><span id="l12.213" class="difflineplus">+    let self = this;</span>
<a href="#l12.214"></a><span id="l12.214" class="difflineplus">+</span>
<a href="#l12.215"></a><span id="l12.215" class="difflineplus">+    let subjectString = Cc[&quot;@mozilla.org/supports-string;1&quot;]</span>
<a href="#l12.216"></a><span id="l12.216" class="difflineplus">+                        .createInstance(Ci.nsISupportsString);</span>
<a href="#l12.217"></a><span id="l12.217" class="difflineplus">+    subjectString.data = aString;</span>
<a href="#l12.218"></a><span id="l12.218" class="difflineplus">+</span>
<a href="#l12.219"></a><span id="l12.219" class="difflineplus">+    let func = function(aMeta, aResponse) {</span>
<a href="#l12.220"></a><span id="l12.220" class="difflineplus">+      try {</span>
<a href="#l12.221"></a><span id="l12.221" class="difflineplus">+        aResponse.setStatusLine(null, aOptions.statusCode,</span>
<a href="#l12.222"></a><span id="l12.222" class="difflineplus">+                                aOptions.statusString);</span>
<a href="#l12.223"></a><span id="l12.223" class="difflineplus">+        aResponse.setHeader(&quot;Content-Type&quot;, aOptions.contentType);</span>
<a href="#l12.224"></a><span id="l12.224" class="difflineplus">+        aResponse.write(aString);</span>
<a href="#l12.225"></a><span id="l12.225" class="difflineplus">+        Services.obs.notifyObservers(subjectString, aKey, aValue);</span>
<a href="#l12.226"></a><span id="l12.226" class="difflineplus">+      } catch(e) {</span>
<a href="#l12.227"></a><span id="l12.227" class="difflineplus">+        dump(&quot;Failed to generate server response: &quot; + e);</span>
<a href="#l12.228"></a><span id="l12.228" class="difflineplus">+      }</span>
<a href="#l12.229"></a><span id="l12.229" class="difflineplus">+    }</span>
<a href="#l12.230"></a><span id="l12.230" class="difflineplus">+    return func;</span>
<a href="#l12.231"></a><span id="l12.231" class="difflineplus">+  },</span>
<a href="#l12.232"></a><span id="l12.232" class="difflineplus">+</span>
<a href="#l12.233"></a><span id="l12.233" class="difflineplus">+  _overrideDefault: function MDBS__overrideDefault(aDefault, aData) {</span>
<a href="#l12.234"></a><span id="l12.234" class="difflineplus">+    if (aData === undefined)</span>
<a href="#l12.235"></a><span id="l12.235" class="difflineplus">+      return aDefault;</span>
<a href="#l12.236"></a><span id="l12.236" class="difflineplus">+</span>
<a href="#l12.237"></a><span id="l12.237" class="difflineplus">+    for (let param in aDefault) {</span>
<a href="#l12.238"></a><span id="l12.238" class="difflineplus">+      if (param in aData)</span>
<a href="#l12.239"></a><span id="l12.239" class="difflineplus">+        aDefault[param] = aData[param];</span>
<a href="#l12.240"></a><span id="l12.240" class="difflineplus">+    }</span>
<a href="#l12.241"></a><span id="l12.241" class="difflineplus">+    return aDefault;</span>
<a href="#l12.242"></a><span id="l12.242" class="difflineplus">+  },</span>
<a href="#l12.243"></a><span id="l12.243" class="difflineplus">+</span>
<a href="#l12.244"></a><span id="l12.244" class="difflineplus">+  _wireOAuth: function MDBS__wireOAuth() {</span>
<a href="#l12.245"></a><span id="l12.245" class="difflineplus">+    let authFunc = this._noteAndReturnString(&quot;cloudfile:auth&quot;, &quot;&quot;,</span>
<a href="#l12.246"></a><span id="l12.246" class="difflineplus">+                                             kAuthTokenString);</span>
<a href="#l12.247"></a><span id="l12.247" class="difflineplus">+</span>
<a href="#l12.248"></a><span id="l12.248" class="difflineplus">+    this._server.registerPathHandler(kServerPath + kOAuthTokenPath,</span>
<a href="#l12.249"></a><span id="l12.249" class="difflineplus">+                                     authFunc);</span>
<a href="#l12.250"></a><span id="l12.250" class="difflineplus">+    this._server.registerPathHandler(kServerPath + kOAuthAccessTokenPath,</span>
<a href="#l12.251"></a><span id="l12.251" class="difflineplus">+                                     authFunc);</span>
<a href="#l12.252"></a><span id="l12.252" class="difflineplus">+    this._server.registerPathHandler(kAuthPath + kOAuthAuthorizePath,</span>
<a href="#l12.253"></a><span id="l12.253" class="difflineplus">+                                     this._authHandler);</span>
<a href="#l12.254"></a><span id="l12.254" class="difflineplus">+  },</span>
<a href="#l12.255"></a><span id="l12.255" class="difflineplus">+</span>
<a href="#l12.256"></a><span id="l12.256" class="difflineplus">+  _authHandler: function MDBS__authHandler(meta, response) {</span>
<a href="#l12.257"></a><span id="l12.257" class="difflineplus">+    response.setStatusLine(null, 302, &quot;Found&quot;);</span>
<a href="#l12.258"></a><span id="l12.258" class="difflineplus">+    response.setHeader(&quot;Location&quot;, &quot;http://oauthcallback.local/&quot;,</span>
<a href="#l12.259"></a><span id="l12.259" class="difflineplus">+                       false);</span>
<a href="#l12.260"></a><span id="l12.260" class="difflineplus">+  },</span>
<a href="#l12.261"></a><span id="l12.261" class="difflineplus">+}</span>
<a href="#l12.262"></a><span id="l12.262" class="difflineplus">+</span>
<a href="#l12.263"></a><span id="l12.263" class="difflineplus">+function parseQueryString(str)</span>
<a href="#l12.264"></a><span id="l12.264" class="difflineplus">+{</span>
<a href="#l12.265"></a><span id="l12.265" class="difflineplus">+  let paramArray = str.split(&quot;&amp;&quot;);</span>
<a href="#l12.266"></a><span id="l12.266" class="difflineplus">+  let regex = /^([^=]+)=(.*)$/;</span>
<a href="#l12.267"></a><span id="l12.267" class="difflineplus">+  let params = {};</span>
<a href="#l12.268"></a><span id="l12.268" class="difflineplus">+  for (let i = 0; i &lt; paramArray.length; i++)</span>
<a href="#l12.269"></a><span id="l12.269" class="difflineplus">+  {</span>
<a href="#l12.270"></a><span id="l12.270" class="difflineplus">+    let match = regex.exec(paramArray[i]);</span>
<a href="#l12.271"></a><span id="l12.271" class="difflineplus">+    if (!match)</span>
<a href="#l12.272"></a><span id="l12.272" class="difflineplus">+      throw &quot;Bad parameter in queryString!  '&quot; + paramArray[i] + &quot;'&quot;;</span>
<a href="#l12.273"></a><span id="l12.273" class="difflineplus">+    params[decodeURIComponent(match[1])] = decodeURIComponent(match[2]);</span>
<a href="#l12.274"></a><span id="l12.274" class="difflineplus">+  }</span>
<a href="#l12.275"></a><span id="l12.275" class="difflineplus">+</span>
<a href="#l12.276"></a><span id="l12.276" class="difflineplus">+  return params;</span>
<a href="#l12.277"></a><span id="l12.277" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">new file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- /dev/null</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -0,0 +1,121 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineplus">+  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineplus">+</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineplus">+let Cu = Components.utils;</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineplus">+let Cc = Components.classes;</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineplus">+let Ci = Components.interfaces;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+let Cr = Components.results;</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+const MODULE_NAME = 'cloudfile-helpers';</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+const RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+const MODULE_REQUIRES = ['folder-display-helpers'];</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineplus">+const kMockContractID = &quot;@mozilla.org/mail/mockCloudFile;1&quot;;</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+const kMockCID = &quot;614fd1f7-a404-4505-92fd-8b0ceff2f66c&quot;;</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineplus">+const kMockID = &quot;mock&quot;;</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineplus">+</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+const kDefaults = {</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+  type: kMockID,</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineplus">+  displayName: &quot;Mock Storage&quot;,</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineplus">+  iconClass: &quot;chrome://messenger/skin/icons/dropbox.png&quot;,</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineplus">+  accountKey: null,</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+  settingsURL: &quot;&quot;,</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineplus">+  managementURL: &quot;&quot;,</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+};</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+Cu.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+Cu.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+var fdh, gMockCloudfileComponent;</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+function setupModule(module) {</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+  fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+  fdh.installInto(module);</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineplus">+  let moh = collector.getModule(&quot;mock-object-helpers&quot;);</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+  gMockCloudfileComponent = new moh.MockObjectRegisterer(</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+      kMockContractID,</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineplus">+      kMockCID,</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+      MockCloudfileAccount);</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+}</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+function installInto(module) {</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+  setupModule(module);</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+  module.gMockCloudfileManager = gMockCloudfileManager;</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+  module.MockCloudfileAccount = MockCloudfileAccount;</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+  module.getFile = getFile;</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+}</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineplus">+</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineplus">+function getFile(aFilename, aRoot) {</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineplus">+  let path = os.getFileForPath(aRoot);</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineplus">+  let file = os.getFileForPath(os.abspath(aFilename, path));</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+  fdh.assert_true(file.exists, &quot;File &quot; + aFilename + &quot; does not exist.&quot;);</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineplus">+  return file;</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineplus">+}</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineplus">+</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineplus">+function MockCloudfileAccount() {</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineplus">+  for(let someDefault in kDefaults)</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineplus">+    this[someDefault] = kDefaults[someDefault];</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineplus">+}</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineplus">+</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineplus">+MockCloudfileAccount.prototype = {</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineplus">+</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineplus">+  QueryInterface: XPCOMUtils.generateQI([Ci.nsIMsgCloudFileProvider]),</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineplus">+  init: function MCA_init(aAccountKey) {</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineplus">+    this.accountKey = aAccountKey;</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineplus">+  },</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineplus">+</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineplus">+  uploadFile: function(aFile, aListener) {</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineplus">+    aListener.onStartRequest(null, null);</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineplus">+    aListener.onStopRequest(null, null, Cr.NS_OK);</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineplus">+  },</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineplus">+</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineplus">+  urlForFile: function(aFile) {</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineplus">+    return &quot;http://www.example.com/download/someFile&quot;;</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineplus">+  },</span>
<a href="#l13.84"></a><span id="l13.84" class="difflineplus">+</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineplus">+  refreshUserInfo: function(aWithUI, aCallback) {</span>
<a href="#l13.86"></a><span id="l13.86" class="difflineplus">+    aCallback.onStartRequest(null, null);</span>
<a href="#l13.87"></a><span id="l13.87" class="difflineplus">+    aCallback.onStopRequest(null, null, Cr.NS_OK);</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineplus">+  }</span>
<a href="#l13.89"></a><span id="l13.89" class="difflineplus">+};</span>
<a href="#l13.90"></a><span id="l13.90" class="difflineplus">+</span>
<a href="#l13.91"></a><span id="l13.91" class="difflineplus">+</span>
<a href="#l13.92"></a><span id="l13.92" class="difflineplus">+function MockCloudfileController(aAccountKey) {</span>
<a href="#l13.93"></a><span id="l13.93" class="difflineplus">+  this.instances = [];</span>
<a href="#l13.94"></a><span id="l13.94" class="difflineplus">+  this.accountKey = aAccountKey;</span>
<a href="#l13.95"></a><span id="l13.95" class="difflineplus">+}</span>
<a href="#l13.96"></a><span id="l13.96" class="difflineplus">+</span>
<a href="#l13.97"></a><span id="l13.97" class="difflineplus">+MockCloudfileController.prototype = {</span>
<a href="#l13.98"></a><span id="l13.98" class="difflineplus">+  get connected() {</span>
<a href="#l13.99"></a><span id="l13.99" class="difflineplus">+    return this.account != null;</span>
<a href="#l13.100"></a><span id="l13.100" class="difflineplus">+  },</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineplus">+  connect: function MCC_connect(aAccount) {</span>
<a href="#l13.102"></a><span id="l13.102" class="difflineplus">+    this.account = aAccount;</span>
<a href="#l13.103"></a><span id="l13.103" class="difflineplus">+  },</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineplus">+};</span>
<a href="#l13.105"></a><span id="l13.105" class="difflineplus">+</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineplus">+var gMockCloudfileManager = {</span>
<a href="#l13.107"></a><span id="l13.107" class="difflineplus">+  _mock_map: {},</span>
<a href="#l13.108"></a><span id="l13.108" class="difflineplus">+</span>
<a href="#l13.109"></a><span id="l13.109" class="difflineplus">+  register: function MCM_register() {</span>
<a href="#l13.110"></a><span id="l13.110" class="difflineplus">+    gCategoryManager.addCategoryEntry(&quot;cloud-files&quot;, kMockID,</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineplus">+                                      &quot;service,&quot; + kMockContractID,</span>
<a href="#l13.112"></a><span id="l13.112" class="difflineplus">+                                      false, true);</span>
<a href="#l13.113"></a><span id="l13.113" class="difflineplus">+    gMockCloudfileComponent.register();</span>
<a href="#l13.114"></a><span id="l13.114" class="difflineplus">+  },</span>
<a href="#l13.115"></a><span id="l13.115" class="difflineplus">+</span>
<a href="#l13.116"></a><span id="l13.116" class="difflineplus">+  unregister: function MCM_unregister() {</span>
<a href="#l13.117"></a><span id="l13.117" class="difflineplus">+    gCategoryManager.deleteCategoryEntry(&quot;cloud-files&quot;, kMockID, false);</span>
<a href="#l13.118"></a><span id="l13.118" class="difflineplus">+    gMockCloudfileComponent.unregister();</span>
<a href="#l13.119"></a><span id="l13.119" class="difflineplus">+  },</span>
<a href="#l13.120"></a><span id="l13.120" class="difflineplus">+</span>
<a href="#l13.121"></a><span id="l13.121" class="difflineplus">+}</span>
<a href="#l13.122"></a><span id="l13.122" class="difflineplus">+</span>
<a href="#l13.123"></a><span id="l13.123" class="difflineplus">+XPCOMUtils.defineLazyServiceGetter(this, &quot;gCategoryManager&quot;,</span>
<a href="#l13.124"></a><span id="l13.124" class="difflineplus">+                                   &quot;@mozilla.org/categorymanager;1&quot;,</span>
<a href="#l13.125"></a><span id="l13.125" class="difflineplus">+                                   &quot;nsICategoryManager&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">new file mode 100644</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineminus">--- /dev/null</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-cloudfile-yousendit-helpers.js</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineat">@@ -0,0 +1,741 @@</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l14.7"></a><span id="l14.7" class="difflineplus">+ * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineplus">+</span>
<a href="#l14.9"></a><span id="l14.9" class="difflineplus">+let Cu = Components.utils;</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineplus">+let Cc = Components.classes;</span>
<a href="#l14.11"></a><span id="l14.11" class="difflineplus">+let Ci = Components.interfaces;</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+const MODULE_NAME = 'cloudfile-yousendit-helpers';</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+const RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+const MODULE_REQUIRES = [];</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineplus">+let httpd = {};</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineplus">+Cu.import('resource://mozmill/stdlib/httpd.js', httpd);</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineplus">+Cu.import('resource://gre/modules/Services.jsm');</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineplus">+Cu.import('resource:///modules/cloudFileAccounts.js');</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineplus">+</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineplus">+const kDefaultServerPort = 4444;</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineplus">+const kServerRoot = &quot;http://localhost:&quot; + kDefaultServerPort;</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineplus">+const kServerPath = &quot;&quot;;</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineplus">+const kServerURL = kServerRoot + kServerPath;</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+const kAuthPath = &quot;/dpi/v1/auth&quot;;</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineplus">+const kUserInfoPath = &quot;/dpi/v1/user&quot;;</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+const kFilePreparePath = &quot;/dpi/v1/item/send&quot;;</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+const kDefaultFileUploadPath = &quot;/uploads&quot;;</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+const kCommitPath = &quot;/dpi/v1/item/commit&quot;;</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+const kDeletePath = &quot;/dpi/v1/item&quot;;</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+const kDownloadURLPrefix = &quot;http://www.example.com/downloads&quot;;</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+const kAuthResult = {</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+  authToken: &quot;someAuthToken&quot;,</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+  errorStatus: null,</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+}</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+const kDefaultConfig = {</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+  port: kDefaultServerPort</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineplus">+}</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+const kDefaultReturnHeader = {</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineplus">+  statusCode: 200,</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineplus">+  statusString: &quot;OK&quot;,</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+  contentType: &quot;text/plain&quot;,</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+}</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+const kDefaultUser = {</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+  key: null,</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+  id: null,</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+  type: &quot;BAS&quot;,</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineplus">+  policy: null,</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineplus">+  version: &quot;v3&quot;,</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineplus">+  password: null,</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineplus">+  role:null, </span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+  email: &quot;john@example.com&quot;,</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineplus">+  firstname: &quot;John&quot;,</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineplus">+  lastname: &quot;User&quot;,</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineplus">+  created: null,</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineplus">+  account: {</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineplus">+    passwordProtect: &quot;Pay-per-use&quot;,</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+    returnReceipt: &quot;Pay-per-use&quot;,</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+    availableStorage: &quot;2147483648&quot;,</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineplus">+    billingPlan: null,</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineplus">+    controlExpirationDate: null,</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+    dropboxUrl: null,</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+    knowledgeBase: &quot;Yes&quot;,</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+    maxDownloadBWpermonth: &quot;1073741824&quot;,</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineplus">+    maxFileDownloads: &quot;100&quot;,</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineplus">+    maxFileSize: &quot;104857600&quot;,</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineplus">+    premiumDelivery: null,</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineplus">+    verifyRecipientIdentity: &quot;Included&quot;</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineplus">+  },</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineplus">+  status: null,</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineplus">+  errorStatus: null,</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineplus">+};</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineplus">+</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineplus">+const kDefaultFilePrepare = {</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineplus">+  itemId: &quot;&quot;,</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineplus">+  uploadUrl: [</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineplus">+  ],</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineplus">+  status: null,</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineplus">+  errorStatus: null,</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineplus">+}</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineplus">+</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineplus">+const kDefaultCommitReturn = {</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineplus">+  downloadUrl: &quot;&quot;,</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineplus">+  errorStatus: null,</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineplus">+}</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineplus">+</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineplus">+function installInto(module) {</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineplus">+  module.MockYouSendItServer = MockYouSendItServer;</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineplus">+  module.MockYouSendItAuthCounter = MockYouSendItAuthCounter;</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineplus">+  module.MockYouSendItDeleterStaleToken = MockYouSendItDeleterStaleToken;</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineplus">+  module.remember_ysi_credentials = remember_ysi_credentials;</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineplus">+}</span>
<a href="#l14.100"></a><span id="l14.100" class="difflineplus">+</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineplus">+function MockYouSendItServer() {</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineplus">+  this.auth = new MockYouSendItAuthSimple(this);</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineplus">+  this.userInfo = new MockYouSendItUserInfoSimple(this);</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineplus">+  this.registry = new MockYouSendItItemIdRegistry(this);</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineplus">+  this.committer = new MockYouSendItCommitterSimple(this);</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineplus">+  this.receiver = new MockYouSendItReceiverSimple(this);</span>
<a href="#l14.107"></a><span id="l14.107" class="difflineplus">+  this.deleter = new MockYouSendItDeleterSimple(this);</span>
<a href="#l14.108"></a><span id="l14.108" class="difflineplus">+  this.preparer = new MockYouSendItPrepareSimple(this);</span>
<a href="#l14.109"></a><span id="l14.109" class="difflineplus">+}</span>
<a href="#l14.110"></a><span id="l14.110" class="difflineplus">+</span>
<a href="#l14.111"></a><span id="l14.111" class="difflineplus">+MockYouSendItServer.prototype = {</span>
<a href="#l14.112"></a><span id="l14.112" class="difflineplus">+  _server: null,</span>
<a href="#l14.113"></a><span id="l14.113" class="difflineplus">+</span>
<a href="#l14.114"></a><span id="l14.114" class="difflineplus">+  getPreparedBackend: function MDBS_getPreparedBackend(aAccountKey) {</span>
<a href="#l14.115"></a><span id="l14.115" class="difflineplus">+    let username = this.userInfo.username;</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineplus">+    Services.prefs.setCharPref(&quot;mail.cloud_files.accounts.&quot; + aAccountKey</span>
<a href="#l14.117"></a><span id="l14.117" class="difflineplus">+                               + &quot;.username&quot;, username);</span>
<a href="#l14.118"></a><span id="l14.118" class="difflineplus">+</span>
<a href="#l14.119"></a><span id="l14.119" class="difflineplus">+    cloudFileAccounts.setSecretValue(aAccountKey, cloudFileAccounts.kTokenRealm, &quot;someAuthToken&quot;);</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineplus">+</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineplus">+    let yousendit = Cc[&quot;@mozilla.org/mail/yousendit;1&quot;]</span>
<a href="#l14.122"></a><span id="l14.122" class="difflineplus">+                    .getService(Ci.nsIMsgCloudFileProvider);</span>
<a href="#l14.123"></a><span id="l14.123" class="difflineplus">+</span>
<a href="#l14.124"></a><span id="l14.124" class="difflineplus">+    let urls = [kServerURL];</span>
<a href="#l14.125"></a><span id="l14.125" class="difflineplus">+    yousendit.overrideUrls(urls.length, urls);</span>
<a href="#l14.126"></a><span id="l14.126" class="difflineplus">+    yousendit.init(aAccountKey);</span>
<a href="#l14.127"></a><span id="l14.127" class="difflineplus">+</span>
<a href="#l14.128"></a><span id="l14.128" class="difflineplus">+    return yousendit;</span>
<a href="#l14.129"></a><span id="l14.129" class="difflineplus">+  },</span>
<a href="#l14.130"></a><span id="l14.130" class="difflineplus">+</span>
<a href="#l14.131"></a><span id="l14.131" class="difflineplus">+  init: function MDBS_init(aConfig) {</span>
<a href="#l14.132"></a><span id="l14.132" class="difflineplus">+</span>
<a href="#l14.133"></a><span id="l14.133" class="difflineplus">+    this._config = overrideDefault(kDefaultConfig, aConfig);</span>
<a href="#l14.134"></a><span id="l14.134" class="difflineplus">+</span>
<a href="#l14.135"></a><span id="l14.135" class="difflineplus">+    this._server = httpd.getServer(this._config.port, '');</span>
<a href="#l14.136"></a><span id="l14.136" class="difflineplus">+    this.auth.init(this._server);</span>
<a href="#l14.137"></a><span id="l14.137" class="difflineplus">+    this.userInfo.init(this._server);</span>
<a href="#l14.138"></a><span id="l14.138" class="difflineplus">+    this.registry.init(this._server);</span>
<a href="#l14.139"></a><span id="l14.139" class="difflineplus">+    this.receiver.init(this._server);</span>
<a href="#l14.140"></a><span id="l14.140" class="difflineplus">+    this.preparer.init(this._server);</span>
<a href="#l14.141"></a><span id="l14.141" class="difflineplus">+    this.deleter.init(this._server);</span>
<a href="#l14.142"></a><span id="l14.142" class="difflineplus">+    this.committer.init(this._server);</span>
<a href="#l14.143"></a><span id="l14.143" class="difflineplus">+</span>
<a href="#l14.144"></a><span id="l14.144" class="difflineplus">+    this.userInfo.setupUser();</span>
<a href="#l14.145"></a><span id="l14.145" class="difflineplus">+  },</span>
<a href="#l14.146"></a><span id="l14.146" class="difflineplus">+</span>
<a href="#l14.147"></a><span id="l14.147" class="difflineplus">+  start: function MDBS_start() {</span>
<a href="#l14.148"></a><span id="l14.148" class="difflineplus">+    this._server.start(this._config.port);</span>
<a href="#l14.149"></a><span id="l14.149" class="difflineplus">+  },</span>
<a href="#l14.150"></a><span id="l14.150" class="difflineplus">+</span>
<a href="#l14.151"></a><span id="l14.151" class="difflineplus">+  stop: function MDBS_stop(aController) {</span>
<a href="#l14.152"></a><span id="l14.152" class="difflineplus">+    this.auth.shutdown();</span>
<a href="#l14.153"></a><span id="l14.153" class="difflineplus">+    this.userInfo.shutdown();</span>
<a href="#l14.154"></a><span id="l14.154" class="difflineplus">+    this.registry.shutdown();</span>
<a href="#l14.155"></a><span id="l14.155" class="difflineplus">+    this.receiver.shutdown();</span>
<a href="#l14.156"></a><span id="l14.156" class="difflineplus">+    this.preparer.shutdown();</span>
<a href="#l14.157"></a><span id="l14.157" class="difflineplus">+    this.deleter.shutdown();</span>
<a href="#l14.158"></a><span id="l14.158" class="difflineplus">+    this.committer.shutdown();</span>
<a href="#l14.159"></a><span id="l14.159" class="difflineplus">+</span>
<a href="#l14.160"></a><span id="l14.160" class="difflineplus">+    let allDone = false;</span>
<a href="#l14.161"></a><span id="l14.161" class="difflineplus">+    this._server.stop(function() {</span>
<a href="#l14.162"></a><span id="l14.162" class="difflineplus">+      allDone = true;</span>
<a href="#l14.163"></a><span id="l14.163" class="difflineplus">+    });</span>
<a href="#l14.164"></a><span id="l14.164" class="difflineplus">+    aController.waitFor(function () allDone,</span>
<a href="#l14.165"></a><span id="l14.165" class="difflineplus">+                        &quot;Timed out waiting for Dropbox server to stop!&quot;);</span>
<a href="#l14.166"></a><span id="l14.166" class="difflineplus">+  },</span>
<a href="#l14.167"></a><span id="l14.167" class="difflineplus">+</span>
<a href="#l14.168"></a><span id="l14.168" class="difflineplus">+  setupUser: function MDBS_wireUser(aData) {</span>
<a href="#l14.169"></a><span id="l14.169" class="difflineplus">+    this.userInfo.shutdown();</span>
<a href="#l14.170"></a><span id="l14.170" class="difflineplus">+    this.userInfo.init(this._server);</span>
<a href="#l14.171"></a><span id="l14.171" class="difflineplus">+    this.userInfo.setupUser(aData);</span>
<a href="#l14.172"></a><span id="l14.172" class="difflineplus">+  },</span>
<a href="#l14.173"></a><span id="l14.173" class="difflineplus">+</span>
<a href="#l14.174"></a><span id="l14.174" class="difflineplus">+  planForUploadFile: function MDBS_planForUploadFile(aFilename, aData) {</span>
<a href="#l14.175"></a><span id="l14.175" class="difflineplus">+    this.receiver.expect(aFilename);</span>
<a href="#l14.176"></a><span id="l14.176" class="difflineplus">+    let downloadUrl = kDownloadURLPrefix + &quot;/&quot; + aFilename;</span>
<a href="#l14.177"></a><span id="l14.177" class="difflineplus">+    this.committer.prepareDownloadURL(aFilename, downloadUrl);</span>
<a href="#l14.178"></a><span id="l14.178" class="difflineplus">+  },</span>
<a href="#l14.179"></a><span id="l14.179" class="difflineplus">+</span>
<a href="#l14.180"></a><span id="l14.180" class="difflineplus">+  planForGetFileURL: function MDBS_planForGetShare(aFilename, aData) {</span>
<a href="#l14.181"></a><span id="l14.181" class="difflineplus">+    this.committer.prepareDownloadURL(aFilename, aData.url);</span>
<a href="#l14.182"></a><span id="l14.182" class="difflineplus">+  },</span>
<a href="#l14.183"></a><span id="l14.183" class="difflineplus">+</span>
<a href="#l14.184"></a><span id="l14.184" class="difflineplus">+  planForDeleteFile: function MYSS_planForDeleteFile(aFilename) {</span>
<a href="#l14.185"></a><span id="l14.185" class="difflineplus">+    this.deleter.prepareForDelete(aFilename);</span>
<a href="#l14.186"></a><span id="l14.186" class="difflineplus">+  },</span>
<a href="#l14.187"></a><span id="l14.187" class="difflineplus">+}</span>
<a href="#l14.188"></a><span id="l14.188" class="difflineplus">+</span>
<a href="#l14.189"></a><span id="l14.189" class="difflineplus">+/**</span>
<a href="#l14.190"></a><span id="l14.190" class="difflineplus">+ * A simple authentication handler, regardless of input, returns</span>
<a href="#l14.191"></a><span id="l14.191" class="difflineplus">+ * an authorization token, and fires the cloudfile:auth observable</span>
<a href="#l14.192"></a><span id="l14.192" class="difflineplus">+ * topic.</span>
<a href="#l14.193"></a><span id="l14.193" class="difflineplus">+ */</span>
<a href="#l14.194"></a><span id="l14.194" class="difflineplus">+function MockYouSendItAuthSimple(aYouSendIt) {</span>
<a href="#l14.195"></a><span id="l14.195" class="difflineplus">+  this._server = null;</span>
<a href="#l14.196"></a><span id="l14.196" class="difflineplus">+  this._auth = null;</span>
<a href="#l14.197"></a><span id="l14.197" class="difflineplus">+}</span>
<a href="#l14.198"></a><span id="l14.198" class="difflineplus">+</span>
<a href="#l14.199"></a><span id="l14.199" class="difflineplus">+MockYouSendItAuthSimple.prototype = {</span>
<a href="#l14.200"></a><span id="l14.200" class="difflineplus">+  init: function(aServer) {</span>
<a href="#l14.201"></a><span id="l14.201" class="difflineplus">+    this._server = aServer;</span>
<a href="#l14.202"></a><span id="l14.202" class="difflineplus">+    this._auth = generateObservableRequestHandler(</span>
<a href="#l14.203"></a><span id="l14.203" class="difflineplus">+        &quot;cloudfile:auth&quot;, &quot;&quot;, JSON.stringify(kAuthResult));</span>
<a href="#l14.204"></a><span id="l14.204" class="difflineplus">+</span>
<a href="#l14.205"></a><span id="l14.205" class="difflineplus">+    this._server.registerPathHandler(kAuthPath, this._auth);</span>
<a href="#l14.206"></a><span id="l14.206" class="difflineplus">+  },</span>
<a href="#l14.207"></a><span id="l14.207" class="difflineplus">+</span>
<a href="#l14.208"></a><span id="l14.208" class="difflineplus">+  shutdown: function() {</span>
<a href="#l14.209"></a><span id="l14.209" class="difflineplus">+    this._server.registerPathHandler(kAuthPath, null);</span>
<a href="#l14.210"></a><span id="l14.210" class="difflineplus">+    this._server = null;</span>
<a href="#l14.211"></a><span id="l14.211" class="difflineplus">+    this._auth = null;</span>
<a href="#l14.212"></a><span id="l14.212" class="difflineplus">+  },</span>
<a href="#l14.213"></a><span id="l14.213" class="difflineplus">+}</span>
<a href="#l14.214"></a><span id="l14.214" class="difflineplus">+</span>
<a href="#l14.215"></a><span id="l14.215" class="difflineplus">+function MockYouSendItUserInfoSimple(aYouSendIt) {</span>
<a href="#l14.216"></a><span id="l14.216" class="difflineplus">+  this._server = null;</span>
<a href="#l14.217"></a><span id="l14.217" class="difflineplus">+  this._userInfo = null;</span>
<a href="#l14.218"></a><span id="l14.218" class="difflineplus">+}</span>
<a href="#l14.219"></a><span id="l14.219" class="difflineplus">+</span>
<a href="#l14.220"></a><span id="l14.220" class="difflineplus">+MockYouSendItUserInfoSimple.prototype = {</span>
<a href="#l14.221"></a><span id="l14.221" class="difflineplus">+  init: function(aServer) {</span>
<a href="#l14.222"></a><span id="l14.222" class="difflineplus">+    this._server = aServer;</span>
<a href="#l14.223"></a><span id="l14.223" class="difflineplus">+  },</span>
<a href="#l14.224"></a><span id="l14.224" class="difflineplus">+</span>
<a href="#l14.225"></a><span id="l14.225" class="difflineplus">+  setupUser: function(aData) {</span>
<a href="#l14.226"></a><span id="l14.226" class="difflineplus">+    aData = overrideDefault(kDefaultUser, aData);</span>
<a href="#l14.227"></a><span id="l14.227" class="difflineplus">+</span>
<a href="#l14.228"></a><span id="l14.228" class="difflineplus">+    this._userInfo = generateObservableRequestHandler(</span>
<a href="#l14.229"></a><span id="l14.229" class="difflineplus">+        &quot;cloudfile:auth&quot;, &quot;&quot;, JSON.stringify(aData));</span>
<a href="#l14.230"></a><span id="l14.230" class="difflineplus">+    this._server.registerPathHandler(kUserInfoPath, this._userInfo);</span>
<a href="#l14.231"></a><span id="l14.231" class="difflineplus">+  },</span>
<a href="#l14.232"></a><span id="l14.232" class="difflineplus">+</span>
<a href="#l14.233"></a><span id="l14.233" class="difflineplus">+  shutdown: function() {</span>
<a href="#l14.234"></a><span id="l14.234" class="difflineplus">+    this._server.registerPathHandler(kUserInfoPath, null);</span>
<a href="#l14.235"></a><span id="l14.235" class="difflineplus">+    this._server = null;</span>
<a href="#l14.236"></a><span id="l14.236" class="difflineplus">+  },</span>
<a href="#l14.237"></a><span id="l14.237" class="difflineplus">+</span>
<a href="#l14.238"></a><span id="l14.238" class="difflineplus">+  get username() {</span>
<a href="#l14.239"></a><span id="l14.239" class="difflineplus">+    return kDefaultUser.email;</span>
<a href="#l14.240"></a><span id="l14.240" class="difflineplus">+  },</span>
<a href="#l14.241"></a><span id="l14.241" class="difflineplus">+};</span>
<a href="#l14.242"></a><span id="l14.242" class="difflineplus">+</span>
<a href="#l14.243"></a><span id="l14.243" class="difflineplus">+function MockYouSendItItemIdRegistry(aYouSendIt) {</span>
<a href="#l14.244"></a><span id="l14.244" class="difflineplus">+  this._itemIdMap = {};</span>
<a href="#l14.245"></a><span id="l14.245" class="difflineplus">+  this._itemIds = [];</span>
<a href="#l14.246"></a><span id="l14.246" class="difflineplus">+}</span>
<a href="#l14.247"></a><span id="l14.247" class="difflineplus">+</span>
<a href="#l14.248"></a><span id="l14.248" class="difflineplus">+MockYouSendItItemIdRegistry.prototype = {</span>
<a href="#l14.249"></a><span id="l14.249" class="difflineplus">+  init: function(aServer) {</span>
<a href="#l14.250"></a><span id="l14.250" class="difflineplus">+    this._itemIdMap = {};</span>
<a href="#l14.251"></a><span id="l14.251" class="difflineplus">+    this._itemIds = [];</span>
<a href="#l14.252"></a><span id="l14.252" class="difflineplus">+  },</span>
<a href="#l14.253"></a><span id="l14.253" class="difflineplus">+</span>
<a href="#l14.254"></a><span id="l14.254" class="difflineplus">+  shutdown: function() {</span>
<a href="#l14.255"></a><span id="l14.255" class="difflineplus">+  },</span>
<a href="#l14.256"></a><span id="l14.256" class="difflineplus">+</span>
<a href="#l14.257"></a><span id="l14.257" class="difflineplus">+  createItemId: function createItemId() {</span>
<a href="#l14.258"></a><span id="l14.258" class="difflineplus">+    let itemId = generateUUID();</span>
<a href="#l14.259"></a><span id="l14.259" class="difflineplus">+    this._itemIds.push(itemId);</span>
<a href="#l14.260"></a><span id="l14.260" class="difflineplus">+    return itemId;</span>
<a href="#l14.261"></a><span id="l14.261" class="difflineplus">+  },</span>
<a href="#l14.262"></a><span id="l14.262" class="difflineplus">+</span>
<a href="#l14.263"></a><span id="l14.263" class="difflineplus">+  setMapping: function setMapping(aItemId, aFilename) {</span>
<a href="#l14.264"></a><span id="l14.264" class="difflineplus">+    let oldItemId = this.lookupItemId(aFilename);</span>
<a href="#l14.265"></a><span id="l14.265" class="difflineplus">+    if (oldItemId)</span>
<a href="#l14.266"></a><span id="l14.266" class="difflineplus">+      delete this._itemIdMap[oldItemId]</span>
<a href="#l14.267"></a><span id="l14.267" class="difflineplus">+</span>
<a href="#l14.268"></a><span id="l14.268" class="difflineplus">+    if (this._itemIds.indexOf(aItemId) != -1) {</span>
<a href="#l14.269"></a><span id="l14.269" class="difflineplus">+      this._itemIdMap[aItemId] = aFilename;</span>
<a href="#l14.270"></a><span id="l14.270" class="difflineplus">+    }</span>
<a href="#l14.271"></a><span id="l14.271" class="difflineplus">+  },</span>
<a href="#l14.272"></a><span id="l14.272" class="difflineplus">+</span>
<a href="#l14.273"></a><span id="l14.273" class="difflineplus">+  lookupFilename: function lookupFilename(aItemId) {</span>
<a href="#l14.274"></a><span id="l14.274" class="difflineplus">+    return this._itemIdMap[aItemId];</span>
<a href="#l14.275"></a><span id="l14.275" class="difflineplus">+  },</span>
<a href="#l14.276"></a><span id="l14.276" class="difflineplus">+</span>
<a href="#l14.277"></a><span id="l14.277" class="difflineplus">+  hasItemId: function hasItemId(aItemId) {</span>
<a href="#l14.278"></a><span id="l14.278" class="difflineplus">+    return (aItemId in this._itemIdMap);</span>
<a href="#l14.279"></a><span id="l14.279" class="difflineplus">+  },</span>
<a href="#l14.280"></a><span id="l14.280" class="difflineplus">+</span>
<a href="#l14.281"></a><span id="l14.281" class="difflineplus">+  lookupItemId: function lookupItemId(aFilename) {</span>
<a href="#l14.282"></a><span id="l14.282" class="difflineplus">+    // Slow lookup</span>
<a href="#l14.283"></a><span id="l14.283" class="difflineplus">+    for (let itemId in this._itemIdMap) {</span>
<a href="#l14.284"></a><span id="l14.284" class="difflineplus">+      if (this._itemIdMap[itemId] == aFilename)</span>
<a href="#l14.285"></a><span id="l14.285" class="difflineplus">+        return itemId;</span>
<a href="#l14.286"></a><span id="l14.286" class="difflineplus">+    }</span>
<a href="#l14.287"></a><span id="l14.287" class="difflineplus">+    return null;</span>
<a href="#l14.288"></a><span id="l14.288" class="difflineplus">+  },</span>
<a href="#l14.289"></a><span id="l14.289" class="difflineplus">+}</span>
<a href="#l14.290"></a><span id="l14.290" class="difflineplus">+</span>
<a href="#l14.291"></a><span id="l14.291" class="difflineplus">+/**</span>
<a href="#l14.292"></a><span id="l14.292" class="difflineplus">+ * A simple preparation handler for a YouSendIt mock server. Allows</span>
<a href="#l14.293"></a><span id="l14.293" class="difflineplus">+ * a client to query for a unique URL to upload to.  Redirects the actual</span>
<a href="#l14.294"></a><span id="l14.294" class="difflineplus">+ * uploads to the passed receiver</span>
<a href="#l14.295"></a><span id="l14.295" class="difflineplus">+ */</span>
<a href="#l14.296"></a><span id="l14.296" class="difflineplus">+function MockYouSendItPrepareSimple(aYouSendIt) {</span>
<a href="#l14.297"></a><span id="l14.297" class="difflineplus">+  this._server = null;</span>
<a href="#l14.298"></a><span id="l14.298" class="difflineplus">+  this._ysi = aYouSendIt;</span>
<a href="#l14.299"></a><span id="l14.299" class="difflineplus">+}</span>
<a href="#l14.300"></a><span id="l14.300" class="difflineplus">+</span>
<a href="#l14.301"></a><span id="l14.301" class="difflineplus">+MockYouSendItPrepareSimple.prototype = {</span>
<a href="#l14.302"></a><span id="l14.302" class="difflineplus">+  init: function(aServer) {</span>
<a href="#l14.303"></a><span id="l14.303" class="difflineplus">+    this._server = aServer;</span>
<a href="#l14.304"></a><span id="l14.304" class="difflineplus">+    this._server.registerPathHandler(kFilePreparePath,</span>
<a href="#l14.305"></a><span id="l14.305" class="difflineplus">+                                     this._prepare.bind(this));</span>
<a href="#l14.306"></a><span id="l14.306" class="difflineplus">+  },</span>
<a href="#l14.307"></a><span id="l14.307" class="difflineplus">+</span>
<a href="#l14.308"></a><span id="l14.308" class="difflineplus">+  shutdown: function() {</span>
<a href="#l14.309"></a><span id="l14.309" class="difflineplus">+    this._server.registerPathHandler(kFilePreparePath, null);</span>
<a href="#l14.310"></a><span id="l14.310" class="difflineplus">+    this._server = null;</span>
<a href="#l14.311"></a><span id="l14.311" class="difflineplus">+  },</span>
<a href="#l14.312"></a><span id="l14.312" class="difflineplus">+</span>
<a href="#l14.313"></a><span id="l14.313" class="difflineplus">+  _prepare: function(aRequest, aResponse) {</span>
<a href="#l14.314"></a><span id="l14.314" class="difflineplus">+    let itemId = this._ysi.registry.createItemId();</span>
<a href="#l14.315"></a><span id="l14.315" class="difflineplus">+    let uploadPath = kDefaultFileUploadPath + &quot;/&quot; + itemId;</span>
<a href="#l14.316"></a><span id="l14.316" class="difflineplus">+</span>
<a href="#l14.317"></a><span id="l14.317" class="difflineplus">+    let injectedData = {</span>
<a href="#l14.318"></a><span id="l14.318" class="difflineplus">+      itemId: itemId,</span>
<a href="#l14.319"></a><span id="l14.319" class="difflineplus">+      uploadUrl: [</span>
<a href="#l14.320"></a><span id="l14.320" class="difflineplus">+        kServerURL + uploadPath,</span>
<a href="#l14.321"></a><span id="l14.321" class="difflineplus">+      ]</span>
<a href="#l14.322"></a><span id="l14.322" class="difflineplus">+    }</span>
<a href="#l14.323"></a><span id="l14.323" class="difflineplus">+</span>
<a href="#l14.324"></a><span id="l14.324" class="difflineplus">+    // Set up the path that will accept an uploaded file</span>
<a href="#l14.325"></a><span id="l14.325" class="difflineplus">+    this._server.registerPathHandler(uploadPath,</span>
<a href="#l14.326"></a><span id="l14.326" class="difflineplus">+                                     this._ysi.receiver.receiveUpload</span>
<a href="#l14.327"></a><span id="l14.327" class="difflineplus">+                                                       .bind(this._ysi.receiver));</span>
<a href="#l14.328"></a><span id="l14.328" class="difflineplus">+</span>
<a href="#l14.329"></a><span id="l14.329" class="difflineplus">+    // Set up the path that will accept file deletion</span>
<a href="#l14.330"></a><span id="l14.330" class="difflineplus">+</span>
<a href="#l14.331"></a><span id="l14.331" class="difflineplus">+    let deletePath = kDeletePath + &quot;/&quot; + itemId;</span>
<a href="#l14.332"></a><span id="l14.332" class="difflineplus">+</span>
<a href="#l14.333"></a><span id="l14.333" class="difflineplus">+    this._server.registerPathHandler(deletePath,</span>
<a href="#l14.334"></a><span id="l14.334" class="difflineplus">+                                     this._ysi.deleter.receiveDelete</span>
<a href="#l14.335"></a><span id="l14.335" class="difflineplus">+                                                      .bind(this._ysi.deleter));</span>
<a href="#l14.336"></a><span id="l14.336" class="difflineplus">+</span>
<a href="#l14.337"></a><span id="l14.337" class="difflineplus">+    let data = overrideDefault(kDefaultFilePrepare, injectedData);</span>
<a href="#l14.338"></a><span id="l14.338" class="difflineplus">+    aResponse.setStatusLine(null, 200, &quot;OK&quot;);</span>
<a href="#l14.339"></a><span id="l14.339" class="difflineplus">+    aResponse.setHeader(&quot;Content-Type&quot;, &quot;application/json&quot;);</span>
<a href="#l14.340"></a><span id="l14.340" class="difflineplus">+    aResponse.write(JSON.stringify(data));</span>
<a href="#l14.341"></a><span id="l14.341" class="difflineplus">+  },</span>
<a href="#l14.342"></a><span id="l14.342" class="difflineplus">+</span>
<a href="#l14.343"></a><span id="l14.343" class="difflineplus">+};</span>
<a href="#l14.344"></a><span id="l14.344" class="difflineplus">+</span>
<a href="#l14.345"></a><span id="l14.345" class="difflineplus">+function MockYouSendItReceiverSimple(aYouSendIt) {</span>
<a href="#l14.346"></a><span id="l14.346" class="difflineplus">+  this._server = null;</span>
<a href="#l14.347"></a><span id="l14.347" class="difflineplus">+  this._ysi = aYouSendIt;</span>
<a href="#l14.348"></a><span id="l14.348" class="difflineplus">+  this._expectedFiles = [];</span>
<a href="#l14.349"></a><span id="l14.349" class="difflineplus">+}</span>
<a href="#l14.350"></a><span id="l14.350" class="difflineplus">+</span>
<a href="#l14.351"></a><span id="l14.351" class="difflineplus">+MockYouSendItReceiverSimple.prototype = {</span>
<a href="#l14.352"></a><span id="l14.352" class="difflineplus">+  init: function(aServer) {</span>
<a href="#l14.353"></a><span id="l14.353" class="difflineplus">+    this._server = aServer;</span>
<a href="#l14.354"></a><span id="l14.354" class="difflineplus">+  },</span>
<a href="#l14.355"></a><span id="l14.355" class="difflineplus">+</span>
<a href="#l14.356"></a><span id="l14.356" class="difflineplus">+  shutdown: function() {</span>
<a href="#l14.357"></a><span id="l14.357" class="difflineplus">+    this._server = null;</span>
<a href="#l14.358"></a><span id="l14.358" class="difflineplus">+    this._expectedFiles = [];</span>
<a href="#l14.359"></a><span id="l14.359" class="difflineplus">+  },</span>
<a href="#l14.360"></a><span id="l14.360" class="difflineplus">+</span>
<a href="#l14.361"></a><span id="l14.361" class="difflineplus">+  receiveUpload: function(aRequest, aResponse) {</span>
<a href="#l14.362"></a><span id="l14.362" class="difflineplus">+    if (aRequest.method != &quot;POST&quot;)</span>
<a href="#l14.363"></a><span id="l14.363" class="difflineplus">+      throw new Error(&quot;Uploads should occur with a POST request&quot;);</span>
<a href="#l14.364"></a><span id="l14.364" class="difflineplus">+</span>
<a href="#l14.365"></a><span id="l14.365" class="difflineplus">+    let formData = parseMultipartForm(aRequest);</span>
<a href="#l14.366"></a><span id="l14.366" class="difflineplus">+</span>
<a href="#l14.367"></a><span id="l14.367" class="difflineplus">+    if (!formData)</span>
<a href="#l14.368"></a><span id="l14.368" class="difflineplus">+      throw new Error(&quot;Could not parse multi-part form during upload&quot;);</span>
<a href="#l14.369"></a><span id="l14.369" class="difflineplus">+</span>
<a href="#l14.370"></a><span id="l14.370" class="difflineplus">+    let filename = formData['filename'];</span>
<a href="#l14.371"></a><span id="l14.371" class="difflineplus">+    let filenameIndex = this._expectedFiles.indexOf(filename);</span>
<a href="#l14.372"></a><span id="l14.372" class="difflineplus">+</span>
<a href="#l14.373"></a><span id="l14.373" class="difflineplus">+    if (filenameIndex == -1)</span>
<a href="#l14.374"></a><span id="l14.374" class="difflineplus">+      throw new Error(&quot;Unexpected file upload: &quot; + formData['filename']);</span>
<a href="#l14.375"></a><span id="l14.375" class="difflineplus">+</span>
<a href="#l14.376"></a><span id="l14.376" class="difflineplus">+    Services.obs.notifyObservers(null, &quot;cloudfile:uploadFile&quot;,</span>
<a href="#l14.377"></a><span id="l14.377" class="difflineplus">+                                 filename);</span>
<a href="#l14.378"></a><span id="l14.378" class="difflineplus">+</span>
<a href="#l14.379"></a><span id="l14.379" class="difflineplus">+    this._expectedFiles.splice(filenameIndex, 1);</span>
<a href="#l14.380"></a><span id="l14.380" class="difflineplus">+</span>
<a href="#l14.381"></a><span id="l14.381" class="difflineplus">+    let itemId = formData['bid'];</span>
<a href="#l14.382"></a><span id="l14.382" class="difflineplus">+    // Tell the committer how to map the uuid to the filename</span>
<a href="#l14.383"></a><span id="l14.383" class="difflineplus">+    this._ysi.registry.setMapping(itemId, filename);</span>
<a href="#l14.384"></a><span id="l14.384" class="difflineplus">+    this._ysi.committer.expectCommit(filename);</span>
<a href="#l14.385"></a><span id="l14.385" class="difflineplus">+</span>
<a href="#l14.386"></a><span id="l14.386" class="difflineplus">+    // De-register this URL...</span>
<a href="#l14.387"></a><span id="l14.387" class="difflineplus">+    this._server.registerPathHandler(aRequest.path, null);</span>
<a href="#l14.388"></a><span id="l14.388" class="difflineplus">+  },</span>
<a href="#l14.389"></a><span id="l14.389" class="difflineplus">+</span>
<a href="#l14.390"></a><span id="l14.390" class="difflineplus">+  expect: function(aFilename) {</span>
<a href="#l14.391"></a><span id="l14.391" class="difflineplus">+    this._expectedFiles.push(aFilename);</span>
<a href="#l14.392"></a><span id="l14.392" class="difflineplus">+  },</span>
<a href="#l14.393"></a><span id="l14.393" class="difflineplus">+</span>
<a href="#l14.394"></a><span id="l14.394" class="difflineplus">+  get expecting() {</span>
<a href="#l14.395"></a><span id="l14.395" class="difflineplus">+    return this._expectedFiles;</span>
<a href="#l14.396"></a><span id="l14.396" class="difflineplus">+  }</span>
<a href="#l14.397"></a><span id="l14.397" class="difflineplus">+};</span>
<a href="#l14.398"></a><span id="l14.398" class="difflineplus">+</span>
<a href="#l14.399"></a><span id="l14.399" class="difflineplus">+function MockYouSendItCommitterSimple(aYouSendIt) {</span>
<a href="#l14.400"></a><span id="l14.400" class="difflineplus">+  this._server = null;</span>
<a href="#l14.401"></a><span id="l14.401" class="difflineplus">+  this._ysi = aYouSendIt;</span>
<a href="#l14.402"></a><span id="l14.402" class="difflineplus">+  this._itemIdMap = {};</span>
<a href="#l14.403"></a><span id="l14.403" class="difflineplus">+  this._filenameURLMap = {};</span>
<a href="#l14.404"></a><span id="l14.404" class="difflineplus">+}</span>
<a href="#l14.405"></a><span id="l14.405" class="difflineplus">+</span>
<a href="#l14.406"></a><span id="l14.406" class="difflineplus">+MockYouSendItCommitterSimple.prototype = {</span>
<a href="#l14.407"></a><span id="l14.407" class="difflineplus">+  init: function(aServer) {</span>
<a href="#l14.408"></a><span id="l14.408" class="difflineplus">+    this._server = aServer;</span>
<a href="#l14.409"></a><span id="l14.409" class="difflineplus">+  },</span>
<a href="#l14.410"></a><span id="l14.410" class="difflineplus">+</span>
<a href="#l14.411"></a><span id="l14.411" class="difflineplus">+  shutdown: function() {</span>
<a href="#l14.412"></a><span id="l14.412" class="difflineplus">+    this._server = null;</span>
<a href="#l14.413"></a><span id="l14.413" class="difflineplus">+    this._itemIdMap = {};</span>
<a href="#l14.414"></a><span id="l14.414" class="difflineplus">+    this._filenameURLMap = {};</span>
<a href="#l14.415"></a><span id="l14.415" class="difflineplus">+  },</span>
<a href="#l14.416"></a><span id="l14.416" class="difflineplus">+</span>
<a href="#l14.417"></a><span id="l14.417" class="difflineplus">+  expectCommit: function(aFilename) {</span>
<a href="#l14.418"></a><span id="l14.418" class="difflineplus">+    let itemId = this._ysi.registry.lookupItemId(aFilename);</span>
<a href="#l14.419"></a><span id="l14.419" class="difflineplus">+    let commitPath = kCommitPath + &quot;/&quot; + itemId;</span>
<a href="#l14.420"></a><span id="l14.420" class="difflineplus">+    this._server.registerPathHandler(commitPath, this.commit.bind(this));</span>
<a href="#l14.421"></a><span id="l14.421" class="difflineplus">+  },</span>
<a href="#l14.422"></a><span id="l14.422" class="difflineplus">+</span>
<a href="#l14.423"></a><span id="l14.423" class="difflineplus">+  prepareDownloadURL: function(aFilename, aURL) {</span>
<a href="#l14.424"></a><span id="l14.424" class="difflineplus">+    this._filenameURLMap[aFilename] = aURL;</span>
<a href="#l14.425"></a><span id="l14.425" class="difflineplus">+  },</span>
<a href="#l14.426"></a><span id="l14.426" class="difflineplus">+</span>
<a href="#l14.427"></a><span id="l14.427" class="difflineplus">+  commit: function(aRequest, aResponse) {</span>
<a href="#l14.428"></a><span id="l14.428" class="difflineplus">+    let itemId = aRequest.path.substring(kCommitPath.length + 1);</span>
<a href="#l14.429"></a><span id="l14.429" class="difflineplus">+</span>
<a href="#l14.430"></a><span id="l14.430" class="difflineplus">+    if (!this._ysi.registry.hasItemId(itemId)) {</span>
<a href="#l14.431"></a><span id="l14.431" class="difflineplus">+      aResponse.setStatusLine(null, 500, &quot;Bad request&quot;);</span>
<a href="#l14.432"></a><span id="l14.432" class="difflineplus">+      aResponse.write(&quot;The item ID &quot; + itemId + &quot; did not map to an item we &quot;</span>
<a href="#l14.433"></a><span id="l14.433" class="difflineplus">+                      + &quot;were prepared for committing&quot;);</span>
<a href="#l14.434"></a><span id="l14.434" class="difflineplus">+      return;</span>
<a href="#l14.435"></a><span id="l14.435" class="difflineplus">+    }</span>
<a href="#l14.436"></a><span id="l14.436" class="difflineplus">+</span>
<a href="#l14.437"></a><span id="l14.437" class="difflineplus">+    let filename = this._ysi.registry.lookupFilename(itemId);</span>
<a href="#l14.438"></a><span id="l14.438" class="difflineplus">+    let url;</span>
<a href="#l14.439"></a><span id="l14.439" class="difflineplus">+</span>
<a href="#l14.440"></a><span id="l14.440" class="difflineplus">+    if (filename in this._filenameURLMap)</span>
<a href="#l14.441"></a><span id="l14.441" class="difflineplus">+      url = this._filenameURLMap[filename];</span>
<a href="#l14.442"></a><span id="l14.442" class="difflineplus">+    else</span>
<a href="#l14.443"></a><span id="l14.443" class="difflineplus">+      url = kDownloadURLPrefix + &quot;/&quot; + filename;</span>
<a href="#l14.444"></a><span id="l14.444" class="difflineplus">+</span>
<a href="#l14.445"></a><span id="l14.445" class="difflineplus">+    let injectedData = {</span>
<a href="#l14.446"></a><span id="l14.446" class="difflineplus">+      downloadUrl: url,</span>
<a href="#l14.447"></a><span id="l14.447" class="difflineplus">+    }</span>
<a href="#l14.448"></a><span id="l14.448" class="difflineplus">+    let data = overrideDefault(kDefaultCommitReturn, injectedData);</span>
<a href="#l14.449"></a><span id="l14.449" class="difflineplus">+</span>
<a href="#l14.450"></a><span id="l14.450" class="difflineplus">+    // Return the default share URL</span>
<a href="#l14.451"></a><span id="l14.451" class="difflineplus">+    aResponse.setStatusLine(null, 200, &quot;OK&quot;);</span>
<a href="#l14.452"></a><span id="l14.452" class="difflineplus">+    aResponse.setHeader(&quot;Content-Type&quot;, &quot;application/json&quot;);</span>
<a href="#l14.453"></a><span id="l14.453" class="difflineplus">+    aResponse.write(JSON.stringify(data));</span>
<a href="#l14.454"></a><span id="l14.454" class="difflineplus">+</span>
<a href="#l14.455"></a><span id="l14.455" class="difflineplus">+    Services.obs.notifyObservers(null, &quot;cloudfile:getFileURL&quot;, filename);</span>
<a href="#l14.456"></a><span id="l14.456" class="difflineplus">+</span>
<a href="#l14.457"></a><span id="l14.457" class="difflineplus">+    // Unregister this commit URL</span>
<a href="#l14.458"></a><span id="l14.458" class="difflineplus">+    this._server.registerPathHandler(aRequest.path, null);</span>
<a href="#l14.459"></a><span id="l14.459" class="difflineplus">+  },</span>
<a href="#l14.460"></a><span id="l14.460" class="difflineplus">+};</span>
<a href="#l14.461"></a><span id="l14.461" class="difflineplus">+</span>
<a href="#l14.462"></a><span id="l14.462" class="difflineplus">+function MockYouSendItDeleterSimple(aYouSendIt) {</span>
<a href="#l14.463"></a><span id="l14.463" class="difflineplus">+  this._server = null;</span>
<a href="#l14.464"></a><span id="l14.464" class="difflineplus">+  this._ysi = aYouSendIt;</span>
<a href="#l14.465"></a><span id="l14.465" class="difflineplus">+  this._expectDelete = [];</span>
<a href="#l14.466"></a><span id="l14.466" class="difflineplus">+}</span>
<a href="#l14.467"></a><span id="l14.467" class="difflineplus">+</span>
<a href="#l14.468"></a><span id="l14.468" class="difflineplus">+MockYouSendItDeleterSimple.prototype = {</span>
<a href="#l14.469"></a><span id="l14.469" class="difflineplus">+  init: function(aServer) {</span>
<a href="#l14.470"></a><span id="l14.470" class="difflineplus">+    this._server = aServer;</span>
<a href="#l14.471"></a><span id="l14.471" class="difflineplus">+  },</span>
<a href="#l14.472"></a><span id="l14.472" class="difflineplus">+  shutdown: function() {},</span>
<a href="#l14.473"></a><span id="l14.473" class="difflineplus">+</span>
<a href="#l14.474"></a><span id="l14.474" class="difflineplus">+  receiveDelete: function(aRequest, aResponse) {</span>
<a href="#l14.475"></a><span id="l14.475" class="difflineplus">+    if (aRequest.method != &quot;DELETE&quot;) {</span>
<a href="#l14.476"></a><span id="l14.476" class="difflineplus">+      aResponse.setStatusLine(null, 500, &quot;Bad request&quot;);</span>
<a href="#l14.477"></a><span id="l14.477" class="difflineplus">+      aResponse.write(&quot;Expected a DELETE for deleting.&quot;);</span>
<a href="#l14.478"></a><span id="l14.478" class="difflineplus">+      return;</span>
<a href="#l14.479"></a><span id="l14.479" class="difflineplus">+    }</span>
<a href="#l14.480"></a><span id="l14.480" class="difflineplus">+</span>
<a href="#l14.481"></a><span id="l14.481" class="difflineplus">+</span>
<a href="#l14.482"></a><span id="l14.482" class="difflineplus">+    let itemId = aRequest.path.substring(kDeletePath.length + 1);</span>
<a href="#l14.483"></a><span id="l14.483" class="difflineplus">+</span>
<a href="#l14.484"></a><span id="l14.484" class="difflineplus">+    if (!this._ysi.registry.hasItemId(itemId)) {</span>
<a href="#l14.485"></a><span id="l14.485" class="difflineplus">+      aResponse.setStatusLine(null, 500, &quot;Bad request&quot;);</span>
<a href="#l14.486"></a><span id="l14.486" class="difflineplus">+      aResponse.write(&quot;The item ID &quot; + itemId + &quot; did not map to an item &quot;</span>
<a href="#l14.487"></a><span id="l14.487" class="difflineplus">+                      + &quot;we were prepared for deleting&quot;);</span>
<a href="#l14.488"></a><span id="l14.488" class="difflineplus">+      return;</span>
<a href="#l14.489"></a><span id="l14.489" class="difflineplus">+    }</span>
<a href="#l14.490"></a><span id="l14.490" class="difflineplus">+</span>
<a href="#l14.491"></a><span id="l14.491" class="difflineplus">+    let filename = this._ysi.registry.lookupFilename(itemId);</span>
<a href="#l14.492"></a><span id="l14.492" class="difflineplus">+    let itemIndex = this._expectDelete.indexOf(filename);</span>
<a href="#l14.493"></a><span id="l14.493" class="difflineplus">+    if (itemIndex == -1) {</span>
<a href="#l14.494"></a><span id="l14.494" class="difflineplus">+      aResponse.setStatusLine(null, 500, &quot;Bad request&quot;);</span>
<a href="#l14.495"></a><span id="l14.495" class="difflineplus">+      aRespones.write(&quot;Not prepared to delete file with filename: &quot;</span>
<a href="#l14.496"></a><span id="l14.496" class="difflineplus">+                      + filename);</span>
<a href="#l14.497"></a><span id="l14.497" class="difflineplus">+      return;</span>
<a href="#l14.498"></a><span id="l14.498" class="difflineplus">+    }</span>
<a href="#l14.499"></a><span id="l14.499" class="difflineplus">+</span>
<a href="#l14.500"></a><span id="l14.500" class="difflineplus">+    this._expectDelete.splice(itemIndex, 1);</span>
<a href="#l14.501"></a><span id="l14.501" class="difflineplus">+</span>
<a href="#l14.502"></a><span id="l14.502" class="difflineplus">+    let response = '&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;yes&quot;?&gt;&lt;delete&gt;&lt;status&gt;OK&lt;/status&gt;&lt;/delete&gt;';</span>
<a href="#l14.503"></a><span id="l14.503" class="difflineplus">+    aResponse.setStatusLine(null, 200, &quot;OK&quot;);</span>
<a href="#l14.504"></a><span id="l14.504" class="difflineplus">+    aResponse.setHeader(&quot;Content-Type&quot;, &quot;application/xml&quot;);</span>
<a href="#l14.505"></a><span id="l14.505" class="difflineplus">+    aResponse.write(response);</span>
<a href="#l14.506"></a><span id="l14.506" class="difflineplus">+</span>
<a href="#l14.507"></a><span id="l14.507" class="difflineplus">+    Services.obs.notifyObservers(null, &quot;cloudfile:deleteFile&quot;, filename);</span>
<a href="#l14.508"></a><span id="l14.508" class="difflineplus">+    this._server.registerPathHandler(aRequest.path, null);</span>
<a href="#l14.509"></a><span id="l14.509" class="difflineplus">+  },</span>
<a href="#l14.510"></a><span id="l14.510" class="difflineplus">+  prepareForDelete: function(aFilename) {</span>
<a href="#l14.511"></a><span id="l14.511" class="difflineplus">+    this._expectDelete.push(aFilename);</span>
<a href="#l14.512"></a><span id="l14.512" class="difflineplus">+  },</span>
<a href="#l14.513"></a><span id="l14.513" class="difflineplus">+};</span>
<a href="#l14.514"></a><span id="l14.514" class="difflineplus">+</span>
<a href="#l14.515"></a><span id="l14.515" class="difflineplus">+function MockYouSendItDeleterStaleToken(aYouSendIt) {</span>
<a href="#l14.516"></a><span id="l14.516" class="difflineplus">+  this._server = null;</span>
<a href="#l14.517"></a><span id="l14.517" class="difflineplus">+  this._ysi = aYouSendIt;</span>
<a href="#l14.518"></a><span id="l14.518" class="difflineplus">+}</span>
<a href="#l14.519"></a><span id="l14.519" class="difflineplus">+</span>
<a href="#l14.520"></a><span id="l14.520" class="difflineplus">+MockYouSendItDeleterStaleToken.prototype = {</span>
<a href="#l14.521"></a><span id="l14.521" class="difflineplus">+  init: function(aServer) {</span>
<a href="#l14.522"></a><span id="l14.522" class="difflineplus">+    this._server = aServer;</span>
<a href="#l14.523"></a><span id="l14.523" class="difflineplus">+  },</span>
<a href="#l14.524"></a><span id="l14.524" class="difflineplus">+</span>
<a href="#l14.525"></a><span id="l14.525" class="difflineplus">+  shutdown: function() {},</span>
<a href="#l14.526"></a><span id="l14.526" class="difflineplus">+</span>
<a href="#l14.527"></a><span id="l14.527" class="difflineplus">+  receiveDelete: function(aRequest, aResponse) {</span>
<a href="#l14.528"></a><span id="l14.528" class="difflineplus">+    let data = '&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;yes&quot;?&gt;&lt;delete&gt;&lt;errorStatus&gt;&lt;code&gt;401&lt;/code&gt;&lt;message&gt;Invalid auth token&lt;/message&gt;&lt;/errorStatus&gt;&lt;/delete&gt;';</span>
<a href="#l14.529"></a><span id="l14.529" class="difflineplus">+</span>
<a href="#l14.530"></a><span id="l14.530" class="difflineplus">+    aResponse.setStatusLine(null, 200, &quot;OK&quot;);</span>
<a href="#l14.531"></a><span id="l14.531" class="difflineplus">+    aResponse.setHeader(&quot;Content-Type&quot;, &quot;application/json&quot;);</span>
<a href="#l14.532"></a><span id="l14.532" class="difflineplus">+    aResponse.write(data);</span>
<a href="#l14.533"></a><span id="l14.533" class="difflineplus">+  },</span>
<a href="#l14.534"></a><span id="l14.534" class="difflineplus">+</span>
<a href="#l14.535"></a><span id="l14.535" class="difflineplus">+  prepareForDelete: function(aFilename) {},</span>
<a href="#l14.536"></a><span id="l14.536" class="difflineplus">+};</span>
<a href="#l14.537"></a><span id="l14.537" class="difflineplus">+</span>
<a href="#l14.538"></a><span id="l14.538" class="difflineplus">+function MockYouSendItAuthCounter(aYouSendIt) {</span>
<a href="#l14.539"></a><span id="l14.539" class="difflineplus">+  this._server = null;</span>
<a href="#l14.540"></a><span id="l14.540" class="difflineplus">+  this._ysi = aYouSendIt;</span>
<a href="#l14.541"></a><span id="l14.541" class="difflineplus">+  this.count = 0;</span>
<a href="#l14.542"></a><span id="l14.542" class="difflineplus">+}</span>
<a href="#l14.543"></a><span id="l14.543" class="difflineplus">+</span>
<a href="#l14.544"></a><span id="l14.544" class="difflineplus">+MockYouSendItAuthCounter.prototype = {</span>
<a href="#l14.545"></a><span id="l14.545" class="difflineplus">+</span>
<a href="#l14.546"></a><span id="l14.546" class="difflineplus">+  init: function(aServer) {</span>
<a href="#l14.547"></a><span id="l14.547" class="difflineplus">+    this._server = aServer;</span>
<a href="#l14.548"></a><span id="l14.548" class="difflineplus">+    this._server.registerPathHandler(kAuthPath, this._auth.bind(this));</span>
<a href="#l14.549"></a><span id="l14.549" class="difflineplus">+  },</span>
<a href="#l14.550"></a><span id="l14.550" class="difflineplus">+</span>
<a href="#l14.551"></a><span id="l14.551" class="difflineplus">+  _auth: function(aRequest, aResponse) {</span>
<a href="#l14.552"></a><span id="l14.552" class="difflineplus">+    this.count += 1;</span>
<a href="#l14.553"></a><span id="l14.553" class="difflineplus">+    aResponse.setStatusLine(null, 200, &quot;OK&quot;);</span>
<a href="#l14.554"></a><span id="l14.554" class="difflineplus">+    aResponse.setHeader(&quot;Content-Type&quot;, &quot;application/json&quot;);</span>
<a href="#l14.555"></a><span id="l14.555" class="difflineplus">+    aResponse.write(JSON.stringify(kAuthResult));</span>
<a href="#l14.556"></a><span id="l14.556" class="difflineplus">+  },</span>
<a href="#l14.557"></a><span id="l14.557" class="difflineplus">+</span>
<a href="#l14.558"></a><span id="l14.558" class="difflineplus">+  shutdown: function() {</span>
<a href="#l14.559"></a><span id="l14.559" class="difflineplus">+    this._server.registerPathHandler(kAuthPath, null);</span>
<a href="#l14.560"></a><span id="l14.560" class="difflineplus">+    this._server = null;</span>
<a href="#l14.561"></a><span id="l14.561" class="difflineplus">+    this._auth = null;</span>
<a href="#l14.562"></a><span id="l14.562" class="difflineplus">+  },</span>
<a href="#l14.563"></a><span id="l14.563" class="difflineplus">+}</span>
<a href="#l14.564"></a><span id="l14.564" class="difflineplus">+</span>
<a href="#l14.565"></a><span id="l14.565" class="difflineplus">+/**</span>
<a href="#l14.566"></a><span id="l14.566" class="difflineplus">+ * Adds a username and password pair to nsILoginManager</span>
<a href="#l14.567"></a><span id="l14.567" class="difflineplus">+ * for the YouSendIt provider instance to retrieve. This may</span>
<a href="#l14.568"></a><span id="l14.568" class="difflineplus">+ * fail if a password already exists for aUserrname.</span>
<a href="#l14.569"></a><span id="l14.569" class="difflineplus">+ *</span>
<a href="#l14.570"></a><span id="l14.570" class="difflineplus">+ * @param aUsername the username to save the password for</span>
<a href="#l14.571"></a><span id="l14.571" class="difflineplus">+ * @param aPassword the password to save</span>
<a href="#l14.572"></a><span id="l14.572" class="difflineplus">+ */</span>
<a href="#l14.573"></a><span id="l14.573" class="difflineplus">+function remember_ysi_credentials(aUsername, aPassword) {</span>
<a href="#l14.574"></a><span id="l14.574" class="difflineplus">+  let loginInfo = Cc[&quot;@mozilla.org/login-manager/loginInfo;1&quot;]</span>
<a href="#l14.575"></a><span id="l14.575" class="difflineplus">+                  .createInstance(Ci.nsILoginInfo);</span>
<a href="#l14.576"></a><span id="l14.576" class="difflineplus">+</span>
<a href="#l14.577"></a><span id="l14.577" class="difflineplus">+  loginInfo.init(kServerURL, null, kServerURL, aUsername,</span>
<a href="#l14.578"></a><span id="l14.578" class="difflineplus">+                 aPassword, &quot;&quot;, &quot;&quot;);</span>
<a href="#l14.579"></a><span id="l14.579" class="difflineplus">+  Services.logins.addLogin(loginInfo);</span>
<a href="#l14.580"></a><span id="l14.580" class="difflineplus">+}</span>
<a href="#l14.581"></a><span id="l14.581" class="difflineplus">+</span>
<a href="#l14.582"></a><span id="l14.582" class="difflineplus">+/**</span>
<a href="#l14.583"></a><span id="l14.583" class="difflineplus">+ * Utility functions</span>
<a href="#l14.584"></a><span id="l14.584" class="difflineplus">+ */</span>
<a href="#l14.585"></a><span id="l14.585" class="difflineplus">+</span>
<a href="#l14.586"></a><span id="l14.586" class="difflineplus">+function generateObservableRequestHandler(aKey, aValue, aString, aOptions) {</span>
<a href="#l14.587"></a><span id="l14.587" class="difflineplus">+  aOptions = overrideDefault(kDefaultReturnHeader, aOptions);</span>
<a href="#l14.588"></a><span id="l14.588" class="difflineplus">+</span>
<a href="#l14.589"></a><span id="l14.589" class="difflineplus">+  let subjectString = Cc[&quot;@mozilla.org/supports-string;1&quot;]</span>
<a href="#l14.590"></a><span id="l14.590" class="difflineplus">+                      .createInstance(Ci.nsISupportsString);</span>
<a href="#l14.591"></a><span id="l14.591" class="difflineplus">+  subjectString.data = aString;</span>
<a href="#l14.592"></a><span id="l14.592" class="difflineplus">+</span>
<a href="#l14.593"></a><span id="l14.593" class="difflineplus">+  let func = function(aMeta, aResponse) {</span>
<a href="#l14.594"></a><span id="l14.594" class="difflineplus">+    aResponse.setStatusLine(null, aOptions.statusCode,</span>
<a href="#l14.595"></a><span id="l14.595" class="difflineplus">+                            aOptions.statusString);</span>
<a href="#l14.596"></a><span id="l14.596" class="difflineplus">+    aResponse.setHeader(&quot;Content-Type&quot;, aOptions.contentType);</span>
<a href="#l14.597"></a><span id="l14.597" class="difflineplus">+    aResponse.write(aString);</span>
<a href="#l14.598"></a><span id="l14.598" class="difflineplus">+    Services.obs.notifyObservers(subjectString, aKey, aValue);</span>
<a href="#l14.599"></a><span id="l14.599" class="difflineplus">+  }</span>
<a href="#l14.600"></a><span id="l14.600" class="difflineplus">+  return func;</span>
<a href="#l14.601"></a><span id="l14.601" class="difflineplus">+}</span>
<a href="#l14.602"></a><span id="l14.602" class="difflineplus">+</span>
<a href="#l14.603"></a><span id="l14.603" class="difflineplus">+function overrideDefault(aDefault, aData) {</span>
<a href="#l14.604"></a><span id="l14.604" class="difflineplus">+  if (aData === undefined)</span>
<a href="#l14.605"></a><span id="l14.605" class="difflineplus">+    return aDefault;</span>
<a href="#l14.606"></a><span id="l14.606" class="difflineplus">+</span>
<a href="#l14.607"></a><span id="l14.607" class="difflineplus">+  for (let param in aDefault) {</span>
<a href="#l14.608"></a><span id="l14.608" class="difflineplus">+    if (param in aData)</span>
<a href="#l14.609"></a><span id="l14.609" class="difflineplus">+      aDefault[param] = aData[param];</span>
<a href="#l14.610"></a><span id="l14.610" class="difflineplus">+  }</span>
<a href="#l14.611"></a><span id="l14.611" class="difflineplus">+  return aDefault;</span>
<a href="#l14.612"></a><span id="l14.612" class="difflineplus">+}</span>
<a href="#l14.613"></a><span id="l14.613" class="difflineplus">+</span>
<a href="#l14.614"></a><span id="l14.614" class="difflineplus">+</span>
<a href="#l14.615"></a><span id="l14.615" class="difflineplus">+/**</span>
<a href="#l14.616"></a><span id="l14.616" class="difflineplus">+ * Large swaths of this were liberally stolen from </span>
<a href="#l14.617"></a><span id="l14.617" class="difflineplus">+ * mozilla/toolkit/crashreporter/test/browser/crashreport.sjs</span>
<a href="#l14.618"></a><span id="l14.618" class="difflineplus">+ *</span>
<a href="#l14.619"></a><span id="l14.619" class="difflineplus">+ */</span>
<a href="#l14.620"></a><span id="l14.620" class="difflineplus">+function generateUUID() {</span>
<a href="#l14.621"></a><span id="l14.621" class="difflineplus">+  let uuidGen = Cc[&quot;@mozilla.org/uuid-generator;1&quot;]</span>
<a href="#l14.622"></a><span id="l14.622" class="difflineplus">+                  .getService(Ci.nsIUUIDGenerator);</span>
<a href="#l14.623"></a><span id="l14.623" class="difflineplus">+  let uuid = uuidGen.generateUUID().toString();</span>
<a href="#l14.624"></a><span id="l14.624" class="difflineplus">+  return uuid.substring(1, uuid.length - 2);</span>
<a href="#l14.625"></a><span id="l14.625" class="difflineplus">+  </span>
<a href="#l14.626"></a><span id="l14.626" class="difflineplus">+}</span>
<a href="#l14.627"></a><span id="l14.627" class="difflineplus">+</span>
<a href="#l14.628"></a><span id="l14.628" class="difflineplus">+function parseHeaders(data, start)</span>
<a href="#l14.629"></a><span id="l14.629" class="difflineplus">+{</span>
<a href="#l14.630"></a><span id="l14.630" class="difflineplus">+  let headers = {};</span>
<a href="#l14.631"></a><span id="l14.631" class="difflineplus">+</span>
<a href="#l14.632"></a><span id="l14.632" class="difflineplus">+  while (true) {</span>
<a href="#l14.633"></a><span id="l14.633" class="difflineplus">+    let done = false;</span>
<a href="#l14.634"></a><span id="l14.634" class="difflineplus">+    let end = data.indexOf(&quot;\r\n&quot;, start);</span>
<a href="#l14.635"></a><span id="l14.635" class="difflineplus">+    if (end == -1) {</span>
<a href="#l14.636"></a><span id="l14.636" class="difflineplus">+      done = true;</span>
<a href="#l14.637"></a><span id="l14.637" class="difflineplus">+      end = data.length;</span>
<a href="#l14.638"></a><span id="l14.638" class="difflineplus">+    }</span>
<a href="#l14.639"></a><span id="l14.639" class="difflineplus">+    let line = data.substring(start, end);</span>
<a href="#l14.640"></a><span id="l14.640" class="difflineplus">+    start = end + 2;</span>
<a href="#l14.641"></a><span id="l14.641" class="difflineplus">+    if (line == &quot;&quot;)</span>
<a href="#l14.642"></a><span id="l14.642" class="difflineplus">+      // empty line, we're done</span>
<a href="#l14.643"></a><span id="l14.643" class="difflineplus">+      break;</span>
<a href="#l14.644"></a><span id="l14.644" class="difflineplus">+</span>
<a href="#l14.645"></a><span id="l14.645" class="difflineplus">+    //XXX: this doesn't handle multi-line headers. do we care?</span>
<a href="#l14.646"></a><span id="l14.646" class="difflineplus">+    let [name, value] = line.split(':');</span>
<a href="#l14.647"></a><span id="l14.647" class="difflineplus">+    //XXX: not normalized, should probably use nsHttpHeaders or something</span>
<a href="#l14.648"></a><span id="l14.648" class="difflineplus">+    headers[name] = value.trimLeft();</span>
<a href="#l14.649"></a><span id="l14.649" class="difflineplus">+  }</span>
<a href="#l14.650"></a><span id="l14.650" class="difflineplus">+  return [headers, start];</span>
<a href="#l14.651"></a><span id="l14.651" class="difflineplus">+}</span>
<a href="#l14.652"></a><span id="l14.652" class="difflineplus">+</span>
<a href="#l14.653"></a><span id="l14.653" class="difflineplus">+function parseMultipartForm(request)</span>
<a href="#l14.654"></a><span id="l14.654" class="difflineplus">+{</span>
<a href="#l14.655"></a><span id="l14.655" class="difflineplus">+  let boundary = null;</span>
<a href="#l14.656"></a><span id="l14.656" class="difflineplus">+  // See if this is a multipart/form-data request, and if so, find the</span>
<a href="#l14.657"></a><span id="l14.657" class="difflineplus">+  // boundary string</span>
<a href="#l14.658"></a><span id="l14.658" class="difflineplus">+  if (request.hasHeader(&quot;Content-Type&quot;)) {</span>
<a href="#l14.659"></a><span id="l14.659" class="difflineplus">+    var contenttype = request.getHeader(&quot;Content-Type&quot;);</span>
<a href="#l14.660"></a><span id="l14.660" class="difflineplus">+    var bits = contenttype.split(&quot;;&quot;);</span>
<a href="#l14.661"></a><span id="l14.661" class="difflineplus">+    if (bits[0] == &quot;multipart/form-data&quot;) {</span>
<a href="#l14.662"></a><span id="l14.662" class="difflineplus">+      for (var i = 1; i &lt; bits.length; i++) {</span>
<a href="#l14.663"></a><span id="l14.663" class="difflineplus">+        var b = bits[i].trimLeft();</span>
<a href="#l14.664"></a><span id="l14.664" class="difflineplus">+        if (b.indexOf(&quot;boundary=&quot;) == 0) {</span>
<a href="#l14.665"></a><span id="l14.665" class="difflineplus">+          // grab everything after boundary=</span>
<a href="#l14.666"></a><span id="l14.666" class="difflineplus">+          boundary = &quot;--&quot; + b.substring(9);</span>
<a href="#l14.667"></a><span id="l14.667" class="difflineplus">+          break;</span>
<a href="#l14.668"></a><span id="l14.668" class="difflineplus">+        }</span>
<a href="#l14.669"></a><span id="l14.669" class="difflineplus">+      }</span>
<a href="#l14.670"></a><span id="l14.670" class="difflineplus">+    }</span>
<a href="#l14.671"></a><span id="l14.671" class="difflineplus">+  }</span>
<a href="#l14.672"></a><span id="l14.672" class="difflineplus">+  if (boundary == null)</span>
<a href="#l14.673"></a><span id="l14.673" class="difflineplus">+    return null;</span>
<a href="#l14.674"></a><span id="l14.674" class="difflineplus">+</span>
<a href="#l14.675"></a><span id="l14.675" class="difflineplus">+  let body = Cc[&quot;@mozilla.org/binaryinputstream;1&quot;]</span>
<a href="#l14.676"></a><span id="l14.676" class="difflineplus">+               .createInstance(Ci.nsIBinaryInputStream);</span>
<a href="#l14.677"></a><span id="l14.677" class="difflineplus">+  body.setInputStream(request.bodyInputStream);</span>
<a href="#l14.678"></a><span id="l14.678" class="difflineplus">+</span>
<a href="#l14.679"></a><span id="l14.679" class="difflineplus">+  let avail;</span>
<a href="#l14.680"></a><span id="l14.680" class="difflineplus">+  let bytes = [];</span>
<a href="#l14.681"></a><span id="l14.681" class="difflineplus">+  while ((avail = body.available()) &gt; 0)</span>
<a href="#l14.682"></a><span id="l14.682" class="difflineplus">+    Array.prototype.push.apply(bytes, body.readByteArray(avail));</span>
<a href="#l14.683"></a><span id="l14.683" class="difflineplus">+  let data = String.fromCharCode.apply(null, bytes);</span>
<a href="#l14.684"></a><span id="l14.684" class="difflineplus">+  let formData = {};</span>
<a href="#l14.685"></a><span id="l14.685" class="difflineplus">+  let done = false;</span>
<a href="#l14.686"></a><span id="l14.686" class="difflineplus">+  let start = 0;</span>
<a href="#l14.687"></a><span id="l14.687" class="difflineplus">+  while (true) {</span>
<a href="#l14.688"></a><span id="l14.688" class="difflineplus">+    // read first line</span>
<a href="#l14.689"></a><span id="l14.689" class="difflineplus">+    let end = data.indexOf(&quot;\r\n&quot;, start);</span>
<a href="#l14.690"></a><span id="l14.690" class="difflineplus">+    if (end == -1) {</span>
<a href="#l14.691"></a><span id="l14.691" class="difflineplus">+      done = true;</span>
<a href="#l14.692"></a><span id="l14.692" class="difflineplus">+      end = data.length;</span>
<a href="#l14.693"></a><span id="l14.693" class="difflineplus">+    }</span>
<a href="#l14.694"></a><span id="l14.694" class="difflineplus">+</span>
<a href="#l14.695"></a><span id="l14.695" class="difflineplus">+    let line = data.substring(start, end);</span>
<a href="#l14.696"></a><span id="l14.696" class="difflineplus">+    // look for closing boundary delimiter line</span>
<a href="#l14.697"></a><span id="l14.697" class="difflineplus">+    if (line == boundary + &quot;--&quot;) {</span>
<a href="#l14.698"></a><span id="l14.698" class="difflineplus">+      break;</span>
<a href="#l14.699"></a><span id="l14.699" class="difflineplus">+    }</span>
<a href="#l14.700"></a><span id="l14.700" class="difflineplus">+</span>
<a href="#l14.701"></a><span id="l14.701" class="difflineplus">+    if (line != boundary) {</span>
<a href="#l14.702"></a><span id="l14.702" class="difflineplus">+      dump(&quot;expected boundary line but didn't find it!&quot;);</span>
<a href="#l14.703"></a><span id="l14.703" class="difflineplus">+      break;</span>
<a href="#l14.704"></a><span id="l14.704" class="difflineplus">+    }</span>
<a href="#l14.705"></a><span id="l14.705" class="difflineplus">+</span>
<a href="#l14.706"></a><span id="l14.706" class="difflineplus">+    // parse headers</span>
<a href="#l14.707"></a><span id="l14.707" class="difflineplus">+    start = end + 2;</span>
<a href="#l14.708"></a><span id="l14.708" class="difflineplus">+    let headers = null;</span>
<a href="#l14.709"></a><span id="l14.709" class="difflineplus">+    [headers, start] = parseHeaders(data, start);</span>
<a href="#l14.710"></a><span id="l14.710" class="difflineplus">+</span>
<a href="#l14.711"></a><span id="l14.711" class="difflineplus">+    // find next boundary string</span>
<a href="#l14.712"></a><span id="l14.712" class="difflineplus">+    end = data.indexOf(&quot;\r\n&quot; + boundary, start);</span>
<a href="#l14.713"></a><span id="l14.713" class="difflineplus">+    if (end == -1) {</span>
<a href="#l14.714"></a><span id="l14.714" class="difflineplus">+      dump(&quot;couldn't find next boundary string\n&quot;);</span>
<a href="#l14.715"></a><span id="l14.715" class="difflineplus">+      break;</span>
<a href="#l14.716"></a><span id="l14.716" class="difflineplus">+    }</span>
<a href="#l14.717"></a><span id="l14.717" class="difflineplus">+</span>
<a href="#l14.718"></a><span id="l14.718" class="difflineplus">+    // read part data, stick in formData using Content-Disposition header</span>
<a href="#l14.719"></a><span id="l14.719" class="difflineplus">+    let part = data.substring(start, end);</span>
<a href="#l14.720"></a><span id="l14.720" class="difflineplus">+    start = end + 2;</span>
<a href="#l14.721"></a><span id="l14.721" class="difflineplus">+</span>
<a href="#l14.722"></a><span id="l14.722" class="difflineplus">+    if (&quot;Content-Disposition&quot; in headers) {</span>
<a href="#l14.723"></a><span id="l14.723" class="difflineplus">+      let bits = headers[&quot;Content-Disposition&quot;].split(';');</span>
<a href="#l14.724"></a><span id="l14.724" class="difflineplus">+      if (bits[0] == 'form-data') {</span>
<a href="#l14.725"></a><span id="l14.725" class="difflineplus">+        for (let i = 0; i &lt; bits.length; i++) {</span>
<a href="#l14.726"></a><span id="l14.726" class="difflineplus">+          let b = bits[i].trimLeft();</span>
<a href="#l14.727"></a><span id="l14.727" class="difflineplus">+          if (b.indexOf('name=') == 0) {</span>
<a href="#l14.728"></a><span id="l14.728" class="difflineplus">+            //TODO: handle non-ascii here?</span>
<a href="#l14.729"></a><span id="l14.729" class="difflineplus">+            let name = b.substring(6, b.length - 1);</span>
<a href="#l14.730"></a><span id="l14.730" class="difflineplus">+            //TODO: handle multiple-value properties?</span>
<a href="#l14.731"></a><span id="l14.731" class="difflineplus">+            formData[name] = part;</span>
<a href="#l14.732"></a><span id="l14.732" class="difflineplus">+          }</span>
<a href="#l14.733"></a><span id="l14.733" class="difflineplus">+          if (b.indexOf('filename=') == 0) {</span>
<a href="#l14.734"></a><span id="l14.734" class="difflineplus">+            let filename = b.substring(10, b.length - 1);</span>
<a href="#l14.735"></a><span id="l14.735" class="difflineplus">+            formData['filename'] = filename;</span>
<a href="#l14.736"></a><span id="l14.736" class="difflineplus">+          }</span>
<a href="#l14.737"></a><span id="l14.737" class="difflineplus">+          //TODO: handle filename= ?</span>
<a href="#l14.738"></a><span id="l14.738" class="difflineplus">+          //TODO: handle multipart/mixed for multi-file uploads?</span>
<a href="#l14.739"></a><span id="l14.739" class="difflineplus">+        }</span>
<a href="#l14.740"></a><span id="l14.740" class="difflineplus">+      }</span>
<a href="#l14.741"></a><span id="l14.741" class="difflineplus">+    }</span>
<a href="#l14.742"></a><span id="l14.742" class="difflineplus">+  }</span>
<a href="#l14.743"></a><span id="l14.743" class="difflineplus">+  return formData;</span>
<a href="#l14.744"></a><span id="l14.744" class="difflineplus">+}</span>
<a href="#l14.745"></a><span id="l14.745" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1">new file mode 100644</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineminus">--- /dev/null</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-mock-object-helpers.js</span>
<a href="#l15.4"></a><span id="l15.4" class="difflineat">@@ -0,0 +1,173 @@</span>
<a href="#l15.5"></a><span id="l15.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l15.6"></a><span id="l15.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l15.7"></a><span id="l15.7" class="difflineplus">+  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l15.8"></a><span id="l15.8" class="difflineplus">+</span>
<a href="#l15.9"></a><span id="l15.9" class="difflineplus">+const MODULE_NAME = 'mock-object-helpers';</span>
<a href="#l15.10"></a><span id="l15.10" class="difflineplus">+const RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l15.11"></a><span id="l15.11" class="difflineplus">+const MODULE_REQUIRES = [];</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+let Cm = Components.manager;</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+let Ci = Components.interfaces;</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+function installInto(module) {</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineplus">+  module.MockObjectReplacer = MockObjectSwapper;</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineplus">+  module.MockObjectRegisterer = MockObjectRegisterer;</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineplus">+}</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineplus">+</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineplus">+function MockObjectRegisterer(aContractID, aCID, aComponent) {</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineplus">+  this._contractID = aContractID;</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineplus">+  this._cid = Components.ID(&quot;{&quot; + aCID + &quot;}&quot;);</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineplus">+  this._component = aComponent;</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineplus">+}</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineplus">+</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineplus">+MockObjectRegisterer.prototype = {</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineplus">+  register: function MOR_register() {</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineplus">+    let providedConstructor = this._component;</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineplus">+    this._mockFactory = {</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineplus">+      createInstance: function MF_createInstance(aOuter, aIid) {</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+        if (aOuter != null)</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+          throw Components.results.NS_ERROR_NO_AGGREGATION;</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+        return new providedConstructor().QueryInterface(aIid);</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+      }</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineplus">+    };</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineplus">+   let componentRegistrar = Cm.QueryInterface(Ci.nsIComponentRegistrar);</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineplus">+</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineplus">+   componentRegistrar.registerFactory(this._cid,</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineplus">+        &quot;&quot;,</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineplus">+        this._contractID,</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineplus">+        this._mockFactory);</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineplus">+  },</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineplus">+</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineplus">+  unregister: function MOR_unregister() {</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineplus">+</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineplus">+    let componentRegistrar = Cm.QueryInterface(Ci.nsIComponentRegistrar);</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineplus">+</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineplus">+ </span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+    componentRegistrar.unregisterFactory(this._cid,</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineplus">+        this._mockFactory);</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineplus">+  },</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineplus">+}</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineplus">+</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineplus">+/**</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineplus">+ * Allows registering a mock XPCOM component, that temporarily replaces the</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineplus">+ *  original one when an object implementing a given ContractID is requested</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineplus">+ *  using createInstance.</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineplus">+ *</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineplus">+ * @param aContractID</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineplus">+ *        The ContractID of the component to replace, for example</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineplus">+ *        &quot;@mozilla.org/filepicker;1&quot;.</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineplus">+ *</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineplus">+ * @param aReplacementCtor</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineplus">+ *        The constructor function for the JavaScript object that will be</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineplus">+ *        created every time createInstance is called. This object must</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineplus">+ *        implement QueryInterface and provide the XPCOM interfaces required by</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineplus">+ *        the specified ContractID (for example</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineplus">+ *        Components.interfaces.nsIFilePicker).</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineplus">+ */</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineplus">+</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineplus">+function MockObjectReplacer(aContractID, aReplacementCtor) {</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineplus">+  this._contractID = aContractID;</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineplus">+  this._replacementCtor = aReplacementCtor;</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineplus">+}</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineplus">+</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineplus">+MockObjectReplacer.prototype = {</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineplus">+  /**</span>
<a href="#l15.80"></a><span id="l15.80" class="difflineplus">+   * Replaces the current factory with one that returns a new mock object.</span>
<a href="#l15.81"></a><span id="l15.81" class="difflineplus">+   *</span>
<a href="#l15.82"></a><span id="l15.82" class="difflineplus">+   * After register() has been called, it is mandatory to call unregister() to</span>
<a href="#l15.83"></a><span id="l15.83" class="difflineplus">+   * restore the original component. Usually, you should use a try-catch block</span>
<a href="#l15.84"></a><span id="l15.84" class="difflineplus">+   * to ensure that unregister() is called.</span>
<a href="#l15.85"></a><span id="l15.85" class="difflineplus">+   */</span>
<a href="#l15.86"></a><span id="l15.86" class="difflineplus">+  register: function MORe_register() {</span>
<a href="#l15.87"></a><span id="l15.87" class="difflineplus">+    if (this._originalFactory)</span>
<a href="#l15.88"></a><span id="l15.88" class="difflineplus">+      throw Error(&quot;Invalid object state when calling register()&quot;);</span>
<a href="#l15.89"></a><span id="l15.89" class="difflineplus">+</span>
<a href="#l15.90"></a><span id="l15.90" class="difflineplus">+    // Define a factory that creates a new object using the given constructor.</span>
<a href="#l15.91"></a><span id="l15.91" class="difflineplus">+    var providedConstructor = this._replacementCtor;</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineplus">+    this._mockFactory = {</span>
<a href="#l15.93"></a><span id="l15.93" class="difflineplus">+      createInstance: function MF_createInstance(aOuter, aIid) {</span>
<a href="#l15.94"></a><span id="l15.94" class="difflineplus">+        if (aOuter != null)</span>
<a href="#l15.95"></a><span id="l15.95" class="difflineplus">+          throw Components.results.NS_ERROR_NO_AGGREGATION;</span>
<a href="#l15.96"></a><span id="l15.96" class="difflineplus">+        return new providedConstructor().QueryInterface(aIid);</span>
<a href="#l15.97"></a><span id="l15.97" class="difflineplus">+      }</span>
<a href="#l15.98"></a><span id="l15.98" class="difflineplus">+    };</span>
<a href="#l15.99"></a><span id="l15.99" class="difflineplus">+</span>
<a href="#l15.100"></a><span id="l15.100" class="difflineplus">+    var retVal = swapFactoryRegistration(this._cid, this._contractID, this._mockFactory, this._originalFactory);</span>
<a href="#l15.101"></a><span id="l15.101" class="difflineplus">+    if ('error' in retVal) {</span>
<a href="#l15.102"></a><span id="l15.102" class="difflineplus">+      throw new Exception(&quot;ERROR: &quot; + retVal.error);</span>
<a href="#l15.103"></a><span id="l15.103" class="difflineplus">+    } else {</span>
<a href="#l15.104"></a><span id="l15.104" class="difflineplus">+      this._cid = retVal.cid;</span>
<a href="#l15.105"></a><span id="l15.105" class="difflineplus">+      this._originalFactory = retVal.originalFactory;</span>
<a href="#l15.106"></a><span id="l15.106" class="difflineplus">+    }</span>
<a href="#l15.107"></a><span id="l15.107" class="difflineplus">+  },</span>
<a href="#l15.108"></a><span id="l15.108" class="difflineplus">+</span>
<a href="#l15.109"></a><span id="l15.109" class="difflineplus">+  /**</span>
<a href="#l15.110"></a><span id="l15.110" class="difflineplus">+   * Restores the original factory.</span>
<a href="#l15.111"></a><span id="l15.111" class="difflineplus">+   */</span>
<a href="#l15.112"></a><span id="l15.112" class="difflineplus">+  unregister: function MORe_unregister() {</span>
<a href="#l15.113"></a><span id="l15.113" class="difflineplus">+    if (!this._originalFactory)</span>
<a href="#l15.114"></a><span id="l15.114" class="difflineplus">+      throw Error(&quot;Invalid object state when calling unregister()&quot;);</span>
<a href="#l15.115"></a><span id="l15.115" class="difflineplus">+</span>
<a href="#l15.116"></a><span id="l15.116" class="difflineplus">+    // Free references to the mock factory.</span>
<a href="#l15.117"></a><span id="l15.117" class="difflineplus">+    swapFactoryRegistration(this._cid, this._contractID, this._mockFactory, this._originalFactory);</span>
<a href="#l15.118"></a><span id="l15.118" class="difflineplus">+</span>
<a href="#l15.119"></a><span id="l15.119" class="difflineplus">+    // Allow registering a mock factory again later.</span>
<a href="#l15.120"></a><span id="l15.120" class="difflineplus">+    this._cid = null;</span>
<a href="#l15.121"></a><span id="l15.121" class="difflineplus">+    this._originalFactory = null;</span>
<a href="#l15.122"></a><span id="l15.122" class="difflineplus">+    this._mockFactory = null;</span>
<a href="#l15.123"></a><span id="l15.123" class="difflineplus">+  },</span>
<a href="#l15.124"></a><span id="l15.124" class="difflineplus">+</span>
<a href="#l15.125"></a><span id="l15.125" class="difflineplus">+  // --- Private methods and properties ---</span>
<a href="#l15.126"></a><span id="l15.126" class="difflineplus">+</span>
<a href="#l15.127"></a><span id="l15.127" class="difflineplus">+  /**</span>
<a href="#l15.128"></a><span id="l15.128" class="difflineplus">+   * The factory of the component being replaced.</span>
<a href="#l15.129"></a><span id="l15.129" class="difflineplus">+   */</span>
<a href="#l15.130"></a><span id="l15.130" class="difflineplus">+  _originalFactory: null,</span>
<a href="#l15.131"></a><span id="l15.131" class="difflineplus">+</span>
<a href="#l15.132"></a><span id="l15.132" class="difflineplus">+  /**</span>
<a href="#l15.133"></a><span id="l15.133" class="difflineplus">+   * The CID under which the mock contractID was registered.</span>
<a href="#l15.134"></a><span id="l15.134" class="difflineplus">+   */</span>
<a href="#l15.135"></a><span id="l15.135" class="difflineplus">+  _cid: null,</span>
<a href="#l15.136"></a><span id="l15.136" class="difflineplus">+</span>
<a href="#l15.137"></a><span id="l15.137" class="difflineplus">+  /**</span>
<a href="#l15.138"></a><span id="l15.138" class="difflineplus">+   * The nsIFactory that was automatically generated by this object.</span>
<a href="#l15.139"></a><span id="l15.139" class="difflineplus">+   */</span>
<a href="#l15.140"></a><span id="l15.140" class="difflineplus">+  _mockFactory: null</span>
<a href="#l15.141"></a><span id="l15.141" class="difflineplus">+}</span>
<a href="#l15.142"></a><span id="l15.142" class="difflineplus">+</span>
<a href="#l15.143"></a><span id="l15.143" class="difflineplus">+/**</span>
<a href="#l15.144"></a><span id="l15.144" class="difflineplus">+ * Swiped from mozilla/testing/mochitest/tests/SimpleTest/specialpowersAPI.js</span>
<a href="#l15.145"></a><span id="l15.145" class="difflineplus">+ */</span>
<a href="#l15.146"></a><span id="l15.146" class="difflineplus">+function swapFactoryRegistration(cid, contractID, newFactory, oldFactory) {</span>
<a href="#l15.147"></a><span id="l15.147" class="difflineplus">+  var componentRegistrar = Components</span>
<a href="#l15.148"></a><span id="l15.148" class="difflineplus">+                           .manager</span>
<a href="#l15.149"></a><span id="l15.149" class="difflineplus">+                           .QueryInterface(Components.interfaces.nsIComponentRegistrar);</span>
<a href="#l15.150"></a><span id="l15.150" class="difflineplus">+</span>
<a href="#l15.151"></a><span id="l15.151" class="difflineplus">+  var unregisterFactory = newFactory;</span>
<a href="#l15.152"></a><span id="l15.152" class="difflineplus">+  var registerFactory = oldFactory;</span>
<a href="#l15.153"></a><span id="l15.153" class="difflineplus">+</span>
<a href="#l15.154"></a><span id="l15.154" class="difflineplus">+  if (cid == null) {</span>
<a href="#l15.155"></a><span id="l15.155" class="difflineplus">+    if (contractID != null) {</span>
<a href="#l15.156"></a><span id="l15.156" class="difflineplus">+      cid = componentRegistrar.contractIDToCID(contractID);</span>
<a href="#l15.157"></a><span id="l15.157" class="difflineplus">+      oldFactory = Components.manager.getClassObject(Components.classes[contractID],</span>
<a href="#l15.158"></a><span id="l15.158" class="difflineplus">+          Components.interfaces.nsIFactory);</span>
<a href="#l15.159"></a><span id="l15.159" class="difflineplus">+    } else {</span>
<a href="#l15.160"></a><span id="l15.160" class="difflineplus">+      return {'error': &quot;trying to register a new contract ID: Missing contractID&quot;};</span>
<a href="#l15.161"></a><span id="l15.161" class="difflineplus">+    }</span>
<a href="#l15.162"></a><span id="l15.162" class="difflineplus">+</span>
<a href="#l15.163"></a><span id="l15.163" class="difflineplus">+    unregisterFactory = oldFactory;</span>
<a href="#l15.164"></a><span id="l15.164" class="difflineplus">+    registerFactory = newFactory;</span>
<a href="#l15.165"></a><span id="l15.165" class="difflineplus">+  }</span>
<a href="#l15.166"></a><span id="l15.166" class="difflineplus">+</span>
<a href="#l15.167"></a><span id="l15.167" class="difflineplus">+  componentRegistrar.unregisterFactory(cid,</span>
<a href="#l15.168"></a><span id="l15.168" class="difflineplus">+      unregisterFactory);</span>
<a href="#l15.169"></a><span id="l15.169" class="difflineplus">+</span>
<a href="#l15.170"></a><span id="l15.170" class="difflineplus">+  // Restore the original factory.</span>
<a href="#l15.171"></a><span id="l15.171" class="difflineplus">+  componentRegistrar.registerFactory(cid,</span>
<a href="#l15.172"></a><span id="l15.172" class="difflineplus">+      &quot;&quot;,</span>
<a href="#l15.173"></a><span id="l15.173" class="difflineplus">+      contractID,</span>
<a href="#l15.174"></a><span id="l15.174" class="difflineplus">+      registerFactory);</span>
<a href="#l15.175"></a><span id="l15.175" class="difflineplus">+  return {'cid':cid, 'originalFactory':oldFactory};</span>
<a href="#l15.176"></a><span id="l15.176" class="difflineplus">+}</span>
<a href="#l15.177"></a><span id="l15.177" class="difflineplus">+</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

