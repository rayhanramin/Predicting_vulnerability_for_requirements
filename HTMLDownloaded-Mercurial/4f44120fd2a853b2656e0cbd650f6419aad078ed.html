<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 111:4f44120fd2a853b2656e0cbd650f6419aad078ed</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 4f44120fd2a853b2656e0cbd650f6419aad078ed" />
<meta property="og:url" content="/comm-central/rev/4f44120fd2a853b2656e0cbd650f6419aad078ed" />
<meta property="og:description" content="Bug 449618 -- Move cardForEmailAddress to nsIAbDirectory r=Standard8, sr=dmose" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 4f44120fd2a853b2656e0cbd650f6419aad078ed 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/4f44120fd2a853b2656e0cbd650f6419aad078ed">shortlog</a> |
<a href="/comm-central/log/4f44120fd2a853b2656e0cbd650f6419aad078ed">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/4f44120fd2a853b2656e0cbd650f6419aad078ed">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/4f44120fd2a853b2656e0cbd650f6419aad078ed">files</a> |
changeset |
<a href="/comm-central/raw-rev/4f44120fd2a853b2656e0cbd650f6419aad078ed">raw</a>  | <a href="/comm-central/archive/4f44120fd2a853b2656e0cbd650f6419aad078ed.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=449618">Bug 449618</a> -- Move cardForEmailAddress to nsIAbDirectory r=Standard8, sr=dmose
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#115;&#104;&#117;&#97;&#32;&#67;&#114;&#97;&#110;&#109;&#101;&#114;&#32;&#60;&#80;&#105;&#100;&#103;&#101;&#111;&#116;&#49;&#56;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Sat, 16 Aug 2008 10:54:28 -0400</td></tr>

<tr>
 <td>changeset 111</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/4f44120fd2a853b2656e0cbd650f6419aad078ed">4f44120fd2a853b2656e0cbd650f6419aad078ed</a></td>
</tr>



<tr>
<td>parent 110</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/e7459764ea53341ccc872f910039ef62d9d4253b">e7459764ea53341ccc872f910039ef62d9d4253b</a>
</td>
</tr>

<tr>
<td>child 112</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/d126f83d690616436b237bbab549e69a292ca943">d126f83d690616436b237bbab549e69a292ca943</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=4f44120fd2a853b2656e0cbd650f6419aad078ed">98</a></td></tr>
<tr><td>push user</td><td>Pidgeot18@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Sat, 16 Aug 2008 14:54:50 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@4f44120fd2a8 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=4f44120fd2a853b2656e0cbd650f6419aad078ed">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=4f44120fd2a853b2656e0cbd650f6419aad078ed&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4f44120fd2a853b2656e0cbd650f6419aad078ed&newProject=comm-central&newRevision=4f44120fd2a853b2656e0cbd650f6419aad078ed&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4f44120fd2a853b2656e0cbd650f6419aad078ed&newProject=comm-central&newRevision=4f44120fd2a853b2656e0cbd650f6419aad078ed&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4f44120fd2a853b2656e0cbd650f6419aad078ed&newProject=comm-central&newRevision=4f44120fd2a853b2656e0cbd650f6419aad078ed&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Standard8%29&revcount=50">Standard8</a>, <a href="/comm-central/log?rev=reviewer%28dmose%29&revcount=50">dmose</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=449618">449618</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=449618">Bug 449618</a> -- Move cardForEmailAddress to nsIAbDirectory r=Standard8, sr=dmose</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4f44120fd2a853b2656e0cbd650f6419aad078ed/mail/base/content/mailWindowOverlay.js">mail/base/content/mailWindowOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4f44120fd2a853b2656e0cbd650f6419aad078ed/mail/base/content/mailWindowOverlay.js">file</a> |
<a href="/comm-central/annotate/4f44120fd2a853b2656e0cbd650f6419aad078ed/mail/base/content/mailWindowOverlay.js">annotate</a> |
<a href="/comm-central/diff/4f44120fd2a853b2656e0cbd650f6419aad078ed/mail/base/content/mailWindowOverlay.js">diff</a> |
<a href="/comm-central/comparison/4f44120fd2a853b2656e0cbd650f6419aad078ed/mail/base/content/mailWindowOverlay.js">comparison</a> |
<a href="/comm-central/log/4f44120fd2a853b2656e0cbd650f6419aad078ed/mail/base/content/mailWindowOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4f44120fd2a853b2656e0cbd650f6419aad078ed/mail/base/content/msgHdrViewOverlay.js">mail/base/content/msgHdrViewOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4f44120fd2a853b2656e0cbd650f6419aad078ed/mail/base/content/msgHdrViewOverlay.js">file</a> |
<a href="/comm-central/annotate/4f44120fd2a853b2656e0cbd650f6419aad078ed/mail/base/content/msgHdrViewOverlay.js">annotate</a> |
<a href="/comm-central/diff/4f44120fd2a853b2656e0cbd650f6419aad078ed/mail/base/content/msgHdrViewOverlay.js">diff</a> |
<a href="/comm-central/comparison/4f44120fd2a853b2656e0cbd650f6419aad078ed/mail/base/content/msgHdrViewOverlay.js">comparison</a> |
<a href="/comm-central/log/4f44120fd2a853b2656e0cbd650f6419aad078ed/mail/base/content/msgHdrViewOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/addrbook/public/nsIAbDirectory.idl">mailnews/addrbook/public/nsIAbDirectory.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/addrbook/public/nsIAbDirectory.idl">file</a> |
<a href="/comm-central/annotate/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/addrbook/public/nsIAbDirectory.idl">annotate</a> |
<a href="/comm-central/diff/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/addrbook/public/nsIAbDirectory.idl">diff</a> |
<a href="/comm-central/comparison/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/addrbook/public/nsIAbDirectory.idl">comparison</a> |
<a href="/comm-central/log/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/addrbook/public/nsIAbDirectory.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/addrbook/public/nsIAbMDBDirectory.idl">mailnews/addrbook/public/nsIAbMDBDirectory.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/addrbook/public/nsIAbMDBDirectory.idl">file</a> |
<a href="/comm-central/annotate/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/addrbook/public/nsIAbMDBDirectory.idl">annotate</a> |
<a href="/comm-central/diff/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/addrbook/public/nsIAbMDBDirectory.idl">diff</a> |
<a href="/comm-central/comparison/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/addrbook/public/nsIAbMDBDirectory.idl">comparison</a> |
<a href="/comm-central/log/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/addrbook/public/nsIAbMDBDirectory.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/addrbook/src/nsAbDirProperty.cpp">mailnews/addrbook/src/nsAbDirProperty.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/addrbook/src/nsAbDirProperty.cpp">file</a> |
<a href="/comm-central/annotate/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/addrbook/src/nsAbDirProperty.cpp">annotate</a> |
<a href="/comm-central/diff/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/addrbook/src/nsAbDirProperty.cpp">diff</a> |
<a href="/comm-central/comparison/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/addrbook/src/nsAbDirProperty.cpp">comparison</a> |
<a href="/comm-central/log/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/addrbook/src/nsAbDirProperty.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/addrbook/src/nsAbMDBDirProperty.cpp">mailnews/addrbook/src/nsAbMDBDirProperty.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/addrbook/src/nsAbMDBDirProperty.cpp">file</a> |
<a href="/comm-central/annotate/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/addrbook/src/nsAbMDBDirProperty.cpp">annotate</a> |
<a href="/comm-central/diff/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/addrbook/src/nsAbMDBDirProperty.cpp">diff</a> |
<a href="/comm-central/comparison/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/addrbook/src/nsAbMDBDirProperty.cpp">comparison</a> |
<a href="/comm-central/log/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/addrbook/src/nsAbMDBDirProperty.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/addrbook/test/unit/test_cardForEmail.js">mailnews/addrbook/test/unit/test_cardForEmail.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/addrbook/test/unit/test_cardForEmail.js">file</a> |
<a href="/comm-central/annotate/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/addrbook/test/unit/test_cardForEmail.js">annotate</a> |
<a href="/comm-central/diff/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/addrbook/test/unit/test_cardForEmail.js">diff</a> |
<a href="/comm-central/comparison/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/addrbook/test/unit/test_cardForEmail.js">comparison</a> |
<a href="/comm-central/log/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/addrbook/test/unit/test_cardForEmail.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/addrbook/test/unit/test_collection.js">mailnews/addrbook/test/unit/test_collection.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/addrbook/test/unit/test_collection.js">file</a> |
<a href="/comm-central/annotate/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/addrbook/test/unit/test_collection.js">annotate</a> |
<a href="/comm-central/diff/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/addrbook/test/unit/test_collection.js">diff</a> |
<a href="/comm-central/comparison/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/addrbook/test/unit/test_collection.js">comparison</a> |
<a href="/comm-central/log/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/addrbook/test/unit/test_collection.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/base/resources/content/junkCommands.js">mailnews/base/resources/content/junkCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/base/resources/content/junkCommands.js">file</a> |
<a href="/comm-central/annotate/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/base/resources/content/junkCommands.js">annotate</a> |
<a href="/comm-central/diff/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/base/resources/content/junkCommands.js">diff</a> |
<a href="/comm-central/comparison/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/base/resources/content/junkCommands.js">comparison</a> |
<a href="/comm-central/log/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/base/resources/content/junkCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/base/resources/content/mailWindowOverlay.js">mailnews/base/resources/content/mailWindowOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/base/resources/content/mailWindowOverlay.js">file</a> |
<a href="/comm-central/annotate/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/base/resources/content/mailWindowOverlay.js">annotate</a> |
<a href="/comm-central/diff/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/base/resources/content/mailWindowOverlay.js">diff</a> |
<a href="/comm-central/comparison/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/base/resources/content/mailWindowOverlay.js">comparison</a> |
<a href="/comm-central/log/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/base/resources/content/mailWindowOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/base/search/public/nsMsgSearchTerm.h">mailnews/base/search/public/nsMsgSearchTerm.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/base/search/public/nsMsgSearchTerm.h">file</a> |
<a href="/comm-central/annotate/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/base/search/public/nsMsgSearchTerm.h">annotate</a> |
<a href="/comm-central/diff/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/base/search/public/nsMsgSearchTerm.h">diff</a> |
<a href="/comm-central/comparison/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/base/search/public/nsMsgSearchTerm.h">comparison</a> |
<a href="/comm-central/log/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/base/search/public/nsMsgSearchTerm.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/base/search/src/nsMsgSearchTerm.cpp">mailnews/base/search/src/nsMsgSearchTerm.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/base/search/src/nsMsgSearchTerm.cpp">file</a> |
<a href="/comm-central/annotate/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/base/search/src/nsMsgSearchTerm.cpp">annotate</a> |
<a href="/comm-central/diff/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/base/search/src/nsMsgSearchTerm.cpp">diff</a> |
<a href="/comm-central/comparison/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/base/search/src/nsMsgSearchTerm.cpp">comparison</a> |
<a href="/comm-central/log/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/base/search/src/nsMsgSearchTerm.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/base/src/nsMsgContentPolicy.cpp">mailnews/base/src/nsMsgContentPolicy.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/base/src/nsMsgContentPolicy.cpp">file</a> |
<a href="/comm-central/annotate/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/base/src/nsMsgContentPolicy.cpp">annotate</a> |
<a href="/comm-central/diff/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/base/src/nsMsgContentPolicy.cpp">diff</a> |
<a href="/comm-central/comparison/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/base/src/nsMsgContentPolicy.cpp">comparison</a> |
<a href="/comm-central/log/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/base/src/nsMsgContentPolicy.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/base/src/nsMsgContentPolicy.h">mailnews/base/src/nsMsgContentPolicy.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/base/src/nsMsgContentPolicy.h">file</a> |
<a href="/comm-central/annotate/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/base/src/nsMsgContentPolicy.h">annotate</a> |
<a href="/comm-central/diff/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/base/src/nsMsgContentPolicy.h">diff</a> |
<a href="/comm-central/comparison/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/base/src/nsMsgContentPolicy.h">comparison</a> |
<a href="/comm-central/log/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/base/src/nsMsgContentPolicy.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/base/util/nsMsgDBFolder.cpp">mailnews/base/util/nsMsgDBFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/base/util/nsMsgDBFolder.cpp">file</a> |
<a href="/comm-central/annotate/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/base/util/nsMsgDBFolder.cpp">annotate</a> |
<a href="/comm-central/diff/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/base/util/nsMsgDBFolder.cpp">diff</a> |
<a href="/comm-central/comparison/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/base/util/nsMsgDBFolder.cpp">comparison</a> |
<a href="/comm-central/log/4f44120fd2a853b2656e0cbd650f6419aad078ed/mailnews/base/util/nsMsgDBFolder.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/mailWindowOverlay.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/mailWindowOverlay.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -2552,23 +2552,25 @@ function allowRemoteContentForSender()</span>
<a href="#l1.4"></a><span id="l1.4">   // search through all of our local address books looking for a match.</span>
<a href="#l1.5"></a><span id="l1.5">   var enumerator = Components.classes[&quot;@mozilla.org/abmanager;1&quot;]</span>
<a href="#l1.6"></a><span id="l1.6">                              .getService(Components.interfaces.nsIAbManager)</span>
<a href="#l1.7"></a><span id="l1.7">                              .directories;</span>
<a href="#l1.8"></a><span id="l1.8">   var cardForEmailAddress;</span>
<a href="#l1.9"></a><span id="l1.9">   var addrbook;</span>
<a href="#l1.10"></a><span id="l1.10">   while (!cardForEmailAddress &amp;&amp; enumerator.hasMoreElements())</span>
<a href="#l1.11"></a><span id="l1.11">   {</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    addrbook = enumerator.getNext();</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-    if (addrbook instanceof Components.interfaces.nsIAbMDBDirectory)</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+    addrbook = enumerator.getNext()</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+                         .QueryInterface(Components.interfaces.nsIAbDirectory);</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+    try {</span>
<a href="#l1.17"></a><span id="l1.17">       cardForEmailAddress = addrbook.cardForEmailAddress(authorEmailAddress);</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+    } catch (e) {}</span>
<a href="#l1.19"></a><span id="l1.19">   }</span>
<a href="#l1.20"></a><span id="l1.20"> </span>
<a href="#l1.21"></a><span id="l1.21">   var allowRemoteContent = false;</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineminus">-  if (cardForEmailAddress &amp;&amp; addrbook instanceof Components.interfaces.nsIAbDirectory)</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+  if (cardForEmailAddress)</span>
<a href="#l1.24"></a><span id="l1.24">   {</span>
<a href="#l1.25"></a><span id="l1.25">     // set the property for remote content</span>
<a href="#l1.26"></a><span id="l1.26">     cardForEmailAddress.setProperty(&quot;AllowRemoteContent&quot;, true);</span>
<a href="#l1.27"></a><span id="l1.27">     addrbook.modifyCard(cardForEmailAddress);</span>
<a href="#l1.28"></a><span id="l1.28">     allowRemoteContent = true;</span>
<a href="#l1.29"></a><span id="l1.29">   }</span>
<a href="#l1.30"></a><span id="l1.30">   else</span>
<a href="#l1.31"></a><span id="l1.31">   {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/content/msgHdrViewOverlay.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/content/msgHdrViewOverlay.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -972,26 +972,19 @@ function useDisplayNameForAddress(emailA</span>
<a href="#l2.4"></a><span id="l2.4"> {</span>
<a href="#l2.5"></a><span id="l2.5">   // For now, if the email address is in the personal address book, then consider this user a 'known' user</span>
<a href="#l2.6"></a><span id="l2.6">   // and use the display name. I could eventually see our rules enlarged to include other local ABs, replicated</span>
<a href="#l2.7"></a><span id="l2.7">   // LDAP directories, and maybe even domain matches (i.e. any email from someone in my company</span>
<a href="#l2.8"></a><span id="l2.8">   // should use the friendly display name)</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10">   if (!gPersonalAddressBookDirectory)</span>
<a href="#l2.11"></a><span id="l2.11">   {</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-    var dirs = Components.classes[&quot;@mozilla.org/abmanager;1&quot;]</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-                         .getService(Components.interfaces.nsIAbManager).directories;</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-    while (dirs.hasMoreElements) {</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-      var dir = dirs.getNext().QueryInterface(Components.interfaces.nsIAbDirectory);</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-      if (dir.URI == kPersonalAddressbookUri) {</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-        gPersonalAddressBookDirectory = dir.QueryInterface(Components.interfaces.nsIAbMDBDirectory);</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-        break;</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-      }</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineminus">-    }</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+    var manager = Components.classes[&quot;@mozilla.org/abmanager;1&quot;]</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+                            .getService(Components.interfaces.nsIAbManager);</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+    gPersonalAddressBookDirectory = manager.getDirectory(kPersonalAddressbookUri);</span>
<a href="#l2.25"></a><span id="l2.25">     if (!gPersonalAddressBookDirectory)</span>
<a href="#l2.26"></a><span id="l2.26">       return false;</span>
<a href="#l2.27"></a><span id="l2.27">   }</span>
<a href="#l2.28"></a><span id="l2.28"> </span>
<a href="#l2.29"></a><span id="l2.29">   // look up the email address in the database</span>
<a href="#l2.30"></a><span id="l2.30">   return gPersonalAddressBookDirectory.cardForEmailAddress(emailAddress);</span>
<a href="#l2.31"></a><span id="l2.31"> }</span>
<a href="#l2.32"></a><span id="l2.32"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/addrbook/public/nsIAbDirectory.idl</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/addrbook/public/nsIAbDirectory.idl</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -54,17 +54,17 @@ interface nsIMutableArray;</span>
<a href="#l3.4"></a><span id="l3.4"> #define kCollectedAddressbook      &quot;history.mab&quot;</span>
<a href="#l3.5"></a><span id="l3.5"> #define kCollectedAddressbookUri   &quot;moz-abmdbdirectory://history.mab&quot;</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7"> #define kABFileName_PreviousSuffix &quot;.na2&quot; /* final v2 address book format */</span>
<a href="#l3.8"></a><span id="l3.8"> #define kABFileName_PreviousSuffixLen 4</span>
<a href="#l3.9"></a><span id="l3.9"> #define kABFileName_CurrentSuffix &quot;.mab&quot;  /* v3 address book extension */</span>
<a href="#l3.10"></a><span id="l3.10"> %}</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-[scriptable, uuid(e30c442f-9d83-4f38-8d41-9884e81237a0)]</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+[scriptable, uuid(ab55bec3-5bf9-4928-8322-5cff399b7045)]</span>
<a href="#l3.14"></a><span id="l3.14"> interface nsIAbDirectory : nsISupports {</span>
<a href="#l3.15"></a><span id="l3.15"> </span>
<a href="#l3.16"></a><span id="l3.16">   /**</span>
<a href="#l3.17"></a><span id="l3.17">    * The chrome URI to use for bringing up a dialog to edit this directory.</span>
<a href="#l3.18"></a><span id="l3.18">    * When opening the dialog, use a JS argument of</span>
<a href="#l3.19"></a><span id="l3.19">    * {selectedDirectory: thisdir} where thisdir is this directory that you just</span>
<a href="#l3.20"></a><span id="l3.20">    * got the chrome URI from.</span>
<a href="#l3.21"></a><span id="l3.21">    */</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineat">@@ -302,9 +302,24 @@ interface nsIAbDirectory : nsISupports {</span>
<a href="#l3.23"></a><span id="l3.23">    *                      be obtained (e.g. dirPrefId isn't set).</span>
<a href="#l3.24"></a><span id="l3.24">    */</span>
<a href="#l3.25"></a><span id="l3.25">   //@{</span>
<a href="#l3.26"></a><span id="l3.26">   void setIntValue(in string aName, in long aValue);</span>
<a href="#l3.27"></a><span id="l3.27">   void setBoolValue(in string aName, in boolean aValue);</span>
<a href="#l3.28"></a><span id="l3.28">   void setStringValue(in string aName, in ACString aValue);</span>
<a href="#l3.29"></a><span id="l3.29">   void setLocalizedStringValue(in string aName, in AUTF8String aValue);</span>
<a href="#l3.30"></a><span id="l3.30">   //@}</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+  /** </span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+   * Returns the address card for the specified email address if found.</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+   *</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+   * If the address book type does not know how to find a card, it will throw</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+   * NS_ERROR_NOT_IMPLEMENTED. Core address book types do throw this exception,</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+   * so beware when calling this method.</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+   *</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+   * @param  emailAddress The email address to find in either the primary or</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+   *                      secondary email address fields. If email address is</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+   *                      empty, the database won't be searched and the function</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+   *                      will return as if no card was found.</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+   * @return              An nsIAbCard if one was found, else returns NULL.</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+   */</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+  nsIAbCard cardForEmailAddress(in AUTF8String emailAddress);</span>
<a href="#l3.46"></a><span id="l3.46"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/addrbook/public/nsIAbMDBDirectory.idl</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/addrbook/public/nsIAbMDBDirectory.idl</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -43,17 +43,17 @@ interface nsIAbDirectory;</span>
<a href="#l4.4"></a><span id="l4.4"> interface nsIAbCard;</span>
<a href="#l4.5"></a><span id="l4.5"> interface nsIAddrDatabase;</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7"> %{C++</span>
<a href="#l4.8"></a><span id="l4.8"> #define kMDBDirectoryRoot          &quot;moz-abmdbdirectory://&quot;</span>
<a href="#l4.9"></a><span id="l4.9"> #define kMDBDirectoryRootLen       21</span>
<a href="#l4.10"></a><span id="l4.10"> %}</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-[scriptable, uuid(705a6b63-118c-402d-a835-b07347de5a53)]</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+[scriptable, uuid(744072be-1ba0-46bc-af24-46e22567a2ea)]</span>
<a href="#l4.14"></a><span id="l4.14"> interface nsIAbMDBDirectory : nsISupports {</span>
<a href="#l4.15"></a><span id="l4.15"> </span>
<a href="#l4.16"></a><span id="l4.16"> 	// Creates an RDF directory component from the</span>
<a href="#l4.17"></a><span id="l4.17"> 	// uriName, adds it to its children and returns</span>
<a href="#l4.18"></a><span id="l4.18"> 	// the component</span>
<a href="#l4.19"></a><span id="l4.19"> 	nsIAbDirectory addDirectory(in string uriName);</span>
<a href="#l4.20"></a><span id="l4.20"> </span>
<a href="#l4.21"></a><span id="l4.21">   /**</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineat">@@ -96,20 +96,9 @@ interface nsIAbMDBDirectory : nsISupport</span>
<a href="#l4.23"></a><span id="l4.23"> 	void removeEmailAddressAt(in unsigned long aIndex);</span>
<a href="#l4.24"></a><span id="l4.24"> </span>
<a href="#l4.25"></a><span id="l4.25">     attribute unsigned long dbRowID;</span>
<a href="#l4.26"></a><span id="l4.26"> </span>
<a href="#l4.27"></a><span id="l4.27"> 	// Empty implementation, called by the data base</span>
<a href="#l4.28"></a><span id="l4.28"> 	[noscript] void notifyDirItemAdded(in nsISupports item);</span>
<a href="#l4.29"></a><span id="l4.29"> 	</span>
<a href="#l4.30"></a><span id="l4.30"> 	[noscript] void clearDatabase();</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-	</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-  /** </span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-   * Returns the address card for the specified email address if found.</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineminus">-   *</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-   * @param  emailAddress The email address to find in either the primary or</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineminus">-   *                      secondary email address fields. If email address is</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineminus">-   *                      empty, the database won't be searched and the function</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-   *                      will return as if no card was found.</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineminus">-   * @return              An nsIAbCard if one was found, else returns NULL.</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineminus">-   */</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">-  nsIAbCard cardForEmailAddress(in AUTF8String emailAddress);</span>
<a href="#l4.42"></a><span id="l4.42"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbDirProperty.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbDirProperty.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -306,16 +306,20 @@ NS_IMETHODIMP nsAbDirProperty::ModifyCar</span>
<a href="#l5.4"></a><span id="l5.4"> { return NS_ERROR_NOT_IMPLEMENTED; }</span>
<a href="#l5.5"></a><span id="l5.5"> </span>
<a href="#l5.6"></a><span id="l5.6"> NS_IMETHODIMP nsAbDirProperty::DeleteCards(nsIArray *cards)</span>
<a href="#l5.7"></a><span id="l5.7"> { return NS_ERROR_NOT_IMPLEMENTED; }</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9"> NS_IMETHODIMP nsAbDirProperty::DropCard(nsIAbCard *childCard, PRBool needToCopyCard)</span>
<a href="#l5.10"></a><span id="l5.10"> { return NS_ERROR_NOT_IMPLEMENTED; }</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::CardForEmailAddress(const nsACString &amp;aEmailAddress,</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+                                                   nsIAbCard ** aAbCard)</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+{ return NS_ERROR_NOT_IMPLEMENTED; }</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+</span>
<a href="#l5.16"></a><span id="l5.16"> NS_IMETHODIMP nsAbDirProperty::GetSupportsMailingLists(PRBool *aSupportsMailingsLists)</span>
<a href="#l5.17"></a><span id="l5.17"> {</span>
<a href="#l5.18"></a><span id="l5.18">   NS_ENSURE_ARG_POINTER(aSupportsMailingsLists);</span>
<a href="#l5.19"></a><span id="l5.19">   // We don't currently support nested mailing lists, so only return true if</span>
<a href="#l5.20"></a><span id="l5.20">   // we're not a mailing list.</span>
<a href="#l5.21"></a><span id="l5.21">   *aSupportsMailingsLists = !m_IsMailList;</span>
<a href="#l5.22"></a><span id="l5.22">   return NS_OK;</span>
<a href="#l5.23"></a><span id="l5.23"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbMDBDirProperty.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbMDBDirProperty.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -163,21 +163,16 @@ NS_IMETHODIMP nsAbMDBDirProperty::Notify</span>
<a href="#l6.4"></a><span id="l6.4"> }</span>
<a href="#l6.5"></a><span id="l6.5"> </span>
<a href="#l6.6"></a><span id="l6.6"> /* [noscript] void clearDatabase (); */</span>
<a href="#l6.7"></a><span id="l6.7"> NS_IMETHODIMP nsAbMDBDirProperty::ClearDatabase()</span>
<a href="#l6.8"></a><span id="l6.8"> {</span>
<a href="#l6.9"></a><span id="l6.9">     return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l6.10"></a><span id="l6.10"> }</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirProperty::CardForEmailAddress(const nsACString &amp;aEmailAddress, nsIAbCard ** aAbCard)</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-{</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-}</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-</span>
<a href="#l6.17"></a><span id="l6.17"> NS_IMETHODIMP nsAbMDBDirProperty::GetDatabaseFile(nsILocalFile **aResult)</span>
<a href="#l6.18"></a><span id="l6.18"> {</span>
<a href="#l6.19"></a><span id="l6.19">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l6.20"></a><span id="l6.20"> }</span>
<a href="#l6.21"></a><span id="l6.21"> </span>
<a href="#l6.22"></a><span id="l6.22"> NS_IMETHODIMP nsAbMDBDirProperty::GetDatabase(nsIAddrDatabase **aResult)</span>
<a href="#l6.23"></a><span id="l6.23"> {</span>
<a href="#l6.24"></a><span id="l6.24">   return NS_ERROR_NOT_IMPLEMENTED;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_cardForEmail.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_cardForEmail.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1,11 +1,11 @@</span>
<a href="#l7.4"></a><span id="l7.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l7.5"></a><span id="l7.5"> /*</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineminus">- * Tests nsIAbMDBDirectory::cardForEmailAddress</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineplus">+ * Tests nsIAbDirectory::cardForEmailAddress</span>
<a href="#l7.8"></a><span id="l7.8">  * - checks correct return when no email address supplied</span>
<a href="#l7.9"></a><span id="l7.9">  * - checks correct return when no matching email address supplied</span>
<a href="#l7.10"></a><span id="l7.10">  * - checks correct return when matching email address supplied.</span>
<a href="#l7.11"></a><span id="l7.11">  *</span>
<a href="#l7.12"></a><span id="l7.12">  * Uses: cardForEmail.mab</span>
<a href="#l7.13"></a><span id="l7.13">  */</span>
<a href="#l7.14"></a><span id="l7.14"> </span>
<a href="#l7.15"></a><span id="l7.15"> function run_test() {</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineat">@@ -14,18 +14,17 @@ function run_test() {</span>
<a href="#l7.17"></a><span id="l7.17"> </span>
<a href="#l7.18"></a><span id="l7.18">   // Copy the file to the profile directory for a PAB</span>
<a href="#l7.19"></a><span id="l7.19">   testAB.copyTo(gProfileDir, kPABData.fileName);</span>
<a href="#l7.20"></a><span id="l7.20"> </span>
<a href="#l7.21"></a><span id="l7.21">   // Test - Get the directory</span>
<a href="#l7.22"></a><span id="l7.22">   var abManager = Components.classes[&quot;@mozilla.org/abmanager;1&quot;]</span>
<a href="#l7.23"></a><span id="l7.23">                             .getService(Components.interfaces.nsIAbManager);</span>
<a href="#l7.24"></a><span id="l7.24"> </span>
<a href="#l7.25"></a><span id="l7.25" class="difflineminus">-  var AB = abManager.getDirectory(kPABData.URI)</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-                .QueryInterface(Components.interfaces.nsIAbMDBDirectory);</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+  var AB = abManager.getDirectory(kPABData.URI);</span>
<a href="#l7.28"></a><span id="l7.28"> </span>
<a href="#l7.29"></a><span id="l7.29">   // Test - Check that a null string succeeds and does not</span>
<a href="#l7.30"></a><span id="l7.30">   // return a card (bug 404264)</span>
<a href="#l7.31"></a><span id="l7.31">   do_check_true(AB.cardForEmailAddress(null) == null);</span>
<a href="#l7.32"></a><span id="l7.32"> </span>
<a href="#l7.33"></a><span id="l7.33">   // Test - Check that an empty string succeeds and does not</span>
<a href="#l7.34"></a><span id="l7.34">   // return a card (bug 404264)</span>
<a href="#l7.35"></a><span id="l7.35">   do_check_true(AB.cardForEmailAddress(&quot;&quot;) == null);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_collection.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_collection.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -259,33 +259,30 @@ function run_test()</span>
<a href="#l8.4"></a><span id="l8.4"> </span>
<a href="#l8.5"></a><span id="l8.5">   // XXX Getting all directories ensures we create all ABs because the</span>
<a href="#l8.6"></a><span id="l8.6">   // address collecter can't currently create ABs itself (bug 314448).</span>
<a href="#l8.7"></a><span id="l8.7">   var temp = abManager.directories;</span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9">   // Get the actual AB for the collector so we can check cards have been</span>
<a href="#l8.10"></a><span id="l8.10">   // added.</span>
<a href="#l8.11"></a><span id="l8.11">   collectChecker.AB =</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-    abManager.getDirectory(prefService.getCharPref(&quot;mail.collect_addressbook&quot;))</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-             .QueryInterface(Components.interfaces.nsIAbMDBDirectory);</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+    abManager.getDirectory(prefService.getCharPref(&quot;mail.collect_addressbook&quot;));</span>
<a href="#l8.15"></a><span id="l8.15"> </span>
<a href="#l8.16"></a><span id="l8.16">   // Get the actual collecter</span>
<a href="#l8.17"></a><span id="l8.17">   collectChecker.addressCollect =</span>
<a href="#l8.18"></a><span id="l8.18">     Components.classes[&quot;@mozilla.org/addressbook/services/addressCollecter;1&quot;]</span>
<a href="#l8.19"></a><span id="l8.19">               .getService(Components.interfaces.nsIAbAddressCollecter);</span>
<a href="#l8.20"></a><span id="l8.20"> </span>
<a href="#l8.21"></a><span id="l8.21">   // Test - Addition of header without email address.</span>
<a href="#l8.22"></a><span id="l8.22"> </span>
<a href="#l8.23"></a><span id="l8.23">   collectChecker.addressCollect.collectAddress(&quot;MyTest &lt;&gt;&quot;, true,</span>
<a href="#l8.24"></a><span id="l8.24">                                                nsIAbPMF.unknown);</span>
<a href="#l8.25"></a><span id="l8.25"> </span>
<a href="#l8.26"></a><span id="l8.26" class="difflineminus">-  var CAB = collectChecker.AB.QueryInterface(Components.interfaces.nsIAbDirectory);</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineminus">-</span>
<a href="#l8.28"></a><span id="l8.28">   // Address book should have no cards present.</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineminus">-  do_check_false(CAB.childCards.hasMoreElements());</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+  do_check_false(collectChecker.AB.childCards.hasMoreElements());</span>
<a href="#l8.31"></a><span id="l8.31"> </span>
<a href="#l8.32"></a><span id="l8.32">   // Test - Email doesn't exist, but don't add it.</span>
<a href="#l8.33"></a><span id="l8.33"> </span>
<a href="#l8.34"></a><span id="l8.34">   // As we've just set everything up, we know we haven't got anything in the</span>
<a href="#l8.35"></a><span id="l8.35">   // AB, so just try and collect without adding.</span>
<a href="#l8.36"></a><span id="l8.36">   collectChecker.addressCollect.collectAddress(addEmailChecks[0].emailHeader,</span>
<a href="#l8.37"></a><span id="l8.37">                                                false,</span>
<a href="#l8.38"></a><span id="l8.38">                                                addEmailChecks[0].mailFormat);</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineat">@@ -298,45 +295,45 @@ function run_test()</span>
<a href="#l8.40"></a><span id="l8.40"> </span>
<a href="#l8.41"></a><span id="l8.41">   collectChecker.part = 0;</span>
<a href="#l8.42"></a><span id="l8.42"> </span>
<a href="#l8.43"></a><span id="l8.43">   addEmailChecks.forEach(collectChecker.checkAddress, collectChecker);</span>
<a href="#l8.44"></a><span id="l8.44"> </span>
<a href="#l8.45"></a><span id="l8.45">   // Test - Do all emails at the same time.</span>
<a href="#l8.46"></a><span id="l8.46"> </span>
<a href="#l8.47"></a><span id="l8.47">   // First delete all existing cards</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineminus">-  var childCards = CAB.childCards;</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+  var childCards = collectChecker.AB.childCards;</span>
<a href="#l8.50"></a><span id="l8.50">   var cardsToDelete = Components.classes[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l8.51"></a><span id="l8.51">                                 .createInstance(Components.interfaces.nsIMutableArray);</span>
<a href="#l8.52"></a><span id="l8.52">   while (childCards.hasMoreElements()) {</span>
<a href="#l8.53"></a><span id="l8.53">     cardsToDelete.appendElement(childCards.getNext(), false);</span>
<a href="#l8.54"></a><span id="l8.54">   }</span>
<a href="#l8.55"></a><span id="l8.55"> </span>
<a href="#l8.56"></a><span id="l8.56" class="difflineminus">-  CAB.deleteCards(cardsToDelete);</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+  collectChecker.AB.deleteCards(cardsToDelete);</span>
<a href="#l8.58"></a><span id="l8.58"> </span>
<a href="#l8.59"></a><span id="l8.59">   // Null these directly, so gc() will purge them</span>
<a href="#l8.60"></a><span id="l8.60">   childCards = null;</span>
<a href="#l8.61"></a><span id="l8.61">   cardsToDelete = null;</span>
<a href="#l8.62"></a><span id="l8.62"> </span>
<a href="#l8.63"></a><span id="l8.63">   // Address book should have no cards present.</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineminus">-  do_check_false(CAB.childCards.hasMoreElements());</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+  do_check_false(collectChecker.AB.childCards.hasMoreElements());</span>
<a href="#l8.66"></a><span id="l8.66"> </span>
<a href="#l8.67"></a><span id="l8.67">   do_check_eq(collectChecker.AB.cardForEmailAddress(addEmailChecks[0].emailHeader), null);</span>
<a href="#l8.68"></a><span id="l8.68"> </span>
<a href="#l8.69"></a><span id="l8.69">   // Now do all emails at the same time.</span>
<a href="#l8.70"></a><span id="l8.70">   collectChecker.checkAll(addEmailChecks);</span>
<a href="#l8.71"></a><span id="l8.71"> </span>
<a href="#l8.72"></a><span id="l8.72">   // Test - Try and modify various emails and formats.</span>
<a href="#l8.73"></a><span id="l8.73"> </span>
<a href="#l8.74"></a><span id="l8.74">   // Add a basic card with just primary and second email to allow testing</span>
<a href="#l8.75"></a><span id="l8.75">   // of the case where we don't modify when second email is matching.</span>
<a href="#l8.76"></a><span id="l8.76">   card = Components.classes[&quot;@mozilla.org/addressbook/cardproperty;1&quot;]</span>
<a href="#l8.77"></a><span id="l8.77">                    .createInstance(Components.interfaces.nsIAbCard);</span>
<a href="#l8.78"></a><span id="l8.78"> </span>
<a href="#l8.79"></a><span id="l8.79">   card.primaryEmail = &quot;userprim\u00D0@invalid.com&quot;;</span>
<a href="#l8.80"></a><span id="l8.80">   card.setProperty(&quot;SecondEmail&quot;, &quot;usersec\u00D0@invalid.com&quot;);</span>
<a href="#l8.81"></a><span id="l8.81"> </span>
<a href="#l8.82"></a><span id="l8.82" class="difflineminus">-  CAB.addCard(card);</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+  collectChecker.AB.addCard(card);</span>
<a href="#l8.84"></a><span id="l8.84"> </span>
<a href="#l8.85"></a><span id="l8.85">   collectChecker.part = 0;</span>
<a href="#l8.86"></a><span id="l8.86"> </span>
<a href="#l8.87"></a><span id="l8.87">   modifyEmailChecks.forEach(collectChecker.checkAddress, collectChecker);</span>
<a href="#l8.88"></a><span id="l8.88"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/base/resources/content/junkCommands.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/base/resources/content/junkCommands.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -183,32 +183,36 @@ MessageClassifier.prototype =</span>
<a href="#l9.4"></a><span id="l9.4">    *</span>
<a href="#l9.5"></a><span id="l9.5">    * Starts the message classification process for a message. If the message</span>
<a href="#l9.6"></a><span id="l9.6">    * sender's address is in the address book specified by aWhiteListDirectory,</span>
<a href="#l9.7"></a><span id="l9.7">    * the message is skipped.</span>
<a href="#l9.8"></a><span id="l9.8">    *</span>
<a href="#l9.9"></a><span id="l9.9">    * @param aMsgHdr</span>
<a href="#l9.10"></a><span id="l9.10">    *        The header (nsIMsgDBHdr) of the message to classify.</span>
<a href="#l9.11"></a><span id="l9.11">    * @param aWhiteListDirectory</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-   *        The addressbook (nsIAbMDBDirectory) to use as a whitelist, or null</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+   *        The addressbook (nsIAbDirectory) to use as a whitelist, or null</span>
<a href="#l9.14"></a><span id="l9.14">    *        if no whitelisting should be done.</span>
<a href="#l9.15"></a><span id="l9.15">    */</span>
<a href="#l9.16"></a><span id="l9.16">   analyzeMessage: function(aMsgHdr, aWhiteListDirectory)</span>
<a href="#l9.17"></a><span id="l9.17">   {</span>
<a href="#l9.18"></a><span id="l9.18">     var junkscoreorigin = aMsgHdr.getStringProperty(&quot;junkscoreorigin&quot;);</span>
<a href="#l9.19"></a><span id="l9.19">     if (junkscoreorigin == &quot;user&quot;) // don't override user-set junk status</span>
<a href="#l9.20"></a><span id="l9.20">       return;</span>
<a href="#l9.21"></a><span id="l9.21"> </span>
<a href="#l9.22"></a><span id="l9.22">     // if a whitelist addressbook was specified, check if the email address is in it</span>
<a href="#l9.23"></a><span id="l9.23">     if (aWhiteListDirectory)</span>
<a href="#l9.24"></a><span id="l9.24">     {</span>
<a href="#l9.25"></a><span id="l9.25">       var headerParser = Components.classes[&quot;@mozilla.org/messenger/headerparser;1&quot;]</span>
<a href="#l9.26"></a><span id="l9.26">                                    .getService(Components.interfaces.nsIMsgHeaderParser);</span>
<a href="#l9.27"></a><span id="l9.27">       var authorEmailAddress = headerParser.extractHeaderAddressMailboxes(null, aMsgHdr.author);</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">-      if (aWhiteListDirectory.cardForEmailAddress(authorEmailAddress))</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineplus">+      var abCard = false;</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+      try {</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+        abCard = aWhiteListDirectory.cardForEmailAddress(authorEmailAddress);</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+      } catch (e) {}</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+      if (abCard)</span>
<a href="#l9.34"></a><span id="l9.34">       {</span>
<a href="#l9.35"></a><span id="l9.35">         // message is ham from whitelist</span>
<a href="#l9.36"></a><span id="l9.36">         {</span>
<a href="#l9.37"></a><span id="l9.37">           var db = aMsgHdr.folder.getMsgDatabase(msgWindow);</span>
<a href="#l9.38"></a><span id="l9.38">           db.setStringProperty(aMsgHdr.messageKey, &quot;junkscore&quot;, Components.interfaces.nsIJunkMailPlugin.IS_HAM_SCORE);</span>
<a href="#l9.39"></a><span id="l9.39">           db.setStringProperty(aMsgHdr.messageKey, &quot;junkscoreorigin&quot;, &quot;whitelist&quot;);</span>
<a href="#l9.40"></a><span id="l9.40">           this.mGoodMsgHdrs.appendElement(aMsgHdr, false);</span>
<a href="#l9.41"></a><span id="l9.41">         }</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineat">@@ -353,18 +357,20 @@ function processFolderForJunk(aAll)</span>
<a href="#l9.43"></a><span id="l9.43">   if (!tmpMsgURI)</span>
<a href="#l9.44"></a><span id="l9.44">     return;</span>
<a href="#l9.45"></a><span id="l9.45"> </span>
<a href="#l9.46"></a><span id="l9.46">   var tmpMsgHdr = messenger.messageServiceFromURI(tmpMsgURI).messageURIToMsgHdr(tmpMsgURI);</span>
<a href="#l9.47"></a><span id="l9.47">   var spamSettings = tmpMsgHdr.folder.server.spamSettings;</span>
<a href="#l9.48"></a><span id="l9.48"> </span>
<a href="#l9.49"></a><span id="l9.49">   // if enabled in the spam settings, retrieve whitelist addressbook</span>
<a href="#l9.50"></a><span id="l9.50">   var whiteListDirectory = null;</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineminus">-  if (spamSettings.useWhiteList &amp;&amp; spamSettings.whiteListAbURI)</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineminus">-    whiteListDirectory = RDF.GetResource(spamSettings.whiteListAbURI).QueryInterface(Components.interfaces.nsIAbMDBDirectory);</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+  if (spamSettings.useWhiteList &amp;&amp; spamSettings.whiteListAbURI) {</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+    whiteListDirectory = Components.classes[&quot;@mozilla.org/abmanager;1&quot;]</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+                                   .getService(Components.interfaces.nsIAbManager)</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineplus">+                                   .getDirectory(spamSettings.whiteListAbURI);</span>
<a href="#l9.57"></a><span id="l9.57"> </span>
<a href="#l9.58"></a><span id="l9.58">   // create a classifier instance to classify messages in the folder.</span>
<a href="#l9.59"></a><span id="l9.59">   var msgClassifier = new MessageClassifier(tmpMsgHdr.folder, totalMessages);</span>
<a href="#l9.60"></a><span id="l9.60"> </span>
<a href="#l9.61"></a><span id="l9.61">   for ( i = 0; i &lt; totalMessages; i++)</span>
<a href="#l9.62"></a><span id="l9.62">   {</span>
<a href="#l9.63"></a><span id="l9.63">     var index = aAll ? i : indices[i];</span>
<a href="#l9.64"></a><span id="l9.64">     try</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/base/resources/content/mailWindowOverlay.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/base/resources/content/mailWindowOverlay.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -2301,23 +2301,25 @@ function allowRemoteContentForSender()</span>
<a href="#l10.4"></a><span id="l10.4">   // search through all of our local address books looking for a match.</span>
<a href="#l10.5"></a><span id="l10.5">   var enumerator = Components.classes[&quot;@mozilla.org/abmanager;1&quot;]</span>
<a href="#l10.6"></a><span id="l10.6">                              .getService(Components.interfaces.nsIAbManager)</span>
<a href="#l10.7"></a><span id="l10.7">                              .directories;</span>
<a href="#l10.8"></a><span id="l10.8">   var cardForEmailAddress;</span>
<a href="#l10.9"></a><span id="l10.9">   var addrbook;</span>
<a href="#l10.10"></a><span id="l10.10">   while (!cardForEmailAddress &amp;&amp; enumerator.hasMoreElements())</span>
<a href="#l10.11"></a><span id="l10.11">   {</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-    addrbook = enumerator.getNext();</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-    if (addrbook instanceof Components.interfaces.nsIAbMDBDirectory)</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+    addrbook = enumerator.getNext()</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+                         .QueryInterface(Components.interfaces.nsIAbDirectory);</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+    try {</span>
<a href="#l10.17"></a><span id="l10.17">       cardForEmailAddress = addrbook.cardForEmailAddress(authorEmailAddress);</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+    } catch (e) {}</span>
<a href="#l10.19"></a><span id="l10.19">   }</span>
<a href="#l10.20"></a><span id="l10.20"> </span>
<a href="#l10.21"></a><span id="l10.21">   var allowRemoteContent = false;</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineminus">-  if (cardForEmailAddress &amp;&amp; addrbook instanceof Components.interfaces.nsIAbDirectory)</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+  if (cardForEmailAddress)</span>
<a href="#l10.24"></a><span id="l10.24">   {</span>
<a href="#l10.25"></a><span id="l10.25">     // set the property for remote content</span>
<a href="#l10.26"></a><span id="l10.26">     cardForEmailAddress.setProperty(&quot;AllowRemoteContent&quot;, true);</span>
<a href="#l10.27"></a><span id="l10.27">     addrbook.modifyCard(cardForEmailAddress);</span>
<a href="#l10.28"></a><span id="l10.28">     allowRemoteContent = true;</span>
<a href="#l10.29"></a><span id="l10.29">   }</span>
<a href="#l10.30"></a><span id="l10.30">   else</span>
<a href="#l10.31"></a><span id="l10.31">   {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/base/search/public/nsMsgSearchTerm.h</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/base/search/public/nsMsgSearchTerm.h</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -41,17 +41,17 @@</span>
<a href="#l11.4"></a><span id="l11.4"> //---------------------------------------------------------------------------</span>
<a href="#l11.5"></a><span id="l11.5"> // nsMsgSearchTerm specifies one criterion, e.g. name contains phil</span>
<a href="#l11.6"></a><span id="l11.6"> //---------------------------------------------------------------------------</span>
<a href="#l11.7"></a><span id="l11.7"> #include &quot;nsIMsgSearchSession.h&quot;</span>
<a href="#l11.8"></a><span id="l11.8"> #include &quot;nsIMsgSearchScopeTerm.h&quot;</span>
<a href="#l11.9"></a><span id="l11.9"> #include &quot;nsIMsgSearchTerm.h&quot;</span>
<a href="#l11.10"></a><span id="l11.10"> </span>
<a href="#l11.11"></a><span id="l11.11"> // needed to search for addresses in address books</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-#include &quot;nsIAbMDBDirectory.h&quot;</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+#include &quot;nsIAbDirectory.h&quot;</span>
<a href="#l11.14"></a><span id="l11.14"> </span>
<a href="#l11.15"></a><span id="l11.15"> #define EMPTY_MESSAGE_LINE(buf) (buf[0] == '\r' || buf[0] == '\n' || buf[0] == '\0')</span>
<a href="#l11.16"></a><span id="l11.16"> </span>
<a href="#l11.17"></a><span id="l11.17"> class nsMsgSearchTerm : public nsIMsgSearchTerm</span>
<a href="#l11.18"></a><span id="l11.18"> {</span>
<a href="#l11.19"></a><span id="l11.19"> public:</span>
<a href="#l11.20"></a><span id="l11.20">   nsMsgSearchTerm();</span>
<a href="#l11.21"></a><span id="l11.21">   nsMsgSearchTerm (nsMsgSearchAttribValue, nsMsgSearchOpValue, nsIMsgSearchValue *, nsMsgSearchBooleanOperator, const char * arbitraryHeader);</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineat">@@ -112,15 +112,15 @@ protected:</span>
<a href="#l11.23"></a><span id="l11.23">   nsresult OutputValue(nsCString &amp;outputStr);</span>
<a href="#l11.24"></a><span id="l11.24">   nsresult ParseAttribute(char *inStream, nsMsgSearchAttribValue *attrib);</span>
<a href="#l11.25"></a><span id="l11.25">   nsresult ParseOperator(char *inStream, nsMsgSearchOpValue *value);</span>
<a href="#l11.26"></a><span id="l11.26">   nsresult ParseValue(char *inStream);</span>
<a href="#l11.27"></a><span id="l11.27">   nsresult InitHeaderAddressParser();</span>
<a href="#l11.28"></a><span id="l11.28">     nsresult InitializeAddressBook();</span>
<a href="#l11.29"></a><span id="l11.29">     nsresult MatchInAddressBook(const char * aAddress, PRBool *pResult);</span>
<a href="#l11.30"></a><span id="l11.30">     // fields used by search in address book</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-    nsCOMPtr &lt;nsIAbMDBDirectory&gt; mDirectory;</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+    nsCOMPtr &lt;nsIAbDirectory&gt; mDirectory;</span>
<a href="#l11.33"></a><span id="l11.33"> </span>
<a href="#l11.34"></a><span id="l11.34">     PRPackedBool mBeginsGrouping;</span>
<a href="#l11.35"></a><span id="l11.35">     PRPackedBool mEndsGrouping;</span>
<a href="#l11.36"></a><span id="l11.36"> };</span>
<a href="#l11.37"></a><span id="l11.37"> </span>
<a href="#l11.38"></a><span id="l11.38"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgSearchTerm.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgSearchTerm.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -63,17 +63,16 @@</span>
<a href="#l12.4"></a><span id="l12.4"> #include &quot;nsIMsgFilterPlugin.h&quot;</span>
<a href="#l12.5"></a><span id="l12.5"> #include &quot;nsILocalFile.h&quot;</span>
<a href="#l12.6"></a><span id="l12.6"> #include &quot;nsIRDFService.h&quot;</span>
<a href="#l12.7"></a><span id="l12.7"> #include &quot;nsISupportsObsolete.h&quot;</span>
<a href="#l12.8"></a><span id="l12.8"> #include &quot;nsNetCID.h&quot;</span>
<a href="#l12.9"></a><span id="l12.9"> #include &quot;nsIFileStreams.h&quot;</span>
<a href="#l12.10"></a><span id="l12.10"> #include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l12.11"></a><span id="l12.11"> #include &quot;nsIAbCard.h&quot;</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-#include &quot;nsIAbDirectory.h&quot;</span>
<a href="#l12.13"></a><span id="l12.13"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l12.14"></a><span id="l12.14"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l12.15"></a><span id="l12.15"> #include &quot;nsMemory.h&quot;</span>
<a href="#l12.16"></a><span id="l12.16"> #include &lt;ctype.h&gt;</span>
<a href="#l12.17"></a><span id="l12.17"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l12.18"></a><span id="l12.18"> #include &quot;nsIMsgTagService.h&quot;</span>
<a href="#l12.19"></a><span id="l12.19"> </span>
<a href="#l12.20"></a><span id="l12.20"> //---------------------------------------------------------------------------</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineat">@@ -888,21 +887,18 @@ nsresult nsMsgSearchTerm::MatchBody (nsI</span>
<a href="#l12.22"></a><span id="l12.22"> nsresult nsMsgSearchTerm::InitializeAddressBook()</span>
<a href="#l12.23"></a><span id="l12.23"> {</span>
<a href="#l12.24"></a><span id="l12.24">   // the search attribute value has the URI for the address book we need to load.</span>
<a href="#l12.25"></a><span id="l12.25">   // we need both the database and the directory.</span>
<a href="#l12.26"></a><span id="l12.26">   nsresult rv = NS_OK;</span>
<a href="#l12.27"></a><span id="l12.27"> </span>
<a href="#l12.28"></a><span id="l12.28">   if (mDirectory)</span>
<a href="#l12.29"></a><span id="l12.29">   {</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineminus">-    nsCOMPtr&lt;nsIAbDirectory&gt; dir(do_QueryInterface(mDirectory, &amp;rv));</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineminus">-</span>
<a href="#l12.33"></a><span id="l12.33">     nsCString uri;</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineminus">-    rv = dir-&gt;GetURI(uri);</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+    rv = mDirectory-&gt;GetURI(uri);</span>
<a href="#l12.36"></a><span id="l12.36">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.37"></a><span id="l12.37"> </span>
<a href="#l12.38"></a><span id="l12.38">     if (!uri.Equals(m_value.string))</span>
<a href="#l12.39"></a><span id="l12.39">       // clear out the directory....we are no longer pointing to the right one</span>
<a href="#l12.40"></a><span id="l12.40">       mDirectory = nsnull;</span>
<a href="#l12.41"></a><span id="l12.41">   }</span>
<a href="#l12.42"></a><span id="l12.42">   if (!mDirectory)</span>
<a href="#l12.43"></a><span id="l12.43">   {</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineat">@@ -926,19 +922,21 @@ nsresult nsMsgSearchTerm::MatchInAddress</span>
<a href="#l12.45"></a><span id="l12.45">   *pResult = PR_FALSE;</span>
<a href="#l12.46"></a><span id="l12.46"> </span>
<a href="#l12.47"></a><span id="l12.47">   // Some junkmails have empty From: fields.</span>
<a href="#l12.48"></a><span id="l12.48">   if (aAddress == NULL || strlen(aAddress) == 0)</span>
<a href="#l12.49"></a><span id="l12.49">     return rv;</span>
<a href="#l12.50"></a><span id="l12.50"> </span>
<a href="#l12.51"></a><span id="l12.51">   if (mDirectory)</span>
<a href="#l12.52"></a><span id="l12.52">   {</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineminus">-    nsIAbCard* cardForAddress;</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineplus">+    nsIAbCard* cardForAddress = nsnull;</span>
<a href="#l12.55"></a><span id="l12.55">     rv = mDirectory-&gt;CardForEmailAddress(nsDependentCString(aAddress),</span>
<a href="#l12.56"></a><span id="l12.56">                                          &amp;cardForAddress);</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineplus">+    if (NS_FAILED(rv) &amp;&amp; rv != NS_ERROR_NOT_IMPLEMENTED)</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineplus">+      return rv;</span>
<a href="#l12.59"></a><span id="l12.59">     if ((m_operator == nsMsgSearchOp::IsInAB &amp;&amp; cardForAddress) || (m_operator == nsMsgSearchOp::IsntInAB &amp;&amp; !cardForAddress))</span>
<a href="#l12.60"></a><span id="l12.60">       *pResult = PR_TRUE;</span>
<a href="#l12.61"></a><span id="l12.61">     NS_IF_RELEASE(cardForAddress);</span>
<a href="#l12.62"></a><span id="l12.62">   }</span>
<a href="#l12.63"></a><span id="l12.63"> </span>
<a href="#l12.64"></a><span id="l12.64">   return rv;</span>
<a href="#l12.65"></a><span id="l12.65"> }</span>
<a href="#l12.66"></a><span id="l12.66"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/base/src/nsMsgContentPolicy.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgContentPolicy.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -38,21 +38,19 @@</span>
<a href="#l13.4"></a><span id="l13.4"> </span>
<a href="#l13.5"></a><span id="l13.5"> #include &quot;nsMsgContentPolicy.h&quot;</span>
<a href="#l13.6"></a><span id="l13.6"> #include &quot;nsIServiceManager.h&quot;</span>
<a href="#l13.7"></a><span id="l13.7"> #include &quot;nsIDocShellTreeItem.h&quot;</span>
<a href="#l13.8"></a><span id="l13.8"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l13.9"></a><span id="l13.9"> #include &quot;nsIPrefBranch2.h&quot;</span>
<a href="#l13.10"></a><span id="l13.10"> #include &quot;nsIURI.h&quot;</span>
<a href="#l13.11"></a><span id="l13.11"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-#include &quot;nsIRDFResource.h&quot;</span>
<a href="#l13.14"></a><span id="l13.14"> #include &quot;nsIMsgHeaderParser.h&quot;</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+#include &quot;nsIAbManager.h&quot;</span>
<a href="#l13.16"></a><span id="l13.16"> #include &quot;nsIAbDirectory.h&quot;</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineminus">-#include &quot;nsIAbMDBDirectory.h&quot;</span>
<a href="#l13.18"></a><span id="l13.18"> #include &quot;nsIAbCard.h&quot;</span>
<a href="#l13.19"></a><span id="l13.19"> #include &quot;nsIMsgMailNewsUrl.h&quot;</span>
<a href="#l13.20"></a><span id="l13.20"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l13.21"></a><span id="l13.21"> #include &quot;nsIMimeMiscStatus.h&quot;</span>
<a href="#l13.22"></a><span id="l13.22"> #include &quot;nsIMsgMessageService.h&quot;</span>
<a href="#l13.23"></a><span id="l13.23"> #include &quot;nsIMsgIncomingServer.h&quot;</span>
<a href="#l13.24"></a><span id="l13.24"> #include &quot;nsIRssIncomingServer.h&quot;</span>
<a href="#l13.25"></a><span id="l13.25"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineat">@@ -148,48 +146,40 @@ nsresult nsMsgContentPolicy::AllowRemote</span>
<a href="#l13.27"></a><span id="l13.27"> </span>
<a href="#l13.28"></a><span id="l13.28">   nsCOMPtr&lt;nsIMsgHeaderParser&gt; headerParser = do_GetService(&quot;@mozilla.org/messenger/headerparser;1&quot;, &amp;rv);</span>
<a href="#l13.29"></a><span id="l13.29">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.30"></a><span id="l13.30"> </span>
<a href="#l13.31"></a><span id="l13.31">   nsCString emailAddress; </span>
<a href="#l13.32"></a><span id="l13.32">   rv = headerParser-&gt;ExtractHeaderAddressMailboxes(nsnull, author.get(), getter_Copies(emailAddress));</span>
<a href="#l13.33"></a><span id="l13.33">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.34"></a><span id="l13.34"> </span>
<a href="#l13.35"></a><span id="l13.35" class="difflineminus">-  if (!mCachedTopLevelAb)</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineminus">-  {</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineminus">-    // Use the RDF service to walk through the list of local directories</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineminus">-    nsCOMPtr&lt;nsIRDFService&gt; rdfService =</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineminus">-      do_GetService(&quot;@mozilla.org/rdf/rdf-service;1&quot;, &amp;rv);</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineminus">-</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; resource;</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineminus">-    rv = rdfService-&gt;GetResource(NS_LITERAL_CSTRING(&quot;moz-abdirectory://&quot;),</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineminus">-                                 getter_AddRefs(resource));</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineminus">-</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineminus">-    mCachedTopLevelAb = do_QueryInterface(resource, &amp;rv);</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineminus">-  }</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+  nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(&quot;@mozilla.org/abmanager;1&quot;,</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+                                                   &amp;rv);</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.53"></a><span id="l13.53"> </span>
<a href="#l13.54"></a><span id="l13.54">   nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineminus">-  rv = mCachedTopLevelAb-&gt;GetChildNodes(getter_AddRefs(enumerator));</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineplus">+  rv = abManager-&gt;GetDirectories(getter_AddRefs(enumerator));</span>
<a href="#l13.57"></a><span id="l13.57">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.58"></a><span id="l13.58"> </span>
<a href="#l13.59"></a><span id="l13.59">   nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineminus">-  nsCOMPtr&lt;nsIAbMDBDirectory&gt; mdbDirectory;</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineplus">+  nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l13.62"></a><span id="l13.62">   nsCOMPtr&lt;nsIAbCard&gt; cardForAddress;</span>
<a href="#l13.63"></a><span id="l13.63">   PRBool hasMore;</span>
<a href="#l13.64"></a><span id="l13.64"> </span>
<a href="#l13.65"></a><span id="l13.65">   while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore &amp;&amp; !cardForAddress)</span>
<a href="#l13.66"></a><span id="l13.66">   {</span>
<a href="#l13.67"></a><span id="l13.67">     rv = enumerator-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l13.68"></a><span id="l13.68">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineminus">-    mdbDirectory = do_QueryInterface(supports);</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineminus">-    if (mdbDirectory)</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineminus">-      mdbDirectory-&gt;CardForEmailAddress(emailAddress, getter_AddRefs(cardForAddress));</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineplus">+    directory = do_QueryInterface(supports);</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineplus">+    if (directory)</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineplus">+    {</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineplus">+      rv = directory-&gt;CardForEmailAddress(emailAddress, getter_AddRefs(cardForAddress));</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineplus">+      if (NS_FAILED(rv) &amp;&amp; rv != NS_ERROR_NOT_IMPLEMENTED)</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineplus">+        return rv;</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineplus">+    }</span>
<a href="#l13.79"></a><span id="l13.79">   }</span>
<a href="#l13.80"></a><span id="l13.80">   </span>
<a href="#l13.81"></a><span id="l13.81">   // if we found a card from the sender, </span>
<a href="#l13.82"></a><span id="l13.82">   if (cardForAddress)</span>
<a href="#l13.83"></a><span id="l13.83">     cardForAddress-&gt;GetPropertyAsBool(kAllowRemoteContentProperty, aAllowForSender);</span>
<a href="#l13.84"></a><span id="l13.84"> </span>
<a href="#l13.85"></a><span id="l13.85">   return NS_OK;</span>
<a href="#l13.86"></a><span id="l13.86"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/base/src/nsMsgContentPolicy.h</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgContentPolicy.h</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -45,17 +45,16 @@</span>
<a href="#l14.4"></a><span id="l14.4"> </span>
<a href="#l14.5"></a><span id="l14.5"> #ifndef _nsMsgContentPolicy_H_</span>
<a href="#l14.6"></a><span id="l14.6"> #define _nsMsgContentPolicy_H_</span>
<a href="#l14.7"></a><span id="l14.7"> </span>
<a href="#l14.8"></a><span id="l14.8"> #include &quot;nsIContentPolicy.h&quot;</span>
<a href="#l14.9"></a><span id="l14.9"> #include &quot;nsIObserver.h&quot;</span>
<a href="#l14.10"></a><span id="l14.10"> #include &quot;nsWeakReference.h&quot;</span>
<a href="#l14.11"></a><span id="l14.11"> #include &quot;nsString.h&quot;</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-#include &quot;nsIAbDirectory.h&quot;</span>
<a href="#l14.13"></a><span id="l14.13"> </span>
<a href="#l14.14"></a><span id="l14.14"> #include &quot;nsICookiePermission.h&quot; </span>
<a href="#l14.15"></a><span id="l14.15"> </span>
<a href="#l14.16"></a><span id="l14.16"> /* DBFCFDF0-4489-4faa-8122-190FD1EFA16C */</span>
<a href="#l14.17"></a><span id="l14.17"> #define NS_MSGCONTENTPOLICY_CID \</span>
<a href="#l14.18"></a><span id="l14.18"> { 0xdbfcfdf0, 0x4489, 0x4faa, { 0x81, 0x22, 0x19, 0xf, 0xd1, 0xef, 0xa1, 0x6c } }</span>
<a href="#l14.19"></a><span id="l14.19"> </span>
<a href="#l14.20"></a><span id="l14.20"> #define NS_MSGCONTENTPOLICY_CONTRACTID &quot;@mozilla.org/messenger/content-policy;1&quot;</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineat">@@ -76,17 +75,16 @@ public:</span>
<a href="#l14.22"></a><span id="l14.22">   NS_DECL_ISUPPORTS</span>
<a href="#l14.23"></a><span id="l14.23">   NS_DECL_NSICONTENTPOLICY</span>
<a href="#l14.24"></a><span id="l14.24">   NS_DECL_NSIOBSERVER</span>
<a href="#l14.25"></a><span id="l14.25"> </span>
<a href="#l14.26"></a><span id="l14.26"> protected:</span>
<a href="#l14.27"></a><span id="l14.27">   PRBool   mBlockRemoteImages;</span>
<a href="#l14.28"></a><span id="l14.28">   PRBool   mAllowPlugins;</span>
<a href="#l14.29"></a><span id="l14.29">   nsCString mTrustedMailDomains;</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectory&gt; mCachedTopLevelAb;</span>
<a href="#l14.31"></a><span id="l14.31"> </span>
<a href="#l14.32"></a><span id="l14.32">   PRBool IsTrustedDomain(nsIURI * aContentLocation);</span>
<a href="#l14.33"></a><span id="l14.33">   nsresult AllowRemoteContentForSender(nsIMsgDBHdr * aMsgHdr, PRBool * aAllowForSender);</span>
<a href="#l14.34"></a><span id="l14.34">   nsresult AllowRemoteContentForMsgHdr(nsIMsgDBHdr * aMsgHdr, nsIURI * aRequestingLocation, nsIURI * aContentLocation, PRInt16 *aDecision);</span>
<a href="#l14.35"></a><span id="l14.35">   nsresult MailShouldLoad(nsIURI * aRequestingLocation, nsIURI * aContentLocation, PRInt16 * aDecision);</span>
<a href="#l14.36"></a><span id="l14.36">   nsresult ComposeShouldLoad(nsIDocShell * aRootDocShell, nsISupports *aRequestingContext, </span>
<a href="#l14.37"></a><span id="l14.37">                              nsIURI * aContentLocation, PRInt16 * aDecision);</span>
<a href="#l14.38"></a><span id="l14.38"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -60,17 +60,17 @@</span>
<a href="#l15.4"></a><span id="l15.4"> #include &quot;nsIPrompt.h&quot;</span>
<a href="#l15.5"></a><span id="l15.5"> #include &quot;nsIInterfaceRequestor.h&quot;</span>
<a href="#l15.6"></a><span id="l15.6"> #include &quot;nsIInterfaceRequestorUtils.h&quot;</span>
<a href="#l15.7"></a><span id="l15.7"> #include &quot;nsILocale.h&quot;</span>
<a href="#l15.8"></a><span id="l15.8"> #include &quot;nsILocaleService.h&quot;</span>
<a href="#l15.9"></a><span id="l15.9"> #include &quot;nsCollationCID.h&quot;</span>
<a href="#l15.10"></a><span id="l15.10"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l15.11"></a><span id="l15.11"> #include &quot;nsIAbCard.h&quot;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-#include &quot;nsIAbMDBDirectory.h&quot;</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+#include &quot;nsIAbDirectory.h&quot;</span>
<a href="#l15.14"></a><span id="l15.14"> #include &quot;nsISpamSettings.h&quot;</span>
<a href="#l15.15"></a><span id="l15.15"> #include &quot;nsIMsgFilterPlugin.h&quot;</span>
<a href="#l15.16"></a><span id="l15.16"> #include &quot;nsIMsgMailSession.h&quot;</span>
<a href="#l15.17"></a><span id="l15.17"> #include &quot;nsIRDFService.h&quot;</span>
<a href="#l15.18"></a><span id="l15.18"> #include &quot;nsTextFormatter.h&quot;</span>
<a href="#l15.19"></a><span id="l15.19"> #include &quot;nsCPasswordManager.h&quot;</span>
<a href="#l15.20"></a><span id="l15.20"> #include &quot;nsMsgDBCID.h&quot;</span>
<a href="#l15.21"></a><span id="l15.21"> #include &quot;nsInt64.h&quot;</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineat">@@ -1771,17 +1771,17 @@ nsMsgDBFolder::SpamFilterClassifyMessage</span>
<a href="#l15.23"></a><span id="l15.23">  */</span>
<a href="#l15.24"></a><span id="l15.24"> NS_IMETHODIMP</span>
<a href="#l15.25"></a><span id="l15.25"> nsMsgDBFolder::CallFilterPlugins(nsIMsgWindow *aMsgWindow, PRBool *aFiltersRun)</span>
<a href="#l15.26"></a><span id="l15.26"> {</span>
<a href="#l15.27"></a><span id="l15.27">   NS_ENSURE_ARG_POINTER(aFiltersRun);</span>
<a href="#l15.28"></a><span id="l15.28">   *aFiltersRun = PR_FALSE;</span>
<a href="#l15.29"></a><span id="l15.29">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l15.30"></a><span id="l15.30">   nsCOMPtr&lt;nsISpamSettings&gt; spamSettings;</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">-  nsCOMArray&lt;nsIAbMDBDirectory&gt; whiteListDirArray;</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+  nsCOMArray&lt;nsIAbDirectory&gt; whiteListDirArray;</span>
<a href="#l15.33"></a><span id="l15.33">   nsCOMPtr&lt;nsIMsgHeaderParser&gt; headerParser;</span>
<a href="#l15.34"></a><span id="l15.34">   PRBool useWhiteList = PR_FALSE;</span>
<a href="#l15.35"></a><span id="l15.35">   PRInt32 spamLevel = 0;</span>
<a href="#l15.36"></a><span id="l15.36">   nsCString whiteListAbURI;</span>
<a href="#l15.37"></a><span id="l15.37"> </span>
<a href="#l15.38"></a><span id="l15.38">   nsresult rv = GetServer(getter_AddRefs(server));</span>
<a href="#l15.39"></a><span id="l15.39">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.40"></a><span id="l15.40"> </span>
<a href="#l15.41"></a><span id="l15.41" class="difflineat">@@ -1871,17 +1871,18 @@ nsMsgDBFolder::CallFilterPlugins(nsIMsgW</span>
<a href="#l15.42"></a><span id="l15.42">       nsCStringArray whiteListArray;</span>
<a href="#l15.43"></a><span id="l15.43">       whiteListArray.ParseString(whiteListAbURI.get(), &quot; &quot;);</span>
<a href="#l15.44"></a><span id="l15.44"> </span>
<a href="#l15.45"></a><span id="l15.45">       for (PRInt32 index = 0; index &lt; whiteListArray.Count(); index++)</span>
<a href="#l15.46"></a><span id="l15.46">       {</span>
<a href="#l15.47"></a><span id="l15.47">         nsCOMPtr&lt;nsIRDFResource&gt; resource;</span>
<a href="#l15.48"></a><span id="l15.48">         rv = rdfService-&gt;GetResource(*whiteListArray[index], getter_AddRefs(resource));</span>
<a href="#l15.49"></a><span id="l15.49"> </span>
<a href="#l15.50"></a><span id="l15.50" class="difflineminus">-        nsCOMPtr&lt;nsIAbMDBDirectory&gt; whiteListDirectory = do_QueryInterface(resource, &amp;rv);</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+        nsCOMPtr&lt;nsIAbDirectory&gt; whiteListDirectory =</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineplus">+          do_QueryInterface(resource, &amp;rv);</span>
<a href="#l15.53"></a><span id="l15.53">         if (whiteListDirectory)</span>
<a href="#l15.54"></a><span id="l15.54">           whiteListDirArray.AppendObject(whiteListDirectory);</span>
<a href="#l15.55"></a><span id="l15.55">       }</span>
<a href="#l15.56"></a><span id="l15.56">     }</span>
<a href="#l15.57"></a><span id="l15.57">     // if we can't get the db, we probably want to continue firing spam filters.</span>
<a href="#l15.58"></a><span id="l15.58">   }</span>
<a href="#l15.59"></a><span id="l15.59"> </span>
<a href="#l15.60"></a><span id="l15.60">   nsCString trustedMailDomains;</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineat">@@ -1940,19 +1941,18 @@ nsMsgDBFolder::CallFilterPlugins(nsIMsgW</span>
<a href="#l15.62"></a><span id="l15.62">     {</span>
<a href="#l15.63"></a><span id="l15.63">       if (NS_SUCCEEDED(rv))</span>
<a href="#l15.64"></a><span id="l15.64">       {</span>
<a href="#l15.65"></a><span id="l15.65">         nsIAbCard* cardForAddress = nsnull;</span>
<a href="#l15.66"></a><span id="l15.66">         // don't want to abort the rest of the scoring.</span>
<a href="#l15.67"></a><span id="l15.67">         if (!authorEmailAddress.IsEmpty())</span>
<a href="#l15.68"></a><span id="l15.68">         {</span>
<a href="#l15.69"></a><span id="l15.69">           for (PRInt32 index = 0; index &lt; whiteListDirArray.Count() &amp;&amp; !cardForAddress; index++)</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineminus">-            rv = whiteListDirArray[index]-&gt;CardForEmailAddress(authorEmailAddress, &amp;cardForAddress);</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineminus">-            if (NS_FAILED(rv))</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineminus">-              cardForAddress = nsnull;</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineplus">+            whiteListDirArray[index]-&gt;CardForEmailAddress(authorEmailAddress,</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineplus">+                                                          &amp;cardForAddress);</span>
<a href="#l15.75"></a><span id="l15.75">         }</span>
<a href="#l15.76"></a><span id="l15.76">         if (cardForAddress)</span>
<a href="#l15.77"></a><span id="l15.77">         {</span>
<a href="#l15.78"></a><span id="l15.78">           NS_RELEASE(cardForAddress);</span>
<a href="#l15.79"></a><span id="l15.79">           // mark this msg as non-junk, because we whitelisted it.</span>
<a href="#l15.80"></a><span id="l15.80">           mDatabase-&gt;SetStringProperty(msgKey, &quot;junkscore&quot;, &quot;0&quot;);</span>
<a href="#l15.81"></a><span id="l15.81">           mDatabase-&gt;SetStringProperty(msgKey, &quot;junkscoreorigin&quot;, &quot;whitelist&quot;);</span>
<a href="#l15.82"></a><span id="l15.82">           continue; // skip this msg since it's in the white list</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

