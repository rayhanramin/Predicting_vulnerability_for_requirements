<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 29571:cca8ae03b543529819e22064c3e5e6c790d257e8</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ cca8ae03b543529819e22064c3e5e6c790d257e8" />
<meta property="og:url" content="/comm-central/rev/cca8ae03b543529819e22064c3e5e6c790d257e8" />
<meta property="og:description" content="Bug 1636290 - Initial user assistance for OpenPGP problems in message composer. r=PatrickBrunschwig,mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / cca8ae03b543529819e22064c3e5e6c790d257e8 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/cca8ae03b543529819e22064c3e5e6c790d257e8">shortlog</a> |
<a href="/comm-central/log/cca8ae03b543529819e22064c3e5e6c790d257e8">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/cca8ae03b543529819e22064c3e5e6c790d257e8">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/cca8ae03b543529819e22064c3e5e6c790d257e8">files</a> |
changeset |
<a href="/comm-central/raw-rev/cca8ae03b543529819e22064c3e5e6c790d257e8">raw</a>  | <a href="/comm-central/archive/cca8ae03b543529819e22064c3e5e6c790d257e8.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1636290">Bug 1636290</a> - Initial user assistance for OpenPGP problems in message composer. r=PatrickBrunschwig,mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#75;&#97;&#105;&#32;&#69;&#110;&#103;&#101;&#114;&#116;&#32;&#60;&#107;&#97;&#105;&#101;&#64;&#107;&#117;&#105;&#120;&#46;&#100;&#101;&#62;</td></tr>
<tr><td></td><td class="date age">Sun, 03 May 2020 21:46:07 +0200</td></tr>

<tr>
 <td>changeset 29571</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/cca8ae03b543529819e22064c3e5e6c790d257e8">cca8ae03b543529819e22064c3e5e6c790d257e8</a></td>
</tr>



<tr>
<td>parent 29570</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/936dbd8706b8b49edb760edbe50199000de978f2">936dbd8706b8b49edb760edbe50199000de978f2</a>
</td>
</tr>

<tr>
<td>child 29572</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/4a66b9f9dec4bcb03584e70a9019ed02af4a3808">4a66b9f9dec4bcb03584e70a9019ed02af4a3808</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=cca8ae03b543529819e22064c3e5e6c790d257e8">17438</a></td></tr>
<tr><td>push user</td><td>kaie@kuix.de</td></tr>
<tr><td>push date</td><td class="date age">Thu, 14 May 2020 16:34:10 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@29a19bc9fd47 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=29a19bc9fd475e16c3457dce90a883461d065c5c">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=29a19bc9fd475e16c3457dce90a883461d065c5c&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=29a19bc9fd475e16c3457dce90a883461d065c5c&newProject=comm-central&newRevision=cca8ae03b543529819e22064c3e5e6c790d257e8&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=29a19bc9fd475e16c3457dce90a883461d065c5c&newProject=comm-central&newRevision=cca8ae03b543529819e22064c3e5e6c790d257e8&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=29a19bc9fd475e16c3457dce90a883461d065c5c&newProject=comm-central&newRevision=cca8ae03b543529819e22064c3e5e6c790d257e8&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28PatrickBrunschwig%29&revcount=50">PatrickBrunschwig</a>, <a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1636290">1636290</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1636290">Bug 1636290</a> - Initial user assistance for OpenPGP problems in message composer. r=PatrickBrunschwig,mkmelin

Differential Revision: <a href="https://phabricator.services.mozilla.com/D74330">https://phabricator.services.mozilla.com/D74330</a></div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/components/compose/content/MsgComposeCommands.js">mail/components/compose/content/MsgComposeCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/components/compose/content/MsgComposeCommands.js">file</a> |
<a href="/comm-central/annotate/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/components/compose/content/MsgComposeCommands.js">annotate</a> |
<a href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/components/compose/content/MsgComposeCommands.js">diff</a> |
<a href="/comm-central/comparison/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/components/compose/content/MsgComposeCommands.js">comparison</a> |
<a href="/comm-central/log/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/components/compose/content/MsgComposeCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/am-e2e/prefs/e2e-prefs.js">mail/extensions/am-e2e/prefs/e2e-prefs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/am-e2e/prefs/e2e-prefs.js">file</a> |
<a href="/comm-central/annotate/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/am-e2e/prefs/e2e-prefs.js">annotate</a> |
<a href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/am-e2e/prefs/e2e-prefs.js">diff</a> |
<a href="/comm-central/comparison/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/am-e2e/prefs/e2e-prefs.js">comparison</a> |
<a href="/comm-central/log/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/am-e2e/prefs/e2e-prefs.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/modules/RNP.jsm">mail/extensions/openpgp/content/modules/RNP.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/modules/RNP.jsm">file</a> |
<a href="/comm-central/annotate/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/modules/RNP.jsm">annotate</a> |
<a href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/modules/RNP.jsm">diff</a> |
<a href="/comm-central/comparison/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/modules/RNP.jsm">comparison</a> |
<a href="/comm-central/log/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/modules/RNP.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/modules/keyRing.jsm">mail/extensions/openpgp/content/modules/keyRing.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/modules/keyRing.jsm">file</a> |
<a href="/comm-central/annotate/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/modules/keyRing.jsm">annotate</a> |
<a href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/modules/keyRing.jsm">diff</a> |
<a href="/comm-central/comparison/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/modules/keyRing.jsm">comparison</a> |
<a href="/comm-central/log/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/modules/keyRing.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/modules/keyserver.jsm">mail/extensions/openpgp/content/modules/keyserver.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/modules/keyserver.jsm">file</a> |
<a href="/comm-central/annotate/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/modules/keyserver.jsm">annotate</a> |
<a href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/modules/keyserver.jsm">diff</a> |
<a href="/comm-central/comparison/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/modules/keyserver.jsm">comparison</a> |
<a href="/comm-central/log/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/modules/keyserver.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/modules/keyserverUris.jsm">mail/extensions/openpgp/content/modules/keyserverUris.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/modules/keyserverUris.jsm">file</a> |
<a href="/comm-central/annotate/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/modules/keyserverUris.jsm">annotate</a> |
<a href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/modules/keyserverUris.jsm">diff</a> |
<a href="/comm-central/comparison/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/modules/keyserverUris.jsm">comparison</a> |
<a href="/comm-central/log/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/modules/keyserverUris.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/modules/sqliteDb.jsm">mail/extensions/openpgp/content/modules/sqliteDb.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/modules/sqliteDb.jsm">file</a> |
<a href="/comm-central/annotate/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/modules/sqliteDb.jsm">annotate</a> |
<a href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/modules/sqliteDb.jsm">diff</a> |
<a href="/comm-central/comparison/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/modules/sqliteDb.jsm">comparison</a> |
<a href="/comm-central/log/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/modules/sqliteDb.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/modules/uidHelper.jsm">mail/extensions/openpgp/content/modules/uidHelper.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/modules/uidHelper.jsm">file</a> |
<a href="/comm-central/annotate/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/modules/uidHelper.jsm">annotate</a> |
<a href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/modules/uidHelper.jsm">diff</a> |
<a href="/comm-central/comparison/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/modules/uidHelper.jsm">comparison</a> |
<a href="/comm-central/log/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/modules/uidHelper.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/strings/composeKeyStatus.dtd">mail/extensions/openpgp/content/strings/composeKeyStatus.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/strings/composeKeyStatus.dtd">file</a> |
<a href="/comm-central/annotate/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/strings/composeKeyStatus.dtd">annotate</a> |
<a href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/strings/composeKeyStatus.dtd">diff</a> |
<a href="/comm-central/comparison/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/strings/composeKeyStatus.dtd">comparison</a> |
<a href="/comm-central/log/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/strings/composeKeyStatus.dtd">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/strings/composeKeyStatus.properties">mail/extensions/openpgp/content/strings/composeKeyStatus.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/strings/composeKeyStatus.properties">file</a> |
<a href="/comm-central/annotate/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/strings/composeKeyStatus.properties">annotate</a> |
<a href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/strings/composeKeyStatus.properties">diff</a> |
<a href="/comm-central/comparison/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/strings/composeKeyStatus.properties">comparison</a> |
<a href="/comm-central/log/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/strings/composeKeyStatus.properties">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/strings/enigmail.properties">mail/extensions/openpgp/content/strings/enigmail.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/strings/enigmail.properties">file</a> |
<a href="/comm-central/annotate/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/strings/enigmail.properties">annotate</a> |
<a href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/strings/enigmail.properties">diff</a> |
<a href="/comm-central/comparison/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/strings/enigmail.properties">comparison</a> |
<a href="/comm-central/log/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/strings/enigmail.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/strings/oneRecipientStatus.dtd">mail/extensions/openpgp/content/strings/oneRecipientStatus.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/strings/oneRecipientStatus.dtd">file</a> |
<a href="/comm-central/annotate/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/strings/oneRecipientStatus.dtd">annotate</a> |
<a href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/strings/oneRecipientStatus.dtd">diff</a> |
<a href="/comm-central/comparison/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/strings/oneRecipientStatus.dtd">comparison</a> |
<a href="/comm-central/log/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/strings/oneRecipientStatus.dtd">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/strings/oneRecipientStatus.properties">mail/extensions/openpgp/content/strings/oneRecipientStatus.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/strings/oneRecipientStatus.properties">file</a> |
<a href="/comm-central/annotate/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/strings/oneRecipientStatus.properties">annotate</a> |
<a href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/strings/oneRecipientStatus.properties">diff</a> |
<a href="/comm-central/comparison/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/strings/oneRecipientStatus.properties">comparison</a> |
<a href="/comm-central/log/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/strings/oneRecipientStatus.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/composeKeyStatus.js">mail/extensions/openpgp/content/ui/composeKeyStatus.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/composeKeyStatus.js">file</a> |
<a href="/comm-central/annotate/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/composeKeyStatus.js">annotate</a> |
<a href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/composeKeyStatus.js">diff</a> |
<a href="/comm-central/comparison/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/composeKeyStatus.js">comparison</a> |
<a href="/comm-central/log/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/composeKeyStatus.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/composeKeyStatus.xhtml">mail/extensions/openpgp/content/ui/composeKeyStatus.xhtml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/composeKeyStatus.xhtml">file</a> |
<a href="/comm-central/annotate/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/composeKeyStatus.xhtml">annotate</a> |
<a href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/composeKeyStatus.xhtml">diff</a> |
<a href="/comm-central/comparison/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/composeKeyStatus.xhtml">comparison</a> |
<a href="/comm-central/log/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/composeKeyStatus.xhtml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">file</a> |
<a href="/comm-central/annotate/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">annotate</a> |
<a href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">diff</a> |
<a href="/comm-central/comparison/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">comparison</a> |
<a href="/comm-central/log/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/enigmailMsgComposeHelper.js">mail/extensions/openpgp/content/ui/enigmailMsgComposeHelper.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/enigmailMsgComposeHelper.js">file</a> |
<a href="/comm-central/annotate/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/enigmailMsgComposeHelper.js">annotate</a> |
<a href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/enigmailMsgComposeHelper.js">diff</a> |
<a href="/comm-central/comparison/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/enigmailMsgComposeHelper.js">comparison</a> |
<a href="/comm-central/log/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/enigmailMsgComposeHelper.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">file</a> |
<a href="/comm-central/annotate/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">annotate</a> |
<a href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">diff</a> |
<a href="/comm-central/comparison/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">comparison</a> |
<a href="/comm-central/log/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/keyDetailsDlg.js">mail/extensions/openpgp/content/ui/keyDetailsDlg.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/keyDetailsDlg.js">file</a> |
<a href="/comm-central/annotate/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/keyDetailsDlg.js">annotate</a> |
<a href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/keyDetailsDlg.js">diff</a> |
<a href="/comm-central/comparison/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/keyDetailsDlg.js">comparison</a> |
<a href="/comm-central/log/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/keyDetailsDlg.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/keyDetailsDlg.xhtml">mail/extensions/openpgp/content/ui/keyDetailsDlg.xhtml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/keyDetailsDlg.xhtml">file</a> |
<a href="/comm-central/annotate/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/keyDetailsDlg.xhtml">annotate</a> |
<a href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/keyDetailsDlg.xhtml">diff</a> |
<a href="/comm-central/comparison/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/keyDetailsDlg.xhtml">comparison</a> |
<a href="/comm-central/log/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/keyDetailsDlg.xhtml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/oneRecipientStatus.js">mail/extensions/openpgp/content/ui/oneRecipientStatus.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/oneRecipientStatus.js">file</a> |
<a href="/comm-central/annotate/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/oneRecipientStatus.js">annotate</a> |
<a href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/oneRecipientStatus.js">diff</a> |
<a href="/comm-central/comparison/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/oneRecipientStatus.js">comparison</a> |
<a href="/comm-central/log/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/oneRecipientStatus.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/oneRecipientStatus.xhtml">mail/extensions/openpgp/content/ui/oneRecipientStatus.xhtml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/oneRecipientStatus.xhtml">file</a> |
<a href="/comm-central/annotate/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/oneRecipientStatus.xhtml">annotate</a> |
<a href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/oneRecipientStatus.xhtml">diff</a> |
<a href="/comm-central/comparison/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/oneRecipientStatus.xhtml">comparison</a> |
<a href="/comm-central/log/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/content/ui/oneRecipientStatus.xhtml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/jar.mn">mail/extensions/openpgp/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/jar.mn">file</a> |
<a href="/comm-central/annotate/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/jar.mn">annotate</a> |
<a href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/jar.mn">diff</a> |
<a href="/comm-central/comparison/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/jar.mn">comparison</a> |
<a href="/comm-central/log/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/extensions/openpgp/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/themes/shared/jar.inc.mn">mail/themes/shared/jar.inc.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/themes/shared/jar.inc.mn">file</a> |
<a href="/comm-central/annotate/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/themes/shared/jar.inc.mn">annotate</a> |
<a href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/themes/shared/jar.inc.mn">diff</a> |
<a href="/comm-central/comparison/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/themes/shared/jar.inc.mn">comparison</a> |
<a href="/comm-central/log/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/themes/shared/jar.inc.mn">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/themes/shared/openpgp/composeKeyStatus.css">mail/themes/shared/openpgp/composeKeyStatus.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/themes/shared/openpgp/composeKeyStatus.css">file</a> |
<a href="/comm-central/annotate/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/themes/shared/openpgp/composeKeyStatus.css">annotate</a> |
<a href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/themes/shared/openpgp/composeKeyStatus.css">diff</a> |
<a href="/comm-central/comparison/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/themes/shared/openpgp/composeKeyStatus.css">comparison</a> |
<a href="/comm-central/log/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/themes/shared/openpgp/composeKeyStatus.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/themes/shared/openpgp/oneRecipientStatus.css">mail/themes/shared/openpgp/oneRecipientStatus.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/themes/shared/openpgp/oneRecipientStatus.css">file</a> |
<a href="/comm-central/annotate/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/themes/shared/openpgp/oneRecipientStatus.css">annotate</a> |
<a href="/comm-central/diff/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/themes/shared/openpgp/oneRecipientStatus.css">diff</a> |
<a href="/comm-central/comparison/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/themes/shared/openpgp/oneRecipientStatus.css">comparison</a> |
<a href="/comm-central/log/cca8ae03b543529819e22064c3e5e6c790d257e8/mail/themes/shared/openpgp/oneRecipientStatus.css">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1729,31 +1729,47 @@ function setSecuritySettings(menu_id) {</span>
<a href="#l1.4"></a><span id="l1.4">       }</span>
<a href="#l1.5"></a><span id="l1.5">     }</span>
<a href="#l1.6"></a><span id="l1.6">   }</span>
<a href="#l1.7"></a><span id="l1.7"> }</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9"> function showMessageComposeSecurityStatus() {</span>
<a href="#l1.10"></a><span id="l1.10">   Recipients2CompFields(gMsgCompose.compFields);</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  window.openDialog(</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-    &quot;chrome://messenger-smime/content/msgCompSecurityInfo.xhtml&quot;,</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-    &quot;&quot;,</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-    &quot;chrome,modal,resizable,centerscreen&quot;,</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-    {</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-      compFields: gMsgCompose.compFields,</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-      subject: document.getElementById(&quot;msgSubject&quot;).value,</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineminus">-      smFields: gSMFields,</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">-      isSigningCertAvailable:</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineminus">-        gCurrentIdentity.getUnicharAttribute(&quot;signing_cert_name&quot;) != &quot;&quot;,</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineminus">-      isEncryptionCertAvailable:</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineminus">-        gCurrentIdentity.getUnicharAttribute(&quot;encryption_cert_name&quot;) != &quot;&quot;,</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineminus">-      currentIdentity: gCurrentIdentity,</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineminus">-    }</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineminus">-  );</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+  if (</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+    MailConstants.MOZ_OPENPGP &amp;&amp;</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+    BondOpenPGP.allDependenciesLoaded() &amp;&amp;</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+    gSelectedTechnologyIsPGP</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+  ) {</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+    window.openDialog(</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+      &quot;chrome://openpgp/content/ui/composeKeyStatus.xhtml&quot;,</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+      &quot;&quot;,</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+      &quot;chrome,modal,resizable,centerscreen&quot;,</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+      {</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+        compFields: gMsgCompose.compFields,</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+        currentIdentity: gCurrentIdentity,</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+      }</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+    );</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+  } else {</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+    window.openDialog(</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+      &quot;chrome://messenger-smime/content/msgCompSecurityInfo.xhtml&quot;,</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+      &quot;&quot;,</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+      &quot;chrome,modal,resizable,centerscreen&quot;,</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+      {</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+        compFields: gMsgCompose.compFields,</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+        subject: document.getElementById(&quot;msgSubject&quot;).value,</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+        smFields: gSMFields,</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+        isSigningCertAvailable:</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+          gCurrentIdentity.getUnicharAttribute(&quot;signing_cert_name&quot;) != &quot;&quot;,</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+        isEncryptionCertAvailable:</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+          gCurrentIdentity.getUnicharAttribute(&quot;encryption_cert_name&quot;) != &quot;&quot;,</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+        currentIdentity: gCurrentIdentity,</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+      }</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+    );</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+  }</span>
<a href="#l1.58"></a><span id="l1.58"> }</span>
<a href="#l1.59"></a><span id="l1.59"> </span>
<a href="#l1.60"></a><span id="l1.60"> function openEditorContextMenu(popup) {</span>
<a href="#l1.61"></a><span id="l1.61">   gSpellChecker.clearSuggestionsFromMenu();</span>
<a href="#l1.62"></a><span id="l1.62">   gSpellChecker.initFromEvent(</span>
<a href="#l1.63"></a><span id="l1.63">     document.popupRangeParent,</span>
<a href="#l1.64"></a><span id="l1.64">     document.popupRangeOffset</span>
<a href="#l1.65"></a><span id="l1.65">   );</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/extensions/am-e2e/prefs/e2e-prefs.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/extensions/am-e2e/prefs/e2e-prefs.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -83,18 +83,18 @@ pref(&quot;temp.openpgp.inlineSigAttachExt&quot;, </span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5"> // debug log directory (if set, also enabled debugging)</span>
<a href="#l2.6"></a><span id="l2.6"> pref(&quot;temp.openpgp.logDirectory&quot;, &quot;&quot;);</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8"> // display all or no keys by default in the key manager</span>
<a href="#l2.9"></a><span id="l2.9"> pref(&quot;temp.openpgp.keyManShowAllKeys&quot;, true);</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-// list of keyservers to use</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-pref(&quot;temp.openpgp.keyserver&quot;, &quot;vks://keys.openpgp.org, hkps://hkps.pool.sks-keyservers.net, hkps://pgp.mit.edu&quot;);</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+// list of keyservers to use (comma separated list)</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+pref(&quot;temp.openpgp.keyserver&quot;, &quot;vks://keys.openpgp.org&quot;);</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17"> // auto select the first keyserver in the key server list</span>
<a href="#l2.18"></a><span id="l2.18"> pref(&quot;temp.openpgp.autoKeyServerSelection&quot;, true);</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20"> // keep passphrase for ... minutes</span>
<a href="#l2.21"></a><span id="l2.21"> pref(&quot;temp.openpgp.maxIdleMinutes&quot;, 5);</span>
<a href="#l2.22"></a><span id="l2.22"> </span>
<a href="#l2.23"></a><span id="l2.23"> // maximum number of parallel decrypt processes that Enigmaik will handle</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/RNP.jsm</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/RNP.jsm</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -323,16 +323,18 @@ var RNP = {</span>
<a href="#l3.4"></a><span id="l3.4">       throw new Error(&quot;rnp_key_is_revoked failed&quot;);</span>
<a href="#l3.5"></a><span id="l3.5">     }</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7">     if (key_revoked.value) {</span>
<a href="#l3.8"></a><span id="l3.8">       keyObj.keyTrust = &quot;r&quot;;</span>
<a href="#l3.9"></a><span id="l3.9">       if (forListing) {</span>
<a href="#l3.10"></a><span id="l3.10">         keyObj.revoke = true;</span>
<a href="#l3.11"></a><span id="l3.11">       }</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+    } else if (this.isExpiredTime(keyObj.expiryTime)) {</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+      keyObj.keyTrust = &quot;e&quot;;</span>
<a href="#l3.14"></a><span id="l3.14">     } else if (keyObj.secretAvailable) {</span>
<a href="#l3.15"></a><span id="l3.15">       keyObj.keyTrust = &quot;u&quot;;</span>
<a href="#l3.16"></a><span id="l3.16">     } else {</span>
<a href="#l3.17"></a><span id="l3.17">       keyObj.keyTrust = &quot;o&quot;;</span>
<a href="#l3.18"></a><span id="l3.18">     }</span>
<a href="#l3.19"></a><span id="l3.19"> </span>
<a href="#l3.20"></a><span id="l3.20">     /* The remaining actions are done for primary keys, only. */</span>
<a href="#l3.21"></a><span id="l3.21">     if (!is_subkey.value) {</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineat">@@ -678,17 +680,25 @@ var RNP = {</span>
<a href="#l3.23"></a><span id="l3.23">     if (</span>
<a href="#l3.24"></a><span id="l3.24">       result.exitCode &amp;&amp;</span>
<a href="#l3.25"></a><span id="l3.25">       !(&quot;alreadyUsedGPGME&quot; in options) &amp;&amp;</span>
<a href="#l3.26"></a><span id="l3.26">       GPGME.allDependenciesLoaded()</span>
<a href="#l3.27"></a><span id="l3.27">     ) {</span>
<a href="#l3.28"></a><span id="l3.28">       // failure processing with RNP, attempt decryption with GPGME</span>
<a href="#l3.29"></a><span id="l3.29">       let r2 = await GPGME.decrypt(encrypted, RNP.enArmor);</span>
<a href="#l3.30"></a><span id="l3.30">       if (!r2.exitCode &amp;&amp; r2.decryptedData) {</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+        // TODO: obtain info which key ID was used for decryption</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+        //       and set result.decryptKey*</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+        //       It isn't obvious how to do that with GPGME, because</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+        //       gpgme_op_decrypt_result provides the list of all the</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+        //       encryption keys, only.</span>
<a href="#l3.36"></a><span id="l3.36">         options.alreadyUsedGPGME = true;</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+        // The result may still contain wrapping like compression,</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+        // and optional signature data. Recursively call ourselves</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+        // to perform the remaining processing.</span>
<a href="#l3.40"></a><span id="l3.40">         return RNP.decrypt(r2.decryptedData, options);</span>
<a href="#l3.41"></a><span id="l3.41">       }</span>
<a href="#l3.42"></a><span id="l3.42">     }</span>
<a href="#l3.43"></a><span id="l3.43"> </span>
<a href="#l3.44"></a><span id="l3.44">     return result;</span>
<a href="#l3.45"></a><span id="l3.45">   },</span>
<a href="#l3.46"></a><span id="l3.46"> </span>
<a href="#l3.47"></a><span id="l3.47">   async getVerifyDetails(ffi, fromAddr, verify_op, result) {</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineat">@@ -1752,32 +1762,42 @@ var RNP = {</span>
<a href="#l3.49"></a><span id="l3.49"> </span>
<a href="#l3.50"></a><span id="l3.50">     if (args.sign) {</span>
<a href="#l3.51"></a><span id="l3.51">       resultStatus.statusFlags |= EnigmailConstants.SIG_CREATED;</span>
<a href="#l3.52"></a><span id="l3.52">     }</span>
<a href="#l3.53"></a><span id="l3.53"> </span>
<a href="#l3.54"></a><span id="l3.54">     return result;</span>
<a href="#l3.55"></a><span id="l3.55">   },</span>
<a href="#l3.56"></a><span id="l3.56"> </span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+  /**</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+   * @param {number} expiryTime - Time to check, in seconds from the epoch.</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+   * @return {Boolean} - true if the given time is after now.</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+   */</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+  isExpiredTime(expiryTime) {</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+    if (!expiryTime) {</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+      return false;</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+    }</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+    let nowSeconds = Math.floor(Date.now() / 1000);</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+    return nowSeconds &gt; expiryTime;</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+  },</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+</span>
<a href="#l3.69"></a><span id="l3.69">   isKeyExpired(handle) {</span>
<a href="#l3.70"></a><span id="l3.70">     let expiration = new ctypes.uint32_t();</span>
<a href="#l3.71"></a><span id="l3.71">     if (RNPLib.rnp_key_get_expiration(handle, expiration.address())) {</span>
<a href="#l3.72"></a><span id="l3.72">       throw new Error(&quot;rnp_key_get_expiration failed&quot;);</span>
<a href="#l3.73"></a><span id="l3.73">     }</span>
<a href="#l3.74"></a><span id="l3.74">     if (!expiration.value) {</span>
<a href="#l3.75"></a><span id="l3.75">       return false;</span>
<a href="#l3.76"></a><span id="l3.76">     }</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineminus">-    let nowSeconds = Math.floor(Date.now() / 1000);</span>
<a href="#l3.78"></a><span id="l3.78">     let creation = new ctypes.uint32_t();</span>
<a href="#l3.79"></a><span id="l3.79">     if (RNPLib.rnp_key_get_creation(handle, creation.address())) {</span>
<a href="#l3.80"></a><span id="l3.80">       throw new Error(&quot;rnp_key_get_creation failed&quot;);</span>
<a href="#l3.81"></a><span id="l3.81">     }</span>
<a href="#l3.82"></a><span id="l3.82">     let expirationSeconds = creation.value + expiration.value;</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineminus">-    let isExpired = nowSeconds &gt; expirationSeconds;</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineminus">-    return isExpired;</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+    return this.isExpiredTime(expirationSeconds);</span>
<a href="#l3.86"></a><span id="l3.86">   },</span>
<a href="#l3.87"></a><span id="l3.87"> </span>
<a href="#l3.88"></a><span id="l3.88">   async findKeyByEmail(id, onlyAcceptableAsPublic = false) {</span>
<a href="#l3.89"></a><span id="l3.89">     if (!id.startsWith(&quot;&lt;&quot;) || !id.endsWith(&quot;&gt;&quot;) || id.includes(&quot; &quot;)) {</span>
<a href="#l3.90"></a><span id="l3.90">       throw new Error(&quot;invalid parameter given to findKeyByEmail&quot;);</span>
<a href="#l3.91"></a><span id="l3.91">     }</span>
<a href="#l3.92"></a><span id="l3.92"> </span>
<a href="#l3.93"></a><span id="l3.93">     let emailWithoutBrackets = id.substring(1, id.length - 1);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/keyRing.jsm</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/keyRing.jsm</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -28,16 +28,22 @@ const { EnigmailLazy } = ChromeUtils.imp</span>
<a href="#l4.4"></a><span id="l4.4"> );</span>
<a href="#l4.5"></a><span id="l4.5"> const { newEnigmailKeyObj } = ChromeUtils.import(</span>
<a href="#l4.6"></a><span id="l4.6">   &quot;chrome://openpgp/content/modules/keyObj.jsm&quot;</span>
<a href="#l4.7"></a><span id="l4.7"> );</span>
<a href="#l4.8"></a><span id="l4.8"> const { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l4.9"></a><span id="l4.9"> const { EnigmailCryptoAPI } = ChromeUtils.import(</span>
<a href="#l4.10"></a><span id="l4.10">   &quot;chrome://openpgp/content/modules/cryptoAPI.jsm&quot;</span>
<a href="#l4.11"></a><span id="l4.11"> );</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+const { PgpSqliteDb2 } = ChromeUtils.import(</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+  &quot;chrome://openpgp/content/modules/sqliteDb.jsm&quot;</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+);</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+const { uidHelper } = ChromeUtils.import(</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+  &quot;chrome://openpgp/content/modules/uidHelper.jsm&quot;</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+);</span>
<a href="#l4.18"></a><span id="l4.18"> </span>
<a href="#l4.19"></a><span id="l4.19"> const getDialog = EnigmailLazy.loader(&quot;enigmail/dialog.jsm&quot;, &quot;EnigmailDialog&quot;);</span>
<a href="#l4.20"></a><span id="l4.20"> const getWindows = EnigmailLazy.loader(</span>
<a href="#l4.21"></a><span id="l4.21">   &quot;enigmail/windows.jsm&quot;,</span>
<a href="#l4.22"></a><span id="l4.22">   &quot;EnigmailWindows&quot;</span>
<a href="#l4.23"></a><span id="l4.23"> );</span>
<a href="#l4.24"></a><span id="l4.24"> </span>
<a href="#l4.25"></a><span id="l4.25"> const DEFAULT_FILE_PERMS = 0o600;</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineat">@@ -61,18 +67,16 @@ let gLoadingKeys = false;</span>
<a href="#l4.27"></a><span id="l4.27">             - p: pgp/classical</span>
<a href="#l4.28"></a><span id="l4.28">             - t: always trust</span>
<a href="#l4.29"></a><span id="l4.29">             - a: auto (:0) (default, currently pgp/classical)</span>
<a href="#l4.30"></a><span id="l4.30">             - T: TOFU</span>
<a href="#l4.31"></a><span id="l4.31">             - TP: TOFU+PGP</span>
<a href="#l4.32"></a><span id="l4.32"> </span>
<a href="#l4.33"></a><span id="l4.33"> */</span>
<a href="#l4.34"></a><span id="l4.34"> </span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-const TRUSTLEVELS_SORTED = EnigmailTrust.trustLevelsSorted();</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineminus">-</span>
<a href="#l4.37"></a><span id="l4.37"> var EnigmailKeyRing = {</span>
<a href="#l4.38"></a><span id="l4.38">   /**</span>
<a href="#l4.39"></a><span id="l4.39">    * Get the complete list of all public keys, optionally sorted by a column</span>
<a href="#l4.40"></a><span id="l4.40">    *</span>
<a href="#l4.41"></a><span id="l4.41">    * @param  win           - optional |object| holding the parent window for displaying error messages</span>
<a href="#l4.42"></a><span id="l4.42">    * @param  sortColumn    - optional |string| containing the column name for sorting. One of:</span>
<a href="#l4.43"></a><span id="l4.43">    *                            userid, keyid, keyidshort, fpr, keytype, validity, trust, expiry</span>
<a href="#l4.44"></a><span id="l4.44">    * @param  sortDirection - |number| 1 = ascending / -1 = descending</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineat">@@ -447,17 +451,19 @@ var EnigmailKeyRing = {</span>
<a href="#l4.46"></a><span id="l4.46">    *                                     key ID, fingerprint, or userId</span>
<a href="#l4.47"></a><span id="l4.47">    * @param outputFile        String or nsIFile - output file name or Object - or NULL</span>
<a href="#l4.48"></a><span id="l4.48">    * @param exitCodeObj       Object   - o.value will contain exit code</span>
<a href="#l4.49"></a><span id="l4.49">    * @param errorMsgObj       Object   - o.value will contain error message from GnuPG</span>
<a href="#l4.50"></a><span id="l4.50">    *</span>
<a href="#l4.51"></a><span id="l4.51">    * @return String - if outputFile is NULL, the key block data; &quot;&quot; if a file is written</span>
<a href="#l4.52"></a><span id="l4.52">    */</span>
<a href="#l4.53"></a><span id="l4.53">   extractKey(includeSecretKey, idArray, outputFile, exitCodeObj, errorMsgObj) {</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineminus">-    EnigmailLog.DEBUG(&quot;keyRing.jsm: EnigmailKeyRing.extractKey: %o\n&quot;, idArray);</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+    EnigmailLog.DEBUG(</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+      &quot;keyRing.jsm: EnigmailKeyRing.extractKey: &quot; + idArray + &quot;\n&quot;</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+    );</span>
<a href="#l4.58"></a><span id="l4.58">     exitCodeObj.value = -1;</span>
<a href="#l4.59"></a><span id="l4.59"> </span>
<a href="#l4.60"></a><span id="l4.60">     if (includeSecretKey) {</span>
<a href="#l4.61"></a><span id="l4.61">       throw new Error(&quot;extractKey with secret key not implemented&quot;);</span>
<a href="#l4.62"></a><span id="l4.62">     }</span>
<a href="#l4.63"></a><span id="l4.63"> </span>
<a href="#l4.64"></a><span id="l4.64">     if (!Array.isArray(idArray) || !idArray.length) {</span>
<a href="#l4.65"></a><span id="l4.65">       throw new Error(&quot;invalid parameter given to EnigmailKeyRing.extractKey&quot;);</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineat">@@ -636,16 +642,73 @@ var EnigmailKeyRing = {</span>
<a href="#l4.67"></a><span id="l4.67"> </span>
<a href="#l4.68"></a><span id="l4.68">     let exitCode = 0;</span>
<a href="#l4.69"></a><span id="l4.69"> </span>
<a href="#l4.70"></a><span id="l4.70">     EnigmailKeyRing.clearCache();</span>
<a href="#l4.71"></a><span id="l4.71"> </span>
<a href="#l4.72"></a><span id="l4.72">     return exitCode;</span>
<a href="#l4.73"></a><span id="l4.73">   },</span>
<a href="#l4.74"></a><span id="l4.74"> </span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+  importKeyDataWithConfirmation(window, preview, keyData, isBinary) {</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+    let somethingWasImported = false;</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+    if (preview.length &gt; 0) {</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+      let exitStatus;</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+      if (preview.length == 1) {</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+        exitStatus = getDialog().confirmDlg(</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+          window,</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+          EnigmailLocale.getString(&quot;doImportOne&quot;, [</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+            preview[0].name,</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+            preview[0].id,</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+          ])</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+        );</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+      } else {</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+        exitStatus = getDialog().confirmDlg(</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+          window,</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+          EnigmailLocale.getString(&quot;doImportMultiple&quot;, [</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+            preview</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+              .map(function(a) {</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+                return &quot;\t&quot; + a.name + &quot; (&quot; + a.id + &quot;)&quot;;</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+              })</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+              .join(&quot;\n&quot;),</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+          ])</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+        );</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+      }</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+      if (exitStatus) {</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+        let errorMsgObj = {};</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+        try {</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+          exitStatus = EnigmailKeyRing.importKey(</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+            window,</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+            false,</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+            keyData,</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+            isBinary,</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+            &quot;&quot;,</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+            errorMsgObj</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+          );</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineplus">+        } catch (ex) {</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+          console.debug(ex);</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+        }</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineplus">+        if (exitStatus === 0) {</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+          let keyList = preview.map(a =&gt; a.id);</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+          getDialog().keyImportDlg(window, keyList);</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+          somethingWasImported = true;</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+        } else {</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineplus">+          getDialog().alert(</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineplus">+            window,</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineplus">+            EnigmailLocale.getString(&quot;failKeyImport&quot;) + &quot;\n&quot; + errorMsgObj.value</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineplus">+          );</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineplus">+        }</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+      }</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineplus">+    } else {</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineplus">+      getDialog().alert(window, EnigmailLocale.getString(&quot;noKeyFound&quot;));</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineplus">+    }</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineplus">+    return somethingWasImported;</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineplus">+  },</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineplus">+</span>
<a href="#l4.132"></a><span id="l4.132">   /**</span>
<a href="#l4.133"></a><span id="l4.133">    * Generate a new key pair with GnuPG</span>
<a href="#l4.134"></a><span id="l4.134">    *</span>
<a href="#l4.135"></a><span id="l4.135">    * @name:       String     - name part of UID</span>
<a href="#l4.136"></a><span id="l4.136">    * @comment:    String     - comment part of UID (brackets are added)</span>
<a href="#l4.137"></a><span id="l4.137">    * @comment:    String     - email part of UID (&lt;&gt; will be added)</span>
<a href="#l4.138"></a><span id="l4.138">    * @expiryDate: Number     - Unix timestamp of key expiry date; 0 if no expiry</span>
<a href="#l4.139"></a><span id="l4.139">    * @keyLength:  Number     - size of key in bytes (e.g 4096)</span>
<a href="#l4.140"></a><span id="l4.140" class="difflineat">@@ -674,284 +737,212 @@ var EnigmailKeyRing = {</span>
<a href="#l4.141"></a><span id="l4.141"> </span>
<a href="#l4.142"></a><span id="l4.142">   /**</span>
<a href="#l4.143"></a><span id="l4.143">    * try to find valid key for encryption to passed email address</span>
<a href="#l4.144"></a><span id="l4.144">    *</span>
<a href="#l4.145"></a><span id="l4.145">    * @param details if not null returns error in details.msg</span>
<a href="#l4.146"></a><span id="l4.146">    *</span>
<a href="#l4.147"></a><span id="l4.147">    * @return: found key ID (without leading &quot;0x&quot;) or null</span>
<a href="#l4.148"></a><span id="l4.148">    */</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineminus">-  getValidKeyForRecipient(emailAddr, minTrustLevelIndex, details) {</span>
<a href="#l4.150"></a><span id="l4.150" class="difflineplus">+  async getValidKeyForRecipient(emailAddr, details) {</span>
<a href="#l4.151"></a><span id="l4.151">     EnigmailLog.DEBUG(</span>
<a href="#l4.152"></a><span id="l4.152">       'keyRing.jsm: getValidKeyForRecipient(): emailAddr=&quot;' + emailAddr + '&quot;\n'</span>
<a href="#l4.153"></a><span id="l4.153">     );</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineminus">-    const TRUSTLEVELS_SORTED = EnigmailTrust.trustLevelsSorted();</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineminus">-    const fullTrustIndex = TRUSTLEVELS_SORTED.indexOf(&quot;f&quot;);</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineplus">+    const FULLTRUSTLEVEL = 2;</span>
<a href="#l4.157"></a><span id="l4.157"> </span>
<a href="#l4.158"></a><span id="l4.158">     emailAddr = emailAddr.toLowerCase();</span>
<a href="#l4.159"></a><span id="l4.159" class="difflineminus">-    var embeddedEmailAddr = &quot;&lt;&quot; + emailAddr + &quot;&gt;&quot;;</span>
<a href="#l4.160"></a><span id="l4.160"> </span>
<a href="#l4.161"></a><span id="l4.161" class="difflineminus">-    // note: we can't take just the first matched because we might have faked keys as duplicates</span>
<a href="#l4.162"></a><span id="l4.162">     var foundKeyId = null;</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineminus">-    var foundKeyTrustIndex = null;</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineplus">+    var foundAcceptanceLevel = null;</span>
<a href="#l4.165"></a><span id="l4.165"> </span>
<a href="#l4.166"></a><span id="l4.166" class="difflineminus">-    let k = this.getAllKeys(null, &quot;validity&quot;, -1);</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineplus">+    let k = this.getAllKeys(null, null);</span>
<a href="#l4.168"></a><span id="l4.168">     let keyList = k.keyList;</span>
<a href="#l4.169"></a><span id="l4.169" class="difflineminus">-    let keySortList = k.keySortList;</span>
<a href="#l4.170"></a><span id="l4.170"> </span>
<a href="#l4.171"></a><span id="l4.171" class="difflineminus">-    // **** LOOP to check against each key</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineminus">-    // - note: we have sorted the keys according to validity</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineminus">-    //         to abort the loop as soon as we reach keys that are not valid enough</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineminus">-    for (var idx = 0; idx &lt; keySortList.length; idx++) {</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineminus">-      var keyObj = keyList[keySortList[idx].keyNum];</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineminus">-      var keyTrust = keyObj.keyTrust;</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineminus">-      var keyTrustIndex = TRUSTLEVELS_SORTED.indexOf(keyTrust);</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineminus">-      //EnigmailLog.DEBUG(&quot;keyRing.jsm: getValidKeyForRecipient():  check key &quot; + keyObj.keyId + &quot;\n&quot;);</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineplus">+    for (var idx = 0; idx &lt; keyList.length; idx++) {</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineplus">+      var keyObj = keyList[idx];</span>
<a href="#l4.181"></a><span id="l4.181"> </span>
<a href="#l4.182"></a><span id="l4.182" class="difflineminus">-      // key trust (our sort criterion) too low?</span>
<a href="#l4.183"></a><span id="l4.183" class="difflineminus">-      // =&gt; *** regular END of the loop</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineminus">-      if (keyTrustIndex &lt; minTrustLevelIndex) {</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineminus">-        if (!foundKeyId) {</span>
<a href="#l4.186"></a><span id="l4.186" class="difflineminus">-          if (details) {</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineminus">-            details.msg = &quot;ProblemNoKey&quot;;</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineminus">-          }</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineminus">-          let msg =</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineminus">-            &quot;no key with enough trust level for '&quot; + emailAddr + &quot;' found&quot;;</span>
<a href="#l4.191"></a><span id="l4.191" class="difflineminus">-          EnigmailLog.DEBUG(</span>
<a href="#l4.192"></a><span id="l4.192" class="difflineminus">-            &quot;keyRing.jsm: getValidKeyForRecipient():  &quot; + msg + &quot;\n&quot;</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineminus">-          );</span>
<a href="#l4.194"></a><span id="l4.194" class="difflineminus">-        }</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineminus">-        return foundKeyId; // **** regular END OF LOOP (return NULL or found single key)</span>
<a href="#l4.196"></a><span id="l4.196" class="difflineplus">+      switch (keyObj.keyTrust) {</span>
<a href="#l4.197"></a><span id="l4.197" class="difflineplus">+        case &quot;e&quot;:</span>
<a href="#l4.198"></a><span id="l4.198" class="difflineplus">+        case &quot;r&quot;:</span>
<a href="#l4.199"></a><span id="l4.199" class="difflineplus">+          continue;</span>
<a href="#l4.200"></a><span id="l4.200">       }</span>
<a href="#l4.201"></a><span id="l4.201"> </span>
<a href="#l4.202"></a><span id="l4.202" class="difflineplus">+      let uidMatch = false;</span>
<a href="#l4.203"></a><span id="l4.203" class="difflineplus">+      for (let uid of keyObj.userIds) {</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineplus">+        if (uid.type !== &quot;uid&quot;) {</span>
<a href="#l4.205"></a><span id="l4.205" class="difflineplus">+          continue;</span>
<a href="#l4.206"></a><span id="l4.206" class="difflineplus">+        }</span>
<a href="#l4.207"></a><span id="l4.207" class="difflineplus">+        let split = {};</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineplus">+        if (uidHelper.getPartsFromUidStr(uid.userId, split)) {</span>
<a href="#l4.209"></a><span id="l4.209" class="difflineplus">+          let uidEmail = split.email.toLowerCase();</span>
<a href="#l4.210"></a><span id="l4.210" class="difflineplus">+          if (uidEmail === emailAddr) {</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineplus">+            uidMatch = true;</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineplus">+            break;</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineplus">+          }</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineplus">+        }</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineplus">+      }</span>
<a href="#l4.216"></a><span id="l4.216" class="difflineplus">+      if (!uidMatch) {</span>
<a href="#l4.217"></a><span id="l4.217" class="difflineplus">+        continue;</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineplus">+      }</span>
<a href="#l4.219"></a><span id="l4.219">       // key valid for encryption?</span>
<a href="#l4.220"></a><span id="l4.220">       if (!keyObj.keyUseFor.includes(&quot;E&quot;)) {</span>
<a href="#l4.221"></a><span id="l4.221">         //EnigmailLog.DEBUG(&quot;keyRing.jsm: getValidKeyForRecipient():  skip key &quot; + keyObj.keyId + &quot; (not provided for encryption)\n&quot;);</span>
<a href="#l4.222"></a><span id="l4.222">         continue; // not valid for encryption =&gt; **** CONTINUE the LOOP</span>
<a href="#l4.223"></a><span id="l4.223">       }</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineminus">-      // key disabled?</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineminus">-      if (keyObj.keyUseFor.includes(&quot;D&quot;)) {</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineminus">-        //EnigmailLog.DEBUG(&quot;keyRing.jsm: getValidKeyForRecipient():  skip key &quot; + keyObj.keyId + &quot; (disabled)\n&quot;);</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineminus">-        continue; // disabled =&gt; **** CONTINUE the LOOP</span>
<a href="#l4.228"></a><span id="l4.228" class="difflineplus">+</span>
<a href="#l4.229"></a><span id="l4.229" class="difflineplus">+      let acceptanceLevel;</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineplus">+      if (keyObj.secretAvailable) {</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineplus">+        acceptanceLevel = 3;</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineplus">+      } else {</span>
<a href="#l4.233"></a><span id="l4.233" class="difflineplus">+        acceptanceLevel = await this.getKeyAcceptanceLevelForEmail(</span>
<a href="#l4.234"></a><span id="l4.234" class="difflineplus">+          keyObj,</span>
<a href="#l4.235"></a><span id="l4.235" class="difflineplus">+          emailAddr</span>
<a href="#l4.236"></a><span id="l4.236" class="difflineplus">+        );</span>
<a href="#l4.237"></a><span id="l4.237">       }</span>
<a href="#l4.238"></a><span id="l4.238"> </span>
<a href="#l4.239"></a><span id="l4.239" class="difflineminus">-      // check against the user ID</span>
<a href="#l4.240"></a><span id="l4.240" class="difflineminus">-      var userId = keyObj.userId.toLowerCase();</span>
<a href="#l4.241"></a><span id="l4.241" class="difflineminus">-      if (</span>
<a href="#l4.242"></a><span id="l4.242" class="difflineminus">-        userId &amp;&amp;</span>
<a href="#l4.243"></a><span id="l4.243" class="difflineminus">-        (userId == emailAddr || userId.includes(embeddedEmailAddr))</span>
<a href="#l4.244"></a><span id="l4.244" class="difflineminus">-      ) {</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineminus">-        if (keyTrustIndex &lt; minTrustLevelIndex) {</span>
<a href="#l4.246"></a><span id="l4.246" class="difflineminus">-          EnigmailLog.DEBUG(</span>
<a href="#l4.247"></a><span id="l4.247" class="difflineminus">-            &quot;keyRing.jsm: getValidKeyForRecipient():  matching key=&quot; +</span>
<a href="#l4.248"></a><span id="l4.248" class="difflineminus">-              keyObj.keyId +</span>
<a href="#l4.249"></a><span id="l4.249" class="difflineminus">-              &quot; found but not enough trust\n&quot;</span>
<a href="#l4.250"></a><span id="l4.250" class="difflineminus">-          );</span>
<a href="#l4.251"></a><span id="l4.251" class="difflineminus">-        } else {</span>
<a href="#l4.252"></a><span id="l4.252" class="difflineminus">-          // key with enough trust level found</span>
<a href="#l4.253"></a><span id="l4.253" class="difflineminus">-          EnigmailLog.DEBUG(</span>
<a href="#l4.254"></a><span id="l4.254" class="difflineminus">-            &quot;keyRing.jsm: getValidKeyForRecipient():  key=&quot; +</span>
<a href="#l4.255"></a><span id="l4.255" class="difflineminus">-              keyObj.keyId +</span>
<a href="#l4.256"></a><span id="l4.256" class="difflineminus">-              ' keyTrust=&quot;' +</span>
<a href="#l4.257"></a><span id="l4.257" class="difflineminus">-              keyTrust +</span>
<a href="#l4.258"></a><span id="l4.258" class="difflineminus">-              '&quot; found\n'</span>
<a href="#l4.259"></a><span id="l4.259" class="difflineminus">-          );</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineminus">-</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineminus">-          // immediately return if a fully or ultimately trusted key is found</span>
<a href="#l4.262"></a><span id="l4.262" class="difflineminus">-          // (faked keys should not be an issue here, so we don't have to check other keys)</span>
<a href="#l4.263"></a><span id="l4.263" class="difflineminus">-          if (keyTrustIndex &gt;= fullTrustIndex) {</span>
<a href="#l4.264"></a><span id="l4.264" class="difflineminus">-            return keyObj.keyId;</span>
<a href="#l4.265"></a><span id="l4.265" class="difflineminus">-          }</span>
<a href="#l4.266"></a><span id="l4.266" class="difflineplus">+      if (acceptanceLevel &lt; 1) {</span>
<a href="#l4.267"></a><span id="l4.267" class="difflineplus">+        continue;</span>
<a href="#l4.268"></a><span id="l4.268" class="difflineplus">+      }</span>
<a href="#l4.269"></a><span id="l4.269"> </span>
<a href="#l4.270"></a><span id="l4.270" class="difflineminus">-          if (foundKeyId != keyObj.keyId) {</span>
<a href="#l4.271"></a><span id="l4.271" class="difflineminus">-            // new matching key found (note: might find same key via subkeys)</span>
<a href="#l4.272"></a><span id="l4.272" class="difflineminus">-            if (foundKeyId) {</span>
<a href="#l4.273"></a><span id="l4.273" class="difflineminus">-              // different matching keys found</span>
<a href="#l4.274"></a><span id="l4.274" class="difflineminus">-              if (foundKeyTrustIndex &gt; keyTrustIndex) {</span>
<a href="#l4.275"></a><span id="l4.275" class="difflineminus">-                return foundKeyId; // OK, previously found key has higher trust level</span>
<a href="#l4.276"></a><span id="l4.276" class="difflineminus">-              }</span>
<a href="#l4.277"></a><span id="l4.277" class="difflineminus">-              // error because we have two keys with same trust level</span>
<a href="#l4.278"></a><span id="l4.278" class="difflineminus">-              // =&gt; let the user decide (to prevent from using faked keys with default trust level)</span>
<a href="#l4.279"></a><span id="l4.279" class="difflineminus">-              if (details) {</span>
<a href="#l4.280"></a><span id="l4.280" class="difflineminus">-                details.msg = &quot;ProblemMultipleKeys&quot;;</span>
<a href="#l4.281"></a><span id="l4.281" class="difflineminus">-              }</span>
<a href="#l4.282"></a><span id="l4.282" class="difflineminus">-              let msg =</span>
<a href="#l4.283"></a><span id="l4.283" class="difflineminus">-                &quot;multiple matching keys with same trust level found for '&quot; +</span>
<a href="#l4.284"></a><span id="l4.284" class="difflineminus">-                emailAddr +</span>
<a href="#l4.285"></a><span id="l4.285" class="difflineminus">-                &quot;' &quot;;</span>
<a href="#l4.286"></a><span id="l4.286" class="difflineminus">-              EnigmailLog.DEBUG(</span>
<a href="#l4.287"></a><span id="l4.287" class="difflineminus">-                &quot;keyRing.jsm: getValidKeyForRecipient():  &quot; +</span>
<a href="#l4.288"></a><span id="l4.288" class="difflineminus">-                  msg +</span>
<a href="#l4.289"></a><span id="l4.289" class="difflineminus">-                  ' trustLevel=&quot;' +</span>
<a href="#l4.290"></a><span id="l4.290" class="difflineminus">-                  keyTrust +</span>
<a href="#l4.291"></a><span id="l4.291" class="difflineminus">-                  '&quot; (0x' +</span>
<a href="#l4.292"></a><span id="l4.292" class="difflineminus">-                  foundKeyId +</span>
<a href="#l4.293"></a><span id="l4.293" class="difflineminus">-                  &quot; and 0x&quot; +</span>
<a href="#l4.294"></a><span id="l4.294" class="difflineminus">-                  keyObj.keyId +</span>
<a href="#l4.295"></a><span id="l4.295" class="difflineminus">-                  &quot;)\n&quot;</span>
<a href="#l4.296"></a><span id="l4.296" class="difflineminus">-              );</span>
<a href="#l4.297"></a><span id="l4.297" class="difflineminus">-              return null;</span>
<a href="#l4.298"></a><span id="l4.298" class="difflineminus">-            }</span>
<a href="#l4.299"></a><span id="l4.299" class="difflineminus">-            // save found key to compare with other matching keys (handling of faked keys)</span>
<a href="#l4.300"></a><span id="l4.300" class="difflineminus">-            foundKeyId = keyObj.keyId;</span>
<a href="#l4.301"></a><span id="l4.301" class="difflineminus">-            foundKeyTrustIndex = keyTrustIndex;</span>
<a href="#l4.302"></a><span id="l4.302" class="difflineminus">-          }</span>
<a href="#l4.303"></a><span id="l4.303" class="difflineminus">-          continue; // matching key found (again) =&gt; **** CONTINUE the LOOP (don't check Sub-UserIDs)</span>
<a href="#l4.304"></a><span id="l4.304" class="difflineminus">-        }</span>
<a href="#l4.305"></a><span id="l4.305" class="difflineplus">+      // immediately return if a fully or ultimately trusted key is found</span>
<a href="#l4.306"></a><span id="l4.306" class="difflineplus">+      if (acceptanceLevel &gt;= FULLTRUSTLEVEL) {</span>
<a href="#l4.307"></a><span id="l4.307" class="difflineplus">+        return keyObj.keyId;</span>
<a href="#l4.308"></a><span id="l4.308">       }</span>
<a href="#l4.309"></a><span id="l4.309"> </span>
<a href="#l4.310"></a><span id="l4.310" class="difflineminus">-      // check against the sub user ID</span>
<a href="#l4.311"></a><span id="l4.311" class="difflineminus">-      // (if we are here, the primary user ID didn't match)</span>
<a href="#l4.312"></a><span id="l4.312" class="difflineminus">-      // - Note: sub user IDs have NO owner trust</span>
<a href="#l4.313"></a><span id="l4.313" class="difflineminus">-      for (var subUidIdx = 1; subUidIdx &lt; keyObj.userIds.length; subUidIdx++) {</span>
<a href="#l4.314"></a><span id="l4.314" class="difflineminus">-        var subUidObj = keyObj.userIds[subUidIdx];</span>
<a href="#l4.315"></a><span id="l4.315" class="difflineminus">-        var subUserId = subUidObj.userId.toLowerCase();</span>
<a href="#l4.316"></a><span id="l4.316" class="difflineminus">-        var subUidTrust = subUidObj.keyTrust;</span>
<a href="#l4.317"></a><span id="l4.317" class="difflineminus">-        var subUidTrustIndex = TRUSTLEVELS_SORTED.indexOf(subUidTrust);</span>
<a href="#l4.318"></a><span id="l4.318" class="difflineminus">-        //EnigmailLog.DEBUG(&quot;keyRing.jsm: getValidKeyForRecipient():  check subUid &quot; + subUidObj.keyId + &quot;\n&quot;);</span>
<a href="#l4.319"></a><span id="l4.319" class="difflineminus">-</span>
<a href="#l4.320"></a><span id="l4.320" class="difflineplus">+      if (foundKeyId != keyObj.keyId) {</span>
<a href="#l4.321"></a><span id="l4.321" class="difflineplus">+        // different matching key found</span>
<a href="#l4.322"></a><span id="l4.322">         if (</span>
<a href="#l4.323"></a><span id="l4.323" class="difflineminus">-          subUserId &amp;&amp;</span>
<a href="#l4.324"></a><span id="l4.324" class="difflineminus">-          (subUserId == emailAddr || subUserId.includes(embeddedEmailAddr))</span>
<a href="#l4.325"></a><span id="l4.325" class="difflineplus">+          !foundKeyId ||</span>
<a href="#l4.326"></a><span id="l4.326" class="difflineplus">+          (foundKeyId &amp;&amp; acceptanceLevel &gt; foundAcceptanceLevel)</span>
<a href="#l4.327"></a><span id="l4.327">         ) {</span>
<a href="#l4.328"></a><span id="l4.328" class="difflineminus">-          if (subUidTrustIndex &lt; minTrustLevelIndex) {</span>
<a href="#l4.329"></a><span id="l4.329" class="difflineminus">-            EnigmailLog.DEBUG(</span>
<a href="#l4.330"></a><span id="l4.330" class="difflineminus">-              &quot;keyRing.jsm: getValidKeyForRecipient():  matching subUid=&quot; +</span>
<a href="#l4.331"></a><span id="l4.331" class="difflineminus">-                keyObj.keyId +</span>
<a href="#l4.332"></a><span id="l4.332" class="difflineminus">-                &quot; found but not enough trust\n&quot;</span>
<a href="#l4.333"></a><span id="l4.333" class="difflineminus">-            );</span>
<a href="#l4.334"></a><span id="l4.334" class="difflineminus">-          } else {</span>
<a href="#l4.335"></a><span id="l4.335" class="difflineminus">-            // subkey with enough trust level found</span>
<a href="#l4.336"></a><span id="l4.336" class="difflineminus">-            EnigmailLog.DEBUG(</span>
<a href="#l4.337"></a><span id="l4.337" class="difflineminus">-              &quot;keyRing.jsm: getValidKeyForRecipient():  matching subUid in key=&quot; +</span>
<a href="#l4.338"></a><span id="l4.338" class="difflineminus">-                keyObj.keyId +</span>
<a href="#l4.339"></a><span id="l4.339" class="difflineminus">-                ' keyTrust=&quot;' +</span>
<a href="#l4.340"></a><span id="l4.340" class="difflineminus">-                keyTrust +</span>
<a href="#l4.341"></a><span id="l4.341" class="difflineminus">-                '&quot; found\n'</span>
<a href="#l4.342"></a><span id="l4.342" class="difflineminus">-            );</span>
<a href="#l4.343"></a><span id="l4.343" class="difflineminus">-</span>
<a href="#l4.344"></a><span id="l4.344" class="difflineminus">-            if (keyTrustIndex &gt;= fullTrustIndex) {</span>
<a href="#l4.345"></a><span id="l4.345" class="difflineminus">-              // immediately return if a fully or ultimately trusted key is found</span>
<a href="#l4.346"></a><span id="l4.346" class="difflineminus">-              // (faked keys should not be an issue here, so we don't have to check other keys)</span>
<a href="#l4.347"></a><span id="l4.347" class="difflineminus">-              return keyObj.keyId;</span>
<a href="#l4.348"></a><span id="l4.348" class="difflineminus">-            }</span>
<a href="#l4.349"></a><span id="l4.349" class="difflineminus">-</span>
<a href="#l4.350"></a><span id="l4.350" class="difflineminus">-            if (foundKeyId != keyObj.keyId) {</span>
<a href="#l4.351"></a><span id="l4.351" class="difflineminus">-              // new matching key found (note: might find same key via different subkeys)</span>
<a href="#l4.352"></a><span id="l4.352" class="difflineminus">-              if (foundKeyId) {</span>
<a href="#l4.353"></a><span id="l4.353" class="difflineminus">-                // different matching keys found</span>
<a href="#l4.354"></a><span id="l4.354" class="difflineminus">-                if (foundKeyTrustIndex &gt; subUidTrustIndex) {</span>
<a href="#l4.355"></a><span id="l4.355" class="difflineminus">-                  return foundKeyId; // OK, previously found key has higher trust level</span>
<a href="#l4.356"></a><span id="l4.356" class="difflineminus">-                }</span>
<a href="#l4.357"></a><span id="l4.357" class="difflineminus">-                // error because we have two keys with same trust level</span>
<a href="#l4.358"></a><span id="l4.358" class="difflineminus">-                // =&gt; let the user decide (to prevent from using faked keys with default trust level)</span>
<a href="#l4.359"></a><span id="l4.359" class="difflineminus">-                if (details) {</span>
<a href="#l4.360"></a><span id="l4.360" class="difflineminus">-                  details.msg = &quot;ProblemMultipleKeys&quot;;</span>
<a href="#l4.361"></a><span id="l4.361" class="difflineminus">-                }</span>
<a href="#l4.362"></a><span id="l4.362" class="difflineminus">-                let msg =</span>
<a href="#l4.363"></a><span id="l4.363" class="difflineminus">-                  &quot;multiple matching keys with same trust level found for '&quot; +</span>
<a href="#l4.364"></a><span id="l4.364" class="difflineminus">-                  emailAddr +</span>
<a href="#l4.365"></a><span id="l4.365" class="difflineminus">-                  &quot;' &quot;;</span>
<a href="#l4.366"></a><span id="l4.366" class="difflineminus">-                EnigmailLog.DEBUG(</span>
<a href="#l4.367"></a><span id="l4.367" class="difflineminus">-                  &quot;keyRing.jsm: getValidKeyForRecipient():  &quot; +</span>
<a href="#l4.368"></a><span id="l4.368" class="difflineminus">-                    msg +</span>
<a href="#l4.369"></a><span id="l4.369" class="difflineminus">-                    ' trustLevel=&quot;' +</span>
<a href="#l4.370"></a><span id="l4.370" class="difflineminus">-                    keyTrust +</span>
<a href="#l4.371"></a><span id="l4.371" class="difflineminus">-                    '&quot; (0x' +</span>
<a href="#l4.372"></a><span id="l4.372" class="difflineminus">-                    foundKeyId +</span>
<a href="#l4.373"></a><span id="l4.373" class="difflineminus">-                    &quot; and 0x&quot; +</span>
<a href="#l4.374"></a><span id="l4.374" class="difflineminus">-                    keyObj.keyId +</span>
<a href="#l4.375"></a><span id="l4.375" class="difflineminus">-                    &quot;)\n&quot;</span>
<a href="#l4.376"></a><span id="l4.376" class="difflineminus">-                );</span>
<a href="#l4.377"></a><span id="l4.377" class="difflineminus">-                return null;</span>
<a href="#l4.378"></a><span id="l4.378" class="difflineminus">-              }</span>
<a href="#l4.379"></a><span id="l4.379" class="difflineminus">-              // save found key to compare with other matching keys (handling of faked keys)</span>
<a href="#l4.380"></a><span id="l4.380" class="difflineminus">-              foundKeyId = keyObj.keyId;</span>
<a href="#l4.381"></a><span id="l4.381" class="difflineminus">-              foundKeyTrustIndex = subUidTrustIndex;</span>
<a href="#l4.382"></a><span id="l4.382" class="difflineminus">-            }</span>
<a href="#l4.383"></a><span id="l4.383" class="difflineminus">-          }</span>
<a href="#l4.384"></a><span id="l4.384" class="difflineplus">+          foundKeyId = keyObj.keyId;</span>
<a href="#l4.385"></a><span id="l4.385" class="difflineplus">+          foundAcceptanceLevel = acceptanceLevel;</span>
<a href="#l4.386"></a><span id="l4.386">         }</span>
<a href="#l4.387"></a><span id="l4.387">       }</span>
<a href="#l4.388"></a><span id="l4.388" class="difflineminus">-    } // **** LOOP to check against each key</span>
<a href="#l4.389"></a><span id="l4.389" class="difflineplus">+    }</span>
<a href="#l4.390"></a><span id="l4.390"> </span>
<a href="#l4.391"></a><span id="l4.391">     if (!foundKeyId) {</span>
<a href="#l4.392"></a><span id="l4.392" class="difflineplus">+      if (details) {</span>
<a href="#l4.393"></a><span id="l4.393" class="difflineplus">+        details.msg = &quot;ProblemNoKey&quot;;</span>
<a href="#l4.394"></a><span id="l4.394" class="difflineplus">+      }</span>
<a href="#l4.395"></a><span id="l4.395" class="difflineplus">+      let msg = &quot;no key with enough trust level for '&quot; + emailAddr + &quot;' found&quot;;</span>
<a href="#l4.396"></a><span id="l4.396">       EnigmailLog.DEBUG(</span>
<a href="#l4.397"></a><span id="l4.397" class="difflineminus">-        &quot;keyRing.jsm: getValidKeyForRecipient():  no key for '&quot; +</span>
<a href="#l4.398"></a><span id="l4.398" class="difflineminus">-          emailAddr +</span>
<a href="#l4.399"></a><span id="l4.399" class="difflineminus">-          &quot;' found\n&quot;</span>
<a href="#l4.400"></a><span id="l4.400" class="difflineplus">+        &quot;keyRing.jsm: getValidKeyForRecipient():  &quot; + msg + &quot;\n&quot;</span>
<a href="#l4.401"></a><span id="l4.401" class="difflineplus">+      );</span>
<a href="#l4.402"></a><span id="l4.402" class="difflineplus">+    } else {</span>
<a href="#l4.403"></a><span id="l4.403" class="difflineplus">+      EnigmailLog.DEBUG(</span>
<a href="#l4.404"></a><span id="l4.404" class="difflineplus">+        &quot;keyRing.jsm: getValidKeyForRecipient():  key=&quot; +</span>
<a href="#l4.405"></a><span id="l4.405" class="difflineplus">+          keyObj.keyId +</span>
<a href="#l4.406"></a><span id="l4.406" class="difflineplus">+          '&quot; found\n'</span>
<a href="#l4.407"></a><span id="l4.407">       );</span>
<a href="#l4.408"></a><span id="l4.408">     }</span>
<a href="#l4.409"></a><span id="l4.409">     return foundKeyId;</span>
<a href="#l4.410"></a><span id="l4.410">   },</span>
<a href="#l4.411"></a><span id="l4.411"> </span>
<a href="#l4.412"></a><span id="l4.412" class="difflineplus">+  async getKeyAcceptanceLevelForEmail(keyObj, email) {</span>
<a href="#l4.413"></a><span id="l4.413" class="difflineplus">+    let acceptanceLevel = 0;</span>
<a href="#l4.414"></a><span id="l4.414" class="difflineplus">+</span>
<a href="#l4.415"></a><span id="l4.415" class="difflineplus">+    let acceptanceResult = {};</span>
<a href="#l4.416"></a><span id="l4.416" class="difflineplus">+    try {</span>
<a href="#l4.417"></a><span id="l4.417" class="difflineplus">+      await PgpSqliteDb2.getAcceptance(keyObj.fpr, email, acceptanceResult);</span>
<a href="#l4.418"></a><span id="l4.418" class="difflineplus">+    } catch (ex) {</span>
<a href="#l4.419"></a><span id="l4.419" class="difflineplus">+      console.debug(&quot;getAcceptance failed: &quot; + ex);</span>
<a href="#l4.420"></a><span id="l4.420" class="difflineplus">+      return null;</span>
<a href="#l4.421"></a><span id="l4.421" class="difflineplus">+    }</span>
<a href="#l4.422"></a><span id="l4.422" class="difflineplus">+</span>
<a href="#l4.423"></a><span id="l4.423" class="difflineplus">+    if (acceptanceResult.emailDecided) {</span>
<a href="#l4.424"></a><span id="l4.424" class="difflineplus">+      switch (acceptanceResult.fingerprintAcceptance) {</span>
<a href="#l4.425"></a><span id="l4.425" class="difflineplus">+        case &quot;verified&quot;:</span>
<a href="#l4.426"></a><span id="l4.426" class="difflineplus">+          acceptanceLevel = 2;</span>
<a href="#l4.427"></a><span id="l4.427" class="difflineplus">+          break;</span>
<a href="#l4.428"></a><span id="l4.428" class="difflineplus">+        case &quot;unverified&quot;:</span>
<a href="#l4.429"></a><span id="l4.429" class="difflineplus">+          acceptanceLevel = 1;</span>
<a href="#l4.430"></a><span id="l4.430" class="difflineplus">+          break;</span>
<a href="#l4.431"></a><span id="l4.431" class="difflineplus">+        case &quot;rejected&quot;:</span>
<a href="#l4.432"></a><span id="l4.432" class="difflineplus">+          acceptanceLevel = -1;</span>
<a href="#l4.433"></a><span id="l4.433" class="difflineplus">+          break;</span>
<a href="#l4.434"></a><span id="l4.434" class="difflineplus">+        default:</span>
<a href="#l4.435"></a><span id="l4.435" class="difflineplus">+        case &quot;undecided&quot;:</span>
<a href="#l4.436"></a><span id="l4.436" class="difflineplus">+          acceptanceLevel = 0;</span>
<a href="#l4.437"></a><span id="l4.437" class="difflineplus">+          break;</span>
<a href="#l4.438"></a><span id="l4.438" class="difflineplus">+      }</span>
<a href="#l4.439"></a><span id="l4.439" class="difflineplus">+    }</span>
<a href="#l4.440"></a><span id="l4.440" class="difflineplus">+    return acceptanceLevel;</span>
<a href="#l4.441"></a><span id="l4.441" class="difflineplus">+  },</span>
<a href="#l4.442"></a><span id="l4.442" class="difflineplus">+</span>
<a href="#l4.443"></a><span id="l4.443" class="difflineplus">+  async getKeyAcceptanceForEmail(keyObj, email) {</span>
<a href="#l4.444"></a><span id="l4.444" class="difflineplus">+    let acceptanceResult = {};</span>
<a href="#l4.445"></a><span id="l4.445" class="difflineplus">+    try {</span>
<a href="#l4.446"></a><span id="l4.446" class="difflineplus">+      await PgpSqliteDb2.getAcceptance(keyObj.fpr, email, acceptanceResult);</span>
<a href="#l4.447"></a><span id="l4.447" class="difflineplus">+    } catch (ex) {</span>
<a href="#l4.448"></a><span id="l4.448" class="difflineplus">+      console.debug(&quot;getAcceptance failed: &quot; + ex);</span>
<a href="#l4.449"></a><span id="l4.449" class="difflineplus">+      return null;</span>
<a href="#l4.450"></a><span id="l4.450" class="difflineplus">+    }</span>
<a href="#l4.451"></a><span id="l4.451" class="difflineplus">+</span>
<a href="#l4.452"></a><span id="l4.452" class="difflineplus">+    if (acceptanceResult.emailDecided) {</span>
<a href="#l4.453"></a><span id="l4.453" class="difflineplus">+      switch (acceptanceResult.fingerprintAcceptance) {</span>
<a href="#l4.454"></a><span id="l4.454" class="difflineplus">+        case &quot;verified&quot;:</span>
<a href="#l4.455"></a><span id="l4.455" class="difflineplus">+        case &quot;unverified&quot;:</span>
<a href="#l4.456"></a><span id="l4.456" class="difflineplus">+        case &quot;rejected&quot;:</span>
<a href="#l4.457"></a><span id="l4.457" class="difflineplus">+        case &quot;undecided&quot;:</span>
<a href="#l4.458"></a><span id="l4.458" class="difflineplus">+          return acceptanceResult.fingerprintAcceptance;</span>
<a href="#l4.459"></a><span id="l4.459" class="difflineplus">+      }</span>
<a href="#l4.460"></a><span id="l4.460" class="difflineplus">+    }</span>
<a href="#l4.461"></a><span id="l4.461" class="difflineplus">+</span>
<a href="#l4.462"></a><span id="l4.462" class="difflineplus">+    return &quot;undecided&quot;;</span>
<a href="#l4.463"></a><span id="l4.463" class="difflineplus">+  },</span>
<a href="#l4.464"></a><span id="l4.464" class="difflineplus">+</span>
<a href="#l4.465"></a><span id="l4.465">   /**</span>
<a href="#l4.466"></a><span id="l4.466">    *  Determine the key ID for a set of given addresses</span>
<a href="#l4.467"></a><span id="l4.467">    *</span>
<a href="#l4.468"></a><span id="l4.468">    * @param {Array&lt;String&gt;} addresses: email addresses</span>
<a href="#l4.469"></a><span id="l4.469" class="difflineminus">-   * @param {String} minTrustLevel:    f for Fully trusted keys / ? for any valid key</span>
<a href="#l4.470"></a><span id="l4.470">    * @param {Object} details:          holds details for invalid keys:</span>
<a href="#l4.471"></a><span id="l4.471">    *                                   - errArray: {</span>
<a href="#l4.472"></a><span id="l4.472">    *                                       * addr {String}: email addresses</span>
<a href="#l4.473"></a><span id="l4.473">    *                                       * msg {String}:  related error</span>
<a href="#l4.474"></a><span id="l4.474">    *                                       }</span>
<a href="#l4.475"></a><span id="l4.475">    *                                   - keyMap {Object&lt;String&gt;}: map of email addr -&gt; keyID</span>
<a href="#l4.476"></a><span id="l4.476">    * @param {Array&lt;String&gt;} resultingArray: list of found key IDs</span>
<a href="#l4.477"></a><span id="l4.477">    *</span>
<a href="#l4.478"></a><span id="l4.478">    * @return {Boolean}: true if at least one key missing; false otherwise</span>
<a href="#l4.479"></a><span id="l4.479">    */</span>
<a href="#l4.480"></a><span id="l4.480" class="difflineminus">-  getValidKeysForAllRecipients(</span>
<a href="#l4.481"></a><span id="l4.481" class="difflineminus">-    addresses,</span>
<a href="#l4.482"></a><span id="l4.482" class="difflineminus">-    minTrustLevel,</span>
<a href="#l4.483"></a><span id="l4.483" class="difflineminus">-    details,</span>
<a href="#l4.484"></a><span id="l4.484" class="difflineminus">-    resultingArray</span>
<a href="#l4.485"></a><span id="l4.485" class="difflineminus">-  ) {</span>
<a href="#l4.486"></a><span id="l4.486" class="difflineminus">-    let minTrustLevelIndex = TRUSTLEVELS_SORTED.indexOf(minTrustLevel);</span>
<a href="#l4.487"></a><span id="l4.487" class="difflineminus">-</span>
<a href="#l4.488"></a><span id="l4.488" class="difflineplus">+  async getValidKeysForAllRecipients(addresses, details, resultingArray) {</span>
<a href="#l4.489"></a><span id="l4.489" class="difflineplus">+    if (!addresses) {</span>
<a href="#l4.490"></a><span id="l4.490" class="difflineplus">+      return null;</span>
<a href="#l4.491"></a><span id="l4.491" class="difflineplus">+    }</span>
<a href="#l4.492"></a><span id="l4.492">     // check whether each address is or has a key:</span>
<a href="#l4.493"></a><span id="l4.493">     let keyMissing = false;</span>
<a href="#l4.494"></a><span id="l4.494">     if (details) {</span>
<a href="#l4.495"></a><span id="l4.495">       details.errArray = [];</span>
<a href="#l4.496"></a><span id="l4.496">       details.keyMap = {};</span>
<a href="#l4.497"></a><span id="l4.497">     }</span>
<a href="#l4.498"></a><span id="l4.498">     for (let i = 0; i &lt; addresses.length; i++) {</span>
<a href="#l4.499"></a><span id="l4.499">       let addr = addresses[i];</span>
<a href="#l4.500"></a><span id="l4.500" class="difflineplus">+      if (!addr) {</span>
<a href="#l4.501"></a><span id="l4.501" class="difflineplus">+        continue;</span>
<a href="#l4.502"></a><span id="l4.502" class="difflineplus">+      }</span>
<a href="#l4.503"></a><span id="l4.503">       // try to find current address in key list:</span>
<a href="#l4.504"></a><span id="l4.504">       let keyId = null;</span>
<a href="#l4.505"></a><span id="l4.505">       var errMsg = null;</span>
<a href="#l4.506"></a><span id="l4.506" class="difflineminus">-      if (addr.includes(&quot;@&quot;)) {</span>
<a href="#l4.507"></a><span id="l4.507" class="difflineminus">-        // try email match:</span>
<a href="#l4.508"></a><span id="l4.508" class="difflineminus">-        var addrErrDetails = {};</span>
<a href="#l4.509"></a><span id="l4.509" class="difflineminus">-        let foundKeyId = this.getValidKeyForRecipient(</span>
<a href="#l4.510"></a><span id="l4.510" class="difflineminus">-          addr,</span>
<a href="#l4.511"></a><span id="l4.511" class="difflineminus">-          minTrustLevelIndex,</span>
<a href="#l4.512"></a><span id="l4.512" class="difflineminus">-          addrErrDetails</span>
<a href="#l4.513"></a><span id="l4.513" class="difflineplus">+      if (!addr.includes(&quot;@&quot;)) {</span>
<a href="#l4.514"></a><span id="l4.514" class="difflineplus">+        throw new Error(</span>
<a href="#l4.515"></a><span id="l4.515" class="difflineplus">+          &quot;getValidKeysForAllRecipients unexpected lookup for non-email addr: &quot; +</span>
<a href="#l4.516"></a><span id="l4.516" class="difflineplus">+            addr</span>
<a href="#l4.517"></a><span id="l4.517">         );</span>
<a href="#l4.518"></a><span id="l4.518" class="difflineminus">-        if (details &amp;&amp; addrErrDetails.msg) {</span>
<a href="#l4.519"></a><span id="l4.519" class="difflineminus">-          errMsg = addrErrDetails.msg;</span>
<a href="#l4.520"></a><span id="l4.520" class="difflineminus">-        }</span>
<a href="#l4.521"></a><span id="l4.521" class="difflineminus">-        if (foundKeyId) {</span>
<a href="#l4.522"></a><span id="l4.522" class="difflineminus">-          keyId = &quot;0x&quot; + foundKeyId.toUpperCase();</span>
<a href="#l4.523"></a><span id="l4.523" class="difflineminus">-          resultingArray.push(keyId);</span>
<a href="#l4.524"></a><span id="l4.524" class="difflineminus">-        }</span>
<a href="#l4.525"></a><span id="l4.525" class="difflineminus">-      } else {</span>
<a href="#l4.526"></a><span id="l4.526" class="difflineminus">-        // try key match:</span>
<a href="#l4.527"></a><span id="l4.527" class="difflineminus">-        var keyObj = this.getKeyById(addr);</span>
<a href="#l4.528"></a><span id="l4.528" class="difflineminus">-</span>
<a href="#l4.529"></a><span id="l4.529" class="difflineminus">-        if (keyObj) {</span>
<a href="#l4.530"></a><span id="l4.530" class="difflineminus">-          // if found, check whether the trust level is enough</span>
<a href="#l4.531"></a><span id="l4.531" class="difflineminus">-          if (</span>
<a href="#l4.532"></a><span id="l4.532" class="difflineminus">-            TRUSTLEVELS_SORTED.indexOf(keyObj.keyTrust) &gt;= minTrustLevelIndex</span>
<a href="#l4.533"></a><span id="l4.533" class="difflineminus">-          ) {</span>
<a href="#l4.534"></a><span id="l4.534" class="difflineminus">-            keyId = &quot;0x&quot; + keyObj.keyId.toUpperCase();</span>
<a href="#l4.535"></a><span id="l4.535" class="difflineminus">-            resultingArray.push(keyId);</span>
<a href="#l4.536"></a><span id="l4.536" class="difflineminus">-          }</span>
<a href="#l4.537"></a><span id="l4.537" class="difflineminus">-        }</span>
<a href="#l4.538"></a><span id="l4.538">       }</span>
<a href="#l4.539"></a><span id="l4.539"> </span>
<a href="#l4.540"></a><span id="l4.540" class="difflineminus">-      if (keyId) {</span>
<a href="#l4.541"></a><span id="l4.541" class="difflineplus">+      // try email match:</span>
<a href="#l4.542"></a><span id="l4.542" class="difflineplus">+      var addrErrDetails = {};</span>
<a href="#l4.543"></a><span id="l4.543" class="difflineplus">+      let foundKeyId = await this.getValidKeyForRecipient(addr, addrErrDetails);</span>
<a href="#l4.544"></a><span id="l4.544" class="difflineplus">+      if (details &amp;&amp; addrErrDetails.msg) {</span>
<a href="#l4.545"></a><span id="l4.545" class="difflineplus">+        errMsg = addrErrDetails.msg;</span>
<a href="#l4.546"></a><span id="l4.546" class="difflineplus">+      }</span>
<a href="#l4.547"></a><span id="l4.547" class="difflineplus">+      if (foundKeyId) {</span>
<a href="#l4.548"></a><span id="l4.548" class="difflineplus">+        keyId = &quot;0x&quot; + foundKeyId.toUpperCase();</span>
<a href="#l4.549"></a><span id="l4.549" class="difflineplus">+        resultingArray.push(keyId);</span>
<a href="#l4.550"></a><span id="l4.550">         if (details) {</span>
<a href="#l4.551"></a><span id="l4.551">           details.keyMap[addr.toLowerCase()] = keyId;</span>
<a href="#l4.552"></a><span id="l4.552">         }</span>
<a href="#l4.553"></a><span id="l4.553">       } else {</span>
<a href="#l4.554"></a><span id="l4.554">         // no key for this address found</span>
<a href="#l4.555"></a><span id="l4.555">         keyMissing = true;</span>
<a href="#l4.556"></a><span id="l4.556">         if (details) {</span>
<a href="#l4.557"></a><span id="l4.557">           if (!errMsg) {</span>
<a href="#l4.558"></a><span id="l4.558" class="difflineat">@@ -960,25 +951,115 @@ var EnigmailKeyRing = {</span>
<a href="#l4.559"></a><span id="l4.559">           var detailsElem = {};</span>
<a href="#l4.560"></a><span id="l4.560">           detailsElem.addr = addr;</span>
<a href="#l4.561"></a><span id="l4.561">           detailsElem.msg = errMsg;</span>
<a href="#l4.562"></a><span id="l4.562">           details.errArray.push(detailsElem);</span>
<a href="#l4.563"></a><span id="l4.563">         }</span>
<a href="#l4.564"></a><span id="l4.564">         EnigmailLog.DEBUG(</span>
<a href="#l4.565"></a><span id="l4.565">           'keyRing.jsm: doValidKeysForAllRecipients(): return null (no single valid key found for=&quot;' +</span>
<a href="#l4.566"></a><span id="l4.566">             addr +</span>
<a href="#l4.567"></a><span id="l4.567" class="difflineminus">-            '&quot; with minTrustLevel=&quot;' +</span>
<a href="#l4.568"></a><span id="l4.568" class="difflineminus">-            minTrustLevel +</span>
<a href="#l4.569"></a><span id="l4.569">             '&quot;)\n'</span>
<a href="#l4.570"></a><span id="l4.570">         );</span>
<a href="#l4.571"></a><span id="l4.571">       }</span>
<a href="#l4.572"></a><span id="l4.572">     }</span>
<a href="#l4.573"></a><span id="l4.573">     return keyMissing;</span>
<a href="#l4.574"></a><span id="l4.574">   },</span>
<a href="#l4.575"></a><span id="l4.575"> </span>
<a href="#l4.576"></a><span id="l4.576" class="difflineplus">+  async getMultValidKeysForOneRecipient(emailAddr) {</span>
<a href="#l4.577"></a><span id="l4.577" class="difflineplus">+    EnigmailLog.DEBUG(</span>
<a href="#l4.578"></a><span id="l4.578" class="difflineplus">+      'keyRing.jsm: getMultValidKeysForOneRecipient(): emailAddr=&quot;' +</span>
<a href="#l4.579"></a><span id="l4.579" class="difflineplus">+        emailAddr +</span>
<a href="#l4.580"></a><span id="l4.580" class="difflineplus">+        '&quot;\n'</span>
<a href="#l4.581"></a><span id="l4.581" class="difflineplus">+    );</span>
<a href="#l4.582"></a><span id="l4.582" class="difflineplus">+    emailAddr = emailAddr.toLowerCase();</span>
<a href="#l4.583"></a><span id="l4.583" class="difflineplus">+    if (emailAddr.startsWith(&quot;&lt;&quot;) &amp;&amp; emailAddr.endsWith(&quot;&gt;&quot;)) {</span>
<a href="#l4.584"></a><span id="l4.584" class="difflineplus">+      emailAddr = emailAddr.substr(1, emailAddr.length - 2);</span>
<a href="#l4.585"></a><span id="l4.585" class="difflineplus">+    }</span>
<a href="#l4.586"></a><span id="l4.586" class="difflineplus">+</span>
<a href="#l4.587"></a><span id="l4.587" class="difflineplus">+    let found = [];</span>
<a href="#l4.588"></a><span id="l4.588" class="difflineplus">+</span>
<a href="#l4.589"></a><span id="l4.589" class="difflineplus">+    let k = this.getAllKeys(null, null);</span>
<a href="#l4.590"></a><span id="l4.590" class="difflineplus">+    let keyList = k.keyList;</span>
<a href="#l4.591"></a><span id="l4.591" class="difflineplus">+</span>
<a href="#l4.592"></a><span id="l4.592" class="difflineplus">+    for (var idx = 0; idx &lt; keyList.length; idx++) {</span>
<a href="#l4.593"></a><span id="l4.593" class="difflineplus">+      var keyObj = keyList[idx];</span>
<a href="#l4.594"></a><span id="l4.594" class="difflineplus">+</span>
<a href="#l4.595"></a><span id="l4.595" class="difflineplus">+      switch (keyObj.keyTrust) {</span>
<a href="#l4.596"></a><span id="l4.596" class="difflineplus">+        case &quot;e&quot;:</span>
<a href="#l4.597"></a><span id="l4.597" class="difflineplus">+        case &quot;r&quot;:</span>
<a href="#l4.598"></a><span id="l4.598" class="difflineplus">+          continue;</span>
<a href="#l4.599"></a><span id="l4.599" class="difflineplus">+        default:</span>
<a href="#l4.600"></a><span id="l4.600" class="difflineplus">+          break;</span>
<a href="#l4.601"></a><span id="l4.601" class="difflineplus">+      }</span>
<a href="#l4.602"></a><span id="l4.602" class="difflineplus">+</span>
<a href="#l4.603"></a><span id="l4.603" class="difflineplus">+      let uidMatch = false;</span>
<a href="#l4.604"></a><span id="l4.604" class="difflineplus">+      for (let uid of keyObj.userIds) {</span>
<a href="#l4.605"></a><span id="l4.605" class="difflineplus">+        if (uid.type !== &quot;uid&quot;) {</span>
<a href="#l4.606"></a><span id="l4.606" class="difflineplus">+          continue;</span>
<a href="#l4.607"></a><span id="l4.607" class="difflineplus">+        }</span>
<a href="#l4.608"></a><span id="l4.608" class="difflineplus">+        let split = {};</span>
<a href="#l4.609"></a><span id="l4.609" class="difflineplus">+        if (uidHelper.getPartsFromUidStr(uid.userId, split)) {</span>
<a href="#l4.610"></a><span id="l4.610" class="difflineplus">+          let uidEmail = split.email.toLowerCase();</span>
<a href="#l4.611"></a><span id="l4.611" class="difflineplus">+          if (uidEmail === emailAddr) {</span>
<a href="#l4.612"></a><span id="l4.612" class="difflineplus">+            uidMatch = true;</span>
<a href="#l4.613"></a><span id="l4.613" class="difflineplus">+            break;</span>
<a href="#l4.614"></a><span id="l4.614" class="difflineplus">+          }</span>
<a href="#l4.615"></a><span id="l4.615" class="difflineplus">+        }</span>
<a href="#l4.616"></a><span id="l4.616" class="difflineplus">+      }</span>
<a href="#l4.617"></a><span id="l4.617" class="difflineplus">+      if (!uidMatch) {</span>
<a href="#l4.618"></a><span id="l4.618" class="difflineplus">+        continue;</span>
<a href="#l4.619"></a><span id="l4.619" class="difflineplus">+      }</span>
<a href="#l4.620"></a><span id="l4.620" class="difflineplus">+      // key valid for encryption?</span>
<a href="#l4.621"></a><span id="l4.621" class="difflineplus">+      if (!keyObj.keyUseFor.includes(&quot;E&quot;)) {</span>
<a href="#l4.622"></a><span id="l4.622" class="difflineplus">+        //EnigmailLog.DEBUG(&quot;keyRing.jsm: getValidKeyForRecipient():  skip key &quot; + keyObj.keyId + &quot; (not provided for encryption)\n&quot;);</span>
<a href="#l4.623"></a><span id="l4.623" class="difflineplus">+        continue; // not valid for encryption =&gt; **** CONTINUE the LOOP</span>
<a href="#l4.624"></a><span id="l4.624" class="difflineplus">+      }</span>
<a href="#l4.625"></a><span id="l4.625" class="difflineplus">+      if (!keyObj.secretAvailable) {</span>
<a href="#l4.626"></a><span id="l4.626" class="difflineplus">+        keyObj.acceptance = await this.getKeyAcceptanceForEmail(</span>
<a href="#l4.627"></a><span id="l4.627" class="difflineplus">+          keyObj,</span>
<a href="#l4.628"></a><span id="l4.628" class="difflineplus">+          emailAddr</span>
<a href="#l4.629"></a><span id="l4.629" class="difflineplus">+        );</span>
<a href="#l4.630"></a><span id="l4.630" class="difflineplus">+      }</span>
<a href="#l4.631"></a><span id="l4.631" class="difflineplus">+      found.push(keyObj);</span>
<a href="#l4.632"></a><span id="l4.632" class="difflineplus">+    }</span>
<a href="#l4.633"></a><span id="l4.633" class="difflineplus">+    return found;</span>
<a href="#l4.634"></a><span id="l4.634" class="difflineplus">+  },</span>
<a href="#l4.635"></a><span id="l4.635" class="difflineplus">+</span>
<a href="#l4.636"></a><span id="l4.636" class="difflineplus">+  /**</span>
<a href="#l4.637"></a><span id="l4.637" class="difflineplus">+   *  Determine the key ID for a set of given addresses</span>
<a href="#l4.638"></a><span id="l4.638" class="difflineplus">+   *</span>
<a href="#l4.639"></a><span id="l4.639" class="difflineplus">+   * @param {string[]} addresses - Email addresses to get key id for.</span>
<a href="#l4.640"></a><span id="l4.640" class="difflineplus">+   *</span>
<a href="#l4.641"></a><span id="l4.641" class="difflineplus">+   * @return {Map&lt;string,keyObj[]&gt;}: map of email addr -&gt; keyObj[]</span>
<a href="#l4.642"></a><span id="l4.642" class="difflineplus">+   */</span>
<a href="#l4.643"></a><span id="l4.643" class="difflineplus">+  async getMultValidKeysForMultRecipients(addresses) {</span>
<a href="#l4.644"></a><span id="l4.644" class="difflineplus">+    if (!addresses) {</span>
<a href="#l4.645"></a><span id="l4.645" class="difflineplus">+      return null;</span>
<a href="#l4.646"></a><span id="l4.646" class="difflineplus">+    }</span>
<a href="#l4.647"></a><span id="l4.647" class="difflineplus">+    let allKeysMap = new Map();</span>
<a href="#l4.648"></a><span id="l4.648" class="difflineplus">+    for (let i = 0; i &lt; addresses.length; i++) {</span>
<a href="#l4.649"></a><span id="l4.649" class="difflineplus">+      let addr = addresses[i].toLowerCase();</span>
<a href="#l4.650"></a><span id="l4.650" class="difflineplus">+      if (!addr) {</span>
<a href="#l4.651"></a><span id="l4.651" class="difflineplus">+        continue;</span>
<a href="#l4.652"></a><span id="l4.652" class="difflineplus">+      }</span>
<a href="#l4.653"></a><span id="l4.653" class="difflineplus">+</span>
<a href="#l4.654"></a><span id="l4.654" class="difflineplus">+      if (!addr.includes(&quot;@&quot;)) {</span>
<a href="#l4.655"></a><span id="l4.655" class="difflineplus">+        throw new Error(</span>
<a href="#l4.656"></a><span id="l4.656" class="difflineplus">+          &quot;getAllRecipientKeys unexpected lookup for non-email addr: &quot; + addr</span>
<a href="#l4.657"></a><span id="l4.657" class="difflineplus">+        );</span>
<a href="#l4.658"></a><span id="l4.658" class="difflineplus">+      }</span>
<a href="#l4.659"></a><span id="l4.659" class="difflineplus">+</span>
<a href="#l4.660"></a><span id="l4.660" class="difflineplus">+      let found = await this.getMultValidKeysForOneRecipient(addr);</span>
<a href="#l4.661"></a><span id="l4.661" class="difflineplus">+      if (found) {</span>
<a href="#l4.662"></a><span id="l4.662" class="difflineplus">+        allKeysMap.set(addr, found);</span>
<a href="#l4.663"></a><span id="l4.663" class="difflineplus">+      }</span>
<a href="#l4.664"></a><span id="l4.664" class="difflineplus">+    }</span>
<a href="#l4.665"></a><span id="l4.665" class="difflineplus">+    return allKeysMap;</span>
<a href="#l4.666"></a><span id="l4.666" class="difflineplus">+  },</span>
<a href="#l4.667"></a><span id="l4.667" class="difflineplus">+</span>
<a href="#l4.668"></a><span id="l4.668">   /**</span>
<a href="#l4.669"></a><span id="l4.669">    * Rebuild the quick access search indexes after the key list was loaded</span>
<a href="#l4.670"></a><span id="l4.670">    */</span>
<a href="#l4.671"></a><span id="l4.671">   rebuildKeyIndex() {</span>
<a href="#l4.672"></a><span id="l4.672">     gKeyIndex = [];</span>
<a href="#l4.673"></a><span id="l4.673">     gSubkeyIndex = [];</span>
<a href="#l4.674"></a><span id="l4.674"> </span>
<a href="#l4.675"></a><span id="l4.675">     for (let i in gKeyListObj.keyList) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/keyserver.jsm</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/keyserver.jsm</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -15,19 +15,16 @@ const { EnigmailLog } = ChromeUtils.impo</span>
<a href="#l5.4"></a><span id="l5.4">   &quot;chrome://openpgp/content/modules/log.jsm&quot;</span>
<a href="#l5.5"></a><span id="l5.5"> );</span>
<a href="#l5.6"></a><span id="l5.6"> const { EnigmailLocale } = ChromeUtils.import(</span>
<a href="#l5.7"></a><span id="l5.7">   &quot;chrome://openpgp/content/modules/locale.jsm&quot;</span>
<a href="#l5.8"></a><span id="l5.8"> );</span>
<a href="#l5.9"></a><span id="l5.9"> const { EnigmailKeyRing } = ChromeUtils.import(</span>
<a href="#l5.10"></a><span id="l5.10">   &quot;chrome://openpgp/content/modules/keyRing.jsm&quot;</span>
<a href="#l5.11"></a><span id="l5.11"> );</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-const { EnigmailKeyserverURIs } = ChromeUtils.import(</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-  &quot;chrome://openpgp/content/modules/keyserverUris.jsm&quot;</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-);</span>
<a href="#l5.15"></a><span id="l5.15"> const { EnigmailData } = ChromeUtils.import(</span>
<a href="#l5.16"></a><span id="l5.16">   &quot;chrome://openpgp/content/modules/data.jsm&quot;</span>
<a href="#l5.17"></a><span id="l5.17"> );</span>
<a href="#l5.18"></a><span id="l5.18"> const { EnigmailConstants } = ChromeUtils.import(</span>
<a href="#l5.19"></a><span id="l5.19">   &quot;chrome://openpgp/content/modules/constants.jsm&quot;</span>
<a href="#l5.20"></a><span id="l5.20"> );</span>
<a href="#l5.21"></a><span id="l5.21"> const { EnigmailGpg } = ChromeUtils.import(</span>
<a href="#l5.22"></a><span id="l5.22">   &quot;chrome://openpgp/content/modules/gpg.jsm&quot;</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineat">@@ -239,18 +236,18 @@ const accessHkpInternal = {</span>
<a href="#l5.24"></a><span id="l5.24">    * @param listener:    optional Object implementing the KeySrvListener API (above)</span>
<a href="#l5.25"></a><span id="l5.25">    *</span>
<a href="#l5.26"></a><span id="l5.26">    * @return:   Promise&lt;Number (Status-ID)&gt;</span>
<a href="#l5.27"></a><span id="l5.27">    */</span>
<a href="#l5.28"></a><span id="l5.28">   accessKeyServer(actionFlag, keyserver, keyId, listener) {</span>
<a href="#l5.29"></a><span id="l5.29">     EnigmailLog.DEBUG(</span>
<a href="#l5.30"></a><span id="l5.30">       `keyserver.jsm: accessHkpInternal.accessKeyServer(${keyserver})\n`</span>
<a href="#l5.31"></a><span id="l5.31">     );</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-    if (keyserver === null) {</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-      keyserver = EnigmailKeyserverURIs.getDefaultKeyServer();</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+    if (!keyserver) {</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+      throw new Error(&quot;accessKeyServer requires explicit keyserver parameter&quot;);</span>
<a href="#l5.36"></a><span id="l5.36">     }</span>
<a href="#l5.37"></a><span id="l5.37"> </span>
<a href="#l5.38"></a><span id="l5.38">     return new Promise((resolve, reject) =&gt; {</span>
<a href="#l5.39"></a><span id="l5.39">       let xmlReq = null;</span>
<a href="#l5.40"></a><span id="l5.40">       if (listener &amp;&amp; typeof listener === &quot;object&quot;) {</span>
<a href="#l5.41"></a><span id="l5.41">         listener.onCancel = function() {</span>
<a href="#l5.42"></a><span id="l5.42">           EnigmailLog.DEBUG(</span>
<a href="#l5.43"></a><span id="l5.43">             `keyserver.jsm: accessHkpInternal.accessKeyServer - onCancel() called\n`</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineat">@@ -950,20 +947,16 @@ const accessGnuPG = {</span>
<a href="#l5.45"></a><span id="l5.45">    */</span>
<a href="#l5.46"></a><span id="l5.46">   accessKeyServer(actionFlag, keyserver, keyId, listener) {</span>
<a href="#l5.47"></a><span id="l5.47">     EnigmailLog.DEBUG(</span>
<a href="#l5.48"></a><span id="l5.48">       `keyserver.jsm: accessGnuPG: accessKeyServer(${keyserver})\n`</span>
<a href="#l5.49"></a><span id="l5.49">     );</span>
<a href="#l5.50"></a><span id="l5.50">     throw new Error(&quot;Not implemented&quot;);</span>
<a href="#l5.51"></a><span id="l5.51"> </span>
<a href="#l5.52"></a><span id="l5.52">     /*</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineminus">-    if (keyserver === null) {</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineminus">-      keyserver = EnigmailKeyserverURIs.getDefaultKeyServer();</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineminus">-    }</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineminus">-</span>
<a href="#l5.57"></a><span id="l5.57">     let proxyHost = EnigmailHttpProxy.getHttpProxy();</span>
<a href="#l5.58"></a><span id="l5.58"> </span>
<a href="#l5.59"></a><span id="l5.59">     switch (actionFlag) {</span>
<a href="#l5.60"></a><span id="l5.60">       case EnigmailConstants.SEARCH_KEY:</span>
<a href="#l5.61"></a><span id="l5.61">         break;</span>
<a href="#l5.62"></a><span id="l5.62">       case EnigmailConstants.DOWNLOAD_KEY:</span>
<a href="#l5.63"></a><span id="l5.63">       case EnigmailConstants.DOWNLOAD_KEY_NO_IMPORT:</span>
<a href="#l5.64"></a><span id="l5.64">         break;</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineat">@@ -1216,18 +1209,18 @@ const accessGnuPG = {</span>
<a href="#l5.66"></a><span id="l5.66">       retObj.pubKeys.push(key);</span>
<a href="#l5.67"></a><span id="l5.67">     }</span>
<a href="#l5.68"></a><span id="l5.68"> </span>
<a href="#l5.69"></a><span id="l5.69">     return retObj;</span>
<a href="#l5.70"></a><span id="l5.70">   },</span>
<a href="#l5.71"></a><span id="l5.71"> };</span>
<a href="#l5.72"></a><span id="l5.72"> </span>
<a href="#l5.73"></a><span id="l5.73"> function getAccessType(keyserver) {</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineminus">-  if (keyserver === null) {</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineminus">-    keyserver = EnigmailKeyserverURIs.getDefaultKeyServer();</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+  if (!keyserver) {</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineplus">+    throw new Error(&quot;getAccessType requires explicit keyserver parameter&quot;);</span>
<a href="#l5.78"></a><span id="l5.78">   }</span>
<a href="#l5.79"></a><span id="l5.79"> </span>
<a href="#l5.80"></a><span id="l5.80">   let srv = parseKeyserverUrl(keyserver);</span>
<a href="#l5.81"></a><span id="l5.81">   switch (srv.protocol) {</span>
<a href="#l5.82"></a><span id="l5.82">     case &quot;keybase&quot;:</span>
<a href="#l5.83"></a><span id="l5.83">       return accessKeyBase;</span>
<a href="#l5.84"></a><span id="l5.84">     case &quot;ldap&quot;:</span>
<a href="#l5.85"></a><span id="l5.85">     case &quot;ldaps&quot;:</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/keyserverUris.jsm</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/keyserverUris.jsm</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -62,17 +62,26 @@ function buildUriOptionsFor(keyserver) {</span>
<a href="#l6.4"></a><span id="l6.4">     uris.push(buildUriFor(&quot;hkp&quot;, keyserver));</span>
<a href="#l6.5"></a><span id="l6.5">   }</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7">   return uris;</span>
<a href="#l6.8"></a><span id="l6.8"> }</span>
<a href="#l6.9"></a><span id="l6.9"> </span>
<a href="#l6.10"></a><span id="l6.10"> function getDefaultKeyServer() {</span>
<a href="#l6.11"></a><span id="l6.11">   let keyservers = EnigmailPrefs.getPref(KEYSERVER_PREF).split(/\s*[,;]\s*/g);</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  return keyservers[0];</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+  let defKs = keyservers[0];</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+  // We don't have great code yet to handle multiple results,</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+  // or poisoned results. So avoid SKS.</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+  // Let's start with verifying keyservers, only, which return only</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+  // one result.</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+  if (!defKs.startsWith(&quot;vks://&quot;)) {</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+    console.debug(&quot;Not using &quot; + defKs + &quot; in getDefaultKeyServer&quot;);</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+    return null;</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+  }</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+  return defKs;</span>
<a href="#l6.23"></a><span id="l6.23"> }</span>
<a href="#l6.24"></a><span id="l6.24"> </span>
<a href="#l6.25"></a><span id="l6.25"> function getUserDefinedKeyserverURIs() {</span>
<a href="#l6.26"></a><span id="l6.26">   const keyservers = EnigmailPrefs.getPref(KEYSERVER_PREF).split(/\s*[,;]\s*/g);</span>
<a href="#l6.27"></a><span id="l6.27">   return EnigmailPrefs.getPref(AUTO_KEYSERVER_SELECTION_PREF)</span>
<a href="#l6.28"></a><span id="l6.28">     ? [keyservers[0]]</span>
<a href="#l6.29"></a><span id="l6.29">     : keyservers;</span>
<a href="#l6.30"></a><span id="l6.30"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/sqliteDb.jsm</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/sqliteDb.jsm</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -33,26 +33,26 @@ var PgpSqliteDb2 = {</span>
<a href="#l7.4"></a><span id="l7.4">   },</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6">   async checkDatabaseStructure() {</span>
<a href="#l7.7"></a><span id="l7.7">     EnigmailLog.DEBUG(`sqliteDb.jsm: PgpSqliteDb2 checkDatabaseStructure()\n`);</span>
<a href="#l7.8"></a><span id="l7.8">     let conn;</span>
<a href="#l7.9"></a><span id="l7.9">     try {</span>
<a href="#l7.10"></a><span id="l7.10">       conn = await this.openDatabase();</span>
<a href="#l7.11"></a><span id="l7.11">       await checkAcceptanceTable(conn);</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-      conn.close();</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+      await conn.close();</span>
<a href="#l7.14"></a><span id="l7.14">       EnigmailLog.DEBUG(</span>
<a href="#l7.15"></a><span id="l7.15">         `sqliteDb.jsm: PgpSqliteDb2 checkDatabaseStructure - success\n`</span>
<a href="#l7.16"></a><span id="l7.16">       );</span>
<a href="#l7.17"></a><span id="l7.17">     } catch (ex) {</span>
<a href="#l7.18"></a><span id="l7.18">       EnigmailLog.ERROR(</span>
<a href="#l7.19"></a><span id="l7.19">         `sqliteDb.jsm: PgpSqliteDb2 checkDatabaseStructure: ERROR: ${ex}\n`</span>
<a href="#l7.20"></a><span id="l7.20">       );</span>
<a href="#l7.21"></a><span id="l7.21">       if (conn) {</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-        conn.close();</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+        await conn.close();</span>
<a href="#l7.24"></a><span id="l7.24">       }</span>
<a href="#l7.25"></a><span id="l7.25">     }</span>
<a href="#l7.26"></a><span id="l7.26">   },</span>
<a href="#l7.27"></a><span id="l7.27"> </span>
<a href="#l7.28"></a><span id="l7.28">   async getFingerprintAcceptance(conn, fingerprint, rv) {</span>
<a href="#l7.29"></a><span id="l7.29">     let myConn = false;</span>
<a href="#l7.30"></a><span id="l7.30"> </span>
<a href="#l7.31"></a><span id="l7.31">     try {</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineat">@@ -72,17 +72,17 @@ var PgpSqliteDb2 = {</span>
<a href="#l7.33"></a><span id="l7.33">             rv.fingerprintAcceptance = result[0].getResultByName(&quot;decision&quot;);</span>
<a href="#l7.34"></a><span id="l7.34">           }</span>
<a href="#l7.35"></a><span id="l7.35">         });</span>
<a href="#l7.36"></a><span id="l7.36">     } catch (ex) {</span>
<a href="#l7.37"></a><span id="l7.37">       console.debug(ex);</span>
<a href="#l7.38"></a><span id="l7.38">     }</span>
<a href="#l7.39"></a><span id="l7.39"> </span>
<a href="#l7.40"></a><span id="l7.40">     if (myConn &amp;&amp; conn) {</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineminus">-      conn.close();</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+      await conn.close();</span>
<a href="#l7.43"></a><span id="l7.43">     }</span>
<a href="#l7.44"></a><span id="l7.44">   },</span>
<a href="#l7.45"></a><span id="l7.45"> </span>
<a href="#l7.46"></a><span id="l7.46">   async getAcceptance(fingerprint, email, rv) {</span>
<a href="#l7.47"></a><span id="l7.47">     rv.emailDecided = false;</span>
<a href="#l7.48"></a><span id="l7.48">     rv.fingerprintAcceptance = &quot;&quot;;</span>
<a href="#l7.49"></a><span id="l7.49"> </span>
<a href="#l7.50"></a><span id="l7.50">     let conn;</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineat">@@ -103,70 +103,71 @@ var PgpSqliteDb2 = {</span>
<a href="#l7.52"></a><span id="l7.52">           )</span>
<a href="#l7.53"></a><span id="l7.53">           .then(result =&gt; {</span>
<a href="#l7.54"></a><span id="l7.54">             if (result.length) {</span>
<a href="#l7.55"></a><span id="l7.55">               let count = result[0].getResultByName(&quot;count(*)&quot;);</span>
<a href="#l7.56"></a><span id="l7.56">               rv.emailDecided = count &gt; 0;</span>
<a href="#l7.57"></a><span id="l7.57">             }</span>
<a href="#l7.58"></a><span id="l7.58">           });</span>
<a href="#l7.59"></a><span id="l7.59">       }</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineminus">-      conn.close();</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+      await conn.close();</span>
<a href="#l7.62"></a><span id="l7.62">     } catch (ex) {</span>
<a href="#l7.63"></a><span id="l7.63">       console.debug(ex);</span>
<a href="#l7.64"></a><span id="l7.64">       if (conn) {</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineminus">-        conn.close();</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+        await conn.close();</span>
<a href="#l7.67"></a><span id="l7.67">       }</span>
<a href="#l7.68"></a><span id="l7.68">     }</span>
<a href="#l7.69"></a><span id="l7.69">   },</span>
<a href="#l7.70"></a><span id="l7.70"> </span>
<a href="#l7.71"></a><span id="l7.71">   async updateAcceptance(fingerprint, emailArray, decision) {</span>
<a href="#l7.72"></a><span id="l7.72">     let conn;</span>
<a href="#l7.73"></a><span id="l7.73">     try {</span>
<a href="#l7.74"></a><span id="l7.74">       conn = await this.openDatabase();</span>
<a href="#l7.75"></a><span id="l7.75"> </span>
<a href="#l7.76"></a><span id="l7.76" class="difflineminus">-      await conn.executeTransaction(async function() {</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineminus">-        fingerprint = fingerprint.toLowerCase();</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+      await conn.execute(&quot;begin transaction&quot;);</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+      fingerprint = fingerprint.toLowerCase();</span>
<a href="#l7.81"></a><span id="l7.81"> </span>
<a href="#l7.82"></a><span id="l7.82" class="difflineminus">-        let delObj = { fpr: fingerprint };</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineplus">+      let delObj = { fpr: fingerprint };</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineplus">+      await conn.execute(</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+        &quot;delete from acceptance_decision where fpr = :fpr&quot;,</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+        delObj</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+      );</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+      await conn.execute(</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+        &quot;delete from acceptance_email where fpr = :fpr&quot;,</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+        delObj</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+      );</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+      if (decision !== &quot;undecided&quot;) {</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+        let decisionObj = {</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+          fpr: fingerprint,</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+          decision,</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineplus">+        };</span>
<a href="#l7.98"></a><span id="l7.98">         await conn.execute(</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineminus">-          &quot;delete from acceptance_decision where fpr = :fpr&quot;,</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineminus">-          delObj</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineminus">-        );</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineminus">-        await conn.execute(</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineminus">-          &quot;delete from acceptance_email where fpr = :fpr&quot;,</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineminus">-          delObj</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineplus">+          &quot;insert into acceptance_decision values (:fpr, :decision)&quot;,</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineplus">+          decisionObj</span>
<a href="#l7.107"></a><span id="l7.107">         );</span>
<a href="#l7.108"></a><span id="l7.108"> </span>
<a href="#l7.109"></a><span id="l7.109" class="difflineminus">-        if (decision !== &quot;undecided&quot;) {</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineminus">-          let decisionObj = {</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineminus">-            fpr: fingerprint,</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineminus">-            decision,</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineminus">-          };</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineplus">+        let insertObj = {</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+          fpr: fingerprint,</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineplus">+        };</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineplus">+        for (let email of emailArray) {</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+          insertObj.email = email.toLowerCase();</span>
<a href="#l7.119"></a><span id="l7.119">           await conn.execute(</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineminus">-            &quot;insert into acceptance_decision values (:fpr, :decision)&quot;,</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineminus">-            decisionObj</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineplus">+            &quot;insert into acceptance_email values (:fpr, :email)&quot;,</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+            insertObj</span>
<a href="#l7.124"></a><span id="l7.124">           );</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineminus">-</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineminus">-          let insertObj = {</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineminus">-            fpr: fingerprint,</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineminus">-          };</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineminus">-          for (let email of emailArray) {</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineminus">-            insertObj.email = email.toLowerCase();</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineminus">-            await conn.execute(</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineminus">-              &quot;insert into acceptance_email values (:fpr, :email)&quot;,</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineminus">-              insertObj</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineminus">-            );</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineminus">-          }</span>
<a href="#l7.136"></a><span id="l7.136">         }</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineminus">-      });</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineminus">-      conn.close();</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineplus">+      }</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineplus">+      await conn.execute(&quot;commit transaction&quot;);</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineplus">+      await conn.close();</span>
<a href="#l7.142"></a><span id="l7.142">     } catch (ex) {</span>
<a href="#l7.143"></a><span id="l7.143">       console.debug(ex);</span>
<a href="#l7.144"></a><span id="l7.144">       if (conn) {</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineminus">-        conn.close();</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineplus">+        await conn.close();</span>
<a href="#l7.147"></a><span id="l7.147">       }</span>
<a href="#l7.148"></a><span id="l7.148">     }</span>
<a href="#l7.149"></a><span id="l7.149">   },</span>
<a href="#l7.150"></a><span id="l7.150"> };</span>
<a href="#l7.151"></a><span id="l7.151"> </span>
<a href="#l7.152"></a><span id="l7.152"> var EnigmailSqliteDb = {</span>
<a href="#l7.153"></a><span id="l7.153">   /**</span>
<a href="#l7.154"></a><span id="l7.154">    * Provide an sqlite conection object asynchronously, retrying if needed</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineat">@@ -189,22 +190,22 @@ var EnigmailSqliteDb = {</span>
<a href="#l7.156"></a><span id="l7.156"> </span>
<a href="#l7.157"></a><span id="l7.157">   async checkDatabaseStructure() {</span>
<a href="#l7.158"></a><span id="l7.158">     EnigmailLog.DEBUG(`sqliteDb.jsm: checkDatabaseStructure()\n`);</span>
<a href="#l7.159"></a><span id="l7.159">     let conn;</span>
<a href="#l7.160"></a><span id="l7.160">     try {</span>
<a href="#l7.161"></a><span id="l7.161">       conn = await this.openDatabase();</span>
<a href="#l7.162"></a><span id="l7.162">       //await checkAutocryptTable(conn);</span>
<a href="#l7.163"></a><span id="l7.163">       await checkWkdTable(conn);</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineminus">-      conn.close();</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineplus">+      await conn.close();</span>
<a href="#l7.166"></a><span id="l7.166">       EnigmailLog.DEBUG(`sqliteDb.jsm: checkDatabaseStructure - success\n`);</span>
<a href="#l7.167"></a><span id="l7.167">     } catch (ex) {</span>
<a href="#l7.168"></a><span id="l7.168">       EnigmailLog.ERROR(`sqliteDb.jsm: checkDatabaseStructure: ERROR: ${ex}\n`);</span>
<a href="#l7.169"></a><span id="l7.169">       if (conn) {</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineminus">-        conn.close();</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineplus">+        await conn.close();</span>
<a href="#l7.172"></a><span id="l7.172">       }</span>
<a href="#l7.173"></a><span id="l7.173">     }</span>
<a href="#l7.174"></a><span id="l7.174">   },</span>
<a href="#l7.175"></a><span id="l7.175"> };</span>
<a href="#l7.176"></a><span id="l7.176"> </span>
<a href="#l7.177"></a><span id="l7.177"> /**</span>
<a href="#l7.178"></a><span id="l7.178">  * use a promise to open the Enigmail database.</span>
<a href="#l7.179"></a><span id="l7.179">  *</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/uidHelper.jsm</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/uidHelper.jsm</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -11,39 +11,55 @@ var EXPORTED_SYMBOLS = [&quot;uidHelper&quot;];</span>
<a href="#l8.4"></a><span id="l8.4"> /* Parse a OpenPGP user ID string and split it into its parts.</span>
<a href="#l8.5"></a><span id="l8.5">  * The expected syntax is:</span>
<a href="#l8.6"></a><span id="l8.6">  *    Name (comment) &lt;email&gt;</span>
<a href="#l8.7"></a><span id="l8.7">  * Each part is allowed to be empty.</span>
<a href="#l8.8"></a><span id="l8.8">  */</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10"> var uidHelper = {</span>
<a href="#l8.11"></a><span id="l8.11">   getPartsFromUidStr(uid, resultObj) {</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+    resultObj.name = &quot;&quot;;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+    resultObj.comment = &quot;&quot;;</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+    resultObj.email = &quot;&quot;;</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+    if (!uid) {</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+      return false;</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+    }</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+</span>
<a href="#l8.20"></a><span id="l8.20">     // RegExp strategy:</span>
<a href="#l8.21"></a><span id="l8.21">     // Search until the first ( or &lt; character, use that as Name.</span>
<a href="#l8.22"></a><span id="l8.22">     // Then search for the () characters, allow any characters until ).</span>
<a href="#l8.23"></a><span id="l8.23">     // Do the same for &lt;&gt;.</span>
<a href="#l8.24"></a><span id="l8.24">     // No characters are allowed between a closing ) and opening &lt;.</span>
<a href="#l8.25"></a><span id="l8.25">     // All characters after a trailing &gt; are ignored.</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineminus">-</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineminus">-    if (!uid) {</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineminus">-      return false;</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineminus">-    }</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-</span>
<a href="#l8.31"></a><span id="l8.31">     let result = uid.match(/^ *([^(&lt;]*)? *(\([^)]*\))? *(&lt;[^&gt;]*&gt;)?/);</span>
<a href="#l8.32"></a><span id="l8.32">     if (result.length != 4) {</span>
<a href="#l8.33"></a><span id="l8.33">       return false;</span>
<a href="#l8.34"></a><span id="l8.34">     }</span>
<a href="#l8.35"></a><span id="l8.35"> </span>
<a href="#l8.36"></a><span id="l8.36" class="difflineminus">-    resultObj.name = result[1].trim();</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">-</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">-    resultObj.comment = &quot;&quot;;</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">-    if (result[2]) {</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineminus">-      resultObj.comment = result[2].substring(1, result[2].length - 1).trim();</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+    if (result[1]) {</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+      resultObj.name = result[1].trim();</span>
<a href="#l8.43"></a><span id="l8.43">     }</span>
<a href="#l8.44"></a><span id="l8.44"> </span>
<a href="#l8.45"></a><span id="l8.45" class="difflineminus">-    resultObj.email = &quot;&quot;;</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineminus">-    if (result[3]) {</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineminus">-      resultObj.email = result[3].substring(1, result[3].length - 1).trim();</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+    if (result[1] &amp;&amp; !result[2] &amp;&amp; !result[3]) {</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+      // Does the whole name look roughly like an email address?</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+      // Domain part after @ must not contain space.</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+      // Local part in front of @ must either be quoted (allows space),</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+      // or must not contain space.</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+      // If that condition is true, then conclude it's probably an</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+      // email address that wasn't enclosed in &lt;&gt;.</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+      let looksLikeEmail = resultObj.name.match(/^(&quot;.+&quot;|[^ ]+)@[^ @]+$/);</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+      if (looksLikeEmail) {</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+        resultObj.email = resultObj.name;</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+        resultObj.name = &quot;&quot;;</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+      }</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+    } else {</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+      if (result[2]) {</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+        resultObj.comment = result[2].substring(1, result[2].length - 1).trim();</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+      }</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+      if (result[3]) {</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+        resultObj.email = result[3].substring(1, result[3].length - 1).trim();</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+      }</span>
<a href="#l8.67"></a><span id="l8.67">     }</span>
<a href="#l8.68"></a><span id="l8.68"> </span>
<a href="#l8.69"></a><span id="l8.69">     return true;</span>
<a href="#l8.70"></a><span id="l8.70">   },</span>
<a href="#l8.71"></a><span id="l8.71"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">new file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- /dev/null</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ b/mail/extensions/openpgp/content/strings/composeKeyStatus.dtd</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -0,0 +1,12 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineplus">+&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineplus">+   - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineplus">+   - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineplus">+</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineplus">+&lt;!--LOCALIZATION NOTE composeKeyStatus.dtd UI for viewing security status when composing a message --&gt;</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineplus">+</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineplus">+&lt;!ENTITY composeKeyStatus.introNeedKeys &quot;To send an end-to-end encrypted message, you must obtain and accept a public key for each recipient.&quot;&gt;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+&lt;!ENTITY composeKeyStatus.keysHeading &quot;Availability of OpenPGP keys:&quot;&gt;</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+&lt;!ENTITY composeKeyStatus.title &quot;OpenPGP Message Security&quot;&gt;</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+&lt;!ENTITY composeKeyStatus.recipient &quot;Recipient&quot;&gt;</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+&lt;!ENTITY composeKeyStatus.status &quot;Status&quot;&gt;</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+&lt;!ENTITY composeKeyStatus.openDetails &quot;Manage keys for selected recipient…&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">new file mode 100644</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineminus">--- /dev/null</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineplus">+++ b/mail/extensions/openpgp/content/strings/composeKeyStatus.properties</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineat">@@ -0,0 +1,7 @@</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineplus">+# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineplus">+# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l10.7"></a><span id="l10.7" class="difflineplus">+# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l10.8"></a><span id="l10.8" class="difflineplus">+</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineplus">+RecipGood=ok</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineplus">+RecipMissing=no key available</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineplus">+RecipNoneAccepted=no accepted key</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/extensions/openpgp/content/strings/enigmail.properties</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/strings/enigmail.properties</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -538,16 +538,17 @@ keyUsageEncrypt=Encrypt</span>
<a href="#l11.4"></a><span id="l11.4"> keyUsageSign=Sign</span>
<a href="#l11.5"></a><span id="l11.5"> keyUsageCertify=Certify</span>
<a href="#l11.6"></a><span id="l11.6"> keyUsageAuthentication=Authentication</span>
<a href="#l11.7"></a><span id="l11.7"> keyDoesNotExpire=Key does not expire</span>
<a href="#l11.8"></a><span id="l11.8"> keyExpired=Key expired on %S</span>
<a href="#l11.9"></a><span id="l11.9"> keyRevoked=Key was revoked</span>
<a href="#l11.10"></a><span id="l11.10"> keyAutoAcceptPersonal=You accept this key for all uses, because it is one of your personal keys. (You have the secret key.)</span>
<a href="#l11.11"></a><span id="l11.11"> keyDoYouAccept=Do you accept this key for verifying digital signatures and for encrypting messages?</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+KeyAcceptWarning=Avoid accepting a rogue key. Use a communication channel other than email to verify the fingerprint of your correspondent's key.</span>
<a href="#l11.13"></a><span id="l11.13"> </span>
<a href="#l11.14"></a><span id="l11.14"> # Strings in enigmailGenCardKey.xhtml</span>
<a href="#l11.15"></a><span id="l11.15"> keygen.started=Please wait while the key is being generated ....</span>
<a href="#l11.16"></a><span id="l11.16"> keygen.completed=Key Generated. The new Key ID is: 0x%S</span>
<a href="#l11.17"></a><span id="l11.17"> keygen.keyBackup=The key is backed up as %S</span>
<a href="#l11.18"></a><span id="l11.18"> keygen.passRequired=Please specify a passphrase if you want to create a backup copy of your key outside your SmartCard.</span>
<a href="#l11.19"></a><span id="l11.19"> </span>
<a href="#l11.20"></a><span id="l11.20"> # Strings in enigmailSetCardPin.xhtml</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineat">@@ -712,8 +713,11 @@ mimeDecrypt.encryptedPart.concealedData=</span>
<a href="#l11.22"></a><span id="l11.22"> </span>
<a href="#l11.23"></a><span id="l11.23"> #strings in gnupg-key.jsm</span>
<a href="#l11.24"></a><span id="l11.24"> import.secretKeyImportError=An error has occurred in GnuPG while importing secret keys. The import was not successful.</span>
<a href="#l11.25"></a><span id="l11.25"> </span>
<a href="#l11.26"></a><span id="l11.26"> #strings in importSettings.js</span>
<a href="#l11.27"></a><span id="l11.27"> importSettings.errorNoFile=The file you specified is not a regular file!</span>
<a href="#l11.28"></a><span id="l11.28"> importSettings.cancelWhileInProgress=Restoring is in progress. Do you really want to abort the process?</span>
<a href="#l11.29"></a><span id="l11.29"> importSettings.button.abortImport=&amp;Abort process</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+cannotUseOwnKeyBecause=Unable to send the message, because there is a problem with your personal key. %S</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+cannotEncryptBecauseMissing=Unable to send this message with end-to-end encryption, because there are problems with the keys of the following recipients: %S</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">new file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- /dev/null</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ b/mail/extensions/openpgp/content/strings/oneRecipientStatus.dtd</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -0,0 +1,18 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineplus">+&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineplus">+   - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineplus">+   - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineplus">+</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineplus">+&lt;!--LOCALIZATION NOTE oneRecipientStatus.dtd UI for viewing security status when composing a message --&gt;</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineplus">+</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineplus">+&lt;!ENTITY oneRecipientStatus.keysHeading &quot;Available OpenPGP keys:&quot;&gt;</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+&lt;!ENTITY oneRecipientStatus.title &quot;OpenPGP Message Security&quot;&gt;</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+&lt;!ENTITY oneRecipientStatus.status &quot;Status&quot;&gt;</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+&lt;!ENTITY oneRecipientStatus.keyId &quot;Key ID&quot;&gt;</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+&lt;!ENTITY oneRecipientStatus.createdDate &quot;Created&quot;&gt;</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+&lt;!ENTITY oneRecipientStatus.expiresDate &quot;Expires&quot;&gt;</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+&lt;!ENTITY oneRecipientStatus.openDetails &quot;Open details and edit acceptance…&quot;&gt;</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+&lt;!ENTITY oneRecipientStatus.discover &quot;Discover new or updated key&quot;&gt;</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+&lt;!ENTITY oneRecipientStatus.instruction1 &quot;To send an end-to-end encrypted message to a recipient, you need to obtain their OpenPGP public key and mark it as accepted.&quot;&gt;</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineplus">+&lt;!ENTITY oneRecipientStatus.instruction2 &quot;To obtain their public key, import them from email they have sent to you and that includes it. Alternatively, you can try to discover their public key on a directory.&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">new file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- /dev/null</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ b/mail/extensions/openpgp/content/strings/oneRecipientStatus.properties</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -0,0 +1,11 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineplus">+# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineplus">+# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineplus">+# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineplus">+</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineplus">+KeyOwn=accepted (personal key)</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineplus">+KeyVerified=accepted (verified)</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineplus">+KeyUnverified=accepted (unverifed)</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+KeyUndecided=not accepted (undecided)</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+KeyRejected=not accepted (rejected)</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+Intro=Available public keys for %S:</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">copy from mailnews/extensions/smime/content/msgCompSecurityInfo.js</span>
<a href="#l14.2"></a><span id="l14.2">copy to mail/extensions/openpgp/content/ui/composeKeyStatus.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineminus">--- a/mailnews/extensions/smime/content/msgCompSecurityInfo.js</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/composeKeyStatus.js</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineat">@@ -1,302 +1,160 @@</span>
<a href="#l14.6"></a><span id="l14.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l14.7"></a><span id="l14.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l14.8"></a><span id="l14.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l14.9"></a><span id="l14.9"> </span>
<a href="#l14.10"></a><span id="l14.10"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l14.11"></a><span id="l14.11" class="difflineplus">+var { EnigmailFuncs } = ChromeUtils.import(</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+  &quot;chrome://openpgp/content/modules/funcs.jsm&quot;</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+);</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+var EnigmailKeyRing = ChromeUtils.import(</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+  &quot;chrome://openpgp/content/modules/keyRing.jsm&quot;</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+).EnigmailKeyRing;</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+var { EnigmailWindows } = ChromeUtils.import(</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineplus">+  &quot;chrome://openpgp/content/modules/windows.jsm&quot;</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineplus">+);</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineplus">+var { EnigmailKey } = ChromeUtils.import(</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineplus">+  &quot;chrome://openpgp/content/modules/key.jsm&quot;</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineplus">+);</span>
<a href="#l14.23"></a><span id="l14.23"> </span>
<a href="#l14.24"></a><span id="l14.24"> var gListBox;</span>
<a href="#l14.25"></a><span id="l14.25"> var gViewButton;</span>
<a href="#l14.26"></a><span id="l14.26"> var gBundle;</span>
<a href="#l14.27"></a><span id="l14.27"> </span>
<a href="#l14.28"></a><span id="l14.28" class="difflineminus">-var gCerts;</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+var gEmailAddresses = [];</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+var gRowToEmail = [];</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+var gMapAddressToKeyObjs = null;</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+function addRecipients(toAddrList, recList) {</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+  for (var i = 0; i &lt; recList.length; i++) {</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+    try {</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+      let entry = EnigmailFuncs.stripEmail(recList[i].replace(/[&quot;,]/g, &quot;&quot;));</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+      toAddrList.push(entry);</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+    } catch (ex) {</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+      console.debug(ex);</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+    }</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+  }</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+}</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineplus">+</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+async function setListEntries() {</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+  gMapAddressToKeyObjs = await EnigmailKeyRing.getMultValidKeysForMultRecipients(</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineplus">+    gEmailAddresses</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineplus">+  );</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+  if (!gMapAddressToKeyObjs) {</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+    throw new Error(&quot;getMultValidKeysForMultRecipients failed&quot;);</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+  }</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+  for (let addr of gEmailAddresses) {</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+    let emailStatus = null;</span>
<a href="#l14.54"></a><span id="l14.54"> </span>
<a href="#l14.55"></a><span id="l14.55" class="difflineminus">-function onLoad() {</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineplus">+    let foundKeys = gMapAddressToKeyObjs.get(addr);</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineplus">+    if (!foundKeys || !foundKeys.length) {</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineplus">+      emailStatus = &quot;RecipMissing&quot;;</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+    } else {</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineplus">+      for (let keyObj of foundKeys) {</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineplus">+        if (</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineplus">+          keyObj.secretAvailable ||</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineplus">+          keyObj.acceptance == &quot;verified&quot; ||</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineplus">+          keyObj.acceptance == &quot;unverified&quot;</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+        ) {</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+          emailStatus = &quot;RecipGood&quot;;</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineplus">+          break;</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineplus">+        }</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+      }</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+      if (!emailStatus) {</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+        emailStatus = &quot;RecipNoneAccepted&quot;;</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineplus">+      }</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineplus">+    }</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineplus">+</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineplus">+    let listitem = document.createXULElement(&quot;richlistitem&quot;);</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineplus">+</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineplus">+    let emailItem = document.createXULElement(&quot;label&quot;);</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineplus">+    emailItem.setAttribute(&quot;value&quot;, addr);</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineplus">+    emailItem.setAttribute(&quot;crop&quot;, &quot;end&quot;);</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineplus">+    emailItem.setAttribute(&quot;style&quot;, &quot;width: var(--recipientWidth)&quot;);</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineplus">+    listitem.appendChild(emailItem);</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineplus">+</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineplus">+    let status = document.createXULElement(&quot;label&quot;);</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineplus">+    status.setAttribute(&quot;value&quot;, gBundle.getString(emailStatus));</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineplus">+    status.setAttribute(&quot;crop&quot;, &quot;end&quot;);</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineplus">+    status.setAttribute(&quot;style&quot;, &quot;width: var(--statusWidth)&quot;);</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineplus">+    listitem.appendChild(status);</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineplus">+</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineplus">+    gListBox.appendChild(listitem);</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineplus">+</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineplus">+    gRowToEmail.push(addr);</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineplus">+  }</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineplus">+}</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineplus">+</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineplus">+async function onLoad() {</span>
<a href="#l14.96"></a><span id="l14.96">   let params = window.arguments[0];</span>
<a href="#l14.97"></a><span id="l14.97">   if (!params) {</span>
<a href="#l14.98"></a><span id="l14.98">     return;</span>
<a href="#l14.99"></a><span id="l14.99">   }</span>
<a href="#l14.100"></a><span id="l14.100"> </span>
<a href="#l14.101"></a><span id="l14.101" class="difflineminus">-  let helper = Cc[</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineminus">-    &quot;@mozilla.org/messenger-smime/smimejshelper;1&quot;</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineminus">-  ].createInstance(Ci.nsISMimeJSHelper);</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineminus">-</span>
<a href="#l14.105"></a><span id="l14.105">   gListBox = document.getElementById(&quot;infolist&quot;);</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineminus">-  gViewButton = document.getElementById(&quot;viewCertButton&quot;);</span>
<a href="#l14.107"></a><span id="l14.107" class="difflineminus">-  gBundle = document.getElementById(&quot;bundle_smime_comp_info&quot;);</span>
<a href="#l14.108"></a><span id="l14.108" class="difflineminus">-</span>
<a href="#l14.109"></a><span id="l14.109" class="difflineminus">-  let allow_ldap_cert_fetching = params.smFields.requireEncryptMessage;</span>
<a href="#l14.110"></a><span id="l14.110" class="difflineminus">-</span>
<a href="#l14.111"></a><span id="l14.111" class="difflineminus">-  let emailAddresses = [];</span>
<a href="#l14.112"></a><span id="l14.112" class="difflineminus">-  let certIssuedInfos = [];</span>
<a href="#l14.113"></a><span id="l14.113" class="difflineminus">-  let certExpiresInfos = [];</span>
<a href="#l14.114"></a><span id="l14.114" class="difflineminus">-  let certs = [];</span>
<a href="#l14.115"></a><span id="l14.115" class="difflineminus">-  let canEncrypt = false;</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineplus">+  gViewButton = document.getElementById(&quot;detailsButton&quot;);</span>
<a href="#l14.117"></a><span id="l14.117" class="difflineplus">+  gBundle = document.getElementById(&quot;bundle_openpgp_comp_info&quot;);</span>
<a href="#l14.118"></a><span id="l14.118"> </span>
<a href="#l14.119"></a><span id="l14.119" class="difflineminus">-  while (true) {</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineminus">-    try {</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineminus">-      // Out parameters - must be objects.</span>
<a href="#l14.122"></a><span id="l14.122" class="difflineminus">-      let outEmailAddresses = {};</span>
<a href="#l14.123"></a><span id="l14.123" class="difflineminus">-      let outCertIssuedInfos = {};</span>
<a href="#l14.124"></a><span id="l14.124" class="difflineminus">-      let outCertExpiresInfos = {};</span>
<a href="#l14.125"></a><span id="l14.125" class="difflineminus">-      let outCerts = {};</span>
<a href="#l14.126"></a><span id="l14.126" class="difflineminus">-      let outCanEncrypt = {};</span>
<a href="#l14.127"></a><span id="l14.127" class="difflineminus">-      helper.getRecipientCertsInfo(</span>
<a href="#l14.128"></a><span id="l14.128" class="difflineminus">-        params.compFields,</span>
<a href="#l14.129"></a><span id="l14.129" class="difflineminus">-        outEmailAddresses,</span>
<a href="#l14.130"></a><span id="l14.130" class="difflineminus">-        outCertIssuedInfos,</span>
<a href="#l14.131"></a><span id="l14.131" class="difflineminus">-        outCertExpiresInfos,</span>
<a href="#l14.132"></a><span id="l14.132" class="difflineminus">-        outCerts,</span>
<a href="#l14.133"></a><span id="l14.133" class="difflineminus">-        outCanEncrypt</span>
<a href="#l14.134"></a><span id="l14.134" class="difflineminus">-      );</span>
<a href="#l14.135"></a><span id="l14.135" class="difflineminus">-      // Unwrap to the actual values.</span>
<a href="#l14.136"></a><span id="l14.136" class="difflineminus">-      emailAddresses = outEmailAddresses.value;</span>
<a href="#l14.137"></a><span id="l14.137" class="difflineminus">-      certIssuedInfos = outCertIssuedInfos.value;</span>
<a href="#l14.138"></a><span id="l14.138" class="difflineminus">-      certExpiresInfos = outCertExpiresInfos.value;</span>
<a href="#l14.139"></a><span id="l14.139" class="difflineminus">-      gCerts = certs = outCerts.value;</span>
<a href="#l14.140"></a><span id="l14.140" class="difflineminus">-      canEncrypt = outCanEncrypt.value;</span>
<a href="#l14.141"></a><span id="l14.141" class="difflineminus">-    } catch (e) {</span>
<a href="#l14.142"></a><span id="l14.142" class="difflineminus">-      dump(e);</span>
<a href="#l14.143"></a><span id="l14.143" class="difflineminus">-      return;</span>
<a href="#l14.144"></a><span id="l14.144" class="difflineminus">-    }</span>
<a href="#l14.145"></a><span id="l14.145" class="difflineminus">-</span>
<a href="#l14.146"></a><span id="l14.146" class="difflineminus">-    if (!allow_ldap_cert_fetching) {</span>
<a href="#l14.147"></a><span id="l14.147" class="difflineminus">-      break;</span>
<a href="#l14.148"></a><span id="l14.148" class="difflineminus">-    }</span>
<a href="#l14.149"></a><span id="l14.149" class="difflineminus">-    allow_ldap_cert_fetching = false;</span>
<a href="#l14.150"></a><span id="l14.150" class="difflineplus">+  var arrLen = {};</span>
<a href="#l14.151"></a><span id="l14.151" class="difflineplus">+  var recList;</span>
<a href="#l14.152"></a><span id="l14.152"> </span>
<a href="#l14.153"></a><span id="l14.153" class="difflineminus">-    let missing = [];</span>
<a href="#l14.154"></a><span id="l14.154" class="difflineminus">-    for (let i = 0; i &lt; emailAddresses.length; i++) {</span>
<a href="#l14.155"></a><span id="l14.155" class="difflineminus">-      if (!certs[i]) {</span>
<a href="#l14.156"></a><span id="l14.156" class="difflineminus">-        missing.push(emailAddresses[i]);</span>
<a href="#l14.157"></a><span id="l14.157" class="difflineminus">-      }</span>
<a href="#l14.158"></a><span id="l14.158" class="difflineminus">-    }</span>
<a href="#l14.159"></a><span id="l14.159" class="difflineminus">-</span>
<a href="#l14.160"></a><span id="l14.160" class="difflineminus">-    if (missing.length &gt; 0) {</span>
<a href="#l14.161"></a><span id="l14.161" class="difflineminus">-      var autocompleteLdap = Services.prefs.getBoolPref(</span>
<a href="#l14.162"></a><span id="l14.162" class="difflineminus">-        &quot;ldap_2.autoComplete.useDirectory&quot;</span>
<a href="#l14.163"></a><span id="l14.163" class="difflineminus">-      );</span>
<a href="#l14.164"></a><span id="l14.164" class="difflineminus">-</span>
<a href="#l14.165"></a><span id="l14.165" class="difflineminus">-      if (autocompleteLdap) {</span>
<a href="#l14.166"></a><span id="l14.166" class="difflineminus">-        var autocompleteDirectory = null;</span>
<a href="#l14.167"></a><span id="l14.167" class="difflineminus">-        if (params.currentIdentity.overrideGlobalPref) {</span>
<a href="#l14.168"></a><span id="l14.168" class="difflineminus">-          autocompleteDirectory = params.currentIdentity.directoryServer;</span>
<a href="#l14.169"></a><span id="l14.169" class="difflineminus">-        } else {</span>
<a href="#l14.170"></a><span id="l14.170" class="difflineminus">-          autocompleteDirectory = Services.prefs.getCharPref(</span>
<a href="#l14.171"></a><span id="l14.171" class="difflineminus">-            &quot;ldap_2.autoComplete.directoryServer&quot;</span>
<a href="#l14.172"></a><span id="l14.172" class="difflineminus">-          );</span>
<a href="#l14.173"></a><span id="l14.173" class="difflineminus">-        }</span>
<a href="#l14.174"></a><span id="l14.174" class="difflineminus">-</span>
<a href="#l14.175"></a><span id="l14.175" class="difflineminus">-        if (autocompleteDirectory) {</span>
<a href="#l14.176"></a><span id="l14.176" class="difflineminus">-          window.openDialog(</span>
<a href="#l14.177"></a><span id="l14.177" class="difflineminus">-            &quot;chrome://messenger-smime/content/certFetchingStatus.xhtml&quot;,</span>
<a href="#l14.178"></a><span id="l14.178" class="difflineminus">-            &quot;&quot;,</span>
<a href="#l14.179"></a><span id="l14.179" class="difflineminus">-            &quot;chrome,resizable=1,modal=1,dialog=1&quot;,</span>
<a href="#l14.180"></a><span id="l14.180" class="difflineminus">-            autocompleteDirectory,</span>
<a href="#l14.181"></a><span id="l14.181" class="difflineminus">-            missing</span>
<a href="#l14.182"></a><span id="l14.182" class="difflineminus">-          );</span>
<a href="#l14.183"></a><span id="l14.183" class="difflineminus">-        }</span>
<a href="#l14.184"></a><span id="l14.184" class="difflineminus">-      }</span>
<a href="#l14.185"></a><span id="l14.185" class="difflineminus">-    }</span>
<a href="#l14.186"></a><span id="l14.186" class="difflineplus">+  if (params.compFields.to) {</span>
<a href="#l14.187"></a><span id="l14.187" class="difflineplus">+    recList = params.compFields.splitRecipients(</span>
<a href="#l14.188"></a><span id="l14.188" class="difflineplus">+      params.compFields.to,</span>
<a href="#l14.189"></a><span id="l14.189" class="difflineplus">+      true,</span>
<a href="#l14.190"></a><span id="l14.190" class="difflineplus">+      arrLen</span>
<a href="#l14.191"></a><span id="l14.191" class="difflineplus">+    );</span>
<a href="#l14.192"></a><span id="l14.192" class="difflineplus">+    addRecipients(gEmailAddresses, recList);</span>
<a href="#l14.193"></a><span id="l14.193">   }</span>
<a href="#l14.194"></a><span id="l14.194" class="difflineminus">-</span>
<a href="#l14.195"></a><span id="l14.195" class="difflineminus">-  let signedElement = document.getElementById(&quot;signed&quot;);</span>
<a href="#l14.196"></a><span id="l14.196" class="difflineminus">-  let encryptedElement = document.getElementById(&quot;encrypted&quot;);</span>
<a href="#l14.197"></a><span id="l14.197" class="difflineminus">-  if (params.smFields.requireEncryptMessage) {</span>
<a href="#l14.198"></a><span id="l14.198" class="difflineminus">-    if (params.isEncryptionCertAvailable &amp;&amp; canEncrypt) {</span>
<a href="#l14.199"></a><span id="l14.199" class="difflineminus">-      encryptedElement.value = gBundle.getString(&quot;StatusYes&quot;);</span>
<a href="#l14.200"></a><span id="l14.200" class="difflineminus">-    } else {</span>
<a href="#l14.201"></a><span id="l14.201" class="difflineminus">-      encryptedElement.value = gBundle.getString(&quot;StatusNotPossible&quot;);</span>
<a href="#l14.202"></a><span id="l14.202" class="difflineminus">-    }</span>
<a href="#l14.203"></a><span id="l14.203" class="difflineminus">-  } else {</span>
<a href="#l14.204"></a><span id="l14.204" class="difflineminus">-    encryptedElement.value = gBundle.getString(&quot;StatusNo&quot;);</span>
<a href="#l14.205"></a><span id="l14.205" class="difflineplus">+  if (params.compFields.cc) {</span>
<a href="#l14.206"></a><span id="l14.206" class="difflineplus">+    recList = params.compFields.splitRecipients(</span>
<a href="#l14.207"></a><span id="l14.207" class="difflineplus">+      params.compFields.cc,</span>
<a href="#l14.208"></a><span id="l14.208" class="difflineplus">+      true,</span>
<a href="#l14.209"></a><span id="l14.209" class="difflineplus">+      arrLen</span>
<a href="#l14.210"></a><span id="l14.210" class="difflineplus">+    );</span>
<a href="#l14.211"></a><span id="l14.211" class="difflineplus">+    addRecipients(gEmailAddresses, recList);</span>
<a href="#l14.212"></a><span id="l14.212">   }</span>
<a href="#l14.213"></a><span id="l14.213" class="difflineminus">-</span>
<a href="#l14.214"></a><span id="l14.214" class="difflineminus">-  if (params.smFields.signMessage) {</span>
<a href="#l14.215"></a><span id="l14.215" class="difflineminus">-    if (params.isSigningCertAvailable) {</span>
<a href="#l14.216"></a><span id="l14.216" class="difflineminus">-      signedElement.value = gBundle.getString(&quot;StatusYes&quot;);</span>
<a href="#l14.217"></a><span id="l14.217" class="difflineminus">-    } else {</span>
<a href="#l14.218"></a><span id="l14.218" class="difflineminus">-      signedElement.value = gBundle.getString(&quot;StatusNotPossible&quot;);</span>
<a href="#l14.219"></a><span id="l14.219" class="difflineminus">-    }</span>
<a href="#l14.220"></a><span id="l14.220" class="difflineminus">-  } else {</span>
<a href="#l14.221"></a><span id="l14.221" class="difflineminus">-    signedElement.value = gBundle.getString(&quot;StatusNo&quot;);</span>
<a href="#l14.222"></a><span id="l14.222" class="difflineplus">+  if (params.compFields.bcc) {</span>
<a href="#l14.223"></a><span id="l14.223" class="difflineplus">+    recList = params.compFields.splitRecipients(</span>
<a href="#l14.224"></a><span id="l14.224" class="difflineplus">+      params.compFields.bcc,</span>
<a href="#l14.225"></a><span id="l14.225" class="difflineplus">+      true,</span>
<a href="#l14.226"></a><span id="l14.226" class="difflineplus">+      arrLen</span>
<a href="#l14.227"></a><span id="l14.227" class="difflineplus">+    );</span>
<a href="#l14.228"></a><span id="l14.228" class="difflineplus">+    addRecipients(gEmailAddresses, recList);</span>
<a href="#l14.229"></a><span id="l14.229">   }</span>
<a href="#l14.230"></a><span id="l14.230"> </span>
<a href="#l14.231"></a><span id="l14.231" class="difflineminus">-  for (let i = 0; i &lt; emailAddresses.length; ++i) {</span>
<a href="#l14.232"></a><span id="l14.232" class="difflineminus">-    let email = document.createXULElement(&quot;label&quot;);</span>
<a href="#l14.233"></a><span id="l14.233" class="difflineminus">-    email.setAttribute(&quot;value&quot;, emailAddresses[i]);</span>
<a href="#l14.234"></a><span id="l14.234" class="difflineminus">-    email.setAttribute(&quot;crop&quot;, &quot;end&quot;);</span>
<a href="#l14.235"></a><span id="l14.235" class="difflineminus">-    email.setAttribute(&quot;style&quot;, &quot;width: var(--recipientWidth)&quot;);</span>
<a href="#l14.236"></a><span id="l14.236" class="difflineminus">-</span>
<a href="#l14.237"></a><span id="l14.237" class="difflineminus">-    let listitem = document.createXULElement(&quot;richlistitem&quot;);</span>
<a href="#l14.238"></a><span id="l14.238" class="difflineminus">-    listitem.appendChild(email);</span>
<a href="#l14.239"></a><span id="l14.239" class="difflineminus">-</span>
<a href="#l14.240"></a><span id="l14.240" class="difflineminus">-    if (!certs[i]) {</span>
<a href="#l14.241"></a><span id="l14.241" class="difflineminus">-      let notFound = document.createXULElement(&quot;label&quot;);</span>
<a href="#l14.242"></a><span id="l14.242" class="difflineminus">-      notFound.setAttribute(&quot;value&quot;, gBundle.getString(&quot;StatusNotFound&quot;));</span>
<a href="#l14.243"></a><span id="l14.243" class="difflineminus">-      notFound.setAttribute(&quot;style&quot;, &quot;width: var(--statusWidth)&quot;);</span>
<a href="#l14.244"></a><span id="l14.244" class="difflineminus">-      listitem.appendChild(notFound);</span>
<a href="#l14.245"></a><span id="l14.245" class="difflineminus">-    } else {</span>
<a href="#l14.246"></a><span id="l14.246" class="difflineminus">-      let status = document.createXULElement(&quot;label&quot;);</span>
<a href="#l14.247"></a><span id="l14.247" class="difflineminus">-      status.setAttribute(&quot;value&quot;, &quot;?&quot;); // temporary placeholder</span>
<a href="#l14.248"></a><span id="l14.248" class="difflineminus">-      status.setAttribute(&quot;crop&quot;, &quot;end&quot;);</span>
<a href="#l14.249"></a><span id="l14.249" class="difflineminus">-      status.setAttribute(&quot;style&quot;, &quot;width: var(--statusWidth)&quot;);</span>
<a href="#l14.250"></a><span id="l14.250" class="difflineminus">-      listitem.appendChild(status);</span>
<a href="#l14.251"></a><span id="l14.251" class="difflineminus">-</span>
<a href="#l14.252"></a><span id="l14.252" class="difflineminus">-      let issued = document.createXULElement(&quot;label&quot;);</span>
<a href="#l14.253"></a><span id="l14.253" class="difflineminus">-      issued.setAttribute(&quot;value&quot;, certIssuedInfos[i]);</span>
<a href="#l14.254"></a><span id="l14.254" class="difflineminus">-      issued.setAttribute(&quot;crop&quot;, &quot;end&quot;);</span>
<a href="#l14.255"></a><span id="l14.255" class="difflineminus">-      issued.setAttribute(&quot;style&quot;, &quot;width: var(--issuedWidth)&quot;);</span>
<a href="#l14.256"></a><span id="l14.256" class="difflineminus">-      listitem.appendChild(issued);</span>
<a href="#l14.257"></a><span id="l14.257" class="difflineminus">-</span>
<a href="#l14.258"></a><span id="l14.258" class="difflineminus">-      let expire = document.createXULElement(&quot;label&quot;);</span>
<a href="#l14.259"></a><span id="l14.259" class="difflineminus">-      expire.setAttribute(&quot;value&quot;, certExpiresInfos[i]);</span>
<a href="#l14.260"></a><span id="l14.260" class="difflineminus">-      expire.setAttribute(&quot;crop&quot;, &quot;end&quot;);</span>
<a href="#l14.261"></a><span id="l14.261" class="difflineminus">-      expire.setAttribute(&quot;style&quot;, &quot;width: var(--expireWidth)&quot;);</span>
<a href="#l14.262"></a><span id="l14.262" class="difflineminus">-      listitem.appendChild(expire);</span>
<a href="#l14.263"></a><span id="l14.263" class="difflineminus">-</span>
<a href="#l14.264"></a><span id="l14.264" class="difflineminus">-      asyncDetermineUsages(certs[i]).then(results =&gt; {</span>
<a href="#l14.265"></a><span id="l14.265" class="difflineminus">-        let someError = results.some(</span>
<a href="#l14.266"></a><span id="l14.266" class="difflineminus">-          result =&gt; result.errorCode !== PRErrorCodeSuccess</span>
<a href="#l14.267"></a><span id="l14.267" class="difflineminus">-        );</span>
<a href="#l14.268"></a><span id="l14.268" class="difflineminus">-        if (!someError) {</span>
<a href="#l14.269"></a><span id="l14.269" class="difflineminus">-          status.setAttribute(&quot;value&quot;, gBundle.getString(&quot;StatusValid&quot;));</span>
<a href="#l14.270"></a><span id="l14.270" class="difflineminus">-          return;</span>
<a href="#l14.271"></a><span id="l14.271" class="difflineminus">-        }</span>
<a href="#l14.272"></a><span id="l14.272" class="difflineplus">+  await setListEntries();</span>
<a href="#l14.273"></a><span id="l14.273" class="difflineplus">+}</span>
<a href="#l14.274"></a><span id="l14.274"> </span>
<a href="#l14.275"></a><span id="l14.275" class="difflineminus">-        // Keep in sync with certViewer.js.</span>
<a href="#l14.276"></a><span id="l14.276" class="difflineminus">-        const SEC_ERROR_BASE = Ci.nsINSSErrorsService.NSS_SEC_ERROR_BASE;</span>
<a href="#l14.277"></a><span id="l14.277" class="difflineminus">-        const SEC_ERROR_EXPIRED_CERTIFICATE = SEC_ERROR_BASE + 11;</span>
<a href="#l14.278"></a><span id="l14.278" class="difflineminus">-        const SEC_ERROR_REVOKED_CERTIFICATE = SEC_ERROR_BASE + 12;</span>
<a href="#l14.279"></a><span id="l14.279" class="difflineminus">-        const SEC_ERROR_UNKNOWN_ISSUER = SEC_ERROR_BASE + 13;</span>
<a href="#l14.280"></a><span id="l14.280" class="difflineminus">-        const SEC_ERROR_UNTRUSTED_ISSUER = SEC_ERROR_BASE + 20;</span>
<a href="#l14.281"></a><span id="l14.281" class="difflineminus">-        const SEC_ERROR_UNTRUSTED_CERT = SEC_ERROR_BASE + 21;</span>
<a href="#l14.282"></a><span id="l14.282" class="difflineminus">-        const SEC_ERROR_EXPIRED_ISSUER_CERTIFICATE = SEC_ERROR_BASE + 30;</span>
<a href="#l14.283"></a><span id="l14.283" class="difflineminus">-        const SEC_ERROR_CERT_SIGNATURE_ALGORITHM_DISABLED =</span>
<a href="#l14.284"></a><span id="l14.284" class="difflineminus">-          SEC_ERROR_BASE + 176;</span>
<a href="#l14.285"></a><span id="l14.285" class="difflineminus">-</span>
<a href="#l14.286"></a><span id="l14.286" class="difflineminus">-        const errorRankings = [</span>
<a href="#l14.287"></a><span id="l14.287" class="difflineminus">-          {</span>
<a href="#l14.288"></a><span id="l14.288" class="difflineminus">-            error: SEC_ERROR_REVOKED_CERTIFICATE,</span>
<a href="#l14.289"></a><span id="l14.289" class="difflineminus">-            bundleString: &quot;StatusRevoked&quot;,</span>
<a href="#l14.290"></a><span id="l14.290" class="difflineminus">-          },</span>
<a href="#l14.291"></a><span id="l14.291" class="difflineminus">-          { error: SEC_ERROR_UNTRUSTED_CERT, bundleString: &quot;StatusUntrusted&quot; },</span>
<a href="#l14.292"></a><span id="l14.292" class="difflineminus">-          {</span>
<a href="#l14.293"></a><span id="l14.293" class="difflineminus">-            error: SEC_ERROR_UNTRUSTED_ISSUER,</span>
<a href="#l14.294"></a><span id="l14.294" class="difflineminus">-            bundleString: &quot;StatusUntrusted&quot;,</span>
<a href="#l14.295"></a><span id="l14.295" class="difflineminus">-          },</span>
<a href="#l14.296"></a><span id="l14.296" class="difflineminus">-          {</span>
<a href="#l14.297"></a><span id="l14.297" class="difflineminus">-            error: SEC_ERROR_CERT_SIGNATURE_ALGORITHM_DISABLED,</span>
<a href="#l14.298"></a><span id="l14.298" class="difflineminus">-            bundleString: &quot;StatusInvalid&quot;,</span>
<a href="#l14.299"></a><span id="l14.299" class="difflineminus">-          },</span>
<a href="#l14.300"></a><span id="l14.300" class="difflineminus">-          {</span>
<a href="#l14.301"></a><span id="l14.301" class="difflineminus">-            error: SEC_ERROR_EXPIRED_CERTIFICATE,</span>
<a href="#l14.302"></a><span id="l14.302" class="difflineminus">-            bundleString: &quot;StatusExpired&quot;,</span>
<a href="#l14.303"></a><span id="l14.303" class="difflineminus">-          },</span>
<a href="#l14.304"></a><span id="l14.304" class="difflineminus">-          {</span>
<a href="#l14.305"></a><span id="l14.305" class="difflineminus">-            error: SEC_ERROR_EXPIRED_ISSUER_CERTIFICATE,</span>
<a href="#l14.306"></a><span id="l14.306" class="difflineminus">-            bundleString: &quot;StatusExpired&quot;,</span>
<a href="#l14.307"></a><span id="l14.307" class="difflineminus">-          },</span>
<a href="#l14.308"></a><span id="l14.308" class="difflineminus">-          { error: SEC_ERROR_UNKNOWN_ISSUER, bundleString: &quot;StatusUntrusted&quot; },</span>
<a href="#l14.309"></a><span id="l14.309" class="difflineminus">-        ];</span>
<a href="#l14.310"></a><span id="l14.310" class="difflineminus">-</span>
<a href="#l14.311"></a><span id="l14.311" class="difflineminus">-        let bs = &quot;StatusInvalid&quot;;</span>
<a href="#l14.312"></a><span id="l14.312" class="difflineminus">-        for (let errorRanking of errorRankings) {</span>
<a href="#l14.313"></a><span id="l14.313" class="difflineminus">-          let errorPresent = results.some(</span>
<a href="#l14.314"></a><span id="l14.314" class="difflineminus">-            result =&gt; result.errorCode == errorRanking.error</span>
<a href="#l14.315"></a><span id="l14.315" class="difflineminus">-          );</span>
<a href="#l14.316"></a><span id="l14.316" class="difflineminus">-          if (errorPresent) {</span>
<a href="#l14.317"></a><span id="l14.317" class="difflineminus">-            bs = errorRanking.bundleString;</span>
<a href="#l14.318"></a><span id="l14.318" class="difflineminus">-            break;</span>
<a href="#l14.319"></a><span id="l14.319" class="difflineminus">-          }</span>
<a href="#l14.320"></a><span id="l14.320" class="difflineminus">-        }</span>
<a href="#l14.321"></a><span id="l14.321" class="difflineminus">-</span>
<a href="#l14.322"></a><span id="l14.322" class="difflineminus">-        status.setAttribute(&quot;value&quot;, gBundle.getString(bs));</span>
<a href="#l14.323"></a><span id="l14.323" class="difflineminus">-      });</span>
<a href="#l14.324"></a><span id="l14.324" class="difflineplus">+async function reload() {</span>
<a href="#l14.325"></a><span id="l14.325" class="difflineplus">+  while (true) {</span>
<a href="#l14.326"></a><span id="l14.326" class="difflineplus">+    let child = gListBox.firstChild;</span>
<a href="#l14.327"></a><span id="l14.327" class="difflineplus">+    if (!child) {</span>
<a href="#l14.328"></a><span id="l14.328" class="difflineplus">+      break;</span>
<a href="#l14.329"></a><span id="l14.329">     }</span>
<a href="#l14.330"></a><span id="l14.330" class="difflineminus">-</span>
<a href="#l14.331"></a><span id="l14.331" class="difflineminus">-    gListBox.appendChild(listitem);</span>
<a href="#l14.332"></a><span id="l14.332" class="difflineplus">+    gListBox.removeChild(child);</span>
<a href="#l14.333"></a><span id="l14.333">   }</span>
<a href="#l14.334"></a><span id="l14.334" class="difflineplus">+  gRowToEmail = [];</span>
<a href="#l14.335"></a><span id="l14.335" class="difflineplus">+  setListEntries();</span>
<a href="#l14.336"></a><span id="l14.336"> }</span>
<a href="#l14.337"></a><span id="l14.337"> </span>
<a href="#l14.338"></a><span id="l14.338" class="difflineminus">-// --- borrowed from pippki.js ---</span>
<a href="#l14.339"></a><span id="l14.339" class="difflineminus">-const PRErrorCodeSuccess = 0;</span>
<a href="#l14.340"></a><span id="l14.340" class="difflineminus">-</span>
<a href="#l14.341"></a><span id="l14.341" class="difflineminus">-const certificateUsageEmailSigner = 0x0010;</span>
<a href="#l14.342"></a><span id="l14.342" class="difflineminus">-const certificateUsageEmailRecipient = 0x0020;</span>
<a href="#l14.343"></a><span id="l14.343" class="difflineminus">-</span>
<a href="#l14.344"></a><span id="l14.344" class="difflineminus">-// A map from the name of a certificate usage to the value of the usage.</span>
<a href="#l14.345"></a><span id="l14.345" class="difflineminus">-const certificateUsages = {</span>
<a href="#l14.346"></a><span id="l14.346" class="difflineminus">-  certificateUsageEmailRecipient,</span>
<a href="#l14.347"></a><span id="l14.347" class="difflineminus">-};</span>
<a href="#l14.348"></a><span id="l14.348" class="difflineminus">-</span>
<a href="#l14.349"></a><span id="l14.349" class="difflineminus">-function asyncDetermineUsages(cert) {</span>
<a href="#l14.350"></a><span id="l14.350" class="difflineminus">-  let promises = [];</span>
<a href="#l14.351"></a><span id="l14.351" class="difflineminus">-  let now = Date.now() / 1000;</span>
<a href="#l14.352"></a><span id="l14.352" class="difflineminus">-  let certdb = Cc[&quot;@mozilla.org/security/x509certdb;1&quot;].getService(</span>
<a href="#l14.353"></a><span id="l14.353" class="difflineminus">-    Ci.nsIX509CertDB</span>
<a href="#l14.354"></a><span id="l14.354" class="difflineminus">-  );</span>
<a href="#l14.355"></a><span id="l14.355" class="difflineminus">-  Object.keys(certificateUsages).forEach(usageString =&gt; {</span>
<a href="#l14.356"></a><span id="l14.356" class="difflineminus">-    promises.push(</span>
<a href="#l14.357"></a><span id="l14.357" class="difflineminus">-      new Promise((resolve, reject) =&gt; {</span>
<a href="#l14.358"></a><span id="l14.358" class="difflineminus">-        let usage = certificateUsages[usageString];</span>
<a href="#l14.359"></a><span id="l14.359" class="difflineminus">-        certdb.asyncVerifyCertAtTime(</span>
<a href="#l14.360"></a><span id="l14.360" class="difflineminus">-          cert,</span>
<a href="#l14.361"></a><span id="l14.361" class="difflineminus">-          usage,</span>
<a href="#l14.362"></a><span id="l14.362" class="difflineminus">-          0,</span>
<a href="#l14.363"></a><span id="l14.363" class="difflineminus">-          null,</span>
<a href="#l14.364"></a><span id="l14.364" class="difflineminus">-          now,</span>
<a href="#l14.365"></a><span id="l14.365" class="difflineminus">-          (aPRErrorCode, aVerifiedChain, aHasEVPolicy) =&gt; {</span>
<a href="#l14.366"></a><span id="l14.366" class="difflineminus">-            resolve({</span>
<a href="#l14.367"></a><span id="l14.367" class="difflineminus">-              usageString,</span>
<a href="#l14.368"></a><span id="l14.368" class="difflineminus">-              errorCode: aPRErrorCode,</span>
<a href="#l14.369"></a><span id="l14.369" class="difflineminus">-              chain: aVerifiedChain,</span>
<a href="#l14.370"></a><span id="l14.370" class="difflineminus">-            });</span>
<a href="#l14.371"></a><span id="l14.371" class="difflineminus">-          }</span>
<a href="#l14.372"></a><span id="l14.372" class="difflineminus">-        );</span>
<a href="#l14.373"></a><span id="l14.373" class="difflineminus">-      })</span>
<a href="#l14.374"></a><span id="l14.374" class="difflineminus">-    );</span>
<a href="#l14.375"></a><span id="l14.375" class="difflineminus">-  });</span>
<a href="#l14.376"></a><span id="l14.376" class="difflineminus">-  return Promise.all(promises);</span>
<a href="#l14.377"></a><span id="l14.377" class="difflineminus">-}</span>
<a href="#l14.378"></a><span id="l14.378" class="difflineminus">-// --- /borrowed from pippki.js ---</span>
<a href="#l14.379"></a><span id="l14.379" class="difflineminus">-</span>
<a href="#l14.380"></a><span id="l14.380"> function onSelectionChange(event) {</span>
<a href="#l14.381"></a><span id="l14.381" class="difflineminus">-  gViewButton.disabled = !(</span>
<a href="#l14.382"></a><span id="l14.382" class="difflineminus">-    gListBox.selectedItems.length == 1 &amp;&amp; certForRow(gListBox.selectedIndex)</span>
<a href="#l14.383"></a><span id="l14.383" class="difflineminus">-  );</span>
<a href="#l14.384"></a><span id="l14.384" class="difflineplus">+  gViewButton.disabled = !gListBox.selectedItems.length;</span>
<a href="#l14.385"></a><span id="l14.385"> }</span>
<a href="#l14.386"></a><span id="l14.386"> </span>
<a href="#l14.387"></a><span id="l14.387" class="difflineminus">-function viewCertHelper(parent, cert) {</span>
<a href="#l14.388"></a><span id="l14.388" class="difflineminus">-  Services.ww.openWindow(</span>
<a href="#l14.389"></a><span id="l14.389" class="difflineminus">-    parent,</span>
<a href="#l14.390"></a><span id="l14.390" class="difflineminus">-    &quot;chrome://pippki/content/certViewer.xhtml&quot;,</span>
<a href="#l14.391"></a><span id="l14.391" class="difflineminus">-    &quot;_blank&quot;,</span>
<a href="#l14.392"></a><span id="l14.392" class="difflineminus">-    &quot;centerscreen,chrome,titlebar&quot;,</span>
<a href="#l14.393"></a><span id="l14.393" class="difflineminus">-    cert</span>
<a href="#l14.394"></a><span id="l14.394" class="difflineplus">+function viewSelectedEmail() {</span>
<a href="#l14.395"></a><span id="l14.395" class="difflineplus">+  if (gViewButton.disabled) {</span>
<a href="#l14.396"></a><span id="l14.396" class="difflineplus">+    return;</span>
<a href="#l14.397"></a><span id="l14.397" class="difflineplus">+  }</span>
<a href="#l14.398"></a><span id="l14.398" class="difflineplus">+  let email = gRowToEmail[gListBox.selectedIndex];</span>
<a href="#l14.399"></a><span id="l14.399" class="difflineplus">+  window.openDialog(</span>
<a href="#l14.400"></a><span id="l14.400" class="difflineplus">+    &quot;chrome://openpgp/content/ui/oneRecipientStatus.xhtml&quot;,</span>
<a href="#l14.401"></a><span id="l14.401" class="difflineplus">+    &quot;&quot;,</span>
<a href="#l14.402"></a><span id="l14.402" class="difflineplus">+    &quot;chrome,modal,resizable,centerscreen&quot;,</span>
<a href="#l14.403"></a><span id="l14.403" class="difflineplus">+    {</span>
<a href="#l14.404"></a><span id="l14.404" class="difflineplus">+      email,</span>
<a href="#l14.405"></a><span id="l14.405" class="difflineplus">+      keys: gMapAddressToKeyObjs.get(email),</span>
<a href="#l14.406"></a><span id="l14.406" class="difflineplus">+    }</span>
<a href="#l14.407"></a><span id="l14.407">   );</span>
<a href="#l14.408"></a><span id="l14.408" class="difflineminus">-}</span>
<a href="#l14.409"></a><span id="l14.409" class="difflineminus">-</span>
<a href="#l14.410"></a><span id="l14.410" class="difflineminus">-function certForRow(aRowIndex) {</span>
<a href="#l14.411"></a><span id="l14.411" class="difflineminus">-  return gCerts[aRowIndex];</span>
<a href="#l14.412"></a><span id="l14.412" class="difflineplus">+  reload();</span>
<a href="#l14.413"></a><span id="l14.413"> }</span>
<a href="#l14.414"></a><span id="l14.414" class="difflineminus">-</span>
<a href="#l14.415"></a><span id="l14.415" class="difflineminus">-function viewSelectedCert() {</span>
<a href="#l14.416"></a><span id="l14.416" class="difflineminus">-  if (!gViewButton.disabled) {</span>
<a href="#l14.417"></a><span id="l14.417" class="difflineminus">-    viewCertHelper(window, certForRow(gListBox.selectedIndex));</span>
<a href="#l14.418"></a><span id="l14.418" class="difflineminus">-  }</span>
<a href="#l14.419"></a><span id="l14.419" class="difflineminus">-}</span>
<a href="#l14.420"></a><span id="l14.420" class="difflineminus">-</span>
<a href="#l14.421"></a><span id="l14.421" class="difflineminus">-/* globals openHelp */</span>
<a href="#l14.422"></a><span id="l14.422" class="difflineminus">-// Suite only.</span>
<a href="#l14.423"></a><span id="l14.423" class="difflineminus">-function doHelpButton() {</span>
<a href="#l14.424"></a><span id="l14.424" class="difflineminus">-  openHelp(</span>
<a href="#l14.425"></a><span id="l14.425" class="difflineminus">-    &quot;compose_security&quot;,</span>
<a href="#l14.426"></a><span id="l14.426" class="difflineminus">-    &quot;chrome://communicator/locale/help/suitehelp.rdf&quot;</span>
<a href="#l14.427"></a><span id="l14.427" class="difflineminus">-  );</span>
<a href="#l14.428"></a><span id="l14.428" class="difflineminus">-}</span>
<a href="#l14.429"></a><span id="l14.429" class="difflineminus">-</span>
<a href="#l14.430"></a><span id="l14.430" class="difflineminus">-function createCell(label) {</span>
<a href="#l14.431"></a><span id="l14.431" class="difflineminus">-  var cell = document.createXULElement(&quot;listcell&quot;);</span>
<a href="#l14.432"></a><span id="l14.432" class="difflineminus">-  cell.setAttribute(&quot;label&quot;, label);</span>
<a href="#l14.433"></a><span id="l14.433" class="difflineminus">-  return cell;</span>
<a href="#l14.434"></a><span id="l14.434" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1">copy from mailnews/extensions/smime/content/msgCompSecurityInfo.xhtml</span>
<a href="#l15.2"></a><span id="l15.2">copy to mail/extensions/openpgp/content/ui/composeKeyStatus.xhtml</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineminus">--- a/mailnews/extensions/smime/content/msgCompSecurityInfo.xhtml</span>
<a href="#l15.4"></a><span id="l15.4" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/composeKeyStatus.xhtml</span>
<a href="#l15.5"></a><span id="l15.5" class="difflineat">@@ -1,68 +1,52 @@</span>
<a href="#l15.6"></a><span id="l15.6"> &lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l15.7"></a><span id="l15.7"> &lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l15.8"></a><span id="l15.8">    - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l15.9"></a><span id="l15.9">    - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l15.10"></a><span id="l15.10"> </span>
<a href="#l15.11"></a><span id="l15.11"> &lt;?xml-stylesheet href=&quot;chrome://global/skin/global.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-&lt;?xml-stylesheet href=&quot;chrome://messenger/skin/smime/msgCompSecurityInfo.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://messenger/skin/openpgp/composeKeyStatus.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l15.14"></a><span id="l15.14"> </span>
<a href="#l15.15"></a><span id="l15.15" class="difflineminus">-&lt;!DOCTYPE window SYSTEM &quot;chrome://messenger-smime/locale/msgCompSecurityInfo.dtd&quot;&gt;</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+&lt;!DOCTYPE window SYSTEM &quot;chrome://openpgp/content/strings/composeKeyStatus.dtd&quot;&gt;</span>
<a href="#l15.17"></a><span id="l15.17"> </span>
<a href="#l15.18"></a><span id="l15.18" class="difflineminus">-&lt;window title=&quot;&amp;title.label;&quot;</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineplus">+&lt;window title=&quot;&amp;composeKeyStatus.title;&quot;</span>
<a href="#l15.20"></a><span id="l15.20">         xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot; xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineminus">-        style=&quot;width: 50em;&quot;</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineplus">+        style=&quot;width: 40em; height: 25em&quot;</span>
<a href="#l15.23"></a><span id="l15.23">         persist=&quot;width height&quot;</span>
<a href="#l15.24"></a><span id="l15.24">         onload=&quot;onLoad();&quot;&gt;</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineminus">-&lt;dialog id=&quot;msgCompSecurityInfo&quot;</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineplus">+&lt;dialog id=&quot;composeKeyStatus&quot;</span>
<a href="#l15.27"></a><span id="l15.27">         buttons=&quot;accept&quot;&gt;</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineminus">-  &lt;script src=&quot;chrome://messenger-smime/content/msgCompSecurityInfo.js&quot;/&gt;</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineplus">+  &lt;script src=&quot;chrome://openpgp/content/ui/composeKeyStatus.js&quot;/&gt;</span>
<a href="#l15.30"></a><span id="l15.30">   &lt;script&gt;&lt;![CDATA[</span>
<a href="#l15.31"></a><span id="l15.31">       function resizeColumns() {</span>
<a href="#l15.32"></a><span id="l15.32">         let list = document.getElementById(&quot;infolist&quot;);</span>
<a href="#l15.33"></a><span id="l15.33">         let cols = list.getElementsByTagName(&quot;treecol&quot;);</span>
<a href="#l15.34"></a><span id="l15.34">         list.style.setProperty(&quot;--recipientWidth&quot;, cols[0].getBoundingClientRect().width + &quot;px&quot;);</span>
<a href="#l15.35"></a><span id="l15.35">         list.style.setProperty(&quot;--statusWidth&quot;, cols[1].getBoundingClientRect().width + &quot;px&quot;);</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineminus">-        list.style.setProperty(&quot;--issuedWidth&quot;, cols[2].getBoundingClientRect().width + &quot;px&quot;);</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineminus">-        list.style.setProperty(&quot;--expireWidth&quot;, cols[3].getBoundingClientRect().width - 5 + &quot;px&quot;);</span>
<a href="#l15.38"></a><span id="l15.38">       }</span>
<a href="#l15.39"></a><span id="l15.39">       addEventListener(&quot;load&quot;, resizeColumns, { once: true });</span>
<a href="#l15.40"></a><span id="l15.40">       addEventListener(&quot;resize&quot;, resizeColumns);</span>
<a href="#l15.41"></a><span id="l15.41">   ]]&gt;&lt;/script&gt;</span>
<a href="#l15.42"></a><span id="l15.42"> </span>
<a href="#l15.43"></a><span id="l15.43" class="difflineminus">-  &lt;stringbundle id=&quot;bundle_smime_comp_info&quot; src=&quot;chrome://messenger-smime/locale/msgCompSecurityInfo.properties&quot;/&gt;</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineplus">+  &lt;stringbundle id=&quot;bundle_openpgp_comp_info&quot; src=&quot;chrome://openpgp/content/strings/composeKeyStatus.properties&quot;/&gt;</span>
<a href="#l15.45"></a><span id="l15.45"> </span>
<a href="#l15.46"></a><span id="l15.46" class="difflineminus">-  &lt;description&gt;&amp;subject.plaintextWarning;&lt;/description&gt;</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineminus">-  &lt;separator class=&quot;thin&quot;/&gt;</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineminus">-  &lt;description&gt;&amp;status.heading;&lt;/description&gt;</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineminus">-  &lt;hbox&gt;</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineminus">-    &lt;vbox&gt;</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineminus">-      &lt;label value=&quot;&amp;status.signed;&quot;/&gt;</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineminus">-      &lt;label value=&quot;&amp;status.encrypted;&quot;/&gt;</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineminus">-    &lt;/vbox&gt;</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineminus">-    &lt;vbox&gt;</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineminus">-      &lt;label id=&quot;signed&quot;/&gt;</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineminus">-      &lt;label id=&quot;encrypted&quot;/&gt;</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineminus">-    &lt;/vbox&gt;</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineminus">-  &lt;/hbox&gt;</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineplus">+  &lt;description&gt;&amp;composeKeyStatus.introNeedKeys;&lt;/description&gt;</span>
<a href="#l15.60"></a><span id="l15.60"> </span>
<a href="#l15.61"></a><span id="l15.61">   &lt;separator class=&quot;thin&quot;/&gt;</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineminus">-  &lt;label value=&quot;&amp;status.certificates;&quot; control=&quot;infolist&quot;/&gt;</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineplus">+  &lt;label value=&quot;&amp;composeKeyStatus.keysHeading;&quot; control=&quot;infolist&quot;/&gt;</span>
<a href="#l15.64"></a><span id="l15.64"> </span>
<a href="#l15.65"></a><span id="l15.65">   &lt;richlistbox id=&quot;infolist&quot;</span>
<a href="#l15.66"></a><span id="l15.66">                class=&quot;theme-listbox&quot;</span>
<a href="#l15.67"></a><span id="l15.67">                flex=&quot;1&quot;</span>
<a href="#l15.68"></a><span id="l15.68">                onselect=&quot;onSelectionChange(event);&quot;&gt;</span>
<a href="#l15.69"></a><span id="l15.69">     &lt;treecols&gt;</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineminus">-      &lt;treecol flex=&quot;3&quot; label=&quot;&amp;tree.recipient;&quot;/&gt;</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineminus">-      &lt;treecol flex=&quot;1&quot; label=&quot;&amp;tree.status;&quot;/&gt;</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineminus">-      &lt;treecol flex=&quot;2&quot; label=&quot;&amp;tree.issuedDate;&quot;/&gt;</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineminus">-      &lt;treecol flex=&quot;2&quot; label=&quot;&amp;tree.expiresDate;&quot;/&gt;</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineplus">+      &lt;treecol flex=&quot;3&quot; label=&quot;&amp;composeKeyStatus.recipient;&quot;/&gt;</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineplus">+      &lt;treecol flex=&quot;2&quot; label=&quot;&amp;composeKeyStatus.status;&quot;/&gt;</span>
<a href="#l15.76"></a><span id="l15.76">     &lt;/treecols&gt;</span>
<a href="#l15.77"></a><span id="l15.77">   &lt;/richlistbox&gt;</span>
<a href="#l15.78"></a><span id="l15.78">   &lt;hbox pack=&quot;start&quot;&gt;</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineminus">-    &lt;button id=&quot;viewCertButton&quot; disabled=&quot;true&quot;</span>
<a href="#l15.80"></a><span id="l15.80" class="difflineminus">-            label=&quot;&amp;view.label;&quot; accesskey=&quot;&amp;view.accesskey;&quot;</span>
<a href="#l15.81"></a><span id="l15.81" class="difflineminus">-            oncommand=&quot;viewSelectedCert();&quot;/&gt;</span>
<a href="#l15.82"></a><span id="l15.82" class="difflineplus">+    &lt;button id=&quot;detailsButton&quot; disabled=&quot;true&quot;</span>
<a href="#l15.83"></a><span id="l15.83" class="difflineplus">+            label=&quot;&amp;composeKeyStatus.openDetails;&quot;</span>
<a href="#l15.84"></a><span id="l15.84" class="difflineplus">+            oncommand=&quot;viewSelectedEmail();&quot;/&gt;</span>
<a href="#l15.85"></a><span id="l15.85">   &lt;/hbox&gt;</span>
<a href="#l15.86"></a><span id="l15.86"> &lt;/dialog&gt;</span>
<a href="#l15.87"></a><span id="l15.87"> &lt;/window&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -1794,17 +1794,22 @@ Enigmail.msg = {</span>
<a href="#l16.4"></a><span id="l16.4">       .getAttribute(&quot;keydata&quot;);</span>
<a href="#l16.5"></a><span id="l16.5">     if (!keyDataB64) {</span>
<a href="#l16.6"></a><span id="l16.6">       return;</span>
<a href="#l16.7"></a><span id="l16.7">     }</span>
<a href="#l16.8"></a><span id="l16.8">     let keyData = EnigmailData.decodeBase64(keyDataB64);</span>
<a href="#l16.9"></a><span id="l16.9">     let errorMsgObj = {};</span>
<a href="#l16.10"></a><span id="l16.10">     let preview = EnigmailKey.getKeyListFromKeyBlock(keyData, errorMsgObj);</span>
<a href="#l16.11"></a><span id="l16.11">     if (errorMsgObj.value === &quot;&quot;) {</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-      this.importKeyDataWithConfirmation(preview, keyData, true);</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+      EnigmailKeyRing.importKeyDataWithConfirmation(</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+        window,</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+        preview,</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+        keyData,</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+        true</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineplus">+      );</span>
<a href="#l16.19"></a><span id="l16.19">     } else {</span>
<a href="#l16.20"></a><span id="l16.20">       EnigmailDialog.alert(</span>
<a href="#l16.21"></a><span id="l16.21">         window,</span>
<a href="#l16.22"></a><span id="l16.22">         EnigmailLocale.getString(&quot;previewFailed&quot;) + &quot;\n&quot; + errorMsgObj.value</span>
<a href="#l16.23"></a><span id="l16.23">       );</span>
<a href="#l16.24"></a><span id="l16.24">     }</span>
<a href="#l16.25"></a><span id="l16.25">   },</span>
<a href="#l16.26"></a><span id="l16.26"> </span>
<a href="#l16.27"></a><span id="l16.27" class="difflineat">@@ -1812,35 +1817,35 @@ Enigmail.msg = {</span>
<a href="#l16.28"></a><span id="l16.28">     let keyId = document</span>
<a href="#l16.29"></a><span id="l16.29">       .getElementById(&quot;signatureKeyBox&quot;)</span>
<a href="#l16.30"></a><span id="l16.30">       .getAttribute(&quot;keyid&quot;);</span>
<a href="#l16.31"></a><span id="l16.31">     if (!keyId) {</span>
<a href="#l16.32"></a><span id="l16.32">       return;</span>
<a href="#l16.33"></a><span id="l16.33">     }</span>
<a href="#l16.34"></a><span id="l16.34"> </span>
<a href="#l16.35"></a><span id="l16.35">     let defKs = EnigmailKeyserverURIs.getDefaultKeyServer();</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineminus">-    // We don't have great code yet to handle multiple results,</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineminus">-    // or poisoned results. So avoid SKS.</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineminus">-    // Let's start with verifying keyservers, only, which return only</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineminus">-    // one result.</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineminus">-    if (!defKs.startsWith(&quot;vks://&quot;)) {</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineminus">-      console.debug(&quot;Not using &quot; + defKs + &quot; in searchSignatureKey&quot;);</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineplus">+    if (!defKs) {</span>
<a href="#l16.43"></a><span id="l16.43">       return;</span>
<a href="#l16.44"></a><span id="l16.44">     }</span>
<a href="#l16.45"></a><span id="l16.45"> </span>
<a href="#l16.46"></a><span id="l16.46">     let vks = await EnigmailKeyServer.downloadNoImport(&quot;0x&quot; + keyId, defKs);</span>
<a href="#l16.47"></a><span id="l16.47">     if (&quot;keyData&quot; in vks) {</span>
<a href="#l16.48"></a><span id="l16.48">       let keyList = EnigmailKey.getKeyListFromKeyBlock(</span>
<a href="#l16.49"></a><span id="l16.49">         vks.keyData,</span>
<a href="#l16.50"></a><span id="l16.50">         {},</span>
<a href="#l16.51"></a><span id="l16.51">         false,</span>
<a href="#l16.52"></a><span id="l16.52">         true,</span>
<a href="#l16.53"></a><span id="l16.53">         false</span>
<a href="#l16.54"></a><span id="l16.54">       );</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineminus">-      this.importKeyDataWithConfirmation(keyList, vks.keyData, true);</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineplus">+      EnigmailKeyRing.importKeyDataWithConfirmation(</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineplus">+        window,</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineplus">+        keyList,</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineplus">+        vks.keyData,</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineplus">+        true</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineplus">+      );</span>
<a href="#l16.62"></a><span id="l16.62">     } else {</span>
<a href="#l16.63"></a><span id="l16.63">       console.debug(&quot;searchKeysOnInternet no data in keys.openpgp.org&quot;);</span>
<a href="#l16.64"></a><span id="l16.64">     }</span>
<a href="#l16.65"></a><span id="l16.65">   },</span>
<a href="#l16.66"></a><span id="l16.66"> </span>
<a href="#l16.67"></a><span id="l16.67">   importKeyFromMsgBody(msgData) {</span>
<a href="#l16.68"></a><span id="l16.68">     let beginIndexObj = {};</span>
<a href="#l16.69"></a><span id="l16.69">     let endIndexObj = {};</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineat">@@ -1857,79 +1862,30 @@ Enigmail.msg = {</span>
<a href="#l16.71"></a><span id="l16.71">       return;</span>
<a href="#l16.72"></a><span id="l16.72">     }</span>
<a href="#l16.73"></a><span id="l16.73"> </span>
<a href="#l16.74"></a><span id="l16.74">     let keyData = msgData.substring(beginIndexObj.value, endIndexObj.value);</span>
<a href="#l16.75"></a><span id="l16.75"> </span>
<a href="#l16.76"></a><span id="l16.76">     let errorMsgObj = {};</span>
<a href="#l16.77"></a><span id="l16.77">     let preview = EnigmailKey.getKeyListFromKeyBlock(keyData, errorMsgObj);</span>
<a href="#l16.78"></a><span id="l16.78">     if (errorMsgObj.value === &quot;&quot;) {</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineminus">-      this.importKeyDataWithConfirmation(preview, keyData, false);</span>
<a href="#l16.80"></a><span id="l16.80" class="difflineplus">+      EnigmailKeyRing.importKeyDataWithConfirmation(</span>
<a href="#l16.81"></a><span id="l16.81" class="difflineplus">+        window,</span>
<a href="#l16.82"></a><span id="l16.82" class="difflineplus">+        preview,</span>
<a href="#l16.83"></a><span id="l16.83" class="difflineplus">+        keyData,</span>
<a href="#l16.84"></a><span id="l16.84" class="difflineplus">+        false</span>
<a href="#l16.85"></a><span id="l16.85" class="difflineplus">+      );</span>
<a href="#l16.86"></a><span id="l16.86">     } else {</span>
<a href="#l16.87"></a><span id="l16.87">       EnigmailDialog.alert(</span>
<a href="#l16.88"></a><span id="l16.88">         window,</span>
<a href="#l16.89"></a><span id="l16.89">         EnigmailLocale.getString(&quot;previewFailed&quot;) + &quot;\n&quot; + errorMsgObj.value</span>
<a href="#l16.90"></a><span id="l16.90">       );</span>
<a href="#l16.91"></a><span id="l16.91">     }</span>
<a href="#l16.92"></a><span id="l16.92">   },</span>
<a href="#l16.93"></a><span id="l16.93"> </span>
<a href="#l16.94"></a><span id="l16.94" class="difflineminus">-  importKeyDataWithConfirmation(preview, keyData, isBinary) {</span>
<a href="#l16.95"></a><span id="l16.95" class="difflineminus">-    let exitStatus = -1,</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineminus">-      errorMsgObj = {};</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineminus">-    if (preview.length &gt; 0) {</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineminus">-      if (preview.length == 1) {</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineminus">-        exitStatus = EnigmailDialog.confirmDlg(</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineminus">-          window,</span>
<a href="#l16.101"></a><span id="l16.101" class="difflineminus">-          EnigmailLocale.getString(&quot;doImportOne&quot;, [</span>
<a href="#l16.102"></a><span id="l16.102" class="difflineminus">-            preview[0].name,</span>
<a href="#l16.103"></a><span id="l16.103" class="difflineminus">-            preview[0].id,</span>
<a href="#l16.104"></a><span id="l16.104" class="difflineminus">-          ])</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineminus">-        );</span>
<a href="#l16.106"></a><span id="l16.106" class="difflineminus">-      } else {</span>
<a href="#l16.107"></a><span id="l16.107" class="difflineminus">-        exitStatus = EnigmailDialog.confirmDlg(</span>
<a href="#l16.108"></a><span id="l16.108" class="difflineminus">-          window,</span>
<a href="#l16.109"></a><span id="l16.109" class="difflineminus">-          EnigmailLocale.getString(&quot;doImportMultiple&quot;, [</span>
<a href="#l16.110"></a><span id="l16.110" class="difflineminus">-            preview</span>
<a href="#l16.111"></a><span id="l16.111" class="difflineminus">-              .map(function(a) {</span>
<a href="#l16.112"></a><span id="l16.112" class="difflineminus">-                return &quot;\t&quot; + a.name + &quot; (&quot; + a.id + &quot;)&quot;;</span>
<a href="#l16.113"></a><span id="l16.113" class="difflineminus">-              })</span>
<a href="#l16.114"></a><span id="l16.114" class="difflineminus">-              .join(&quot;\n&quot;),</span>
<a href="#l16.115"></a><span id="l16.115" class="difflineminus">-          ])</span>
<a href="#l16.116"></a><span id="l16.116" class="difflineminus">-        );</span>
<a href="#l16.117"></a><span id="l16.117" class="difflineminus">-      }</span>
<a href="#l16.118"></a><span id="l16.118" class="difflineminus">-</span>
<a href="#l16.119"></a><span id="l16.119" class="difflineminus">-      if (exitStatus) {</span>
<a href="#l16.120"></a><span id="l16.120" class="difflineminus">-        try {</span>
<a href="#l16.121"></a><span id="l16.121" class="difflineminus">-          exitStatus = EnigmailKeyRing.importKey(</span>
<a href="#l16.122"></a><span id="l16.122" class="difflineminus">-            window,</span>
<a href="#l16.123"></a><span id="l16.123" class="difflineminus">-            false,</span>
<a href="#l16.124"></a><span id="l16.124" class="difflineminus">-            keyData,</span>
<a href="#l16.125"></a><span id="l16.125" class="difflineminus">-            isBinary,</span>
<a href="#l16.126"></a><span id="l16.126" class="difflineminus">-            &quot;&quot;,</span>
<a href="#l16.127"></a><span id="l16.127" class="difflineminus">-            errorMsgObj</span>
<a href="#l16.128"></a><span id="l16.128" class="difflineminus">-          );</span>
<a href="#l16.129"></a><span id="l16.129" class="difflineminus">-        } catch (ex) {}</span>
<a href="#l16.130"></a><span id="l16.130" class="difflineminus">-</span>
<a href="#l16.131"></a><span id="l16.131" class="difflineminus">-        if (exitStatus === 0) {</span>
<a href="#l16.132"></a><span id="l16.132" class="difflineminus">-          var keyList = preview.map(function(a) {</span>
<a href="#l16.133"></a><span id="l16.133" class="difflineminus">-            return a.id;</span>
<a href="#l16.134"></a><span id="l16.134" class="difflineminus">-          });</span>
<a href="#l16.135"></a><span id="l16.135" class="difflineminus">-          EnigmailDialog.keyImportDlg(window, keyList);</span>
<a href="#l16.136"></a><span id="l16.136" class="difflineminus">-        } else {</span>
<a href="#l16.137"></a><span id="l16.137" class="difflineminus">-          EnigmailDialog.alert(</span>
<a href="#l16.138"></a><span id="l16.138" class="difflineminus">-            window,</span>
<a href="#l16.139"></a><span id="l16.139" class="difflineminus">-            EnigmailLocale.getString(&quot;failKeyImport&quot;) + &quot;\n&quot; + errorMsgObj.value</span>
<a href="#l16.140"></a><span id="l16.140" class="difflineminus">-          );</span>
<a href="#l16.141"></a><span id="l16.141" class="difflineminus">-        }</span>
<a href="#l16.142"></a><span id="l16.142" class="difflineminus">-      }</span>
<a href="#l16.143"></a><span id="l16.143" class="difflineminus">-    } else {</span>
<a href="#l16.144"></a><span id="l16.144" class="difflineminus">-      EnigmailDialog.alert(window, EnigmailLocale.getString(&quot;noKeyFound&quot;));</span>
<a href="#l16.145"></a><span id="l16.145" class="difflineminus">-    }</span>
<a href="#l16.146"></a><span id="l16.146" class="difflineminus">-  },</span>
<a href="#l16.147"></a><span id="l16.147" class="difflineminus">-</span>
<a href="#l16.148"></a><span id="l16.148">   /**</span>
<a href="#l16.149"></a><span id="l16.149">    * Extract the subject from the 1st content line and move it to the subject line</span>
<a href="#l16.150"></a><span id="l16.150">    */</span>
<a href="#l16.151"></a><span id="l16.151">   movePEPsubject() {</span>
<a href="#l16.152"></a><span id="l16.152">     EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: movePEPsubject:\n&quot;);</span>
<a href="#l16.153"></a><span id="l16.153"> </span>
<a href="#l16.154"></a><span id="l16.154">     let bodyElement = this.getBodyElement();</span>
<a href="#l16.155"></a><span id="l16.155"> </span>
<a href="#l16.156"></a><span id="l16.156" class="difflineat">@@ -2900,17 +2856,22 @@ Enigmail.msg = {</span>
<a href="#l16.157"></a><span id="l16.157">           preview = EnigmailKey.getKeyListFromKeyBlock(</span>
<a href="#l16.158"></a><span id="l16.158">             callbackArg.data,</span>
<a href="#l16.159"></a><span id="l16.159">             errorMsgObj</span>
<a href="#l16.160"></a><span id="l16.160">           );</span>
<a href="#l16.161"></a><span id="l16.161">         }</span>
<a href="#l16.162"></a><span id="l16.162">       }</span>
<a href="#l16.163"></a><span id="l16.163"> </span>
<a href="#l16.164"></a><span id="l16.164">       if (errorMsgObj.value === &quot;&quot;) {</span>
<a href="#l16.165"></a><span id="l16.165" class="difflineminus">-        this.importKeyDataWithConfirmation(preview, callbackArg.data, false);</span>
<a href="#l16.166"></a><span id="l16.166" class="difflineplus">+        EnigmailKeyRing.importKeyDataWithConfirmation(</span>
<a href="#l16.167"></a><span id="l16.167" class="difflineplus">+          window,</span>
<a href="#l16.168"></a><span id="l16.168" class="difflineplus">+          preview,</span>
<a href="#l16.169"></a><span id="l16.169" class="difflineplus">+          callbackArg.data,</span>
<a href="#l16.170"></a><span id="l16.170" class="difflineplus">+          false</span>
<a href="#l16.171"></a><span id="l16.171" class="difflineplus">+        );</span>
<a href="#l16.172"></a><span id="l16.172">       } else {</span>
<a href="#l16.173"></a><span id="l16.173">         EnigmailDialog.alert(</span>
<a href="#l16.174"></a><span id="l16.174">           window,</span>
<a href="#l16.175"></a><span id="l16.175">           EnigmailLocale.getString(&quot;previewFailed&quot;) + &quot;\n&quot; + errorMsgObj.value</span>
<a href="#l16.176"></a><span id="l16.176">         );</span>
<a href="#l16.177"></a><span id="l16.177">       }</span>
<a href="#l16.178"></a><span id="l16.178">       outFile.remove(true);</span>
<a href="#l16.179"></a><span id="l16.179">       return;</span>
<a href="#l16.180"></a><span id="l16.180" class="difflineat">@@ -3116,43 +3077,48 @@ Enigmail.msg = {</span>
<a href="#l16.181"></a><span id="l16.181">     if (!foundKeys) {</span>
<a href="#l16.182"></a><span id="l16.182">       console.debug(&quot;searchKeysOnInternet no wkd data&quot;);</span>
<a href="#l16.183"></a><span id="l16.183">     } else {</span>
<a href="#l16.184"></a><span id="l16.184">       let keyList = EnigmailKey.getKeyListFromKeyBlock(</span>
<a href="#l16.185"></a><span id="l16.185">         foundKeys.keyData,</span>
<a href="#l16.186"></a><span id="l16.186">         {},</span>
<a href="#l16.187"></a><span id="l16.187">         false</span>
<a href="#l16.188"></a><span id="l16.188">       );</span>
<a href="#l16.189"></a><span id="l16.189" class="difflineminus">-      this.importKeyDataWithConfirmation(keyList, foundKeys.keyData, true);</span>
<a href="#l16.190"></a><span id="l16.190" class="difflineplus">+      EnigmailKeyRing.importKeyDataWithConfirmation(</span>
<a href="#l16.191"></a><span id="l16.191" class="difflineplus">+        window,</span>
<a href="#l16.192"></a><span id="l16.192" class="difflineplus">+        keyList,</span>
<a href="#l16.193"></a><span id="l16.193" class="difflineplus">+        foundKeys.keyData,</span>
<a href="#l16.194"></a><span id="l16.194" class="difflineplus">+        true</span>
<a href="#l16.195"></a><span id="l16.195" class="difflineplus">+      );</span>
<a href="#l16.196"></a><span id="l16.196">     }</span>
<a href="#l16.197"></a><span id="l16.197"> </span>
<a href="#l16.198"></a><span id="l16.198">     if (foundKeys) {</span>
<a href="#l16.199"></a><span id="l16.199">       return;</span>
<a href="#l16.200"></a><span id="l16.200">     }</span>
<a href="#l16.201"></a><span id="l16.201"> </span>
<a href="#l16.202"></a><span id="l16.202">     let defKs = EnigmailKeyserverURIs.getDefaultKeyServer();</span>
<a href="#l16.203"></a><span id="l16.203" class="difflineminus">-    // We don't have great code yet to handle multiple results,</span>
<a href="#l16.204"></a><span id="l16.204" class="difflineminus">-    // or poisoned results. So avoid SKS.</span>
<a href="#l16.205"></a><span id="l16.205" class="difflineminus">-    // Let's start with verifying keyservers, only, which return only</span>
<a href="#l16.206"></a><span id="l16.206" class="difflineminus">-    // one result.</span>
<a href="#l16.207"></a><span id="l16.207" class="difflineminus">-    if (!defKs.startsWith(&quot;vks://&quot;)) {</span>
<a href="#l16.208"></a><span id="l16.208" class="difflineminus">-      console.debug(&quot;Not using &quot; + defKs + &quot; in searchKeysOnInternet&quot;);</span>
<a href="#l16.209"></a><span id="l16.209" class="difflineplus">+    if (!defKs) {</span>
<a href="#l16.210"></a><span id="l16.210">       return;</span>
<a href="#l16.211"></a><span id="l16.211">     }</span>
<a href="#l16.212"></a><span id="l16.212"> </span>
<a href="#l16.213"></a><span id="l16.213">     let vks = await EnigmailKeyServer.downloadNoImport(address, defKs);</span>
<a href="#l16.214"></a><span id="l16.214">     if (&quot;keyData&quot; in vks) {</span>
<a href="#l16.215"></a><span id="l16.215">       let keyList = EnigmailKey.getKeyListFromKeyBlock(</span>
<a href="#l16.216"></a><span id="l16.216">         vks.keyData,</span>
<a href="#l16.217"></a><span id="l16.217">         {},</span>
<a href="#l16.218"></a><span id="l16.218">         false,</span>
<a href="#l16.219"></a><span id="l16.219">         true,</span>
<a href="#l16.220"></a><span id="l16.220">         false</span>
<a href="#l16.221"></a><span id="l16.221">       );</span>
<a href="#l16.222"></a><span id="l16.222" class="difflineminus">-      this.importKeyDataWithConfirmation(keyList, vks.keyData, true);</span>
<a href="#l16.223"></a><span id="l16.223" class="difflineplus">+      EnigmailKeyRing.importKeyDataWithConfirmation(</span>
<a href="#l16.224"></a><span id="l16.224" class="difflineplus">+        window,</span>
<a href="#l16.225"></a><span id="l16.225" class="difflineplus">+        keyList,</span>
<a href="#l16.226"></a><span id="l16.226" class="difflineplus">+        vks.keyData,</span>
<a href="#l16.227"></a><span id="l16.227" class="difflineplus">+        true</span>
<a href="#l16.228"></a><span id="l16.228" class="difflineplus">+      );</span>
<a href="#l16.229"></a><span id="l16.229">     } else {</span>
<a href="#l16.230"></a><span id="l16.230">       console.debug(&quot;searchKeysOnInternet no data in keys.openpgp.org&quot;);</span>
<a href="#l16.231"></a><span id="l16.231">     }</span>
<a href="#l16.232"></a><span id="l16.232">   },</span>
<a href="#l16.233"></a><span id="l16.233"> </span>
<a href="#l16.234"></a><span id="l16.234">   importKeyFromKeyserver() {</span>
<a href="#l16.235"></a><span id="l16.235">     var pubKeyId = &quot;0x&quot; + Enigmail.msg.securityInfo.keyId;</span>
<a href="#l16.236"></a><span id="l16.236">     var inputObj = {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/enigmailMsgComposeHelper.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/enigmailMsgComposeHelper.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -45,85 +45,59 @@ if (!Enigmail) {</span>
<a href="#l17.4"></a><span id="l17.4">   var Enigmail = {};</span>
<a href="#l17.5"></a><span id="l17.5"> }</span>
<a href="#l17.6"></a><span id="l17.6"> </span>
<a href="#l17.7"></a><span id="l17.7"> Enigmail.hlp = {</span>
<a href="#l17.8"></a><span id="l17.8">   /* try to find valid key to passed email addresses (or keys)</span>
<a href="#l17.9"></a><span id="l17.9">    * @return: list of all found key (with leading &quot;0x&quot;) or null</span>
<a href="#l17.10"></a><span id="l17.10">    *          details in details parameter</span>
<a href="#l17.11"></a><span id="l17.11">    */</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-  validKeysForAllRecipients(emailsOrKeys, details) {</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+  async validKeysForAllRecipients(emailsOrKeys, details) {</span>
<a href="#l17.14"></a><span id="l17.14">     EnigmailLog.DEBUG(&quot;=====&gt; validKeysForAllRecipients()\n&quot;);</span>
<a href="#l17.15"></a><span id="l17.15">     EnigmailLog.DEBUG(</span>
<a href="#l17.16"></a><span id="l17.16">       &quot;enigmailMsgComposeHelper.js: validKeysForAllRecipients(): emailsOrKeys='&quot; +</span>
<a href="#l17.17"></a><span id="l17.17">         emailsOrKeys +</span>
<a href="#l17.18"></a><span id="l17.18">         &quot;'\n&quot;</span>
<a href="#l17.19"></a><span id="l17.19">     );</span>
<a href="#l17.20"></a><span id="l17.20"> </span>
<a href="#l17.21"></a><span id="l17.21">     // use helper to see when we enter and leave this function</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineminus">-    let resultingArray = this.doValidKeysForAllRecipients(</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineplus">+    let resultingArray = await this.doValidKeysForAllRecipients(</span>
<a href="#l17.24"></a><span id="l17.24">       emailsOrKeys,</span>
<a href="#l17.25"></a><span id="l17.25">       details</span>
<a href="#l17.26"></a><span id="l17.26">     );</span>
<a href="#l17.27"></a><span id="l17.27"> </span>
<a href="#l17.28"></a><span id="l17.28">     EnigmailLog.DEBUG(</span>
<a href="#l17.29"></a><span id="l17.29">       &quot;enigmailMsgComposeHelper.js: validKeysForAllRecipients(): return '&quot; +</span>
<a href="#l17.30"></a><span id="l17.30">         resultingArray +</span>
<a href="#l17.31"></a><span id="l17.31">         &quot;'\n&quot;</span>
<a href="#l17.32"></a><span id="l17.32">     );</span>
<a href="#l17.33"></a><span id="l17.33">     EnigmailLog.DEBUG(&quot;  &lt;=== validKeysForAllRecipients()\n&quot;);</span>
<a href="#l17.34"></a><span id="l17.34">     return resultingArray;</span>
<a href="#l17.35"></a><span id="l17.35">   },</span>
<a href="#l17.36"></a><span id="l17.36"> </span>
<a href="#l17.37"></a><span id="l17.37">   // helper for validKeysForAllRecipients()</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineminus">-  doValidKeysForAllRecipients(emailsOrKeys, details) {</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineplus">+  async doValidKeysForAllRecipients(emailsOrKeys, details) {</span>
<a href="#l17.40"></a><span id="l17.40">     EnigmailLog.DEBUG(</span>
<a href="#l17.41"></a><span id="l17.41">       &quot;enigmailMsgComposeHelper.js: doValidKeysForAllRecipients(): emailsOrKeys='&quot; +</span>
<a href="#l17.42"></a><span id="l17.42">         emailsOrKeys +</span>
<a href="#l17.43"></a><span id="l17.43">         &quot;'\n&quot;</span>
<a href="#l17.44"></a><span id="l17.44">     );</span>
<a href="#l17.45"></a><span id="l17.45"> </span>
<a href="#l17.46"></a><span id="l17.46" class="difflineminus">-    // check which keys are accepted</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineminus">-    let minTrustLevel;</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineminus">-    let acceptedKeys = EnigmailPrefs.getPref(&quot;acceptedKeys&quot;);</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineminus">-    switch (acceptedKeys) {</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineminus">-      case 0: // accept valid/authenticated keys only</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineminus">-        minTrustLevel = &quot;f&quot;; // first value for trusted keys</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineminus">-        break;</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineminus">-      case 1: // accept all but revoked/disabled/expired keys</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineminus">-        minTrustLevel = &quot;?&quot;; // value between invalid and unknown keys</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineminus">-        break;</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineminus">-      default:</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineminus">-        EnigmailLog.DEBUG(</span>
<a href="#l17.58"></a><span id="l17.58" class="difflineminus">-          'enigmailMsgComposeOverlay.js: doValidKeysForAllRecipients(): return null (INVALID VALUE for acceptedKeys: &quot;' +</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineminus">-            acceptedKeys +</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineminus">-            '&quot;)\n'</span>
<a href="#l17.61"></a><span id="l17.61" class="difflineminus">-        );</span>
<a href="#l17.62"></a><span id="l17.62" class="difflineminus">-        return null;</span>
<a href="#l17.63"></a><span id="l17.63" class="difflineminus">-    }</span>
<a href="#l17.64"></a><span id="l17.64" class="difflineminus">-</span>
<a href="#l17.65"></a><span id="l17.65" class="difflineminus">-    EnigmailLog.DEBUG(</span>
<a href="#l17.66"></a><span id="l17.66" class="difflineminus">-      'enigmailMsgComposeHelper.js: doValidKeysForAllRecipients(): find keys with minTrustLevel=&quot;' +</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineminus">-        minTrustLevel +</span>
<a href="#l17.68"></a><span id="l17.68" class="difflineminus">-        '&quot;\n'</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineminus">-    );</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineminus">-</span>
<a href="#l17.71"></a><span id="l17.71">     let keyMissing;</span>
<a href="#l17.72"></a><span id="l17.72">     let resultingArray = []; // resulting key list (if all valid)</span>
<a href="#l17.73"></a><span id="l17.73">     try {</span>
<a href="#l17.74"></a><span id="l17.74">       // create array of address elements (email or key)</span>
<a href="#l17.75"></a><span id="l17.75">       let addresses = [];</span>
<a href="#l17.76"></a><span id="l17.76">       try {</span>
<a href="#l17.77"></a><span id="l17.77">         addresses = EnigmailFuncs.stripEmail(emailsOrKeys).split(&quot;,&quot;);</span>
<a href="#l17.78"></a><span id="l17.78">       } catch (ex) {}</span>
<a href="#l17.79"></a><span id="l17.79"> </span>
<a href="#l17.80"></a><span id="l17.80">       // resolve all the email addresses if possible:</span>
<a href="#l17.81"></a><span id="l17.81" class="difflineminus">-      keyMissing = EnigmailKeyRing.getValidKeysForAllRecipients(</span>
<a href="#l17.82"></a><span id="l17.82" class="difflineplus">+      keyMissing = await EnigmailKeyRing.getValidKeysForAllRecipients(</span>
<a href="#l17.83"></a><span id="l17.83">         addresses,</span>
<a href="#l17.84"></a><span id="l17.84" class="difflineminus">-        minTrustLevel,</span>
<a href="#l17.85"></a><span id="l17.85">         details,</span>
<a href="#l17.86"></a><span id="l17.86">         resultingArray</span>
<a href="#l17.87"></a><span id="l17.87">       );</span>
<a href="#l17.88"></a><span id="l17.88">     } catch (ex) {</span>
<a href="#l17.89"></a><span id="l17.89">       EnigmailLog.DEBUG(</span>
<a href="#l17.90"></a><span id="l17.90">         &quot;enigmailMsgComposeHelper.js: doValidKeysForAllRecipients(): return null (exception: &quot; +</span>
<a href="#l17.91"></a><span id="l17.91">           ex.message +</span>
<a href="#l17.92"></a><span id="l17.92">           &quot;\n&quot; +</span>
<a href="#l17.93"></a><span id="l17.93" class="difflineat">@@ -140,65 +114,9 @@ Enigmail.hlp = {</span>
<a href="#l17.94"></a><span id="l17.94">     }</span>
<a href="#l17.95"></a><span id="l17.95">     EnigmailLog.DEBUG(</span>
<a href="#l17.96"></a><span id="l17.96">       'enigmailMsgComposeHelper.js: doValidKeysForAllRecipients(): return &quot;' +</span>
<a href="#l17.97"></a><span id="l17.97">         resultingArray +</span>
<a href="#l17.98"></a><span id="l17.98">         '&quot;\n'</span>
<a href="#l17.99"></a><span id="l17.99">     );</span>
<a href="#l17.100"></a><span id="l17.100">     return resultingArray;</span>
<a href="#l17.101"></a><span id="l17.101">   },</span>
<a href="#l17.102"></a><span id="l17.102" class="difflineminus">-</span>
<a href="#l17.103"></a><span id="l17.103" class="difflineminus">-  /**</span>
<a href="#l17.104"></a><span id="l17.104" class="difflineminus">-   * processConflicts</span>
<a href="#l17.105"></a><span id="l17.105" class="difflineminus">-   * - handle sign/encrypt/pgpMime conflicts if any</span>
<a href="#l17.106"></a><span id="l17.106" class="difflineminus">-   * - NOTE: conflicts result into disabling the feature (0/never)</span>
<a href="#l17.107"></a><span id="l17.107" class="difflineminus">-   * Input parameters:</span>
<a href="#l17.108"></a><span id="l17.108" class="difflineminus">-   *  @encrypt: email would currently get encrypted</span>
<a href="#l17.109"></a><span id="l17.109" class="difflineminus">-   *  @sign:    email would currently get signed</span>
<a href="#l17.110"></a><span id="l17.110" class="difflineminus">-   * @return:  false if error occurred or processing was canceled</span>
<a href="#l17.111"></a><span id="l17.111" class="difflineminus">-   */</span>
<a href="#l17.112"></a><span id="l17.112" class="difflineminus">-  processConflicts(encrypt, sign) {</span>
<a href="#l17.113"></a><span id="l17.113" class="difflineminus">-    // process message about whether we still sign/encrypt</span>
<a href="#l17.114"></a><span id="l17.114" class="difflineminus">-    let msg = &quot;&quot;;</span>
<a href="#l17.115"></a><span id="l17.115" class="difflineminus">-    msg +=</span>
<a href="#l17.116"></a><span id="l17.116" class="difflineminus">-      &quot;\n- &quot; + EnigmailLocale.getString(encrypt ? &quot;encryptYes&quot; : &quot;encryptNo&quot;);</span>
<a href="#l17.117"></a><span id="l17.117" class="difflineminus">-    msg += &quot;\n- &quot; + EnigmailLocale.getString(sign ? &quot;signYes&quot; : &quot;signNo&quot;);</span>
<a href="#l17.118"></a><span id="l17.118" class="difflineminus">-    if (EnigmailPrefs.getPref(&quot;warnOnRulesConflict&quot;) == 2) {</span>
<a href="#l17.119"></a><span id="l17.119" class="difflineminus">-      EnigmailPrefs.setPref(&quot;warnOnRulesConflict&quot;, 0);</span>
<a href="#l17.120"></a><span id="l17.120" class="difflineminus">-    }</span>
<a href="#l17.121"></a><span id="l17.121" class="difflineminus">-    if (</span>
<a href="#l17.122"></a><span id="l17.122" class="difflineminus">-      !EnigmailDialog.confirmPref(</span>
<a href="#l17.123"></a><span id="l17.123" class="difflineminus">-        window,</span>
<a href="#l17.124"></a><span id="l17.124" class="difflineminus">-        EnigmailLocale.getString(&quot;rulesConflict&quot;, [msg]),</span>
<a href="#l17.125"></a><span id="l17.125" class="difflineminus">-        &quot;warnOnRulesConflict&quot;</span>
<a href="#l17.126"></a><span id="l17.126" class="difflineminus">-      )</span>
<a href="#l17.127"></a><span id="l17.127" class="difflineminus">-    ) {</span>
<a href="#l17.128"></a><span id="l17.128" class="difflineminus">-      return false;</span>
<a href="#l17.129"></a><span id="l17.129" class="difflineminus">-    }</span>
<a href="#l17.130"></a><span id="l17.130" class="difflineminus">-    return true;</span>
<a href="#l17.131"></a><span id="l17.131" class="difflineminus">-  },</span>
<a href="#l17.132"></a><span id="l17.132" class="difflineminus">-</span>
<a href="#l17.133"></a><span id="l17.133" class="difflineminus">-  /**</span>
<a href="#l17.134"></a><span id="l17.134" class="difflineminus">-   * determine invalid recipients as returned from GnuPG</span>
<a href="#l17.135"></a><span id="l17.135" class="difflineminus">-   *</span>
<a href="#l17.136"></a><span id="l17.136" class="difflineminus">-   * @gpgMsg: output from GnuPG</span>
<a href="#l17.137"></a><span id="l17.137" class="difflineminus">-   *</span>
<a href="#l17.138"></a><span id="l17.138" class="difflineminus">-   * @return: space separated list of invalid addresses</span>
<a href="#l17.139"></a><span id="l17.139" class="difflineminus">-   */</span>
<a href="#l17.140"></a><span id="l17.140" class="difflineminus">-  getInvalidAddress(gpgMsg) {</span>
<a href="#l17.141"></a><span id="l17.141" class="difflineminus">-    EnigmailLog.DEBUG(</span>
<a href="#l17.142"></a><span id="l17.142" class="difflineminus">-      'enigmailMsgComposeHelper.js: getInvalidAddress(): gpgMsg=&quot;' +</span>
<a href="#l17.143"></a><span id="l17.143" class="difflineminus">-        gpgMsg +</span>
<a href="#l17.144"></a><span id="l17.144" class="difflineminus">-        '&quot;\n\n'</span>
<a href="#l17.145"></a><span id="l17.145" class="difflineminus">-    );</span>
<a href="#l17.146"></a><span id="l17.146" class="difflineminus">-    var invalidAddr = [];</span>
<a href="#l17.147"></a><span id="l17.147" class="difflineminus">-    var lines = gpgMsg.split(/[\n\r]+/);</span>
<a href="#l17.148"></a><span id="l17.148" class="difflineminus">-    for (var i = 0; i &lt; lines.length; i++) {</span>
<a href="#l17.149"></a><span id="l17.149" class="difflineminus">-      var m = lines[i].match(/^(INV_RECP \d+ )(.*)$/);</span>
<a href="#l17.150"></a><span id="l17.150" class="difflineminus">-      if (m &amp;&amp; m.length == 3) {</span>
<a href="#l17.151"></a><span id="l17.151" class="difflineminus">-        try {</span>
<a href="#l17.152"></a><span id="l17.152" class="difflineminus">-          invalidAddr.push(EnigmailFuncs.stripEmail(m[2].toLowerCase()));</span>
<a href="#l17.153"></a><span id="l17.153" class="difflineminus">-        } catch (ex) {}</span>
<a href="#l17.154"></a><span id="l17.154" class="difflineminus">-      }</span>
<a href="#l17.155"></a><span id="l17.155" class="difflineminus">-    }</span>
<a href="#l17.156"></a><span id="l17.156" class="difflineminus">-    return invalidAddr.join(&quot; &quot;);</span>
<a href="#l17.157"></a><span id="l17.157" class="difflineminus">-  },</span>
<a href="#l17.158"></a><span id="l17.158"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -7,17 +7,17 @@</span>
<a href="#l18.4"></a><span id="l18.4"> &quot;use strict&quot;;</span>
<a href="#l18.5"></a><span id="l18.5"> </span>
<a href="#l18.6"></a><span id="l18.6"> /*globally available Thunderbird variables/object/functions: */</span>
<a href="#l18.7"></a><span id="l18.7"> /*global gMsgCompose: false, getCurrentIdentity: false, gNotification: false */</span>
<a href="#l18.8"></a><span id="l18.8"> /*global UpdateAttachmentBucket: false, gContentChanged: true */</span>
<a href="#l18.9"></a><span id="l18.9"> /*global AddAttachments: false, AddAttachment: false, ChangeAttachmentBucketVisibility: false, GetResourceFromUri: false */</span>
<a href="#l18.10"></a><span id="l18.10"> /*global Recipients2CompFields: false, Attachments2CompFields: false, DetermineConvertibility: false, gWindowLocked: false */</span>
<a href="#l18.11"></a><span id="l18.11"> /*global CommandUpdate_MsgCompose: false, gSMFields: false, setSecuritySettings: false, getCurrentAccountKey: false */</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-/*global Sendlater3Composing: false, gCurrentIdentity: false */</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+/*global Sendlater3Composing: false, gCurrentIdentity: false, showMessageComposeSecurityStatus: false */</span>
<a href="#l18.14"></a><span id="l18.14"> /*global gSendEncrypted: true, gOptionalEncryption: true, gSendSigned: true, gSelectedTechnologyIsPGP: true */</span>
<a href="#l18.15"></a><span id="l18.15"> /*global gIsRelatedToEncryptedOriginal: true, gIsRelatedToSignedOriginal: true, gAttachMyPublicPGPKey: true */</span>
<a href="#l18.16"></a><span id="l18.16"> </span>
<a href="#l18.17"></a><span id="l18.17"> /* import-globals-from ../BondOpenPGP.jsm */</span>
<a href="#l18.18"></a><span id="l18.18"> </span>
<a href="#l18.19"></a><span id="l18.19"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l18.20"></a><span id="l18.20"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l18.21"></a><span id="l18.21">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineat">@@ -90,16 +90,19 @@ var EnigmailMime = ChromeUtils.import(</span>
<a href="#l18.23"></a><span id="l18.23">   &quot;chrome://openpgp/content/modules/mime.jsm&quot;</span>
<a href="#l18.24"></a><span id="l18.24"> ).EnigmailMime;</span>
<a href="#l18.25"></a><span id="l18.25"> var EnigmailMsgRead = ChromeUtils.import(</span>
<a href="#l18.26"></a><span id="l18.26">   &quot;chrome://openpgp/content/modules/msgRead.jsm&quot;</span>
<a href="#l18.27"></a><span id="l18.27"> ).EnigmailMsgRead;</span>
<a href="#l18.28"></a><span id="l18.28"> var EnigmailMimeEncrypt = ChromeUtils.import(</span>
<a href="#l18.29"></a><span id="l18.29">   &quot;chrome://openpgp/content/modules/mimeEncrypt.jsm&quot;</span>
<a href="#l18.30"></a><span id="l18.30"> ).EnigmailMimeEncrypt;</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineplus">+const { EnigmailCryptoAPI } = ChromeUtils.import(</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineplus">+  &quot;chrome://openpgp/content/modules/cryptoAPI.jsm&quot;</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineplus">+);</span>
<a href="#l18.34"></a><span id="l18.34"> var { jsmime } = ChromeUtils.import(&quot;resource:///modules/jsmime.jsm&quot;);</span>
<a href="#l18.35"></a><span id="l18.35"> </span>
<a href="#l18.36"></a><span id="l18.36"> // Account encryption policy values:</span>
<a href="#l18.37"></a><span id="l18.37"> // const kEncryptionPolicy_Never = 0;</span>
<a href="#l18.38"></a><span id="l18.38"> // 'IfPossible' was used by ns4.</span>
<a href="#l18.39"></a><span id="l18.39"> // const kEncryptionPolicy_IfPossible = 1;</span>
<a href="#l18.40"></a><span id="l18.40"> var kEncryptionPolicy_Always = 2;</span>
<a href="#l18.41"></a><span id="l18.41"> </span>
<a href="#l18.42"></a><span id="l18.42" class="difflineat">@@ -143,17 +146,17 @@ Enigmail.msg = {</span>
<a href="#l18.43"></a><span id="l18.43">   },</span>
<a href="#l18.44"></a><span id="l18.44"> </span>
<a href="#l18.45"></a><span id="l18.45">   keyLookupDone: [],</span>
<a href="#l18.46"></a><span id="l18.46"> </span>
<a href="#l18.47"></a><span id="l18.47">   saveDraftError: 0,</span>
<a href="#l18.48"></a><span id="l18.48">   addrOnChangeTimeout: 250,</span>
<a href="#l18.49"></a><span id="l18.49">   /* timeout when entering something into the address field */</span>
<a href="#l18.50"></a><span id="l18.50"> </span>
<a href="#l18.51"></a><span id="l18.51" class="difflineminus">-  composeStartup() {</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineplus">+  async composeStartup() {</span>
<a href="#l18.53"></a><span id="l18.53">     if (!BondOpenPGP.allDependenciesLoaded()) {</span>
<a href="#l18.54"></a><span id="l18.54">       return;</span>
<a href="#l18.55"></a><span id="l18.55">     }</span>
<a href="#l18.56"></a><span id="l18.56"> </span>
<a href="#l18.57"></a><span id="l18.57">     EnigmailLog.DEBUG(</span>
<a href="#l18.58"></a><span id="l18.58">       &quot;enigmailMsgComposeOverlay.js: Enigmail.msg.composeStartup\n&quot;</span>
<a href="#l18.59"></a><span id="l18.59">     );</span>
<a href="#l18.60"></a><span id="l18.60"> </span>
<a href="#l18.61"></a><span id="l18.61" class="difflineat">@@ -221,17 +224,17 @@ Enigmail.msg = {</span>
<a href="#l18.62"></a><span id="l18.62">     // possible values to check:</span>
<a href="#l18.63"></a><span id="l18.63">     // - Enigmail.msg.wasEnigmailAddOnInstalled()</span>
<a href="#l18.64"></a><span id="l18.64">     // - Enigmail.msg.wasEnigmailEnabledForIdentity</span>
<a href="#l18.65"></a><span id="l18.65">     // - this.identity.getIntAttribute(&quot;mimePreferOpenPGP&quot;) &gt; 0</span>
<a href="#l18.66"></a><span id="l18.66"> </span>
<a href="#l18.67"></a><span id="l18.67">     Enigmail.msg.composeOpen();</span>
<a href="#l18.68"></a><span id="l18.68">     //Enigmail.msg.processFinalState();</span>
<a href="#l18.69"></a><span id="l18.69">     Enigmail.msg.updateStatusBar();</span>
<a href="#l18.70"></a><span id="l18.70" class="difflineminus">-    Enigmail.msg.initialSendFlags();</span>
<a href="#l18.71"></a><span id="l18.71" class="difflineplus">+    await Enigmail.msg.initialSendFlags();</span>
<a href="#l18.72"></a><span id="l18.72"> </span>
<a href="#l18.73"></a><span id="l18.73">     //Enigmail.msg.setFinalSendMode('final-pgpmimeYes');</span>
<a href="#l18.74"></a><span id="l18.74">   },</span>
<a href="#l18.75"></a><span id="l18.75"> </span>
<a href="#l18.76"></a><span id="l18.76">   // TODO: call this from global compose when options change</span>
<a href="#l18.77"></a><span id="l18.77">   enigmailComposeProcessFinalState() {</span>
<a href="#l18.78"></a><span id="l18.78">     //Enigmail.msg.processFinalState();</span>
<a href="#l18.79"></a><span id="l18.79">     Enigmail.msg.updateStatusBar();</span>
<a href="#l18.80"></a><span id="l18.80" class="difflineat">@@ -840,29 +843,29 @@ Enigmail.msg = {</span>
<a href="#l18.81"></a><span id="l18.81">       if (relatedNode.attachment.name.toLowerCase() + &quot;.sig&quot; == findFile) {</span>
<a href="#l18.82"></a><span id="l18.82">         baseAttachment = relatedNode.attachment;</span>
<a href="#l18.83"></a><span id="l18.83">       }</span>
<a href="#l18.84"></a><span id="l18.84">       relatedNode = relatedNode.nextSibling;</span>
<a href="#l18.85"></a><span id="l18.85">     }</span>
<a href="#l18.86"></a><span id="l18.86">     return baseAttachment;</span>
<a href="#l18.87"></a><span id="l18.87">   },</span>
<a href="#l18.88"></a><span id="l18.88"> </span>
<a href="#l18.89"></a><span id="l18.89" class="difflineminus">-  initialSendFlags() {</span>
<a href="#l18.90"></a><span id="l18.90" class="difflineplus">+  async initialSendFlags() {</span>
<a href="#l18.91"></a><span id="l18.91">     EnigmailLog.DEBUG(</span>
<a href="#l18.92"></a><span id="l18.92">       &quot;enigmailMsgComposeOverlay.js: Enigmail.msg.initialSendFlags\n&quot;</span>
<a href="#l18.93"></a><span id="l18.93">     );</span>
<a href="#l18.94"></a><span id="l18.94">     this.fireSendFlags();</span>
<a href="#l18.95"></a><span id="l18.95"> </span>
<a href="#l18.96"></a><span id="l18.96">     EnigmailTimer.setTimeout(</span>
<a href="#l18.97"></a><span id="l18.97" class="difflineminus">-      function() {</span>
<a href="#l18.98"></a><span id="l18.98" class="difflineplus">+      async function() {</span>
<a href="#l18.99"></a><span id="l18.99">         EnigmailLog.DEBUG(</span>
<a href="#l18.100"></a><span id="l18.100">           &quot;enigmailMsgComposeOverlay: re-determine send flags\n&quot;</span>
<a href="#l18.101"></a><span id="l18.101">         );</span>
<a href="#l18.102"></a><span id="l18.102">         try {</span>
<a href="#l18.103"></a><span id="l18.103" class="difflineminus">-          this.determineSendFlags();</span>
<a href="#l18.104"></a><span id="l18.104" class="difflineplus">+          await this.determineSendFlags();</span>
<a href="#l18.105"></a><span id="l18.105">           //this.processFinalState();</span>
<a href="#l18.106"></a><span id="l18.106">           this.updateStatusBar();</span>
<a href="#l18.107"></a><span id="l18.107">         } catch (ex) {</span>
<a href="#l18.108"></a><span id="l18.108">           EnigmailLog.DEBUG(</span>
<a href="#l18.109"></a><span id="l18.109">             &quot;enigmailMsgComposeOverlay: re-determine send flags - ERROR: &quot; +</span>
<a href="#l18.110"></a><span id="l18.110">               ex.toString() +</span>
<a href="#l18.111"></a><span id="l18.111">               &quot;\n&quot;</span>
<a href="#l18.112"></a><span id="l18.112">           );</span>
<a href="#l18.113"></a><span id="l18.113" class="difflineat">@@ -1628,17 +1631,17 @@ Enigmail.msg = {</span>
<a href="#l18.114"></a><span id="l18.114">         if (e) e.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l18.115"></a><span id="l18.115">         if (s) s.setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l18.116"></a><span id="l18.116">         if (e) e.setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l18.117"></a><span id="l18.117">   },</span>
<a href="#l18.118"></a><span id="l18.118">   */</span>
<a href="#l18.119"></a><span id="l18.119"> </span>
<a href="#l18.120"></a><span id="l18.120">   /* check if encryption is possible (have keys for everyone or not)</span>
<a href="#l18.121"></a><span id="l18.121">    */</span>
<a href="#l18.122"></a><span id="l18.122" class="difflineminus">-  determineSendFlags() {</span>
<a href="#l18.123"></a><span id="l18.123" class="difflineplus">+  async determineSendFlags() {</span>
<a href="#l18.124"></a><span id="l18.124">     EnigmailLog.DEBUG(</span>
<a href="#l18.125"></a><span id="l18.125">       &quot;enigmailMsgComposeOverlay.js: Enigmail.msg.focusChange: Enigmail.msg.determineSendFlags\n&quot;</span>
<a href="#l18.126"></a><span id="l18.126">     );</span>
<a href="#l18.127"></a><span id="l18.127"> </span>
<a href="#l18.128"></a><span id="l18.128">     let detailsObj = {};</span>
<a href="#l18.129"></a><span id="l18.129"> </span>
<a href="#l18.130"></a><span id="l18.130">     if (!this.identity) {</span>
<a href="#l18.131"></a><span id="l18.131">       this.identity = getCurrentIdentity();</span>
<a href="#l18.132"></a><span id="l18.132" class="difflineat">@@ -1652,31 +1655,39 @@ Enigmail.msg = {</span>
<a href="#l18.133"></a><span id="l18.133">       ].createInstance(Ci.nsIMsgCompFields);</span>
<a href="#l18.134"></a><span id="l18.134">     }</span>
<a href="#l18.135"></a><span id="l18.135">     Recipients2CompFields(compFields);</span>
<a href="#l18.136"></a><span id="l18.136"> </span>
<a href="#l18.137"></a><span id="l18.137">     // disabled, see bug 1625135</span>
<a href="#l18.138"></a><span id="l18.138">     // gMsgCompose.expandMailingLists();</span>
<a href="#l18.139"></a><span id="l18.139"> </span>
<a href="#l18.140"></a><span id="l18.140">     if (Enigmail.msg.isEnigmailEnabledForIdentity()) {</span>
<a href="#l18.141"></a><span id="l18.141" class="difflineminus">-      // process list of to/cc email addresses</span>
<a href="#l18.142"></a><span id="l18.142" class="difflineminus">-      // - bcc email addresses are ignored, when processing whether to sign/encrypt</span>
<a href="#l18.143"></a><span id="l18.143" class="difflineplus">+      // TODO: use a mechanism that hides the bcc recipients in the</span>
<a href="#l18.144"></a><span id="l18.144" class="difflineplus">+      //       OpenPGG recipient info.</span>
<a href="#l18.145"></a><span id="l18.145">       var toAddrList = [];</span>
<a href="#l18.146"></a><span id="l18.146">       var arrLen = {};</span>
<a href="#l18.147"></a><span id="l18.147">       var recList;</span>
<a href="#l18.148"></a><span id="l18.148" class="difflineminus">-      if (compFields.to.length &gt; 0) {</span>
<a href="#l18.149"></a><span id="l18.149" class="difflineplus">+      if (compFields.to) {</span>
<a href="#l18.150"></a><span id="l18.150">         recList = compFields.splitRecipients(compFields.to, true, arrLen);</span>
<a href="#l18.151"></a><span id="l18.151">         this.addRecipients(toAddrList, recList);</span>
<a href="#l18.152"></a><span id="l18.152">       }</span>
<a href="#l18.153"></a><span id="l18.153" class="difflineminus">-      if (compFields.cc.length &gt; 0) {</span>
<a href="#l18.154"></a><span id="l18.154" class="difflineplus">+      if (compFields.cc) {</span>
<a href="#l18.155"></a><span id="l18.155">         recList = compFields.splitRecipients(compFields.cc, true, arrLen);</span>
<a href="#l18.156"></a><span id="l18.156">         this.addRecipients(toAddrList, recList);</span>
<a href="#l18.157"></a><span id="l18.157">       }</span>
<a href="#l18.158"></a><span id="l18.158" class="difflineminus">-</span>
<a href="#l18.159"></a><span id="l18.159" class="difflineminus">-      Enigmail.hlp.validKeysForAllRecipients(toAddrList.join(&quot;, &quot;), detailsObj);</span>
<a href="#l18.160"></a><span id="l18.160" class="difflineplus">+      if (compFields.bcc) {</span>
<a href="#l18.161"></a><span id="l18.161" class="difflineplus">+        recList = compFields.splitRecipients(compFields.bcc, true, arrLen);</span>
<a href="#l18.162"></a><span id="l18.162" class="difflineplus">+        this.addRecipients(toAddrList, recList);</span>
<a href="#l18.163"></a><span id="l18.163" class="difflineplus">+      }</span>
<a href="#l18.164"></a><span id="l18.164" class="difflineplus">+</span>
<a href="#l18.165"></a><span id="l18.165" class="difflineplus">+      // We don't need the returned array of valid keys</span>
<a href="#l18.166"></a><span id="l18.166" class="difflineplus">+      await Enigmail.hlp.validKeysForAllRecipients(</span>
<a href="#l18.167"></a><span id="l18.167" class="difflineplus">+        toAddrList.join(&quot;, &quot;),</span>
<a href="#l18.168"></a><span id="l18.168" class="difflineplus">+        detailsObj</span>
<a href="#l18.169"></a><span id="l18.169" class="difflineplus">+      );</span>
<a href="#l18.170"></a><span id="l18.170">       //this.autoPgpEncryption = (validKeyList !== null);</span>
<a href="#l18.171"></a><span id="l18.171">     }</span>
<a href="#l18.172"></a><span id="l18.172"> </span>
<a href="#l18.173"></a><span id="l18.173">     // process and signal new resulting state</span>
<a href="#l18.174"></a><span id="l18.174">     //this.processFinalState();</span>
<a href="#l18.175"></a><span id="l18.175">     this.updateStatusBar();</span>
<a href="#l18.176"></a><span id="l18.176"> </span>
<a href="#l18.177"></a><span id="l18.177">     return detailsObj;</span>
<a href="#l18.178"></a><span id="l18.178" class="difflineat">@@ -1751,96 +1762,16 @@ Enigmail.msg = {</span>
<a href="#l18.179"></a><span id="l18.179">     */</span>
<a href="#l18.180"></a><span id="l18.180">   },</span>
<a href="#l18.181"></a><span id="l18.181"> </span>
<a href="#l18.182"></a><span id="l18.182">   getSenderUserId() {</span>
<a href="#l18.183"></a><span id="l18.183">     let keyId = this.identity.getUnicharAttribute(&quot;openpgp_key_id&quot;);</span>
<a href="#l18.184"></a><span id="l18.184">     return &quot;0x&quot; + keyId;</span>
<a href="#l18.185"></a><span id="l18.185">   },</span>
<a href="#l18.186"></a><span id="l18.186"> </span>
<a href="#l18.187"></a><span id="l18.187" class="difflineminus">-  /* process rules and find keys for passed email addresses</span>
<a href="#l18.188"></a><span id="l18.188" class="difflineminus">-   * This is THE core method to prepare sending encryptes emails.</span>
<a href="#l18.189"></a><span id="l18.189" class="difflineminus">-   * - it processes the recipient rules (if not disabled)</span>
<a href="#l18.190"></a><span id="l18.190" class="difflineminus">-   * - it</span>
<a href="#l18.191"></a><span id="l18.191" class="difflineminus">-   *</span>
<a href="#l18.192"></a><span id="l18.192" class="difflineminus">-   * @sendFlags:    Longint - all current combined/processed send flags (incl. optSendFlags)</span>
<a href="#l18.193"></a><span id="l18.193" class="difflineminus">-   * @optSendFlags: Longint - may only be SEND_ALWAYS_TRUST or SEND_ENCRYPT_TO_SELF</span>
<a href="#l18.194"></a><span id="l18.194" class="difflineminus">-   * @fromAddr:     String - from email</span>
<a href="#l18.195"></a><span id="l18.195" class="difflineminus">-   * @toAddrList:   Array  - both to and cc receivers</span>
<a href="#l18.196"></a><span id="l18.196" class="difflineminus">-   * @bccAddrList:  Array  - bcc receivers</span>
<a href="#l18.197"></a><span id="l18.197" class="difflineminus">-   * @return:       Object:</span>
<a href="#l18.198"></a><span id="l18.198" class="difflineminus">-   *                - sendFlags (Longint)</span>
<a href="#l18.199"></a><span id="l18.199" class="difflineminus">-   *                - toAddrStr  comma separated string of unprocessed to/cc emails</span>
<a href="#l18.200"></a><span id="l18.200" class="difflineminus">-   *                - bccAddrStr comma separated string of unprocessed to/cc emails</span>
<a href="#l18.201"></a><span id="l18.201" class="difflineminus">-   *                or null (cancel sending the email)</span>
<a href="#l18.202"></a><span id="l18.202" class="difflineminus">-   */</span>
<a href="#l18.203"></a><span id="l18.203" class="difflineminus">-  keySelection(</span>
<a href="#l18.204"></a><span id="l18.204" class="difflineminus">-    enigmailSvc,</span>
<a href="#l18.205"></a><span id="l18.205" class="difflineminus">-    sendFlags,</span>
<a href="#l18.206"></a><span id="l18.206" class="difflineminus">-    optSendFlags,</span>
<a href="#l18.207"></a><span id="l18.207" class="difflineminus">-    fromAddr,</span>
<a href="#l18.208"></a><span id="l18.208" class="difflineminus">-    toAddrList,</span>
<a href="#l18.209"></a><span id="l18.209" class="difflineminus">-    bccAddrList</span>
<a href="#l18.210"></a><span id="l18.210" class="difflineminus">-  ) {</span>
<a href="#l18.211"></a><span id="l18.211" class="difflineminus">-    EnigmailLog.DEBUG(&quot;=====&gt; keySelection()\n&quot;);</span>
<a href="#l18.212"></a><span id="l18.212" class="difflineminus">-    EnigmailLog.DEBUG(</span>
<a href="#l18.213"></a><span id="l18.213" class="difflineminus">-      &quot;enigmailMsgComposeOverlay.js: Enigmail.msg.keySelection()\n&quot;</span>
<a href="#l18.214"></a><span id="l18.214" class="difflineminus">-    );</span>
<a href="#l18.215"></a><span id="l18.215" class="difflineminus">-</span>
<a href="#l18.216"></a><span id="l18.216" class="difflineminus">-    let toAddrStr = toAddrList.join(&quot;, &quot;);</span>
<a href="#l18.217"></a><span id="l18.217" class="difflineminus">-    let bccAddrStr = bccAddrList.join(&quot;, &quot;);</span>
<a href="#l18.218"></a><span id="l18.218" class="difflineminus">-    let keyMap = {};</span>
<a href="#l18.219"></a><span id="l18.219" class="difflineminus">-</span>
<a href="#l18.220"></a><span id="l18.220" class="difflineminus">-    // NOTE: If we only have bcc addresses, we currently do NOT process rules and select keys at all</span>
<a href="#l18.221"></a><span id="l18.221" class="difflineminus">-    //       This is GOOD because sending keys for bcc addresses makes bcc addresses visible</span>
<a href="#l18.222"></a><span id="l18.222" class="difflineminus">-    //       (thus compromising the concept of bcc)</span>
<a href="#l18.223"></a><span id="l18.223" class="difflineminus">-    //       THUS, we disable encryption even though all bcc receivers might want to have it encrypted.</span>
<a href="#l18.224"></a><span id="l18.224" class="difflineminus">-    if (toAddrStr.length === 0) {</span>
<a href="#l18.225"></a><span id="l18.225" class="difflineminus">-      EnigmailLog.DEBUG(</span>
<a href="#l18.226"></a><span id="l18.226" class="difflineminus">-        'enigmailMsgComposeOverlay.js: Enigmail.msg.keySelection(): skip key selection because we neither have &quot;to&quot; nor &quot;cc&quot; addresses\n'</span>
<a href="#l18.227"></a><span id="l18.227" class="difflineminus">-      );</span>
<a href="#l18.228"></a><span id="l18.228" class="difflineminus">-</span>
<a href="#l18.229"></a><span id="l18.229" class="difflineminus">-      //sendFlags |= EnigmailConstants.SEND_PGP_MIME;</span>
<a href="#l18.230"></a><span id="l18.230" class="difflineminus">-      //sendFlags &amp;= ~EnigmailConstants.SEND_PGP_MIME;</span>
<a href="#l18.231"></a><span id="l18.231" class="difflineminus">-</span>
<a href="#l18.232"></a><span id="l18.232" class="difflineminus">-      return {</span>
<a href="#l18.233"></a><span id="l18.233" class="difflineminus">-        sendFlags,</span>
<a href="#l18.234"></a><span id="l18.234" class="difflineminus">-        toAddrStr,</span>
<a href="#l18.235"></a><span id="l18.235" class="difflineminus">-        bccAddrStr,</span>
<a href="#l18.236"></a><span id="l18.236" class="difflineminus">-        keyMap,</span>
<a href="#l18.237"></a><span id="l18.237" class="difflineminus">-      };</span>
<a href="#l18.238"></a><span id="l18.238" class="difflineminus">-    }</span>
<a href="#l18.239"></a><span id="l18.239" class="difflineminus">-</span>
<a href="#l18.240"></a><span id="l18.240" class="difflineminus">-    EnigmailLog.DEBUG(</span>
<a href="#l18.241"></a><span id="l18.241" class="difflineminus">-      'enigmailMsgComposeOverlay.js: Enigmail.msg.keySelection(): toAddrStr=&quot;' +</span>
<a href="#l18.242"></a><span id="l18.242" class="difflineminus">-        toAddrStr +</span>
<a href="#l18.243"></a><span id="l18.243" class="difflineminus">-        '&quot; bccAddrStr=&quot;' +</span>
<a href="#l18.244"></a><span id="l18.244" class="difflineminus">-        bccAddrStr +</span>
<a href="#l18.245"></a><span id="l18.245" class="difflineminus">-        '&quot;\n'</span>
<a href="#l18.246"></a><span id="l18.246" class="difflineminus">-    );</span>
<a href="#l18.247"></a><span id="l18.247" class="difflineminus">-</span>
<a href="#l18.248"></a><span id="l18.248" class="difflineminus">-    // REPEAT 1 or 2 times:</span>
<a href="#l18.249"></a><span id="l18.249" class="difflineminus">-    // NOTE: The only way to call this loop twice is to come to the &quot;continue;&quot; statement below,</span>
<a href="#l18.250"></a><span id="l18.250" class="difflineminus">-    //       which forces a second iteration (with forceRecipientSettings==true)</span>
<a href="#l18.251"></a><span id="l18.251" class="difflineminus">-    EnigmailLog.DEBUG(</span>
<a href="#l18.252"></a><span id="l18.252" class="difflineminus">-      'enigmailMsgComposeOverlay.js: Enigmail.msg.keySelection(): return toAddrStr=&quot;' +</span>
<a href="#l18.253"></a><span id="l18.253" class="difflineminus">-        toAddrStr +</span>
<a href="#l18.254"></a><span id="l18.254" class="difflineminus">-        '&quot; bccAddrStr=&quot;' +</span>
<a href="#l18.255"></a><span id="l18.255" class="difflineminus">-        bccAddrStr +</span>
<a href="#l18.256"></a><span id="l18.256" class="difflineminus">-        '&quot;\n'</span>
<a href="#l18.257"></a><span id="l18.257" class="difflineminus">-    );</span>
<a href="#l18.258"></a><span id="l18.258" class="difflineminus">-    EnigmailLog.DEBUG(&quot;  &lt;=== keySelection()\n&quot;);</span>
<a href="#l18.259"></a><span id="l18.259" class="difflineminus">-    return {</span>
<a href="#l18.260"></a><span id="l18.260" class="difflineminus">-      sendFlags,</span>
<a href="#l18.261"></a><span id="l18.261" class="difflineminus">-      toAddrStr,</span>
<a href="#l18.262"></a><span id="l18.262" class="difflineminus">-      bccAddrStr,</span>
<a href="#l18.263"></a><span id="l18.263" class="difflineminus">-      keyMap,</span>
<a href="#l18.264"></a><span id="l18.264" class="difflineminus">-    };</span>
<a href="#l18.265"></a><span id="l18.265" class="difflineminus">-  },</span>
<a href="#l18.266"></a><span id="l18.266" class="difflineminus">-</span>
<a href="#l18.267"></a><span id="l18.267">   /**</span>
<a href="#l18.268"></a><span id="l18.268">    * Determine if S/MIME or OpenPGP should be used</span>
<a href="#l18.269"></a><span id="l18.269">    *</span>
<a href="#l18.270"></a><span id="l18.270">    * @param sendFlags: Number - input send flags.</span>
<a href="#l18.271"></a><span id="l18.271">    *</span>
<a href="#l18.272"></a><span id="l18.272">    * @return: Boolean:</span>
<a href="#l18.273"></a><span id="l18.273">    *   1: use OpenPGP</span>
<a href="#l18.274"></a><span id="l18.274">    *   0: use S/MIME</span>
<a href="#l18.275"></a><span id="l18.275" class="difflineat">@@ -2491,17 +2422,17 @@ Enigmail.msg = {</span>
<a href="#l18.276"></a><span id="l18.276">     EnigmailLog.DEBUG(</span>
<a href="#l18.277"></a><span id="l18.277">       &quot;enigmailMsgComposeOverlay.js: Enigmail.msg.prepareSecurityInfo: securityInfo = &quot; +</span>
<a href="#l18.278"></a><span id="l18.278">         newSecurityInfo +</span>
<a href="#l18.279"></a><span id="l18.279">         &quot;\n&quot;</span>
<a href="#l18.280"></a><span id="l18.280">     );</span>
<a href="#l18.281"></a><span id="l18.281">     return newSecurityInfo;</span>
<a href="#l18.282"></a><span id="l18.282">   },</span>
<a href="#l18.283"></a><span id="l18.283"> </span>
<a href="#l18.284"></a><span id="l18.284" class="difflineminus">-  encryptMsg(msgSendType) {</span>
<a href="#l18.285"></a><span id="l18.285" class="difflineplus">+  async encryptMsg(msgSendType) {</span>
<a href="#l18.286"></a><span id="l18.286">     // msgSendType: value from nsIMsgCompDeliverMode</span>
<a href="#l18.287"></a><span id="l18.287">     EnigmailLog.DEBUG(</span>
<a href="#l18.288"></a><span id="l18.288">       &quot;enigmailMsgComposeOverlay.js: Enigmail.msg.encryptMsg: msgSendType=&quot; +</span>
<a href="#l18.289"></a><span id="l18.289">         msgSendType +</span>
<a href="#l18.290"></a><span id="l18.290">         &quot;, gSendSigned=&quot; +</span>
<a href="#l18.291"></a><span id="l18.291">         gSendSigned +</span>
<a href="#l18.292"></a><span id="l18.292">         &quot;, gSendEncrypted=&quot; +</span>
<a href="#l18.293"></a><span id="l18.293">         gSendEncrypted +</span>
<a href="#l18.294"></a><span id="l18.294" class="difflineat">@@ -2544,78 +2475,85 @@ Enigmail.msg = {</span>
<a href="#l18.295"></a><span id="l18.295">     ) {</span>
<a href="#l18.296"></a><span id="l18.296">       // don't attempt to send message if no recipient specified</span>
<a href="#l18.297"></a><span id="l18.297">       var bundle = document.getElementById(&quot;bundle_composeMsgs&quot;);</span>
<a href="#l18.298"></a><span id="l18.298">       EnigmailDialog.alert(window, bundle.getString(&quot;12511&quot;));</span>
<a href="#l18.299"></a><span id="l18.299">       return false;</span>
<a href="#l18.300"></a><span id="l18.300">     }</span>
<a href="#l18.301"></a><span id="l18.301"> </span>
<a href="#l18.302"></a><span id="l18.302">     this.identity = getCurrentIdentity();</span>
<a href="#l18.303"></a><span id="l18.303" class="difflineplus">+    let senderKeyId = this.identity.getUnicharAttribute(&quot;openpgp_key_id&quot;);</span>
<a href="#l18.304"></a><span id="l18.304" class="difflineplus">+</span>
<a href="#l18.305"></a><span id="l18.305" class="difflineplus">+    let senderKeyUsable = EnigmailEncryption.determineOwnKeyUsability(</span>
<a href="#l18.306"></a><span id="l18.306" class="difflineplus">+      sendFlags,</span>
<a href="#l18.307"></a><span id="l18.307" class="difflineplus">+      senderKeyId</span>
<a href="#l18.308"></a><span id="l18.308" class="difflineplus">+    );</span>
<a href="#l18.309"></a><span id="l18.309" class="difflineplus">+    if (senderKeyUsable.errorMsg) {</span>
<a href="#l18.310"></a><span id="l18.310" class="difflineplus">+      let fullAlert = EnigmailLocale.getString(&quot;cannotUseOwnKeyBecause&quot;, [</span>
<a href="#l18.311"></a><span id="l18.311" class="difflineplus">+        senderKeyUsable.errorMsg,</span>
<a href="#l18.312"></a><span id="l18.312" class="difflineplus">+      ]);</span>
<a href="#l18.313"></a><span id="l18.313" class="difflineplus">+</span>
<a href="#l18.314"></a><span id="l18.314" class="difflineplus">+      EnigmailDialog.alert(window, fullAlert);</span>
<a href="#l18.315"></a><span id="l18.315" class="difflineplus">+      return false;</span>
<a href="#l18.316"></a><span id="l18.316" class="difflineplus">+    }</span>
<a href="#l18.317"></a><span id="l18.317" class="difflineplus">+</span>
<a href="#l18.318"></a><span id="l18.318" class="difflineplus">+    if (gSendEncrypted) {</span>
<a href="#l18.319"></a><span id="l18.319" class="difflineplus">+      let canEncryptDetails = await this.determineSendFlags();</span>
<a href="#l18.320"></a><span id="l18.320" class="difflineplus">+      if (canEncryptDetails.errArray.length != 0) {</span>
<a href="#l18.321"></a><span id="l18.321" class="difflineplus">+        let isFirst = true;</span>
<a href="#l18.322"></a><span id="l18.322" class="difflineplus">+        let allProblems = &quot;&quot;;</span>
<a href="#l18.323"></a><span id="l18.323" class="difflineplus">+        for (let obj of canEncryptDetails.errArray) {</span>
<a href="#l18.324"></a><span id="l18.324" class="difflineplus">+          if (isFirst) {</span>
<a href="#l18.325"></a><span id="l18.325" class="difflineplus">+            isFirst = false;</span>
<a href="#l18.326"></a><span id="l18.326" class="difflineplus">+          } else {</span>
<a href="#l18.327"></a><span id="l18.327" class="difflineplus">+            allProblems += &quot;, &quot;;</span>
<a href="#l18.328"></a><span id="l18.328" class="difflineplus">+          }</span>
<a href="#l18.329"></a><span id="l18.329" class="difflineplus">+          allProblems += obj.addr;</span>
<a href="#l18.330"></a><span id="l18.330" class="difflineplus">+        }</span>
<a href="#l18.331"></a><span id="l18.331" class="difflineplus">+</span>
<a href="#l18.332"></a><span id="l18.332" class="difflineplus">+        let fullAlert = EnigmailLocale.getString(</span>
<a href="#l18.333"></a><span id="l18.333" class="difflineplus">+          &quot;cannotEncryptBecauseMissing&quot;,</span>
<a href="#l18.334"></a><span id="l18.334" class="difflineplus">+          [allProblems]</span>
<a href="#l18.335"></a><span id="l18.335" class="difflineplus">+        );</span>
<a href="#l18.336"></a><span id="l18.336" class="difflineplus">+</span>
<a href="#l18.337"></a><span id="l18.337" class="difflineplus">+        EnigmailDialog.alert(window, fullAlert);</span>
<a href="#l18.338"></a><span id="l18.338" class="difflineplus">+        showMessageComposeSecurityStatus();</span>
<a href="#l18.339"></a><span id="l18.339" class="difflineplus">+        return false;</span>
<a href="#l18.340"></a><span id="l18.340" class="difflineplus">+      }</span>
<a href="#l18.341"></a><span id="l18.341" class="difflineplus">+    }</span>
<a href="#l18.342"></a><span id="l18.342"> </span>
<a href="#l18.343"></a><span id="l18.343">     if (gWindowLocked) {</span>
<a href="#l18.344"></a><span id="l18.344">       EnigmailDialog.alert(window, EnigmailLocale.getString(&quot;windowLocked&quot;));</span>
<a href="#l18.345"></a><span id="l18.345">       return false;</span>
<a href="#l18.346"></a><span id="l18.346">     }</span>
<a href="#l18.347"></a><span id="l18.347"> </span>
<a href="#l18.348"></a><span id="l18.348">     let newSecurityInfo = this.resetDirty();</span>
<a href="#l18.349"></a><span id="l18.349">     this.dirty = 1;</span>
<a href="#l18.350"></a><span id="l18.350"> </span>
<a href="#l18.351"></a><span id="l18.351" class="difflineminus">-    let enigmailSvc = EnigmailCore.getService(window);</span>
<a href="#l18.352"></a><span id="l18.352" class="difflineminus">-    if (!enigmailSvc) {</span>
<a href="#l18.353"></a><span id="l18.353" class="difflineminus">-      var msg = EnigmailLocale.getString(&quot;sendUnencrypted&quot;);</span>
<a href="#l18.354"></a><span id="l18.354" class="difflineminus">-      if (</span>
<a href="#l18.355"></a><span id="l18.355" class="difflineminus">-        EnigmailCore.getEnigmailService() &amp;&amp;</span>
<a href="#l18.356"></a><span id="l18.356" class="difflineminus">-        EnigmailCore.getEnigmailService().initializationError</span>
<a href="#l18.357"></a><span id="l18.357" class="difflineminus">-      ) {</span>
<a href="#l18.358"></a><span id="l18.358" class="difflineminus">-        msg =</span>
<a href="#l18.359"></a><span id="l18.359" class="difflineminus">-          EnigmailCore.getEnigmailService().initializationError + &quot;\n\n&quot; + msg;</span>
<a href="#l18.360"></a><span id="l18.360" class="difflineminus">-      }</span>
<a href="#l18.361"></a><span id="l18.361" class="difflineminus">-</span>
<a href="#l18.362"></a><span id="l18.362" class="difflineminus">-      return EnigmailDialog.confirmDlg(</span>
<a href="#l18.363"></a><span id="l18.363" class="difflineminus">-        window,</span>
<a href="#l18.364"></a><span id="l18.364" class="difflineminus">-        msg,</span>
<a href="#l18.365"></a><span id="l18.365" class="difflineminus">-        EnigmailLocale.getString(&quot;msgCompose.button.send&quot;)</span>
<a href="#l18.366"></a><span id="l18.366" class="difflineminus">-      );</span>
<a href="#l18.367"></a><span id="l18.367" class="difflineminus">-    }</span>
<a href="#l18.368"></a><span id="l18.368" class="difflineminus">-</span>
<a href="#l18.369"></a><span id="l18.369">     try {</span>
<a href="#l18.370"></a><span id="l18.370">       this.modifiedAttach = null;</span>
<a href="#l18.371"></a><span id="l18.371"> </span>
<a href="#l18.372"></a><span id="l18.372">       // fill fromAddr, toAddrList, bcc etc</span>
<a href="#l18.373"></a><span id="l18.373">       let rcpt = this.determineMsgRecipients(sendFlags);</span>
<a href="#l18.374"></a><span id="l18.374">       if (typeof rcpt === &quot;boolean&quot;) {</span>
<a href="#l18.375"></a><span id="l18.375">         return rcpt;</span>
<a href="#l18.376"></a><span id="l18.376">       }</span>
<a href="#l18.377"></a><span id="l18.377">       sendFlags = rcpt.sendFlags;</span>
<a href="#l18.378"></a><span id="l18.378"> </span>
<a href="#l18.379"></a><span id="l18.379">       if (this.sendPgpMime) {</span>
<a href="#l18.380"></a><span id="l18.380">         // Use PGP/MIME</span>
<a href="#l18.381"></a><span id="l18.381">         sendFlags |= EnigmailConstants.SEND_PGP_MIME;</span>
<a href="#l18.382"></a><span id="l18.382">       }</span>
<a href="#l18.383"></a><span id="l18.383"> </span>
<a href="#l18.384"></a><span id="l18.384" class="difflineminus">-      let result = this.keySelection(</span>
<a href="#l18.385"></a><span id="l18.385" class="difflineminus">-        enigmailSvc,</span>
<a href="#l18.386"></a><span id="l18.386" class="difflineminus">-        sendFlags, // all current combined/processed send flags (incl. optSendFlags)</span>
<a href="#l18.387"></a><span id="l18.387" class="difflineminus">-        rcpt.optSendFlags, // may only be SEND_ALWAYS_TRUST or SEND_ENCRYPT_TO_SELF</span>
<a href="#l18.388"></a><span id="l18.388" class="difflineminus">-        rcpt.fromAddr,</span>
<a href="#l18.389"></a><span id="l18.389" class="difflineminus">-        rcpt.toAddrList,</span>
<a href="#l18.390"></a><span id="l18.390" class="difflineminus">-        rcpt.bccAddrList</span>
<a href="#l18.391"></a><span id="l18.391" class="difflineminus">-      );</span>
<a href="#l18.392"></a><span id="l18.392" class="difflineminus">-      if (!result) {</span>
<a href="#l18.393"></a><span id="l18.393" class="difflineminus">-        return false;</span>
<a href="#l18.394"></a><span id="l18.394" class="difflineminus">-      }</span>
<a href="#l18.395"></a><span id="l18.395" class="difflineminus">-</span>
<a href="#l18.396"></a><span id="l18.396" class="difflineminus">-      sendFlags = result.sendFlags;</span>
<a href="#l18.397"></a><span id="l18.397" class="difflineminus">-      let toAddrStr = result.toAddrStr;</span>
<a href="#l18.398"></a><span id="l18.398" class="difflineminus">-      let bccAddrStr = result.bccAddrStr;</span>
<a href="#l18.399"></a><span id="l18.399" class="difflineminus">-      let keyMap = result.keyMap;</span>
<a href="#l18.400"></a><span id="l18.400" class="difflineplus">+      let toAddrStr = rcpt.toAddrList.join(&quot;, &quot;);</span>
<a href="#l18.401"></a><span id="l18.401" class="difflineplus">+      let bccAddrStr = rcpt.bccAddrList.join(&quot;, &quot;);</span>
<a href="#l18.402"></a><span id="l18.402" class="difflineplus">+      let keyMap = {};</span>
<a href="#l18.403"></a><span id="l18.403"> </span>
<a href="#l18.404"></a><span id="l18.404">       if (gAttachMyPublicPGPKey) {</span>
<a href="#l18.405"></a><span id="l18.405" class="difflineminus">-        let keyId = this.identity.getUnicharAttribute(&quot;openpgp_key_id&quot;);</span>
<a href="#l18.406"></a><span id="l18.406" class="difflineminus">-        this.attachOwnKey(keyId);</span>
<a href="#l18.407"></a><span id="l18.407" class="difflineplus">+        this.attachOwnKey(senderKeyId);</span>
<a href="#l18.408"></a><span id="l18.408">       }</span>
<a href="#l18.409"></a><span id="l18.409"> </span>
<a href="#l18.410"></a><span id="l18.410">       /*</span>
<a href="#l18.411"></a><span id="l18.411">       if (this.preferPgpOverSmime(sendFlags) === 0) {</span>
<a href="#l18.412"></a><span id="l18.412">         // use S/MIME</span>
<a href="#l18.413"></a><span id="l18.413">         Attachments2CompFields(gMsgCompose.compFields); // update list of attachments</span>
<a href="#l18.414"></a><span id="l18.414">         sendFlags = 0;</span>
<a href="#l18.415"></a><span id="l18.415">         return true;</span>
<a href="#l18.416"></a><span id="l18.416" class="difflineat">@@ -2720,28 +2658,17 @@ Enigmail.msg = {</span>
<a href="#l18.417"></a><span id="l18.417">           }</span>
<a href="#l18.418"></a><span id="l18.418">         }</span>
<a href="#l18.419"></a><span id="l18.419">       }</span>
<a href="#l18.420"></a><span id="l18.420">     } catch (ex) {</span>
<a href="#l18.421"></a><span id="l18.421">       EnigmailLog.writeException(</span>
<a href="#l18.422"></a><span id="l18.422">         &quot;enigmailMsgComposeOverlay.js: Enigmail.msg.encryptMsg&quot;,</span>
<a href="#l18.423"></a><span id="l18.423">         ex</span>
<a href="#l18.424"></a><span id="l18.424">       );</span>
<a href="#l18.425"></a><span id="l18.425" class="difflineminus">-      let msg = EnigmailLocale.getString(&quot;signFailed&quot;);</span>
<a href="#l18.426"></a><span id="l18.426" class="difflineminus">-      if (</span>
<a href="#l18.427"></a><span id="l18.427" class="difflineminus">-        EnigmailCore.getEnigmailService() &amp;&amp;</span>
<a href="#l18.428"></a><span id="l18.428" class="difflineminus">-        EnigmailCore.getEnigmailService().initializationError</span>
<a href="#l18.429"></a><span id="l18.429" class="difflineminus">-      ) {</span>
<a href="#l18.430"></a><span id="l18.430" class="difflineminus">-        msg += &quot;\n&quot; + EnigmailCore.getEnigmailService().initializationError;</span>
<a href="#l18.431"></a><span id="l18.431" class="difflineminus">-      }</span>
<a href="#l18.432"></a><span id="l18.432" class="difflineminus">-      return EnigmailDialog.confirmDlg(</span>
<a href="#l18.433"></a><span id="l18.433" class="difflineminus">-        window,</span>
<a href="#l18.434"></a><span id="l18.434" class="difflineminus">-        msg,</span>
<a href="#l18.435"></a><span id="l18.435" class="difflineminus">-        EnigmailLocale.getString(&quot;msgCompose.button.sendUnencrypted&quot;)</span>
<a href="#l18.436"></a><span id="l18.436" class="difflineminus">-      );</span>
<a href="#l18.437"></a><span id="l18.437" class="difflineplus">+      return false;</span>
<a href="#l18.438"></a><span id="l18.438">     }</span>
<a href="#l18.439"></a><span id="l18.439"> </span>
<a href="#l18.440"></a><span id="l18.440">     // The encryption process for PGP/MIME messages follows &quot;here&quot;. It's</span>
<a href="#l18.441"></a><span id="l18.441">     // called automatically from nsMsgCompose-&gt;sendMsg().</span>
<a href="#l18.442"></a><span id="l18.442">     // registration for this is done in core.jsm: startup()</span>
<a href="#l18.443"></a><span id="l18.443"> </span>
<a href="#l18.444"></a><span id="l18.444">     return true;</span>
<a href="#l18.445"></a><span id="l18.445">   },</span>
<a href="#l18.446"></a><span id="l18.446" class="difflineat">@@ -3286,17 +3213,20 @@ Enigmail.msg = {</span>
<a href="#l18.447"></a><span id="l18.447">       sendMsgType != Ci.nsIMsgCompDeliverMode.AutoSaveAsDraft</span>
<a href="#l18.448"></a><span id="l18.448">     ) {</span>
<a href="#l18.449"></a><span id="l18.449">       this.sendProcess = true;</span>
<a href="#l18.450"></a><span id="l18.450">       //let bc = document.getElementById(&quot;enigmail-bc-sendprocess&quot;);</span>
<a href="#l18.451"></a><span id="l18.451"> </span>
<a href="#l18.452"></a><span id="l18.452">       try {</span>
<a href="#l18.453"></a><span id="l18.453">         this.modifyCompFields();</span>
<a href="#l18.454"></a><span id="l18.454">         //bc.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l18.455"></a><span id="l18.455" class="difflineminus">-        if (!this.encryptMsg(sendMsgType)) {</span>
<a href="#l18.456"></a><span id="l18.456" class="difflineplus">+</span>
<a href="#l18.457"></a><span id="l18.457" class="difflineplus">+        const cApi = EnigmailCryptoAPI();</span>
<a href="#l18.458"></a><span id="l18.458" class="difflineplus">+        let encryptResult = cApi.sync(this.encryptMsg(sendMsgType));</span>
<a href="#l18.459"></a><span id="l18.459" class="difflineplus">+        if (!encryptResult) {</span>
<a href="#l18.460"></a><span id="l18.460">           this.resetUpdatedFields();</span>
<a href="#l18.461"></a><span id="l18.461">           event.preventDefault();</span>
<a href="#l18.462"></a><span id="l18.462">           event.stopPropagation();</span>
<a href="#l18.463"></a><span id="l18.463">         }</span>
<a href="#l18.464"></a><span id="l18.464">       } catch (ex) {</span>
<a href="#l18.465"></a><span id="l18.465">         console.debug(ex);</span>
<a href="#l18.466"></a><span id="l18.466">       }</span>
<a href="#l18.467"></a><span id="l18.467">       //bc.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l18.468"></a><span id="l18.468" class="difflineat">@@ -3844,54 +3774,52 @@ Enigmail.msg = {</span>
<a href="#l18.469"></a><span id="l18.469"> </span>
<a href="#l18.470"></a><span id="l18.470">   addrOnChangeTimer: null,</span>
<a href="#l18.471"></a><span id="l18.471"> </span>
<a href="#l18.472"></a><span id="l18.472">   addressOnChange() {</span>
<a href="#l18.473"></a><span id="l18.473">     EnigmailLog.DEBUG(</span>
<a href="#l18.474"></a><span id="l18.474">       &quot;enigmailMsgComposeOverlay.js: Enigmail.msg.addressOnChange\n&quot;</span>
<a href="#l18.475"></a><span id="l18.475">     );</span>
<a href="#l18.476"></a><span id="l18.476">     if (!this.addrOnChangeTimer) {</span>
<a href="#l18.477"></a><span id="l18.477" class="difflineminus">-      var self = this;</span>
<a href="#l18.478"></a><span id="l18.478" class="difflineminus">-      this.addrOnChangeTimer = EnigmailTimer.setTimeout(function() {</span>
<a href="#l18.479"></a><span id="l18.479" class="difflineminus">-        self.fireSendFlags();</span>
<a href="#l18.480"></a><span id="l18.480" class="difflineminus">-        self.addrOnChangeTimer = null;</span>
<a href="#l18.481"></a><span id="l18.481" class="difflineplus">+      this.addrOnChangeTimer = EnigmailTimer.setTimeout(async () =&gt; {</span>
<a href="#l18.482"></a><span id="l18.482" class="difflineplus">+        await this.fireSendFlags();</span>
<a href="#l18.483"></a><span id="l18.483" class="difflineplus">+        this.addrOnChangeTimer = null;</span>
<a href="#l18.484"></a><span id="l18.484">       }, Enigmail.msg.addrOnChangeTimeout);</span>
<a href="#l18.485"></a><span id="l18.485">     }</span>
<a href="#l18.486"></a><span id="l18.486">   },</span>
<a href="#l18.487"></a><span id="l18.487"> </span>
<a href="#l18.488"></a><span id="l18.488" class="difflineminus">-  focusChange() {</span>
<a href="#l18.489"></a><span id="l18.489" class="difflineplus">+  async focusChange() {</span>
<a href="#l18.490"></a><span id="l18.490">     // call original TB function</span>
<a href="#l18.491"></a><span id="l18.491">     CommandUpdate_MsgCompose();</span>
<a href="#l18.492"></a><span id="l18.492"> </span>
<a href="#l18.493"></a><span id="l18.493">     var focusedWindow = top.document.commandDispatcher.focusedWindow;</span>
<a href="#l18.494"></a><span id="l18.494"> </span>
<a href="#l18.495"></a><span id="l18.495">     // we're just setting focus to where it was before</span>
<a href="#l18.496"></a><span id="l18.496">     if (focusedWindow == Enigmail.msg.lastFocusedWindow) {</span>
<a href="#l18.497"></a><span id="l18.497">       // skip</span>
<a href="#l18.498"></a><span id="l18.498">       return;</span>
<a href="#l18.499"></a><span id="l18.499">     }</span>
<a href="#l18.500"></a><span id="l18.500"> </span>
<a href="#l18.501"></a><span id="l18.501">     Enigmail.msg.lastFocusedWindow = focusedWindow;</span>
<a href="#l18.502"></a><span id="l18.502"> </span>
<a href="#l18.503"></a><span id="l18.503" class="difflineminus">-    Enigmail.msg.fireSendFlags();</span>
<a href="#l18.504"></a><span id="l18.504" class="difflineplus">+    await Enigmail.msg.fireSendFlags();</span>
<a href="#l18.505"></a><span id="l18.505">   },</span>
<a href="#l18.506"></a><span id="l18.506"> </span>
<a href="#l18.507"></a><span id="l18.507">   fireSendFlags() {</span>
<a href="#l18.508"></a><span id="l18.508">     try {</span>
<a href="#l18.509"></a><span id="l18.509">       EnigmailLog.DEBUG(</span>
<a href="#l18.510"></a><span id="l18.510">         &quot;enigmailMsgComposeOverlay.js: Enigmail.msg.fireSendFlags\n&quot;</span>
<a href="#l18.511"></a><span id="l18.511">       );</span>
<a href="#l18.512"></a><span id="l18.512">       if (!this.determineSendFlagId) {</span>
<a href="#l18.513"></a><span id="l18.513" class="difflineminus">-        let self = this;</span>
<a href="#l18.514"></a><span id="l18.514" class="difflineminus">-        this.determineSendFlagId = EnigmailTimer.setTimeout(function() {</span>
<a href="#l18.515"></a><span id="l18.515" class="difflineplus">+        this.determineSendFlagId = EnigmailTimer.setTimeout(async () =&gt; {</span>
<a href="#l18.516"></a><span id="l18.516">           try {</span>
<a href="#l18.517"></a><span id="l18.517" class="difflineminus">-            self.determineSendFlags();</span>
<a href="#l18.518"></a><span id="l18.518" class="difflineminus">-            self.fireSearchKeys();</span>
<a href="#l18.519"></a><span id="l18.519" class="difflineplus">+            await this.determineSendFlags();</span>
<a href="#l18.520"></a><span id="l18.520" class="difflineplus">+            this.fireSearchKeys();</span>
<a href="#l18.521"></a><span id="l18.521">           } catch (x) {}</span>
<a href="#l18.522"></a><span id="l18.522" class="difflineminus">-          self.determineSendFlagId = null;</span>
<a href="#l18.523"></a><span id="l18.523" class="difflineplus">+          this.determineSendFlagId = null;</span>
<a href="#l18.524"></a><span id="l18.524">         }, 0);</span>
<a href="#l18.525"></a><span id="l18.525">       }</span>
<a href="#l18.526"></a><span id="l18.526">     } catch (ex) {}</span>
<a href="#l18.527"></a><span id="l18.527">   },</span>
<a href="#l18.528"></a><span id="l18.528"> </span>
<a href="#l18.529"></a><span id="l18.529">   /**</span>
<a href="#l18.530"></a><span id="l18.530">    * Merge multiple  Re: Re: into one Re: in message subject</span>
<a href="#l18.531"></a><span id="l18.531">    */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/keyDetailsDlg.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/keyDetailsDlg.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -5,17 +5,17 @@</span>
<a href="#l19.4"></a><span id="l19.4">  */</span>
<a href="#l19.5"></a><span id="l19.5"> </span>
<a href="#l19.6"></a><span id="l19.6"> /* global EnigmailLog: false, EnigmailLocale: false, EnigmailKey: false, EnigmailKeyRing: false */</span>
<a href="#l19.7"></a><span id="l19.7"> </span>
<a href="#l19.8"></a><span id="l19.8"> // from enigmailCommon.js:</span>
<a href="#l19.9"></a><span id="l19.9"> /* global GetEnigmailSvc: false, EnigAlert: false, EnigConvertGpgToUnicode: false */</span>
<a href="#l19.10"></a><span id="l19.10"> /* global EnigCleanGuiList: false, EnigGetTrustLabel: false, EnigShowPhoto: false, EnigSignKey: false */</span>
<a href="#l19.11"></a><span id="l19.11"> /* global EnigEditKeyExpiry: false, EnigEditKeyTrust: false, EnigChangeKeyPwd: false, EnigRevokeKey: false */</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-/* global EnigCreateRevokeCert: false, EnigmailTimer: false */</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+/* global EnigCreateRevokeCert: false, EnigmailTimer: false, EnigmailCryptoAPI: false */</span>
<a href="#l19.14"></a><span id="l19.14"> </span>
<a href="#l19.15"></a><span id="l19.15"> // from enigmailKeyManager.js:</span>
<a href="#l19.16"></a><span id="l19.16"> /* global keyMgrAddPhoto: false, EnigmailCompat: false */</span>
<a href="#l19.17"></a><span id="l19.17"> </span>
<a href="#l19.18"></a><span id="l19.18"> &quot;use strict&quot;;</span>
<a href="#l19.19"></a><span id="l19.19"> </span>
<a href="#l19.20"></a><span id="l19.20"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l19.21"></a><span id="l19.21"> </span>
<a href="#l19.22"></a><span id="l19.22" class="difflineat">@@ -85,16 +85,17 @@ async function reloadData() {</span>
<a href="#l19.23"></a><span id="l19.23">   EnigCleanGuiList(uidList);</span>
<a href="#l19.24"></a><span id="l19.24"> </span>
<a href="#l19.25"></a><span id="l19.25">   let keyObj = EnigmailKeyRing.getKeyById(gKeyId);</span>
<a href="#l19.26"></a><span id="l19.26">   if (keyObj) {</span>
<a href="#l19.27"></a><span id="l19.27">     let keyIsExpired =</span>
<a href="#l19.28"></a><span id="l19.28">       keyObj.expiryTime &amp;&amp; keyObj.expiryTime &lt; Math.floor(Date.now() / 1000);</span>
<a href="#l19.29"></a><span id="l19.29"> </span>
<a href="#l19.30"></a><span id="l19.30">     let acceptanceIntroText = &quot;&quot;;</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineplus">+    let acceptanceWarningText = &quot;&quot;;</span>
<a href="#l19.32"></a><span id="l19.32">     if (keyObj.secretAvailable) {</span>
<a href="#l19.33"></a><span id="l19.33">       setLabel(&quot;keyType&quot;, EnigmailLocale.getString(&quot;keyTypePair2&quot;));</span>
<a href="#l19.34"></a><span id="l19.34">       document.getElementById(&quot;ownKeyCommands&quot;).removeAttribute(&quot;hidden&quot;);</span>
<a href="#l19.35"></a><span id="l19.35">       acceptanceIntroText = EnigmailLocale.getString(&quot;keyAutoAcceptPersonal&quot;);</span>
<a href="#l19.36"></a><span id="l19.36">     } else {</span>
<a href="#l19.37"></a><span id="l19.37">       document.getElementById(&quot;ownKeyCommands&quot;).setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l19.38"></a><span id="l19.38">       setLabel(&quot;keyType&quot;, EnigmailLocale.getString(&quot;keyTypePublic&quot;));</span>
<a href="#l19.39"></a><span id="l19.39"> </span>
<a href="#l19.40"></a><span id="l19.40" class="difflineat">@@ -103,16 +104,17 @@ async function reloadData() {</span>
<a href="#l19.41"></a><span id="l19.41">         keyObj.keyTrust == &quot;e&quot; ||</span>
<a href="#l19.42"></a><span id="l19.42">         keyIsExpired</span>
<a href="#l19.43"></a><span id="l19.43">       );</span>
<a href="#l19.44"></a><span id="l19.44">       if (isStillValid) {</span>
<a href="#l19.45"></a><span id="l19.45">         document</span>
<a href="#l19.46"></a><span id="l19.46">           .getElementById(&quot;acceptanceRadio&quot;)</span>
<a href="#l19.47"></a><span id="l19.47">           .setAttribute(&quot;hidden&quot;, &quot;false&quot;);</span>
<a href="#l19.48"></a><span id="l19.48">         acceptanceIntroText = EnigmailLocale.getString(&quot;keyDoYouAccept&quot;);</span>
<a href="#l19.49"></a><span id="l19.49" class="difflineplus">+        acceptanceWarningText = EnigmailLocale.getString(&quot;KeyAcceptWarning&quot;);</span>
<a href="#l19.50"></a><span id="l19.50">         gUpdateAllowed = true;</span>
<a href="#l19.51"></a><span id="l19.51"> </span>
<a href="#l19.52"></a><span id="l19.52">         let acceptanceResult = {};</span>
<a href="#l19.53"></a><span id="l19.53">         await PgpSqliteDb2.getFingerprintAcceptance(</span>
<a href="#l19.54"></a><span id="l19.54">           null,</span>
<a href="#l19.55"></a><span id="l19.55">           keyObj.fpr,</span>
<a href="#l19.56"></a><span id="l19.56">           acceptanceResult</span>
<a href="#l19.57"></a><span id="l19.57">         );</span>
<a href="#l19.58"></a><span id="l19.58" class="difflineat">@@ -166,16 +168,17 @@ async function reloadData() {</span>
<a href="#l19.59"></a><span id="l19.59">       acceptanceIntroText = expiryInfo;</span>
<a href="#l19.60"></a><span id="l19.60">     } else if (keyObj.expiry.length === 0) {</span>
<a href="#l19.61"></a><span id="l19.61">       expiryInfo = EnigmailLocale.getString(&quot;keyDoesNotExpire&quot;);</span>
<a href="#l19.62"></a><span id="l19.62">     } else {</span>
<a href="#l19.63"></a><span id="l19.63">       expiryInfo = keyObj.expiry;</span>
<a href="#l19.64"></a><span id="l19.64">     }</span>
<a href="#l19.65"></a><span id="l19.65"> </span>
<a href="#l19.66"></a><span id="l19.66">     setText(&quot;acceptanceIntro&quot;, acceptanceIntroText);</span>
<a href="#l19.67"></a><span id="l19.67" class="difflineplus">+    setText(&quot;acceptanceExplanation&quot;, acceptanceWarningText);</span>
<a href="#l19.68"></a><span id="l19.68">     setLabel(&quot;keyExpiry&quot;, expiryInfo);</span>
<a href="#l19.69"></a><span id="l19.69">     if (keyObj.fpr) {</span>
<a href="#l19.70"></a><span id="l19.70">       gFingerprint = keyObj.fpr;</span>
<a href="#l19.71"></a><span id="l19.71">       setLabel(&quot;fingerprint&quot;, EnigmailKey.formatFpr(keyObj.fpr));</span>
<a href="#l19.72"></a><span id="l19.72">     }</span>
<a href="#l19.73"></a><span id="l19.73">   }</span>
<a href="#l19.74"></a><span id="l19.74"> }</span>
<a href="#l19.75"></a><span id="l19.75"> </span>
<a href="#l19.76"></a><span id="l19.76" class="difflineat">@@ -608,24 +611,30 @@ SubkeyListView.prototype = {</span>
<a href="#l19.77"></a><span id="l19.77">     return true;</span>
<a href="#l19.78"></a><span id="l19.78">   },</span>
<a href="#l19.79"></a><span id="l19.79"> </span>
<a href="#l19.80"></a><span id="l19.80">   toggleOpenState(row) {},</span>
<a href="#l19.81"></a><span id="l19.81"> };</span>
<a href="#l19.82"></a><span id="l19.82"> </span>
<a href="#l19.83"></a><span id="l19.83"> function sigHandleDblClick(event) {}</span>
<a href="#l19.84"></a><span id="l19.84"> </span>
<a href="#l19.85"></a><span id="l19.85" class="difflineminus">-function onAccept() {</span>
<a href="#l19.86"></a><span id="l19.86" class="difflineplus">+async function onAccept() {</span>
<a href="#l19.87"></a><span id="l19.87">   if (gUpdateAllowed &amp;&amp; gAcceptanceRadio.value != gOriginalAcceptance) {</span>
<a href="#l19.88"></a><span id="l19.88" class="difflineminus">-    PgpSqliteDb2.updateAcceptance(</span>
<a href="#l19.89"></a><span id="l19.89" class="difflineminus">-      gFingerprint,</span>
<a href="#l19.90"></a><span id="l19.90" class="difflineminus">-      gAllEmails,</span>
<a href="#l19.91"></a><span id="l19.91" class="difflineminus">-      gAcceptanceRadio.value</span>
<a href="#l19.92"></a><span id="l19.92" class="difflineplus">+    enableRefresh();</span>
<a href="#l19.93"></a><span id="l19.93" class="difflineplus">+</span>
<a href="#l19.94"></a><span id="l19.94" class="difflineplus">+    const cApi = EnigmailCryptoAPI();</span>
<a href="#l19.95"></a><span id="l19.95" class="difflineplus">+    cApi.sync(</span>
<a href="#l19.96"></a><span id="l19.96" class="difflineplus">+      PgpSqliteDb2.updateAcceptance(</span>
<a href="#l19.97"></a><span id="l19.97" class="difflineplus">+        gFingerprint,</span>
<a href="#l19.98"></a><span id="l19.98" class="difflineplus">+        gAllEmails,</span>
<a href="#l19.99"></a><span id="l19.99" class="difflineplus">+        gAcceptanceRadio.value</span>
<a href="#l19.100"></a><span id="l19.100" class="difflineplus">+      )</span>
<a href="#l19.101"></a><span id="l19.101">     );</span>
<a href="#l19.102"></a><span id="l19.102">   }</span>
<a href="#l19.103"></a><span id="l19.103">   return true;</span>
<a href="#l19.104"></a><span id="l19.104"> }</span>
<a href="#l19.105"></a><span id="l19.105"> </span>
<a href="#l19.106"></a><span id="l19.106" class="difflineminus">-document.addEventListener(&quot;dialogaccept&quot;, function(event) {</span>
<a href="#l19.107"></a><span id="l19.107" class="difflineminus">-  if (!onAccept()) {</span>
<a href="#l19.108"></a><span id="l19.108" class="difflineplus">+document.addEventListener(&quot;dialogaccept&quot;, async function(event) {</span>
<a href="#l19.109"></a><span id="l19.109" class="difflineplus">+  let result = await onAccept();</span>
<a href="#l19.110"></a><span id="l19.110" class="difflineplus">+  if (!result) {</span>
<a href="#l19.111"></a><span id="l19.111">     event.preventDefault();</span>
<a href="#l19.112"></a><span id="l19.112">   } // Prevent the dialog closing.</span>
<a href="#l19.113"></a><span id="l19.113"> });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/keyDetailsDlg.xhtml</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/keyDetailsDlg.xhtml</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -13,17 +13,17 @@</span>
<a href="#l20.4"></a><span id="l20.4"> %brandDTD;</span>
<a href="#l20.5"></a><span id="l20.5"> &lt;!ENTITY % enigMailDTD SYSTEM &quot;chrome://openpgp/content/strings/enigmail.dtd&quot; &gt;</span>
<a href="#l20.6"></a><span id="l20.6"> %enigMailDTD;</span>
<a href="#l20.7"></a><span id="l20.7"> ]&gt;</span>
<a href="#l20.8"></a><span id="l20.8"> </span>
<a href="#l20.9"></a><span id="l20.9"> &lt;window title=&quot;&amp;enigmail.keyDetails.title;&quot;</span>
<a href="#l20.10"></a><span id="l20.10">         xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l20.11"></a><span id="l20.11">         xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-        style=&quot;min-width:450px;&quot;</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+        style=&quot;min-width:60em; min-height:30em&quot;</span>
<a href="#l20.14"></a><span id="l20.14">         persist=&quot;width height&quot;</span>
<a href="#l20.15"></a><span id="l20.15">         onload=&quot;onLoad();&quot;&gt;</span>
<a href="#l20.16"></a><span id="l20.16"> &lt;dialog id=&quot;enigmailKeyDetailsDlg&quot;</span>
<a href="#l20.17"></a><span id="l20.17">         buttons=&quot;accept&quot;</span>
<a href="#l20.18"></a><span id="l20.18">         buttonlabelaccept=&quot;&amp;enigmail.cardDetails.closeWindow.label;&quot;&gt;</span>
<a href="#l20.19"></a><span id="l20.19"> </span>
<a href="#l20.20"></a><span id="l20.20">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://openpgp/content/ui/enigmailCommon.js&quot;/&gt;</span>
<a href="#l20.21"></a><span id="l20.21">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://openpgp/content/ui/keyDetailsDlg.js&quot;/&gt;</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineat">@@ -85,16 +85,19 @@</span>
<a href="#l20.23"></a><span id="l20.23">       &lt;tab id=&quot;signaturesTab&quot;  label=&quot;&amp;enigmail.keyDetails.signaturesTab;&quot;/&gt;</span>
<a href="#l20.24"></a><span id="l20.24">       &lt;tab id=&quot;structureTab&quot;   label=&quot;&amp;enigmail.keyDetails.structureTab;&quot;/&gt;</span>
<a href="#l20.25"></a><span id="l20.25">     &lt;/tabs&gt;</span>
<a href="#l20.26"></a><span id="l20.26"> </span>
<a href="#l20.27"></a><span id="l20.27">     &lt;tabpanels flex=&quot;1&quot; id=&quot;mainTabPanel&quot;&gt;</span>
<a href="#l20.28"></a><span id="l20.28">        &lt;!-- Acceptance Tab --&gt;</span>
<a href="#l20.29"></a><span id="l20.29">       &lt;vbox id=&quot;acceptancePanel&quot;&gt;</span>
<a href="#l20.30"></a><span id="l20.30">         &lt;description id=&quot;acceptanceIntro&quot;/&gt;</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineplus">+        &lt;separator class=&quot;thin&quot;/&gt;</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineplus">+        &lt;description id=&quot;acceptanceExplanation&quot;/&gt;</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineplus">+        &lt;separator class=&quot;thin&quot;/&gt;</span>
<a href="#l20.34"></a><span id="l20.34">         &lt;radiogroup id=&quot;acceptanceRadio&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l20.35"></a><span id="l20.35">           &lt;radio id=&quot;acceptRejected&quot; value=&quot;rejected&quot;</span>
<a href="#l20.36"></a><span id="l20.36">                  label=&quot;&amp;enigmail.acceptance.rejected.label;&quot;/&gt;</span>
<a href="#l20.37"></a><span id="l20.37"> </span>
<a href="#l20.38"></a><span id="l20.38">           &lt;radio id=&quot;acceptUndecided&quot; value=&quot;undecided&quot;</span>
<a href="#l20.39"></a><span id="l20.39">                  label=&quot;&amp;enigmail.acceptance.undecided.label;&quot;/&gt;</span>
<a href="#l20.40"></a><span id="l20.40"> </span>
<a href="#l20.41"></a><span id="l20.41">           &lt;radio id=&quot;acceptUnverified&quot; value=&quot;unverified&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1">copy from mailnews/extensions/smime/content/msgCompSecurityInfo.js</span>
<a href="#l21.2"></a><span id="l21.2">copy to mail/extensions/openpgp/content/ui/oneRecipientStatus.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineminus">--- a/mailnews/extensions/smime/content/msgCompSecurityInfo.js</span>
<a href="#l21.4"></a><span id="l21.4" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/oneRecipientStatus.js</span>
<a href="#l21.5"></a><span id="l21.5" class="difflineat">@@ -1,302 +1,202 @@</span>
<a href="#l21.6"></a><span id="l21.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l21.7"></a><span id="l21.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l21.8"></a><span id="l21.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l21.9"></a><span id="l21.9"> </span>
<a href="#l21.10"></a><span id="l21.10"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l21.11"></a><span id="l21.11" class="difflineplus">+var { EnigmailFuncs } = ChromeUtils.import(</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineplus">+  &quot;chrome://openpgp/content/modules/funcs.jsm&quot;</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+);</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineplus">+var EnigmailKeyRing = ChromeUtils.import(</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineplus">+  &quot;chrome://openpgp/content/modules/keyRing.jsm&quot;</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineplus">+).EnigmailKeyRing;</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineplus">+var { EnigmailWindows } = ChromeUtils.import(</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineplus">+  &quot;chrome://openpgp/content/modules/windows.jsm&quot;</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineplus">+);</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineplus">+var EnigmailWkdLookup = ChromeUtils.import(</span>
<a href="#l21.21"></a><span id="l21.21" class="difflineplus">+  &quot;chrome://openpgp/content/modules/wkdLookup.jsm&quot;</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineplus">+).EnigmailWkdLookup;</span>
<a href="#l21.23"></a><span id="l21.23" class="difflineplus">+var { EnigmailKeyserverURIs } = ChromeUtils.import(</span>
<a href="#l21.24"></a><span id="l21.24" class="difflineplus">+  &quot;chrome://openpgp/content/modules/keyserverUris.jsm&quot;</span>
<a href="#l21.25"></a><span id="l21.25" class="difflineplus">+);</span>
<a href="#l21.26"></a><span id="l21.26" class="difflineplus">+var EnigmailKeyServer = ChromeUtils.import(</span>
<a href="#l21.27"></a><span id="l21.27" class="difflineplus">+  &quot;chrome://openpgp/content/modules/keyserver.jsm&quot;</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineplus">+).EnigmailKeyServer;</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineplus">+var { EnigmailKey } = ChromeUtils.import(</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineplus">+  &quot;chrome://openpgp/content/modules/key.jsm&quot;</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineplus">+);</span>
<a href="#l21.32"></a><span id="l21.32"> </span>
<a href="#l21.33"></a><span id="l21.33"> var gListBox;</span>
<a href="#l21.34"></a><span id="l21.34"> var gViewButton;</span>
<a href="#l21.35"></a><span id="l21.35"> var gBundle;</span>
<a href="#l21.36"></a><span id="l21.36"> </span>
<a href="#l21.37"></a><span id="l21.37" class="difflineminus">-var gCerts;</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineplus">+var gAddr;</span>
<a href="#l21.39"></a><span id="l21.39" class="difflineplus">+var gRowToKey = [];</span>
<a href="#l21.40"></a><span id="l21.40" class="difflineplus">+</span>
<a href="#l21.41"></a><span id="l21.41" class="difflineplus">+async function setListEntries(keys = null) {</span>
<a href="#l21.42"></a><span id="l21.42" class="difflineplus">+  let index = 0;</span>
<a href="#l21.43"></a><span id="l21.43" class="difflineplus">+</span>
<a href="#l21.44"></a><span id="l21.44" class="difflineplus">+  if (!keys) {</span>
<a href="#l21.45"></a><span id="l21.45" class="difflineplus">+    keys = await EnigmailKeyRing.getMultValidKeysForOneRecipient(gAddr);</span>
<a href="#l21.46"></a><span id="l21.46" class="difflineplus">+  }</span>
<a href="#l21.47"></a><span id="l21.47" class="difflineplus">+</span>
<a href="#l21.48"></a><span id="l21.48" class="difflineplus">+  for (let keyObj of keys) {</span>
<a href="#l21.49"></a><span id="l21.49" class="difflineplus">+    let listitem = document.createXULElement(&quot;richlistitem&quot;);</span>
<a href="#l21.50"></a><span id="l21.50" class="difflineplus">+</span>
<a href="#l21.51"></a><span id="l21.51" class="difflineplus">+    let keyId = document.createXULElement(&quot;label&quot;);</span>
<a href="#l21.52"></a><span id="l21.52" class="difflineplus">+    keyId.setAttribute(&quot;value&quot;, &quot;0x&quot; + keyObj.keyId);</span>
<a href="#l21.53"></a><span id="l21.53" class="difflineplus">+    keyId.setAttribute(&quot;crop&quot;, &quot;end&quot;);</span>
<a href="#l21.54"></a><span id="l21.54" class="difflineplus">+    keyId.setAttribute(&quot;style&quot;, &quot;width: var(--keyWidth)&quot;);</span>
<a href="#l21.55"></a><span id="l21.55" class="difflineplus">+    listitem.appendChild(keyId);</span>
<a href="#l21.56"></a><span id="l21.56"> </span>
<a href="#l21.57"></a><span id="l21.57" class="difflineminus">-function onLoad() {</span>
<a href="#l21.58"></a><span id="l21.58" class="difflineplus">+    let acceptanceText;</span>
<a href="#l21.59"></a><span id="l21.59" class="difflineplus">+    if (keyObj.secretAvailable) {</span>
<a href="#l21.60"></a><span id="l21.60" class="difflineplus">+      acceptanceText = gBundle.getString(&quot;KeyOwn&quot;);</span>
<a href="#l21.61"></a><span id="l21.61" class="difflineplus">+    } else {</span>
<a href="#l21.62"></a><span id="l21.62" class="difflineplus">+      if (!(&quot;acceptance&quot; in keyObj)) {</span>
<a href="#l21.63"></a><span id="l21.63" class="difflineplus">+        throw new Error(</span>
<a href="#l21.64"></a><span id="l21.64" class="difflineplus">+          &quot;expected getMultValidKeysForMultRecipients to set acceptance&quot;</span>
<a href="#l21.65"></a><span id="l21.65" class="difflineplus">+        );</span>
<a href="#l21.66"></a><span id="l21.66" class="difflineplus">+      }</span>
<a href="#l21.67"></a><span id="l21.67" class="difflineplus">+      let stringId;</span>
<a href="#l21.68"></a><span id="l21.68" class="difflineplus">+      switch (keyObj.acceptance) {</span>
<a href="#l21.69"></a><span id="l21.69" class="difflineplus">+        case &quot;rejected&quot;:</span>
<a href="#l21.70"></a><span id="l21.70" class="difflineplus">+          stringId = &quot;KeyRejected&quot;;</span>
<a href="#l21.71"></a><span id="l21.71" class="difflineplus">+          break;</span>
<a href="#l21.72"></a><span id="l21.72" class="difflineplus">+        case &quot;unverified&quot;:</span>
<a href="#l21.73"></a><span id="l21.73" class="difflineplus">+          stringId = &quot;KeyUnverified&quot;;</span>
<a href="#l21.74"></a><span id="l21.74" class="difflineplus">+          break;</span>
<a href="#l21.75"></a><span id="l21.75" class="difflineplus">+        case &quot;verified&quot;:</span>
<a href="#l21.76"></a><span id="l21.76" class="difflineplus">+          stringId = &quot;KeyVerified&quot;;</span>
<a href="#l21.77"></a><span id="l21.77" class="difflineplus">+          break;</span>
<a href="#l21.78"></a><span id="l21.78" class="difflineplus">+        case &quot;undecided&quot;:</span>
<a href="#l21.79"></a><span id="l21.79" class="difflineplus">+          stringId = &quot;KeyUndecided&quot;;</span>
<a href="#l21.80"></a><span id="l21.80" class="difflineplus">+          break;</span>
<a href="#l21.81"></a><span id="l21.81" class="difflineplus">+        default:</span>
<a href="#l21.82"></a><span id="l21.82" class="difflineplus">+          throw new Error(&quot;unexpected acceptance value: &quot; + keyObj.acceptance);</span>
<a href="#l21.83"></a><span id="l21.83" class="difflineplus">+      }</span>
<a href="#l21.84"></a><span id="l21.84" class="difflineplus">+      acceptanceText = gBundle.getString(stringId);</span>
<a href="#l21.85"></a><span id="l21.85" class="difflineplus">+    }</span>
<a href="#l21.86"></a><span id="l21.86" class="difflineplus">+</span>
<a href="#l21.87"></a><span id="l21.87" class="difflineplus">+    let status = document.createXULElement(&quot;label&quot;);</span>
<a href="#l21.88"></a><span id="l21.88" class="difflineplus">+    status.setAttribute(&quot;value&quot;, acceptanceText);</span>
<a href="#l21.89"></a><span id="l21.89" class="difflineplus">+    status.setAttribute(&quot;crop&quot;, &quot;end&quot;);</span>
<a href="#l21.90"></a><span id="l21.90" class="difflineplus">+    status.setAttribute(&quot;style&quot;, &quot;width: var(--statusWidth)&quot;);</span>
<a href="#l21.91"></a><span id="l21.91" class="difflineplus">+    listitem.appendChild(status);</span>
<a href="#l21.92"></a><span id="l21.92" class="difflineplus">+</span>
<a href="#l21.93"></a><span id="l21.93" class="difflineplus">+    let issued = document.createXULElement(&quot;label&quot;);</span>
<a href="#l21.94"></a><span id="l21.94" class="difflineplus">+    issued.setAttribute(&quot;value&quot;, keyObj.created);</span>
<a href="#l21.95"></a><span id="l21.95" class="difflineplus">+    issued.setAttribute(&quot;crop&quot;, &quot;end&quot;);</span>
<a href="#l21.96"></a><span id="l21.96" class="difflineplus">+    issued.setAttribute(&quot;style&quot;, &quot;width: var(--issuedWidth)&quot;);</span>
<a href="#l21.97"></a><span id="l21.97" class="difflineplus">+    listitem.appendChild(issued);</span>
<a href="#l21.98"></a><span id="l21.98" class="difflineplus">+</span>
<a href="#l21.99"></a><span id="l21.99" class="difflineplus">+    let expire = document.createXULElement(&quot;label&quot;);</span>
<a href="#l21.100"></a><span id="l21.100" class="difflineplus">+    expire.setAttribute(&quot;value&quot;, keyObj.expiry);</span>
<a href="#l21.101"></a><span id="l21.101" class="difflineplus">+    expire.setAttribute(&quot;crop&quot;, &quot;end&quot;);</span>
<a href="#l21.102"></a><span id="l21.102" class="difflineplus">+    expire.setAttribute(&quot;style&quot;, &quot;width: var(--expireWidth)&quot;);</span>
<a href="#l21.103"></a><span id="l21.103" class="difflineplus">+    listitem.appendChild(expire);</span>
<a href="#l21.104"></a><span id="l21.104" class="difflineplus">+</span>
<a href="#l21.105"></a><span id="l21.105" class="difflineplus">+    gListBox.appendChild(listitem);</span>
<a href="#l21.106"></a><span id="l21.106" class="difflineplus">+</span>
<a href="#l21.107"></a><span id="l21.107" class="difflineplus">+    gRowToKey[index] = keyObj.keyId;</span>
<a href="#l21.108"></a><span id="l21.108" class="difflineplus">+    index++;</span>
<a href="#l21.109"></a><span id="l21.109" class="difflineplus">+  }</span>
<a href="#l21.110"></a><span id="l21.110" class="difflineplus">+}</span>
<a href="#l21.111"></a><span id="l21.111" class="difflineplus">+</span>
<a href="#l21.112"></a><span id="l21.112" class="difflineplus">+async function onLoad() {</span>
<a href="#l21.113"></a><span id="l21.113">   let params = window.arguments[0];</span>
<a href="#l21.114"></a><span id="l21.114">   if (!params) {</span>
<a href="#l21.115"></a><span id="l21.115">     return;</span>
<a href="#l21.116"></a><span id="l21.116">   }</span>
<a href="#l21.117"></a><span id="l21.117"> </span>
<a href="#l21.118"></a><span id="l21.118" class="difflineminus">-  let helper = Cc[</span>
<a href="#l21.119"></a><span id="l21.119" class="difflineminus">-    &quot;@mozilla.org/messenger-smime/smimejshelper;1&quot;</span>
<a href="#l21.120"></a><span id="l21.120" class="difflineminus">-  ].createInstance(Ci.nsISMimeJSHelper);</span>
<a href="#l21.121"></a><span id="l21.121" class="difflineplus">+  gListBox = document.getElementById(&quot;infolist&quot;);</span>
<a href="#l21.122"></a><span id="l21.122" class="difflineplus">+  gViewButton = document.getElementById(&quot;detailsButton&quot;);</span>
<a href="#l21.123"></a><span id="l21.123" class="difflineplus">+  gBundle = document.getElementById(&quot;bundle_one_recip_info&quot;);</span>
<a href="#l21.124"></a><span id="l21.124"> </span>
<a href="#l21.125"></a><span id="l21.125" class="difflineminus">-  gListBox = document.getElementById(&quot;infolist&quot;);</span>
<a href="#l21.126"></a><span id="l21.126" class="difflineminus">-  gViewButton = document.getElementById(&quot;viewCertButton&quot;);</span>
<a href="#l21.127"></a><span id="l21.127" class="difflineminus">-  gBundle = document.getElementById(&quot;bundle_smime_comp_info&quot;);</span>
<a href="#l21.128"></a><span id="l21.128" class="difflineplus">+  gAddr = params.email;</span>
<a href="#l21.129"></a><span id="l21.129"> </span>
<a href="#l21.130"></a><span id="l21.130" class="difflineminus">-  let allow_ldap_cert_fetching = params.smFields.requireEncryptMessage;</span>
<a href="#l21.131"></a><span id="l21.131" class="difflineplus">+  document.getElementById(&quot;intro&quot;).value = gBundle.getFormattedString(&quot;Intro&quot;, [</span>
<a href="#l21.132"></a><span id="l21.132" class="difflineplus">+    gAddr,</span>
<a href="#l21.133"></a><span id="l21.133" class="difflineplus">+  ]);</span>
<a href="#l21.134"></a><span id="l21.134"> </span>
<a href="#l21.135"></a><span id="l21.135" class="difflineminus">-  let emailAddresses = [];</span>
<a href="#l21.136"></a><span id="l21.136" class="difflineminus">-  let certIssuedInfos = [];</span>
<a href="#l21.137"></a><span id="l21.137" class="difflineminus">-  let certExpiresInfos = [];</span>
<a href="#l21.138"></a><span id="l21.138" class="difflineminus">-  let certs = [];</span>
<a href="#l21.139"></a><span id="l21.139" class="difflineminus">-  let canEncrypt = false;</span>
<a href="#l21.140"></a><span id="l21.140" class="difflineplus">+  await setListEntries(params.keys);</span>
<a href="#l21.141"></a><span id="l21.141" class="difflineplus">+}</span>
<a href="#l21.142"></a><span id="l21.142"> </span>
<a href="#l21.143"></a><span id="l21.143" class="difflineplus">+async function reload() {</span>
<a href="#l21.144"></a><span id="l21.144">   while (true) {</span>
<a href="#l21.145"></a><span id="l21.145" class="difflineminus">-    try {</span>
<a href="#l21.146"></a><span id="l21.146" class="difflineminus">-      // Out parameters - must be objects.</span>
<a href="#l21.147"></a><span id="l21.147" class="difflineminus">-      let outEmailAddresses = {};</span>
<a href="#l21.148"></a><span id="l21.148" class="difflineminus">-      let outCertIssuedInfos = {};</span>
<a href="#l21.149"></a><span id="l21.149" class="difflineminus">-      let outCertExpiresInfos = {};</span>
<a href="#l21.150"></a><span id="l21.150" class="difflineminus">-      let outCerts = {};</span>
<a href="#l21.151"></a><span id="l21.151" class="difflineminus">-      let outCanEncrypt = {};</span>
<a href="#l21.152"></a><span id="l21.152" class="difflineminus">-      helper.getRecipientCertsInfo(</span>
<a href="#l21.153"></a><span id="l21.153" class="difflineminus">-        params.compFields,</span>
<a href="#l21.154"></a><span id="l21.154" class="difflineminus">-        outEmailAddresses,</span>
<a href="#l21.155"></a><span id="l21.155" class="difflineminus">-        outCertIssuedInfos,</span>
<a href="#l21.156"></a><span id="l21.156" class="difflineminus">-        outCertExpiresInfos,</span>
<a href="#l21.157"></a><span id="l21.157" class="difflineminus">-        outCerts,</span>
<a href="#l21.158"></a><span id="l21.158" class="difflineminus">-        outCanEncrypt</span>
<a href="#l21.159"></a><span id="l21.159" class="difflineminus">-      );</span>
<a href="#l21.160"></a><span id="l21.160" class="difflineminus">-      // Unwrap to the actual values.</span>
<a href="#l21.161"></a><span id="l21.161" class="difflineminus">-      emailAddresses = outEmailAddresses.value;</span>
<a href="#l21.162"></a><span id="l21.162" class="difflineminus">-      certIssuedInfos = outCertIssuedInfos.value;</span>
<a href="#l21.163"></a><span id="l21.163" class="difflineminus">-      certExpiresInfos = outCertExpiresInfos.value;</span>
<a href="#l21.164"></a><span id="l21.164" class="difflineminus">-      gCerts = certs = outCerts.value;</span>
<a href="#l21.165"></a><span id="l21.165" class="difflineminus">-      canEncrypt = outCanEncrypt.value;</span>
<a href="#l21.166"></a><span id="l21.166" class="difflineminus">-    } catch (e) {</span>
<a href="#l21.167"></a><span id="l21.167" class="difflineminus">-      dump(e);</span>
<a href="#l21.168"></a><span id="l21.168" class="difflineminus">-      return;</span>
<a href="#l21.169"></a><span id="l21.169" class="difflineminus">-    }</span>
<a href="#l21.170"></a><span id="l21.170" class="difflineminus">-</span>
<a href="#l21.171"></a><span id="l21.171" class="difflineminus">-    if (!allow_ldap_cert_fetching) {</span>
<a href="#l21.172"></a><span id="l21.172" class="difflineplus">+    let child = gListBox.firstChild;</span>
<a href="#l21.173"></a><span id="l21.173" class="difflineplus">+    if (!child) {</span>
<a href="#l21.174"></a><span id="l21.174">       break;</span>
<a href="#l21.175"></a><span id="l21.175">     }</span>
<a href="#l21.176"></a><span id="l21.176" class="difflineminus">-    allow_ldap_cert_fetching = false;</span>
<a href="#l21.177"></a><span id="l21.177" class="difflineminus">-</span>
<a href="#l21.178"></a><span id="l21.178" class="difflineminus">-    let missing = [];</span>
<a href="#l21.179"></a><span id="l21.179" class="difflineminus">-    for (let i = 0; i &lt; emailAddresses.length; i++) {</span>
<a href="#l21.180"></a><span id="l21.180" class="difflineminus">-      if (!certs[i]) {</span>
<a href="#l21.181"></a><span id="l21.181" class="difflineminus">-        missing.push(emailAddresses[i]);</span>
<a href="#l21.182"></a><span id="l21.182" class="difflineminus">-      }</span>
<a href="#l21.183"></a><span id="l21.183" class="difflineminus">-    }</span>
<a href="#l21.184"></a><span id="l21.184" class="difflineplus">+    gListBox.removeChild(child);</span>
<a href="#l21.185"></a><span id="l21.185" class="difflineplus">+  }</span>
<a href="#l21.186"></a><span id="l21.186" class="difflineplus">+  gRowToKey = [];</span>
<a href="#l21.187"></a><span id="l21.187" class="difflineplus">+  setListEntries();</span>
<a href="#l21.188"></a><span id="l21.188" class="difflineplus">+}</span>
<a href="#l21.189"></a><span id="l21.189"> </span>
<a href="#l21.190"></a><span id="l21.190" class="difflineminus">-    if (missing.length &gt; 0) {</span>
<a href="#l21.191"></a><span id="l21.191" class="difflineminus">-      var autocompleteLdap = Services.prefs.getBoolPref(</span>
<a href="#l21.192"></a><span id="l21.192" class="difflineminus">-        &quot;ldap_2.autoComplete.useDirectory&quot;</span>
<a href="#l21.193"></a><span id="l21.193" class="difflineminus">-      );</span>
<a href="#l21.194"></a><span id="l21.194" class="difflineminus">-</span>
<a href="#l21.195"></a><span id="l21.195" class="difflineminus">-      if (autocompleteLdap) {</span>
<a href="#l21.196"></a><span id="l21.196" class="difflineminus">-        var autocompleteDirectory = null;</span>
<a href="#l21.197"></a><span id="l21.197" class="difflineminus">-        if (params.currentIdentity.overrideGlobalPref) {</span>
<a href="#l21.198"></a><span id="l21.198" class="difflineminus">-          autocompleteDirectory = params.currentIdentity.directoryServer;</span>
<a href="#l21.199"></a><span id="l21.199" class="difflineminus">-        } else {</span>
<a href="#l21.200"></a><span id="l21.200" class="difflineminus">-          autocompleteDirectory = Services.prefs.getCharPref(</span>
<a href="#l21.201"></a><span id="l21.201" class="difflineminus">-            &quot;ldap_2.autoComplete.directoryServer&quot;</span>
<a href="#l21.202"></a><span id="l21.202" class="difflineminus">-          );</span>
<a href="#l21.203"></a><span id="l21.203" class="difflineminus">-        }</span>
<a href="#l21.204"></a><span id="l21.204" class="difflineplus">+function onSelectionChange(event) {</span>
<a href="#l21.205"></a><span id="l21.205" class="difflineplus">+  let haveSelection = gListBox.selectedItems.length;</span>
<a href="#l21.206"></a><span id="l21.206" class="difflineplus">+  gViewButton.disabled = !haveSelection;</span>
<a href="#l21.207"></a><span id="l21.207" class="difflineplus">+}</span>
<a href="#l21.208"></a><span id="l21.208"> </span>
<a href="#l21.209"></a><span id="l21.209" class="difflineminus">-        if (autocompleteDirectory) {</span>
<a href="#l21.210"></a><span id="l21.210" class="difflineminus">-          window.openDialog(</span>
<a href="#l21.211"></a><span id="l21.211" class="difflineminus">-            &quot;chrome://messenger-smime/content/certFetchingStatus.xhtml&quot;,</span>
<a href="#l21.212"></a><span id="l21.212" class="difflineminus">-            &quot;&quot;,</span>
<a href="#l21.213"></a><span id="l21.213" class="difflineminus">-            &quot;chrome,resizable=1,modal=1,dialog=1&quot;,</span>
<a href="#l21.214"></a><span id="l21.214" class="difflineminus">-            autocompleteDirectory,</span>
<a href="#l21.215"></a><span id="l21.215" class="difflineminus">-            missing</span>
<a href="#l21.216"></a><span id="l21.216" class="difflineminus">-          );</span>
<a href="#l21.217"></a><span id="l21.217" class="difflineminus">-        }</span>
<a href="#l21.218"></a><span id="l21.218" class="difflineminus">-      }</span>
<a href="#l21.219"></a><span id="l21.219" class="difflineminus">-    }</span>
<a href="#l21.220"></a><span id="l21.220" class="difflineplus">+function viewSelectedKey() {</span>
<a href="#l21.221"></a><span id="l21.221" class="difflineplus">+  if (gViewButton.disabled) {</span>
<a href="#l21.222"></a><span id="l21.222" class="difflineplus">+    return;</span>
<a href="#l21.223"></a><span id="l21.223">   }</span>
<a href="#l21.224"></a><span id="l21.224" class="difflineplus">+  EnigmailWindows.openKeyDetails(</span>
<a href="#l21.225"></a><span id="l21.225" class="difflineplus">+    window,</span>
<a href="#l21.226"></a><span id="l21.226" class="difflineplus">+    gRowToKey[gListBox.selectedIndex],</span>
<a href="#l21.227"></a><span id="l21.227" class="difflineplus">+    false</span>
<a href="#l21.228"></a><span id="l21.228" class="difflineplus">+  );</span>
<a href="#l21.229"></a><span id="l21.229" class="difflineplus">+  reload();</span>
<a href="#l21.230"></a><span id="l21.230" class="difflineplus">+}</span>
<a href="#l21.231"></a><span id="l21.231"> </span>
<a href="#l21.232"></a><span id="l21.232" class="difflineminus">-  let signedElement = document.getElementById(&quot;signed&quot;);</span>
<a href="#l21.233"></a><span id="l21.233" class="difflineminus">-  let encryptedElement = document.getElementById(&quot;encrypted&quot;);</span>
<a href="#l21.234"></a><span id="l21.234" class="difflineminus">-  if (params.smFields.requireEncryptMessage) {</span>
<a href="#l21.235"></a><span id="l21.235" class="difflineminus">-    if (params.isEncryptionCertAvailable &amp;&amp; canEncrypt) {</span>
<a href="#l21.236"></a><span id="l21.236" class="difflineminus">-      encryptedElement.value = gBundle.getString(&quot;StatusYes&quot;);</span>
<a href="#l21.237"></a><span id="l21.237" class="difflineminus">-    } else {</span>
<a href="#l21.238"></a><span id="l21.238" class="difflineminus">-      encryptedElement.value = gBundle.getString(&quot;StatusNotPossible&quot;);</span>
<a href="#l21.239"></a><span id="l21.239" class="difflineminus">-    }</span>
<a href="#l21.240"></a><span id="l21.240" class="difflineplus">+async function discoverKey() {</span>
<a href="#l21.241"></a><span id="l21.241" class="difflineplus">+  let foundKeys = null;</span>
<a href="#l21.242"></a><span id="l21.242" class="difflineplus">+  foundKeys = await EnigmailWkdLookup.downloadKey(gAddr);</span>
<a href="#l21.243"></a><span id="l21.243" class="difflineplus">+  if (!foundKeys) {</span>
<a href="#l21.244"></a><span id="l21.244" class="difflineplus">+    console.debug(&quot;searchKeysOnInternet no wkd data&quot;);</span>
<a href="#l21.245"></a><span id="l21.245">   } else {</span>
<a href="#l21.246"></a><span id="l21.246" class="difflineminus">-    encryptedElement.value = gBundle.getString(&quot;StatusNo&quot;);</span>
<a href="#l21.247"></a><span id="l21.247" class="difflineminus">-  }</span>
<a href="#l21.248"></a><span id="l21.248" class="difflineminus">-</span>
<a href="#l21.249"></a><span id="l21.249" class="difflineminus">-  if (params.smFields.signMessage) {</span>
<a href="#l21.250"></a><span id="l21.250" class="difflineminus">-    if (params.isSigningCertAvailable) {</span>
<a href="#l21.251"></a><span id="l21.251" class="difflineminus">-      signedElement.value = gBundle.getString(&quot;StatusYes&quot;);</span>
<a href="#l21.252"></a><span id="l21.252" class="difflineminus">-    } else {</span>
<a href="#l21.253"></a><span id="l21.253" class="difflineminus">-      signedElement.value = gBundle.getString(&quot;StatusNotPossible&quot;);</span>
<a href="#l21.254"></a><span id="l21.254" class="difflineplus">+    let keyList = EnigmailKey.getKeyListFromKeyBlock(</span>
<a href="#l21.255"></a><span id="l21.255" class="difflineplus">+      foundKeys.keyData,</span>
<a href="#l21.256"></a><span id="l21.256" class="difflineplus">+      {},</span>
<a href="#l21.257"></a><span id="l21.257" class="difflineplus">+      false</span>
<a href="#l21.258"></a><span id="l21.258" class="difflineplus">+    );</span>
<a href="#l21.259"></a><span id="l21.259" class="difflineplus">+    let somethingWasImported = EnigmailKeyRing.importKeyDataWithConfirmation(</span>
<a href="#l21.260"></a><span id="l21.260" class="difflineplus">+      window,</span>
<a href="#l21.261"></a><span id="l21.261" class="difflineplus">+      keyList,</span>
<a href="#l21.262"></a><span id="l21.262" class="difflineplus">+      foundKeys.keyData,</span>
<a href="#l21.263"></a><span id="l21.263" class="difflineplus">+      true</span>
<a href="#l21.264"></a><span id="l21.264" class="difflineplus">+    );</span>
<a href="#l21.265"></a><span id="l21.265" class="difflineplus">+    if (somethingWasImported) {</span>
<a href="#l21.266"></a><span id="l21.266" class="difflineplus">+      reload();</span>
<a href="#l21.267"></a><span id="l21.267">     }</span>
<a href="#l21.268"></a><span id="l21.268" class="difflineminus">-  } else {</span>
<a href="#l21.269"></a><span id="l21.269" class="difflineminus">-    signedElement.value = gBundle.getString(&quot;StatusNo&quot;);</span>
<a href="#l21.270"></a><span id="l21.270" class="difflineplus">+    return;</span>
<a href="#l21.271"></a><span id="l21.271">   }</span>
<a href="#l21.272"></a><span id="l21.272"> </span>
<a href="#l21.273"></a><span id="l21.273" class="difflineminus">-  for (let i = 0; i &lt; emailAddresses.length; ++i) {</span>
<a href="#l21.274"></a><span id="l21.274" class="difflineminus">-    let email = document.createXULElement(&quot;label&quot;);</span>
<a href="#l21.275"></a><span id="l21.275" class="difflineminus">-    email.setAttribute(&quot;value&quot;, emailAddresses[i]);</span>
<a href="#l21.276"></a><span id="l21.276" class="difflineminus">-    email.setAttribute(&quot;crop&quot;, &quot;end&quot;);</span>
<a href="#l21.277"></a><span id="l21.277" class="difflineminus">-    email.setAttribute(&quot;style&quot;, &quot;width: var(--recipientWidth)&quot;);</span>
<a href="#l21.278"></a><span id="l21.278" class="difflineminus">-</span>
<a href="#l21.279"></a><span id="l21.279" class="difflineminus">-    let listitem = document.createXULElement(&quot;richlistitem&quot;);</span>
<a href="#l21.280"></a><span id="l21.280" class="difflineminus">-    listitem.appendChild(email);</span>
<a href="#l21.281"></a><span id="l21.281" class="difflineminus">-</span>
<a href="#l21.282"></a><span id="l21.282" class="difflineminus">-    if (!certs[i]) {</span>
<a href="#l21.283"></a><span id="l21.283" class="difflineminus">-      let notFound = document.createXULElement(&quot;label&quot;);</span>
<a href="#l21.284"></a><span id="l21.284" class="difflineminus">-      notFound.setAttribute(&quot;value&quot;, gBundle.getString(&quot;StatusNotFound&quot;));</span>
<a href="#l21.285"></a><span id="l21.285" class="difflineminus">-      notFound.setAttribute(&quot;style&quot;, &quot;width: var(--statusWidth)&quot;);</span>
<a href="#l21.286"></a><span id="l21.286" class="difflineminus">-      listitem.appendChild(notFound);</span>
<a href="#l21.287"></a><span id="l21.287" class="difflineminus">-    } else {</span>
<a href="#l21.288"></a><span id="l21.288" class="difflineminus">-      let status = document.createXULElement(&quot;label&quot;);</span>
<a href="#l21.289"></a><span id="l21.289" class="difflineminus">-      status.setAttribute(&quot;value&quot;, &quot;?&quot;); // temporary placeholder</span>
<a href="#l21.290"></a><span id="l21.290" class="difflineminus">-      status.setAttribute(&quot;crop&quot;, &quot;end&quot;);</span>
<a href="#l21.291"></a><span id="l21.291" class="difflineminus">-      status.setAttribute(&quot;style&quot;, &quot;width: var(--statusWidth)&quot;);</span>
<a href="#l21.292"></a><span id="l21.292" class="difflineminus">-      listitem.appendChild(status);</span>
<a href="#l21.293"></a><span id="l21.293" class="difflineminus">-</span>
<a href="#l21.294"></a><span id="l21.294" class="difflineminus">-      let issued = document.createXULElement(&quot;label&quot;);</span>
<a href="#l21.295"></a><span id="l21.295" class="difflineminus">-      issued.setAttribute(&quot;value&quot;, certIssuedInfos[i]);</span>
<a href="#l21.296"></a><span id="l21.296" class="difflineminus">-      issued.setAttribute(&quot;crop&quot;, &quot;end&quot;);</span>
<a href="#l21.297"></a><span id="l21.297" class="difflineminus">-      issued.setAttribute(&quot;style&quot;, &quot;width: var(--issuedWidth)&quot;);</span>
<a href="#l21.298"></a><span id="l21.298" class="difflineminus">-      listitem.appendChild(issued);</span>
<a href="#l21.299"></a><span id="l21.299" class="difflineminus">-</span>
<a href="#l21.300"></a><span id="l21.300" class="difflineminus">-      let expire = document.createXULElement(&quot;label&quot;);</span>
<a href="#l21.301"></a><span id="l21.301" class="difflineminus">-      expire.setAttribute(&quot;value&quot;, certExpiresInfos[i]);</span>
<a href="#l21.302"></a><span id="l21.302" class="difflineminus">-      expire.setAttribute(&quot;crop&quot;, &quot;end&quot;);</span>
<a href="#l21.303"></a><span id="l21.303" class="difflineminus">-      expire.setAttribute(&quot;style&quot;, &quot;width: var(--expireWidth)&quot;);</span>
<a href="#l21.304"></a><span id="l21.304" class="difflineminus">-      listitem.appendChild(expire);</span>
<a href="#l21.305"></a><span id="l21.305" class="difflineminus">-</span>
<a href="#l21.306"></a><span id="l21.306" class="difflineminus">-      asyncDetermineUsages(certs[i]).then(results =&gt; {</span>
<a href="#l21.307"></a><span id="l21.307" class="difflineminus">-        let someError = results.some(</span>
<a href="#l21.308"></a><span id="l21.308" class="difflineminus">-          result =&gt; result.errorCode !== PRErrorCodeSuccess</span>
<a href="#l21.309"></a><span id="l21.309" class="difflineminus">-        );</span>
<a href="#l21.310"></a><span id="l21.310" class="difflineminus">-        if (!someError) {</span>
<a href="#l21.311"></a><span id="l21.311" class="difflineminus">-          status.setAttribute(&quot;value&quot;, gBundle.getString(&quot;StatusValid&quot;));</span>
<a href="#l21.312"></a><span id="l21.312" class="difflineminus">-          return;</span>
<a href="#l21.313"></a><span id="l21.313" class="difflineminus">-        }</span>
<a href="#l21.314"></a><span id="l21.314" class="difflineplus">+  let defKs = EnigmailKeyserverURIs.getDefaultKeyServer();</span>
<a href="#l21.315"></a><span id="l21.315" class="difflineplus">+  if (!defKs) {</span>
<a href="#l21.316"></a><span id="l21.316" class="difflineplus">+    return;</span>
<a href="#l21.317"></a><span id="l21.317" class="difflineplus">+  }</span>
<a href="#l21.318"></a><span id="l21.318"> </span>
<a href="#l21.319"></a><span id="l21.319" class="difflineminus">-        // Keep in sync with certViewer.js.</span>
<a href="#l21.320"></a><span id="l21.320" class="difflineminus">-        const SEC_ERROR_BASE = Ci.nsINSSErrorsService.NSS_SEC_ERROR_BASE;</span>
<a href="#l21.321"></a><span id="l21.321" class="difflineminus">-        const SEC_ERROR_EXPIRED_CERTIFICATE = SEC_ERROR_BASE + 11;</span>
<a href="#l21.322"></a><span id="l21.322" class="difflineminus">-        const SEC_ERROR_REVOKED_CERTIFICATE = SEC_ERROR_BASE + 12;</span>
<a href="#l21.323"></a><span id="l21.323" class="difflineminus">-        const SEC_ERROR_UNKNOWN_ISSUER = SEC_ERROR_BASE + 13;</span>
<a href="#l21.324"></a><span id="l21.324" class="difflineminus">-        const SEC_ERROR_UNTRUSTED_ISSUER = SEC_ERROR_BASE + 20;</span>
<a href="#l21.325"></a><span id="l21.325" class="difflineminus">-        const SEC_ERROR_UNTRUSTED_CERT = SEC_ERROR_BASE + 21;</span>
<a href="#l21.326"></a><span id="l21.326" class="difflineminus">-        const SEC_ERROR_EXPIRED_ISSUER_CERTIFICATE = SEC_ERROR_BASE + 30;</span>
<a href="#l21.327"></a><span id="l21.327" class="difflineminus">-        const SEC_ERROR_CERT_SIGNATURE_ALGORITHM_DISABLED =</span>
<a href="#l21.328"></a><span id="l21.328" class="difflineminus">-          SEC_ERROR_BASE + 176;</span>
<a href="#l21.329"></a><span id="l21.329" class="difflineminus">-</span>
<a href="#l21.330"></a><span id="l21.330" class="difflineminus">-        const errorRankings = [</span>
<a href="#l21.331"></a><span id="l21.331" class="difflineminus">-          {</span>
<a href="#l21.332"></a><span id="l21.332" class="difflineminus">-            error: SEC_ERROR_REVOKED_CERTIFICATE,</span>
<a href="#l21.333"></a><span id="l21.333" class="difflineminus">-            bundleString: &quot;StatusRevoked&quot;,</span>
<a href="#l21.334"></a><span id="l21.334" class="difflineminus">-          },</span>
<a href="#l21.335"></a><span id="l21.335" class="difflineminus">-          { error: SEC_ERROR_UNTRUSTED_CERT, bundleString: &quot;StatusUntrusted&quot; },</span>
<a href="#l21.336"></a><span id="l21.336" class="difflineminus">-          {</span>
<a href="#l21.337"></a><span id="l21.337" class="difflineminus">-            error: SEC_ERROR_UNTRUSTED_ISSUER,</span>
<a href="#l21.338"></a><span id="l21.338" class="difflineminus">-            bundleString: &quot;StatusUntrusted&quot;,</span>
<a href="#l21.339"></a><span id="l21.339" class="difflineminus">-          },</span>
<a href="#l21.340"></a><span id="l21.340" class="difflineminus">-          {</span>
<a href="#l21.341"></a><span id="l21.341" class="difflineminus">-            error: SEC_ERROR_CERT_SIGNATURE_ALGORITHM_DISABLED,</span>
<a href="#l21.342"></a><span id="l21.342" class="difflineminus">-            bundleString: &quot;StatusInvalid&quot;,</span>
<a href="#l21.343"></a><span id="l21.343" class="difflineminus">-          },</span>
<a href="#l21.344"></a><span id="l21.344" class="difflineminus">-          {</span>
<a href="#l21.345"></a><span id="l21.345" class="difflineminus">-            error: SEC_ERROR_EXPIRED_CERTIFICATE,</span>
<a href="#l21.346"></a><span id="l21.346" class="difflineminus">-            bundleString: &quot;StatusExpired&quot;,</span>
<a href="#l21.347"></a><span id="l21.347" class="difflineminus">-          },</span>
<a href="#l21.348"></a><span id="l21.348" class="difflineminus">-          {</span>
<a href="#l21.349"></a><span id="l21.349" class="difflineminus">-            error: SEC_ERROR_EXPIRED_ISSUER_CERTIFICATE,</span>
<a href="#l21.350"></a><span id="l21.350" class="difflineminus">-            bundleString: &quot;StatusExpired&quot;,</span>
<a href="#l21.351"></a><span id="l21.351" class="difflineminus">-          },</span>
<a href="#l21.352"></a><span id="l21.352" class="difflineminus">-          { error: SEC_ERROR_UNKNOWN_ISSUER, bundleString: &quot;StatusUntrusted&quot; },</span>
<a href="#l21.353"></a><span id="l21.353" class="difflineminus">-        ];</span>
<a href="#l21.354"></a><span id="l21.354" class="difflineminus">-</span>
<a href="#l21.355"></a><span id="l21.355" class="difflineminus">-        let bs = &quot;StatusInvalid&quot;;</span>
<a href="#l21.356"></a><span id="l21.356" class="difflineminus">-        for (let errorRanking of errorRankings) {</span>
<a href="#l21.357"></a><span id="l21.357" class="difflineminus">-          let errorPresent = results.some(</span>
<a href="#l21.358"></a><span id="l21.358" class="difflineminus">-            result =&gt; result.errorCode == errorRanking.error</span>
<a href="#l21.359"></a><span id="l21.359" class="difflineminus">-          );</span>
<a href="#l21.360"></a><span id="l21.360" class="difflineminus">-          if (errorPresent) {</span>
<a href="#l21.361"></a><span id="l21.361" class="difflineminus">-            bs = errorRanking.bundleString;</span>
<a href="#l21.362"></a><span id="l21.362" class="difflineminus">-            break;</span>
<a href="#l21.363"></a><span id="l21.363" class="difflineminus">-          }</span>
<a href="#l21.364"></a><span id="l21.364" class="difflineminus">-        }</span>
<a href="#l21.365"></a><span id="l21.365" class="difflineminus">-</span>
<a href="#l21.366"></a><span id="l21.366" class="difflineminus">-        status.setAttribute(&quot;value&quot;, gBundle.getString(bs));</span>
<a href="#l21.367"></a><span id="l21.367" class="difflineminus">-      });</span>
<a href="#l21.368"></a><span id="l21.368" class="difflineplus">+  let vks = await EnigmailKeyServer.downloadNoImport(gAddr, defKs);</span>
<a href="#l21.369"></a><span id="l21.369" class="difflineplus">+  if (&quot;keyData&quot; in vks) {</span>
<a href="#l21.370"></a><span id="l21.370" class="difflineplus">+    let keyList = EnigmailKey.getKeyListFromKeyBlock(</span>
<a href="#l21.371"></a><span id="l21.371" class="difflineplus">+      vks.keyData,</span>
<a href="#l21.372"></a><span id="l21.372" class="difflineplus">+      {},</span>
<a href="#l21.373"></a><span id="l21.373" class="difflineplus">+      false,</span>
<a href="#l21.374"></a><span id="l21.374" class="difflineplus">+      true,</span>
<a href="#l21.375"></a><span id="l21.375" class="difflineplus">+      false</span>
<a href="#l21.376"></a><span id="l21.376" class="difflineplus">+    );</span>
<a href="#l21.377"></a><span id="l21.377" class="difflineplus">+    let somethingWasImported = EnigmailKeyRing.importKeyDataWithConfirmation(</span>
<a href="#l21.378"></a><span id="l21.378" class="difflineplus">+      window,</span>
<a href="#l21.379"></a><span id="l21.379" class="difflineplus">+      keyList,</span>
<a href="#l21.380"></a><span id="l21.380" class="difflineplus">+      vks.keyData,</span>
<a href="#l21.381"></a><span id="l21.381" class="difflineplus">+      true</span>
<a href="#l21.382"></a><span id="l21.382" class="difflineplus">+    );</span>
<a href="#l21.383"></a><span id="l21.383" class="difflineplus">+    if (somethingWasImported) {</span>
<a href="#l21.384"></a><span id="l21.384" class="difflineplus">+      reload();</span>
<a href="#l21.385"></a><span id="l21.385">     }</span>
<a href="#l21.386"></a><span id="l21.386" class="difflineminus">-</span>
<a href="#l21.387"></a><span id="l21.387" class="difflineminus">-    gListBox.appendChild(listitem);</span>
<a href="#l21.388"></a><span id="l21.388" class="difflineplus">+  } else {</span>
<a href="#l21.389"></a><span id="l21.389" class="difflineplus">+    console.debug(&quot;searchKeysOnInternet no data in keys.openpgp.org&quot;);</span>
<a href="#l21.390"></a><span id="l21.390">   }</span>
<a href="#l21.391"></a><span id="l21.391"> }</span>
<a href="#l21.392"></a><span id="l21.392" class="difflineminus">-</span>
<a href="#l21.393"></a><span id="l21.393" class="difflineminus">-// --- borrowed from pippki.js ---</span>
<a href="#l21.394"></a><span id="l21.394" class="difflineminus">-const PRErrorCodeSuccess = 0;</span>
<a href="#l21.395"></a><span id="l21.395" class="difflineminus">-</span>
<a href="#l21.396"></a><span id="l21.396" class="difflineminus">-const certificateUsageEmailSigner = 0x0010;</span>
<a href="#l21.397"></a><span id="l21.397" class="difflineminus">-const certificateUsageEmailRecipient = 0x0020;</span>
<a href="#l21.398"></a><span id="l21.398" class="difflineminus">-</span>
<a href="#l21.399"></a><span id="l21.399" class="difflineminus">-// A map from the name of a certificate usage to the value of the usage.</span>
<a href="#l21.400"></a><span id="l21.400" class="difflineminus">-const certificateUsages = {</span>
<a href="#l21.401"></a><span id="l21.401" class="difflineminus">-  certificateUsageEmailRecipient,</span>
<a href="#l21.402"></a><span id="l21.402" class="difflineminus">-};</span>
<a href="#l21.403"></a><span id="l21.403" class="difflineminus">-</span>
<a href="#l21.404"></a><span id="l21.404" class="difflineminus">-function asyncDetermineUsages(cert) {</span>
<a href="#l21.405"></a><span id="l21.405" class="difflineminus">-  let promises = [];</span>
<a href="#l21.406"></a><span id="l21.406" class="difflineminus">-  let now = Date.now() / 1000;</span>
<a href="#l21.407"></a><span id="l21.407" class="difflineminus">-  let certdb = Cc[&quot;@mozilla.org/security/x509certdb;1&quot;].getService(</span>
<a href="#l21.408"></a><span id="l21.408" class="difflineminus">-    Ci.nsIX509CertDB</span>
<a href="#l21.409"></a><span id="l21.409" class="difflineminus">-  );</span>
<a href="#l21.410"></a><span id="l21.410" class="difflineminus">-  Object.keys(certificateUsages).forEach(usageString =&gt; {</span>
<a href="#l21.411"></a><span id="l21.411" class="difflineminus">-    promises.push(</span>
<a href="#l21.412"></a><span id="l21.412" class="difflineminus">-      new Promise((resolve, reject) =&gt; {</span>
<a href="#l21.413"></a><span id="l21.413" class="difflineminus">-        let usage = certificateUsages[usageString];</span>
<a href="#l21.414"></a><span id="l21.414" class="difflineminus">-        certdb.asyncVerifyCertAtTime(</span>
<a href="#l21.415"></a><span id="l21.415" class="difflineminus">-          cert,</span>
<a href="#l21.416"></a><span id="l21.416" class="difflineminus">-          usage,</span>
<a href="#l21.417"></a><span id="l21.417" class="difflineminus">-          0,</span>
<a href="#l21.418"></a><span id="l21.418" class="difflineminus">-          null,</span>
<a href="#l21.419"></a><span id="l21.419" class="difflineminus">-          now,</span>
<a href="#l21.420"></a><span id="l21.420" class="difflineminus">-          (aPRErrorCode, aVerifiedChain, aHasEVPolicy) =&gt; {</span>
<a href="#l21.421"></a><span id="l21.421" class="difflineminus">-            resolve({</span>
<a href="#l21.422"></a><span id="l21.422" class="difflineminus">-              usageString,</span>
<a href="#l21.423"></a><span id="l21.423" class="difflineminus">-              errorCode: aPRErrorCode,</span>
<a href="#l21.424"></a><span id="l21.424" class="difflineminus">-              chain: aVerifiedChain,</span>
<a href="#l21.425"></a><span id="l21.425" class="difflineminus">-            });</span>
<a href="#l21.426"></a><span id="l21.426" class="difflineminus">-          }</span>
<a href="#l21.427"></a><span id="l21.427" class="difflineminus">-        );</span>
<a href="#l21.428"></a><span id="l21.428" class="difflineminus">-      })</span>
<a href="#l21.429"></a><span id="l21.429" class="difflineminus">-    );</span>
<a href="#l21.430"></a><span id="l21.430" class="difflineminus">-  });</span>
<a href="#l21.431"></a><span id="l21.431" class="difflineminus">-  return Promise.all(promises);</span>
<a href="#l21.432"></a><span id="l21.432" class="difflineminus">-}</span>
<a href="#l21.433"></a><span id="l21.433" class="difflineminus">-// --- /borrowed from pippki.js ---</span>
<a href="#l21.434"></a><span id="l21.434" class="difflineminus">-</span>
<a href="#l21.435"></a><span id="l21.435" class="difflineminus">-function onSelectionChange(event) {</span>
<a href="#l21.436"></a><span id="l21.436" class="difflineminus">-  gViewButton.disabled = !(</span>
<a href="#l21.437"></a><span id="l21.437" class="difflineminus">-    gListBox.selectedItems.length == 1 &amp;&amp; certForRow(gListBox.selectedIndex)</span>
<a href="#l21.438"></a><span id="l21.438" class="difflineminus">-  );</span>
<a href="#l21.439"></a><span id="l21.439" class="difflineminus">-}</span>
<a href="#l21.440"></a><span id="l21.440" class="difflineminus">-</span>
<a href="#l21.441"></a><span id="l21.441" class="difflineminus">-function viewCertHelper(parent, cert) {</span>
<a href="#l21.442"></a><span id="l21.442" class="difflineminus">-  Services.ww.openWindow(</span>
<a href="#l21.443"></a><span id="l21.443" class="difflineminus">-    parent,</span>
<a href="#l21.444"></a><span id="l21.444" class="difflineminus">-    &quot;chrome://pippki/content/certViewer.xhtml&quot;,</span>
<a href="#l21.445"></a><span id="l21.445" class="difflineminus">-    &quot;_blank&quot;,</span>
<a href="#l21.446"></a><span id="l21.446" class="difflineminus">-    &quot;centerscreen,chrome,titlebar&quot;,</span>
<a href="#l21.447"></a><span id="l21.447" class="difflineminus">-    cert</span>
<a href="#l21.448"></a><span id="l21.448" class="difflineminus">-  );</span>
<a href="#l21.449"></a><span id="l21.449" class="difflineminus">-}</span>
<a href="#l21.450"></a><span id="l21.450" class="difflineminus">-</span>
<a href="#l21.451"></a><span id="l21.451" class="difflineminus">-function certForRow(aRowIndex) {</span>
<a href="#l21.452"></a><span id="l21.452" class="difflineminus">-  return gCerts[aRowIndex];</span>
<a href="#l21.453"></a><span id="l21.453" class="difflineminus">-}</span>
<a href="#l21.454"></a><span id="l21.454" class="difflineminus">-</span>
<a href="#l21.455"></a><span id="l21.455" class="difflineminus">-function viewSelectedCert() {</span>
<a href="#l21.456"></a><span id="l21.456" class="difflineminus">-  if (!gViewButton.disabled) {</span>
<a href="#l21.457"></a><span id="l21.457" class="difflineminus">-    viewCertHelper(window, certForRow(gListBox.selectedIndex));</span>
<a href="#l21.458"></a><span id="l21.458" class="difflineminus">-  }</span>
<a href="#l21.459"></a><span id="l21.459" class="difflineminus">-}</span>
<a href="#l21.460"></a><span id="l21.460" class="difflineminus">-</span>
<a href="#l21.461"></a><span id="l21.461" class="difflineminus">-/* globals openHelp */</span>
<a href="#l21.462"></a><span id="l21.462" class="difflineminus">-// Suite only.</span>
<a href="#l21.463"></a><span id="l21.463" class="difflineminus">-function doHelpButton() {</span>
<a href="#l21.464"></a><span id="l21.464" class="difflineminus">-  openHelp(</span>
<a href="#l21.465"></a><span id="l21.465" class="difflineminus">-    &quot;compose_security&quot;,</span>
<a href="#l21.466"></a><span id="l21.466" class="difflineminus">-    &quot;chrome://communicator/locale/help/suitehelp.rdf&quot;</span>
<a href="#l21.467"></a><span id="l21.467" class="difflineminus">-  );</span>
<a href="#l21.468"></a><span id="l21.468" class="difflineminus">-}</span>
<a href="#l21.469"></a><span id="l21.469" class="difflineminus">-</span>
<a href="#l21.470"></a><span id="l21.470" class="difflineminus">-function createCell(label) {</span>
<a href="#l21.471"></a><span id="l21.471" class="difflineminus">-  var cell = document.createXULElement(&quot;listcell&quot;);</span>
<a href="#l21.472"></a><span id="l21.472" class="difflineminus">-  cell.setAttribute(&quot;label&quot;, label);</span>
<a href="#l21.473"></a><span id="l21.473" class="difflineminus">-  return cell;</span>
<a href="#l21.474"></a><span id="l21.474" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1">copy from mailnews/extensions/smime/content/msgCompSecurityInfo.xhtml</span>
<a href="#l22.2"></a><span id="l22.2">copy to mail/extensions/openpgp/content/ui/oneRecipientStatus.xhtml</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineminus">--- a/mailnews/extensions/smime/content/msgCompSecurityInfo.xhtml</span>
<a href="#l22.4"></a><span id="l22.4" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/oneRecipientStatus.xhtml</span>
<a href="#l22.5"></a><span id="l22.5" class="difflineat">@@ -1,68 +1,60 @@</span>
<a href="#l22.6"></a><span id="l22.6"> &lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l22.7"></a><span id="l22.7"> &lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l22.8"></a><span id="l22.8">    - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l22.9"></a><span id="l22.9">    - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l22.10"></a><span id="l22.10"> </span>
<a href="#l22.11"></a><span id="l22.11"> &lt;?xml-stylesheet href=&quot;chrome://global/skin/global.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-&lt;?xml-stylesheet href=&quot;chrome://messenger/skin/smime/msgCompSecurityInfo.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://messenger/skin/openpgp/oneRecipientStatus.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l22.14"></a><span id="l22.14"> </span>
<a href="#l22.15"></a><span id="l22.15" class="difflineminus">-&lt;!DOCTYPE window SYSTEM &quot;chrome://messenger-smime/locale/msgCompSecurityInfo.dtd&quot;&gt;</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineplus">+&lt;!DOCTYPE window SYSTEM &quot;chrome://openpgp/content/strings/oneRecipientStatus.dtd&quot;&gt;</span>
<a href="#l22.17"></a><span id="l22.17"> </span>
<a href="#l22.18"></a><span id="l22.18" class="difflineminus">-&lt;window title=&quot;&amp;title.label;&quot;</span>
<a href="#l22.19"></a><span id="l22.19" class="difflineplus">+&lt;window title=&quot;&amp;oneRecipientStatus.title;&quot;</span>
<a href="#l22.20"></a><span id="l22.20">         xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot; xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineminus">-        style=&quot;width: 50em;&quot;</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineplus">+        style=&quot;width: 50em; height: 22em&quot;</span>
<a href="#l22.23"></a><span id="l22.23">         persist=&quot;width height&quot;</span>
<a href="#l22.24"></a><span id="l22.24">         onload=&quot;onLoad();&quot;&gt;</span>
<a href="#l22.25"></a><span id="l22.25" class="difflineminus">-&lt;dialog id=&quot;msgCompSecurityInfo&quot;</span>
<a href="#l22.26"></a><span id="l22.26" class="difflineplus">+&lt;dialog id=&quot;oneRecipientStatus&quot;</span>
<a href="#l22.27"></a><span id="l22.27">         buttons=&quot;accept&quot;&gt;</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineminus">-  &lt;script src=&quot;chrome://messenger-smime/content/msgCompSecurityInfo.js&quot;/&gt;</span>
<a href="#l22.29"></a><span id="l22.29" class="difflineplus">+  &lt;script src=&quot;chrome://openpgp/content/ui/oneRecipientStatus.js&quot;/&gt;</span>
<a href="#l22.30"></a><span id="l22.30">   &lt;script&gt;&lt;![CDATA[</span>
<a href="#l22.31"></a><span id="l22.31">       function resizeColumns() {</span>
<a href="#l22.32"></a><span id="l22.32">         let list = document.getElementById(&quot;infolist&quot;);</span>
<a href="#l22.33"></a><span id="l22.33">         let cols = list.getElementsByTagName(&quot;treecol&quot;);</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineminus">-        list.style.setProperty(&quot;--recipientWidth&quot;, cols[0].getBoundingClientRect().width + &quot;px&quot;);</span>
<a href="#l22.35"></a><span id="l22.35" class="difflineplus">+        list.style.setProperty(&quot;--keyWidth&quot;, cols[0].getBoundingClientRect().width + &quot;px&quot;);</span>
<a href="#l22.36"></a><span id="l22.36">         list.style.setProperty(&quot;--statusWidth&quot;, cols[1].getBoundingClientRect().width + &quot;px&quot;);</span>
<a href="#l22.37"></a><span id="l22.37">         list.style.setProperty(&quot;--issuedWidth&quot;, cols[2].getBoundingClientRect().width + &quot;px&quot;);</span>
<a href="#l22.38"></a><span id="l22.38">         list.style.setProperty(&quot;--expireWidth&quot;, cols[3].getBoundingClientRect().width - 5 + &quot;px&quot;);</span>
<a href="#l22.39"></a><span id="l22.39">       }</span>
<a href="#l22.40"></a><span id="l22.40">       addEventListener(&quot;load&quot;, resizeColumns, { once: true });</span>
<a href="#l22.41"></a><span id="l22.41">       addEventListener(&quot;resize&quot;, resizeColumns);</span>
<a href="#l22.42"></a><span id="l22.42">   ]]&gt;&lt;/script&gt;</span>
<a href="#l22.43"></a><span id="l22.43"> </span>
<a href="#l22.44"></a><span id="l22.44" class="difflineminus">-  &lt;stringbundle id=&quot;bundle_smime_comp_info&quot; src=&quot;chrome://messenger-smime/locale/msgCompSecurityInfo.properties&quot;/&gt;</span>
<a href="#l22.45"></a><span id="l22.45" class="difflineplus">+  &lt;stringbundle id=&quot;bundle_one_recip_info&quot; src=&quot;chrome://openpgp/content/strings/oneRecipientStatus.properties&quot;/&gt;</span>
<a href="#l22.46"></a><span id="l22.46"> </span>
<a href="#l22.47"></a><span id="l22.47" class="difflineminus">-  &lt;description&gt;&amp;subject.plaintextWarning;&lt;/description&gt;</span>
<a href="#l22.48"></a><span id="l22.48" class="difflineplus">+  &lt;description&gt;&amp;oneRecipientStatus.instruction1;&lt;/description&gt;</span>
<a href="#l22.49"></a><span id="l22.49">   &lt;separator class=&quot;thin&quot;/&gt;</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineminus">-  &lt;description&gt;&amp;status.heading;&lt;/description&gt;</span>
<a href="#l22.51"></a><span id="l22.51" class="difflineminus">-  &lt;hbox&gt;</span>
<a href="#l22.52"></a><span id="l22.52" class="difflineminus">-    &lt;vbox&gt;</span>
<a href="#l22.53"></a><span id="l22.53" class="difflineminus">-      &lt;label value=&quot;&amp;status.signed;&quot;/&gt;</span>
<a href="#l22.54"></a><span id="l22.54" class="difflineminus">-      &lt;label value=&quot;&amp;status.encrypted;&quot;/&gt;</span>
<a href="#l22.55"></a><span id="l22.55" class="difflineminus">-    &lt;/vbox&gt;</span>
<a href="#l22.56"></a><span id="l22.56" class="difflineminus">-    &lt;vbox&gt;</span>
<a href="#l22.57"></a><span id="l22.57" class="difflineminus">-      &lt;label id=&quot;signed&quot;/&gt;</span>
<a href="#l22.58"></a><span id="l22.58" class="difflineminus">-      &lt;label id=&quot;encrypted&quot;/&gt;</span>
<a href="#l22.59"></a><span id="l22.59" class="difflineminus">-    &lt;/vbox&gt;</span>
<a href="#l22.60"></a><span id="l22.60" class="difflineminus">-  &lt;/hbox&gt;</span>
<a href="#l22.61"></a><span id="l22.61" class="difflineminus">-</span>
<a href="#l22.62"></a><span id="l22.62" class="difflineplus">+  &lt;description&gt;&amp;oneRecipientStatus.instruction2;&lt;/description&gt;</span>
<a href="#l22.63"></a><span id="l22.63">   &lt;separator class=&quot;thin&quot;/&gt;</span>
<a href="#l22.64"></a><span id="l22.64" class="difflineminus">-  &lt;label value=&quot;&amp;status.certificates;&quot; control=&quot;infolist&quot;/&gt;</span>
<a href="#l22.65"></a><span id="l22.65" class="difflineplus">+  &lt;label id=&quot;intro&quot; control=&quot;infolist&quot;/&gt;</span>
<a href="#l22.66"></a><span id="l22.66"> </span>
<a href="#l22.67"></a><span id="l22.67">   &lt;richlistbox id=&quot;infolist&quot;</span>
<a href="#l22.68"></a><span id="l22.68">                class=&quot;theme-listbox&quot;</span>
<a href="#l22.69"></a><span id="l22.69">                flex=&quot;1&quot;</span>
<a href="#l22.70"></a><span id="l22.70">                onselect=&quot;onSelectionChange(event);&quot;&gt;</span>
<a href="#l22.71"></a><span id="l22.71">     &lt;treecols&gt;</span>
<a href="#l22.72"></a><span id="l22.72" class="difflineminus">-      &lt;treecol flex=&quot;3&quot; label=&quot;&amp;tree.recipient;&quot;/&gt;</span>
<a href="#l22.73"></a><span id="l22.73" class="difflineminus">-      &lt;treecol flex=&quot;1&quot; label=&quot;&amp;tree.status;&quot;/&gt;</span>
<a href="#l22.74"></a><span id="l22.74" class="difflineminus">-      &lt;treecol flex=&quot;2&quot; label=&quot;&amp;tree.issuedDate;&quot;/&gt;</span>
<a href="#l22.75"></a><span id="l22.75" class="difflineminus">-      &lt;treecol flex=&quot;2&quot; label=&quot;&amp;tree.expiresDate;&quot;/&gt;</span>
<a href="#l22.76"></a><span id="l22.76" class="difflineplus">+      &lt;treecol flex=&quot;3&quot; label=&quot;&amp;oneRecipientStatus.keyId;&quot;/&gt;</span>
<a href="#l22.77"></a><span id="l22.77" class="difflineplus">+      &lt;treecol flex=&quot;4&quot; label=&quot;&amp;oneRecipientStatus.status;&quot;/&gt;</span>
<a href="#l22.78"></a><span id="l22.78" class="difflineplus">+      &lt;treecol flex=&quot;1&quot; label=&quot;&amp;oneRecipientStatus.createdDate;&quot;/&gt;</span>
<a href="#l22.79"></a><span id="l22.79" class="difflineplus">+      &lt;treecol flex=&quot;1&quot; label=&quot;&amp;oneRecipientStatus.expiresDate;&quot;/&gt;</span>
<a href="#l22.80"></a><span id="l22.80">     &lt;/treecols&gt;</span>
<a href="#l22.81"></a><span id="l22.81">   &lt;/richlistbox&gt;</span>
<a href="#l22.82"></a><span id="l22.82">   &lt;hbox pack=&quot;start&quot;&gt;</span>
<a href="#l22.83"></a><span id="l22.83" class="difflineminus">-    &lt;button id=&quot;viewCertButton&quot; disabled=&quot;true&quot;</span>
<a href="#l22.84"></a><span id="l22.84" class="difflineminus">-            label=&quot;&amp;view.label;&quot; accesskey=&quot;&amp;view.accesskey;&quot;</span>
<a href="#l22.85"></a><span id="l22.85" class="difflineminus">-            oncommand=&quot;viewSelectedCert();&quot;/&gt;</span>
<a href="#l22.86"></a><span id="l22.86" class="difflineplus">+    &lt;button id=&quot;detailsButton&quot; disabled=&quot;true&quot;</span>
<a href="#l22.87"></a><span id="l22.87" class="difflineplus">+            label=&quot;&amp;oneRecipientStatus.openDetails;&quot;</span>
<a href="#l22.88"></a><span id="l22.88" class="difflineplus">+            oncommand=&quot;viewSelectedKey();&quot;/&gt;</span>
<a href="#l22.89"></a><span id="l22.89" class="difflineplus">+    &lt;button id=&quot;discoverButton&quot;</span>
<a href="#l22.90"></a><span id="l22.90" class="difflineplus">+            label=&quot;&amp;oneRecipientStatus.discover;&quot;</span>
<a href="#l22.91"></a><span id="l22.91" class="difflineplus">+            oncommand=&quot;discoverKey();&quot;/&gt;</span>
<a href="#l22.92"></a><span id="l22.92">   &lt;/hbox&gt;</span>
<a href="#l22.93"></a><span id="l22.93"> &lt;/dialog&gt;</span>
<a href="#l22.94"></a><span id="l22.94"> &lt;/window&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mail/extensions/openpgp/jar.mn</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mail/extensions/openpgp/jar.mn</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -6,15 +6,19 @@</span>
<a href="#l23.4"></a><span id="l23.4"> openpgp.jar:</span>
<a href="#l23.5"></a><span id="l23.5"> % content openpgp %content/openpgp/</span>
<a href="#l23.6"></a><span id="l23.6">   content/openpgp/BondOpenPGP.jsm              (content/BondOpenPGP.jsm)</span>
<a href="#l23.7"></a><span id="l23.7">   content/openpgp/modules                      (content/modules/*.js*)</span>
<a href="#l23.8"></a><span id="l23.8">   content/openpgp/modules/stdlib               (content/modules/stdlib/*.js*)</span>
<a href="#l23.9"></a><span id="l23.9">   content/openpgp/modules/cryptoAPI            (content/modules/cryptoAPI/*.js*)</span>
<a href="#l23.10"></a><span id="l23.10">   content/openpgp/strings/enigmail.properties  (content/strings/enigmail.properties)</span>
<a href="#l23.11"></a><span id="l23.11">   content/openpgp/strings/enigmail.dtd         (content/strings/enigmail.dtd)</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineplus">+  content/openpgp/strings/oneRecipientStatus.properties (content/strings/oneRecipientStatus.properties)</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+  content/openpgp/strings/oneRecipientStatus.dtd        (content/strings/oneRecipientStatus.dtd)</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineplus">+  content/openpgp/strings/composeKeyStatus.properties   (content/strings/composeKeyStatus.properties)</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineplus">+  content/openpgp/strings/composeKeyStatus.dtd          (content/strings/composeKeyStatus.dtd)</span>
<a href="#l23.16"></a><span id="l23.16">   content/openpgp/strings/bond.dtd             (content/strings/bond.dtd)</span>
<a href="#l23.17"></a><span id="l23.17">   content/openpgp/ui                           (content/ui/*.js)</span>
<a href="#l23.18"></a><span id="l23.18">   content/openpgp/ui                           (content/ui/*.xhtml)</span>
<a href="#l23.19"></a><span id="l23.19">   content/openpgp/ui                           (content/ui/*.css)</span>
<a href="#l23.20"></a><span id="l23.20"> </span>
<a href="#l23.21"></a><span id="l23.21"> [localization] @AB_CD@.jar:</span>
<a href="#l23.22"></a><span id="l23.22">   openpgp/content/ui/keyPicker.ftl             (content/ui/keyPicker.ftl)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mail/themes/shared/jar.inc.mn</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mail/themes/shared/jar.inc.mn</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -267,8 +267,10 @@</span>
<a href="#l24.4"></a><span id="l24.4">   skin/classic/messenger/openpgp/password-error.svg           (../shared/openpgp/password-error.svg)</span>
<a href="#l24.5"></a><span id="l24.5">   skin/classic/messenger/openpgp/sign-active-18.svg           (../shared/openpgp/sign-active-18.svg)</span>
<a href="#l24.6"></a><span id="l24.6">   skin/classic/messenger/openpgp/sign-disabled-18.svg         (../shared/openpgp/sign-disabled-18.svg)</span>
<a href="#l24.7"></a><span id="l24.7">   skin/classic/messenger/openpgp/sign-inactive-18.svg         (../shared/openpgp/sign-inactive-18.svg)</span>
<a href="#l24.8"></a><span id="l24.8">   skin/classic/messenger/openpgp/spinning-wheel.png           (../shared/openpgp/spinning-wheel.png)</span>
<a href="#l24.9"></a><span id="l24.9">   skin/classic/messenger/openpgp/twisty-clsd.png              (../shared/openpgp/twisty-clsd.png)</span>
<a href="#l24.10"></a><span id="l24.10">   skin/classic/messenger/openpgp/twisty-open.png              (../shared/openpgp/twisty-open.png)</span>
<a href="#l24.11"></a><span id="l24.11">   skin/classic/messenger/openpgp/warning-16.png               (../shared/openpgp/warning-16.png)</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineplus">+  skin/classic/messenger/openpgp/composeKeyStatus.css         (../shared/openpgp/composeKeyStatus.css)</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+  skin/classic/messenger/openpgp/oneRecipientStatus.css       (../shared/openpgp/oneRecipientStatus.css)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1">new file mode 100644</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineminus">--- /dev/null</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineplus">+++ b/mail/themes/shared/openpgp/composeKeyStatus.css</span>
<a href="#l25.4"></a><span id="l25.4" class="difflineat">@@ -0,0 +1,11 @@</span>
<a href="#l25.5"></a><span id="l25.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l25.6"></a><span id="l25.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l25.7"></a><span id="l25.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l25.8"></a><span id="l25.8" class="difflineplus">+</span>
<a href="#l25.9"></a><span id="l25.9" class="difflineplus">+@import url(&quot;chrome://messenger/skin/messenger.css&quot;);</span>
<a href="#l25.10"></a><span id="l25.10" class="difflineplus">+</span>
<a href="#l25.11"></a><span id="l25.11" class="difflineplus">+@namespace url(&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;);</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineplus">+</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+treecolpicker {</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineplus">+  display: none;</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1">new file mode 100644</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineminus">--- /dev/null</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineplus">+++ b/mail/themes/shared/openpgp/oneRecipientStatus.css</span>
<a href="#l26.4"></a><span id="l26.4" class="difflineat">@@ -0,0 +1,11 @@</span>
<a href="#l26.5"></a><span id="l26.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l26.6"></a><span id="l26.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l26.7"></a><span id="l26.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l26.8"></a><span id="l26.8" class="difflineplus">+</span>
<a href="#l26.9"></a><span id="l26.9" class="difflineplus">+@import url(&quot;chrome://messenger/skin/messenger.css&quot;);</span>
<a href="#l26.10"></a><span id="l26.10" class="difflineplus">+</span>
<a href="#l26.11"></a><span id="l26.11" class="difflineplus">+@namespace url(&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;);</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineplus">+</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+treecolpicker {</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineplus">+  display: none;</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineplus">+}</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

