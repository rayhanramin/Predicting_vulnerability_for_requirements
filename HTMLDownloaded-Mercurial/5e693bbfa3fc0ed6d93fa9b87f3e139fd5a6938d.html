<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26534:5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d" />
<meta property="og:url" content="/comm-central/rev/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d" />
<meta property="og:description" content="Bug 1515877 - Turn on ESLint in mailnews/imap; rs=NPOTB" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d">shortlog</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d">files</a> |
changeset |
<a href="/comm-central/raw-rev/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d">raw</a>  | <a href="/comm-central/archive/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1515877">Bug 1515877</a> - Turn on ESLint in mailnews/imap; rs=NPOTB
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 08 May 2019 15:55:21 +1200</td></tr>

<tr>
 <td>changeset 26534</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d">5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d</a></td>
</tr>



<tr>
<td>parent 26533</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/fb00935549d335953b7689234103884ae8283c6d">fb00935549d335953b7689234103884ae8283c6d</a>
</td>
</tr>

<tr>
<td>child 26535</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/7ca0abedb9172bfb19c4daffc803d8cee94044b6">7ca0abedb9172bfb19c4daffc803d8cee94044b6</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d">15885</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Wed, 08 May 2019 03:56:04 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@305d1bc1bda9 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=305d1bc1bda9880aea7801204f3b5e27766f38f3">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=305d1bc1bda9880aea7801204f3b5e27766f38f3&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=305d1bc1bda9880aea7801204f3b5e27766f38f3&newProject=comm-central&newRevision=fb00935549d335953b7689234103884ae8283c6d&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=305d1bc1bda9880aea7801204f3b5e27766f38f3&newProject=comm-central&newRevision=fb00935549d335953b7689234103884ae8283c6d&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=305d1bc1bda9880aea7801204f3b5e27766f38f3&newProject=comm-central&newRevision=fb00935549d335953b7689234103884ae8283c6d&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28NPOTB%29&revcount=50">NPOTB</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1515877">1515877</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1515877">Bug 1515877</a> - Turn on ESLint in mailnews/imap; rs=NPOTB</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/.eslintignore">.eslintignore</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/.eslintignore">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/.eslintignore">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/.eslintignore">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/.eslintignore">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/.eslintignore">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/.eslintrc.js">mailnews/imap/test/unit/.eslintrc.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/.eslintrc.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/.eslintrc.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/.eslintrc.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/.eslintrc.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/.eslintrc.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/head_imap_maildir.js">mailnews/imap/test/unit/head_imap_maildir.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/head_imap_maildir.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/head_imap_maildir.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/head_imap_maildir.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/head_imap_maildir.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/head_imap_maildir.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/head_server.js">mailnews/imap/test/unit/head_server.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/head_server.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/head_server.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/head_server.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/head_server.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/head_server.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_autosync_date_constraints.js">mailnews/imap/test/unit/test_autosync_date_constraints.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_autosync_date_constraints.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_autosync_date_constraints.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_autosync_date_constraints.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_autosync_date_constraints.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_autosync_date_constraints.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_bccProperty.js">mailnews/imap/test/unit/test_bccProperty.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_bccProperty.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_bccProperty.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_bccProperty.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_bccProperty.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_bccProperty.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_bug460636.js">mailnews/imap/test/unit/test_bug460636.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_bug460636.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_bug460636.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_bug460636.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_bug460636.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_bug460636.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_cacheParts.js">mailnews/imap/test/unit/test_cacheParts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_cacheParts.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_cacheParts.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_cacheParts.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_cacheParts.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_cacheParts.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_chunkLastLF.js">mailnews/imap/test/unit/test_chunkLastLF.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_chunkLastLF.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_chunkLastLF.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_chunkLastLF.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_chunkLastLF.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_chunkLastLF.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_compactOfflineStore.js">mailnews/imap/test/unit/test_compactOfflineStore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_compactOfflineStore.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_compactOfflineStore.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_compactOfflineStore.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_compactOfflineStore.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_compactOfflineStore.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_converterImap.js">mailnews/imap/test/unit/test_converterImap.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_converterImap.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_converterImap.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_converterImap.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_converterImap.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_converterImap.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_copyThenMove.js">mailnews/imap/test/unit/test_copyThenMove.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_copyThenMove.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_copyThenMove.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_copyThenMove.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_copyThenMove.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_copyThenMove.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_customCommandReturnsFetchResponse.js">mailnews/imap/test/unit/test_customCommandReturnsFetchResponse.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_customCommandReturnsFetchResponse.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_customCommandReturnsFetchResponse.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_customCommandReturnsFetchResponse.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_customCommandReturnsFetchResponse.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_customCommandReturnsFetchResponse.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_dod.js">mailnews/imap/test/unit/test_dod.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_dod.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_dod.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_dod.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_dod.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_dod.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_dontStatNoSelect.js">mailnews/imap/test/unit/test_dontStatNoSelect.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_dontStatNoSelect.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_dontStatNoSelect.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_dontStatNoSelect.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_dontStatNoSelect.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_dontStatNoSelect.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_downloadOffline.js">mailnews/imap/test/unit/test_downloadOffline.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_downloadOffline.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_downloadOffline.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_downloadOffline.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_downloadOffline.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_downloadOffline.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_fetchCustomAttribute.js">mailnews/imap/test/unit/test_fetchCustomAttribute.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_fetchCustomAttribute.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_fetchCustomAttribute.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_fetchCustomAttribute.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_fetchCustomAttribute.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_fetchCustomAttribute.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_filterCustomHeaders.js">mailnews/imap/test/unit/test_filterCustomHeaders.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_filterCustomHeaders.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_filterCustomHeaders.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_filterCustomHeaders.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_filterCustomHeaders.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_filterCustomHeaders.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_filterNeedsBody.js">mailnews/imap/test/unit/test_filterNeedsBody.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_filterNeedsBody.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_filterNeedsBody.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_filterNeedsBody.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_filterNeedsBody.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_filterNeedsBody.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_folderOfflineFlags.js">mailnews/imap/test/unit/test_folderOfflineFlags.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_folderOfflineFlags.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_folderOfflineFlags.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_folderOfflineFlags.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_folderOfflineFlags.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_folderOfflineFlags.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_gmailAttributes.js">mailnews/imap/test/unit/test_gmailAttributes.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_gmailAttributes.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_gmailAttributes.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_gmailAttributes.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_gmailAttributes.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_gmailAttributes.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_gmailOfflineMsgStore.js">mailnews/imap/test/unit/test_gmailOfflineMsgStore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_gmailOfflineMsgStore.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_gmailOfflineMsgStore.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_gmailOfflineMsgStore.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_gmailOfflineMsgStore.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_gmailOfflineMsgStore.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapAttachmentSaves.js">mailnews/imap/test/unit/test_imapAttachmentSaves.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapAttachmentSaves.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapAttachmentSaves.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapAttachmentSaves.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapAttachmentSaves.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapAttachmentSaves.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapAuthMethods.js">mailnews/imap/test/unit/test_imapAuthMethods.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapAuthMethods.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapAuthMethods.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapAuthMethods.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapAuthMethods.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapAuthMethods.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapAutoSync.js">mailnews/imap/test/unit/test_imapAutoSync.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapAutoSync.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapAutoSync.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapAutoSync.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapAutoSync.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapAutoSync.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapChunks.js">mailnews/imap/test/unit/test_imapChunks.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapChunks.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapChunks.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapChunks.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapChunks.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapChunks.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapContentLength.js">mailnews/imap/test/unit/test_imapContentLength.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapContentLength.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapContentLength.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapContentLength.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapContentLength.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapContentLength.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapCopyTimeout.js">mailnews/imap/test/unit/test_imapCopyTimeout.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapCopyTimeout.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapCopyTimeout.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapCopyTimeout.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapCopyTimeout.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapCopyTimeout.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapFilterActions.js">mailnews/imap/test/unit/test_imapFilterActions.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapFilterActions.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapFilterActions.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapFilterActions.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapFilterActions.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapFilterActions.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapFilterActionsPostplugin.js">mailnews/imap/test/unit/test_imapFilterActionsPostplugin.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapFilterActionsPostplugin.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapFilterActionsPostplugin.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapFilterActionsPostplugin.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapFilterActionsPostplugin.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapFilterActionsPostplugin.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapFlagChange.js">mailnews/imap/test/unit/test_imapFlagChange.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapFlagChange.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapFlagChange.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapFlagChange.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapFlagChange.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapFlagChange.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapFolderCopy.js">mailnews/imap/test/unit/test_imapFolderCopy.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapFolderCopy.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapFolderCopy.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapFolderCopy.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapFolderCopy.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapFolderCopy.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapHdrChunking.js">mailnews/imap/test/unit/test_imapHdrChunking.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapHdrChunking.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapHdrChunking.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapHdrChunking.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapHdrChunking.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapHdrChunking.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapHdrStreaming.js">mailnews/imap/test/unit/test_imapHdrStreaming.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapHdrStreaming.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapHdrStreaming.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapHdrStreaming.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapHdrStreaming.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapHdrStreaming.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapHighWater.js">mailnews/imap/test/unit/test_imapHighWater.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapHighWater.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapHighWater.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapHighWater.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapHighWater.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapHighWater.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapID.js">mailnews/imap/test/unit/test_imapID.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapID.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapID.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapID.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapID.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapID.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapMove.js">mailnews/imap/test/unit/test_imapMove.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapMove.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapMove.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapMove.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapMove.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapMove.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapPasswordFailure.js">mailnews/imap/test/unit/test_imapPasswordFailure.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapPasswordFailure.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapPasswordFailure.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapPasswordFailure.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapPasswordFailure.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapPasswordFailure.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapProtocols.js">mailnews/imap/test/unit/test_imapProtocols.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapProtocols.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapProtocols.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapProtocols.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapProtocols.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapProtocols.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapProxy.js">mailnews/imap/test/unit/test_imapProxy.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapProxy.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapProxy.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapProxy.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapProxy.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapProxy.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapRename.js">mailnews/imap/test/unit/test_imapRename.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapRename.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapRename.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapRename.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapRename.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapRename.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapSearch.js">mailnews/imap/test/unit/test_imapSearch.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapSearch.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapSearch.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapSearch.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapSearch.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapSearch.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapStatusCloseDBs.js">mailnews/imap/test/unit/test_imapStatusCloseDBs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapStatusCloseDBs.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapStatusCloseDBs.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapStatusCloseDBs.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapStatusCloseDBs.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapStatusCloseDBs.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapStoreMsgOffline.js">mailnews/imap/test/unit/test_imapStoreMsgOffline.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapStoreMsgOffline.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapStoreMsgOffline.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapStoreMsgOffline.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapStoreMsgOffline.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapStoreMsgOffline.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapUndo.js">mailnews/imap/test/unit/test_imapUndo.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapUndo.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapUndo.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapUndo.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapUndo.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapUndo.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapUrls.js">mailnews/imap/test/unit/test_imapUrls.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapUrls.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapUrls.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapUrls.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapUrls.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_imapUrls.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_largeOfflineStore.js">mailnews/imap/test/unit/test_largeOfflineStore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_largeOfflineStore.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_largeOfflineStore.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_largeOfflineStore.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_largeOfflineStore.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_largeOfflineStore.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_listClosesDB.js">mailnews/imap/test/unit/test_listClosesDB.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_listClosesDB.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_listClosesDB.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_listClosesDB.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_listClosesDB.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_listClosesDB.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_listSubscribed.js">mailnews/imap/test/unit/test_listSubscribed.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_listSubscribed.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_listSubscribed.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_listSubscribed.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_listSubscribed.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_listSubscribed.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_localToImapFilter.js">mailnews/imap/test/unit/test_localToImapFilter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_localToImapFilter.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_localToImapFilter.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_localToImapFilter.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_localToImapFilter.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_localToImapFilter.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_localToImapFilterQuarantine.js">mailnews/imap/test/unit/test_localToImapFilterQuarantine.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_localToImapFilterQuarantine.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_localToImapFilterQuarantine.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_localToImapFilterQuarantine.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_localToImapFilterQuarantine.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_localToImapFilterQuarantine.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_lsub.js">mailnews/imap/test/unit/test_lsub.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_lsub.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_lsub.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_lsub.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_lsub.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_lsub.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_mailboxes.js">mailnews/imap/test/unit/test_mailboxes.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_mailboxes.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_mailboxes.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_mailboxes.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_mailboxes.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_mailboxes.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js">mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_offlineCopy.js">mailnews/imap/test/unit/test_offlineCopy.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_offlineCopy.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_offlineCopy.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_offlineCopy.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_offlineCopy.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_offlineCopy.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_offlineDraftDataloss.js">mailnews/imap/test/unit/test_offlineDraftDataloss.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_offlineDraftDataloss.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_offlineDraftDataloss.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_offlineDraftDataloss.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_offlineDraftDataloss.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_offlineDraftDataloss.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_offlinePlayback.js">mailnews/imap/test/unit/test_offlinePlayback.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_offlinePlayback.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_offlinePlayback.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_offlinePlayback.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_offlinePlayback.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_offlinePlayback.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_offlineStoreLocking.js">mailnews/imap/test/unit/test_offlineStoreLocking.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_offlineStoreLocking.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_offlineStoreLocking.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_offlineStoreLocking.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_offlineStoreLocking.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_offlineStoreLocking.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_partsOnDemand.js">mailnews/imap/test/unit/test_partsOnDemand.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_partsOnDemand.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_partsOnDemand.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_partsOnDemand.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_partsOnDemand.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_partsOnDemand.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_preserveDataOnMove.js">mailnews/imap/test/unit/test_preserveDataOnMove.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_preserveDataOnMove.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_preserveDataOnMove.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_preserveDataOnMove.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_preserveDataOnMove.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_preserveDataOnMove.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_saveImapDraft.js">mailnews/imap/test/unit/test_saveImapDraft.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_saveImapDraft.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_saveImapDraft.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_saveImapDraft.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_saveImapDraft.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_saveImapDraft.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_saveTemplate.js">mailnews/imap/test/unit/test_saveTemplate.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_saveTemplate.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_saveTemplate.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_saveTemplate.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_saveTemplate.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_saveTemplate.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_starttlsFailure.js">mailnews/imap/test/unit/test_starttlsFailure.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_starttlsFailure.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_starttlsFailure.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_starttlsFailure.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_starttlsFailure.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_starttlsFailure.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_stopMovingToLocalFolder.js">mailnews/imap/test/unit/test_stopMovingToLocalFolder.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_stopMovingToLocalFolder.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_stopMovingToLocalFolder.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_stopMovingToLocalFolder.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_stopMovingToLocalFolder.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_stopMovingToLocalFolder.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_subfolderLocation.js">mailnews/imap/test/unit/test_subfolderLocation.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_subfolderLocation.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_subfolderLocation.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_subfolderLocation.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_subfolderLocation.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_subfolderLocation.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_syncChanges.js">mailnews/imap/test/unit/test_syncChanges.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_syncChanges.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_syncChanges.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_syncChanges.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_syncChanges.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_syncChanges.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_trustSpamAssassin.js">mailnews/imap/test/unit/test_trustSpamAssassin.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_trustSpamAssassin.js">file</a> |
<a href="/comm-central/annotate/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_trustSpamAssassin.js">annotate</a> |
<a href="/comm-central/diff/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_trustSpamAssassin.js">diff</a> |
<a href="/comm-central/comparison/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_trustSpamAssassin.js">comparison</a> |
<a href="/comm-central/log/5e693bbfa3fc0ed6d93fa9b87f3e139fd5a6938d/mailnews/imap/test/unit/test_trustSpamAssassin.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/.eslintignore</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/.eslintignore</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -59,17 +59,16 @@ editor/ui/dialogs/content/EdSnapToGrid.j</span>
<a href="#l1.4"></a><span id="l1.4"> editor/ui/dialogs/content/EdSnapToGrid.xul</span>
<a href="#l1.5"></a><span id="l1.5"> editor/ui/texzilla/**</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> # mailnews exclusions</span>
<a href="#l1.8"></a><span id="l1.8"> mailnews/mailnews.js</span>
<a href="#l1.9"></a><span id="l1.9"> mailnews/extensions/dsn/content/dsn.js</span>
<a href="#l1.10"></a><span id="l1.10"> mailnews/extensions/mdn/content/mdn.js</span>
<a href="#l1.11"></a><span id="l1.11"> mailnews/extensions/smime/content/smime.js</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-mailnews/imap/*</span>
<a href="#l1.13"></a><span id="l1.13"> mailnews/import/*</span>
<a href="#l1.14"></a><span id="l1.14"> mailnews/intl/*</span>
<a href="#l1.15"></a><span id="l1.15"> mailnews/jsaccount/*</span>
<a href="#l1.16"></a><span id="l1.16"> mailnews/mime/*</span>
<a href="#l1.17"></a><span id="l1.17"> </span>
<a href="#l1.18"></a><span id="l1.18"> # mail exclusions</span>
<a href="#l1.19"></a><span id="l1.19"> mail/app/profile/all-thunderbird.js</span>
<a href="#l1.20"></a><span id="l1.20"> mail/app/profile/channel-prefs.js</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">new file mode 100644</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineminus">--- /dev/null</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineplus">+++ b/mailnews/imap/test/unit/.eslintrc.js</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineat">@@ -0,0 +1,14 @@</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineplus">+</span>
<a href="#l2.7"></a><span id="l2.7" class="difflineplus">+module.exports = {</span>
<a href="#l2.8"></a><span id="l2.8" class="difflineplus">+  &quot;extends&quot;: &quot;plugin:mozilla/xpcshell-test&quot;,</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineplus">+</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+  &quot;rules&quot;: {</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineplus">+    &quot;func-names&quot;: &quot;off&quot;,</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+    &quot;mozilla/import-headjs-globals&quot;: &quot;error&quot;,</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+    &quot;no-unused-vars&quot;: [&quot;error&quot;, {</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+      &quot;args&quot;: &quot;none&quot;,</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+      &quot;vars&quot;: &quot;all&quot;,</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+    }],</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+  },</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/imap/test/unit/head_imap_maildir.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/imap/test/unit/head_imap_maildir.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,6 +1,7 @@</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineplus">+/* import-globals-from head_server.js */</span>
<a href="#l3.5"></a><span id="l3.5"> load(&quot;head_server.js&quot;);</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7"> info(&quot;Running test with maildir&quot;);</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9"> Services.prefs.setCharPref(&quot;mail.serverDefaultStoreContractID&quot;,</span>
<a href="#l3.10"></a><span id="l3.10">                            &quot;@mozilla.org/msgstore/maildirstore;1&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/imap/test/unit/head_server.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/imap/test/unit/head_server.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -62,17 +62,17 @@ function makeServer(daemon, infoString, </span>
<a href="#l4.4"></a><span id="l4.4">     }</span>
<a href="#l4.5"></a><span id="l4.5">     return handler;</span>
<a href="#l4.6"></a><span id="l4.6">   }</span>
<a href="#l4.7"></a><span id="l4.7">   var server = new nsMailServer(createHandler, daemon);</span>
<a href="#l4.8"></a><span id="l4.8">   server.start();</span>
<a href="#l4.9"></a><span id="l4.9">   return server;</span>
<a href="#l4.10"></a><span id="l4.10"> }</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-function createLocalIMAPServer(port, hostname=&quot;localhost&quot;) {</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+function createLocalIMAPServer(port, hostname = &quot;localhost&quot;) {</span>
<a href="#l4.14"></a><span id="l4.14">   let server = localAccountUtils.create_incoming_server(&quot;imap&quot;, port,</span>
<a href="#l4.15"></a><span id="l4.15">     &quot;user&quot;, &quot;password&quot;, hostname);</span>
<a href="#l4.16"></a><span id="l4.16">   server.QueryInterface(Ci.nsIImapIncomingServer);</span>
<a href="#l4.17"></a><span id="l4.17">   return server;</span>
<a href="#l4.18"></a><span id="l4.18"> }</span>
<a href="#l4.19"></a><span id="l4.19"> </span>
<a href="#l4.20"></a><span id="l4.20"> // &lt;copied from=&quot;head_maillocal.js&quot;&gt;</span>
<a href="#l4.21"></a><span id="l4.21"> /**</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineat">@@ -85,41 +85,39 @@ function createLocalIMAPServer(port, hos</span>
<a href="#l4.23"></a><span id="l4.23">  *    e.g. &quot;authenticate CRAM-MD5&quot;.</span>
<a href="#l4.24"></a><span id="l4.24">  */</span>
<a href="#l4.25"></a><span id="l4.25"> function do_check_transaction(fromServer, expected, withParams) {</span>
<a href="#l4.26"></a><span id="l4.26">   // If we don't spin the event loop before starting the next test, the readers</span>
<a href="#l4.27"></a><span id="l4.27">   // aren't expired. In this case, the &quot;real&quot; real transaction is the last one.</span>
<a href="#l4.28"></a><span id="l4.28">   if (fromServer instanceof Array)</span>
<a href="#l4.29"></a><span id="l4.29">     fromServer = fromServer[fromServer.length - 1];</span>
<a href="#l4.30"></a><span id="l4.30"> </span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-  var realTransaction = new Array();</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-  for (var i = 0; i &lt; fromServer.them.length; i++)</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-  {</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+  let realTransaction = [];</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+  for (let i = 0; i &lt; fromServer.them.length; i++) {</span>
<a href="#l4.36"></a><span id="l4.36">     var line = fromServer.them[i]; // e.g. '1 login &quot;user&quot; &quot;password&quot;'</span>
<a href="#l4.37"></a><span id="l4.37">     var components = line.split(&quot; &quot;);</span>
<a href="#l4.38"></a><span id="l4.38">     if (components.length &lt; 2)</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineminus">-      throw &quot;IMAP command in transaction log missing: &quot; + line;</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+      throw new Error(&quot;IMAP command in transaction log missing: &quot; + line);</span>
<a href="#l4.41"></a><span id="l4.41">     if (withParams)</span>
<a href="#l4.42"></a><span id="l4.42">       realTransaction.push(line.substr(components[0].length + 1));</span>
<a href="#l4.43"></a><span id="l4.43">     else if (components[1] == &quot;authenticate&quot;)</span>
<a href="#l4.44"></a><span id="l4.44">       realTransaction.push(components[1] + &quot; &quot; + components[2].toUpperCase());</span>
<a href="#l4.45"></a><span id="l4.45">     else</span>
<a href="#l4.46"></a><span id="l4.46">       realTransaction.push(components[1]);</span>
<a href="#l4.47"></a><span id="l4.47">   }</span>
<a href="#l4.48"></a><span id="l4.48"> </span>
<a href="#l4.49"></a><span id="l4.49">   Assert.equal(realTransaction.join(&quot;, &quot;), expected.join(&quot;, &quot;));</span>
<a href="#l4.50"></a><span id="l4.50"> }</span>
<a href="#l4.51"></a><span id="l4.51"> </span>
<a href="#l4.52"></a><span id="l4.52"> /**</span>
<a href="#l4.53"></a><span id="l4.53">  * add a simple message to the IMAP pump mailbox</span>
<a href="#l4.54"></a><span id="l4.54">  */</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineminus">-function addImapMessage()</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineminus">-{</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+function addImapMessage() {</span>
<a href="#l4.58"></a><span id="l4.58">   let messages = [];</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineminus">-  let messageGenerator = new MessageGenerator();</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+  let messageGenerator = new MessageGenerator(); // eslint-disable-line no-undef</span>
<a href="#l4.61"></a><span id="l4.61">   messages = messages.concat(messageGenerator.makeMessage());</span>
<a href="#l4.62"></a><span id="l4.62">   let dataUri = Services.io.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l4.63"></a><span id="l4.63">                   btoa(messages[0].toMessageString()));</span>
<a href="#l4.64"></a><span id="l4.64">   let imapMsg = new imapMessage(dataUri.spec, IMAPPump.mailbox.uidnext++, []);</span>
<a href="#l4.65"></a><span id="l4.65">   IMAPPump.mailbox.addMessage(imapMsg);</span>
<a href="#l4.66"></a><span id="l4.66"> }</span>
<a href="#l4.67"></a><span id="l4.67"> </span>
<a href="#l4.68"></a><span id="l4.68"> registerCleanupFunction(function() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_autosync_date_constraints.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_autosync_date_constraints.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1,28 +1,27 @@</span>
<a href="#l5.4"></a><span id="l5.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l5.5"></a><span id="l5.5"> /*</span>
<a href="#l5.6"></a><span id="l5.6">  * Test autosync date constraints</span>
<a href="#l5.7"></a><span id="l5.7">  */</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l5.12"></a><span id="l5.12"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l5.13"></a><span id="l5.13"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l5.14"></a><span id="l5.14"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l5.15"></a><span id="l5.15"> </span>
<a href="#l5.16"></a><span id="l5.16" class="difflineminus">-var gRootFolder;</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-var gIMAPTrashFolder, gMsgImapInboxFolder;</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineminus">-var gImapInboxOfflineStoreSize;</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+var gMsgImapInboxFolder;</span>
<a href="#l5.20"></a><span id="l5.20"> </span>
<a href="#l5.21"></a><span id="l5.21"> // Adds some messages directly to a mailbox (eg new mail)</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineminus">-function addMessagesToServer(messages, mailbox)</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineminus">-{</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+function addMessagesToServer(messages, mailbox) {</span>
<a href="#l5.25"></a><span id="l5.25">   // Create the imapMessages and store them on the mailbox</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineminus">-  messages.forEach(function (message)</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineminus">-  {</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">-    let dataUri = 'data:text/plain,' + message.toMessageString();</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+  messages.forEach(function(message) {</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+    let dataUri = &quot;data:text/plain,&quot; + message.toMessageString();</span>
<a href="#l5.31"></a><span id="l5.31">     mailbox.addMessage(new imapMessage(dataUri, mailbox.uidnext++, []));</span>
<a href="#l5.32"></a><span id="l5.32">   });</span>
<a href="#l5.33"></a><span id="l5.33"> }</span>
<a href="#l5.34"></a><span id="l5.34"> </span>
<a href="#l5.35"></a><span id="l5.35"> var tests = [</span>
<a href="#l5.36"></a><span id="l5.36">   setup,</span>
<a href="#l5.37"></a><span id="l5.37">   function* downloadForOffline() {</span>
<a href="#l5.38"></a><span id="l5.38">     // ...and download for offline use.</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineat">@@ -43,38 +42,36 @@ var tests = [</span>
<a href="#l5.40"></a><span id="l5.40">           if (header.dateInSeconds &lt; cutOffDateInSeconds)</span>
<a href="#l5.41"></a><span id="l5.41">             Assert.equal(header.getStringProperty(&quot;pendingRemoval&quot;), &quot;1&quot;);</span>
<a href="#l5.42"></a><span id="l5.42">           else</span>
<a href="#l5.43"></a><span id="l5.43">             Assert.equal(header.getStringProperty(&quot;pendingRemoval&quot;), &quot;&quot;);</span>
<a href="#l5.44"></a><span id="l5.44">         }</span>
<a href="#l5.45"></a><span id="l5.45">       }</span>
<a href="#l5.46"></a><span id="l5.46">     }</span>
<a href="#l5.47"></a><span id="l5.47">   },</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineminus">-  teardown</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+  teardown,</span>
<a href="#l5.50"></a><span id="l5.50"> ];</span>
<a href="#l5.51"></a><span id="l5.51"> </span>
<a href="#l5.52"></a><span id="l5.52"> function setup() {</span>
<a href="#l5.53"></a><span id="l5.53">   Services.prefs.setIntPref(&quot;mail.server.server1.autosync_max_age_days&quot;, 4);</span>
<a href="#l5.54"></a><span id="l5.54"> </span>
<a href="#l5.55"></a><span id="l5.55">   setupIMAPPump();</span>
<a href="#l5.56"></a><span id="l5.56"> </span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">-  gRootFolder = IMAPPump.incomingServer.rootFolder;</span>
<a href="#l5.58"></a><span id="l5.58">   gMsgImapInboxFolder = IMAPPump.inbox.QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l5.59"></a><span id="l5.59">   // these hacks are required because we've created the inbox before</span>
<a href="#l5.60"></a><span id="l5.60">   // running initial folder discovery, and adding the folder bails</span>
<a href="#l5.61"></a><span id="l5.61">   // out before we set it as verified online, so we bail out, and</span>
<a href="#l5.62"></a><span id="l5.62">   // then remove the INBOX folder since it's not verified.</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineminus">-  gMsgImapInboxFolder.hierarchyDelimiter = '/';</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+  gMsgImapInboxFolder.hierarchyDelimiter = &quot;/&quot;;</span>
<a href="#l5.65"></a><span id="l5.65">   gMsgImapInboxFolder.verifiedAsOnlineFolder = true;</span>
<a href="#l5.66"></a><span id="l5.66"> </span>
<a href="#l5.67"></a><span id="l5.67"> </span>
<a href="#l5.68"></a><span id="l5.68">   // Add a couple of messages to the INBOX</span>
<a href="#l5.69"></a><span id="l5.69">   // this is synchronous, afaik</span>
<a href="#l5.70"></a><span id="l5.70">   let messageGenerator = new MessageGenerator();</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineminus">-  let scenarioFactory = new MessageScenarioFactory(messageGenerator);</span>
<a href="#l5.72"></a><span id="l5.72"> </span>
<a href="#l5.73"></a><span id="l5.73">   // build up a diverse list of messages</span>
<a href="#l5.74"></a><span id="l5.74">   let messages = [];</span>
<a href="#l5.75"></a><span id="l5.75">   messages = messages.concat(messageGenerator.makeMessage({age: {days: 2, hours: 1}}));</span>
<a href="#l5.76"></a><span id="l5.76">   messages = messages.concat(messageGenerator.makeMessage({age: {days: 8, hours: 1}}));</span>
<a href="#l5.77"></a><span id="l5.77">   messages = messages.concat(messageGenerator.makeMessage({age: {days: 10, hours: 1}}));</span>
<a href="#l5.78"></a><span id="l5.78"> </span>
<a href="#l5.79"></a><span id="l5.79">   addMessagesToServer(messages, IMAPPump.daemon.getMailbox(&quot;INBOX&quot;));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_bccProperty.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_bccProperty.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -2,27 +2,29 @@</span>
<a href="#l6.4"></a><span id="l6.4"> /*</span>
<a href="#l6.5"></a><span id="l6.5">  * Test to ensure that BCC gets added to message headers on IMAP download</span>
<a href="#l6.6"></a><span id="l6.6">  *</span>
<a href="#l6.7"></a><span id="l6.7">  * adapted from test_downloadOffline.js</span>
<a href="#l6.8"></a><span id="l6.8">  *</span>
<a href="#l6.9"></a><span id="l6.9">  * original author Kent James &lt;kent@caspia.com&gt;</span>
<a href="#l6.10"></a><span id="l6.10">  */</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l6.14"></a><span id="l6.14"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l6.15"></a><span id="l6.15"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l6.16"></a><span id="l6.16"> </span>
<a href="#l6.17"></a><span id="l6.17"> var gFileName = &quot;draft1&quot;;</span>
<a href="#l6.18"></a><span id="l6.18"> var gMsgFile = do_get_file(&quot;../../../data/&quot; + gFileName);</span>
<a href="#l6.19"></a><span id="l6.19"> </span>
<a href="#l6.20"></a><span id="l6.20"> var tests = [</span>
<a href="#l6.21"></a><span id="l6.21">   setup,</span>
<a href="#l6.22"></a><span id="l6.22">   downloadAllForOffline,</span>
<a href="#l6.23"></a><span id="l6.23">   checkBccs,</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-  teardown</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+  teardown,</span>
<a href="#l6.26"></a><span id="l6.26"> ];</span>
<a href="#l6.27"></a><span id="l6.27"> </span>
<a href="#l6.28"></a><span id="l6.28"> function* setup() {</span>
<a href="#l6.29"></a><span id="l6.29">   setupIMAPPump();</span>
<a href="#l6.30"></a><span id="l6.30"> </span>
<a href="#l6.31"></a><span id="l6.31">   /*</span>
<a href="#l6.32"></a><span id="l6.32">    * Ok, prelude done. Read the original message from disk</span>
<a href="#l6.33"></a><span id="l6.33">    * (through a file URI), and add it to the Inbox.</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineat">@@ -41,17 +43,17 @@ function* setup() {</span>
<a href="#l6.35"></a><span id="l6.35"> function* downloadAllForOffline() {</span>
<a href="#l6.36"></a><span id="l6.36">   IMAPPump.inbox.downloadAllForOffline(asyncUrlListener, null);</span>
<a href="#l6.37"></a><span id="l6.37">   yield false;</span>
<a href="#l6.38"></a><span id="l6.38"> }</span>
<a href="#l6.39"></a><span id="l6.39"> </span>
<a href="#l6.40"></a><span id="l6.40"> function checkBccs() {</span>
<a href="#l6.41"></a><span id="l6.41">   // locate the new message by enumerating through the database</span>
<a href="#l6.42"></a><span id="l6.42">   let enumerator = IMAPPump.inbox.msgDatabase.EnumerateMessages();</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-  while(enumerator.hasMoreElements()) {</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+  while (enumerator.hasMoreElements()) {</span>
<a href="#l6.45"></a><span id="l6.45">     let hdr = enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l6.46"></a><span id="l6.46">     Assert.ok(hdr.bccList.includes(&quot;Another Person&quot;));</span>
<a href="#l6.47"></a><span id="l6.47">     Assert.ok(hdr.bccList.includes(&quot;&lt;u1@example.com&gt;&quot;));</span>
<a href="#l6.48"></a><span id="l6.48">     Assert.ok(!hdr.bccList.includes(&quot;IDoNotExist&quot;));</span>
<a href="#l6.49"></a><span id="l6.49">   }</span>
<a href="#l6.50"></a><span id="l6.50"> }</span>
<a href="#l6.51"></a><span id="l6.51"> </span>
<a href="#l6.52"></a><span id="l6.52"> function teardown() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_bug460636.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_bug460636.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1,27 +1,29 @@</span>
<a href="#l7.4"></a><span id="l7.4"> /*</span>
<a href="#l7.5"></a><span id="l7.5">  * Test bug 460636 - nsMsgSaveAsListener sometimes inserts extra LF characters</span>
<a href="#l7.6"></a><span id="l7.6">  */</span>
<a href="#l7.7"></a><span id="l7.7"> </span>
<a href="#l7.8"></a><span id="l7.8" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l7.10"></a><span id="l7.10"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l7.11"></a><span id="l7.11"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l7.12"></a><span id="l7.12"> </span>
<a href="#l7.13"></a><span id="l7.13"> var gSavedMsgFile;</span>
<a href="#l7.14"></a><span id="l7.14"> </span>
<a href="#l7.15"></a><span id="l7.15"> var gIMAPService = Cc[&quot;@mozilla.org/messenger/messageservice;1?type=imap&quot;]</span>
<a href="#l7.16"></a><span id="l7.16">                        .getService(Ci.nsIMsgMessageService);</span>
<a href="#l7.17"></a><span id="l7.17"> </span>
<a href="#l7.18"></a><span id="l7.18"> var gFileName = &quot;bug460636&quot;;</span>
<a href="#l7.19"></a><span id="l7.19"> var gMsgFile = do_get_file(&quot;../../../data/&quot; + gFileName);</span>
<a href="#l7.20"></a><span id="l7.20"> </span>
<a href="#l7.21"></a><span id="l7.21"> var tests = [</span>
<a href="#l7.22"></a><span id="l7.22">   setup,</span>
<a href="#l7.23"></a><span id="l7.23">   checkSavedMessage,</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">-  teardown</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+  teardown,</span>
<a href="#l7.26"></a><span id="l7.26"> ];</span>
<a href="#l7.27"></a><span id="l7.27"> </span>
<a href="#l7.28"></a><span id="l7.28"> function* setup() {</span>
<a href="#l7.29"></a><span id="l7.29">   setupIMAPPump();</span>
<a href="#l7.30"></a><span id="l7.30"> </span>
<a href="#l7.31"></a><span id="l7.31">   /*</span>
<a href="#l7.32"></a><span id="l7.32">    * Ok, prelude done. Read the original message from disk</span>
<a href="#l7.33"></a><span id="l7.33">    * (through a file URI), and add it to the Inbox.</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineat">@@ -48,31 +50,30 @@ function* setup() {</span>
<a href="#l7.35"></a><span id="l7.35">    *                        in boolean aGenerateDummyEnvelope,</span>
<a href="#l7.36"></a><span id="l7.36">    *                        in nsIUrlListener aUrlListener, out nsIURI aURL,</span>
<a href="#l7.37"></a><span id="l7.37">    *                        in boolean canonicalLineEnding,</span>
<a href="#l7.38"></a><span id="l7.38">    *                        in nsIMsgWindow aMsgWindow);</span>
<a href="#l7.39"></a><span id="l7.39">    * Enforcing canonicalLineEnding (i.e., CRLF) makes sure that the</span>
<a href="#l7.40"></a><span id="l7.40">    * test also runs successfully on platforms not using CRLF by default.</span>
<a href="#l7.41"></a><span id="l7.41">    */</span>
<a href="#l7.42"></a><span id="l7.42">   gIMAPService.SaveMessageToDisk(&quot;imap-message://user@localhost/INBOX#&quot;</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-                                 + (IMAPPump.mailbox.uidnext-1), gSavedMsgFile,</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+                                 + (IMAPPump.mailbox.uidnext - 1), gSavedMsgFile,</span>
<a href="#l7.45"></a><span id="l7.45">                                  false, asyncUrlListener, {}, true, null);</span>
<a href="#l7.46"></a><span id="l7.46">   yield false;</span>
<a href="#l7.47"></a><span id="l7.47"> }</span>
<a href="#l7.48"></a><span id="l7.48"> </span>
<a href="#l7.49"></a><span id="l7.49"> function checkSavedMessage() {</span>
<a href="#l7.50"></a><span id="l7.50">   Assert.equal(IOUtils.loadFileToString(gMsgFile),</span>
<a href="#l7.51"></a><span id="l7.51">                IOUtils.loadFileToString(gSavedMsgFile));</span>
<a href="#l7.52"></a><span id="l7.52"> }</span>
<a href="#l7.53"></a><span id="l7.53"> </span>
<a href="#l7.54"></a><span id="l7.54"> function teardown() {</span>
<a href="#l7.55"></a><span id="l7.55">   try {</span>
<a href="#l7.56"></a><span id="l7.56">     gSavedMsgFile.remove(false);</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineminus">-  }</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineminus">-  catch (ex) {</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+  } catch (ex) {</span>
<a href="#l7.60"></a><span id="l7.60">     dump(ex);</span>
<a href="#l7.61"></a><span id="l7.61">     do_throw(ex);</span>
<a href="#l7.62"></a><span id="l7.62">   }</span>
<a href="#l7.63"></a><span id="l7.63">   teardownIMAPPump();</span>
<a href="#l7.64"></a><span id="l7.64"> }</span>
<a href="#l7.65"></a><span id="l7.65"> </span>
<a href="#l7.66"></a><span id="l7.66"> function run_test() {</span>
<a href="#l7.67"></a><span id="l7.67">   async_run_tests(tests);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_cacheParts.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_cacheParts.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1,17 +1,16 @@</span>
<a href="#l8.4"></a><span id="l8.4"> /*</span>
<a href="#l8.5"></a><span id="l8.5">  * Test bug 629738 - Parts should be cached.</span>
<a href="#l8.6"></a><span id="l8.6">  */</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l8.9"></a><span id="l8.9"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l8.10"></a><span id="l8.10"> var {PromiseTestUtils} = ChromeUtils.import(&quot;resource://testing-common/mailnews/PromiseTestUtils.jsm&quot;);</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-var gSavedMsgFile;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-</span>
<a href="#l8.14"></a><span id="l8.14"> var gIMAPService = Cc[&quot;@mozilla.org/messenger/messageservice;1?type=imap&quot;]</span>
<a href="#l8.15"></a><span id="l8.15">                        .getService(Ci.nsIMsgMessageService);</span>
<a href="#l8.16"></a><span id="l8.16"> </span>
<a href="#l8.17"></a><span id="l8.17"> var gFileName1 = &quot;image-attach-test&quot;;</span>
<a href="#l8.18"></a><span id="l8.18"> var gMsgFile1 = do_get_file(&quot;../../../data/&quot; + gFileName1);</span>
<a href="#l8.19"></a><span id="l8.19"> var gMsgId1 = &quot;4A947F73.5030709@example.com&quot;;</span>
<a href="#l8.20"></a><span id="l8.20"> </span>
<a href="#l8.21"></a><span id="l8.21"> var gFileName2 = &quot;external-attach-test&quot;;</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineat">@@ -20,50 +19,49 @@ var gMsgId2 = &quot;876TY.5030709@example.com</span>
<a href="#l8.23"></a><span id="l8.23"> </span>
<a href="#l8.24"></a><span id="l8.24"> var gMsgURL1;</span>
<a href="#l8.25"></a><span id="l8.25"> var gMsgPartURL1;</span>
<a href="#l8.26"></a><span id="l8.26"> var gMsgURL2;</span>
<a href="#l8.27"></a><span id="l8.27"> var gMsgPartURL2;</span>
<a href="#l8.28"></a><span id="l8.28"> var gUidValidity;</span>
<a href="#l8.29"></a><span id="l8.29"> </span>
<a href="#l8.30"></a><span id="l8.30"> // We use this as a display consumer</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-var streamListener =</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-{</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+var streamListener = {</span>
<a href="#l8.34"></a><span id="l8.34">   _data: &quot;&quot;,</span>
<a href="#l8.35"></a><span id="l8.35"> </span>
<a href="#l8.36"></a><span id="l8.36">   QueryInterface:</span>
<a href="#l8.37"></a><span id="l8.37">     ChromeUtils.generateQI([Ci.nsIStreamListener, Ci.nsIRequestObserver]),</span>
<a href="#l8.38"></a><span id="l8.38"> </span>
<a href="#l8.39"></a><span id="l8.39">   // nsIRequestObserver</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineminus">-  onStartRequest: function(aRequest) {</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+  onStartRequest(aRequest) {</span>
<a href="#l8.42"></a><span id="l8.42">   },</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineminus">-  onStopRequest: function(aRequest, aStatusCode) {</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+  onStopRequest(aRequest, aStatusCode) {</span>
<a href="#l8.45"></a><span id="l8.45">     Assert.equal(aStatusCode, Cr.NS_OK);</span>
<a href="#l8.46"></a><span id="l8.46">   },</span>
<a href="#l8.47"></a><span id="l8.47"> </span>
<a href="#l8.48"></a><span id="l8.48">   // nsIStreamListener</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineminus">-  onDataAvailable: function(aRequest, aInputStream, aOffset, aCount) {</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+  onDataAvailable(aRequest, aInputStream, aOffset, aCount) {</span>
<a href="#l8.51"></a><span id="l8.51">     let scriptStream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;]</span>
<a href="#l8.52"></a><span id="l8.52">                          .createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l8.53"></a><span id="l8.53"> </span>
<a href="#l8.54"></a><span id="l8.54">     scriptStream.init(aInputStream);</span>
<a href="#l8.55"></a><span id="l8.55"> </span>
<a href="#l8.56"></a><span id="l8.56">     scriptStream.read(aCount);</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineminus">-  }</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+  },</span>
<a href="#l8.59"></a><span id="l8.59"> };</span>
<a href="#l8.60"></a><span id="l8.60"> </span>
<a href="#l8.61"></a><span id="l8.61"> var tests = [</span>
<a href="#l8.62"></a><span id="l8.62">   setup,</span>
<a href="#l8.63"></a><span id="l8.63">   displayMessage1,</span>
<a href="#l8.64"></a><span id="l8.64">   displayPart1,</span>
<a href="#l8.65"></a><span id="l8.65">   displayMessage2,</span>
<a href="#l8.66"></a><span id="l8.66">   hackMetadata,</span>
<a href="#l8.67"></a><span id="l8.67">   displayPart2,</span>
<a href="#l8.68"></a><span id="l8.68">   checkCache,</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineminus">-  teardown</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+  teardown,</span>
<a href="#l8.71"></a><span id="l8.71"> ];</span>
<a href="#l8.72"></a><span id="l8.72"> </span>
<a href="#l8.73"></a><span id="l8.73"> async function setup() {</span>
<a href="#l8.74"></a><span id="l8.74">   // No offline download, otherwise nothing is cached.</span>
<a href="#l8.75"></a><span id="l8.75">   Services.prefs.setBoolPref(&quot;mail.server.server1.offline_download&quot;, false);</span>
<a href="#l8.76"></a><span id="l8.76">   // Make sure our small attachment doesn't automatically get loaded, so</span>
<a href="#l8.77"></a><span id="l8.77">   // give it a tiny threshold.</span>
<a href="#l8.78"></a><span id="l8.78">   // XXX We can't set this pref until the fake server supports body structure.</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineat">@@ -91,46 +89,46 @@ async function displayMessage1() {</span>
<a href="#l8.80"></a><span id="l8.80">   // that it reads on its startup.</span>
<a href="#l8.81"></a><span id="l8.81">   gIMAPService = Cc[&quot;@mozilla.org/messenger/messageservice;1?type=imap&quot;]</span>
<a href="#l8.82"></a><span id="l8.82">                    .getService(Ci.nsIMsgMessageService);</span>
<a href="#l8.83"></a><span id="l8.83"> </span>
<a href="#l8.84"></a><span id="l8.84">   let db = IMAPPump.inbox.msgDatabase;</span>
<a href="#l8.85"></a><span id="l8.85">   let msg = db.getMsgHdrForMessageID(gMsgId1);</span>
<a href="#l8.86"></a><span id="l8.86">   gUidValidity = msg.folder.QueryInterface(Ci.nsIImapMailFolderSink).uidValidity;</span>
<a href="#l8.87"></a><span id="l8.87">   let listener = new PromiseTestUtils.PromiseUrlListener();</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineminus">-  let url = new Object;</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+  let url = {};</span>
<a href="#l8.90"></a><span id="l8.90">   gIMAPService.DisplayMessage(IMAPPump.inbox.getUriForMsg(msg),</span>
<a href="#l8.91"></a><span id="l8.91">                               streamListener,</span>
<a href="#l8.92"></a><span id="l8.92">                               null,</span>
<a href="#l8.93"></a><span id="l8.93">                               listener,</span>
<a href="#l8.94"></a><span id="l8.94">                               null,</span>
<a href="#l8.95"></a><span id="l8.95">                               url);</span>
<a href="#l8.96"></a><span id="l8.96">   gMsgURL1 = url.value;</span>
<a href="#l8.97"></a><span id="l8.97">   await listener.promise;</span>
<a href="#l8.98"></a><span id="l8.98"> }</span>
<a href="#l8.99"></a><span id="l8.99"> </span>
<a href="#l8.100"></a><span id="l8.100"> async function displayPart1() {</span>
<a href="#l8.101"></a><span id="l8.101">   let db = IMAPPump.inbox.msgDatabase;</span>
<a href="#l8.102"></a><span id="l8.102">   let msg = db.getMsgHdrForMessageID(gMsgId1);</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineminus">-  let url = new Object;</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineplus">+  let url = {};</span>
<a href="#l8.105"></a><span id="l8.105">   let listener = new PromiseTestUtils.PromiseUrlListener();</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineminus">-  gIMAPService.DisplayMessage(IMAPPump.inbox.getUriForMsg(msg)+&quot;?part=1.2&amp;filename=check.gif&quot;,</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineplus">+  gIMAPService.DisplayMessage(IMAPPump.inbox.getUriForMsg(msg) + &quot;?part=1.2&amp;filename=check.gif&quot;,</span>
<a href="#l8.108"></a><span id="l8.108">                               streamListener,</span>
<a href="#l8.109"></a><span id="l8.109">                               null,</span>
<a href="#l8.110"></a><span id="l8.110">                               listener,</span>
<a href="#l8.111"></a><span id="l8.111">                               null,</span>
<a href="#l8.112"></a><span id="l8.112">                               url);</span>
<a href="#l8.113"></a><span id="l8.113">   gMsgPartURL1 = url.value;</span>
<a href="#l8.114"></a><span id="l8.114">   await listener.promise;</span>
<a href="#l8.115"></a><span id="l8.115"> }</span>
<a href="#l8.116"></a><span id="l8.116"> </span>
<a href="#l8.117"></a><span id="l8.117"> async function displayMessage2() {</span>
<a href="#l8.118"></a><span id="l8.118">   let db = IMAPPump.inbox.msgDatabase;</span>
<a href="#l8.119"></a><span id="l8.119">   let msg = db.getMsgHdrForMessageID(gMsgId2);</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineminus">-  let url = new Object;</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineplus">+  let url = {};</span>
<a href="#l8.122"></a><span id="l8.122">   let listener = new PromiseTestUtils.PromiseUrlListener();</span>
<a href="#l8.123"></a><span id="l8.123">   gIMAPService.DisplayMessage(IMAPPump.inbox.getUriForMsg(msg),</span>
<a href="#l8.124"></a><span id="l8.124">                               streamListener,</span>
<a href="#l8.125"></a><span id="l8.125">                               null,</span>
<a href="#l8.126"></a><span id="l8.126">                               listener,</span>
<a href="#l8.127"></a><span id="l8.127">                               null,</span>
<a href="#l8.128"></a><span id="l8.128">                               url);</span>
<a href="#l8.129"></a><span id="l8.129">   gMsgURL2 = url.value;</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineat">@@ -139,37 +137,36 @@ async function displayMessage2() {</span>
<a href="#l8.131"></a><span id="l8.131"> </span>
<a href="#l8.132"></a><span id="l8.132"> function hackMetadata() {</span>
<a href="#l8.133"></a><span id="l8.133">   // The sad story is that the fake server doesn't support body structure, so we</span>
<a href="#l8.134"></a><span id="l8.134">   // always load all messages entirely.</span>
<a href="#l8.135"></a><span id="l8.135">   // Hack the meta data to pretend this isn't the case to force separate caching</span>
<a href="#l8.136"></a><span id="l8.136">   // of the PDF attachment.</span>
<a href="#l8.137"></a><span id="l8.137">   let extension = gUidValidity.toString(16);</span>
<a href="#l8.138"></a><span id="l8.138"> </span>
<a href="#l8.139"></a><span id="l8.139" class="difflineminus">-  MailServices.imap</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineminus">-              .cacheStorage</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineminus">-              .asyncOpenURI(gMsgURL2, extension, Ci.nsICacheStorage.OPEN_NORMALLY,</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineplus">+  MailServices.imap.cacheStorage.asyncOpenURI(</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineplus">+    gMsgURL2, extension, Ci.nsICacheStorage.OPEN_NORMALLY,</span>
<a href="#l8.144"></a><span id="l8.144">     {</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineminus">-      onCacheEntryAvailable: function(cacheEntry, isNew, appCache, status) {</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineplus">+      onCacheEntryAvailable(cacheEntry, isNew, appCache, status) {</span>
<a href="#l8.147"></a><span id="l8.147">         Assert.equal(status, Cr.NS_OK);</span>
<a href="#l8.148"></a><span id="l8.148">         cacheEntry.setMetaDataElement(&quot;ContentModified&quot;, &quot;Modified View As Link&quot;);</span>
<a href="#l8.149"></a><span id="l8.149">       },</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineminus">-      onCacheEntryCheck: function(cacheEntry, appCache) {</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineplus">+      onCacheEntryCheck(cacheEntry, appCache) {</span>
<a href="#l8.152"></a><span id="l8.152">         return Ci.nsICacheEntryOpenCallback.ENTRY_WANTED;</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineminus">-      }</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineplus">+      },</span>
<a href="#l8.155"></a><span id="l8.155">     }</span>
<a href="#l8.156"></a><span id="l8.156">   );</span>
<a href="#l8.157"></a><span id="l8.157"> }</span>
<a href="#l8.158"></a><span id="l8.158"> </span>
<a href="#l8.159"></a><span id="l8.159"> async function displayPart2() {</span>
<a href="#l8.160"></a><span id="l8.160">   let db = IMAPPump.inbox.msgDatabase;</span>
<a href="#l8.161"></a><span id="l8.161">   let msg = db.getMsgHdrForMessageID(gMsgId2);</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineminus">-  let url = new Object;</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineplus">+  let url = {};</span>
<a href="#l8.164"></a><span id="l8.164">   let listener = new PromiseTestUtils.PromiseUrlListener();</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineminus">-  gIMAPService.DisplayMessage(IMAPPump.inbox.getUriForMsg(msg)+&quot;?part=1.2&amp;filename=check.pdf&quot;,</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineplus">+  gIMAPService.DisplayMessage(IMAPPump.inbox.getUriForMsg(msg) + &quot;?part=1.2&amp;filename=check.pdf&quot;,</span>
<a href="#l8.167"></a><span id="l8.167">                               streamListener,</span>
<a href="#l8.168"></a><span id="l8.168">                               null,</span>
<a href="#l8.169"></a><span id="l8.169">                               listener,</span>
<a href="#l8.170"></a><span id="l8.170">                               null,</span>
<a href="#l8.171"></a><span id="l8.171">                               url);</span>
<a href="#l8.172"></a><span id="l8.172">   gMsgPartURL2 = url.value;</span>
<a href="#l8.173"></a><span id="l8.173">   await listener.promise;</span>
<a href="#l8.174"></a><span id="l8.174"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_chunkLastLF.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_chunkLastLF.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -7,34 +7,34 @@</span>
<a href="#l9.4"></a><span id="l9.4">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l9.5"></a><span id="l9.5"> </span>
<a href="#l9.6"></a><span id="l9.6"> /*</span>
<a href="#l9.7"></a><span id="l9.7">  * Test content length for the IMAP protocol. This focuses on necko URLs</span>
<a href="#l9.8"></a><span id="l9.8">  * that are run externally.</span>
<a href="#l9.9"></a><span id="l9.9">  */</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11">  // async support</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l9.14"></a><span id="l9.14"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l9.15"></a><span id="l9.15"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l9.16"></a><span id="l9.16"> </span>
<a href="#l9.17"></a><span id="l9.17"> var gFile = do_get_file(&quot;../../../data/bug92111b&quot;);</span>
<a href="#l9.18"></a><span id="l9.18"> var gIMAPDaemon, gIMAPServer, gIMAPIncomingServer;</span>
<a href="#l9.19"></a><span id="l9.19"> </span>
<a href="#l9.20"></a><span id="l9.20"> // Adds some messages directly to a mailbox (eg new mail)</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">-function addMessageToServer(file, mailbox)</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">-{</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+function addMessageToServer(file, mailbox) {</span>
<a href="#l9.24"></a><span id="l9.24">   let URI = Services.io.newFileURI(file).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l9.25"></a><span id="l9.25">   let msg = new imapMessage(URI.spec, mailbox.uidnext++, []);</span>
<a href="#l9.26"></a><span id="l9.26">   // underestimate the actual file size, like some IMAP servers do</span>
<a href="#l9.27"></a><span id="l9.27">   msg.setSize(file.fileSize - 55);</span>
<a href="#l9.28"></a><span id="l9.28">   mailbox.addMessage(msg);</span>
<a href="#l9.29"></a><span id="l9.29"> }</span>
<a href="#l9.30"></a><span id="l9.30"> </span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-function run_test()</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineminus">-{</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+function run_test() {</span>
<a href="#l9.34"></a><span id="l9.34">   // Disable new mail notifications</span>
<a href="#l9.35"></a><span id="l9.35">   Services.prefs.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l9.36"></a><span id="l9.36">   Services.prefs.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l9.37"></a><span id="l9.37">   Services.prefs.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l9.38"></a><span id="l9.38">   Services.prefs.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l9.39"></a><span id="l9.39">   Services.prefs.setBoolPref(&quot;mail.server.server1.autosync_offline_stores&quot;, false);</span>
<a href="#l9.40"></a><span id="l9.40"> </span>
<a href="#l9.41"></a><span id="l9.41">   // Crank down the message chunk size to make test cases easier</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineat">@@ -51,18 +51,17 @@ function run_test()</span>
<a href="#l9.43"></a><span id="l9.43">   // The server doesn't support more than one connection</span>
<a href="#l9.44"></a><span id="l9.44">   Services.prefs.setIntPref(&quot;mail.server.server1.max_cached_connections&quot;, 1);</span>
<a href="#l9.45"></a><span id="l9.45">   // We aren't interested in downloading messages automatically</span>
<a href="#l9.46"></a><span id="l9.46">   Services.prefs.setBoolPref(&quot;mail.server.server1.download_on_biff&quot;, false);</span>
<a href="#l9.47"></a><span id="l9.47"> </span>
<a href="#l9.48"></a><span id="l9.48">   async_run_tests([verifyContentLength, endTest]);</span>
<a href="#l9.49"></a><span id="l9.49"> }</span>
<a href="#l9.50"></a><span id="l9.50"> </span>
<a href="#l9.51"></a><span id="l9.51" class="difflineminus">-function* verifyContentLength()</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineminus">-{</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+function* verifyContentLength() {</span>
<a href="#l9.54"></a><span id="l9.54">   dump(&quot;adding message to server\n&quot;);</span>
<a href="#l9.55"></a><span id="l9.55">   // Add a message to the IMAP server</span>
<a href="#l9.56"></a><span id="l9.56">   addMessageToServer(gFile, gIMAPDaemon.getMailbox(&quot;INBOX&quot;));</span>
<a href="#l9.57"></a><span id="l9.57"> </span>
<a href="#l9.58"></a><span id="l9.58">   let imapS = Cc[&quot;@mozilla.org/messenger/messageservice;1?type=imap&quot;]</span>
<a href="#l9.59"></a><span id="l9.59">                 .getService(Ci.nsIMsgMessageService);</span>
<a href="#l9.60"></a><span id="l9.60"> </span>
<a href="#l9.61"></a><span id="l9.61">   dump(&quot;getting uri\n&quot;);</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineat">@@ -100,38 +99,37 @@ function* verifyContentLength()</span>
<a href="#l9.63"></a><span id="l9.63">   //                                                       Ci.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l9.64"></a><span id="l9.64">   // Currently attachments have their content length set to the length of the</span>
<a href="#l9.65"></a><span id="l9.65">   // entire message</span>
<a href="#l9.66"></a><span id="l9.66">   // do_check_eq(attachmentChannel.contentLength, gFile.fileSize);</span>
<a href="#l9.67"></a><span id="l9.67"> </span>
<a href="#l9.68"></a><span id="l9.68">   yield true;</span>
<a href="#l9.69"></a><span id="l9.69"> }</span>
<a href="#l9.70"></a><span id="l9.70"> </span>
<a href="#l9.71"></a><span id="l9.71" class="difflineminus">-function* endTest()</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineminus">-{</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineplus">+function* endTest() {</span>
<a href="#l9.74"></a><span id="l9.74">   gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l9.75"></a><span id="l9.75">   gIMAPServer.stop();</span>
<a href="#l9.76"></a><span id="l9.76">   let thread = gThreadManager.currentThread;</span>
<a href="#l9.77"></a><span id="l9.77">   while (thread.hasPendingEvents())</span>
<a href="#l9.78"></a><span id="l9.78">     thread.processNextEvent(true);</span>
<a href="#l9.79"></a><span id="l9.79"> </span>
<a href="#l9.80"></a><span id="l9.80">   yield true;</span>
<a href="#l9.81"></a><span id="l9.81"> }</span>
<a href="#l9.82"></a><span id="l9.82"> </span>
<a href="#l9.83"></a><span id="l9.83"> var gStreamListener = {</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineminus">-  QueryInterface : ChromeUtils.generateQI([Ci.nsIStreamListener]),</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineminus">-  _stream : null,</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineminus">-  _data : null,</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineminus">-  onStartRequest : function (aRequest) {</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineplus">+  QueryInterface: ChromeUtils.generateQI([Ci.nsIStreamListener]),</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineplus">+  _stream: null,</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineplus">+  _data: null,</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineplus">+  onStartRequest(aRequest) {</span>
<a href="#l9.92"></a><span id="l9.92">     this._data = &quot;&quot;;</span>
<a href="#l9.93"></a><span id="l9.93">     this._stream = null;</span>
<a href="#l9.94"></a><span id="l9.94">   },</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineminus">-  onStopRequest : function (aRequest, aStatusCode) {</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineplus">+  onStopRequest(aRequest, aStatusCode) {</span>
<a href="#l9.97"></a><span id="l9.97">     async_driver();</span>
<a href="#l9.98"></a><span id="l9.98">   },</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineminus">-  onDataAvailable : function (aRequest, aInputStream, aOff, aCount) {</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineplus">+  onDataAvailable(aRequest, aInputStream, aOff, aCount) {</span>
<a href="#l9.101"></a><span id="l9.101">     if (this._stream == null) {</span>
<a href="#l9.102"></a><span id="l9.102">       this._stream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;].createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l9.103"></a><span id="l9.103">       this._stream.init(aInputStream);</span>
<a href="#l9.104"></a><span id="l9.104">     }</span>
<a href="#l9.105"></a><span id="l9.105">     this._data += this._stream.read(aCount);</span>
<a href="#l9.106"></a><span id="l9.106">   },</span>
<a href="#l9.107"></a><span id="l9.107"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_compactOfflineStore.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_compactOfflineStore.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -2,73 +2,69 @@</span>
<a href="#l10.4"></a><span id="l10.4"> /*</span>
<a href="#l10.5"></a><span id="l10.5">  * Test to ensure that compacting offline stores works correctly with imap folders</span>
<a href="#l10.6"></a><span id="l10.6">  * and returns success.</span>
<a href="#l10.7"></a><span id="l10.7">  */</span>
<a href="#l10.8"></a><span id="l10.8"> </span>
<a href="#l10.9"></a><span id="l10.9"> Services.prefs.setCharPref(&quot;mail.serverDefaultStoreContractID&quot;,</span>
<a href="#l10.10"></a><span id="l10.10">                            &quot;@mozilla.org/msgstore/berkeleystore;1&quot;);</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+/* import-globals-from ../../../test/resources/alertTestUtils.js */</span>
<a href="#l10.16"></a><span id="l10.16"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l10.17"></a><span id="l10.17"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l10.18"></a><span id="l10.18"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l10.19"></a><span id="l10.19"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l10.20"></a><span id="l10.20"> </span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">-var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineminus">-</span>
<a href="#l10.23"></a><span id="l10.23"> // Globals</span>
<a href="#l10.24"></a><span id="l10.24"> var gRootFolder;</span>
<a href="#l10.25"></a><span id="l10.25"> var gImapInboxOfflineStoreSize;</span>
<a href="#l10.26"></a><span id="l10.26"> </span>
<a href="#l10.27"></a><span id="l10.27"> var gMsgFile1 = do_get_file(&quot;../../../data/bugmail10&quot;);</span>
<a href="#l10.28"></a><span id="l10.28"> var gMsgFile2 = do_get_file(&quot;../../../data/bugmail11&quot;);</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineminus">-var gMsgFile3 = do_get_file(&quot;../../../data/draft1&quot;);</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+// var gMsgFile3 = do_get_file(&quot;../../../data/draft1&quot;);</span>
<a href="#l10.31"></a><span id="l10.31"> var gMsgFile4 = do_get_file(&quot;../../../data/bugmail7&quot;);</span>
<a href="#l10.32"></a><span id="l10.32"> var gMsgFile5 = do_get_file(&quot;../../../data/bugmail6&quot;);</span>
<a href="#l10.33"></a><span id="l10.33"> </span>
<a href="#l10.34"></a><span id="l10.34"> // Copied straight from the example files</span>
<a href="#l10.35"></a><span id="l10.35"> var gMsgId1 = &quot;200806061706.m56H6RWT004933@mrapp54.mozilla.org&quot;;</span>
<a href="#l10.36"></a><span id="l10.36"> var gMsgId2 = &quot;200804111417.m3BEHTk4030129@mrapp51.mozilla.org&quot;;</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-var gMsgId3 = &quot;4849BF7B.2030800@example.com&quot;;</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+// var gMsgId3 = &quot;4849BF7B.2030800@example.com&quot;;</span>
<a href="#l10.39"></a><span id="l10.39"> var gMsgId4 = &quot;bugmail7.m47LtAEf007542@mrapp51.mozilla.org&quot;;</span>
<a href="#l10.40"></a><span id="l10.40"> var gMsgId5 = &quot;bugmail6.m47LtAEf007542@mrapp51.mozilla.org&quot;;</span>
<a href="#l10.41"></a><span id="l10.41"> </span>
<a href="#l10.42"></a><span id="l10.42"> // Adds some messages directly to a mailbox (eg new mail)</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineminus">-function addMessagesToServer(messages, mailbox)</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineminus">-{</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+function addMessagesToServer(messages, mailbox) {</span>
<a href="#l10.46"></a><span id="l10.46">   // For every message we have, we need to convert it to a file:/// URI</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineminus">-  messages.forEach(function (message)</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-  {</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+  messages.forEach(function(message) {</span>
<a href="#l10.50"></a><span id="l10.50">     let URI = Services.io.newFileURI(message.file).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l10.51"></a><span id="l10.51">     // Create the imapMessage and store it on the mailbox.</span>
<a href="#l10.52"></a><span id="l10.52">     mailbox.addMessage(new imapMessage(URI.spec, mailbox.uidnext++, []));</span>
<a href="#l10.53"></a><span id="l10.53">   });</span>
<a href="#l10.54"></a><span id="l10.54"> }</span>
<a href="#l10.55"></a><span id="l10.55"> </span>
<a href="#l10.56"></a><span id="l10.56" class="difflineminus">-function addGeneratedMessagesToServer(messages, mailbox)</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineminus">-{</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineplus">+function addGeneratedMessagesToServer(messages, mailbox) {</span>
<a href="#l10.59"></a><span id="l10.59">   // Create the imapMessages and store them on the mailbox</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineminus">-  messages.forEach(function (message)</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineminus">-  {</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+  messages.forEach(function(message) {</span>
<a href="#l10.63"></a><span id="l10.63">     let dataUri = Services.io.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l10.64"></a><span id="l10.64">                                      btoa(message.toMessageString()));</span>
<a href="#l10.65"></a><span id="l10.65">     mailbox.addMessage(new imapMessage(dataUri.spec, mailbox.uidnext++, []));</span>
<a href="#l10.66"></a><span id="l10.66">   });</span>
<a href="#l10.67"></a><span id="l10.67"> }</span>
<a href="#l10.68"></a><span id="l10.68"> </span>
<a href="#l10.69"></a><span id="l10.69"> </span>
<a href="#l10.70"></a><span id="l10.70"> function checkOfflineStore(prevOfflineStoreSize) {</span>
<a href="#l10.71"></a><span id="l10.71">   dump(&quot;checking offline store\n&quot;);</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineminus">-  let offset = new Object;</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineminus">-  let size = new Object;</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineplus">+  let offset = {};</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineplus">+  let size = {};</span>
<a href="#l10.76"></a><span id="l10.76">   let enumerator = IMAPPump.inbox.msgDatabase.EnumerateMessages();</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineminus">-  if (enumerator)</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineminus">-  {</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineminus">-    while (enumerator.hasMoreElements())</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineminus">-    {</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineplus">+  if (enumerator) {</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineplus">+    while (enumerator.hasMoreElements()) {</span>
<a href="#l10.83"></a><span id="l10.83">       let header = enumerator.getNext();</span>
<a href="#l10.84"></a><span id="l10.84">       // this will verify that the message in the offline store</span>
<a href="#l10.85"></a><span id="l10.85">       // starts with &quot;From &quot; - otherwise, it returns an error.</span>
<a href="#l10.86"></a><span id="l10.86">       if (header instanceof Ci.nsIMsgDBHdr &amp;&amp;</span>
<a href="#l10.87"></a><span id="l10.87">          (header.flags &amp; Ci.nsMsgMessageFlags.Offline))</span>
<a href="#l10.88"></a><span id="l10.88">         IMAPPump.inbox.getOfflineFileStream(header.messageKey, offset, size).close();</span>
<a href="#l10.89"></a><span id="l10.89">     }</span>
<a href="#l10.90"></a><span id="l10.90">   }</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineat">@@ -142,28 +138,28 @@ var tests = [</span>
<a href="#l10.92"></a><span id="l10.92">     tmpFile.append(&quot;nstmp&quot;);</span>
<a href="#l10.93"></a><span id="l10.93">     Assert.ok(!tmpFile.exists());</span>
<a href="#l10.94"></a><span id="l10.94">     checkOfflineStore(gImapInboxOfflineStoreSize);</span>
<a href="#l10.95"></a><span id="l10.95">     asyncUrlListener.OnStopRunningUrl(null, 0);</span>
<a href="#l10.96"></a><span id="l10.96">     yield false;</span>
<a href="#l10.97"></a><span id="l10.97">     let msgHdr = IMAPPump.inbox.msgDatabase.getMsgHdrForMessageID(gMsgId2);</span>
<a href="#l10.98"></a><span id="l10.98">     Assert.equal(msgHdr.flags &amp; Ci.nsMsgMessageFlags.Offline, 0);</span>
<a href="#l10.99"></a><span id="l10.99">   },</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineminus">-  teardown</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineplus">+  teardown,</span>
<a href="#l10.102"></a><span id="l10.102"> ];</span>
<a href="#l10.103"></a><span id="l10.103"> </span>
<a href="#l10.104"></a><span id="l10.104"> function setup() {</span>
<a href="#l10.105"></a><span id="l10.105">   setupIMAPPump();</span>
<a href="#l10.106"></a><span id="l10.106"> </span>
<a href="#l10.107"></a><span id="l10.107">   gRootFolder = IMAPPump.incomingServer.rootFolder;</span>
<a href="#l10.108"></a><span id="l10.108">   // these hacks are required because we've created the inbox before</span>
<a href="#l10.109"></a><span id="l10.109">   // running initial folder discovery, and adding the folder bails</span>
<a href="#l10.110"></a><span id="l10.110">   // out before we set it as verified online, so we bail out, and</span>
<a href="#l10.111"></a><span id="l10.111">   // then remove the INBOX folder since it's not verified.</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineminus">-  IMAPPump.inbox.hierarchyDelimiter = '/';</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineplus">+  IMAPPump.inbox.hierarchyDelimiter = &quot;/&quot;;</span>
<a href="#l10.114"></a><span id="l10.114">   IMAPPump.inbox.verifiedAsOnlineFolder = true;</span>
<a href="#l10.115"></a><span id="l10.115"> </span>
<a href="#l10.116"></a><span id="l10.116">   let messageGenerator = new MessageGenerator();</span>
<a href="#l10.117"></a><span id="l10.117">   let messages = [];</span>
<a href="#l10.118"></a><span id="l10.118">   for (let i = 0; i &lt; 50; i++)</span>
<a href="#l10.119"></a><span id="l10.119">     messages = messages.concat(messageGenerator.makeMessage());</span>
<a href="#l10.120"></a><span id="l10.120"> </span>
<a href="#l10.121"></a><span id="l10.121">   addGeneratedMessagesToServer(messages, IMAPPump.daemon.getMailbox(&quot;INBOX&quot;));</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineat">@@ -175,28 +171,25 @@ function setup() {</span>
<a href="#l10.123"></a><span id="l10.123">                        {file: gMsgFile2, messageId: gMsgId2},</span>
<a href="#l10.124"></a><span id="l10.124">                        {file: gMsgFile5, messageId: gMsgId5}],</span>
<a href="#l10.125"></a><span id="l10.125">                       IMAPPump.daemon.getMailbox(&quot;INBOX&quot;));</span>
<a href="#l10.126"></a><span id="l10.126"> }</span>
<a href="#l10.127"></a><span id="l10.127"> </span>
<a href="#l10.128"></a><span id="l10.128"> // nsIMsgCopyServiceListener implementation - runs next test when copy</span>
<a href="#l10.129"></a><span id="l10.129"> // is completed.</span>
<a href="#l10.130"></a><span id="l10.130"> var CopyListener = {</span>
<a href="#l10.131"></a><span id="l10.131" class="difflineminus">-  OnStartCopy: function() {},</span>
<a href="#l10.132"></a><span id="l10.132" class="difflineminus">-  OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineminus">-  SetMessageKey: function(aKey) {</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineminus">-    let hdr = localAccountUtils.inboxFolder.GetMessageHeader(aKey);</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineminus">-    gMsgHdrs.push({hdr: hdr, ID: hdr.messageId});</span>
<a href="#l10.136"></a><span id="l10.136" class="difflineminus">-  },</span>
<a href="#l10.137"></a><span id="l10.137" class="difflineminus">-  SetMessageId: function(aMessageId) {},</span>
<a href="#l10.138"></a><span id="l10.138" class="difflineminus">-  OnStopCopy: function(aStatus) {</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineplus">+  OnStartCopy() {},</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineplus">+  OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineplus">+  SetMessageKey(aKey) {},</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineplus">+  SetMessageId(aMessageId) {},</span>
<a href="#l10.143"></a><span id="l10.143" class="difflineplus">+  OnStopCopy(aStatus) {</span>
<a href="#l10.144"></a><span id="l10.144">     // Check: message successfully copied.</span>
<a href="#l10.145"></a><span id="l10.145">     Assert.equal(aStatus, 0);</span>
<a href="#l10.146"></a><span id="l10.146">     async_driver();</span>
<a href="#l10.147"></a><span id="l10.147" class="difflineminus">-  }</span>
<a href="#l10.148"></a><span id="l10.148" class="difflineplus">+  },</span>
<a href="#l10.149"></a><span id="l10.149"> };</span>
<a href="#l10.150"></a><span id="l10.150"> </span>
<a href="#l10.151"></a><span id="l10.151"> function teardown() {</span>
<a href="#l10.152"></a><span id="l10.152">   gRootFolder = null;</span>
<a href="#l10.153"></a><span id="l10.153">   teardownIMAPPump();</span>
<a href="#l10.154"></a><span id="l10.154"> }</span>
<a href="#l10.155"></a><span id="l10.155"> </span>
<a href="#l10.156"></a><span id="l10.156"> function run_test() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_converterImap.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_converterImap.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -4,34 +4,36 @@</span>
<a href="#l11.4"></a><span id="l11.4"> </span>
<a href="#l11.5"></a><span id="l11.5"> var {OS} = ChromeUtils.import(&quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l11.6"></a><span id="l11.6"> var {convertMailStoreTo} = ChromeUtils.import(&quot;resource:///modules/mailstoreConverter.jsm&quot;);</span>
<a href="#l11.7"></a><span id="l11.7"> var {Log} = ChromeUtils.import(&quot;resource://gre/modules/Log.jsm&quot;);</span>
<a href="#l11.8"></a><span id="l11.8"> </span>
<a href="#l11.9"></a><span id="l11.9"> Services.prefs.setCharPref(&quot;mail.serverDefaultStoreContractID&quot;,</span>
<a href="#l11.10"></a><span id="l11.10">                            &quot;@mozilla.org/msgstore/berkeleystore;1&quot;);</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+/* import-globals-from ../../../test/resources/alertTestUtils.js */</span>
<a href="#l11.16"></a><span id="l11.16"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l11.17"></a><span id="l11.17"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l11.18"></a><span id="l11.18"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l11.19"></a><span id="l11.19"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l11.20"></a><span id="l11.20"> </span>
<a href="#l11.21"></a><span id="l11.21"> var log = Log.repository.getLogger(&quot;MailStoreConverter&quot;);</span>
<a href="#l11.22"></a><span id="l11.22"> </span>
<a href="#l11.23"></a><span id="l11.23"> var {FileUtils} = ChromeUtils.import(&quot;resource://gre/modules/FileUtils.jsm&quot;);</span>
<a href="#l11.24"></a><span id="l11.24"> </span>
<a href="#l11.25"></a><span id="l11.25"> // Globals</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineminus">-var gRootFolder;</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineminus">-</span>
<a href="#l11.28"></a><span id="l11.28"> var gMsgFile1 = do_get_file(&quot;../../../data/bugmail10&quot;);</span>
<a href="#l11.29"></a><span id="l11.29"> </span>
<a href="#l11.30"></a><span id="l11.30"> // Copied straight from the example files</span>
<a href="#l11.31"></a><span id="l11.31"> var gMsgId1 = &quot;200806061706.m56H6RWT004933@mrapp54.mozilla.org&quot;;</span>
<a href="#l11.32"></a><span id="l11.32"> var gMsgId2 = &quot;200804111417.m3BEHTk4030129@mrapp51.mozilla.org&quot;;</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-var gMsgId3 = &quot;4849BF7B.2030800@example.com&quot;;</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+// var gMsgId3 = &quot;4849BF7B.2030800@example.com&quot;;</span>
<a href="#l11.35"></a><span id="l11.35"> var gMsgId4 = &quot;bugmail7.m47LtAEf007542@mrapp51.mozilla.org&quot;;</span>
<a href="#l11.36"></a><span id="l11.36"> var gMsgId5 = &quot;bugmail6.m47LtAEf007542@mrapp51.mozilla.org&quot;;</span>
<a href="#l11.37"></a><span id="l11.37"> </span>
<a href="#l11.38"></a><span id="l11.38"> function checkConversion(aSource, aTarget) {</span>
<a href="#l11.39"></a><span id="l11.39">   let sourceContents = aSource.directoryEntries;</span>
<a href="#l11.40"></a><span id="l11.40"> </span>
<a href="#l11.41"></a><span id="l11.41">   while (sourceContents.hasMoreElements()) {</span>
<a href="#l11.42"></a><span id="l11.42">     let sourceContent = sourceContents.getNext().QueryInterface(Ci.nsIFile);</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineat">@@ -50,17 +52,17 @@ function checkConversion(aSource, aTarge</span>
<a href="#l11.44"></a><span id="l11.44">       let cur = FileUtils.File(OS.Path.join(targetFile.path, &quot;cur&quot;));</span>
<a href="#l11.45"></a><span id="l11.45">       Assert.ok(cur.exists());</span>
<a href="#l11.46"></a><span id="l11.46">       let tmp = FileUtils.File(OS.Path.join(targetFile.path, &quot;tmp&quot;));</span>
<a href="#l11.47"></a><span id="l11.47">       Assert.ok(tmp.exists());</span>
<a href="#l11.48"></a><span id="l11.48">       if (targetFile.leafName == &quot;INBOX&quot;) {</span>
<a href="#l11.49"></a><span id="l11.49">         let curContents = cur.directoryEntries;</span>
<a href="#l11.50"></a><span id="l11.50">         let curContentsCount = 0;</span>
<a href="#l11.51"></a><span id="l11.51">         while (curContents.hasMoreElements()) {</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineminus">-          let curContent = curContents.getNext();</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+          curContents.getNext();</span>
<a href="#l11.54"></a><span id="l11.54">           curContentsCount += 1;</span>
<a href="#l11.55"></a><span id="l11.55">         }</span>
<a href="#l11.56"></a><span id="l11.56">         Assert.equal(curContentsCount, 8);</span>
<a href="#l11.57"></a><span id="l11.57">       }</span>
<a href="#l11.58"></a><span id="l11.58">     }</span>
<a href="#l11.59"></a><span id="l11.59">   }</span>
<a href="#l11.60"></a><span id="l11.60"> }</span>
<a href="#l11.61"></a><span id="l11.61"> </span>
<a href="#l11.62"></a><span id="l11.62" class="difflineat">@@ -85,17 +87,16 @@ function addMessagesToServer(aMessages, </span>
<a href="#l11.63"></a><span id="l11.63">   aMessages.forEach(function(message) {</span>
<a href="#l11.64"></a><span id="l11.64">     aMailbox.addMessage(new imapMessage(message.spec, aMailbox.uidnext++, []));</span>
<a href="#l11.65"></a><span id="l11.65">   });</span>
<a href="#l11.66"></a><span id="l11.66"> }</span>
<a href="#l11.67"></a><span id="l11.67"> </span>
<a href="#l11.68"></a><span id="l11.68"> function setup() {</span>
<a href="#l11.69"></a><span id="l11.69">   setupIMAPPump();</span>
<a href="#l11.70"></a><span id="l11.70"> </span>
<a href="#l11.71"></a><span id="l11.71" class="difflineminus">-  gRootFolder = IMAPPump.incomingServer.rootFolder;</span>
<a href="#l11.72"></a><span id="l11.72">   // These hacks are required because we've created the inbox before</span>
<a href="#l11.73"></a><span id="l11.73">   // running initial folder discovery, and adding the folder bails</span>
<a href="#l11.74"></a><span id="l11.74">   // out before we set it as verified online, so we bail out, and</span>
<a href="#l11.75"></a><span id="l11.75">   // then remove the INBOX folder since it's not verified.</span>
<a href="#l11.76"></a><span id="l11.76">   IMAPPump.inbox.hierarchyDelimiter = &quot;/&quot;;</span>
<a href="#l11.77"></a><span id="l11.77">   IMAPPump.inbox.verifiedAsOnlineFolder = true;</span>
<a href="#l11.78"></a><span id="l11.78"> </span>
<a href="#l11.79"></a><span id="l11.79">   // Add a couple of messages to the INBOX.</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineat">@@ -112,17 +113,16 @@ async function downloadForOffline() {</span>
<a href="#l11.81"></a><span id="l11.81">   let promiseUrlListener = new PromiseTestUtils.PromiseUrlListener();</span>
<a href="#l11.82"></a><span id="l11.82">   IMAPPump.inbox.downloadAllForOffline(promiseUrlListener, null);</span>
<a href="#l11.83"></a><span id="l11.83">   await promiseUrlListener.promise;</span>
<a href="#l11.84"></a><span id="l11.84"> }</span>
<a href="#l11.85"></a><span id="l11.85"> </span>
<a href="#l11.86"></a><span id="l11.86"> function run_test() {</span>
<a href="#l11.87"></a><span id="l11.87">   setup();</span>
<a href="#l11.88"></a><span id="l11.88">   registerCleanupFunction(function() {</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineminus">-    gRootFolder = null;</span>
<a href="#l11.90"></a><span id="l11.90">     teardownIMAPPump();</span>
<a href="#l11.91"></a><span id="l11.91">   });</span>
<a href="#l11.92"></a><span id="l11.92"> </span>
<a href="#l11.93"></a><span id="l11.93">   run_next_test();</span>
<a href="#l11.94"></a><span id="l11.94"> }</span>
<a href="#l11.95"></a><span id="l11.95"> </span>
<a href="#l11.96"></a><span id="l11.96"> add_task(async function convert() {</span>
<a href="#l11.97"></a><span id="l11.97">   await downloadForOffline();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_copyThenMove.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_copyThenMove.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -1,47 +1,43 @@</span>
<a href="#l12.4"></a><span id="l12.4"> // This file extends test_imapFolderCopy.js to test message</span>
<a href="#l12.5"></a><span id="l12.5"> // moves from a local folder to an IMAP folder.</span>
<a href="#l12.6"></a><span id="l12.6"> //</span>
<a href="#l12.7"></a><span id="l12.7"> // Original Author: Kent James &lt;kent@caspia.com&gt;</span>
<a href="#l12.8"></a><span id="l12.8"> </span>
<a href="#l12.9"></a><span id="l12.9"> </span>
<a href="#l12.10"></a><span id="l12.10" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l12.13"></a><span id="l12.13"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l12.14"></a><span id="l12.14"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l12.15"></a><span id="l12.15"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l12.16"></a><span id="l12.16"> </span>
<a href="#l12.17"></a><span id="l12.17"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l12.18"></a><span id="l12.18"> </span>
<a href="#l12.19"></a><span id="l12.19"> var gEmptyLocal1, gEmptyLocal2;</span>
<a href="#l12.20"></a><span id="l12.20"> var gLastKey;</span>
<a href="#l12.21"></a><span id="l12.21"> var gMessages = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l12.22"></a><span id="l12.22"> var gCopyService = MailServices.copy;</span>
<a href="#l12.23"></a><span id="l12.23"> </span>
<a href="#l12.24"></a><span id="l12.24" class="difflineminus">-var {</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineminus">-  getFolderProperties,</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineminus">-  getSpecialFolderString,</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineminus">-  allAccountsSorted,</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineminus">-  getMostRecentFolders,</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineminus">-  folderNameCompare,</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineminus">-} = ChromeUtils.import(&quot;resource:///modules/folderUtils.jsm&quot;);</span>
<a href="#l12.31"></a><span id="l12.31"> var {toXPCOMArray} = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l12.32"></a><span id="l12.32"> </span>
<a href="#l12.33"></a><span id="l12.33"> var tests = [</span>
<a href="#l12.34"></a><span id="l12.34">   setup,</span>
<a href="#l12.35"></a><span id="l12.35">   function* copyFolder1() {</span>
<a href="#l12.36"></a><span id="l12.36">     dump(&quot;gEmpty1 &quot; + gEmptyLocal1.URI + &quot;\n&quot;);</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineminus">-    let folders = new Array;</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+    let folders = [];</span>
<a href="#l12.39"></a><span id="l12.39">     folders.push(gEmptyLocal1.QueryInterface(Ci.nsIMsgFolder));</span>
<a href="#l12.40"></a><span id="l12.40">     let array = toXPCOMArray(folders, Ci.nsIMutableArray);</span>
<a href="#l12.41"></a><span id="l12.41">     gCopyService.CopyFolders(array, IMAPPump.inbox, false, CopyListener, null);</span>
<a href="#l12.42"></a><span id="l12.42">     yield false;</span>
<a href="#l12.43"></a><span id="l12.43">   },</span>
<a href="#l12.44"></a><span id="l12.44">   function* copyFolder2() {</span>
<a href="#l12.45"></a><span id="l12.45">     dump(&quot;gEmpty2 &quot; + gEmptyLocal2.URI + &quot;\n&quot;);</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineminus">-    let folders = new Array;</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+    let folders = [];</span>
<a href="#l12.48"></a><span id="l12.48">     folders.push(gEmptyLocal2);</span>
<a href="#l12.49"></a><span id="l12.49">     let array = toXPCOMArray(folders, Ci.nsIMutableArray);</span>
<a href="#l12.50"></a><span id="l12.50">     gCopyService.CopyFolders(array, IMAPPump.inbox, false, CopyListener, null);</span>
<a href="#l12.51"></a><span id="l12.51">     yield false;</span>
<a href="#l12.52"></a><span id="l12.52">   },</span>
<a href="#l12.53"></a><span id="l12.53">   function* getLocalMessage1() {</span>
<a href="#l12.54"></a><span id="l12.54">     dump(&quot;getLocalMessage\n&quot;);</span>
<a href="#l12.55"></a><span id="l12.55">     var file = do_get_file(&quot;../../../data/bugmail1&quot;);</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineat">@@ -87,27 +83,25 @@ var tests = [</span>
<a href="#l12.57"></a><span id="l12.57">     Assert.ok(folder2 !== null);</span>
<a href="#l12.58"></a><span id="l12.58">     // folder 1 and 2 should each now have two messages in them.</span>
<a href="#l12.59"></a><span id="l12.59">     Assert.ok(folder1 !== null);</span>
<a href="#l12.60"></a><span id="l12.60">     Assert.equal(folderCount(folder2), 2);</span>
<a href="#l12.61"></a><span id="l12.61">     // The local inbox folder should now be empty, since the second</span>
<a href="#l12.62"></a><span id="l12.62">     // operation was a move.</span>
<a href="#l12.63"></a><span id="l12.63">     Assert.equal(folderCount(localAccountUtils.inboxFolder), 0);</span>
<a href="#l12.64"></a><span id="l12.64">   },</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineminus">-  teardown</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineplus">+  teardown,</span>
<a href="#l12.67"></a><span id="l12.67"> ];</span>
<a href="#l12.68"></a><span id="l12.68"> </span>
<a href="#l12.69"></a><span id="l12.69" class="difflineminus">-function folderCount(folder)</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineminus">-{</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineplus">+function folderCount(folder) {</span>
<a href="#l12.72"></a><span id="l12.72">   let enumerator = folder.msgDatabase.EnumerateMessages();</span>
<a href="#l12.73"></a><span id="l12.73">   let count = 0;</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineminus">-  while (enumerator.hasMoreElements())</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineminus">-  {</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineplus">+  while (enumerator.hasMoreElements()) {</span>
<a href="#l12.77"></a><span id="l12.77">     count++;</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineminus">-    let hdr = enumerator.getNext();</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineplus">+    enumerator.getNext();</span>
<a href="#l12.80"></a><span id="l12.80">   }</span>
<a href="#l12.81"></a><span id="l12.81">   return count;</span>
<a href="#l12.82"></a><span id="l12.82"> }</span>
<a href="#l12.83"></a><span id="l12.83"> </span>
<a href="#l12.84"></a><span id="l12.84"> function setup() {</span>
<a href="#l12.85"></a><span id="l12.85">   // Turn off autosync_offline_stores because</span>
<a href="#l12.86"></a><span id="l12.86">   // fetching messages is invoked after copying the messages.</span>
<a href="#l12.87"></a><span id="l12.87">   // (i.e. The fetching process will be invoked after OnStopCopy)</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineat">@@ -119,37 +113,34 @@ function setup() {</span>
<a href="#l12.89"></a><span id="l12.89"> </span>
<a href="#l12.90"></a><span id="l12.90">   gEmptyLocal1 = localAccountUtils.rootFolder.createLocalSubfolder(&quot;empty 1&quot;);</span>
<a href="#l12.91"></a><span id="l12.91">   gEmptyLocal2 = localAccountUtils.rootFolder.createLocalSubfolder(&quot;empty 2&quot;);</span>
<a href="#l12.92"></a><span id="l12.92"> </span>
<a href="#l12.93"></a><span id="l12.93">   // these hacks are required because we've created the inbox before</span>
<a href="#l12.94"></a><span id="l12.94">   // running initial folder discovery, and adding the folder bails</span>
<a href="#l12.95"></a><span id="l12.95">   // out before we set it as verified online, so we bail out, and</span>
<a href="#l12.96"></a><span id="l12.96">   // then remove the INBOX folder since it's not verified.</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineminus">-  IMAPPump.inbox.hierarchyDelimiter = '/';</span>
<a href="#l12.98"></a><span id="l12.98" class="difflineplus">+  IMAPPump.inbox.hierarchyDelimiter = &quot;/&quot;;</span>
<a href="#l12.99"></a><span id="l12.99">   IMAPPump.inbox.verifiedAsOnlineFolder = true;</span>
<a href="#l12.100"></a><span id="l12.100"> }</span>
<a href="#l12.101"></a><span id="l12.101"> </span>
<a href="#l12.102"></a><span id="l12.102"> // nsIMsgCopyServiceListener implementation - runs next test when copy</span>
<a href="#l12.103"></a><span id="l12.103"> // is completed.</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineminus">-var CopyListener =</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineminus">-{</span>
<a href="#l12.106"></a><span id="l12.106" class="difflineminus">-  OnStartCopy: function() {},</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineminus">-  OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineminus">-  SetMessageKey: function(aKey)</span>
<a href="#l12.109"></a><span id="l12.109" class="difflineminus">-  {</span>
<a href="#l12.110"></a><span id="l12.110" class="difflineplus">+var CopyListener = {</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineplus">+  OnStartCopy() {},</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineplus">+  OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l12.113"></a><span id="l12.113" class="difflineplus">+  SetMessageKey(aKey) {</span>
<a href="#l12.114"></a><span id="l12.114">     gLastKey = aKey;</span>
<a href="#l12.115"></a><span id="l12.115">   },</span>
<a href="#l12.116"></a><span id="l12.116" class="difflineminus">-  SetMessageId: function(aMessageId) {},</span>
<a href="#l12.117"></a><span id="l12.117" class="difflineminus">-  OnStopCopy: function(aStatus)</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineminus">-  {</span>
<a href="#l12.119"></a><span id="l12.119" class="difflineplus">+  SetMessageId(aMessageId) {},</span>
<a href="#l12.120"></a><span id="l12.120" class="difflineplus">+  OnStopCopy(aStatus) {</span>
<a href="#l12.121"></a><span id="l12.121">     // Check: message successfully copied.</span>
<a href="#l12.122"></a><span id="l12.122">     Assert.equal(aStatus, 0);</span>
<a href="#l12.123"></a><span id="l12.123">     async_driver();</span>
<a href="#l12.124"></a><span id="l12.124" class="difflineminus">-  }</span>
<a href="#l12.125"></a><span id="l12.125" class="difflineplus">+  },</span>
<a href="#l12.126"></a><span id="l12.126"> };</span>
<a href="#l12.127"></a><span id="l12.127"> </span>
<a href="#l12.128"></a><span id="l12.128"> asyncUrlListener.callback = function(aUrl, aExitCode) {</span>
<a href="#l12.129"></a><span id="l12.129">   Assert.equal(aExitCode, 0);</span>
<a href="#l12.130"></a><span id="l12.130"> };</span>
<a href="#l12.131"></a><span id="l12.131"> </span>
<a href="#l12.132"></a><span id="l12.132"> function teardown() {</span>
<a href="#l12.133"></a><span id="l12.133">   gMessages.clear();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_customCommandReturnsFetchResponse.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_customCommandReturnsFetchResponse.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -3,144 +3,139 @@</span>
<a href="#l13.4"></a><span id="l13.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l13.5"></a><span id="l13.5"> </span>
<a href="#l13.6"></a><span id="l13.6"> /*</span>
<a href="#l13.7"></a><span id="l13.7">  * Test to ensure that imap customCommandResult function works properly</span>
<a href="#l13.8"></a><span id="l13.8">  * Bug 778246</span>
<a href="#l13.9"></a><span id="l13.9">  */</span>
<a href="#l13.10"></a><span id="l13.10"> </span>
<a href="#l13.11"></a><span id="l13.11"> // async support</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l13.14"></a><span id="l13.14"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l13.15"></a><span id="l13.15"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l13.16"></a><span id="l13.16"> </span>
<a href="#l13.17"></a><span id="l13.17"> // IMAP pump</span>
<a href="#l13.18"></a><span id="l13.18"> </span>
<a href="#l13.19"></a><span id="l13.19"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l13.20"></a><span id="l13.20"> </span>
<a href="#l13.21"></a><span id="l13.21"> // Globals</span>
<a href="#l13.22"></a><span id="l13.22"> </span>
<a href="#l13.23"></a><span id="l13.23"> // Messages to load must have CRLF line endings, that is Windows style</span>
<a href="#l13.24"></a><span id="l13.24"> var gMessageFileName = &quot;bugmail10&quot;; // message file used as the test message</span>
<a href="#l13.25"></a><span id="l13.25"> var gMessage, gExpectedLength;</span>
<a href="#l13.26"></a><span id="l13.26"> </span>
<a href="#l13.27"></a><span id="l13.27" class="difflineminus">-var gCustomList = ['Custom1', 'Custom2', 'Custom3'];</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+var gCustomList = [&quot;Custom1&quot;, &quot;Custom2&quot;, &quot;Custom3&quot;];</span>
<a href="#l13.29"></a><span id="l13.29"> </span>
<a href="#l13.30"></a><span id="l13.30"> var gMsgWindow = Cc[&quot;@mozilla.org/messenger/msgwindow;1&quot;]</span>
<a href="#l13.31"></a><span id="l13.31">   .createInstance(Ci.nsIMsgWindow);</span>
<a href="#l13.32"></a><span id="l13.32"> </span>
<a href="#l13.33"></a><span id="l13.33"> setupIMAPPump(&quot;CUSTOM1&quot;);</span>
<a href="#l13.34"></a><span id="l13.34"> </span>
<a href="#l13.35"></a><span id="l13.35"> // Definition of tests</span>
<a href="#l13.36"></a><span id="l13.36"> var tests = [</span>
<a href="#l13.37"></a><span id="l13.37">   loadImapMessage,</span>
<a href="#l13.38"></a><span id="l13.38">   testStoreCustomList,</span>
<a href="#l13.39"></a><span id="l13.39">   testStoreMinusCustomList,</span>
<a href="#l13.40"></a><span id="l13.40">   testStorePlusCustomList,</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineminus">-  endTest</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineminus">-]</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+  endTest,</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+];</span>
<a href="#l13.45"></a><span id="l13.45"> </span>
<a href="#l13.46"></a><span id="l13.46"> // load and update a message in the imap fake server</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineminus">-function* loadImapMessage()</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineminus">-{</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+function* loadImapMessage() {</span>
<a href="#l13.50"></a><span id="l13.50">   gMessage = new imapMessage(specForFileName(gMessageFileName),</span>
<a href="#l13.51"></a><span id="l13.51">     IMAPPump.mailbox.uidnext++, []);</span>
<a href="#l13.52"></a><span id="l13.52">   gMessage.xCustomList = [];</span>
<a href="#l13.53"></a><span id="l13.53">   IMAPPump.mailbox.addMessage(gMessage);</span>
<a href="#l13.54"></a><span id="l13.54">   IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l13.55"></a><span id="l13.55">   yield false;</span>
<a href="#l13.56"></a><span id="l13.56"> }</span>
<a href="#l13.57"></a><span id="l13.57"> </span>
<a href="#l13.58"></a><span id="l13.58" class="difflineminus">-function* testStoreCustomList()</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineminus">-{</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+function* testStoreCustomList() {</span>
<a href="#l13.61"></a><span id="l13.61">   let msgHdr = mailTestUtils.firstMsgHdr(IMAPPump.inbox);</span>
<a href="#l13.62"></a><span id="l13.62">   gExpectedLength = gCustomList.length;</span>
<a href="#l13.63"></a><span id="l13.63">   let uri = IMAPPump.inbox.issueCommandOnMsgs(&quot;STORE&quot;, msgHdr.messageKey +</span>
<a href="#l13.64"></a><span id="l13.64">     &quot; X-CUSTOM-LIST (&quot; + gCustomList.join(&quot; &quot;) + &quot;)&quot;, gMsgWindow);</span>
<a href="#l13.65"></a><span id="l13.65">   uri.QueryInterface(Ci.nsIMsgMailNewsUrl);</span>
<a href="#l13.66"></a><span id="l13.66">   uri.RegisterListener(storeCustomListSetListener);</span>
<a href="#l13.67"></a><span id="l13.67">   yield false;</span>
<a href="#l13.68"></a><span id="l13.68"> }</span>
<a href="#l13.69"></a><span id="l13.69"> </span>
<a href="#l13.70"></a><span id="l13.70"> // listens for response from customCommandResult request for X-CUSTOM-LIST</span>
<a href="#l13.71"></a><span id="l13.71"> var storeCustomListSetListener = {</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineminus">-  OnStartRunningUrl: function (aUrl) {},</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineplus">+  OnStartRunningUrl(aUrl) {},</span>
<a href="#l13.74"></a><span id="l13.74"> </span>
<a href="#l13.75"></a><span id="l13.75" class="difflineminus">-  OnStopRunningUrl: function (aUrl, aExitCode) {</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineplus">+  OnStopRunningUrl(aUrl, aExitCode) {</span>
<a href="#l13.77"></a><span id="l13.77">     aUrl.QueryInterface(Ci.nsIImapUrl);</span>
<a href="#l13.78"></a><span id="l13.78">     Assert.equal(aUrl.customCommandResult,</span>
<a href="#l13.79"></a><span id="l13.79">       &quot;(&quot; + gMessage.xCustomList.join(&quot; &quot;) + &quot;)&quot;);</span>
<a href="#l13.80"></a><span id="l13.80">     Assert.equal(gMessage.xCustomList.length, gExpectedLength);</span>
<a href="#l13.81"></a><span id="l13.81">     async_driver();</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineminus">-  }</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineplus">+  },</span>
<a href="#l13.84"></a><span id="l13.84"> };</span>
<a href="#l13.85"></a><span id="l13.85"> </span>
<a href="#l13.86"></a><span id="l13.86" class="difflineminus">-function* testStoreMinusCustomList()</span>
<a href="#l13.87"></a><span id="l13.87" class="difflineminus">-{</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineplus">+function* testStoreMinusCustomList() {</span>
<a href="#l13.89"></a><span id="l13.89">   let msgHdr = mailTestUtils.firstMsgHdr(IMAPPump.inbox);</span>
<a href="#l13.90"></a><span id="l13.90">   gExpectedLength--;</span>
<a href="#l13.91"></a><span id="l13.91">   let uri = IMAPPump.inbox.issueCommandOnMsgs(&quot;STORE&quot;, msgHdr.messageKey +</span>
<a href="#l13.92"></a><span id="l13.92">     &quot; -X-CUSTOM-LIST (&quot; + gCustomList[0] + &quot;)&quot;, gMsgWindow);</span>
<a href="#l13.93"></a><span id="l13.93">   uri.QueryInterface(Ci.nsIMsgMailNewsUrl);</span>
<a href="#l13.94"></a><span id="l13.94">   uri.RegisterListener(storeCustomListRemovedListener);</span>
<a href="#l13.95"></a><span id="l13.95">   yield false;</span>
<a href="#l13.96"></a><span id="l13.96"> }</span>
<a href="#l13.97"></a><span id="l13.97"> </span>
<a href="#l13.98"></a><span id="l13.98"> // listens for response from customCommandResult request for X-CUSTOM-LIST</span>
<a href="#l13.99"></a><span id="l13.99"> var storeCustomListRemovedListener = {</span>
<a href="#l13.100"></a><span id="l13.100" class="difflineminus">-  OnStartRunningUrl: function (aUrl) {},</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineplus">+  OnStartRunningUrl(aUrl) {},</span>
<a href="#l13.102"></a><span id="l13.102"> </span>
<a href="#l13.103"></a><span id="l13.103" class="difflineminus">-  OnStopRunningUrl: function (aUrl, aExitCode) {</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineplus">+  OnStopRunningUrl(aUrl, aExitCode) {</span>
<a href="#l13.105"></a><span id="l13.105">     aUrl.QueryInterface(Ci.nsIImapUrl);</span>
<a href="#l13.106"></a><span id="l13.106">     Assert.equal(aUrl.customCommandResult,</span>
<a href="#l13.107"></a><span id="l13.107">       &quot;(&quot; + gMessage.xCustomList.join(&quot; &quot;) + &quot;)&quot;);</span>
<a href="#l13.108"></a><span id="l13.108">     Assert.equal(gMessage.xCustomList.length, gExpectedLength);</span>
<a href="#l13.109"></a><span id="l13.109">     async_driver();</span>
<a href="#l13.110"></a><span id="l13.110" class="difflineminus">-  }</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineplus">+  },</span>
<a href="#l13.112"></a><span id="l13.112"> };</span>
<a href="#l13.113"></a><span id="l13.113"> </span>
<a href="#l13.114"></a><span id="l13.114" class="difflineminus">-function* testStorePlusCustomList()</span>
<a href="#l13.115"></a><span id="l13.115" class="difflineminus">-{</span>
<a href="#l13.116"></a><span id="l13.116" class="difflineplus">+function* testStorePlusCustomList() {</span>
<a href="#l13.117"></a><span id="l13.117">   let msgHdr = mailTestUtils.firstMsgHdr(IMAPPump.inbox);</span>
<a href="#l13.118"></a><span id="l13.118">   gExpectedLength++;</span>
<a href="#l13.119"></a><span id="l13.119">   let uri = IMAPPump.inbox.issueCommandOnMsgs(&quot;STORE&quot;, msgHdr.messageKey +</span>
<a href="#l13.120"></a><span id="l13.120">     ' +X-CUSTOM-LIST (&quot;Custom4&quot;)', gMsgWindow);</span>
<a href="#l13.121"></a><span id="l13.121">   uri.QueryInterface(Ci.nsIMsgMailNewsUrl);</span>
<a href="#l13.122"></a><span id="l13.122">   uri.RegisterListener(storeCustomListAddedListener);</span>
<a href="#l13.123"></a><span id="l13.123">   yield false;</span>
<a href="#l13.124"></a><span id="l13.124"> }</span>
<a href="#l13.125"></a><span id="l13.125"> </span>
<a href="#l13.126"></a><span id="l13.126"> // listens for response from customCommandResult request for X-CUSTOM-LIST</span>
<a href="#l13.127"></a><span id="l13.127"> var storeCustomListAddedListener = {</span>
<a href="#l13.128"></a><span id="l13.128" class="difflineminus">-  OnStartRunningUrl: function (aUrl) {},</span>
<a href="#l13.129"></a><span id="l13.129" class="difflineplus">+  OnStartRunningUrl(aUrl) {},</span>
<a href="#l13.130"></a><span id="l13.130"> </span>
<a href="#l13.131"></a><span id="l13.131" class="difflineminus">-  OnStopRunningUrl: function (aUrl, aExitCode) {</span>
<a href="#l13.132"></a><span id="l13.132" class="difflineplus">+  OnStopRunningUrl(aUrl, aExitCode) {</span>
<a href="#l13.133"></a><span id="l13.133">     aUrl.QueryInterface(Ci.nsIImapUrl);</span>
<a href="#l13.134"></a><span id="l13.134">     Assert.equal(aUrl.customCommandResult,</span>
<a href="#l13.135"></a><span id="l13.135">       &quot;(&quot; + gMessage.xCustomList.join(&quot; &quot;) + &quot;)&quot;);</span>
<a href="#l13.136"></a><span id="l13.136">     Assert.equal(gMessage.xCustomList.length, gExpectedLength);</span>
<a href="#l13.137"></a><span id="l13.137">     async_driver();</span>
<a href="#l13.138"></a><span id="l13.138" class="difflineminus">-  }</span>
<a href="#l13.139"></a><span id="l13.139" class="difflineplus">+  },</span>
<a href="#l13.140"></a><span id="l13.140"> };</span>
<a href="#l13.141"></a><span id="l13.141"> </span>
<a href="#l13.142"></a><span id="l13.142"> </span>
<a href="#l13.143"></a><span id="l13.143"> // Cleanup at end</span>
<a href="#l13.144"></a><span id="l13.144" class="difflineminus">-function endTest()</span>
<a href="#l13.145"></a><span id="l13.145" class="difflineminus">-{</span>
<a href="#l13.146"></a><span id="l13.146" class="difflineplus">+function endTest() {</span>
<a href="#l13.147"></a><span id="l13.147">   teardownIMAPPump();</span>
<a href="#l13.148"></a><span id="l13.148"> }</span>
<a href="#l13.149"></a><span id="l13.149"> </span>
<a href="#l13.150"></a><span id="l13.150" class="difflineminus">-function run_test()</span>
<a href="#l13.151"></a><span id="l13.151" class="difflineminus">-{</span>
<a href="#l13.152"></a><span id="l13.152" class="difflineplus">+function run_test() {</span>
<a href="#l13.153"></a><span id="l13.153">   Services.prefs.setBoolPref(&quot;mail.server.server1.autosync_offline_stores&quot;, false);</span>
<a href="#l13.154"></a><span id="l13.154">   async_run_tests(tests);</span>
<a href="#l13.155"></a><span id="l13.155"> }</span>
<a href="#l13.156"></a><span id="l13.156"> </span>
<a href="#l13.157"></a><span id="l13.157"> /*</span>
<a href="#l13.158"></a><span id="l13.158">  * helper functions</span>
<a href="#l13.159"></a><span id="l13.159">  */</span>
<a href="#l13.160"></a><span id="l13.160"> </span>
<a href="#l13.161"></a><span id="l13.161"> // given a test file, return the file uri spec</span>
<a href="#l13.162"></a><span id="l13.162" class="difflineminus">-function specForFileName(aFileName)</span>
<a href="#l13.163"></a><span id="l13.163" class="difflineminus">-{</span>
<a href="#l13.164"></a><span id="l13.164" class="difflineplus">+function specForFileName(aFileName) {</span>
<a href="#l13.165"></a><span id="l13.165">   let file = do_get_file(&quot;../../../data/&quot; + aFileName);</span>
<a href="#l13.166"></a><span id="l13.166">   let msgfileuri = Services.io.newFileURI(file).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l13.167"></a><span id="l13.167">   return msgfileuri.spec;</span>
<a href="#l13.168"></a><span id="l13.168"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_dod.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_dod.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -3,53 +3,54 @@</span>
<a href="#l14.4"></a><span id="l14.4">  * 'This part will be downloaded on demand' in message pane content (text) area.</span>
<a href="#l14.5"></a><span id="l14.5">  * To add messages to the test, place the 'markerRe' text used for testing in</span>
<a href="#l14.6"></a><span id="l14.6">  * the offending part that is displaying the problem message.</span>
<a href="#l14.7"></a><span id="l14.7">  * Prepend to the filename 'bodystructure' and save in the database</span>
<a href="#l14.8"></a><span id="l14.8">  * See current test files for examples.</span>
<a href="#l14.9"></a><span id="l14.9">  */</span>
<a href="#l14.10"></a><span id="l14.10"> </span>
<a href="#l14.11"></a><span id="l14.11">  // async support</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l14.14"></a><span id="l14.14"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l14.15"></a><span id="l14.15"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l14.16"></a><span id="l14.16"> </span>
<a href="#l14.17"></a><span id="l14.17"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l14.18"></a><span id="l14.18"> </span>
<a href="#l14.19"></a><span id="l14.19"> var gServer, gIMAPIncomingServer, gIMAPDaemon;</span>
<a href="#l14.20"></a><span id="l14.20"> </span>
<a href="#l14.21"></a><span id="l14.21"> var tests = [</span>
<a href="#l14.22"></a><span id="l14.22">   streamMessages,</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineminus">-  endTest</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineplus">+  endTest,</span>
<a href="#l14.25"></a><span id="l14.25"> ];</span>
<a href="#l14.26"></a><span id="l14.26"> </span>
<a href="#l14.27"></a><span id="l14.27" class="difflineminus">-function run_test()</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineminus">-{</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+function run_test() {</span>
<a href="#l14.30"></a><span id="l14.30">   gIMAPDaemon = new imapDaemon();</span>
<a href="#l14.31"></a><span id="l14.31">   // pref tuning: one connection only, turn off notifications</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">-  Services.prefs.setIntPref( &quot;mail.server.server1.max_cached_connections&quot;, 1);</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+  Services.prefs.setIntPref(&quot;mail.server.server1.max_cached_connections&quot;, 1);</span>
<a href="#l14.34"></a><span id="l14.34">   Services.prefs.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l14.35"></a><span id="l14.35">   Services.prefs.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineminus">-  Services.prefs.setBoolPref(&quot;mail.biff.show_tray_icon&quot;,    false);</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l14.38"></a><span id="l14.38">   Services.prefs.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l14.39"></a><span id="l14.39"> </span>
<a href="#l14.40"></a><span id="l14.40">   // Force bodypart fetching as best as we can.</span>
<a href="#l14.41"></a><span id="l14.41">   // It would be advisable to enable log and check to be sure body[] is not</span>
<a href="#l14.42"></a><span id="l14.42">   // being fetched in lieu of parts. There may be conditions that bypass</span>
<a href="#l14.43"></a><span id="l14.43">   // bodypart fetch.</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineminus">-  Services.prefs.setBoolPref(&quot;mail.inline_attachments&quot;,     false);</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineminus">-  Services.prefs.setIntPref (&quot;browser.cache.disk.capacity&quot;,              0);</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineminus">-  Services.prefs.setIntPref (&quot;mail.imap.mime_parts_on_demand_threshold&quot;, 1);</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineminus">-  Services.prefs.setIntPref (&quot;mailnews.display.disallow_mime_handlers&quot;,  0);</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineminus">-  Services.prefs.setBoolPref(&quot;mail.server.default.fetch_by_chunks&quot;,  false);</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.inline_attachments&quot;, false);</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+  Services.prefs.setIntPref(&quot;browser.cache.disk.capacity&quot;, 0);</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+  Services.prefs.setIntPref(&quot;mail.imap.mime_parts_on_demand_threshold&quot;, 1);</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+  Services.prefs.setIntPref(&quot;mailnews.display.disallow_mime_handlers&quot;, 0);</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.server.default.fetch_by_chunks&quot;, false);</span>
<a href="#l14.54"></a><span id="l14.54">   Services.prefs.setBoolPref(&quot;mail.server.server1.autosync_offline_stores&quot;, false);</span>
<a href="#l14.55"></a><span id="l14.55"> </span>
<a href="#l14.56"></a><span id="l14.56">   gServer = makeServer(gIMAPDaemon, &quot;&quot;);</span>
<a href="#l14.57"></a><span id="l14.57">   gIMAPIncomingServer = createLocalIMAPServer(gServer.port);</span>
<a href="#l14.58"></a><span id="l14.58"> </span>
<a href="#l14.59"></a><span id="l14.59" class="difflineminus">-  //start first test</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineplus">+  // start first test</span>
<a href="#l14.61"></a><span id="l14.61">   async_run_tests(tests);</span>
<a href="#l14.62"></a><span id="l14.62"> }</span>
<a href="#l14.63"></a><span id="l14.63"> </span>
<a href="#l14.64"></a><span id="l14.64"> function* streamMessages() {</span>
<a href="#l14.65"></a><span id="l14.65">   let inbox = gIMAPDaemon.getMailbox(&quot;INBOX&quot;);</span>
<a href="#l14.66"></a><span id="l14.66">   let imapS = Cc[&quot;@mozilla.org/messenger/messageservice;1?type=imap&quot;]</span>
<a href="#l14.67"></a><span id="l14.67">                 .getService(Ci.nsIMsgMessageService);</span>
<a href="#l14.68"></a><span id="l14.68">   let fileNames = [];</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineat">@@ -61,65 +62,64 @@ function* streamMessages() {</span>
<a href="#l14.70"></a><span id="l14.70">     if (msgfileuri.fileName.toLowerCase().startsWith(&quot;bodystructure&quot;)) {</span>
<a href="#l14.71"></a><span id="l14.71">       inbox.addMessage(new imapMessage(msgfileuri.spec, inbox.uidnext++, []));</span>
<a href="#l14.72"></a><span id="l14.72">       fileNames.push(msgfileuri.fileName);</span>
<a href="#l14.73"></a><span id="l14.73">     }</span>
<a href="#l14.74"></a><span id="l14.74">   }</span>
<a href="#l14.75"></a><span id="l14.75"> </span>
<a href="#l14.76"></a><span id="l14.76">   // loop through the files twice, once for plain and one for html check</span>
<a href="#l14.77"></a><span id="l14.77">   let isPlain = true;</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineminus">-  for (let cnt = 2 ; cnt &gt; 0 ; cnt--, isPlain = false) {</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineplus">+  for (let cnt = 2; cnt &gt; 0; cnt--, isPlain = false) {</span>
<a href="#l14.80"></a><span id="l14.80">     // adjust these for 'view body as' setting</span>
<a href="#l14.81"></a><span id="l14.81">     // 0 orig html 3 sanitized 1 plain text</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineminus">-    Services.prefs.setIntPref (&quot;mailnews.display.html_as&quot;, isPlain ? 1 : 0);</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineplus">+    Services.prefs.setIntPref(&quot;mailnews.display.html_as&quot;, isPlain ? 1 : 0);</span>
<a href="#l14.84"></a><span id="l14.84">     Services.prefs.setBoolPref(&quot;mailnews.display.prefer_plaintext&quot;, isPlain);</span>
<a href="#l14.85"></a><span id="l14.85">     let marker;</span>
<a href="#l14.86"></a><span id="l14.86">     if (isPlain)</span>
<a href="#l14.87"></a><span id="l14.87">       marker = &quot;thisplaintextneedstodisplaytopasstest&quot;;</span>
<a href="#l14.88"></a><span id="l14.88">     else</span>
<a href="#l14.89"></a><span id="l14.89">       marker = &quot;thishtmltextneedstodisplaytopasstest&quot;;</span>
<a href="#l14.90"></a><span id="l14.90"> </span>
<a href="#l14.91"></a><span id="l14.91" class="difflineminus">-    for (let i = 1; i &lt; inbox.uidnext ; i++) {</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineplus">+    for (let i = 1; i &lt; inbox.uidnext; i++) {</span>
<a href="#l14.93"></a><span id="l14.93">       let uri = {};</span>
<a href="#l14.94"></a><span id="l14.94">       imapS.GetUrlForUri(&quot;imap-message://user@localhost/INBOX#&quot; + i, uri, null);</span>
<a href="#l14.95"></a><span id="l14.95">       let channel = Services.io.newChannelFromURI(uri.value,</span>
<a href="#l14.96"></a><span id="l14.96">                                                   null,</span>
<a href="#l14.97"></a><span id="l14.97">                                                   Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l14.98"></a><span id="l14.98">                                                   null,</span>
<a href="#l14.99"></a><span id="l14.99">                                                   Ci.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l14.100"></a><span id="l14.100">                                                   Ci.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l14.101"></a><span id="l14.101">       channel.asyncOpen(gStreamListener, null);</span>
<a href="#l14.102"></a><span id="l14.102">       yield false;</span>
<a href="#l14.103"></a><span id="l14.103">       let buf = gStreamListener._data;</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineminus">-      dump(&quot;##########\nTesting---&gt;&quot; + fileNames[i-1] +</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineplus">+      dump(&quot;##########\nTesting---&gt;&quot; + fileNames[i - 1] +</span>
<a href="#l14.106"></a><span id="l14.106">            &quot;; 'prefer plain text': &quot; + isPlain + &quot;\n&quot; +</span>
<a href="#l14.107"></a><span id="l14.107">            buf + &quot;\n&quot; +</span>
<a href="#l14.108"></a><span id="l14.108" class="difflineminus">-           &quot;##########\nTesting---&gt;&quot; + fileNames[i-1] +</span>
<a href="#l14.109"></a><span id="l14.109" class="difflineplus">+           &quot;##########\nTesting---&gt;&quot; + fileNames[i - 1] +</span>
<a href="#l14.110"></a><span id="l14.110">            &quot;; 'prefer plain text': &quot; + isPlain + &quot;\n&quot;);</span>
<a href="#l14.111"></a><span id="l14.111">       try {</span>
<a href="#l14.112"></a><span id="l14.112">         Assert.ok(buf.includes(marker));</span>
<a href="#l14.113"></a><span id="l14.113" class="difflineminus">-      }</span>
<a href="#l14.114"></a><span id="l14.114" class="difflineminus">-      catch(e){}</span>
<a href="#l14.115"></a><span id="l14.115" class="difflineplus">+      } catch (e) {}</span>
<a href="#l14.116"></a><span id="l14.116">     }</span>
<a href="#l14.117"></a><span id="l14.117">   }</span>
<a href="#l14.118"></a><span id="l14.118">   yield true;</span>
<a href="#l14.119"></a><span id="l14.119"> }</span>
<a href="#l14.120"></a><span id="l14.120"> </span>
<a href="#l14.121"></a><span id="l14.121"> var gStreamListener = {</span>
<a href="#l14.122"></a><span id="l14.122" class="difflineminus">-  QueryInterface : ChromeUtils.generateQI([Ci.nsIStreamListener]),</span>
<a href="#l14.123"></a><span id="l14.123" class="difflineminus">-  _stream : null,</span>
<a href="#l14.124"></a><span id="l14.124" class="difflineminus">-  _data : null,</span>
<a href="#l14.125"></a><span id="l14.125" class="difflineminus">-  onStartRequest : function (aRequest) {</span>
<a href="#l14.126"></a><span id="l14.126" class="difflineplus">+  QueryInterface: ChromeUtils.generateQI([Ci.nsIStreamListener]),</span>
<a href="#l14.127"></a><span id="l14.127" class="difflineplus">+  _stream: null,</span>
<a href="#l14.128"></a><span id="l14.128" class="difflineplus">+  _data: null,</span>
<a href="#l14.129"></a><span id="l14.129" class="difflineplus">+  onStartRequest(aRequest) {</span>
<a href="#l14.130"></a><span id="l14.130">     this._data = &quot;&quot;;</span>
<a href="#l14.131"></a><span id="l14.131">     this._stream = null;</span>
<a href="#l14.132"></a><span id="l14.132">   },</span>
<a href="#l14.133"></a><span id="l14.133" class="difflineminus">-  onStopRequest : function (aRequest, aStatusCode) {</span>
<a href="#l14.134"></a><span id="l14.134" class="difflineplus">+  onStopRequest(aRequest, aStatusCode) {</span>
<a href="#l14.135"></a><span id="l14.135">     async_driver();</span>
<a href="#l14.136"></a><span id="l14.136">   },</span>
<a href="#l14.137"></a><span id="l14.137" class="difflineminus">-  onDataAvailable : function (aRequest, aInputStream, aOff, aCount) {</span>
<a href="#l14.138"></a><span id="l14.138" class="difflineplus">+  onDataAvailable(aRequest, aInputStream, aOff, aCount) {</span>
<a href="#l14.139"></a><span id="l14.139">     if (this._stream == null) {</span>
<a href="#l14.140"></a><span id="l14.140">       this._stream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;].createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l14.141"></a><span id="l14.141">       this._stream.init(aInputStream);</span>
<a href="#l14.142"></a><span id="l14.142">     }</span>
<a href="#l14.143"></a><span id="l14.143">     this._data += this._stream.read(aCount);</span>
<a href="#l14.144"></a><span id="l14.144">   },</span>
<a href="#l14.145"></a><span id="l14.145"> };</span>
<a href="#l14.146"></a><span id="l14.146"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_dontStatNoSelect.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_dontStatNoSelect.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -1,35 +1,38 @@</span>
<a href="#l15.4"></a><span id="l15.4"> // This file tests that checking folders for new mail with STATUS</span>
<a href="#l15.5"></a><span id="l15.5"> // doesn't try to STAT noselect folders.</span>
<a href="#l15.6"></a><span id="l15.6"> </span>
<a href="#l15.7"></a><span id="l15.7"> var gServer, gImapServer;</span>
<a href="#l15.8"></a><span id="l15.8" class="difflineminus">-var gIMAPInbox, gIMAPFolder1, gIMAPFolder2;</span>
<a href="#l15.9"></a><span id="l15.9" class="difflineplus">+var gIMAPInbox;</span>
<a href="#l15.10"></a><span id="l15.10"> var gFolder2Mailbox;</span>
<a href="#l15.11"></a><span id="l15.11"> var gFolder1, gFolder2;</span>
<a href="#l15.12"></a><span id="l15.12"> </span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l15.14"></a><span id="l15.14"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l15.15"></a><span id="l15.15"> // async support</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l15.18"></a><span id="l15.18"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l15.19"></a><span id="l15.19"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l15.20"></a><span id="l15.20"> </span>
<a href="#l15.21"></a><span id="l15.21"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l15.22"></a><span id="l15.22"> </span>
<a href="#l15.23"></a><span id="l15.23"> var tests = [</span>
<a href="#l15.24"></a><span id="l15.24">   checkStatSelect,</span>
<a href="#l15.25"></a><span id="l15.25">   checkStatNoSelect,</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineminus">-  endTest</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineplus">+  endTest,</span>
<a href="#l15.28"></a><span id="l15.28"> ];</span>
<a href="#l15.29"></a><span id="l15.29"> </span>
<a href="#l15.30"></a><span id="l15.30"> function run_test() {</span>
<a href="#l15.31"></a><span id="l15.31">   var daemon = new imapDaemon();</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineminus">-  daemon.createMailbox(&quot;folder 1&quot;, {subscribed : true});</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+  daemon.createMailbox(&quot;folder 1&quot;, {subscribed: true});</span>
<a href="#l15.34"></a><span id="l15.34">   let folder1Mailbox = daemon.getMailbox(&quot;folder 1&quot;);</span>
<a href="#l15.35"></a><span id="l15.35">   folder1Mailbox.flags.push(&quot;\\Noselect&quot;);</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineminus">-  daemon.createMailbox(&quot;folder 2&quot;, {subscribed : true});</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+  daemon.createMailbox(&quot;folder 2&quot;, {subscribed: true});</span>
<a href="#l15.38"></a><span id="l15.38">   gFolder2Mailbox = daemon.getMailbox(&quot;folder 2&quot;);</span>
<a href="#l15.39"></a><span id="l15.39">   addMessageToFolder(gFolder2Mailbox);</span>
<a href="#l15.40"></a><span id="l15.40">   gServer = makeServer(daemon, &quot;&quot;);</span>
<a href="#l15.41"></a><span id="l15.41"> </span>
<a href="#l15.42"></a><span id="l15.42">   gImapServer = createLocalIMAPServer(gServer.port);</span>
<a href="#l15.43"></a><span id="l15.43"> </span>
<a href="#l15.44"></a><span id="l15.44">   // Bug 1050840: check a newly created server has the default number of connections</span>
<a href="#l15.45"></a><span id="l15.45">   Assert.equal(gImapServer.maximumConnectionsNumber, 5);</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineat">@@ -62,17 +65,17 @@ function run_test() {</span>
<a href="#l15.47"></a><span id="l15.47">   Services.prefs.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l15.48"></a><span id="l15.48"> </span>
<a href="#l15.49"></a><span id="l15.49">   let rootFolder = gImapServer.rootFolder;</span>
<a href="#l15.50"></a><span id="l15.50">   gIMAPInbox = rootFolder.getFolderWithFlags(Ci.nsMsgFolderFlags.Inbox);</span>
<a href="#l15.51"></a><span id="l15.51">   gFolder1 = rootFolder.getChildNamed(&quot;folder 1&quot;);</span>
<a href="#l15.52"></a><span id="l15.52">   gFolder2 = rootFolder.getChildNamed(&quot;folder 2&quot;);</span>
<a href="#l15.53"></a><span id="l15.53">   gFolder1.setFlag(Ci.nsMsgFolderFlags.CheckNew);</span>
<a href="#l15.54"></a><span id="l15.54">   gFolder2.setFlag(Ci.nsMsgFolderFlags.CheckNew);</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineminus">-  //start first test</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineplus">+  // start first test</span>
<a href="#l15.57"></a><span id="l15.57">   async_run_tests(tests);</span>
<a href="#l15.58"></a><span id="l15.58"> }</span>
<a href="#l15.59"></a><span id="l15.59"> </span>
<a href="#l15.60"></a><span id="l15.60"> function* checkStatSelect() {</span>
<a href="#l15.61"></a><span id="l15.61">   // imap fake server's resetTest resets the authentication state - charming.</span>
<a href="#l15.62"></a><span id="l15.62">   // So poke the _test member directly.</span>
<a href="#l15.63"></a><span id="l15.63">   gServer._test = true;</span>
<a href="#l15.64"></a><span id="l15.64">   gIMAPInbox.getNewMessages(null, null);</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineat">@@ -112,26 +115,25 @@ function addMessageToFolder(mbox) {</span>
<a href="#l15.66"></a><span id="l15.66"> </span>
<a href="#l15.67"></a><span id="l15.67">   let msgURI =</span>
<a href="#l15.68"></a><span id="l15.68">     Services.io.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l15.69"></a><span id="l15.69">                        btoa(messages[0].toMessageString()));</span>
<a href="#l15.70"></a><span id="l15.70">   let message = new imapMessage(msgURI.spec, mbox.uidnext++);</span>
<a href="#l15.71"></a><span id="l15.71">   mbox.addMessage(message);</span>
<a href="#l15.72"></a><span id="l15.72"> }</span>
<a href="#l15.73"></a><span id="l15.73"> </span>
<a href="#l15.74"></a><span id="l15.74" class="difflineminus">-function* endTest()</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineminus">-{</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineplus">+function* endTest() {</span>
<a href="#l15.77"></a><span id="l15.77">   Assert.equal(gFolder2.getNumUnread(false), 2);</span>
<a href="#l15.78"></a><span id="l15.78">   // Clean up the server in preparation</span>
<a href="#l15.79"></a><span id="l15.79">   gServer.resetTest();</span>
<a href="#l15.80"></a><span id="l15.80">   gImapServer.closeCachedConnections();</span>
<a href="#l15.81"></a><span id="l15.81">   gServer.performTest();</span>
<a href="#l15.82"></a><span id="l15.82">   gServer.stop();</span>
<a href="#l15.83"></a><span id="l15.83">   yield true;</span>
<a href="#l15.84"></a><span id="l15.84"> }</span>
<a href="#l15.85"></a><span id="l15.85"> </span>
<a href="#l15.86"></a><span id="l15.86"> var gFolderListener = {</span>
<a href="#l15.87"></a><span id="l15.87" class="difflineminus">-  OnItemBoolPropertyChanged : function(aItem, aProperty, aOldValue, aNewValue) {</span>
<a href="#l15.88"></a><span id="l15.88" class="difflineplus">+  OnItemBoolPropertyChanged(aItem, aProperty, aOldValue, aNewValue) {</span>
<a href="#l15.89"></a><span id="l15.89">     // This means that the STAT on &quot;folder 2&quot; has finished.</span>
<a href="#l15.90"></a><span id="l15.90" class="difflineminus">-    if (aProperty == &quot;NewMessages&quot; &amp;&amp; aNewValue == true)</span>
<a href="#l15.91"></a><span id="l15.91" class="difflineplus">+    if (aProperty == &quot;NewMessages&quot; &amp;&amp; aNewValue)</span>
<a href="#l15.92"></a><span id="l15.92">       async_driver();</span>
<a href="#l15.93"></a><span id="l15.93" class="difflineminus">-  }</span>
<a href="#l15.94"></a><span id="l15.94" class="difflineplus">+  },</span>
<a href="#l15.95"></a><span id="l15.95"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_downloadOffline.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_downloadOffline.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -1,25 +1,27 @@</span>
<a href="#l16.4"></a><span id="l16.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l16.5"></a><span id="l16.5"> /*</span>
<a href="#l16.6"></a><span id="l16.6">  * Test to ensure that downloadAllForOffline works correctly with imap folders</span>
<a href="#l16.7"></a><span id="l16.7">  * and returns success.</span>
<a href="#l16.8"></a><span id="l16.8">  */</span>
<a href="#l16.9"></a><span id="l16.9"> </span>
<a href="#l16.10"></a><span id="l16.10" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l16.11"></a><span id="l16.11" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l16.12"></a><span id="l16.12"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l16.13"></a><span id="l16.13"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l16.14"></a><span id="l16.14"> </span>
<a href="#l16.15"></a><span id="l16.15"> var gFileName = &quot;bug460636&quot;;</span>
<a href="#l16.16"></a><span id="l16.16"> var gMsgFile = do_get_file(&quot;../../../data/&quot; + gFileName);</span>
<a href="#l16.17"></a><span id="l16.17"> </span>
<a href="#l16.18"></a><span id="l16.18"> var tests = [</span>
<a href="#l16.19"></a><span id="l16.19">   setup,</span>
<a href="#l16.20"></a><span id="l16.20">   downloadAllForOffline,</span>
<a href="#l16.21"></a><span id="l16.21">   verifyDownloaded,</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineminus">-  teardownIMAPPump</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineplus">+  teardownIMAPPump,</span>
<a href="#l16.24"></a><span id="l16.24"> ];</span>
<a href="#l16.25"></a><span id="l16.25"> </span>
<a href="#l16.26"></a><span id="l16.26"> async function setup() {</span>
<a href="#l16.27"></a><span id="l16.27">   setupIMAPPump();</span>
<a href="#l16.28"></a><span id="l16.28"> </span>
<a href="#l16.29"></a><span id="l16.29">  /*</span>
<a href="#l16.30"></a><span id="l16.30">    * Ok, prelude done. Read the original message from disk</span>
<a href="#l16.31"></a><span id="l16.31">    * (through a file URI), and add it to the Inbox.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_fetchCustomAttribute.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_fetchCustomAttribute.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -2,16 +2,18 @@</span>
<a href="#l17.4"></a><span id="l17.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l17.5"></a><span id="l17.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l17.6"></a><span id="l17.6"> </span>
<a href="#l17.7"></a><span id="l17.7"> /*</span>
<a href="#l17.8"></a><span id="l17.8">  * Test to ensure that imap fetchCustomMsgAttribute function works properly</span>
<a href="#l17.9"></a><span id="l17.9">  */</span>
<a href="#l17.10"></a><span id="l17.10"> </span>
<a href="#l17.11"></a><span id="l17.11"> // async support</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l17.14"></a><span id="l17.14"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l17.15"></a><span id="l17.15"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l17.16"></a><span id="l17.16"> </span>
<a href="#l17.17"></a><span id="l17.17"> // IMAP pump</span>
<a href="#l17.18"></a><span id="l17.18"> </span>
<a href="#l17.19"></a><span id="l17.19"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l17.20"></a><span id="l17.20"> </span>
<a href="#l17.21"></a><span id="l17.21"> // Globals</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineat">@@ -27,89 +29,83 @@ var gMsgWindow = Cc[&quot;@mozilla.org/messen</span>
<a href="#l17.23"></a><span id="l17.23"> </span>
<a href="#l17.24"></a><span id="l17.24"> setupIMAPPump(&quot;CUSTOM1&quot;);</span>
<a href="#l17.25"></a><span id="l17.25"> </span>
<a href="#l17.26"></a><span id="l17.26"> // Definition of tests</span>
<a href="#l17.27"></a><span id="l17.27"> var tests = [</span>
<a href="#l17.28"></a><span id="l17.28">   loadImapMessage,</span>
<a href="#l17.29"></a><span id="l17.29">   testFetchCustomValue,</span>
<a href="#l17.30"></a><span id="l17.30">   testFetchCustomList,</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineminus">-  endTest</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineminus">-]</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineplus">+  endTest,</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineplus">+];</span>
<a href="#l17.35"></a><span id="l17.35"> </span>
<a href="#l17.36"></a><span id="l17.36"> // load and update a message in the imap fake server</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineminus">-function* loadImapMessage()</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineminus">-{</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineplus">+function* loadImapMessage() {</span>
<a href="#l17.40"></a><span id="l17.40">   let message = new imapMessage(specForFileName(gMessage),</span>
<a href="#l17.41"></a><span id="l17.41">                           IMAPPump.mailbox.uidnext++, []);</span>
<a href="#l17.42"></a><span id="l17.42">   message.xCustomValue = gCustomValue;</span>
<a href="#l17.43"></a><span id="l17.43">   message.xCustomList = gCustomList;</span>
<a href="#l17.44"></a><span id="l17.44">   IMAPPump.mailbox.addMessage(message);</span>
<a href="#l17.45"></a><span id="l17.45">   IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l17.46"></a><span id="l17.46">   yield false;</span>
<a href="#l17.47"></a><span id="l17.47"> }</span>
<a href="#l17.48"></a><span id="l17.48"> </span>
<a href="#l17.49"></a><span id="l17.49"> // Used to verify that nsIServerResponseParser.msg_fetch() can handle</span>
<a href="#l17.50"></a><span id="l17.50"> // not in a parenthesis group - Bug 750012</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineminus">-function* testFetchCustomValue()</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineminus">-{</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineplus">+function* testFetchCustomValue() {</span>
<a href="#l17.54"></a><span id="l17.54">   let msgHdr = mailTestUtils.firstMsgHdr(IMAPPump.inbox);</span>
<a href="#l17.55"></a><span id="l17.55">   let uri = IMAPPump.inbox.fetchCustomMsgAttribute(&quot;X-CUSTOM-VALUE&quot;, msgHdr.messageKey, gMsgWindow);</span>
<a href="#l17.56"></a><span id="l17.56">   uri.QueryInterface(Ci.nsIMsgMailNewsUrl);</span>
<a href="#l17.57"></a><span id="l17.57">   uri.RegisterListener(fetchCustomValueListener);</span>
<a href="#l17.58"></a><span id="l17.58">   yield false;</span>
<a href="#l17.59"></a><span id="l17.59"> }</span>
<a href="#l17.60"></a><span id="l17.60"> </span>
<a href="#l17.61"></a><span id="l17.61"> // listens for resposne from fetchCustomMsgAttribute request for X-CUSTOM-VALUE</span>
<a href="#l17.62"></a><span id="l17.62"> var fetchCustomValueListener = {</span>
<a href="#l17.63"></a><span id="l17.63" class="difflineminus">-  OnStartRunningUrl: function (aUrl) {},</span>
<a href="#l17.64"></a><span id="l17.64" class="difflineplus">+  OnStartRunningUrl(aUrl) {},</span>
<a href="#l17.65"></a><span id="l17.65"> </span>
<a href="#l17.66"></a><span id="l17.66" class="difflineminus">-  OnStopRunningUrl: function (aUrl, aExitCode) {</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineplus">+  OnStopRunningUrl(aUrl, aExitCode) {</span>
<a href="#l17.68"></a><span id="l17.68">     aUrl.QueryInterface(Ci.nsIImapUrl);</span>
<a href="#l17.69"></a><span id="l17.69">     Assert.equal(aUrl.customAttributeResult, gCustomValue);</span>
<a href="#l17.70"></a><span id="l17.70">     async_driver();</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineminus">-  }</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineplus">+  },</span>
<a href="#l17.73"></a><span id="l17.73"> };</span>
<a href="#l17.74"></a><span id="l17.74"> </span>
<a href="#l17.75"></a><span id="l17.75"> // Used to verify that nsIServerResponseParser.msg_fetch() can handle a parenthesis group - Bug 735542</span>
<a href="#l17.76"></a><span id="l17.76" class="difflineminus">-function* testFetchCustomList()</span>
<a href="#l17.77"></a><span id="l17.77" class="difflineminus">-{</span>
<a href="#l17.78"></a><span id="l17.78" class="difflineplus">+function* testFetchCustomList() {</span>
<a href="#l17.79"></a><span id="l17.79">   let msgHdr = mailTestUtils.firstMsgHdr(IMAPPump.inbox);</span>
<a href="#l17.80"></a><span id="l17.80">   let uri = IMAPPump.inbox.fetchCustomMsgAttribute(&quot;X-CUSTOM-LIST&quot;, msgHdr.messageKey, gMsgWindow);</span>
<a href="#l17.81"></a><span id="l17.81">   uri.QueryInterface(Ci.nsIMsgMailNewsUrl);</span>
<a href="#l17.82"></a><span id="l17.82">   uri.RegisterListener(fetchCustomListListener);</span>
<a href="#l17.83"></a><span id="l17.83">   yield false;</span>
<a href="#l17.84"></a><span id="l17.84"> }</span>
<a href="#l17.85"></a><span id="l17.85"> </span>
<a href="#l17.86"></a><span id="l17.86"> // listens for response from fetchCustomMsgAttribute request for X-CUSTOM-LIST</span>
<a href="#l17.87"></a><span id="l17.87"> var fetchCustomListListener = {</span>
<a href="#l17.88"></a><span id="l17.88" class="difflineminus">-  OnStartRunningUrl: function (aUrl) {},</span>
<a href="#l17.89"></a><span id="l17.89" class="difflineplus">+  OnStartRunningUrl(aUrl) {},</span>
<a href="#l17.90"></a><span id="l17.90"> </span>
<a href="#l17.91"></a><span id="l17.91" class="difflineminus">-  OnStopRunningUrl: function (aUrl, aExitCode) {</span>
<a href="#l17.92"></a><span id="l17.92" class="difflineplus">+  OnStopRunningUrl(aUrl, aExitCode) {</span>
<a href="#l17.93"></a><span id="l17.93">     aUrl.QueryInterface(Ci.nsIImapUrl);</span>
<a href="#l17.94"></a><span id="l17.94">     Assert.equal(aUrl.customAttributeResult, &quot;(&quot; + gCustomList.join(&quot; &quot;) + &quot;)&quot;);</span>
<a href="#l17.95"></a><span id="l17.95">     async_driver();</span>
<a href="#l17.96"></a><span id="l17.96" class="difflineminus">-  }</span>
<a href="#l17.97"></a><span id="l17.97" class="difflineplus">+  },</span>
<a href="#l17.98"></a><span id="l17.98"> };</span>
<a href="#l17.99"></a><span id="l17.99"> </span>
<a href="#l17.100"></a><span id="l17.100"> // Cleanup at end</span>
<a href="#l17.101"></a><span id="l17.101" class="difflineminus">-function endTest()</span>
<a href="#l17.102"></a><span id="l17.102" class="difflineminus">-{</span>
<a href="#l17.103"></a><span id="l17.103" class="difflineplus">+function endTest() {</span>
<a href="#l17.104"></a><span id="l17.104">   teardownIMAPPump();</span>
<a href="#l17.105"></a><span id="l17.105"> }</span>
<a href="#l17.106"></a><span id="l17.106"> </span>
<a href="#l17.107"></a><span id="l17.107" class="difflineminus">-function run_test()</span>
<a href="#l17.108"></a><span id="l17.108" class="difflineminus">-{</span>
<a href="#l17.109"></a><span id="l17.109" class="difflineplus">+function run_test() {</span>
<a href="#l17.110"></a><span id="l17.110">   Services.prefs.setBoolPref(&quot;mail.server.server1.autosync_offline_stores&quot;, false);</span>
<a href="#l17.111"></a><span id="l17.111">   async_run_tests(tests);</span>
<a href="#l17.112"></a><span id="l17.112"> }</span>
<a href="#l17.113"></a><span id="l17.113"> </span>
<a href="#l17.114"></a><span id="l17.114"> /*</span>
<a href="#l17.115"></a><span id="l17.115">  * helper functions</span>
<a href="#l17.116"></a><span id="l17.116">  */</span>
<a href="#l17.117"></a><span id="l17.117"> </span>
<a href="#l17.118"></a><span id="l17.118"> // given a test file, return the file uri spec</span>
<a href="#l17.119"></a><span id="l17.119" class="difflineminus">-function specForFileName(aFileName)</span>
<a href="#l17.120"></a><span id="l17.120" class="difflineminus">-{</span>
<a href="#l17.121"></a><span id="l17.121" class="difflineplus">+function specForFileName(aFileName) {</span>
<a href="#l17.122"></a><span id="l17.122">   let file = do_get_file(&quot;../../../data/&quot; + aFileName);</span>
<a href="#l17.123"></a><span id="l17.123">   let msgfileuri = Services.io.newFileURI(file).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l17.124"></a><span id="l17.124">   return msgfileuri.spec;</span>
<a href="#l17.125"></a><span id="l17.125"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_filterCustomHeaders.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_filterCustomHeaders.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -3,34 +3,34 @@</span>
<a href="#l18.4"></a><span id="l18.4">  * filters on custom headers.</span>
<a href="#l18.5"></a><span id="l18.5">  * See https://bugzilla.mozilla.org/show_bug.cgi?id=655578</span>
<a href="#l18.6"></a><span id="l18.6">  * for more info.</span>
<a href="#l18.7"></a><span id="l18.7">  *</span>
<a href="#l18.8"></a><span id="l18.8">  * Original author: David Bienvenu &lt;bienvenu@mozilla.com&gt;</span>
<a href="#l18.9"></a><span id="l18.9">  */</span>
<a href="#l18.10"></a><span id="l18.10"> </span>
<a href="#l18.11"></a><span id="l18.11"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l18.14"></a><span id="l18.14"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l18.15"></a><span id="l18.15"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l18.16"></a><span id="l18.16"> </span>
<a href="#l18.17"></a><span id="l18.17"> // IMAP pump</span>
<a href="#l18.18"></a><span id="l18.18"> </span>
<a href="#l18.19"></a><span id="l18.19"> setupIMAPPump();</span>
<a href="#l18.20"></a><span id="l18.20"> </span>
<a href="#l18.21"></a><span id="l18.21"> // Definition of tests</span>
<a href="#l18.22"></a><span id="l18.22"> </span>
<a href="#l18.23"></a><span id="l18.23"> var tests = [</span>
<a href="#l18.24"></a><span id="l18.24">   setupTest,</span>
<a href="#l18.25"></a><span id="l18.25">   checkFilterResults,</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineminus">-  endTest</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineminus">-]</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineplus">+  endTest,</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineplus">+];</span>
<a href="#l18.30"></a><span id="l18.30"> </span>
<a href="#l18.31"></a><span id="l18.31" class="difflineminus">-function run_test()</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineminus">-{</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineminus">-</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineplus">+function run_test() {</span>
<a href="#l18.35"></a><span id="l18.35">   // Create a test filter.</span>
<a href="#l18.36"></a><span id="l18.36">   let filterList = IMAPPump.incomingServer.getFilterList(null);</span>
<a href="#l18.37"></a><span id="l18.37">   let filter = filterList.createFilter(&quot;test list-id&quot;);</span>
<a href="#l18.38"></a><span id="l18.38">   let searchTerm = filter.createTerm();</span>
<a href="#l18.39"></a><span id="l18.39">   searchTerm.attrib = Ci.nsMsgSearchAttrib.OtherHeader + 1;</span>
<a href="#l18.40"></a><span id="l18.40">   searchTerm.op = Ci.nsMsgSearchOp.Contains;</span>
<a href="#l18.41"></a><span id="l18.41">   let value = searchTerm.value;</span>
<a href="#l18.42"></a><span id="l18.42">   value.attrib = Ci.nsMsgSearchAttrib.OtherHeader;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_filterNeedsBody.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_filterNeedsBody.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -1,46 +1,46 @@</span>
<a href="#l19.4"></a><span id="l19.4"> /*</span>
<a href="#l19.5"></a><span id="l19.5">  * This file tests the needsBody attribute added to a</span>
<a href="#l19.6"></a><span id="l19.6">  *  custom filter action in bug 555051.</span>
<a href="#l19.7"></a><span id="l19.7">  *</span>
<a href="#l19.8"></a><span id="l19.8">  * Original author: Kent James &lt;kent@caspia.com&gt;</span>
<a href="#l19.9"></a><span id="l19.9">  * adapted from test_imapFilterActions.js</span>
<a href="#l19.10"></a><span id="l19.10">  */</span>
<a href="#l19.11"></a><span id="l19.11"> </span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l19.13"></a><span id="l19.13"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l19.14"></a><span id="l19.14"> </span>
<a href="#l19.15"></a><span id="l19.15"> // Globals</span>
<a href="#l19.16"></a><span id="l19.16"> var gFilter; // a message filter with a subject search</span>
<a href="#l19.17"></a><span id="l19.17"> var gAction; // current message action (reused)</span>
<a href="#l19.18"></a><span id="l19.18"> var gMessage = &quot;draft1&quot;; // message file used as the test message</span>
<a href="#l19.19"></a><span id="l19.19"> </span>
<a href="#l19.20"></a><span id="l19.20"> // Definition of tests</span>
<a href="#l19.21"></a><span id="l19.21"> var tests = [</span>
<a href="#l19.22"></a><span id="l19.22">   setupIMAPPump,</span>
<a href="#l19.23"></a><span id="l19.23">   setup,</span>
<a href="#l19.24"></a><span id="l19.24">   function NeedsBodyTrue() {</span>
<a href="#l19.25"></a><span id="l19.25">     gAction.type = Ci.nsMsgFilterAction.Custom;</span>
<a href="#l19.26"></a><span id="l19.26" class="difflineminus">-    gAction.customId = 'mailnews@mozilla.org#testOffline';</span>
<a href="#l19.27"></a><span id="l19.27" class="difflineplus">+    gAction.customId = &quot;mailnews@mozilla.org#testOffline&quot;;</span>
<a href="#l19.28"></a><span id="l19.28">     actionTestOffline.needsBody = true;</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineminus">-    gAction.strValue = 'true';</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineplus">+    gAction.strValue = &quot;true&quot;;</span>
<a href="#l19.31"></a><span id="l19.31">   },</span>
<a href="#l19.32"></a><span id="l19.32">   runFilterAction,</span>
<a href="#l19.33"></a><span id="l19.33">   function NeedsBodyFalse() {</span>
<a href="#l19.34"></a><span id="l19.34">     gAction.type = Ci.nsMsgFilterAction.Custom;</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineminus">-    gAction.customId = 'mailnews@mozilla.org#testOffline';</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineplus">+    gAction.customId = &quot;mailnews@mozilla.org#testOffline&quot;;</span>
<a href="#l19.37"></a><span id="l19.37">     actionTestOffline.needsBody = false;</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineminus">-    gAction.strValue = 'false';</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineplus">+    gAction.strValue = &quot;false&quot;;</span>
<a href="#l19.40"></a><span id="l19.40">   },</span>
<a href="#l19.41"></a><span id="l19.41">   runFilterAction,</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineminus">-  teardownIMAPPump</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineplus">+  teardownIMAPPump,</span>
<a href="#l19.44"></a><span id="l19.44"> ];</span>
<a href="#l19.45"></a><span id="l19.45"> </span>
<a href="#l19.46"></a><span id="l19.46"> function setup() {</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineminus">-</span>
<a href="#l19.48"></a><span id="l19.48">   // Create a test filter.</span>
<a href="#l19.49"></a><span id="l19.49">   let filterList = IMAPPump.incomingServer.getFilterList(null);</span>
<a href="#l19.50"></a><span id="l19.50">   gFilter = filterList.createFilter(&quot;test offline&quot;);</span>
<a href="#l19.51"></a><span id="l19.51">   let searchTerm = gFilter.createTerm();</span>
<a href="#l19.52"></a><span id="l19.52">   searchTerm.matchAll = true;</span>
<a href="#l19.53"></a><span id="l19.53"> </span>
<a href="#l19.54"></a><span id="l19.54">   gFilter.appendTerm(searchTerm);</span>
<a href="#l19.55"></a><span id="l19.55">   gFilter.enabled = true;</span>
<a href="#l19.56"></a><span id="l19.56" class="difflineat">@@ -72,36 +72,33 @@ async function runFilterAction() {</span>
<a href="#l19.57"></a><span id="l19.57"> }</span>
<a href="#l19.58"></a><span id="l19.58"> </span>
<a href="#l19.59"></a><span id="l19.59"> function run_test() {</span>
<a href="#l19.60"></a><span id="l19.60">   tests.forEach(x =&gt; add_task(x));</span>
<a href="#l19.61"></a><span id="l19.61">   run_next_test();</span>
<a href="#l19.62"></a><span id="l19.62"> }</span>
<a href="#l19.63"></a><span id="l19.63"> </span>
<a href="#l19.64"></a><span id="l19.64"> // custom action to test offline status</span>
<a href="#l19.65"></a><span id="l19.65" class="difflineminus">-var actionTestOffline =</span>
<a href="#l19.66"></a><span id="l19.66" class="difflineminus">-{</span>
<a href="#l19.67"></a><span id="l19.67" class="difflineplus">+var actionTestOffline = {</span>
<a href="#l19.68"></a><span id="l19.68">   id: &quot;mailnews@mozilla.org#testOffline&quot;,</span>
<a href="#l19.69"></a><span id="l19.69">   name: &quot;test if offline&quot;,</span>
<a href="#l19.70"></a><span id="l19.70" class="difflineminus">-  apply: function(aMsgHdrs, aActionValue, aListener, aType, aMsgWindow)</span>
<a href="#l19.71"></a><span id="l19.71" class="difflineminus">-  {</span>
<a href="#l19.72"></a><span id="l19.72" class="difflineminus">-    for (var i = 0; i &lt; aMsgHdrs.length; i++)</span>
<a href="#l19.73"></a><span id="l19.73" class="difflineminus">-    {</span>
<a href="#l19.74"></a><span id="l19.74" class="difflineplus">+  apply(aMsgHdrs, aActionValue, aListener, aType, aMsgWindow) {</span>
<a href="#l19.75"></a><span id="l19.75" class="difflineplus">+    for (let i = 0; i &lt; aMsgHdrs.length; i++) {</span>
<a href="#l19.76"></a><span id="l19.76">       var msgHdr = aMsgHdrs.queryElementAt(i, Ci.nsIMsgDBHdr);</span>
<a href="#l19.77"></a><span id="l19.77">       let isOffline = msgHdr.flags &amp; Ci.nsMsgMessageFlags.Offline;</span>
<a href="#l19.78"></a><span id="l19.78" class="difflineminus">-      Assert.equal(!!isOffline, aActionValue == 'true');</span>
<a href="#l19.79"></a><span id="l19.79" class="difflineplus">+      Assert.equal(!!isOffline, aActionValue == &quot;true&quot;);</span>
<a href="#l19.80"></a><span id="l19.80">     }</span>
<a href="#l19.81"></a><span id="l19.81">   },</span>
<a href="#l19.82"></a><span id="l19.82" class="difflineminus">-  isValidForType: function(type, scope) {return true;},</span>
<a href="#l19.83"></a><span id="l19.83" class="difflineplus">+  isValidForType(type, scope) { return true; },</span>
<a href="#l19.84"></a><span id="l19.84"> </span>
<a href="#l19.85"></a><span id="l19.85" class="difflineminus">-  validateActionValue: function(value, folder, type) { return null;},</span>
<a href="#l19.86"></a><span id="l19.86" class="difflineplus">+  validateActionValue(value, folder, type) { return null; },</span>
<a href="#l19.87"></a><span id="l19.87"> </span>
<a href="#l19.88"></a><span id="l19.88">   allowDuplicates: false,</span>
<a href="#l19.89"></a><span id="l19.89"> </span>
<a href="#l19.90"></a><span id="l19.90" class="difflineminus">-  needsBody: false // set during test setup</span>
<a href="#l19.91"></a><span id="l19.91" class="difflineplus">+  needsBody: false, // set during test setup</span>
<a href="#l19.92"></a><span id="l19.92"> };</span>
<a href="#l19.93"></a><span id="l19.93"> </span>
<a href="#l19.94"></a><span id="l19.94"> /*</span>
<a href="#l19.95"></a><span id="l19.95">  * helper functions</span>
<a href="#l19.96"></a><span id="l19.96">  */</span>
<a href="#l19.97"></a><span id="l19.97"> </span>
<a href="#l19.98"></a><span id="l19.98"> // given a test file, return the file uri spec</span>
<a href="#l19.99"></a><span id="l19.99"> function specForFileName(aFileName) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_folderOfflineFlags.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_folderOfflineFlags.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -5,50 +5,49 @@</span>
<a href="#l20.4"></a><span id="l20.4"> /**</span>
<a href="#l20.5"></a><span id="l20.5">  * Test that the folders that should get flagged for offline use do, and that</span>
<a href="#l20.6"></a><span id="l20.6">  * those that shouldn't don't.</span>
<a href="#l20.7"></a><span id="l20.7">  */</span>
<a href="#l20.8"></a><span id="l20.8"> </span>
<a href="#l20.9"></a><span id="l20.9"> // make SOLO_FILE=&quot;test_folderOfflineFlags.js&quot; -C mailnews/imap/test check-one</span>
<a href="#l20.10"></a><span id="l20.10"> </span>
<a href="#l20.11"></a><span id="l20.11"> // async support</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineplus">+/* import-globals-from ../../../test/resources/alertTestUtils.js */</span>
<a href="#l20.15"></a><span id="l20.15"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l20.16"></a><span id="l20.16"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l20.17"></a><span id="l20.17"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l20.18"></a><span id="l20.18"> </span>
<a href="#l20.19"></a><span id="l20.19" class="difflineminus">-// IMAP pump</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineminus">-</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineminus">-</span>
<a href="#l20.23"></a><span id="l20.23"> // Definition of tests</span>
<a href="#l20.24"></a><span id="l20.24"> var tests = [</span>
<a href="#l20.25"></a><span id="l20.25">   setup,</span>
<a href="#l20.26"></a><span id="l20.26">   testGeneralFoldersOffline,</span>
<a href="#l20.27"></a><span id="l20.27">   testTrashNotOffline,</span>
<a href="#l20.28"></a><span id="l20.28">   testJunkNotOffline,</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineminus">-  teardown</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineplus">+  teardown,</span>
<a href="#l20.31"></a><span id="l20.31"> ];</span>
<a href="#l20.32"></a><span id="l20.32"> </span>
<a href="#l20.33"></a><span id="l20.33"> /**</span>
<a href="#l20.34"></a><span id="l20.34">  * Setup the mailboxes that will be used for this test.</span>
<a href="#l20.35"></a><span id="l20.35">  */</span>
<a href="#l20.36"></a><span id="l20.36"> function* setup() {</span>
<a href="#l20.37"></a><span id="l20.37">   setupIMAPPump(&quot;GMail&quot;);</span>
<a href="#l20.38"></a><span id="l20.38"> </span>
<a href="#l20.39"></a><span id="l20.39">   IMAPPump.mailbox.subscribed = true;</span>
<a href="#l20.40"></a><span id="l20.40">   IMAPPump.mailbox.specialUseFlag = &quot;\\Inbox&quot;;</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineminus">-  IMAPPump.daemon.createMailbox(&quot;[Gmail]&quot;, {flags : [&quot;\\Noselect&quot;], subscribed: true});</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineminus">-  IMAPPump.daemon.createMailbox(&quot;[Gmail]/All Mail&quot;, {specialUseFlag : &quot;\\AllMail&quot;, subscribed: true});</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineminus">-  IMAPPump.daemon.createMailbox(&quot;[Gmail]/Drafts&quot;, {specialUseFlag : &quot;\\Drafts&quot;, subscribed: true});</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineminus">-  IMAPPump.daemon.createMailbox(&quot;[Gmail]/Sent&quot;, {specialUseFlag : &quot;\\Sent&quot;, subscribed: true});</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineminus">-  IMAPPump.daemon.createMailbox(&quot;[Gmail]/Spam&quot;, {specialUseFlag : &quot;\\Spam&quot;, subscribed: true});</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineminus">-  IMAPPump.daemon.createMailbox(&quot;[Gmail]/Starred&quot;, {specialUseFlag : &quot;\\Starred&quot;, subscribed: true});</span>
<a href="#l20.47"></a><span id="l20.47" class="difflineminus">-  IMAPPump.daemon.createMailbox(&quot;[Gmail]/Trash&quot;, {specialUseFlag : &quot;\\Trash&quot;, subscribed: true});</span>
<a href="#l20.48"></a><span id="l20.48" class="difflineminus">-  IMAPPump.daemon.createMailbox(&quot;folder1&quot;, {subscribed : true});</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineminus">-  IMAPPump.daemon.createMailbox(&quot;folder2&quot;, {subscribed : true});</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;[Gmail]&quot;, {flags: [&quot;\\Noselect&quot;], subscribed: true});</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;[Gmail]/All Mail&quot;, {specialUseFlag: &quot;\\AllMail&quot;, subscribed: true});</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;[Gmail]/Drafts&quot;, {specialUseFlag: &quot;\\Drafts&quot;, subscribed: true});</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;[Gmail]/Sent&quot;, {specialUseFlag: &quot;\\Sent&quot;, subscribed: true});</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;[Gmail]/Spam&quot;, {specialUseFlag: &quot;\\Spam&quot;, subscribed: true});</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;[Gmail]/Starred&quot;, {specialUseFlag: &quot;\\Starred&quot;, subscribed: true});</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;[Gmail]/Trash&quot;, {specialUseFlag: &quot;\\Trash&quot;, subscribed: true});</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;folder1&quot;, {subscribed: true});</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;folder2&quot;, {subscribed: true});</span>
<a href="#l20.59"></a><span id="l20.59"> </span>
<a href="#l20.60"></a><span id="l20.60">   // select the inbox to force folder discovery, etc.</span>
<a href="#l20.61"></a><span id="l20.61">   IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l20.62"></a><span id="l20.62"> </span>
<a href="#l20.63"></a><span id="l20.63">   yield false;</span>
<a href="#l20.64"></a><span id="l20.64"> }</span>
<a href="#l20.65"></a><span id="l20.65"> </span>
<a href="#l20.66"></a><span id="l20.66"> /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_gmailAttributes.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_gmailAttributes.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -10,16 +10,18 @@</span>
<a href="#l21.4"></a><span id="l21.4">  *</span>
<a href="#l21.5"></a><span id="l21.5">  * See https://bugzilla.mozilla.org/show_bug.cgi?id=721316</span>
<a href="#l21.6"></a><span id="l21.6">  * for more info.</span>
<a href="#l21.7"></a><span id="l21.7">  *</span>
<a href="#l21.8"></a><span id="l21.8">  * Original Author: Atul Jangra&lt;atuljangra66@gmail.com&gt;</span>
<a href="#l21.9"></a><span id="l21.9">  */</span>
<a href="#l21.10"></a><span id="l21.10"> </span>
<a href="#l21.11"></a><span id="l21.11"> // async support</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l21.14"></a><span id="l21.14"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l21.15"></a><span id="l21.15"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l21.16"></a><span id="l21.16"> </span>
<a href="#l21.17"></a><span id="l21.17"> // IMAP pump</span>
<a href="#l21.18"></a><span id="l21.18"> </span>
<a href="#l21.19"></a><span id="l21.19"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l21.20"></a><span id="l21.20"> </span>
<a href="#l21.21"></a><span id="l21.21"> // Messages to load must have CRLF line endings, that is Windows style</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineat">@@ -30,79 +32,74 @@ var gXGmThrid = &quot;1266894439832287888&quot;;</span>
<a href="#l21.23"></a><span id="l21.23"> var gXGmLabels = '(\\Inbox \\Sent Important &quot;Muy Importante&quot; foo)';</span>
<a href="#l21.24"></a><span id="l21.24"> </span>
<a href="#l21.25"></a><span id="l21.25"> setupIMAPPump(&quot;GMail&quot;);</span>
<a href="#l21.26"></a><span id="l21.26"> </span>
<a href="#l21.27"></a><span id="l21.27"> IMAPPump.mailbox.specialUseFlag = &quot;\\Inbox&quot;;</span>
<a href="#l21.28"></a><span id="l21.28"> IMAPPump.mailbox.subscribed = true;</span>
<a href="#l21.29"></a><span id="l21.29"> </span>
<a href="#l21.30"></a><span id="l21.30"> // need all mail folder to identify this as gmail server.</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineminus">-IMAPPump.daemon.createMailbox(&quot;[Gmail]&quot;, {flags : [&quot;\\NoSelect&quot;] });</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineminus">-IMAPPump.daemon.createMailbox(&quot;[Gmail]/All Mail&quot;, {subscribed : true,</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineminus">-                                               specialUseFlag : &quot;\\AllMail&quot;});</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineplus">+IMAPPump.daemon.createMailbox(&quot;[Gmail]&quot;, {flags: [&quot;\\NoSelect&quot;] });</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineplus">+IMAPPump.daemon.createMailbox(&quot;[Gmail]/All Mail&quot;, {</span>
<a href="#l21.36"></a><span id="l21.36" class="difflineplus">+  subscribed: true,</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineplus">+  specialUseFlag: &quot;\\AllMail&quot;,</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineplus">+});</span>
<a href="#l21.39"></a><span id="l21.39"> </span>
<a href="#l21.40"></a><span id="l21.40"> // Definition of tests</span>
<a href="#l21.41"></a><span id="l21.41"> var tests = [</span>
<a href="#l21.42"></a><span id="l21.42">   loadImapMessage,</span>
<a href="#l21.43"></a><span id="l21.43">   testFetchXGmMsgid,</span>
<a href="#l21.44"></a><span id="l21.44">   testFetchXGmThrid,</span>
<a href="#l21.45"></a><span id="l21.45">   testFetchXGmLabels,</span>
<a href="#l21.46"></a><span id="l21.46" class="difflineminus">-  endTest</span>
<a href="#l21.47"></a><span id="l21.47" class="difflineminus">-]</span>
<a href="#l21.48"></a><span id="l21.48" class="difflineplus">+  endTest,</span>
<a href="#l21.49"></a><span id="l21.49" class="difflineplus">+];</span>
<a href="#l21.50"></a><span id="l21.50"> </span>
<a href="#l21.51"></a><span id="l21.51"> // load and update a message in the imap fake server</span>
<a href="#l21.52"></a><span id="l21.52" class="difflineminus">-function* loadImapMessage()</span>
<a href="#l21.53"></a><span id="l21.53" class="difflineminus">-{</span>
<a href="#l21.54"></a><span id="l21.54" class="difflineplus">+function* loadImapMessage() {</span>
<a href="#l21.55"></a><span id="l21.55">   let message = new imapMessage(specForFileName(gMessage),</span>
<a href="#l21.56"></a><span id="l21.56">                                 IMAPPump.mailbox.uidnext++, []);</span>
<a href="#l21.57"></a><span id="l21.57">   message.xGmMsgid = gXGmMsgid;</span>
<a href="#l21.58"></a><span id="l21.58">   message.xGmThrid = gXGmThrid;</span>
<a href="#l21.59"></a><span id="l21.59">   message.xGmLabels = gXGmLabels;</span>
<a href="#l21.60"></a><span id="l21.60">   IMAPPump.mailbox.addMessage(message);</span>
<a href="#l21.61"></a><span id="l21.61">   IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l21.62"></a><span id="l21.62">   yield false;</span>
<a href="#l21.63"></a><span id="l21.63"> }</span>
<a href="#l21.64"></a><span id="l21.64"> </span>
<a href="#l21.65"></a><span id="l21.65" class="difflineminus">-function testFetchXGmMsgid()</span>
<a href="#l21.66"></a><span id="l21.66" class="difflineminus">-{</span>
<a href="#l21.67"></a><span id="l21.67" class="difflineplus">+function testFetchXGmMsgid() {</span>
<a href="#l21.68"></a><span id="l21.68">   let msgHdr = mailTestUtils.firstMsgHdr(IMAPPump.inbox);</span>
<a href="#l21.69"></a><span id="l21.69">   let val = msgHdr.getStringProperty(&quot;X-GM-MSGID&quot;);</span>
<a href="#l21.70"></a><span id="l21.70">   Assert.equal(val, gXGmMsgid);</span>
<a href="#l21.71"></a><span id="l21.71"> }</span>
<a href="#l21.72"></a><span id="l21.72"> </span>
<a href="#l21.73"></a><span id="l21.73" class="difflineminus">-function testFetchXGmThrid()</span>
<a href="#l21.74"></a><span id="l21.74" class="difflineminus">-{</span>
<a href="#l21.75"></a><span id="l21.75" class="difflineplus">+function testFetchXGmThrid() {</span>
<a href="#l21.76"></a><span id="l21.76">   let msgHdr = mailTestUtils.firstMsgHdr(IMAPPump.inbox);</span>
<a href="#l21.77"></a><span id="l21.77">   let val = msgHdr.getStringProperty(&quot;X-GM-THRID&quot;);</span>
<a href="#l21.78"></a><span id="l21.78">   Assert.equal(val, gXGmThrid);</span>
<a href="#l21.79"></a><span id="l21.79"> }</span>
<a href="#l21.80"></a><span id="l21.80"> </span>
<a href="#l21.81"></a><span id="l21.81" class="difflineminus">-function testFetchXGmLabels()</span>
<a href="#l21.82"></a><span id="l21.82" class="difflineminus">-{</span>
<a href="#l21.83"></a><span id="l21.83" class="difflineplus">+function testFetchXGmLabels() {</span>
<a href="#l21.84"></a><span id="l21.84">   let msgHdr = mailTestUtils.firstMsgHdr(IMAPPump.inbox);</span>
<a href="#l21.85"></a><span id="l21.85">   let val = msgHdr.getStringProperty(&quot;X-GM-LABELS&quot;);</span>
<a href="#l21.86"></a><span id="l21.86">    // We need to remove the starting &quot;(&quot; and ending &quot;)&quot; from gXGmLabels while comparing</span>
<a href="#l21.87"></a><span id="l21.87" class="difflineminus">-  Assert.equal(val, gXGmLabels.substring(1 ,gXGmLabels.length - 1));</span>
<a href="#l21.88"></a><span id="l21.88" class="difflineplus">+  Assert.equal(val, gXGmLabels.substring(1, gXGmLabels.length - 1));</span>
<a href="#l21.89"></a><span id="l21.89"> }</span>
<a href="#l21.90"></a><span id="l21.90"> </span>
<a href="#l21.91"></a><span id="l21.91"> // Cleanup at end</span>
<a href="#l21.92"></a><span id="l21.92" class="difflineminus">-function endTest()</span>
<a href="#l21.93"></a><span id="l21.93" class="difflineminus">-{</span>
<a href="#l21.94"></a><span id="l21.94" class="difflineplus">+function endTest() {</span>
<a href="#l21.95"></a><span id="l21.95">   teardownIMAPPump();</span>
<a href="#l21.96"></a><span id="l21.96"> }</span>
<a href="#l21.97"></a><span id="l21.97"> </span>
<a href="#l21.98"></a><span id="l21.98" class="difflineminus">-function run_test()</span>
<a href="#l21.99"></a><span id="l21.99" class="difflineminus">-{</span>
<a href="#l21.100"></a><span id="l21.100" class="difflineplus">+function run_test() {</span>
<a href="#l21.101"></a><span id="l21.101">   Services.prefs.setBoolPref(&quot;mail.server.server1.autosync_offline_stores&quot;, false);</span>
<a href="#l21.102"></a><span id="l21.102">   async_run_tests(tests);</span>
<a href="#l21.103"></a><span id="l21.103"> }</span>
<a href="#l21.104"></a><span id="l21.104"> </span>
<a href="#l21.105"></a><span id="l21.105"> /*</span>
<a href="#l21.106"></a><span id="l21.106">  * helper functions</span>
<a href="#l21.107"></a><span id="l21.107">  */</span>
<a href="#l21.108"></a><span id="l21.108"> </span>
<a href="#l21.109"></a><span id="l21.109"> // given a test file, return the file uri spec</span>
<a href="#l21.110"></a><span id="l21.110" class="difflineminus">-function specForFileName(aFileName)</span>
<a href="#l21.111"></a><span id="l21.111" class="difflineminus">-{</span>
<a href="#l21.112"></a><span id="l21.112" class="difflineplus">+function specForFileName(aFileName) {</span>
<a href="#l21.113"></a><span id="l21.113">   let file = do_get_file(&quot;../../../data/&quot; + aFileName);</span>
<a href="#l21.114"></a><span id="l21.114">   let msgfileuri = Services.io.newFileURI(file).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l21.115"></a><span id="l21.115">   return msgfileuri.spec;</span>
<a href="#l21.116"></a><span id="l21.116"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_gmailOfflineMsgStore.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_gmailOfflineMsgStore.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -12,18 +12,19 @@</span>
<a href="#l22.4"></a><span id="l22.4">  *</span>
<a href="#l22.5"></a><span id="l22.5">  * See https://bugzilla.mozilla.org/show_bug.cgi?id=721316</span>
<a href="#l22.6"></a><span id="l22.6">  * for more info.</span>
<a href="#l22.7"></a><span id="l22.7">  *</span>
<a href="#l22.8"></a><span id="l22.8">  * Original Author: Atul Jangra&lt;atuljangra66@gmail.com&gt;</span>
<a href="#l22.9"></a><span id="l22.9">  */</span>
<a href="#l22.10"></a><span id="l22.10"> </span>
<a href="#l22.11"></a><span id="l22.11"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l22.13"></a><span id="l22.13"> </span>
<a href="#l22.14"></a><span id="l22.14" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l22.16"></a><span id="l22.16"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l22.17"></a><span id="l22.17"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l22.18"></a><span id="l22.18"> </span>
<a href="#l22.19"></a><span id="l22.19"> </span>
<a href="#l22.20"></a><span id="l22.20"> </span>
<a href="#l22.21"></a><span id="l22.21"> // Messages to load must have CRLF line endings, that is Windows style</span>
<a href="#l22.22"></a><span id="l22.22"> </span>
<a href="#l22.23"></a><span id="l22.23"> var gMessage1 = &quot;bugmail10&quot;; // message file used as the test message for Inbox and fooFolder</span>
<a href="#l22.24"></a><span id="l22.24" class="difflineat">@@ -55,37 +56,39 @@ var tests = [</span>
<a href="#l22.25"></a><span id="l22.25">   selectInboxMsg,</span>
<a href="#l22.26"></a><span id="l22.26">   StreamMessageInbox,</span>
<a href="#l22.27"></a><span id="l22.27">   createAndUpdate,</span>
<a href="#l22.28"></a><span id="l22.28">   addFoo,</span>
<a href="#l22.29"></a><span id="l22.29">   updateFoo,</span>
<a href="#l22.30"></a><span id="l22.30">   selectFooMsg,</span>
<a href="#l22.31"></a><span id="l22.31">   StreamMessageFoo,</span>
<a href="#l22.32"></a><span id="l22.32">   crossStreaming,</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineminus">-  teardown</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineminus">-]</span>
<a href="#l22.35"></a><span id="l22.35" class="difflineplus">+  teardown,</span>
<a href="#l22.36"></a><span id="l22.36" class="difflineplus">+];</span>
<a href="#l22.37"></a><span id="l22.37"> </span>
<a href="#l22.38"></a><span id="l22.38"> function setup() {</span>
<a href="#l22.39"></a><span id="l22.39">   // We aren't interested in downloading messages automatically</span>
<a href="#l22.40"></a><span id="l22.40">   Services.prefs.setBoolPref(&quot;mail.server.server1.autosync_offline_stores&quot;, false);</span>
<a href="#l22.41"></a><span id="l22.41">   Services.prefs.setBoolPref(&quot;mail.server.server1.offline_download&quot;, true);</span>
<a href="#l22.42"></a><span id="l22.42">   Services.prefs.setBoolPref(&quot;mail.biff.alert.show_preview&quot;, false);</span>
<a href="#l22.43"></a><span id="l22.43"> </span>
<a href="#l22.44"></a><span id="l22.44">   setupIMAPPump(&quot;GMail&quot;);</span>
<a href="#l22.45"></a><span id="l22.45"> </span>
<a href="#l22.46"></a><span id="l22.46">   IMAPPump.mailbox.specialUseFlag = &quot;\\Inbox&quot;;</span>
<a href="#l22.47"></a><span id="l22.47">   IMAPPump.mailbox.subscribed = true;</span>
<a href="#l22.48"></a><span id="l22.48"> </span>
<a href="#l22.49"></a><span id="l22.49">   // need all mail folder to identify this as gmail server.</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineminus">-  IMAPPump.daemon.createMailbox(&quot;[Gmail]&quot;, {flags : [&quot;\\NoSelect&quot;] });</span>
<a href="#l22.51"></a><span id="l22.51" class="difflineminus">-  IMAPPump.daemon.createMailbox(&quot;[Gmail]/All Mail&quot;, {subscribed : true,</span>
<a href="#l22.52"></a><span id="l22.52" class="difflineminus">-                                                 specialUseFlag : &quot;\\AllMail&quot;});</span>
<a href="#l22.53"></a><span id="l22.53" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;[Gmail]&quot;, {flags: [&quot;\\NoSelect&quot;] });</span>
<a href="#l22.54"></a><span id="l22.54" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;[Gmail]/All Mail&quot;, {</span>
<a href="#l22.55"></a><span id="l22.55" class="difflineplus">+    subscribed: true,</span>
<a href="#l22.56"></a><span id="l22.56" class="difflineplus">+    specialUseFlag: &quot;\\AllMail&quot;,</span>
<a href="#l22.57"></a><span id="l22.57" class="difflineplus">+  });</span>
<a href="#l22.58"></a><span id="l22.58"> </span>
<a href="#l22.59"></a><span id="l22.59">   // Creating the mailbox &quot;foo&quot;</span>
<a href="#l22.60"></a><span id="l22.60" class="difflineminus">-  IMAPPump.daemon.createMailbox(&quot;foo&quot;, {subscribed : true});</span>
<a href="#l22.61"></a><span id="l22.61" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;foo&quot;, {subscribed: true});</span>
<a href="#l22.62"></a><span id="l22.62">   fooBox = IMAPPump.daemon.getMailbox(&quot;foo&quot;);</span>
<a href="#l22.63"></a><span id="l22.63"> </span>
<a href="#l22.64"></a><span id="l22.64">   // Add message1 to inbox.</span>
<a href="#l22.65"></a><span id="l22.65">   let message = new imapMessage(specForFileName(gMessage1),</span>
<a href="#l22.66"></a><span id="l22.66">                             IMAPPump.mailbox.uidnext++, []);</span>
<a href="#l22.67"></a><span id="l22.67">   message.messageId = gMsgId1;</span>
<a href="#l22.68"></a><span id="l22.68">   message.xGmMsgid = gXGmMsgid1;</span>
<a href="#l22.69"></a><span id="l22.69">   message.xGmThrid = gXGmThrid1;</span>
<a href="#l22.70"></a><span id="l22.70" class="difflineat">@@ -99,17 +102,17 @@ function* updateFolder() {</span>
<a href="#l22.71"></a><span id="l22.71"> }</span>
<a href="#l22.72"></a><span id="l22.72"> </span>
<a href="#l22.73"></a><span id="l22.73"> function* selectInboxMsg() {</span>
<a href="#l22.74"></a><span id="l22.74">   // Select mesasage1 from inbox which makes message1 available in offline store.</span>
<a href="#l22.75"></a><span id="l22.75">   let imapService = Cc[&quot;@mozilla.org/messenger/messageservice;1?type=imap&quot;]</span>
<a href="#l22.76"></a><span id="l22.76">                         .getService(Ci.nsIMsgMessageService);</span>
<a href="#l22.77"></a><span id="l22.77">   let db = IMAPPump.inbox.msgDatabase;</span>
<a href="#l22.78"></a><span id="l22.78">   let msg1 = db.getMsgHdrForMessageID(gMsgId1);</span>
<a href="#l22.79"></a><span id="l22.79" class="difflineminus">-  let url = new Object;</span>
<a href="#l22.80"></a><span id="l22.80" class="difflineplus">+  let url = {};</span>
<a href="#l22.81"></a><span id="l22.81">   imapService.DisplayMessage(IMAPPump.inbox.getUriForMsg(msg1), streamListener,</span>
<a href="#l22.82"></a><span id="l22.82">                              null, asyncUrlListener, null, url);</span>
<a href="#l22.83"></a><span id="l22.83">   yield false;</span>
<a href="#l22.84"></a><span id="l22.84"> }</span>
<a href="#l22.85"></a><span id="l22.85"> </span>
<a href="#l22.86"></a><span id="l22.86"> function* StreamMessageInbox() {</span>
<a href="#l22.87"></a><span id="l22.87">   // Stream message1 from inbox</span>
<a href="#l22.88"></a><span id="l22.88">   let newMsgHdr = IMAPPump.inbox.msgDatabase.getMsgHdrForMessageID(gMsgId1);</span>
<a href="#l22.89"></a><span id="l22.89" class="difflineat">@@ -152,17 +155,17 @@ function* updateFoo() {</span>
<a href="#l22.90"></a><span id="l22.90">   yield false;</span>
<a href="#l22.91"></a><span id="l22.91"> }</span>
<a href="#l22.92"></a><span id="l22.92"> </span>
<a href="#l22.93"></a><span id="l22.93"> function* selectFooMsg() {</span>
<a href="#l22.94"></a><span id="l22.94">   // Select message2 from fooFolder, which makes fooFolder a local folder.</span>
<a href="#l22.95"></a><span id="l22.95">   let imapService = Cc[&quot;@mozilla.org/messenger/messageservice;1?type=imap&quot;]</span>
<a href="#l22.96"></a><span id="l22.96">                        .getService(Ci.nsIMsgMessageService);</span>
<a href="#l22.97"></a><span id="l22.97">   let msg1 = fooFolder.msgDatabase.getMsgHdrForMessageID(gMsgId2);</span>
<a href="#l22.98"></a><span id="l22.98" class="difflineminus">-  let url = new Object;</span>
<a href="#l22.99"></a><span id="l22.99" class="difflineplus">+  let url = {};</span>
<a href="#l22.100"></a><span id="l22.100">   imapService.DisplayMessage(fooFolder.getUriForMsg(msg1), streamListener,</span>
<a href="#l22.101"></a><span id="l22.101">                              null, asyncUrlListener, null, url);</span>
<a href="#l22.102"></a><span id="l22.102">   yield false;</span>
<a href="#l22.103"></a><span id="l22.103"> }</span>
<a href="#l22.104"></a><span id="l22.104"> </span>
<a href="#l22.105"></a><span id="l22.105"> function* StreamMessageFoo() {</span>
<a href="#l22.106"></a><span id="l22.106">   // Stream message2 from fooFolder</span>
<a href="#l22.107"></a><span id="l22.107">   let newMsgHdr = fooFolder.msgDatabase.getMsgHdrForMessageID(gMsgId2);</span>
<a href="#l22.108"></a><span id="l22.108" class="difflineat">@@ -187,17 +190,17 @@ function* crossStreaming() {</span>
<a href="#l22.109"></a><span id="l22.109">   let msgURI = fooFolder.getUriForMsg(msg2);</span>
<a href="#l22.110"></a><span id="l22.110">   let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l22.111"></a><span id="l22.111">   let msgServ = messenger.messageServiceFromURI(msgURI);</span>
<a href="#l22.112"></a><span id="l22.112">   // pass true for aLocalOnly since message should be in offline store of Inbox.</span>
<a href="#l22.113"></a><span id="l22.113">   msgServ.streamMessage(msgURI, gStreamListener, null, null, false, &quot;&quot;, true);</span>
<a href="#l22.114"></a><span id="l22.114">   gFooOfflineStoreSizeFinal = fooFolder.filePath.fileSize;</span>
<a href="#l22.115"></a><span id="l22.115">   gImapInboxOfflineStoreSizeFinal = IMAPPump.inbox.filePath.fileSize;</span>
<a href="#l22.116"></a><span id="l22.116">   Assert.equal(gFooOfflineStoreSizeFinal, gFooOfflineStoreSizeInitial);</span>
<a href="#l22.117"></a><span id="l22.117" class="difflineminus">-  Assert.equal(gImapInboxOfflineStoreSizeFinal,gImapInboxOfflineStoreSizeInitial);</span>
<a href="#l22.118"></a><span id="l22.118" class="difflineplus">+  Assert.equal(gImapInboxOfflineStoreSizeFinal, gImapInboxOfflineStoreSizeInitial);</span>
<a href="#l22.119"></a><span id="l22.119">   yield false;</span>
<a href="#l22.120"></a><span id="l22.120"> }</span>
<a href="#l22.121"></a><span id="l22.121"> </span>
<a href="#l22.122"></a><span id="l22.122"> function teardown() {</span>
<a href="#l22.123"></a><span id="l22.123">   teardownIMAPPump();</span>
<a href="#l22.124"></a><span id="l22.124"> }</span>
<a href="#l22.125"></a><span id="l22.125"> </span>
<a href="#l22.126"></a><span id="l22.126"> function run_test() {</span>
<a href="#l22.127"></a><span id="l22.127" class="difflineat">@@ -208,61 +211,59 @@ function run_test() {</span>
<a href="#l22.128"></a><span id="l22.128">  * helper functions</span>
<a href="#l22.129"></a><span id="l22.129">  */</span>
<a href="#l22.130"></a><span id="l22.130"> </span>
<a href="#l22.131"></a><span id="l22.131"> asyncUrlListener.callback = function(aUrl, aExitCode) {</span>
<a href="#l22.132"></a><span id="l22.132">   Assert.equal(aExitCode, 0);</span>
<a href="#l22.133"></a><span id="l22.133"> };</span>
<a href="#l22.134"></a><span id="l22.134"> </span>
<a href="#l22.135"></a><span id="l22.135">  // We use this as a display consumer</span>
<a href="#l22.136"></a><span id="l22.136" class="difflineminus">-var streamListener =</span>
<a href="#l22.137"></a><span id="l22.137" class="difflineminus">-{</span>
<a href="#l22.138"></a><span id="l22.138" class="difflineplus">+var streamListener = {</span>
<a href="#l22.139"></a><span id="l22.139">   _data: &quot;&quot;,</span>
<a href="#l22.140"></a><span id="l22.140"> </span>
<a href="#l22.141"></a><span id="l22.141">   QueryInterface:</span>
<a href="#l22.142"></a><span id="l22.142">     ChromeUtils.generateQI([Ci.nsIStreamListener, Ci.nsIRequestObserver]),</span>
<a href="#l22.143"></a><span id="l22.143"> </span>
<a href="#l22.144"></a><span id="l22.144">   // nsIRequestObserver</span>
<a href="#l22.145"></a><span id="l22.145" class="difflineminus">-  onStartRequest: function(aRequest) {</span>
<a href="#l22.146"></a><span id="l22.146" class="difflineplus">+  onStartRequest(aRequest) {</span>
<a href="#l22.147"></a><span id="l22.147">   },</span>
<a href="#l22.148"></a><span id="l22.148" class="difflineminus">-  onStopRequest: function(aRequest, aStatusCode) {</span>
<a href="#l22.149"></a><span id="l22.149" class="difflineplus">+  onStopRequest(aRequest, aStatusCode) {</span>
<a href="#l22.150"></a><span id="l22.150">     Assert.equal(aStatusCode, 0);</span>
<a href="#l22.151"></a><span id="l22.151">   },</span>
<a href="#l22.152"></a><span id="l22.152"> </span>
<a href="#l22.153"></a><span id="l22.153">   // nsIStreamListener</span>
<a href="#l22.154"></a><span id="l22.154" class="difflineminus">-  onDataAvailable: function(aRequest, aInputStream, aOffset, aCount) {</span>
<a href="#l22.155"></a><span id="l22.155" class="difflineplus">+  onDataAvailable(aRequest, aInputStream, aOffset, aCount) {</span>
<a href="#l22.156"></a><span id="l22.156">     let scriptStream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;]</span>
<a href="#l22.157"></a><span id="l22.157" class="difflineminus">-                          .createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l22.158"></a><span id="l22.158" class="difflineplus">+                         .createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l22.159"></a><span id="l22.159"> </span>
<a href="#l22.160"></a><span id="l22.160">     scriptStream.init(aInputStream);</span>
<a href="#l22.161"></a><span id="l22.161"> </span>
<a href="#l22.162"></a><span id="l22.162">     scriptStream.read(aCount);</span>
<a href="#l22.163"></a><span id="l22.163" class="difflineminus">-  }</span>
<a href="#l22.164"></a><span id="l22.164" class="difflineplus">+  },</span>
<a href="#l22.165"></a><span id="l22.165"> };</span>
<a href="#l22.166"></a><span id="l22.166"> </span>
<a href="#l22.167"></a><span id="l22.167"> var gStreamListener = {</span>
<a href="#l22.168"></a><span id="l22.168" class="difflineminus">-  QueryInterface : ChromeUtils.generateQI([Ci.nsIStreamListener]),</span>
<a href="#l22.169"></a><span id="l22.169" class="difflineminus">-  _stream : null,</span>
<a href="#l22.170"></a><span id="l22.170" class="difflineminus">-  _data : null,</span>
<a href="#l22.171"></a><span id="l22.171" class="difflineminus">-  onStartRequest : function (aRequest) {</span>
<a href="#l22.172"></a><span id="l22.172" class="difflineplus">+  QueryInterface: ChromeUtils.generateQI([Ci.nsIStreamListener]),</span>
<a href="#l22.173"></a><span id="l22.173" class="difflineplus">+  _stream: null,</span>
<a href="#l22.174"></a><span id="l22.174" class="difflineplus">+  _data: null,</span>
<a href="#l22.175"></a><span id="l22.175" class="difflineplus">+  onStartRequest(aRequest) {</span>
<a href="#l22.176"></a><span id="l22.176">     this._data = &quot;&quot;;</span>
<a href="#l22.177"></a><span id="l22.177">   },</span>
<a href="#l22.178"></a><span id="l22.178" class="difflineminus">-  onStopRequest : function (aRequest, aStatusCode) {</span>
<a href="#l22.179"></a><span id="l22.179" class="difflineplus">+  onStopRequest(aRequest, aStatusCode) {</span>
<a href="#l22.180"></a><span id="l22.180">     async_driver();</span>
<a href="#l22.181"></a><span id="l22.181">     this._stream = null;</span>
<a href="#l22.182"></a><span id="l22.182">   },</span>
<a href="#l22.183"></a><span id="l22.183" class="difflineminus">-  onDataAvailable : function (aRequest, aInputStream, aOff, aCount) {</span>
<a href="#l22.184"></a><span id="l22.184" class="difflineplus">+  onDataAvailable(aRequest, aInputStream, aOff, aCount) {</span>
<a href="#l22.185"></a><span id="l22.185">     if (this._stream == null) {</span>
<a href="#l22.186"></a><span id="l22.186">       this._stream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;].createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l22.187"></a><span id="l22.187">       this._stream.init(aInputStream);</span>
<a href="#l22.188"></a><span id="l22.188">     }</span>
<a href="#l22.189"></a><span id="l22.189">     this._data += this._stream.read(aCount);</span>
<a href="#l22.190"></a><span id="l22.190">   },</span>
<a href="#l22.191"></a><span id="l22.191"> };</span>
<a href="#l22.192"></a><span id="l22.192"> </span>
<a href="#l22.193"></a><span id="l22.193"> // given a test file, return the file uri spec</span>
<a href="#l22.194"></a><span id="l22.194" class="difflineminus">-function specForFileName(aFileName)</span>
<a href="#l22.195"></a><span id="l22.195" class="difflineminus">-{</span>
<a href="#l22.196"></a><span id="l22.196" class="difflineplus">+function specForFileName(aFileName) {</span>
<a href="#l22.197"></a><span id="l22.197">   let file = do_get_file(&quot;../../../data/&quot; + aFileName);</span>
<a href="#l22.198"></a><span id="l22.198">   let msgfileuri = Services.io.newFileURI(file).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l22.199"></a><span id="l22.199">   return msgfileuri.spec;</span>
<a href="#l22.200"></a><span id="l22.200"> }</span>
<a href="#l22.201"></a><span id="l22.201"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapAttachmentSaves.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapAttachmentSaves.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -1,51 +1,53 @@</span>
<a href="#l23.4"></a><span id="l23.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l23.5"></a><span id="l23.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l23.6"></a><span id="l23.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l23.7"></a><span id="l23.7"> </span>
<a href="#l23.8"></a><span id="l23.8"> /*</span>
<a href="#l23.9"></a><span id="l23.9">  * Tests imap save and detach attachments.</span>
<a href="#l23.10"></a><span id="l23.10">  */</span>
<a href="#l23.11"></a><span id="l23.11"> </span>
<a href="#l23.12"></a><span id="l23.12" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l23.15"></a><span id="l23.15"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l23.16"></a><span id="l23.16"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l23.17"></a><span id="l23.17"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l23.18"></a><span id="l23.18"> </span>
<a href="#l23.19"></a><span id="l23.19"> // javascript mime emitter functions</span>
<a href="#l23.20"></a><span id="l23.20"> var mimeMsg = {};</span>
<a href="#l23.21"></a><span id="l23.21"> ChromeUtils.import(&quot;resource:///modules/gloda/mimemsg.js&quot;, mimeMsg);</span>
<a href="#l23.22"></a><span id="l23.22"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l23.23"></a><span id="l23.23"> </span>
<a href="#l23.24"></a><span id="l23.24"> // IMAP pump</span>
<a href="#l23.25"></a><span id="l23.25"> </span>
<a href="#l23.26"></a><span id="l23.26" class="difflineminus">-var kAttachFileName = 'bob.txt';</span>
<a href="#l23.27"></a><span id="l23.27" class="difflineplus">+var kAttachFileName = &quot;bob.txt&quot;;</span>
<a href="#l23.28"></a><span id="l23.28"> </span>
<a href="#l23.29"></a><span id="l23.29"> setupIMAPPump();</span>
<a href="#l23.30"></a><span id="l23.30"> </span>
<a href="#l23.31"></a><span id="l23.31"> // Dummy message window so we can say the inbox is open in a window.</span>
<a href="#l23.32"></a><span id="l23.32"> var dummyMsgWindow = Cc[&quot;@mozilla.org/messenger/msgwindow;1&quot;]</span>
<a href="#l23.33"></a><span id="l23.33">                        .createInstance(Ci.nsIMsgWindow);</span>
<a href="#l23.34"></a><span id="l23.34"> </span>
<a href="#l23.35"></a><span id="l23.35"> var tests = [</span>
<a href="#l23.36"></a><span id="l23.36">   loadImapMessage,</span>
<a href="#l23.37"></a><span id="l23.37">   startMime,</span>
<a href="#l23.38"></a><span id="l23.38">   startDetach,</span>
<a href="#l23.39"></a><span id="l23.39">   testDetach,</span>
<a href="#l23.40"></a><span id="l23.40" class="difflineminus">-  endTest</span>
<a href="#l23.41"></a><span id="l23.41" class="difflineminus">-]</span>
<a href="#l23.42"></a><span id="l23.42" class="difflineplus">+  endTest,</span>
<a href="#l23.43"></a><span id="l23.43" class="difflineplus">+];</span>
<a href="#l23.44"></a><span id="l23.44"> </span>
<a href="#l23.45"></a><span id="l23.45"> // load and update a message in the imap fake server</span>
<a href="#l23.46"></a><span id="l23.46" class="difflineminus">-function* loadImapMessage()</span>
<a href="#l23.47"></a><span id="l23.47" class="difflineminus">-{</span>
<a href="#l23.48"></a><span id="l23.48" class="difflineplus">+function* loadImapMessage() {</span>
<a href="#l23.49"></a><span id="l23.49">   let gMessageGenerator = new MessageGenerator();</span>
<a href="#l23.50"></a><span id="l23.50">   // create a synthetic message with attachment</span>
<a href="#l23.51"></a><span id="l23.51">   let smsg = gMessageGenerator.makeMessage({</span>
<a href="#l23.52"></a><span id="l23.52">     attachments: [</span>
<a href="#l23.53"></a><span id="l23.53" class="difflineminus">-      {filename: kAttachFileName, body: 'I like cheese!'}</span>
<a href="#l23.54"></a><span id="l23.54" class="difflineplus">+      {filename: kAttachFileName, body: &quot;I like cheese!&quot;},</span>
<a href="#l23.55"></a><span id="l23.55">     ],</span>
<a href="#l23.56"></a><span id="l23.56">   });</span>
<a href="#l23.57"></a><span id="l23.57"> </span>
<a href="#l23.58"></a><span id="l23.58">   let msgURI =</span>
<a href="#l23.59"></a><span id="l23.59">     Services.io.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l23.60"></a><span id="l23.60">                        btoa(smsg.toMessageString()));</span>
<a href="#l23.61"></a><span id="l23.61">   let imapInbox = IMAPPump.daemon.getMailbox(&quot;INBOX&quot;);</span>
<a href="#l23.62"></a><span id="l23.62">   let message = new imapMessage(msgURI.spec, imapInbox.uidnext++, []);</span>
<a href="#l23.63"></a><span id="l23.63" class="difflineat">@@ -55,44 +57,41 @@ function* loadImapMessage()</span>
<a href="#l23.64"></a><span id="l23.64">   Assert.equal(1, IMAPPump.inbox.getTotalMessages(false));</span>
<a href="#l23.65"></a><span id="l23.65">   let msgHdr = mailTestUtils.firstMsgHdr(IMAPPump.inbox);</span>
<a href="#l23.66"></a><span id="l23.66">   Assert.ok(msgHdr instanceof Ci.nsIMsgDBHdr);</span>
<a href="#l23.67"></a><span id="l23.67"> </span>
<a href="#l23.68"></a><span id="l23.68">   yield true;</span>
<a href="#l23.69"></a><span id="l23.69"> }</span>
<a href="#l23.70"></a><span id="l23.70"> </span>
<a href="#l23.71"></a><span id="l23.71"> // process the message through mime</span>
<a href="#l23.72"></a><span id="l23.72" class="difflineminus">-function* startMime()</span>
<a href="#l23.73"></a><span id="l23.73" class="difflineminus">-{</span>
<a href="#l23.74"></a><span id="l23.74" class="difflineplus">+function* startMime() {</span>
<a href="#l23.75"></a><span id="l23.75">   let msgHdr = mailTestUtils.firstMsgHdr(IMAPPump.inbox);</span>
<a href="#l23.76"></a><span id="l23.76"> </span>
<a href="#l23.77"></a><span id="l23.77">   mimeMsg.MsgHdrToMimeMessage(msgHdr, gCallbackObject, gCallbackObject.callback,</span>
<a href="#l23.78"></a><span id="l23.78">                               true /* allowDownload */);</span>
<a href="#l23.79"></a><span id="l23.79">   yield false;</span>
<a href="#l23.80"></a><span id="l23.80"> }</span>
<a href="#l23.81"></a><span id="l23.81"> </span>
<a href="#l23.82"></a><span id="l23.82"> // detach any found attachments</span>
<a href="#l23.83"></a><span id="l23.83" class="difflineminus">-function* startDetach()</span>
<a href="#l23.84"></a><span id="l23.84" class="difflineminus">-{</span>
<a href="#l23.85"></a><span id="l23.85" class="difflineplus">+function* startDetach() {</span>
<a href="#l23.86"></a><span id="l23.86">   let msgHdr = mailTestUtils.firstMsgHdr(IMAPPump.inbox);</span>
<a href="#l23.87"></a><span id="l23.87">   let msgURI = msgHdr.folder.generateMessageURI(msgHdr.messageKey);</span>
<a href="#l23.88"></a><span id="l23.88"> </span>
<a href="#l23.89"></a><span id="l23.89">   let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l23.90"></a><span id="l23.90">   let attachment = gCallbackObject.attachments[0];</span>
<a href="#l23.91"></a><span id="l23.91"> </span>
<a href="#l23.92"></a><span id="l23.92">   messenger.detachAttachmentsWOPrompts(do_get_profile(), 1,</span>
<a href="#l23.93"></a><span id="l23.93">                                        [attachment.contentType], [attachment.url],</span>
<a href="#l23.94"></a><span id="l23.94">                                        [attachment.name], [msgURI], null);</span>
<a href="#l23.95"></a><span id="l23.95">   // deletion of original message should kick async_driver.</span>
<a href="#l23.96"></a><span id="l23.96">   yield false;</span>
<a href="#l23.97"></a><span id="l23.97"> }</span>
<a href="#l23.98"></a><span id="l23.98"> </span>
<a href="#l23.99"></a><span id="l23.99"> // test that the detachment was successful</span>
<a href="#l23.100"></a><span id="l23.100" class="difflineminus">-function* testDetach()</span>
<a href="#l23.101"></a><span id="l23.101" class="difflineminus">-{</span>
<a href="#l23.102"></a><span id="l23.102" class="difflineplus">+function* testDetach() {</span>
<a href="#l23.103"></a><span id="l23.103">   // This test seems to fail on Linux without the following delay.</span>
<a href="#l23.104"></a><span id="l23.104">   mailTestUtils.do_timeout_function(200, async_driver);</span>
<a href="#l23.105"></a><span id="l23.105">   yield false;</span>
<a href="#l23.106"></a><span id="l23.106">   // Check that the file attached to the message now exists in the profile</span>
<a href="#l23.107"></a><span id="l23.107">   // directory.</span>
<a href="#l23.108"></a><span id="l23.108">   let checkFile = do_get_profile().clone();</span>
<a href="#l23.109"></a><span id="l23.109">   checkFile.append(kAttachFileName);</span>
<a href="#l23.110"></a><span id="l23.110">   Assert.ok(checkFile.exists());</span>
<a href="#l23.111"></a><span id="l23.111" class="difflineat">@@ -103,35 +102,33 @@ function* testDetach()</span>
<a href="#l23.112"></a><span id="l23.112">   // Get the message header - detached copy has UID 2.</span>
<a href="#l23.113"></a><span id="l23.113">   let msgHdr = IMAPPump.inbox.GetMessageHeader(2);</span>
<a href="#l23.114"></a><span id="l23.114">   Assert.ok(msgHdr !== null);</span>
<a href="#l23.115"></a><span id="l23.115">   let messageContent = getContentFromMessage(msgHdr);</span>
<a href="#l23.116"></a><span id="l23.116">   Assert.ok(messageContent.includes(&quot;AttachmentDetached&quot;));</span>
<a href="#l23.117"></a><span id="l23.117"> }</span>
<a href="#l23.118"></a><span id="l23.118"> </span>
<a href="#l23.119"></a><span id="l23.119"> // Cleanup</span>
<a href="#l23.120"></a><span id="l23.120" class="difflineminus">-function endTest()</span>
<a href="#l23.121"></a><span id="l23.121" class="difflineminus">-{</span>
<a href="#l23.122"></a><span id="l23.122" class="difflineplus">+function endTest() {</span>
<a href="#l23.123"></a><span id="l23.123">   teardownIMAPPump();</span>
<a href="#l23.124"></a><span id="l23.124"> }</span>
<a href="#l23.125"></a><span id="l23.125"> </span>
<a href="#l23.126"></a><span id="l23.126"> function SaveAttachmentCallback() {</span>
<a href="#l23.127"></a><span id="l23.127">   this.attachments = null;</span>
<a href="#l23.128"></a><span id="l23.128"> }</span>
<a href="#l23.129"></a><span id="l23.129"> </span>
<a href="#l23.130"></a><span id="l23.130"> SaveAttachmentCallback.prototype = {</span>
<a href="#l23.131"></a><span id="l23.131">   callback: function saveAttachmentCallback_callback(aMsgHdr, aMimeMessage) {</span>
<a href="#l23.132"></a><span id="l23.132">     this.attachments = aMimeMessage.allAttachments;</span>
<a href="#l23.133"></a><span id="l23.133">     async_driver();</span>
<a href="#l23.134"></a><span id="l23.134" class="difflineminus">-  }</span>
<a href="#l23.135"></a><span id="l23.135" class="difflineminus">-}</span>
<a href="#l23.136"></a><span id="l23.136" class="difflineplus">+  },</span>
<a href="#l23.137"></a><span id="l23.137" class="difflineplus">+};</span>
<a href="#l23.138"></a><span id="l23.138"> var gCallbackObject = new SaveAttachmentCallback();</span>
<a href="#l23.139"></a><span id="l23.139"> </span>
<a href="#l23.140"></a><span id="l23.140" class="difflineminus">-function run_test()</span>
<a href="#l23.141"></a><span id="l23.141" class="difflineminus">-{</span>
<a href="#l23.142"></a><span id="l23.142" class="difflineplus">+function run_test() {</span>
<a href="#l23.143"></a><span id="l23.143">   // Add folder listeners that will capture async events</span>
<a href="#l23.144"></a><span id="l23.144">   const nsIMFNService = Ci.nsIMsgFolderNotificationService;</span>
<a href="#l23.145"></a><span id="l23.145">   MailServices.mfn.addListener(mfnListener, nsIMFNService.msgsDeleted);</span>
<a href="#l23.146"></a><span id="l23.146"> </span>
<a href="#l23.147"></a><span id="l23.147">   // We need to register the dummyMsgWindow so that when we've finished running</span>
<a href="#l23.148"></a><span id="l23.148">   // the append url, in nsImapMailFolder::OnStopRunningUrl, we'll think the</span>
<a href="#l23.149"></a><span id="l23.149">   // Inbox is open in a folder and update it, which the detach code relies</span>
<a href="#l23.150"></a><span id="l23.150">   // on to finish the detach.</span>
<a href="#l23.151"></a><span id="l23.151" class="difflineat">@@ -168,16 +165,14 @@ function getContentFromMessage(aMsgHdr) </span>
<a href="#l23.152"></a><span id="l23.152">   let sis = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;]</span>
<a href="#l23.153"></a><span id="l23.153">               .createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l23.154"></a><span id="l23.154">   sis.init(streamListener.inputStream);</span>
<a href="#l23.155"></a><span id="l23.155">   let content = sis.read(MAX_MESSAGE_LENGTH);</span>
<a href="#l23.156"></a><span id="l23.156">   sis.close();</span>
<a href="#l23.157"></a><span id="l23.157">   return content;</span>
<a href="#l23.158"></a><span id="l23.158"> }</span>
<a href="#l23.159"></a><span id="l23.159"> </span>
<a href="#l23.160"></a><span id="l23.160" class="difflineminus">-var mfnListener =</span>
<a href="#l23.161"></a><span id="l23.161" class="difflineminus">-{</span>
<a href="#l23.162"></a><span id="l23.162" class="difflineminus">-  msgsDeleted: function msgsDeleted(aMsgArray)</span>
<a href="#l23.163"></a><span id="l23.163" class="difflineminus">-  {</span>
<a href="#l23.164"></a><span id="l23.164" class="difflineplus">+var mfnListener = {</span>
<a href="#l23.165"></a><span id="l23.165" class="difflineplus">+  msgsDeleted(aMsgArray) {</span>
<a href="#l23.166"></a><span id="l23.166">     dump(&quot;msg deleted\n&quot;);</span>
<a href="#l23.167"></a><span id="l23.167">     async_driver();</span>
<a href="#l23.168"></a><span id="l23.168">   },</span>
<a href="#l23.169"></a><span id="l23.169"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapAuthMethods.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapAuthMethods.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -7,86 +7,92 @@</span>
<a href="#l24.4"></a><span id="l24.4">  * BUGS:</span>
<a href="#l24.5"></a><span id="l24.5">  * - cleanup after each test doesn't seem to work correctly. Effects:</span>
<a href="#l24.6"></a><span id="l24.6">  *    - one more &quot;lsub&quot; per test, e.g. &quot;capability&quot;, &quot;auth...&quot;, &quot;lsub&quot;, &quot;lsub&quot;, &quot;lsub&quot;, &quot;list&quot; in the 3. test.,</span>
<a href="#l24.7"></a><span id="l24.7">  *    - root folder check succeeds although login failed</span>
<a href="#l24.8"></a><span id="l24.8">  * - removeIncomingServer(..., true); (cleanup files) fails.</span>
<a href="#l24.9"></a><span id="l24.9">  */</span>
<a href="#l24.10"></a><span id="l24.10"> </span>
<a href="#l24.11"></a><span id="l24.11"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+/* import-globals-from ../../../test/resources/alertTestUtils.js */</span>
<a href="#l24.14"></a><span id="l24.14"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l24.15"></a><span id="l24.15"> </span>
<a href="#l24.16"></a><span id="l24.16" class="difflineminus">-//const kUsername = &quot;fred&quot;;</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineminus">-//const kPassword = &quot;wilma&quot;;</span>
<a href="#l24.18"></a><span id="l24.18" class="difflineplus">+// const kUsername = &quot;fred&quot;;</span>
<a href="#l24.19"></a><span id="l24.19" class="difflineplus">+// const kPassword = &quot;wilma&quot;;</span>
<a href="#l24.20"></a><span id="l24.20"> </span>
<a href="#l24.21"></a><span id="l24.21"> var thisTest;</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineminus">-var test = null;</span>
<a href="#l24.23"></a><span id="l24.23"> </span>
<a href="#l24.24"></a><span id="l24.24"> var tests = [</span>
<a href="#l24.25"></a><span id="l24.25" class="difflineminus">-  { title: &quot;Cleartext password, with server only supporting old-style login&quot;,</span>
<a href="#l24.26"></a><span id="l24.26" class="difflineminus">-    clientAuthMethod : Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l24.27"></a><span id="l24.27" class="difflineminus">-    serverAuthMethods : [],</span>
<a href="#l24.28"></a><span id="l24.28" class="difflineminus">-    expectSuccess : true,</span>
<a href="#l24.29"></a><span id="l24.29" class="difflineminus">-    transaction: [ &quot;capability&quot;, &quot;login&quot;, &quot;lsub&quot; ] },</span>
<a href="#l24.30"></a><span id="l24.30" class="difflineminus">-  // Just to make sure we clean up properly - in the test and in TB, e.g. don't cache stuff</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineminus">-  { title: &quot;Second time Cleartext password, with server only supporting old-style login&quot;,</span>
<a href="#l24.32"></a><span id="l24.32" class="difflineminus">-    clientAuthMethod : Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l24.33"></a><span id="l24.33" class="difflineminus">-    serverAuthMethods : [],</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineminus">-    expectSuccess : true,</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineminus">-    transaction: [ &quot;capability&quot;, &quot;login&quot;, &quot;lsub&quot; ] },</span>
<a href="#l24.36"></a><span id="l24.36" class="difflineminus">- { title: &quot;Cleartext password, with server supporting AUTH PLAIN, LOGIN and CRAM&quot;,</span>
<a href="#l24.37"></a><span id="l24.37" class="difflineminus">-    clientAuthMethod : Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l24.38"></a><span id="l24.38" class="difflineminus">-    serverAuthMethods : [ &quot;PLAIN&quot;, &quot;LOGIN&quot;, &quot;CRAM-MD5&quot; ],</span>
<a href="#l24.39"></a><span id="l24.39" class="difflineminus">-    expectSuccess : true,</span>
<a href="#l24.40"></a><span id="l24.40" class="difflineminus">-    transaction: [ &quot;capability&quot;, &quot;authenticate PLAIN&quot;, &quot;lsub&quot; ] },</span>
<a href="#l24.41"></a><span id="l24.41" class="difflineminus">-  { title: &quot;Cleartext password, with server supporting only AUTH LOGIN&quot;,</span>
<a href="#l24.42"></a><span id="l24.42" class="difflineminus">-    clientAuthMethod : Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l24.43"></a><span id="l24.43" class="difflineminus">-    serverAuthMethods : [ &quot;LOGIN&quot; ],</span>
<a href="#l24.44"></a><span id="l24.44" class="difflineminus">-    expectSuccess : true,</span>
<a href="#l24.45"></a><span id="l24.45" class="difflineminus">-    transaction: [ &quot;capability&quot;, &quot;authenticate LOGIN&quot;, &quot;lsub&quot; ] },</span>
<a href="#l24.46"></a><span id="l24.46" class="difflineminus">-  { title: &quot;Encrypted password, with server supporting PLAIN and CRAM&quot;,</span>
<a href="#l24.47"></a><span id="l24.47" class="difflineminus">-    clientAuthMethod : Ci.nsMsgAuthMethod.passwordEncrypted,</span>
<a href="#l24.48"></a><span id="l24.48" class="difflineminus">-    serverAuthMethods : [ &quot;PLAIN&quot;, &quot;LOGIN&quot;, &quot;CRAM-MD5&quot; ],</span>
<a href="#l24.49"></a><span id="l24.49" class="difflineminus">-    expectSuccess : true,</span>
<a href="#l24.50"></a><span id="l24.50" class="difflineminus">-    transaction: [ &quot;capability&quot;, &quot;authenticate CRAM-MD5&quot;, &quot;lsub&quot; ] },</span>
<a href="#l24.51"></a><span id="l24.51" class="difflineminus">-  { title: &quot;Encrypted password, with server only supporting AUTH PLAIN and LOGIN (must fail)&quot;,</span>
<a href="#l24.52"></a><span id="l24.52" class="difflineminus">-    clientAuthMethod : Ci.nsMsgAuthMethod.passwordEncrypted,</span>
<a href="#l24.53"></a><span id="l24.53" class="difflineminus">-    serverAuthMethods : [ &quot;PLAIN&quot;, &quot;LOGIN&quot; ],</span>
<a href="#l24.54"></a><span id="l24.54" class="difflineminus">-    expectSuccess : false,</span>
<a href="#l24.55"></a><span id="l24.55" class="difflineminus">-    transaction: [ &quot;capability&quot; ] },</span>
<a href="#l24.56"></a><span id="l24.56" class="difflineminus">-  { title: &quot;Any secure method, with server supporting AUTH PLAIN and CRAM&quot;,</span>
<a href="#l24.57"></a><span id="l24.57" class="difflineminus">-    clientAuthMethod : Ci.nsMsgAuthMethod.secure,</span>
<a href="#l24.58"></a><span id="l24.58" class="difflineminus">-    serverAuthMethods : [ &quot;PLAIN&quot; , &quot;LOGIN&quot;, &quot;CRAM-MD5&quot; ],</span>
<a href="#l24.59"></a><span id="l24.59" class="difflineminus">-    expectSuccess : true,</span>
<a href="#l24.60"></a><span id="l24.60" class="difflineminus">-    transaction: [ &quot;capability&quot;, &quot;authenticate CRAM-MD5&quot;, &quot;lsub&quot; ] },</span>
<a href="#l24.61"></a><span id="l24.61" class="difflineminus">-  { title: &quot;Any secure method, with server only supporting AUTH PLAIN and LOGIN (must fail)&quot;,</span>
<a href="#l24.62"></a><span id="l24.62" class="difflineminus">-    clientAuthMethod : Ci.nsMsgAuthMethod.secure,</span>
<a href="#l24.63"></a><span id="l24.63" class="difflineminus">-    serverAuthMethods : [ &quot;PLAIN&quot; ],</span>
<a href="#l24.64"></a><span id="l24.64" class="difflineminus">-    expectSuccess : false,</span>
<a href="#l24.65"></a><span id="l24.65" class="difflineminus">-    transaction: [ &quot;capability&quot; ] },</span>
<a href="#l24.66"></a><span id="l24.66" class="difflineplus">+  {</span>
<a href="#l24.67"></a><span id="l24.67" class="difflineplus">+    title: &quot;Cleartext password, with server only supporting old-style login&quot;,</span>
<a href="#l24.68"></a><span id="l24.68" class="difflineplus">+    clientAuthMethod: Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l24.69"></a><span id="l24.69" class="difflineplus">+    serverAuthMethods: [],</span>
<a href="#l24.70"></a><span id="l24.70" class="difflineplus">+    expectSuccess: true,</span>
<a href="#l24.71"></a><span id="l24.71" class="difflineplus">+    transaction: [ &quot;capability&quot;, &quot;login&quot;, &quot;lsub&quot; ],</span>
<a href="#l24.72"></a><span id="l24.72" class="difflineplus">+  }, {</span>
<a href="#l24.73"></a><span id="l24.73" class="difflineplus">+    // Just to make sure we clean up properly - in the test and in TB, e.g. don't cache stuff</span>
<a href="#l24.74"></a><span id="l24.74" class="difflineplus">+    title: &quot;Second time Cleartext password, with server only supporting old-style login&quot;,</span>
<a href="#l24.75"></a><span id="l24.75" class="difflineplus">+    clientAuthMethod: Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l24.76"></a><span id="l24.76" class="difflineplus">+    serverAuthMethods: [],</span>
<a href="#l24.77"></a><span id="l24.77" class="difflineplus">+    expectSuccess: true,</span>
<a href="#l24.78"></a><span id="l24.78" class="difflineplus">+    transaction: [ &quot;capability&quot;, &quot;login&quot;, &quot;lsub&quot; ],</span>
<a href="#l24.79"></a><span id="l24.79" class="difflineplus">+  }, {</span>
<a href="#l24.80"></a><span id="l24.80" class="difflineplus">+    title: &quot;Cleartext password, with server supporting AUTH PLAIN, LOGIN and CRAM&quot;,</span>
<a href="#l24.81"></a><span id="l24.81" class="difflineplus">+    clientAuthMethod: Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l24.82"></a><span id="l24.82" class="difflineplus">+    serverAuthMethods: [ &quot;PLAIN&quot;, &quot;LOGIN&quot;, &quot;CRAM-MD5&quot; ],</span>
<a href="#l24.83"></a><span id="l24.83" class="difflineplus">+    expectSuccess: true,</span>
<a href="#l24.84"></a><span id="l24.84" class="difflineplus">+    transaction: [ &quot;capability&quot;, &quot;authenticate PLAIN&quot;, &quot;lsub&quot; ],</span>
<a href="#l24.85"></a><span id="l24.85" class="difflineplus">+  }, {</span>
<a href="#l24.86"></a><span id="l24.86" class="difflineplus">+    title: &quot;Cleartext password, with server supporting only AUTH LOGIN&quot;,</span>
<a href="#l24.87"></a><span id="l24.87" class="difflineplus">+    clientAuthMethod: Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l24.88"></a><span id="l24.88" class="difflineplus">+    serverAuthMethods: [ &quot;LOGIN&quot; ],</span>
<a href="#l24.89"></a><span id="l24.89" class="difflineplus">+    expectSuccess: true,</span>
<a href="#l24.90"></a><span id="l24.90" class="difflineplus">+    transaction: [ &quot;capability&quot;, &quot;authenticate LOGIN&quot;, &quot;lsub&quot; ],</span>
<a href="#l24.91"></a><span id="l24.91" class="difflineplus">+  }, {</span>
<a href="#l24.92"></a><span id="l24.92" class="difflineplus">+    title: &quot;Encrypted password, with server supporting PLAIN and CRAM&quot;,</span>
<a href="#l24.93"></a><span id="l24.93" class="difflineplus">+    clientAuthMethod: Ci.nsMsgAuthMethod.passwordEncrypted,</span>
<a href="#l24.94"></a><span id="l24.94" class="difflineplus">+    serverAuthMethods: [ &quot;PLAIN&quot;, &quot;LOGIN&quot;, &quot;CRAM-MD5&quot; ],</span>
<a href="#l24.95"></a><span id="l24.95" class="difflineplus">+    expectSuccess: true,</span>
<a href="#l24.96"></a><span id="l24.96" class="difflineplus">+    transaction: [ &quot;capability&quot;, &quot;authenticate CRAM-MD5&quot;, &quot;lsub&quot; ],</span>
<a href="#l24.97"></a><span id="l24.97" class="difflineplus">+  }, {</span>
<a href="#l24.98"></a><span id="l24.98" class="difflineplus">+    title: &quot;Encrypted password, with server only supporting AUTH PLAIN and LOGIN (must fail)&quot;,</span>
<a href="#l24.99"></a><span id="l24.99" class="difflineplus">+    clientAuthMethod: Ci.nsMsgAuthMethod.passwordEncrypted,</span>
<a href="#l24.100"></a><span id="l24.100" class="difflineplus">+    serverAuthMethods: [ &quot;PLAIN&quot;, &quot;LOGIN&quot; ],</span>
<a href="#l24.101"></a><span id="l24.101" class="difflineplus">+    expectSuccess: false,</span>
<a href="#l24.102"></a><span id="l24.102" class="difflineplus">+    transaction: [ &quot;capability&quot; ],</span>
<a href="#l24.103"></a><span id="l24.103" class="difflineplus">+  }, {</span>
<a href="#l24.104"></a><span id="l24.104" class="difflineplus">+    title: &quot;Any secure method, with server supporting AUTH PLAIN and CRAM&quot;,</span>
<a href="#l24.105"></a><span id="l24.105" class="difflineplus">+    clientAuthMethod: Ci.nsMsgAuthMethod.secure,</span>
<a href="#l24.106"></a><span id="l24.106" class="difflineplus">+    serverAuthMethods: [ &quot;PLAIN&quot;, &quot;LOGIN&quot;, &quot;CRAM-MD5&quot; ],</span>
<a href="#l24.107"></a><span id="l24.107" class="difflineplus">+    expectSuccess: true,</span>
<a href="#l24.108"></a><span id="l24.108" class="difflineplus">+    transaction: [ &quot;capability&quot;, &quot;authenticate CRAM-MD5&quot;, &quot;lsub&quot; ],</span>
<a href="#l24.109"></a><span id="l24.109" class="difflineplus">+  }, {</span>
<a href="#l24.110"></a><span id="l24.110" class="difflineplus">+    title: &quot;Any secure method, with server only supporting AUTH PLAIN and LOGIN (must fail)&quot;,</span>
<a href="#l24.111"></a><span id="l24.111" class="difflineplus">+    clientAuthMethod: Ci.nsMsgAuthMethod.secure,</span>
<a href="#l24.112"></a><span id="l24.112" class="difflineplus">+    serverAuthMethods: [ &quot;PLAIN&quot; ],</span>
<a href="#l24.113"></a><span id="l24.113" class="difflineplus">+    expectSuccess: false,</span>
<a href="#l24.114"></a><span id="l24.114" class="difflineplus">+    transaction: [ &quot;capability&quot; ],</span>
<a href="#l24.115"></a><span id="l24.115" class="difflineplus">+  },</span>
<a href="#l24.116"></a><span id="l24.116"> ];</span>
<a href="#l24.117"></a><span id="l24.117"> </span>
<a href="#l24.118"></a><span id="l24.118"> function nextTest() {</span>
<a href="#l24.119"></a><span id="l24.119">   try {</span>
<a href="#l24.120"></a><span id="l24.120">     thisTest = tests.shift();</span>
<a href="#l24.121"></a><span id="l24.121" class="difflineminus">-    if (!thisTest)</span>
<a href="#l24.122"></a><span id="l24.122" class="difflineminus">-    {</span>
<a href="#l24.123"></a><span id="l24.123" class="difflineplus">+    if (!thisTest) {</span>
<a href="#l24.124"></a><span id="l24.124">         endTest();</span>
<a href="#l24.125"></a><span id="l24.125">         return;</span>
<a href="#l24.126"></a><span id="l24.126">     }</span>
<a href="#l24.127"></a><span id="l24.127">     /* doesn't work, hangs on first performTest(...)</span>
<a href="#l24.128"></a><span id="l24.128">     {</span>
<a href="#l24.129"></a><span id="l24.129">       dump(&quot;resetTest()\n&quot;);</span>
<a href="#l24.130"></a><span id="l24.130">       server.resetTest();</span>
<a href="#l24.131"></a><span id="l24.131">       dump(&quot;server.performTest()\n&quot;);</span>
<a href="#l24.132"></a><span id="l24.132">       server.performTest();</span>
<a href="#l24.133"></a><span id="l24.133">     }*/</span>
<a href="#l24.134"></a><span id="l24.134"> </span>
<a href="#l24.135"></a><span id="l24.135" class="difflineminus">-    test = thisTest.title;</span>
<a href="#l24.136"></a><span id="l24.136">     dump(&quot;NEXT test: &quot; + thisTest.title + &quot;\n&quot;);</span>
<a href="#l24.137"></a><span id="l24.137"> </span>
<a href="#l24.138"></a><span id="l24.138">     // (re)create fake server</span>
<a href="#l24.139"></a><span id="l24.139">     var daemon = new imapDaemon();</span>
<a href="#l24.140"></a><span id="l24.140">     var server = makeServer(daemon, &quot;&quot;,</span>
<a href="#l24.141"></a><span id="l24.141">       {kAuthSchemes: thisTest.serverAuthMethods});</span>
<a href="#l24.142"></a><span id="l24.142">     server.setDebugLevel(fsDebugAll);</span>
<a href="#l24.143"></a><span id="l24.143"> </span>
<a href="#l24.144"></a><span id="l24.144" class="difflineat">@@ -96,50 +102,49 @@ function nextTest() {</span>
<a href="#l24.145"></a><span id="l24.145">     let msgServer = incomingServer;</span>
<a href="#l24.146"></a><span id="l24.146">     msgServer.QueryInterface(Ci.nsIMsgIncomingServer);</span>
<a href="#l24.147"></a><span id="l24.147">     msgServer.authMethod = thisTest.clientAuthMethod;</span>
<a href="#l24.148"></a><span id="l24.148"> </span>
<a href="#l24.149"></a><span id="l24.149">     // connect</span>
<a href="#l24.150"></a><span id="l24.150">     incomingServer.performExpand(null);</span>
<a href="#l24.151"></a><span id="l24.151">     server.performTest(&quot;LSUB&quot;);</span>
<a href="#l24.152"></a><span id="l24.152"> </span>
<a href="#l24.153"></a><span id="l24.153" class="difflineminus">-    dump(&quot;should &quot; + (thisTest.expectSuccess ? &quot;&quot;:&quot;not &quot;) + &quot;be logged in\n&quot;);</span>
<a href="#l24.154"></a><span id="l24.154" class="difflineplus">+    dump(&quot;should &quot; + (thisTest.expectSuccess ? &quot;&quot; : &quot;not &quot;) + &quot;be logged in\n&quot;);</span>
<a href="#l24.155"></a><span id="l24.155">     Assert.equal(true, incomingServer instanceof Ci.nsIImapServerSink);</span>
<a href="#l24.156"></a><span id="l24.156" class="difflineminus">-    //do_check_eq(thisTest.expectSuccess, incomingServer.userAuthenticated); TODO fails second time</span>
<a href="#l24.157"></a><span id="l24.157" class="difflineminus">-    //var rootFolder = incomingServer.rootFolder;</span>
<a href="#l24.158"></a><span id="l24.158" class="difflineplus">+    // do_check_eq(thisTest.expectSuccess, incomingServer.userAuthenticated); TODO fails second time</span>
<a href="#l24.159"></a><span id="l24.159" class="difflineplus">+    // var rootFolder = incomingServer.rootFolder;</span>
<a href="#l24.160"></a><span id="l24.160">     // Client creates fake Inbox, so check other folder</span>
<a href="#l24.161"></a><span id="l24.161" class="difflineminus">-    //do_check_eq(thisTest.expectSuccess,</span>
<a href="#l24.162"></a><span id="l24.162" class="difflineplus">+    // do_check_eq(thisTest.expectSuccess,</span>
<a href="#l24.163"></a><span id="l24.163">     //    rootFolder.containsChildNamed(&quot;somemailbox&quot;)); TODO</span>
<a href="#l24.164"></a><span id="l24.164">     do_check_transaction(server.playTransaction(), thisTest.transaction, false);</span>
<a href="#l24.165"></a><span id="l24.165"> </span>
<a href="#l24.166"></a><span id="l24.166">     do {</span>
<a href="#l24.167"></a><span id="l24.167">       incomingServer.closeCachedConnections();</span>
<a href="#l24.168"></a><span id="l24.168" class="difflineminus">-    } while (incomingServer.serverBusy)</span>
<a href="#l24.169"></a><span id="l24.169" class="difflineplus">+    } while (incomingServer.serverBusy);</span>
<a href="#l24.170"></a><span id="l24.170">     incomingServer.shutdown();</span>
<a href="#l24.171"></a><span id="l24.171">     incomingServer.clearAllValues();</span>
<a href="#l24.172"></a><span id="l24.172">     deleteIMAPServer(incomingServer);</span>
<a href="#l24.173"></a><span id="l24.173">     MailServices.accounts.closeCachedConnections();</span>
<a href="#l24.174"></a><span id="l24.174">     MailServices.accounts.shutdownServers();</span>
<a href="#l24.175"></a><span id="l24.175">     MailServices.accounts.UnloadAccounts();</span>
<a href="#l24.176"></a><span id="l24.176">     server.stop();</span>
<a href="#l24.177"></a><span id="l24.177" class="difflineminus">-</span>
<a href="#l24.178"></a><span id="l24.178">   } catch (e) {</span>
<a href="#l24.179"></a><span id="l24.179" class="difflineminus">-    //server.stop();</span>
<a href="#l24.180"></a><span id="l24.180" class="difflineminus">-    //endTest();</span>
<a href="#l24.181"></a><span id="l24.181" class="difflineplus">+    // server.stop();</span>
<a href="#l24.182"></a><span id="l24.182" class="difflineplus">+    // endTest();</span>
<a href="#l24.183"></a><span id="l24.183">     do_throw(e);</span>
<a href="#l24.184"></a><span id="l24.184">   }</span>
<a href="#l24.185"></a><span id="l24.185"> </span>
<a href="#l24.186"></a><span id="l24.186">   nextTest();</span>
<a href="#l24.187"></a><span id="l24.187"> }</span>
<a href="#l24.188"></a><span id="l24.188"> </span>
<a href="#l24.189"></a><span id="l24.189"> function deleteIMAPServer(incomingServer) {</span>
<a href="#l24.190"></a><span id="l24.190">   if (!incomingServer)</span>
<a href="#l24.191"></a><span id="l24.191">     return;</span>
<a href="#l24.192"></a><span id="l24.192">   MailServices.accounts.removeIncomingServer(incomingServer, false); // TODO cleanup files = true fails</span>
<a href="#l24.193"></a><span id="l24.193" class="difflineminus">-  //incomingServer = null;</span>
<a href="#l24.194"></a><span id="l24.194" class="difflineplus">+  // incomingServer = null;</span>
<a href="#l24.195"></a><span id="l24.195">   MailServices.accounts.removeAccount(MailServices.accounts.defaultAccount);</span>
<a href="#l24.196"></a><span id="l24.196"> }</span>
<a href="#l24.197"></a><span id="l24.197"> </span>
<a href="#l24.198"></a><span id="l24.198"> </span>
<a href="#l24.199"></a><span id="l24.199"> function run_test() {</span>
<a href="#l24.200"></a><span id="l24.200">   do_test_pending();</span>
<a href="#l24.201"></a><span id="l24.201"> </span>
<a href="#l24.202"></a><span id="l24.202">   registerAlertTestUtils();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapAutoSync.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapAutoSync.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -13,267 +13,257 @@</span>
<a href="#l25.4"></a><span id="l25.4"> </span>
<a href="#l25.5"></a><span id="l25.5"> // We test that checking non-inbox folders for new messages isn't</span>
<a href="#l25.6"></a><span id="l25.6"> // interfering with autoSync's detection of new messages.</span>
<a href="#l25.7"></a><span id="l25.7"> </span>
<a href="#l25.8"></a><span id="l25.8"> // We also test that folders that have messages added to them via move/copy</span>
<a href="#l25.9"></a><span id="l25.9"> // get put in the front of the queue.</span>
<a href="#l25.10"></a><span id="l25.10"> </span>
<a href="#l25.11"></a><span id="l25.11"> // IMAP pump</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l25.13"></a><span id="l25.13"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l25.14"></a><span id="l25.14"> </span>
<a href="#l25.15"></a><span id="l25.15" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l25.16"></a><span id="l25.16"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l25.17"></a><span id="l25.17"> </span>
<a href="#l25.18"></a><span id="l25.18" class="difflineplus">+/* import-globals-from ../../../test/resources/alertTestUtils.js */</span>
<a href="#l25.19"></a><span id="l25.19" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l25.20"></a><span id="l25.20"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l25.21"></a><span id="l25.21"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l25.22"></a><span id="l25.22"> </span>
<a href="#l25.23"></a><span id="l25.23"> // Globals</span>
<a href="#l25.24"></a><span id="l25.24"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l25.25"></a><span id="l25.25"> </span>
<a href="#l25.26"></a><span id="l25.26"> setupIMAPPump();</span>
<a href="#l25.27"></a><span id="l25.27"> </span>
<a href="#l25.28"></a><span id="l25.28"> var msgFlagOffline = Ci.nsMsgMessageFlags.Offline;</span>
<a href="#l25.29"></a><span id="l25.29"> var nsIAutoSyncMgrListener = Ci.nsIAutoSyncMgrListener;</span>
<a href="#l25.30"></a><span id="l25.30"> </span>
<a href="#l25.31"></a><span id="l25.31" class="difflineminus">-var gGotAlert;</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineminus">-</span>
<a href="#l25.33"></a><span id="l25.33"> var gAutoSyncManager = Cc[&quot;@mozilla.org/imap/autosyncmgr;1&quot;]</span>
<a href="#l25.34"></a><span id="l25.34">                        .getService(Ci.nsIAutoSyncManager);</span>
<a href="#l25.35"></a><span id="l25.35"> </span>
<a href="#l25.36"></a><span id="l25.36"> // Definition of tests</span>
<a href="#l25.37"></a><span id="l25.37"> var tests = [</span>
<a href="#l25.38"></a><span id="l25.38">   test_createTargetFolder,</span>
<a href="#l25.39"></a><span id="l25.39">   test_checkForNewMessages,</span>
<a href="#l25.40"></a><span id="l25.40">   test_triggerAutoSyncIdle,</span>
<a href="#l25.41"></a><span id="l25.41">   test_moveMessageToTargetFolder,</span>
<a href="#l25.42"></a><span id="l25.42">   test_waitForTargetUpdate,</span>
<a href="#l25.43"></a><span id="l25.43" class="difflineminus">-  endTest</span>
<a href="#l25.44"></a><span id="l25.44" class="difflineminus">-]</span>
<a href="#l25.45"></a><span id="l25.45" class="difflineplus">+  endTest,</span>
<a href="#l25.46"></a><span id="l25.46" class="difflineplus">+];</span>
<a href="#l25.47"></a><span id="l25.47"> </span>
<a href="#l25.48"></a><span id="l25.48"> var gTargetFolder;</span>
<a href="#l25.49"></a><span id="l25.49"> </span>
<a href="#l25.50"></a><span id="l25.50" class="difflineminus">-function* test_createTargetFolder()</span>
<a href="#l25.51"></a><span id="l25.51" class="difflineminus">-{</span>
<a href="#l25.52"></a><span id="l25.52" class="difflineplus">+function* test_createTargetFolder() {</span>
<a href="#l25.53"></a><span id="l25.53">   gAutoSyncManager.addListener(gAutoSyncListener);</span>
<a href="#l25.54"></a><span id="l25.54"> </span>
<a href="#l25.55"></a><span id="l25.55">   IMAPPump.incomingServer.rootFolder.createSubfolder(&quot;targetFolder&quot;, null);</span>
<a href="#l25.56"></a><span id="l25.56">   yield false;</span>
<a href="#l25.57"></a><span id="l25.57">   gTargetFolder = IMAPPump.incomingServer.rootFolder.getChildNamed(&quot;targetFolder&quot;);</span>
<a href="#l25.58"></a><span id="l25.58">   Assert.ok(gTargetFolder instanceof Ci.nsIMsgImapMailFolder);</span>
<a href="#l25.59"></a><span id="l25.59">   // set folder to be checked for new messages when inbox is checked.</span>
<a href="#l25.60"></a><span id="l25.60">   gTargetFolder.setFlag(Ci.nsMsgFolderFlags.CheckNew);</span>
<a href="#l25.61"></a><span id="l25.61"> }</span>
<a href="#l25.62"></a><span id="l25.62"> </span>
<a href="#l25.63"></a><span id="l25.63" class="difflineminus">-function* test_checkForNewMessages()</span>
<a href="#l25.64"></a><span id="l25.64" class="difflineminus">-{</span>
<a href="#l25.65"></a><span id="l25.65" class="difflineplus">+function* test_checkForNewMessages() {</span>
<a href="#l25.66"></a><span id="l25.66">   addMessageToFolder(gTargetFolder);</span>
<a href="#l25.67"></a><span id="l25.67">   // This will update the INBOX and STATUS targetFolder. We only care about</span>
<a href="#l25.68"></a><span id="l25.68">   // the latter.</span>
<a href="#l25.69"></a><span id="l25.69">   IMAPPump.inbox.getNewMessages(null, null);</span>
<a href="#l25.70"></a><span id="l25.70">   IMAPPump.server.performTest(&quot;STATUS&quot;);</span>
<a href="#l25.71"></a><span id="l25.71">   // Now we'd like to make autosync update folders it knows about, to</span>
<a href="#l25.72"></a><span id="l25.72">   // get the initial autosync out of the way.</span>
<a href="#l25.73"></a><span id="l25.73">   yield true;</span>
<a href="#l25.74"></a><span id="l25.74"> }</span>
<a href="#l25.75"></a><span id="l25.75"> </span>
<a href="#l25.76"></a><span id="l25.76" class="difflineminus">-function test_triggerAutoSyncIdle()</span>
<a href="#l25.77"></a><span id="l25.77" class="difflineminus">-{</span>
<a href="#l25.78"></a><span id="l25.78" class="difflineplus">+function test_triggerAutoSyncIdle() {</span>
<a href="#l25.79"></a><span id="l25.79">   // wait for both folders to get updated.</span>
<a href="#l25.80"></a><span id="l25.80">   gAutoSyncListener._waitingForDiscoveryList.push(IMAPPump.inbox);</span>
<a href="#l25.81"></a><span id="l25.81">   gAutoSyncListener._waitingForDiscoveryList.push(gTargetFolder);</span>
<a href="#l25.82"></a><span id="l25.82">   gAutoSyncListener._waitingForDiscovery = true;</span>
<a href="#l25.83"></a><span id="l25.83">   let observer = gAutoSyncManager.QueryInterface(Ci.nsIObserver);</span>
<a href="#l25.84"></a><span id="l25.84">   observer.observe(null, &quot;mail-startup-done&quot;, &quot;&quot;);</span>
<a href="#l25.85"></a><span id="l25.85">   observer.observe(null, &quot;mail:appIdle&quot;, &quot;idle&quot;);</span>
<a href="#l25.86"></a><span id="l25.86"> }</span>
<a href="#l25.87"></a><span id="l25.87"> </span>
<a href="#l25.88"></a><span id="l25.88"> // move the message to a diffent folder</span>
<a href="#l25.89"></a><span id="l25.89" class="difflineminus">-function* test_moveMessageToTargetFolder()</span>
<a href="#l25.90"></a><span id="l25.90" class="difflineminus">-{</span>
<a href="#l25.91"></a><span id="l25.91" class="difflineplus">+function* test_moveMessageToTargetFolder() {</span>
<a href="#l25.92"></a><span id="l25.92">   let observer = gAutoSyncManager.QueryInterface(Ci.nsIObserver);</span>
<a href="#l25.93"></a><span id="l25.93">   observer.observe(null, &quot;mail:appIdle&quot;, &quot;back&quot;);</span>
<a href="#l25.94"></a><span id="l25.94">   let msgHdr = mailTestUtils.firstMsgHdr(IMAPPump.inbox);</span>
<a href="#l25.95"></a><span id="l25.95">   Assert.ok(msgHdr !== null);</span>
<a href="#l25.96"></a><span id="l25.96"> </span>
<a href="#l25.97"></a><span id="l25.97">   // Now move this message to the target folder.</span>
<a href="#l25.98"></a><span id="l25.98">   let messages = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l25.99"></a><span id="l25.99">                    .createInstance(Ci.nsIMutableArray);</span>
<a href="#l25.100"></a><span id="l25.100">   messages.appendElement(msgHdr);</span>
<a href="#l25.101"></a><span id="l25.101">   MailServices.copy.CopyMessages(IMAPPump.inbox, messages, gTargetFolder, true,</span>
<a href="#l25.102"></a><span id="l25.102">                                  asyncCopyListener, null, false);</span>
<a href="#l25.103"></a><span id="l25.103">   yield false;</span>
<a href="#l25.104"></a><span id="l25.104"> }</span>
<a href="#l25.105"></a><span id="l25.105"> </span>
<a href="#l25.106"></a><span id="l25.106" class="difflineminus">-function* test_waitForTargetUpdate()</span>
<a href="#l25.107"></a><span id="l25.107" class="difflineminus">-{</span>
<a href="#l25.108"></a><span id="l25.108" class="difflineplus">+function* test_waitForTargetUpdate() {</span>
<a href="#l25.109"></a><span id="l25.109">   // After the copy, now we expect to get notified of the gTargetFolder</span>
<a href="#l25.110"></a><span id="l25.110">   // getting updated, after we simulate going idle.</span>
<a href="#l25.111"></a><span id="l25.111">   gAutoSyncListener._waitingForUpdate = true;</span>
<a href="#l25.112"></a><span id="l25.112">   gAutoSyncListener._waitingForUpdateList.push(gTargetFolder);</span>
<a href="#l25.113"></a><span id="l25.113">   gAutoSyncManager.QueryInterface(Ci.nsIObserver).observe(null, &quot;mail:appIdle&quot;,</span>
<a href="#l25.114"></a><span id="l25.114">                                                           &quot;idle&quot;);</span>
<a href="#l25.115"></a><span id="l25.115">   // Need two yield here to get results of both onDownloadCompleted and onDiscoveryQProcessed</span>
<a href="#l25.116"></a><span id="l25.116">   yield false;</span>
<a href="#l25.117"></a><span id="l25.117">   yield false;</span>
<a href="#l25.118"></a><span id="l25.118"> }</span>
<a href="#l25.119"></a><span id="l25.119"> </span>
<a href="#l25.120"></a><span id="l25.120"> // Cleanup</span>
<a href="#l25.121"></a><span id="l25.121" class="difflineminus">-function endTest()</span>
<a href="#l25.122"></a><span id="l25.122" class="difflineminus">-{</span>
<a href="#l25.123"></a><span id="l25.123" class="difflineplus">+function endTest() {</span>
<a href="#l25.124"></a><span id="l25.124">   let enumerator = gTargetFolder.messages;</span>
<a href="#l25.125"></a><span id="l25.125">   let numMsgs = 0;</span>
<a href="#l25.126"></a><span id="l25.126">   while (enumerator.hasMoreElements()) {</span>
<a href="#l25.127"></a><span id="l25.127">     numMsgs++;</span>
<a href="#l25.128"></a><span id="l25.128">     Assert.notEqual(enumerator.getNext()</span>
<a href="#l25.129"></a><span id="l25.129">                      .QueryInterface(Ci.nsIMsgDBHdr).flags &amp; msgFlagOffline, 0);</span>
<a href="#l25.130"></a><span id="l25.130">   }</span>
<a href="#l25.131"></a><span id="l25.131">   Assert.equal(2, numMsgs);</span>
<a href="#l25.132"></a><span id="l25.132">   Assert.equal(gAutoSyncListener._waitingForUpdateList.length, 0);</span>
<a href="#l25.133"></a><span id="l25.133">   Assert.ok(!gAutoSyncListener._waitingForDiscovery);</span>
<a href="#l25.134"></a><span id="l25.134">   Assert.ok(!gAutoSyncListener._waitingForUpdate);</span>
<a href="#l25.135"></a><span id="l25.135">   teardownIMAPPump();</span>
<a href="#l25.136"></a><span id="l25.136"> }</span>
<a href="#l25.137"></a><span id="l25.137"> </span>
<a href="#l25.138"></a><span id="l25.138" class="difflineminus">-function run_test()</span>
<a href="#l25.139"></a><span id="l25.139" class="difflineminus">-{</span>
<a href="#l25.140"></a><span id="l25.140" class="difflineplus">+function run_test() {</span>
<a href="#l25.141"></a><span id="l25.141">   // Add folder listeners that will capture async events</span>
<a href="#l25.142"></a><span id="l25.142">   const nsIMFNService = Ci.nsIMsgFolderNotificationService;</span>
<a href="#l25.143"></a><span id="l25.143">   let flags =</span>
<a href="#l25.144"></a><span id="l25.144">         nsIMFNService.folderAdded |</span>
<a href="#l25.145"></a><span id="l25.145">         nsIMFNService.msgsMoveCopyCompleted |</span>
<a href="#l25.146"></a><span id="l25.146">         nsIMFNService.msgAdded;</span>
<a href="#l25.147"></a><span id="l25.147">   MailServices.mfn.addListener(mfnListener, flags);</span>
<a href="#l25.148"></a><span id="l25.148">   addMessageToFolder(IMAPPump.inbox);</span>
<a href="#l25.149"></a><span id="l25.149"> </span>
<a href="#l25.150"></a><span id="l25.150">   async_run_tests(tests);</span>
<a href="#l25.151"></a><span id="l25.151"> }</span>
<a href="#l25.152"></a><span id="l25.152"> </span>
<a href="#l25.153"></a><span id="l25.153"> // listeners for various events to drive the tests.</span>
<a href="#l25.154"></a><span id="l25.154"> </span>
<a href="#l25.155"></a><span id="l25.155" class="difflineminus">-var mfnListener =</span>
<a href="#l25.156"></a><span id="l25.156" class="difflineminus">-{</span>
<a href="#l25.157"></a><span id="l25.157" class="difflineminus">-  msgsMoveCopyCompleted: function (aMove, aSrcMsgs, aDestFolder, aDestMsgs)</span>
<a href="#l25.158"></a><span id="l25.158" class="difflineminus">-  {</span>
<a href="#l25.159"></a><span id="l25.159" class="difflineminus">-    dump('msgsMoveCopyCompleted to folder ' + aDestFolder.name + '\n');</span>
<a href="#l25.160"></a><span id="l25.160" class="difflineplus">+var mfnListener = {</span>
<a href="#l25.161"></a><span id="l25.161" class="difflineplus">+  msgsMoveCopyCompleted(aMove, aSrcMsgs, aDestFolder, aDestMsgs) {</span>
<a href="#l25.162"></a><span id="l25.162" class="difflineplus">+    dump(&quot;msgsMoveCopyCompleted to folder &quot; + aDestFolder.name + &quot;\n&quot;);</span>
<a href="#l25.163"></a><span id="l25.163">   },</span>
<a href="#l25.164"></a><span id="l25.164" class="difflineminus">-  folderAdded: function folderAdded(aFolder)</span>
<a href="#l25.165"></a><span id="l25.165" class="difflineminus">-  {</span>
<a href="#l25.166"></a><span id="l25.166" class="difflineplus">+  folderAdded(aFolder) {</span>
<a href="#l25.167"></a><span id="l25.167">     // we are only using async yield on the target folder add</span>
<a href="#l25.168"></a><span id="l25.168">     if (aFolder.name == &quot;targetFolder&quot;)</span>
<a href="#l25.169"></a><span id="l25.169">       async_driver();</span>
<a href="#l25.170"></a><span id="l25.170">   },</span>
<a href="#l25.171"></a><span id="l25.171"> </span>
<a href="#l25.172"></a><span id="l25.172" class="difflineminus">-  msgAdded: function msgAdded(aMsg)</span>
<a href="#l25.173"></a><span id="l25.173" class="difflineminus">-  {</span>
<a href="#l25.174"></a><span id="l25.174" class="difflineplus">+  msgAdded(aMsg) {</span>
<a href="#l25.175"></a><span id="l25.175">   },</span>
<a href="#l25.176"></a><span id="l25.176"> };</span>
<a href="#l25.177"></a><span id="l25.177"> </span>
<a href="#l25.178"></a><span id="l25.178" class="difflineminus">-var gAutoSyncListener =</span>
<a href="#l25.179"></a><span id="l25.179" class="difflineminus">-{</span>
<a href="#l25.180"></a><span id="l25.180" class="difflineminus">-  _inQFolderList : new Array(),</span>
<a href="#l25.181"></a><span id="l25.181" class="difflineminus">-  _runnning : false,</span>
<a href="#l25.182"></a><span id="l25.182" class="difflineplus">+var gAutoSyncListener = {</span>
<a href="#l25.183"></a><span id="l25.183" class="difflineplus">+  _inQFolderList: [],</span>
<a href="#l25.184"></a><span id="l25.184" class="difflineplus">+  _runnning: false,</span>
<a href="#l25.185"></a><span id="l25.185">   _lastMessage: {},</span>
<a href="#l25.186"></a><span id="l25.186" class="difflineminus">-  _waitingForUpdateList : new Array(),</span>
<a href="#l25.187"></a><span id="l25.187" class="difflineminus">-  _waitingForUpdate : false,</span>
<a href="#l25.188"></a><span id="l25.188" class="difflineminus">-  _waitingForDiscoveryList : new Array(),</span>
<a href="#l25.189"></a><span id="l25.189" class="difflineminus">-  _waitingForDiscovery : false,</span>
<a href="#l25.190"></a><span id="l25.190" class="difflineplus">+  _waitingForUpdateList: [],</span>
<a href="#l25.191"></a><span id="l25.191" class="difflineplus">+  _waitingForUpdate: false,</span>
<a href="#l25.192"></a><span id="l25.192" class="difflineplus">+  _waitingForDiscoveryList: [],</span>
<a href="#l25.193"></a><span id="l25.193" class="difflineplus">+  _waitingForDiscovery: false,</span>
<a href="#l25.194"></a><span id="l25.194"> </span>
<a href="#l25.195"></a><span id="l25.195" class="difflineminus">-  onStateChanged : function(running) {</span>
<a href="#l25.196"></a><span id="l25.196" class="difflineplus">+  onStateChanged(running) {</span>
<a href="#l25.197"></a><span id="l25.197">     try {</span>
<a href="#l25.198"></a><span id="l25.198">       this._runnning = running;</span>
<a href="#l25.199"></a><span id="l25.199">     } catch (e) {</span>
<a href="#l25.200"></a><span id="l25.200" class="difflineminus">-      throw(e);</span>
<a href="#l25.201"></a><span id="l25.201" class="difflineplus">+      throw (e);</span>
<a href="#l25.202"></a><span id="l25.202">     }</span>
<a href="#l25.203"></a><span id="l25.203">   },</span>
<a href="#l25.204"></a><span id="l25.204"> </span>
<a href="#l25.205"></a><span id="l25.205" class="difflineminus">-  onFolderAddedIntoQ : function(queue, folder) {</span>
<a href="#l25.206"></a><span id="l25.206" class="difflineplus">+  onFolderAddedIntoQ(queue, folder) {</span>
<a href="#l25.207"></a><span id="l25.207">     try {</span>
<a href="#l25.208"></a><span id="l25.208" class="difflineminus">-      let queueName = &quot;&quot;;</span>
<a href="#l25.209"></a><span id="l25.209">       dump(&quot;folder added into Q &quot; + this.qName(queue) + &quot; &quot; + folder.URI + &quot;\n&quot;);</span>
<a href="#l25.210"></a><span id="l25.210">       if (folder instanceof Ci.nsIMsgFolder &amp;&amp;</span>
<a href="#l25.211"></a><span id="l25.211">           queue == nsIAutoSyncMgrListener.PriorityQueue) {</span>
<a href="#l25.212"></a><span id="l25.212" class="difflineplus">+        return;</span>
<a href="#l25.213"></a><span id="l25.213">       }</span>
<a href="#l25.214"></a><span id="l25.214">     } catch (e) {</span>
<a href="#l25.215"></a><span id="l25.215" class="difflineminus">-      throw(e);</span>
<a href="#l25.216"></a><span id="l25.216" class="difflineplus">+      throw (e);</span>
<a href="#l25.217"></a><span id="l25.217">     }</span>
<a href="#l25.218"></a><span id="l25.218">   },</span>
<a href="#l25.219"></a><span id="l25.219" class="difflineminus">-  onFolderRemovedFromQ : function(queue, folder) {</span>
<a href="#l25.220"></a><span id="l25.220" class="difflineplus">+  onFolderRemovedFromQ(queue, folder) {</span>
<a href="#l25.221"></a><span id="l25.221">     try {</span>
<a href="#l25.222"></a><span id="l25.222">       dump(&quot;folder removed from Q &quot; + this.qName(queue) + &quot; &quot; + folder.URI + &quot;\n&quot;);</span>
<a href="#l25.223"></a><span id="l25.223">       if (folder instanceof Ci.nsIMsgFolder &amp;&amp;</span>
<a href="#l25.224"></a><span id="l25.224">           queue == nsIAutoSyncMgrListener.PriorityQueue) {</span>
<a href="#l25.225"></a><span id="l25.225" class="difflineplus">+        return;</span>
<a href="#l25.226"></a><span id="l25.226">       }</span>
<a href="#l25.227"></a><span id="l25.227">     } catch (e) {</span>
<a href="#l25.228"></a><span id="l25.228" class="difflineminus">-      throw(e);</span>
<a href="#l25.229"></a><span id="l25.229" class="difflineplus">+      throw (e);</span>
<a href="#l25.230"></a><span id="l25.230">     }</span>
<a href="#l25.231"></a><span id="l25.231">   },</span>
<a href="#l25.232"></a><span id="l25.232" class="difflineminus">-  onDownloadStarted : function(folder, numOfMessages, totalPending) {</span>
<a href="#l25.233"></a><span id="l25.233" class="difflineplus">+  onDownloadStarted(folder, numOfMessages, totalPending) {</span>
<a href="#l25.234"></a><span id="l25.234">     try {</span>
<a href="#l25.235"></a><span id="l25.235">       dump(&quot;folder download started&quot; + folder.URI + &quot;\n&quot;);</span>
<a href="#l25.236"></a><span id="l25.236">     } catch (e) {</span>
<a href="#l25.237"></a><span id="l25.237" class="difflineminus">-      throw(e);</span>
<a href="#l25.238"></a><span id="l25.238" class="difflineplus">+      throw (e);</span>
<a href="#l25.239"></a><span id="l25.239">     }</span>
<a href="#l25.240"></a><span id="l25.240">   },</span>
<a href="#l25.241"></a><span id="l25.241"> </span>
<a href="#l25.242"></a><span id="l25.242" class="difflineminus">-  onDownloadCompleted : function(folder) {</span>
<a href="#l25.243"></a><span id="l25.243" class="difflineplus">+  onDownloadCompleted(folder) {</span>
<a href="#l25.244"></a><span id="l25.244">     try {</span>
<a href="#l25.245"></a><span id="l25.245">       dump(&quot;folder download completed&quot; + folder.URI + &quot;\n&quot;);</span>
<a href="#l25.246"></a><span id="l25.246">       if (folder instanceof Ci.nsIMsgFolder) {</span>
<a href="#l25.247"></a><span id="l25.247">         let index = mailTestUtils.non_strict_index_of(this._waitingForUpdateList, folder);</span>
<a href="#l25.248"></a><span id="l25.248">         if (index != -1)</span>
<a href="#l25.249"></a><span id="l25.249">           this._waitingForUpdateList.splice(index, 1);</span>
<a href="#l25.250"></a><span id="l25.250">         if (this._waitingForUpdate &amp;&amp; this._waitingForUpdateList.length == 0) {</span>
<a href="#l25.251"></a><span id="l25.251">           dump(&quot;got last folder update looking for\n&quot;);</span>
<a href="#l25.252"></a><span id="l25.252">           this._waitingForUpdate = false;</span>
<a href="#l25.253"></a><span id="l25.253">           async_driver();</span>
<a href="#l25.254"></a><span id="l25.254">         }</span>
<a href="#l25.255"></a><span id="l25.255">       }</span>
<a href="#l25.256"></a><span id="l25.256">     } catch (e) {</span>
<a href="#l25.257"></a><span id="l25.257" class="difflineminus">-      throw(e);</span>
<a href="#l25.258"></a><span id="l25.258" class="difflineplus">+      throw (e);</span>
<a href="#l25.259"></a><span id="l25.259">     }</span>
<a href="#l25.260"></a><span id="l25.260">   },</span>
<a href="#l25.261"></a><span id="l25.261"> </span>
<a href="#l25.262"></a><span id="l25.262" class="difflineminus">-  onDownloadError : function(folder) {</span>
<a href="#l25.263"></a><span id="l25.263" class="difflineplus">+  onDownloadError(folder) {</span>
<a href="#l25.264"></a><span id="l25.264">     if (folder instanceof Ci.nsIMsgFolder) {</span>
<a href="#l25.265"></a><span id="l25.265">       dump(&quot;OnDownloadError: &quot; + folder.prettyName + &quot;\n&quot;);</span>
<a href="#l25.266"></a><span id="l25.266">     }</span>
<a href="#l25.267"></a><span id="l25.267">   },</span>
<a href="#l25.268"></a><span id="l25.268"> </span>
<a href="#l25.269"></a><span id="l25.269" class="difflineminus">-  onDiscoveryQProcessed : function (folder, numOfHdrsProcessed, leftToProcess) {</span>
<a href="#l25.270"></a><span id="l25.270" class="difflineplus">+  onDiscoveryQProcessed(folder, numOfHdrsProcessed, leftToProcess) {</span>
<a href="#l25.271"></a><span id="l25.271">     dump(&quot;onDiscoveryQProcessed: &quot; + folder.prettyName + &quot;\n&quot;);</span>
<a href="#l25.272"></a><span id="l25.272">     let index = mailTestUtils.non_strict_index_of(this._waitingForDiscoveryList, folder);</span>
<a href="#l25.273"></a><span id="l25.273">     if (index != -1)</span>
<a href="#l25.274"></a><span id="l25.274">       this._waitingForDiscoveryList.splice(index, 1);</span>
<a href="#l25.275"></a><span id="l25.275">     if (this._waitingForDiscovery &amp;&amp; this._waitingForDiscoveryList.length == 0) {</span>
<a href="#l25.276"></a><span id="l25.276">       dump(&quot;got last folder discovery looking for\n&quot;);</span>
<a href="#l25.277"></a><span id="l25.277">       this._waitingForDiscovery = false;</span>
<a href="#l25.278"></a><span id="l25.278">       async_driver();</span>
<a href="#l25.279"></a><span id="l25.279">     }</span>
<a href="#l25.280"></a><span id="l25.280">   },</span>
<a href="#l25.281"></a><span id="l25.281"> </span>
<a href="#l25.282"></a><span id="l25.282" class="difflineminus">-  onAutoSyncInitiated : function (folder) {</span>
<a href="#l25.283"></a><span id="l25.283" class="difflineplus">+  onAutoSyncInitiated(folder) {</span>
<a href="#l25.284"></a><span id="l25.284">   },</span>
<a href="#l25.285"></a><span id="l25.285" class="difflineminus">-  qName : function(queueType) {</span>
<a href="#l25.286"></a><span id="l25.286" class="difflineplus">+  qName(queueType) {</span>
<a href="#l25.287"></a><span id="l25.287">     if (queueType == nsIAutoSyncMgrListener.PriorityQueue)</span>
<a href="#l25.288"></a><span id="l25.288">       return &quot;priorityQ&quot;;</span>
<a href="#l25.289"></a><span id="l25.289">     if (queueType == nsIAutoSyncMgrListener.UpdateQueue)</span>
<a href="#l25.290"></a><span id="l25.290">      return &quot;updateQ&quot;;</span>
<a href="#l25.291"></a><span id="l25.291">     if (queueType == nsIAutoSyncMgrListener.DiscoveryQueue)</span>
<a href="#l25.292"></a><span id="l25.292">       return &quot;discoveryQ&quot;;</span>
<a href="#l25.293"></a><span id="l25.293">     return &quot;&quot;;</span>
<a href="#l25.294"></a><span id="l25.294">   },</span>
<a href="#l25.295"></a><span id="l25.295" class="difflineminus">-}</span>
<a href="#l25.296"></a><span id="l25.296" class="difflineplus">+};</span>
<a href="#l25.297"></a><span id="l25.297"> </span>
<a href="#l25.298"></a><span id="l25.298"> /*</span>
<a href="#l25.299"></a><span id="l25.299">  * helper functions</span>
<a href="#l25.300"></a><span id="l25.300">  */</span>
<a href="#l25.301"></a><span id="l25.301"> </span>
<a href="#l25.302"></a><span id="l25.302"> // load and update a message in the imap fake server</span>
<a href="#l25.303"></a><span id="l25.303" class="difflineminus">-function addMessageToFolder(folder)</span>
<a href="#l25.304"></a><span id="l25.304" class="difflineminus">-{</span>
<a href="#l25.305"></a><span id="l25.305" class="difflineplus">+function addMessageToFolder(folder) {</span>
<a href="#l25.306"></a><span id="l25.306">   let messages = [];</span>
<a href="#l25.307"></a><span id="l25.307">   let gMessageGenerator = new MessageGenerator();</span>
<a href="#l25.308"></a><span id="l25.308">   messages = messages.concat(gMessageGenerator.makeMessage());</span>
<a href="#l25.309"></a><span id="l25.309"> </span>
<a href="#l25.310"></a><span id="l25.310">   let msgURI =</span>
<a href="#l25.311"></a><span id="l25.311">     Services.io.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l25.312"></a><span id="l25.312">                        btoa(messages[0].toMessageString()));</span>
<a href="#l25.313"></a><span id="l25.313">   let imapMailbox =  IMAPPump.daemon.getMailbox(folder.name);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapChunks.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapChunks.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -8,18 +8,17 @@ var {IOUtils} = ChromeUtils.import(&quot;reso</span>
<a href="#l26.4"></a><span id="l26.4"> var gIMAPDaemon, gServer, gIMAPIncomingServer, gSavedMsgFile;</span>
<a href="#l26.5"></a><span id="l26.5"> </span>
<a href="#l26.6"></a><span id="l26.6"> var gIMAPService = Cc[&quot;@mozilla.org/messenger/messageservice;1?type=imap&quot;]</span>
<a href="#l26.7"></a><span id="l26.7">                        .getService(Ci.nsIMsgMessageService);</span>
<a href="#l26.8"></a><span id="l26.8"> </span>
<a href="#l26.9"></a><span id="l26.9"> var gFileName = &quot;bug92111&quot;;</span>
<a href="#l26.10"></a><span id="l26.10"> var gMsgFile = do_get_file(&quot;../../../data/&quot; + gFileName);</span>
<a href="#l26.11"></a><span id="l26.11"> </span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-function run_test()</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineminus">-{</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineplus">+function run_test() {</span>
<a href="#l26.15"></a><span id="l26.15">   /*</span>
<a href="#l26.16"></a><span id="l26.16">    * Set up an IMAP server. The bug is only triggered when nsMsgSaveAsListener</span>
<a href="#l26.17"></a><span id="l26.17">    * is used (i.e., for IMAP and NNTP).</span>
<a href="#l26.18"></a><span id="l26.18">    */</span>
<a href="#l26.19"></a><span id="l26.19">   gIMAPDaemon = new imapDaemon();</span>
<a href="#l26.20"></a><span id="l26.20">   gServer = makeServer(gIMAPDaemon, &quot;&quot;);</span>
<a href="#l26.21"></a><span id="l26.21">   gIMAPIncomingServer = createLocalIMAPServer(gServer.port);</span>
<a href="#l26.22"></a><span id="l26.22"> </span>
<a href="#l26.23"></a><span id="l26.23" class="difflineat">@@ -56,68 +55,64 @@ function run_test()</span>
<a href="#l26.24"></a><span id="l26.24">    * &lt;profile_dir&gt;/mailtest/ImapMail (where fakeserver puts the IMAP mailbox</span>
<a href="#l26.25"></a><span id="l26.25">    * files). If we pass the test, we'll remove the file afterwards</span>
<a href="#l26.26"></a><span id="l26.26">    * (cf. UrlListener), otherwise it's kept in IMapMD.</span>
<a href="#l26.27"></a><span id="l26.27">    */</span>
<a href="#l26.28"></a><span id="l26.28">   gSavedMsgFile = Services.dirsvc.get(&quot;IMapMD&quot;, Ci.nsIFile);</span>
<a href="#l26.29"></a><span id="l26.29">   gSavedMsgFile.append(gFileName + &quot;.eml&quot;);</span>
<a href="#l26.30"></a><span id="l26.30"> </span>
<a href="#l26.31"></a><span id="l26.31">   do_test_pending();</span>
<a href="#l26.32"></a><span id="l26.32" class="difflineminus">-  do_timeout(10000, function(){</span>
<a href="#l26.33"></a><span id="l26.33" class="difflineminus">-      do_throw('SaveMessageToDisk did not complete within 10 seconds' +</span>
<a href="#l26.34"></a><span id="l26.34" class="difflineminus">-        '(incorrect messageURI?). ABORTING.');</span>
<a href="#l26.35"></a><span id="l26.35" class="difflineminus">-      }</span>
<a href="#l26.36"></a><span id="l26.36" class="difflineminus">-    );</span>
<a href="#l26.37"></a><span id="l26.37" class="difflineplus">+  do_timeout(10000, function() {</span>
<a href="#l26.38"></a><span id="l26.38" class="difflineplus">+    do_throw(&quot;SaveMessageToDisk did not complete within 10 seconds&quot; +</span>
<a href="#l26.39"></a><span id="l26.39" class="difflineplus">+      &quot;(incorrect messageURI?). ABORTING.&quot;);</span>
<a href="#l26.40"></a><span id="l26.40" class="difflineplus">+    }</span>
<a href="#l26.41"></a><span id="l26.41" class="difflineplus">+  );</span>
<a href="#l26.42"></a><span id="l26.42"> </span>
<a href="#l26.43"></a><span id="l26.43">   /*</span>
<a href="#l26.44"></a><span id="l26.44">    * From nsIMsgMessageService.idl:</span>
<a href="#l26.45"></a><span id="l26.45">    * void SaveMessageToDisk(in string aMessageURI, in nsIFile aFile,</span>
<a href="#l26.46"></a><span id="l26.46">    *                        in boolean aGenerateDummyEnvelope,</span>
<a href="#l26.47"></a><span id="l26.47">    *                        in nsIUrlListener aUrlListener, out nsIURI aURL,</span>
<a href="#l26.48"></a><span id="l26.48">    *                        in boolean canonicalLineEnding,</span>
<a href="#l26.49"></a><span id="l26.49">    *                        in nsIMsgWindow aMsgWindow);</span>
<a href="#l26.50"></a><span id="l26.50">    * Enforcing canonicalLineEnding (i.e., CRLF) makes sure that the</span>
<a href="#l26.51"></a><span id="l26.51">    * test also runs successfully on platforms not using CRLF by default.</span>
<a href="#l26.52"></a><span id="l26.52">    */</span>
<a href="#l26.53"></a><span id="l26.53">   gIMAPService.SaveMessageToDisk(&quot;imap-message://user@localhost/INBOX#&quot;</span>
<a href="#l26.54"></a><span id="l26.54" class="difflineminus">-                                 + (inbox.uidnext-1), gSavedMsgFile,</span>
<a href="#l26.55"></a><span id="l26.55" class="difflineplus">+                                 + (inbox.uidnext - 1), gSavedMsgFile,</span>
<a href="#l26.56"></a><span id="l26.56">                                  false, UrlListener, {}, true, null);</span>
<a href="#l26.57"></a><span id="l26.57"> }</span>
<a href="#l26.58"></a><span id="l26.58"> </span>
<a href="#l26.59"></a><span id="l26.59" class="difflineminus">-function endTest()</span>
<a href="#l26.60"></a><span id="l26.60" class="difflineminus">-{</span>
<a href="#l26.61"></a><span id="l26.61" class="difflineplus">+function endTest() {</span>
<a href="#l26.62"></a><span id="l26.62">   gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l26.63"></a><span id="l26.63">   gServer.stop();</span>
<a href="#l26.64"></a><span id="l26.64">   var thread = gThreadManager.currentThread;</span>
<a href="#l26.65"></a><span id="l26.65">   while (thread.hasPendingEvents())</span>
<a href="#l26.66"></a><span id="l26.66">     thread.processNextEvent(true);</span>
<a href="#l26.67"></a><span id="l26.67"> </span>
<a href="#l26.68"></a><span id="l26.68">   try {</span>
<a href="#l26.69"></a><span id="l26.69">     gSavedMsgFile.remove(false);</span>
<a href="#l26.70"></a><span id="l26.70" class="difflineminus">-  }</span>
<a href="#l26.71"></a><span id="l26.71" class="difflineminus">-  catch (ex) {</span>
<a href="#l26.72"></a><span id="l26.72" class="difflineplus">+  } catch (ex) {</span>
<a href="#l26.73"></a><span id="l26.73">     dump(ex);</span>
<a href="#l26.74"></a><span id="l26.74">     do_throw(ex);</span>
<a href="#l26.75"></a><span id="l26.75">   }</span>
<a href="#l26.76"></a><span id="l26.76">   do_test_finished();</span>
<a href="#l26.77"></a><span id="l26.77"> }</span>
<a href="#l26.78"></a><span id="l26.78"> </span>
<a href="#l26.79"></a><span id="l26.79" class="difflineminus">-var UrlListener =</span>
<a href="#l26.80"></a><span id="l26.80" class="difflineminus">-{</span>
<a href="#l26.81"></a><span id="l26.81" class="difflineminus">-  OnStartRunningUrl: function(url) { },</span>
<a href="#l26.82"></a><span id="l26.82" class="difflineminus">-  OnStopRunningUrl: function(url, rc)</span>
<a href="#l26.83"></a><span id="l26.83" class="difflineminus">-  {</span>
<a href="#l26.84"></a><span id="l26.84" class="difflineplus">+var UrlListener = {</span>
<a href="#l26.85"></a><span id="l26.85" class="difflineplus">+  OnStartRunningUrl(url) {},</span>
<a href="#l26.86"></a><span id="l26.86" class="difflineplus">+  OnStopRunningUrl(url, rc) {</span>
<a href="#l26.87"></a><span id="l26.87">     // operation succeeded</span>
<a href="#l26.88"></a><span id="l26.88">     Assert.equal(rc, 0);</span>
<a href="#l26.89"></a><span id="l26.89"> </span>
<a href="#l26.90"></a><span id="l26.90">     // File contents were not modified</span>
<a href="#l26.91"></a><span id="l26.91">     Assert.equal(IOUtils.loadFileToString(gMsgFile),</span>
<a href="#l26.92"></a><span id="l26.92">                  IOUtils.loadFileToString(gSavedMsgFile));</span>
<a href="#l26.93"></a><span id="l26.93"> </span>
<a href="#l26.94"></a><span id="l26.94">     // The file doesn't get closed straight away, but does after a little bit.</span>
<a href="#l26.95"></a><span id="l26.95">     // So wait, and then remove it. We need to test this to ensure we don't</span>
<a href="#l26.96"></a><span id="l26.96">     // indefinitely lock the file.</span>
<a href="#l26.97"></a><span id="l26.97">     do_timeout(1000, endTest);</span>
<a href="#l26.98"></a><span id="l26.98" class="difflineminus">-  }</span>
<a href="#l26.99"></a><span id="l26.99" class="difflineplus">+  },</span>
<a href="#l26.100"></a><span id="l26.100"> };</span>
<a href="#l26.101"></a><span id="l26.101"> </span>
<a href="#l26.102"></a><span id="l26.102"> // XXX IRVING we need a separate check somehow to make sure we store the correct</span>
<a href="#l26.103"></a><span id="l26.103"> // content size for chunked messages where the server lied</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapContentLength.js</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapContentLength.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -6,44 +6,46 @@</span>
<a href="#l27.4"></a><span id="l27.4">  *</span>
<a href="#l27.5"></a><span id="l27.5">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l27.6"></a><span id="l27.6"> </span>
<a href="#l27.7"></a><span id="l27.7"> /*</span>
<a href="#l27.8"></a><span id="l27.8">  * Test content length for the IMAP protocol. This focuses on necko URLs</span>
<a href="#l27.9"></a><span id="l27.9">  * that are run externally.</span>
<a href="#l27.10"></a><span id="l27.10">  */</span>
<a href="#l27.11"></a><span id="l27.11"> </span>
<a href="#l27.12"></a><span id="l27.12" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l27.14"></a><span id="l27.14"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l27.15"></a><span id="l27.15"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l27.16"></a><span id="l27.16"> </span>
<a href="#l27.17"></a><span id="l27.17"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l27.18"></a><span id="l27.18"> </span>
<a href="#l27.19"></a><span id="l27.19"> var gMsgHdr = null;</span>
<a href="#l27.20"></a><span id="l27.20"> </span>
<a href="#l27.21"></a><span id="l27.21"> // Take a multipart message as we're testing attachment URLs as well</span>
<a href="#l27.22"></a><span id="l27.22"> var gFile = do_get_file(&quot;../../../data/multipart-complex2&quot;);</span>
<a href="#l27.23"></a><span id="l27.23"> </span>
<a href="#l27.24"></a><span id="l27.24"> var tests = [</span>
<a href="#l27.25"></a><span id="l27.25">   setup,</span>
<a href="#l27.26"></a><span id="l27.26">   addMessageToServer,</span>
<a href="#l27.27"></a><span id="l27.27">   verifyContentLength,</span>
<a href="#l27.28"></a><span id="l27.28" class="difflineminus">-  teardown</span>
<a href="#l27.29"></a><span id="l27.29" class="difflineplus">+  teardown,</span>
<a href="#l27.30"></a><span id="l27.30"> ];</span>
<a href="#l27.31"></a><span id="l27.31"> </span>
<a href="#l27.32"></a><span id="l27.32"> // Adds some messages directly to a mailbox (eg new mail)</span>
<a href="#l27.33"></a><span id="l27.33"> function* addMessageToServer() {</span>
<a href="#l27.34"></a><span id="l27.34">   let URI = Services.io.newFileURI(gFile).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l27.35"></a><span id="l27.35">   IMAPPump.mailbox.addMessage(new imapMessage(URI.spec, IMAPPump.mailbox.uidnext++, []));</span>
<a href="#l27.36"></a><span id="l27.36"> </span>
<a href="#l27.37"></a><span id="l27.37">   IMAPPump.inbox.updateFolder(null);</span>
<a href="#l27.38"></a><span id="l27.38">   yield false;</span>
<a href="#l27.39"></a><span id="l27.39"> }</span>
<a href="#l27.40"></a><span id="l27.40"> </span>
<a href="#l27.41"></a><span id="l27.41"> var msgFolderListener = {</span>
<a href="#l27.42"></a><span id="l27.42" class="difflineminus">-  msgAdded: function(aMsgHdr) {</span>
<a href="#l27.43"></a><span id="l27.43" class="difflineplus">+  msgAdded(aMsgHdr) {</span>
<a href="#l27.44"></a><span id="l27.44">     gMsgHdr = aMsgHdr;</span>
<a href="#l27.45"></a><span id="l27.45">     executeSoon(async_driver);</span>
<a href="#l27.46"></a><span id="l27.46">   },</span>
<a href="#l27.47"></a><span id="l27.47"> };</span>
<a href="#l27.48"></a><span id="l27.48"> </span>
<a href="#l27.49"></a><span id="l27.49"> function setup() {</span>
<a href="#l27.50"></a><span id="l27.50">   setupIMAPPump();</span>
<a href="#l27.51"></a><span id="l27.51"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapCopyTimeout.js</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapCopyTimeout.js</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -3,72 +3,75 @@</span>
<a href="#l28.4"></a><span id="l28.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l28.5"></a><span id="l28.5"> </span>
<a href="#l28.6"></a><span id="l28.6"> // This tests our handling of server timeouts during online move of</span>
<a href="#l28.7"></a><span id="l28.7"> // an imap message. The move is done as an offline operation and then</span>
<a href="#l28.8"></a><span id="l28.8"> // played back, to copy what the apps do.</span>
<a href="#l28.9"></a><span id="l28.9"> </span>
<a href="#l28.10"></a><span id="l28.10"> Services.prefs.setIntPref(&quot;mailnews.tcptimeout&quot;, 2);</span>
<a href="#l28.11"></a><span id="l28.11"> </span>
<a href="#l28.12"></a><span id="l28.12" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineplus">+/* import-globals-from ../../../test/resources/alertTestUtils.js */</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l28.16"></a><span id="l28.16"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l28.17"></a><span id="l28.17"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l28.18"></a><span id="l28.18"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l28.19"></a><span id="l28.19"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l28.20"></a><span id="l28.20"> </span>
<a href="#l28.21"></a><span id="l28.21"> // IMAP pump</span>
<a href="#l28.22"></a><span id="l28.22"> </span>
<a href="#l28.23"></a><span id="l28.23"> // Globals</span>
<a href="#l28.24"></a><span id="l28.24"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l28.25"></a><span id="l28.25"> </span>
<a href="#l28.26"></a><span id="l28.26"> setupIMAPPump();</span>
<a href="#l28.27"></a><span id="l28.27"> </span>
<a href="#l28.28"></a><span id="l28.28"> var gGotAlert = false;</span>
<a href="#l28.29"></a><span id="l28.29"> var gGotMsgAdded = false;</span>
<a href="#l28.30"></a><span id="l28.30"> </span>
<a href="#l28.31"></a><span id="l28.31" class="difflineplus">+/* exported alert */// to alertTestUtils.js</span>
<a href="#l28.32"></a><span id="l28.32"> function alert(aDialogTitle, aText) {</span>
<a href="#l28.33"></a><span id="l28.33">   Assert.ok(aText.startsWith(&quot;Connection to server localhost timed out.&quot;));</span>
<a href="#l28.34"></a><span id="l28.34">   gGotAlert = true;</span>
<a href="#l28.35"></a><span id="l28.35">   async_driver();</span>
<a href="#l28.36"></a><span id="l28.36"> }</span>
<a href="#l28.37"></a><span id="l28.37"> </span>
<a href="#l28.38"></a><span id="l28.38"> var CopyListener = {</span>
<a href="#l28.39"></a><span id="l28.39" class="difflineminus">-  OnStartCopy: function() {},</span>
<a href="#l28.40"></a><span id="l28.40" class="difflineminus">-  OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l28.41"></a><span id="l28.41" class="difflineminus">-  SetMessageKey: function(aMsgKey) {},</span>
<a href="#l28.42"></a><span id="l28.42" class="difflineminus">-  GetMessageId: function() {},</span>
<a href="#l28.43"></a><span id="l28.43" class="difflineminus">-  OnStopCopy: function(aStatus) {</span>
<a href="#l28.44"></a><span id="l28.44" class="difflineplus">+  OnStartCopy() {},</span>
<a href="#l28.45"></a><span id="l28.45" class="difflineplus">+  OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l28.46"></a><span id="l28.46" class="difflineplus">+  SetMessageKey(aMsgKey) {},</span>
<a href="#l28.47"></a><span id="l28.47" class="difflineplus">+  GetMessageId() {},</span>
<a href="#l28.48"></a><span id="l28.48" class="difflineplus">+  OnStopCopy(aStatus) {</span>
<a href="#l28.49"></a><span id="l28.49">     async_driver();</span>
<a href="#l28.50"></a><span id="l28.50" class="difflineminus">-  }</span>
<a href="#l28.51"></a><span id="l28.51" class="difflineplus">+  },</span>
<a href="#l28.52"></a><span id="l28.52"> };</span>
<a href="#l28.53"></a><span id="l28.53"> </span>
<a href="#l28.54"></a><span id="l28.54"> // Definition of tests</span>
<a href="#l28.55"></a><span id="l28.55"> var tests = [</span>
<a href="#l28.56"></a><span id="l28.56">   createTargetFolder,</span>
<a href="#l28.57"></a><span id="l28.57">   loadImapMessage,</span>
<a href="#l28.58"></a><span id="l28.58">   moveMessageToTargetFolder,</span>
<a href="#l28.59"></a><span id="l28.59">   waitForOfflinePlayback,</span>
<a href="#l28.60"></a><span id="l28.60">   updateTargetFolder,</span>
<a href="#l28.61"></a><span id="l28.61" class="difflineminus">-  endTest</span>
<a href="#l28.62"></a><span id="l28.62" class="difflineminus">-]</span>
<a href="#l28.63"></a><span id="l28.63" class="difflineplus">+  endTest,</span>
<a href="#l28.64"></a><span id="l28.64" class="difflineplus">+];</span>
<a href="#l28.65"></a><span id="l28.65"> </span>
<a href="#l28.66"></a><span id="l28.66"> var gTargetFolder;</span>
<a href="#l28.67"></a><span id="l28.67" class="difflineminus">-function* createTargetFolder()</span>
<a href="#l28.68"></a><span id="l28.68" class="difflineminus">-{</span>
<a href="#l28.69"></a><span id="l28.69" class="difflineplus">+function* createTargetFolder() {</span>
<a href="#l28.70"></a><span id="l28.70">   IMAPPump.daemon.copySleep = 5000;</span>
<a href="#l28.71"></a><span id="l28.71">   IMAPPump.incomingServer.rootFolder.createSubfolder(&quot;targetFolder&quot;, null);</span>
<a href="#l28.72"></a><span id="l28.72">   yield false;</span>
<a href="#l28.73"></a><span id="l28.73">   gTargetFolder = IMAPPump.incomingServer.rootFolder.getChildNamed(&quot;targetFolder&quot;);</span>
<a href="#l28.74"></a><span id="l28.74">   Assert.ok(gTargetFolder instanceof Ci.nsIMsgImapMailFolder);</span>
<a href="#l28.75"></a><span id="l28.75">   gTargetFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l28.76"></a><span id="l28.76">   yield false;</span>
<a href="#l28.77"></a><span id="l28.77"> }</span>
<a href="#l28.78"></a><span id="l28.78"> </span>
<a href="#l28.79"></a><span id="l28.79"> // load and update a message in the imap fake server</span>
<a href="#l28.80"></a><span id="l28.80" class="difflineminus">-function* loadImapMessage()</span>
<a href="#l28.81"></a><span id="l28.81" class="difflineminus">-{</span>
<a href="#l28.82"></a><span id="l28.82" class="difflineplus">+function* loadImapMessage() {</span>
<a href="#l28.83"></a><span id="l28.83">   let messages = [];</span>
<a href="#l28.84"></a><span id="l28.84">   let gMessageGenerator = new MessageGenerator();</span>
<a href="#l28.85"></a><span id="l28.85">   messages = messages.concat(gMessageGenerator.makeMessage());</span>
<a href="#l28.86"></a><span id="l28.86"> </span>
<a href="#l28.87"></a><span id="l28.87">   let msgURI =</span>
<a href="#l28.88"></a><span id="l28.88">     Services.io.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l28.89"></a><span id="l28.89">                        btoa(messages[0].toMessageString()));</span>
<a href="#l28.90"></a><span id="l28.90">   let imapInbox = IMAPPump.daemon.getMailbox(&quot;INBOX&quot;);</span>
<a href="#l28.91"></a><span id="l28.91" class="difflineat">@@ -79,83 +82,75 @@ function* loadImapMessage()</span>
<a href="#l28.92"></a><span id="l28.92">   Assert.equal(1, IMAPPump.inbox.getTotalMessages(false));</span>
<a href="#l28.93"></a><span id="l28.93">   let msgHdr = mailTestUtils.firstMsgHdr(IMAPPump.inbox);</span>
<a href="#l28.94"></a><span id="l28.94">   Assert.ok(msgHdr instanceof Ci.nsIMsgDBHdr);</span>
<a href="#l28.95"></a><span id="l28.95"> </span>
<a href="#l28.96"></a><span id="l28.96">   yield true;</span>
<a href="#l28.97"></a><span id="l28.97"> }</span>
<a href="#l28.98"></a><span id="l28.98"> </span>
<a href="#l28.99"></a><span id="l28.99"> // move the message to a diffent folder</span>
<a href="#l28.100"></a><span id="l28.100" class="difflineminus">-function* moveMessageToTargetFolder()</span>
<a href="#l28.101"></a><span id="l28.101" class="difflineminus">-{</span>
<a href="#l28.102"></a><span id="l28.102" class="difflineplus">+function* moveMessageToTargetFolder() {</span>
<a href="#l28.103"></a><span id="l28.103">   let msgHdr = mailTestUtils.firstMsgHdr(IMAPPump.inbox);</span>
<a href="#l28.104"></a><span id="l28.104"> </span>
<a href="#l28.105"></a><span id="l28.105">   // Now move this message to the target folder.</span>
<a href="#l28.106"></a><span id="l28.106">   var messages = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l28.107"></a><span id="l28.107">                    .createInstance(Ci.nsIMutableArray);</span>
<a href="#l28.108"></a><span id="l28.108">   messages.appendElement(msgHdr);</span>
<a href="#l28.109"></a><span id="l28.109">   // This should cause the move to be done as an offline imap operation</span>
<a href="#l28.110"></a><span id="l28.110">   // that's played back immediately.</span>
<a href="#l28.111"></a><span id="l28.111">   MailServices.copy.CopyMessages(IMAPPump.inbox, messages, gTargetFolder, true,</span>
<a href="#l28.112"></a><span id="l28.112">                                  CopyListener, gDummyMsgWindow, true);</span>
<a href="#l28.113"></a><span id="l28.113">   yield false;</span>
<a href="#l28.114"></a><span id="l28.114"> }</span>
<a href="#l28.115"></a><span id="l28.115"> </span>
<a href="#l28.116"></a><span id="l28.116" class="difflineminus">-function* waitForOfflinePlayback()</span>
<a href="#l28.117"></a><span id="l28.117" class="difflineminus">-{</span>
<a href="#l28.118"></a><span id="l28.118" class="difflineplus">+function* waitForOfflinePlayback() {</span>
<a href="#l28.119"></a><span id="l28.119">   // just wait for the alert about timed out connection.</span>
<a href="#l28.120"></a><span id="l28.120">   yield false;</span>
<a href="#l28.121"></a><span id="l28.121">   // then, wait for a second so we don't get our next url aborted.</span>
<a href="#l28.122"></a><span id="l28.122">   do_timeout(1000, async_driver);</span>
<a href="#l28.123"></a><span id="l28.123">   yield false;</span>
<a href="#l28.124"></a><span id="l28.124"> }</span>
<a href="#l28.125"></a><span id="l28.125"> </span>
<a href="#l28.126"></a><span id="l28.126" class="difflineminus">-function* updateTargetFolder()</span>
<a href="#l28.127"></a><span id="l28.127" class="difflineminus">-{</span>
<a href="#l28.128"></a><span id="l28.128" class="difflineplus">+function* updateTargetFolder() {</span>
<a href="#l28.129"></a><span id="l28.129">   gTargetFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l28.130"></a><span id="l28.130">   yield false;</span>
<a href="#l28.131"></a><span id="l28.131"> }</span>
<a href="#l28.132"></a><span id="l28.132"> </span>
<a href="#l28.133"></a><span id="l28.133"> // Cleanup</span>
<a href="#l28.134"></a><span id="l28.134" class="difflineminus">-function endTest()</span>
<a href="#l28.135"></a><span id="l28.135" class="difflineminus">-{</span>
<a href="#l28.136"></a><span id="l28.136" class="difflineplus">+function endTest() {</span>
<a href="#l28.137"></a><span id="l28.137">   Assert.ok(gGotAlert);</span>
<a href="#l28.138"></a><span id="l28.138">   // Make sure neither source nor target folder have offline events.</span>
<a href="#l28.139"></a><span id="l28.139">   Assert.ok(!IMAPPump.inbox.getFlag(Ci.nsMsgFolderFlags.OfflineEvents));</span>
<a href="#l28.140"></a><span id="l28.140">   Assert.ok(!gTargetFolder.getFlag(Ci.nsMsgFolderFlags.OfflineEvents));</span>
<a href="#l28.141"></a><span id="l28.141"> </span>
<a href="#l28.142"></a><span id="l28.142">   // fake server does the copy, but then times out, so make sure the target</span>
<a href="#l28.143"></a><span id="l28.143">   // folder has only 1 message, not the multiple ones it would have if we</span>
<a href="#l28.144"></a><span id="l28.144">   // retried.</span>
<a href="#l28.145"></a><span id="l28.145">   Assert.equal(gTargetFolder.getTotalMessages(false), 1);</span>
<a href="#l28.146"></a><span id="l28.146">   teardownIMAPPump();</span>
<a href="#l28.147"></a><span id="l28.147"> }</span>
<a href="#l28.148"></a><span id="l28.148"> </span>
<a href="#l28.149"></a><span id="l28.149"> // listeners</span>
<a href="#l28.150"></a><span id="l28.150"> </span>
<a href="#l28.151"></a><span id="l28.151" class="difflineminus">-var mfnListener =</span>
<a href="#l28.152"></a><span id="l28.152" class="difflineminus">-{</span>
<a href="#l28.153"></a><span id="l28.153" class="difflineminus">-  folderAdded: function folderAdded(aFolder)</span>
<a href="#l28.154"></a><span id="l28.154" class="difflineminus">-  {</span>
<a href="#l28.155"></a><span id="l28.155" class="difflineplus">+var mfnListener = {</span>
<a href="#l28.156"></a><span id="l28.156" class="difflineplus">+  folderAdded(aFolder) {</span>
<a href="#l28.157"></a><span id="l28.157">     // we are only using async yield on the target folder add</span>
<a href="#l28.158"></a><span id="l28.158">     if (aFolder.name == &quot;targetFolder&quot;)</span>
<a href="#l28.159"></a><span id="l28.159">       async_driver();</span>
<a href="#l28.160"></a><span id="l28.160">   },</span>
<a href="#l28.161"></a><span id="l28.161"> </span>
<a href="#l28.162"></a><span id="l28.162" class="difflineminus">-  msgAdded: function msgAdded(aMsg)</span>
<a href="#l28.163"></a><span id="l28.163" class="difflineminus">-  {</span>
<a href="#l28.164"></a><span id="l28.164" class="difflineplus">+  msgAdded(aMsg) {</span>
<a href="#l28.165"></a><span id="l28.165">     if (!gGotMsgAdded)</span>
<a href="#l28.166"></a><span id="l28.166">       async_driver();</span>
<a href="#l28.167"></a><span id="l28.167">     gGotMsgAdded = true;</span>
<a href="#l28.168"></a><span id="l28.168">   },</span>
<a href="#l28.169"></a><span id="l28.169"> </span>
<a href="#l28.170"></a><span id="l28.170"> };</span>
<a href="#l28.171"></a><span id="l28.171"> </span>
<a href="#l28.172"></a><span id="l28.172" class="difflineminus">-function run_test()</span>
<a href="#l28.173"></a><span id="l28.173" class="difflineminus">-{</span>
<a href="#l28.174"></a><span id="l28.174" class="difflineplus">+function run_test() {</span>
<a href="#l28.175"></a><span id="l28.175">   Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l28.176"></a><span id="l28.176">   // Add folder listeners that will capture async events</span>
<a href="#l28.177"></a><span id="l28.177">   const nsIMFNService = Ci.nsIMsgFolderNotificationService;</span>
<a href="#l28.178"></a><span id="l28.178">   let flags =</span>
<a href="#l28.179"></a><span id="l28.179">         nsIMFNService.folderAdded |</span>
<a href="#l28.180"></a><span id="l28.180">         nsIMFNService.msgAdded;</span>
<a href="#l28.181"></a><span id="l28.181">   MailServices.mfn.addListener(mfnListener, flags);</span>
<a href="#l28.182"></a><span id="l28.182">   async_run_tests(tests);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapFilterActions.js</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapFilterActions.js</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -4,69 +4,51 @@</span>
<a href="#l29.4"></a><span id="l29.4">  * mail are not tested. The tests check various counts, and the effects</span>
<a href="#l29.5"></a><span id="l29.5">  * on the message database of the filters. Effects on IMAP server</span>
<a href="#l29.6"></a><span id="l29.6">  * flags, if any, are not tested.</span>
<a href="#l29.7"></a><span id="l29.7">  *</span>
<a href="#l29.8"></a><span id="l29.8">  * Original author: Kent James &lt;kent@caspia.com&gt;</span>
<a href="#l29.9"></a><span id="l29.9">  * adapted from test_localToImapFilter.js</span>
<a href="#l29.10"></a><span id="l29.10">  */</span>
<a href="#l29.11"></a><span id="l29.11"> </span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-var {</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineminus">-  getFolderProperties,</span>
<a href="#l29.14"></a><span id="l29.14" class="difflineminus">-  getSpecialFolderString,</span>
<a href="#l29.15"></a><span id="l29.15" class="difflineminus">-  allAccountsSorted,</span>
<a href="#l29.16"></a><span id="l29.16" class="difflineminus">-  getMostRecentFolders,</span>
<a href="#l29.17"></a><span id="l29.17" class="difflineminus">-  folderNameCompare,</span>
<a href="#l29.18"></a><span id="l29.18" class="difflineminus">-} = ChromeUtils.import(&quot;resource:///modules/folderUtils.jsm&quot;);</span>
<a href="#l29.19"></a><span id="l29.19" class="difflineminus">-</span>
<a href="#l29.20"></a><span id="l29.20" class="difflineminus">-var nsMsgSearchScope = Ci.nsMsgSearchScope;</span>
<a href="#l29.21"></a><span id="l29.21" class="difflineminus">-var nsMsgSearchAttrib = Ci.nsMsgSearchAttrib;</span>
<a href="#l29.22"></a><span id="l29.22" class="difflineminus">-var nsMsgSearchOp = Ci.nsMsgSearchOp;</span>
<a href="#l29.23"></a><span id="l29.23" class="difflineminus">-var Is = nsMsgSearchOp.Is;</span>
<a href="#l29.24"></a><span id="l29.24" class="difflineminus">-var Contains = nsMsgSearchOp.Contains;</span>
<a href="#l29.25"></a><span id="l29.25" class="difflineminus">-var Subject = nsMsgSearchAttrib.Subject;</span>
<a href="#l29.26"></a><span id="l29.26" class="difflineminus">-var Body = nsMsgSearchAttrib.Body;</span>
<a href="#l29.27"></a><span id="l29.27" class="difflineplus">+var Is = Ci.nsMsgSearchOp.Is;</span>
<a href="#l29.28"></a><span id="l29.28" class="difflineplus">+var Contains = Ci.nsMsgSearchOp.Contains;</span>
<a href="#l29.29"></a><span id="l29.29" class="difflineplus">+var Subject = Ci.nsMsgSearchAttrib.Subject;</span>
<a href="#l29.30"></a><span id="l29.30" class="difflineplus">+var Body = Ci.nsMsgSearchAttrib.Body;</span>
<a href="#l29.31"></a><span id="l29.31"> </span>
<a href="#l29.32"></a><span id="l29.32"> // Globals</span>
<a href="#l29.33"></a><span id="l29.33"> var gSubfolder; // a local message folder used as a target for moves and copies</span>
<a href="#l29.34"></a><span id="l29.34" class="difflineminus">-var gLastKey; // the last message key</span>
<a href="#l29.35"></a><span id="l29.35"> var gFilter; // a message filter with a subject search</span>
<a href="#l29.36"></a><span id="l29.36"> var gAction; // current message action (reused)</span>
<a href="#l29.37"></a><span id="l29.37"> var gBodyFilter; // a message filter with a body search</span>
<a href="#l29.38"></a><span id="l29.38"> var gInboxListener; // database listener object</span>
<a href="#l29.39"></a><span id="l29.39" class="difflineminus">-var gContinueListener; // what listener is used to continue the test?</span>
<a href="#l29.40"></a><span id="l29.40"> var gHeader; // the current message db header</span>
<a href="#l29.41"></a><span id="l29.41" class="difflineminus">-var gChecks; // the function that will be used to check the results of the filter</span>
<a href="#l29.42"></a><span id="l29.42"> var gInboxCount; // the previous number of messages in the Inbox</span>
<a href="#l29.43"></a><span id="l29.43"> var gSubfolderCount; // the previous number of messages in the subfolder</span>
<a href="#l29.44"></a><span id="l29.44" class="difflineminus">-var gMoveCallbackCount; // the number of callbacks from the move listener</span>
<a href="#l29.45"></a><span id="l29.45" class="difflineminus">-var gCurTestNum; // the current test number</span>
<a href="#l29.46"></a><span id="l29.46"> var gMessage = &quot;draft1&quot;; // message file used as the test message</span>
<a href="#l29.47"></a><span id="l29.47"> </span>
<a href="#l29.48"></a><span id="l29.48"> // subject of the test message</span>
<a href="#l29.49"></a><span id="l29.49"> var gMessageSubject = &quot;Hello, did you receive my bugmail?&quot;;</span>
<a href="#l29.50"></a><span id="l29.50"> </span>
<a href="#l29.51"></a><span id="l29.51"> // a string in the body of the test message</span>
<a href="#l29.52"></a><span id="l29.52"> var gMessageInBody = &quot;an HTML message&quot;;</span>
<a href="#l29.53"></a><span id="l29.53"> </span>
<a href="#l29.54"></a><span id="l29.54"> // various object references</span>
<a href="#l29.55"></a><span id="l29.55" class="difflineminus">-var gCopyService = MailServices.copy;</span>
<a href="#l29.56"></a><span id="l29.56"> var gDbService = Cc[&quot;@mozilla.org/msgDatabase/msgDBService;1&quot;]</span>
<a href="#l29.57"></a><span id="l29.57">                              .getService(Ci.nsIMsgDBService);</span>
<a href="#l29.58"></a><span id="l29.58"> </span>
<a href="#l29.59"></a><span id="l29.59"> // Definition of tests. The test function name is the filter action</span>
<a href="#l29.60"></a><span id="l29.60"> // being tested, with &quot;Body&quot; appended to tests that use delayed</span>
<a href="#l29.61"></a><span id="l29.61"> // application of filters due to a body search</span>
<a href="#l29.62"></a><span id="l29.62" class="difflineminus">-var gTestArray =</span>
<a href="#l29.63"></a><span id="l29.63" class="difflineminus">-[</span>
<a href="#l29.64"></a><span id="l29.64" class="difflineplus">+var gTestArray = [</span>
<a href="#l29.65"></a><span id="l29.65">   setupIMAPPump,</span>
<a href="#l29.66"></a><span id="l29.66" class="difflineminus">-    // optionally set server parameters, here enabling debug messages</span>
<a href="#l29.67"></a><span id="l29.67" class="difflineminus">-  //function serverParms() {</span>
<a href="#l29.68"></a><span id="l29.68" class="difflineminus">-  //  IMAPPump.server.setDebugLevel(fsDebugAll);</span>
<a href="#l29.69"></a><span id="l29.69" class="difflineminus">-  //},</span>
<a href="#l29.70"></a><span id="l29.70" class="difflineplus">+  // optionally set server parameters, here enabling debug messages</span>
<a href="#l29.71"></a><span id="l29.71" class="difflineplus">+  // function serverParms() {</span>
<a href="#l29.72"></a><span id="l29.72" class="difflineplus">+  //   IMAPPump.server.setDebugLevel(fsDebugAll);</span>
<a href="#l29.73"></a><span id="l29.73" class="difflineplus">+  // },</span>
<a href="#l29.74"></a><span id="l29.74">   setupFilters,</span>
<a href="#l29.75"></a><span id="l29.75">   // The initial tests do not result in new messages added.</span>
<a href="#l29.76"></a><span id="l29.76">   async function MoveToFolder() {</span>
<a href="#l29.77"></a><span id="l29.77">     gAction.type = Ci.nsMsgFilterAction.MoveToFolder;</span>
<a href="#l29.78"></a><span id="l29.78">     gAction.targetFolderUri = gSubfolder.URI;</span>
<a href="#l29.79"></a><span id="l29.79">     gInboxCount = folderCount(IMAPPump.inbox);</span>
<a href="#l29.80"></a><span id="l29.80">     gSubfolderCount = folderCount(gSubfolder);</span>
<a href="#l29.81"></a><span id="l29.81">     await setupTest(gFilter, gAction);</span>
<a href="#l29.82"></a><span id="l29.82" class="difflineat">@@ -324,29 +306,27 @@ var gTestArray =</span>
<a href="#l29.83"></a><span id="l29.83">     gSubfolderCount = folderCount(gSubfolder);</span>
<a href="#l29.84"></a><span id="l29.84">     await setupTest(gBodyFilter, gAction);</span>
<a href="#l29.85"></a><span id="l29.85"> </span>
<a href="#l29.86"></a><span id="l29.86">     testCounts(true, 1, 1, 1);</span>
<a href="#l29.87"></a><span id="l29.87">     Assert.equal(gInboxCount + 1, folderCount(IMAPPump.inbox));</span>
<a href="#l29.88"></a><span id="l29.88">     Assert.equal(gSubfolderCount + 1, folderCount(gSubfolder));</span>
<a href="#l29.89"></a><span id="l29.89">   },</span>
<a href="#l29.90"></a><span id="l29.90">   /**/</span>
<a href="#l29.91"></a><span id="l29.91" class="difflineminus">-  endTest</span>
<a href="#l29.92"></a><span id="l29.92" class="difflineplus">+  endTest,</span>
<a href="#l29.93"></a><span id="l29.93"> </span>
<a href="#l29.94"></a><span id="l29.94"> ];</span>
<a href="#l29.95"></a><span id="l29.95"> </span>
<a href="#l29.96"></a><span id="l29.96"> function run_test() {</span>
<a href="#l29.97"></a><span id="l29.97" class="difflineminus">-  //Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l29.98"></a><span id="l29.98" class="difflineplus">+  // Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l29.99"></a><span id="l29.99">   gTestArray.forEach(x =&gt; add_task(x));</span>
<a href="#l29.100"></a><span id="l29.100">   run_next_test();</span>
<a href="#l29.101"></a><span id="l29.101"> }</span>
<a href="#l29.102"></a><span id="l29.102"> </span>
<a href="#l29.103"></a><span id="l29.103" class="difflineminus">-function setupFilters()</span>
<a href="#l29.104"></a><span id="l29.104" class="difflineminus">-{</span>
<a href="#l29.105"></a><span id="l29.105" class="difflineminus">-</span>
<a href="#l29.106"></a><span id="l29.106" class="difflineplus">+function setupFilters() {</span>
<a href="#l29.107"></a><span id="l29.107">   // Create a non-body filter.</span>
<a href="#l29.108"></a><span id="l29.108">   let filterList = IMAPPump.incomingServer.getFilterList(null);</span>
<a href="#l29.109"></a><span id="l29.109">   gFilter = filterList.createFilter(&quot;subject&quot;);</span>
<a href="#l29.110"></a><span id="l29.110">   let searchTerm = gFilter.createTerm();</span>
<a href="#l29.111"></a><span id="l29.111">   searchTerm.attrib = Subject;</span>
<a href="#l29.112"></a><span id="l29.112">   searchTerm.op = Is;</span>
<a href="#l29.113"></a><span id="l29.113">   var value = searchTerm.value;</span>
<a href="#l29.114"></a><span id="l29.114">   value.attrib = Subject;</span>
<a href="#l29.115"></a><span id="l29.115" class="difflineat">@@ -378,231 +358,204 @@ function setupFilters()</span>
<a href="#l29.116"></a><span id="l29.116">   MailServices.mailSession.AddFolderListener(FolderListener, Ci.nsIFolderListener.event);</span>
<a href="#l29.117"></a><span id="l29.117">   gPreviousUnread = 0;</span>
<a href="#l29.118"></a><span id="l29.118"> </span>
<a href="#l29.119"></a><span id="l29.119">   // When a message body is not downloaded, and then later a filter is</span>
<a href="#l29.120"></a><span id="l29.120">   //   applied that requires a download of message bodies, then the previous</span>
<a href="#l29.121"></a><span id="l29.121">   //   bodies are downloaded - and the message filters are applied twice!</span>
<a href="#l29.122"></a><span id="l29.122">   //   See bug 1116228, but for now workaround by always downloading bodies.</span>
<a href="#l29.123"></a><span id="l29.123">   IMAPPump.incomingServer.downloadBodiesOnGetNewMail = true;</span>
<a href="#l29.124"></a><span id="l29.124" class="difflineminus">-</span>
<a href="#l29.125"></a><span id="l29.125"> }</span>
<a href="#l29.126"></a><span id="l29.126"> </span>
<a href="#l29.127"></a><span id="l29.127"> /*</span>
<a href="#l29.128"></a><span id="l29.128">  * functions used to support test setup and execution</span>
<a href="#l29.129"></a><span id="l29.129">  */</span>
<a href="#l29.130"></a><span id="l29.130"> </span>
<a href="#l29.131"></a><span id="l29.131"> // basic preparation done for each test</span>
<a href="#l29.132"></a><span id="l29.132" class="difflineminus">-async function setupTest(aFilter, aAction)</span>
<a href="#l29.133"></a><span id="l29.133" class="difflineminus">-{</span>
<a href="#l29.134"></a><span id="l29.134" class="difflineplus">+async function setupTest(aFilter, aAction) {</span>
<a href="#l29.135"></a><span id="l29.135">   let filterList = IMAPPump.incomingServer.getFilterList(null);</span>
<a href="#l29.136"></a><span id="l29.136">   while (filterList.filterCount)</span>
<a href="#l29.137"></a><span id="l29.137">     filterList.removeFilterAt(0);</span>
<a href="#l29.138"></a><span id="l29.138" class="difflineminus">-  if (aFilter)</span>
<a href="#l29.139"></a><span id="l29.139" class="difflineminus">-  {</span>
<a href="#l29.140"></a><span id="l29.140" class="difflineplus">+  if (aFilter) {</span>
<a href="#l29.141"></a><span id="l29.141">     aFilter.clearActionList();</span>
<a href="#l29.142"></a><span id="l29.142">     if (aAction) {</span>
<a href="#l29.143"></a><span id="l29.143">       aFilter.appendAction(aAction);</span>
<a href="#l29.144"></a><span id="l29.144">       filterList.insertFilterAt(0, aFilter);</span>
<a href="#l29.145"></a><span id="l29.145">     }</span>
<a href="#l29.146"></a><span id="l29.146">   }</span>
<a href="#l29.147"></a><span id="l29.147">   if (gInboxListener)</span>
<a href="#l29.148"></a><span id="l29.148">     gDbService.unregisterPendingListener(gInboxListener);</span>
<a href="#l29.149"></a><span id="l29.149"> </span>
<a href="#l29.150"></a><span id="l29.150">   IMAPPump.inbox.clearNewMessages();</span>
<a href="#l29.151"></a><span id="l29.151"> </span>
<a href="#l29.152"></a><span id="l29.152">   gInboxListener = new DBListener();</span>
<a href="#l29.153"></a><span id="l29.153">   gDbService.registerPendingListener(IMAPPump.inbox, gInboxListener);</span>
<a href="#l29.154"></a><span id="l29.154" class="difflineminus">-  gMoveCallbackCount = 0;</span>
<a href="#l29.155"></a><span id="l29.155">   IMAPPump.mailbox.addMessage(new imapMessage(specForFileName(gMessage),</span>
<a href="#l29.156"></a><span id="l29.156">                           IMAPPump.mailbox.uidnext++, []));</span>
<a href="#l29.157"></a><span id="l29.157">   let promiseUrlListener = new PromiseTestUtils.PromiseUrlListener();</span>
<a href="#l29.158"></a><span id="l29.158">   IMAPPump.inbox.updateFolderWithListener(null, promiseUrlListener);</span>
<a href="#l29.159"></a><span id="l29.159">   await promiseUrlListener.promise;</span>
<a href="#l29.160"></a><span id="l29.160">   await PromiseTestUtils.promiseDelay(200);</span>
<a href="#l29.161"></a><span id="l29.161"> }</span>
<a href="#l29.162"></a><span id="l29.162"> </span>
<a href="#l29.163"></a><span id="l29.163"> // Cleanup, null out everything, close all cached connections and stop the</span>
<a href="#l29.164"></a><span id="l29.164"> // server</span>
<a href="#l29.165"></a><span id="l29.165" class="difflineminus">-function endTest()</span>
<a href="#l29.166"></a><span id="l29.166" class="difflineminus">-{</span>
<a href="#l29.167"></a><span id="l29.167" class="difflineplus">+function endTest() {</span>
<a href="#l29.168"></a><span id="l29.168">   if (gInboxListener)</span>
<a href="#l29.169"></a><span id="l29.169">     gDbService.unregisterPendingListener(gInboxListener);</span>
<a href="#l29.170"></a><span id="l29.170">   gInboxListener = null;</span>
<a href="#l29.171"></a><span id="l29.171">   MailServices.mailSession.RemoveFolderListener(FolderListener);</span>
<a href="#l29.172"></a><span id="l29.172">   teardownIMAPPump();</span>
<a href="#l29.173"></a><span id="l29.173"> }</span>
<a href="#l29.174"></a><span id="l29.174"> </span>
<a href="#l29.175"></a><span id="l29.175"> /*</span>
<a href="#l29.176"></a><span id="l29.176">  * listener objects</span>
<a href="#l29.177"></a><span id="l29.177">  */</span>
<a href="#l29.178"></a><span id="l29.178"> </span>
<a href="#l29.179"></a><span id="l29.179"> // nsIFolderListener implementation</span>
<a href="#l29.180"></a><span id="l29.180"> var FolderListener = {</span>
<a href="#l29.181"></a><span id="l29.181" class="difflineminus">-  OnItemEvent: function OnItemEvent(aEventFolder, aEvent) {</span>
<a href="#l29.182"></a><span id="l29.182" class="difflineplus">+  OnItemEvent(aEventFolder, aEvent) {</span>
<a href="#l29.183"></a><span id="l29.183">     dump(&quot;received folder event &quot; + aEvent +</span>
<a href="#l29.184"></a><span id="l29.184">          &quot; folder &quot; + aEventFolder.name +</span>
<a href="#l29.185"></a><span id="l29.185">          &quot;\n&quot;);</span>
<a href="#l29.186"></a><span id="l29.186" class="difflineminus">-  }</span>
<a href="#l29.187"></a><span id="l29.187" class="difflineplus">+  },</span>
<a href="#l29.188"></a><span id="l29.188"> };</span>
<a href="#l29.189"></a><span id="l29.189"> </span>
<a href="#l29.190"></a><span id="l29.190"> // nsIDBChangeListener implementation. Counts of calls are kept, but not</span>
<a href="#l29.191"></a><span id="l29.191"> // currently used in the tests. Current role is to provide a reference</span>
<a href="#l29.192"></a><span id="l29.192"> // to the new message header (plus give some examples of using db listeners</span>
<a href="#l29.193"></a><span id="l29.193"> // in javascript).</span>
<a href="#l29.194"></a><span id="l29.194" class="difflineminus">-function DBListener()</span>
<a href="#l29.195"></a><span id="l29.195" class="difflineminus">-{</span>
<a href="#l29.196"></a><span id="l29.196" class="difflineplus">+function DBListener() {</span>
<a href="#l29.197"></a><span id="l29.197">   this.counts = {};</span>
<a href="#l29.198"></a><span id="l29.198">   let counts = this.counts;</span>
<a href="#l29.199"></a><span id="l29.199">   counts.onHdrFlagsChanged = 0;</span>
<a href="#l29.200"></a><span id="l29.200">   counts.onHdrDeleted = 0;</span>
<a href="#l29.201"></a><span id="l29.201">   counts.onHdrAdded = 0;</span>
<a href="#l29.202"></a><span id="l29.202">   counts.onParentChanged = 0;</span>
<a href="#l29.203"></a><span id="l29.203">   counts.onAnnouncerGoingAway = 0;</span>
<a href="#l29.204"></a><span id="l29.204">   counts.onReadChanged = 0;</span>
<a href="#l29.205"></a><span id="l29.205">   counts.onJunkScoreChanged = 0;</span>
<a href="#l29.206"></a><span id="l29.206">   counts.onHdrPropertyChanged = 0;</span>
<a href="#l29.207"></a><span id="l29.207">   counts.onEvent = 0;</span>
<a href="#l29.208"></a><span id="l29.208"> }</span>
<a href="#l29.209"></a><span id="l29.209"> </span>
<a href="#l29.210"></a><span id="l29.210" class="difflineminus">-DBListener.prototype =</span>
<a href="#l29.211"></a><span id="l29.211" class="difflineminus">-{</span>
<a href="#l29.212"></a><span id="l29.212" class="difflineminus">-  onHdrFlagsChanged:</span>
<a href="#l29.213"></a><span id="l29.213" class="difflineminus">-    function onHdrFlagsChanged(aHdrChanged, aOldFlags, aNewFlags, aInstigator)</span>
<a href="#l29.214"></a><span id="l29.214" class="difflineminus">-    {</span>
<a href="#l29.215"></a><span id="l29.215" class="difflineminus">-      this.counts.onHdrFlagsChanged++;</span>
<a href="#l29.216"></a><span id="l29.216" class="difflineminus">-    },</span>
<a href="#l29.217"></a><span id="l29.217" class="difflineplus">+DBListener.prototype = {</span>
<a href="#l29.218"></a><span id="l29.218" class="difflineplus">+  onHdrFlagsChanged(aHdrChanged, aOldFlags, aNewFlags, aInstigator) {</span>
<a href="#l29.219"></a><span id="l29.219" class="difflineplus">+    this.counts.onHdrFlagsChanged++;</span>
<a href="#l29.220"></a><span id="l29.220" class="difflineplus">+  },</span>
<a href="#l29.221"></a><span id="l29.221" class="difflineplus">+</span>
<a href="#l29.222"></a><span id="l29.222" class="difflineplus">+  onHdrDeleted(aHdrChanged, aParentKey, Flags, aInstigator) {</span>
<a href="#l29.223"></a><span id="l29.223" class="difflineplus">+    this.counts.onHdrDeleted++;</span>
<a href="#l29.224"></a><span id="l29.224" class="difflineplus">+  },</span>
<a href="#l29.225"></a><span id="l29.225"> </span>
<a href="#l29.226"></a><span id="l29.226" class="difflineminus">-  onHdrDeleted:</span>
<a href="#l29.227"></a><span id="l29.227" class="difflineminus">-    function onHdrDeleted(aHdrChanged, aParentKey, Flags, aInstigator)</span>
<a href="#l29.228"></a><span id="l29.228" class="difflineminus">-    {</span>
<a href="#l29.229"></a><span id="l29.229" class="difflineminus">-      this.counts.onHdrDeleted++;</span>
<a href="#l29.230"></a><span id="l29.230" class="difflineminus">-    },</span>
<a href="#l29.231"></a><span id="l29.231" class="difflineplus">+  onHdrAdded(aHdrChanged, aParentKey, aFlags, aInstigator) {</span>
<a href="#l29.232"></a><span id="l29.232" class="difflineplus">+    this.counts.onHdrAdded++;</span>
<a href="#l29.233"></a><span id="l29.233" class="difflineplus">+    gHeader = aHdrChanged;</span>
<a href="#l29.234"></a><span id="l29.234" class="difflineplus">+  },</span>
<a href="#l29.235"></a><span id="l29.235"> </span>
<a href="#l29.236"></a><span id="l29.236" class="difflineminus">-  onHdrAdded:</span>
<a href="#l29.237"></a><span id="l29.237" class="difflineminus">-    function onHdrAdded(aHdrChanged, aParentKey, aFlags, aInstigator)</span>
<a href="#l29.238"></a><span id="l29.238" class="difflineminus">-    {</span>
<a href="#l29.239"></a><span id="l29.239" class="difflineminus">-      this.counts.onHdrAdded++;</span>
<a href="#l29.240"></a><span id="l29.240" class="difflineminus">-      gHeader = aHdrChanged;</span>
<a href="#l29.241"></a><span id="l29.241" class="difflineminus">-    },</span>
<a href="#l29.242"></a><span id="l29.242" class="difflineminus">-</span>
<a href="#l29.243"></a><span id="l29.243" class="difflineminus">-  onParentChanged:</span>
<a href="#l29.244"></a><span id="l29.244" class="difflineminus">-    function onParentChanged(aKeyChanged, oldParent, newParent, aInstigator)</span>
<a href="#l29.245"></a><span id="l29.245" class="difflineminus">-    {</span>
<a href="#l29.246"></a><span id="l29.246" class="difflineminus">-      this.counts.onParentChanged++;</span>
<a href="#l29.247"></a><span id="l29.247" class="difflineminus">-    },</span>
<a href="#l29.248"></a><span id="l29.248" class="difflineplus">+  onParentChanged(aKeyChanged, oldParent, newParent, aInstigator) {</span>
<a href="#l29.249"></a><span id="l29.249" class="difflineplus">+    this.counts.onParentChanged++;</span>
<a href="#l29.250"></a><span id="l29.250" class="difflineplus">+  },</span>
<a href="#l29.251"></a><span id="l29.251"> </span>
<a href="#l29.252"></a><span id="l29.252" class="difflineminus">-  onAnnouncerGoingAway:</span>
<a href="#l29.253"></a><span id="l29.253" class="difflineminus">-    function onAnnouncerGoingAway(instigator)</span>
<a href="#l29.254"></a><span id="l29.254" class="difflineminus">-    {</span>
<a href="#l29.255"></a><span id="l29.255" class="difflineminus">-      if (gInboxListener)</span>
<a href="#l29.256"></a><span id="l29.256" class="difflineminus">-        try {</span>
<a href="#l29.257"></a><span id="l29.257" class="difflineminus">-          IMAPPump.inbox.msgDatabase.RemoveListener(gInboxListener);</span>
<a href="#l29.258"></a><span id="l29.258" class="difflineminus">-        }</span>
<a href="#l29.259"></a><span id="l29.259" class="difflineminus">-        catch (e) {dump(&quot; listener not found\n&quot;);}</span>
<a href="#l29.260"></a><span id="l29.260" class="difflineminus">-      this.counts.onAnnouncerGoingAway++;</span>
<a href="#l29.261"></a><span id="l29.261" class="difflineminus">-    },</span>
<a href="#l29.262"></a><span id="l29.262" class="difflineminus">-</span>
<a href="#l29.263"></a><span id="l29.263" class="difflineminus">-  onReadChanged:</span>
<a href="#l29.264"></a><span id="l29.264" class="difflineminus">-    function onReadChanged(aInstigator)</span>
<a href="#l29.265"></a><span id="l29.265" class="difflineminus">-    {</span>
<a href="#l29.266"></a><span id="l29.266" class="difflineminus">-      this.counts.onReadChanged++;</span>
<a href="#l29.267"></a><span id="l29.267" class="difflineminus">-    },</span>
<a href="#l29.268"></a><span id="l29.268" class="difflineplus">+  onAnnouncerGoingAway(instigator) {</span>
<a href="#l29.269"></a><span id="l29.269" class="difflineplus">+    if (gInboxListener) {</span>
<a href="#l29.270"></a><span id="l29.270" class="difflineplus">+      try {</span>
<a href="#l29.271"></a><span id="l29.271" class="difflineplus">+        IMAPPump.inbox.msgDatabase.RemoveListener(gInboxListener);</span>
<a href="#l29.272"></a><span id="l29.272" class="difflineplus">+      } catch (e) {</span>
<a href="#l29.273"></a><span id="l29.273" class="difflineplus">+        dump(&quot; listener not found\n&quot;);</span>
<a href="#l29.274"></a><span id="l29.274" class="difflineplus">+      }</span>
<a href="#l29.275"></a><span id="l29.275" class="difflineplus">+    }</span>
<a href="#l29.276"></a><span id="l29.276" class="difflineplus">+    this.counts.onAnnouncerGoingAway++;</span>
<a href="#l29.277"></a><span id="l29.277" class="difflineplus">+  },</span>
<a href="#l29.278"></a><span id="l29.278"> </span>
<a href="#l29.279"></a><span id="l29.279" class="difflineminus">-  onJunkScoreChanged:</span>
<a href="#l29.280"></a><span id="l29.280" class="difflineminus">-    function onJunkScoreChanged(aInstigator)</span>
<a href="#l29.281"></a><span id="l29.281" class="difflineminus">-    {</span>
<a href="#l29.282"></a><span id="l29.282" class="difflineminus">-      this.counts.onJunkScoreChanged++;</span>
<a href="#l29.283"></a><span id="l29.283" class="difflineminus">-    },</span>
<a href="#l29.284"></a><span id="l29.284" class="difflineplus">+  onReadChanged(aInstigator) {</span>
<a href="#l29.285"></a><span id="l29.285" class="difflineplus">+    this.counts.onReadChanged++;</span>
<a href="#l29.286"></a><span id="l29.286" class="difflineplus">+  },</span>
<a href="#l29.287"></a><span id="l29.287" class="difflineplus">+</span>
<a href="#l29.288"></a><span id="l29.288" class="difflineplus">+  onJunkScoreChanged(aInstigator) {</span>
<a href="#l29.289"></a><span id="l29.289" class="difflineplus">+    this.counts.onJunkScoreChanged++;</span>
<a href="#l29.290"></a><span id="l29.290" class="difflineplus">+  },</span>
<a href="#l29.291"></a><span id="l29.291"> </span>
<a href="#l29.292"></a><span id="l29.292" class="difflineminus">-  onHdrPropertyChanged:</span>
<a href="#l29.293"></a><span id="l29.293" class="difflineminus">-    function onHdrPropertyChanged(aHdrToChange, aPreChange, aStatus, aInstigator)</span>
<a href="#l29.294"></a><span id="l29.294" class="difflineminus">-    {</span>
<a href="#l29.295"></a><span id="l29.295" class="difflineminus">-      this.counts.onHdrPropertyChanged++;</span>
<a href="#l29.296"></a><span id="l29.296" class="difflineminus">-    },</span>
<a href="#l29.297"></a><span id="l29.297" class="difflineplus">+  onHdrPropertyChanged(aHdrToChange, aPreChange, aStatus, aInstigator) {</span>
<a href="#l29.298"></a><span id="l29.298" class="difflineplus">+    this.counts.onHdrPropertyChanged++;</span>
<a href="#l29.299"></a><span id="l29.299" class="difflineplus">+  },</span>
<a href="#l29.300"></a><span id="l29.300"> </span>
<a href="#l29.301"></a><span id="l29.301" class="difflineminus">-  onEvent:</span>
<a href="#l29.302"></a><span id="l29.302" class="difflineminus">-    function onEvent(aDB, aEvent)</span>
<a href="#l29.303"></a><span id="l29.303" class="difflineminus">-    {</span>
<a href="#l29.304"></a><span id="l29.304" class="difflineminus">-      this.counts.onEvent++;</span>
<a href="#l29.305"></a><span id="l29.305" class="difflineminus">-    },</span>
<a href="#l29.306"></a><span id="l29.306" class="difflineminus">-</span>
<a href="#l29.307"></a><span id="l29.307" class="difflineplus">+  onEvent(aDB, aEvent) {</span>
<a href="#l29.308"></a><span id="l29.308" class="difflineplus">+    this.counts.onEvent++;</span>
<a href="#l29.309"></a><span id="l29.309" class="difflineplus">+  },</span>
<a href="#l29.310"></a><span id="l29.310"> };</span>
<a href="#l29.311"></a><span id="l29.311"> </span>
<a href="#l29.312"></a><span id="l29.312"> /*</span>
<a href="#l29.313"></a><span id="l29.313">  * helper functions</span>
<a href="#l29.314"></a><span id="l29.314">  */</span>
<a href="#l29.315"></a><span id="l29.315"> </span>
<a href="#l29.316"></a><span id="l29.316"> // return the number of messages in a folder (and check that the</span>
<a href="#l29.317"></a><span id="l29.317"> // folder counts match the database counts)</span>
<a href="#l29.318"></a><span id="l29.318" class="difflineminus">-function folderCount(folder)</span>
<a href="#l29.319"></a><span id="l29.319" class="difflineminus">-{</span>
<a href="#l29.320"></a><span id="l29.320" class="difflineplus">+function folderCount(folder) {</span>
<a href="#l29.321"></a><span id="l29.321">   // count using the database</span>
<a href="#l29.322"></a><span id="l29.322">   let enumerator = folder.msgDatabase.EnumerateMessages();</span>
<a href="#l29.323"></a><span id="l29.323">   let dbCount = 0;</span>
<a href="#l29.324"></a><span id="l29.324" class="difflineminus">-  while (enumerator.hasMoreElements())</span>
<a href="#l29.325"></a><span id="l29.325" class="difflineminus">-  {</span>
<a href="#l29.326"></a><span id="l29.326" class="difflineplus">+  while (enumerator.hasMoreElements()) {</span>
<a href="#l29.327"></a><span id="l29.327">     dbCount++;</span>
<a href="#l29.328"></a><span id="l29.328" class="difflineminus">-    let hdr = enumerator.getNext();</span>
<a href="#l29.329"></a><span id="l29.329" class="difflineplus">+    enumerator.getNext();</span>
<a href="#l29.330"></a><span id="l29.330">   }</span>
<a href="#l29.331"></a><span id="l29.331"> </span>
<a href="#l29.332"></a><span id="l29.332">   // count using the folder</span>
<a href="#l29.333"></a><span id="l29.333" class="difflineminus">-  let folderCount = folder.getTotalMessages(false);</span>
<a href="#l29.334"></a><span id="l29.334" class="difflineplus">+  let count = folder.getTotalMessages(false);</span>
<a href="#l29.335"></a><span id="l29.335"> </span>
<a href="#l29.336"></a><span id="l29.336">   // compare the two</span>
<a href="#l29.337"></a><span id="l29.337" class="difflineminus">-  Assert.equal(dbCount, folderCount);</span>
<a href="#l29.338"></a><span id="l29.338" class="difflineplus">+  Assert.equal(dbCount, count);</span>
<a href="#l29.339"></a><span id="l29.339">   return dbCount;</span>
<a href="#l29.340"></a><span id="l29.340"> }</span>
<a href="#l29.341"></a><span id="l29.341"> </span>
<a href="#l29.342"></a><span id="l29.342"> // given a test file, return the file uri spec</span>
<a href="#l29.343"></a><span id="l29.343" class="difflineminus">-function specForFileName(aFileName)</span>
<a href="#l29.344"></a><span id="l29.344" class="difflineminus">-{</span>
<a href="#l29.345"></a><span id="l29.345" class="difflineplus">+function specForFileName(aFileName) {</span>
<a href="#l29.346"></a><span id="l29.346">   let file = do_get_file(&quot;../../../data/&quot; + aFileName);</span>
<a href="#l29.347"></a><span id="l29.347">   let msgfileuri = Services.io.newFileURI(file).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l29.348"></a><span id="l29.348">   return msgfileuri.spec;</span>
<a href="#l29.349"></a><span id="l29.349"> }</span>
<a href="#l29.350"></a><span id="l29.350"> </span>
<a href="#l29.351"></a><span id="l29.351"> // shorthand for the inbox message summary database</span>
<a href="#l29.352"></a><span id="l29.352" class="difflineminus">-function db()</span>
<a href="#l29.353"></a><span id="l29.353" class="difflineminus">-{</span>
<a href="#l29.354"></a><span id="l29.354" class="difflineplus">+function db() {</span>
<a href="#l29.355"></a><span id="l29.355">   return IMAPPump.inbox.msgDatabase;</span>
<a href="#l29.356"></a><span id="l29.356"> }</span>
<a href="#l29.357"></a><span id="l29.357"> </span>
<a href="#l29.358"></a><span id="l29.358"> // static variables used in testCounts</span>
<a href="#l29.359"></a><span id="l29.359"> var gPreviousUnread = 0;</span>
<a href="#l29.360"></a><span id="l29.360"> </span>
<a href="#l29.361"></a><span id="l29.361"> // Test various counts.</span>
<a href="#l29.362"></a><span id="l29.362"> //</span>
<a href="#l29.363"></a><span id="l29.363"> //  aHasNew:         folder hasNew flag</span>
<a href="#l29.364"></a><span id="l29.364"> //  aUnreadDelta:    change in unread count for the folder</span>
<a href="#l29.365"></a><span id="l29.365"> //  aFolderNewDelta: change in new count for the folder</span>
<a href="#l29.366"></a><span id="l29.366"> //  aDbNewDelta:     change in new count for the database</span>
<a href="#l29.367"></a><span id="l29.367"> //</span>
<a href="#l29.368"></a><span id="l29.368" class="difflineminus">-function testCounts(aHasNew, aUnreadDelta, aFolderNewDelta, aDbNewDelta)</span>
<a href="#l29.369"></a><span id="l29.369" class="difflineminus">-{</span>
<a href="#l29.370"></a><span id="l29.370" class="difflineplus">+function testCounts(aHasNew, aUnreadDelta, aFolderNewDelta, aDbNewDelta) {</span>
<a href="#l29.371"></a><span id="l29.371">   try {</span>
<a href="#l29.372"></a><span id="l29.372" class="difflineminus">-  let folderNew = IMAPPump.inbox.getNumNewMessages(false);</span>
<a href="#l29.373"></a><span id="l29.373" class="difflineminus">-  let hasNew = IMAPPump.inbox.hasNewMessages;</span>
<a href="#l29.374"></a><span id="l29.374" class="difflineminus">-  let unread = IMAPPump.inbox.getNumUnread(false);</span>
<a href="#l29.375"></a><span id="l29.375" class="difflineminus">-  let countOut = {};</span>
<a href="#l29.376"></a><span id="l29.376" class="difflineminus">-  let arrayOut = {};</span>
<a href="#l29.377"></a><span id="l29.377" class="difflineminus">-  db().getNewList(countOut, arrayOut);</span>
<a href="#l29.378"></a><span id="l29.378" class="difflineminus">-  let dbNew = countOut.value ? countOut.value : 0;</span>
<a href="#l29.379"></a><span id="l29.379" class="difflineminus">-  dump(&quot; hasNew: &quot; + hasNew +</span>
<a href="#l29.380"></a><span id="l29.380" class="difflineminus">-       &quot; unread: &quot; + unread +</span>
<a href="#l29.381"></a><span id="l29.381" class="difflineminus">-       &quot; folderNew: &quot; + folderNew +</span>
<a href="#l29.382"></a><span id="l29.382" class="difflineminus">-       &quot; dbNew: &quot; + dbNew +</span>
<a href="#l29.383"></a><span id="l29.383" class="difflineminus">-       &quot; prevUnread &quot; + gPreviousUnread +</span>
<a href="#l29.384"></a><span id="l29.384" class="difflineminus">-       &quot;\n&quot;);</span>
<a href="#l29.385"></a><span id="l29.385" class="difflineminus">-  Assert.equal(aHasNew, hasNew);</span>
<a href="#l29.386"></a><span id="l29.386" class="difflineminus">-  Assert.equal(aUnreadDelta, unread - gPreviousUnread);</span>
<a href="#l29.387"></a><span id="l29.387" class="difflineminus">-  gPreviousUnread = unread;</span>
<a href="#l29.388"></a><span id="l29.388" class="difflineminus">-  // This seems to be reset for each folder update.</span>
<a href="#l29.389"></a><span id="l29.389" class="difflineminus">-  //</span>
<a href="#l29.390"></a><span id="l29.390" class="difflineminus">-  // This check seems to be failing in SeaMonkey builds, yet I can see no ill</span>
<a href="#l29.391"></a><span id="l29.391" class="difflineminus">-  // effects of this in the actual program. Fixing this is complex because of</span>
<a href="#l29.392"></a><span id="l29.392" class="difflineminus">-  // the messiness of new count management (see bug 507638 for a</span>
<a href="#l29.393"></a><span id="l29.393" class="difflineminus">-  // refactoring proposal, and attachment 398899 on bug 514801 for one possible</span>
<a href="#l29.394"></a><span id="l29.394" class="difflineminus">-  // fix to this particular test). So I am disabling this.</span>
<a href="#l29.395"></a><span id="l29.395" class="difflineminus">-  //Assert.equal(aFolderNewDelta, folderNew);</span>
<a href="#l29.396"></a><span id="l29.396" class="difflineminus">-  Assert.equal(aDbNewDelta, dbNew);</span>
<a href="#l29.397"></a><span id="l29.397" class="difflineminus">-  } catch (e) {dump(e);}</span>
<a href="#l29.398"></a><span id="l29.398" class="difflineplus">+    let folderNew = IMAPPump.inbox.getNumNewMessages(false);</span>
<a href="#l29.399"></a><span id="l29.399" class="difflineplus">+    let hasNew = IMAPPump.inbox.hasNewMessages;</span>
<a href="#l29.400"></a><span id="l29.400" class="difflineplus">+    let unread = IMAPPump.inbox.getNumUnread(false);</span>
<a href="#l29.401"></a><span id="l29.401" class="difflineplus">+    let countOut = {};</span>
<a href="#l29.402"></a><span id="l29.402" class="difflineplus">+    let arrayOut = {};</span>
<a href="#l29.403"></a><span id="l29.403" class="difflineplus">+    db().getNewList(countOut, arrayOut);</span>
<a href="#l29.404"></a><span id="l29.404" class="difflineplus">+    let dbNew = countOut.value ? countOut.value : 0;</span>
<a href="#l29.405"></a><span id="l29.405" class="difflineplus">+    dump(&quot; hasNew: &quot; + hasNew +</span>
<a href="#l29.406"></a><span id="l29.406" class="difflineplus">+         &quot; unread: &quot; + unread +</span>
<a href="#l29.407"></a><span id="l29.407" class="difflineplus">+         &quot; folderNew: &quot; + folderNew +</span>
<a href="#l29.408"></a><span id="l29.408" class="difflineplus">+         &quot; dbNew: &quot; + dbNew +</span>
<a href="#l29.409"></a><span id="l29.409" class="difflineplus">+         &quot; prevUnread &quot; + gPreviousUnread +</span>
<a href="#l29.410"></a><span id="l29.410" class="difflineplus">+         &quot;\n&quot;);</span>
<a href="#l29.411"></a><span id="l29.411" class="difflineplus">+    Assert.equal(aHasNew, hasNew);</span>
<a href="#l29.412"></a><span id="l29.412" class="difflineplus">+    Assert.equal(aUnreadDelta, unread - gPreviousUnread);</span>
<a href="#l29.413"></a><span id="l29.413" class="difflineplus">+    gPreviousUnread = unread;</span>
<a href="#l29.414"></a><span id="l29.414" class="difflineplus">+    // This seems to be reset for each folder update.</span>
<a href="#l29.415"></a><span id="l29.415" class="difflineplus">+    //</span>
<a href="#l29.416"></a><span id="l29.416" class="difflineplus">+    // This check seems to be failing in SeaMonkey builds, yet I can see no ill</span>
<a href="#l29.417"></a><span id="l29.417" class="difflineplus">+    // effects of this in the actual program. Fixing this is complex because of</span>
<a href="#l29.418"></a><span id="l29.418" class="difflineplus">+    // the messiness of new count management (see bug 507638 for a</span>
<a href="#l29.419"></a><span id="l29.419" class="difflineplus">+    // refactoring proposal, and attachment 398899 on bug 514801 for one possible</span>
<a href="#l29.420"></a><span id="l29.420" class="difflineplus">+    // fix to this particular test). So I am disabling this.</span>
<a href="#l29.421"></a><span id="l29.421" class="difflineplus">+    // Assert.equal(aFolderNewDelta, folderNew);</span>
<a href="#l29.422"></a><span id="l29.422" class="difflineplus">+    Assert.equal(aDbNewDelta, dbNew);</span>
<a href="#l29.423"></a><span id="l29.423" class="difflineplus">+  } catch (e) {</span>
<a href="#l29.424"></a><span id="l29.424" class="difflineplus">+    dump(e);</span>
<a href="#l29.425"></a><span id="l29.425" class="difflineplus">+  }</span>
<a href="#l29.426"></a><span id="l29.426"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapFilterActionsPostplugin.js</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapFilterActionsPostplugin.js</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -1,60 +1,41 @@</span>
<a href="#l30.4"></a><span id="l30.4"> /*</span>
<a href="#l30.5"></a><span id="l30.5">  * This file tests imap filter actions post-plugin, which uses nsMsgFilterAfterTheFact</span>
<a href="#l30.6"></a><span id="l30.6">  *</span>
<a href="#l30.7"></a><span id="l30.7">  * Original author: Kent James &lt;kent@caspia.com&gt;</span>
<a href="#l30.8"></a><span id="l30.8">  * adapted from test_imapFilterActions.js</span>
<a href="#l30.9"></a><span id="l30.9">  */</span>
<a href="#l30.10"></a><span id="l30.10"> </span>
<a href="#l30.11"></a><span id="l30.11" class="difflineminus">-var {</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-  getFolderProperties,</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineminus">-  getSpecialFolderString,</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineminus">-  allAccountsSorted,</span>
<a href="#l30.15"></a><span id="l30.15" class="difflineminus">-  getMostRecentFolders,</span>
<a href="#l30.16"></a><span id="l30.16" class="difflineminus">-  folderNameCompare,</span>
<a href="#l30.17"></a><span id="l30.17" class="difflineminus">-} = ChromeUtils.import(&quot;resource:///modules/folderUtils.jsm&quot;);</span>
<a href="#l30.18"></a><span id="l30.18"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l30.19"></a><span id="l30.19"> </span>
<a href="#l30.20"></a><span id="l30.20" class="difflineminus">-var nsMsgSearchScope = Ci.nsMsgSearchScope;</span>
<a href="#l30.21"></a><span id="l30.21" class="difflineminus">-var nsMsgSearchAttrib = Ci.nsMsgSearchAttrib;</span>
<a href="#l30.22"></a><span id="l30.22" class="difflineminus">-var nsMsgSearchOp = Ci.nsMsgSearchOp;</span>
<a href="#l30.23"></a><span id="l30.23" class="difflineminus">-var Is = nsMsgSearchOp.Is;</span>
<a href="#l30.24"></a><span id="l30.24" class="difflineminus">-var Contains = nsMsgSearchOp.Contains;</span>
<a href="#l30.25"></a><span id="l30.25" class="difflineminus">-var Subject = nsMsgSearchAttrib.Subject;</span>
<a href="#l30.26"></a><span id="l30.26" class="difflineminus">-var Body = nsMsgSearchAttrib.Body;</span>
<a href="#l30.27"></a><span id="l30.27" class="difflineplus">+var Is = Ci.nsMsgSearchOp.Is;</span>
<a href="#l30.28"></a><span id="l30.28" class="difflineplus">+var Subject = Ci.nsMsgSearchAttrib.Subject;</span>
<a href="#l30.29"></a><span id="l30.29"> </span>
<a href="#l30.30"></a><span id="l30.30"> // Globals</span>
<a href="#l30.31"></a><span id="l30.31"> var gSubfolder; // a local message folder used as a target for moves and copies</span>
<a href="#l30.32"></a><span id="l30.32" class="difflineminus">-var gLastKey; // the last message key</span>
<a href="#l30.33"></a><span id="l30.33"> var gFilter; // a message filter with a subject search</span>
<a href="#l30.34"></a><span id="l30.34"> var gAction; // current message action (reused)</span>
<a href="#l30.35"></a><span id="l30.35"> var gInboxListener; // database listener object</span>
<a href="#l30.36"></a><span id="l30.36"> var gHeader; // the current message db header</span>
<a href="#l30.37"></a><span id="l30.37" class="difflineminus">-var gChecks; // the function that will be used to check the results of the filter</span>
<a href="#l30.38"></a><span id="l30.38"> var gInboxCount; // the previous number of messages in the Inbox</span>
<a href="#l30.39"></a><span id="l30.39"> var gSubfolderCount; // the previous number of messages in the subfolder</span>
<a href="#l30.40"></a><span id="l30.40" class="difflineminus">-var gMoveCallbackCount; // the number of callbacks from the move listener</span>
<a href="#l30.41"></a><span id="l30.41"> var gMessage = &quot;draft1&quot;; // message file used as the test message</span>
<a href="#l30.42"></a><span id="l30.42"> </span>
<a href="#l30.43"></a><span id="l30.43"> // subject of the test message</span>
<a href="#l30.44"></a><span id="l30.44"> var gMessageSubject = &quot;Hello, did you receive my bugmail?&quot;;</span>
<a href="#l30.45"></a><span id="l30.45"> </span>
<a href="#l30.46"></a><span id="l30.46" class="difflineminus">-// a string in the body of the test message</span>
<a href="#l30.47"></a><span id="l30.47" class="difflineminus">-var gMessageInBody = &quot;an HTML message&quot;;</span>
<a href="#l30.48"></a><span id="l30.48" class="difflineminus">-</span>
<a href="#l30.49"></a><span id="l30.49"> // various object references</span>
<a href="#l30.50"></a><span id="l30.50"> var gDbService = Cc[&quot;@mozilla.org/msgDatabase/msgDBService;1&quot;]</span>
<a href="#l30.51"></a><span id="l30.51">                              .getService(Ci.nsIMsgDBService);</span>
<a href="#l30.52"></a><span id="l30.52"> </span>
<a href="#l30.53"></a><span id="l30.53"> // Definition of tests. The test function name is the filter action</span>
<a href="#l30.54"></a><span id="l30.54"> // being tested, with &quot;Body&quot; appended to tests that use delayed</span>
<a href="#l30.55"></a><span id="l30.55"> // application of filters due to a body search</span>
<a href="#l30.56"></a><span id="l30.56" class="difflineminus">-var gTestArray =</span>
<a href="#l30.57"></a><span id="l30.57" class="difflineminus">-[</span>
<a href="#l30.58"></a><span id="l30.58" class="difflineplus">+var gTestArray = [</span>
<a href="#l30.59"></a><span id="l30.59">   setupIMAPPump,</span>
<a href="#l30.60"></a><span id="l30.60">   setupFilters,</span>
<a href="#l30.61"></a><span id="l30.61">   async function DoNothing() {</span>
<a href="#l30.62"></a><span id="l30.62">     gAction.type = Ci.nsMsgFilterAction.StopExecution;</span>
<a href="#l30.63"></a><span id="l30.63">     gInboxCount = folderCount(IMAPPump.inbox);</span>
<a href="#l30.64"></a><span id="l30.64">     await setupTest(gFilter, gAction);</span>
<a href="#l30.65"></a><span id="l30.65">     testCounts(false, 1, 0, 0);</span>
<a href="#l30.66"></a><span id="l30.66">     Assert.equal(gInboxCount + 1, folderCount(IMAPPump.inbox));</span>
<a href="#l30.67"></a><span id="l30.67" class="difflineat">@@ -166,34 +147,33 @@ var gTestArray =</span>
<a href="#l30.68"></a><span id="l30.68">     gSubfolderCount = folderCount(gSubfolder);</span>
<a href="#l30.69"></a><span id="l30.69">     await setupTest(gFilter, gAction);</span>
<a href="#l30.70"></a><span id="l30.70">     testCounts(true, 1, 1, 1);</span>
<a href="#l30.71"></a><span id="l30.71">     Assert.equal(gInboxCount + 1, folderCount(IMAPPump.inbox));</span>
<a href="#l30.72"></a><span id="l30.72">     Assert.equal(gSubfolderCount + 1, folderCount(gSubfolder));</span>
<a href="#l30.73"></a><span id="l30.73">   },</span>
<a href="#l30.74"></a><span id="l30.74">   async function Custom() {</span>
<a href="#l30.75"></a><span id="l30.75">     gAction.type = Ci.nsMsgFilterAction.Custom;</span>
<a href="#l30.76"></a><span id="l30.76" class="difflineminus">-    gAction.customId = 'mailnews@mozilla.org#testOffline';</span>
<a href="#l30.77"></a><span id="l30.77" class="difflineminus">-    gAction.strValue = 'true';</span>
<a href="#l30.78"></a><span id="l30.78" class="difflineplus">+    gAction.customId = &quot;mailnews@mozilla.org#testOffline&quot;;</span>
<a href="#l30.79"></a><span id="l30.79" class="difflineplus">+    gAction.strValue = &quot;true&quot;;</span>
<a href="#l30.80"></a><span id="l30.80">     actionTestOffline.needsBody = true;</span>
<a href="#l30.81"></a><span id="l30.81">     await setupTest(gFilter, gAction);</span>
<a href="#l30.82"></a><span id="l30.82">     testCounts(true, 1, 1, 1);</span>
<a href="#l30.83"></a><span id="l30.83">   },</span>
<a href="#l30.84"></a><span id="l30.84">   /**/</span>
<a href="#l30.85"></a><span id="l30.85">   endTest,</span>
<a href="#l30.86"></a><span id="l30.86"> ];</span>
<a href="#l30.87"></a><span id="l30.87"> </span>
<a href="#l30.88"></a><span id="l30.88"> function run_test() {</span>
<a href="#l30.89"></a><span id="l30.89">   Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l30.90"></a><span id="l30.90">   gTestArray.forEach(x =&gt; add_task(x));</span>
<a href="#l30.91"></a><span id="l30.91">   run_next_test();</span>
<a href="#l30.92"></a><span id="l30.92"> }</span>
<a href="#l30.93"></a><span id="l30.93"> </span>
<a href="#l30.94"></a><span id="l30.94" class="difflineminus">-function setupFilters()</span>
<a href="#l30.95"></a><span id="l30.95" class="difflineminus">-{</span>
<a href="#l30.96"></a><span id="l30.96" class="difflineplus">+function setupFilters() {</span>
<a href="#l30.97"></a><span id="l30.97"> // Create a non-body filter.</span>
<a href="#l30.98"></a><span id="l30.98">   let filterList = IMAPPump.incomingServer.getFilterList(null);</span>
<a href="#l30.99"></a><span id="l30.99">   gFilter = filterList.createFilter(&quot;subject&quot;);</span>
<a href="#l30.100"></a><span id="l30.100">   let searchTerm = gFilter.createTerm();</span>
<a href="#l30.101"></a><span id="l30.101">   searchTerm.attrib = Subject;</span>
<a href="#l30.102"></a><span id="l30.102">   searchTerm.op = Is;</span>
<a href="#l30.103"></a><span id="l30.103">   var value = searchTerm.value;</span>
<a href="#l30.104"></a><span id="l30.104">   value.attrib = Subject;</span>
<a href="#l30.105"></a><span id="l30.105" class="difflineat">@@ -206,270 +186,229 @@ function setupFilters()</span>
<a href="#l30.106"></a><span id="l30.106"> </span>
<a href="#l30.107"></a><span id="l30.107">   // an action that can be modified by tests</span>
<a href="#l30.108"></a><span id="l30.108">   gAction = gFilter.createAction();</span>
<a href="#l30.109"></a><span id="l30.109"> </span>
<a href="#l30.110"></a><span id="l30.110">   MailServices.filters.addCustomAction(actionTestOffline);</span>
<a href="#l30.111"></a><span id="l30.111">   MailServices.mailSession.AddFolderListener(FolderListener, Ci.nsIFolderListener.event);</span>
<a href="#l30.112"></a><span id="l30.112">   gSubfolder = localAccountUtils.rootFolder.createLocalSubfolder(&quot;Subfolder&quot;);</span>
<a href="#l30.113"></a><span id="l30.113">   gPreviousUnread = 0;</span>
<a href="#l30.114"></a><span id="l30.114" class="difflineminus">-  gPreviousDbNew = 0;</span>
<a href="#l30.115"></a><span id="l30.115"> }</span>
<a href="#l30.116"></a><span id="l30.116"> </span>
<a href="#l30.117"></a><span id="l30.117"> /*</span>
<a href="#l30.118"></a><span id="l30.118">  * functions used to support test setup and execution</span>
<a href="#l30.119"></a><span id="l30.119">  */</span>
<a href="#l30.120"></a><span id="l30.120"> </span>
<a href="#l30.121"></a><span id="l30.121"> // basic preparation done for each test</span>
<a href="#l30.122"></a><span id="l30.122" class="difflineminus">-async function setupTest(aFilter, aAction)</span>
<a href="#l30.123"></a><span id="l30.123" class="difflineminus">-{</span>
<a href="#l30.124"></a><span id="l30.124" class="difflineplus">+async function setupTest(aFilter, aAction) {</span>
<a href="#l30.125"></a><span id="l30.125">   let filterList = IMAPPump.incomingServer.getFilterList(null);</span>
<a href="#l30.126"></a><span id="l30.126">   while (filterList.filterCount)</span>
<a href="#l30.127"></a><span id="l30.127">     filterList.removeFilterAt(0);</span>
<a href="#l30.128"></a><span id="l30.128" class="difflineminus">-  if (aFilter)</span>
<a href="#l30.129"></a><span id="l30.129" class="difflineminus">-  {</span>
<a href="#l30.130"></a><span id="l30.130" class="difflineplus">+  if (aFilter) {</span>
<a href="#l30.131"></a><span id="l30.131">     aFilter.clearActionList();</span>
<a href="#l30.132"></a><span id="l30.132">     if (aAction) {</span>
<a href="#l30.133"></a><span id="l30.133">       aFilter.appendAction(aAction);</span>
<a href="#l30.134"></a><span id="l30.134">       filterList.insertFilterAt(0, aFilter);</span>
<a href="#l30.135"></a><span id="l30.135">     }</span>
<a href="#l30.136"></a><span id="l30.136">   }</span>
<a href="#l30.137"></a><span id="l30.137">   if (gInboxListener)</span>
<a href="#l30.138"></a><span id="l30.138">     gDbService.unregisterPendingListener(gInboxListener);</span>
<a href="#l30.139"></a><span id="l30.139"> </span>
<a href="#l30.140"></a><span id="l30.140">   gInboxListener = new DBListener();</span>
<a href="#l30.141"></a><span id="l30.141">   gDbService.registerPendingListener(IMAPPump.inbox, gInboxListener);</span>
<a href="#l30.142"></a><span id="l30.142" class="difflineminus">-  gMoveCallbackCount = 0;</span>
<a href="#l30.143"></a><span id="l30.143">   IMAPPump.mailbox.addMessage(new imapMessage(specForFileName(gMessage),</span>
<a href="#l30.144"></a><span id="l30.144">                           IMAPPump.mailbox.uidnext++, []));</span>
<a href="#l30.145"></a><span id="l30.145">   let promiseUrlListener = new PromiseTestUtils.PromiseUrlListener();</span>
<a href="#l30.146"></a><span id="l30.146">   IMAPPump.inbox.updateFolderWithListener(null, promiseUrlListener);</span>
<a href="#l30.147"></a><span id="l30.147">   await promiseUrlListener.promise;</span>
<a href="#l30.148"></a><span id="l30.148">   await PromiseTestUtils.promiseDelay(200);</span>
<a href="#l30.149"></a><span id="l30.149"> }</span>
<a href="#l30.150"></a><span id="l30.150"> </span>
<a href="#l30.151"></a><span id="l30.151"> // Cleanup, null out everything, close all cached connections and stop the</span>
<a href="#l30.152"></a><span id="l30.152"> // server</span>
<a href="#l30.153"></a><span id="l30.153" class="difflineminus">-function endTest()</span>
<a href="#l30.154"></a><span id="l30.154" class="difflineminus">-{</span>
<a href="#l30.155"></a><span id="l30.155" class="difflineplus">+function endTest() {</span>
<a href="#l30.156"></a><span id="l30.156">   if (gInboxListener)</span>
<a href="#l30.157"></a><span id="l30.157">     gDbService.unregisterPendingListener(gInboxListener);</span>
<a href="#l30.158"></a><span id="l30.158">   gInboxListener = null;</span>
<a href="#l30.159"></a><span id="l30.159">   MailServices.mailSession.RemoveFolderListener(FolderListener);</span>
<a href="#l30.160"></a><span id="l30.160">   teardownIMAPPump();</span>
<a href="#l30.161"></a><span id="l30.161"> }</span>
<a href="#l30.162"></a><span id="l30.162"> </span>
<a href="#l30.163"></a><span id="l30.163"> /*</span>
<a href="#l30.164"></a><span id="l30.164">  * listener objects</span>
<a href="#l30.165"></a><span id="l30.165">  */</span>
<a href="#l30.166"></a><span id="l30.166"> </span>
<a href="#l30.167"></a><span id="l30.167"> // nsIFolderListener implementation</span>
<a href="#l30.168"></a><span id="l30.168"> var FolderListener = {</span>
<a href="#l30.169"></a><span id="l30.169" class="difflineminus">-  OnItemEvent: function OnItemEvent(aEventFolder, aEvent) {</span>
<a href="#l30.170"></a><span id="l30.170" class="difflineplus">+  OnItemEvent(aEventFolder, aEvent) {</span>
<a href="#l30.171"></a><span id="l30.171">     dump(&quot;received folder event &quot; + aEvent +</span>
<a href="#l30.172"></a><span id="l30.172">          &quot; folder &quot; + aEventFolder.name +</span>
<a href="#l30.173"></a><span id="l30.173">          &quot;\n&quot;);</span>
<a href="#l30.174"></a><span id="l30.174" class="difflineminus">-  }</span>
<a href="#l30.175"></a><span id="l30.175" class="difflineplus">+  },</span>
<a href="#l30.176"></a><span id="l30.176"> };</span>
<a href="#l30.177"></a><span id="l30.177"> </span>
<a href="#l30.178"></a><span id="l30.178"> // nsIDBChangeListener implementation. Counts of calls are kept, but not</span>
<a href="#l30.179"></a><span id="l30.179"> // currently used in the tests. Current role is to provide a reference</span>
<a href="#l30.180"></a><span id="l30.180"> // to the new message header (plus give some examples of using db listeners</span>
<a href="#l30.181"></a><span id="l30.181"> // in javascript).</span>
<a href="#l30.182"></a><span id="l30.182" class="difflineminus">-function DBListener()</span>
<a href="#l30.183"></a><span id="l30.183" class="difflineminus">-{</span>
<a href="#l30.184"></a><span id="l30.184" class="difflineplus">+function DBListener() {</span>
<a href="#l30.185"></a><span id="l30.185">   this.counts = {};</span>
<a href="#l30.186"></a><span id="l30.186">   let counts = this.counts;</span>
<a href="#l30.187"></a><span id="l30.187">   counts.onHdrFlagsChanged = 0;</span>
<a href="#l30.188"></a><span id="l30.188">   counts.onHdrDeleted = 0;</span>
<a href="#l30.189"></a><span id="l30.189">   counts.onHdrAdded = 0;</span>
<a href="#l30.190"></a><span id="l30.190">   counts.onParentChanged = 0;</span>
<a href="#l30.191"></a><span id="l30.191">   counts.onAnnouncerGoingAway = 0;</span>
<a href="#l30.192"></a><span id="l30.192">   counts.onReadChanged = 0;</span>
<a href="#l30.193"></a><span id="l30.193">   counts.onJunkScoreChanged = 0;</span>
<a href="#l30.194"></a><span id="l30.194">   counts.onHdrPropertyChanged = 0;</span>
<a href="#l30.195"></a><span id="l30.195">   counts.onEvent = 0;</span>
<a href="#l30.196"></a><span id="l30.196"> }</span>
<a href="#l30.197"></a><span id="l30.197"> </span>
<a href="#l30.198"></a><span id="l30.198" class="difflineminus">-DBListener.prototype =</span>
<a href="#l30.199"></a><span id="l30.199" class="difflineminus">-{</span>
<a href="#l30.200"></a><span id="l30.200" class="difflineminus">-  onHdrFlagsChanged:</span>
<a href="#l30.201"></a><span id="l30.201" class="difflineminus">-    function onHdrFlagsChanged(aHdrChanged, aOldFlags, aNewFlags, aInstigator)</span>
<a href="#l30.202"></a><span id="l30.202" class="difflineminus">-    {</span>
<a href="#l30.203"></a><span id="l30.203" class="difflineminus">-      this.counts.onHdrFlagsChanged++;</span>
<a href="#l30.204"></a><span id="l30.204" class="difflineminus">-    },</span>
<a href="#l30.205"></a><span id="l30.205" class="difflineplus">+DBListener.prototype = {</span>
<a href="#l30.206"></a><span id="l30.206" class="difflineplus">+  onHdrFlagsChanged(aHdrChanged, aOldFlags, aNewFlags, aInstigator) {</span>
<a href="#l30.207"></a><span id="l30.207" class="difflineplus">+    this.counts.onHdrFlagsChanged++;</span>
<a href="#l30.208"></a><span id="l30.208" class="difflineplus">+  },</span>
<a href="#l30.209"></a><span id="l30.209" class="difflineplus">+</span>
<a href="#l30.210"></a><span id="l30.210" class="difflineplus">+  onHdrDeleted(aHdrChanged, aParentKey, Flags, aInstigator) {</span>
<a href="#l30.211"></a><span id="l30.211" class="difflineplus">+    this.counts.onHdrDeleted++;</span>
<a href="#l30.212"></a><span id="l30.212" class="difflineplus">+  },</span>
<a href="#l30.213"></a><span id="l30.213"> </span>
<a href="#l30.214"></a><span id="l30.214" class="difflineminus">-  onHdrDeleted:</span>
<a href="#l30.215"></a><span id="l30.215" class="difflineminus">-    function onHdrDeleted(aHdrChanged, aParentKey, Flags, aInstigator)</span>
<a href="#l30.216"></a><span id="l30.216" class="difflineminus">-    {</span>
<a href="#l30.217"></a><span id="l30.217" class="difflineminus">-      this.counts.onHdrDeleted++;</span>
<a href="#l30.218"></a><span id="l30.218" class="difflineminus">-    },</span>
<a href="#l30.219"></a><span id="l30.219" class="difflineplus">+  onHdrAdded(aHdrChanged, aParentKey, aFlags, aInstigator) {</span>
<a href="#l30.220"></a><span id="l30.220" class="difflineplus">+    this.counts.onHdrAdded++;</span>
<a href="#l30.221"></a><span id="l30.221" class="difflineplus">+    gHeader = aHdrChanged;</span>
<a href="#l30.222"></a><span id="l30.222" class="difflineplus">+  },</span>
<a href="#l30.223"></a><span id="l30.223"> </span>
<a href="#l30.224"></a><span id="l30.224" class="difflineminus">-  onHdrAdded:</span>
<a href="#l30.225"></a><span id="l30.225" class="difflineminus">-    function onHdrAdded(aHdrChanged, aParentKey, aFlags, aInstigator)</span>
<a href="#l30.226"></a><span id="l30.226" class="difflineminus">-    {</span>
<a href="#l30.227"></a><span id="l30.227" class="difflineminus">-      this.counts.onHdrAdded++;</span>
<a href="#l30.228"></a><span id="l30.228" class="difflineminus">-      gHeader = aHdrChanged;</span>
<a href="#l30.229"></a><span id="l30.229" class="difflineminus">-    },</span>
<a href="#l30.230"></a><span id="l30.230" class="difflineminus">-</span>
<a href="#l30.231"></a><span id="l30.231" class="difflineminus">-  onParentChanged:</span>
<a href="#l30.232"></a><span id="l30.232" class="difflineminus">-    function onParentChanged(aKeyChanged, oldParent, newParent, aInstigator)</span>
<a href="#l30.233"></a><span id="l30.233" class="difflineminus">-    {</span>
<a href="#l30.234"></a><span id="l30.234" class="difflineminus">-      this.counts.onParentChanged++;</span>
<a href="#l30.235"></a><span id="l30.235" class="difflineminus">-    },</span>
<a href="#l30.236"></a><span id="l30.236" class="difflineplus">+  onParentChanged(aKeyChanged, oldParent, newParent, aInstigator) {</span>
<a href="#l30.237"></a><span id="l30.237" class="difflineplus">+    this.counts.onParentChanged++;</span>
<a href="#l30.238"></a><span id="l30.238" class="difflineplus">+  },</span>
<a href="#l30.239"></a><span id="l30.239"> </span>
<a href="#l30.240"></a><span id="l30.240" class="difflineminus">-  onAnnouncerGoingAway:</span>
<a href="#l30.241"></a><span id="l30.241" class="difflineminus">-    function onAnnouncerGoingAway(instigator)</span>
<a href="#l30.242"></a><span id="l30.242" class="difflineminus">-    {</span>
<a href="#l30.243"></a><span id="l30.243" class="difflineminus">-      if (gInboxListener)</span>
<a href="#l30.244"></a><span id="l30.244" class="difflineminus">-        try {</span>
<a href="#l30.245"></a><span id="l30.245" class="difflineminus">-          IMAPPump.inbox.msgDatabase.RemoveListener(gInboxListener);</span>
<a href="#l30.246"></a><span id="l30.246" class="difflineminus">-        }</span>
<a href="#l30.247"></a><span id="l30.247" class="difflineminus">-        catch (e) {dump(&quot; listener not found\n&quot;);}</span>
<a href="#l30.248"></a><span id="l30.248" class="difflineminus">-      this.counts.onAnnouncerGoingAway++;</span>
<a href="#l30.249"></a><span id="l30.249" class="difflineminus">-    },</span>
<a href="#l30.250"></a><span id="l30.250" class="difflineminus">-</span>
<a href="#l30.251"></a><span id="l30.251" class="difflineminus">-  onReadChanged:</span>
<a href="#l30.252"></a><span id="l30.252" class="difflineminus">-    function onReadChanged(aInstigator)</span>
<a href="#l30.253"></a><span id="l30.253" class="difflineminus">-    {</span>
<a href="#l30.254"></a><span id="l30.254" class="difflineminus">-      this.counts.onReadChanged++;</span>
<a href="#l30.255"></a><span id="l30.255" class="difflineminus">-    },</span>
<a href="#l30.256"></a><span id="l30.256" class="difflineplus">+  onAnnouncerGoingAway(instigator) {</span>
<a href="#l30.257"></a><span id="l30.257" class="difflineplus">+    if (gInboxListener) {</span>
<a href="#l30.258"></a><span id="l30.258" class="difflineplus">+      try {</span>
<a href="#l30.259"></a><span id="l30.259" class="difflineplus">+        IMAPPump.inbox.msgDatabase.RemoveListener(gInboxListener);</span>
<a href="#l30.260"></a><span id="l30.260" class="difflineplus">+      } catch (e) {</span>
<a href="#l30.261"></a><span id="l30.261" class="difflineplus">+        dump(&quot; listener not found\n&quot;);</span>
<a href="#l30.262"></a><span id="l30.262" class="difflineplus">+      }</span>
<a href="#l30.263"></a><span id="l30.263" class="difflineplus">+    }</span>
<a href="#l30.264"></a><span id="l30.264" class="difflineplus">+    this.counts.onAnnouncerGoingAway++;</span>
<a href="#l30.265"></a><span id="l30.265" class="difflineplus">+  },</span>
<a href="#l30.266"></a><span id="l30.266"> </span>
<a href="#l30.267"></a><span id="l30.267" class="difflineminus">-  onJunkScoreChanged:</span>
<a href="#l30.268"></a><span id="l30.268" class="difflineminus">-    function onJunkScoreChanged(aInstigator)</span>
<a href="#l30.269"></a><span id="l30.269" class="difflineminus">-    {</span>
<a href="#l30.270"></a><span id="l30.270" class="difflineminus">-      this.counts.onJunkScoreChanged++;</span>
<a href="#l30.271"></a><span id="l30.271" class="difflineminus">-    },</span>
<a href="#l30.272"></a><span id="l30.272" class="difflineplus">+  onReadChanged(aInstigator) {</span>
<a href="#l30.273"></a><span id="l30.273" class="difflineplus">+    this.counts.onReadChanged++;</span>
<a href="#l30.274"></a><span id="l30.274" class="difflineplus">+  },</span>
<a href="#l30.275"></a><span id="l30.275" class="difflineplus">+</span>
<a href="#l30.276"></a><span id="l30.276" class="difflineplus">+  onJunkScoreChanged(aInstigator) {</span>
<a href="#l30.277"></a><span id="l30.277" class="difflineplus">+    this.counts.onJunkScoreChanged++;</span>
<a href="#l30.278"></a><span id="l30.278" class="difflineplus">+  },</span>
<a href="#l30.279"></a><span id="l30.279"> </span>
<a href="#l30.280"></a><span id="l30.280" class="difflineminus">-  onHdrPropertyChanged:</span>
<a href="#l30.281"></a><span id="l30.281" class="difflineminus">-    function onHdrPropertyChanged(aHdrToChange, aPreChange, aStatus, aInstigator)</span>
<a href="#l30.282"></a><span id="l30.282" class="difflineminus">-    {</span>
<a href="#l30.283"></a><span id="l30.283" class="difflineminus">-      this.counts.onHdrPropertyChanged++;</span>
<a href="#l30.284"></a><span id="l30.284" class="difflineminus">-    },</span>
<a href="#l30.285"></a><span id="l30.285" class="difflineplus">+  onHdrPropertyChanged(aHdrToChange, aPreChange, aStatus, aInstigator) {</span>
<a href="#l30.286"></a><span id="l30.286" class="difflineplus">+    this.counts.onHdrPropertyChanged++;</span>
<a href="#l30.287"></a><span id="l30.287" class="difflineplus">+  },</span>
<a href="#l30.288"></a><span id="l30.288"> </span>
<a href="#l30.289"></a><span id="l30.289" class="difflineminus">-  onEvent:</span>
<a href="#l30.290"></a><span id="l30.290" class="difflineminus">-    function onEvent(aDB, aEvent)</span>
<a href="#l30.291"></a><span id="l30.291" class="difflineminus">-    {</span>
<a href="#l30.292"></a><span id="l30.292" class="difflineminus">-      this.counts.onEvent++;</span>
<a href="#l30.293"></a><span id="l30.293" class="difflineminus">-    },</span>
<a href="#l30.294"></a><span id="l30.294" class="difflineminus">-</span>
<a href="#l30.295"></a><span id="l30.295" class="difflineplus">+  onEvent(aDB, aEvent) {</span>
<a href="#l30.296"></a><span id="l30.296" class="difflineplus">+    this.counts.onEvent++;</span>
<a href="#l30.297"></a><span id="l30.297" class="difflineplus">+  },</span>
<a href="#l30.298"></a><span id="l30.298"> };</span>
<a href="#l30.299"></a><span id="l30.299"> </span>
<a href="#l30.300"></a><span id="l30.300"> /*</span>
<a href="#l30.301"></a><span id="l30.301">  * helper functions</span>
<a href="#l30.302"></a><span id="l30.302">  */</span>
<a href="#l30.303"></a><span id="l30.303"> </span>
<a href="#l30.304"></a><span id="l30.304"> // return the number of messages in a folder (and check that the</span>
<a href="#l30.305"></a><span id="l30.305"> // folder counts match the database counts)</span>
<a href="#l30.306"></a><span id="l30.306" class="difflineminus">-function folderCount(folder)</span>
<a href="#l30.307"></a><span id="l30.307" class="difflineminus">-{</span>
<a href="#l30.308"></a><span id="l30.308" class="difflineplus">+function folderCount(folder) {</span>
<a href="#l30.309"></a><span id="l30.309">   // count using the database</span>
<a href="#l30.310"></a><span id="l30.310">   let enumerator = folder.msgDatabase.EnumerateMessages();</span>
<a href="#l30.311"></a><span id="l30.311">   let dbCount = 0;</span>
<a href="#l30.312"></a><span id="l30.312" class="difflineminus">-  while (enumerator.hasMoreElements())</span>
<a href="#l30.313"></a><span id="l30.313" class="difflineminus">-  {</span>
<a href="#l30.314"></a><span id="l30.314" class="difflineplus">+  while (enumerator.hasMoreElements()) {</span>
<a href="#l30.315"></a><span id="l30.315">     dbCount++;</span>
<a href="#l30.316"></a><span id="l30.316" class="difflineminus">-    let hdr = enumerator.getNext();</span>
<a href="#l30.317"></a><span id="l30.317" class="difflineplus">+    enumerator.getNext();</span>
<a href="#l30.318"></a><span id="l30.318">   }</span>
<a href="#l30.319"></a><span id="l30.319"> </span>
<a href="#l30.320"></a><span id="l30.320">   // count using the folder</span>
<a href="#l30.321"></a><span id="l30.321" class="difflineminus">-  let folderCount = folder.getTotalMessages(false);</span>
<a href="#l30.322"></a><span id="l30.322" class="difflineplus">+  let count = folder.getTotalMessages(false);</span>
<a href="#l30.323"></a><span id="l30.323"> </span>
<a href="#l30.324"></a><span id="l30.324">   // compare the two</span>
<a href="#l30.325"></a><span id="l30.325" class="difflineminus">-  Assert.equal(dbCount, folderCount);</span>
<a href="#l30.326"></a><span id="l30.326" class="difflineplus">+  Assert.equal(dbCount, count);</span>
<a href="#l30.327"></a><span id="l30.327">   return dbCount;</span>
<a href="#l30.328"></a><span id="l30.328"> }</span>
<a href="#l30.329"></a><span id="l30.329"> </span>
<a href="#l30.330"></a><span id="l30.330"> // given a test file, return the file uri spec</span>
<a href="#l30.331"></a><span id="l30.331" class="difflineminus">-function specForFileName(aFileName)</span>
<a href="#l30.332"></a><span id="l30.332" class="difflineminus">-{</span>
<a href="#l30.333"></a><span id="l30.333" class="difflineplus">+function specForFileName(aFileName) {</span>
<a href="#l30.334"></a><span id="l30.334">   let file = do_get_file(&quot;../../../data/&quot; + aFileName);</span>
<a href="#l30.335"></a><span id="l30.335">   let msgfileuri = Services.io.newFileURI(file).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l30.336"></a><span id="l30.336">   return msgfileuri.spec;</span>
<a href="#l30.337"></a><span id="l30.337"> }</span>
<a href="#l30.338"></a><span id="l30.338"> </span>
<a href="#l30.339"></a><span id="l30.339"> // shorthand for the inbox message summary database</span>
<a href="#l30.340"></a><span id="l30.340" class="difflineminus">-function db()</span>
<a href="#l30.341"></a><span id="l30.341" class="difflineminus">-{</span>
<a href="#l30.342"></a><span id="l30.342" class="difflineplus">+function db() {</span>
<a href="#l30.343"></a><span id="l30.343">   return IMAPPump.inbox.msgDatabase;</span>
<a href="#l30.344"></a><span id="l30.344"> }</span>
<a href="#l30.345"></a><span id="l30.345"> </span>
<a href="#l30.346"></a><span id="l30.346"> // static variables used in testCounts</span>
<a href="#l30.347"></a><span id="l30.347"> var gPreviousUnread;</span>
<a href="#l30.348"></a><span id="l30.348" class="difflineminus">-var gPreviousDbNew;</span>
<a href="#l30.349"></a><span id="l30.349"> </span>
<a href="#l30.350"></a><span id="l30.350"> // Test various counts.</span>
<a href="#l30.351"></a><span id="l30.351"> //</span>
<a href="#l30.352"></a><span id="l30.352"> //  aHasNew:         folder hasNew flag</span>
<a href="#l30.353"></a><span id="l30.353"> //  aUnreadDelta:    change in unread count for the folder</span>
<a href="#l30.354"></a><span id="l30.354"> //  aFolderNewDelta: change in new count for the folder</span>
<a href="#l30.355"></a><span id="l30.355"> //  aDbNewDelta:     change in new count for the database</span>
<a href="#l30.356"></a><span id="l30.356"> //</span>
<a href="#l30.357"></a><span id="l30.357" class="difflineminus">-function testCounts(aHasNew, aUnreadDelta, aFolderNewDelta, aDbNewDelta)</span>
<a href="#l30.358"></a><span id="l30.358" class="difflineminus">-{</span>
<a href="#l30.359"></a><span id="l30.359" class="difflineplus">+function testCounts(aHasNew, aUnreadDelta, aFolderNewDelta, aDbNewDelta) {</span>
<a href="#l30.360"></a><span id="l30.360">   try {</span>
<a href="#l30.361"></a><span id="l30.361">   let folderNew = IMAPPump.inbox.getNumNewMessages(false);</span>
<a href="#l30.362"></a><span id="l30.362">   let hasNew = IMAPPump.inbox.hasNewMessages;</span>
<a href="#l30.363"></a><span id="l30.363">   let unread = IMAPPump.inbox.getNumUnread(false);</span>
<a href="#l30.364"></a><span id="l30.364">   let countOut = {};</span>
<a href="#l30.365"></a><span id="l30.365">   let arrayOut = {};</span>
<a href="#l30.366"></a><span id="l30.366">   db().getNewList(countOut, arrayOut);</span>
<a href="#l30.367"></a><span id="l30.367">   let dbNew = countOut.value ? countOut.value : 0;</span>
<a href="#l30.368"></a><span id="l30.368">   dump(&quot; hasNew: &quot; + hasNew +</span>
<a href="#l30.369"></a><span id="l30.369">        &quot; unread: &quot; + unread +</span>
<a href="#l30.370"></a><span id="l30.370">        &quot; folderNew: &quot; + folderNew +</span>
<a href="#l30.371"></a><span id="l30.371">        &quot; dbNew: &quot; + dbNew +</span>
<a href="#l30.372"></a><span id="l30.372">        &quot; prevUnread &quot; + gPreviousUnread +</span>
<a href="#l30.373"></a><span id="l30.373">        &quot;\n&quot;);</span>
<a href="#l30.374"></a><span id="l30.374" class="difflineminus">-  //Assert.equal(aHasNew, hasNew);</span>
<a href="#l30.375"></a><span id="l30.375" class="difflineplus">+  // Assert.equal(aHasNew, hasNew);</span>
<a href="#l30.376"></a><span id="l30.376">   Assert.equal(aUnreadDelta, unread - gPreviousUnread);</span>
<a href="#l30.377"></a><span id="l30.377">   gPreviousUnread = unread;</span>
<a href="#l30.378"></a><span id="l30.378">   // This seems to be reset for each folder update.</span>
<a href="#l30.379"></a><span id="l30.379">   //</span>
<a href="#l30.380"></a><span id="l30.380">   // This check seems to be failing in SeaMonkey builds, yet I can see no ill</span>
<a href="#l30.381"></a><span id="l30.381">   // effects of this in the actual program. Fixing this is complex because of</span>
<a href="#l30.382"></a><span id="l30.382">   // the messiness of new count management (see bug 507638 for a</span>
<a href="#l30.383"></a><span id="l30.383">   // refactoring proposal, and attachment 398899 on bug 514801 for one possible</span>
<a href="#l30.384"></a><span id="l30.384">   // fix to this particular test). So I am disabling this.</span>
<a href="#l30.385"></a><span id="l30.385" class="difflineminus">-  //Assert.equal(aFolderNewDelta, folderNew);</span>
<a href="#l30.386"></a><span id="l30.386" class="difflineminus">-  //Assert.equal(aDbNewDelta, dbNew - gPreviousDbNew);</span>
<a href="#l30.387"></a><span id="l30.387" class="difflineminus">-  //gPreviousDbNew = dbNew;</span>
<a href="#l30.388"></a><span id="l30.388" class="difflineminus">-  } catch (e) {dump(e);}</span>
<a href="#l30.389"></a><span id="l30.389" class="difflineminus">-}</span>
<a href="#l30.390"></a><span id="l30.390" class="difflineminus">-</span>
<a href="#l30.391"></a><span id="l30.391" class="difflineminus">-// print the counts for debugging purposes in this test</span>
<a href="#l30.392"></a><span id="l30.392" class="difflineminus">-function printListener(listener)</span>
<a href="#l30.393"></a><span id="l30.393" class="difflineminus">-{</span>
<a href="#l30.394"></a><span id="l30.394" class="difflineminus">-  print(&quot;DBListener counts: &quot;);</span>
<a href="#l30.395"></a><span id="l30.395" class="difflineminus">-  for (var item in listener.counts) {</span>
<a href="#l30.396"></a><span id="l30.396" class="difflineminus">-      dump(item + &quot;: &quot; + listener.counts[item] + &quot; &quot;);</span>
<a href="#l30.397"></a><span id="l30.397" class="difflineplus">+  // Assert.equal(aFolderNewDelta, folderNew);</span>
<a href="#l30.398"></a><span id="l30.398" class="difflineplus">+  // Assert.equal(aDbNewDelta, dbNew - gPreviousDbNew);</span>
<a href="#l30.399"></a><span id="l30.399" class="difflineplus">+  // gPreviousDbNew = dbNew;</span>
<a href="#l30.400"></a><span id="l30.400" class="difflineplus">+  } catch (e) {</span>
<a href="#l30.401"></a><span id="l30.401" class="difflineplus">+    dump(e);</span>
<a href="#l30.402"></a><span id="l30.402">   }</span>
<a href="#l30.403"></a><span id="l30.403" class="difflineminus">-  dump(&quot;\n&quot;);</span>
<a href="#l30.404"></a><span id="l30.404"> }</span>
<a href="#l30.405"></a><span id="l30.405"> </span>
<a href="#l30.406"></a><span id="l30.406"> // custom action to test offline status</span>
<a href="#l30.407"></a><span id="l30.407" class="difflineminus">-var actionTestOffline =</span>
<a href="#l30.408"></a><span id="l30.408" class="difflineminus">-{</span>
<a href="#l30.409"></a><span id="l30.409" class="difflineplus">+var actionTestOffline = {</span>
<a href="#l30.410"></a><span id="l30.410">   id: &quot;mailnews@mozilla.org#testOffline&quot;,</span>
<a href="#l30.411"></a><span id="l30.411">   name: &quot;test if offline&quot;,</span>
<a href="#l30.412"></a><span id="l30.412" class="difflineminus">-  apply: function(aMsgHdrs, aActionValue, aListener, aType, aMsgWindow)</span>
<a href="#l30.413"></a><span id="l30.413" class="difflineminus">-  {</span>
<a href="#l30.414"></a><span id="l30.414" class="difflineminus">-    for (var i = 0; i &lt; aMsgHdrs.length; i++)</span>
<a href="#l30.415"></a><span id="l30.415" class="difflineminus">-    {</span>
<a href="#l30.416"></a><span id="l30.416" class="difflineplus">+  apply(aMsgHdrs, aActionValue, aListener, aType, aMsgWindow) {</span>
<a href="#l30.417"></a><span id="l30.417" class="difflineplus">+    for (let i = 0; i &lt; aMsgHdrs.length; i++) {</span>
<a href="#l30.418"></a><span id="l30.418">       var msgHdr = aMsgHdrs.queryElementAt(i, Ci.nsIMsgDBHdr);</span>
<a href="#l30.419"></a><span id="l30.419" class="difflineminus">-      let isOffline = (msgHdr.flags &amp; Ci.nsMsgMessageFlags.Offline) ? true : false;</span>
<a href="#l30.420"></a><span id="l30.420" class="difflineplus">+      let isOffline = !!((msgHdr.flags &amp; Ci.nsMsgMessageFlags.Offline));</span>
<a href="#l30.421"></a><span id="l30.421">       dump(&quot;in actionTestOffline, flags are &quot; + msgHdr.flags +</span>
<a href="#l30.422"></a><span id="l30.422">             &quot; subject is &quot; + msgHdr.subject +</span>
<a href="#l30.423"></a><span id="l30.423">             &quot; isOffline is &quot; + isOffline +</span>
<a href="#l30.424"></a><span id="l30.424">             &quot;\n&quot;);</span>
<a href="#l30.425"></a><span id="l30.425">       // XXX TODO: the offline flag is not set here when it should be in postplugin filters</span>
<a href="#l30.426"></a><span id="l30.426" class="difflineminus">-      //Assert.equal(isOffline, aActionValue == 'true');</span>
<a href="#l30.427"></a><span id="l30.427" class="difflineplus">+      // Assert.equal(isOffline, aActionValue == 'true');</span>
<a href="#l30.428"></a><span id="l30.428">       Assert.equal(msgHdr.subject, gMessageSubject);</span>
<a href="#l30.429"></a><span id="l30.429">     }</span>
<a href="#l30.430"></a><span id="l30.430">   },</span>
<a href="#l30.431"></a><span id="l30.431" class="difflineminus">-  isValidForType: function(type, scope) {return true;},</span>
<a href="#l30.432"></a><span id="l30.432" class="difflineplus">+  isValidForType(type, scope) { return true; },</span>
<a href="#l30.433"></a><span id="l30.433"> </span>
<a href="#l30.434"></a><span id="l30.434" class="difflineminus">-  validateActionValue: function(value, folder, type) { return null;},</span>
<a href="#l30.435"></a><span id="l30.435" class="difflineplus">+  validateActionValue(value, folder, type) { return null; },</span>
<a href="#l30.436"></a><span id="l30.436"> </span>
<a href="#l30.437"></a><span id="l30.437">   allowDuplicates: false,</span>
<a href="#l30.438"></a><span id="l30.438"> </span>
<a href="#l30.439"></a><span id="l30.439" class="difflineminus">-  needsBody: true // set during test setup</span>
<a href="#l30.440"></a><span id="l30.440" class="difflineplus">+  needsBody: true, // set during test setup</span>
<a href="#l30.441"></a><span id="l30.441"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapFlagChange.js</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapFlagChange.js</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -1,14 +1,17 @@</span>
<a href="#l31.4"></a><span id="l31.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l31.5"></a><span id="l31.5"> /*</span>
<a href="#l31.6"></a><span id="l31.6">  * Test to ensure that imap flag changes made from a different profile/machine</span>
<a href="#l31.7"></a><span id="l31.7">  * are stored in db.</span>
<a href="#l31.8"></a><span id="l31.8">  */</span>
<a href="#l31.9"></a><span id="l31.9"> </span>
<a href="#l31.10"></a><span id="l31.10" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l31.11"></a><span id="l31.11" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l31.13"></a><span id="l31.13"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l31.14"></a><span id="l31.14"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l31.15"></a><span id="l31.15"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l31.16"></a><span id="l31.16"> </span>
<a href="#l31.17"></a><span id="l31.17"> var gMessage;</span>
<a href="#l31.18"></a><span id="l31.18"> var gSecondFolder;</span>
<a href="#l31.19"></a><span id="l31.19"> var gSynthMessage;</span>
<a href="#l31.20"></a><span id="l31.20"> </span>
<a href="#l31.21"></a><span id="l31.21" class="difflineat">@@ -92,25 +95,25 @@ var tests = [</span>
<a href="#l31.22"></a><span id="l31.22">     IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l31.23"></a><span id="l31.23">     yield false;</span>
<a href="#l31.24"></a><span id="l31.24">   },</span>
<a href="#l31.25"></a><span id="l31.25">   function checkTagCleared() {</span>
<a href="#l31.26"></a><span id="l31.26">     let msgHdr = IMAPPump.inbox.msgDatabase.getMsgHdrForMessageID(gSynthMessage.messageId);</span>
<a href="#l31.27"></a><span id="l31.27">     let keywords = msgHdr.getStringProperty(&quot;keywords&quot;);</span>
<a href="#l31.28"></a><span id="l31.28">     Assert.ok(!keywords.includes(&quot;randomtag&quot;));</span>
<a href="#l31.29"></a><span id="l31.29">   },</span>
<a href="#l31.30"></a><span id="l31.30" class="difflineminus">-  teardown</span>
<a href="#l31.31"></a><span id="l31.31" class="difflineplus">+  teardown,</span>
<a href="#l31.32"></a><span id="l31.32"> ];</span>
<a href="#l31.33"></a><span id="l31.33"> </span>
<a href="#l31.34"></a><span id="l31.34"> function* setup() {</span>
<a href="#l31.35"></a><span id="l31.35">   Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l31.36"></a><span id="l31.36"> </span>
<a href="#l31.37"></a><span id="l31.37">   setupIMAPPump();</span>
<a href="#l31.38"></a><span id="l31.38"> </span>
<a href="#l31.39"></a><span id="l31.39" class="difflineminus">-  IMAPPump.daemon.createMailbox(&quot;secondFolder&quot;, {subscribed : true});</span>
<a href="#l31.40"></a><span id="l31.40" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;secondFolder&quot;, {subscribed: true});</span>
<a href="#l31.41"></a><span id="l31.41"> </span>
<a href="#l31.42"></a><span id="l31.42">   // build up a diverse list of messages</span>
<a href="#l31.43"></a><span id="l31.43">   let messages = [];</span>
<a href="#l31.44"></a><span id="l31.44">   let gMessageGenerator = new MessageGenerator();</span>
<a href="#l31.45"></a><span id="l31.45">   messages = messages.concat(gMessageGenerator.makeMessage());</span>
<a href="#l31.46"></a><span id="l31.46">   gSynthMessage = messages[0];</span>
<a href="#l31.47"></a><span id="l31.47"> </span>
<a href="#l31.48"></a><span id="l31.48">   let msgURI =</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapFolderCopy.js</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapFolderCopy.js</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -1,49 +1,45 @@</span>
<a href="#l32.4"></a><span id="l32.4"> // This file tests the folder copying with IMAP. In particular, we're</span>
<a href="#l32.5"></a><span id="l32.5"> // going to test copying local folders to imap servers, but other tests</span>
<a href="#l32.6"></a><span id="l32.6"> // could be added.</span>
<a href="#l32.7"></a><span id="l32.7"> </span>
<a href="#l32.8"></a><span id="l32.8" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l32.9"></a><span id="l32.9" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l32.10"></a><span id="l32.10" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l32.11"></a><span id="l32.11"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l32.12"></a><span id="l32.12"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l32.13"></a><span id="l32.13"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l32.14"></a><span id="l32.14"> </span>
<a href="#l32.15"></a><span id="l32.15"> var gEmptyLocal1, gEmptyLocal2, gEmptyLocal3, gNotEmptyLocal4;</span>
<a href="#l32.16"></a><span id="l32.16"> </span>
<a href="#l32.17"></a><span id="l32.17" class="difflineminus">-var {</span>
<a href="#l32.18"></a><span id="l32.18" class="difflineminus">-  getFolderProperties,</span>
<a href="#l32.19"></a><span id="l32.19" class="difflineminus">-  getSpecialFolderString,</span>
<a href="#l32.20"></a><span id="l32.20" class="difflineminus">-  allAccountsSorted,</span>
<a href="#l32.21"></a><span id="l32.21" class="difflineminus">-  getMostRecentFolders,</span>
<a href="#l32.22"></a><span id="l32.22" class="difflineminus">-  folderNameCompare,</span>
<a href="#l32.23"></a><span id="l32.23" class="difflineminus">-} = ChromeUtils.import(&quot;resource:///modules/folderUtils.jsm&quot;);</span>
<a href="#l32.24"></a><span id="l32.24"> var {toXPCOMArray} = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l32.25"></a><span id="l32.25"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l32.26"></a><span id="l32.26"> </span>
<a href="#l32.27"></a><span id="l32.27"> var tests = [</span>
<a href="#l32.28"></a><span id="l32.28">   setup,</span>
<a href="#l32.29"></a><span id="l32.29">   function* copyFolder1() {</span>
<a href="#l32.30"></a><span id="l32.30">     dump(&quot;gEmpty1 &quot; + gEmptyLocal1.URI + &quot;\n&quot;);</span>
<a href="#l32.31"></a><span id="l32.31" class="difflineminus">-    let folders = new Array;</span>
<a href="#l32.32"></a><span id="l32.32" class="difflineplus">+    let folders = [];</span>
<a href="#l32.33"></a><span id="l32.33">     folders.push(gEmptyLocal1.QueryInterface(Ci.nsIMsgFolder));</span>
<a href="#l32.34"></a><span id="l32.34">     let array = toXPCOMArray(folders, Ci.nsIMutableArray);</span>
<a href="#l32.35"></a><span id="l32.35">     MailServices.copy.CopyFolders(array, IMAPPump.inbox, false, CopyListener, null);</span>
<a href="#l32.36"></a><span id="l32.36">     yield false;</span>
<a href="#l32.37"></a><span id="l32.37">   },</span>
<a href="#l32.38"></a><span id="l32.38">   function* copyFolder2() {</span>
<a href="#l32.39"></a><span id="l32.39">     dump(&quot;gEmpty2 &quot; + gEmptyLocal2.URI + &quot;\n&quot;);</span>
<a href="#l32.40"></a><span id="l32.40" class="difflineminus">-    let folders = new Array;</span>
<a href="#l32.41"></a><span id="l32.41" class="difflineplus">+    let folders = [];</span>
<a href="#l32.42"></a><span id="l32.42">     folders.push(gEmptyLocal2);</span>
<a href="#l32.43"></a><span id="l32.43">     let array = toXPCOMArray(folders, Ci.nsIMutableArray);</span>
<a href="#l32.44"></a><span id="l32.44">     MailServices.copy.CopyFolders(array, IMAPPump.inbox, false, CopyListener, null);</span>
<a href="#l32.45"></a><span id="l32.45">     yield false;</span>
<a href="#l32.46"></a><span id="l32.46">   },</span>
<a href="#l32.47"></a><span id="l32.47">   function* copyFolder3() {</span>
<a href="#l32.48"></a><span id="l32.48">     dump(&quot;gEmpty3 &quot; + gEmptyLocal3.URI + &quot;\n&quot;);</span>
<a href="#l32.49"></a><span id="l32.49" class="difflineminus">-    let folders = new Array;</span>
<a href="#l32.50"></a><span id="l32.50" class="difflineplus">+    let folders = [];</span>
<a href="#l32.51"></a><span id="l32.51">     folders.push(gEmptyLocal3);</span>
<a href="#l32.52"></a><span id="l32.52">     let array = toXPCOMArray(folders, Ci.nsIMutableArray);</span>
<a href="#l32.53"></a><span id="l32.53">     MailServices.copy.CopyFolders(array, IMAPPump.inbox, false, CopyListener, null);</span>
<a href="#l32.54"></a><span id="l32.54">     yield false;</span>
<a href="#l32.55"></a><span id="l32.55">   },</span>
<a href="#l32.56"></a><span id="l32.56">   function verifyFolders() {</span>
<a href="#l32.57"></a><span id="l32.57">     let folder1 = IMAPPump.inbox.getChildNamed(&quot;empty 1&quot;);</span>
<a href="#l32.58"></a><span id="l32.58">     dump(&quot;found folder1\n&quot;);</span>
<a href="#l32.59"></a><span id="l32.59" class="difflineat">@@ -51,26 +47,26 @@ var tests = [</span>
<a href="#l32.60"></a><span id="l32.60">     dump(&quot;found folder2\n&quot;);</span>
<a href="#l32.61"></a><span id="l32.61">     let folder3 = IMAPPump.inbox.getChildNamed(&quot;empty 3&quot;);</span>
<a href="#l32.62"></a><span id="l32.62">     dump(&quot;found folder3\n&quot;);</span>
<a href="#l32.63"></a><span id="l32.63">     Assert.ok(folder1 !== null);</span>
<a href="#l32.64"></a><span id="l32.64">     Assert.ok(folder2 !== null);</span>
<a href="#l32.65"></a><span id="l32.65">     Assert.ok(folder3 !== null);</span>
<a href="#l32.66"></a><span id="l32.66">   },</span>
<a href="#l32.67"></a><span id="l32.67">   function* moveImapFolder1() {</span>
<a href="#l32.68"></a><span id="l32.68" class="difflineminus">-    let folders = new Array;</span>
<a href="#l32.69"></a><span id="l32.69" class="difflineplus">+    let folders = [];</span>
<a href="#l32.70"></a><span id="l32.70">     let folder1 = IMAPPump.inbox.getChildNamed(&quot;empty 1&quot;);</span>
<a href="#l32.71"></a><span id="l32.71">     let folder2 = IMAPPump.inbox.getChildNamed(&quot;empty 2&quot;);</span>
<a href="#l32.72"></a><span id="l32.72">     folders.push(folder2.QueryInterface(Ci.nsIMsgFolder));</span>
<a href="#l32.73"></a><span id="l32.73">     let array = toXPCOMArray(folders, Ci.nsIMutableArray);</span>
<a href="#l32.74"></a><span id="l32.74">     MailServices.copy.CopyFolders(array, folder1, true, CopyListener, null);</span>
<a href="#l32.75"></a><span id="l32.75">     yield false;</span>
<a href="#l32.76"></a><span id="l32.76">   },</span>
<a href="#l32.77"></a><span id="l32.77">   function* moveImapFolder2() {</span>
<a href="#l32.78"></a><span id="l32.78" class="difflineminus">-    let folders = new Array;</span>
<a href="#l32.79"></a><span id="l32.79" class="difflineplus">+    let folders = [];</span>
<a href="#l32.80"></a><span id="l32.80">     let folder1 = IMAPPump.inbox.getChildNamed(&quot;empty 1&quot;);</span>
<a href="#l32.81"></a><span id="l32.81">     let folder3 = IMAPPump.inbox.getChildNamed(&quot;empty 3&quot;);</span>
<a href="#l32.82"></a><span id="l32.82">     folders.push(folder3.QueryInterface(Ci.nsIMsgFolder));</span>
<a href="#l32.83"></a><span id="l32.83">     let array = toXPCOMArray(folders, Ci.nsIMutableArray);</span>
<a href="#l32.84"></a><span id="l32.84">     MailServices.copy.CopyFolders(array, folder1, true, CopyListener, null);</span>
<a href="#l32.85"></a><span id="l32.85">     yield false;</span>
<a href="#l32.86"></a><span id="l32.86">   },</span>
<a href="#l32.87"></a><span id="l32.87">   function verifyImapFolders() {</span>
<a href="#l32.88"></a><span id="l32.88" class="difflineat">@@ -80,31 +76,31 @@ var tests = [</span>
<a href="#l32.89"></a><span id="l32.89">     dump(&quot;found folder2\n&quot;);</span>
<a href="#l32.90"></a><span id="l32.90">     let folder3 = folder1.getChildNamed(&quot;empty 3&quot;);</span>
<a href="#l32.91"></a><span id="l32.91">     dump(&quot;found folder3\n&quot;);</span>
<a href="#l32.92"></a><span id="l32.92">     Assert.ok(folder1 !== null);</span>
<a href="#l32.93"></a><span id="l32.93">     Assert.ok(folder2 !== null);</span>
<a href="#l32.94"></a><span id="l32.94">     Assert.ok(folder3 !== null);</span>
<a href="#l32.95"></a><span id="l32.95">   },</span>
<a href="#l32.96"></a><span id="l32.96">   function* testImapFolderCopyFailure() {</span>
<a href="#l32.97"></a><span id="l32.97" class="difflineminus">-    let folders = new Array;</span>
<a href="#l32.98"></a><span id="l32.98" class="difflineplus">+    let folders = [];</span>
<a href="#l32.99"></a><span id="l32.99">     folders.push(gNotEmptyLocal4.QueryInterface(Ci.nsIMsgFolder));</span>
<a href="#l32.100"></a><span id="l32.100">     let array = toXPCOMArray(folders, Ci.nsIMutableArray);</span>
<a href="#l32.101"></a><span id="l32.101">     IMAPPump.daemon.commandToFail = &quot;APPEND&quot;;</span>
<a href="#l32.102"></a><span id="l32.102">     // we expect NS_MSG_ERROR_IMAP_COMMAND_FAILED;</span>
<a href="#l32.103"></a><span id="l32.103">     CopyListener._expectedStatus = 0x80550021;</span>
<a href="#l32.104"></a><span id="l32.104">     MailServices.copy.CopyFolders(array, IMAPPump.inbox, false, CopyListener, null);</span>
<a href="#l32.105"></a><span id="l32.105"> </span>
<a href="#l32.106"></a><span id="l32.106">     // In failure case OnStopCopy is sent twice, the first one comes from</span>
<a href="#l32.107"></a><span id="l32.107">     // nsMsgCopyService, the second one comes from nsImapFolderCopyState.</span>
<a href="#l32.108"></a><span id="l32.108">     yield false;</span>
<a href="#l32.109"></a><span id="l32.109"> </span>
<a href="#l32.110"></a><span id="l32.110">     yield false;</span>
<a href="#l32.111"></a><span id="l32.111">   },</span>
<a href="#l32.112"></a><span id="l32.112" class="difflineminus">-  teardown</span>
<a href="#l32.113"></a><span id="l32.113" class="difflineplus">+  teardown,</span>
<a href="#l32.114"></a><span id="l32.114"> ];</span>
<a href="#l32.115"></a><span id="l32.115"> </span>
<a href="#l32.116"></a><span id="l32.116"> function setup() {</span>
<a href="#l32.117"></a><span id="l32.117">   setupIMAPPump();</span>
<a href="#l32.118"></a><span id="l32.118"> </span>
<a href="#l32.119"></a><span id="l32.119">   gEmptyLocal1 = localAccountUtils.rootFolder.createLocalSubfolder(&quot;empty 1&quot;);</span>
<a href="#l32.120"></a><span id="l32.120">   gEmptyLocal2 = localAccountUtils.rootFolder.createLocalSubfolder(&quot;empty 2&quot;);</span>
<a href="#l32.121"></a><span id="l32.121">   gEmptyLocal3 = localAccountUtils.rootFolder.createLocalSubfolder(&quot;empty 3&quot;);</span>
<a href="#l32.122"></a><span id="l32.122" class="difflineat">@@ -114,33 +110,33 @@ function setup() {</span>
<a href="#l32.123"></a><span id="l32.123">   let message = messageGenerator.makeMessage();</span>
<a href="#l32.124"></a><span id="l32.124">   gNotEmptyLocal4.QueryInterface(Ci.nsIMsgLocalMailFolder);</span>
<a href="#l32.125"></a><span id="l32.125">   gNotEmptyLocal4.addMessage(message.toMboxString());</span>
<a href="#l32.126"></a><span id="l32.126"> </span>
<a href="#l32.127"></a><span id="l32.127">   // these hacks are required because we've created the inbox before</span>
<a href="#l32.128"></a><span id="l32.128">   // running initial folder discovery, and adding the folder bails</span>
<a href="#l32.129"></a><span id="l32.129">   // out before we set it as verified online, so we bail out, and</span>
<a href="#l32.130"></a><span id="l32.130">   // then remove the INBOX folder since it's not verified.</span>
<a href="#l32.131"></a><span id="l32.131" class="difflineminus">-  IMAPPump.inbox.hierarchyDelimiter = '/';</span>
<a href="#l32.132"></a><span id="l32.132" class="difflineplus">+  IMAPPump.inbox.hierarchyDelimiter = &quot;/&quot;;</span>
<a href="#l32.133"></a><span id="l32.133">   IMAPPump.inbox.verifiedAsOnlineFolder = true;</span>
<a href="#l32.134"></a><span id="l32.134"> }</span>
<a href="#l32.135"></a><span id="l32.135"> </span>
<a href="#l32.136"></a><span id="l32.136"> // nsIMsgCopyServiceListener implementation - runs next test when copy</span>
<a href="#l32.137"></a><span id="l32.137"> // is completed.</span>
<a href="#l32.138"></a><span id="l32.138"> var CopyListener = {</span>
<a href="#l32.139"></a><span id="l32.139" class="difflineminus">-  _expectedStatus : 0,</span>
<a href="#l32.140"></a><span id="l32.140" class="difflineminus">-  OnStartCopy: function() {},</span>
<a href="#l32.141"></a><span id="l32.141" class="difflineminus">-  OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l32.142"></a><span id="l32.142" class="difflineminus">-  SetMessageKey: function(aKey) {},</span>
<a href="#l32.143"></a><span id="l32.143" class="difflineminus">-  SetMessageId: function(aMessageId) {},</span>
<a href="#l32.144"></a><span id="l32.144" class="difflineminus">-  OnStopCopy: function(aStatus) {</span>
<a href="#l32.145"></a><span id="l32.145" class="difflineplus">+  _expectedStatus: 0,</span>
<a href="#l32.146"></a><span id="l32.146" class="difflineplus">+  OnStartCopy() {},</span>
<a href="#l32.147"></a><span id="l32.147" class="difflineplus">+  OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l32.148"></a><span id="l32.148" class="difflineplus">+  SetMessageKey(aKey) {},</span>
<a href="#l32.149"></a><span id="l32.149" class="difflineplus">+  SetMessageId(aMessageId) {},</span>
<a href="#l32.150"></a><span id="l32.150" class="difflineplus">+  OnStopCopy(aStatus) {</span>
<a href="#l32.151"></a><span id="l32.151">     // Check: message successfully copied.</span>
<a href="#l32.152"></a><span id="l32.152">     Assert.equal(aStatus, this._expectedStatus);</span>
<a href="#l32.153"></a><span id="l32.153">     async_driver();</span>
<a href="#l32.154"></a><span id="l32.154" class="difflineminus">-  }</span>
<a href="#l32.155"></a><span id="l32.155" class="difflineplus">+  },</span>
<a href="#l32.156"></a><span id="l32.156"> };</span>
<a href="#l32.157"></a><span id="l32.157"> </span>
<a href="#l32.158"></a><span id="l32.158"> function teardown() {</span>
<a href="#l32.159"></a><span id="l32.159">   teardownIMAPPump();</span>
<a href="#l32.160"></a><span id="l32.160"> }</span>
<a href="#l32.161"></a><span id="l32.161"> </span>
<a href="#l32.162"></a><span id="l32.162"> function run_test() {</span>
<a href="#l32.163"></a><span id="l32.163">   async_run_tests(tests);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapHdrChunking.js</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapHdrChunking.js</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -1,70 +1,70 @@</span>
<a href="#l33.4"></a><span id="l33.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l33.5"></a><span id="l33.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l33.6"></a><span id="l33.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l33.7"></a><span id="l33.7"> </span>
<a href="#l33.8"></a><span id="l33.8"> /*</span>
<a href="#l33.9"></a><span id="l33.9">  * Tests imap msg header download chunking</span>
<a href="#l33.10"></a><span id="l33.10">  */</span>
<a href="#l33.11"></a><span id="l33.11"> </span>
<a href="#l33.12"></a><span id="l33.12" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l33.14"></a><span id="l33.14" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l33.15"></a><span id="l33.15"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l33.16"></a><span id="l33.16"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l33.17"></a><span id="l33.17"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l33.18"></a><span id="l33.18"> </span>
<a href="#l33.19"></a><span id="l33.19"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l33.20"></a><span id="l33.20"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l33.21"></a><span id="l33.21"> // javascript mime emitter functions</span>
<a href="#l33.22"></a><span id="l33.22"> </span>
<a href="#l33.23"></a><span id="l33.23"> // IMAP pump</span>
<a href="#l33.24"></a><span id="l33.24"> </span>
<a href="#l33.25"></a><span id="l33.25"> setupIMAPPump();</span>
<a href="#l33.26"></a><span id="l33.26"> </span>
<a href="#l33.27"></a><span id="l33.27"> // Dummy message window so we can say the inbox is open in a window.</span>
<a href="#l33.28"></a><span id="l33.28" class="difflineminus">-var dummyMsgWindow =</span>
<a href="#l33.29"></a><span id="l33.29" class="difflineminus">-{</span>
<a href="#l33.30"></a><span id="l33.30" class="difflineminus">-  openFolder : IMAPPump.inbox,</span>
<a href="#l33.31"></a><span id="l33.31" class="difflineplus">+var dummyMsgWindow = {</span>
<a href="#l33.32"></a><span id="l33.32" class="difflineplus">+  openFolder: IMAPPump.inbox,</span>
<a href="#l33.33"></a><span id="l33.33">   QueryInterface: ChromeUtils.generateQI([Ci.nsIMsgWindow,</span>
<a href="#l33.34"></a><span id="l33.34" class="difflineminus">-                                          Ci.nsISupportsWeakReference])</span>
<a href="#l33.35"></a><span id="l33.35" class="difflineplus">+                                          Ci.nsISupportsWeakReference]),</span>
<a href="#l33.36"></a><span id="l33.36"> };</span>
<a href="#l33.37"></a><span id="l33.37"> </span>
<a href="#l33.38"></a><span id="l33.38"> var gFolderListener = {</span>
<a href="#l33.39"></a><span id="l33.39">   _gotNewMailBiff: false,</span>
<a href="#l33.40"></a><span id="l33.40" class="difflineminus">-  OnItemIntPropertyChanged : function(aItem, aProperty, aOldValue, aNewValue) {</span>
<a href="#l33.41"></a><span id="l33.41" class="difflineplus">+  OnItemIntPropertyChanged(aItem, aProperty, aOldValue, aNewValue) {</span>
<a href="#l33.42"></a><span id="l33.42">     if (aProperty == &quot;BiffState&quot; &amp;&amp;</span>
<a href="#l33.43"></a><span id="l33.43">         aNewValue == Ci.nsIMsgFolder.nsMsgBiffState_NewMail) {</span>
<a href="#l33.44"></a><span id="l33.44">       this._gotNewMailBiff = true;</span>
<a href="#l33.45"></a><span id="l33.45">       async_driver();</span>
<a href="#l33.46"></a><span id="l33.46">     }</span>
<a href="#l33.47"></a><span id="l33.47" class="difflineminus">-  }</span>
<a href="#l33.48"></a><span id="l33.48" class="difflineplus">+  },</span>
<a href="#l33.49"></a><span id="l33.49"> };</span>
<a href="#l33.50"></a><span id="l33.50"> </span>
<a href="#l33.51"></a><span id="l33.51"> var tests = [</span>
<a href="#l33.52"></a><span id="l33.52">   uploadImapMessages,</span>
<a href="#l33.53"></a><span id="l33.53">   testMessageFetched,</span>
<a href="#l33.54"></a><span id="l33.54">   testHdrsDownloaded,</span>
<a href="#l33.55"></a><span id="l33.55" class="difflineminus">-  endTest</span>
<a href="#l33.56"></a><span id="l33.56" class="difflineminus">-]</span>
<a href="#l33.57"></a><span id="l33.57" class="difflineplus">+  endTest,</span>
<a href="#l33.58"></a><span id="l33.58" class="difflineplus">+];</span>
<a href="#l33.59"></a><span id="l33.59"> </span>
<a href="#l33.60"></a><span id="l33.60"> // upload messages to the imap fake server Inbox</span>
<a href="#l33.61"></a><span id="l33.61" class="difflineminus">-function* uploadImapMessages()</span>
<a href="#l33.62"></a><span id="l33.62" class="difflineminus">-{</span>
<a href="#l33.63"></a><span id="l33.63" class="difflineplus">+function* uploadImapMessages() {</span>
<a href="#l33.64"></a><span id="l33.64">   // make 10 messages</span>
<a href="#l33.65"></a><span id="l33.65">   let messageGenerator = new MessageGenerator();</span>
<a href="#l33.66"></a><span id="l33.66">   let scenarioFactory = new MessageScenarioFactory(messageGenerator);</span>
<a href="#l33.67"></a><span id="l33.67"> </span>
<a href="#l33.68"></a><span id="l33.68">   // build up a list of messages</span>
<a href="#l33.69"></a><span id="l33.69">   let messages = [];</span>
<a href="#l33.70"></a><span id="l33.70">   messages = messages.concat(scenarioFactory.directReply(10));</span>
<a href="#l33.71"></a><span id="l33.71"> </span>
<a href="#l33.72"></a><span id="l33.72">   // Add 10 messages with uids 1-10.</span>
<a href="#l33.73"></a><span id="l33.73" class="difflineminus">-  let imapInbox = IMAPPump.daemon.getMailbox(&quot;INBOX&quot;)</span>
<a href="#l33.74"></a><span id="l33.74" class="difflineplus">+  let imapInbox = IMAPPump.daemon.getMailbox(&quot;INBOX&quot;);</span>
<a href="#l33.75"></a><span id="l33.75">   // Create the imapMessages and store them on the mailbox</span>
<a href="#l33.76"></a><span id="l33.76" class="difflineminus">-  messages.forEach(function (message)</span>
<a href="#l33.77"></a><span id="l33.77" class="difflineminus">-  {</span>
<a href="#l33.78"></a><span id="l33.78" class="difflineplus">+  messages.forEach(function(message) {</span>
<a href="#l33.79"></a><span id="l33.79">     let dataUri = Services.io.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l33.80"></a><span id="l33.80">                                      btoa(message.toMessageString()));</span>
<a href="#l33.81"></a><span id="l33.81">     imapInbox.addMessage(new imapMessage(dataUri.spec, imapInbox.uidnext++, []));</span>
<a href="#l33.82"></a><span id="l33.82">   });</span>
<a href="#l33.83"></a><span id="l33.83">   // updateFolderWithListener with null for nsIMsgWindow makes biff notify.</span>
<a href="#l33.84"></a><span id="l33.84">   IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l33.85"></a><span id="l33.85">   yield false;</span>
<a href="#l33.86"></a><span id="l33.86"> }</span>
<a href="#l33.87"></a><span id="l33.87" class="difflineat">@@ -85,18 +85,17 @@ function* testHdrsDownloaded() {</span>
<a href="#l33.88"></a><span id="l33.88">   yield true;</span>
<a href="#l33.89"></a><span id="l33.89"> }</span>
<a href="#l33.90"></a><span id="l33.90"> </span>
<a href="#l33.91"></a><span id="l33.91"> // Cleanup</span>
<a href="#l33.92"></a><span id="l33.92"> function endTest() {</span>
<a href="#l33.93"></a><span id="l33.93">   teardownIMAPPump();</span>
<a href="#l33.94"></a><span id="l33.94"> }</span>
<a href="#l33.95"></a><span id="l33.95"> </span>
<a href="#l33.96"></a><span id="l33.96" class="difflineminus">-function run_test()</span>
<a href="#l33.97"></a><span id="l33.97" class="difflineminus">-{</span>
<a href="#l33.98"></a><span id="l33.98" class="difflineplus">+function run_test() {</span>
<a href="#l33.99"></a><span id="l33.99">   // We need to register the dummyMsgWindow so that we'll think the</span>
<a href="#l33.100"></a><span id="l33.100">   // Inbox is open in a folder and fetch headers in chunks.</span>
<a href="#l33.101"></a><span id="l33.101">   MailServices.mailSession.AddMsgWindow(dummyMsgWindow);</span>
<a href="#l33.102"></a><span id="l33.102">   MailServices.mailSession.AddFolderListener(gFolderListener,</span>
<a href="#l33.103"></a><span id="l33.103">                                              Ci.nsIFolderListener.intPropertyChanged);</span>
<a href="#l33.104"></a><span id="l33.104"> </span>
<a href="#l33.105"></a><span id="l33.105">   // Set chunk size to 3, so we'll have to chain 4 requests to get</span>
<a href="#l33.106"></a><span id="l33.106">   // 10 headers.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapHdrStreaming.js</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapHdrStreaming.js</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -1,106 +1,102 @@</span>
<a href="#l34.4"></a><span id="l34.4"> /**</span>
<a href="#l34.5"></a><span id="l34.5">  * This test checks if the imap message service code streams headers correctly.</span>
<a href="#l34.6"></a><span id="l34.6">  * It checks that streaming headers for messages stored for offline use works.</span>
<a href="#l34.7"></a><span id="l34.7">  * It doesn't test streaming messages that haven't been stored for offline use</span>
<a href="#l34.8"></a><span id="l34.8">  * because that's not implemented yet, and it's unclear if anyone will want it.</span>
<a href="#l34.9"></a><span id="l34.9">  */</span>
<a href="#l34.10"></a><span id="l34.10"> </span>
<a href="#l34.11"></a><span id="l34.11" class="difflineminus">-var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l34.14"></a><span id="l34.14" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l34.15"></a><span id="l34.15"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l34.16"></a><span id="l34.16"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l34.17"></a><span id="l34.17"> </span>
<a href="#l34.18"></a><span id="l34.18" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l34.19"></a><span id="l34.19" class="difflineplus">+/* import-globals-from ../../../test/resources/messageModifier.js */</span>
<a href="#l34.20"></a><span id="l34.20" class="difflineplus">+/* import-globals-from ../../../test/resources/messageInjection.js */</span>
<a href="#l34.21"></a><span id="l34.21"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l34.22"></a><span id="l34.22"> load(&quot;../../../resources/messageModifier.js&quot;);</span>
<a href="#l34.23"></a><span id="l34.23"> load(&quot;../../../resources/messageInjection.js&quot;);</span>
<a href="#l34.24"></a><span id="l34.24"> </span>
<a href="#l34.25"></a><span id="l34.25"> // IMAP pump</span>
<a href="#l34.26"></a><span id="l34.26"> </span>
<a href="#l34.27"></a><span id="l34.27"> setupIMAPPump();</span>
<a href="#l34.28"></a><span id="l34.28"> </span>
<a href="#l34.29"></a><span id="l34.29"> </span>
<a href="#l34.30"></a><span id="l34.30"> var gMsgFile1 = do_get_file(&quot;../../../data/bugmail10&quot;);</span>
<a href="#l34.31"></a><span id="l34.31"> var gMsgId1 = &quot;200806061706.m56H6RWT004933@mrapp54.mozilla.org&quot;;</span>
<a href="#l34.32"></a><span id="l34.32"> </span>
<a href="#l34.33"></a><span id="l34.33"> // We use this as a display consumer</span>
<a href="#l34.34"></a><span id="l34.34" class="difflineminus">-var streamListener =</span>
<a href="#l34.35"></a><span id="l34.35" class="difflineminus">-{</span>
<a href="#l34.36"></a><span id="l34.36" class="difflineplus">+var streamListener = {</span>
<a href="#l34.37"></a><span id="l34.37">   _data: &quot;&quot;,</span>
<a href="#l34.38"></a><span id="l34.38" class="difflineminus">-  _stream : null,</span>
<a href="#l34.39"></a><span id="l34.39" class="difflineplus">+  _stream: null,</span>
<a href="#l34.40"></a><span id="l34.40"> </span>
<a href="#l34.41"></a><span id="l34.41">   QueryInterface:</span>
<a href="#l34.42"></a><span id="l34.42">     ChromeUtils.generateQI([Ci.nsIStreamListener, Ci.nsIRequestObserver]),</span>
<a href="#l34.43"></a><span id="l34.43"> </span>
<a href="#l34.44"></a><span id="l34.44">   // nsIRequestObserver</span>
<a href="#l34.45"></a><span id="l34.45" class="difflineminus">-  onStartRequest: function(aRequest) {</span>
<a href="#l34.46"></a><span id="l34.46" class="difflineplus">+  onStartRequest(aRequest) {</span>
<a href="#l34.47"></a><span id="l34.47">   },</span>
<a href="#l34.48"></a><span id="l34.48" class="difflineminus">-  onStopRequest: function(aRequest, aStatusCode) {</span>
<a href="#l34.49"></a><span id="l34.49" class="difflineplus">+  onStopRequest(aRequest, aStatusCode) {</span>
<a href="#l34.50"></a><span id="l34.50">     Assert.equal(aStatusCode, 0);</span>
<a href="#l34.51"></a><span id="l34.51">     Assert.ok(this._data.includes(&quot;Content-Type&quot;));</span>
<a href="#l34.52"></a><span id="l34.52">     async_driver();</span>
<a href="#l34.53"></a><span id="l34.53">   },</span>
<a href="#l34.54"></a><span id="l34.54"> </span>
<a href="#l34.55"></a><span id="l34.55">   // nsIStreamListener</span>
<a href="#l34.56"></a><span id="l34.56" class="difflineminus">-  onDataAvailable: function(aRequest, aInputStream, aOffset, aCount) {</span>
<a href="#l34.57"></a><span id="l34.57" class="difflineplus">+  onDataAvailable(aRequest, aInputStream, aOffset, aCount) {</span>
<a href="#l34.58"></a><span id="l34.58">     if (this._stream == null) {</span>
<a href="#l34.59"></a><span id="l34.59">       this._stream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;].createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l34.60"></a><span id="l34.60">       this._stream.init(aInputStream);</span>
<a href="#l34.61"></a><span id="l34.61">     }</span>
<a href="#l34.62"></a><span id="l34.62">     this._data += this._stream.read(aCount);</span>
<a href="#l34.63"></a><span id="l34.63" class="difflineminus">-  }</span>
<a href="#l34.64"></a><span id="l34.64" class="difflineplus">+  },</span>
<a href="#l34.65"></a><span id="l34.65"> };</span>
<a href="#l34.66"></a><span id="l34.66"> </span>
<a href="#l34.67"></a><span id="l34.67"> // Adds some messages directly to a mailbox (eg new mail)</span>
<a href="#l34.68"></a><span id="l34.68" class="difflineminus">-function addMessagesToServer(messages, mailbox)</span>
<a href="#l34.69"></a><span id="l34.69" class="difflineminus">-{</span>
<a href="#l34.70"></a><span id="l34.70" class="difflineplus">+function addMessagesToServer(messages, mailbox) {</span>
<a href="#l34.71"></a><span id="l34.71">   // For every message we have, we need to convert it to a file:/// URI</span>
<a href="#l34.72"></a><span id="l34.72" class="difflineminus">-  messages.forEach(function (message)</span>
<a href="#l34.73"></a><span id="l34.73" class="difflineminus">-  {</span>
<a href="#l34.74"></a><span id="l34.74" class="difflineplus">+  messages.forEach(function(message) {</span>
<a href="#l34.75"></a><span id="l34.75">     let URI = Services.io.newFileURI(message.file).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l34.76"></a><span id="l34.76">     // Create the imapMessage and store it on the mailbox.</span>
<a href="#l34.77"></a><span id="l34.77">     mailbox.addMessage(new imapMessage(URI.spec, mailbox.uidnext++, []));</span>
<a href="#l34.78"></a><span id="l34.78">   });</span>
<a href="#l34.79"></a><span id="l34.79"> }</span>
<a href="#l34.80"></a><span id="l34.80"> </span>
<a href="#l34.81"></a><span id="l34.81" class="difflineminus">-var incomingServer, server;</span>
<a href="#l34.82"></a><span id="l34.82"> function run_test() {</span>
<a href="#l34.83"></a><span id="l34.83" class="difflineminus">-</span>
<a href="#l34.84"></a><span id="l34.84">   // Add a couple of messages to the INBOX</span>
<a href="#l34.85"></a><span id="l34.85">   // this is synchronous, afaik</span>
<a href="#l34.86"></a><span id="l34.86">   addMessagesToServer([{file: gMsgFile1, messageId: gMsgId1}],</span>
<a href="#l34.87"></a><span id="l34.87">                         IMAPPump.daemon.getMailbox(&quot;INBOX&quot;));</span>
<a href="#l34.88"></a><span id="l34.88">   Services.prefs.setBoolPref(&quot;mail.server.server1.autosync_offline_stores&quot;, false);</span>
<a href="#l34.89"></a><span id="l34.89">   async_run_tests(tests);</span>
<a href="#l34.90"></a><span id="l34.90">  }</span>
<a href="#l34.91"></a><span id="l34.91"> </span>
<a href="#l34.92"></a><span id="l34.92"> var tests = [</span>
<a href="#l34.93"></a><span id="l34.93">   test_updateFolder,</span>
<a href="#l34.94"></a><span id="l34.94">   test_downloadForOffline,</span>
<a href="#l34.95"></a><span id="l34.95">   test_streamHeaders,</span>
<a href="#l34.96"></a><span id="l34.96" class="difflineminus">-  endTest</span>
<a href="#l34.97"></a><span id="l34.97" class="difflineminus">-]</span>
<a href="#l34.98"></a><span id="l34.98" class="difflineplus">+  endTest,</span>
<a href="#l34.99"></a><span id="l34.99" class="difflineplus">+];</span>
<a href="#l34.100"></a><span id="l34.100"> </span>
<a href="#l34.101"></a><span id="l34.101"> function* test_updateFolder() {</span>
<a href="#l34.102"></a><span id="l34.102">   IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l34.103"></a><span id="l34.103">   yield false;</span>
<a href="#l34.104"></a><span id="l34.104"> }</span>
<a href="#l34.105"></a><span id="l34.105"> </span>
<a href="#l34.106"></a><span id="l34.106"> function* test_downloadForOffline() {</span>
<a href="#l34.107"></a><span id="l34.107">   IMAPPump.inbox.downloadAllForOffline(asyncUrlListener, null);</span>
<a href="#l34.108"></a><span id="l34.108">   yield false;</span>
<a href="#l34.109"></a><span id="l34.109"> }</span>
<a href="#l34.110"></a><span id="l34.110"> </span>
<a href="#l34.111"></a><span id="l34.111" class="difflineminus">-function* test_streamHeaders()</span>
<a href="#l34.112"></a><span id="l34.112" class="difflineminus">-{</span>
<a href="#l34.113"></a><span id="l34.113" class="difflineplus">+function* test_streamHeaders() {</span>
<a href="#l34.114"></a><span id="l34.114">   let newMsgHdr = IMAPPump.inbox.GetMessageHeader(1);</span>
<a href="#l34.115"></a><span id="l34.115">   let msgURI = newMsgHdr.folder.getUriForMsg(newMsgHdr);</span>
<a href="#l34.116"></a><span id="l34.116">   let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l34.117"></a><span id="l34.117">   let msgServ = messenger.messageServiceFromURI(msgURI);</span>
<a href="#l34.118"></a><span id="l34.118" class="difflineminus">-  msgServ.streamHeaders(msgURI, streamListener, asyncUrlListener,true);</span>
<a href="#l34.119"></a><span id="l34.119" class="difflineplus">+  msgServ.streamHeaders(msgURI, streamListener, asyncUrlListener, true);</span>
<a href="#l34.120"></a><span id="l34.120">   yield false;</span>
<a href="#l34.121"></a><span id="l34.121"> }</span>
<a href="#l34.122"></a><span id="l34.122"> </span>
<a href="#l34.123"></a><span id="l34.123" class="difflineminus">-function endTest()</span>
<a href="#l34.124"></a><span id="l34.124" class="difflineminus">-{</span>
<a href="#l34.125"></a><span id="l34.125" class="difflineplus">+function endTest() {</span>
<a href="#l34.126"></a><span id="l34.126">   teardownIMAPPump();</span>
<a href="#l34.127"></a><span id="l34.127"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapHighWater.js</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapHighWater.js</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -1,49 +1,49 @@</span>
<a href="#l35.4"></a><span id="l35.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l35.5"></a><span id="l35.5"> /*</span>
<a href="#l35.6"></a><span id="l35.6">  * Test to ensure that offline imap moves handle extremely high highwater</span>
<a href="#l35.7"></a><span id="l35.7">  * marks.</span>
<a href="#l35.8"></a><span id="l35.8">  */</span>
<a href="#l35.9"></a><span id="l35.9"> </span>
<a href="#l35.10"></a><span id="l35.10" class="difflineminus">-var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l35.11"></a><span id="l35.11"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l35.12"></a><span id="l35.12"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l35.14"></a><span id="l35.14" class="difflineplus">+/* import-globals-from ../../../test/resources/alertTestUtils.js */</span>
<a href="#l35.15"></a><span id="l35.15" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l35.16"></a><span id="l35.16" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l35.17"></a><span id="l35.17"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l35.18"></a><span id="l35.18"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l35.19"></a><span id="l35.19"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l35.20"></a><span id="l35.20"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l35.21"></a><span id="l35.21"> </span>
<a href="#l35.22"></a><span id="l35.22"> var gIMAPDaemon, gServer, gIMAPIncomingServer;</span>
<a href="#l35.23"></a><span id="l35.23"> </span>
<a href="#l35.24"></a><span id="l35.24"> var gIMAPInbox;</span>
<a href="#l35.25"></a><span id="l35.25"> var gFolder1, gRootFolder;</span>
<a href="#l35.26"></a><span id="l35.26"> </span>
<a href="#l35.27"></a><span id="l35.27"> // Adds some messages directly to a mailbox (eg new mail)</span>
<a href="#l35.28"></a><span id="l35.28" class="difflineminus">-function addMessagesToServer(messages, mailbox)</span>
<a href="#l35.29"></a><span id="l35.29" class="difflineminus">-{</span>
<a href="#l35.30"></a><span id="l35.30" class="difflineplus">+function addMessagesToServer(messages, mailbox) {</span>
<a href="#l35.31"></a><span id="l35.31">   // Create the imapMessages and store them on the mailbox</span>
<a href="#l35.32"></a><span id="l35.32" class="difflineminus">-  messages.forEach(function (message)</span>
<a href="#l35.33"></a><span id="l35.33" class="difflineminus">-  {</span>
<a href="#l35.34"></a><span id="l35.34" class="difflineplus">+  messages.forEach(function(message) {</span>
<a href="#l35.35"></a><span id="l35.35">     let dataUri = Services.io.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l35.36"></a><span id="l35.36">                                       btoa(message.toMessageString()));</span>
<a href="#l35.37"></a><span id="l35.37">     mailbox.addMessage(new imapMessage(dataUri.spec, mailbox.uidnext++, []));</span>
<a href="#l35.38"></a><span id="l35.38">   });</span>
<a href="#l35.39"></a><span id="l35.39"> }</span>
<a href="#l35.40"></a><span id="l35.40"> </span>
<a href="#l35.41"></a><span id="l35.41" class="difflineminus">-function run_test()</span>
<a href="#l35.42"></a><span id="l35.42" class="difflineminus">-{</span>
<a href="#l35.43"></a><span id="l35.43" class="difflineplus">+function run_test() {</span>
<a href="#l35.44"></a><span id="l35.44">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l35.45"></a><span id="l35.45"> </span>
<a href="#l35.46"></a><span id="l35.46">   /*</span>
<a href="#l35.47"></a><span id="l35.47">    * Set up an IMAP server.</span>
<a href="#l35.48"></a><span id="l35.48">    */</span>
<a href="#l35.49"></a><span id="l35.49">   gIMAPDaemon = new imapDaemon();</span>
<a href="#l35.50"></a><span id="l35.50">   gServer = makeServer(gIMAPDaemon, &quot;&quot;);</span>
<a href="#l35.51"></a><span id="l35.51" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;folder 1&quot;, {subscribed : true});</span>
<a href="#l35.52"></a><span id="l35.52" class="difflineplus">+  gIMAPDaemon.createMailbox(&quot;folder 1&quot;, {subscribed: true});</span>
<a href="#l35.53"></a><span id="l35.53">   gIMAPIncomingServer = createLocalIMAPServer(gServer.port);</span>
<a href="#l35.54"></a><span id="l35.54">   gIMAPIncomingServer.maximumConnectionsNumber = 1;</span>
<a href="#l35.55"></a><span id="l35.55"> </span>
<a href="#l35.56"></a><span id="l35.56">   // We need an identity so that updateFolder doesn't fail</span>
<a href="#l35.57"></a><span id="l35.57">   let localAccount = MailServices.accounts.createAccount();</span>
<a href="#l35.58"></a><span id="l35.58">   let identity = MailServices.accounts.createIdentity();</span>
<a href="#l35.59"></a><span id="l35.59">   localAccount.addIdentity(identity);</span>
<a href="#l35.60"></a><span id="l35.60">   localAccount.defaultIdentity = identity;</span>
<a href="#l35.61"></a><span id="l35.61" class="difflineat">@@ -72,17 +72,17 @@ function* setupFolders() {</span>
<a href="#l35.62"></a><span id="l35.62">   let messageGenerator = new MessageGenerator();</span>
<a href="#l35.63"></a><span id="l35.63">   let scenarioFactory = new MessageScenarioFactory(messageGenerator);</span>
<a href="#l35.64"></a><span id="l35.64"> </span>
<a href="#l35.65"></a><span id="l35.65">   // build up a list of messages</span>
<a href="#l35.66"></a><span id="l35.66">   let messages = [];</span>
<a href="#l35.67"></a><span id="l35.67">   messages = messages.concat(scenarioFactory.directReply(10));</span>
<a href="#l35.68"></a><span id="l35.68"> </span>
<a href="#l35.69"></a><span id="l35.69">   // Add 10 messages with uids 1-10.</span>
<a href="#l35.70"></a><span id="l35.70" class="difflineminus">-  let imapInbox = gIMAPDaemon.getMailbox(&quot;INBOX&quot;)</span>
<a href="#l35.71"></a><span id="l35.71" class="difflineplus">+  let imapInbox = gIMAPDaemon.getMailbox(&quot;INBOX&quot;);</span>
<a href="#l35.72"></a><span id="l35.72">   addMessagesToServer(messages, imapInbox);</span>
<a href="#l35.73"></a><span id="l35.73">   messages = [];</span>
<a href="#l35.74"></a><span id="l35.74">   messages = messages.concat(messageGenerator.makeMessage());</span>
<a href="#l35.75"></a><span id="l35.75">   // Add a single message to move target folder.</span>
<a href="#l35.76"></a><span id="l35.76">   addMessagesToServer(messages, gIMAPDaemon.getMailbox(&quot;folder 1&quot;));</span>
<a href="#l35.77"></a><span id="l35.77"> </span>
<a href="#l35.78"></a><span id="l35.78">   // Get the IMAP inbox...</span>
<a href="#l35.79"></a><span id="l35.79">   gRootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l35.80"></a><span id="l35.80" class="difflineat">@@ -98,18 +98,17 @@ function* doMoves() {</span>
<a href="#l35.81"></a><span id="l35.81">   gFolder1 = gRootFolder.getChildNamed(&quot;folder 1&quot;)</span>
<a href="#l35.82"></a><span id="l35.82">                .QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l35.83"></a><span id="l35.83">   gFolder1.updateFolderWithListener(null, UrlListener);</span>
<a href="#l35.84"></a><span id="l35.84">   yield false;</span>
<a href="#l35.85"></a><span id="l35.85">   // get five messages to move from Inbox to folder 1.</span>
<a href="#l35.86"></a><span id="l35.86">   let headers1 = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l35.87"></a><span id="l35.87">                    .createInstance(Ci.nsIMutableArray);</span>
<a href="#l35.88"></a><span id="l35.88">   let msgEnumerator = gIMAPInbox.msgDatabase.EnumerateMessages();</span>
<a href="#l35.89"></a><span id="l35.89" class="difflineminus">-  for (let i = 0; i &lt; 5 &amp;&amp; msgEnumerator.hasMoreElements(); i++)</span>
<a href="#l35.90"></a><span id="l35.90" class="difflineminus">-  {</span>
<a href="#l35.91"></a><span id="l35.91" class="difflineplus">+  for (let i = 0; i &lt; 5 &amp;&amp; msgEnumerator.hasMoreElements(); i++) {</span>
<a href="#l35.92"></a><span id="l35.92">     let header = msgEnumerator.getNext();</span>
<a href="#l35.93"></a><span id="l35.93">     if (header instanceof Ci.nsIMsgDBHdr)</span>
<a href="#l35.94"></a><span id="l35.94">       headers1.appendElement(header);</span>
<a href="#l35.95"></a><span id="l35.95">   }</span>
<a href="#l35.96"></a><span id="l35.96">   // this will add dummy headers with keys &gt; 0xffffff80</span>
<a href="#l35.97"></a><span id="l35.97">   MailServices.copy.CopyMessages(gIMAPInbox, headers1, gFolder1, true,</span>
<a href="#l35.98"></a><span id="l35.98">                                  CopyListener, gDummyMsgWindow, true);</span>
<a href="#l35.99"></a><span id="l35.99">   yield false;</span>
<a href="#l35.100"></a><span id="l35.100" class="difflineat">@@ -118,18 +117,17 @@ function* doMoves() {</span>
<a href="#l35.101"></a><span id="l35.101">   gFolder1.updateFolderWithListener(gDummyMsgWindow, UrlListener);</span>
<a href="#l35.102"></a><span id="l35.102">   yield false;</span>
<a href="#l35.103"></a><span id="l35.103">   // Check that playing back offline events gets rid of dummy</span>
<a href="#l35.104"></a><span id="l35.104">   // headers, and thus highWater is recalculated.</span>
<a href="#l35.105"></a><span id="l35.105">   Assert.equal(gFolder1.msgDatabase.dBFolderInfo.highWater, 6);</span>
<a href="#l35.106"></a><span id="l35.106">   headers1 = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l35.107"></a><span id="l35.107">                 .createInstance(Ci.nsIMutableArray);</span>
<a href="#l35.108"></a><span id="l35.108">   msgEnumerator = gIMAPInbox.msgDatabase.EnumerateMessages();</span>
<a href="#l35.109"></a><span id="l35.109" class="difflineminus">-  for (let i = 0; i &lt; 5 &amp;&amp; msgEnumerator.hasMoreElements(); i++)</span>
<a href="#l35.110"></a><span id="l35.110" class="difflineminus">-  {</span>
<a href="#l35.111"></a><span id="l35.111" class="difflineplus">+  for (let i = 0; i &lt; 5 &amp;&amp; msgEnumerator.hasMoreElements(); i++) {</span>
<a href="#l35.112"></a><span id="l35.112">     let header = msgEnumerator.getNext();</span>
<a href="#l35.113"></a><span id="l35.113">     if (header instanceof Ci.nsIMsgDBHdr)</span>
<a href="#l35.114"></a><span id="l35.114">       headers1.appendElement(header);</span>
<a href="#l35.115"></a><span id="l35.115">   }</span>
<a href="#l35.116"></a><span id="l35.116">   // Check that CopyMessages will handle having a high highwater mark.</span>
<a href="#l35.117"></a><span id="l35.117">   // It will thrown an exception if it can't.</span>
<a href="#l35.118"></a><span id="l35.118">   let msgHdr = gFolder1.msgDatabase.CreateNewHdr(0xfffffffd);</span>
<a href="#l35.119"></a><span id="l35.119">   gFolder1.msgDatabase.AddNewHdrToDB(msgHdr, false);</span>
<a href="#l35.120"></a><span id="l35.120" class="difflineat">@@ -139,58 +137,53 @@ function* doMoves() {</span>
<a href="#l35.121"></a><span id="l35.121">   gServer.performTest(&quot;UID COPY&quot;);</span>
<a href="#l35.122"></a><span id="l35.122"> </span>
<a href="#l35.123"></a><span id="l35.123">   gFolder1.msgDatabase.DeleteHeader(msgHdr, null, true, false);</span>
<a href="#l35.124"></a><span id="l35.124">   gIMAPInbox.updateFolderWithListener(null, UrlListener);</span>
<a href="#l35.125"></a><span id="l35.125">   yield false;</span>
<a href="#l35.126"></a><span id="l35.126">   // this should clear the dummy headers.</span>
<a href="#l35.127"></a><span id="l35.127">   gFolder1.updateFolderWithListener(gDummyMsgWindow, UrlListener);</span>
<a href="#l35.128"></a><span id="l35.128">   yield false;</span>
<a href="#l35.129"></a><span id="l35.129" class="difflineminus">-  let serverSink = gIMAPIncomingServer.QueryInterface(Ci.nsIImapServerSink);</span>
<a href="#l35.130"></a><span id="l35.130">   Assert.equal(gFolder1.msgDatabase.dBFolderInfo.highWater, 11);</span>
<a href="#l35.131"></a><span id="l35.131">   yield true;</span>
<a href="#l35.132"></a><span id="l35.132"> }</span>
<a href="#l35.133"></a><span id="l35.133"> </span>
<a href="#l35.134"></a><span id="l35.134" class="difflineminus">-var UrlListener =</span>
<a href="#l35.135"></a><span id="l35.135" class="difflineminus">-{</span>
<a href="#l35.136"></a><span id="l35.136" class="difflineminus">-  OnStartRunningUrl: function(url) { },</span>
<a href="#l35.137"></a><span id="l35.137" class="difflineminus">-  OnStopRunningUrl: function(url, rc)</span>
<a href="#l35.138"></a><span id="l35.138" class="difflineminus">-  {</span>
<a href="#l35.139"></a><span id="l35.139" class="difflineplus">+var UrlListener = {</span>
<a href="#l35.140"></a><span id="l35.140" class="difflineplus">+  OnStartRunningUrl(url) {},</span>
<a href="#l35.141"></a><span id="l35.141" class="difflineplus">+  OnStopRunningUrl(url, rc) {</span>
<a href="#l35.142"></a><span id="l35.142">     // Check for ok status.</span>
<a href="#l35.143"></a><span id="l35.143">     Assert.equal(rc, 0);</span>
<a href="#l35.144"></a><span id="l35.144">     async_driver();</span>
<a href="#l35.145"></a><span id="l35.145" class="difflineminus">-  }</span>
<a href="#l35.146"></a><span id="l35.146" class="difflineplus">+  },</span>
<a href="#l35.147"></a><span id="l35.147"> };</span>
<a href="#l35.148"></a><span id="l35.148"> </span>
<a href="#l35.149"></a><span id="l35.149"> // nsIMsgCopyServiceListener implementation</span>
<a href="#l35.150"></a><span id="l35.150" class="difflineminus">-var CopyListener =</span>
<a href="#l35.151"></a><span id="l35.151" class="difflineminus">-{</span>
<a href="#l35.152"></a><span id="l35.152" class="difflineminus">-  OnStartCopy: function() {},</span>
<a href="#l35.153"></a><span id="l35.153" class="difflineminus">-  OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l35.154"></a><span id="l35.154" class="difflineminus">-  SetMessageKey: function(aKey){},</span>
<a href="#l35.155"></a><span id="l35.155" class="difflineminus">-  SetMessageId: function(aMessageId) {},</span>
<a href="#l35.156"></a><span id="l35.156" class="difflineminus">-  OnStopCopy: function(aStatus){</span>
<a href="#l35.157"></a><span id="l35.157" class="difflineplus">+var CopyListener = {</span>
<a href="#l35.158"></a><span id="l35.158" class="difflineplus">+  OnStartCopy() {},</span>
<a href="#l35.159"></a><span id="l35.159" class="difflineplus">+  OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l35.160"></a><span id="l35.160" class="difflineplus">+  SetMessageKey(aKey) {},</span>
<a href="#l35.161"></a><span id="l35.161" class="difflineplus">+  SetMessageId(aMessageId) {},</span>
<a href="#l35.162"></a><span id="l35.162" class="difflineplus">+  OnStopCopy(aStatus) {</span>
<a href="#l35.163"></a><span id="l35.163">     Assert.equal(aStatus, 0);</span>
<a href="#l35.164"></a><span id="l35.164">     async_driver();</span>
<a href="#l35.165"></a><span id="l35.165" class="difflineminus">-  }</span>
<a href="#l35.166"></a><span id="l35.166" class="difflineplus">+  },</span>
<a href="#l35.167"></a><span id="l35.167"> };</span>
<a href="#l35.168"></a><span id="l35.168"> </span>
<a href="#l35.169"></a><span id="l35.169"> // Definition of tests</span>
<a href="#l35.170"></a><span id="l35.170"> var tests = [</span>
<a href="#l35.171"></a><span id="l35.171">   setupFolders,</span>
<a href="#l35.172"></a><span id="l35.172">   doMoves,</span>
<a href="#l35.173"></a><span id="l35.173" class="difflineminus">-  endTest</span>
<a href="#l35.174"></a><span id="l35.174" class="difflineminus">-]</span>
<a href="#l35.175"></a><span id="l35.175" class="difflineplus">+  endTest,</span>
<a href="#l35.176"></a><span id="l35.176" class="difflineplus">+];</span>
<a href="#l35.177"></a><span id="l35.177"> </span>
<a href="#l35.178"></a><span id="l35.178"> function actually_run_test() {</span>
<a href="#l35.179"></a><span id="l35.179">   async_run_tests(tests);</span>
<a href="#l35.180"></a><span id="l35.180"> }</span>
<a href="#l35.181"></a><span id="l35.181"> </span>
<a href="#l35.182"></a><span id="l35.182" class="difflineminus">-function* endTest()</span>
<a href="#l35.183"></a><span id="l35.183" class="difflineminus">-{</span>
<a href="#l35.184"></a><span id="l35.184" class="difflineplus">+function* endTest() {</span>
<a href="#l35.185"></a><span id="l35.185">   Services.io.offline = true;</span>
<a href="#l35.186"></a><span id="l35.186">   gServer.performTest(&quot;LOGOUT&quot;);</span>
<a href="#l35.187"></a><span id="l35.187"> //  gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l35.188"></a><span id="l35.188">   gServer.stop();</span>
<a href="#l35.189"></a><span id="l35.189">   let thread = gThreadManager.currentThread;</span>
<a href="#l35.190"></a><span id="l35.190">   while (thread.hasPendingEvents())</span>
<a href="#l35.191"></a><span id="l35.191">     thread.processNextEvent(true);</span>
<a href="#l35.192"></a><span id="l35.192">   yield true;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapID.js</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapID.js</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -1,39 +1,34 @@</span>
<a href="#l36.4"></a><span id="l36.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l36.5"></a><span id="l36.5"> /*</span>
<a href="#l36.6"></a><span id="l36.6">  * Test to ensure that we handle the RFC2197 ID command.</span>
<a href="#l36.7"></a><span id="l36.7">  */</span>
<a href="#l36.8"></a><span id="l36.8"> </span>
<a href="#l36.9"></a><span id="l36.9" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l36.10"></a><span id="l36.10"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l36.11"></a><span id="l36.11"> </span>
<a href="#l36.12"></a><span id="l36.12" class="difflineminus">-var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l36.13"></a><span id="l36.13"> var {PromiseTestUtils} = ChromeUtils.import(&quot;resource://testing-common/mailnews/PromiseTestUtils.jsm&quot;);</span>
<a href="#l36.14"></a><span id="l36.14"> </span>
<a href="#l36.15"></a><span id="l36.15"> var kIDResponse = &quot;(\&quot;name\&quot; \&quot;GImap\&quot; \&quot;vendor\&quot; \&quot;Google, Inc.\&quot; \&quot;support-url\&quot; \&quot;http://mail.google.com/support\&quot;)&quot;;</span>
<a href="#l36.16"></a><span id="l36.16"> </span>
<a href="#l36.17"></a><span id="l36.17"> add_task(async function setup() {</span>
<a href="#l36.18"></a><span id="l36.18">   setupIMAPPump(&quot;GMail&quot;);</span>
<a href="#l36.19"></a><span id="l36.19">   IMAPPump.daemon.idResponse = kIDResponse;</span>
<a href="#l36.20"></a><span id="l36.20"> </span>
<a href="#l36.21"></a><span id="l36.21">   // update folder to kick start tests.</span>
<a href="#l36.22"></a><span id="l36.22">   let promiseUrlListener = new PromiseTestUtils.PromiseUrlListener();</span>
<a href="#l36.23"></a><span id="l36.23">   IMAPPump.inbox.updateFolderWithListener(null, promiseUrlListener);</span>
<a href="#l36.24"></a><span id="l36.24">   await promiseUrlListener.promise;</span>
<a href="#l36.25"></a><span id="l36.25"> });</span>
<a href="#l36.26"></a><span id="l36.26"> </span>
<a href="#l36.27"></a><span id="l36.27"> add_task(async function updateInbox() {</span>
<a href="#l36.28"></a><span id="l36.28" class="difflineminus">-  let rootFolder = IMAPPump.incomingServer.rootFolder;</span>
<a href="#l36.29"></a><span id="l36.29">   let promiseUrlListener = new PromiseTestUtils.PromiseUrlListener();</span>
<a href="#l36.30"></a><span id="l36.30">   IMAPPump.inbox.updateFolderWithListener(null, promiseUrlListener);</span>
<a href="#l36.31"></a><span id="l36.31">   await promiseUrlListener.promise;</span>
<a href="#l36.32"></a><span id="l36.32"> });</span>
<a href="#l36.33"></a><span id="l36.33"> </span>
<a href="#l36.34"></a><span id="l36.34"> add_task(function checkIDHandling() {</span>
<a href="#l36.35"></a><span id="l36.35">   Assert.equal(IMAPPump.daemon.clientID, &quot;(\&quot;name\&quot; \&quot;xpcshell\&quot; \&quot;version\&quot; \&quot;1\&quot;)&quot;);</span>
<a href="#l36.36"></a><span id="l36.36">   Assert.equal(IMAPPump.incomingServer.serverIDPref, kIDResponse);</span>
<a href="#l36.37"></a><span id="l36.37"> });</span>
<a href="#l36.38"></a><span id="l36.38"> </span>
<a href="#l36.39"></a><span id="l36.39"> add_task(teardownIMAPPump);</span>
<a href="#l36.40"></a><span id="l36.40" class="difflineminus">-</span>
<a href="#l36.41"></a><span id="l36.41" class="difflineminus">-function run_test() {</span>
<a href="#l36.42"></a><span id="l36.42" class="difflineminus">-  run_next_test();</span>
<a href="#l36.43"></a><span id="l36.43" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapMove.js</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapMove.js</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -2,36 +2,37 @@</span>
<a href="#l37.4"></a><span id="l37.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l37.5"></a><span id="l37.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l37.6"></a><span id="l37.6"> </span>
<a href="#l37.7"></a><span id="l37.7"> // This tests that we use IMAP move if the IMAP server supports it.</span>
<a href="#l37.8"></a><span id="l37.8"> </span>
<a href="#l37.9"></a><span id="l37.9"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l37.10"></a><span id="l37.10"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l37.11"></a><span id="l37.11"> </span>
<a href="#l37.12"></a><span id="l37.12" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l37.14"></a><span id="l37.14"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l37.15"></a><span id="l37.15"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l37.16"></a><span id="l37.16"> </span>
<a href="#l37.17"></a><span id="l37.17"> var gFolder1;</span>
<a href="#l37.18"></a><span id="l37.18"> </span>
<a href="#l37.19"></a><span id="l37.19"> var tests = [</span>
<a href="#l37.20"></a><span id="l37.20">   setupCUSTOM1,</span>
<a href="#l37.21"></a><span id="l37.21">   startTest,</span>
<a href="#l37.22"></a><span id="l37.22">   doMove,</span>
<a href="#l37.23"></a><span id="l37.23">   testMove,</span>
<a href="#l37.24"></a><span id="l37.24" class="difflineminus">-  teardownIMAPPump</span>
<a href="#l37.25"></a><span id="l37.25" class="difflineplus">+  teardownIMAPPump,</span>
<a href="#l37.26"></a><span id="l37.26"> ];</span>
<a href="#l37.27"></a><span id="l37.27"> </span>
<a href="#l37.28"></a><span id="l37.28"> function setupCUSTOM1() {</span>
<a href="#l37.29"></a><span id="l37.29">   setupIMAPPump(&quot;CUSTOM1&quot;);</span>
<a href="#l37.30"></a><span id="l37.30">   Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l37.31"></a><span id="l37.31"> }</span>
<a href="#l37.32"></a><span id="l37.32"> </span>
<a href="#l37.33"></a><span id="l37.33" class="difflineminus">-async function startTest()</span>
<a href="#l37.34"></a><span id="l37.34" class="difflineminus">-{</span>
<a href="#l37.35"></a><span id="l37.35" class="difflineplus">+async function startTest() {</span>
<a href="#l37.36"></a><span id="l37.36">   IMAPPump.incomingServer.rootFolder.createSubfolder(&quot;folder 1&quot;, null);</span>
<a href="#l37.37"></a><span id="l37.37">   await PromiseTestUtils.promiseFolderAdded(&quot;folder 1&quot;);</span>
<a href="#l37.38"></a><span id="l37.38"> </span>
<a href="#l37.39"></a><span id="l37.39">   addImapMessage();</span>
<a href="#l37.40"></a><span id="l37.40">   let listener = new PromiseTestUtils.PromiseUrlListener();</span>
<a href="#l37.41"></a><span id="l37.41">   IMAPPump.inbox.updateFolderWithListener(null, listener);</span>
<a href="#l37.42"></a><span id="l37.42">   await listener.promise;</span>
<a href="#l37.43"></a><span id="l37.43"> </span>
<a href="#l37.44"></a><span id="l37.44" class="difflineat">@@ -59,24 +60,23 @@ async function doMove() {</span>
<a href="#l37.45"></a><span id="l37.45"> async function testMove() {</span>
<a href="#l37.46"></a><span id="l37.46">   Assert.equal(IMAPPump.inbox.getTotalMessages(false), 0);</span>
<a href="#l37.47"></a><span id="l37.47">   let listener = new PromiseTestUtils.PromiseUrlListener();</span>
<a href="#l37.48"></a><span id="l37.48">   gFolder1.updateFolderWithListener(null, listener);</span>
<a href="#l37.49"></a><span id="l37.49">   await listener.promise;</span>
<a href="#l37.50"></a><span id="l37.50">   Assert.equal(gFolder1.getTotalMessages(false), 1);</span>
<a href="#l37.51"></a><span id="l37.51"> </span>
<a href="#l37.52"></a><span id="l37.52">   // maildir should also delete the files.</span>
<a href="#l37.53"></a><span id="l37.53" class="difflineminus">-  if (IMAPPump.inbox.msgStore.storeType == &quot;maildir&quot;)</span>
<a href="#l37.54"></a><span id="l37.54" class="difflineminus">-  {</span>
<a href="#l37.55"></a><span id="l37.55" class="difflineplus">+  if (IMAPPump.inbox.msgStore.storeType == &quot;maildir&quot;) {</span>
<a href="#l37.56"></a><span id="l37.56">     let curDir = IMAPPump.inbox.filePath.clone();</span>
<a href="#l37.57"></a><span id="l37.57">     curDir.append(&quot;cur&quot;);</span>
<a href="#l37.58"></a><span id="l37.58">     Assert.ok(curDir.exists());</span>
<a href="#l37.59"></a><span id="l37.59">     Assert.ok(curDir.isDirectory());</span>
<a href="#l37.60"></a><span id="l37.60">     let curEnum = curDir.directoryEntries;</span>
<a href="#l37.61"></a><span id="l37.61">     // the directory should be empty, fails from bug 771643</span>
<a href="#l37.62"></a><span id="l37.62" class="difflineminus">-    Assert.ok(!curEnum.hasMoreElements())</span>
<a href="#l37.63"></a><span id="l37.63" class="difflineplus">+    Assert.ok(!curEnum.hasMoreElements());</span>
<a href="#l37.64"></a><span id="l37.64">   }</span>
<a href="#l37.65"></a><span id="l37.65"> }</span>
<a href="#l37.66"></a><span id="l37.66"> </span>
<a href="#l37.67"></a><span id="l37.67"> function run_test() {</span>
<a href="#l37.68"></a><span id="l37.68">   tests.forEach(x =&gt; add_task(x));</span>
<a href="#l37.69"></a><span id="l37.69">   run_next_test();</span>
<a href="#l37.70"></a><span id="l37.70"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapPasswordFailure.js</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapPasswordFailure.js</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -5,28 +5,30 @@</span>
<a href="#l38.4"></a><span id="l38.4">  *   - Check we get a prompt asking what to do.</span>
<a href="#l38.5"></a><span id="l38.5">  *   - Check retry does what it should do.</span>
<a href="#l38.6"></a><span id="l38.6">  *   - Check cancel does what it should do.</span>
<a href="#l38.7"></a><span id="l38.7">  *   - Re-initiate connection, this time select enter new password, check that</span>
<a href="#l38.8"></a><span id="l38.8">  *     we get a new password prompt and can enter the password.</span>
<a href="#l38.9"></a><span id="l38.9">  */</span>
<a href="#l38.10"></a><span id="l38.10"> </span>
<a href="#l38.11"></a><span id="l38.11"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l38.12"></a><span id="l38.12" class="difflineminus">-var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l38.13"></a><span id="l38.13"> </span>
<a href="#l38.14"></a><span id="l38.14" class="difflineplus">+/* import-globals-from ../../../test/resources/alertTestUtils.js */</span>
<a href="#l38.15"></a><span id="l38.15" class="difflineplus">+/* import-globals-from ../../../test/resources/passwordStorage.js */</span>
<a href="#l38.16"></a><span id="l38.16"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l38.17"></a><span id="l38.17"> load(&quot;../../../resources/passwordStorage.js&quot;);</span>
<a href="#l38.18"></a><span id="l38.18"> </span>
<a href="#l38.19"></a><span id="l38.19"> var kUserName = &quot;user&quot;;</span>
<a href="#l38.20"></a><span id="l38.20"> var kInvalidPassword = &quot;imaptest&quot;;</span>
<a href="#l38.21"></a><span id="l38.21"> var kValidPassword = &quot;password&quot;;</span>
<a href="#l38.22"></a><span id="l38.22"> </span>
<a href="#l38.23"></a><span id="l38.23"> var incomingServer, server;</span>
<a href="#l38.24"></a><span id="l38.24"> var attempt = 0;</span>
<a href="#l38.25"></a><span id="l38.25"> </span>
<a href="#l38.26"></a><span id="l38.26" class="difflineplus">+/* exported confirmEx, promptPasswordPS */// to alertTestUtils.js</span>
<a href="#l38.27"></a><span id="l38.27"> function confirmEx(aDialogTitle, aText, aButtonFlags, aButton0Title,</span>
<a href="#l38.28"></a><span id="l38.28">                    aButton1Title, aButton2Title, aCheckMsg, aCheckState) {</span>
<a href="#l38.29"></a><span id="l38.29">   switch (++attempt) {</span>
<a href="#l38.30"></a><span id="l38.30">     // First attempt, retry.</span>
<a href="#l38.31"></a><span id="l38.31">     case 1:</span>
<a href="#l38.32"></a><span id="l38.32">       dump(&quot;\nAttempting retry\n&quot;);</span>
<a href="#l38.33"></a><span id="l38.33">       return 0;</span>
<a href="#l38.34"></a><span id="l38.34">     // Second attempt, cancel.</span>
<a href="#l38.35"></a><span id="l38.35" class="difflineat">@@ -52,26 +54,26 @@ function promptPasswordPS(aParent, aDial</span>
<a href="#l38.36"></a><span id="l38.36">   if (attempt == 4) {</span>
<a href="#l38.37"></a><span id="l38.37">     aPassword.value = kValidPassword;</span>
<a href="#l38.38"></a><span id="l38.38">     aCheckState.value = true;</span>
<a href="#l38.39"></a><span id="l38.39">     return true;</span>
<a href="#l38.40"></a><span id="l38.40">   }</span>
<a href="#l38.41"></a><span id="l38.41">   return false;</span>
<a href="#l38.42"></a><span id="l38.42"> }</span>
<a href="#l38.43"></a><span id="l38.43"> </span>
<a href="#l38.44"></a><span id="l38.44" class="difflineminus">-add_task(async function () {</span>
<a href="#l38.45"></a><span id="l38.45" class="difflineplus">+add_task(async function() {</span>
<a href="#l38.46"></a><span id="l38.46">   do_test_pending();</span>
<a href="#l38.47"></a><span id="l38.47"> </span>
<a href="#l38.48"></a><span id="l38.48">   // Prepare files for passwords (generated by a script in bug 1018624).</span>
<a href="#l38.49"></a><span id="l38.49" class="difflineminus">-  await setupForPassword(&quot;signons-mailnews1.8-imap.json&quot;)</span>
<a href="#l38.50"></a><span id="l38.50" class="difflineplus">+  await setupForPassword(&quot;signons-mailnews1.8-imap.json&quot;);</span>
<a href="#l38.51"></a><span id="l38.51"> </span>
<a href="#l38.52"></a><span id="l38.52">   registerAlertTestUtils();</span>
<a href="#l38.53"></a><span id="l38.53"> </span>
<a href="#l38.54"></a><span id="l38.54">   let daemon = new imapDaemon();</span>
<a href="#l38.55"></a><span id="l38.55" class="difflineminus">-  daemon.createMailbox(&quot;Subscribed&quot;, {subscribed : true});</span>
<a href="#l38.56"></a><span id="l38.56" class="difflineplus">+  daemon.createMailbox(&quot;Subscribed&quot;, {subscribed: true});</span>
<a href="#l38.57"></a><span id="l38.57">   server = makeServer(daemon, &quot;&quot;, {</span>
<a href="#l38.58"></a><span id="l38.58">     // Make username of server match the singons.txt file</span>
<a href="#l38.59"></a><span id="l38.59">     // (pw there is intentionally invalid)</span>
<a href="#l38.60"></a><span id="l38.60">     kUsername: kUserName,</span>
<a href="#l38.61"></a><span id="l38.61">     kPassword: kValidPassword});</span>
<a href="#l38.62"></a><span id="l38.62">   server.setDebugLevel(fsDebugAll);</span>
<a href="#l38.63"></a><span id="l38.63"> </span>
<a href="#l38.64"></a><span id="l38.64"> </span>
<a href="#l38.65"></a><span id="l38.65" class="difflineat">@@ -150,12 +152,8 @@ function endTest() {</span>
<a href="#l38.66"></a><span id="l38.66">   server.stop();</span>
<a href="#l38.67"></a><span id="l38.67"> </span>
<a href="#l38.68"></a><span id="l38.68">   var thread = gThreadManager.currentThread;</span>
<a href="#l38.69"></a><span id="l38.69">   while (thread.hasPendingEvents())</span>
<a href="#l38.70"></a><span id="l38.70">     thread.processNextEvent(true);</span>
<a href="#l38.71"></a><span id="l38.71"> </span>
<a href="#l38.72"></a><span id="l38.72">   do_test_finished();</span>
<a href="#l38.73"></a><span id="l38.73"> }</span>
<a href="#l38.74"></a><span id="l38.74" class="difflineminus">-</span>
<a href="#l38.75"></a><span id="l38.75" class="difflineminus">-function run_test() {</span>
<a href="#l38.76"></a><span id="l38.76" class="difflineminus">-  run_next_test();</span>
<a href="#l38.77"></a><span id="l38.77" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapProtocols.js</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapProtocols.js</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -6,28 +6,29 @@</span>
<a href="#l39.4"></a><span id="l39.4"> var defaultProtocolFlags =</span>
<a href="#l39.5"></a><span id="l39.5">   Ci.nsIProtocolHandler.URI_NORELATIVE |</span>
<a href="#l39.6"></a><span id="l39.6">   Ci.nsIProtocolHandler.URI_FORBIDS_AUTOMATIC_DOCUMENT_REPLACEMENT |</span>
<a href="#l39.7"></a><span id="l39.7">   Ci.nsIProtocolHandler.URI_DANGEROUS_TO_LOAD |</span>
<a href="#l39.8"></a><span id="l39.8">   Ci.nsIProtocolHandler.ALLOWS_PROXY |</span>
<a href="#l39.9"></a><span id="l39.9">   Ci.nsIProtocolHandler.URI_FORBIDS_COOKIE_ACCESS |</span>
<a href="#l39.10"></a><span id="l39.10">   Ci.nsIProtocolHandler.ORIGIN_IS_FULL_SPEC;</span>
<a href="#l39.11"></a><span id="l39.11"> </span>
<a href="#l39.12"></a><span id="l39.12" class="difflineminus">-var protocols =</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineminus">-  [ { protocol: &quot;imap&quot;,</span>
<a href="#l39.14"></a><span id="l39.14" class="difflineminus">-      urlSpec: &quot;imap://user@localhost/&quot;,</span>
<a href="#l39.15"></a><span id="l39.15" class="difflineminus">-      defaultPort: Ci.nsIImapUrl.DEFAULT_IMAP_PORT</span>
<a href="#l39.16"></a><span id="l39.16" class="difflineminus">-    }</span>
<a href="#l39.17"></a><span id="l39.17" class="difflineminus">-    // XXX Imaps protocol not available via nsIProtocolHandler yet.</span>
<a href="#l39.18"></a><span id="l39.18" class="difflineminus">-    /*,</span>
<a href="#l39.19"></a><span id="l39.19" class="difflineminus">-    { protocol: &quot;imaps&quot;,</span>
<a href="#l39.20"></a><span id="l39.20" class="difflineminus">-      urlSpec: &quot;iamps://user@localhost/&quot;,</span>
<a href="#l39.21"></a><span id="l39.21" class="difflineminus">-      defaultPort: Ci.nsIImapUrl.DEFAULT_IMAPS_PORT</span>
<a href="#l39.22"></a><span id="l39.22" class="difflineminus">-      }*/</span>
<a href="#l39.23"></a><span id="l39.23" class="difflineminus">-    ];</span>
<a href="#l39.24"></a><span id="l39.24" class="difflineplus">+var protocols = [</span>
<a href="#l39.25"></a><span id="l39.25" class="difflineplus">+  {</span>
<a href="#l39.26"></a><span id="l39.26" class="difflineplus">+    protocol: &quot;imap&quot;,</span>
<a href="#l39.27"></a><span id="l39.27" class="difflineplus">+    urlSpec: &quot;imap://user@localhost/&quot;,</span>
<a href="#l39.28"></a><span id="l39.28" class="difflineplus">+    defaultPort: Ci.nsIImapUrl.DEFAULT_IMAP_PORT,</span>
<a href="#l39.29"></a><span id="l39.29" class="difflineplus">+  },</span>
<a href="#l39.30"></a><span id="l39.30" class="difflineplus">+  // XXX Imaps protocol not available via nsIProtocolHandler yet.</span>
<a href="#l39.31"></a><span id="l39.31" class="difflineplus">+  // {</span>
<a href="#l39.32"></a><span id="l39.32" class="difflineplus">+  //   protocol: &quot;imaps&quot;,</span>
<a href="#l39.33"></a><span id="l39.33" class="difflineplus">+  //   urlSpec: &quot;iamps://user@localhost/&quot;,</span>
<a href="#l39.34"></a><span id="l39.34" class="difflineplus">+  //   defaultPort: Ci.nsIImapUrl.DEFAULT_IMAPS_PORT,</span>
<a href="#l39.35"></a><span id="l39.35" class="difflineplus">+  // },</span>
<a href="#l39.36"></a><span id="l39.36" class="difflineplus">+];</span>
<a href="#l39.37"></a><span id="l39.37"> </span>
<a href="#l39.38"></a><span id="l39.38"> function run_test() {</span>
<a href="#l39.39"></a><span id="l39.39">   // We need a server to match the urlSpecs above.</span>
<a href="#l39.40"></a><span id="l39.40">   createLocalIMAPServer();</span>
<a href="#l39.41"></a><span id="l39.41"> </span>
<a href="#l39.42"></a><span id="l39.42">   for (var part = 0; part &lt; protocols.length; ++part) {</span>
<a href="#l39.43"></a><span id="l39.43">     print(&quot;protocol: &quot; + protocols[part].protocol);</span>
<a href="#l39.44"></a><span id="l39.44"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapProxy.js</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapProxy.js</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -1,28 +1,29 @@</span>
<a href="#l40.4"></a><span id="l40.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l40.5"></a><span id="l40.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l40.6"></a><span id="l40.6"> // Test that IMAP over a SOCKS proxy works.</span>
<a href="#l40.7"></a><span id="l40.7"> </span>
<a href="#l40.8"></a><span id="l40.8"> var {NetworkTestUtils} = ChromeUtils.import(&quot;resource://testing-common/mailnews/NetworkTestUtils.jsm&quot;);</span>
<a href="#l40.9"></a><span id="l40.9"> var {PromiseTestUtils} = ChromeUtils.import(&quot;resource://testing-common/mailnews/PromiseTestUtils.jsm&quot;);</span>
<a href="#l40.10"></a><span id="l40.10" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l40.11"></a><span id="l40.11"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l40.12"></a><span id="l40.12"> </span>
<a href="#l40.13"></a><span id="l40.13"> var server, daemon, incomingServer;</span>
<a href="#l40.14"></a><span id="l40.14"> </span>
<a href="#l40.15"></a><span id="l40.15"> const PORT = 143;</span>
<a href="#l40.16"></a><span id="l40.16"> </span>
<a href="#l40.17"></a><span id="l40.17"> add_task(async function setup() {</span>
<a href="#l40.18"></a><span id="l40.18">   // Disable new mail notifications</span>
<a href="#l40.19"></a><span id="l40.19">   Services.prefs.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l40.20"></a><span id="l40.20">   Services.prefs.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l40.21"></a><span id="l40.21">   Services.prefs.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l40.22"></a><span id="l40.22">   Services.prefs.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l40.23"></a><span id="l40.23"> </span>
<a href="#l40.24"></a><span id="l40.24" class="difflineminus">-  let daemon = new imapDaemon();</span>
<a href="#l40.25"></a><span id="l40.25" class="difflineplus">+  daemon = new imapDaemon();</span>
<a href="#l40.26"></a><span id="l40.26">   server = makeServer(daemon, &quot;&quot;);</span>
<a href="#l40.27"></a><span id="l40.27"> </span>
<a href="#l40.28"></a><span id="l40.28">   let messages = [];</span>
<a href="#l40.29"></a><span id="l40.29">   let messageGenerator = new MessageGenerator();</span>
<a href="#l40.30"></a><span id="l40.30">   messages = messages.concat(messageGenerator.makeMessage());</span>
<a href="#l40.31"></a><span id="l40.31">   let dataUri = Services.io.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l40.32"></a><span id="l40.32">                                    btoa(messages[0].toMessageString()));</span>
<a href="#l40.33"></a><span id="l40.33">   let imapMsg = new imapMessage(dataUri.spec, daemon.inbox.uidnext++, []);</span>
<a href="#l40.34"></a><span id="l40.34" class="difflineat">@@ -56,12 +57,8 @@ add_task(async function downloadEmail() </span>
<a href="#l40.35"></a><span id="l40.35">   Assert.equal(inboxFolder.getTotalMessages(false), 1);</span>
<a href="#l40.36"></a><span id="l40.36"> });</span>
<a href="#l40.37"></a><span id="l40.37"> </span>
<a href="#l40.38"></a><span id="l40.38"> add_task(async function cleanUp() {</span>
<a href="#l40.39"></a><span id="l40.39">   NetworkTestUtils.shutdownServers();</span>
<a href="#l40.40"></a><span id="l40.40">   incomingServer.closeCachedConnections();</span>
<a href="#l40.41"></a><span id="l40.41">   server.stop();</span>
<a href="#l40.42"></a><span id="l40.42"> });</span>
<a href="#l40.43"></a><span id="l40.43" class="difflineminus">-</span>
<a href="#l40.44"></a><span id="l40.44" class="difflineminus">-function run_test() {</span>
<a href="#l40.45"></a><span id="l40.45" class="difflineminus">-  run_next_test();</span>
<a href="#l40.46"></a><span id="l40.46" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapRename.js</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapRename.js</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -2,16 +2,18 @@</span>
<a href="#l41.4"></a><span id="l41.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l41.5"></a><span id="l41.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l41.6"></a><span id="l41.6"> </span>
<a href="#l41.7"></a><span id="l41.7"> // This tests that renaming non-ASCII name folder works.</span>
<a href="#l41.8"></a><span id="l41.8"> </span>
<a href="#l41.9"></a><span id="l41.9"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l41.10"></a><span id="l41.10"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l41.11"></a><span id="l41.11"> </span>
<a href="#l41.12"></a><span id="l41.12" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l41.14"></a><span id="l41.14"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l41.15"></a><span id="l41.15"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l41.16"></a><span id="l41.16"> </span>
<a href="#l41.17"></a><span id="l41.17"> setupIMAPPump();</span>
<a href="#l41.18"></a><span id="l41.18"> </span>
<a href="#l41.19"></a><span id="l41.19"> var tests = [</span>
<a href="#l41.20"></a><span id="l41.20">   setup,</span>
<a href="#l41.21"></a><span id="l41.21">   test_rename,</span>
<a href="#l41.22"></a><span id="l41.22" class="difflineat">@@ -42,23 +44,20 @@ function* test_rename() {</span>
<a href="#l41.23"></a><span id="l41.23">   let folder = rootFolder.getChildNamed(&quot;folder \u00e1&quot;);</span>
<a href="#l41.24"></a><span id="l41.24">   Assert.ok(folder.msgDatabase.summaryValid);</span>
<a href="#l41.25"></a><span id="l41.25">   Assert.equal(&quot;folder &amp;AOE-&quot;, folder.filePath.leafName);</span>
<a href="#l41.26"></a><span id="l41.26">   Assert.equal(&quot;folder \u00e1&quot;, folder.prettyName);</span>
<a href="#l41.27"></a><span id="l41.27"> </span>
<a href="#l41.28"></a><span id="l41.28">   yield true;</span>
<a href="#l41.29"></a><span id="l41.29"> }</span>
<a href="#l41.30"></a><span id="l41.30"> </span>
<a href="#l41.31"></a><span id="l41.31" class="difflineminus">-var mfnListener =</span>
<a href="#l41.32"></a><span id="l41.32" class="difflineminus">-{</span>
<a href="#l41.33"></a><span id="l41.33" class="difflineminus">-  folderAdded: function folderAdded(aFolder)</span>
<a href="#l41.34"></a><span id="l41.34" class="difflineminus">-  {</span>
<a href="#l41.35"></a><span id="l41.35" class="difflineplus">+var mfnListener = {</span>
<a href="#l41.36"></a><span id="l41.36" class="difflineplus">+  folderAdded(aFolder) {</span>
<a href="#l41.37"></a><span id="l41.37">     // we are only using async yield on the target folder add</span>
<a href="#l41.38"></a><span id="l41.38">     if (aFolder.name == &quot;folder 1&quot;)</span>
<a href="#l41.39"></a><span id="l41.39">       async_driver();</span>
<a href="#l41.40"></a><span id="l41.40">   },</span>
<a href="#l41.41"></a><span id="l41.41"> };</span>
<a href="#l41.42"></a><span id="l41.42"> </span>
<a href="#l41.43"></a><span id="l41.43" class="difflineminus">-function run_test()</span>
<a href="#l41.44"></a><span id="l41.44" class="difflineminus">-{</span>
<a href="#l41.45"></a><span id="l41.45" class="difflineplus">+function run_test() {</span>
<a href="#l41.46"></a><span id="l41.46">   async_run_tests(tests);</span>
<a href="#l41.47"></a><span id="l41.47"> }</span>
<a href="#l41.48"></a><span id="l41.48"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapSearch.js</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapSearch.js</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineat">@@ -3,24 +3,26 @@</span>
<a href="#l42.4"></a><span id="l42.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l42.5"></a><span id="l42.5"> </span>
<a href="#l42.6"></a><span id="l42.6"> /* Tests traditional (non-gloda) search on IMAP folders.</span>
<a href="#l42.7"></a><span id="l42.7">  * Derived from a combination of test_imapPump.js and test_search.js</span>
<a href="#l42.8"></a><span id="l42.8">  * Original author: Kent James &lt;kent@caspia.com&gt;</span>
<a href="#l42.9"></a><span id="l42.9">  */</span>
<a href="#l42.10"></a><span id="l42.10"> </span>
<a href="#l42.11"></a><span id="l42.11"> // async support</span>
<a href="#l42.12"></a><span id="l42.12" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l42.14"></a><span id="l42.14"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l42.15"></a><span id="l42.15"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l42.16"></a><span id="l42.16"> </span>
<a href="#l42.17"></a><span id="l42.17"> // headers we will store in db</span>
<a href="#l42.18"></a><span id="l42.18"> // set value of headers we want parsed into the db</span>
<a href="#l42.19"></a><span id="l42.19"> Services.prefs.setCharPref(&quot;mailnews.customDBHeaders&quot;,</span>
<a href="#l42.20"></a><span id="l42.20">                            &quot;x-spam-status oneliner twoliner threeliner nospace withspace&quot;);</span>
<a href="#l42.21"></a><span id="l42.21" class="difflineminus">-dump('set mailnews.customDBHeaders to ' + Services.prefs.getCharPref(&quot;mailnews.customDBHeaders&quot;) + '\n');</span>
<a href="#l42.22"></a><span id="l42.22" class="difflineplus">+dump(&quot;set mailnews.customDBHeaders to &quot; + Services.prefs.getCharPref(&quot;mailnews.customDBHeaders&quot;) + &quot;\n&quot;);</span>
<a href="#l42.23"></a><span id="l42.23"> </span>
<a href="#l42.24"></a><span id="l42.24"> // set customHeaders, which post-bug 363238 should get added to the db. Note that all headers but the last</span>
<a href="#l42.25"></a><span id="l42.25"> //  seem to end in colon.</span>
<a href="#l42.26"></a><span id="l42.26"> Services.prefs.setCharPref(&quot;mailnews.customHeaders&quot;,</span>
<a href="#l42.27"></a><span id="l42.27">                            &quot;x-uidl: x-bugzilla-watch-reason: x-bugzilla-component: received: x-spam-checker-version&quot;);</span>
<a href="#l42.28"></a><span id="l42.28"> </span>
<a href="#l42.29"></a><span id="l42.29"> // IMAP pump</span>
<a href="#l42.30"></a><span id="l42.30"> </span>
<a href="#l42.31"></a><span id="l42.31" class="difflineat">@@ -30,285 +32,297 @@ Services.prefs.setCharPref(&quot;mailnews.cus</span>
<a href="#l42.32"></a><span id="l42.32"> var gMessage = &quot;bugmail12&quot;; // message file used as the test message</span>
<a href="#l42.33"></a><span id="l42.33"> </span>
<a href="#l42.34"></a><span id="l42.34"> setupIMAPPump();</span>
<a href="#l42.35"></a><span id="l42.35"> </span>
<a href="#l42.36"></a><span id="l42.36"> // Definition of tests</span>
<a href="#l42.37"></a><span id="l42.37"> var tests = [</span>
<a href="#l42.38"></a><span id="l42.38">   loadImapMessage,</span>
<a href="#l42.39"></a><span id="l42.39">   testSearch,</span>
<a href="#l42.40"></a><span id="l42.40" class="difflineminus">-  endTest</span>
<a href="#l42.41"></a><span id="l42.41" class="difflineminus">-]</span>
<a href="#l42.42"></a><span id="l42.42" class="difflineplus">+  endTest,</span>
<a href="#l42.43"></a><span id="l42.43" class="difflineplus">+];</span>
<a href="#l42.44"></a><span id="l42.44"> </span>
<a href="#l42.45"></a><span id="l42.45"> /*</span>
<a href="#l42.46"></a><span id="l42.46"> /*</span>
<a href="#l42.47"></a><span id="l42.47">  * Testing of general mail search features.</span>
<a href="#l42.48"></a><span id="l42.48">  *</span>
<a href="#l42.49"></a><span id="l42.49">  * This tests some search attributes not tested by other specific tests,</span>
<a href="#l42.50"></a><span id="l42.50">  * e.g., test_searchTag.js or test_searchJunk.js</span>
<a href="#l42.51"></a><span id="l42.51">  */</span>
<a href="#l42.52"></a><span id="l42.52" class="difflineplus">+/* import-globals-from ../../../test/resources/searchTestUtils.js */</span>
<a href="#l42.53"></a><span id="l42.53"> load(&quot;../../../resources/searchTestUtils.js&quot;);</span>
<a href="#l42.54"></a><span id="l42.54"> </span>
<a href="#l42.55"></a><span id="l42.55" class="difflineminus">-var nsMsgSearchScope = Ci.nsMsgSearchScope;</span>
<a href="#l42.56"></a><span id="l42.56" class="difflineminus">-var nsMsgSearchAttrib = Ci.nsMsgSearchAttrib;</span>
<a href="#l42.57"></a><span id="l42.57" class="difflineminus">-var nsMsgSearchOp = Ci.nsMsgSearchOp;</span>
<a href="#l42.58"></a><span id="l42.58" class="difflineminus">-</span>
<a href="#l42.59"></a><span id="l42.59" class="difflineminus">-var Isnt = nsMsgSearchOp.Isnt;</span>
<a href="#l42.60"></a><span id="l42.60" class="difflineminus">-var Is = nsMsgSearchOp.Is;</span>
<a href="#l42.61"></a><span id="l42.61" class="difflineminus">-var IsEmpty = nsMsgSearchOp.IsEmpty;</span>
<a href="#l42.62"></a><span id="l42.62" class="difflineminus">-var IsntEmpty = nsMsgSearchOp.IsntEmpty;</span>
<a href="#l42.63"></a><span id="l42.63" class="difflineminus">-var Contains = nsMsgSearchOp.Contains;</span>
<a href="#l42.64"></a><span id="l42.64" class="difflineminus">-var DoesntContain = nsMsgSearchOp.DoesntContain;</span>
<a href="#l42.65"></a><span id="l42.65" class="difflineminus">-var BeginsWith = nsMsgSearchOp.BeginsWith;</span>
<a href="#l42.66"></a><span id="l42.66" class="difflineminus">-var EndsWith = nsMsgSearchOp.EndsWith;</span>
<a href="#l42.67"></a><span id="l42.67" class="difflineminus">-var IsBefore = nsMsgSearchOp.IsBefore; // control entry not enabled</span>
<a href="#l42.68"></a><span id="l42.68" class="difflineplus">+var Isnt = Ci.nsMsgSearchOp.Isnt;</span>
<a href="#l42.69"></a><span id="l42.69" class="difflineplus">+var Is = Ci.nsMsgSearchOp.Is;</span>
<a href="#l42.70"></a><span id="l42.70" class="difflineplus">+var Contains = Ci.nsMsgSearchOp.Contains;</span>
<a href="#l42.71"></a><span id="l42.71" class="difflineplus">+var BeginsWith = Ci.nsMsgSearchOp.BeginsWith;</span>
<a href="#l42.72"></a><span id="l42.72" class="difflineplus">+var EndsWith = Ci.nsMsgSearchOp.EndsWith;</span>
<a href="#l42.73"></a><span id="l42.73"> </span>
<a href="#l42.74"></a><span id="l42.74" class="difflineminus">-var offlineMail = nsMsgSearchScope.offlineMail;</span>
<a href="#l42.75"></a><span id="l42.75" class="difflineminus">-var onlineMail = nsMsgSearchScope.onlineMail;</span>
<a href="#l42.76"></a><span id="l42.76" class="difflineminus">-var offlineMailFilter = nsMsgSearchScope.offlineMailFilter;</span>
<a href="#l42.77"></a><span id="l42.77" class="difflineminus">-var onlineMailFilter = nsMsgSearchScope.onlineMailFilter;</span>
<a href="#l42.78"></a><span id="l42.78" class="difflineminus">-var news = nsMsgSearchScope.news; // control entry not enabled</span>
<a href="#l42.79"></a><span id="l42.79" class="difflineplus">+var OtherHeader = Ci.nsMsgSearchAttrib.OtherHeader;</span>
<a href="#l42.80"></a><span id="l42.80" class="difflineplus">+var From = Ci.nsMsgSearchAttrib.Sender;</span>
<a href="#l42.81"></a><span id="l42.81" class="difflineplus">+var Subject = Ci.nsMsgSearchAttrib.Subject;</span>
<a href="#l42.82"></a><span id="l42.82"> </span>
<a href="#l42.83"></a><span id="l42.83" class="difflineminus">-var OtherHeader = nsMsgSearchAttrib.OtherHeader;</span>
<a href="#l42.84"></a><span id="l42.84" class="difflineminus">-var From = nsMsgSearchAttrib.Sender;</span>
<a href="#l42.85"></a><span id="l42.85" class="difflineminus">-var Subject = nsMsgSearchAttrib.Subject;</span>
<a href="#l42.86"></a><span id="l42.86" class="difflineminus">-</span>
<a href="#l42.87"></a><span id="l42.87" class="difflineminus">-var searchTests =</span>
<a href="#l42.88"></a><span id="l42.88" class="difflineminus">-[</span>
<a href="#l42.89"></a><span id="l42.89" class="difflineplus">+var searchTests = [</span>
<a href="#l42.90"></a><span id="l42.90">   // test the To: header</span>
<a href="#l42.91"></a><span id="l42.91" class="difflineminus">-  { testString: &quot;PrimaryEmail1@test.invalid&quot;,</span>
<a href="#l42.92"></a><span id="l42.92" class="difflineplus">+  {</span>
<a href="#l42.93"></a><span id="l42.93" class="difflineplus">+    testString: &quot;PrimaryEmail1@test.invalid&quot;,</span>
<a href="#l42.94"></a><span id="l42.94">     testAttribute: From,</span>
<a href="#l42.95"></a><span id="l42.95">     op: Is,</span>
<a href="#l42.96"></a><span id="l42.96" class="difflineminus">-    count: 1 },</span>
<a href="#l42.97"></a><span id="l42.97" class="difflineminus">-  { testString: &quot;PrimaryEmail1@test.invalid&quot;,</span>
<a href="#l42.98"></a><span id="l42.98" class="difflineplus">+    count: 1,</span>
<a href="#l42.99"></a><span id="l42.99" class="difflineplus">+  }, {</span>
<a href="#l42.100"></a><span id="l42.100" class="difflineplus">+    testString: &quot;PrimaryEmail1@test.invalid&quot;,</span>
<a href="#l42.101"></a><span id="l42.101">     testAttribute: From,</span>
<a href="#l42.102"></a><span id="l42.102">     op: Isnt,</span>
<a href="#l42.103"></a><span id="l42.103" class="difflineminus">-    count: 0 },</span>
<a href="#l42.104"></a><span id="l42.104" class="difflineminus">-  { testString: &quot;PrimaryEmail&quot;,</span>
<a href="#l42.105"></a><span id="l42.105" class="difflineplus">+    count: 0,</span>
<a href="#l42.106"></a><span id="l42.106" class="difflineplus">+  }, {</span>
<a href="#l42.107"></a><span id="l42.107" class="difflineplus">+    testString: &quot;PrimaryEmail&quot;,</span>
<a href="#l42.108"></a><span id="l42.108">     testAttribute: From,</span>
<a href="#l42.109"></a><span id="l42.109">     op: BeginsWith,</span>
<a href="#l42.110"></a><span id="l42.110" class="difflineminus">-    count: 1 },</span>
<a href="#l42.111"></a><span id="l42.111" class="difflineminus">-  { testString: &quot;invalid&quot;,</span>
<a href="#l42.112"></a><span id="l42.112" class="difflineplus">+    count: 1,</span>
<a href="#l42.113"></a><span id="l42.113" class="difflineplus">+  }, {</span>
<a href="#l42.114"></a><span id="l42.114" class="difflineplus">+    testString: &quot;invalid&quot;,</span>
<a href="#l42.115"></a><span id="l42.115">     testAttribute: From,</span>
<a href="#l42.116"></a><span id="l42.116">     op: BeginsWith,</span>
<a href="#l42.117"></a><span id="l42.117" class="difflineminus">-    count: 0 },</span>
<a href="#l42.118"></a><span id="l42.118" class="difflineminus">-  { testString: &quot;invalid&quot;,</span>
<a href="#l42.119"></a><span id="l42.119" class="difflineplus">+    count: 0,</span>
<a href="#l42.120"></a><span id="l42.120" class="difflineplus">+  }, {</span>
<a href="#l42.121"></a><span id="l42.121" class="difflineplus">+    testString: &quot;invalid&quot;,</span>
<a href="#l42.122"></a><span id="l42.122" class="difflineplus">+    testAttribute: From,</span>
<a href="#l42.123"></a><span id="l42.123" class="difflineplus">+    op: EndsWith,</span>
<a href="#l42.124"></a><span id="l42.124" class="difflineplus">+    count: 1,</span>
<a href="#l42.125"></a><span id="l42.125" class="difflineplus">+  }, {</span>
<a href="#l42.126"></a><span id="l42.126" class="difflineplus">+    testString: &quot;Primary&quot;,</span>
<a href="#l42.127"></a><span id="l42.127">     testAttribute: From,</span>
<a href="#l42.128"></a><span id="l42.128">     op: EndsWith,</span>
<a href="#l42.129"></a><span id="l42.129" class="difflineminus">-    count: 1},</span>
<a href="#l42.130"></a><span id="l42.130" class="difflineminus">-  { testString: &quot;Primary&quot;,</span>
<a href="#l42.131"></a><span id="l42.131" class="difflineminus">-    testAttribute: From,</span>
<a href="#l42.132"></a><span id="l42.132" class="difflineminus">-    op: EndsWith,</span>
<a href="#l42.133"></a><span id="l42.133" class="difflineminus">-    count: 0},</span>
<a href="#l42.134"></a><span id="l42.134" class="difflineminus">-  { testString: &quot;QAContact&quot;,</span>
<a href="#l42.135"></a><span id="l42.135" class="difflineplus">+    count: 0,</span>
<a href="#l42.136"></a><span id="l42.136" class="difflineplus">+  }, {</span>
<a href="#l42.137"></a><span id="l42.137" class="difflineplus">+    testString: &quot;QAContact&quot;,</span>
<a href="#l42.138"></a><span id="l42.138" class="difflineplus">+    testAttribute: OtherHeader,</span>
<a href="#l42.139"></a><span id="l42.139" class="difflineplus">+    op: BeginsWith,</span>
<a href="#l42.140"></a><span id="l42.140" class="difflineplus">+    count: 1,</span>
<a href="#l42.141"></a><span id="l42.141" class="difflineplus">+  }, {</span>
<a href="#l42.142"></a><span id="l42.142" class="difflineplus">+    testString: &quot;filters&quot;,</span>
<a href="#l42.143"></a><span id="l42.143">     testAttribute: OtherHeader,</span>
<a href="#l42.144"></a><span id="l42.144">     op: BeginsWith,</span>
<a href="#l42.145"></a><span id="l42.145" class="difflineminus">-    count: 1},</span>
<a href="#l42.146"></a><span id="l42.146" class="difflineminus">-  { testString: &quot;filters&quot;,</span>
<a href="#l42.147"></a><span id="l42.147" class="difflineminus">-    testAttribute: OtherHeader,</span>
<a href="#l42.148"></a><span id="l42.148" class="difflineminus">-    op: BeginsWith,</span>
<a href="#l42.149"></a><span id="l42.149" class="difflineminus">-    count: 0},</span>
<a href="#l42.150"></a><span id="l42.150" class="difflineminus">-  { testString: &quot;mail.bugs&quot;,</span>
<a href="#l42.151"></a><span id="l42.151" class="difflineplus">+    count: 0,</span>
<a href="#l42.152"></a><span id="l42.152" class="difflineplus">+  }, {</span>
<a href="#l42.153"></a><span id="l42.153" class="difflineplus">+    testString: &quot;mail.bugs&quot;,</span>
<a href="#l42.154"></a><span id="l42.154">     testAttribute: OtherHeader,</span>
<a href="#l42.155"></a><span id="l42.155">     op: EndsWith,</span>
<a href="#l42.156"></a><span id="l42.156" class="difflineminus">-    count: 1},</span>
<a href="#l42.157"></a><span id="l42.157" class="difflineminus">-  { testString: &quot;QAContact&quot;,</span>
<a href="#l42.158"></a><span id="l42.158" class="difflineplus">+    count: 1,</span>
<a href="#l42.159"></a><span id="l42.159" class="difflineplus">+  }, {</span>
<a href="#l42.160"></a><span id="l42.160" class="difflineplus">+    testString: &quot;QAContact&quot;,</span>
<a href="#l42.161"></a><span id="l42.161">     testAttribute: OtherHeader,</span>
<a href="#l42.162"></a><span id="l42.162">     op: EndsWith,</span>
<a href="#l42.163"></a><span id="l42.163" class="difflineminus">-    count: 0},</span>
<a href="#l42.164"></a><span id="l42.164" class="difflineminus">-  { testString: &quot;QAcontact filters@mail.bugs&quot;,</span>
<a href="#l42.165"></a><span id="l42.165" class="difflineplus">+    count: 0,</span>
<a href="#l42.166"></a><span id="l42.166" class="difflineplus">+  }, {</span>
<a href="#l42.167"></a><span id="l42.167" class="difflineplus">+    testString: &quot;QAcontact filters@mail.bugs&quot;,</span>
<a href="#l42.168"></a><span id="l42.168">     testAttribute: OtherHeader,</span>
<a href="#l42.169"></a><span id="l42.169">     op: Is,</span>
<a href="#l42.170"></a><span id="l42.170" class="difflineminus">-    count: 1},</span>
<a href="#l42.171"></a><span id="l42.171" class="difflineminus">-  { testString: &quot;filters@mail.bugs&quot;,</span>
<a href="#l42.172"></a><span id="l42.172" class="difflineplus">+    count: 1,</span>
<a href="#l42.173"></a><span id="l42.173" class="difflineplus">+  }, {</span>
<a href="#l42.174"></a><span id="l42.174" class="difflineplus">+    testString: &quot;filters@mail.bugs&quot;,</span>
<a href="#l42.175"></a><span id="l42.175">     testAttribute: OtherHeader,</span>
<a href="#l42.176"></a><span id="l42.176">     op: Is,</span>
<a href="#l42.177"></a><span id="l42.177" class="difflineminus">-    count: 0},</span>
<a href="#l42.178"></a><span id="l42.178" class="difflineminus">-  { testString: &quot;QAcontact filters@mail.bugs&quot;,</span>
<a href="#l42.179"></a><span id="l42.179" class="difflineplus">+    count: 0,</span>
<a href="#l42.180"></a><span id="l42.180" class="difflineplus">+  }, {</span>
<a href="#l42.181"></a><span id="l42.181" class="difflineplus">+    testString: &quot;QAcontact filters@mail.bugs&quot;,</span>
<a href="#l42.182"></a><span id="l42.182">     testAttribute: OtherHeader,</span>
<a href="#l42.183"></a><span id="l42.183">     op: Isnt,</span>
<a href="#l42.184"></a><span id="l42.184" class="difflineminus">-    count: 0},</span>
<a href="#l42.185"></a><span id="l42.185" class="difflineminus">-  { testString: &quot;QAcontact&quot;,</span>
<a href="#l42.186"></a><span id="l42.186" class="difflineplus">+    count: 0,</span>
<a href="#l42.187"></a><span id="l42.187" class="difflineplus">+  }, {</span>
<a href="#l42.188"></a><span id="l42.188" class="difflineplus">+    testString: &quot;QAcontact&quot;,</span>
<a href="#l42.189"></a><span id="l42.189">     testAttribute: OtherHeader,</span>
<a href="#l42.190"></a><span id="l42.190">     op: Isnt,</span>
<a href="#l42.191"></a><span id="l42.191" class="difflineminus">-    count: 1},</span>
<a href="#l42.192"></a><span id="l42.192" class="difflineminus">-  { testString: &quot;filters&quot;,</span>
<a href="#l42.193"></a><span id="l42.193" class="difflineplus">+    count: 1,</span>
<a href="#l42.194"></a><span id="l42.194" class="difflineplus">+  }, {</span>
<a href="#l42.195"></a><span id="l42.195" class="difflineplus">+    testString: &quot;filters&quot;,</span>
<a href="#l42.196"></a><span id="l42.196">     testAttribute: OtherHeader,</span>
<a href="#l42.197"></a><span id="l42.197">     op: Contains,</span>
<a href="#l42.198"></a><span id="l42.198" class="difflineminus">-    count: 1},</span>
<a href="#l42.199"></a><span id="l42.199" class="difflineminus">-  { testString: &quot;foobar&quot;,</span>
<a href="#l42.200"></a><span id="l42.200" class="difflineplus">+    count: 1,</span>
<a href="#l42.201"></a><span id="l42.201" class="difflineplus">+  }, {</span>
<a href="#l42.202"></a><span id="l42.202" class="difflineplus">+    testString: &quot;foobar&quot;,</span>
<a href="#l42.203"></a><span id="l42.203">     testAttribute: OtherHeader,</span>
<a href="#l42.204"></a><span id="l42.204">     op: Contains,</span>
<a href="#l42.205"></a><span id="l42.205" class="difflineminus">-    count: 0},</span>
<a href="#l42.206"></a><span id="l42.206" class="difflineminus">-</span>
<a href="#l42.207"></a><span id="l42.207" class="difflineplus">+    count: 0,</span>
<a href="#l42.208"></a><span id="l42.208" class="difflineplus">+  },</span>
<a href="#l42.209"></a><span id="l42.209">   // test accumulation of received header</span>
<a href="#l42.210"></a><span id="l42.210" class="difflineminus">-  // only in first received</span>
<a href="#l42.211"></a><span id="l42.211" class="difflineminus">-  { testString: &quot;caspiaco&quot;,</span>
<a href="#l42.212"></a><span id="l42.212" class="difflineplus">+  {</span>
<a href="#l42.213"></a><span id="l42.213" class="difflineplus">+    // only in first received</span>
<a href="#l42.214"></a><span id="l42.214" class="difflineplus">+    testString: &quot;caspiaco&quot;,</span>
<a href="#l42.215"></a><span id="l42.215">     testAttribute: OtherHeader,</span>
<a href="#l42.216"></a><span id="l42.216">     op: Contains,</span>
<a href="#l42.217"></a><span id="l42.217">     customHeader: &quot;Received&quot;,</span>
<a href="#l42.218"></a><span id="l42.218" class="difflineminus">-    count: 1},</span>
<a href="#l42.219"></a><span id="l42.219" class="difflineminus">-  // only in second</span>
<a href="#l42.220"></a><span id="l42.220" class="difflineminus">-  { testString: &quot;webapp01.sj.mozilla.com&quot;,</span>
<a href="#l42.221"></a><span id="l42.221" class="difflineplus">+    count: 1,</span>
<a href="#l42.222"></a><span id="l42.222" class="difflineplus">+  }, {</span>
<a href="#l42.223"></a><span id="l42.223" class="difflineplus">+    // only in second</span>
<a href="#l42.224"></a><span id="l42.224" class="difflineplus">+    testString: &quot;webapp01.sj.mozilla.com&quot;,</span>
<a href="#l42.225"></a><span id="l42.225">     testAttribute: OtherHeader,</span>
<a href="#l42.226"></a><span id="l42.226">     op: Contains,</span>
<a href="#l42.227"></a><span id="l42.227">     customHeader: &quot;received&quot;,</span>
<a href="#l42.228"></a><span id="l42.228" class="difflineminus">-    count: 1},</span>
<a href="#l42.229"></a><span id="l42.229" class="difflineminus">-  // in neither</span>
<a href="#l42.230"></a><span id="l42.230" class="difflineminus">-  { testString: &quot;not there&quot;,</span>
<a href="#l42.231"></a><span id="l42.231" class="difflineplus">+    count: 1,</span>
<a href="#l42.232"></a><span id="l42.232" class="difflineplus">+  }, {</span>
<a href="#l42.233"></a><span id="l42.233" class="difflineplus">+    // in neither</span>
<a href="#l42.234"></a><span id="l42.234" class="difflineplus">+    testString: &quot;not there&quot;,</span>
<a href="#l42.235"></a><span id="l42.235">     testAttribute: OtherHeader,</span>
<a href="#l42.236"></a><span id="l42.236">     op: Contains,</span>
<a href="#l42.237"></a><span id="l42.237">     customHeader: &quot;received&quot;,</span>
<a href="#l42.238"></a><span id="l42.238" class="difflineminus">-    count: 0},</span>
<a href="#l42.239"></a><span id="l42.239" class="difflineminus">-</span>
<a href="#l42.240"></a><span id="l42.240" class="difflineplus">+    count: 0,</span>
<a href="#l42.241"></a><span id="l42.241" class="difflineplus">+  },</span>
<a href="#l42.242"></a><span id="l42.242">   // test multiple line arbitrary headers</span>
<a href="#l42.243"></a><span id="l42.243" class="difflineminus">-  // in the first line</span>
<a href="#l42.244"></a><span id="l42.244" class="difflineminus">-  { testString: &quot;SpamAssassin 3.2.3&quot;,</span>
<a href="#l42.245"></a><span id="l42.245" class="difflineplus">+  {</span>
<a href="#l42.246"></a><span id="l42.246" class="difflineplus">+    // in the first line</span>
<a href="#l42.247"></a><span id="l42.247" class="difflineplus">+    testString: &quot;SpamAssassin 3.2.3&quot;,</span>
<a href="#l42.248"></a><span id="l42.248">     testAttribute: OtherHeader,</span>
<a href="#l42.249"></a><span id="l42.249">     op: Contains,</span>
<a href="#l42.250"></a><span id="l42.250">     customHeader: &quot;X-Spam-Checker-Version&quot;,</span>
<a href="#l42.251"></a><span id="l42.251" class="difflineminus">-    count: 1},</span>
<a href="#l42.252"></a><span id="l42.252" class="difflineminus">-  // in the second line</span>
<a href="#l42.253"></a><span id="l42.253" class="difflineminus">-  { testString: &quot;host29.example.com&quot;,</span>
<a href="#l42.254"></a><span id="l42.254" class="difflineplus">+    count: 1,</span>
<a href="#l42.255"></a><span id="l42.255" class="difflineplus">+  }, {</span>
<a href="#l42.256"></a><span id="l42.256" class="difflineplus">+    // in the second line</span>
<a href="#l42.257"></a><span id="l42.257" class="difflineplus">+    testString: &quot;host29.example.com&quot;,</span>
<a href="#l42.258"></a><span id="l42.258" class="difflineplus">+    testAttribute: OtherHeader,</span>
<a href="#l42.259"></a><span id="l42.259" class="difflineplus">+    op: Contains,</span>
<a href="#l42.260"></a><span id="l42.260" class="difflineplus">+    customHeader: &quot;X-Spam-Checker-Version&quot;,</span>
<a href="#l42.261"></a><span id="l42.261" class="difflineplus">+    count: 1,</span>
<a href="#l42.262"></a><span id="l42.262" class="difflineplus">+  }, {</span>
<a href="#l42.263"></a><span id="l42.263" class="difflineplus">+    // spans two lines with space</span>
<a href="#l42.264"></a><span id="l42.264" class="difflineplus">+    testString: &quot;on host29.example.com&quot;,</span>
<a href="#l42.265"></a><span id="l42.265">     testAttribute: OtherHeader,</span>
<a href="#l42.266"></a><span id="l42.266">     op: Contains,</span>
<a href="#l42.267"></a><span id="l42.267">     customHeader: &quot;X-Spam-Checker-Version&quot;,</span>
<a href="#l42.268"></a><span id="l42.268" class="difflineminus">-    count: 1},</span>
<a href="#l42.269"></a><span id="l42.269" class="difflineminus">-  // spans two lines with space</span>
<a href="#l42.270"></a><span id="l42.270" class="difflineminus">-   { testString: &quot;on host29.example.com&quot;,</span>
<a href="#l42.271"></a><span id="l42.271" class="difflineminus">-     testAttribute: OtherHeader,</span>
<a href="#l42.272"></a><span id="l42.272" class="difflineminus">-     op: Contains,</span>
<a href="#l42.273"></a><span id="l42.273" class="difflineminus">-     customHeader: &quot;X-Spam-Checker-Version&quot;,</span>
<a href="#l42.274"></a><span id="l42.274" class="difflineminus">-     count: 1},</span>
<a href="#l42.275"></a><span id="l42.275" class="difflineminus">-</span>
<a href="#l42.276"></a><span id="l42.276" class="difflineplus">+    count: 1,</span>
<a href="#l42.277"></a><span id="l42.277" class="difflineplus">+  },</span>
<a href="#l42.278"></a><span id="l42.278">   // subject spanning several lines</span>
<a href="#l42.279"></a><span id="l42.279" class="difflineminus">-  // on the first line</span>
<a href="#l42.280"></a><span id="l42.280" class="difflineminus">-   { testString: &quot;A filter will&quot;,</span>
<a href="#l42.281"></a><span id="l42.281" class="difflineminus">-     testAttribute: Subject,</span>
<a href="#l42.282"></a><span id="l42.282" class="difflineminus">-     op: Contains,</span>
<a href="#l42.283"></a><span id="l42.283" class="difflineminus">-     count: 1},</span>
<a href="#l42.284"></a><span id="l42.284" class="difflineminus">-   { testString: &quot;I do not exist&quot;,</span>
<a href="#l42.285"></a><span id="l42.285" class="difflineminus">-     testAttribute: Subject,</span>
<a href="#l42.286"></a><span id="l42.286" class="difflineminus">-     op: Contains,</span>
<a href="#l42.287"></a><span id="l42.287" class="difflineminus">-     count: 0},</span>
<a href="#l42.288"></a><span id="l42.288" class="difflineminus">-  // on the second line</span>
<a href="#l42.289"></a><span id="l42.289" class="difflineminus">-   { testString: &quot;this message&quot;,</span>
<a href="#l42.290"></a><span id="l42.290" class="difflineminus">-     testAttribute: Subject,</span>
<a href="#l42.291"></a><span id="l42.291" class="difflineminus">-     op: Contains,</span>
<a href="#l42.292"></a><span id="l42.292" class="difflineminus">-     count: 1},</span>
<a href="#l42.293"></a><span id="l42.293" class="difflineminus">-  // spanning second and third line</span>
<a href="#l42.294"></a><span id="l42.294" class="difflineminus">-   { testString: &quot;over many&quot;,</span>
<a href="#l42.295"></a><span id="l42.295" class="difflineminus">-     testAttribute: Subject,</span>
<a href="#l42.296"></a><span id="l42.296" class="difflineminus">-     op: Contains,</span>
<a href="#l42.297"></a><span id="l42.297" class="difflineminus">-     count: 1},</span>
<a href="#l42.298"></a><span id="l42.298" class="difflineminus">-</span>
<a href="#l42.299"></a><span id="l42.299" class="difflineplus">+  {</span>
<a href="#l42.300"></a><span id="l42.300" class="difflineplus">+    // on the first line</span>
<a href="#l42.301"></a><span id="l42.301" class="difflineplus">+    testString: &quot;A filter will&quot;,</span>
<a href="#l42.302"></a><span id="l42.302" class="difflineplus">+    testAttribute: Subject,</span>
<a href="#l42.303"></a><span id="l42.303" class="difflineplus">+    op: Contains,</span>
<a href="#l42.304"></a><span id="l42.304" class="difflineplus">+    count: 1,</span>
<a href="#l42.305"></a><span id="l42.305" class="difflineplus">+  }, {</span>
<a href="#l42.306"></a><span id="l42.306" class="difflineplus">+    testString: &quot;I do not exist&quot;,</span>
<a href="#l42.307"></a><span id="l42.307" class="difflineplus">+    testAttribute: Subject,</span>
<a href="#l42.308"></a><span id="l42.308" class="difflineplus">+    op: Contains,</span>
<a href="#l42.309"></a><span id="l42.309" class="difflineplus">+    count: 0,</span>
<a href="#l42.310"></a><span id="l42.310" class="difflineplus">+  }, {</span>
<a href="#l42.311"></a><span id="l42.311" class="difflineplus">+    // on the second line</span>
<a href="#l42.312"></a><span id="l42.312" class="difflineplus">+    testString: &quot;this message&quot;,</span>
<a href="#l42.313"></a><span id="l42.313" class="difflineplus">+    testAttribute: Subject,</span>
<a href="#l42.314"></a><span id="l42.314" class="difflineplus">+    op: Contains,</span>
<a href="#l42.315"></a><span id="l42.315" class="difflineplus">+    count: 1,</span>
<a href="#l42.316"></a><span id="l42.316" class="difflineplus">+  }, {</span>
<a href="#l42.317"></a><span id="l42.317" class="difflineplus">+    // spanning second and third line</span>
<a href="#l42.318"></a><span id="l42.318" class="difflineplus">+    testString: &quot;over many&quot;,</span>
<a href="#l42.319"></a><span id="l42.319" class="difflineplus">+    testAttribute: Subject,</span>
<a href="#l42.320"></a><span id="l42.320" class="difflineplus">+    op: Contains,</span>
<a href="#l42.321"></a><span id="l42.321" class="difflineplus">+    count: 1,</span>
<a href="#l42.322"></a><span id="l42.322" class="difflineplus">+  },</span>
<a href="#l42.323"></a><span id="l42.323">   // tests of custom headers db values</span>
<a href="#l42.324"></a><span id="l42.324" class="difflineminus">-    { testString: &quot;a one line header&quot;,</span>
<a href="#l42.325"></a><span id="l42.325" class="difflineminus">-      dbHeader: &quot;oneliner&quot;},</span>
<a href="#l42.326"></a><span id="l42.326" class="difflineminus">-    { testString: &quot;a two line header&quot;,</span>
<a href="#l42.327"></a><span id="l42.327" class="difflineminus">-      dbHeader: &quot;twoliner&quot;},</span>
<a href="#l42.328"></a><span id="l42.328" class="difflineminus">-    { testString: &quot;a three line header with lotsa space and tabs&quot;,</span>
<a href="#l42.329"></a><span id="l42.329" class="difflineminus">-      dbHeader: &quot;threeliner&quot;},</span>
<a href="#l42.330"></a><span id="l42.330" class="difflineminus">-    { testString: &quot;I have no space&quot;,</span>
<a href="#l42.331"></a><span id="l42.331" class="difflineminus">-      dbHeader: &quot;nospace&quot;},</span>
<a href="#l42.332"></a><span id="l42.332" class="difflineminus">-    { testString: &quot;too much space&quot;,</span>
<a href="#l42.333"></a><span id="l42.333" class="difflineminus">-      dbHeader: &quot;withspace&quot;},</span>
<a href="#l42.334"></a><span id="l42.334" class="difflineminus">-</span>
<a href="#l42.335"></a><span id="l42.335" class="difflineplus">+  {</span>
<a href="#l42.336"></a><span id="l42.336" class="difflineplus">+    testString: &quot;a one line header&quot;,</span>
<a href="#l42.337"></a><span id="l42.337" class="difflineplus">+    dbHeader: &quot;oneliner&quot;,</span>
<a href="#l42.338"></a><span id="l42.338" class="difflineplus">+  }, {</span>
<a href="#l42.339"></a><span id="l42.339" class="difflineplus">+    testString: &quot;a two line header&quot;,</span>
<a href="#l42.340"></a><span id="l42.340" class="difflineplus">+    dbHeader: &quot;twoliner&quot;,</span>
<a href="#l42.341"></a><span id="l42.341" class="difflineplus">+  }, {</span>
<a href="#l42.342"></a><span id="l42.342" class="difflineplus">+    testString: &quot;a three line header with lotsa space and tabs&quot;,</span>
<a href="#l42.343"></a><span id="l42.343" class="difflineplus">+    dbHeader: &quot;threeliner&quot;,</span>
<a href="#l42.344"></a><span id="l42.344" class="difflineplus">+  }, {</span>
<a href="#l42.345"></a><span id="l42.345" class="difflineplus">+    testString: &quot;I have no space&quot;,</span>
<a href="#l42.346"></a><span id="l42.346" class="difflineplus">+    dbHeader: &quot;nospace&quot;,</span>
<a href="#l42.347"></a><span id="l42.347" class="difflineplus">+  }, {</span>
<a href="#l42.348"></a><span id="l42.348" class="difflineplus">+    testString: &quot;too much space&quot;,</span>
<a href="#l42.349"></a><span id="l42.349" class="difflineplus">+    dbHeader: &quot;withspace&quot;,</span>
<a href="#l42.350"></a><span id="l42.350" class="difflineplus">+  },</span>
<a href="#l42.351"></a><span id="l42.351">   // tests of custom db headers in a search</span>
<a href="#l42.352"></a><span id="l42.352" class="difflineminus">-    { testString: &quot;one line&quot;,</span>
<a href="#l42.353"></a><span id="l42.353" class="difflineminus">-      testAttribute: OtherHeader,</span>
<a href="#l42.354"></a><span id="l42.354" class="difflineminus">-      op: Contains,</span>
<a href="#l42.355"></a><span id="l42.355" class="difflineminus">-      customHeader: &quot;oneliner&quot;,</span>
<a href="#l42.356"></a><span id="l42.356" class="difflineminus">-      count: 1},</span>
<a href="#l42.357"></a><span id="l42.357" class="difflineminus">-    { testString: &quot;two line header&quot;,</span>
<a href="#l42.358"></a><span id="l42.358" class="difflineminus">-      testAttribute: OtherHeader,</span>
<a href="#l42.359"></a><span id="l42.359" class="difflineminus">-      op: Contains,</span>
<a href="#l42.360"></a><span id="l42.360" class="difflineminus">-      customHeader: &quot;twoliner&quot;,</span>
<a href="#l42.361"></a><span id="l42.361" class="difflineminus">-      count: 1},</span>
<a href="#l42.362"></a><span id="l42.362" class="difflineminus">-    { testString: &quot;three line header with lotsa&quot;,</span>
<a href="#l42.363"></a><span id="l42.363" class="difflineminus">-      testAttribute: OtherHeader,</span>
<a href="#l42.364"></a><span id="l42.364" class="difflineminus">-      op: Contains,</span>
<a href="#l42.365"></a><span id="l42.365" class="difflineminus">-      customHeader: &quot;threeliner&quot;,</span>
<a href="#l42.366"></a><span id="l42.366" class="difflineminus">-      count: 1},</span>
<a href="#l42.367"></a><span id="l42.367" class="difflineminus">-    { testString: &quot;I have no space&quot;,</span>
<a href="#l42.368"></a><span id="l42.368" class="difflineminus">-      testAttribute: OtherHeader,</span>
<a href="#l42.369"></a><span id="l42.369" class="difflineminus">-      op: Contains,</span>
<a href="#l42.370"></a><span id="l42.370" class="difflineminus">-      customHeader: &quot;nospace&quot;,</span>
<a href="#l42.371"></a><span id="l42.371" class="difflineminus">-      count: 1},</span>
<a href="#l42.372"></a><span id="l42.372" class="difflineminus">-    { testString: &quot;too much space&quot;,</span>
<a href="#l42.373"></a><span id="l42.373" class="difflineminus">-      testAttribute: OtherHeader,</span>
<a href="#l42.374"></a><span id="l42.374" class="difflineminus">-      op: Contains,</span>
<a href="#l42.375"></a><span id="l42.375" class="difflineminus">-      customHeader: &quot;withspace&quot;,</span>
<a href="#l42.376"></a><span id="l42.376" class="difflineminus">-      count: 1}</span>
<a href="#l42.377"></a><span id="l42.377" class="difflineplus">+  {</span>
<a href="#l42.378"></a><span id="l42.378" class="difflineplus">+    testString: &quot;one line&quot;,</span>
<a href="#l42.379"></a><span id="l42.379" class="difflineplus">+    testAttribute: OtherHeader,</span>
<a href="#l42.380"></a><span id="l42.380" class="difflineplus">+    op: Contains,</span>
<a href="#l42.381"></a><span id="l42.381" class="difflineplus">+    customHeader: &quot;oneliner&quot;,</span>
<a href="#l42.382"></a><span id="l42.382" class="difflineplus">+    count: 1,</span>
<a href="#l42.383"></a><span id="l42.383" class="difflineplus">+  }, {</span>
<a href="#l42.384"></a><span id="l42.384" class="difflineplus">+    testString: &quot;two line header&quot;,</span>
<a href="#l42.385"></a><span id="l42.385" class="difflineplus">+    testAttribute: OtherHeader,</span>
<a href="#l42.386"></a><span id="l42.386" class="difflineplus">+    op: Contains,</span>
<a href="#l42.387"></a><span id="l42.387" class="difflineplus">+    customHeader: &quot;twoliner&quot;,</span>
<a href="#l42.388"></a><span id="l42.388" class="difflineplus">+    count: 1,</span>
<a href="#l42.389"></a><span id="l42.389" class="difflineplus">+  }, {</span>
<a href="#l42.390"></a><span id="l42.390" class="difflineplus">+    testString: &quot;three line header with lotsa&quot;,</span>
<a href="#l42.391"></a><span id="l42.391" class="difflineplus">+    testAttribute: OtherHeader,</span>
<a href="#l42.392"></a><span id="l42.392" class="difflineplus">+    op: Contains,</span>
<a href="#l42.393"></a><span id="l42.393" class="difflineplus">+    customHeader: &quot;threeliner&quot;,</span>
<a href="#l42.394"></a><span id="l42.394" class="difflineplus">+    count: 1,</span>
<a href="#l42.395"></a><span id="l42.395" class="difflineplus">+  }, {</span>
<a href="#l42.396"></a><span id="l42.396" class="difflineplus">+    testString: &quot;I have no space&quot;,</span>
<a href="#l42.397"></a><span id="l42.397" class="difflineplus">+    testAttribute: OtherHeader,</span>
<a href="#l42.398"></a><span id="l42.398" class="difflineplus">+    op: Contains,</span>
<a href="#l42.399"></a><span id="l42.399" class="difflineplus">+    customHeader: &quot;nospace&quot;,</span>
<a href="#l42.400"></a><span id="l42.400" class="difflineplus">+    count: 1,</span>
<a href="#l42.401"></a><span id="l42.401" class="difflineplus">+  }, {</span>
<a href="#l42.402"></a><span id="l42.402" class="difflineplus">+    testString: &quot;too much space&quot;,</span>
<a href="#l42.403"></a><span id="l42.403" class="difflineplus">+    testAttribute: OtherHeader,</span>
<a href="#l42.404"></a><span id="l42.404" class="difflineplus">+    op: Contains,</span>
<a href="#l42.405"></a><span id="l42.405" class="difflineplus">+    customHeader: &quot;withspace&quot;,</span>
<a href="#l42.406"></a><span id="l42.406" class="difflineplus">+    count: 1,</span>
<a href="#l42.407"></a><span id="l42.407" class="difflineplus">+  },</span>
<a href="#l42.408"></a><span id="l42.408"> ];</span>
<a href="#l42.409"></a><span id="l42.409"> </span>
<a href="#l42.410"></a><span id="l42.410"> // load and update a message in the imap fake server</span>
<a href="#l42.411"></a><span id="l42.411" class="difflineminus">-function* loadImapMessage()</span>
<a href="#l42.412"></a><span id="l42.412" class="difflineminus">-{</span>
<a href="#l42.413"></a><span id="l42.413" class="difflineplus">+function* loadImapMessage() {</span>
<a href="#l42.414"></a><span id="l42.414">   IMAPPump.mailbox.addMessage(new imapMessage(specForFileName(gMessage),</span>
<a href="#l42.415"></a><span id="l42.415">                           IMAPPump.mailbox.uidnext++, []));</span>
<a href="#l42.416"></a><span id="l42.416">   IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l42.417"></a><span id="l42.417">   yield false;</span>
<a href="#l42.418"></a><span id="l42.418"> </span>
<a href="#l42.419"></a><span id="l42.419">   Assert.equal(1, IMAPPump.inbox.getTotalMessages(false));</span>
<a href="#l42.420"></a><span id="l42.420">   yield true;</span>
<a href="#l42.421"></a><span id="l42.421"> }</span>
<a href="#l42.422"></a><span id="l42.422"> </span>
<a href="#l42.423"></a><span id="l42.423"> // process each test from queue, calls itself upon completion of each search</span>
<a href="#l42.424"></a><span id="l42.424" class="difflineminus">-var testObject;</span>
<a href="#l42.425"></a><span id="l42.425" class="difflineminus">-function* testSearch()</span>
<a href="#l42.426"></a><span id="l42.426" class="difflineminus">-{</span>
<a href="#l42.427"></a><span id="l42.427" class="difflineminus">-  while (searchTests.length)</span>
<a href="#l42.428"></a><span id="l42.428" class="difflineminus">-  {</span>
<a href="#l42.429"></a><span id="l42.429" class="difflineplus">+function* testSearch() {</span>
<a href="#l42.430"></a><span id="l42.430" class="difflineplus">+  while (searchTests.length) {</span>
<a href="#l42.431"></a><span id="l42.431">     let test = searchTests.shift();</span>
<a href="#l42.432"></a><span id="l42.432" class="difflineminus">-    if (test.dbHeader)</span>
<a href="#l42.433"></a><span id="l42.433" class="difflineminus">-    {</span>
<a href="#l42.434"></a><span id="l42.434" class="difflineplus">+    if (test.dbHeader) {</span>
<a href="#l42.435"></a><span id="l42.435">       //  test of a custom db header</span>
<a href="#l42.436"></a><span id="l42.436">       dump(&quot;testing dbHeader &quot; + test.dbHeader + &quot;\n&quot;);</span>
<a href="#l42.437"></a><span id="l42.437">       let customValue = mailTestUtils.firstMsgHdr(IMAPPump.inbox)</span>
<a href="#l42.438"></a><span id="l42.438">                                      .getProperty(test.dbHeader);</span>
<a href="#l42.439"></a><span id="l42.439">       Assert.equal(customValue, test.testString);</span>
<a href="#l42.440"></a><span id="l42.440" class="difflineminus">-    }</span>
<a href="#l42.441"></a><span id="l42.441" class="difflineminus">-    else</span>
<a href="#l42.442"></a><span id="l42.442" class="difflineminus">-    {</span>
<a href="#l42.443"></a><span id="l42.443" class="difflineplus">+    } else {</span>
<a href="#l42.444"></a><span id="l42.444">       dump(&quot;testing for string '&quot; + test.testString + &quot;'\n&quot;);</span>
<a href="#l42.445"></a><span id="l42.445" class="difflineminus">-      testObject = new TestSearch(IMAPPump.inbox,</span>
<a href="#l42.446"></a><span id="l42.446" class="difflineminus">-                           test.testString,</span>
<a href="#l42.447"></a><span id="l42.447" class="difflineminus">-                           test.testAttribute,</span>
<a href="#l42.448"></a><span id="l42.448" class="difflineminus">-                           test.op,</span>
<a href="#l42.449"></a><span id="l42.449" class="difflineminus">-                           test.count,</span>
<a href="#l42.450"></a><span id="l42.450" class="difflineminus">-                           async_driver,</span>
<a href="#l42.451"></a><span id="l42.451" class="difflineminus">-                           null,</span>
<a href="#l42.452"></a><span id="l42.452" class="difflineminus">-                           test.customHeader ? test.customHeader : &quot;X-Bugzilla-Watch-Reason&quot;);</span>
<a href="#l42.453"></a><span id="l42.453" class="difflineplus">+      new TestSearch(IMAPPump.inbox,</span>
<a href="#l42.454"></a><span id="l42.454" class="difflineplus">+                     test.testString,</span>
<a href="#l42.455"></a><span id="l42.455" class="difflineplus">+                     test.testAttribute,</span>
<a href="#l42.456"></a><span id="l42.456" class="difflineplus">+                     test.op,</span>
<a href="#l42.457"></a><span id="l42.457" class="difflineplus">+                     test.count,</span>
<a href="#l42.458"></a><span id="l42.458" class="difflineplus">+                     async_driver,</span>
<a href="#l42.459"></a><span id="l42.459" class="difflineplus">+                     null,</span>
<a href="#l42.460"></a><span id="l42.460" class="difflineplus">+                     test.customHeader ? test.customHeader : &quot;X-Bugzilla-Watch-Reason&quot;);</span>
<a href="#l42.461"></a><span id="l42.461">       yield false;</span>
<a href="#l42.462"></a><span id="l42.462">     }</span>
<a href="#l42.463"></a><span id="l42.463">   }</span>
<a href="#l42.464"></a><span id="l42.464" class="difflineminus">-  testObject = null;</span>
<a href="#l42.465"></a><span id="l42.465">   yield true;</span>
<a href="#l42.466"></a><span id="l42.466"> }</span>
<a href="#l42.467"></a><span id="l42.467"> </span>
<a href="#l42.468"></a><span id="l42.468"> // Cleanup at end</span>
<a href="#l42.469"></a><span id="l42.469" class="difflineminus">-function endTest()</span>
<a href="#l42.470"></a><span id="l42.470" class="difflineminus">-{</span>
<a href="#l42.471"></a><span id="l42.471" class="difflineplus">+function endTest() {</span>
<a href="#l42.472"></a><span id="l42.472">   teardownIMAPPump();</span>
<a href="#l42.473"></a><span id="l42.473"> }</span>
<a href="#l42.474"></a><span id="l42.474"> </span>
<a href="#l42.475"></a><span id="l42.475" class="difflineminus">-function run_test()</span>
<a href="#l42.476"></a><span id="l42.476" class="difflineminus">-{</span>
<a href="#l42.477"></a><span id="l42.477" class="difflineplus">+function run_test() {</span>
<a href="#l42.478"></a><span id="l42.478">   // don't use offline store</span>
<a href="#l42.479"></a><span id="l42.479">   IMAPPump.inbox.clearFlag(Ci.nsMsgFolderFlags.Offline);</span>
<a href="#l42.480"></a><span id="l42.480"> </span>
<a href="#l42.481"></a><span id="l42.481">   async_run_tests(tests);</span>
<a href="#l42.482"></a><span id="l42.482"> }</span>
<a href="#l42.483"></a><span id="l42.483"> </span>
<a href="#l42.484"></a><span id="l42.484"> /*</span>
<a href="#l42.485"></a><span id="l42.485">  * helper function</span>
<a href="#l42.486"></a><span id="l42.486">  */</span>
<a href="#l42.487"></a><span id="l42.487"> </span>
<a href="#l42.488"></a><span id="l42.488"> // given a test file, return the file uri spec</span>
<a href="#l42.489"></a><span id="l42.489" class="difflineminus">-function specForFileName(aFileName)</span>
<a href="#l42.490"></a><span id="l42.490" class="difflineminus">-{</span>
<a href="#l42.491"></a><span id="l42.491" class="difflineplus">+function specForFileName(aFileName) {</span>
<a href="#l42.492"></a><span id="l42.492">   let file = do_get_file(&quot;../../../data/&quot; + aFileName);</span>
<a href="#l42.493"></a><span id="l42.493">   let msgfileuri = Services.io.newFileURI(file)</span>
<a href="#l42.494"></a><span id="l42.494">                               .QueryInterface(Ci.nsIFileURL);</span>
<a href="#l42.495"></a><span id="l42.495">   return msgfileuri.spec;</span>
<a href="#l42.496"></a><span id="l42.496"> }</span>
<a href="#l42.497"></a><span id="l42.497"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapStatusCloseDBs.js</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapStatusCloseDBs.js</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineat">@@ -1,29 +1,31 @@</span>
<a href="#l43.4"></a><span id="l43.4"> // This file tests that checking folders for new mail with STATUS</span>
<a href="#l43.5"></a><span id="l43.5"> // doesn't leave db's open.</span>
<a href="#l43.6"></a><span id="l43.6"> </span>
<a href="#l43.7"></a><span id="l43.7" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l43.8"></a><span id="l43.8" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l43.9"></a><span id="l43.9"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l43.10"></a><span id="l43.10"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l43.11"></a><span id="l43.11"> </span>
<a href="#l43.12"></a><span id="l43.12"> var gFolder1, gFolder2;</span>
<a href="#l43.13"></a><span id="l43.13"> </span>
<a href="#l43.14"></a><span id="l43.14"> var tests = [</span>
<a href="#l43.15"></a><span id="l43.15">   setup,</span>
<a href="#l43.16"></a><span id="l43.16">   check,</span>
<a href="#l43.17"></a><span id="l43.17" class="difflineminus">-  teardown</span>
<a href="#l43.18"></a><span id="l43.18" class="difflineplus">+  teardown,</span>
<a href="#l43.19"></a><span id="l43.19"> ];</span>
<a href="#l43.20"></a><span id="l43.20"> </span>
<a href="#l43.21"></a><span id="l43.21"> function* setup() {</span>
<a href="#l43.22"></a><span id="l43.22">   Services.prefs.setBoolPref(&quot;mail.check_all_imap_folders_for_new&quot;, true);</span>
<a href="#l43.23"></a><span id="l43.23"> </span>
<a href="#l43.24"></a><span id="l43.24">   setupIMAPPump();</span>
<a href="#l43.25"></a><span id="l43.25"> </span>
<a href="#l43.26"></a><span id="l43.26" class="difflineminus">-  IMAPPump.daemon.createMailbox(&quot;folder 1&quot;, {subscribed : true});</span>
<a href="#l43.27"></a><span id="l43.27" class="difflineminus">-  IMAPPump.daemon.createMailbox(&quot;folder 2&quot;, {subscribed : true});</span>
<a href="#l43.28"></a><span id="l43.28" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;folder 1&quot;, {subscribed: true});</span>
<a href="#l43.29"></a><span id="l43.29" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;folder 2&quot;, {subscribed: true});</span>
<a href="#l43.30"></a><span id="l43.30"> </span>
<a href="#l43.31"></a><span id="l43.31">   IMAPPump.server.performTest(&quot;SUBSCRIBE&quot;);</span>
<a href="#l43.32"></a><span id="l43.32"> </span>
<a href="#l43.33"></a><span id="l43.33">   let rootFolder = IMAPPump.incomingServer.rootFolder;</span>
<a href="#l43.34"></a><span id="l43.34">   gFolder1 = rootFolder.getChildNamed(&quot;folder 1&quot;);</span>
<a href="#l43.35"></a><span id="l43.35">   gFolder2 = rootFolder.getChildNamed(&quot;folder 2&quot;);</span>
<a href="#l43.36"></a><span id="l43.36"> </span>
<a href="#l43.37"></a><span id="l43.37">   IMAPPump.inbox.getNewMessages(null, null);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapStoreMsgOffline.js</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapStoreMsgOffline.js</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineat">@@ -3,71 +3,70 @@</span>
<a href="#l44.4"></a><span id="l44.4">  * offline stores correctly, when we fetch the message for display.</span>
<a href="#l44.5"></a><span id="l44.5">  * It checks:</span>
<a href="#l44.6"></a><span id="l44.6">  *   - Normal messages, no attachments.</span>
<a href="#l44.7"></a><span id="l44.7">  *   - Message with inline attachment (e.g., image)</span>
<a href="#l44.8"></a><span id="l44.8">  *   - Message with non-inline attachment (e.g., .doc file)</span>
<a href="#l44.9"></a><span id="l44.9">  *   - Message with mix of attachment types.</span>
<a href="#l44.10"></a><span id="l44.10">  */</span>
<a href="#l44.11"></a><span id="l44.11"> </span>
<a href="#l44.12"></a><span id="l44.12" class="difflineminus">-var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineminus">-</span>
<a href="#l44.14"></a><span id="l44.14" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l44.15"></a><span id="l44.15" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l44.16"></a><span id="l44.16"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l44.17"></a><span id="l44.17"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l44.18"></a><span id="l44.18"> </span>
<a href="#l44.19"></a><span id="l44.19" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l44.20"></a><span id="l44.20" class="difflineplus">+/* import-globals-from ../../../test/resources/messageModifier.js */</span>
<a href="#l44.21"></a><span id="l44.21" class="difflineplus">+/* import-globals-from ../../../test/resources/messageInjection.js */</span>
<a href="#l44.22"></a><span id="l44.22"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l44.23"></a><span id="l44.23"> load(&quot;../../../resources/messageModifier.js&quot;);</span>
<a href="#l44.24"></a><span id="l44.24"> load(&quot;../../../resources/messageInjection.js&quot;);</span>
<a href="#l44.25"></a><span id="l44.25"> </span>
<a href="#l44.26"></a><span id="l44.26"> var gMessageGenerator = new MessageGenerator();</span>
<a href="#l44.27"></a><span id="l44.27" class="difflineminus">-var gScenarioFactory = new MessageScenarioFactory(gMessageGenerator);</span>
<a href="#l44.28"></a><span id="l44.28"> </span>
<a href="#l44.29"></a><span id="l44.29"> var gMsgFile1 = do_get_file(&quot;../../../data/bugmail10&quot;);</span>
<a href="#l44.30"></a><span id="l44.30"> var gMsgId1 = &quot;200806061706.m56H6RWT004933@mrapp54.mozilla.org&quot;;</span>
<a href="#l44.31"></a><span id="l44.31"> var gMsgFile2 = do_get_file(&quot;../../../data/image-attach-test&quot;);</span>
<a href="#l44.32"></a><span id="l44.32"> var gMsgId2 = &quot;4A947F73.5030709@example.com&quot;;</span>
<a href="#l44.33"></a><span id="l44.33"> var gMsgFile3 = do_get_file(&quot;../../../data/external-attach-test&quot;);</span>
<a href="#l44.34"></a><span id="l44.34"> var gMsgId3 = &quot;876TY.5030709@example.com&quot;;</span>
<a href="#l44.35"></a><span id="l44.35"> </span>
<a href="#l44.36"></a><span id="l44.36"> var gFirstNewMsg;</span>
<a href="#l44.37"></a><span id="l44.37"> var gFirstMsgSize;</span>
<a href="#l44.38"></a><span id="l44.38"> var gImapInboxOfflineStoreSize;</span>
<a href="#l44.39"></a><span id="l44.39"> </span>
<a href="#l44.40"></a><span id="l44.40"> // We use this as a display consumer</span>
<a href="#l44.41"></a><span id="l44.41" class="difflineminus">-var streamListener =</span>
<a href="#l44.42"></a><span id="l44.42" class="difflineminus">-{</span>
<a href="#l44.43"></a><span id="l44.43" class="difflineplus">+var streamListener = {</span>
<a href="#l44.44"></a><span id="l44.44">   _data: &quot;&quot;,</span>
<a href="#l44.45"></a><span id="l44.45"> </span>
<a href="#l44.46"></a><span id="l44.46">   QueryInterface:</span>
<a href="#l44.47"></a><span id="l44.47">     ChromeUtils.generateQI([Ci.nsIStreamListener, Ci.nsIRequestObserver]),</span>
<a href="#l44.48"></a><span id="l44.48"> </span>
<a href="#l44.49"></a><span id="l44.49">   // nsIRequestObserver</span>
<a href="#l44.50"></a><span id="l44.50" class="difflineminus">-  onStartRequest: function(aRequest) {</span>
<a href="#l44.51"></a><span id="l44.51" class="difflineplus">+  onStartRequest(aRequest) {</span>
<a href="#l44.52"></a><span id="l44.52">   },</span>
<a href="#l44.53"></a><span id="l44.53" class="difflineminus">-  onStopRequest: function(aRequest, aStatusCode) {</span>
<a href="#l44.54"></a><span id="l44.54" class="difflineplus">+  onStopRequest(aRequest, aStatusCode) {</span>
<a href="#l44.55"></a><span id="l44.55">     Assert.equal(aStatusCode, 0);</span>
<a href="#l44.56"></a><span id="l44.56">   },</span>
<a href="#l44.57"></a><span id="l44.57"> </span>
<a href="#l44.58"></a><span id="l44.58">   // nsIStreamListener</span>
<a href="#l44.59"></a><span id="l44.59" class="difflineminus">-  onDataAvailable: function(aRequest, aInputStream, aOffset, aCount) {</span>
<a href="#l44.60"></a><span id="l44.60" class="difflineplus">+  onDataAvailable(aRequest, aInputStream, aOffset, aCount) {</span>
<a href="#l44.61"></a><span id="l44.61">     let scriptStream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;]</span>
<a href="#l44.62"></a><span id="l44.62">                          .createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l44.63"></a><span id="l44.63"> </span>
<a href="#l44.64"></a><span id="l44.64">     scriptStream.init(aInputStream);</span>
<a href="#l44.65"></a><span id="l44.65"> </span>
<a href="#l44.66"></a><span id="l44.66">     scriptStream.read(aCount);</span>
<a href="#l44.67"></a><span id="l44.67" class="difflineminus">-  }</span>
<a href="#l44.68"></a><span id="l44.68" class="difflineplus">+  },</span>
<a href="#l44.69"></a><span id="l44.69"> };</span>
<a href="#l44.70"></a><span id="l44.70"> </span>
<a href="#l44.71"></a><span id="l44.71"> // Adds some messages directly to a mailbox (eg new mail)</span>
<a href="#l44.72"></a><span id="l44.72" class="difflineminus">-function addMessagesToServer(messages, mailbox)</span>
<a href="#l44.73"></a><span id="l44.73" class="difflineminus">-{</span>
<a href="#l44.74"></a><span id="l44.74" class="difflineplus">+function addMessagesToServer(messages, mailbox) {</span>
<a href="#l44.75"></a><span id="l44.75">   // For every message we have, we need to convert it to a file:/// URI</span>
<a href="#l44.76"></a><span id="l44.76" class="difflineminus">-  messages.forEach(function (message)</span>
<a href="#l44.77"></a><span id="l44.77" class="difflineminus">-  {</span>
<a href="#l44.78"></a><span id="l44.78" class="difflineplus">+  messages.forEach(function(message) {</span>
<a href="#l44.79"></a><span id="l44.79">     let URI = Services.io.newFileURI(message.file).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l44.80"></a><span id="l44.80">     // Create the imapMessage and store it on the mailbox.</span>
<a href="#l44.81"></a><span id="l44.81">     mailbox.addMessage(new imapMessage(URI.spec, mailbox.uidnext++, []));</span>
<a href="#l44.82"></a><span id="l44.82">   });</span>
<a href="#l44.83"></a><span id="l44.83"> }</span>
<a href="#l44.84"></a><span id="l44.84"> </span>
<a href="#l44.85"></a><span id="l44.85"> function setup() {</span>
<a href="#l44.86"></a><span id="l44.86">   // We aren't interested in downloading messages automatically</span>
<a href="#l44.87"></a><span id="l44.87" class="difflineat">@@ -80,17 +79,17 @@ function setup() {</span>
<a href="#l44.88"></a><span id="l44.88">   // Services.prefs.setIntPref(&quot;mail.imap.mime_parts_on_demand_threshold&quot;, 3000);</span>
<a href="#l44.89"></a><span id="l44.89"> </span>
<a href="#l44.90"></a><span id="l44.90">   setupIMAPPump();</span>
<a href="#l44.91"></a><span id="l44.91"> </span>
<a href="#l44.92"></a><span id="l44.92">   // these hacks are required because we've created the inbox before</span>
<a href="#l44.93"></a><span id="l44.93">   // running initial folder discovery, and adding the folder bails</span>
<a href="#l44.94"></a><span id="l44.94">   // out before we set it as verified online, so we bail out, and</span>
<a href="#l44.95"></a><span id="l44.95">   // then remove the INBOX folder since it's not verified.</span>
<a href="#l44.96"></a><span id="l44.96" class="difflineminus">-  IMAPPump.inbox.hierarchyDelimiter = '/';</span>
<a href="#l44.97"></a><span id="l44.97" class="difflineplus">+  IMAPPump.inbox.hierarchyDelimiter = &quot;/&quot;;</span>
<a href="#l44.98"></a><span id="l44.98">   IMAPPump.inbox.verifiedAsOnlineFolder = true;</span>
<a href="#l44.99"></a><span id="l44.99"> </span>
<a href="#l44.100"></a><span id="l44.100"> </span>
<a href="#l44.101"></a><span id="l44.101">   // Add a couple of messages to the INBOX</span>
<a href="#l44.102"></a><span id="l44.102">   // this is synchronous, afaik</span>
<a href="#l44.103"></a><span id="l44.103">   addMessagesToServer([{file: gMsgFile1, messageId: gMsgId1},</span>
<a href="#l44.104"></a><span id="l44.104">                        {file: gMsgFile2, messageId: gMsgId2},</span>
<a href="#l44.105"></a><span id="l44.105">                        {file: gMsgFile3, messageId: gMsgId3},</span>
<a href="#l44.106"></a><span id="l44.106" class="difflineat">@@ -109,125 +108,122 @@ var tests = [</span>
<a href="#l44.107"></a><span id="l44.107">   function* selectFirstMsg() {</span>
<a href="#l44.108"></a><span id="l44.108">     // We postpone creating the imap service until after we've set the prefs</span>
<a href="#l44.109"></a><span id="l44.109">     // that it reads on its startup.</span>
<a href="#l44.110"></a><span id="l44.110">     gIMAPService = Cc[&quot;@mozilla.org/messenger/messageservice;1?type=imap&quot;]</span>
<a href="#l44.111"></a><span id="l44.111">                      .getService(Ci.nsIMsgMessageService);</span>
<a href="#l44.112"></a><span id="l44.112"> </span>
<a href="#l44.113"></a><span id="l44.113">     let db = IMAPPump.inbox.msgDatabase;</span>
<a href="#l44.114"></a><span id="l44.114">     let msg1 = db.getMsgHdrForMessageID(gMsgId1);</span>
<a href="#l44.115"></a><span id="l44.115" class="difflineminus">-    let url = new Object;</span>
<a href="#l44.116"></a><span id="l44.116" class="difflineplus">+    let url = {};</span>
<a href="#l44.117"></a><span id="l44.117">     gIMAPService.DisplayMessage(IMAPPump.inbox.getUriForMsg(msg1),</span>
<a href="#l44.118"></a><span id="l44.118">                                             streamListener,</span>
<a href="#l44.119"></a><span id="l44.119">                                             null,</span>
<a href="#l44.120"></a><span id="l44.120">                                             asyncUrlListener,</span>
<a href="#l44.121"></a><span id="l44.121">                                             null,</span>
<a href="#l44.122"></a><span id="l44.122">                                             url);</span>
<a href="#l44.123"></a><span id="l44.123">     yield false;</span>
<a href="#l44.124"></a><span id="l44.124">   },</span>
<a href="#l44.125"></a><span id="l44.125">   function* select2ndMsg() {</span>
<a href="#l44.126"></a><span id="l44.126">     let msg1 = IMAPPump.inbox.msgDatabase.getMsgHdrForMessageID(gMsgId1);</span>
<a href="#l44.127"></a><span id="l44.127">     Assert.notEqual(msg1.flags &amp; Ci.nsMsgMessageFlags.Offline, 0);</span>
<a href="#l44.128"></a><span id="l44.128">     let db = IMAPPump.inbox.msgDatabase;</span>
<a href="#l44.129"></a><span id="l44.129">     let msg2 = db.getMsgHdrForMessageID(gMsgId2);</span>
<a href="#l44.130"></a><span id="l44.130" class="difflineminus">-    let url = new Object;</span>
<a href="#l44.131"></a><span id="l44.131" class="difflineplus">+    let url = {};</span>
<a href="#l44.132"></a><span id="l44.132">     gIMAPService.DisplayMessage(IMAPPump.inbox.getUriForMsg(msg2),</span>
<a href="#l44.133"></a><span id="l44.133">                                             streamListener,</span>
<a href="#l44.134"></a><span id="l44.134">                                             null,</span>
<a href="#l44.135"></a><span id="l44.135">                                             asyncUrlListener,</span>
<a href="#l44.136"></a><span id="l44.136">                                             null,</span>
<a href="#l44.137"></a><span id="l44.137">                                             url);</span>
<a href="#l44.138"></a><span id="l44.138">     yield false;</span>
<a href="#l44.139"></a><span id="l44.139">   },</span>
<a href="#l44.140"></a><span id="l44.140">   function* select3rdMsg() {</span>
<a href="#l44.141"></a><span id="l44.141">     let msg2 = IMAPPump.inbox.msgDatabase.getMsgHdrForMessageID(gMsgId2);</span>
<a href="#l44.142"></a><span id="l44.142">     Assert.notEqual(msg2.flags &amp; Ci.nsMsgMessageFlags.Offline, 0);</span>
<a href="#l44.143"></a><span id="l44.143">     let db = IMAPPump.inbox.msgDatabase;</span>
<a href="#l44.144"></a><span id="l44.144">     let msg3 = db.getMsgHdrForMessageID(gMsgId3);</span>
<a href="#l44.145"></a><span id="l44.145" class="difflineminus">-    let url = new Object;</span>
<a href="#l44.146"></a><span id="l44.146" class="difflineplus">+    let url = {};</span>
<a href="#l44.147"></a><span id="l44.147">     gIMAPService.DisplayMessage(IMAPPump.inbox.getUriForMsg(msg3),</span>
<a href="#l44.148"></a><span id="l44.148">                                             streamListener,</span>
<a href="#l44.149"></a><span id="l44.149">                                             null,</span>
<a href="#l44.150"></a><span id="l44.150">                                             asyncUrlListener,</span>
<a href="#l44.151"></a><span id="l44.151">                                             null,</span>
<a href="#l44.152"></a><span id="l44.152">                                             url);</span>
<a href="#l44.153"></a><span id="l44.153">     yield false;</span>
<a href="#l44.154"></a><span id="l44.154">   },</span>
<a href="#l44.155"></a><span id="l44.155">   function verify3rdMsg() {</span>
<a href="#l44.156"></a><span id="l44.156" class="difflineminus">-    let msg3 = IMAPPump.inbox.msgDatabase.getMsgHdrForMessageID(gMsgId3);</span>
<a href="#l44.157"></a><span id="l44.157" class="difflineplus">+    // let msg3 =</span>
<a href="#l44.158"></a><span id="l44.158" class="difflineplus">+    IMAPPump.inbox.msgDatabase.getMsgHdrForMessageID(gMsgId3);</span>
<a href="#l44.159"></a><span id="l44.159">     // can't turn this on because our fake server doesn't support body structure.</span>
<a href="#l44.160"></a><span id="l44.160" class="difflineminus">-//    do_check_eq(msg3.flags &amp; Ci.nsMsgMessageFlags.Offline, 0);</span>
<a href="#l44.161"></a><span id="l44.161" class="difflineplus">+    // do_check_eq(msg3.flags &amp; Ci.nsMsgMessageFlags.Offline, 0);</span>
<a href="#l44.162"></a><span id="l44.162">   },</span>
<a href="#l44.163"></a><span id="l44.163">   function* addNewMsgs() {</span>
<a href="#l44.164"></a><span id="l44.164" class="difflineminus">-    let mbox = IMAPPump.daemon.getMailbox(&quot;INBOX&quot;)</span>
<a href="#l44.165"></a><span id="l44.165" class="difflineplus">+    let mbox = IMAPPump.daemon.getMailbox(&quot;INBOX&quot;);</span>
<a href="#l44.166"></a><span id="l44.166">     // make a couple of messages</span>
<a href="#l44.167"></a><span id="l44.167">     let messages = [];</span>
<a href="#l44.168"></a><span id="l44.168">     let bodyString = &quot;&quot;;</span>
<a href="#l44.169"></a><span id="l44.169">     for (let i = 0; i &lt; 100; i++)</span>
<a href="#l44.170"></a><span id="l44.170">       bodyString += &quot;1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890\r\n&quot;;</span>
<a href="#l44.171"></a><span id="l44.171"> </span>
<a href="#l44.172"></a><span id="l44.172" class="difflineminus">-    let gMessageGenerator = new MessageGenerator();</span>
<a href="#l44.173"></a><span id="l44.173" class="difflineplus">+    gMessageGenerator = new MessageGenerator();</span>
<a href="#l44.174"></a><span id="l44.174">     messages = messages.concat(gMessageGenerator.makeMessage({body: {body: bodyString, contentType: &quot;text/plain&quot;}}));</span>
<a href="#l44.175"></a><span id="l44.175"> </span>
<a href="#l44.176"></a><span id="l44.176">     gFirstNewMsg = mbox.uidnext;</span>
<a href="#l44.177"></a><span id="l44.177">     // need to account for x-mozilla-status, status2, and envelope.</span>
<a href="#l44.178"></a><span id="l44.178">     gFirstMsgSize = messages[0].toMessageString().length + 102;</span>
<a href="#l44.179"></a><span id="l44.179"> </span>
<a href="#l44.180"></a><span id="l44.180" class="difflineminus">-    messages.forEach(function (message)</span>
<a href="#l44.181"></a><span id="l44.181" class="difflineminus">-    {</span>
<a href="#l44.182"></a><span id="l44.182" class="difflineplus">+    messages.forEach(function(message) {</span>
<a href="#l44.183"></a><span id="l44.183">       let dataUri = Services.io.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l44.184"></a><span id="l44.184">                                        btoa(message.toMessageString()));</span>
<a href="#l44.185"></a><span id="l44.185">       mbox.addMessage(new imapMessage(dataUri.spec, mbox.uidnext++, []));</span>
<a href="#l44.186"></a><span id="l44.186">     });</span>
<a href="#l44.187"></a><span id="l44.187">     IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l44.188"></a><span id="l44.188">     yield false;</span>
<a href="#l44.189"></a><span id="l44.189">   },</span>
<a href="#l44.190"></a><span id="l44.190" class="difflineminus">-  function* testQueuedOfflineDownload()</span>
<a href="#l44.191"></a><span id="l44.191" class="difflineminus">-  {</span>
<a href="#l44.192"></a><span id="l44.192" class="difflineplus">+  function* testQueuedOfflineDownload() {</span>
<a href="#l44.193"></a><span id="l44.193">     // Make sure that streaming the same message and then trying to download</span>
<a href="#l44.194"></a><span id="l44.194">     // it for offline use doesn't end up in it getting added to the offline</span>
<a href="#l44.195"></a><span id="l44.195">     // store twice.</span>
<a href="#l44.196"></a><span id="l44.196">     gImapInboxOfflineStoreSize = IMAPPump.inbox.filePath.fileSize + gFirstMsgSize;</span>
<a href="#l44.197"></a><span id="l44.197">     let newMsgHdr = IMAPPump.inbox.GetMessageHeader(gFirstNewMsg);</span>
<a href="#l44.198"></a><span id="l44.198">     let msgURI = newMsgHdr.folder.getUriForMsg(newMsgHdr);</span>
<a href="#l44.199"></a><span id="l44.199">     let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l44.200"></a><span id="l44.200">     let msgServ = messenger.messageServiceFromURI(msgURI);</span>
<a href="#l44.201"></a><span id="l44.201">     msgServ.streamMessage(msgURI, gStreamListener, null, null, false, &quot;&quot;, false);</span>
<a href="#l44.202"></a><span id="l44.202">     yield false;</span>
<a href="#l44.203"></a><span id="l44.203">   },</span>
<a href="#l44.204"></a><span id="l44.204" class="difflineminus">-  function* firstStreamFinished()</span>
<a href="#l44.205"></a><span id="l44.205" class="difflineminus">-  {</span>
<a href="#l44.206"></a><span id="l44.206" class="difflineplus">+  function* firstStreamFinished() {</span>
<a href="#l44.207"></a><span id="l44.207">     // nsIMsgFolder.DownloadMessagesForOffline does not take a listener, so</span>
<a href="#l44.208"></a><span id="l44.208">     // we invoke nsIImapService.downloadMessagesForOffline directly with a</span>
<a href="#l44.209"></a><span id="l44.209">     // listener.</span>
<a href="#l44.210"></a><span id="l44.210">     MailServices.imap.downloadMessagesForOffline(gFirstNewMsg,</span>
<a href="#l44.211"></a><span id="l44.211">                                                  IMAPPump.inbox,</span>
<a href="#l44.212"></a><span id="l44.212">                                                  asyncUrlListener,</span>
<a href="#l44.213"></a><span id="l44.213">                                                  null);</span>
<a href="#l44.214"></a><span id="l44.214">     yield false;</span>
<a href="#l44.215"></a><span id="l44.215">   },</span>
<a href="#l44.216"></a><span id="l44.216" class="difflineminus">-  function checkOfflineStoreSize()</span>
<a href="#l44.217"></a><span id="l44.217" class="difflineminus">-  {</span>
<a href="#l44.218"></a><span id="l44.218" class="difflineplus">+  function checkOfflineStoreSize() {</span>
<a href="#l44.219"></a><span id="l44.219">     dump(&quot;checking offline store size\n&quot;);</span>
<a href="#l44.220"></a><span id="l44.220">     Assert.ok(IMAPPump.inbox.filePath.fileSize &lt;= gImapInboxOfflineStoreSize);</span>
<a href="#l44.221"></a><span id="l44.221">   },</span>
<a href="#l44.222"></a><span id="l44.222" class="difflineminus">-  teardown</span>
<a href="#l44.223"></a><span id="l44.223" class="difflineminus">-]</span>
<a href="#l44.224"></a><span id="l44.224" class="difflineplus">+  teardown,</span>
<a href="#l44.225"></a><span id="l44.225" class="difflineplus">+];</span>
<a href="#l44.226"></a><span id="l44.226"> </span>
<a href="#l44.227"></a><span id="l44.227"> var gStreamListener = {</span>
<a href="#l44.228"></a><span id="l44.228" class="difflineminus">-  QueryInterface : ChromeUtils.generateQI([Ci.nsIStreamListener]),</span>
<a href="#l44.229"></a><span id="l44.229" class="difflineminus">-  _stream : null,</span>
<a href="#l44.230"></a><span id="l44.230" class="difflineminus">-  _data : null,</span>
<a href="#l44.231"></a><span id="l44.231" class="difflineminus">-  onStartRequest : function (aRequest) {</span>
<a href="#l44.232"></a><span id="l44.232" class="difflineplus">+  QueryInterface: ChromeUtils.generateQI([Ci.nsIStreamListener]),</span>
<a href="#l44.233"></a><span id="l44.233" class="difflineplus">+  _stream: null,</span>
<a href="#l44.234"></a><span id="l44.234" class="difflineplus">+  _data: null,</span>
<a href="#l44.235"></a><span id="l44.235" class="difflineplus">+  onStartRequest(aRequest) {</span>
<a href="#l44.236"></a><span id="l44.236">     this._data = &quot;&quot;;</span>
<a href="#l44.237"></a><span id="l44.237">   },</span>
<a href="#l44.238"></a><span id="l44.238" class="difflineminus">-  onStopRequest : function (aRequest, aStatusCode) {</span>
<a href="#l44.239"></a><span id="l44.239" class="difflineplus">+  onStopRequest(aRequest, aStatusCode) {</span>
<a href="#l44.240"></a><span id="l44.240">     async_driver();</span>
<a href="#l44.241"></a><span id="l44.241">   },</span>
<a href="#l44.242"></a><span id="l44.242" class="difflineminus">-  onDataAvailable : function (aRequest, aInputStream, aOff, aCount) {</span>
<a href="#l44.243"></a><span id="l44.243" class="difflineplus">+  onDataAvailable(aRequest, aInputStream, aOff, aCount) {</span>
<a href="#l44.244"></a><span id="l44.244">     if (this._stream == null) {</span>
<a href="#l44.245"></a><span id="l44.245">       this._stream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;].createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l44.246"></a><span id="l44.246">       this._stream.init(aInputStream);</span>
<a href="#l44.247"></a><span id="l44.247">     }</span>
<a href="#l44.248"></a><span id="l44.248">     this._data += this._stream.read(aCount);</span>
<a href="#l44.249"></a><span id="l44.249">   },</span>
<a href="#l44.250"></a><span id="l44.250"> };</span>
<a href="#l44.251"></a><span id="l44.251"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapUndo.js</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapUndo.js</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineat">@@ -2,64 +2,62 @@</span>
<a href="#l45.4"></a><span id="l45.4"> // There are three main cases:</span>
<a href="#l45.5"></a><span id="l45.5"> // 1. Normal undo</span>
<a href="#l45.6"></a><span id="l45.6"> // 2. Undo after the source folder has been compacted.</span>
<a href="#l45.7"></a><span id="l45.7"> // 2.1 Same, but the server doesn't support COPYUID (GMail case)</span>
<a href="#l45.8"></a><span id="l45.8"> //</span>
<a href="#l45.9"></a><span id="l45.9"> // Original Author: David Bienvenu &lt;bienvenu@nventure.com&gt;</span>
<a href="#l45.10"></a><span id="l45.10"> </span>
<a href="#l45.11"></a><span id="l45.11"> </span>
<a href="#l45.12"></a><span id="l45.12" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l45.13"></a><span id="l45.13" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l45.14"></a><span id="l45.14"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l45.15"></a><span id="l45.15"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l45.16"></a><span id="l45.16"> </span>
<a href="#l45.17"></a><span id="l45.17"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l45.18"></a><span id="l45.18"> </span>
<a href="#l45.19"></a><span id="l45.19"> var gRootFolder;</span>
<a href="#l45.20"></a><span id="l45.20" class="difflineminus">-var gLastKey;</span>
<a href="#l45.21"></a><span id="l45.21"> var gMessages = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l45.22"></a><span id="l45.22" class="difflineminus">-var gCopyService = MailServices.copy;</span>
<a href="#l45.23"></a><span id="l45.23"> var gMsgWindow;</span>
<a href="#l45.24"></a><span id="l45.24"> </span>
<a href="#l45.25"></a><span id="l45.25"> var gMsgFile1 = do_get_file(&quot;../../../data/bugmail10&quot;);</span>
<a href="#l45.26"></a><span id="l45.26"> var gMsgFile2 = do_get_file(&quot;../../../data/bugmail11&quot;);</span>
<a href="#l45.27"></a><span id="l45.27" class="difflineminus">-var gMsgFile3 = do_get_file(&quot;../../../data/draft1&quot;);</span>
<a href="#l45.28"></a><span id="l45.28" class="difflineplus">+// var gMsgFile3 = do_get_file(&quot;../../../data/draft1&quot;);</span>
<a href="#l45.29"></a><span id="l45.29"> var gMsgFile4 = do_get_file(&quot;../../../data/bugmail7&quot;);</span>
<a href="#l45.30"></a><span id="l45.30"> var gMsgFile5 = do_get_file(&quot;../../../data/bugmail6&quot;);</span>
<a href="#l45.31"></a><span id="l45.31"> </span>
<a href="#l45.32"></a><span id="l45.32"> // Copied straight from the example files</span>
<a href="#l45.33"></a><span id="l45.33"> var gMsgId1 = &quot;200806061706.m56H6RWT004933@mrapp54.mozilla.org&quot;;</span>
<a href="#l45.34"></a><span id="l45.34"> var gMsgId2 = &quot;200804111417.m3BEHTk4030129@mrapp51.mozilla.org&quot;;</span>
<a href="#l45.35"></a><span id="l45.35" class="difflineminus">-var gMsgId3 = &quot;4849BF7B.2030800@example.com&quot;;</span>
<a href="#l45.36"></a><span id="l45.36" class="difflineplus">+// var gMsgId3 = &quot;4849BF7B.2030800@example.com&quot;;</span>
<a href="#l45.37"></a><span id="l45.37"> var gMsgId4 = &quot;bugmail7.m47LtAEf007542@mrapp51.mozilla.org&quot;;</span>
<a href="#l45.38"></a><span id="l45.38"> var gMsgId5 = &quot;bugmail6.m47LtAEf007542@mrapp51.mozilla.org&quot;;</span>
<a href="#l45.39"></a><span id="l45.39"> </span>
<a href="#l45.40"></a><span id="l45.40"> </span>
<a href="#l45.41"></a><span id="l45.41"> </span>
<a href="#l45.42"></a><span id="l45.42"> // Adds some messages directly to a mailbox (eg new mail)</span>
<a href="#l45.43"></a><span id="l45.43" class="difflineminus">-function addMessagesToServer(messages, mailbox)</span>
<a href="#l45.44"></a><span id="l45.44" class="difflineminus">-{</span>
<a href="#l45.45"></a><span id="l45.45" class="difflineplus">+function addMessagesToServer(messages, mailbox) {</span>
<a href="#l45.46"></a><span id="l45.46">   // For every message we have, we need to convert it to a file:/// URI</span>
<a href="#l45.47"></a><span id="l45.47" class="difflineminus">-  messages.forEach(function (message)</span>
<a href="#l45.48"></a><span id="l45.48" class="difflineminus">-  {</span>
<a href="#l45.49"></a><span id="l45.49" class="difflineplus">+  messages.forEach(function(message) {</span>
<a href="#l45.50"></a><span id="l45.50">     let URI = Services.io.newFileURI(message.file).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l45.51"></a><span id="l45.51">     // Create the imapMessage and store it on the mailbox.</span>
<a href="#l45.52"></a><span id="l45.52">     mailbox.addMessage(new imapMessage(URI.spec, mailbox.uidnext++, []));</span>
<a href="#l45.53"></a><span id="l45.53">   });</span>
<a href="#l45.54"></a><span id="l45.54"> }</span>
<a href="#l45.55"></a><span id="l45.55"> </span>
<a href="#l45.56"></a><span id="l45.56"> function alertListener() {}</span>
<a href="#l45.57"></a><span id="l45.57"> </span>
<a href="#l45.58"></a><span id="l45.58"> alertListener.prototype = {</span>
<a href="#l45.59"></a><span id="l45.59" class="difflineminus">-  reset: function () {</span>
<a href="#l45.60"></a><span id="l45.60" class="difflineplus">+  reset() {</span>
<a href="#l45.61"></a><span id="l45.61">   },</span>
<a href="#l45.62"></a><span id="l45.62"> </span>
<a href="#l45.63"></a><span id="l45.63" class="difflineminus">-  onAlert: function (aMessage, aMsgWindow) {</span>
<a href="#l45.64"></a><span id="l45.64" class="difflineplus">+  onAlert(aMessage, aMsgWindow) {</span>
<a href="#l45.65"></a><span id="l45.65">     dump(&quot;got alert &quot; + aMessage + &quot;\n&quot;);</span>
<a href="#l45.66"></a><span id="l45.66" class="difflineminus">-    do_throw ('TEST FAILED ' + aMessage);</span>
<a href="#l45.67"></a><span id="l45.67" class="difflineminus">-  }</span>
<a href="#l45.68"></a><span id="l45.68" class="difflineplus">+    do_throw(&quot;TEST FAILED &quot; + aMessage);</span>
<a href="#l45.69"></a><span id="l45.69" class="difflineplus">+  },</span>
<a href="#l45.70"></a><span id="l45.70"> };</span>
<a href="#l45.71"></a><span id="l45.71"> </span>
<a href="#l45.72"></a><span id="l45.72"> var tests = [</span>
<a href="#l45.73"></a><span id="l45.73">   setup,</span>
<a href="#l45.74"></a><span id="l45.74">   function* updateFolder() {</span>
<a href="#l45.75"></a><span id="l45.75">     IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l45.76"></a><span id="l45.76">     yield false;</span>
<a href="#l45.77"></a><span id="l45.77">   },</span>
<a href="#l45.78"></a><span id="l45.78" class="difflineat">@@ -90,17 +88,17 @@ var tests = [</span>
<a href="#l45.79"></a><span id="l45.79">     IMAPPump.inbox.updateFolderWithListener(gMsgWindow, asyncUrlListener);</span>
<a href="#l45.80"></a><span id="l45.80">     yield false;</span>
<a href="#l45.81"></a><span id="l45.81">   },</span>
<a href="#l45.82"></a><span id="l45.82">   function verifyFolders() {</span>
<a href="#l45.83"></a><span id="l45.83">     let msgRestored = IMAPPump.inbox.msgDatabase.getMsgHdrForMessageID(gMsgId1);</span>
<a href="#l45.84"></a><span id="l45.84">     Assert.ok(msgRestored !== null);</span>
<a href="#l45.85"></a><span id="l45.85">     Assert.equal(IMAPPump.inbox.msgDatabase.dBFolderInfo.numMessages, 4);</span>
<a href="#l45.86"></a><span id="l45.86">   },</span>
<a href="#l45.87"></a><span id="l45.87" class="difflineminus">-  teardown</span>
<a href="#l45.88"></a><span id="l45.88" class="difflineplus">+  teardown,</span>
<a href="#l45.89"></a><span id="l45.89"> ];</span>
<a href="#l45.90"></a><span id="l45.90"> </span>
<a href="#l45.91"></a><span id="l45.91"> function setup() {</span>
<a href="#l45.92"></a><span id="l45.92">   setupIMAPPump();</span>
<a href="#l45.93"></a><span id="l45.93"> </span>
<a href="#l45.94"></a><span id="l45.94">   var listener1 = new alertListener();</span>
<a href="#l45.95"></a><span id="l45.95"> </span>
<a href="#l45.96"></a><span id="l45.96">   MailServices.mailSession.addUserFeedbackListener(listener1);</span>
<a href="#l45.97"></a><span id="l45.97" class="difflineat">@@ -111,17 +109,17 @@ function setup() {</span>
<a href="#l45.98"></a><span id="l45.98">   gMsgWindow = Cc[&quot;@mozilla.org/messenger/msgwindow;1&quot;]</span>
<a href="#l45.99"></a><span id="l45.99">                   .createInstance(Ci.nsIMsgWindow);</span>
<a href="#l45.100"></a><span id="l45.100"> </span>
<a href="#l45.101"></a><span id="l45.101">   gRootFolder = IMAPPump.incomingServer.rootFolder;</span>
<a href="#l45.102"></a><span id="l45.102">   // these hacks are required because we've created the inbox before</span>
<a href="#l45.103"></a><span id="l45.103">   // running initial folder discovery, and adding the folder bails</span>
<a href="#l45.104"></a><span id="l45.104">   // out before we set it as verified online, so we bail out, and</span>
<a href="#l45.105"></a><span id="l45.105">   // then remove the INBOX folder since it's not verified.</span>
<a href="#l45.106"></a><span id="l45.106" class="difflineminus">-  IMAPPump.inbox.hierarchyDelimiter = '/';</span>
<a href="#l45.107"></a><span id="l45.107" class="difflineplus">+  IMAPPump.inbox.hierarchyDelimiter = &quot;/&quot;;</span>
<a href="#l45.108"></a><span id="l45.108">   IMAPPump.inbox.verifiedAsOnlineFolder = true;</span>
<a href="#l45.109"></a><span id="l45.109"> </span>
<a href="#l45.110"></a><span id="l45.110"> </span>
<a href="#l45.111"></a><span id="l45.111">   // Add a couple of messages to the INBOX</span>
<a href="#l45.112"></a><span id="l45.112">   // this is synchronous, afaik</span>
<a href="#l45.113"></a><span id="l45.113">   addMessagesToServer([{file: gMsgFile1, messageId: gMsgId1},</span>
<a href="#l45.114"></a><span id="l45.114">                        {file: gMsgFile4, messageId: gMsgId4},</span>
<a href="#l45.115"></a><span id="l45.115">                        {file: gMsgFile5, messageId: gMsgId5},</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapUrls.js</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapUrls.js</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineat">@@ -9,18 +9,17 @@</span>
<a href="#l46.4"></a><span id="l46.4"> // IMAP pump</span>
<a href="#l46.5"></a><span id="l46.5"> </span>
<a href="#l46.6"></a><span id="l46.6"> setupIMAPPump();</span>
<a href="#l46.7"></a><span id="l46.7"> </span>
<a href="#l46.8"></a><span id="l46.8"> /*</span>
<a href="#l46.9"></a><span id="l46.9">  * Test parsing of imap uri's with very large UID's.</span>
<a href="#l46.10"></a><span id="l46.10">  */</span>
<a href="#l46.11"></a><span id="l46.11"> </span>
<a href="#l46.12"></a><span id="l46.12" class="difflineminus">-function run_test()</span>
<a href="#l46.13"></a><span id="l46.13" class="difflineminus">-{</span>
<a href="#l46.14"></a><span id="l46.14" class="difflineplus">+function run_test() {</span>
<a href="#l46.15"></a><span id="l46.15">   let imapS = Cc[&quot;@mozilla.org/messenger/messageservice;1?type=imap&quot;]</span>
<a href="#l46.16"></a><span id="l46.16">                 .getService(Ci.nsIMsgMessageService);</span>
<a href="#l46.17"></a><span id="l46.17">   let uri = {};</span>
<a href="#l46.18"></a><span id="l46.18">   imapS.GetUrlForUri(&quot;imap-message://user@localhost/INBOX#4294967168&quot;, uri, null);</span>
<a href="#l46.19"></a><span id="l46.19">   Assert.equal(uri.value.spec, &quot;imap://user@localhost:&quot; + IMAPPump.server.port +</span>
<a href="#l46.20"></a><span id="l46.20">       &quot;/fetch%3EUID%3E%5EINBOX%3E4294967168&quot;);</span>
<a href="#l46.21"></a><span id="l46.21">   teardownIMAPPump();</span>
<a href="#l46.22"></a><span id="l46.22"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_largeOfflineStore.js</span>
<a href="#l47.2"></a><span id="l47.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_largeOfflineStore.js</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineat">@@ -1,45 +1,47 @@</span>
<a href="#l47.4"></a><span id="l47.4"> /* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l47.5"></a><span id="l47.5"> /*</span>
<a href="#l47.6"></a><span id="l47.6">  * Test to ensure that downloadAllForOffline works correctly for large imap</span>
<a href="#l47.7"></a><span id="l47.7">  * stores, i.e., over 4 GiB.</span>
<a href="#l47.8"></a><span id="l47.8">  */</span>
<a href="#l47.9"></a><span id="l47.9"> </span>
<a href="#l47.10"></a><span id="l47.10" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l47.11"></a><span id="l47.11" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l47.12"></a><span id="l47.12" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l47.13"></a><span id="l47.13"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l47.14"></a><span id="l47.14"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l47.15"></a><span id="l47.15"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l47.16"></a><span id="l47.16"> </span>
<a href="#l47.17"></a><span id="l47.17"> Services.prefs.setCharPref(&quot;mail.serverDefaultStoreContractID&quot;,</span>
<a href="#l47.18"></a><span id="l47.18">                            &quot;@mozilla.org/msgstore/berkeleystore;1&quot;);</span>
<a href="#l47.19"></a><span id="l47.19"> </span>
<a href="#l47.20"></a><span id="l47.20"> var gOfflineStoreSize;</span>
<a href="#l47.21"></a><span id="l47.21"> </span>
<a href="#l47.22"></a><span id="l47.22"> var tests = [</span>
<a href="#l47.23"></a><span id="l47.23">   setup,</span>
<a href="#l47.24"></a><span id="l47.24">   check_result,</span>
<a href="#l47.25"></a><span id="l47.25" class="difflineminus">-  teardown</span>
<a href="#l47.26"></a><span id="l47.26" class="difflineplus">+  teardown,</span>
<a href="#l47.27"></a><span id="l47.27"> ];</span>
<a href="#l47.28"></a><span id="l47.28"> </span>
<a href="#l47.29"></a><span id="l47.29"> function run_test() {</span>
<a href="#l47.30"></a><span id="l47.30">   setupIMAPPump();</span>
<a href="#l47.31"></a><span id="l47.31"> </span>
<a href="#l47.32"></a><span id="l47.32">   // Figure out the name of the IMAP inbox</span>
<a href="#l47.33"></a><span id="l47.33">   let inboxFile = IMAPPump.incomingServer.rootMsgFolder.filePath;</span>
<a href="#l47.34"></a><span id="l47.34">   inboxFile.append(&quot;INBOX&quot;);</span>
<a href="#l47.35"></a><span id="l47.35">   if (!inboxFile.exists())</span>
<a href="#l47.36"></a><span id="l47.36">     inboxFile.create(Ci.nsIFile.NORMAL_FILE_TYPE, parseInt(&quot;0644&quot;, 8));</span>
<a href="#l47.37"></a><span id="l47.37"> </span>
<a href="#l47.38"></a><span id="l47.38">   let neededFreeSpace = 0x200000000;</span>
<a href="#l47.39"></a><span id="l47.39">   // On Windows, check whether the drive is NTFS. If it is, mark the file as</span>
<a href="#l47.40"></a><span id="l47.40">   // sparse. If it isn't, then bail out now, because in all probability it is</span>
<a href="#l47.41"></a><span id="l47.41">   // FAT32, which doesn't support file sizes greater than 4 GB.</span>
<a href="#l47.42"></a><span id="l47.42">   if (&quot;@mozilla.org/windows-registry-key;1&quot; in Cc &amp;&amp;</span>
<a href="#l47.43"></a><span id="l47.43" class="difflineminus">-      mailTestUtils.get_file_system(inboxFile) != &quot;NTFS&quot;)</span>
<a href="#l47.44"></a><span id="l47.44" class="difflineminus">-  {</span>
<a href="#l47.45"></a><span id="l47.45" class="difflineplus">+      mailTestUtils.get_file_system(inboxFile) != &quot;NTFS&quot;) {</span>
<a href="#l47.46"></a><span id="l47.46">     dump(&quot;On Windows, this test only works on NTFS volumes.\n&quot;);</span>
<a href="#l47.47"></a><span id="l47.47">     teardown();</span>
<a href="#l47.48"></a><span id="l47.48">     return;</span>
<a href="#l47.49"></a><span id="l47.49">   }</span>
<a href="#l47.50"></a><span id="l47.50"> </span>
<a href="#l47.51"></a><span id="l47.51">   let isFileSparse = mailTestUtils.mark_file_region_sparse(inboxFile, 0, 0x10000000f);</span>
<a href="#l47.52"></a><span id="l47.52">   let freeDiskSpace = inboxFile.diskSpaceAvailable;</span>
<a href="#l47.53"></a><span id="l47.53">   info(&quot;Free disk space = &quot; + mailTestUtils.toMiBString(freeDiskSpace));</span>
<a href="#l47.54"></a><span id="l47.54" class="difflineat">@@ -114,17 +116,17 @@ function* check_result() {</span>
<a href="#l47.55"></a><span id="l47.55">     // Verify that each message has been downloaded and looks OK.</span>
<a href="#l47.56"></a><span id="l47.56">     if (!(header instanceof Ci.nsIMsgDBHdr &amp;&amp;</span>
<a href="#l47.57"></a><span id="l47.57">           (header.flags &amp; Ci.nsMsgMessageFlags.Offline)))</span>
<a href="#l47.58"></a><span id="l47.58">       do_throw(&quot;Message not downloaded for offline use&quot;);</span>
<a href="#l47.59"></a><span id="l47.59"> </span>
<a href="#l47.60"></a><span id="l47.60">     IMAPPump.inbox.getOfflineFileStream(header.messageKey, offset, size).close();</span>
<a href="#l47.61"></a><span id="l47.61">     info(&quot;Msg hdr offset = &quot; + offset.value);</span>
<a href="#l47.62"></a><span id="l47.62">   }</span>
<a href="#l47.63"></a><span id="l47.63" class="difflineminus">-};</span>
<a href="#l47.64"></a><span id="l47.64" class="difflineplus">+}</span>
<a href="#l47.65"></a><span id="l47.65"> </span>
<a href="#l47.66"></a><span id="l47.66"> function teardown() {</span>
<a href="#l47.67"></a><span id="l47.67">   // Free up disk space - if you want to look at the file after running</span>
<a href="#l47.68"></a><span id="l47.68">   // this test, comment out this line.</span>
<a href="#l47.69"></a><span id="l47.69">   if (IMAPPump.inbox)</span>
<a href="#l47.70"></a><span id="l47.70">     IMAPPump.inbox.filePath.remove(false);</span>
<a href="#l47.71"></a><span id="l47.71"> </span>
<a href="#l47.72"></a><span id="l47.72">   teardownIMAPPump();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_listClosesDB.js</span>
<a href="#l48.2"></a><span id="l48.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_listClosesDB.js</span>
<a href="#l48.3"></a><span id="l48.3" class="difflineat">@@ -1,37 +1,40 @@</span>
<a href="#l48.4"></a><span id="l48.4"> // This file tests that listing folders on startup because we're not using</span>
<a href="#l48.5"></a><span id="l48.5"> // subscription doesn't leave db's open.</span>
<a href="#l48.6"></a><span id="l48.6"> </span>
<a href="#l48.7"></a><span id="l48.7" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l48.8"></a><span id="l48.8" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l48.9"></a><span id="l48.9" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l48.10"></a><span id="l48.10"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l48.11"></a><span id="l48.11"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l48.12"></a><span id="l48.12"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l48.13"></a><span id="l48.13"> </span>
<a href="#l48.14"></a><span id="l48.14"> var gSub3;</span>
<a href="#l48.15"></a><span id="l48.15"> </span>
<a href="#l48.16"></a><span id="l48.16"> var tests = [</span>
<a href="#l48.17"></a><span id="l48.17">   setup,</span>
<a href="#l48.18"></a><span id="l48.18">   updateInbox,</span>
<a href="#l48.19"></a><span id="l48.19">   checkCachedDBForFolder,</span>
<a href="#l48.20"></a><span id="l48.20" class="difflineminus">-  teardown</span>
<a href="#l48.21"></a><span id="l48.21" class="difflineplus">+  teardown,</span>
<a href="#l48.22"></a><span id="l48.22"> ];</span>
<a href="#l48.23"></a><span id="l48.23"> </span>
<a href="#l48.24"></a><span id="l48.24"> function* setup() {</span>
<a href="#l48.25"></a><span id="l48.25">   setupIMAPPump();</span>
<a href="#l48.26"></a><span id="l48.26"> </span>
<a href="#l48.27"></a><span id="l48.27" class="difflineminus">-  IMAPPump.daemon.createMailbox(&quot;folder1&quot;, {subscribed : true});</span>
<a href="#l48.28"></a><span id="l48.28" class="difflineminus">-  IMAPPump.daemon.createMailbox(&quot;folder1/sub1&quot;, &quot;&quot;, {subscribed : true});</span>
<a href="#l48.29"></a><span id="l48.29" class="difflineminus">-  IMAPPump.daemon.createMailbox(&quot;folder1/sub1/sub2&quot;, &quot;&quot;, {subscribed : true});</span>
<a href="#l48.30"></a><span id="l48.30" class="difflineminus">-  IMAPPump.daemon.createMailbox(&quot;folder1/sub1/sub2/sub3&quot;, &quot;&quot;, {subscribed : true});</span>
<a href="#l48.31"></a><span id="l48.31" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;folder1&quot;, {subscribed: true});</span>
<a href="#l48.32"></a><span id="l48.32" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;folder1/sub1&quot;, &quot;&quot;, {subscribed: true});</span>
<a href="#l48.33"></a><span id="l48.33" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;folder1/sub1/sub2&quot;, &quot;&quot;, {subscribed: true});</span>
<a href="#l48.34"></a><span id="l48.34" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;folder1/sub1/sub2/sub3&quot;, &quot;&quot;, {subscribed: true});</span>
<a href="#l48.35"></a><span id="l48.35"> </span>
<a href="#l48.36"></a><span id="l48.36">   IMAPPump.incomingServer.usingSubscription = false;</span>
<a href="#l48.37"></a><span id="l48.37"> </span>
<a href="#l48.38"></a><span id="l48.38">   let rootFolder = IMAPPump.incomingServer.rootFolder.QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l48.39"></a><span id="l48.39" class="difflineminus">-  rootFolder.hierarchyDelimiter = '/';</span>
<a href="#l48.40"></a><span id="l48.40" class="difflineminus">-  IMAPPump.inbox.hierarchyDelimiter = '/';</span>
<a href="#l48.41"></a><span id="l48.41" class="difflineplus">+  rootFolder.hierarchyDelimiter = &quot;/&quot;;</span>
<a href="#l48.42"></a><span id="l48.42" class="difflineplus">+  IMAPPump.inbox.hierarchyDelimiter = &quot;/&quot;;</span>
<a href="#l48.43"></a><span id="l48.43">   rootFolder.addSubfolder(&quot;folder1&quot;);</span>
<a href="#l48.44"></a><span id="l48.44">   rootFolder.addSubfolder(&quot;folder1/sub1&quot;);</span>
<a href="#l48.45"></a><span id="l48.45">   rootFolder.addSubfolder(&quot;folder1/sub1/sub2&quot;);</span>
<a href="#l48.46"></a><span id="l48.46">   gSub3 = rootFolder.addSubfolder(&quot;folder1/sub1/sub2/sub3&quot;);</span>
<a href="#l48.47"></a><span id="l48.47">   IMAPPump.server.performTest(&quot;LIST&quot;);</span>
<a href="#l48.48"></a><span id="l48.48"> </span>
<a href="#l48.49"></a><span id="l48.49">   do_timeout(1000, async_driver);</span>
<a href="#l48.50"></a><span id="l48.50">   yield false;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l49.1"></a><span id="l49.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_listSubscribed.js</span>
<a href="#l49.2"></a><span id="l49.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_listSubscribed.js</span>
<a href="#l49.3"></a><span id="l49.3" class="difflineat">@@ -8,16 +8,19 @@</span>
<a href="#l49.4"></a><span id="l49.4"> /* References:</span>
<a href="#l49.5"></a><span id="l49.5">  * RFC 5258 - http://tools.ietf.org/html/rfc5258</span>
<a href="#l49.6"></a><span id="l49.6">  * Bug 495318</span>
<a href="#l49.7"></a><span id="l49.7">  * Bug 816028</span>
<a href="#l49.8"></a><span id="l49.8">  * http://bugzilla.zimbra.com/show_bug.cgi?id=78794</span>
<a href="#l49.9"></a><span id="l49.9">  */</span>
<a href="#l49.10"></a><span id="l49.10"> </span>
<a href="#l49.11"></a><span id="l49.11"> // async support</span>
<a href="#l49.12"></a><span id="l49.12" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l49.13"></a><span id="l49.13" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l49.14"></a><span id="l49.14" class="difflineplus">+/* import-globals-from ../../../test/resources/alertTestUtils.js */</span>
<a href="#l49.15"></a><span id="l49.15"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l49.16"></a><span id="l49.16"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l49.17"></a><span id="l49.17"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l49.18"></a><span id="l49.18"> </span>
<a href="#l49.19"></a><span id="l49.19"> // IMAP pump</span>
<a href="#l49.20"></a><span id="l49.20"> </span>
<a href="#l49.21"></a><span id="l49.21"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l49.22"></a><span id="l49.22"> </span>
<a href="#l49.23"></a><span id="l49.23" class="difflineat">@@ -27,73 +30,71 @@ var {Services} = ChromeUtils.import(&quot;res</span>
<a href="#l49.24"></a><span id="l49.24"> // it also has a bug that causes a server crash in certain setups</span>
<a href="#l49.25"></a><span id="l49.25"> setupIMAPPump(&quot;Zimbra&quot;);</span>
<a href="#l49.26"></a><span id="l49.26"> </span>
<a href="#l49.27"></a><span id="l49.27"> // Definition of tests</span>
<a href="#l49.28"></a><span id="l49.28"> var tests = [</span>
<a href="#l49.29"></a><span id="l49.29">   setupMailboxes,</span>
<a href="#l49.30"></a><span id="l49.30">   testListSubscribed,</span>
<a href="#l49.31"></a><span id="l49.31">   testZimbraServerVersions,</span>
<a href="#l49.32"></a><span id="l49.32" class="difflineminus">-  endTest</span>
<a href="#l49.33"></a><span id="l49.33" class="difflineminus">-]</span>
<a href="#l49.34"></a><span id="l49.34" class="difflineplus">+  endTest,</span>
<a href="#l49.35"></a><span id="l49.35" class="difflineplus">+];</span>
<a href="#l49.36"></a><span id="l49.36"> </span>
<a href="#l49.37"></a><span id="l49.37"> // setup the mailboxes that will be used for this test</span>
<a href="#l49.38"></a><span id="l49.38" class="difflineminus">-function* setupMailboxes()</span>
<a href="#l49.39"></a><span id="l49.39" class="difflineminus">-{</span>
<a href="#l49.40"></a><span id="l49.40" class="difflineplus">+function* setupMailboxes() {</span>
<a href="#l49.41"></a><span id="l49.41">   IMAPPump.mailbox.subscribed = true;</span>
<a href="#l49.42"></a><span id="l49.42" class="difflineminus">-  IMAPPump.daemon.createMailbox(&quot;folder1&quot;, {subscribed : true, flags : [&quot;\\Noselect&quot;]});</span>
<a href="#l49.43"></a><span id="l49.43" class="difflineminus">-  IMAPPump.daemon.createMailbox(&quot;folder1/folder11&quot;, {subscribed : true, flags : [&quot;\\Noinferiors&quot;]});</span>
<a href="#l49.44"></a><span id="l49.44" class="difflineminus">-  IMAPPump.daemon.createMailbox(&quot;folder2&quot;, {subscribed : true, nonExistent : true});</span>
<a href="#l49.45"></a><span id="l49.45" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;folder1&quot;, {subscribed: true, flags: [&quot;\\Noselect&quot;]});</span>
<a href="#l49.46"></a><span id="l49.46" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;folder1/folder11&quot;, {subscribed: true, flags: [&quot;\\Noinferiors&quot;]});</span>
<a href="#l49.47"></a><span id="l49.47" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;folder2&quot;, {subscribed: true, nonExistent: true});</span>
<a href="#l49.48"></a><span id="l49.48">   IMAPPump.daemon.createMailbox(&quot;folder3&quot;, {});</span>
<a href="#l49.49"></a><span id="l49.49"> </span>
<a href="#l49.50"></a><span id="l49.50">   // select the inbox to force folder discovery, etc.</span>
<a href="#l49.51"></a><span id="l49.51">   IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l49.52"></a><span id="l49.52">   yield false;</span>
<a href="#l49.53"></a><span id="l49.53"> }</span>
<a href="#l49.54"></a><span id="l49.54"> </span>
<a href="#l49.55"></a><span id="l49.55"> // tests that LIST (SUBSCRIBED) returns the proper response</span>
<a href="#l49.56"></a><span id="l49.56" class="difflineminus">-function* testListSubscribed()</span>
<a href="#l49.57"></a><span id="l49.57" class="difflineminus">-{</span>
<a href="#l49.58"></a><span id="l49.58" class="difflineplus">+function* testListSubscribed() {</span>
<a href="#l49.59"></a><span id="l49.59">   // check that we have \Noselect and \Noinferiors flags - these would not have</span>
<a href="#l49.60"></a><span id="l49.60">   // been returned if we had used LSUB instead of LIST(SUBSCRIBED)</span>
<a href="#l49.61"></a><span id="l49.61">   let rootFolder = IMAPPump.incomingServer.rootFolder;</span>
<a href="#l49.62"></a><span id="l49.62">   let folder1 = rootFolder.getChildNamed(&quot;folder1&quot;);</span>
<a href="#l49.63"></a><span id="l49.63">   Assert.ok(folder1.getFlag(Ci.nsMsgFolderFlags.ImapNoselect));</span>
<a href="#l49.64"></a><span id="l49.64">   Assert.ok(!folder1.getFlag(Ci.nsMsgFolderFlags.ImapNoinferiors));</span>
<a href="#l49.65"></a><span id="l49.65"> </span>
<a href="#l49.66"></a><span id="l49.66">   // make sure the above test was not a fluke</span>
<a href="#l49.67"></a><span id="l49.67">   let folder11 = folder1.getChildNamed(&quot;folder11&quot;);</span>
<a href="#l49.68"></a><span id="l49.68">   Assert.ok(!folder11.getFlag(Ci.nsMsgFolderFlags.ImapNoselect));</span>
<a href="#l49.69"></a><span id="l49.69">   Assert.ok(folder11.getFlag(Ci.nsMsgFolderFlags.ImapNoinferiors));</span>
<a href="#l49.70"></a><span id="l49.70"> </span>
<a href="#l49.71"></a><span id="l49.71">   // test that \NonExistent implies \Noselect</span>
<a href="#l49.72"></a><span id="l49.72" class="difflineminus">-  let folder2 = rootFolder.getChildNamed(&quot;folder2&quot;);</span>
<a href="#l49.73"></a><span id="l49.73" class="difflineplus">+  rootFolder.getChildNamed(&quot;folder2&quot;);</span>
<a href="#l49.74"></a><span id="l49.74">   Assert.ok(folder1.getFlag(Ci.nsMsgFolderFlags.ImapNoselect));</span>
<a href="#l49.75"></a><span id="l49.75"> </span>
<a href="#l49.76"></a><span id="l49.76">   // should not get a folder3 since it is not subscribed</span>
<a href="#l49.77"></a><span id="l49.77">   let folder3;</span>
<a href="#l49.78"></a><span id="l49.78">   try {</span>
<a href="#l49.79"></a><span id="l49.79">     folder3 = rootFolder.getChildNamed(&quot;folder3&quot;);</span>
<a href="#l49.80"></a><span id="l49.80">   } catch (ex) {}</span>
<a href="#l49.81"></a><span id="l49.81" class="difflineminus">-  //do_check_false(folder1.getFlag(Ci.nsMsgFolderFlags.Subscribed));</span>
<a href="#l49.82"></a><span id="l49.82" class="difflineplus">+  // do_check_false(folder1.getFlag(Ci.nsMsgFolderFlags.Subscribed));</span>
<a href="#l49.83"></a><span id="l49.83">   Assert.equal(null, folder3);</span>
<a href="#l49.84"></a><span id="l49.84"> </span>
<a href="#l49.85"></a><span id="l49.85">   yield true;</span>
<a href="#l49.86"></a><span id="l49.86"> }</span>
<a href="#l49.87"></a><span id="l49.87"> </span>
<a href="#l49.88"></a><span id="l49.88"> function* testZimbraServerVersions() {</span>
<a href="#l49.89"></a><span id="l49.89">   // older versions of Zimbra can crash if we send LIST (SUBSCRIBED) so we want</span>
<a href="#l49.90"></a><span id="l49.90">   // to make sure that we are checking for versions</span>
<a href="#l49.91"></a><span id="l49.91"> </span>
<a href="#l49.92"></a><span id="l49.92" class="difflineminus">-  let testValues = [ { version : '6.3.1_GA_2790', expectedResult : false },</span>
<a href="#l49.93"></a><span id="l49.93" class="difflineminus">-                     { version : '7.2.2_GA_2790', expectedResult : false },</span>
<a href="#l49.94"></a><span id="l49.94" class="difflineminus">-                     { version : '7.2.3_GA_2790', expectedResult : true },</span>
<a href="#l49.95"></a><span id="l49.95" class="difflineminus">-                     { version : '8.0.2_GA_2790', expectedResult : false },</span>
<a href="#l49.96"></a><span id="l49.96" class="difflineminus">-                     { version : '8.0.3_GA_2790', expectedResult : true },</span>
<a href="#l49.97"></a><span id="l49.97" class="difflineminus">-                     { version : '9.0.0_GA_2790', expectedResult : true } ];</span>
<a href="#l49.98"></a><span id="l49.98" class="difflineplus">+  let testValues = [ { version: &quot;6.3.1_GA_2790&quot;, expectedResult: false },</span>
<a href="#l49.99"></a><span id="l49.99" class="difflineplus">+                     { version: &quot;7.2.2_GA_2790&quot;, expectedResult: false },</span>
<a href="#l49.100"></a><span id="l49.100" class="difflineplus">+                     { version: &quot;7.2.3_GA_2790&quot;, expectedResult: true },</span>
<a href="#l49.101"></a><span id="l49.101" class="difflineplus">+                     { version: &quot;8.0.2_GA_2790&quot;, expectedResult: false },</span>
<a href="#l49.102"></a><span id="l49.102" class="difflineplus">+                     { version: &quot;8.0.3_GA_2790&quot;, expectedResult: true },</span>
<a href="#l49.103"></a><span id="l49.103" class="difflineplus">+                     { version: &quot;9.0.0_GA_2790&quot;, expectedResult: true } ];</span>
<a href="#l49.104"></a><span id="l49.104"> </span>
<a href="#l49.105"></a><span id="l49.105">   for (let i = 0; i &lt; testValues.length; i++) {</span>
<a href="#l49.106"></a><span id="l49.106">     IMAPPump.daemon.idResponse = '(&quot;NAME&quot; &quot;Zimbra&quot; ' +</span>
<a href="#l49.107"></a><span id="l49.107">                              '&quot;VERSION&quot; &quot;' + testValues[i].version + '&quot; ' +</span>
<a href="#l49.108"></a><span id="l49.108">                              '&quot;RELEASE&quot; &quot;20120815212257&quot; ' +</span>
<a href="#l49.109"></a><span id="l49.109">                              '&quot;USER&quot; &quot;user@domain.com&quot; ' +</span>
<a href="#l49.110"></a><span id="l49.110">                              '&quot;SERVER&quot; &quot;14b63305-d002-4f1b-bcd9-23d402d4ef40&quot;)';</span>
<a href="#l49.111"></a><span id="l49.111">     IMAPPump.incomingServer.closeCachedConnections();</span>
<a href="#l49.112"></a><span id="l49.112" class="difflineat">@@ -105,38 +106,16 @@ function* testZimbraServerVersions() {</span>
<a href="#l49.113"></a><span id="l49.113">     let rootFolder = IMAPPump.incomingServer.rootFolder;</span>
<a href="#l49.114"></a><span id="l49.114">     let folder1 = rootFolder.getChildNamed(&quot;folder1&quot;);</span>
<a href="#l49.115"></a><span id="l49.115">     Assert.equal(folder1.getFlag(Ci.nsMsgFolderFlags.ImapNoselect),</span>
<a href="#l49.116"></a><span id="l49.116">                  testValues[i].expectedResult);</span>
<a href="#l49.117"></a><span id="l49.117">   }</span>
<a href="#l49.118"></a><span id="l49.118"> }</span>
<a href="#l49.119"></a><span id="l49.119"> </span>
<a href="#l49.120"></a><span id="l49.120"> // Cleanup at end</span>
<a href="#l49.121"></a><span id="l49.121" class="difflineminus">-function endTest()</span>
<a href="#l49.122"></a><span id="l49.122" class="difflineminus">-{</span>
<a href="#l49.123"></a><span id="l49.123" class="difflineplus">+function endTest() {</span>
<a href="#l49.124"></a><span id="l49.124">   teardownIMAPPump();</span>
<a href="#l49.125"></a><span id="l49.125"> }</span>
<a href="#l49.126"></a><span id="l49.126"> </span>
<a href="#l49.127"></a><span id="l49.127" class="difflineminus">-function run_test()</span>
<a href="#l49.128"></a><span id="l49.128" class="difflineminus">-{</span>
<a href="#l49.129"></a><span id="l49.129" class="difflineplus">+function run_test() {</span>
<a href="#l49.130"></a><span id="l49.130">   Services.prefs.setBoolPref(&quot;mail.server.server1.autosync_offline_stores&quot;, false);</span>
<a href="#l49.131"></a><span id="l49.131">   async_run_tests(tests);</span>
<a href="#l49.132"></a><span id="l49.132"> }</span>
<a href="#l49.133"></a><span id="l49.133" class="difflineminus">-</span>
<a href="#l49.134"></a><span id="l49.134" class="difflineminus">-/*</span>
<a href="#l49.135"></a><span id="l49.135" class="difflineminus">- * helper functions</span>
<a href="#l49.136"></a><span id="l49.136" class="difflineminus">- */</span>
<a href="#l49.137"></a><span id="l49.137" class="difflineminus">-</span>
<a href="#l49.138"></a><span id="l49.138" class="difflineminus">-// given a test file, return the file uri spec</span>
<a href="#l49.139"></a><span id="l49.139" class="difflineminus">-function specForFileName(aFileName)</span>
<a href="#l49.140"></a><span id="l49.140" class="difflineminus">-{</span>
<a href="#l49.141"></a><span id="l49.141" class="difflineminus">-  let file = do_get_file(&quot;../../../data/&quot; + aFileName);</span>
<a href="#l49.142"></a><span id="l49.142" class="difflineminus">-  let msgfileuri = Services.io.newFileURI(file).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l49.143"></a><span id="l49.143" class="difflineminus">-  return msgfileuri.spec;</span>
<a href="#l49.144"></a><span id="l49.144" class="difflineminus">-}</span>
<a href="#l49.145"></a><span id="l49.145" class="difflineminus">-</span>
<a href="#l49.146"></a><span id="l49.146" class="difflineminus">-function recursiveDeleteMailboxes(aMailbox)</span>
<a href="#l49.147"></a><span id="l49.147" class="difflineminus">-{</span>
<a href="#l49.148"></a><span id="l49.148" class="difflineminus">-  for (var child of aMailbox.allChildren) {</span>
<a href="#l49.149"></a><span id="l49.149" class="difflineminus">-    recursiveDeleteMailboxes(child);</span>
<a href="#l49.150"></a><span id="l49.150" class="difflineminus">-  }</span>
<a href="#l49.151"></a><span id="l49.151" class="difflineminus">-  IMAPPump.daemon.deleteMailbox(aMailbox);</span>
<a href="#l49.152"></a><span id="l49.152" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l50.1"></a><span id="l50.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_localToImapFilter.js</span>
<a href="#l50.2"></a><span id="l50.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_localToImapFilter.js</span>
<a href="#l50.3"></a><span id="l50.3" class="difflineat">@@ -2,36 +2,30 @@</span>
<a href="#l50.4"></a><span id="l50.4">  * This file tests copies of multiple messages using filters</span>
<a href="#l50.5"></a><span id="l50.5">  * from incoming POP3, with filter actions copying and moving</span>
<a href="#l50.6"></a><span id="l50.6">  * messages to IMAP folders. This test is adapted from</span>
<a href="#l50.7"></a><span id="l50.7">  * test_imapFolderCopy.js</span>
<a href="#l50.8"></a><span id="l50.8">  *</span>
<a href="#l50.9"></a><span id="l50.9">  * Original author: Kent James &lt;kent@caspia.com&gt;</span>
<a href="#l50.10"></a><span id="l50.10">  */</span>
<a href="#l50.11"></a><span id="l50.11"> </span>
<a href="#l50.12"></a><span id="l50.12" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l50.13"></a><span id="l50.13" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l50.14"></a><span id="l50.14" class="difflineplus">+/* import-globals-from ../../../test/resources/POP3pump.js */</span>
<a href="#l50.15"></a><span id="l50.15"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l50.16"></a><span id="l50.16"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l50.17"></a><span id="l50.17"> load(&quot;../../../resources/POP3pump.js&quot;);</span>
<a href="#l50.18"></a><span id="l50.18"> </span>
<a href="#l50.19"></a><span id="l50.19" class="difflineminus">-var {</span>
<a href="#l50.20"></a><span id="l50.20" class="difflineminus">-  getFolderProperties,</span>
<a href="#l50.21"></a><span id="l50.21" class="difflineminus">-  getSpecialFolderString,</span>
<a href="#l50.22"></a><span id="l50.22" class="difflineminus">-  allAccountsSorted,</span>
<a href="#l50.23"></a><span id="l50.23" class="difflineminus">-  getMostRecentFolders,</span>
<a href="#l50.24"></a><span id="l50.24" class="difflineminus">-  folderNameCompare,</span>
<a href="#l50.25"></a><span id="l50.25" class="difflineminus">-} = ChromeUtils.import(&quot;resource:///modules/folderUtils.jsm&quot;);</span>
<a href="#l50.26"></a><span id="l50.26"> var {fixIterator, toXPCOMArray} = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l50.27"></a><span id="l50.27"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l50.28"></a><span id="l50.28"> </span>
<a href="#l50.29"></a><span id="l50.29" class="difflineminus">-var gIMAPTrashFolder;</span>
<a href="#l50.30"></a><span id="l50.30"> var gEmptyLocal1, gEmptyLocal2;</span>
<a href="#l50.31"></a><span id="l50.31" class="difflineminus">-var gLastKey;</span>
<a href="#l50.32"></a><span id="l50.32"> var gMessages = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l50.33"></a><span id="l50.33"> var gFiles = [&quot;../../../data/bugmail1&quot;,</span>
<a href="#l50.34"></a><span id="l50.34" class="difflineminus">-                &quot;../../../data/draft1&quot;];</span>
<a href="#l50.35"></a><span id="l50.35" class="difflineplus">+              &quot;../../../data/draft1&quot;];</span>
<a href="#l50.36"></a><span id="l50.36"> </span>
<a href="#l50.37"></a><span id="l50.37"> var tests = [</span>
<a href="#l50.38"></a><span id="l50.38">   setup,</span>
<a href="#l50.39"></a><span id="l50.39">   function* copyFolder1() {</span>
<a href="#l50.40"></a><span id="l50.40">     dump(&quot;gEmpty1 &quot; + gEmptyLocal1.URI + &quot;\n&quot;);</span>
<a href="#l50.41"></a><span id="l50.41">     let folders = [];</span>
<a href="#l50.42"></a><span id="l50.42">     folders.push(gEmptyLocal1.QueryInterface(Ci.nsIMsgFolder));</span>
<a href="#l50.43"></a><span id="l50.43">     let array = toXPCOMArray(folders, Ci.nsIMutableArray);</span>
<a href="#l50.44"></a><span id="l50.44" class="difflineat">@@ -89,79 +83,72 @@ var tests = [</span>
<a href="#l50.45"></a><span id="l50.45">     Assert.ok(folder2 !== null);</span>
<a href="#l50.46"></a><span id="l50.46">     // folder 1 and 2 should each now have 2 messages in them.</span>
<a href="#l50.47"></a><span id="l50.47">     Assert.equal(folderCount(folder1), 2);</span>
<a href="#l50.48"></a><span id="l50.48">     Assert.equal(folderCount(folder2), 2);</span>
<a href="#l50.49"></a><span id="l50.49">     // the local inbox folder should now be empty, since the second</span>
<a href="#l50.50"></a><span id="l50.50">     // operation was a move</span>
<a href="#l50.51"></a><span id="l50.51">     Assert.equal(folderCount(localAccountUtils.inboxFolder), 0);</span>
<a href="#l50.52"></a><span id="l50.52">   },</span>
<a href="#l50.53"></a><span id="l50.53" class="difflineminus">-  teardown</span>
<a href="#l50.54"></a><span id="l50.54" class="difflineplus">+  teardown,</span>
<a href="#l50.55"></a><span id="l50.55"> ];</span>
<a href="#l50.56"></a><span id="l50.56"> </span>
<a href="#l50.57"></a><span id="l50.57" class="difflineminus">-function folderCount(folder)</span>
<a href="#l50.58"></a><span id="l50.58" class="difflineminus">-{</span>
<a href="#l50.59"></a><span id="l50.59" class="difflineplus">+function folderCount(folder) {</span>
<a href="#l50.60"></a><span id="l50.60">   let enumerator = folder.msgDatabase.EnumerateMessages();</span>
<a href="#l50.61"></a><span id="l50.61">   let count = 0;</span>
<a href="#l50.62"></a><span id="l50.62" class="difflineplus">+  // eslint-disable-next-line no-unused-vars</span>
<a href="#l50.63"></a><span id="l50.63">   for (let hdr of fixIterator(enumerator, Ci.nsIMsgDBHdr)) {</span>
<a href="#l50.64"></a><span id="l50.64">     count++;</span>
<a href="#l50.65"></a><span id="l50.65">   }</span>
<a href="#l50.66"></a><span id="l50.66">   return count;</span>
<a href="#l50.67"></a><span id="l50.67"> }</span>
<a href="#l50.68"></a><span id="l50.68"> </span>
<a href="#l50.69"></a><span id="l50.69"> function setup() {</span>
<a href="#l50.70"></a><span id="l50.70">   setupIMAPPump();</span>
<a href="#l50.71"></a><span id="l50.71">   gEmptyLocal1 = localAccountUtils.rootFolder.createLocalSubfolder(&quot;empty 1&quot;);</span>
<a href="#l50.72"></a><span id="l50.72">   gEmptyLocal2 = localAccountUtils.rootFolder.createLocalSubfolder(&quot;empty 2&quot;);</span>
<a href="#l50.73"></a><span id="l50.73"> </span>
<a href="#l50.74"></a><span id="l50.74">   // these hacks are required because we've created the inbox before</span>
<a href="#l50.75"></a><span id="l50.75">   // running initial folder discovery, and adding the folder bails</span>
<a href="#l50.76"></a><span id="l50.76">   // out before we set it as verified online, so we bail out, and</span>
<a href="#l50.77"></a><span id="l50.77">   // then remove the INBOX folder since it's not verified.</span>
<a href="#l50.78"></a><span id="l50.78" class="difflineminus">-  IMAPPump.inbox.hierarchyDelimiter = '/';</span>
<a href="#l50.79"></a><span id="l50.79" class="difflineplus">+  IMAPPump.inbox.hierarchyDelimiter = &quot;/&quot;;</span>
<a href="#l50.80"></a><span id="l50.80">   IMAPPump.inbox.verifiedAsOnlineFolder = true;</span>
<a href="#l50.81"></a><span id="l50.81"> }</span>
<a href="#l50.82"></a><span id="l50.82"> </span>
<a href="#l50.83"></a><span id="l50.83"> // nsIMsgCopyServiceListener implementation - runs next test when copy</span>
<a href="#l50.84"></a><span id="l50.84"> // is completed.</span>
<a href="#l50.85"></a><span id="l50.85" class="difflineminus">-var CopyListener =</span>
<a href="#l50.86"></a><span id="l50.86" class="difflineminus">-{</span>
<a href="#l50.87"></a><span id="l50.87" class="difflineminus">-  OnStartCopy: function OnStartCopy() {},</span>
<a href="#l50.88"></a><span id="l50.88" class="difflineminus">-  OnProgress: function OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l50.89"></a><span id="l50.89" class="difflineminus">-  SetMessageKey: function SetMessageKey(aKey)</span>
<a href="#l50.90"></a><span id="l50.90" class="difflineminus">-  {</span>
<a href="#l50.91"></a><span id="l50.91" class="difflineminus">-    gLastKey = aKey;</span>
<a href="#l50.92"></a><span id="l50.92" class="difflineminus">-  },</span>
<a href="#l50.93"></a><span id="l50.93" class="difflineminus">-  SetMessageId: function SetMessageId(aMessageId) {},</span>
<a href="#l50.94"></a><span id="l50.94" class="difflineminus">-  OnStopCopy: function OnStopCopy(aStatus)</span>
<a href="#l50.95"></a><span id="l50.95" class="difflineminus">-  {</span>
<a href="#l50.96"></a><span id="l50.96" class="difflineplus">+var CopyListener = {</span>
<a href="#l50.97"></a><span id="l50.97" class="difflineplus">+  OnStartCopy() {},</span>
<a href="#l50.98"></a><span id="l50.98" class="difflineplus">+  OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l50.99"></a><span id="l50.99" class="difflineplus">+  SetMessageKey(aKey) {},</span>
<a href="#l50.100"></a><span id="l50.100" class="difflineplus">+  SetMessageId(aMessageId) {},</span>
<a href="#l50.101"></a><span id="l50.101" class="difflineplus">+  OnStopCopy(aStatus) {</span>
<a href="#l50.102"></a><span id="l50.102">     // Check: message successfully copied.</span>
<a href="#l50.103"></a><span id="l50.103">     Assert.equal(aStatus, 0);</span>
<a href="#l50.104"></a><span id="l50.104">     async_driver();</span>
<a href="#l50.105"></a><span id="l50.105" class="difflineminus">-  }</span>
<a href="#l50.106"></a><span id="l50.106" class="difflineplus">+  },</span>
<a href="#l50.107"></a><span id="l50.107"> };</span>
<a href="#l50.108"></a><span id="l50.108"> </span>
<a href="#l50.109"></a><span id="l50.109"> asyncUrlListener.callback = function(aUrl, aExitCode) {</span>
<a href="#l50.110"></a><span id="l50.110">   Assert.equal(aExitCode, 0);</span>
<a href="#l50.111"></a><span id="l50.111"> };</span>
<a href="#l50.112"></a><span id="l50.112"> </span>
<a href="#l50.113"></a><span id="l50.113"> function listMessages(folder) {</span>
<a href="#l50.114"></a><span id="l50.114">   let enumerator = folder.msgDatabase.EnumerateMessages();</span>
<a href="#l50.115"></a><span id="l50.115">   var msgCount = 0;</span>
<a href="#l50.116"></a><span id="l50.116">   dump(&quot;listing messages for &quot; + folder.prettyName + &quot;\n&quot;);</span>
<a href="#l50.117"></a><span id="l50.117" class="difflineminus">-  for (let hdr of fixIterator(enumerator, Ci.nsIMsgDBHdr))</span>
<a href="#l50.118"></a><span id="l50.118" class="difflineminus">-  {</span>
<a href="#l50.119"></a><span id="l50.119" class="difflineplus">+  for (let hdr of fixIterator(enumerator, Ci.nsIMsgDBHdr)) {</span>
<a href="#l50.120"></a><span id="l50.120">     msgCount++;</span>
<a href="#l50.121"></a><span id="l50.121">     dump(msgCount + &quot;: &quot; + hdr.subject + &quot;\n&quot;);</span>
<a href="#l50.122"></a><span id="l50.122">   }</span>
<a href="#l50.123"></a><span id="l50.123"> }</span>
<a href="#l50.124"></a><span id="l50.124"> </span>
<a href="#l50.125"></a><span id="l50.125"> function teardown() {</span>
<a href="#l50.126"></a><span id="l50.126">   gMessages.clear();</span>
<a href="#l50.127"></a><span id="l50.127" class="difflineminus">-  gIMAPTrashFolder = null;</span>
<a href="#l50.128"></a><span id="l50.128">   gEmptyLocal1 = null;</span>
<a href="#l50.129"></a><span id="l50.129">   gEmptyLocal2 = null;</span>
<a href="#l50.130"></a><span id="l50.130">   gPOP3Pump = null;</span>
<a href="#l50.131"></a><span id="l50.131">   teardownIMAPPump();</span>
<a href="#l50.132"></a><span id="l50.132"> }</span>
<a href="#l50.133"></a><span id="l50.133"> </span>
<a href="#l50.134"></a><span id="l50.134"> function run_test() {</span>
<a href="#l50.135"></a><span id="l50.135">   async_run_tests(tests);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l51.1"></a><span id="l51.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_localToImapFilterQuarantine.js</span>
<a href="#l51.2"></a><span id="l51.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_localToImapFilterQuarantine.js</span>
<a href="#l51.3"></a><span id="l51.3" class="difflineat">@@ -10,19 +10,22 @@</span>
<a href="#l51.4"></a><span id="l51.4">  *</span>
<a href="#l51.5"></a><span id="l51.5">  */</span>
<a href="#l51.6"></a><span id="l51.6"> </span>
<a href="#l51.7"></a><span id="l51.7"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l51.8"></a><span id="l51.8"> </span>
<a href="#l51.9"></a><span id="l51.9"> Services.prefs.setCharPref(&quot;mail.serverDefaultStoreContractID&quot;,</span>
<a href="#l51.10"></a><span id="l51.10">                            &quot;@mozilla.org/msgstore/berkeleystore;1&quot;);</span>
<a href="#l51.11"></a><span id="l51.11"> </span>
<a href="#l51.12"></a><span id="l51.12" class="difflineplus">+/* import-globals-from ../../../test/resources/POP3pump.js */</span>
<a href="#l51.13"></a><span id="l51.13"> load(&quot;../../../resources/POP3pump.js&quot;);</span>
<a href="#l51.14"></a><span id="l51.14"> </span>
<a href="#l51.15"></a><span id="l51.15"> // async support</span>
<a href="#l51.16"></a><span id="l51.16" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l51.17"></a><span id="l51.17" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l51.18"></a><span id="l51.18"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l51.19"></a><span id="l51.19"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l51.20"></a><span id="l51.20"> </span>
<a href="#l51.21"></a><span id="l51.21"> // IMAP pump</span>
<a href="#l51.22"></a><span id="l51.22"> </span>
<a href="#l51.23"></a><span id="l51.23"> setupIMAPPump();</span>
<a href="#l51.24"></a><span id="l51.24"> </span>
<a href="#l51.25"></a><span id="l51.25"> var gFinishedRunningURL = -1;</span>
<a href="#l51.26"></a><span id="l51.26" class="difflineat">@@ -31,28 +34,27 @@ var gSubfolder;</span>
<a href="#l51.27"></a><span id="l51.27"> // tests</span>
<a href="#l51.28"></a><span id="l51.28"> </span>
<a href="#l51.29"></a><span id="l51.29"> var quarantineTests = [</span>
<a href="#l51.30"></a><span id="l51.30">   createSubfolder,</span>
<a href="#l51.31"></a><span id="l51.31">   getLocalMessages,</span>
<a href="#l51.32"></a><span id="l51.32">   updateSubfolderAndTest,</span>
<a href="#l51.33"></a><span id="l51.33">   get2Messages,</span>
<a href="#l51.34"></a><span id="l51.34">   updateSubfolderAndTest2,</span>
<a href="#l51.35"></a><span id="l51.35" class="difflineminus">-  endTest</span>
<a href="#l51.36"></a><span id="l51.36" class="difflineplus">+  endTest,</span>
<a href="#l51.37"></a><span id="l51.37"> ];</span>
<a href="#l51.38"></a><span id="l51.38"> </span>
<a href="#l51.39"></a><span id="l51.39" class="difflineminus">-function* createSubfolder()</span>
<a href="#l51.40"></a><span id="l51.40" class="difflineminus">-{</span>
<a href="#l51.41"></a><span id="l51.41" class="difflineplus">+function* createSubfolder() {</span>
<a href="#l51.42"></a><span id="l51.42">   IMAPPump.incomingServer.rootFolder.createSubfolder(&quot;subfolder&quot;, null);</span>
<a href="#l51.43"></a><span id="l51.43" class="difflineminus">-  dl('wait for folderAdded notification');</span>
<a href="#l51.44"></a><span id="l51.44" class="difflineplus">+  dl(&quot;wait for folderAdded notification&quot;);</span>
<a href="#l51.45"></a><span id="l51.45">   yield false;</span>
<a href="#l51.46"></a><span id="l51.46">   gSubfolder = IMAPPump.incomingServer.rootFolder.getChildNamed(&quot;subfolder&quot;);</span>
<a href="#l51.47"></a><span id="l51.47">   Assert.ok(gSubfolder instanceof Ci.nsIMsgImapMailFolder);</span>
<a href="#l51.48"></a><span id="l51.48">   gSubfolder.updateFolderWithListener(null, urlListener);</span>
<a href="#l51.49"></a><span id="l51.49" class="difflineminus">-  dl('wait for OnStopRunningURL');</span>
<a href="#l51.50"></a><span id="l51.50" class="difflineplus">+  dl(&quot;wait for OnStopRunningURL&quot;);</span>
<a href="#l51.51"></a><span id="l51.51">   yield false;</span>
<a href="#l51.52"></a><span id="l51.52"> }</span>
<a href="#l51.53"></a><span id="l51.53"> </span>
<a href="#l51.54"></a><span id="l51.54"> function* getLocalMessages() {</span>
<a href="#l51.55"></a><span id="l51.55">   // setup copy then move mail filters on the inbox</span>
<a href="#l51.56"></a><span id="l51.56">   let filterList = gPOP3Pump.fakeServer.getFilterList(null);</span>
<a href="#l51.57"></a><span id="l51.57">   let filter = filterList.createFilter(&quot;copyThenMoveAll&quot;);</span>
<a href="#l51.58"></a><span id="l51.58">   let searchTerm = filter.createTerm();</span>
<a href="#l51.59"></a><span id="l51.59" class="difflineat">@@ -61,174 +63,168 @@ function* getLocalMessages() {</span>
<a href="#l51.60"></a><span id="l51.60">   let copyAction = filter.createAction();</span>
<a href="#l51.61"></a><span id="l51.61">   copyAction.type = Ci.nsMsgFilterAction.CopyToFolder;</span>
<a href="#l51.62"></a><span id="l51.62">   copyAction.targetFolderUri = gSubfolder.URI;</span>
<a href="#l51.63"></a><span id="l51.63">   filter.appendAction(copyAction);</span>
<a href="#l51.64"></a><span id="l51.64">   filter.enabled = true;</span>
<a href="#l51.65"></a><span id="l51.65">   filterList.insertFilterAt(0, filter);</span>
<a href="#l51.66"></a><span id="l51.66"> </span>
<a href="#l51.67"></a><span id="l51.67">   gPOP3Pump.files = [&quot;../../../data/bugmail1&quot;];</span>
<a href="#l51.68"></a><span id="l51.68" class="difflineminus">-  gPOP3Pump.onDone = function() {dump('POP3Pump done\n');async_driver();};</span>
<a href="#l51.69"></a><span id="l51.69" class="difflineplus">+  gPOP3Pump.onDone = function() {</span>
<a href="#l51.70"></a><span id="l51.70" class="difflineplus">+    dump(&quot;POP3Pump done\n&quot;);</span>
<a href="#l51.71"></a><span id="l51.71" class="difflineplus">+    async_driver();</span>
<a href="#l51.72"></a><span id="l51.72" class="difflineplus">+  };</span>
<a href="#l51.73"></a><span id="l51.73">   gPOP3Pump.run();</span>
<a href="#l51.74"></a><span id="l51.74" class="difflineminus">-  dl('waiting for POP3Pump done');</span>
<a href="#l51.75"></a><span id="l51.75" class="difflineplus">+  dl(&quot;waiting for POP3Pump done&quot;);</span>
<a href="#l51.76"></a><span id="l51.76">   yield false;</span>
<a href="#l51.77"></a><span id="l51.77"> }</span>
<a href="#l51.78"></a><span id="l51.78"> </span>
<a href="#l51.79"></a><span id="l51.79"> function checkResult() {</span>
<a href="#l51.80"></a><span id="l51.80">   if (gFinishedRunningURL == 1) {</span>
<a href="#l51.81"></a><span id="l51.81">     async_driver();</span>
<a href="#l51.82"></a><span id="l51.82">     gFinishedRunningURL = -1;</span>
<a href="#l51.83"></a><span id="l51.83" class="difflineminus">-    return;</span>
<a href="#l51.84"></a><span id="l51.84" class="difflineminus">-  }</span>
<a href="#l51.85"></a><span id="l51.85" class="difflineminus">-  else if (gFinishedRunningURL == 0) {</span>
<a href="#l51.86"></a><span id="l51.86" class="difflineplus">+  } else if (gFinishedRunningURL == 0) {</span>
<a href="#l51.87"></a><span id="l51.87">     gSubfolder.updateFolderWithListener(null, urlListener);</span>
<a href="#l51.88"></a><span id="l51.88">     do_timeout(100, checkResult);</span>
<a href="#l51.89"></a><span id="l51.89" class="difflineminus">-    return;</span>
<a href="#l51.90"></a><span id="l51.90">   }</span>
<a href="#l51.91"></a><span id="l51.91">   // Else just ignore it.</span>
<a href="#l51.92"></a><span id="l51.92"> }</span>
<a href="#l51.93"></a><span id="l51.93"> </span>
<a href="#l51.94"></a><span id="l51.94"> function* updateSubfolderAndTest() {</span>
<a href="#l51.95"></a><span id="l51.95">   // The previous function does an append, which may take a bit of time to</span>
<a href="#l51.96"></a><span id="l51.96">   // complete. Unfortunately updateFolderWithListener succeeds successfully</span>
<a href="#l51.97"></a><span id="l51.97">   // if there is a url running, but doesn't tell us that is the case. So we</span>
<a href="#l51.98"></a><span id="l51.98">   // have to run updateFolderWithListener several times to actually find out</span>
<a href="#l51.99"></a><span id="l51.99">   // when we are done.</span>
<a href="#l51.100"></a><span id="l51.100">   gFinishedRunningURL = 0;</span>
<a href="#l51.101"></a><span id="l51.101">   gSubfolder.updateFolderWithListener(null, urlListener);</span>
<a href="#l51.102"></a><span id="l51.102" class="difflineminus">-  dl('wait for OnStopRunningURL');</span>
<a href="#l51.103"></a><span id="l51.103" class="difflineplus">+  dl(&quot;wait for OnStopRunningURL&quot;);</span>
<a href="#l51.104"></a><span id="l51.104">   do_timeout(100, checkResult);</span>
<a href="#l51.105"></a><span id="l51.105">   yield false;</span>
<a href="#l51.106"></a><span id="l51.106"> </span>
<a href="#l51.107"></a><span id="l51.107">   // kill some time</span>
<a href="#l51.108"></a><span id="l51.108">   do_timeout(200, async_driver);</span>
<a href="#l51.109"></a><span id="l51.109">   yield false;</span>
<a href="#l51.110"></a><span id="l51.110"> </span>
<a href="#l51.111"></a><span id="l51.111">   // test</span>
<a href="#l51.112"></a><span id="l51.112">   listMessages(gSubfolder);</span>
<a href="#l51.113"></a><span id="l51.113">   listMessages(localAccountUtils.inboxFolder);</span>
<a href="#l51.114"></a><span id="l51.114">   Assert.equal(folderCount(gSubfolder), 1);</span>
<a href="#l51.115"></a><span id="l51.115">   Assert.equal(folderCount(localAccountUtils.inboxFolder), 1);</span>
<a href="#l51.116"></a><span id="l51.116"> }</span>
<a href="#l51.117"></a><span id="l51.117"> </span>
<a href="#l51.118"></a><span id="l51.118" class="difflineminus">-function* get2Messages()</span>
<a href="#l51.119"></a><span id="l51.119" class="difflineminus">-{</span>
<a href="#l51.120"></a><span id="l51.120" class="difflineplus">+function* get2Messages() {</span>
<a href="#l51.121"></a><span id="l51.121">   gPOP3Pump.files = [&quot;../../../data/bugmail10&quot;,</span>
<a href="#l51.122"></a><span id="l51.122">                      &quot;../../../data/draft1&quot;];</span>
<a href="#l51.123"></a><span id="l51.123" class="difflineminus">-  gPOP3Pump.onDone = function() {dump('POP3Pump done\n');async_driver();};</span>
<a href="#l51.124"></a><span id="l51.124" class="difflineplus">+  gPOP3Pump.onDone = function() {</span>
<a href="#l51.125"></a><span id="l51.125" class="difflineplus">+    dump(&quot;POP3Pump done\n&quot;);</span>
<a href="#l51.126"></a><span id="l51.126" class="difflineplus">+    async_driver();</span>
<a href="#l51.127"></a><span id="l51.127" class="difflineplus">+  };</span>
<a href="#l51.128"></a><span id="l51.128">   gPOP3Pump.run();</span>
<a href="#l51.129"></a><span id="l51.129" class="difflineminus">-  dl('waiting for POP3Pump done');</span>
<a href="#l51.130"></a><span id="l51.130" class="difflineplus">+  dl(&quot;waiting for POP3Pump done&quot;);</span>
<a href="#l51.131"></a><span id="l51.131">   yield false;</span>
<a href="#l51.132"></a><span id="l51.132"> }</span>
<a href="#l51.133"></a><span id="l51.133"> </span>
<a href="#l51.134"></a><span id="l51.134"> function* updateSubfolderAndTest2() {</span>
<a href="#l51.135"></a><span id="l51.135">   // The previous function does an append, which may take a bit of time to</span>
<a href="#l51.136"></a><span id="l51.136">   // complete. Unfortunately updateFolderWithListener succeeds successfully</span>
<a href="#l51.137"></a><span id="l51.137">   // if there is a url running, but doesn't tell us that is the case. So we</span>
<a href="#l51.138"></a><span id="l51.138">   // have to run updateFolderWithListener several times to actually find out</span>
<a href="#l51.139"></a><span id="l51.139">   // when we are done.</span>
<a href="#l51.140"></a><span id="l51.140">   gFinishedRunningURL = 0;</span>
<a href="#l51.141"></a><span id="l51.141">   gSubfolder.updateFolderWithListener(null, urlListener);</span>
<a href="#l51.142"></a><span id="l51.142" class="difflineminus">-  dl('wait for OnStopRunningURL');</span>
<a href="#l51.143"></a><span id="l51.143" class="difflineplus">+  dl(&quot;wait for OnStopRunningURL&quot;);</span>
<a href="#l51.144"></a><span id="l51.144">   do_timeout(1000, checkResult);</span>
<a href="#l51.145"></a><span id="l51.145">   yield false;</span>
<a href="#l51.146"></a><span id="l51.146"> </span>
<a href="#l51.147"></a><span id="l51.147">   // kill some time</span>
<a href="#l51.148"></a><span id="l51.148">   do_timeout(1000, async_driver);</span>
<a href="#l51.149"></a><span id="l51.149">   yield false;</span>
<a href="#l51.150"></a><span id="l51.150"> </span>
<a href="#l51.151"></a><span id="l51.151" class="difflineminus">-  //test</span>
<a href="#l51.152"></a><span id="l51.152" class="difflineplus">+  // test</span>
<a href="#l51.153"></a><span id="l51.153">   listMessages(gSubfolder);</span>
<a href="#l51.154"></a><span id="l51.154">   listMessages(localAccountUtils.inboxFolder);</span>
<a href="#l51.155"></a><span id="l51.155">   Assert.equal(folderCount(gSubfolder), 3);</span>
<a href="#l51.156"></a><span id="l51.156">   Assert.equal(folderCount(localAccountUtils.inboxFolder), 3);</span>
<a href="#l51.157"></a><span id="l51.157"> }</span>
<a href="#l51.158"></a><span id="l51.158"> </span>
<a href="#l51.159"></a><span id="l51.159" class="difflineminus">-function endTest()</span>
<a href="#l51.160"></a><span id="l51.160" class="difflineminus">-{</span>
<a href="#l51.161"></a><span id="l51.161" class="difflineplus">+function endTest() {</span>
<a href="#l51.162"></a><span id="l51.162">   // Cleanup, null out everything, close all cached connections and stop the</span>
<a href="#l51.163"></a><span id="l51.163">   // server</span>
<a href="#l51.164"></a><span id="l51.164">   dl(&quot;Exiting mail tests&quot;);</span>
<a href="#l51.165"></a><span id="l51.165">   gPOP3Pump = null;</span>
<a href="#l51.166"></a><span id="l51.166">   teardownIMAPPump();</span>
<a href="#l51.167"></a><span id="l51.167"> }</span>
<a href="#l51.168"></a><span id="l51.168"> </span>
<a href="#l51.169"></a><span id="l51.169"> // listeners</span>
<a href="#l51.170"></a><span id="l51.170"> </span>
<a href="#l51.171"></a><span id="l51.171" class="difflineminus">-var mfnListener =</span>
<a href="#l51.172"></a><span id="l51.172" class="difflineminus">-{</span>
<a href="#l51.173"></a><span id="l51.173" class="difflineminus">-  folderAdded: function folderAdded(aFolder)</span>
<a href="#l51.174"></a><span id="l51.174" class="difflineminus">-  {</span>
<a href="#l51.175"></a><span id="l51.175" class="difflineminus">-    dl('folderAdded &lt;' + aFolder.name + '&gt;');</span>
<a href="#l51.176"></a><span id="l51.176" class="difflineplus">+var mfnListener = {</span>
<a href="#l51.177"></a><span id="l51.177" class="difflineplus">+  folderAdded(aFolder) {</span>
<a href="#l51.178"></a><span id="l51.178" class="difflineplus">+    dl(&quot;folderAdded &lt;&quot; + aFolder.name + &quot;&gt;&quot;);</span>
<a href="#l51.179"></a><span id="l51.179">     // we are only using async yield on the Subfolder add</span>
<a href="#l51.180"></a><span id="l51.180">     if (aFolder.name == &quot;subfolder&quot;)</span>
<a href="#l51.181"></a><span id="l51.181">       async_driver();</span>
<a href="#l51.182"></a><span id="l51.182">   },</span>
<a href="#l51.183"></a><span id="l51.183"> </span>
<a href="#l51.184"></a><span id="l51.184" class="difflineminus">-  msgAdded: function msgAdded(aMsg)</span>
<a href="#l51.185"></a><span id="l51.185" class="difflineminus">-  {</span>
<a href="#l51.186"></a><span id="l51.186" class="difflineminus">-    dl('msgAdded to folder &lt;' + aMsg.folder.name + '&gt; subject &lt;' + aMsg.subject + '&gt;');</span>
<a href="#l51.187"></a><span id="l51.187" class="difflineplus">+  msgAdded(aMsg) {</span>
<a href="#l51.188"></a><span id="l51.188" class="difflineplus">+    dl(&quot;msgAdded to folder &lt;&quot; + aMsg.folder.name + &quot;&gt; subject &lt;&quot; + aMsg.subject + &quot;&gt;&quot;);</span>
<a href="#l51.189"></a><span id="l51.189">   },</span>
<a href="#l51.190"></a><span id="l51.190"> </span>
<a href="#l51.191"></a><span id="l51.191"> };</span>
<a href="#l51.192"></a><span id="l51.192"> </span>
<a href="#l51.193"></a><span id="l51.193"> var urlListener = {</span>
<a href="#l51.194"></a><span id="l51.194" class="difflineminus">-  OnStartRunningUrl: function _OnStartRunningUrl(aUrl) {</span>
<a href="#l51.195"></a><span id="l51.195" class="difflineminus">-    dl('OnStartRunningUrl');</span>
<a href="#l51.196"></a><span id="l51.196" class="difflineplus">+  OnStartRunningUrl(aUrl) {</span>
<a href="#l51.197"></a><span id="l51.197" class="difflineplus">+    dl(&quot;OnStartRunningUrl&quot;);</span>
<a href="#l51.198"></a><span id="l51.198">   },</span>
<a href="#l51.199"></a><span id="l51.199" class="difflineminus">-  OnStopRunningUrl: function _OnStopRunningUrl(aUrl, aExitCode) {</span>
<a href="#l51.200"></a><span id="l51.200" class="difflineminus">-    dl('OnStopRunningUrl');</span>
<a href="#l51.201"></a><span id="l51.201" class="difflineplus">+  OnStopRunningUrl(aUrl, aExitCode) {</span>
<a href="#l51.202"></a><span id="l51.202" class="difflineplus">+    dl(&quot;OnStopRunningUrl&quot;);</span>
<a href="#l51.203"></a><span id="l51.203">     gFinishedRunningURL = 1;</span>
<a href="#l51.204"></a><span id="l51.204">     checkResult();</span>
<a href="#l51.205"></a><span id="l51.205" class="difflineminus">-  }</span>
<a href="#l51.206"></a><span id="l51.206" class="difflineplus">+  },</span>
<a href="#l51.207"></a><span id="l51.207"> };</span>
<a href="#l51.208"></a><span id="l51.208"> </span>
<a href="#l51.209"></a><span id="l51.209"> // main test startup</span>
<a href="#l51.210"></a><span id="l51.210"> </span>
<a href="#l51.211"></a><span id="l51.211" class="difflineminus">-function run_test()</span>
<a href="#l51.212"></a><span id="l51.212" class="difflineminus">-{</span>
<a href="#l51.213"></a><span id="l51.213" class="difflineplus">+function run_test() {</span>
<a href="#l51.214"></a><span id="l51.214">   // quarantine messages</span>
<a href="#l51.215"></a><span id="l51.215">   Services.prefs.setBoolPref(&quot;mailnews.downloadToTempFile&quot;, true);</span>
<a href="#l51.216"></a><span id="l51.216"> </span>
<a href="#l51.217"></a><span id="l51.217">   // Add folder listeners that will capture async events</span>
<a href="#l51.218"></a><span id="l51.218">   const nsIMFNService = Ci.nsIMsgFolderNotificationService;</span>
<a href="#l51.219"></a><span id="l51.219">   let flags =</span>
<a href="#l51.220"></a><span id="l51.220">         nsIMFNService.folderAdded |</span>
<a href="#l51.221"></a><span id="l51.221">         nsIMFNService.msgAdded;</span>
<a href="#l51.222"></a><span id="l51.222">   MailServices.mfn.addListener(mfnListener, flags);</span>
<a href="#l51.223"></a><span id="l51.223"> </span>
<a href="#l51.224"></a><span id="l51.224" class="difflineminus">-  //start first test</span>
<a href="#l51.225"></a><span id="l51.225" class="difflineplus">+  // start first test</span>
<a href="#l51.226"></a><span id="l51.226">   async_run_tests(quarantineTests);</span>
<a href="#l51.227"></a><span id="l51.227"> }</span>
<a href="#l51.228"></a><span id="l51.228"> </span>
<a href="#l51.229"></a><span id="l51.229"> // helper functions</span>
<a href="#l51.230"></a><span id="l51.230"> </span>
<a href="#l51.231"></a><span id="l51.231"> // count of messages in a folder, using the database</span>
<a href="#l51.232"></a><span id="l51.232" class="difflineminus">-function folderCount(folder)</span>
<a href="#l51.233"></a><span id="l51.233" class="difflineminus">-{</span>
<a href="#l51.234"></a><span id="l51.234" class="difflineplus">+function folderCount(folder) {</span>
<a href="#l51.235"></a><span id="l51.235">   let enumerator = folder.msgDatabase.EnumerateMessages();</span>
<a href="#l51.236"></a><span id="l51.236">   let count = 0;</span>
<a href="#l51.237"></a><span id="l51.237" class="difflineminus">-  while (enumerator.hasMoreElements())</span>
<a href="#l51.238"></a><span id="l51.238" class="difflineminus">-  {</span>
<a href="#l51.239"></a><span id="l51.239" class="difflineplus">+  while (enumerator.hasMoreElements()) {</span>
<a href="#l51.240"></a><span id="l51.240">     count++;</span>
<a href="#l51.241"></a><span id="l51.241" class="difflineminus">-    let hdr = enumerator.getNext();</span>
<a href="#l51.242"></a><span id="l51.242" class="difflineplus">+    enumerator.getNext();</span>
<a href="#l51.243"></a><span id="l51.243">   }</span>
<a href="#l51.244"></a><span id="l51.244">   return count;</span>
<a href="#l51.245"></a><span id="l51.245"> }</span>
<a href="#l51.246"></a><span id="l51.246"> </span>
<a href="#l51.247"></a><span id="l51.247"> // display of message subjects in a folder</span>
<a href="#l51.248"></a><span id="l51.248"> function listMessages(folder) {</span>
<a href="#l51.249"></a><span id="l51.249">   let enumerator = folder.msgDatabase.EnumerateMessages();</span>
<a href="#l51.250"></a><span id="l51.250">   var msgCount = 0;</span>
<a href="#l51.251"></a><span id="l51.251">   dl(&quot;listing messages for &quot; + folder.prettyName);</span>
<a href="#l51.252"></a><span id="l51.252" class="difflineminus">-  while(enumerator.hasMoreElements())</span>
<a href="#l51.253"></a><span id="l51.253" class="difflineminus">-  {</span>
<a href="#l51.254"></a><span id="l51.254" class="difflineplus">+  while (enumerator.hasMoreElements()) {</span>
<a href="#l51.255"></a><span id="l51.255">     msgCount++;</span>
<a href="#l51.256"></a><span id="l51.256">     let hdr = enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l51.257"></a><span id="l51.257">     dl(msgCount + &quot;: &quot; + hdr.subject);</span>
<a href="#l51.258"></a><span id="l51.258">   }</span>
<a href="#l51.259"></a><span id="l51.259"> }</span>
<a href="#l51.260"></a><span id="l51.260"> </span>
<a href="#l51.261"></a><span id="l51.261"> // shorthand output of a line of text</span>
<a href="#l51.262"></a><span id="l51.262"> function dl(text) {</span>
<a href="#l51.263"></a><span id="l51.263" class="difflineminus">-  dump(text + '\n');</span>
<a href="#l51.264"></a><span id="l51.264" class="difflineplus">+  dump(text + &quot;\n&quot;);</span>
<a href="#l51.265"></a><span id="l51.265"> }</span>
<a href="#l51.266"></a><span id="l51.266"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l52.1"></a><span id="l52.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_lsub.js</span>
<a href="#l52.2"></a><span id="l52.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_lsub.js</span>
<a href="#l52.3"></a><span id="l52.3" class="difflineat">@@ -3,16 +3,19 @@</span>
<a href="#l52.4"></a><span id="l52.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l52.5"></a><span id="l52.5"> </span>
<a href="#l52.6"></a><span id="l52.6"> // Test that listing subscribed mailboxes uses LIST (SUBSCRIBED) instead of LSUB</span>
<a href="#l52.7"></a><span id="l52.7"> // for servers that have LIST-EXTENDED capability</span>
<a href="#l52.8"></a><span id="l52.8"> // see: bug 495318</span>
<a href="#l52.9"></a><span id="l52.9"> // see: RFC 5258 - http://tools.ietf.org/html/rfc5258</span>
<a href="#l52.10"></a><span id="l52.10"> </span>
<a href="#l52.11"></a><span id="l52.11"> // async support</span>
<a href="#l52.12"></a><span id="l52.12" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l52.13"></a><span id="l52.13" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l52.14"></a><span id="l52.14" class="difflineplus">+/* import-globals-from ../../../test/resources/alertTestUtils.js */</span>
<a href="#l52.15"></a><span id="l52.15"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l52.16"></a><span id="l52.16"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l52.17"></a><span id="l52.17"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l52.18"></a><span id="l52.18"> </span>
<a href="#l52.19"></a><span id="l52.19"> // IMAP pump</span>
<a href="#l52.20"></a><span id="l52.20"> </span>
<a href="#l52.21"></a><span id="l52.21"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l52.22"></a><span id="l52.22"> </span>
<a href="#l52.23"></a><span id="l52.23" class="difflineat">@@ -20,86 +23,62 @@ var {Services} = ChromeUtils.import(&quot;res</span>
<a href="#l52.24"></a><span id="l52.24"> </span>
<a href="#l52.25"></a><span id="l52.25"> </span>
<a href="#l52.26"></a><span id="l52.26"> setupIMAPPump();</span>
<a href="#l52.27"></a><span id="l52.27"> </span>
<a href="#l52.28"></a><span id="l52.28"> // Definition of tests</span>
<a href="#l52.29"></a><span id="l52.29"> var tests = [</span>
<a href="#l52.30"></a><span id="l52.30">   setupMailboxes,</span>
<a href="#l52.31"></a><span id="l52.31">   testLsub,</span>
<a href="#l52.32"></a><span id="l52.32" class="difflineminus">-  endTest</span>
<a href="#l52.33"></a><span id="l52.33" class="difflineminus">-]</span>
<a href="#l52.34"></a><span id="l52.34" class="difflineplus">+  endTest,</span>
<a href="#l52.35"></a><span id="l52.35" class="difflineplus">+];</span>
<a href="#l52.36"></a><span id="l52.36"> </span>
<a href="#l52.37"></a><span id="l52.37"> // setup the mailboxes that will be used for this test</span>
<a href="#l52.38"></a><span id="l52.38" class="difflineminus">-function* setupMailboxes()</span>
<a href="#l52.39"></a><span id="l52.39" class="difflineminus">-{</span>
<a href="#l52.40"></a><span id="l52.40" class="difflineplus">+function* setupMailboxes() {</span>
<a href="#l52.41"></a><span id="l52.41">   IMAPPump.mailbox.subscribed = true;</span>
<a href="#l52.42"></a><span id="l52.42" class="difflineminus">-  IMAPPump.daemon.createMailbox(&quot;folder1&quot;, {subscribed : true, flags : [&quot;\\Noselect&quot;]});</span>
<a href="#l52.43"></a><span id="l52.43" class="difflineminus">-  IMAPPump.daemon.createMailbox(&quot;folder1/folder11&quot;, {subscribed : true, flags : [&quot;\\Noinferiors&quot;]});</span>
<a href="#l52.44"></a><span id="l52.44" class="difflineminus">-  IMAPPump.daemon.createMailbox(&quot;folder2&quot;, {subscribed : true, nonExistent : true});</span>
<a href="#l52.45"></a><span id="l52.45" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;folder1&quot;, {subscribed: true, flags: [&quot;\\Noselect&quot;]});</span>
<a href="#l52.46"></a><span id="l52.46" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;folder1/folder11&quot;, {subscribed: true, flags: [&quot;\\Noinferiors&quot;]});</span>
<a href="#l52.47"></a><span id="l52.47" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;folder2&quot;, {subscribed: true, nonExistent: true});</span>
<a href="#l52.48"></a><span id="l52.48">   IMAPPump.daemon.createMailbox(&quot;folder3&quot;, {});</span>
<a href="#l52.49"></a><span id="l52.49"> </span>
<a href="#l52.50"></a><span id="l52.50">   // select the inbox to force folder discovery, etc.</span>
<a href="#l52.51"></a><span id="l52.51">   IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l52.52"></a><span id="l52.52">   yield false;</span>
<a href="#l52.53"></a><span id="l52.53"> }</span>
<a href="#l52.54"></a><span id="l52.54"> </span>
<a href="#l52.55"></a><span id="l52.55"> // tests that LSUB returns the proper response</span>
<a href="#l52.56"></a><span id="l52.56" class="difflineminus">-function* testLsub()</span>
<a href="#l52.57"></a><span id="l52.57" class="difflineminus">-{</span>
<a href="#l52.58"></a><span id="l52.58" class="difflineplus">+function* testLsub() {</span>
<a href="#l52.59"></a><span id="l52.59">   // check that we have \Noselect and \Noinferiors flags - these would not have</span>
<a href="#l52.60"></a><span id="l52.60">   // been returned if we had used LSUB instead of LIST(SUBSCRIBED)</span>
<a href="#l52.61"></a><span id="l52.61">   let rootFolder = IMAPPump.incomingServer.rootFolder;</span>
<a href="#l52.62"></a><span id="l52.62">   let folder1 = rootFolder.getChildNamed(&quot;folder1&quot;);</span>
<a href="#l52.63"></a><span id="l52.63">   Assert.ok(folder1.getFlag(Ci.nsMsgFolderFlags.ImapNoselect));</span>
<a href="#l52.64"></a><span id="l52.64">   Assert.ok(!folder1.getFlag(Ci.nsMsgFolderFlags.ImapNoinferiors));</span>
<a href="#l52.65"></a><span id="l52.65"> </span>
<a href="#l52.66"></a><span id="l52.66">   // make sure the above test was not a fluke</span>
<a href="#l52.67"></a><span id="l52.67">   let folder11 = folder1.getChildNamed(&quot;folder11&quot;);</span>
<a href="#l52.68"></a><span id="l52.68">   Assert.ok(!folder11.getFlag(Ci.nsMsgFolderFlags.ImapNoselect));</span>
<a href="#l52.69"></a><span id="l52.69">   Assert.ok(folder11.getFlag(Ci.nsMsgFolderFlags.ImapNoinferiors));</span>
<a href="#l52.70"></a><span id="l52.70"> </span>
<a href="#l52.71"></a><span id="l52.71">   // test that \NonExistent implies \Noselect</span>
<a href="#l52.72"></a><span id="l52.72" class="difflineminus">-  let folder2 = rootFolder.getChildNamed(&quot;folder2&quot;);</span>
<a href="#l52.73"></a><span id="l52.73" class="difflineplus">+  rootFolder.getChildNamed(&quot;folder2&quot;);</span>
<a href="#l52.74"></a><span id="l52.74">   Assert.ok(folder1.getFlag(Ci.nsMsgFolderFlags.ImapNoselect));</span>
<a href="#l52.75"></a><span id="l52.75"> </span>
<a href="#l52.76"></a><span id="l52.76">   // should not get a folder3 since it is not subscribed</span>
<a href="#l52.77"></a><span id="l52.77">   let folder3;</span>
<a href="#l52.78"></a><span id="l52.78">   try {</span>
<a href="#l52.79"></a><span id="l52.79">     folder3 = rootFolder.getChildNamed(&quot;folder3&quot;);</span>
<a href="#l52.80"></a><span id="l52.80">   } catch (ex) {}</span>
<a href="#l52.81"></a><span id="l52.81" class="difflineminus">-  //do_check_false(folder1.getFlag(Ci.nsMsgFolderFlags.Subscribed));</span>
<a href="#l52.82"></a><span id="l52.82" class="difflineplus">+  // do_check_false(folder1.getFlag(Ci.nsMsgFolderFlags.Subscribed));</span>
<a href="#l52.83"></a><span id="l52.83">   Assert.equal(null, folder3);</span>
<a href="#l52.84"></a><span id="l52.84"> </span>
<a href="#l52.85"></a><span id="l52.85">   yield true;</span>
<a href="#l52.86"></a><span id="l52.86"> }</span>
<a href="#l52.87"></a><span id="l52.87"> </span>
<a href="#l52.88"></a><span id="l52.88"> // Cleanup at end</span>
<a href="#l52.89"></a><span id="l52.89" class="difflineminus">-function endTest()</span>
<a href="#l52.90"></a><span id="l52.90" class="difflineminus">-{</span>
<a href="#l52.91"></a><span id="l52.91" class="difflineplus">+function endTest() {</span>
<a href="#l52.92"></a><span id="l52.92">   teardownIMAPPump();</span>
<a href="#l52.93"></a><span id="l52.93"> }</span>
<a href="#l52.94"></a><span id="l52.94"> </span>
<a href="#l52.95"></a><span id="l52.95" class="difflineminus">-function run_test()</span>
<a href="#l52.96"></a><span id="l52.96" class="difflineminus">-{</span>
<a href="#l52.97"></a><span id="l52.97" class="difflineplus">+function run_test() {</span>
<a href="#l52.98"></a><span id="l52.98">   Services.prefs.setBoolPref(&quot;mail.server.server1.autosync_offline_stores&quot;, false);</span>
<a href="#l52.99"></a><span id="l52.99">   async_run_tests(tests);</span>
<a href="#l52.100"></a><span id="l52.100"> }</span>
<a href="#l52.101"></a><span id="l52.101" class="difflineminus">-</span>
<a href="#l52.102"></a><span id="l52.102" class="difflineminus">-/*</span>
<a href="#l52.103"></a><span id="l52.103" class="difflineminus">- * helper functions</span>
<a href="#l52.104"></a><span id="l52.104" class="difflineminus">- */</span>
<a href="#l52.105"></a><span id="l52.105" class="difflineminus">-</span>
<a href="#l52.106"></a><span id="l52.106" class="difflineminus">-// given a test file, return the file uri spec</span>
<a href="#l52.107"></a><span id="l52.107" class="difflineminus">-function specForFileName(aFileName)</span>
<a href="#l52.108"></a><span id="l52.108" class="difflineminus">-{</span>
<a href="#l52.109"></a><span id="l52.109" class="difflineminus">-  let file = do_get_file(&quot;../../../data/&quot; + aFileName);</span>
<a href="#l52.110"></a><span id="l52.110" class="difflineminus">-  let msgfileuri = Services.io.newFileURI(file).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l52.111"></a><span id="l52.111" class="difflineminus">-  return msgfileuri.spec;</span>
<a href="#l52.112"></a><span id="l52.112" class="difflineminus">-}</span>
<a href="#l52.113"></a><span id="l52.113" class="difflineminus">-</span>
<a href="#l52.114"></a><span id="l52.114" class="difflineminus">-function recursiveDeleteMailboxes(aMailbox)</span>
<a href="#l52.115"></a><span id="l52.115" class="difflineminus">-{</span>
<a href="#l52.116"></a><span id="l52.116" class="difflineminus">-  for (var child of aMailbox.allChildren) {</span>
<a href="#l52.117"></a><span id="l52.117" class="difflineminus">-    recursiveDeleteMailboxes(child);</span>
<a href="#l52.118"></a><span id="l52.118" class="difflineminus">-  }</span>
<a href="#l52.119"></a><span id="l52.119" class="difflineminus">-  IMAPPump.daemon.deleteMailbox(aMailbox);</span>
<a href="#l52.120"></a><span id="l52.120" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l53.1"></a><span id="l53.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_mailboxes.js</span>
<a href="#l53.2"></a><span id="l53.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_mailboxes.js</span>
<a href="#l53.3"></a><span id="l53.3" class="difflineat">@@ -1,28 +1,31 @@</span>
<a href="#l53.4"></a><span id="l53.4"> /**</span>
<a href="#l53.5"></a><span id="l53.5">  * Tests basic mailbox handling of IMAP, like discovery, rename and empty folder.</span>
<a href="#l53.6"></a><span id="l53.6">  */</span>
<a href="#l53.7"></a><span id="l53.7"> </span>
<a href="#l53.8"></a><span id="l53.8" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l53.9"></a><span id="l53.9" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l53.10"></a><span id="l53.10" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l53.11"></a><span id="l53.11"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l53.12"></a><span id="l53.12"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l53.13"></a><span id="l53.13"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l53.14"></a><span id="l53.14"> </span>
<a href="#l53.15"></a><span id="l53.15"> // The following folder names are not pure ASCII and will be MUTF-7 encoded.</span>
<a href="#l53.16"></a><span id="l53.16"> const folderName1 = &quot;I18N box\u00E1&quot;; // I18N boxá</span>
<a href="#l53.17"></a><span id="l53.17"> const folderName2 = &quot;test \u00E4&quot;;    // test ä</span>
<a href="#l53.18"></a><span id="l53.18"> </span>
<a href="#l53.19"></a><span id="l53.19"> function* setup() {</span>
<a href="#l53.20"></a><span id="l53.20">   setupIMAPPump();</span>
<a href="#l53.21"></a><span id="l53.21"> </span>
<a href="#l53.22"></a><span id="l53.22" class="difflineminus">-  IMAPPump.daemon.createMailbox(folderName1, {subscribed : true});</span>
<a href="#l53.23"></a><span id="l53.23" class="difflineplus">+  IMAPPump.daemon.createMailbox(folderName1, {subscribed: true});</span>
<a href="#l53.24"></a><span id="l53.24">   IMAPPump.daemon.createMailbox(&quot;Unsubscribed box&quot;);</span>
<a href="#l53.25"></a><span id="l53.25">   // Create an all upper case trash folder name to make sure</span>
<a href="#l53.26"></a><span id="l53.26">   // we handle special folder names case-insensitively.</span>
<a href="#l53.27"></a><span id="l53.27" class="difflineminus">-  IMAPPump.daemon.createMailbox(&quot;TRASH&quot;, {subscribed : true});</span>
<a href="#l53.28"></a><span id="l53.28" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;TRASH&quot;, {subscribed: true});</span>
<a href="#l53.29"></a><span id="l53.29"> </span>
<a href="#l53.30"></a><span id="l53.30">   // Get the server list...</span>
<a href="#l53.31"></a><span id="l53.31">   IMAPPump.server.performTest(&quot;LIST&quot;);</span>
<a href="#l53.32"></a><span id="l53.32"> </span>
<a href="#l53.33"></a><span id="l53.33">   IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l53.34"></a><span id="l53.34">   yield false;</span>
<a href="#l53.35"></a><span id="l53.35"> }</span>
<a href="#l53.36"></a><span id="l53.36"> </span>
<a href="#l53.37"></a><span id="l53.37" class="difflineat">@@ -57,23 +60,22 @@ var tests = [</span>
<a href="#l53.38"></a><span id="l53.38">     let newChild = rootFolder.getChildNamed(folderName2).</span>
<a href="#l53.39"></a><span id="l53.39">                    QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l53.40"></a><span id="l53.40">     newChild.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l53.41"></a><span id="l53.41">     yield false;</span>
<a href="#l53.42"></a><span id="l53.42">   },</span>
<a href="#l53.43"></a><span id="l53.43">   function checkEmptyFolder() {</span>
<a href="#l53.44"></a><span id="l53.44">     try {</span>
<a href="#l53.45"></a><span id="l53.45">     let serverSink = IMAPPump.server.QueryInterface(Ci.nsIImapServerSink);</span>
<a href="#l53.46"></a><span id="l53.46" class="difflineminus">-      serverSink.possibleImapMailbox(&quot;/&quot;, '/', 0);</span>
<a href="#l53.47"></a><span id="l53.47" class="difflineminus">-    }</span>
<a href="#l53.48"></a><span id="l53.48" class="difflineminus">-    catch (ex) {</span>
<a href="#l53.49"></a><span id="l53.49" class="difflineplus">+      serverSink.possibleImapMailbox(&quot;/&quot;, &quot;/&quot;, 0);</span>
<a href="#l53.50"></a><span id="l53.50" class="difflineplus">+    } catch (ex) {</span>
<a href="#l53.51"></a><span id="l53.51">       // we expect this to fail, but not crash or assert.</span>
<a href="#l53.52"></a><span id="l53.52">     }</span>
<a href="#l53.53"></a><span id="l53.53">   },</span>
<a href="#l53.54"></a><span id="l53.54" class="difflineminus">-  teardown</span>
<a href="#l53.55"></a><span id="l53.55" class="difflineplus">+  teardown,</span>
<a href="#l53.56"></a><span id="l53.56"> ];</span>
<a href="#l53.57"></a><span id="l53.57"> </span>
<a href="#l53.58"></a><span id="l53.58"> function teardown() {</span>
<a href="#l53.59"></a><span id="l53.59">   teardownIMAPPump();</span>
<a href="#l53.60"></a><span id="l53.60"> }</span>
<a href="#l53.61"></a><span id="l53.61"> </span>
<a href="#l53.62"></a><span id="l53.62"> function run_test() {</span>
<a href="#l53.63"></a><span id="l53.63">   async_run_tests(tests);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l54.1"></a><span id="l54.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js</span>
<a href="#l54.2"></a><span id="l54.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js</span>
<a href="#l54.3"></a><span id="l54.3" class="difflineat">@@ -10,23 +10,24 @@</span>
<a href="#l54.4"></a><span id="l54.4"> * Test suite for nsIMsgFolderListener events due to IMAP operations</span>
<a href="#l54.5"></a><span id="l54.5"> *</span>
<a href="#l54.6"></a><span id="l54.6"> * Currently tested</span>
<a href="#l54.7"></a><span id="l54.7"> * - Adding new folders</span>
<a href="#l54.8"></a><span id="l54.8"> * - Copying messages from files to mailboxes</span>
<a href="#l54.9"></a><span id="l54.9"> * - Adding new messages directly to mailboxes</span>
<a href="#l54.10"></a><span id="l54.10"> */</span>
<a href="#l54.11"></a><span id="l54.11"> </span>
<a href="#l54.12"></a><span id="l54.12" class="difflineplus">+/* import-globals-from ../../../test/resources/msgFolderListenerSetup.js */</span>
<a href="#l54.13"></a><span id="l54.13"> load(&quot;../../../resources/msgFolderListenerSetup.js&quot;);</span>
<a href="#l54.14"></a><span id="l54.14"> </span>
<a href="#l54.15"></a><span id="l54.15"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l54.16"></a><span id="l54.16"> </span>
<a href="#l54.17"></a><span id="l54.17"> // Globals</span>
<a href="#l54.18"></a><span id="l54.18"> var gRootFolder;</span>
<a href="#l54.19"></a><span id="l54.19" class="difflineminus">-var gIMAPInbox, gIMAPFolder2, gIMAPFolder3, gIMAPTrashFolder;</span>
<a href="#l54.20"></a><span id="l54.20" class="difflineplus">+var gIMAPInbox, gIMAPFolder2, gIMAPFolder3;</span>
<a href="#l54.21"></a><span id="l54.21"> var gIMAPDaemon, gServer, gIMAPIncomingServer;</span>
<a href="#l54.22"></a><span id="l54.22"> var gMsgFile1 = do_get_file(&quot;../../../data/bugmail10&quot;);</span>
<a href="#l54.23"></a><span id="l54.23"> var gMsgFile2 = do_get_file(&quot;../../../data/bugmail11&quot;);</span>
<a href="#l54.24"></a><span id="l54.24"> var gMsgFile3 = do_get_file(&quot;../../../data/draft1&quot;);</span>
<a href="#l54.25"></a><span id="l54.25"> var gMsgFile4 = do_get_file(&quot;../../../data/bugmail7&quot;);</span>
<a href="#l54.26"></a><span id="l54.26"> var gMsgFile5 = do_get_file(&quot;../../../data/bugmail6&quot;);</span>
<a href="#l54.27"></a><span id="l54.27"> </span>
<a href="#l54.28"></a><span id="l54.28"> // Copied straight from the example files</span>
<a href="#l54.29"></a><span id="l54.29" class="difflineat">@@ -34,30 +35,28 @@ var gMsgId1 = &quot;200806061706.m56H6RWT0049</span>
<a href="#l54.30"></a><span id="l54.30"> var gMsgId2 = &quot;200804111417.m3BEHTk4030129@mrapp51.mozilla.org&quot;;</span>
<a href="#l54.31"></a><span id="l54.31"> var gMsgId3 = &quot;4849BF7B.2030800@example.com&quot;;</span>
<a href="#l54.32"></a><span id="l54.32"> var gMsgId4 = &quot;bugmail7.m47LtAEf007542@mrapp51.mozilla.org&quot;;</span>
<a href="#l54.33"></a><span id="l54.33"> var gMsgId5 = &quot;bugmail6.m47LtAEf007542@mrapp51.mozilla.org&quot;;</span>
<a href="#l54.34"></a><span id="l54.34"> var gMsgWindow = Cc[&quot;@mozilla.org/messenger/msgwindow;1&quot;]</span>
<a href="#l54.35"></a><span id="l54.35">                   .createInstance(Ci.nsIMsgWindow);</span>
<a href="#l54.36"></a><span id="l54.36"> </span>
<a href="#l54.37"></a><span id="l54.37"> </span>
<a href="#l54.38"></a><span id="l54.38" class="difflineminus">-function addFolder(parent, folderName, storeIn)</span>
<a href="#l54.39"></a><span id="l54.39" class="difflineminus">-{</span>
<a href="#l54.40"></a><span id="l54.40" class="difflineplus">+function addFolder(parent, folderName, storeIn) {</span>
<a href="#l54.41"></a><span id="l54.41">   gExpectedEvents = [[MailServices.mfn.folderAdded, parent, folderName, storeIn]];</span>
<a href="#l54.42"></a><span id="l54.42">   // No copy listener notification for this</span>
<a href="#l54.43"></a><span id="l54.43">   gCurrStatus |= kStatus.onStopCopyDone;</span>
<a href="#l54.44"></a><span id="l54.44">   parent.createSubfolder(folderName, null);</span>
<a href="#l54.45"></a><span id="l54.45">   gCurrStatus |= kStatus.functionCallDone;</span>
<a href="#l54.46"></a><span id="l54.46">   gServer.performTest(&quot;LIST&quot;);</span>
<a href="#l54.47"></a><span id="l54.47">   if (gCurrStatus == kStatus.everythingDone)</span>
<a href="#l54.48"></a><span id="l54.48">     resetStatusAndProceed();</span>
<a href="#l54.49"></a><span id="l54.49"> }</span>
<a href="#l54.50"></a><span id="l54.50"> </span>
<a href="#l54.51"></a><span id="l54.51" class="difflineminus">-function copyFileMessage(file, messageId, destFolder)</span>
<a href="#l54.52"></a><span id="l54.52" class="difflineminus">-{</span>
<a href="#l54.53"></a><span id="l54.53" class="difflineplus">+function copyFileMessage(file, messageId, destFolder) {</span>
<a href="#l54.54"></a><span id="l54.54">   copyListener.mFolderStoredIn = destFolder;</span>
<a href="#l54.55"></a><span id="l54.55"> </span>
<a href="#l54.56"></a><span id="l54.56">   // This *needs* to be a draft (fourth parameter), as for non-UIDPLUS servers,</span>
<a href="#l54.57"></a><span id="l54.57">   // nsImapProtocol::UploadMessageFromFile is hardcoded not to send a copy</span>
<a href="#l54.58"></a><span id="l54.58">   // listener notification. The same function also asks for the message id from</span>
<a href="#l54.59"></a><span id="l54.59">   // the copy listener, without which it will *not* send the notification.</span>
<a href="#l54.60"></a><span id="l54.60"> </span>
<a href="#l54.61"></a><span id="l54.61">   // ...but wait, nsImapProtocol.cpp requires SEARCH afterwards to retrieve the</span>
<a href="#l54.62"></a><span id="l54.62" class="difflineat">@@ -74,36 +73,33 @@ function copyFileMessage(file, messageId</span>
<a href="#l54.63"></a><span id="l54.63">   gServer.performTest(&quot;APPEND&quot;);</span>
<a href="#l54.64"></a><span id="l54.64">   // Allow some time for the append operation to complete, so update folder</span>
<a href="#l54.65"></a><span id="l54.65">   // every second</span>
<a href="#l54.66"></a><span id="l54.66">   gFolderBeingUpdated = destFolder;</span>
<a href="#l54.67"></a><span id="l54.67">   doUpdateFolder(gTest);</span>
<a href="#l54.68"></a><span id="l54.68"> }</span>
<a href="#l54.69"></a><span id="l54.69"> </span>
<a href="#l54.70"></a><span id="l54.70"> var gFolderBeingUpdated = null;</span>
<a href="#l54.71"></a><span id="l54.71" class="difflineminus">-function doUpdateFolder(test)</span>
<a href="#l54.72"></a><span id="l54.72" class="difflineminus">-{</span>
<a href="#l54.73"></a><span id="l54.73" class="difflineplus">+function doUpdateFolder(test) {</span>
<a href="#l54.74"></a><span id="l54.74">   // In case we've moved on to the next test, exit</span>
<a href="#l54.75"></a><span id="l54.75">   if (gTest &gt; test)</span>
<a href="#l54.76"></a><span id="l54.76">     return;</span>
<a href="#l54.77"></a><span id="l54.77"> </span>
<a href="#l54.78"></a><span id="l54.78">   gFolderBeingUpdated.updateFolder(null);</span>
<a href="#l54.79"></a><span id="l54.79"> </span>
<a href="#l54.80"></a><span id="l54.80">   if (gCurrStatus == kStatus.everythingDone)</span>
<a href="#l54.81"></a><span id="l54.81">     resetStatusAndProceed();</span>
<a href="#l54.82"></a><span id="l54.82">   else</span>
<a href="#l54.83"></a><span id="l54.83" class="difflineminus">-    do_timeout(1000, function(){doUpdateFolder(test);});</span>
<a href="#l54.84"></a><span id="l54.84" class="difflineplus">+    do_timeout(1000, function() { doUpdateFolder(test); });</span>
<a href="#l54.85"></a><span id="l54.85"> }</span>
<a href="#l54.86"></a><span id="l54.86"> </span>
<a href="#l54.87"></a><span id="l54.87"> // Adds some messages directly to a mailbox (eg new mail)</span>
<a href="#l54.88"></a><span id="l54.88" class="difflineminus">-function addMessagesToServer(messages, mailbox, localFolder)</span>
<a href="#l54.89"></a><span id="l54.89" class="difflineminus">-{</span>
<a href="#l54.90"></a><span id="l54.90" class="difflineplus">+function addMessagesToServer(messages, mailbox, localFolder) {</span>
<a href="#l54.91"></a><span id="l54.91">   // For every message we have, we need to convert it to a file:/// URI</span>
<a href="#l54.92"></a><span id="l54.92" class="difflineminus">-  messages.forEach(function (message)</span>
<a href="#l54.93"></a><span id="l54.93" class="difflineminus">-  {</span>
<a href="#l54.94"></a><span id="l54.94" class="difflineplus">+  messages.forEach(function(message) {</span>
<a href="#l54.95"></a><span id="l54.95">     let URI = Services.io.newFileURI(message.file).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l54.96"></a><span id="l54.96">     // Create the imapMessage and store it on the mailbox.</span>
<a href="#l54.97"></a><span id="l54.97">     mailbox.addMessage(new imapMessage(URI.spec, mailbox.uidnext++, []));</span>
<a href="#l54.98"></a><span id="l54.98">     // We can't get the headers again, so just pass on the message id</span>
<a href="#l54.99"></a><span id="l54.99">     gExpectedEvents.push([MailServices.mfn.msgAdded, {expectedMessageId: message.messageId}]);</span>
<a href="#l54.100"></a><span id="l54.100">   });</span>
<a href="#l54.101"></a><span id="l54.101">   gExpectedEvents.push([MailServices.mfn.msgsClassified,</span>
<a href="#l54.102"></a><span id="l54.102">                         messages.map(hdr =&gt; hdr.messageId),</span>
<a href="#l54.103"></a><span id="l54.103" class="difflineat">@@ -111,28 +107,25 @@ function addMessagesToServer(messages, m</span>
<a href="#l54.104"></a><span id="l54.104"> </span>
<a href="#l54.105"></a><span id="l54.105">   // No copy listener notification for this</span>
<a href="#l54.106"></a><span id="l54.106">   gCurrStatus |= kStatus.functionCallDone | kStatus.onStopCopyDone;</span>
<a href="#l54.107"></a><span id="l54.107"> </span>
<a href="#l54.108"></a><span id="l54.108">   gFolderBeingUpdated = localFolder;</span>
<a href="#l54.109"></a><span id="l54.109">   doUpdateFolder(gTest);</span>
<a href="#l54.110"></a><span id="l54.110"> }</span>
<a href="#l54.111"></a><span id="l54.111"> </span>
<a href="#l54.112"></a><span id="l54.112" class="difflineminus">-function copyMessages(messages, isMove, srcFolder, destFolder)</span>
<a href="#l54.113"></a><span id="l54.113" class="difflineminus">-{</span>
<a href="#l54.114"></a><span id="l54.114" class="difflineplus">+function copyMessages(messages, isMove, srcFolder, destFolder) {</span>
<a href="#l54.115"></a><span id="l54.115">   let array = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l54.116"></a><span id="l54.116" class="difflineminus">-  messages.forEach(function (message)</span>
<a href="#l54.117"></a><span id="l54.117" class="difflineminus">-  {</span>
<a href="#l54.118"></a><span id="l54.118" class="difflineplus">+  messages.forEach(function(message) {</span>
<a href="#l54.119"></a><span id="l54.119">     array.appendElement(message);</span>
<a href="#l54.120"></a><span id="l54.120">   });</span>
<a href="#l54.121"></a><span id="l54.121">   gExpectedEvents = [[MailServices.mfn.msgsMoveCopyCompleted, isMove, messages, destFolder, true]];</span>
<a href="#l54.122"></a><span id="l54.122">   // We'll also get the msgAdded events when we go and update the destination</span>
<a href="#l54.123"></a><span id="l54.123">   // folder</span>
<a href="#l54.124"></a><span id="l54.124" class="difflineminus">-  messages.forEach(function (message)</span>
<a href="#l54.125"></a><span id="l54.125" class="difflineminus">-  {</span>
<a href="#l54.126"></a><span id="l54.126" class="difflineplus">+  messages.forEach(function(message) {</span>
<a href="#l54.127"></a><span id="l54.127">     // We can't use the headers directly, because the notifications we'll</span>
<a href="#l54.128"></a><span id="l54.128">     // receive are for message headers in the destination folder</span>
<a href="#l54.129"></a><span id="l54.129">     gExpectedEvents.push([MailServices.mfn.msgKeyChanged,</span>
<a href="#l54.130"></a><span id="l54.130">                           {expectedMessageId: message.messageId}]);</span>
<a href="#l54.131"></a><span id="l54.131">     gExpectedEvents.push([MailServices.mfn.msgAdded,</span>
<a href="#l54.132"></a><span id="l54.132">                           {expectedMessageId: message.messageId}]);</span>
<a href="#l54.133"></a><span id="l54.133">   });</span>
<a href="#l54.134"></a><span id="l54.134">   gExpectedEvents.push([MailServices.mfn.msgsClassified,</span>
<a href="#l54.135"></a><span id="l54.135" class="difflineat">@@ -144,59 +137,59 @@ function copyMessages(messages, isMove, </span>
<a href="#l54.136"></a><span id="l54.136">   gServer.performTest(&quot;COPY&quot;);</span>
<a href="#l54.137"></a><span id="l54.137"> </span>
<a href="#l54.138"></a><span id="l54.138">   gFolderBeingUpdated = destFolder;</span>
<a href="#l54.139"></a><span id="l54.139">   doUpdateFolder(gTest);</span>
<a href="#l54.140"></a><span id="l54.140">   if (gCurrStatus == kStatus.everythingDone)</span>
<a href="#l54.141"></a><span id="l54.141">     resetStatusAndProceed();</span>
<a href="#l54.142"></a><span id="l54.142"> }</span>
<a href="#l54.143"></a><span id="l54.143"> </span>
<a href="#l54.144"></a><span id="l54.144" class="difflineminus">-var gTestArray =</span>
<a href="#l54.145"></a><span id="l54.145" class="difflineminus">-[</span>
<a href="#l54.146"></a><span id="l54.146" class="difflineplus">+var gTestArray = [</span>
<a href="#l54.147"></a><span id="l54.147">   // Adding folders</span>
<a href="#l54.148"></a><span id="l54.148">   // Create another folder to move and copy messages around, and force initialization.</span>
<a href="#l54.149"></a><span id="l54.149">   function testAddFolder1() {</span>
<a href="#l54.150"></a><span id="l54.150">     addFolder(gRootFolder, &quot;folder2&quot;, function(folder) { gIMAPFolder2 = folder; });</span>
<a href="#l54.151"></a><span id="l54.151">    },</span>
<a href="#l54.152"></a><span id="l54.152">   function testAddFolder2() {</span>
<a href="#l54.153"></a><span id="l54.153">     addFolder(gRootFolder, &quot;folder3&quot;, function(folder) { gIMAPFolder3 = folder; });</span>
<a href="#l54.154"></a><span id="l54.154">   },</span>
<a href="#l54.155"></a><span id="l54.155"> </span>
<a href="#l54.156"></a><span id="l54.156">   // Adding messages to folders</span>
<a href="#l54.157"></a><span id="l54.157" class="difflineminus">-  function testCopyFileMessage1()</span>
<a href="#l54.158"></a><span id="l54.158" class="difflineminus">-  {</span>
<a href="#l54.159"></a><span id="l54.159" class="difflineplus">+  function testCopyFileMessage1() {</span>
<a href="#l54.160"></a><span id="l54.160">     // Make sure the offline flag is not set for any of the folders</span>
<a href="#l54.161"></a><span id="l54.161" class="difflineminus">-    [gIMAPInbox, gIMAPFolder2, gIMAPFolder3].forEach(function (folder)</span>
<a href="#l54.162"></a><span id="l54.162" class="difflineminus">-    {</span>
<a href="#l54.163"></a><span id="l54.163" class="difflineplus">+    [gIMAPInbox, gIMAPFolder2, gIMAPFolder3].forEach(function(folder) {</span>
<a href="#l54.164"></a><span id="l54.164">       folder.clearFlag(Ci.nsMsgFolderFlags.Offline);</span>
<a href="#l54.165"></a><span id="l54.165">     });</span>
<a href="#l54.166"></a><span id="l54.166" class="difflineminus">-    copyFileMessage(gMsgFile1, gMsgId1, gIMAPInbox)</span>
<a href="#l54.167"></a><span id="l54.167" class="difflineplus">+    copyFileMessage(gMsgFile1, gMsgId1, gIMAPInbox);</span>
<a href="#l54.168"></a><span id="l54.168">   },</span>
<a href="#l54.169"></a><span id="l54.169" class="difflineminus">-  function testCopyFileMessage2() { copyFileMessage(gMsgFile2, gMsgId2, gIMAPInbox) },</span>
<a href="#l54.170"></a><span id="l54.170" class="difflineplus">+  function testCopyFileMessage2() {</span>
<a href="#l54.171"></a><span id="l54.171" class="difflineplus">+    copyFileMessage(gMsgFile2, gMsgId2, gIMAPInbox);</span>
<a href="#l54.172"></a><span id="l54.172" class="difflineplus">+  },</span>
<a href="#l54.173"></a><span id="l54.173"> </span>
<a href="#l54.174"></a><span id="l54.174">   // Add message straight to the server, so that we get a message added</span>
<a href="#l54.175"></a><span id="l54.175">   // notification on the next folder update</span>
<a href="#l54.176"></a><span id="l54.176">   function testNewMessageArrival1() {</span>
<a href="#l54.177"></a><span id="l54.177">     addMessagesToServer([{file: gMsgFile3, messageId: gMsgId3}],</span>
<a href="#l54.178"></a><span id="l54.178" class="difflineminus">-                        gIMAPDaemon.getMailbox(&quot;INBOX&quot;), gIMAPInbox)</span>
<a href="#l54.179"></a><span id="l54.179" class="difflineplus">+                        gIMAPDaemon.getMailbox(&quot;INBOX&quot;), gIMAPInbox);</span>
<a href="#l54.180"></a><span id="l54.180">   },</span>
<a href="#l54.181"></a><span id="l54.181"> </span>
<a href="#l54.182"></a><span id="l54.182">   // Add another couple of messages, this time to another folder on the server</span>
<a href="#l54.183"></a><span id="l54.183">   function testNewMessageArrival2() {</span>
<a href="#l54.184"></a><span id="l54.184">     addMessagesToServer([{file: gMsgFile4, messageId: gMsgId4},</span>
<a href="#l54.185"></a><span id="l54.185">                          {file: gMsgFile5, messageId: gMsgId5}],</span>
<a href="#l54.186"></a><span id="l54.186">                         gIMAPDaemon.getMailbox(&quot;INBOX&quot;), gIMAPInbox);</span>
<a href="#l54.187"></a><span id="l54.187">   },</span>
<a href="#l54.188"></a><span id="l54.188"> </span>
<a href="#l54.189"></a><span id="l54.189">   // Moving/copying messages (this doesn't work right now)</span>
<a href="#l54.190"></a><span id="l54.190" class="difflineminus">-  function testCopyMessages1() { copyMessages([gMsgHdrs[0].hdr, gMsgHdrs[1].hdr], false, gIMAPInbox, gIMAPFolder3) }</span>
<a href="#l54.191"></a><span id="l54.191" class="difflineplus">+  function testCopyMessages1() {</span>
<a href="#l54.192"></a><span id="l54.192" class="difflineplus">+    copyMessages([gMsgHdrs[0].hdr, gMsgHdrs[1].hdr], false, gIMAPInbox, gIMAPFolder3);</span>
<a href="#l54.193"></a><span id="l54.193" class="difflineplus">+  },</span>
<a href="#l54.194"></a><span id="l54.194"> ];</span>
<a href="#l54.195"></a><span id="l54.195"> </span>
<a href="#l54.196"></a><span id="l54.196" class="difflineminus">-function run_test()</span>
<a href="#l54.197"></a><span id="l54.197" class="difflineminus">-{</span>
<a href="#l54.198"></a><span id="l54.198" class="difflineplus">+function run_test() {</span>
<a href="#l54.199"></a><span id="l54.199">   // This is before any of the actual tests, so...</span>
<a href="#l54.200"></a><span id="l54.200">   gTest = 0;</span>
<a href="#l54.201"></a><span id="l54.201"> </span>
<a href="#l54.202"></a><span id="l54.202">   gIMAPDaemon = new imapDaemon();</span>
<a href="#l54.203"></a><span id="l54.203">   gServer = makeServer(gIMAPDaemon, &quot;&quot;);</span>
<a href="#l54.204"></a><span id="l54.204"> </span>
<a href="#l54.205"></a><span id="l54.205">   gIMAPIncomingServer = createLocalIMAPServer(gServer.port);</span>
<a href="#l54.206"></a><span id="l54.206"> </span>
<a href="#l54.207"></a><span id="l54.207" class="difflineat">@@ -233,59 +226,53 @@ function run_test()</span>
<a href="#l54.208"></a><span id="l54.208"> </span>
<a href="#l54.209"></a><span id="l54.209">   // Get the server list...</span>
<a href="#l54.210"></a><span id="l54.210">   gIMAPIncomingServer.performExpand(null);</span>
<a href="#l54.211"></a><span id="l54.211"> </span>
<a href="#l54.212"></a><span id="l54.212">   // We get these notifications on initial discovery</span>
<a href="#l54.213"></a><span id="l54.213">   gRootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l54.214"></a><span id="l54.214">   gIMAPInbox = gRootFolder.getChildNamed(&quot;Inbox&quot;);</span>
<a href="#l54.215"></a><span id="l54.215">   gExpectedEvents = [[MailServices.mfn.folderAdded, gRootFolder, &quot;Trash&quot;,</span>
<a href="#l54.216"></a><span id="l54.216" class="difflineminus">-                      function(folder) { gIMAPTrashFolder = folder; } ]];</span>
<a href="#l54.217"></a><span id="l54.217" class="difflineplus">+                      function(folder) {}]];</span>
<a href="#l54.218"></a><span id="l54.218">   gCurrStatus |= kStatus.onStopCopyDone | kStatus.functionCallDone;</span>
<a href="#l54.219"></a><span id="l54.219"> </span>
<a href="#l54.220"></a><span id="l54.220">   gServer.performTest(&quot;SUBSCRIBE&quot;);</span>
<a href="#l54.221"></a><span id="l54.221"> </span>
<a href="#l54.222"></a><span id="l54.222">   // &quot;Master&quot; do_test_pending(), paired with a do_test_finished() at the end of</span>
<a href="#l54.223"></a><span id="l54.223">   // all the operations.</span>
<a href="#l54.224"></a><span id="l54.224">   do_test_pending();</span>
<a href="#l54.225"></a><span id="l54.225"> }</span>
<a href="#l54.226"></a><span id="l54.226"> </span>
<a href="#l54.227"></a><span id="l54.227" class="difflineminus">-function doTest(test)</span>
<a href="#l54.228"></a><span id="l54.228" class="difflineminus">-{</span>
<a href="#l54.229"></a><span id="l54.229" class="difflineplus">+function doTest(test) { // eslint-disable-line no-unused-vars</span>
<a href="#l54.230"></a><span id="l54.230">   dump(&quot;Doing test &quot; + test + &quot;\n&quot;);</span>
<a href="#l54.231"></a><span id="l54.231" class="difflineminus">-  if (test &lt;= gTestArray.length)</span>
<a href="#l54.232"></a><span id="l54.232" class="difflineminus">-  {</span>
<a href="#l54.233"></a><span id="l54.233" class="difflineminus">-    let testFn = gTestArray[test-1];</span>
<a href="#l54.234"></a><span id="l54.234" class="difflineplus">+  if (test &lt;= gTestArray.length) {</span>
<a href="#l54.235"></a><span id="l54.235" class="difflineplus">+    let testFn = gTestArray[test - 1];</span>
<a href="#l54.236"></a><span id="l54.236"> </span>
<a href="#l54.237"></a><span id="l54.237">     // Set a limit of ten seconds; if the notifications haven't arrived by then there's a problem.</span>
<a href="#l54.238"></a><span id="l54.238" class="difflineminus">-    do_timeout(10000, function(){</span>
<a href="#l54.239"></a><span id="l54.239" class="difflineplus">+    do_timeout(10000, function() {</span>
<a href="#l54.240"></a><span id="l54.240">         if (gTest == test)</span>
<a href="#l54.241"></a><span id="l54.241">           do_throw(&quot;Notifications not received in 10000 ms for operation &quot; + testFn.name +</span>
<a href="#l54.242"></a><span id="l54.242">             &quot;, current status is &quot; + gCurrStatus);</span>
<a href="#l54.243"></a><span id="l54.243">         }</span>
<a href="#l54.244"></a><span id="l54.244">       );</span>
<a href="#l54.245"></a><span id="l54.245">     testFn();</span>
<a href="#l54.246"></a><span id="l54.246" class="difflineminus">-  }</span>
<a href="#l54.247"></a><span id="l54.247" class="difflineminus">-  else</span>
<a href="#l54.248"></a><span id="l54.248" class="difflineminus">-  {</span>
<a href="#l54.249"></a><span id="l54.249" class="difflineplus">+  } else {</span>
<a href="#l54.250"></a><span id="l54.250">     MailServices.mfn.removeListener(gMFListener);</span>
<a href="#l54.251"></a><span id="l54.251">     // Cleanup, null out everything, close all cached connections and stop the</span>
<a href="#l54.252"></a><span id="l54.252">     // server</span>
<a href="#l54.253"></a><span id="l54.253">     gRootFolder = null;</span>
<a href="#l54.254"></a><span id="l54.254">     gIMAPInbox.msgDatabase = null;</span>
<a href="#l54.255"></a><span id="l54.255">     gIMAPInbox = null;</span>
<a href="#l54.256"></a><span id="l54.256">     gIMAPFolder2 = null;</span>
<a href="#l54.257"></a><span id="l54.257">     gIMAPFolder3 = null;</span>
<a href="#l54.258"></a><span id="l54.258" class="difflineminus">-    gIMAPTrashFolder = null;</span>
<a href="#l54.259"></a><span id="l54.259">     do_timeout(1000, endTest);</span>
<a href="#l54.260"></a><span id="l54.260">   }</span>
<a href="#l54.261"></a><span id="l54.261"> }</span>
<a href="#l54.262"></a><span id="l54.262"> </span>
<a href="#l54.263"></a><span id="l54.263" class="difflineminus">-function endTest()</span>
<a href="#l54.264"></a><span id="l54.264" class="difflineminus">-{</span>
<a href="#l54.265"></a><span id="l54.265" class="difflineplus">+function endTest() {</span>
<a href="#l54.266"></a><span id="l54.266">   gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l54.267"></a><span id="l54.267">   gServer.performTest();</span>
<a href="#l54.268"></a><span id="l54.268">   gServer.stop();</span>
<a href="#l54.269"></a><span id="l54.269">   let thread = gThreadManager.currentThread;</span>
<a href="#l54.270"></a><span id="l54.270">   while (thread.hasPendingEvents())</span>
<a href="#l54.271"></a><span id="l54.271">     thread.processNextEvent(true);</span>
<a href="#l54.272"></a><span id="l54.272"> </span>
<a href="#l54.273"></a><span id="l54.273">   do_test_finished(); // for the one in run_test()</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l55.1"></a><span id="l55.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_offlineCopy.js</span>
<a href="#l55.2"></a><span id="l55.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_offlineCopy.js</span>
<a href="#l55.3"></a><span id="l55.3" class="difflineat">@@ -6,38 +6,36 @@</span>
<a href="#l55.4"></a><span id="l55.4">  *</span>
<a href="#l55.5"></a><span id="l55.5">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l55.6"></a><span id="l55.6"> </span>
<a href="#l55.7"></a><span id="l55.7"> /**</span>
<a href="#l55.8"></a><span id="l55.8">  * This test checks pseudo-offline message copies (which is triggered</span>
<a href="#l55.9"></a><span id="l55.9">  * by allowUndo == true in CopyMessages).</span>
<a href="#l55.10"></a><span id="l55.10">  */</span>
<a href="#l55.11"></a><span id="l55.11"> </span>
<a href="#l55.12"></a><span id="l55.12" class="difflineminus">-var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l55.13"></a><span id="l55.13"> var {PromiseTestUtils} = ChromeUtils.import(&quot;resource://testing-common/mailnews/PromiseTestUtils.jsm&quot;);</span>
<a href="#l55.14"></a><span id="l55.14"> </span>
<a href="#l55.15"></a><span id="l55.15" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l55.16"></a><span id="l55.16"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l55.17"></a><span id="l55.17"> </span>
<a href="#l55.18"></a><span id="l55.18"> var gMsgFile1 = do_get_file(&quot;../../../data/bugmail10&quot;);</span>
<a href="#l55.19"></a><span id="l55.19"> var gMsgId1 = &quot;200806061706.m56H6RWT004933@mrapp54.mozilla.org&quot;;</span>
<a href="#l55.20"></a><span id="l55.20"> var gMsgFile2 = do_get_file(&quot;../../../data/image-attach-test&quot;);</span>
<a href="#l55.21"></a><span id="l55.21"> var gMsgId2 = &quot;4A947F73.5030709@example.com&quot;;</span>
<a href="#l55.22"></a><span id="l55.22"> var gMsgFile3 = do_get_file(&quot;../../../data/SpamAssassinYes&quot;);</span>
<a href="#l55.23"></a><span id="l55.23"> var gMsg3Id = &quot;bugmail7.m47LtAEf007543@mrapp51.mozilla.org&quot;;</span>
<a href="#l55.24"></a><span id="l55.24"> var gMsgFile4 = do_get_file(&quot;../../../data/bug460636&quot;);</span>
<a href="#l55.25"></a><span id="l55.25"> var gMsg4Id = &quot;foo.12345@example&quot;;</span>
<a href="#l55.26"></a><span id="l55.26"> </span>
<a href="#l55.27"></a><span id="l55.27"> var gFolder1;</span>
<a href="#l55.28"></a><span id="l55.28"> </span>
<a href="#l55.29"></a><span id="l55.29"> // Adds some messages directly to a mailbox (eg new mail)</span>
<a href="#l55.30"></a><span id="l55.30" class="difflineminus">-function addMessagesToServer(messages, mailbox)</span>
<a href="#l55.31"></a><span id="l55.31" class="difflineminus">-{</span>
<a href="#l55.32"></a><span id="l55.32" class="difflineplus">+function addMessagesToServer(messages, mailbox) {</span>
<a href="#l55.33"></a><span id="l55.33">   // For every message we have, we need to convert it to a file:/// URI</span>
<a href="#l55.34"></a><span id="l55.34" class="difflineminus">-  messages.forEach(function (message)</span>
<a href="#l55.35"></a><span id="l55.35" class="difflineminus">-  {</span>
<a href="#l55.36"></a><span id="l55.36" class="difflineplus">+  messages.forEach(function(message) {</span>
<a href="#l55.37"></a><span id="l55.37">     let URI = Services.io.newFileURI(message.file).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l55.38"></a><span id="l55.38">     // Create the imapMessage and store it on the mailbox.</span>
<a href="#l55.39"></a><span id="l55.39">     mailbox.addMessage(new imapMessage(URI.spec, mailbox.uidnext++, []));</span>
<a href="#l55.40"></a><span id="l55.40">   });</span>
<a href="#l55.41"></a><span id="l55.41"> }</span>
<a href="#l55.42"></a><span id="l55.42"> </span>
<a href="#l55.43"></a><span id="l55.43"> var tests = [</span>
<a href="#l55.44"></a><span id="l55.44">   async function setup() {</span>
<a href="#l55.45"></a><span id="l55.45" class="difflineat">@@ -56,17 +54,17 @@ var tests = [</span>
<a href="#l55.46"></a><span id="l55.46"> </span>
<a href="#l55.47"></a><span id="l55.47">     gFolder1 = IMAPPump.incomingServer.rootFolder.getChildNamed(&quot;folder 1&quot;);</span>
<a href="#l55.48"></a><span id="l55.48">     Assert.ok(gFolder1 instanceof Ci.nsIMsgFolder);</span>
<a href="#l55.49"></a><span id="l55.49"> </span>
<a href="#l55.50"></a><span id="l55.50">     // these hacks are required because we've created the inbox before</span>
<a href="#l55.51"></a><span id="l55.51">     // running initial folder discovery, and adding the folder bails</span>
<a href="#l55.52"></a><span id="l55.52">     // out before we set it as verified online, so we bail out, and</span>
<a href="#l55.53"></a><span id="l55.53">     // then remove the INBOX folder since it's not verified.</span>
<a href="#l55.54"></a><span id="l55.54" class="difflineminus">-    IMAPPump.inbox.hierarchyDelimiter = '/';</span>
<a href="#l55.55"></a><span id="l55.55" class="difflineplus">+    IMAPPump.inbox.hierarchyDelimiter = &quot;/&quot;;</span>
<a href="#l55.56"></a><span id="l55.56">     IMAPPump.inbox.verifiedAsOnlineFolder = true;</span>
<a href="#l55.57"></a><span id="l55.57"> </span>
<a href="#l55.58"></a><span id="l55.58">     // Add messages to the INBOX</span>
<a href="#l55.59"></a><span id="l55.59">     // this is synchronous, afaik</span>
<a href="#l55.60"></a><span id="l55.60">     addMessagesToServer([{file: gMsgFile1, messageId: gMsgId1},</span>
<a href="#l55.61"></a><span id="l55.61">                          {file: gMsgFile2, messageId: gMsgId2},</span>
<a href="#l55.62"></a><span id="l55.62">                         ],</span>
<a href="#l55.63"></a><span id="l55.63">                         IMAPPump.daemon.getMailbox(&quot;INBOX&quot;));</span>
<a href="#l55.64"></a><span id="l55.64" class="difflineat">@@ -96,26 +94,25 @@ var tests = [</span>
<a href="#l55.65"></a><span id="l55.65">     IMAPPump.inbox.updateFolderWithListener(null, promiseUrlListener);</span>
<a href="#l55.66"></a><span id="l55.66">     await promiseUrlListener.promise;</span>
<a href="#l55.67"></a><span id="l55.67"> </span>
<a href="#l55.68"></a><span id="l55.68">     let db = IMAPPump.inbox.msgDatabase;</span>
<a href="#l55.69"></a><span id="l55.69"> </span>
<a href="#l55.70"></a><span id="l55.70">     // test the headers in the inbox</span>
<a href="#l55.71"></a><span id="l55.71">     let enumerator = db.EnumerateMessages();</span>
<a href="#l55.72"></a><span id="l55.72">     let count = 0;</span>
<a href="#l55.73"></a><span id="l55.73" class="difflineminus">-    while (enumerator.hasMoreElements())</span>
<a href="#l55.74"></a><span id="l55.74" class="difflineminus">-    {</span>
<a href="#l55.75"></a><span id="l55.75" class="difflineplus">+    while (enumerator.hasMoreElements()) {</span>
<a href="#l55.76"></a><span id="l55.76">       count++;</span>
<a href="#l55.77"></a><span id="l55.77">       var message = enumerator.getNext();</span>
<a href="#l55.78"></a><span id="l55.78">       message instanceof Ci.nsIMsgDBHdr;</span>
<a href="#l55.79"></a><span id="l55.79" class="difflineminus">-      dump('message &lt;'+ message.subject +</span>
<a href="#l55.80"></a><span id="l55.80" class="difflineminus">-           '&gt; storeToken: &lt;' + message.getStringProperty(&quot;storeToken&quot;) +</span>
<a href="#l55.81"></a><span id="l55.81" class="difflineminus">-           '&gt; offset: &lt;' + message.messageOffset +</span>
<a href="#l55.82"></a><span id="l55.82" class="difflineminus">-           '&gt; id: &lt;' + message.messageId +</span>
<a href="#l55.83"></a><span id="l55.83" class="difflineminus">-           '&gt;\n');</span>
<a href="#l55.84"></a><span id="l55.84" class="difflineplus">+      dump(&quot;message &lt;&quot; + message.subject +</span>
<a href="#l55.85"></a><span id="l55.85" class="difflineplus">+           &quot;&gt; storeToken: &lt;&quot; + message.getStringProperty(&quot;storeToken&quot;) +</span>
<a href="#l55.86"></a><span id="l55.86" class="difflineplus">+           &quot;&gt; offset: &lt;&quot; + message.messageOffset +</span>
<a href="#l55.87"></a><span id="l55.87" class="difflineplus">+           &quot;&gt; id: &lt;&quot; + message.messageId +</span>
<a href="#l55.88"></a><span id="l55.88" class="difflineplus">+           &quot;&gt;\n&quot;);</span>
<a href="#l55.89"></a><span id="l55.89">       // This fails for file copies in bug 790912. Without  this, messages that</span>
<a href="#l55.90"></a><span id="l55.90">       //  are copied are not visible in pre-pluggableStores versions of TB (pre TB 12)</span>
<a href="#l55.91"></a><span id="l55.91">       if (IMAPPump.inbox.msgStore.storeType == &quot;mbox&quot;)</span>
<a href="#l55.92"></a><span id="l55.92">         Assert.equal(message.messageOffset, parseInt(message.getStringProperty(&quot;storeToken&quot;)));</span>
<a href="#l55.93"></a><span id="l55.93">     }</span>
<a href="#l55.94"></a><span id="l55.94">     Assert.equal(count, 4);</span>
<a href="#l55.95"></a><span id="l55.95">   },</span>
<a href="#l55.96"></a><span id="l55.96">   function copyMessagesToSubfolder() {</span>
<a href="#l55.97"></a><span id="l55.97" class="difflineat">@@ -146,44 +143,42 @@ var tests = [</span>
<a href="#l55.98"></a><span id="l55.98">     messages.appendElement(msg4);</span>
<a href="#l55.99"></a><span id="l55.99">     MailServices.copy.CopyMessages(IMAPPump.inbox, messages, gFolder1, false,</span>
<a href="#l55.100"></a><span id="l55.100">                                    null, null, true);</span>
<a href="#l55.101"></a><span id="l55.101"> </span>
<a href="#l55.102"></a><span id="l55.102">     // test the db headers in folder1</span>
<a href="#l55.103"></a><span id="l55.103">     db = gFolder1.msgDatabase;</span>
<a href="#l55.104"></a><span id="l55.104">     let enumerator = db.EnumerateMessages();</span>
<a href="#l55.105"></a><span id="l55.105">     let count = 0;</span>
<a href="#l55.106"></a><span id="l55.106" class="difflineminus">-    while (enumerator.hasMoreElements())</span>
<a href="#l55.107"></a><span id="l55.107" class="difflineminus">-    {</span>
<a href="#l55.108"></a><span id="l55.108" class="difflineplus">+    while (enumerator.hasMoreElements()) {</span>
<a href="#l55.109"></a><span id="l55.109">       count++;</span>
<a href="#l55.110"></a><span id="l55.110">       var message = enumerator.getNext();</span>
<a href="#l55.111"></a><span id="l55.111">       message instanceof Ci.nsIMsgDBHdr;</span>
<a href="#l55.112"></a><span id="l55.112" class="difflineminus">-      dump('message &lt;'+ message.subject +</span>
<a href="#l55.113"></a><span id="l55.113" class="difflineminus">-           '&gt; storeToken: &lt;' + message.getStringProperty(&quot;storeToken&quot;) +</span>
<a href="#l55.114"></a><span id="l55.114" class="difflineminus">-           '&gt; offset: &lt;' + message.messageOffset +</span>
<a href="#l55.115"></a><span id="l55.115" class="difflineminus">-           '&gt; id: &lt;' + message.messageId +</span>
<a href="#l55.116"></a><span id="l55.116" class="difflineminus">-           '&gt;\n');</span>
<a href="#l55.117"></a><span id="l55.117" class="difflineplus">+      dump(&quot;message &lt;&quot; + message.subject +</span>
<a href="#l55.118"></a><span id="l55.118" class="difflineplus">+           &quot;&gt; storeToken: &lt;&quot; + message.getStringProperty(&quot;storeToken&quot;) +</span>
<a href="#l55.119"></a><span id="l55.119" class="difflineplus">+           &quot;&gt; offset: &lt;&quot; + message.messageOffset +</span>
<a href="#l55.120"></a><span id="l55.120" class="difflineplus">+           &quot;&gt; id: &lt;&quot; + message.messageId +</span>
<a href="#l55.121"></a><span id="l55.121" class="difflineplus">+           &quot;&gt;\n&quot;);</span>
<a href="#l55.122"></a><span id="l55.122">       if (gFolder1.msgStore.storeType == &quot;mbox&quot;)</span>
<a href="#l55.123"></a><span id="l55.123">         Assert.equal(message.messageOffset, parseInt(message.getStringProperty(&quot;storeToken&quot;)));</span>
<a href="#l55.124"></a><span id="l55.124">     }</span>
<a href="#l55.125"></a><span id="l55.125">     Assert.equal(count, 3);</span>
<a href="#l55.126"></a><span id="l55.126">   },</span>
<a href="#l55.127"></a><span id="l55.127">   async function test_headers() {</span>
<a href="#l55.128"></a><span id="l55.128">     let msgIds = [gMsgId1, gMsg3Id, gMsg4Id];</span>
<a href="#l55.129"></a><span id="l55.129" class="difflineminus">-    for (let msgId of msgIds)</span>
<a href="#l55.130"></a><span id="l55.130" class="difflineminus">-    {</span>
<a href="#l55.131"></a><span id="l55.131" class="difflineminus">-      let newMsgHdr= gFolder1.msgDatabase.getMsgHdrForMessageID(msgId);</span>
<a href="#l55.132"></a><span id="l55.132" class="difflineplus">+    for (let msgId of msgIds) {</span>
<a href="#l55.133"></a><span id="l55.133" class="difflineplus">+      let newMsgHdr = gFolder1.msgDatabase.getMsgHdrForMessageID(msgId);</span>
<a href="#l55.134"></a><span id="l55.134">       Assert.ok(newMsgHdr.flags &amp; Ci.nsMsgMessageFlags.Offline);</span>
<a href="#l55.135"></a><span id="l55.135">       let msgURI = newMsgHdr.folder.getUriForMsg(newMsgHdr);</span>
<a href="#l55.136"></a><span id="l55.136">       let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l55.137"></a><span id="l55.137">       let msgServ = messenger.messageServiceFromURI(msgURI);</span>
<a href="#l55.138"></a><span id="l55.138">       let promiseStreamListener = new PromiseTestUtils.PromiseStreamListener();</span>
<a href="#l55.139"></a><span id="l55.139">       msgServ.streamHeaders(msgURI, promiseStreamListener, null, true);</span>
<a href="#l55.140"></a><span id="l55.140">       let data = await promiseStreamListener.promise;</span>
<a href="#l55.141"></a><span id="l55.141" class="difflineminus">-      dump('\nheaders for messageId ' + msgId + '\n' + data + '\n\n');</span>
<a href="#l55.142"></a><span id="l55.142" class="difflineplus">+      dump(&quot;\nheaders for messageId &quot; + msgId + &quot;\n&quot; + data + &quot;\n\n&quot;);</span>
<a href="#l55.143"></a><span id="l55.143">       Assert.ok(data.includes(msgId));</span>
<a href="#l55.144"></a><span id="l55.144">     }</span>
<a href="#l55.145"></a><span id="l55.145">   },</span>
<a href="#l55.146"></a><span id="l55.146">   function moveMessagesToSubfolder() {</span>
<a href="#l55.147"></a><span id="l55.147">     let db = IMAPPump.inbox.msgDatabase;</span>
<a href="#l55.148"></a><span id="l55.148">     let enumerator = db.EnumerateMessages();</span>
<a href="#l55.149"></a><span id="l55.149">     Assert.ok(enumerator.hasMoreElements());</span>
<a href="#l55.150"></a><span id="l55.150">     let messages = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l55.151"></a><span id="l55.151" class="difflineat">@@ -193,26 +188,25 @@ var tests = [</span>
<a href="#l55.152"></a><span id="l55.152">     MailServices.copy.CopyMessages(IMAPPump.inbox, messages, gFolder1, true,</span>
<a href="#l55.153"></a><span id="l55.153">                                    null, null, true);</span>
<a href="#l55.154"></a><span id="l55.154"> </span>
<a href="#l55.155"></a><span id="l55.155">     // the inbox should now be empty</span>
<a href="#l55.156"></a><span id="l55.156">     enumerator = db.EnumerateMessages();</span>
<a href="#l55.157"></a><span id="l55.157">     Assert.ok(!enumerator.hasMoreElements());</span>
<a href="#l55.158"></a><span id="l55.158"> </span>
<a href="#l55.159"></a><span id="l55.159">     // maildir should also delete the files.</span>
<a href="#l55.160"></a><span id="l55.160" class="difflineminus">-    if (IMAPPump.inbox.msgStore.storeType == &quot;maildir&quot;)</span>
<a href="#l55.161"></a><span id="l55.161" class="difflineminus">-    {</span>
<a href="#l55.162"></a><span id="l55.162" class="difflineplus">+    if (IMAPPump.inbox.msgStore.storeType == &quot;maildir&quot;) {</span>
<a href="#l55.163"></a><span id="l55.163">       let curDir = IMAPPump.inbox.filePath.clone();</span>
<a href="#l55.164"></a><span id="l55.164">       curDir.append(&quot;cur&quot;);</span>
<a href="#l55.165"></a><span id="l55.165">       Assert.ok(curDir.exists());</span>
<a href="#l55.166"></a><span id="l55.166">       Assert.ok(curDir.isDirectory());</span>
<a href="#l55.167"></a><span id="l55.167">       let curEnum = curDir.directoryEntries;</span>
<a href="#l55.168"></a><span id="l55.168">       // the directory should be empty, fails from bug 771643</span>
<a href="#l55.169"></a><span id="l55.169" class="difflineminus">-      Assert.ok(!curEnum.hasMoreElements())</span>
<a href="#l55.170"></a><span id="l55.170" class="difflineplus">+      Assert.ok(!curEnum.hasMoreElements());</span>
<a href="#l55.171"></a><span id="l55.171">     }</span>
<a href="#l55.172"></a><span id="l55.172">   },</span>
<a href="#l55.173"></a><span id="l55.173" class="difflineminus">-  teardownIMAPPump</span>
<a href="#l55.174"></a><span id="l55.174" class="difflineplus">+  teardownIMAPPump,</span>
<a href="#l55.175"></a><span id="l55.175"> ];</span>
<a href="#l55.176"></a><span id="l55.176"> </span>
<a href="#l55.177"></a><span id="l55.177"> function run_test() {</span>
<a href="#l55.178"></a><span id="l55.178">   tests.forEach(x =&gt; add_task(x));</span>
<a href="#l55.179"></a><span id="l55.179">   run_next_test();</span>
<a href="#l55.180"></a><span id="l55.180"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l56.1"></a><span id="l56.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_offlineDraftDataloss.js</span>
<a href="#l56.2"></a><span id="l56.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_offlineDraftDataloss.js</span>
<a href="#l56.3"></a><span id="l56.3" class="difflineat">@@ -4,16 +4,18 @@</span>
<a href="#l56.4"></a><span id="l56.4"> </span>
<a href="#l56.5"></a><span id="l56.5"> /**</span>
<a href="#l56.6"></a><span id="l56.6">  * This file tests that a message saved as draft in an IMAP folder in offline</span>
<a href="#l56.7"></a><span id="l56.7">  * mode is not lost when going back online</span>
<a href="#l56.8"></a><span id="l56.8">  * See Bug 805626</span>
<a href="#l56.9"></a><span id="l56.9">  */</span>
<a href="#l56.10"></a><span id="l56.10"> </span>
<a href="#l56.11"></a><span id="l56.11"> // async support</span>
<a href="#l56.12"></a><span id="l56.12" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l56.13"></a><span id="l56.13" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l56.14"></a><span id="l56.14"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l56.15"></a><span id="l56.15"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l56.16"></a><span id="l56.16"> </span>
<a href="#l56.17"></a><span id="l56.17"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l56.18"></a><span id="l56.18"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l56.19"></a><span id="l56.19"> </span>
<a href="#l56.20"></a><span id="l56.20"> // IMAP pump</span>
<a href="#l56.21"></a><span id="l56.21"> </span>
<a href="#l56.22"></a><span id="l56.22" class="difflineat">@@ -22,49 +24,46 @@ setupIMAPPump();</span>
<a href="#l56.23"></a><span id="l56.23"> // Definition of tests</span>
<a href="#l56.24"></a><span id="l56.24"> </span>
<a href="#l56.25"></a><span id="l56.25"> var tests = [</span>
<a href="#l56.26"></a><span id="l56.26">   createDraftsFolder,</span>
<a href="#l56.27"></a><span id="l56.27">   goOffline,</span>
<a href="#l56.28"></a><span id="l56.28">   saveDraft,</span>
<a href="#l56.29"></a><span id="l56.29">   goOnline,</span>
<a href="#l56.30"></a><span id="l56.30">   checkResult,</span>
<a href="#l56.31"></a><span id="l56.31" class="difflineminus">-  endTest</span>
<a href="#l56.32"></a><span id="l56.32" class="difflineplus">+  endTest,</span>
<a href="#l56.33"></a><span id="l56.33"> ];</span>
<a href="#l56.34"></a><span id="l56.34"> </span>
<a href="#l56.35"></a><span id="l56.35"> var gDraftsFolder;</span>
<a href="#l56.36"></a><span id="l56.36"> </span>
<a href="#l56.37"></a><span id="l56.37" class="difflineminus">-function* createDraftsFolder()</span>
<a href="#l56.38"></a><span id="l56.38" class="difflineminus">-{</span>
<a href="#l56.39"></a><span id="l56.39" class="difflineplus">+function* createDraftsFolder() {</span>
<a href="#l56.40"></a><span id="l56.40">   IMAPPump.incomingServer.rootFolder.createSubfolder(&quot;Drafts&quot;, null);</span>
<a href="#l56.41"></a><span id="l56.41">   yield false;</span>
<a href="#l56.42"></a><span id="l56.42">   gDraftsFolder = IMAPPump.incomingServer.rootFolder.getChildNamed(&quot;Drafts&quot;);</span>
<a href="#l56.43"></a><span id="l56.43">   Assert.ok(gDraftsFolder instanceof Ci.nsIMsgImapMailFolder);</span>
<a href="#l56.44"></a><span id="l56.44">   gDraftsFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l56.45"></a><span id="l56.45">   yield false;</span>
<a href="#l56.46"></a><span id="l56.46"> }</span>
<a href="#l56.47"></a><span id="l56.47" class="difflineminus">-function* goOffline()</span>
<a href="#l56.48"></a><span id="l56.48" class="difflineminus">-{</span>
<a href="#l56.49"></a><span id="l56.49" class="difflineplus">+function* goOffline() {</span>
<a href="#l56.50"></a><span id="l56.50">   // Don't prompt about offline download when going offline</span>
<a href="#l56.51"></a><span id="l56.51">   Services.prefs.setIntPref(&quot;offline.download.download_messages&quot;, 2);</span>
<a href="#l56.52"></a><span id="l56.52"> </span>
<a href="#l56.53"></a><span id="l56.53">   IMAPPump.incomingServer.closeCachedConnections();</span>
<a href="#l56.54"></a><span id="l56.54">   let thread = gThreadManager.currentThread;</span>
<a href="#l56.55"></a><span id="l56.55">   while (thread.hasPendingEvents())</span>
<a href="#l56.56"></a><span id="l56.56">     thread.processNextEvent(true);</span>
<a href="#l56.57"></a><span id="l56.57"> </span>
<a href="#l56.58"></a><span id="l56.58">   do_timeout(2000, async_driver);</span>
<a href="#l56.59"></a><span id="l56.59">   yield false;</span>
<a href="#l56.60"></a><span id="l56.60"> </span>
<a href="#l56.61"></a><span id="l56.61">   IMAPPump.server.stop();</span>
<a href="#l56.62"></a><span id="l56.62">   Services.io.offline = true;</span>
<a href="#l56.63"></a><span id="l56.63"> }</span>
<a href="#l56.64"></a><span id="l56.64"> </span>
<a href="#l56.65"></a><span id="l56.65" class="difflineminus">-function* saveDraft()</span>
<a href="#l56.66"></a><span id="l56.66" class="difflineminus">-{</span>
<a href="#l56.67"></a><span id="l56.67" class="difflineplus">+function* saveDraft() {</span>
<a href="#l56.68"></a><span id="l56.68">   let msgCompose = Cc[&quot;@mozilla.org/messengercompose/compose;1&quot;]</span>
<a href="#l56.69"></a><span id="l56.69">                      .createInstance(Ci.nsIMsgCompose);</span>
<a href="#l56.70"></a><span id="l56.70">   let fields = Cc[&quot;@mozilla.org/messengercompose/composefields;1&quot;]</span>
<a href="#l56.71"></a><span id="l56.71">                  .createInstance(Ci.nsIMsgCompFields);</span>
<a href="#l56.72"></a><span id="l56.72">   let params = Cc[&quot;@mozilla.org/messengercompose/composeparams;1&quot;]</span>
<a href="#l56.73"></a><span id="l56.73">                  .createInstance(Ci.nsIMsgComposeParams);</span>
<a href="#l56.74"></a><span id="l56.74">   params.composeFields = fields;</span>
<a href="#l56.75"></a><span id="l56.75">   msgCompose.initialize(params);</span>
<a href="#l56.76"></a><span id="l56.76" class="difflineat">@@ -78,108 +77,98 @@ function* saveDraft()</span>
<a href="#l56.77"></a><span id="l56.77">   progress.registerListener(progressListener);</span>
<a href="#l56.78"></a><span id="l56.78">   msgCompose.SendMsg(Ci.nsIMsgSend.nsMsgSaveAsDraft, identity, &quot;&quot;, null,</span>
<a href="#l56.79"></a><span id="l56.79">                      progress);</span>
<a href="#l56.80"></a><span id="l56.80">   yield false;</span>
<a href="#l56.81"></a><span id="l56.81">   // verify that message is not on the server yet</span>
<a href="#l56.82"></a><span id="l56.82">   Assert.equal(IMAPPump.daemon.getMailbox(&quot;Drafts&quot;)._messages.length, 0);</span>
<a href="#l56.83"></a><span id="l56.83"> }</span>
<a href="#l56.84"></a><span id="l56.84"> </span>
<a href="#l56.85"></a><span id="l56.85" class="difflineminus">-function* goOnline()</span>
<a href="#l56.86"></a><span id="l56.86" class="difflineminus">-{</span>
<a href="#l56.87"></a><span id="l56.87" class="difflineplus">+function* goOnline() {</span>
<a href="#l56.88"></a><span id="l56.88">   let offlineManager = Cc[&quot;@mozilla.org/messenger/offline-manager;1&quot;]</span>
<a href="#l56.89"></a><span id="l56.89">                        .getService(Ci.nsIMsgOfflineManager);</span>
<a href="#l56.90"></a><span id="l56.90">   IMAPPump.daemon.closing = false;</span>
<a href="#l56.91"></a><span id="l56.91">   Services.io.offline = false;</span>
<a href="#l56.92"></a><span id="l56.92"> </span>
<a href="#l56.93"></a><span id="l56.93">   IMAPPump.server.start();</span>
<a href="#l56.94"></a><span id="l56.94">   offlineManager.inProgress = true;</span>
<a href="#l56.95"></a><span id="l56.95">   offlineManager.goOnline(false, true, null);</span>
<a href="#l56.96"></a><span id="l56.96" class="difflineminus">-  let waitForNotInProgress = function () {</span>
<a href="#l56.97"></a><span id="l56.97" class="difflineplus">+  let waitForNotInProgress = function() {</span>
<a href="#l56.98"></a><span id="l56.98">     if (offlineManager.inProgress)</span>
<a href="#l56.99"></a><span id="l56.99">       do_timeout(250, waitForNotInProgress);</span>
<a href="#l56.100"></a><span id="l56.100">     else</span>
<a href="#l56.101"></a><span id="l56.101">       async_driver();</span>
<a href="#l56.102"></a><span id="l56.102" class="difflineminus">-  }</span>
<a href="#l56.103"></a><span id="l56.103" class="difflineplus">+  };</span>
<a href="#l56.104"></a><span id="l56.104">   waitForNotInProgress();</span>
<a href="#l56.105"></a><span id="l56.105">   yield false;</span>
<a href="#l56.106"></a><span id="l56.106"> }</span>
<a href="#l56.107"></a><span id="l56.107"> </span>
<a href="#l56.108"></a><span id="l56.108" class="difflineminus">-function* checkResult()</span>
<a href="#l56.109"></a><span id="l56.109" class="difflineminus">-{</span>
<a href="#l56.110"></a><span id="l56.110" class="difflineplus">+function* checkResult() {</span>
<a href="#l56.111"></a><span id="l56.111">   // verify that message is now on the server</span>
<a href="#l56.112"></a><span id="l56.112">   Assert.equal(IMAPPump.daemon.getMailbox(&quot;Drafts&quot;)._messages.length, 1);</span>
<a href="#l56.113"></a><span id="l56.113">   yield true;</span>
<a href="#l56.114"></a><span id="l56.114"> }</span>
<a href="#l56.115"></a><span id="l56.115"> </span>
<a href="#l56.116"></a><span id="l56.116" class="difflineminus">-function* endTest()</span>
<a href="#l56.117"></a><span id="l56.117" class="difflineminus">-{</span>
<a href="#l56.118"></a><span id="l56.118" class="difflineplus">+function* endTest() {</span>
<a href="#l56.119"></a><span id="l56.119">   teardownIMAPPump();</span>
<a href="#l56.120"></a><span id="l56.120">   yield true;</span>
<a href="#l56.121"></a><span id="l56.121"> }</span>
<a href="#l56.122"></a><span id="l56.122"> </span>
<a href="#l56.123"></a><span id="l56.123" class="difflineminus">-function run_test()</span>
<a href="#l56.124"></a><span id="l56.124" class="difflineminus">-{</span>
<a href="#l56.125"></a><span id="l56.125" class="difflineplus">+function run_test() {</span>
<a href="#l56.126"></a><span id="l56.126">   Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l56.127"></a><span id="l56.127" class="difflineminus">-  let server = IMAPPump.incomingServer;</span>
<a href="#l56.128"></a><span id="l56.128"> </span>
<a href="#l56.129"></a><span id="l56.129">   // Add folder listeners that will capture async events</span>
<a href="#l56.130"></a><span id="l56.130">   const nsIMFNService = Ci.nsIMsgFolderNotificationService;</span>
<a href="#l56.131"></a><span id="l56.131"> </span>
<a href="#l56.132"></a><span id="l56.132">   let flags =</span>
<a href="#l56.133"></a><span id="l56.133">         nsIMFNService.msgsMoveCopyCompleted |</span>
<a href="#l56.134"></a><span id="l56.134">         nsIMFNService.folderAdded |</span>
<a href="#l56.135"></a><span id="l56.135">         nsIMFNService.msgAdded;</span>
<a href="#l56.136"></a><span id="l56.136">   MailServices.mfn.addListener(mfnListener, flags);</span>
<a href="#l56.137"></a><span id="l56.137"> </span>
<a href="#l56.138"></a><span id="l56.138" class="difflineminus">-  //start first test</span>
<a href="#l56.139"></a><span id="l56.139" class="difflineplus">+  // start first test</span>
<a href="#l56.140"></a><span id="l56.140">   async_run_tests(tests);</span>
<a href="#l56.141"></a><span id="l56.141"> }</span>
<a href="#l56.142"></a><span id="l56.142"> </span>
<a href="#l56.143"></a><span id="l56.143" class="difflineminus">-var mfnListener =</span>
<a href="#l56.144"></a><span id="l56.144" class="difflineminus">-{</span>
<a href="#l56.145"></a><span id="l56.145" class="difflineminus">-  msgsMoveCopyCompleted: function (aMove, aSrcMsgs, aDestFolder, aDestMsgs)</span>
<a href="#l56.146"></a><span id="l56.146" class="difflineminus">-  {</span>
<a href="#l56.147"></a><span id="l56.147" class="difflineminus">-    dl('msgsMoveCopyCompleted to folder ' + aDestFolder.name);</span>
<a href="#l56.148"></a><span id="l56.148" class="difflineplus">+var mfnListener = {</span>
<a href="#l56.149"></a><span id="l56.149" class="difflineplus">+  msgsMoveCopyCompleted(aMove, aSrcMsgs, aDestFolder, aDestMsgs) {</span>
<a href="#l56.150"></a><span id="l56.150" class="difflineplus">+    dl(&quot;msgsMoveCopyCompleted to folder &quot; + aDestFolder.name);</span>
<a href="#l56.151"></a><span id="l56.151">   },</span>
<a href="#l56.152"></a><span id="l56.152"> </span>
<a href="#l56.153"></a><span id="l56.153" class="difflineminus">-  folderAdded: function (aFolder)</span>
<a href="#l56.154"></a><span id="l56.154" class="difflineminus">-  {</span>
<a href="#l56.155"></a><span id="l56.155" class="difflineminus">-    dl('folderAdded &lt;' + aFolder.name + '&gt;');</span>
<a href="#l56.156"></a><span id="l56.156" class="difflineplus">+  folderAdded(aFolder) {</span>
<a href="#l56.157"></a><span id="l56.157" class="difflineplus">+    dl(&quot;folderAdded &lt;&quot; + aFolder.name + &quot;&gt;&quot;);</span>
<a href="#l56.158"></a><span id="l56.158">     // we are only using async add on the Junk folder</span>
<a href="#l56.159"></a><span id="l56.159">     if (aFolder.name == &quot;Drafts&quot;)</span>
<a href="#l56.160"></a><span id="l56.160">       async_driver();</span>
<a href="#l56.161"></a><span id="l56.161">   },</span>
<a href="#l56.162"></a><span id="l56.162"> </span>
<a href="#l56.163"></a><span id="l56.163" class="difflineminus">-  msgAdded: function msgAdded(aMsg)</span>
<a href="#l56.164"></a><span id="l56.164" class="difflineminus">-  {</span>
<a href="#l56.165"></a><span id="l56.165" class="difflineminus">-    dl('msgAdded with subject &lt;' + aMsg.subject + '&gt;');</span>
<a href="#l56.166"></a><span id="l56.166" class="difflineminus">-  }</span>
<a href="#l56.167"></a><span id="l56.167" class="difflineplus">+  msgAdded(aMsg) {</span>
<a href="#l56.168"></a><span id="l56.168" class="difflineplus">+    dl(&quot;msgAdded with subject &lt;&quot; + aMsg.subject + &quot;&gt;&quot;);</span>
<a href="#l56.169"></a><span id="l56.169" class="difflineplus">+  },</span>
<a href="#l56.170"></a><span id="l56.170"> };</span>
<a href="#l56.171"></a><span id="l56.171"> </span>
<a href="#l56.172"></a><span id="l56.172"> var progressListener = {</span>
<a href="#l56.173"></a><span id="l56.173" class="difflineminus">-  onStateChange: function(aWebProgress, aRequest, aStateFlags, aStatus) {</span>
<a href="#l56.174"></a><span id="l56.174" class="difflineminus">-    if (aStateFlags &amp; Ci.nsIWebProgressListener.STATE_STOP){</span>
<a href="#l56.175"></a><span id="l56.175" class="difflineminus">-      dl('onStateChange');</span>
<a href="#l56.176"></a><span id="l56.176" class="difflineplus">+  onStateChange(aWebProgress, aRequest, aStateFlags, aStatus) {</span>
<a href="#l56.177"></a><span id="l56.177" class="difflineplus">+    if (aStateFlags &amp; Ci.nsIWebProgressListener.STATE_STOP) {</span>
<a href="#l56.178"></a><span id="l56.178" class="difflineplus">+      dl(&quot;onStateChange&quot;);</span>
<a href="#l56.179"></a><span id="l56.179">       async_driver();</span>
<a href="#l56.180"></a><span id="l56.180">     }</span>
<a href="#l56.181"></a><span id="l56.181">   },</span>
<a href="#l56.182"></a><span id="l56.182"> </span>
<a href="#l56.183"></a><span id="l56.183" class="difflineminus">-  onProgressChange: function(aWebProgress, aRequest, aCurSelfProgress,</span>
<a href="#l56.184"></a><span id="l56.184" class="difflineminus">-                             aMaxSelfProgress, aCurTotalProgress,</span>
<a href="#l56.185"></a><span id="l56.185" class="difflineminus">-                             aMaxTotalProgress) {},</span>
<a href="#l56.186"></a><span id="l56.186" class="difflineminus">-  onLocationChange: function(aWebProgress, aRequest, aLocation, aFlags) {},</span>
<a href="#l56.187"></a><span id="l56.187" class="difflineminus">-  onStatusChange: function(aWebProgress, aRequest, aStatus, aMessage) {},</span>
<a href="#l56.188"></a><span id="l56.188" class="difflineminus">-  onSecurityChange: function(aWebProgress, aRequest, state) {},</span>
<a href="#l56.189"></a><span id="l56.189" class="difflineminus">-  onContentBlockingEvent: function(aWebProgress, aRequest, aEvent) {},</span>
<a href="#l56.190"></a><span id="l56.190" class="difflineplus">+  onProgressChange(aWebProgress, aRequest, aCurSelfProgress, aMaxSelfProgress,</span>
<a href="#l56.191"></a><span id="l56.191" class="difflineplus">+                   aCurTotalProgress, aMaxTotalProgress) {},</span>
<a href="#l56.192"></a><span id="l56.192" class="difflineplus">+  onLocationChange(aWebProgress, aRequest, aLocation, aFlags) {},</span>
<a href="#l56.193"></a><span id="l56.193" class="difflineplus">+  onStatusChange(aWebProgress, aRequest, aStatus, aMessage) {},</span>
<a href="#l56.194"></a><span id="l56.194" class="difflineplus">+  onSecurityChange(aWebProgress, aRequest, state) {},</span>
<a href="#l56.195"></a><span id="l56.195" class="difflineplus">+  onContentBlockingEvent(aWebProgress, aRequest, aEvent) {},</span>
<a href="#l56.196"></a><span id="l56.196"> </span>
<a href="#l56.197"></a><span id="l56.197">   QueryInterface: ChromeUtils.generateQI([&quot;nsIWebProgressListener&quot;,</span>
<a href="#l56.198"></a><span id="l56.198">                                           &quot;nsISupportsWeakReference&quot;]),</span>
<a href="#l56.199"></a><span id="l56.199"> };</span>
<a href="#l56.200"></a><span id="l56.200"> </span>
<a href="#l56.201"></a><span id="l56.201"> /*</span>
<a href="#l56.202"></a><span id="l56.202">  * helper functions</span>
<a href="#l56.203"></a><span id="l56.203">  */</span>
<a href="#l56.204"></a><span id="l56.204"> </span>
<a href="#l56.205"></a><span id="l56.205"> // quick shorthand for output of a line of text.</span>
<a href="#l56.206"></a><span id="l56.206"> function dl(text) {</span>
<a href="#l56.207"></a><span id="l56.207" class="difflineminus">-  dump(text + '\n');</span>
<a href="#l56.208"></a><span id="l56.208" class="difflineplus">+  dump(text + &quot;\n&quot;);</span>
<a href="#l56.209"></a><span id="l56.209"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l57.1"></a><span id="l57.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_offlinePlayback.js</span>
<a href="#l57.2"></a><span id="l57.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_offlinePlayback.js</span>
<a href="#l57.3"></a><span id="l57.3" class="difflineat">@@ -2,16 +2,17 @@</span>
<a href="#l57.4"></a><span id="l57.4"> /*</span>
<a href="#l57.5"></a><span id="l57.5">  * Test to ensure that changes made while offline are played back when we</span>
<a href="#l57.6"></a><span id="l57.6">  * go back online.</span>
<a href="#l57.7"></a><span id="l57.7">  */</span>
<a href="#l57.8"></a><span id="l57.8"> </span>
<a href="#l57.9"></a><span id="l57.9"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l57.10"></a><span id="l57.10"> var {PromiseTestUtils} = ChromeUtils.import(&quot;resource://testing-common/mailnews/PromiseTestUtils.jsm&quot;);</span>
<a href="#l57.11"></a><span id="l57.11"> </span>
<a href="#l57.12"></a><span id="l57.12" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l57.13"></a><span id="l57.13"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l57.14"></a><span id="l57.14"> </span>
<a href="#l57.15"></a><span id="l57.15"> var gSecondFolder, gThirdFolder;</span>
<a href="#l57.16"></a><span id="l57.16"> var gSynthMessage1, gSynthMessage2;</span>
<a href="#l57.17"></a><span id="l57.17"> // the message id of bugmail10</span>
<a href="#l57.18"></a><span id="l57.18"> var gMsgId1 = &quot;200806061706.m56H6RWT004933@mrapp54.mozilla.org&quot;;</span>
<a href="#l57.19"></a><span id="l57.19"> var gOfflineManager;</span>
<a href="#l57.20"></a><span id="l57.20"> </span>
<a href="#l57.21"></a><span id="l57.21" class="difflineat">@@ -21,19 +22,19 @@ var tests = [</span>
<a href="#l57.22"></a><span id="l57.22">     var {fsDebugAll} = ChromeUtils.import(&quot;resource://testing-common/mailnews/maild.js&quot;);</span>
<a href="#l57.23"></a><span id="l57.23">     IMAPPump.server.setDebugLevel(fsDebugAll);</span>
<a href="#l57.24"></a><span id="l57.24">   },</span>
<a href="#l57.25"></a><span id="l57.25">   setup,</span>
<a href="#l57.26"></a><span id="l57.26"> </span>
<a href="#l57.27"></a><span id="l57.27">   function prepareToGoOffline() {</span>
<a href="#l57.28"></a><span id="l57.28">     let rootFolder = IMAPPump.incomingServer.rootFolder;</span>
<a href="#l57.29"></a><span id="l57.29">     gSecondFolder = rootFolder.getChildNamed(&quot;secondFolder&quot;)</span>
<a href="#l57.30"></a><span id="l57.30" class="difflineminus">-                      .QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l57.31"></a><span id="l57.31" class="difflineminus">-    gThirdFolder =  rootFolder.getChildNamed(&quot;thirdFolder&quot;)</span>
<a href="#l57.32"></a><span id="l57.32" class="difflineminus">-                      .QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l57.33"></a><span id="l57.33" class="difflineplus">+                              .QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l57.34"></a><span id="l57.34" class="difflineplus">+    gThirdFolder = rootFolder.getChildNamed(&quot;thirdFolder&quot;)</span>
<a href="#l57.35"></a><span id="l57.35" class="difflineplus">+                             .QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l57.36"></a><span id="l57.36">     IMAPPump.incomingServer.closeCachedConnections();</span>
<a href="#l57.37"></a><span id="l57.37">   },</span>
<a href="#l57.38"></a><span id="l57.38">   async function doOfflineOps() {</span>
<a href="#l57.39"></a><span id="l57.39">     IMAPPump.server.stop();</span>
<a href="#l57.40"></a><span id="l57.40">     Services.io.offline = true;</span>
<a href="#l57.41"></a><span id="l57.41"> </span>
<a href="#l57.42"></a><span id="l57.42">     // Flag the two messages, and then copy them to different folders. Since</span>
<a href="#l57.43"></a><span id="l57.43">     // we're offline, these operations are synchronous.</span>
<a href="#l57.44"></a><span id="l57.44" class="difflineat">@@ -89,42 +90,41 @@ var tests = [</span>
<a href="#l57.45"></a><span id="l57.45">   function checkDone() {</span>
<a href="#l57.46"></a><span id="l57.46">     let msgHdr1 = gSecondFolder.msgDatabase.getMsgHdrForMessageID(gSynthMessage1.messageId);</span>
<a href="#l57.47"></a><span id="l57.47">     let msgHdr2 = gThirdFolder.msgDatabase.getMsgHdrForMessageID(gSynthMessage2.messageId);</span>
<a href="#l57.48"></a><span id="l57.48">     let msgHdr3 = IMAPPump.inbox.msgDatabase.getMsgHdrForMessageID(gMsgId1);</span>
<a href="#l57.49"></a><span id="l57.49">     Assert.notEqual(msgHdr1, null);</span>
<a href="#l57.50"></a><span id="l57.50">     Assert.notEqual(msgHdr2, null);</span>
<a href="#l57.51"></a><span id="l57.51">     Assert.notEqual(msgHdr3, null);</span>
<a href="#l57.52"></a><span id="l57.52">   },</span>
<a href="#l57.53"></a><span id="l57.53" class="difflineminus">-  teardownIMAPPump</span>
<a href="#l57.54"></a><span id="l57.54" class="difflineplus">+  teardownIMAPPump,</span>
<a href="#l57.55"></a><span id="l57.55"> ];</span>
<a href="#l57.56"></a><span id="l57.56"> </span>
<a href="#l57.57"></a><span id="l57.57"> async function setup() {</span>
<a href="#l57.58"></a><span id="l57.58" class="difflineminus">-</span>
<a href="#l57.59"></a><span id="l57.59">   /*</span>
<a href="#l57.60"></a><span id="l57.60">    * Set up an IMAP server.</span>
<a href="#l57.61"></a><span id="l57.61">    */</span>
<a href="#l57.62"></a><span id="l57.62" class="difflineminus">-  IMAPPump.daemon.createMailbox(&quot;secondFolder&quot;, {subscribed : true});</span>
<a href="#l57.63"></a><span id="l57.63" class="difflineminus">-  IMAPPump.daemon.createMailbox(&quot;thirdFolder&quot;, {subscribed : true});</span>
<a href="#l57.64"></a><span id="l57.64" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;secondFolder&quot;, {subscribed: true});</span>
<a href="#l57.65"></a><span id="l57.65" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;thirdFolder&quot;, {subscribed: true});</span>
<a href="#l57.66"></a><span id="l57.66">   Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l57.67"></a><span id="l57.67">   // Don't prompt about offline download when going offline</span>
<a href="#l57.68"></a><span id="l57.68">   Services.prefs.setIntPref(&quot;offline.download.download_messages&quot;, 2);</span>
<a href="#l57.69"></a><span id="l57.69"> </span>
<a href="#l57.70"></a><span id="l57.70">   // make a couple of messages</span>
<a href="#l57.71"></a><span id="l57.71">   let messages = [];</span>
<a href="#l57.72"></a><span id="l57.72">   let gMessageGenerator = new MessageGenerator();</span>
<a href="#l57.73"></a><span id="l57.73">   messages = messages.concat(gMessageGenerator.makeMessage());</span>
<a href="#l57.74"></a><span id="l57.74">   messages = messages.concat(gMessageGenerator.makeMessage());</span>
<a href="#l57.75"></a><span id="l57.75">   gSynthMessage1 = messages[0];</span>
<a href="#l57.76"></a><span id="l57.76">   gSynthMessage2 = messages[1];</span>
<a href="#l57.77"></a><span id="l57.77"> </span>
<a href="#l57.78"></a><span id="l57.78">   let msgURI =</span>
<a href="#l57.79"></a><span id="l57.79">     Services.io.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l57.80"></a><span id="l57.80">                        btoa(messages[0].toMessageString()));</span>
<a href="#l57.81"></a><span id="l57.81" class="difflineminus">-  let imapInbox =  IMAPPump.daemon.getMailbox(&quot;INBOX&quot;)</span>
<a href="#l57.82"></a><span id="l57.82" class="difflineplus">+  let imapInbox = IMAPPump.daemon.getMailbox(&quot;INBOX&quot;);</span>
<a href="#l57.83"></a><span id="l57.83">   let message = new imapMessage(msgURI.spec, imapInbox.uidnext++, [&quot;\\Seen&quot;]);</span>
<a href="#l57.84"></a><span id="l57.84">   imapInbox.addMessage(message);</span>
<a href="#l57.85"></a><span id="l57.85">   msgURI =</span>
<a href="#l57.86"></a><span id="l57.86">     Services.io.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l57.87"></a><span id="l57.87">                        btoa(messages[1].toMessageString()));</span>
<a href="#l57.88"></a><span id="l57.88">   message = new imapMessage(msgURI.spec, imapInbox.uidnext++, [&quot;\\Seen&quot;]);</span>
<a href="#l57.89"></a><span id="l57.89">   imapInbox.addMessage(message);</span>
<a href="#l57.90"></a><span id="l57.90"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l58.1"></a><span id="l58.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_offlineStoreLocking.js</span>
<a href="#l58.2"></a><span id="l58.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_offlineStoreLocking.js</span>
<a href="#l58.3"></a><span id="l58.3" class="difflineat">@@ -1,68 +1,47 @@</span>
<a href="#l58.4"></a><span id="l58.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l58.5"></a><span id="l58.5"> /*</span>
<a href="#l58.6"></a><span id="l58.6">  * Test to ensure that code that writes to the imap offline store deals</span>
<a href="#l58.7"></a><span id="l58.7">  * with offline store locking correctly.</span>
<a href="#l58.8"></a><span id="l58.8">  */</span>
<a href="#l58.9"></a><span id="l58.9"> </span>
<a href="#l58.10"></a><span id="l58.10" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l58.11"></a><span id="l58.11" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l58.12"></a><span id="l58.12" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l58.13"></a><span id="l58.13" class="difflineplus">+/* import-globals-from ../../../test/resources/alertTestUtils.js */</span>
<a href="#l58.14"></a><span id="l58.14"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l58.15"></a><span id="l58.15"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l58.16"></a><span id="l58.16"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l58.17"></a><span id="l58.17"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l58.18"></a><span id="l58.18"> </span>
<a href="#l58.19"></a><span id="l58.19"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l58.20"></a><span id="l58.20" class="difflineminus">-var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l58.21"></a><span id="l58.21" class="difflineminus">-</span>
<a href="#l58.22"></a><span id="l58.22"> </span>
<a href="#l58.23"></a><span id="l58.23"> // Globals</span>
<a href="#l58.24"></a><span id="l58.24"> var gIMAPTrashFolder, gMsgImapInboxFolder;</span>
<a href="#l58.25"></a><span id="l58.25"> var gGotAlert = false;</span>
<a href="#l58.26"></a><span id="l58.26"> var gMovedMsgId;</span>
<a href="#l58.27"></a><span id="l58.27"> </span>
<a href="#l58.28"></a><span id="l58.28" class="difflineplus">+/* exported alert */// to alertTestUtils.js</span>
<a href="#l58.29"></a><span id="l58.29"> function alert(aDialogTitle, aText) {</span>
<a href="#l58.30"></a><span id="l58.30"> //  do_check_true(aText.startsWith(&quot;Connection to server Mail for  timed out.&quot;));</span>
<a href="#l58.31"></a><span id="l58.31">   gGotAlert = true;</span>
<a href="#l58.32"></a><span id="l58.32"> }</span>
<a href="#l58.33"></a><span id="l58.33"> </span>
<a href="#l58.34"></a><span id="l58.34" class="difflineminus">-function addGeneratedMessagesToServer(messages, mailbox)</span>
<a href="#l58.35"></a><span id="l58.35" class="difflineminus">-{</span>
<a href="#l58.36"></a><span id="l58.36" class="difflineplus">+function addGeneratedMessagesToServer(messages, mailbox) {</span>
<a href="#l58.37"></a><span id="l58.37">   // Create the imapMessages and store them on the mailbox</span>
<a href="#l58.38"></a><span id="l58.38" class="difflineminus">-  messages.forEach(function (message)</span>
<a href="#l58.39"></a><span id="l58.39" class="difflineminus">-  {</span>
<a href="#l58.40"></a><span id="l58.40" class="difflineplus">+  messages.forEach(function(message) {</span>
<a href="#l58.41"></a><span id="l58.41">     let dataUri = Services.io.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l58.42"></a><span id="l58.42">                                      btoa(message.toMessageString()));</span>
<a href="#l58.43"></a><span id="l58.43">     mailbox.addMessage(new imapMessage(dataUri.spec, mailbox.uidnext++, []));</span>
<a href="#l58.44"></a><span id="l58.44">   });</span>
<a href="#l58.45"></a><span id="l58.45"> }</span>
<a href="#l58.46"></a><span id="l58.46"> </span>
<a href="#l58.47"></a><span id="l58.47"> var gStreamedHdr = null;</span>
<a href="#l58.48"></a><span id="l58.48"> </span>
<a href="#l58.49"></a><span id="l58.49" class="difflineminus">-function checkOfflineStore(prevOfflineStoreSize) {</span>
<a href="#l58.50"></a><span id="l58.50" class="difflineminus">-  dump(&quot;checking offline store\n&quot;);</span>
<a href="#l58.51"></a><span id="l58.51" class="difflineminus">-  let offset = new Object;</span>
<a href="#l58.52"></a><span id="l58.52" class="difflineminus">-  let size = new Object;</span>
<a href="#l58.53"></a><span id="l58.53" class="difflineminus">-  let enumerator = IMAPPump.inbox.msgDatabase.EnumerateMessages();</span>
<a href="#l58.54"></a><span id="l58.54" class="difflineminus">-  if (enumerator)</span>
<a href="#l58.55"></a><span id="l58.55" class="difflineminus">-  {</span>
<a href="#l58.56"></a><span id="l58.56" class="difflineminus">-    while (enumerator.hasMoreElements())</span>
<a href="#l58.57"></a><span id="l58.57" class="difflineminus">-    {</span>
<a href="#l58.58"></a><span id="l58.58" class="difflineminus">-      let header = enumerator.getNext();</span>
<a href="#l58.59"></a><span id="l58.59" class="difflineminus">-      // this will verify that the message in the offline store</span>
<a href="#l58.60"></a><span id="l58.60" class="difflineminus">-      // starts with &quot;From &quot; - otherwise, it returns an error.</span>
<a href="#l58.61"></a><span id="l58.61" class="difflineminus">-      if (header instanceof Ci.nsIMsgDBHdr &amp;&amp;</span>
<a href="#l58.62"></a><span id="l58.62" class="difflineminus">-         (header.flags &amp; Ci.nsMsgMessageFlags.Offline))</span>
<a href="#l58.63"></a><span id="l58.63" class="difflineminus">-        IMAPPump.inbox.getOfflineFileStream(header.messageKey, offset, size).close();</span>
<a href="#l58.64"></a><span id="l58.64" class="difflineminus">-    }</span>
<a href="#l58.65"></a><span id="l58.65" class="difflineminus">-  }</span>
<a href="#l58.66"></a><span id="l58.66" class="difflineminus">-  // check that the offline store shrunk by at least 100 bytes.</span>
<a href="#l58.67"></a><span id="l58.67" class="difflineminus">-  // (exact calculation might be fragile).</span>
<a href="#l58.68"></a><span id="l58.68" class="difflineminus">-  Assert.ok(prevOfflineStoreSize &gt; IMAPPump.inbox.filePath.fileSize + 100);</span>
<a href="#l58.69"></a><span id="l58.69" class="difflineminus">-}</span>
<a href="#l58.70"></a><span id="l58.70" class="difflineminus">-</span>
<a href="#l58.71"></a><span id="l58.71"> var tests = [</span>
<a href="#l58.72"></a><span id="l58.72">   setup,</span>
<a href="#l58.73"></a><span id="l58.73">   function* downloadForOffline() {</span>
<a href="#l58.74"></a><span id="l58.74">     // ...and download for offline use.</span>
<a href="#l58.75"></a><span id="l58.75">     dump(&quot;Downloading for offline use\n&quot;);</span>
<a href="#l58.76"></a><span id="l58.76">     IMAPPump.inbox.downloadAllForOffline(asyncUrlListener, null);</span>
<a href="#l58.77"></a><span id="l58.77">     yield false;</span>
<a href="#l58.78"></a><span id="l58.78">   },</span>
<a href="#l58.79"></a><span id="l58.79" class="difflineat">@@ -125,93 +104,91 @@ var tests = [</span>
<a href="#l58.80"></a><span id="l58.80">   },</span>
<a href="#l58.81"></a><span id="l58.81">   function testOfflineBodyCopy() {</span>
<a href="#l58.82"></a><span id="l58.82">     // In order to check that offline copy of messages doesn't try to copy</span>
<a href="#l58.83"></a><span id="l58.83">     // the body if the offline store is locked, we're going to go offline.</span>
<a href="#l58.84"></a><span id="l58.84">     // Thunderbird itself does move/copies pseudo-offline, but that's too</span>
<a href="#l58.85"></a><span id="l58.85">     // hard to test because of the half-second delay.</span>
<a href="#l58.86"></a><span id="l58.86">     IMAPPump.server.stop();</span>
<a href="#l58.87"></a><span id="l58.87">     Services.io.offline = true;</span>
<a href="#l58.88"></a><span id="l58.88" class="difflineminus">-    let trashHdr;</span>
<a href="#l58.89"></a><span id="l58.89">     let enumerator = gIMAPTrashFolder.msgDatabase.EnumerateMessages();</span>
<a href="#l58.90"></a><span id="l58.90">     let msgHdr = enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l58.91"></a><span id="l58.91">     gMovedMsgId = msgHdr.messageId;</span>
<a href="#l58.92"></a><span id="l58.92">     let array = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l58.93"></a><span id="l58.93">     array.appendElement(msgHdr);</span>
<a href="#l58.94"></a><span id="l58.94">     IMAPPump.inbox.compact(asyncUrlListener, gDummyMsgWindow);</span>
<a href="#l58.95"></a><span id="l58.95">     MailServices.copy.CopyMessages(gIMAPTrashFolder, array, IMAPPump.inbox, true,</span>
<a href="#l58.96"></a><span id="l58.96">                                    CopyListener, null, true);</span>
<a href="#l58.97"></a><span id="l58.97">   },</span>
<a href="#l58.98"></a><span id="l58.98">   function* verifyNoOfflineMsg() {</span>
<a href="#l58.99"></a><span id="l58.99">     try {</span>
<a href="#l58.100"></a><span id="l58.100" class="difflineminus">-    let movedMsg = IMAPPump.inbox.msgDatabase.getMsgHdrForMessageID(gMovedMsgId);</span>
<a href="#l58.101"></a><span id="l58.101" class="difflineminus">-    Assert.equal(false, movedMsg.flags &amp; Ci.nsMsgMessageFlags.Offline);</span>
<a href="#l58.102"></a><span id="l58.102" class="difflineminus">-    } catch (ex) {dump(ex);}</span>
<a href="#l58.103"></a><span id="l58.103" class="difflineplus">+      let movedMsg = IMAPPump.inbox.msgDatabase.getMsgHdrForMessageID(gMovedMsgId);</span>
<a href="#l58.104"></a><span id="l58.104" class="difflineplus">+      Assert.equal(false, movedMsg.flags &amp; Ci.nsMsgMessageFlags.Offline);</span>
<a href="#l58.105"></a><span id="l58.105" class="difflineplus">+    } catch (ex) {</span>
<a href="#l58.106"></a><span id="l58.106" class="difflineplus">+      dump(ex);</span>
<a href="#l58.107"></a><span id="l58.107" class="difflineplus">+    }</span>
<a href="#l58.108"></a><span id="l58.108">     yield false;</span>
<a href="#l58.109"></a><span id="l58.109">     yield false;</span>
<a href="#l58.110"></a><span id="l58.110">   },</span>
<a href="#l58.111"></a><span id="l58.111" class="difflineminus">-  teardown</span>
<a href="#l58.112"></a><span id="l58.112" class="difflineplus">+  teardown,</span>
<a href="#l58.113"></a><span id="l58.113"> ];</span>
<a href="#l58.114"></a><span id="l58.114"> </span>
<a href="#l58.115"></a><span id="l58.115"> function run_test() {</span>
<a href="#l58.116"></a><span id="l58.116">   async_run_tests(tests);</span>
<a href="#l58.117"></a><span id="l58.117"> }</span>
<a href="#l58.118"></a><span id="l58.118"> </span>
<a href="#l58.119"></a><span id="l58.119"> function setup() {</span>
<a href="#l58.120"></a><span id="l58.120">   Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l58.121"></a><span id="l58.121"> </span>
<a href="#l58.122"></a><span id="l58.122">   setupIMAPPump();</span>
<a href="#l58.123"></a><span id="l58.123"> </span>
<a href="#l58.124"></a><span id="l58.124">   gMsgImapInboxFolder = IMAPPump.inbox.QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l58.125"></a><span id="l58.125">   // these hacks are required because we've created the inbox before</span>
<a href="#l58.126"></a><span id="l58.126">   // running initial folder discovery, and adding the folder bails</span>
<a href="#l58.127"></a><span id="l58.127">   // out before we set it as verified online, so we bail out, and</span>
<a href="#l58.128"></a><span id="l58.128">   // then remove the INBOX folder since it's not verified.</span>
<a href="#l58.129"></a><span id="l58.129" class="difflineminus">-  gMsgImapInboxFolder.hierarchyDelimiter = '/';</span>
<a href="#l58.130"></a><span id="l58.130" class="difflineplus">+  gMsgImapInboxFolder.hierarchyDelimiter = &quot;/&quot;;</span>
<a href="#l58.131"></a><span id="l58.131">   gMsgImapInboxFolder.verifiedAsOnlineFolder = true;</span>
<a href="#l58.132"></a><span id="l58.132"> </span>
<a href="#l58.133"></a><span id="l58.133">   let messageGenerator = new MessageGenerator();</span>
<a href="#l58.134"></a><span id="l58.134">   let messages = [];</span>
<a href="#l58.135"></a><span id="l58.135">   let bodyString = &quot;&quot;;</span>
<a href="#l58.136"></a><span id="l58.136">   for (let i = 0; i &lt; 100; i++)</span>
<a href="#l58.137"></a><span id="l58.137">     bodyString += &quot;1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890\r\n&quot;;</span>
<a href="#l58.138"></a><span id="l58.138"> </span>
<a href="#l58.139"></a><span id="l58.139">   for (let i = 0; i &lt; 50; i++)</span>
<a href="#l58.140"></a><span id="l58.140">     messages = messages.concat(messageGenerator.makeMessage({body: {body: bodyString, contentType: &quot;text/plain&quot;}}));</span>
<a href="#l58.141"></a><span id="l58.141"> </span>
<a href="#l58.142"></a><span id="l58.142">   addGeneratedMessagesToServer(messages, IMAPPump.daemon.getMailbox(&quot;INBOX&quot;));</span>
<a href="#l58.143"></a><span id="l58.143"> }</span>
<a href="#l58.144"></a><span id="l58.144"> </span>
<a href="#l58.145"></a><span id="l58.145"> // nsIMsgCopyServiceListener implementation - runs next test when copy</span>
<a href="#l58.146"></a><span id="l58.146"> // is completed.</span>
<a href="#l58.147"></a><span id="l58.147" class="difflineminus">-var CopyListener =</span>
<a href="#l58.148"></a><span id="l58.148" class="difflineminus">-{</span>
<a href="#l58.149"></a><span id="l58.149" class="difflineminus">-  OnStartCopy: function() {},</span>
<a href="#l58.150"></a><span id="l58.150" class="difflineminus">-  OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l58.151"></a><span id="l58.151" class="difflineminus">-  SetMessageKey: function(aKey)</span>
<a href="#l58.152"></a><span id="l58.152" class="difflineminus">-  {</span>
<a href="#l58.153"></a><span id="l58.153" class="difflineminus">-    let hdr = localAccountUtils.inboxFolder.GetMessageHeader(aKey);</span>
<a href="#l58.154"></a><span id="l58.154" class="difflineminus">-    gMsgHdrs.push({hdr: hdr, ID: hdr.messageId});</span>
<a href="#l58.155"></a><span id="l58.155" class="difflineminus">-  },</span>
<a href="#l58.156"></a><span id="l58.156" class="difflineminus">-  SetMessageId: function(aMessageId) {},</span>
<a href="#l58.157"></a><span id="l58.157" class="difflineminus">-  OnStopCopy: function(aStatus)</span>
<a href="#l58.158"></a><span id="l58.158" class="difflineminus">-  {</span>
<a href="#l58.159"></a><span id="l58.159" class="difflineplus">+var CopyListener = {</span>
<a href="#l58.160"></a><span id="l58.160" class="difflineplus">+  OnStartCopy() {},</span>
<a href="#l58.161"></a><span id="l58.161" class="difflineplus">+  OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l58.162"></a><span id="l58.162" class="difflineplus">+  SetMessageKey(aKey) {},</span>
<a href="#l58.163"></a><span id="l58.163" class="difflineplus">+  SetMessageId(aMessageId) {},</span>
<a href="#l58.164"></a><span id="l58.164" class="difflineplus">+  OnStopCopy(aStatus) {</span>
<a href="#l58.165"></a><span id="l58.165">     // Check: message successfully copied.</span>
<a href="#l58.166"></a><span id="l58.166">     Assert.equal(aStatus, 0);</span>
<a href="#l58.167"></a><span id="l58.167">     async_driver();</span>
<a href="#l58.168"></a><span id="l58.168" class="difflineminus">-  }</span>
<a href="#l58.169"></a><span id="l58.169" class="difflineplus">+  },</span>
<a href="#l58.170"></a><span id="l58.170"> };</span>
<a href="#l58.171"></a><span id="l58.171"> </span>
<a href="#l58.172"></a><span id="l58.172"> function teardown() {</span>
<a href="#l58.173"></a><span id="l58.173" class="difflineplus">+  Assert.ok(gGotAlert);</span>
<a href="#l58.174"></a><span id="l58.174">   gMsgImapInboxFolder = null;</span>
<a href="#l58.175"></a><span id="l58.175">   gIMAPTrashFolder = null;</span>
<a href="#l58.176"></a><span id="l58.176"> </span>
<a href="#l58.177"></a><span id="l58.177">   // IMAPPump.server has already stopped, we do not need to IMAPPump.server.stop().</span>
<a href="#l58.178"></a><span id="l58.178">   IMAPPump.inbox = null;</span>
<a href="#l58.179"></a><span id="l58.179">   try {</span>
<a href="#l58.180"></a><span id="l58.180">     IMAPPump.incomingServer.closeCachedConnections();</span>
<a href="#l58.181"></a><span id="l58.181">     let serverSink = IMAPPump.incomingServer.QueryInterface(Ci.nsIImapServerSink);</span>
<a href="#l58.182"></a><span id="l58.182">     serverSink.abortQueuedUrls();</span>
<a href="#l58.183"></a><span id="l58.183" class="difflineminus">-  } catch (ex) {dump(ex);}</span>
<a href="#l58.184"></a><span id="l58.184" class="difflineplus">+  } catch (ex) {</span>
<a href="#l58.185"></a><span id="l58.185" class="difflineplus">+    dump(ex);</span>
<a href="#l58.186"></a><span id="l58.186" class="difflineplus">+  }</span>
<a href="#l58.187"></a><span id="l58.187">   let thread = gThreadManager.currentThread;</span>
<a href="#l58.188"></a><span id="l58.188">   while (thread.hasPendingEvents())</span>
<a href="#l58.189"></a><span id="l58.189">     thread.processNextEvent(true);</span>
<a href="#l58.190"></a><span id="l58.190"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l59.1"></a><span id="l59.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_partsOnDemand.js</span>
<a href="#l59.2"></a><span id="l59.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_partsOnDemand.js</span>
<a href="#l59.3"></a><span id="l59.3" class="difflineat">@@ -4,16 +4,19 @@</span>
<a href="#l59.4"></a><span id="l59.4"> </span>
<a href="#l59.5"></a><span id="l59.5"> /*</span>
<a href="#l59.6"></a><span id="l59.6">  * Tests that you can stream a message without the attachments. Tests the</span>
<a href="#l59.7"></a><span id="l59.7">  * MsgHdrToMimeMessage API that exposes this.</span>
<a href="#l59.8"></a><span id="l59.8">  */</span>
<a href="#l59.9"></a><span id="l59.9"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l59.10"></a><span id="l59.10"> Services.prefs.setIntPref(&quot;mail.imap.mime_parts_on_demand_threshold&quot;, 1000);</span>
<a href="#l59.11"></a><span id="l59.11"> </span>
<a href="#l59.12"></a><span id="l59.12" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l59.13"></a><span id="l59.13" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l59.14"></a><span id="l59.14" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l59.15"></a><span id="l59.15"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l59.16"></a><span id="l59.16"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l59.17"></a><span id="l59.17"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l59.18"></a><span id="l59.18"> </span>
<a href="#l59.19"></a><span id="l59.19"> // javascript mime emitter functions</span>
<a href="#l59.20"></a><span id="l59.20"> var mimeMsg = {};</span>
<a href="#l59.21"></a><span id="l59.21"> ChromeUtils.import(&quot;resource:///modules/gloda/mimemsg.js&quot;, mimeMsg);</span>
<a href="#l59.22"></a><span id="l59.22"> </span>
<a href="#l59.23"></a><span id="l59.23" class="difflineat">@@ -25,36 +28,33 @@ setupIMAPPump();</span>
<a href="#l59.24"></a><span id="l59.24"> </span>
<a href="#l59.25"></a><span id="l59.25"> var tests = [</span>
<a href="#l59.26"></a><span id="l59.26">   setPrefs,</span>
<a href="#l59.27"></a><span id="l59.27">   loadImapMessage,</span>
<a href="#l59.28"></a><span id="l59.28">   startMime,</span>
<a href="#l59.29"></a><span id="l59.29">   testAllInlineMessage,</span>
<a href="#l59.30"></a><span id="l59.30">   updateCounts,</span>
<a href="#l59.31"></a><span id="l59.31">   testNotRead,</span>
<a href="#l59.32"></a><span id="l59.32" class="difflineminus">-  endTest</span>
<a href="#l59.33"></a><span id="l59.33" class="difflineminus">-]</span>
<a href="#l59.34"></a><span id="l59.34" class="difflineplus">+  endTest,</span>
<a href="#l59.35"></a><span id="l59.35" class="difflineplus">+];</span>
<a href="#l59.36"></a><span id="l59.36"> </span>
<a href="#l59.37"></a><span id="l59.37"> // make sure we are in the optimal conditions!</span>
<a href="#l59.38"></a><span id="l59.38"> function* setPrefs() {</span>
<a href="#l59.39"></a><span id="l59.39">   Services.prefs.setIntPref(&quot;mail.imap.mime_parts_on_demand_threshold&quot;, 20);</span>
<a href="#l59.40"></a><span id="l59.40">   Services.prefs.setBoolPref(&quot;mail.imap.mime_parts_on_demand&quot;, true);</span>
<a href="#l59.41"></a><span id="l59.41">   Services.prefs.setBoolPref(&quot;mail.server.server1.autosync_offline_stores&quot;, false);</span>
<a href="#l59.42"></a><span id="l59.42">   Services.prefs.setBoolPref(&quot;mail.server.server1.offline_download&quot;, false);</span>
<a href="#l59.43"></a><span id="l59.43">   Services.prefs.setBoolPref(&quot;mail.server.server1.download_on_biff&quot;, false);</span>
<a href="#l59.44"></a><span id="l59.44">   Services.prefs.setIntPref(&quot;browser.cache.disk.capacity&quot;, 0);</span>
<a href="#l59.45"></a><span id="l59.45"> </span>
<a href="#l59.46"></a><span id="l59.46">   yield true;</span>
<a href="#l59.47"></a><span id="l59.47"> }</span>
<a href="#l59.48"></a><span id="l59.48"> </span>
<a href="#l59.49"></a><span id="l59.49"> // load and update a message in the imap fake server</span>
<a href="#l59.50"></a><span id="l59.50" class="difflineminus">-function* loadImapMessage()</span>
<a href="#l59.51"></a><span id="l59.51" class="difflineminus">-{</span>
<a href="#l59.52"></a><span id="l59.52" class="difflineminus">-  let gMessageGenerator = new MessageGenerator();</span>
<a href="#l59.53"></a><span id="l59.53" class="difflineminus">-</span>
<a href="#l59.54"></a><span id="l59.54" class="difflineplus">+function* loadImapMessage() {</span>
<a href="#l59.55"></a><span id="l59.55">   let file = do_get_file(&quot;../../../data/bodystructuretest1&quot;);</span>
<a href="#l59.56"></a><span id="l59.56">   let msgURI = Services.io.newFileURI(file).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l59.57"></a><span id="l59.57"> </span>
<a href="#l59.58"></a><span id="l59.58">   let imapInbox = IMAPPump.daemon.getMailbox(&quot;INBOX&quot;);</span>
<a href="#l59.59"></a><span id="l59.59">   let message = new imapMessage(msgURI.spec, imapInbox.uidnext++, []);</span>
<a href="#l59.60"></a><span id="l59.60">   IMAPPump.mailbox.addMessage(message);</span>
<a href="#l59.61"></a><span id="l59.61">   // add a second message with no external parts. We want to make</span>
<a href="#l59.62"></a><span id="l59.62">   // sure that streaming this message doesn't mark it read, even</span>
<a href="#l59.63"></a><span id="l59.63" class="difflineat">@@ -68,65 +68,58 @@ function* loadImapMessage()</span>
<a href="#l59.64"></a><span id="l59.64"> </span>
<a href="#l59.65"></a><span id="l59.65">   Assert.equal(2, IMAPPump.inbox.getTotalMessages(false));</span>
<a href="#l59.66"></a><span id="l59.66">   let msgHdr = mailTestUtils.firstMsgHdr(IMAPPump.inbox);</span>
<a href="#l59.67"></a><span id="l59.67">   Assert.ok(msgHdr instanceof Ci.nsIMsgDBHdr);</span>
<a href="#l59.68"></a><span id="l59.68">   yield true;</span>
<a href="#l59.69"></a><span id="l59.69"> }</span>
<a href="#l59.70"></a><span id="l59.70"> </span>
<a href="#l59.71"></a><span id="l59.71"> // process the message through mime</span>
<a href="#l59.72"></a><span id="l59.72" class="difflineminus">-function* startMime()</span>
<a href="#l59.73"></a><span id="l59.73" class="difflineminus">-{</span>
<a href="#l59.74"></a><span id="l59.74" class="difflineplus">+function* startMime() {</span>
<a href="#l59.75"></a><span id="l59.75">   let msgHdr = mailTestUtils.firstMsgHdr(IMAPPump.inbox);</span>
<a href="#l59.76"></a><span id="l59.76"> </span>
<a href="#l59.77"></a><span id="l59.77" class="difflineminus">-  mimeMsg.MsgHdrToMimeMessage(msgHdr, this, function (aMsgHdr, aMimeMessage) {</span>
<a href="#l59.78"></a><span id="l59.78" class="difflineplus">+  mimeMsg.MsgHdrToMimeMessage(msgHdr, this, function(aMsgHdr, aMimeMessage) {</span>
<a href="#l59.79"></a><span id="l59.79">     let url = aMimeMessage.allUserAttachments[0].url;</span>
<a href="#l59.80"></a><span id="l59.80">     // A URL containing this string indicates that the attachment will be</span>
<a href="#l59.81"></a><span id="l59.81">     // downloaded on demand.</span>
<a href="#l59.82"></a><span id="l59.82">     Assert.ok(url.includes(&quot;/;section=&quot;));</span>
<a href="#l59.83"></a><span id="l59.83">     async_driver();</span>
<a href="#l59.84"></a><span id="l59.84">   }, true /* allowDownload */, { partsOnDemand: true, examineEncryptedParts: true });</span>
<a href="#l59.85"></a><span id="l59.85">   yield false;</span>
<a href="#l59.86"></a><span id="l59.86"> }</span>
<a href="#l59.87"></a><span id="l59.87"> </span>
<a href="#l59.88"></a><span id="l59.88"> // test that we don't mark all inline messages as read.</span>
<a href="#l59.89"></a><span id="l59.89" class="difflineminus">-function* testAllInlineMessage()</span>
<a href="#l59.90"></a><span id="l59.90" class="difflineminus">-{</span>
<a href="#l59.91"></a><span id="l59.91" class="difflineplus">+function* testAllInlineMessage() {</span>
<a href="#l59.92"></a><span id="l59.92">   let enumerator = IMAPPump.inbox.msgDatabase.EnumerateMessages();</span>
<a href="#l59.93"></a><span id="l59.93"> </span>
<a href="#l59.94"></a><span id="l59.94" class="difflineminus">-  if (enumerator.hasMoreElements())</span>
<a href="#l59.95"></a><span id="l59.95" class="difflineminus">-  {</span>
<a href="#l59.96"></a><span id="l59.96" class="difflineplus">+  if (enumerator.hasMoreElements()) {</span>
<a href="#l59.97"></a><span id="l59.97">     gSecondMsg = enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l59.98"></a><span id="l59.98" class="difflineminus">-    mimeMsg.MsgHdrToMimeMessage(gSecondMsg, this, function (aMsgHdr, aMimeMessage) {</span>
<a href="#l59.99"></a><span id="l59.99" class="difflineplus">+    mimeMsg.MsgHdrToMimeMessage(gSecondMsg, this, function(aMsgHdr, aMimeMessage) {</span>
<a href="#l59.100"></a><span id="l59.100">       async_driver();</span>
<a href="#l59.101"></a><span id="l59.101">     }, true /* allowDownload */, { partsOnDemand: true });</span>
<a href="#l59.102"></a><span id="l59.102">     yield false;</span>
<a href="#l59.103"></a><span id="l59.103">   }</span>
<a href="#l59.104"></a><span id="l59.104"> }</span>
<a href="#l59.105"></a><span id="l59.105"> </span>
<a href="#l59.106"></a><span id="l59.106" class="difflineminus">-function* updateCounts()</span>
<a href="#l59.107"></a><span id="l59.107" class="difflineminus">-{</span>
<a href="#l59.108"></a><span id="l59.108" class="difflineplus">+function* updateCounts() {</span>
<a href="#l59.109"></a><span id="l59.109">   // select the trash, then the inbox again, to force an update of the</span>
<a href="#l59.110"></a><span id="l59.110">   // read state of messages.</span>
<a href="#l59.111"></a><span id="l59.111">   let trash = IMAPPump.incomingServer.rootFolder.getChildNamed(&quot;Trash&quot;);</span>
<a href="#l59.112"></a><span id="l59.112">   Assert.ok(trash instanceof Ci.nsIMsgImapMailFolder);</span>
<a href="#l59.113"></a><span id="l59.113">   trash.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l59.114"></a><span id="l59.114">   yield false;</span>
<a href="#l59.115"></a><span id="l59.115">   IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l59.116"></a><span id="l59.116">   yield false;</span>
<a href="#l59.117"></a><span id="l59.117"> }</span>
<a href="#l59.118"></a><span id="l59.118"> </span>
<a href="#l59.119"></a><span id="l59.119" class="difflineminus">-function* testNotRead()</span>
<a href="#l59.120"></a><span id="l59.120" class="difflineminus">-{</span>
<a href="#l59.121"></a><span id="l59.121" class="difflineplus">+function* testNotRead() {</span>
<a href="#l59.122"></a><span id="l59.122">   Assert.equal(2, IMAPPump.inbox.getNumUnread(false));</span>
<a href="#l59.123"></a><span id="l59.123">   yield true;</span>
<a href="#l59.124"></a><span id="l59.124"> }</span>
<a href="#l59.125"></a><span id="l59.125"> </span>
<a href="#l59.126"></a><span id="l59.126"> // Cleanup</span>
<a href="#l59.127"></a><span id="l59.127" class="difflineminus">-function endTest()</span>
<a href="#l59.128"></a><span id="l59.128" class="difflineminus">-{</span>
<a href="#l59.129"></a><span id="l59.129" class="difflineplus">+function endTest() {</span>
<a href="#l59.130"></a><span id="l59.130">   teardownIMAPPump();</span>
<a href="#l59.131"></a><span id="l59.131"> }</span>
<a href="#l59.132"></a><span id="l59.132"> </span>
<a href="#l59.133"></a><span id="l59.133" class="difflineminus">-function run_test()</span>
<a href="#l59.134"></a><span id="l59.134" class="difflineminus">-{</span>
<a href="#l59.135"></a><span id="l59.135" class="difflineplus">+function run_test() {</span>
<a href="#l59.136"></a><span id="l59.136">   async_run_tests(tests);</span>
<a href="#l59.137"></a><span id="l59.137"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l60.1"></a><span id="l60.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_preserveDataOnMove.js</span>
<a href="#l60.2"></a><span id="l60.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_preserveDataOnMove.js</span>
<a href="#l60.3"></a><span id="l60.3" class="difflineat">@@ -1,16 +1,18 @@</span>
<a href="#l60.4"></a><span id="l60.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l60.5"></a><span id="l60.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l60.6"></a><span id="l60.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l60.7"></a><span id="l60.7"> </span>
<a href="#l60.8"></a><span id="l60.8"> // This tests that arbitrary message header properties are preserved</span>
<a href="#l60.9"></a><span id="l60.9"> //  during online move of an imap message.</span>
<a href="#l60.10"></a><span id="l60.10"> </span>
<a href="#l60.11"></a><span id="l60.11"> // async support</span>
<a href="#l60.12"></a><span id="l60.12" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l60.13"></a><span id="l60.13" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l60.14"></a><span id="l60.14"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l60.15"></a><span id="l60.15"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l60.16"></a><span id="l60.16"> </span>
<a href="#l60.17"></a><span id="l60.17"> // IMAP pump</span>
<a href="#l60.18"></a><span id="l60.18"> </span>
<a href="#l60.19"></a><span id="l60.19"> // Globals</span>
<a href="#l60.20"></a><span id="l60.20"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l60.21"></a><span id="l60.21"> </span>
<a href="#l60.22"></a><span id="l60.22" class="difflineat">@@ -19,52 +21,49 @@ var gMessage = &quot;bugmail10&quot;; // message f</span>
<a href="#l60.23"></a><span id="l60.23"> setupIMAPPump();</span>
<a href="#l60.24"></a><span id="l60.24"> </span>
<a href="#l60.25"></a><span id="l60.25"> // Definition of tests</span>
<a href="#l60.26"></a><span id="l60.26"> var tests = [</span>
<a href="#l60.27"></a><span id="l60.27">   createSubfolder,</span>
<a href="#l60.28"></a><span id="l60.28">   loadImapMessage,</span>
<a href="#l60.29"></a><span id="l60.29">   moveMessageToSubfolder,</span>
<a href="#l60.30"></a><span id="l60.30">   testPropertyOnMove,</span>
<a href="#l60.31"></a><span id="l60.31" class="difflineminus">-  endTest</span>
<a href="#l60.32"></a><span id="l60.32" class="difflineminus">-]</span>
<a href="#l60.33"></a><span id="l60.33" class="difflineplus">+  endTest,</span>
<a href="#l60.34"></a><span id="l60.34" class="difflineplus">+];</span>
<a href="#l60.35"></a><span id="l60.35"> </span>
<a href="#l60.36"></a><span id="l60.36"> var gSubfolder;</span>
<a href="#l60.37"></a><span id="l60.37" class="difflineminus">-function* createSubfolder()</span>
<a href="#l60.38"></a><span id="l60.38" class="difflineminus">-{</span>
<a href="#l60.39"></a><span id="l60.39" class="difflineplus">+function* createSubfolder() {</span>
<a href="#l60.40"></a><span id="l60.40">   IMAPPump.incomingServer.rootFolder.createSubfolder(&quot;Subfolder&quot;, null);</span>
<a href="#l60.41"></a><span id="l60.41" class="difflineminus">-  dl('wait for folderAdded notification');</span>
<a href="#l60.42"></a><span id="l60.42" class="difflineplus">+  dl(&quot;wait for folderAdded notification&quot;);</span>
<a href="#l60.43"></a><span id="l60.43">   yield false;</span>
<a href="#l60.44"></a><span id="l60.44">   gSubfolder = IMAPPump.incomingServer.rootFolder.getChildNamed(&quot;Subfolder&quot;);</span>
<a href="#l60.45"></a><span id="l60.45">   Assert.ok(gSubfolder instanceof Ci.nsIMsgImapMailFolder);</span>
<a href="#l60.46"></a><span id="l60.46">   gSubfolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l60.47"></a><span id="l60.47" class="difflineminus">-  dl('wait for OnStopRunningURL');</span>
<a href="#l60.48"></a><span id="l60.48" class="difflineplus">+  dl(&quot;wait for OnStopRunningURL&quot;);</span>
<a href="#l60.49"></a><span id="l60.49">   yield false;</span>
<a href="#l60.50"></a><span id="l60.50"> }</span>
<a href="#l60.51"></a><span id="l60.51"> </span>
<a href="#l60.52"></a><span id="l60.52"> // load and update a message in the imap fake server</span>
<a href="#l60.53"></a><span id="l60.53" class="difflineminus">-function* loadImapMessage()</span>
<a href="#l60.54"></a><span id="l60.54" class="difflineminus">-{</span>
<a href="#l60.55"></a><span id="l60.55" class="difflineplus">+function* loadImapMessage() {</span>
<a href="#l60.56"></a><span id="l60.56">   IMAPPump.mailbox.addMessage(new imapMessage(specForFileName(gMessage),</span>
<a href="#l60.57"></a><span id="l60.57">                           IMAPPump.mailbox.uidnext++, []));</span>
<a href="#l60.58"></a><span id="l60.58">   IMAPPump.inbox.updateFolder(null);</span>
<a href="#l60.59"></a><span id="l60.59" class="difflineminus">-  dl('wait for msgAdded notification');</span>
<a href="#l60.60"></a><span id="l60.60" class="difflineplus">+  dl(&quot;wait for msgAdded notification&quot;);</span>
<a href="#l60.61"></a><span id="l60.61">   yield false;</span>
<a href="#l60.62"></a><span id="l60.62">   Assert.equal(1, IMAPPump.inbox.getTotalMessages(false));</span>
<a href="#l60.63"></a><span id="l60.63">   let msgHdr = mailTestUtils.firstMsgHdr(IMAPPump.inbox);</span>
<a href="#l60.64"></a><span id="l60.64">   Assert.ok(msgHdr instanceof Ci.nsIMsgDBHdr);</span>
<a href="#l60.65"></a><span id="l60.65"> </span>
<a href="#l60.66"></a><span id="l60.66">   // set an arbitrary property</span>
<a href="#l60.67"></a><span id="l60.67">   msgHdr.setStringProperty(&quot;testprop&quot;, &quot;somevalue&quot;);</span>
<a href="#l60.68"></a><span id="l60.68">   yield true;</span>
<a href="#l60.69"></a><span id="l60.69"> }</span>
<a href="#l60.70"></a><span id="l60.70"> </span>
<a href="#l60.71"></a><span id="l60.71"> // move the message to a subfolder</span>
<a href="#l60.72"></a><span id="l60.72" class="difflineminus">-function* moveMessageToSubfolder()</span>
<a href="#l60.73"></a><span id="l60.73" class="difflineminus">-{</span>
<a href="#l60.74"></a><span id="l60.74" class="difflineplus">+function* moveMessageToSubfolder() {</span>
<a href="#l60.75"></a><span id="l60.75">   let msgHdr = mailTestUtils.firstMsgHdr(IMAPPump.inbox);</span>
<a href="#l60.76"></a><span id="l60.76"> </span>
<a href="#l60.77"></a><span id="l60.77">   // Now move this message to the subfolder.</span>
<a href="#l60.78"></a><span id="l60.78">   var messages = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l60.79"></a><span id="l60.79">                    .createInstance(Ci.nsIMutableArray);</span>
<a href="#l60.80"></a><span id="l60.80">   messages.appendElement(msgHdr);</span>
<a href="#l60.81"></a><span id="l60.81">   /*</span>
<a href="#l60.82"></a><span id="l60.82">   void CopyMessages(in nsIMsgFolder srcFolder,</span>
<a href="#l60.83"></a><span id="l60.83" class="difflineat">@@ -73,78 +72,71 @@ function* moveMessageToSubfolder()</span>
<a href="#l60.84"></a><span id="l60.84">                     in boolean isMove,</span>
<a href="#l60.85"></a><span id="l60.85">                     in nsIMsgCopyServiceListener listener,</span>
<a href="#l60.86"></a><span id="l60.86">                     in nsIMsgWindow msgWindow,</span>
<a href="#l60.87"></a><span id="l60.87">                     in boolean allowUndo);</span>
<a href="#l60.88"></a><span id="l60.88">   */</span>
<a href="#l60.89"></a><span id="l60.89"> </span>
<a href="#l60.90"></a><span id="l60.90">   MailServices.copy.CopyMessages(IMAPPump.inbox, messages, gSubfolder, true,</span>
<a href="#l60.91"></a><span id="l60.91">                                  asyncCopyListener, null, false);</span>
<a href="#l60.92"></a><span id="l60.92" class="difflineminus">-  dl('wait for OnStopCopy');</span>
<a href="#l60.93"></a><span id="l60.93" class="difflineplus">+  dl(&quot;wait for OnStopCopy&quot;);</span>
<a href="#l60.94"></a><span id="l60.94">   yield false;</span>
<a href="#l60.95"></a><span id="l60.95"> }</span>
<a href="#l60.96"></a><span id="l60.96"> </span>
<a href="#l60.97"></a><span id="l60.97" class="difflineminus">-function* testPropertyOnMove()</span>
<a href="#l60.98"></a><span id="l60.98" class="difflineminus">-{</span>
<a href="#l60.99"></a><span id="l60.99" class="difflineplus">+function* testPropertyOnMove() {</span>
<a href="#l60.100"></a><span id="l60.100">   gSubfolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l60.101"></a><span id="l60.101" class="difflineminus">-  dl('wait for msgAdded');</span>
<a href="#l60.102"></a><span id="l60.102" class="difflineplus">+  dl(&quot;wait for msgAdded&quot;);</span>
<a href="#l60.103"></a><span id="l60.103">   yield false; // wait for msgAdded notification</span>
<a href="#l60.104"></a><span id="l60.104" class="difflineminus">-  dl('wait for OnStopRunningURL');</span>
<a href="#l60.105"></a><span id="l60.105" class="difflineplus">+  dl(&quot;wait for OnStopRunningURL&quot;);</span>
<a href="#l60.106"></a><span id="l60.106">   yield false; // wait for OnStopRunningUrl</span>
<a href="#l60.107"></a><span id="l60.107">   let msgHdr = mailTestUtils.firstMsgHdr(gSubfolder);</span>
<a href="#l60.108"></a><span id="l60.108">   Assert.equal(msgHdr.getStringProperty(&quot;testprop&quot;), &quot;somevalue&quot;);</span>
<a href="#l60.109"></a><span id="l60.109">   yield true;</span>
<a href="#l60.110"></a><span id="l60.110"> }</span>
<a href="#l60.111"></a><span id="l60.111"> </span>
<a href="#l60.112"></a><span id="l60.112"> // Cleanup</span>
<a href="#l60.113"></a><span id="l60.113" class="difflineminus">-function endTest()</span>
<a href="#l60.114"></a><span id="l60.114" class="difflineminus">-{</span>
<a href="#l60.115"></a><span id="l60.115" class="difflineplus">+function endTest() {</span>
<a href="#l60.116"></a><span id="l60.116">   teardownIMAPPump();</span>
<a href="#l60.117"></a><span id="l60.117"> }</span>
<a href="#l60.118"></a><span id="l60.118"> </span>
<a href="#l60.119"></a><span id="l60.119"> // listeners</span>
<a href="#l60.120"></a><span id="l60.120"> </span>
<a href="#l60.121"></a><span id="l60.121" class="difflineminus">-var mfnListener =</span>
<a href="#l60.122"></a><span id="l60.122" class="difflineminus">-{</span>
<a href="#l60.123"></a><span id="l60.123" class="difflineminus">-  folderAdded: function folderAdded(aFolder)</span>
<a href="#l60.124"></a><span id="l60.124" class="difflineminus">-  {</span>
<a href="#l60.125"></a><span id="l60.125" class="difflineminus">-    dl('folderAdded &lt;' + aFolder.name + '&gt;');</span>
<a href="#l60.126"></a><span id="l60.126" class="difflineplus">+var mfnListener = {</span>
<a href="#l60.127"></a><span id="l60.127" class="difflineplus">+  folderAdded(aFolder) {</span>
<a href="#l60.128"></a><span id="l60.128" class="difflineplus">+    dl(&quot;folderAdded &lt;&quot; + aFolder.name + &quot;&gt;&quot;);</span>
<a href="#l60.129"></a><span id="l60.129">     // we are only using async yield on the Subfolder add</span>
<a href="#l60.130"></a><span id="l60.130">     if (aFolder.name == &quot;Subfolder&quot;)</span>
<a href="#l60.131"></a><span id="l60.131">       async_driver();</span>
<a href="#l60.132"></a><span id="l60.132">   },</span>
<a href="#l60.133"></a><span id="l60.133"> </span>
<a href="#l60.134"></a><span id="l60.134" class="difflineminus">-  msgAdded: function msgAdded(aMsg)</span>
<a href="#l60.135"></a><span id="l60.135" class="difflineminus">-  {</span>
<a href="#l60.136"></a><span id="l60.136" class="difflineminus">-    dl('msgAdded with subject &lt;' + aMsg.subject + '&gt;')</span>
<a href="#l60.137"></a><span id="l60.137" class="difflineplus">+  msgAdded(aMsg) {</span>
<a href="#l60.138"></a><span id="l60.138" class="difflineplus">+    dl(&quot;msgAdded with subject &lt;&quot; + aMsg.subject + &quot;&gt;&quot;);</span>
<a href="#l60.139"></a><span id="l60.139">     async_driver();</span>
<a href="#l60.140"></a><span id="l60.140">   },</span>
<a href="#l60.141"></a><span id="l60.141"> </span>
<a href="#l60.142"></a><span id="l60.142"> };</span>
<a href="#l60.143"></a><span id="l60.143"> </span>
<a href="#l60.144"></a><span id="l60.144" class="difflineminus">-function run_test()</span>
<a href="#l60.145"></a><span id="l60.145" class="difflineminus">-{</span>
<a href="#l60.146"></a><span id="l60.146" class="difflineplus">+function run_test() {</span>
<a href="#l60.147"></a><span id="l60.147">   Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l60.148"></a><span id="l60.148">   // Add folder listeners that will capture async events</span>
<a href="#l60.149"></a><span id="l60.149">   const nsIMFNService = Ci.nsIMsgFolderNotificationService;</span>
<a href="#l60.150"></a><span id="l60.150">   let flags =</span>
<a href="#l60.151"></a><span id="l60.151">         nsIMFNService.folderAdded |</span>
<a href="#l60.152"></a><span id="l60.152">         nsIMFNService.msgAdded;</span>
<a href="#l60.153"></a><span id="l60.153">   MailServices.mfn.addListener(mfnListener, flags);</span>
<a href="#l60.154"></a><span id="l60.154">   async_run_tests(tests);</span>
<a href="#l60.155"></a><span id="l60.155"> }</span>
<a href="#l60.156"></a><span id="l60.156"> </span>
<a href="#l60.157"></a><span id="l60.157"> /*</span>
<a href="#l60.158"></a><span id="l60.158">  * helper functions</span>
<a href="#l60.159"></a><span id="l60.159">  */</span>
<a href="#l60.160"></a><span id="l60.160"> </span>
<a href="#l60.161"></a><span id="l60.161"> // given a test file, return the file uri spec</span>
<a href="#l60.162"></a><span id="l60.162" class="difflineminus">-function specForFileName(aFileName)</span>
<a href="#l60.163"></a><span id="l60.163" class="difflineminus">-{</span>
<a href="#l60.164"></a><span id="l60.164" class="difflineplus">+function specForFileName(aFileName) {</span>
<a href="#l60.165"></a><span id="l60.165">   let file = do_get_file(&quot;../../../data/&quot; + aFileName);</span>
<a href="#l60.166"></a><span id="l60.166">   let msgfileuri = Services.io.newFileURI(file).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l60.167"></a><span id="l60.167">   return msgfileuri.spec;</span>
<a href="#l60.168"></a><span id="l60.168"> }</span>
<a href="#l60.169"></a><span id="l60.169"> </span>
<a href="#l60.170"></a><span id="l60.170"> // shorthand output of a line of text</span>
<a href="#l60.171"></a><span id="l60.171"> function dl(text) {</span>
<a href="#l60.172"></a><span id="l60.172" class="difflineminus">-  dump(text + '\n');</span>
<a href="#l60.173"></a><span id="l60.173" class="difflineplus">+  dump(text + &quot;\n&quot;);</span>
<a href="#l60.174"></a><span id="l60.174"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l61.1"></a><span id="l61.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_saveImapDraft.js</span>
<a href="#l61.2"></a><span id="l61.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_saveImapDraft.js</span>
<a href="#l61.3"></a><span id="l61.3" class="difflineat">@@ -3,16 +3,18 @@</span>
<a href="#l61.4"></a><span id="l61.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l61.5"></a><span id="l61.5"> </span>
<a href="#l61.6"></a><span id="l61.6"> /*</span>
<a href="#l61.7"></a><span id="l61.7">  * This file tests that a message saved as draft in an IMAP folder is correctly</span>
<a href="#l61.8"></a><span id="l61.8">  * marked as unread.</span>
<a href="#l61.9"></a><span id="l61.9">  */</span>
<a href="#l61.10"></a><span id="l61.10"> </span>
<a href="#l61.11"></a><span id="l61.11"> // async support</span>
<a href="#l61.12"></a><span id="l61.12" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l61.13"></a><span id="l61.13" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l61.14"></a><span id="l61.14"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l61.15"></a><span id="l61.15"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l61.16"></a><span id="l61.16"> </span>
<a href="#l61.17"></a><span id="l61.17"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l61.18"></a><span id="l61.18"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l61.19"></a><span id="l61.19"> </span>
<a href="#l61.20"></a><span id="l61.20"> // IMAP pump</span>
<a href="#l61.21"></a><span id="l61.21"> </span>
<a href="#l61.22"></a><span id="l61.22" class="difflineat">@@ -20,34 +22,32 @@ setupIMAPPump();</span>
<a href="#l61.23"></a><span id="l61.23"> </span>
<a href="#l61.24"></a><span id="l61.24"> // Definition of tests</span>
<a href="#l61.25"></a><span id="l61.25"> </span>
<a href="#l61.26"></a><span id="l61.26"> var tests = [</span>
<a href="#l61.27"></a><span id="l61.27">   createDraftsFolder,</span>
<a href="#l61.28"></a><span id="l61.28">   saveDraft,</span>
<a href="#l61.29"></a><span id="l61.29">   updateDrafts,</span>
<a href="#l61.30"></a><span id="l61.30">   checkResult,</span>
<a href="#l61.31"></a><span id="l61.31" class="difflineminus">-  endTest</span>
<a href="#l61.32"></a><span id="l61.32" class="difflineplus">+  endTest,</span>
<a href="#l61.33"></a><span id="l61.33"> ];</span>
<a href="#l61.34"></a><span id="l61.34"> </span>
<a href="#l61.35"></a><span id="l61.35"> var gDraftsFolder;</span>
<a href="#l61.36"></a><span id="l61.36" class="difflineminus">-function* createDraftsFolder()</span>
<a href="#l61.37"></a><span id="l61.37" class="difflineminus">-{</span>
<a href="#l61.38"></a><span id="l61.38" class="difflineplus">+function* createDraftsFolder() {</span>
<a href="#l61.39"></a><span id="l61.39">   IMAPPump.incomingServer.rootFolder.createSubfolder(&quot;Drafts&quot;, null);</span>
<a href="#l61.40"></a><span id="l61.40" class="difflineminus">-  dl('wait for folderAdded');</span>
<a href="#l61.41"></a><span id="l61.41" class="difflineplus">+  dl(&quot;wait for folderAdded&quot;);</span>
<a href="#l61.42"></a><span id="l61.42">   yield false;</span>
<a href="#l61.43"></a><span id="l61.43">   gDraftsFolder = IMAPPump.incomingServer.rootFolder.getChildNamed(&quot;Drafts&quot;);</span>
<a href="#l61.44"></a><span id="l61.44">   Assert.ok(gDraftsFolder instanceof Ci.nsIMsgImapMailFolder);</span>
<a href="#l61.45"></a><span id="l61.45">   gDraftsFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l61.46"></a><span id="l61.46" class="difflineminus">-  dl('wait for OnStopRunningURL');</span>
<a href="#l61.47"></a><span id="l61.47" class="difflineplus">+  dl(&quot;wait for OnStopRunningURL&quot;);</span>
<a href="#l61.48"></a><span id="l61.48">   yield false;</span>
<a href="#l61.49"></a><span id="l61.49"> }</span>
<a href="#l61.50"></a><span id="l61.50"> </span>
<a href="#l61.51"></a><span id="l61.51" class="difflineminus">-function* saveDraft()</span>
<a href="#l61.52"></a><span id="l61.52" class="difflineminus">-{</span>
<a href="#l61.53"></a><span id="l61.53" class="difflineplus">+function* saveDraft() {</span>
<a href="#l61.54"></a><span id="l61.54">   var msgCompose = Cc[&quot;@mozilla.org/messengercompose/compose;1&quot;]</span>
<a href="#l61.55"></a><span id="l61.55">                      .createInstance(Ci.nsIMsgCompose);</span>
<a href="#l61.56"></a><span id="l61.56">   var fields = Cc[&quot;@mozilla.org/messengercompose/composefields;1&quot;]</span>
<a href="#l61.57"></a><span id="l61.57">                  .createInstance(Ci.nsIMsgCompFields);</span>
<a href="#l61.58"></a><span id="l61.58">   var params = Cc[&quot;@mozilla.org/messengercompose/composeparams;1&quot;]</span>
<a href="#l61.59"></a><span id="l61.59">                  .createInstance(Ci.nsIMsgComposeParams);</span>
<a href="#l61.60"></a><span id="l61.60">   params.composeFields = fields;</span>
<a href="#l61.61"></a><span id="l61.61">   msgCompose.initialize(params);</span>
<a href="#l61.62"></a><span id="l61.62" class="difflineat">@@ -59,94 +59,86 @@ function* saveDraft()</span>
<a href="#l61.63"></a><span id="l61.63">   var progress = Cc[&quot;@mozilla.org/messenger/progress;1&quot;]</span>
<a href="#l61.64"></a><span id="l61.64">                    .createInstance(Ci.nsIMsgProgress);</span>
<a href="#l61.65"></a><span id="l61.65">   progress.registerListener(progressListener);</span>
<a href="#l61.66"></a><span id="l61.66">   msgCompose.SendMsg(Ci.nsIMsgSend.nsMsgSaveAsDraft, identity, &quot;&quot;, null,</span>
<a href="#l61.67"></a><span id="l61.67">                      progress);</span>
<a href="#l61.68"></a><span id="l61.68">   yield false;</span>
<a href="#l61.69"></a><span id="l61.69"> }</span>
<a href="#l61.70"></a><span id="l61.70"> </span>
<a href="#l61.71"></a><span id="l61.71" class="difflineminus">-function* updateDrafts()</span>
<a href="#l61.72"></a><span id="l61.72" class="difflineminus">-{</span>
<a href="#l61.73"></a><span id="l61.73" class="difflineplus">+function* updateDrafts() {</span>
<a href="#l61.74"></a><span id="l61.74">   dump(&quot;updating drafts\n&quot;);</span>
<a href="#l61.75"></a><span id="l61.75">   gDraftsFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l61.76"></a><span id="l61.76">   yield false;</span>
<a href="#l61.77"></a><span id="l61.77"> }</span>
<a href="#l61.78"></a><span id="l61.78"> </span>
<a href="#l61.79"></a><span id="l61.79" class="difflineminus">-function* checkResult()</span>
<a href="#l61.80"></a><span id="l61.80" class="difflineminus">-{</span>
<a href="#l61.81"></a><span id="l61.81" class="difflineplus">+function* checkResult() {</span>
<a href="#l61.82"></a><span id="l61.82">   dump(&quot;checking result\n&quot;);</span>
<a href="#l61.83"></a><span id="l61.83">   Assert.equal(gDraftsFolder.getTotalMessages(false), 1);</span>
<a href="#l61.84"></a><span id="l61.84">   Assert.equal(gDraftsFolder.getNumUnread(false), 1);</span>
<a href="#l61.85"></a><span id="l61.85">   yield true;</span>
<a href="#l61.86"></a><span id="l61.86"> }</span>
<a href="#l61.87"></a><span id="l61.87"> </span>
<a href="#l61.88"></a><span id="l61.88" class="difflineminus">-function* endTest()</span>
<a href="#l61.89"></a><span id="l61.89" class="difflineminus">-{</span>
<a href="#l61.90"></a><span id="l61.90" class="difflineplus">+function* endTest() {</span>
<a href="#l61.91"></a><span id="l61.91">   teardownIMAPPump();</span>
<a href="#l61.92"></a><span id="l61.92">   yield true;</span>
<a href="#l61.93"></a><span id="l61.93"> }</span>
<a href="#l61.94"></a><span id="l61.94"> </span>
<a href="#l61.95"></a><span id="l61.95" class="difflineminus">-function run_test()</span>
<a href="#l61.96"></a><span id="l61.96" class="difflineminus">-{</span>
<a href="#l61.97"></a><span id="l61.97" class="difflineplus">+function run_test() {</span>
<a href="#l61.98"></a><span id="l61.98">   Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l61.99"></a><span id="l61.99" class="difflineminus">-  let server = IMAPPump.incomingServer;</span>
<a href="#l61.100"></a><span id="l61.100"> </span>
<a href="#l61.101"></a><span id="l61.101">   // Add folder listeners that will capture async events</span>
<a href="#l61.102"></a><span id="l61.102">   const nsIMFNService = Ci.nsIMsgFolderNotificationService;</span>
<a href="#l61.103"></a><span id="l61.103"> </span>
<a href="#l61.104"></a><span id="l61.104">   let flags =</span>
<a href="#l61.105"></a><span id="l61.105">         nsIMFNService.msgsMoveCopyCompleted |</span>
<a href="#l61.106"></a><span id="l61.106">         nsIMFNService.folderAdded |</span>
<a href="#l61.107"></a><span id="l61.107">         nsIMFNService.msgAdded;</span>
<a href="#l61.108"></a><span id="l61.108">   MailServices.mfn.addListener(mfnListener, flags);</span>
<a href="#l61.109"></a><span id="l61.109"> </span>
<a href="#l61.110"></a><span id="l61.110" class="difflineminus">-  //start first test</span>
<a href="#l61.111"></a><span id="l61.111" class="difflineplus">+  // start first test</span>
<a href="#l61.112"></a><span id="l61.112">   async_run_tests(tests);</span>
<a href="#l61.113"></a><span id="l61.113"> }</span>
<a href="#l61.114"></a><span id="l61.114"> </span>
<a href="#l61.115"></a><span id="l61.115" class="difflineminus">-var mfnListener =</span>
<a href="#l61.116"></a><span id="l61.116" class="difflineminus">-{</span>
<a href="#l61.117"></a><span id="l61.117" class="difflineminus">-  msgsMoveCopyCompleted: function (aMove, aSrcMsgs, aDestFolder, aDestMsgs)</span>
<a href="#l61.118"></a><span id="l61.118" class="difflineminus">-  {</span>
<a href="#l61.119"></a><span id="l61.119" class="difflineminus">-    dl('msgsMoveCopyCompleted to folder ' + aDestFolder.name);</span>
<a href="#l61.120"></a><span id="l61.120" class="difflineplus">+var mfnListener = {</span>
<a href="#l61.121"></a><span id="l61.121" class="difflineplus">+  msgsMoveCopyCompleted(aMove, aSrcMsgs, aDestFolder, aDestMsgs) {</span>
<a href="#l61.122"></a><span id="l61.122" class="difflineplus">+    dl(&quot;msgsMoveCopyCompleted to folder &quot; + aDestFolder.name);</span>
<a href="#l61.123"></a><span id="l61.123">   },</span>
<a href="#l61.124"></a><span id="l61.124"> </span>
<a href="#l61.125"></a><span id="l61.125" class="difflineminus">-  folderAdded: function (aFolder)</span>
<a href="#l61.126"></a><span id="l61.126" class="difflineminus">-  {</span>
<a href="#l61.127"></a><span id="l61.127" class="difflineminus">-    dl('folderAdded &lt;' + aFolder.name + '&gt;');</span>
<a href="#l61.128"></a><span id="l61.128" class="difflineplus">+  folderAdded(aFolder) {</span>
<a href="#l61.129"></a><span id="l61.129" class="difflineplus">+    dl(&quot;folderAdded &lt;&quot; + aFolder.name + &quot;&gt;&quot;);</span>
<a href="#l61.130"></a><span id="l61.130">     // we are only using async add on the Junk folder</span>
<a href="#l61.131"></a><span id="l61.131">     if (aFolder.name == &quot;Drafts&quot;)</span>
<a href="#l61.132"></a><span id="l61.132">       async_driver();</span>
<a href="#l61.133"></a><span id="l61.133">   },</span>
<a href="#l61.134"></a><span id="l61.134"> </span>
<a href="#l61.135"></a><span id="l61.135" class="difflineminus">-  msgAdded: function msgAdded(aMsg)</span>
<a href="#l61.136"></a><span id="l61.136" class="difflineminus">-  {</span>
<a href="#l61.137"></a><span id="l61.137" class="difflineminus">-    dl('msgAdded with subject &lt;' + aMsg.subject + '&gt;');</span>
<a href="#l61.138"></a><span id="l61.138" class="difflineminus">-  }</span>
<a href="#l61.139"></a><span id="l61.139" class="difflineplus">+  msgAdded(aMsg) {</span>
<a href="#l61.140"></a><span id="l61.140" class="difflineplus">+    dl(&quot;msgAdded with subject &lt;&quot; + aMsg.subject + &quot;&gt;&quot;);</span>
<a href="#l61.141"></a><span id="l61.141" class="difflineplus">+  },</span>
<a href="#l61.142"></a><span id="l61.142"> };</span>
<a href="#l61.143"></a><span id="l61.143"> </span>
<a href="#l61.144"></a><span id="l61.144"> var progressListener = {</span>
<a href="#l61.145"></a><span id="l61.145" class="difflineminus">-  onStateChange: function(aWebProgress, aRequest, aStateFlags, aStatus) {</span>
<a href="#l61.146"></a><span id="l61.146" class="difflineminus">-    if (aStateFlags &amp; Ci.nsIWebProgressListener.STATE_STOP){</span>
<a href="#l61.147"></a><span id="l61.147" class="difflineminus">-      dl('onStateChange');</span>
<a href="#l61.148"></a><span id="l61.148" class="difflineplus">+  onStateChange(aWebProgress, aRequest, aStateFlags, aStatus) {</span>
<a href="#l61.149"></a><span id="l61.149" class="difflineplus">+    if (aStateFlags &amp; Ci.nsIWebProgressListener.STATE_STOP) {</span>
<a href="#l61.150"></a><span id="l61.150" class="difflineplus">+      dl(&quot;onStateChange&quot;);</span>
<a href="#l61.151"></a><span id="l61.151">       async_driver();</span>
<a href="#l61.152"></a><span id="l61.152">     }</span>
<a href="#l61.153"></a><span id="l61.153">   },</span>
<a href="#l61.154"></a><span id="l61.154"> </span>
<a href="#l61.155"></a><span id="l61.155" class="difflineminus">-  onProgressChange: function(aWebProgress, aRequest, aCurSelfProgress, aMaxSelfProgress, aCurTotalProgress, aMaxTotalProgress) {},</span>
<a href="#l61.156"></a><span id="l61.156" class="difflineminus">-  onLocationChange: function(aWebProgress, aRequest, aLocation, aFlags) {},</span>
<a href="#l61.157"></a><span id="l61.157" class="difflineminus">-  onStatusChange: function(aWebProgress, aRequest, aStatus, aMessage) {},</span>
<a href="#l61.158"></a><span id="l61.158" class="difflineminus">-  onSecurityChange: function(aWebProgress, aRequest, state) {},</span>
<a href="#l61.159"></a><span id="l61.159" class="difflineminus">-  onContentBlockingEvent: function(aWebProgress, aRequest, aEvent) {},</span>
<a href="#l61.160"></a><span id="l61.160" class="difflineplus">+  onProgressChange(aWebProgress, aRequest, aCurSelfProgress, aMaxSelfProgress,</span>
<a href="#l61.161"></a><span id="l61.161" class="difflineplus">+                   aCurTotalProgress, aMaxTotalProgress) {},</span>
<a href="#l61.162"></a><span id="l61.162" class="difflineplus">+  onLocationChange(aWebProgress, aRequest, aLocation, aFlags) {},</span>
<a href="#l61.163"></a><span id="l61.163" class="difflineplus">+  onStatusChange(aWebProgress, aRequest, aStatus, aMessage) {},</span>
<a href="#l61.164"></a><span id="l61.164" class="difflineplus">+  onSecurityChange(aWebProgress, aRequest, state) {},</span>
<a href="#l61.165"></a><span id="l61.165" class="difflineplus">+  onContentBlockingEvent(aWebProgress, aRequest, aEvent) {},</span>
<a href="#l61.166"></a><span id="l61.166"> </span>
<a href="#l61.167"></a><span id="l61.167">   QueryInterface: ChromeUtils.generateQI([&quot;nsIWebProgressListener&quot;,</span>
<a href="#l61.168"></a><span id="l61.168">                                           &quot;nsISupportsWeakReference&quot;]),</span>
<a href="#l61.169"></a><span id="l61.169"> };</span>
<a href="#l61.170"></a><span id="l61.170"> </span>
<a href="#l61.171"></a><span id="l61.171"> /*</span>
<a href="#l61.172"></a><span id="l61.172">  * helper functions</span>
<a href="#l61.173"></a><span id="l61.173">  */</span>
<a href="#l61.174"></a><span id="l61.174"> </span>
<a href="#l61.175"></a><span id="l61.175"> // quick shorthand for output of a line of text.</span>
<a href="#l61.176"></a><span id="l61.176"> function dl(text) {</span>
<a href="#l61.177"></a><span id="l61.177" class="difflineminus">-  dump(text + '\n');</span>
<a href="#l61.178"></a><span id="l61.178" class="difflineplus">+  dump(text + &quot;\n&quot;);</span>
<a href="#l61.179"></a><span id="l61.179"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l62.1"></a><span id="l62.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_saveTemplate.js</span>
<a href="#l62.2"></a><span id="l62.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_saveTemplate.js</span>
<a href="#l62.3"></a><span id="l62.3" class="difflineat">@@ -6,69 +6,70 @@</span>
<a href="#l62.4"></a><span id="l62.4">  * Tests imap save of message as a template, and test initial save right after</span>
<a href="#l62.5"></a><span id="l62.5">  * creation of folder.</span>
<a href="#l62.6"></a><span id="l62.6">  */</span>
<a href="#l62.7"></a><span id="l62.7"> </span>
<a href="#l62.8"></a><span id="l62.8"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l62.9"></a><span id="l62.9"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l62.10"></a><span id="l62.10"> var {MailUtils} = ChromeUtils.import(&quot;resource:///modules/MailUtils.jsm&quot;);</span>
<a href="#l62.11"></a><span id="l62.11"> </span>
<a href="#l62.12"></a><span id="l62.12" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l62.13"></a><span id="l62.13" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l62.14"></a><span id="l62.14" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l62.15"></a><span id="l62.15"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l62.16"></a><span id="l62.16"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l62.17"></a><span id="l62.17"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l62.18"></a><span id="l62.18"> </span>
<a href="#l62.19"></a><span id="l62.19"> // IMAP pump</span>
<a href="#l62.20"></a><span id="l62.20"> </span>
<a href="#l62.21"></a><span id="l62.21"> setupIMAPPump();</span>
<a href="#l62.22"></a><span id="l62.22"> </span>
<a href="#l62.23"></a><span id="l62.23"> var tests = [</span>
<a href="#l62.24"></a><span id="l62.24">   loadImapMessage,</span>
<a href="#l62.25"></a><span id="l62.25">   saveAsTemplate,</span>
<a href="#l62.26"></a><span id="l62.26" class="difflineminus">-  endTest</span>
<a href="#l62.27"></a><span id="l62.27" class="difflineminus">-]</span>
<a href="#l62.28"></a><span id="l62.28" class="difflineplus">+  endTest,</span>
<a href="#l62.29"></a><span id="l62.29" class="difflineplus">+];</span>
<a href="#l62.30"></a><span id="l62.30"> </span>
<a href="#l62.31"></a><span id="l62.31"> // load and update a message in the imap fake server</span>
<a href="#l62.32"></a><span id="l62.32" class="difflineminus">-function* loadImapMessage()</span>
<a href="#l62.33"></a><span id="l62.33" class="difflineminus">-{</span>
<a href="#l62.34"></a><span id="l62.34" class="difflineplus">+function* loadImapMessage() {</span>
<a href="#l62.35"></a><span id="l62.35">   let gMessageGenerator = new MessageGenerator();</span>
<a href="#l62.36"></a><span id="l62.36">   // create a synthetic message with attachment</span>
<a href="#l62.37"></a><span id="l62.37">   let smsg = gMessageGenerator.makeMessage();</span>
<a href="#l62.38"></a><span id="l62.38"> </span>
<a href="#l62.39"></a><span id="l62.39">   let msgURI =</span>
<a href="#l62.40"></a><span id="l62.40">     Services.io.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l62.41"></a><span id="l62.41">                         btoa(smsg.toMessageString()));</span>
<a href="#l62.42"></a><span id="l62.42" class="difflineminus">-  let imapInbox =  IMAPPump.daemon.getMailbox(&quot;INBOX&quot;)</span>
<a href="#l62.43"></a><span id="l62.43" class="difflineplus">+  let imapInbox = IMAPPump.daemon.getMailbox(&quot;INBOX&quot;);</span>
<a href="#l62.44"></a><span id="l62.44">   let message = new imapMessage(msgURI.spec, imapInbox.uidnext++, []);</span>
<a href="#l62.45"></a><span id="l62.45">   IMAPPump.mailbox.addMessage(message);</span>
<a href="#l62.46"></a><span id="l62.46">   IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l62.47"></a><span id="l62.47">   yield false;</span>
<a href="#l62.48"></a><span id="l62.48">   MailServices.mfn.addListener(mfnListener, MailServices.mfn.msgAdded);</span>
<a href="#l62.49"></a><span id="l62.49">   yield true;</span>
<a href="#l62.50"></a><span id="l62.50"> }</span>
<a href="#l62.51"></a><span id="l62.51"> </span>
<a href="#l62.52"></a><span id="l62.52"> // Cleanup</span>
<a href="#l62.53"></a><span id="l62.53" class="difflineminus">-function* endTest()</span>
<a href="#l62.54"></a><span id="l62.54" class="difflineminus">-{</span>
<a href="#l62.55"></a><span id="l62.55" class="difflineplus">+function* endTest() {</span>
<a href="#l62.56"></a><span id="l62.56">   teardownIMAPPump();</span>
<a href="#l62.57"></a><span id="l62.57">   yield true;</span>
<a href="#l62.58"></a><span id="l62.58"> }</span>
<a href="#l62.59"></a><span id="l62.59"> </span>
<a href="#l62.60"></a><span id="l62.60"> function saveAsUrlListener(aUri, aIdentity) {</span>
<a href="#l62.61"></a><span id="l62.61">   this.uri = aUri;</span>
<a href="#l62.62"></a><span id="l62.62">   this.identity = aIdentity;</span>
<a href="#l62.63"></a><span id="l62.63"> }</span>
<a href="#l62.64"></a><span id="l62.64"> </span>
<a href="#l62.65"></a><span id="l62.65"> saveAsUrlListener.prototype = {</span>
<a href="#l62.66"></a><span id="l62.66" class="difflineminus">-  OnStartRunningUrl: function(aUrl) {</span>
<a href="#l62.67"></a><span id="l62.67" class="difflineplus">+  OnStartRunningUrl(aUrl) {</span>
<a href="#l62.68"></a><span id="l62.68">   },</span>
<a href="#l62.69"></a><span id="l62.69" class="difflineminus">-  OnStopRunningUrl: function(aUrl, aExitCode) {</span>
<a href="#l62.70"></a><span id="l62.70" class="difflineplus">+  OnStopRunningUrl(aUrl, aExitCode) {</span>
<a href="#l62.71"></a><span id="l62.71">     let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l62.72"></a><span id="l62.72">                       .createInstance(Ci.nsIMessenger);</span>
<a href="#l62.73"></a><span id="l62.73">     messenger.saveAs(this.uri, false, this.identity, null);</span>
<a href="#l62.74"></a><span id="l62.74" class="difflineminus">-  }</span>
<a href="#l62.75"></a><span id="l62.75" class="difflineplus">+  },</span>
<a href="#l62.76"></a><span id="l62.76"> };</span>
<a href="#l62.77"></a><span id="l62.77"> </span>
<a href="#l62.78"></a><span id="l62.78"> // This is similar to the method in mailCommands.js, to test the way that</span>
<a href="#l62.79"></a><span id="l62.79"> // it creates a new templates folder before saving the message as a template.</span>
<a href="#l62.80"></a><span id="l62.80"> function* saveAsTemplate() {</span>
<a href="#l62.81"></a><span id="l62.81">   let hdr = mailTestUtils.firstMsgHdr(IMAPPump.inbox);</span>
<a href="#l62.82"></a><span id="l62.82">   let uri = IMAPPump.inbox.getUriForMsg(hdr);</span>
<a href="#l62.83"></a><span id="l62.83">   let identity = MailServices.accounts</span>
<a href="#l62.84"></a><span id="l62.84" class="difflineat">@@ -78,24 +79,21 @@ function* saveAsTemplate() {</span>
<a href="#l62.85"></a><span id="l62.85">   // Verify that Templates folder doesn't exist, and then create it.</span>
<a href="#l62.86"></a><span id="l62.86">   Assert.equal(templates.parent, null);</span>
<a href="#l62.87"></a><span id="l62.87">   templates.setFlag(Ci.nsMsgFolderFlags.Templates);</span>
<a href="#l62.88"></a><span id="l62.88">   templates.createStorageIfMissing(new saveAsUrlListener(uri, identity));</span>
<a href="#l62.89"></a><span id="l62.89">   yield false;</span>
<a href="#l62.90"></a><span id="l62.90"> }</span>
<a href="#l62.91"></a><span id="l62.91"> </span>
<a href="#l62.92"></a><span id="l62.92"> // listener for saveAsTemplate adding a message to the templates folder.</span>
<a href="#l62.93"></a><span id="l62.93" class="difflineminus">-var mfnListener =</span>
<a href="#l62.94"></a><span id="l62.94" class="difflineminus">-{</span>
<a href="#l62.95"></a><span id="l62.95" class="difflineminus">-  msgAdded: function msgAdded(aMsg)</span>
<a href="#l62.96"></a><span id="l62.96" class="difflineminus">-  {</span>
<a href="#l62.97"></a><span id="l62.97" class="difflineplus">+var mfnListener = {</span>
<a href="#l62.98"></a><span id="l62.98" class="difflineplus">+  msgAdded(aMsg) {</span>
<a href="#l62.99"></a><span id="l62.99">     // Check this is the templates folder.</span>
<a href="#l62.100"></a><span id="l62.100">     Assert.equal(aMsg.folder.prettyName, &quot;Templates&quot;);</span>
<a href="#l62.101"></a><span id="l62.101">     async_driver();</span>
<a href="#l62.102"></a><span id="l62.102">   },</span>
<a href="#l62.103"></a><span id="l62.103"> };</span>
<a href="#l62.104"></a><span id="l62.104"> </span>
<a href="#l62.105"></a><span id="l62.105"> </span>
<a href="#l62.106"></a><span id="l62.106" class="difflineminus">-function run_test()</span>
<a href="#l62.107"></a><span id="l62.107" class="difflineminus">-{</span>
<a href="#l62.108"></a><span id="l62.108" class="difflineplus">+function run_test() {</span>
<a href="#l62.109"></a><span id="l62.109">   Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l62.110"></a><span id="l62.110">   async_run_tests(tests);</span>
<a href="#l62.111"></a><span id="l62.111"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l63.1"></a><span id="l63.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_starttlsFailure.js</span>
<a href="#l63.2"></a><span id="l63.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_starttlsFailure.js</span>
<a href="#l63.3"></a><span id="l63.3" class="difflineat">@@ -1,32 +1,35 @@</span>
<a href="#l63.4"></a><span id="l63.4"> /**</span>
<a href="#l63.5"></a><span id="l63.5">  * This test checks that we handle the server dropping the connection</span>
<a href="#l63.6"></a><span id="l63.6">  * on starttls. Since fakeserver doesn't support STARTTLS, I've made</span>
<a href="#l63.7"></a><span id="l63.7">  * it drop the connection when it's attempted.</span>
<a href="#l63.8"></a><span id="l63.8">  */</span>
<a href="#l63.9"></a><span id="l63.9"> </span>
<a href="#l63.10"></a><span id="l63.10"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l63.11"></a><span id="l63.11" class="difflineminus">-var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l63.12"></a><span id="l63.12"> </span>
<a href="#l63.13"></a><span id="l63.13" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l63.14"></a><span id="l63.14" class="difflineplus">+/* import-globals-from ../../../test/resources/alertTestUtils.js */</span>
<a href="#l63.15"></a><span id="l63.15" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l63.16"></a><span id="l63.16"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l63.17"></a><span id="l63.17"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l63.18"></a><span id="l63.18"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l63.19"></a><span id="l63.19"> </span>
<a href="#l63.20"></a><span id="l63.20"> var gGotAlert = false;</span>
<a href="#l63.21"></a><span id="l63.21"> </span>
<a href="#l63.22"></a><span id="l63.22" class="difflineplus">+/* exported alert */// to asyncTestUtils.js</span>
<a href="#l63.23"></a><span id="l63.23"> function alert(aDialogTitle, aText) {</span>
<a href="#l63.24"></a><span id="l63.24">   Assert.ok(aText.startsWith(&quot;Server localhost has disconnected&quot;));</span>
<a href="#l63.25"></a><span id="l63.25">   gGotAlert = true;</span>
<a href="#l63.26"></a><span id="l63.26"> }</span>
<a href="#l63.27"></a><span id="l63.27"> </span>
<a href="#l63.28"></a><span id="l63.28"> var tests = [</span>
<a href="#l63.29"></a><span id="l63.29">   setup,</span>
<a href="#l63.30"></a><span id="l63.30">   check_alert,</span>
<a href="#l63.31"></a><span id="l63.31" class="difflineminus">-  teardown</span>
<a href="#l63.32"></a><span id="l63.32" class="difflineplus">+  teardown,</span>
<a href="#l63.33"></a><span id="l63.33"> ];</span>
<a href="#l63.34"></a><span id="l63.34"> </span>
<a href="#l63.35"></a><span id="l63.35"> function* setup() {</span>
<a href="#l63.36"></a><span id="l63.36">   // set up IMAP fakeserver and incoming server</span>
<a href="#l63.37"></a><span id="l63.37">   IMAPPump.daemon = new imapDaemon();</span>
<a href="#l63.38"></a><span id="l63.38">   IMAPPump.server = makeServer(IMAPPump.daemon, &quot;&quot;, {dropOnStartTLS: true});</span>
<a href="#l63.39"></a><span id="l63.39">   IMAPPump.incomingServer = createLocalIMAPServer(IMAPPump.server.port);</span>
<a href="#l63.40"></a><span id="l63.40">   IMAPPump.incomingServer.socketType = Ci.nsMsgSocketType.alwaysSTARTTLS;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l64.1"></a><span id="l64.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_stopMovingToLocalFolder.js</span>
<a href="#l64.2"></a><span id="l64.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_stopMovingToLocalFolder.js</span>
<a href="#l64.3"></a><span id="l64.3" class="difflineat">@@ -3,47 +3,50 @@</span>
<a href="#l64.4"></a><span id="l64.4">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l64.5"></a><span id="l64.5"> </span>
<a href="#l64.6"></a><span id="l64.6"> /* Test that the message failed to move to a local folder remains on IMAP</span>
<a href="#l64.7"></a><span id="l64.7">  * server. */</span>
<a href="#l64.8"></a><span id="l64.8"> </span>
<a href="#l64.9"></a><span id="l64.9"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l64.10"></a><span id="l64.10"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l64.11"></a><span id="l64.11"> </span>
<a href="#l64.12"></a><span id="l64.12" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l64.13"></a><span id="l64.13" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l64.14"></a><span id="l64.14" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l64.15"></a><span id="l64.15"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l64.16"></a><span id="l64.16"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l64.17"></a><span id="l64.17"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l64.18"></a><span id="l64.18"> </span>
<a href="#l64.19"></a><span id="l64.19"> setupIMAPPump();</span>
<a href="#l64.20"></a><span id="l64.20"> </span>
<a href="#l64.21"></a><span id="l64.21"> function stop_server() {</span>
<a href="#l64.22"></a><span id="l64.22">   IMAPPump.incomingServer.closeCachedConnections();</span>
<a href="#l64.23"></a><span id="l64.23">   IMAPPump.server.stop();</span>
<a href="#l64.24"></a><span id="l64.24">   let thread = gThreadManager.currentThread;</span>
<a href="#l64.25"></a><span id="l64.25">   while (thread.hasPendingEvents())</span>
<a href="#l64.26"></a><span id="l64.26">     thread.processNextEvent(true);</span>
<a href="#l64.27"></a><span id="l64.27"> }</span>
<a href="#l64.28"></a><span id="l64.28"> </span>
<a href="#l64.29"></a><span id="l64.29"> var asyncCopyListener = {</span>
<a href="#l64.30"></a><span id="l64.30" class="difflineminus">-  OnStartCopy: function() {},</span>
<a href="#l64.31"></a><span id="l64.31" class="difflineminus">-  SetMessageKey: function(aMsgKey) {},</span>
<a href="#l64.32"></a><span id="l64.32" class="difflineminus">-  GetMessageId: function() {},</span>
<a href="#l64.33"></a><span id="l64.33" class="difflineminus">-  OnProgress: function(aProgress, aProgressMax) {</span>
<a href="#l64.34"></a><span id="l64.34" class="difflineplus">+  OnStartCopy() {},</span>
<a href="#l64.35"></a><span id="l64.35" class="difflineplus">+  SetMessageKey(aMsgKey) {},</span>
<a href="#l64.36"></a><span id="l64.36" class="difflineplus">+  GetMessageId() {},</span>
<a href="#l64.37"></a><span id="l64.37" class="difflineplus">+  OnProgress(aProgress, aProgressMax) {</span>
<a href="#l64.38"></a><span id="l64.38">     stop_server();</span>
<a href="#l64.39"></a><span id="l64.39">   },</span>
<a href="#l64.40"></a><span id="l64.40" class="difflineminus">-  OnStopCopy: function(aStatus) {</span>
<a href="#l64.41"></a><span id="l64.41" class="difflineplus">+  OnStopCopy(aStatus) {</span>
<a href="#l64.42"></a><span id="l64.42">     Assert.equal(aStatus, 0);</span>
<a href="#l64.43"></a><span id="l64.43">     async_driver();</span>
<a href="#l64.44"></a><span id="l64.44" class="difflineminus">-  }</span>
<a href="#l64.45"></a><span id="l64.45" class="difflineplus">+  },</span>
<a href="#l64.46"></a><span id="l64.46"> };</span>
<a href="#l64.47"></a><span id="l64.47"> </span>
<a href="#l64.48"></a><span id="l64.48"> var tests = [</span>
<a href="#l64.49"></a><span id="l64.49">   setup_messages,</span>
<a href="#l64.50"></a><span id="l64.50">   move_messages,</span>
<a href="#l64.51"></a><span id="l64.51" class="difflineminus">-  check_messages</span>
<a href="#l64.52"></a><span id="l64.52" class="difflineplus">+  check_messages,</span>
<a href="#l64.53"></a><span id="l64.53"> ];</span>
<a href="#l64.54"></a><span id="l64.54"> </span>
<a href="#l64.55"></a><span id="l64.55"> function* setup_messages() {</span>
<a href="#l64.56"></a><span id="l64.56">   Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;, false);</span>
<a href="#l64.57"></a><span id="l64.57"> </span>
<a href="#l64.58"></a><span id="l64.58">   let messageGenerator = new MessageGenerator();</span>
<a href="#l64.59"></a><span id="l64.59">   let messageString = messageGenerator.makeMessage().toMessageString();</span>
<a href="#l64.60"></a><span id="l64.60">   let dataUri = Services.io.newURI(&quot;data:text/plain;base64,&quot; + btoa(messageString));</span>
<a href="#l64.61"></a><span id="l64.61" class="difflineat">@@ -74,16 +77,18 @@ function run_test() {</span>
<a href="#l64.62"></a><span id="l64.62">     // IMAPPump.server.performTest() brings this test to a halt,</span>
<a href="#l64.63"></a><span id="l64.63">     // so we need teardownIMAPPump() without IMAPPump.server.performTest().</span>
<a href="#l64.64"></a><span id="l64.64">     IMAPPump.inbox = null;</span>
<a href="#l64.65"></a><span id="l64.65">     IMAPPump.server.resetTest();</span>
<a href="#l64.66"></a><span id="l64.66">     try {</span>
<a href="#l64.67"></a><span id="l64.67">       IMAPPump.incomingServer.closeCachedConnections();</span>
<a href="#l64.68"></a><span id="l64.68">       let serverSink = IMAPPump.incomingServer.QueryInterface(Ci.nsIImapServerSink);</span>
<a href="#l64.69"></a><span id="l64.69">       serverSink.abortQueuedUrls();</span>
<a href="#l64.70"></a><span id="l64.70" class="difflineminus">-    } catch (ex) {dump(ex);}</span>
<a href="#l64.71"></a><span id="l64.71" class="difflineplus">+    } catch (ex) {</span>
<a href="#l64.72"></a><span id="l64.72" class="difflineplus">+      dump(ex);</span>
<a href="#l64.73"></a><span id="l64.73" class="difflineplus">+    }</span>
<a href="#l64.74"></a><span id="l64.74">     IMAPPump.server.stop();</span>
<a href="#l64.75"></a><span id="l64.75">     let thread = gThreadManager.currentThread;</span>
<a href="#l64.76"></a><span id="l64.76">     while (thread.hasPendingEvents())</span>
<a href="#l64.77"></a><span id="l64.77">       thread.processNextEvent(true);</span>
<a href="#l64.78"></a><span id="l64.78">   });</span>
<a href="#l64.79"></a><span id="l64.79">   async_run_tests(tests);</span>
<a href="#l64.80"></a><span id="l64.80"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l65.1"></a><span id="l65.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_subfolderLocation.js</span>
<a href="#l65.2"></a><span id="l65.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_subfolderLocation.js</span>
<a href="#l65.3"></a><span id="l65.3" class="difflineat">@@ -1,25 +1,25 @@</span>
<a href="#l65.4"></a><span id="l65.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l65.5"></a><span id="l65.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l65.6"></a><span id="l65.6"> </span>
<a href="#l65.7"></a><span id="l65.7"> // Test proper location of new imap offline subfolders for maildir.</span>
<a href="#l65.8"></a><span id="l65.8"> </span>
<a href="#l65.9"></a><span id="l65.9" class="difflineminus">-var CC = Components.Constructor;</span>
<a href="#l65.10"></a><span id="l65.10" class="difflineminus">-</span>
<a href="#l65.11"></a><span id="l65.11"> // async support</span>
<a href="#l65.12"></a><span id="l65.12" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l65.13"></a><span id="l65.13" class="difflineplus">+/* import-globals-from ../../../test/resources/alertTestUtils.js */</span>
<a href="#l65.14"></a><span id="l65.14"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l65.15"></a><span id="l65.15"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l65.16"></a><span id="l65.16"> </span>
<a href="#l65.17"></a><span id="l65.17"> // Globals</span>
<a href="#l65.18"></a><span id="l65.18"> </span>
<a href="#l65.19"></a><span id="l65.19"> // Messages to load must have CRLF line endings, that is Windows style</span>
<a href="#l65.20"></a><span id="l65.20"> var gMessage = &quot;bugmail10&quot;; // message file used as the test message</span>
<a href="#l65.21"></a><span id="l65.21"> </span>
<a href="#l65.22"></a><span id="l65.22" class="difflineminus">-add_task(function () {</span>
<a href="#l65.23"></a><span id="l65.23" class="difflineplus">+add_task(function() {</span>
<a href="#l65.24"></a><span id="l65.24">   Services.prefs.setBoolPref(&quot;mail.server.server1.autosync_offline_stores&quot;, false);</span>
<a href="#l65.25"></a><span id="l65.25">   setupIMAPPump();</span>
<a href="#l65.26"></a><span id="l65.26"> });</span>
<a href="#l65.27"></a><span id="l65.27"> </span>
<a href="#l65.28"></a><span id="l65.28"> // load and update a message in the imap fake server</span>
<a href="#l65.29"></a><span id="l65.29"> add_task(async function loadImapMessage() {</span>
<a href="#l65.30"></a><span id="l65.30">   IMAPPump.mailbox.addMessage(new imapMessage(specForFileName(gMessage),</span>
<a href="#l65.31"></a><span id="l65.31">                               IMAPPump.mailbox.uidnext++, []));</span>
<a href="#l65.32"></a><span id="l65.32" class="difflineat">@@ -59,20 +59,16 @@ add_task(function testSubfolder() {</span>
<a href="#l65.33"></a><span id="l65.33">   let subfolder1 = IMAPPump.inbox.getChildNamed(folderName1);</span>
<a href="#l65.34"></a><span id="l65.34">   let subfolder2 = IMAPPump.inbox.getChildNamed(folderName2);</span>
<a href="#l65.35"></a><span id="l65.35">   Assert.equal(subfolder1.filePath.parent.path, subfolder2.filePath.parent.path);</span>
<a href="#l65.36"></a><span id="l65.36"> });</span>
<a href="#l65.37"></a><span id="l65.37"> </span>
<a href="#l65.38"></a><span id="l65.38"> // Cleanup at end</span>
<a href="#l65.39"></a><span id="l65.39"> add_task(teardownIMAPPump);</span>
<a href="#l65.40"></a><span id="l65.40"> </span>
<a href="#l65.41"></a><span id="l65.41" class="difflineminus">-function run_test() {</span>
<a href="#l65.42"></a><span id="l65.42" class="difflineminus">-  run_next_test();</span>
<a href="#l65.43"></a><span id="l65.43" class="difflineminus">-}</span>
<a href="#l65.44"></a><span id="l65.44" class="difflineminus">-</span>
<a href="#l65.45"></a><span id="l65.45"> /*</span>
<a href="#l65.46"></a><span id="l65.46">  * helper functions</span>
<a href="#l65.47"></a><span id="l65.47">  */</span>
<a href="#l65.48"></a><span id="l65.48"> </span>
<a href="#l65.49"></a><span id="l65.49"> // given a test file, return the file uri spec</span>
<a href="#l65.50"></a><span id="l65.50"> function specForFileName(aFileName) {</span>
<a href="#l65.51"></a><span id="l65.51">   let file = do_get_file(&quot;../../../data/&quot; + aFileName);</span>
<a href="#l65.52"></a><span id="l65.52">   let msgfileuri = Services.io.newFileURI(file).QueryInterface(Ci.nsIFileURL);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l66.1"></a><span id="l66.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_syncChanges.js</span>
<a href="#l66.2"></a><span id="l66.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_syncChanges.js</span>
<a href="#l66.3"></a><span id="l66.3" class="difflineat">@@ -1,15 +1,18 @@</span>
<a href="#l66.4"></a><span id="l66.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l66.5"></a><span id="l66.5"> /*</span>
<a href="#l66.6"></a><span id="l66.6">  * Test to ensure that changes made from a different profile/machine</span>
<a href="#l66.7"></a><span id="l66.7">  * are synced correctly. In particular, we're checking that emptying out</span>
<a href="#l66.8"></a><span id="l66.8">  * an imap folder on the server makes us delete all the headers from our db.</span>
<a href="#l66.9"></a><span id="l66.9">  */</span>
<a href="#l66.10"></a><span id="l66.10"> </span>
<a href="#l66.11"></a><span id="l66.11" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l66.12"></a><span id="l66.12" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l66.13"></a><span id="l66.13" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l66.14"></a><span id="l66.14"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l66.15"></a><span id="l66.15"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l66.16"></a><span id="l66.16"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l66.17"></a><span id="l66.17"> </span>
<a href="#l66.18"></a><span id="l66.18"> var gMessage;</span>
<a href="#l66.19"></a><span id="l66.19"> var gSecondFolder;</span>
<a href="#l66.20"></a><span id="l66.20"> var gSynthMessage;</span>
<a href="#l66.21"></a><span id="l66.21"> </span>
<a href="#l66.22"></a><span id="l66.22" class="difflineat">@@ -32,29 +35,29 @@ var tests = [</span>
<a href="#l66.23"></a><span id="l66.23">   function* simulateMailboxEmptied() {</span>
<a href="#l66.24"></a><span id="l66.24">     gMessage.setFlag(&quot;\\Deleted&quot;);</span>
<a href="#l66.25"></a><span id="l66.25">     IMAPPump.inbox.expunge(asyncUrlListener, null);</span>
<a href="#l66.26"></a><span id="l66.26">     yield false;</span>
<a href="#l66.27"></a><span id="l66.27">     IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l66.28"></a><span id="l66.28">     yield false;</span>
<a href="#l66.29"></a><span id="l66.29">   },</span>
<a href="#l66.30"></a><span id="l66.30">   function checkMailboxEmpty() {</span>
<a href="#l66.31"></a><span id="l66.31" class="difflineminus">-    let msgHdr = IMAPPump.inbox.msgDatabase.getMsgHdrForMessageID(gSynthMessage.messageId);</span>
<a href="#l66.32"></a><span id="l66.32" class="difflineplus">+    IMAPPump.inbox.msgDatabase.getMsgHdrForMessageID(gSynthMessage.messageId);</span>
<a href="#l66.33"></a><span id="l66.33">     Assert.equal(IMAPPump.inbox.getTotalMessages(false), 0);</span>
<a href="#l66.34"></a><span id="l66.34">   },</span>
<a href="#l66.35"></a><span id="l66.35" class="difflineminus">-  teardown</span>
<a href="#l66.36"></a><span id="l66.36" class="difflineplus">+  teardown,</span>
<a href="#l66.37"></a><span id="l66.37"> ];</span>
<a href="#l66.38"></a><span id="l66.38"> </span>
<a href="#l66.39"></a><span id="l66.39"> function* setup() {</span>
<a href="#l66.40"></a><span id="l66.40">   /*</span>
<a href="#l66.41"></a><span id="l66.41">    * Set up an IMAP server.</span>
<a href="#l66.42"></a><span id="l66.42">    */</span>
<a href="#l66.43"></a><span id="l66.43">   setupIMAPPump();</span>
<a href="#l66.44"></a><span id="l66.44"> </span>
<a href="#l66.45"></a><span id="l66.45" class="difflineminus">-  IMAPPump.daemon.createMailbox(&quot;secondFolder&quot;, {subscribed : true});</span>
<a href="#l66.46"></a><span id="l66.46" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;secondFolder&quot;, {subscribed: true});</span>
<a href="#l66.47"></a><span id="l66.47"> </span>
<a href="#l66.48"></a><span id="l66.48">   let messages = [];</span>
<a href="#l66.49"></a><span id="l66.49">   let gMessageGenerator = new MessageGenerator();</span>
<a href="#l66.50"></a><span id="l66.50">   messages = messages.concat(gMessageGenerator.makeMessage());</span>
<a href="#l66.51"></a><span id="l66.51">   gSynthMessage = messages[0];</span>
<a href="#l66.52"></a><span id="l66.52"> </span>
<a href="#l66.53"></a><span id="l66.53">   let msgURI =</span>
<a href="#l66.54"></a><span id="l66.54">     Services.io.newURI(&quot;data:text/plain;base64,&quot; +</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l67.1"></a><span id="l67.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_trustSpamAssassin.js</span>
<a href="#l67.2"></a><span id="l67.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_trustSpamAssassin.js</span>
<a href="#l67.3"></a><span id="l67.3" class="difflineat">@@ -7,16 +7,18 @@</span>
<a href="#l67.4"></a><span id="l67.4">  *  SpamAssassin headers, and marking that as good</span>
<a href="#l67.5"></a><span id="l67.5">  *  without having the message return to the junk folder,</span>
<a href="#l67.6"></a><span id="l67.6">  *  as discussed in bug 540385.</span>
<a href="#l67.7"></a><span id="l67.7">  *</span>
<a href="#l67.8"></a><span id="l67.8">  * adapted from test_filterNeedsBody.js</span>
<a href="#l67.9"></a><span id="l67.9">  */</span>
<a href="#l67.10"></a><span id="l67.10"> </span>
<a href="#l67.11"></a><span id="l67.11"> // async support</span>
<a href="#l67.12"></a><span id="l67.12" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l67.13"></a><span id="l67.13" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l67.14"></a><span id="l67.14"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l67.15"></a><span id="l67.15"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l67.16"></a><span id="l67.16"> </span>
<a href="#l67.17"></a><span id="l67.17"> // IMAP pump</span>
<a href="#l67.18"></a><span id="l67.18"> </span>
<a href="#l67.19"></a><span id="l67.19"> // Globals</span>
<a href="#l67.20"></a><span id="l67.20"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l67.21"></a><span id="l67.21"> </span>
<a href="#l67.22"></a><span id="l67.22" class="difflineat">@@ -28,60 +30,56 @@ setupIMAPPump();</span>
<a href="#l67.23"></a><span id="l67.23"> </span>
<a href="#l67.24"></a><span id="l67.24"> var tests = [</span>
<a href="#l67.25"></a><span id="l67.25">   createJunkFolder,</span>
<a href="#l67.26"></a><span id="l67.26">   loadImapMessage,</span>
<a href="#l67.27"></a><span id="l67.27">   testMessageInJunk,</span>
<a href="#l67.28"></a><span id="l67.28">   markMessageAsGood,</span>
<a href="#l67.29"></a><span id="l67.29">   updateFoldersAndCheck,</span>
<a href="#l67.30"></a><span id="l67.30">   endTest,</span>
<a href="#l67.31"></a><span id="l67.31" class="difflineminus">-]</span>
<a href="#l67.32"></a><span id="l67.32" class="difflineplus">+];</span>
<a href="#l67.33"></a><span id="l67.33"> </span>
<a href="#l67.34"></a><span id="l67.34"> var gJunkFolder;</span>
<a href="#l67.35"></a><span id="l67.35" class="difflineminus">-function* createJunkFolder()</span>
<a href="#l67.36"></a><span id="l67.36" class="difflineminus">-{</span>
<a href="#l67.37"></a><span id="l67.37" class="difflineplus">+function* createJunkFolder() {</span>
<a href="#l67.38"></a><span id="l67.38">   IMAPPump.incomingServer.rootFolder.createSubfolder(&quot;Junk&quot;, null);</span>
<a href="#l67.39"></a><span id="l67.39" class="difflineminus">-  dl('wait for folderAdded');</span>
<a href="#l67.40"></a><span id="l67.40" class="difflineplus">+  dl(&quot;wait for folderAdded&quot;);</span>
<a href="#l67.41"></a><span id="l67.41">   yield false;</span>
<a href="#l67.42"></a><span id="l67.42">   gJunkFolder = IMAPPump.incomingServer.rootFolder.getChildNamed(&quot;Junk&quot;);</span>
<a href="#l67.43"></a><span id="l67.43">   Assert.ok(gJunkFolder instanceof Ci.nsIMsgImapMailFolder);</span>
<a href="#l67.44"></a><span id="l67.44">   gJunkFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l67.45"></a><span id="l67.45" class="difflineminus">-  dl('wait for OnStopRunningURL');</span>
<a href="#l67.46"></a><span id="l67.46" class="difflineplus">+  dl(&quot;wait for OnStopRunningURL&quot;);</span>
<a href="#l67.47"></a><span id="l67.47">   yield false;</span>
<a href="#l67.48"></a><span id="l67.48"> }</span>
<a href="#l67.49"></a><span id="l67.49"> </span>
<a href="#l67.50"></a><span id="l67.50"> /*</span>
<a href="#l67.51"></a><span id="l67.51">  * Load and update a message in the imap fake server, should move</span>
<a href="#l67.52"></a><span id="l67.52">  *  SpamAssassin-marked junk message to junk folder</span>
<a href="#l67.53"></a><span id="l67.53">  */</span>
<a href="#l67.54"></a><span id="l67.54" class="difflineminus">-function* loadImapMessage()</span>
<a href="#l67.55"></a><span id="l67.55" class="difflineminus">-{</span>
<a href="#l67.56"></a><span id="l67.56" class="difflineplus">+function* loadImapMessage() {</span>
<a href="#l67.57"></a><span id="l67.57">   IMAPPump.mailbox.addMessage(new imapMessage(specForFileName(gMessage),</span>
<a href="#l67.58"></a><span id="l67.58">                           IMAPPump.mailbox.uidnext++, []));</span>
<a href="#l67.59"></a><span id="l67.59">   /*</span>
<a href="#l67.60"></a><span id="l67.60">    * The message matched the SpamAssassin header, so it moved</span>
<a href="#l67.61"></a><span id="l67.61">    *  to the junk folder</span>
<a href="#l67.62"></a><span id="l67.62">    */</span>
<a href="#l67.63"></a><span id="l67.63">   IMAPPump.inbox.updateFolder(null);</span>
<a href="#l67.64"></a><span id="l67.64" class="difflineminus">-  dl('wait for msgsMoveCopyCompleted');</span>
<a href="#l67.65"></a><span id="l67.65" class="difflineplus">+  dl(&quot;wait for msgsMoveCopyCompleted&quot;);</span>
<a href="#l67.66"></a><span id="l67.66">   yield false;</span>
<a href="#l67.67"></a><span id="l67.67">   gJunkFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l67.68"></a><span id="l67.68" class="difflineminus">-  dl('wait for OnStopRunningURL');</span>
<a href="#l67.69"></a><span id="l67.69" class="difflineplus">+  dl(&quot;wait for OnStopRunningURL&quot;);</span>
<a href="#l67.70"></a><span id="l67.70">   yield false;</span>
<a href="#l67.71"></a><span id="l67.71"> }</span>
<a href="#l67.72"></a><span id="l67.72"> </span>
<a href="#l67.73"></a><span id="l67.73" class="difflineminus">-function* testMessageInJunk()</span>
<a href="#l67.74"></a><span id="l67.74" class="difflineminus">-{</span>
<a href="#l67.75"></a><span id="l67.75" class="difflineplus">+function* testMessageInJunk() {</span>
<a href="#l67.76"></a><span id="l67.76">   Assert.equal(0, IMAPPump.inbox.getTotalMessages(false));</span>
<a href="#l67.77"></a><span id="l67.77">   Assert.equal(1, gJunkFolder.getTotalMessages(false));</span>
<a href="#l67.78"></a><span id="l67.78">   yield true;</span>
<a href="#l67.79"></a><span id="l67.79"> }</span>
<a href="#l67.80"></a><span id="l67.80"> </span>
<a href="#l67.81"></a><span id="l67.81" class="difflineminus">-function* markMessageAsGood()</span>
<a href="#l67.82"></a><span id="l67.82" class="difflineminus">-{</span>
<a href="#l67.83"></a><span id="l67.83" class="difflineplus">+function* markMessageAsGood() {</span>
<a href="#l67.84"></a><span id="l67.84">   /*</span>
<a href="#l67.85"></a><span id="l67.85">    * This is done in the application in nsMsgDBView, which is difficult</span>
<a href="#l67.86"></a><span id="l67.86">    *  to test in xpcshell tests. We aren't really trying to test that here</span>
<a href="#l67.87"></a><span id="l67.87">    *  though, since the point of this test is working with the server-based</span>
<a href="#l67.88"></a><span id="l67.88">    *  filters. So I will simply simulate the operations that would typically</span>
<a href="#l67.89"></a><span id="l67.89">    *  be done by a manual marking of the messages.</span>
<a href="#l67.90"></a><span id="l67.90">    */</span>
<a href="#l67.91"></a><span id="l67.91">   let msgHdr = mailTestUtils.firstMsgHdr(gJunkFolder);</span>
<a href="#l67.92"></a><span id="l67.92" class="difflineat">@@ -104,41 +102,38 @@ function* markMessageAsGood()</span>
<a href="#l67.93"></a><span id="l67.93">                     in boolean isMove,</span>
<a href="#l67.94"></a><span id="l67.94">                     in nsIMsgCopyServiceListener listener,</span>
<a href="#l67.95"></a><span id="l67.95">                     in nsIMsgWindow msgWindow,</span>
<a href="#l67.96"></a><span id="l67.96">                     in boolean allowUndo);</span>
<a href="#l67.97"></a><span id="l67.97">   */</span>
<a href="#l67.98"></a><span id="l67.98"> </span>
<a href="#l67.99"></a><span id="l67.99">   MailServices.copy.CopyMessages(gJunkFolder, messages, IMAPPump.inbox, true,</span>
<a href="#l67.100"></a><span id="l67.100">                                  null, null, false);</span>
<a href="#l67.101"></a><span id="l67.101" class="difflineminus">-  dl('wait for msgsMoveCopyCompleted');</span>
<a href="#l67.102"></a><span id="l67.102" class="difflineplus">+  dl(&quot;wait for msgsMoveCopyCompleted&quot;);</span>
<a href="#l67.103"></a><span id="l67.103">   yield false;</span>
<a href="#l67.104"></a><span id="l67.104"> }</span>
<a href="#l67.105"></a><span id="l67.105"> </span>
<a href="#l67.106"></a><span id="l67.106" class="difflineminus">-function* updateFoldersAndCheck()</span>
<a href="#l67.107"></a><span id="l67.107" class="difflineminus">-{</span>
<a href="#l67.108"></a><span id="l67.108" class="difflineplus">+function* updateFoldersAndCheck() {</span>
<a href="#l67.109"></a><span id="l67.109">   IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l67.110"></a><span id="l67.110" class="difflineminus">-  dl('wait for OnStopRunningURL');</span>
<a href="#l67.111"></a><span id="l67.111" class="difflineplus">+  dl(&quot;wait for OnStopRunningURL&quot;);</span>
<a href="#l67.112"></a><span id="l67.112">   yield false;</span>
<a href="#l67.113"></a><span id="l67.113">   gJunkFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l67.114"></a><span id="l67.114" class="difflineminus">-  dl('wait for OnStopRunningURL');</span>
<a href="#l67.115"></a><span id="l67.115" class="difflineplus">+  dl(&quot;wait for OnStopRunningURL&quot;);</span>
<a href="#l67.116"></a><span id="l67.116">   yield false;</span>
<a href="#l67.117"></a><span id="l67.117">   // bug 540385 causes this test to fail</span>
<a href="#l67.118"></a><span id="l67.118">   Assert.equal(1, IMAPPump.inbox.getTotalMessages(false));</span>
<a href="#l67.119"></a><span id="l67.119">   Assert.equal(0, gJunkFolder.getTotalMessages(false));</span>
<a href="#l67.120"></a><span id="l67.120">   yield true;</span>
<a href="#l67.121"></a><span id="l67.121"> }</span>
<a href="#l67.122"></a><span id="l67.122"> </span>
<a href="#l67.123"></a><span id="l67.123" class="difflineminus">-function endTest()</span>
<a href="#l67.124"></a><span id="l67.124" class="difflineminus">-{</span>
<a href="#l67.125"></a><span id="l67.125" class="difflineplus">+function endTest() {</span>
<a href="#l67.126"></a><span id="l67.126">   teardownIMAPPump();</span>
<a href="#l67.127"></a><span id="l67.127"> }</span>
<a href="#l67.128"></a><span id="l67.128"> </span>
<a href="#l67.129"></a><span id="l67.129" class="difflineminus">-function run_test()</span>
<a href="#l67.130"></a><span id="l67.130" class="difflineminus">-{</span>
<a href="#l67.131"></a><span id="l67.131" class="difflineplus">+function run_test() {</span>
<a href="#l67.132"></a><span id="l67.132">   let server = IMAPPump.incomingServer;</span>
<a href="#l67.133"></a><span id="l67.133">   let spamSettings = server.spamSettings;</span>
<a href="#l67.134"></a><span id="l67.134">   server.setBoolValue(&quot;useServerFilter&quot;, true);</span>
<a href="#l67.135"></a><span id="l67.135">   server.setCharValue(&quot;serverFilterName&quot;, &quot;SpamAssassin&quot;);</span>
<a href="#l67.136"></a><span id="l67.136">   server.setIntValue(&quot;serverFilterTrustFlags&quot;, Ci.nsISpamSettings.TRUST_POSITIVES);</span>
<a href="#l67.137"></a><span id="l67.137">   server.setBoolValue(&quot;moveOnSpam&quot;, true);</span>
<a href="#l67.138"></a><span id="l67.138">   server.setIntValue(&quot;moveTargetMode&quot;, Ci.nsISpamSettings.MOVE_TARGET_MODE_ACCOUNT);</span>
<a href="#l67.139"></a><span id="l67.139">   server.setCharValue(&quot;spamActionTargetAccount&quot;, server.serverURI);</span>
<a href="#l67.140"></a><span id="l67.140" class="difflineat">@@ -149,50 +144,45 @@ function run_test()</span>
<a href="#l67.141"></a><span id="l67.141">   const nsIMFNService = Ci.nsIMsgFolderNotificationService;</span>
<a href="#l67.142"></a><span id="l67.142"> </span>
<a href="#l67.143"></a><span id="l67.143">   let flags =</span>
<a href="#l67.144"></a><span id="l67.144">         nsIMFNService.msgsMoveCopyCompleted |</span>
<a href="#l67.145"></a><span id="l67.145">         nsIMFNService.folderAdded |</span>
<a href="#l67.146"></a><span id="l67.146">         nsIMFNService.msgAdded;</span>
<a href="#l67.147"></a><span id="l67.147">   MailServices.mfn.addListener(mfnListener, flags);</span>
<a href="#l67.148"></a><span id="l67.148"> </span>
<a href="#l67.149"></a><span id="l67.149" class="difflineminus">-  //start first test</span>
<a href="#l67.150"></a><span id="l67.150" class="difflineplus">+  // start first test</span>
<a href="#l67.151"></a><span id="l67.151">   async_run_tests(tests);</span>
<a href="#l67.152"></a><span id="l67.152"> }</span>
<a href="#l67.153"></a><span id="l67.153"> </span>
<a href="#l67.154"></a><span id="l67.154" class="difflineminus">-var mfnListener =</span>
<a href="#l67.155"></a><span id="l67.155" class="difflineminus">-{</span>
<a href="#l67.156"></a><span id="l67.156" class="difflineminus">-  msgsMoveCopyCompleted: function (aMove, aSrcMsgs, aDestFolder, aDestMsgs)</span>
<a href="#l67.157"></a><span id="l67.157" class="difflineminus">-  {</span>
<a href="#l67.158"></a><span id="l67.158" class="difflineminus">-    dl('msgsMoveCopyCompleted to folder ' + aDestFolder.name);</span>
<a href="#l67.159"></a><span id="l67.159" class="difflineplus">+var mfnListener = {</span>
<a href="#l67.160"></a><span id="l67.160" class="difflineplus">+  msgsMoveCopyCompleted(aMove, aSrcMsgs, aDestFolder, aDestMsgs) {</span>
<a href="#l67.161"></a><span id="l67.161" class="difflineplus">+    dl(&quot;msgsMoveCopyCompleted to folder &quot; + aDestFolder.name);</span>
<a href="#l67.162"></a><span id="l67.162">     async_driver();</span>
<a href="#l67.163"></a><span id="l67.163">   },</span>
<a href="#l67.164"></a><span id="l67.164"> </span>
<a href="#l67.165"></a><span id="l67.165" class="difflineminus">-  folderAdded: function (aFolder)</span>
<a href="#l67.166"></a><span id="l67.166" class="difflineminus">-  {</span>
<a href="#l67.167"></a><span id="l67.167" class="difflineminus">-    dl('folderAdded &lt;' + aFolder.name + '&gt;');</span>
<a href="#l67.168"></a><span id="l67.168" class="difflineplus">+  folderAdded(aFolder) {</span>
<a href="#l67.169"></a><span id="l67.169" class="difflineplus">+    dl(&quot;folderAdded &lt;&quot; + aFolder.name + &quot;&gt;&quot;);</span>
<a href="#l67.170"></a><span id="l67.170">     // we are only using async add on the Junk folder</span>
<a href="#l67.171"></a><span id="l67.171">     if (aFolder.name == &quot;Junk&quot;)</span>
<a href="#l67.172"></a><span id="l67.172">       async_driver();</span>
<a href="#l67.173"></a><span id="l67.173">   },</span>
<a href="#l67.174"></a><span id="l67.174"> </span>
<a href="#l67.175"></a><span id="l67.175" class="difflineminus">-  msgAdded: function msgAdded(aMsg)</span>
<a href="#l67.176"></a><span id="l67.176" class="difflineminus">-  {</span>
<a href="#l67.177"></a><span id="l67.177" class="difflineminus">-    dl('msgAdded with subject &lt;' + aMsg.subject + '&gt;');</span>
<a href="#l67.178"></a><span id="l67.178" class="difflineminus">-  }</span>
<a href="#l67.179"></a><span id="l67.179" class="difflineplus">+  msgAdded(aMsg) {</span>
<a href="#l67.180"></a><span id="l67.180" class="difflineplus">+    dl(&quot;msgAdded with subject &lt;&quot; + aMsg.subject + &quot;&gt;&quot;);</span>
<a href="#l67.181"></a><span id="l67.181" class="difflineplus">+  },</span>
<a href="#l67.182"></a><span id="l67.182"> };</span>
<a href="#l67.183"></a><span id="l67.183"> </span>
<a href="#l67.184"></a><span id="l67.184"> /*</span>
<a href="#l67.185"></a><span id="l67.185">  * helper functions</span>
<a href="#l67.186"></a><span id="l67.186">  */</span>
<a href="#l67.187"></a><span id="l67.187"> </span>
<a href="#l67.188"></a><span id="l67.188"> // given a test file, return the file uri spec</span>
<a href="#l67.189"></a><span id="l67.189" class="difflineminus">-function specForFileName(aFileName)</span>
<a href="#l67.190"></a><span id="l67.190" class="difflineminus">-{</span>
<a href="#l67.191"></a><span id="l67.191" class="difflineplus">+function specForFileName(aFileName) {</span>
<a href="#l67.192"></a><span id="l67.192">   let file = do_get_file(&quot;../../../data/&quot; + aFileName);</span>
<a href="#l67.193"></a><span id="l67.193">   let msgfileuri = Services.io.newFileURI(file).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l67.194"></a><span id="l67.194">   return msgfileuri.spec;</span>
<a href="#l67.195"></a><span id="l67.195"> }</span>
<a href="#l67.196"></a><span id="l67.196"> </span>
<a href="#l67.197"></a><span id="l67.197"> // quick shorthand for output of a line of text.</span>
<a href="#l67.198"></a><span id="l67.198"> function dl(text) {</span>
<a href="#l67.199"></a><span id="l67.199" class="difflineminus">-  dump(text + '\n');</span>
<a href="#l67.200"></a><span id="l67.200" class="difflineplus">+  dump(text + &quot;\n&quot;);</span>
<a href="#l67.201"></a><span id="l67.201"> }</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:31Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

