<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 25469:04e98cdf20613f973d96dcbf5ca6bc659c594fa2</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 04e98cdf20613f973d96dcbf5ca6bc659c594fa2" />
<meta property="og:url" content="/comm-central/rev/04e98cdf20613f973d96dcbf5ca6bc659c594fa2" />
<meta property="og:description" content="Bug 1503421 - Context menus WebExtensions API; r=Fallen" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 04e98cdf20613f973d96dcbf5ca6bc659c594fa2 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/04e98cdf20613f973d96dcbf5ca6bc659c594fa2">shortlog</a> |
<a href="/comm-central/log/04e98cdf20613f973d96dcbf5ca6bc659c594fa2">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/04e98cdf20613f973d96dcbf5ca6bc659c594fa2">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/04e98cdf20613f973d96dcbf5ca6bc659c594fa2">files</a> |
changeset |
<a href="/comm-central/raw-rev/04e98cdf20613f973d96dcbf5ca6bc659c594fa2">raw</a>  | <a href="/comm-central/archive/04e98cdf20613f973d96dcbf5ca6bc659c594fa2.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1503421">Bug 1503421</a> - Context menus WebExtensions API; r=Fallen
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Sun, 30 Dec 2018 20:33:02 +1300</td></tr>

<tr>
 <td>changeset 25469</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/04e98cdf20613f973d96dcbf5ca6bc659c594fa2">04e98cdf20613f973d96dcbf5ca6bc659c594fa2</a></td>
</tr>



<tr>
<td>parent 25468</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/4331140b9077f55277917f2a0d8f2d2f9e839e70">4331140b9077f55277917f2a0d8f2d2f9e839e70</a>
</td>
</tr>

<tr>
<td>child 25470</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/da68367e23e51f72ccd8e1aec01b76eee6732fbd">da68367e23e51f72ccd8e1aec01b76eee6732fbd</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=04e98cdf20613f973d96dcbf5ca6bc659c594fa2">15283</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Sun, 30 Dec 2018 07:33:51 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@da68367e23e5 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=da68367e23e51f72ccd8e1aec01b76eee6732fbd">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=da68367e23e51f72ccd8e1aec01b76eee6732fbd&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=da68367e23e51f72ccd8e1aec01b76eee6732fbd&newProject=comm-central&newRevision=4b4bc20aa6deba71751a8e0043d9c07b8faeae00&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=da68367e23e51f72ccd8e1aec01b76eee6732fbd&newProject=comm-central&newRevision=4b4bc20aa6deba71751a8e0043d9c07b8faeae00&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=da68367e23e51f72ccd8e1aec01b76eee6732fbd&newProject=comm-central&newRevision=4b4bc20aa6deba71751a8e0043d9c07b8faeae00&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Fallen%29&revcount=50">Fallen</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1503421">1503421</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1503421">Bug 1503421</a> - Context menus WebExtensions API; r=Fallen</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/base/content/nsContextMenu.js">mail/base/content/nsContextMenu.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/base/content/nsContextMenu.js">file</a> |
<a href="/comm-central/annotate/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/base/content/nsContextMenu.js">annotate</a> |
<a href="/comm-central/diff/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/base/content/nsContextMenu.js">diff</a> |
<a href="/comm-central/comparison/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/base/content/nsContextMenu.js">comparison</a> |
<a href="/comm-central/log/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/base/content/nsContextMenu.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/base/content/tabmail.xml">mail/base/content/tabmail.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/base/content/tabmail.xml">file</a> |
<a href="/comm-central/annotate/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/base/content/tabmail.xml">annotate</a> |
<a href="/comm-central/diff/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/base/content/tabmail.xml">diff</a> |
<a href="/comm-central/comparison/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/base/content/tabmail.xml">comparison</a> |
<a href="/comm-central/log/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/base/content/tabmail.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/child/.eslintrc.js">mail/components/extensions/child/.eslintrc.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/child/.eslintrc.js">file</a> |
<a href="/comm-central/annotate/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/child/.eslintrc.js">annotate</a> |
<a href="/comm-central/diff/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/child/.eslintrc.js">diff</a> |
<a href="/comm-central/comparison/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/child/.eslintrc.js">comparison</a> |
<a href="/comm-central/log/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/child/.eslintrc.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/child/ext-mail.js">mail/components/extensions/child/ext-mail.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/child/ext-mail.js">file</a> |
<a href="/comm-central/annotate/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/child/ext-mail.js">annotate</a> |
<a href="/comm-central/diff/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/child/ext-mail.js">diff</a> |
<a href="/comm-central/comparison/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/child/ext-mail.js">comparison</a> |
<a href="/comm-central/log/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/child/ext-mail.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/child/ext-menus-child.js">mail/components/extensions/child/ext-menus-child.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/child/ext-menus-child.js">file</a> |
<a href="/comm-central/annotate/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/child/ext-menus-child.js">annotate</a> |
<a href="/comm-central/diff/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/child/ext-menus-child.js">diff</a> |
<a href="/comm-central/comparison/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/child/ext-menus-child.js">comparison</a> |
<a href="/comm-central/log/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/child/ext-menus-child.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/child/ext-menus.js">mail/components/extensions/child/ext-menus.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/child/ext-menus.js">file</a> |
<a href="/comm-central/annotate/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/child/ext-menus.js">annotate</a> |
<a href="/comm-central/diff/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/child/ext-menus.js">diff</a> |
<a href="/comm-central/comparison/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/child/ext-menus.js">comparison</a> |
<a href="/comm-central/log/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/child/ext-menus.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/ext-mail.json">mail/components/extensions/ext-mail.json</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/ext-mail.json">file</a> |
<a href="/comm-central/annotate/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/ext-mail.json">annotate</a> |
<a href="/comm-central/diff/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/ext-mail.json">diff</a> |
<a href="/comm-central/comparison/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/ext-mail.json">comparison</a> |
<a href="/comm-central/log/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/ext-mail.json">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/jar.mn">mail/components/extensions/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/jar.mn">file</a> |
<a href="/comm-central/annotate/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/jar.mn">annotate</a> |
<a href="/comm-central/diff/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/jar.mn">diff</a> |
<a href="/comm-central/comparison/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/jar.mn">comparison</a> |
<a href="/comm-central/log/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/parent/ext-mail.js">mail/components/extensions/parent/ext-mail.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/parent/ext-mail.js">file</a> |
<a href="/comm-central/annotate/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/parent/ext-mail.js">annotate</a> |
<a href="/comm-central/diff/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/parent/ext-mail.js">diff</a> |
<a href="/comm-central/comparison/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/parent/ext-mail.js">comparison</a> |
<a href="/comm-central/log/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/parent/ext-mail.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/parent/ext-menus.js">mail/components/extensions/parent/ext-menus.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/parent/ext-menus.js">file</a> |
<a href="/comm-central/annotate/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/parent/ext-menus.js">annotate</a> |
<a href="/comm-central/diff/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/parent/ext-menus.js">diff</a> |
<a href="/comm-central/comparison/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/parent/ext-menus.js">comparison</a> |
<a href="/comm-central/log/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/parent/ext-menus.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/schemas/menus.json">mail/components/extensions/schemas/menus.json</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/schemas/menus.json">file</a> |
<a href="/comm-central/annotate/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/schemas/menus.json">annotate</a> |
<a href="/comm-central/diff/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/schemas/menus.json">diff</a> |
<a href="/comm-central/comparison/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/schemas/menus.json">comparison</a> |
<a href="/comm-central/log/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/schemas/menus.json">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/schemas/menus_child.json">mail/components/extensions/schemas/menus_child.json</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/schemas/menus_child.json">file</a> |
<a href="/comm-central/annotate/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/schemas/menus_child.json">annotate</a> |
<a href="/comm-central/diff/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/schemas/menus_child.json">diff</a> |
<a href="/comm-central/comparison/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/schemas/menus_child.json">comparison</a> |
<a href="/comm-central/log/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/schemas/menus_child.json">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/test/browser/browser.ini">mail/components/extensions/test/browser/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/test/browser/browser.ini">file</a> |
<a href="/comm-central/annotate/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/test/browser/browser.ini">annotate</a> |
<a href="/comm-central/diff/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/test/browser/browser.ini">diff</a> |
<a href="/comm-central/comparison/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/test/browser/browser.ini">comparison</a> |
<a href="/comm-central/log/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/test/browser/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/test/browser/browser_ext_menus.js">mail/components/extensions/test/browser/browser_ext_menus.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/test/browser/browser_ext_menus.js">file</a> |
<a href="/comm-central/annotate/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/test/browser/browser_ext_menus.js">annotate</a> |
<a href="/comm-central/diff/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/test/browser/browser_ext_menus.js">diff</a> |
<a href="/comm-central/comparison/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/test/browser/browser_ext_menus.js">comparison</a> |
<a href="/comm-central/log/04e98cdf20613f973d96dcbf5ca6bc659c594fa2/mail/components/extensions/test/browser/browser_ext_menus.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/nsContextMenu.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/nsContextMenu.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -78,16 +78,42 @@ nsContextMenu.prototype = {</span>
<a href="#l1.4"></a><span id="l1.4">     }</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6">     this.isContentSelected = this.isContentSelection();</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8">     this.hasPageMenu = false;</span>
<a href="#l1.9"></a><span id="l1.9">     if (!aIsShift) {</span>
<a href="#l1.10"></a><span id="l1.10">       this.hasPageMenu = PageMenuParent.buildAndAddToPopup(this.target,</span>
<a href="#l1.11"></a><span id="l1.11">                                                            aPopup);</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+      let subject = {</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+        menu: aPopup,</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+        tab: document.getElementById(&quot;tabmail&quot;).currentTabInfo,</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+        isContentSelected: this.isContentSelected,</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+        inFrame: this.inFrame,</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+        isTextSelected: this.isTextSelected,</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+        onTextInput: this.onTextInput,</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+        onLink: this.onLink,</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+        onImage: this.onImage,</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+        onVideo: this.onVideo,</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+        onAudio: this.onAudio,</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+        onCanvas: this.onCanvas,</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+        onEditableArea: this.onEditableArea,</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+        srcUrl: this.mediaURL,</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+        pageUrl: this.browser ? this.browser.currentURI.spec : undefined,</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+        linkUrl: this.linkURL,</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+        selectionText: this.isTextSelected ? this.selectionInfo.text : undefined,</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+      };</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+      if (document.popupNode.closest(&quot;tree&quot;) == gFolderDisplay.tree) {</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+        subject.displayedFolder = gFolderDisplay.view.displayedFolder;</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+        subject.selectedMessages = gFolderDisplay.selectedMessages;</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+      }</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+      subject.wrappedJSObject = subject;</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+      Services.obs.notifyObservers(subject, &quot;on-build-contextmenu&quot;);</span>
<a href="#l1.38"></a><span id="l1.38">     }</span>
<a href="#l1.39"></a><span id="l1.39"> </span>
<a href="#l1.40"></a><span id="l1.40">     this.initItems();</span>
<a href="#l1.41"></a><span id="l1.41"> </span>
<a href="#l1.42"></a><span id="l1.42">     // If all items in the menu are hidden, set this.shouldDisplay to false</span>
<a href="#l1.43"></a><span id="l1.43">     // so that the callers know to not even display the empty menu.</span>
<a href="#l1.44"></a><span id="l1.44">     let contextPopup = document.getElementById(&quot;mailContext&quot;);</span>
<a href="#l1.45"></a><span id="l1.45">     for (let item of contextPopup.children) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/content/tabmail.xml</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/content/tabmail.xml</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1827,16 +1827,24 @@</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5">       &lt;property name=&quot;linkedBrowser&quot;&gt;</span>
<a href="#l2.6"></a><span id="l2.6">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l2.7"></a><span id="l2.7">           let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l2.8"></a><span id="l2.8">           let tab = tabmail._getTabContextForTabbyThing(this, false)[1];</span>
<a href="#l2.9"></a><span id="l2.9">           return tabmail.getBrowserForTab(tab);</span>
<a href="#l2.10"></a><span id="l2.10">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l2.11"></a><span id="l2.11">       &lt;/property&gt;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+      &lt;property name=&quot;mode&quot;&gt;</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+          let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+          let tab = tabmail._getTabContextForTabbyThing(this, false)[1];</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+          return tab.mode;</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+        ]]&gt;&lt;/getter&gt;</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+      &lt;/property&gt;</span>
<a href="#l2.20"></a><span id="l2.20">     &lt;/implementation&gt;</span>
<a href="#l2.21"></a><span id="l2.21"> </span>
<a href="#l2.22"></a><span id="l2.22">     &lt;handlers&gt;</span>
<a href="#l2.23"></a><span id="l2.23">       &lt;handler event=&quot;mouseover&quot;&gt;</span>
<a href="#l2.24"></a><span id="l2.24">         var anonid = event.originalTarget.getAttribute(&quot;anonid&quot;);</span>
<a href="#l2.25"></a><span id="l2.25">         if (anonid == &quot;close-button&quot;)</span>
<a href="#l2.26"></a><span id="l2.26">           this.mOverCloseButton = true;</span>
<a href="#l2.27"></a><span id="l2.27">       &lt;/handler&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/components/extensions/child/.eslintrc.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/components/extensions/child/.eslintrc.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,13 +1,15 @@</span>
<a href="#l3.4"></a><span id="l3.4"> &quot;use strict&quot;;</span>
<a href="#l3.5"></a><span id="l3.5"> </span>
<a href="#l3.6"></a><span id="l3.6"> module.exports = {</span>
<a href="#l3.7"></a><span id="l3.7">   &quot;globals&quot;: {</span>
<a href="#l3.8"></a><span id="l3.8">     // These are defined in the WebExtension script scopes by ExtensionCommon.jsm.</span>
<a href="#l3.9"></a><span id="l3.9">     // From toolkit/components/extensions/.eslintrc.js.</span>
<a href="#l3.10"></a><span id="l3.10">     &quot;ExtensionAPI&quot;: true,</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+    &quot;ExtensionCommon&quot;: true,</span>
<a href="#l3.12"></a><span id="l3.12">     &quot;extensions&quot;: true,</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+    &quot;ExtensionUtils&quot;: true,</span>
<a href="#l3.14"></a><span id="l3.14"> </span>
<a href="#l3.15"></a><span id="l3.15">     // From toolkit/components/extensions/child/.eslintrc.js.</span>
<a href="#l3.16"></a><span id="l3.16">     &quot;EventManager&quot;: true,</span>
<a href="#l3.17"></a><span id="l3.17">   },</span>
<a href="#l3.18"></a><span id="l3.18"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/components/extensions/child/ext-mail.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/components/extensions/child/ext-mail.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1,15 +1,29 @@</span>
<a href="#l4.4"></a><span id="l4.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.5"></a><span id="l4.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.6"></a><span id="l4.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8"> &quot;use strict&quot;;</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10"> extensions.registerModules({</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+  menus: {</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+    url: &quot;chrome://messenger/content/child/ext-menus.js&quot;,</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+    scopes: [&quot;addon_child&quot;],</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+    paths: [</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+      [&quot;menus&quot;],</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+    ],</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+  },</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+  menusChild: {</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+    url: &quot;chrome://messenger/content/child/ext-menus-child.js&quot;,</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+    scopes: [&quot;addon_child&quot;, &quot;devtools_child&quot;],</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+    paths: [</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+      [&quot;menus&quot;],</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+    ],</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+  },</span>
<a href="#l4.25"></a><span id="l4.25">   tabs: {</span>
<a href="#l4.26"></a><span id="l4.26">     url: &quot;chrome://messenger/content/child/ext-tabs.js&quot;,</span>
<a href="#l4.27"></a><span id="l4.27">     scopes: [&quot;addon_child&quot;],</span>
<a href="#l4.28"></a><span id="l4.28">     paths: [</span>
<a href="#l4.29"></a><span id="l4.29">       [&quot;tabs&quot;],</span>
<a href="#l4.30"></a><span id="l4.30">     ],</span>
<a href="#l4.31"></a><span id="l4.31">   },</span>
<a href="#l4.32"></a><span id="l4.32"> });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">new file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- /dev/null</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ b/mail/components/extensions/child/ext-menus-child.js</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -0,0 +1,24 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineplus">+</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;ContextMenuChild&quot;,</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineplus">+                               &quot;resource:///actors/ContextMenuChild.jsm&quot;);</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+this.menusChild = class extends ExtensionAPI {</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+  getAPI(context) {</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+    return {</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+      menus: {</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+        getTargetElement(targetElementId) {</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+          let element;</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+          let lastMenuTarget = ContextMenuChild.getLastTarget(context.messageManager);</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+          if (lastMenuTarget &amp;&amp; Math.floor(lastMenuTarget.timeStamp) === targetElementId) {</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+            element = lastMenuTarget.targetRef.get();</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+          }</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+          if (element &amp;&amp; element.getRootNode({composed: true}) === context.contentWindow.document) {</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+            return element;</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+          }</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+          return null;</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+        },</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+      },</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+    };</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+  }</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">new file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- /dev/null</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ b/mail/components/extensions/child/ext-menus.js</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -0,0 +1,260 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineplus">+/* -*- Mode: indent-tabs-mode: nil; js-indent-level: 2 -*- */</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineplus">+/* vim: set sts=2 sw=2 et tw=80: */</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineplus">+</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;Services&quot;,</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineplus">+                               &quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineplus">+</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+var {</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+  withHandlingUserInput,</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+} = ExtensionCommon;</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+var {</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+  ExtensionError,</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+} = ExtensionUtils;</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+// If id is not specified for an item we use an integer.</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+// This ID need only be unique within a single addon. Since all addon code that</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+// can use this API runs in the same process, this local variable suffices.</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+var gNextMenuItemID = 0;</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+// Map[Extension -&gt; Map[string or id, ContextMenusClickPropHandler]]</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+var gPropHandlers = new Map();</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+// The menus API supports an &quot;onclick&quot; attribute in the create/update</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+// methods to register a callback. This class manages these onclick properties.</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+class ContextMenusClickPropHandler {</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+  constructor(context) {</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+    this.context = context;</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+    // Map[string or integer -&gt; callback]</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+    this.onclickMap = new Map();</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+    this.dispatchEvent = this.dispatchEvent.bind(this);</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+  }</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+  // A listener on menus.onClicked that forwards the event to the only</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+  // listener, if any.</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+  dispatchEvent(info, tab) {</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+    let onclick = this.onclickMap.get(info.menuItemId);</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+    if (onclick) {</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+      // No need for runSafe or anything because we are already being run inside</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+      // an event handler -- the event is just being forwarded to the actual</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+      // handler.</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+      withHandlingUserInput(this.context.contentWindow, () =&gt; onclick(info, tab));</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+    }</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+  }</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+  // Sets the `onclick` handler for the given menu item.</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+  // The `onclick` function MUST be owned by `this.context`.</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+  setListener(id, onclick) {</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+    if (this.onclickMap.size === 0) {</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+      this.context.childManager.getParentEvent(&quot;menus.onClicked&quot;).addListener(this.dispatchEvent);</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+      this.context.callOnClose(this);</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+    }</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+    this.onclickMap.set(id, onclick);</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+    let propHandlerMap = gPropHandlers.get(this.context.extension);</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+    if (!propHandlerMap) {</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineplus">+      propHandlerMap = new Map();</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+    } else {</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+      // If the current callback was created in a different context, remove it</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+      // from the other context.</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineplus">+      let propHandler = propHandlerMap.get(id);</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+      if (propHandler &amp;&amp; propHandler !== this) {</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+        propHandler.unsetListener(id);</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+      }</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+    }</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+    propHandlerMap.set(id, this);</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+    gPropHandlers.set(this.context.extension, propHandlerMap);</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+  }</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+  // Deletes the `onclick` handler for the given menu item.</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+  // The `onclick` function MUST be owned by `this.context`.</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineplus">+  unsetListener(id) {</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineplus">+    if (!this.onclickMap.delete(id)) {</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineplus">+      return;</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineplus">+    }</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineplus">+    if (this.onclickMap.size === 0) {</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineplus">+      this.context.childManager.getParentEvent(&quot;menus.onClicked&quot;).removeListener(this.dispatchEvent);</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineplus">+      this.context.forgetOnClose(this);</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineplus">+    }</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineplus">+    let propHandlerMap = gPropHandlers.get(this.context.extension);</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineplus">+    propHandlerMap.delete(id);</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineplus">+    if (propHandlerMap.size === 0) {</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineplus">+      gPropHandlers.delete(this.context.extension);</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineplus">+    }</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineplus">+  }</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineplus">+</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineplus">+  // Deletes the `onclick` handler for the given menu item, if any, regardless</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineplus">+  // of the context where it was created.</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineplus">+  unsetListenerFromAnyContext(id) {</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineplus">+    let propHandlerMap = gPropHandlers.get(this.context.extension);</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineplus">+    let propHandler = propHandlerMap &amp;&amp; propHandlerMap.get(id);</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineplus">+    if (propHandler) {</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineplus">+      propHandler.unsetListener(id);</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineplus">+    }</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineplus">+  }</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineplus">+</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineplus">+  // Remove all `onclick` handlers of the extension.</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineplus">+  deleteAllListenersFromExtension() {</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineplus">+    let propHandlerMap = gPropHandlers.get(this.context.extension);</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineplus">+    if (propHandlerMap) {</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineplus">+      for (let [id, propHandler] of propHandlerMap) {</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineplus">+        propHandler.unsetListener(id);</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineplus">+      }</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineplus">+    }</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineplus">+  }</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineplus">+</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineplus">+  // Removes all `onclick` handlers from this context.</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineplus">+  close() {</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineplus">+    for (let id of this.onclickMap.keys()) {</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineplus">+      this.unsetListener(id);</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineplus">+    }</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineplus">+  }</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineplus">+}</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineplus">+</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineplus">+this.menus = class extends ExtensionAPI {</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineplus">+  getAPI(context) {</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineplus">+    let onClickedProp = new ContextMenusClickPropHandler(context);</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineplus">+    let pendingMenuEvent;</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineplus">+</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineplus">+    return {</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineplus">+      menus: {</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineplus">+        create(createProperties, callback) {</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineplus">+          if (createProperties.id === null) {</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineplus">+            createProperties.id = ++gNextMenuItemID;</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineplus">+          }</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineplus">+          let {onclick} = createProperties;</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineplus">+          delete createProperties.onclick;</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineplus">+          context.childManager.callParentAsyncFunction(&quot;menus.create&quot;, [</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineplus">+            createProperties,</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineplus">+          ]).then(() =&gt; {</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineplus">+            if (onclick) {</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineplus">+              onClickedProp.setListener(createProperties.id, onclick);</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineplus">+            }</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineplus">+            if (callback) {</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineplus">+              context.runSafeWithoutClone(callback);</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineplus">+            }</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineplus">+          }).catch(error =&gt; {</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineplus">+            context.withLastError(error, null, () =&gt; {</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineplus">+              if (callback) {</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineplus">+                context.runSafeWithoutClone(callback);</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineplus">+              }</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineplus">+            });</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineplus">+          });</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineplus">+          return createProperties.id;</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineplus">+        },</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineplus">+</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineplus">+        update(id, updateProperties) {</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineplus">+          let {onclick} = updateProperties;</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineplus">+          delete updateProperties.onclick;</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineplus">+          return context.childManager.callParentAsyncFunction(&quot;menus.update&quot;, [</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineplus">+            id,</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineplus">+            updateProperties,</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineplus">+          ]).then(() =&gt; {</span>
<a href="#l6.158"></a><span id="l6.158" class="difflineplus">+            if (onclick) {</span>
<a href="#l6.159"></a><span id="l6.159" class="difflineplus">+              onClickedProp.setListener(id, onclick);</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineplus">+            } else if (onclick === null) {</span>
<a href="#l6.161"></a><span id="l6.161" class="difflineplus">+              onClickedProp.unsetListenerFromAnyContext(id);</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineplus">+            }</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineplus">+            // else onclick is not set so it should not be changed.</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineplus">+          });</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineplus">+        },</span>
<a href="#l6.166"></a><span id="l6.166" class="difflineplus">+</span>
<a href="#l6.167"></a><span id="l6.167" class="difflineplus">+        remove(id) {</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineplus">+          onClickedProp.unsetListenerFromAnyContext(id);</span>
<a href="#l6.169"></a><span id="l6.169" class="difflineplus">+          return context.childManager.callParentAsyncFunction(&quot;menus.remove&quot;, [</span>
<a href="#l6.170"></a><span id="l6.170" class="difflineplus">+            id,</span>
<a href="#l6.171"></a><span id="l6.171" class="difflineplus">+          ]);</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineplus">+        },</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineplus">+</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineplus">+        removeAll() {</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineplus">+          onClickedProp.deleteAllListenersFromExtension();</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineplus">+</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineplus">+          return context.childManager.callParentAsyncFunction(&quot;menus.removeAll&quot;, []);</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineplus">+        },</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineplus">+</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineplus">+        overrideContext(contextOptions) {</span>
<a href="#l6.181"></a><span id="l6.181" class="difflineplus">+          let checkValidArg = (contextType, propKey) =&gt; {</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineplus">+            if (contextOptions.context !== contextType) {</span>
<a href="#l6.183"></a><span id="l6.183" class="difflineplus">+              if (contextOptions[propKey]) {</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineplus">+                throw new ExtensionError(`Property &quot;${propKey}&quot; can only be used with context &quot;${contextType}&quot;`);</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineplus">+              }</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineplus">+              return false;</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineplus">+            }</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineplus">+            if (contextOptions.showDefaults) {</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineplus">+              throw new ExtensionError(`Property &quot;showDefaults&quot; cannot be used with context &quot;${contextType}&quot;`);</span>
<a href="#l6.190"></a><span id="l6.190" class="difflineplus">+            }</span>
<a href="#l6.191"></a><span id="l6.191" class="difflineplus">+            if (!contextOptions[propKey]) {</span>
<a href="#l6.192"></a><span id="l6.192" class="difflineplus">+              throw new ExtensionError(`Property &quot;${propKey}&quot; is required for context &quot;${contextType}&quot;`);</span>
<a href="#l6.193"></a><span id="l6.193" class="difflineplus">+            }</span>
<a href="#l6.194"></a><span id="l6.194" class="difflineplus">+            return true;</span>
<a href="#l6.195"></a><span id="l6.195" class="difflineplus">+          };</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineplus">+          if (checkValidArg(&quot;tab&quot;, &quot;tabId&quot;)) {</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineplus">+            if (!context.extension.hasPermission(&quot;tabs&quot;)) {</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineplus">+              throw new ExtensionError(`The &quot;tab&quot; context requires the &quot;tabs&quot; permission.`);</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineplus">+            }</span>
<a href="#l6.200"></a><span id="l6.200" class="difflineplus">+          }</span>
<a href="#l6.201"></a><span id="l6.201" class="difflineplus">+          if (checkValidArg(&quot;bookmark&quot;, &quot;bookmarkId&quot;)) {</span>
<a href="#l6.202"></a><span id="l6.202" class="difflineplus">+            if (!context.extension.hasPermission(&quot;bookmarks&quot;)) {</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineplus">+              throw new ExtensionError(`The &quot;bookmark&quot; context requires the &quot;bookmarks&quot; permission.`);</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineplus">+            }</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineplus">+          }</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineplus">+</span>
<a href="#l6.207"></a><span id="l6.207" class="difflineplus">+          let webExtContextData = {</span>
<a href="#l6.208"></a><span id="l6.208" class="difflineplus">+            extensionId: context.extension.id,</span>
<a href="#l6.209"></a><span id="l6.209" class="difflineplus">+            showDefaults: contextOptions.showDefaults,</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineplus">+            overrideContext: contextOptions.context,</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineplus">+            bookmarkId: contextOptions.bookmarkId,</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineplus">+            tabId: contextOptions.tabId,</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineplus">+          };</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineplus">+</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineplus">+          if (pendingMenuEvent) {</span>
<a href="#l6.216"></a><span id="l6.216" class="difflineplus">+            // overrideContext is called more than once during the same event.</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineplus">+            pendingMenuEvent.webExtContextData = webExtContextData;</span>
<a href="#l6.218"></a><span id="l6.218" class="difflineplus">+            return;</span>
<a href="#l6.219"></a><span id="l6.219" class="difflineplus">+          }</span>
<a href="#l6.220"></a><span id="l6.220" class="difflineplus">+          pendingMenuEvent = {</span>
<a href="#l6.221"></a><span id="l6.221" class="difflineplus">+            webExtContextData,</span>
<a href="#l6.222"></a><span id="l6.222" class="difflineplus">+            observe(subject, topic, data) {</span>
<a href="#l6.223"></a><span id="l6.223" class="difflineplus">+              pendingMenuEvent = null;</span>
<a href="#l6.224"></a><span id="l6.224" class="difflineplus">+              Services.obs.removeObserver(this, &quot;on-prepare-contextmenu&quot;);</span>
<a href="#l6.225"></a><span id="l6.225" class="difflineplus">+              subject = subject.wrappedJSObject;</span>
<a href="#l6.226"></a><span id="l6.226" class="difflineplus">+              if (context.principal.subsumes(subject.context.principal)) {</span>
<a href="#l6.227"></a><span id="l6.227" class="difflineplus">+                subject.webExtContextData = this.webExtContextData;</span>
<a href="#l6.228"></a><span id="l6.228" class="difflineplus">+              }</span>
<a href="#l6.229"></a><span id="l6.229" class="difflineplus">+            },</span>
<a href="#l6.230"></a><span id="l6.230" class="difflineplus">+            run() {</span>
<a href="#l6.231"></a><span id="l6.231" class="difflineplus">+              // &quot;on-prepare-contextmenu&quot; is expected to be observed before the</span>
<a href="#l6.232"></a><span id="l6.232" class="difflineplus">+              // end of the &quot;contextmenu&quot; event dispatch. This task is queued</span>
<a href="#l6.233"></a><span id="l6.233" class="difflineplus">+              // in case that does not happen, e.g. when the menu is not shown.</span>
<a href="#l6.234"></a><span id="l6.234" class="difflineplus">+              // ... or if the method was not called during a contextmenu event.</span>
<a href="#l6.235"></a><span id="l6.235" class="difflineplus">+              if (pendingMenuEvent === this) {</span>
<a href="#l6.236"></a><span id="l6.236" class="difflineplus">+                pendingMenuEvent = null;</span>
<a href="#l6.237"></a><span id="l6.237" class="difflineplus">+                Services.obs.removeObserver(this, &quot;on-prepare-contextmenu&quot;);</span>
<a href="#l6.238"></a><span id="l6.238" class="difflineplus">+              }</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineplus">+            },</span>
<a href="#l6.240"></a><span id="l6.240" class="difflineplus">+          };</span>
<a href="#l6.241"></a><span id="l6.241" class="difflineplus">+          Services.obs.addObserver(pendingMenuEvent, &quot;on-prepare-contextmenu&quot;);</span>
<a href="#l6.242"></a><span id="l6.242" class="difflineplus">+          Services.tm.dispatchToMainThread(pendingMenuEvent);</span>
<a href="#l6.243"></a><span id="l6.243" class="difflineplus">+        },</span>
<a href="#l6.244"></a><span id="l6.244" class="difflineplus">+</span>
<a href="#l6.245"></a><span id="l6.245" class="difflineplus">+        onClicked: new EventManager({</span>
<a href="#l6.246"></a><span id="l6.246" class="difflineplus">+          context,</span>
<a href="#l6.247"></a><span id="l6.247" class="difflineplus">+          name: &quot;menus.onClicked&quot;,</span>
<a href="#l6.248"></a><span id="l6.248" class="difflineplus">+          register: fire =&gt; {</span>
<a href="#l6.249"></a><span id="l6.249" class="difflineplus">+            let listener = (info, tab) =&gt; {</span>
<a href="#l6.250"></a><span id="l6.250" class="difflineplus">+              withHandlingUserInput(context.contentWindow,</span>
<a href="#l6.251"></a><span id="l6.251" class="difflineplus">+                                    () =&gt; fire.sync(info, tab));</span>
<a href="#l6.252"></a><span id="l6.252" class="difflineplus">+            };</span>
<a href="#l6.253"></a><span id="l6.253" class="difflineplus">+</span>
<a href="#l6.254"></a><span id="l6.254" class="difflineplus">+            let event = context.childManager.getParentEvent(&quot;menus.onClicked&quot;);</span>
<a href="#l6.255"></a><span id="l6.255" class="difflineplus">+            event.addListener(listener);</span>
<a href="#l6.256"></a><span id="l6.256" class="difflineplus">+            return () =&gt; {</span>
<a href="#l6.257"></a><span id="l6.257" class="difflineplus">+              event.removeListener(listener);</span>
<a href="#l6.258"></a><span id="l6.258" class="difflineplus">+            };</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineplus">+          },</span>
<a href="#l6.260"></a><span id="l6.260" class="difflineplus">+        }).api(),</span>
<a href="#l6.261"></a><span id="l6.261" class="difflineplus">+      },</span>
<a href="#l6.262"></a><span id="l6.262" class="difflineplus">+    };</span>
<a href="#l6.263"></a><span id="l6.263" class="difflineplus">+  }</span>
<a href="#l6.264"></a><span id="l6.264" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/components/extensions/ext-mail.json</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/components/extensions/ext-mail.json</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -54,16 +54,28 @@</span>
<a href="#l7.4"></a><span id="l7.4">     &quot;url&quot;: &quot;chrome://messenger/content/parent/ext-mailTabs.js&quot;,</span>
<a href="#l7.5"></a><span id="l7.5">     &quot;schema&quot;: &quot;chrome://messenger/content/schemas/mailTabs.json&quot;,</span>
<a href="#l7.6"></a><span id="l7.6">     &quot;scopes&quot;: [&quot;addon_parent&quot;],</span>
<a href="#l7.7"></a><span id="l7.7">     &quot;manifest&quot;: [&quot;mailTabs&quot;],</span>
<a href="#l7.8"></a><span id="l7.8">     &quot;paths&quot;: [</span>
<a href="#l7.9"></a><span id="l7.9">       [&quot;mailTabs&quot;]</span>
<a href="#l7.10"></a><span id="l7.10">     ]</span>
<a href="#l7.11"></a><span id="l7.11">   },</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+  &quot;menusChild&quot;: {</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+    &quot;schema&quot;: &quot;chrome://messenger/content/schemas/menus_child.json&quot;,</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+    &quot;scopes&quot;: [&quot;addon_child&quot;, &quot;content_child&quot;, &quot;devtools_child&quot;]</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+  },</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+  &quot;menus&quot;: {</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+    &quot;url&quot;: &quot;chrome://messenger/content/parent/ext-menus.js&quot;,</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+    &quot;schema&quot;: &quot;chrome://messenger/content/schemas/menus.json&quot;,</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+    &quot;scopes&quot;: [&quot;addon_parent&quot;],</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+    &quot;paths&quot;: [</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+      [&quot;menus&quot;]</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+    ]</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+  },</span>
<a href="#l7.24"></a><span id="l7.24">   &quot;pkcs11&quot;: {</span>
<a href="#l7.25"></a><span id="l7.25">     &quot;url&quot;: &quot;chrome://messenger/content/parent/ext-pkcs11.js&quot;,</span>
<a href="#l7.26"></a><span id="l7.26">     &quot;schema&quot;: &quot;chrome://messenger/content/schemas/pkcs11.json&quot;,</span>
<a href="#l7.27"></a><span id="l7.27">     &quot;scopes&quot;: [&quot;addon_parent&quot;],</span>
<a href="#l7.28"></a><span id="l7.28">     &quot;paths&quot;: [</span>
<a href="#l7.29"></a><span id="l7.29">       [&quot;pkcs11&quot;]</span>
<a href="#l7.30"></a><span id="l7.30">     ]</span>
<a href="#l7.31"></a><span id="l7.31">   },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/components/extensions/jar.mn</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/components/extensions/jar.mn</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -2,32 +2,37 @@</span>
<a href="#l8.4"></a><span id="l8.4"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.5"></a><span id="l8.5"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7"> messenger.jar:</span>
<a href="#l8.8"></a><span id="l8.8">     content/messenger/ext-mail.json                (ext-mail.json)</span>
<a href="#l8.9"></a><span id="l8.9">     content/messenger/extension.svg                (extension.svg)</span>
<a href="#l8.10"></a><span id="l8.10"> </span>
<a href="#l8.11"></a><span id="l8.11">     content/messenger/child/ext-mail.js            (child/ext-mail.js)</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+    content/messenger/child/ext-menus-child.js     (child/ext-menus-child.js)</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+    content/messenger/child/ext-menus.js           (child/ext-menus.js)</span>
<a href="#l8.14"></a><span id="l8.14">     content/messenger/child/ext-tabs.js            (child/ext-tabs.js)</span>
<a href="#l8.15"></a><span id="l8.15"> </span>
<a href="#l8.16"></a><span id="l8.16">     content/messenger/parent/ext-addressBook.js    (parent/ext-addressBook.js)</span>
<a href="#l8.17"></a><span id="l8.17">     content/messenger/parent/ext-browserAction.js  (parent/ext-browserAction.js)</span>
<a href="#l8.18"></a><span id="l8.18">     content/messenger/parent/ext-cloudFile.js      (parent/ext-cloudFile.js)</span>
<a href="#l8.19"></a><span id="l8.19">     content/messenger/parent/ext-commands.js       (parent/ext-commands.js)</span>
<a href="#l8.20"></a><span id="l8.20">     content/messenger/parent/ext-composeAction.js  (parent/ext-composeAction.js)</span>
<a href="#l8.21"></a><span id="l8.21">     content/messenger/parent/ext-legacy.js         (parent/ext-legacy.js)</span>
<a href="#l8.22"></a><span id="l8.22">     content/messenger/parent/ext-mail.js           (parent/ext-mail.js)</span>
<a href="#l8.23"></a><span id="l8.23">     content/messenger/parent/ext-mailTabs.js       (parent/ext-mailTabs.js)</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+    content/messenger/parent/ext-menus.js          (parent/ext-menus.js)</span>
<a href="#l8.25"></a><span id="l8.25">     content/messenger/parent/ext-pkcs11.js         (../../../../browser/components/extensions/parent/ext-pkcs11.js)</span>
<a href="#l8.26"></a><span id="l8.26">     content/messenger/parent/ext-tabs.js           (parent/ext-tabs.js)</span>
<a href="#l8.27"></a><span id="l8.27">     content/messenger/parent/ext-windows.js        (parent/ext-windows.js)</span>
<a href="#l8.28"></a><span id="l8.28"> </span>
<a href="#l8.29"></a><span id="l8.29">     content/messenger/schemas/addressBook.json     (schemas/addressBook.json)</span>
<a href="#l8.30"></a><span id="l8.30">     content/messenger/schemas/browserAction.json   (schemas/browserAction.json)</span>
<a href="#l8.31"></a><span id="l8.31">     content/messenger/schemas/cloudFile.json       (schemas/cloudFile.json)</span>
<a href="#l8.32"></a><span id="l8.32">     content/messenger/schemas/commands.json        (schemas/commands.json)</span>
<a href="#l8.33"></a><span id="l8.33">     content/messenger/schemas/composeAction.json   (schemas/composeAction.json)</span>
<a href="#l8.34"></a><span id="l8.34">     content/messenger/schemas/legacy.json          (schemas/legacy.json)</span>
<a href="#l8.35"></a><span id="l8.35">     content/messenger/schemas/mailTabs.json        (schemas/mailTabs.json)</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+    content/messenger/schemas/menus.json           (schemas/menus.json)</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+    content/messenger/schemas/menus_child.json     (schemas/menus_child.json)</span>
<a href="#l8.38"></a><span id="l8.38">     content/messenger/schemas/pkcs11.json          (../../../../browser/components/extensions/schemas/pkcs11.json)</span>
<a href="#l8.39"></a><span id="l8.39">     content/messenger/schemas/tabs.json            (schemas/tabs.json)</span>
<a href="#l8.40"></a><span id="l8.40">     content/messenger/schemas/windows.json         (schemas/windows.json)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/components/extensions/parent/ext-mail.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/components/extensions/parent/ext-mail.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -501,16 +501,24 @@ class TabTracker extends TabTrackerBase </span>
<a href="#l9.4"></a><span id="l9.4"> tabTracker = new TabTracker();</span>
<a href="#l9.5"></a><span id="l9.5"> windowTracker = new WindowTracker();</span>
<a href="#l9.6"></a><span id="l9.6"> Object.assign(global, { tabTracker, windowTracker });</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8"> /**</span>
<a href="#l9.9"></a><span id="l9.9">  * Extension-specific wrapper around a Thunderbird tab.</span>
<a href="#l9.10"></a><span id="l9.10">  */</span>
<a href="#l9.11"></a><span id="l9.11"> class Tab extends TabBase {</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+  constructor(extension, nativeTab, id) {</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+    if (nativeTab.localName == &quot;tab&quot;) {</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+      let tabmail = nativeTab.ownerDocument.getElementById(&quot;tabmail&quot;);</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+      nativeTab = tabmail._getTabContextForTabbyThing(nativeTab)[1];</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+    }</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+    super(extension, nativeTab, id);</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+  }</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+</span>
<a href="#l9.20"></a><span id="l9.20">   /** Returns true if this tab is a 3-pane tab. */</span>
<a href="#l9.21"></a><span id="l9.21">   get isMail3Pane() {</span>
<a href="#l9.22"></a><span id="l9.22">     return this.nativeTab.mode.type == &quot;folder&quot;;</span>
<a href="#l9.23"></a><span id="l9.23">   }</span>
<a href="#l9.24"></a><span id="l9.24"> </span>
<a href="#l9.25"></a><span id="l9.25">   /** Overrides the matches function to enable querying for 3-pane tabs. */</span>
<a href="#l9.26"></a><span id="l9.26">   matches(queryInfo, context) {</span>
<a href="#l9.27"></a><span id="l9.27">     let result = super.matches(queryInfo, context);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">new file mode 100644</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineminus">--- /dev/null</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineplus">+++ b/mail/components/extensions/parent/ext-menus.js</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineat">@@ -0,0 +1,1043 @@</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineplus">+/* -*- Mode: indent-tabs-mode: nil; js-indent-level: 2 -*- */</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineplus">+/* vim: set sts=2 sw=2 et tw=80: */</span>
<a href="#l10.7"></a><span id="l10.7" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l10.8"></a><span id="l10.8" class="difflineplus">+</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/AppConstants.jsm&quot;);</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineplus">+</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+var {</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+  DefaultMap,</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+  ExtensionError,</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+} = ExtensionUtils;</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/ExtensionParent.jsm&quot;);</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+var {</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+  IconDetails,</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+} = ExtensionParent;</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+const ACTION_MENU_TOP_LEVEL_LIMIT = 6;</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+// Map[Extension -&gt; Map[ID -&gt; MenuItem]]</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineplus">+// Note: we want to enumerate all the menu items so</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+// this cannot be a weak map.</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineplus">+var gMenuMap = new Map();</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+// Map[Extension -&gt; MenuItem]</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+var gRootItems = new Map();</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+// Map[Extension -&gt; ID[]]</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+// Menu IDs that were eligible for being shown in the current menu.</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineplus">+var gShownMenuItems = new DefaultMap(() =&gt; []);</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+// Set of extensions that are listening to onShown.</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+var gOnShownSubscribers = new Set();</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+// If id is not specified for an item we use an integer.</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+var gNextMenuItemID = 0;</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+// Used to assign unique names to radio groups.</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+var gNextRadioGroupID = 0;</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineplus">+// The max length of a menu item's label.</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineplus">+var gMaxLabelLength = 64;</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+var gMenuBuilder = {</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+  // When a new menu is opened, this function is called and</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+  // we populate the |xulMenu| with all the items from extensions</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+  // to be displayed. We always clear all the items again when</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+  // popuphidden fires.</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineplus">+  build(contextData) {</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+    contextData = this.maybeOverrideContextData(contextData);</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineplus">+    let xulMenu = contextData.menu;</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineplus">+    xulMenu.addEventListener(&quot;popuphidden&quot;, this);</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineplus">+    this.xulMenu = xulMenu;</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineplus">+    for (let [, root] of gRootItems) {</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineplus">+      this.createAndInsertTopLevelElements(root, contextData, null);</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+    }</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+    this.afterBuildingMenu(contextData);</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineplus">+</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineplus">+    if (contextData.webExtContextData &amp;&amp; !contextData.webExtContextData.showDefaults) {</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineplus">+      // Wait until nsContextMenu.js has toggled the visibility of the default</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineplus">+      // menu items before hiding the default items.</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineplus">+      Promise.resolve().then(() =&gt; this.hideDefaultMenuItems());</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineplus">+    }</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineplus">+  },</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineplus">+</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineplus">+  maybeOverrideContextData(contextData) {</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineplus">+    let {webExtContextData} = contextData;</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineplus">+    if (!webExtContextData || !webExtContextData.overrideContext) {</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineplus">+      return contextData;</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineplus">+    }</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineplus">+    let contextDataBase = {</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineplus">+      menu: contextData.menu,</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineplus">+      // eslint-disable-next-line no-use-before-define</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineplus">+      originalViewType: getContextViewType(contextData),</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineplus">+      originalViewUrl: contextData.inFrame ? contextData.frameUrl : contextData.pageUrl,</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineplus">+      webExtContextData,</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineplus">+    };</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineplus">+    if (webExtContextData.overrideContext === &quot;tab&quot;) {</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineplus">+      // TODO: Handle invalid tabs more gracefully (instead of throwing).</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineplus">+      let tab = tabTracker.getTab(webExtContextData.tabId);</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineplus">+      return {</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineplus">+        ...contextDataBase,</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineplus">+        tab,</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineplus">+        pageUrl: tab.linkedBrowser.currentURI.spec,</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineplus">+        onTab: true,</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineplus">+      };</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineplus">+    }</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineplus">+    throw new Error(`Unexpected overrideContext: ${webExtContextData.overrideContext}`);</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineplus">+  },</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineplus">+</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineplus">+  createAndInsertTopLevelElements(root, contextData, nextSibling) {</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineplus">+    let rootElements;</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineplus">+    if (contextData.onBrowserAction || contextData.onPageAction) {</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineplus">+      if (contextData.extension.id !== root.extension.id) {</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineplus">+        return;</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineplus">+      }</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineplus">+      rootElements = this.buildTopLevelElements(root, contextData, ACTION_MENU_TOP_LEVEL_LIMIT, false);</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineplus">+</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineplus">+      // Action menu items are prepended to the menu, followed by a separator.</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineplus">+      nextSibling = nextSibling || this.xulMenu.firstElementChild;</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineplus">+      if (rootElements.length &amp;&amp; !this.itemsToCleanUp.has(nextSibling)) {</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineplus">+        rootElements.push(this.xulMenu.ownerDocument.createXULElement(&quot;menuseparator&quot;));</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineplus">+      }</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineplus">+    } else if (contextData.webExtContextData) {</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineplus">+      let {</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineplus">+        extensionId,</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineplus">+        showDefaults,</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineplus">+        overrideContext,</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineplus">+      } = contextData.webExtContextData;</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineplus">+      if (extensionId === root.extension.id) {</span>
<a href="#l10.116"></a><span id="l10.116" class="difflineplus">+        rootElements = this.buildTopLevelElements(root, contextData, Infinity, false);</span>
<a href="#l10.117"></a><span id="l10.117" class="difflineplus">+        // The extension menu should be rendered at the top, but after the navigation buttons.</span>
<a href="#l10.118"></a><span id="l10.118" class="difflineplus">+        nextSibling = nextSibling || this.xulMenu.querySelector(&quot;:scope &gt; #context-sep-navigation + *&quot;);</span>
<a href="#l10.119"></a><span id="l10.119" class="difflineplus">+        if (rootElements.length &amp;&amp; showDefaults &amp;&amp; !this.itemsToCleanUp.has(nextSibling)) {</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineplus">+          rootElements.push(this.xulMenu.ownerDocument.createXULElement(&quot;menuseparator&quot;));</span>
<a href="#l10.121"></a><span id="l10.121" class="difflineplus">+        }</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineplus">+      } else if (!showDefaults &amp;&amp; !overrideContext) {</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineplus">+        // When the default menu items should be hidden, menu items from other</span>
<a href="#l10.124"></a><span id="l10.124" class="difflineplus">+        // extensions should be hidden too.</span>
<a href="#l10.125"></a><span id="l10.125" class="difflineplus">+        return;</span>
<a href="#l10.126"></a><span id="l10.126" class="difflineplus">+      }</span>
<a href="#l10.127"></a><span id="l10.127" class="difflineplus">+      // Fall through to show default extension menu items.</span>
<a href="#l10.128"></a><span id="l10.128" class="difflineplus">+    }</span>
<a href="#l10.129"></a><span id="l10.129" class="difflineplus">+    if (!rootElements) {</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineplus">+      rootElements = this.buildTopLevelElements(root, contextData, 1, true);</span>
<a href="#l10.131"></a><span id="l10.131" class="difflineplus">+      if (rootElements.length &amp;&amp; !this.itemsToCleanUp.has(this.xulMenu.lastElementChild)) {</span>
<a href="#l10.132"></a><span id="l10.132" class="difflineplus">+        // All extension menu items are appended at the end.</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineplus">+        // Prepend separator if this is the first extension menu item.</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineplus">+        rootElements.unshift(this.xulMenu.ownerDocument.createXULElement(&quot;menuseparator&quot;));</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineplus">+      }</span>
<a href="#l10.136"></a><span id="l10.136" class="difflineplus">+    }</span>
<a href="#l10.137"></a><span id="l10.137" class="difflineplus">+</span>
<a href="#l10.138"></a><span id="l10.138" class="difflineplus">+    if (!rootElements.length) {</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineplus">+      return;</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineplus">+    }</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineplus">+</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineplus">+    if (nextSibling) {</span>
<a href="#l10.143"></a><span id="l10.143" class="difflineplus">+      nextSibling.before(...rootElements);</span>
<a href="#l10.144"></a><span id="l10.144" class="difflineplus">+    } else {</span>
<a href="#l10.145"></a><span id="l10.145" class="difflineplus">+      this.xulMenu.append(...rootElements);</span>
<a href="#l10.146"></a><span id="l10.146" class="difflineplus">+    }</span>
<a href="#l10.147"></a><span id="l10.147" class="difflineplus">+    for (let item of rootElements) {</span>
<a href="#l10.148"></a><span id="l10.148" class="difflineplus">+      this.itemsToCleanUp.add(item);</span>
<a href="#l10.149"></a><span id="l10.149" class="difflineplus">+    }</span>
<a href="#l10.150"></a><span id="l10.150" class="difflineplus">+  },</span>
<a href="#l10.151"></a><span id="l10.151" class="difflineplus">+</span>
<a href="#l10.152"></a><span id="l10.152" class="difflineplus">+  buildElementWithChildren(item, contextData) {</span>
<a href="#l10.153"></a><span id="l10.153" class="difflineplus">+    const element = this.buildSingleElement(item, contextData);</span>
<a href="#l10.154"></a><span id="l10.154" class="difflineplus">+    const children = this.buildChildren(item, contextData);</span>
<a href="#l10.155"></a><span id="l10.155" class="difflineplus">+    if (children.length) {</span>
<a href="#l10.156"></a><span id="l10.156" class="difflineplus">+      element.firstElementChild.append(...children);</span>
<a href="#l10.157"></a><span id="l10.157" class="difflineplus">+    }</span>
<a href="#l10.158"></a><span id="l10.158" class="difflineplus">+    return element;</span>
<a href="#l10.159"></a><span id="l10.159" class="difflineplus">+  },</span>
<a href="#l10.160"></a><span id="l10.160" class="difflineplus">+</span>
<a href="#l10.161"></a><span id="l10.161" class="difflineplus">+  buildChildren(item, contextData) {</span>
<a href="#l10.162"></a><span id="l10.162" class="difflineplus">+    let groupName;</span>
<a href="#l10.163"></a><span id="l10.163" class="difflineplus">+    let children = [];</span>
<a href="#l10.164"></a><span id="l10.164" class="difflineplus">+    for (let child of item.children) {</span>
<a href="#l10.165"></a><span id="l10.165" class="difflineplus">+      if (child.type == &quot;radio&quot; &amp;&amp; !child.groupName) {</span>
<a href="#l10.166"></a><span id="l10.166" class="difflineplus">+        if (!groupName) {</span>
<a href="#l10.167"></a><span id="l10.167" class="difflineplus">+          groupName = `webext-radio-group-${gNextRadioGroupID++}`;</span>
<a href="#l10.168"></a><span id="l10.168" class="difflineplus">+        }</span>
<a href="#l10.169"></a><span id="l10.169" class="difflineplus">+        child.groupName = groupName;</span>
<a href="#l10.170"></a><span id="l10.170" class="difflineplus">+      } else {</span>
<a href="#l10.171"></a><span id="l10.171" class="difflineplus">+        groupName = null;</span>
<a href="#l10.172"></a><span id="l10.172" class="difflineplus">+      }</span>
<a href="#l10.173"></a><span id="l10.173" class="difflineplus">+</span>
<a href="#l10.174"></a><span id="l10.174" class="difflineplus">+      if (child.enabledForContext(contextData)) {</span>
<a href="#l10.175"></a><span id="l10.175" class="difflineplus">+        children.push(this.buildElementWithChildren(child, contextData));</span>
<a href="#l10.176"></a><span id="l10.176" class="difflineplus">+      }</span>
<a href="#l10.177"></a><span id="l10.177" class="difflineplus">+    }</span>
<a href="#l10.178"></a><span id="l10.178" class="difflineplus">+    return children;</span>
<a href="#l10.179"></a><span id="l10.179" class="difflineplus">+  },</span>
<a href="#l10.180"></a><span id="l10.180" class="difflineplus">+</span>
<a href="#l10.181"></a><span id="l10.181" class="difflineplus">+  buildTopLevelElements(root, contextData, maxCount, forceManifestIcons) {</span>
<a href="#l10.182"></a><span id="l10.182" class="difflineplus">+    let children = this.buildChildren(root, contextData);</span>
<a href="#l10.183"></a><span id="l10.183" class="difflineplus">+</span>
<a href="#l10.184"></a><span id="l10.184" class="difflineplus">+    // TODO: Fix bug 1492969 and remove this whole if block.</span>
<a href="#l10.185"></a><span id="l10.185" class="difflineplus">+    if (children.length === 1 &amp;&amp; maxCount === 1 &amp;&amp; forceManifestIcons &amp;&amp;</span>
<a href="#l10.186"></a><span id="l10.186" class="difflineplus">+        AppConstants.platform === &quot;linux&quot; &amp;&amp;</span>
<a href="#l10.187"></a><span id="l10.187" class="difflineplus">+        children[0].getAttribute(&quot;type&quot;) === &quot;checkbox&quot;) {</span>
<a href="#l10.188"></a><span id="l10.188" class="difflineplus">+      // Keep single checkbox items in the submenu on Linux since</span>
<a href="#l10.189"></a><span id="l10.189" class="difflineplus">+      // the extension icon overlaps the checkbox otherwise.</span>
<a href="#l10.190"></a><span id="l10.190" class="difflineplus">+      maxCount = 0;</span>
<a href="#l10.191"></a><span id="l10.191" class="difflineplus">+    }</span>
<a href="#l10.192"></a><span id="l10.192" class="difflineplus">+</span>
<a href="#l10.193"></a><span id="l10.193" class="difflineplus">+    if (children.length &gt; maxCount) {</span>
<a href="#l10.194"></a><span id="l10.194" class="difflineplus">+      // Move excess items into submenu.</span>
<a href="#l10.195"></a><span id="l10.195" class="difflineplus">+      let rootElement = this.buildSingleElement(root, contextData);</span>
<a href="#l10.196"></a><span id="l10.196" class="difflineplus">+      rootElement.setAttribute(&quot;ext-type&quot;, &quot;top-level-menu&quot;);</span>
<a href="#l10.197"></a><span id="l10.197" class="difflineplus">+      rootElement.firstElementChild.append(...children.splice(maxCount - 1));</span>
<a href="#l10.198"></a><span id="l10.198" class="difflineplus">+      children.push(rootElement);</span>
<a href="#l10.199"></a><span id="l10.199" class="difflineplus">+    }</span>
<a href="#l10.200"></a><span id="l10.200" class="difflineplus">+</span>
<a href="#l10.201"></a><span id="l10.201" class="difflineplus">+    if (forceManifestIcons) {</span>
<a href="#l10.202"></a><span id="l10.202" class="difflineplus">+      for (let rootElement of children) {</span>
<a href="#l10.203"></a><span id="l10.203" class="difflineplus">+        // Display the extension icon on the root element.</span>
<a href="#l10.204"></a><span id="l10.204" class="difflineplus">+        if (root.extension.manifest.icons) {</span>
<a href="#l10.205"></a><span id="l10.205" class="difflineplus">+          this.setMenuItemIcon(rootElement, root.extension, contextData, root.extension.manifest.icons);</span>
<a href="#l10.206"></a><span id="l10.206" class="difflineplus">+        } else {</span>
<a href="#l10.207"></a><span id="l10.207" class="difflineplus">+          this.removeMenuItemIcon(rootElement);</span>
<a href="#l10.208"></a><span id="l10.208" class="difflineplus">+        }</span>
<a href="#l10.209"></a><span id="l10.209" class="difflineplus">+      }</span>
<a href="#l10.210"></a><span id="l10.210" class="difflineplus">+    }</span>
<a href="#l10.211"></a><span id="l10.211" class="difflineplus">+    return children;</span>
<a href="#l10.212"></a><span id="l10.212" class="difflineplus">+  },</span>
<a href="#l10.213"></a><span id="l10.213" class="difflineplus">+</span>
<a href="#l10.214"></a><span id="l10.214" class="difflineplus">+  removeSeparatorIfNoTopLevelItems() {</span>
<a href="#l10.215"></a><span id="l10.215" class="difflineplus">+    // Extension menu items always have have a non-empty ID.</span>
<a href="#l10.216"></a><span id="l10.216" class="difflineplus">+    let isNonExtensionSeparator =</span>
<a href="#l10.217"></a><span id="l10.217" class="difflineplus">+      item =&gt; item.nodeName === &quot;menuseparator&quot; &amp;&amp; !item.id;</span>
<a href="#l10.218"></a><span id="l10.218" class="difflineplus">+</span>
<a href="#l10.219"></a><span id="l10.219" class="difflineplus">+    // itemsToCleanUp contains all top-level menu items. A separator should</span>
<a href="#l10.220"></a><span id="l10.220" class="difflineplus">+    // only be kept if it is next to an extension menu item.</span>
<a href="#l10.221"></a><span id="l10.221" class="difflineplus">+    let isExtensionMenuItemSibling =</span>
<a href="#l10.222"></a><span id="l10.222" class="difflineplus">+      item =&gt; item &amp;&amp; this.itemsToCleanUp.has(item) &amp;&amp; !isNonExtensionSeparator(item);</span>
<a href="#l10.223"></a><span id="l10.223" class="difflineplus">+</span>
<a href="#l10.224"></a><span id="l10.224" class="difflineplus">+    for (let item of this.itemsToCleanUp) {</span>
<a href="#l10.225"></a><span id="l10.225" class="difflineplus">+      if (isNonExtensionSeparator(item)) {</span>
<a href="#l10.226"></a><span id="l10.226" class="difflineplus">+        if (!isExtensionMenuItemSibling(item.previousElementSibling) &amp;&amp;</span>
<a href="#l10.227"></a><span id="l10.227" class="difflineplus">+            !isExtensionMenuItemSibling(item.nextElementSibling)) {</span>
<a href="#l10.228"></a><span id="l10.228" class="difflineplus">+          item.remove();</span>
<a href="#l10.229"></a><span id="l10.229" class="difflineplus">+          this.itemsToCleanUp.delete(item);</span>
<a href="#l10.230"></a><span id="l10.230" class="difflineplus">+        }</span>
<a href="#l10.231"></a><span id="l10.231" class="difflineplus">+      }</span>
<a href="#l10.232"></a><span id="l10.232" class="difflineplus">+    }</span>
<a href="#l10.233"></a><span id="l10.233" class="difflineplus">+  },</span>
<a href="#l10.234"></a><span id="l10.234" class="difflineplus">+</span>
<a href="#l10.235"></a><span id="l10.235" class="difflineplus">+  buildSingleElement(item, contextData) {</span>
<a href="#l10.236"></a><span id="l10.236" class="difflineplus">+    let doc = contextData.menu.ownerDocument;</span>
<a href="#l10.237"></a><span id="l10.237" class="difflineplus">+    let element;</span>
<a href="#l10.238"></a><span id="l10.238" class="difflineplus">+    if (item.children.length &gt; 0) {</span>
<a href="#l10.239"></a><span id="l10.239" class="difflineplus">+      element = this.createMenuElement(doc, item);</span>
<a href="#l10.240"></a><span id="l10.240" class="difflineplus">+    } else if (item.type == &quot;separator&quot;) {</span>
<a href="#l10.241"></a><span id="l10.241" class="difflineplus">+      element = doc.createXULElement(&quot;menuseparator&quot;);</span>
<a href="#l10.242"></a><span id="l10.242" class="difflineplus">+    } else {</span>
<a href="#l10.243"></a><span id="l10.243" class="difflineplus">+      element = doc.createXULElement(&quot;menuitem&quot;);</span>
<a href="#l10.244"></a><span id="l10.244" class="difflineplus">+    }</span>
<a href="#l10.245"></a><span id="l10.245" class="difflineplus">+</span>
<a href="#l10.246"></a><span id="l10.246" class="difflineplus">+    return this.customizeElement(element, item, contextData);</span>
<a href="#l10.247"></a><span id="l10.247" class="difflineplus">+  },</span>
<a href="#l10.248"></a><span id="l10.248" class="difflineplus">+</span>
<a href="#l10.249"></a><span id="l10.249" class="difflineplus">+  createMenuElement(doc, item) {</span>
<a href="#l10.250"></a><span id="l10.250" class="difflineplus">+    let element = doc.createXULElement(&quot;menu&quot;);</span>
<a href="#l10.251"></a><span id="l10.251" class="difflineplus">+    // Menu elements need to have a menupopup child for its menu items.</span>
<a href="#l10.252"></a><span id="l10.252" class="difflineplus">+    let menupopup = doc.createXULElement(&quot;menupopup&quot;);</span>
<a href="#l10.253"></a><span id="l10.253" class="difflineplus">+    element.appendChild(menupopup);</span>
<a href="#l10.254"></a><span id="l10.254" class="difflineplus">+    return element;</span>
<a href="#l10.255"></a><span id="l10.255" class="difflineplus">+  },</span>
<a href="#l10.256"></a><span id="l10.256" class="difflineplus">+</span>
<a href="#l10.257"></a><span id="l10.257" class="difflineplus">+  customizeElement(element, item, contextData) {</span>
<a href="#l10.258"></a><span id="l10.258" class="difflineplus">+    let label = item.title;</span>
<a href="#l10.259"></a><span id="l10.259" class="difflineplus">+    if (label) {</span>
<a href="#l10.260"></a><span id="l10.260" class="difflineplus">+      let accessKey;</span>
<a href="#l10.261"></a><span id="l10.261" class="difflineplus">+      label = label.replace(/&amp;([\S\s]|$)/g, (_, nextChar, i) =&gt; {</span>
<a href="#l10.262"></a><span id="l10.262" class="difflineplus">+        if (nextChar === &quot;&amp;&quot;) {</span>
<a href="#l10.263"></a><span id="l10.263" class="difflineplus">+          return &quot;&amp;&quot;;</span>
<a href="#l10.264"></a><span id="l10.264" class="difflineplus">+        }</span>
<a href="#l10.265"></a><span id="l10.265" class="difflineplus">+        if (accessKey === undefined) {</span>
<a href="#l10.266"></a><span id="l10.266" class="difflineplus">+          if (nextChar === &quot;%&quot; &amp;&amp; label.charAt(i + 2) === &quot;s&quot;) {</span>
<a href="#l10.267"></a><span id="l10.267" class="difflineplus">+            accessKey = &quot;&quot;;</span>
<a href="#l10.268"></a><span id="l10.268" class="difflineplus">+          } else {</span>
<a href="#l10.269"></a><span id="l10.269" class="difflineplus">+            accessKey = nextChar;</span>
<a href="#l10.270"></a><span id="l10.270" class="difflineplus">+          }</span>
<a href="#l10.271"></a><span id="l10.271" class="difflineplus">+        }</span>
<a href="#l10.272"></a><span id="l10.272" class="difflineplus">+        return nextChar;</span>
<a href="#l10.273"></a><span id="l10.273" class="difflineplus">+      });</span>
<a href="#l10.274"></a><span id="l10.274" class="difflineplus">+      element.setAttribute(&quot;accesskey&quot;, accessKey || &quot;&quot;);</span>
<a href="#l10.275"></a><span id="l10.275" class="difflineplus">+</span>
<a href="#l10.276"></a><span id="l10.276" class="difflineplus">+      if (contextData.isTextSelected &amp;&amp; label.indexOf(&quot;%s&quot;) &gt; -1) {</span>
<a href="#l10.277"></a><span id="l10.277" class="difflineplus">+        let selection = contextData.selectionText.trim();</span>
<a href="#l10.278"></a><span id="l10.278" class="difflineplus">+        // The rendering engine will truncate the title if it's longer than 64 characters.</span>
<a href="#l10.279"></a><span id="l10.279" class="difflineplus">+        // But if it makes sense let's try truncate selection text only, to handle cases like</span>
<a href="#l10.280"></a><span id="l10.280" class="difflineplus">+        // 'look up &quot;%s&quot; in MyDictionary' more elegantly.</span>
<a href="#l10.281"></a><span id="l10.281" class="difflineplus">+</span>
<a href="#l10.282"></a><span id="l10.282" class="difflineplus">+        let codePointsToRemove = 0;</span>
<a href="#l10.283"></a><span id="l10.283" class="difflineplus">+</span>
<a href="#l10.284"></a><span id="l10.284" class="difflineplus">+        let selectionArray = Array.from(selection);</span>
<a href="#l10.285"></a><span id="l10.285" class="difflineplus">+</span>
<a href="#l10.286"></a><span id="l10.286" class="difflineplus">+        let completeLabelLength = label.length - 2 + selectionArray.length;</span>
<a href="#l10.287"></a><span id="l10.287" class="difflineplus">+        if (completeLabelLength &gt; gMaxLabelLength) {</span>
<a href="#l10.288"></a><span id="l10.288" class="difflineplus">+          codePointsToRemove = completeLabelLength - gMaxLabelLength;</span>
<a href="#l10.289"></a><span id="l10.289" class="difflineplus">+        }</span>
<a href="#l10.290"></a><span id="l10.290" class="difflineplus">+</span>
<a href="#l10.291"></a><span id="l10.291" class="difflineplus">+        if (codePointsToRemove) {</span>
<a href="#l10.292"></a><span id="l10.292" class="difflineplus">+          let ellipsis = &quot;\u2026&quot;;</span>
<a href="#l10.293"></a><span id="l10.293" class="difflineplus">+          try {</span>
<a href="#l10.294"></a><span id="l10.294" class="difflineplus">+            ellipsis = Services.prefs.getComplexValue(&quot;intl.ellipsis&quot;,</span>
<a href="#l10.295"></a><span id="l10.295" class="difflineplus">+                                                      Ci.nsIPrefLocalizedString).data;</span>
<a href="#l10.296"></a><span id="l10.296" class="difflineplus">+          } catch (e) { }</span>
<a href="#l10.297"></a><span id="l10.297" class="difflineplus">+          codePointsToRemove += 1;</span>
<a href="#l10.298"></a><span id="l10.298" class="difflineplus">+          selection = selectionArray.slice(0, -codePointsToRemove).join(&quot;&quot;) + ellipsis;</span>
<a href="#l10.299"></a><span id="l10.299" class="difflineplus">+        }</span>
<a href="#l10.300"></a><span id="l10.300" class="difflineplus">+</span>
<a href="#l10.301"></a><span id="l10.301" class="difflineplus">+        label = label.replace(/%s/g, selection);</span>
<a href="#l10.302"></a><span id="l10.302" class="difflineplus">+      }</span>
<a href="#l10.303"></a><span id="l10.303" class="difflineplus">+</span>
<a href="#l10.304"></a><span id="l10.304" class="difflineplus">+      element.setAttribute(&quot;label&quot;, label);</span>
<a href="#l10.305"></a><span id="l10.305" class="difflineplus">+    }</span>
<a href="#l10.306"></a><span id="l10.306" class="difflineplus">+</span>
<a href="#l10.307"></a><span id="l10.307" class="difflineplus">+    element.setAttribute(&quot;id&quot;, item.elementId);</span>
<a href="#l10.308"></a><span id="l10.308" class="difflineplus">+</span>
<a href="#l10.309"></a><span id="l10.309" class="difflineplus">+    if (&quot;icons&quot; in item) {</span>
<a href="#l10.310"></a><span id="l10.310" class="difflineplus">+      if (item.icons) {</span>
<a href="#l10.311"></a><span id="l10.311" class="difflineplus">+        this.setMenuItemIcon(element, item.extension, contextData, item.icons);</span>
<a href="#l10.312"></a><span id="l10.312" class="difflineplus">+      } else {</span>
<a href="#l10.313"></a><span id="l10.313" class="difflineplus">+        this.removeMenuItemIcon(element);</span>
<a href="#l10.314"></a><span id="l10.314" class="difflineplus">+      }</span>
<a href="#l10.315"></a><span id="l10.315" class="difflineplus">+    }</span>
<a href="#l10.316"></a><span id="l10.316" class="difflineplus">+</span>
<a href="#l10.317"></a><span id="l10.317" class="difflineplus">+    if (item.type == &quot;checkbox&quot;) {</span>
<a href="#l10.318"></a><span id="l10.318" class="difflineplus">+      element.setAttribute(&quot;type&quot;, &quot;checkbox&quot;);</span>
<a href="#l10.319"></a><span id="l10.319" class="difflineplus">+      if (item.checked) {</span>
<a href="#l10.320"></a><span id="l10.320" class="difflineplus">+        element.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l10.321"></a><span id="l10.321" class="difflineplus">+      }</span>
<a href="#l10.322"></a><span id="l10.322" class="difflineplus">+    } else if (item.type == &quot;radio&quot;) {</span>
<a href="#l10.323"></a><span id="l10.323" class="difflineplus">+      element.setAttribute(&quot;type&quot;, &quot;radio&quot;);</span>
<a href="#l10.324"></a><span id="l10.324" class="difflineplus">+      element.setAttribute(&quot;name&quot;, item.groupName);</span>
<a href="#l10.325"></a><span id="l10.325" class="difflineplus">+      if (item.checked) {</span>
<a href="#l10.326"></a><span id="l10.326" class="difflineplus">+        element.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l10.327"></a><span id="l10.327" class="difflineplus">+      }</span>
<a href="#l10.328"></a><span id="l10.328" class="difflineplus">+    }</span>
<a href="#l10.329"></a><span id="l10.329" class="difflineplus">+</span>
<a href="#l10.330"></a><span id="l10.330" class="difflineplus">+    if (!item.enabled) {</span>
<a href="#l10.331"></a><span id="l10.331" class="difflineplus">+      element.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l10.332"></a><span id="l10.332" class="difflineplus">+    }</span>
<a href="#l10.333"></a><span id="l10.333" class="difflineplus">+</span>
<a href="#l10.334"></a><span id="l10.334" class="difflineplus">+    let button;</span>
<a href="#l10.335"></a><span id="l10.335" class="difflineplus">+</span>
<a href="#l10.336"></a><span id="l10.336" class="difflineplus">+    element.addEventListener(&quot;command&quot;, event =&gt; {</span>
<a href="#l10.337"></a><span id="l10.337" class="difflineplus">+      if (event.target !== event.currentTarget) {</span>
<a href="#l10.338"></a><span id="l10.338" class="difflineplus">+        return;</span>
<a href="#l10.339"></a><span id="l10.339" class="difflineplus">+      }</span>
<a href="#l10.340"></a><span id="l10.340" class="difflineplus">+      const wasChecked = item.checked;</span>
<a href="#l10.341"></a><span id="l10.341" class="difflineplus">+      if (item.type == &quot;checkbox&quot;) {</span>
<a href="#l10.342"></a><span id="l10.342" class="difflineplus">+        item.checked = !item.checked;</span>
<a href="#l10.343"></a><span id="l10.343" class="difflineplus">+      } else if (item.type == &quot;radio&quot;) {</span>
<a href="#l10.344"></a><span id="l10.344" class="difflineplus">+        // Deselect all radio items in the current radio group.</span>
<a href="#l10.345"></a><span id="l10.345" class="difflineplus">+        for (let child of item.parent.children) {</span>
<a href="#l10.346"></a><span id="l10.346" class="difflineplus">+          if (child.type == &quot;radio&quot; &amp;&amp; child.groupName == item.groupName) {</span>
<a href="#l10.347"></a><span id="l10.347" class="difflineplus">+            child.checked = false;</span>
<a href="#l10.348"></a><span id="l10.348" class="difflineplus">+          }</span>
<a href="#l10.349"></a><span id="l10.349" class="difflineplus">+        }</span>
<a href="#l10.350"></a><span id="l10.350" class="difflineplus">+        // Select the clicked radio item.</span>
<a href="#l10.351"></a><span id="l10.351" class="difflineplus">+        item.checked = true;</span>
<a href="#l10.352"></a><span id="l10.352" class="difflineplus">+      }</span>
<a href="#l10.353"></a><span id="l10.353" class="difflineplus">+</span>
<a href="#l10.354"></a><span id="l10.354" class="difflineplus">+      let {webExtContextData} = contextData;</span>
<a href="#l10.355"></a><span id="l10.355" class="difflineplus">+      if (contextData.tab &amp;&amp;</span>
<a href="#l10.356"></a><span id="l10.356" class="difflineplus">+          // If the menu context was overridden by the extension, do not grant</span>
<a href="#l10.357"></a><span id="l10.357" class="difflineplus">+          // activeTab since the extension also controls the tabId.</span>
<a href="#l10.358"></a><span id="l10.358" class="difflineplus">+          (!webExtContextData || webExtContextData.extensionId !== item.extension.id)) {</span>
<a href="#l10.359"></a><span id="l10.359" class="difflineplus">+        item.tabManager.addActiveTabPermission(contextData.tab);</span>
<a href="#l10.360"></a><span id="l10.360" class="difflineplus">+      }</span>
<a href="#l10.361"></a><span id="l10.361" class="difflineplus">+</span>
<a href="#l10.362"></a><span id="l10.362" class="difflineplus">+      let info = item.getClickInfo(contextData, wasChecked);</span>
<a href="#l10.363"></a><span id="l10.363" class="difflineplus">+</span>
<a href="#l10.364"></a><span id="l10.364" class="difflineplus">+      const map = {shiftKey: &quot;Shift&quot;, altKey: &quot;Alt&quot;, metaKey: &quot;Command&quot;, ctrlKey: &quot;Ctrl&quot;};</span>
<a href="#l10.365"></a><span id="l10.365" class="difflineplus">+      info.modifiers = Object.keys(map).filter(key =&gt; event[key]).map(key =&gt; map[key]);</span>
<a href="#l10.366"></a><span id="l10.366" class="difflineplus">+      if (event.ctrlKey &amp;&amp; AppConstants.platform === &quot;macosx&quot;) {</span>
<a href="#l10.367"></a><span id="l10.367" class="difflineplus">+        info.modifiers.push(&quot;MacCtrl&quot;);</span>
<a href="#l10.368"></a><span id="l10.368" class="difflineplus">+      }</span>
<a href="#l10.369"></a><span id="l10.369" class="difflineplus">+</span>
<a href="#l10.370"></a><span id="l10.370" class="difflineplus">+      info.button = button;</span>
<a href="#l10.371"></a><span id="l10.371" class="difflineplus">+</span>
<a href="#l10.372"></a><span id="l10.372" class="difflineplus">+      // Allow menus to open various actions supported in webext prior</span>
<a href="#l10.373"></a><span id="l10.373" class="difflineplus">+      // to notifying onclicked.</span>
<a href="#l10.374"></a><span id="l10.374" class="difflineplus">+      let actionFor = {</span>
<a href="#l10.375"></a><span id="l10.375" class="difflineplus">+        _execute_browser_action: global.browserActionFor,</span>
<a href="#l10.376"></a><span id="l10.376" class="difflineplus">+      }[item.command];</span>
<a href="#l10.377"></a><span id="l10.377" class="difflineplus">+      if (actionFor) {</span>
<a href="#l10.378"></a><span id="l10.378" class="difflineplus">+        let win = event.target.ownerGlobal;</span>
<a href="#l10.379"></a><span id="l10.379" class="difflineplus">+        actionFor(item.extension).triggerAction(win);</span>
<a href="#l10.380"></a><span id="l10.380" class="difflineplus">+      }</span>
<a href="#l10.381"></a><span id="l10.381" class="difflineplus">+</span>
<a href="#l10.382"></a><span id="l10.382" class="difflineplus">+      item.extension.emit(&quot;webext-menu-menuitem-click&quot;, info, contextData.tab);</span>
<a href="#l10.383"></a><span id="l10.383" class="difflineplus">+    }, {once: true});</span>
<a href="#l10.384"></a><span id="l10.384" class="difflineplus">+</span>
<a href="#l10.385"></a><span id="l10.385" class="difflineplus">+    element.addEventListener(&quot;click&quot;, event =&gt; { // eslint-disable-line mozilla/balanced-listeners</span>
<a href="#l10.386"></a><span id="l10.386" class="difflineplus">+      if (event.target !== event.currentTarget ||</span>
<a href="#l10.387"></a><span id="l10.387" class="difflineplus">+          // Ignore menu items that are usually not clickeable,</span>
<a href="#l10.388"></a><span id="l10.388" class="difflineplus">+          // such as separators and parents of submenus and disabled items.</span>
<a href="#l10.389"></a><span id="l10.389" class="difflineplus">+          element.localName !== &quot;menuitem&quot; ||</span>
<a href="#l10.390"></a><span id="l10.390" class="difflineplus">+          element.disabled) {</span>
<a href="#l10.391"></a><span id="l10.391" class="difflineplus">+        return;</span>
<a href="#l10.392"></a><span id="l10.392" class="difflineplus">+      }</span>
<a href="#l10.393"></a><span id="l10.393" class="difflineplus">+</span>
<a href="#l10.394"></a><span id="l10.394" class="difflineplus">+      button = event.button;</span>
<a href="#l10.395"></a><span id="l10.395" class="difflineplus">+      if (event.button) {</span>
<a href="#l10.396"></a><span id="l10.396" class="difflineplus">+        element.doCommand();</span>
<a href="#l10.397"></a><span id="l10.397" class="difflineplus">+        contextData.menu.hidePopup();</span>
<a href="#l10.398"></a><span id="l10.398" class="difflineplus">+      }</span>
<a href="#l10.399"></a><span id="l10.399" class="difflineplus">+    });</span>
<a href="#l10.400"></a><span id="l10.400" class="difflineplus">+</span>
<a href="#l10.401"></a><span id="l10.401" class="difflineplus">+    // Don't publish the ID of the root because the root element is</span>
<a href="#l10.402"></a><span id="l10.402" class="difflineplus">+    // auto-generated.</span>
<a href="#l10.403"></a><span id="l10.403" class="difflineplus">+    if (item.parent) {</span>
<a href="#l10.404"></a><span id="l10.404" class="difflineplus">+      gShownMenuItems.get(item.extension).push(item.id);</span>
<a href="#l10.405"></a><span id="l10.405" class="difflineplus">+    }</span>
<a href="#l10.406"></a><span id="l10.406" class="difflineplus">+</span>
<a href="#l10.407"></a><span id="l10.407" class="difflineplus">+    return element;</span>
<a href="#l10.408"></a><span id="l10.408" class="difflineplus">+  },</span>
<a href="#l10.409"></a><span id="l10.409" class="difflineplus">+</span>
<a href="#l10.410"></a><span id="l10.410" class="difflineplus">+  setMenuItemIcon(element, extension, contextData, icons) {</span>
<a href="#l10.411"></a><span id="l10.411" class="difflineplus">+    let parentWindow = contextData.menu.ownerGlobal;</span>
<a href="#l10.412"></a><span id="l10.412" class="difflineplus">+</span>
<a href="#l10.413"></a><span id="l10.413" class="difflineplus">+    let {icon} = IconDetails.getPreferredIcon(icons, extension,</span>
<a href="#l10.414"></a><span id="l10.414" class="difflineplus">+                                              16 * parentWindow.devicePixelRatio);</span>
<a href="#l10.415"></a><span id="l10.415" class="difflineplus">+</span>
<a href="#l10.416"></a><span id="l10.416" class="difflineplus">+    // The extension icons in the manifest are not pre-resolved, since</span>
<a href="#l10.417"></a><span id="l10.417" class="difflineplus">+    // they're sometimes used by the add-on manager when the extension is</span>
<a href="#l10.418"></a><span id="l10.418" class="difflineplus">+    // not enabled, and its URLs are not resolvable.</span>
<a href="#l10.419"></a><span id="l10.419" class="difflineplus">+    let resolvedURL = extension.baseURI.resolve(icon);</span>
<a href="#l10.420"></a><span id="l10.420" class="difflineplus">+</span>
<a href="#l10.421"></a><span id="l10.421" class="difflineplus">+    if (element.localName == &quot;menu&quot;) {</span>
<a href="#l10.422"></a><span id="l10.422" class="difflineplus">+      element.setAttribute(&quot;class&quot;, &quot;menu-iconic&quot;);</span>
<a href="#l10.423"></a><span id="l10.423" class="difflineplus">+    } else if (element.localName == &quot;menuitem&quot;) {</span>
<a href="#l10.424"></a><span id="l10.424" class="difflineplus">+      element.setAttribute(&quot;class&quot;, &quot;menuitem-iconic&quot;);</span>
<a href="#l10.425"></a><span id="l10.425" class="difflineplus">+    }</span>
<a href="#l10.426"></a><span id="l10.426" class="difflineplus">+</span>
<a href="#l10.427"></a><span id="l10.427" class="difflineplus">+    element.setAttribute(&quot;image&quot;, resolvedURL);</span>
<a href="#l10.428"></a><span id="l10.428" class="difflineplus">+  },</span>
<a href="#l10.429"></a><span id="l10.429" class="difflineplus">+</span>
<a href="#l10.430"></a><span id="l10.430" class="difflineplus">+  // Undo changes from setMenuItemIcon.</span>
<a href="#l10.431"></a><span id="l10.431" class="difflineplus">+  removeMenuItemIcon(element) {</span>
<a href="#l10.432"></a><span id="l10.432" class="difflineplus">+    element.removeAttribute(&quot;class&quot;);</span>
<a href="#l10.433"></a><span id="l10.433" class="difflineplus">+    element.removeAttribute(&quot;image&quot;);</span>
<a href="#l10.434"></a><span id="l10.434" class="difflineplus">+  },</span>
<a href="#l10.435"></a><span id="l10.435" class="difflineplus">+</span>
<a href="#l10.436"></a><span id="l10.436" class="difflineplus">+  rebuildMenu(extension) {</span>
<a href="#l10.437"></a><span id="l10.437" class="difflineplus">+    let {contextData} = this;</span>
<a href="#l10.438"></a><span id="l10.438" class="difflineplus">+    if (!contextData) {</span>
<a href="#l10.439"></a><span id="l10.439" class="difflineplus">+      // This happens if the menu is not visible.</span>
<a href="#l10.440"></a><span id="l10.440" class="difflineplus">+      return;</span>
<a href="#l10.441"></a><span id="l10.441" class="difflineplus">+    }</span>
<a href="#l10.442"></a><span id="l10.442" class="difflineplus">+</span>
<a href="#l10.443"></a><span id="l10.443" class="difflineplus">+    // Find the group of existing top-level items (usually 0 or 1 items)</span>
<a href="#l10.444"></a><span id="l10.444" class="difflineplus">+    // and remember its position for when the new items are inserted.</span>
<a href="#l10.445"></a><span id="l10.445" class="difflineplus">+    let elementIdPrefix = `${makeWidgetId(extension.id)}-menuitem-`;</span>
<a href="#l10.446"></a><span id="l10.446" class="difflineplus">+    let nextSibling = null;</span>
<a href="#l10.447"></a><span id="l10.447" class="difflineplus">+    for (let item of this.itemsToCleanUp) {</span>
<a href="#l10.448"></a><span id="l10.448" class="difflineplus">+      if (item.id &amp;&amp; item.id.startsWith(elementIdPrefix)) {</span>
<a href="#l10.449"></a><span id="l10.449" class="difflineplus">+        nextSibling = item.nextSibling;</span>
<a href="#l10.450"></a><span id="l10.450" class="difflineplus">+        item.remove();</span>
<a href="#l10.451"></a><span id="l10.451" class="difflineplus">+        this.itemsToCleanUp.delete(item);</span>
<a href="#l10.452"></a><span id="l10.452" class="difflineplus">+      }</span>
<a href="#l10.453"></a><span id="l10.453" class="difflineplus">+    }</span>
<a href="#l10.454"></a><span id="l10.454" class="difflineplus">+</span>
<a href="#l10.455"></a><span id="l10.455" class="difflineplus">+    let root = gRootItems.get(extension);</span>
<a href="#l10.456"></a><span id="l10.456" class="difflineplus">+    if (root) {</span>
<a href="#l10.457"></a><span id="l10.457" class="difflineplus">+      this.createAndInsertTopLevelElements(root, contextData, nextSibling);</span>
<a href="#l10.458"></a><span id="l10.458" class="difflineplus">+    }</span>
<a href="#l10.459"></a><span id="l10.459" class="difflineplus">+    this.removeSeparatorIfNoTopLevelItems();</span>
<a href="#l10.460"></a><span id="l10.460" class="difflineplus">+  },</span>
<a href="#l10.461"></a><span id="l10.461" class="difflineplus">+</span>
<a href="#l10.462"></a><span id="l10.462" class="difflineplus">+  // This should be called once, after constructing the top-level menus, if any.</span>
<a href="#l10.463"></a><span id="l10.463" class="difflineplus">+  afterBuildingMenu(contextData) {</span>
<a href="#l10.464"></a><span id="l10.464" class="difflineplus">+    function dispatchOnShownEvent(extension) {</span>
<a href="#l10.465"></a><span id="l10.465" class="difflineplus">+      // Note: gShownMenuItems is a DefaultMap, so .get(extension) causes the</span>
<a href="#l10.466"></a><span id="l10.466" class="difflineplus">+      // extension to be stored in the map even if there are currently no</span>
<a href="#l10.467"></a><span id="l10.467" class="difflineplus">+      // shown menu items. This ensures that the onHidden event can be fired</span>
<a href="#l10.468"></a><span id="l10.468" class="difflineplus">+      // when the menu is closed.</span>
<a href="#l10.469"></a><span id="l10.469" class="difflineplus">+      let menuIds = gShownMenuItems.get(extension);</span>
<a href="#l10.470"></a><span id="l10.470" class="difflineplus">+      extension.emit(&quot;webext-menu-shown&quot;, menuIds, contextData);</span>
<a href="#l10.471"></a><span id="l10.471" class="difflineplus">+    }</span>
<a href="#l10.472"></a><span id="l10.472" class="difflineplus">+</span>
<a href="#l10.473"></a><span id="l10.473" class="difflineplus">+    if (contextData.onBrowserAction || contextData.onPageAction) {</span>
<a href="#l10.474"></a><span id="l10.474" class="difflineplus">+      dispatchOnShownEvent(contextData.extension);</span>
<a href="#l10.475"></a><span id="l10.475" class="difflineplus">+    } else {</span>
<a href="#l10.476"></a><span id="l10.476" class="difflineplus">+      gOnShownSubscribers.forEach(dispatchOnShownEvent);</span>
<a href="#l10.477"></a><span id="l10.477" class="difflineplus">+    }</span>
<a href="#l10.478"></a><span id="l10.478" class="difflineplus">+</span>
<a href="#l10.479"></a><span id="l10.479" class="difflineplus">+    this.contextData = contextData;</span>
<a href="#l10.480"></a><span id="l10.480" class="difflineplus">+  },</span>
<a href="#l10.481"></a><span id="l10.481" class="difflineplus">+</span>
<a href="#l10.482"></a><span id="l10.482" class="difflineplus">+  hideDefaultMenuItems() {</span>
<a href="#l10.483"></a><span id="l10.483" class="difflineplus">+    for (let item of this.xulMenu.children) {</span>
<a href="#l10.484"></a><span id="l10.484" class="difflineplus">+      if (!this.itemsToCleanUp.has(item)) {</span>
<a href="#l10.485"></a><span id="l10.485" class="difflineplus">+        item.hidden = true;</span>
<a href="#l10.486"></a><span id="l10.486" class="difflineplus">+      }</span>
<a href="#l10.487"></a><span id="l10.487" class="difflineplus">+    }</span>
<a href="#l10.488"></a><span id="l10.488" class="difflineplus">+  },</span>
<a href="#l10.489"></a><span id="l10.489" class="difflineplus">+</span>
<a href="#l10.490"></a><span id="l10.490" class="difflineplus">+  handleEvent(event) {</span>
<a href="#l10.491"></a><span id="l10.491" class="difflineplus">+    if (this.xulMenu != event.target || event.type != &quot;popuphidden&quot;) {</span>
<a href="#l10.492"></a><span id="l10.492" class="difflineplus">+      return;</span>
<a href="#l10.493"></a><span id="l10.493" class="difflineplus">+    }</span>
<a href="#l10.494"></a><span id="l10.494" class="difflineplus">+</span>
<a href="#l10.495"></a><span id="l10.495" class="difflineplus">+    delete this.xulMenu;</span>
<a href="#l10.496"></a><span id="l10.496" class="difflineplus">+    delete this.contextData;</span>
<a href="#l10.497"></a><span id="l10.497" class="difflineplus">+</span>
<a href="#l10.498"></a><span id="l10.498" class="difflineplus">+    let target = event.target;</span>
<a href="#l10.499"></a><span id="l10.499" class="difflineplus">+    target.removeEventListener(&quot;popuphidden&quot;, this);</span>
<a href="#l10.500"></a><span id="l10.500" class="difflineplus">+    for (let item of this.itemsToCleanUp) {</span>
<a href="#l10.501"></a><span id="l10.501" class="difflineplus">+      item.remove();</span>
<a href="#l10.502"></a><span id="l10.502" class="difflineplus">+    }</span>
<a href="#l10.503"></a><span id="l10.503" class="difflineplus">+    this.itemsToCleanUp.clear();</span>
<a href="#l10.504"></a><span id="l10.504" class="difflineplus">+    for (let extension of gShownMenuItems.keys()) {</span>
<a href="#l10.505"></a><span id="l10.505" class="difflineplus">+      extension.emit(&quot;webext-menu-hidden&quot;);</span>
<a href="#l10.506"></a><span id="l10.506" class="difflineplus">+    }</span>
<a href="#l10.507"></a><span id="l10.507" class="difflineplus">+    gShownMenuItems.clear();</span>
<a href="#l10.508"></a><span id="l10.508" class="difflineplus">+  },</span>
<a href="#l10.509"></a><span id="l10.509" class="difflineplus">+</span>
<a href="#l10.510"></a><span id="l10.510" class="difflineplus">+  itemsToCleanUp: new Set(),</span>
<a href="#l10.511"></a><span id="l10.511" class="difflineplus">+};</span>
<a href="#l10.512"></a><span id="l10.512" class="difflineplus">+</span>
<a href="#l10.513"></a><span id="l10.513" class="difflineplus">+// Called from pageAction or browserAction popup.</span>
<a href="#l10.514"></a><span id="l10.514" class="difflineplus">+global.actionContextMenu = function(contextData) {</span>
<a href="#l10.515"></a><span id="l10.515" class="difflineplus">+  contextData.tab = tabTracker.activeTab;</span>
<a href="#l10.516"></a><span id="l10.516" class="difflineplus">+  contextData.pageUrl = contextData.tab.linkedBrowser.currentURI.spec;</span>
<a href="#l10.517"></a><span id="l10.517" class="difflineplus">+  gMenuBuilder.build(contextData);</span>
<a href="#l10.518"></a><span id="l10.518" class="difflineplus">+};</span>
<a href="#l10.519"></a><span id="l10.519" class="difflineplus">+</span>
<a href="#l10.520"></a><span id="l10.520" class="difflineplus">+const contextsMap = {</span>
<a href="#l10.521"></a><span id="l10.521" class="difflineplus">+  onAudio: &quot;audio&quot;,</span>
<a href="#l10.522"></a><span id="l10.522" class="difflineplus">+  onEditable: &quot;editable&quot;,</span>
<a href="#l10.523"></a><span id="l10.523" class="difflineplus">+  inFrame: &quot;frame&quot;,</span>
<a href="#l10.524"></a><span id="l10.524" class="difflineplus">+  onImage: &quot;image&quot;,</span>
<a href="#l10.525"></a><span id="l10.525" class="difflineplus">+  onLink: &quot;link&quot;,</span>
<a href="#l10.526"></a><span id="l10.526" class="difflineplus">+  onPassword: &quot;password&quot;,</span>
<a href="#l10.527"></a><span id="l10.527" class="difflineplus">+  isTextSelected: &quot;selection&quot;,</span>
<a href="#l10.528"></a><span id="l10.528" class="difflineplus">+  onVideo: &quot;video&quot;,</span>
<a href="#l10.529"></a><span id="l10.529" class="difflineplus">+</span>
<a href="#l10.530"></a><span id="l10.530" class="difflineplus">+  onBrowserAction: &quot;browser_action&quot;,</span>
<a href="#l10.531"></a><span id="l10.531" class="difflineplus">+  onTab: &quot;tab&quot;,</span>
<a href="#l10.532"></a><span id="l10.532" class="difflineplus">+</span>
<a href="#l10.533"></a><span id="l10.533" class="difflineplus">+  selectedMessages: &quot;message_list&quot;,</span>
<a href="#l10.534"></a><span id="l10.534" class="difflineplus">+  selectedFolder: &quot;folder_pane&quot;,</span>
<a href="#l10.535"></a><span id="l10.535" class="difflineplus">+};</span>
<a href="#l10.536"></a><span id="l10.536" class="difflineplus">+</span>
<a href="#l10.537"></a><span id="l10.537" class="difflineplus">+const getMenuContexts = contextData =&gt; {</span>
<a href="#l10.538"></a><span id="l10.538" class="difflineplus">+  let contexts = new Set();</span>
<a href="#l10.539"></a><span id="l10.539" class="difflineplus">+</span>
<a href="#l10.540"></a><span id="l10.540" class="difflineplus">+  for (const [key, value] of Object.entries(contextsMap)) {</span>
<a href="#l10.541"></a><span id="l10.541" class="difflineplus">+    if (contextData[key]) {</span>
<a href="#l10.542"></a><span id="l10.542" class="difflineplus">+      contexts.add(value);</span>
<a href="#l10.543"></a><span id="l10.543" class="difflineplus">+    }</span>
<a href="#l10.544"></a><span id="l10.544" class="difflineplus">+  }</span>
<a href="#l10.545"></a><span id="l10.545" class="difflineplus">+</span>
<a href="#l10.546"></a><span id="l10.546" class="difflineplus">+  if (contexts.size === 0) {</span>
<a href="#l10.547"></a><span id="l10.547" class="difflineplus">+    contexts.add(&quot;page&quot;);</span>
<a href="#l10.548"></a><span id="l10.548" class="difflineplus">+  }</span>
<a href="#l10.549"></a><span id="l10.549" class="difflineplus">+</span>
<a href="#l10.550"></a><span id="l10.550" class="difflineplus">+  // New non-content contexts supported in Firefox are not part of &quot;all&quot;.</span>
<a href="#l10.551"></a><span id="l10.551" class="difflineplus">+  if (!contextData.onTab) {</span>
<a href="#l10.552"></a><span id="l10.552" class="difflineplus">+    contexts.add(&quot;all&quot;);</span>
<a href="#l10.553"></a><span id="l10.553" class="difflineplus">+  }</span>
<a href="#l10.554"></a><span id="l10.554" class="difflineplus">+</span>
<a href="#l10.555"></a><span id="l10.555" class="difflineplus">+  return contexts;</span>
<a href="#l10.556"></a><span id="l10.556" class="difflineplus">+};</span>
<a href="#l10.557"></a><span id="l10.557" class="difflineplus">+</span>
<a href="#l10.558"></a><span id="l10.558" class="difflineplus">+function getContextViewType(contextData) {</span>
<a href="#l10.559"></a><span id="l10.559" class="difflineplus">+  if (&quot;originalViewType&quot; in contextData) {</span>
<a href="#l10.560"></a><span id="l10.560" class="difflineplus">+    return contextData.originalViewType;</span>
<a href="#l10.561"></a><span id="l10.561" class="difflineplus">+  }</span>
<a href="#l10.562"></a><span id="l10.562" class="difflineplus">+  if (contextData.webExtBrowserType === &quot;popup&quot; ||</span>
<a href="#l10.563"></a><span id="l10.563" class="difflineplus">+      contextData.webExtBrowserType === &quot;sidebar&quot;) {</span>
<a href="#l10.564"></a><span id="l10.564" class="difflineplus">+    return contextData.webExtBrowserType;</span>
<a href="#l10.565"></a><span id="l10.565" class="difflineplus">+  }</span>
<a href="#l10.566"></a><span id="l10.566" class="difflineplus">+  if (contextData.tab &amp;&amp; contextData.menu.id === &quot;tabContextMenu&quot;) {</span>
<a href="#l10.567"></a><span id="l10.567" class="difflineplus">+    return &quot;tab&quot;;</span>
<a href="#l10.568"></a><span id="l10.568" class="difflineplus">+  }</span>
<a href="#l10.569"></a><span id="l10.569" class="difflineplus">+  return undefined;</span>
<a href="#l10.570"></a><span id="l10.570" class="difflineplus">+}</span>
<a href="#l10.571"></a><span id="l10.571" class="difflineplus">+</span>
<a href="#l10.572"></a><span id="l10.572" class="difflineplus">+function addMenuEventInfo(info, contextData, extension, includeSensitiveData) {</span>
<a href="#l10.573"></a><span id="l10.573" class="difflineplus">+  info.viewType = getContextViewType(contextData);</span>
<a href="#l10.574"></a><span id="l10.574" class="difflineplus">+  if (contextData.onVideo) {</span>
<a href="#l10.575"></a><span id="l10.575" class="difflineplus">+    info.mediaType = &quot;video&quot;;</span>
<a href="#l10.576"></a><span id="l10.576" class="difflineplus">+  } else if (contextData.onAudio) {</span>
<a href="#l10.577"></a><span id="l10.577" class="difflineplus">+    info.mediaType = &quot;audio&quot;;</span>
<a href="#l10.578"></a><span id="l10.578" class="difflineplus">+  } else if (contextData.onImage) {</span>
<a href="#l10.579"></a><span id="l10.579" class="difflineplus">+    info.mediaType = &quot;image&quot;;</span>
<a href="#l10.580"></a><span id="l10.580" class="difflineplus">+  }</span>
<a href="#l10.581"></a><span id="l10.581" class="difflineplus">+  if (contextData.frameId !== undefined) {</span>
<a href="#l10.582"></a><span id="l10.582" class="difflineplus">+    info.frameId = contextData.frameId;</span>
<a href="#l10.583"></a><span id="l10.583" class="difflineplus">+  }</span>
<a href="#l10.584"></a><span id="l10.584" class="difflineplus">+  info.editable = contextData.onEditable || false;</span>
<a href="#l10.585"></a><span id="l10.585" class="difflineplus">+  if (includeSensitiveData) {</span>
<a href="#l10.586"></a><span id="l10.586" class="difflineplus">+    if (contextData.timeStamp) {</span>
<a href="#l10.587"></a><span id="l10.587" class="difflineplus">+      // Convert to integer, in case the DOMHighResTimeStamp has a fractional part.</span>
<a href="#l10.588"></a><span id="l10.588" class="difflineplus">+      info.targetElementId = Math.floor(contextData.timeStamp);</span>
<a href="#l10.589"></a><span id="l10.589" class="difflineplus">+    }</span>
<a href="#l10.590"></a><span id="l10.590" class="difflineplus">+    if (contextData.onLink) {</span>
<a href="#l10.591"></a><span id="l10.591" class="difflineplus">+      info.linkText = contextData.linkText;</span>
<a href="#l10.592"></a><span id="l10.592" class="difflineplus">+      info.linkUrl = contextData.linkUrl;</span>
<a href="#l10.593"></a><span id="l10.593" class="difflineplus">+    }</span>
<a href="#l10.594"></a><span id="l10.594" class="difflineplus">+    if (contextData.onAudio || contextData.onImage || contextData.onVideo) {</span>
<a href="#l10.595"></a><span id="l10.595" class="difflineplus">+      info.srcUrl = contextData.srcUrl;</span>
<a href="#l10.596"></a><span id="l10.596" class="difflineplus">+    }</span>
<a href="#l10.597"></a><span id="l10.597" class="difflineplus">+    if (contextData.inFrame) {</span>
<a href="#l10.598"></a><span id="l10.598" class="difflineplus">+      info.frameUrl = contextData.frameUrl;</span>
<a href="#l10.599"></a><span id="l10.599" class="difflineplus">+    }</span>
<a href="#l10.600"></a><span id="l10.600" class="difflineplus">+    if (contextData.isTextSelected) {</span>
<a href="#l10.601"></a><span id="l10.601" class="difflineplus">+      info.selectionText = contextData.selectionText;</span>
<a href="#l10.602"></a><span id="l10.602" class="difflineplus">+    }</span>
<a href="#l10.603"></a><span id="l10.603" class="difflineplus">+  }</span>
<a href="#l10.604"></a><span id="l10.604" class="difflineplus">+  // If the context was overridden, then frameUrl should be the URL of the</span>
<a href="#l10.605"></a><span id="l10.605" class="difflineplus">+  // document in which the menu was opened (instead of undefined, even if that</span>
<a href="#l10.606"></a><span id="l10.606" class="difflineplus">+  // document is not in a frame).</span>
<a href="#l10.607"></a><span id="l10.607" class="difflineplus">+  if (contextData.originalViewUrl) {</span>
<a href="#l10.608"></a><span id="l10.608" class="difflineplus">+    info.frameUrl = contextData.originalViewUrl;</span>
<a href="#l10.609"></a><span id="l10.609" class="difflineplus">+  }</span>
<a href="#l10.610"></a><span id="l10.610" class="difflineplus">+</span>
<a href="#l10.611"></a><span id="l10.611" class="difflineplus">+  if (contextData.selectedMessages &amp;&amp; extension.hasPermission(&quot;messagesRead&quot;)) {</span>
<a href="#l10.612"></a><span id="l10.612" class="difflineplus">+    info.selectedMessages = messageListTracker.startList(contextData.selectedMessages, {extension});</span>
<a href="#l10.613"></a><span id="l10.613" class="difflineplus">+  }</span>
<a href="#l10.614"></a><span id="l10.614" class="difflineplus">+  for (let folderType of [&quot;displayedFolder&quot;, &quot;selectedFolder&quot;]) {</span>
<a href="#l10.615"></a><span id="l10.615" class="difflineplus">+    if (contextData[folderType] &amp;&amp; extension.hasPermission(&quot;accountsRead&quot;)) {</span>
<a href="#l10.616"></a><span id="l10.616" class="difflineplus">+      info[folderType] = convertFolder(contextData[folderType]);</span>
<a href="#l10.617"></a><span id="l10.617" class="difflineplus">+    }</span>
<a href="#l10.618"></a><span id="l10.618" class="difflineplus">+  }</span>
<a href="#l10.619"></a><span id="l10.619" class="difflineplus">+}</span>
<a href="#l10.620"></a><span id="l10.620" class="difflineplus">+</span>
<a href="#l10.621"></a><span id="l10.621" class="difflineplus">+function MenuItem(extension, createProperties, isRoot = false) {</span>
<a href="#l10.622"></a><span id="l10.622" class="difflineplus">+  this.extension = extension;</span>
<a href="#l10.623"></a><span id="l10.623" class="difflineplus">+  this.children = [];</span>
<a href="#l10.624"></a><span id="l10.624" class="difflineplus">+  this.parent = null;</span>
<a href="#l10.625"></a><span id="l10.625" class="difflineplus">+  this.tabManager = extension.tabManager;</span>
<a href="#l10.626"></a><span id="l10.626" class="difflineplus">+</span>
<a href="#l10.627"></a><span id="l10.627" class="difflineplus">+  this.setDefaults();</span>
<a href="#l10.628"></a><span id="l10.628" class="difflineplus">+  this.setProps(createProperties);</span>
<a href="#l10.629"></a><span id="l10.629" class="difflineplus">+</span>
<a href="#l10.630"></a><span id="l10.630" class="difflineplus">+  if (!this.hasOwnProperty(&quot;_id&quot;)) {</span>
<a href="#l10.631"></a><span id="l10.631" class="difflineplus">+    this.id = gNextMenuItemID++;</span>
<a href="#l10.632"></a><span id="l10.632" class="difflineplus">+  }</span>
<a href="#l10.633"></a><span id="l10.633" class="difflineplus">+  // If the item is not the root and has no parent</span>
<a href="#l10.634"></a><span id="l10.634" class="difflineplus">+  // it must be a child of the root.</span>
<a href="#l10.635"></a><span id="l10.635" class="difflineplus">+  if (!isRoot &amp;&amp; !this.parent) {</span>
<a href="#l10.636"></a><span id="l10.636" class="difflineplus">+    this.root.addChild(this);</span>
<a href="#l10.637"></a><span id="l10.637" class="difflineplus">+  }</span>
<a href="#l10.638"></a><span id="l10.638" class="difflineplus">+}</span>
<a href="#l10.639"></a><span id="l10.639" class="difflineplus">+</span>
<a href="#l10.640"></a><span id="l10.640" class="difflineplus">+MenuItem.prototype = {</span>
<a href="#l10.641"></a><span id="l10.641" class="difflineplus">+  setProps(createProperties) {</span>
<a href="#l10.642"></a><span id="l10.642" class="difflineplus">+    for (let propName in createProperties) {</span>
<a href="#l10.643"></a><span id="l10.643" class="difflineplus">+      if (createProperties[propName] === null) {</span>
<a href="#l10.644"></a><span id="l10.644" class="difflineplus">+        // Omitted optional argument.</span>
<a href="#l10.645"></a><span id="l10.645" class="difflineplus">+        continue;</span>
<a href="#l10.646"></a><span id="l10.646" class="difflineplus">+      }</span>
<a href="#l10.647"></a><span id="l10.647" class="difflineplus">+      this[propName] = createProperties[propName];</span>
<a href="#l10.648"></a><span id="l10.648" class="difflineplus">+    }</span>
<a href="#l10.649"></a><span id="l10.649" class="difflineplus">+</span>
<a href="#l10.650"></a><span id="l10.650" class="difflineplus">+    if (&quot;icons&quot; in createProperties &amp;&amp; createProperties.icons === null) {</span>
<a href="#l10.651"></a><span id="l10.651" class="difflineplus">+      this.icons = null;</span>
<a href="#l10.652"></a><span id="l10.652" class="difflineplus">+    }</span>
<a href="#l10.653"></a><span id="l10.653" class="difflineplus">+</span>
<a href="#l10.654"></a><span id="l10.654" class="difflineplus">+    if (createProperties.documentUrlPatterns != null) {</span>
<a href="#l10.655"></a><span id="l10.655" class="difflineplus">+      this.documentUrlMatchPattern = new MatchPatternSet(this.documentUrlPatterns, {</span>
<a href="#l10.656"></a><span id="l10.656" class="difflineplus">+        restrictSchemes: this.extension.restrictSchemes,</span>
<a href="#l10.657"></a><span id="l10.657" class="difflineplus">+      });</span>
<a href="#l10.658"></a><span id="l10.658" class="difflineplus">+    }</span>
<a href="#l10.659"></a><span id="l10.659" class="difflineplus">+</span>
<a href="#l10.660"></a><span id="l10.660" class="difflineplus">+    if (createProperties.targetUrlPatterns != null) {</span>
<a href="#l10.661"></a><span id="l10.661" class="difflineplus">+      this.targetUrlMatchPattern = new MatchPatternSet(this.targetUrlPatterns, {</span>
<a href="#l10.662"></a><span id="l10.662" class="difflineplus">+        // restrictSchemes default to false when matching links instead of pages</span>
<a href="#l10.663"></a><span id="l10.663" class="difflineplus">+        // (see Bug 1280370 for a rationale).</span>
<a href="#l10.664"></a><span id="l10.664" class="difflineplus">+        restrictSchemes: false,</span>
<a href="#l10.665"></a><span id="l10.665" class="difflineplus">+      });</span>
<a href="#l10.666"></a><span id="l10.666" class="difflineplus">+    }</span>
<a href="#l10.667"></a><span id="l10.667" class="difflineplus">+</span>
<a href="#l10.668"></a><span id="l10.668" class="difflineplus">+    // If a child MenuItem does not specify any contexts, then it should</span>
<a href="#l10.669"></a><span id="l10.669" class="difflineplus">+    // inherit the contexts specified from its parent.</span>
<a href="#l10.670"></a><span id="l10.670" class="difflineplus">+    if (createProperties.parentId &amp;&amp; !createProperties.contexts) {</span>
<a href="#l10.671"></a><span id="l10.671" class="difflineplus">+      this.contexts = this.parent.contexts;</span>
<a href="#l10.672"></a><span id="l10.672" class="difflineplus">+    }</span>
<a href="#l10.673"></a><span id="l10.673" class="difflineplus">+  },</span>
<a href="#l10.674"></a><span id="l10.674" class="difflineplus">+</span>
<a href="#l10.675"></a><span id="l10.675" class="difflineplus">+  setDefaults() {</span>
<a href="#l10.676"></a><span id="l10.676" class="difflineplus">+    this.setProps({</span>
<a href="#l10.677"></a><span id="l10.677" class="difflineplus">+      type: &quot;normal&quot;,</span>
<a href="#l10.678"></a><span id="l10.678" class="difflineplus">+      checked: false,</span>
<a href="#l10.679"></a><span id="l10.679" class="difflineplus">+      contexts: [&quot;all&quot;],</span>
<a href="#l10.680"></a><span id="l10.680" class="difflineplus">+      enabled: true,</span>
<a href="#l10.681"></a><span id="l10.681" class="difflineplus">+      visible: true,</span>
<a href="#l10.682"></a><span id="l10.682" class="difflineplus">+    });</span>
<a href="#l10.683"></a><span id="l10.683" class="difflineplus">+  },</span>
<a href="#l10.684"></a><span id="l10.684" class="difflineplus">+</span>
<a href="#l10.685"></a><span id="l10.685" class="difflineplus">+  set id(id) {</span>
<a href="#l10.686"></a><span id="l10.686" class="difflineplus">+    if (this.hasOwnProperty(&quot;_id&quot;)) {</span>
<a href="#l10.687"></a><span id="l10.687" class="difflineplus">+      throw new ExtensionError(&quot;ID of a MenuItem cannot be changed&quot;);</span>
<a href="#l10.688"></a><span id="l10.688" class="difflineplus">+    }</span>
<a href="#l10.689"></a><span id="l10.689" class="difflineplus">+    let isIdUsed = gMenuMap.get(this.extension).has(id);</span>
<a href="#l10.690"></a><span id="l10.690" class="difflineplus">+    if (isIdUsed) {</span>
<a href="#l10.691"></a><span id="l10.691" class="difflineplus">+      throw new ExtensionError(`ID already exists: ${id}`);</span>
<a href="#l10.692"></a><span id="l10.692" class="difflineplus">+    }</span>
<a href="#l10.693"></a><span id="l10.693" class="difflineplus">+    this._id = id;</span>
<a href="#l10.694"></a><span id="l10.694" class="difflineplus">+  },</span>
<a href="#l10.695"></a><span id="l10.695" class="difflineplus">+</span>
<a href="#l10.696"></a><span id="l10.696" class="difflineplus">+  get id() {</span>
<a href="#l10.697"></a><span id="l10.697" class="difflineplus">+    return this._id;</span>
<a href="#l10.698"></a><span id="l10.698" class="difflineplus">+  },</span>
<a href="#l10.699"></a><span id="l10.699" class="difflineplus">+</span>
<a href="#l10.700"></a><span id="l10.700" class="difflineplus">+  get elementId() {</span>
<a href="#l10.701"></a><span id="l10.701" class="difflineplus">+    let id = this.id;</span>
<a href="#l10.702"></a><span id="l10.702" class="difflineplus">+    // If the ID is an integer, it is auto-generated and globally unique.</span>
<a href="#l10.703"></a><span id="l10.703" class="difflineplus">+    // If the ID is a string, it is only unique within one extension and the</span>
<a href="#l10.704"></a><span id="l10.704" class="difflineplus">+    // ID needs to be concatenated with the extension ID.</span>
<a href="#l10.705"></a><span id="l10.705" class="difflineplus">+    if (typeof id !== &quot;number&quot;) {</span>
<a href="#l10.706"></a><span id="l10.706" class="difflineplus">+      // To avoid collisions with numeric IDs, add a prefix to string IDs.</span>
<a href="#l10.707"></a><span id="l10.707" class="difflineplus">+      id = `_${id}`;</span>
<a href="#l10.708"></a><span id="l10.708" class="difflineplus">+    }</span>
<a href="#l10.709"></a><span id="l10.709" class="difflineplus">+    return `${makeWidgetId(this.extension.id)}-menuitem-${id}`;</span>
<a href="#l10.710"></a><span id="l10.710" class="difflineplus">+  },</span>
<a href="#l10.711"></a><span id="l10.711" class="difflineplus">+</span>
<a href="#l10.712"></a><span id="l10.712" class="difflineplus">+  ensureValidParentId(parentId) {</span>
<a href="#l10.713"></a><span id="l10.713" class="difflineplus">+    if (parentId === undefined) {</span>
<a href="#l10.714"></a><span id="l10.714" class="difflineplus">+      return;</span>
<a href="#l10.715"></a><span id="l10.715" class="difflineplus">+    }</span>
<a href="#l10.716"></a><span id="l10.716" class="difflineplus">+    let menuMap = gMenuMap.get(this.extension);</span>
<a href="#l10.717"></a><span id="l10.717" class="difflineplus">+    if (!menuMap.has(parentId)) {</span>
<a href="#l10.718"></a><span id="l10.718" class="difflineplus">+      throw new ExtensionError(`Could not find any MenuItem with id: ${parentId}`);</span>
<a href="#l10.719"></a><span id="l10.719" class="difflineplus">+    }</span>
<a href="#l10.720"></a><span id="l10.720" class="difflineplus">+    for (let item = menuMap.get(parentId); item; item = item.parent) {</span>
<a href="#l10.721"></a><span id="l10.721" class="difflineplus">+      if (item === this) {</span>
<a href="#l10.722"></a><span id="l10.722" class="difflineplus">+        throw new ExtensionError(&quot;MenuItem cannot be an ancestor (or self) of its new parent.&quot;);</span>
<a href="#l10.723"></a><span id="l10.723" class="difflineplus">+      }</span>
<a href="#l10.724"></a><span id="l10.724" class="difflineplus">+    }</span>
<a href="#l10.725"></a><span id="l10.725" class="difflineplus">+  },</span>
<a href="#l10.726"></a><span id="l10.726" class="difflineplus">+</span>
<a href="#l10.727"></a><span id="l10.727" class="difflineplus">+  set parentId(parentId) {</span>
<a href="#l10.728"></a><span id="l10.728" class="difflineplus">+    this.ensureValidParentId(parentId);</span>
<a href="#l10.729"></a><span id="l10.729" class="difflineplus">+</span>
<a href="#l10.730"></a><span id="l10.730" class="difflineplus">+    if (this.parent) {</span>
<a href="#l10.731"></a><span id="l10.731" class="difflineplus">+      this.parent.detachChild(this);</span>
<a href="#l10.732"></a><span id="l10.732" class="difflineplus">+    }</span>
<a href="#l10.733"></a><span id="l10.733" class="difflineplus">+</span>
<a href="#l10.734"></a><span id="l10.734" class="difflineplus">+    if (parentId === undefined) {</span>
<a href="#l10.735"></a><span id="l10.735" class="difflineplus">+      this.root.addChild(this);</span>
<a href="#l10.736"></a><span id="l10.736" class="difflineplus">+    } else {</span>
<a href="#l10.737"></a><span id="l10.737" class="difflineplus">+      let menuMap = gMenuMap.get(this.extension);</span>
<a href="#l10.738"></a><span id="l10.738" class="difflineplus">+      menuMap.get(parentId).addChild(this);</span>
<a href="#l10.739"></a><span id="l10.739" class="difflineplus">+    }</span>
<a href="#l10.740"></a><span id="l10.740" class="difflineplus">+  },</span>
<a href="#l10.741"></a><span id="l10.741" class="difflineplus">+</span>
<a href="#l10.742"></a><span id="l10.742" class="difflineplus">+  get parentId() {</span>
<a href="#l10.743"></a><span id="l10.743" class="difflineplus">+    return this.parent ? this.parent.id : undefined;</span>
<a href="#l10.744"></a><span id="l10.744" class="difflineplus">+  },</span>
<a href="#l10.745"></a><span id="l10.745" class="difflineplus">+</span>
<a href="#l10.746"></a><span id="l10.746" class="difflineplus">+  addChild(child) {</span>
<a href="#l10.747"></a><span id="l10.747" class="difflineplus">+    if (child.parent) {</span>
<a href="#l10.748"></a><span id="l10.748" class="difflineplus">+      throw new Error(&quot;Child MenuItem already has a parent.&quot;);</span>
<a href="#l10.749"></a><span id="l10.749" class="difflineplus">+    }</span>
<a href="#l10.750"></a><span id="l10.750" class="difflineplus">+    this.children.push(child);</span>
<a href="#l10.751"></a><span id="l10.751" class="difflineplus">+    child.parent = this;</span>
<a href="#l10.752"></a><span id="l10.752" class="difflineplus">+  },</span>
<a href="#l10.753"></a><span id="l10.753" class="difflineplus">+</span>
<a href="#l10.754"></a><span id="l10.754" class="difflineplus">+  detachChild(child) {</span>
<a href="#l10.755"></a><span id="l10.755" class="difflineplus">+    let idx = this.children.indexOf(child);</span>
<a href="#l10.756"></a><span id="l10.756" class="difflineplus">+    if (idx &lt; 0) {</span>
<a href="#l10.757"></a><span id="l10.757" class="difflineplus">+      throw new Error(&quot;Child MenuItem not found, it cannot be removed.&quot;);</span>
<a href="#l10.758"></a><span id="l10.758" class="difflineplus">+    }</span>
<a href="#l10.759"></a><span id="l10.759" class="difflineplus">+    this.children.splice(idx, 1);</span>
<a href="#l10.760"></a><span id="l10.760" class="difflineplus">+    child.parent = null;</span>
<a href="#l10.761"></a><span id="l10.761" class="difflineplus">+  },</span>
<a href="#l10.762"></a><span id="l10.762" class="difflineplus">+</span>
<a href="#l10.763"></a><span id="l10.763" class="difflineplus">+  get root() {</span>
<a href="#l10.764"></a><span id="l10.764" class="difflineplus">+    let extension = this.extension;</span>
<a href="#l10.765"></a><span id="l10.765" class="difflineplus">+    if (!gRootItems.has(extension)) {</span>
<a href="#l10.766"></a><span id="l10.766" class="difflineplus">+      let root = new MenuItem(extension,</span>
<a href="#l10.767"></a><span id="l10.767" class="difflineplus">+                              {title: extension.name},</span>
<a href="#l10.768"></a><span id="l10.768" class="difflineplus">+                              /* isRoot = */ true);</span>
<a href="#l10.769"></a><span id="l10.769" class="difflineplus">+      gRootItems.set(extension, root);</span>
<a href="#l10.770"></a><span id="l10.770" class="difflineplus">+    }</span>
<a href="#l10.771"></a><span id="l10.771" class="difflineplus">+</span>
<a href="#l10.772"></a><span id="l10.772" class="difflineplus">+    return gRootItems.get(extension);</span>
<a href="#l10.773"></a><span id="l10.773" class="difflineplus">+  },</span>
<a href="#l10.774"></a><span id="l10.774" class="difflineplus">+</span>
<a href="#l10.775"></a><span id="l10.775" class="difflineplus">+  remove() {</span>
<a href="#l10.776"></a><span id="l10.776" class="difflineplus">+    if (this.parent) {</span>
<a href="#l10.777"></a><span id="l10.777" class="difflineplus">+      this.parent.detachChild(this);</span>
<a href="#l10.778"></a><span id="l10.778" class="difflineplus">+    }</span>
<a href="#l10.779"></a><span id="l10.779" class="difflineplus">+    let children = this.children.slice(0);</span>
<a href="#l10.780"></a><span id="l10.780" class="difflineplus">+    for (let child of children) {</span>
<a href="#l10.781"></a><span id="l10.781" class="difflineplus">+      child.remove();</span>
<a href="#l10.782"></a><span id="l10.782" class="difflineplus">+    }</span>
<a href="#l10.783"></a><span id="l10.783" class="difflineplus">+</span>
<a href="#l10.784"></a><span id="l10.784" class="difflineplus">+    let menuMap = gMenuMap.get(this.extension);</span>
<a href="#l10.785"></a><span id="l10.785" class="difflineplus">+    menuMap.delete(this.id);</span>
<a href="#l10.786"></a><span id="l10.786" class="difflineplus">+    if (this.root == this) {</span>
<a href="#l10.787"></a><span id="l10.787" class="difflineplus">+      gRootItems.delete(this.extension);</span>
<a href="#l10.788"></a><span id="l10.788" class="difflineplus">+    }</span>
<a href="#l10.789"></a><span id="l10.789" class="difflineplus">+  },</span>
<a href="#l10.790"></a><span id="l10.790" class="difflineplus">+</span>
<a href="#l10.791"></a><span id="l10.791" class="difflineplus">+  getClickInfo(contextData, wasChecked) {</span>
<a href="#l10.792"></a><span id="l10.792" class="difflineplus">+    let info = {</span>
<a href="#l10.793"></a><span id="l10.793" class="difflineplus">+      menuItemId: this.id,</span>
<a href="#l10.794"></a><span id="l10.794" class="difflineplus">+    };</span>
<a href="#l10.795"></a><span id="l10.795" class="difflineplus">+    if (this.parent) {</span>
<a href="#l10.796"></a><span id="l10.796" class="difflineplus">+      info.parentMenuItemId = this.parentId;</span>
<a href="#l10.797"></a><span id="l10.797" class="difflineplus">+    }</span>
<a href="#l10.798"></a><span id="l10.798" class="difflineplus">+</span>
<a href="#l10.799"></a><span id="l10.799" class="difflineplus">+    addMenuEventInfo(info, contextData, this.extension, true);</span>
<a href="#l10.800"></a><span id="l10.800" class="difflineplus">+</span>
<a href="#l10.801"></a><span id="l10.801" class="difflineplus">+    if ((this.type === &quot;checkbox&quot;) || (this.type === &quot;radio&quot;)) {</span>
<a href="#l10.802"></a><span id="l10.802" class="difflineplus">+      info.checked = this.checked;</span>
<a href="#l10.803"></a><span id="l10.803" class="difflineplus">+      info.wasChecked = wasChecked;</span>
<a href="#l10.804"></a><span id="l10.804" class="difflineplus">+    }</span>
<a href="#l10.805"></a><span id="l10.805" class="difflineplus">+</span>
<a href="#l10.806"></a><span id="l10.806" class="difflineplus">+    return info;</span>
<a href="#l10.807"></a><span id="l10.807" class="difflineplus">+  },</span>
<a href="#l10.808"></a><span id="l10.808" class="difflineplus">+</span>
<a href="#l10.809"></a><span id="l10.809" class="difflineplus">+  enabledForContext(contextData) {</span>
<a href="#l10.810"></a><span id="l10.810" class="difflineplus">+    if (!this.visible) {</span>
<a href="#l10.811"></a><span id="l10.811" class="difflineplus">+      return false;</span>
<a href="#l10.812"></a><span id="l10.812" class="difflineplus">+    }</span>
<a href="#l10.813"></a><span id="l10.813" class="difflineplus">+    let contexts = getMenuContexts(contextData);</span>
<a href="#l10.814"></a><span id="l10.814" class="difflineplus">+    if (!this.contexts.some(n =&gt; contexts.has(n))) {</span>
<a href="#l10.815"></a><span id="l10.815" class="difflineplus">+      return false;</span>
<a href="#l10.816"></a><span id="l10.816" class="difflineplus">+    }</span>
<a href="#l10.817"></a><span id="l10.817" class="difflineplus">+</span>
<a href="#l10.818"></a><span id="l10.818" class="difflineplus">+    if (this.viewTypes &amp;&amp; !this.viewTypes.includes(getContextViewType(contextData))) {</span>
<a href="#l10.819"></a><span id="l10.819" class="difflineplus">+      return false;</span>
<a href="#l10.820"></a><span id="l10.820" class="difflineplus">+    }</span>
<a href="#l10.821"></a><span id="l10.821" class="difflineplus">+</span>
<a href="#l10.822"></a><span id="l10.822" class="difflineplus">+    let docPattern = this.documentUrlMatchPattern;</span>
<a href="#l10.823"></a><span id="l10.823" class="difflineplus">+    // When viewTypes is specified, the menu item is expected to be restricted</span>
<a href="#l10.824"></a><span id="l10.824" class="difflineplus">+    // to documents. So let documentUrlPatterns always apply to the URL of the</span>
<a href="#l10.825"></a><span id="l10.825" class="difflineplus">+    // document in which the menu was opened. When maybeOverrideContextData</span>
<a href="#l10.826"></a><span id="l10.826" class="difflineplus">+    // changes the context, contextData.pageUrl does not reflect that URL any</span>
<a href="#l10.827"></a><span id="l10.827" class="difflineplus">+    // more, so use contextData.originalViewUrl instead.</span>
<a href="#l10.828"></a><span id="l10.828" class="difflineplus">+    if (docPattern &amp;&amp; this.viewTypes &amp;&amp; contextData.originalViewUrl) {</span>
<a href="#l10.829"></a><span id="l10.829" class="difflineplus">+      if (!docPattern.matches(Services.io.newURI(contextData.originalViewUrl))) {</span>
<a href="#l10.830"></a><span id="l10.830" class="difflineplus">+        return false;</span>
<a href="#l10.831"></a><span id="l10.831" class="difflineplus">+      }</span>
<a href="#l10.832"></a><span id="l10.832" class="difflineplus">+      docPattern = null; // Null it so that it won't be used with pageURI below.</span>
<a href="#l10.833"></a><span id="l10.833" class="difflineplus">+    }</span>
<a href="#l10.834"></a><span id="l10.834" class="difflineplus">+</span>
<a href="#l10.835"></a><span id="l10.835" class="difflineplus">+    let pageURI = contextData[contextData.inFrame ? &quot;frameUrl&quot; : &quot;pageUrl&quot;];</span>
<a href="#l10.836"></a><span id="l10.836" class="difflineplus">+    if (pageURI) {</span>
<a href="#l10.837"></a><span id="l10.837" class="difflineplus">+      pageURI = Services.io.newURI(pageURI);</span>
<a href="#l10.838"></a><span id="l10.838" class="difflineplus">+      if (docPattern &amp;&amp; !docPattern.matches(pageURI)) {</span>
<a href="#l10.839"></a><span id="l10.839" class="difflineplus">+        return false;</span>
<a href="#l10.840"></a><span id="l10.840" class="difflineplus">+      }</span>
<a href="#l10.841"></a><span id="l10.841" class="difflineplus">+    }</span>
<a href="#l10.842"></a><span id="l10.842" class="difflineplus">+</span>
<a href="#l10.843"></a><span id="l10.843" class="difflineplus">+    let targetPattern = this.targetUrlMatchPattern;</span>
<a href="#l10.844"></a><span id="l10.844" class="difflineplus">+    if (targetPattern) {</span>
<a href="#l10.845"></a><span id="l10.845" class="difflineplus">+      let targetUrls = [];</span>
<a href="#l10.846"></a><span id="l10.846" class="difflineplus">+      if (contextData.onImage || contextData.onAudio || contextData.onVideo) {</span>
<a href="#l10.847"></a><span id="l10.847" class="difflineplus">+        // TODO: double check if srcUrl is always set when we need it</span>
<a href="#l10.848"></a><span id="l10.848" class="difflineplus">+        targetUrls.push(contextData.srcUrl);</span>
<a href="#l10.849"></a><span id="l10.849" class="difflineplus">+      }</span>
<a href="#l10.850"></a><span id="l10.850" class="difflineplus">+      if (contextData.onLink) {</span>
<a href="#l10.851"></a><span id="l10.851" class="difflineplus">+        targetUrls.push(contextData.linkUrl);</span>
<a href="#l10.852"></a><span id="l10.852" class="difflineplus">+      }</span>
<a href="#l10.853"></a><span id="l10.853" class="difflineplus">+      if (!targetUrls.some(targetUrl =&gt; targetPattern.matches(Services.io.newURI(targetUrl)))) {</span>
<a href="#l10.854"></a><span id="l10.854" class="difflineplus">+        return false;</span>
<a href="#l10.855"></a><span id="l10.855" class="difflineplus">+      }</span>
<a href="#l10.856"></a><span id="l10.856" class="difflineplus">+    }</span>
<a href="#l10.857"></a><span id="l10.857" class="difflineplus">+</span>
<a href="#l10.858"></a><span id="l10.858" class="difflineplus">+    return true;</span>
<a href="#l10.859"></a><span id="l10.859" class="difflineplus">+  },</span>
<a href="#l10.860"></a><span id="l10.860" class="difflineplus">+};</span>
<a href="#l10.861"></a><span id="l10.861" class="difflineplus">+</span>
<a href="#l10.862"></a><span id="l10.862" class="difflineplus">+// While any extensions are active, this Tracker registers to observe/listen</span>
<a href="#l10.863"></a><span id="l10.863" class="difflineplus">+// for menu events from both Tools and context menus, both content and chrome.</span>
<a href="#l10.864"></a><span id="l10.864" class="difflineplus">+const menuTracker = {</span>
<a href="#l10.865"></a><span id="l10.865" class="difflineplus">+  menuIds: [&quot;tabContextMenu&quot;, &quot;folderPaneContext&quot;],</span>
<a href="#l10.866"></a><span id="l10.866" class="difflineplus">+</span>
<a href="#l10.867"></a><span id="l10.867" class="difflineplus">+  register() {</span>
<a href="#l10.868"></a><span id="l10.868" class="difflineplus">+    Services.obs.addObserver(this, &quot;on-build-contextmenu&quot;);</span>
<a href="#l10.869"></a><span id="l10.869" class="difflineplus">+    for (const window of windowTracker.browserWindows()) {</span>
<a href="#l10.870"></a><span id="l10.870" class="difflineplus">+      this.onWindowOpen(window);</span>
<a href="#l10.871"></a><span id="l10.871" class="difflineplus">+    }</span>
<a href="#l10.872"></a><span id="l10.872" class="difflineplus">+    windowTracker.addOpenListener(this.onWindowOpen);</span>
<a href="#l10.873"></a><span id="l10.873" class="difflineplus">+  },</span>
<a href="#l10.874"></a><span id="l10.874" class="difflineplus">+</span>
<a href="#l10.875"></a><span id="l10.875" class="difflineplus">+  unregister() {</span>
<a href="#l10.876"></a><span id="l10.876" class="difflineplus">+    Services.obs.removeObserver(this, &quot;on-build-contextmenu&quot;);</span>
<a href="#l10.877"></a><span id="l10.877" class="difflineplus">+    for (const window of windowTracker.browserWindows()) {</span>
<a href="#l10.878"></a><span id="l10.878" class="difflineplus">+      for (const id of this.menuIds) {</span>
<a href="#l10.879"></a><span id="l10.879" class="difflineplus">+        const menu = window.document.getElementById(id);</span>
<a href="#l10.880"></a><span id="l10.880" class="difflineplus">+        menu.removeEventListener(&quot;popupshowing&quot;, this);</span>
<a href="#l10.881"></a><span id="l10.881" class="difflineplus">+      }</span>
<a href="#l10.882"></a><span id="l10.882" class="difflineplus">+    }</span>
<a href="#l10.883"></a><span id="l10.883" class="difflineplus">+    windowTracker.removeOpenListener(this.onWindowOpen);</span>
<a href="#l10.884"></a><span id="l10.884" class="difflineplus">+  },</span>
<a href="#l10.885"></a><span id="l10.885" class="difflineplus">+</span>
<a href="#l10.886"></a><span id="l10.886" class="difflineplus">+  observe(subject, topic, data) {</span>
<a href="#l10.887"></a><span id="l10.887" class="difflineplus">+    subject = subject.wrappedJSObject;</span>
<a href="#l10.888"></a><span id="l10.888" class="difflineplus">+    gMenuBuilder.build(subject);</span>
<a href="#l10.889"></a><span id="l10.889" class="difflineplus">+  },</span>
<a href="#l10.890"></a><span id="l10.890" class="difflineplus">+</span>
<a href="#l10.891"></a><span id="l10.891" class="difflineplus">+  onWindowOpen(window) {</span>
<a href="#l10.892"></a><span id="l10.892" class="difflineplus">+    for (const id of menuTracker.menuIds) {</span>
<a href="#l10.893"></a><span id="l10.893" class="difflineplus">+      const menu = window.document.getElementById(id);</span>
<a href="#l10.894"></a><span id="l10.894" class="difflineplus">+      menu.addEventListener(&quot;popupshowing&quot;, menuTracker);</span>
<a href="#l10.895"></a><span id="l10.895" class="difflineplus">+    }</span>
<a href="#l10.896"></a><span id="l10.896" class="difflineplus">+  },</span>
<a href="#l10.897"></a><span id="l10.897" class="difflineplus">+</span>
<a href="#l10.898"></a><span id="l10.898" class="difflineplus">+  handleEvent(event) {</span>
<a href="#l10.899"></a><span id="l10.899" class="difflineplus">+    const menu = event.target;</span>
<a href="#l10.900"></a><span id="l10.900" class="difflineplus">+    if (menu.id === &quot;tabContextMenu&quot;) {</span>
<a href="#l10.901"></a><span id="l10.901" class="difflineplus">+      const trigger = menu.triggerNode;</span>
<a href="#l10.902"></a><span id="l10.902" class="difflineplus">+      const tab = trigger.localName === &quot;tab&quot; ? trigger : tabTracker.activeTab;</span>
<a href="#l10.903"></a><span id="l10.903" class="difflineplus">+      const pageUrl = tab.linkedBrowser.currentURI.spec;</span>
<a href="#l10.904"></a><span id="l10.904" class="difflineplus">+      gMenuBuilder.build({menu, tab, pageUrl, onTab: true});</span>
<a href="#l10.905"></a><span id="l10.905" class="difflineplus">+    }</span>
<a href="#l10.906"></a><span id="l10.906" class="difflineplus">+    if (menu.id === &quot;folderPaneContext&quot;) {</span>
<a href="#l10.907"></a><span id="l10.907" class="difflineplus">+      const trigger = menu.triggerNode;</span>
<a href="#l10.908"></a><span id="l10.908" class="difflineplus">+      const tab = trigger.localName === &quot;tab&quot; ? trigger : tabTracker.activeTab;</span>
<a href="#l10.909"></a><span id="l10.909" class="difflineplus">+      const pageUrl = tab.linkedBrowser.currentURI.spec;</span>
<a href="#l10.910"></a><span id="l10.910" class="difflineplus">+      gMenuBuilder.build({</span>
<a href="#l10.911"></a><span id="l10.911" class="difflineplus">+        menu, tab, pageUrl,</span>
<a href="#l10.912"></a><span id="l10.912" class="difflineplus">+        selectedFolder: trigger.ownerGlobal.gFolderTreeView.getSelectedFolders()[0],</span>
<a href="#l10.913"></a><span id="l10.913" class="difflineplus">+      });</span>
<a href="#l10.914"></a><span id="l10.914" class="difflineplus">+    }</span>
<a href="#l10.915"></a><span id="l10.915" class="difflineplus">+  },</span>
<a href="#l10.916"></a><span id="l10.916" class="difflineplus">+};</span>
<a href="#l10.917"></a><span id="l10.917" class="difflineplus">+</span>
<a href="#l10.918"></a><span id="l10.918" class="difflineplus">+this.menus = class extends ExtensionAPI {</span>
<a href="#l10.919"></a><span id="l10.919" class="difflineplus">+  constructor(extension) {</span>
<a href="#l10.920"></a><span id="l10.920" class="difflineplus">+    super(extension);</span>
<a href="#l10.921"></a><span id="l10.921" class="difflineplus">+</span>
<a href="#l10.922"></a><span id="l10.922" class="difflineplus">+    if (!gMenuMap.size) {</span>
<a href="#l10.923"></a><span id="l10.923" class="difflineplus">+      menuTracker.register();</span>
<a href="#l10.924"></a><span id="l10.924" class="difflineplus">+    }</span>
<a href="#l10.925"></a><span id="l10.925" class="difflineplus">+    gMenuMap.set(extension, new Map());</span>
<a href="#l10.926"></a><span id="l10.926" class="difflineplus">+  }</span>
<a href="#l10.927"></a><span id="l10.927" class="difflineplus">+</span>
<a href="#l10.928"></a><span id="l10.928" class="difflineplus">+  onShutdown(reason) {</span>
<a href="#l10.929"></a><span id="l10.929" class="difflineplus">+    let {extension} = this;</span>
<a href="#l10.930"></a><span id="l10.930" class="difflineplus">+</span>
<a href="#l10.931"></a><span id="l10.931" class="difflineplus">+    if (gMenuMap.has(extension)) {</span>
<a href="#l10.932"></a><span id="l10.932" class="difflineplus">+      gMenuMap.delete(extension);</span>
<a href="#l10.933"></a><span id="l10.933" class="difflineplus">+      gRootItems.delete(extension);</span>
<a href="#l10.934"></a><span id="l10.934" class="difflineplus">+      gShownMenuItems.delete(extension);</span>
<a href="#l10.935"></a><span id="l10.935" class="difflineplus">+      gOnShownSubscribers.delete(extension);</span>
<a href="#l10.936"></a><span id="l10.936" class="difflineplus">+      if (!gMenuMap.size) {</span>
<a href="#l10.937"></a><span id="l10.937" class="difflineplus">+        menuTracker.unregister();</span>
<a href="#l10.938"></a><span id="l10.938" class="difflineplus">+      }</span>
<a href="#l10.939"></a><span id="l10.939" class="difflineplus">+    }</span>
<a href="#l10.940"></a><span id="l10.940" class="difflineplus">+  }</span>
<a href="#l10.941"></a><span id="l10.941" class="difflineplus">+</span>
<a href="#l10.942"></a><span id="l10.942" class="difflineplus">+  getAPI(context) {</span>
<a href="#l10.943"></a><span id="l10.943" class="difflineplus">+    let {extension} = context;</span>
<a href="#l10.944"></a><span id="l10.944" class="difflineplus">+</span>
<a href="#l10.945"></a><span id="l10.945" class="difflineplus">+    return {</span>
<a href="#l10.946"></a><span id="l10.946" class="difflineplus">+      menus: {</span>
<a href="#l10.947"></a><span id="l10.947" class="difflineplus">+        refresh() {</span>
<a href="#l10.948"></a><span id="l10.948" class="difflineplus">+          gMenuBuilder.rebuildMenu(extension);</span>
<a href="#l10.949"></a><span id="l10.949" class="difflineplus">+        },</span>
<a href="#l10.950"></a><span id="l10.950" class="difflineplus">+</span>
<a href="#l10.951"></a><span id="l10.951" class="difflineplus">+        onShown: new EventManager({</span>
<a href="#l10.952"></a><span id="l10.952" class="difflineplus">+          context,</span>
<a href="#l10.953"></a><span id="l10.953" class="difflineplus">+          name: &quot;menus.onShown&quot;,</span>
<a href="#l10.954"></a><span id="l10.954" class="difflineplus">+          register: fire =&gt; {</span>
<a href="#l10.955"></a><span id="l10.955" class="difflineplus">+            let listener = (event, menuIds, contextData) =&gt; {</span>
<a href="#l10.956"></a><span id="l10.956" class="difflineplus">+              let info = {</span>
<a href="#l10.957"></a><span id="l10.957" class="difflineplus">+                menuIds,</span>
<a href="#l10.958"></a><span id="l10.958" class="difflineplus">+                contexts: Array.from(getMenuContexts(contextData)),</span>
<a href="#l10.959"></a><span id="l10.959" class="difflineplus">+              };</span>
<a href="#l10.960"></a><span id="l10.960" class="difflineplus">+</span>
<a href="#l10.961"></a><span id="l10.961" class="difflineplus">+              let nativeTab = contextData.tab;</span>
<a href="#l10.962"></a><span id="l10.962" class="difflineplus">+</span>
<a href="#l10.963"></a><span id="l10.963" class="difflineplus">+              // The menus.onShown event is fired before the user has consciously</span>
<a href="#l10.964"></a><span id="l10.964" class="difflineplus">+              // interacted with an extension, so we require permissions before</span>
<a href="#l10.965"></a><span id="l10.965" class="difflineplus">+              // exposing sensitive contextual data.</span>
<a href="#l10.966"></a><span id="l10.966" class="difflineplus">+              let contextUrl = contextData.inFrame ? contextData.frameUrl : contextData.pageUrl;</span>
<a href="#l10.967"></a><span id="l10.967" class="difflineplus">+              let includeSensitiveData =</span>
<a href="#l10.968"></a><span id="l10.968" class="difflineplus">+                (nativeTab &amp;&amp; extension.tabManager.hasActiveTabPermission(nativeTab)) ||</span>
<a href="#l10.969"></a><span id="l10.969" class="difflineplus">+                (contextUrl &amp;&amp; extension.whiteListedHosts.matches(contextUrl));</span>
<a href="#l10.970"></a><span id="l10.970" class="difflineplus">+</span>
<a href="#l10.971"></a><span id="l10.971" class="difflineplus">+              addMenuEventInfo(info, contextData, extension, includeSensitiveData);</span>
<a href="#l10.972"></a><span id="l10.972" class="difflineplus">+</span>
<a href="#l10.973"></a><span id="l10.973" class="difflineplus">+              let tab = nativeTab &amp;&amp; extension.tabManager.convert(nativeTab);</span>
<a href="#l10.974"></a><span id="l10.974" class="difflineplus">+              fire.sync(info, tab);</span>
<a href="#l10.975"></a><span id="l10.975" class="difflineplus">+            };</span>
<a href="#l10.976"></a><span id="l10.976" class="difflineplus">+            gOnShownSubscribers.add(extension);</span>
<a href="#l10.977"></a><span id="l10.977" class="difflineplus">+            extension.on(&quot;webext-menu-shown&quot;, listener);</span>
<a href="#l10.978"></a><span id="l10.978" class="difflineplus">+            return () =&gt; {</span>
<a href="#l10.979"></a><span id="l10.979" class="difflineplus">+              gOnShownSubscribers.delete(extension);</span>
<a href="#l10.980"></a><span id="l10.980" class="difflineplus">+              extension.off(&quot;webext-menu-shown&quot;, listener);</span>
<a href="#l10.981"></a><span id="l10.981" class="difflineplus">+            };</span>
<a href="#l10.982"></a><span id="l10.982" class="difflineplus">+          },</span>
<a href="#l10.983"></a><span id="l10.983" class="difflineplus">+        }).api(),</span>
<a href="#l10.984"></a><span id="l10.984" class="difflineplus">+        onHidden: new EventManager({</span>
<a href="#l10.985"></a><span id="l10.985" class="difflineplus">+          context,</span>
<a href="#l10.986"></a><span id="l10.986" class="difflineplus">+          name: &quot;menus.onHidden&quot;,</span>
<a href="#l10.987"></a><span id="l10.987" class="difflineplus">+          register: fire =&gt; {</span>
<a href="#l10.988"></a><span id="l10.988" class="difflineplus">+            let listener = () =&gt; {</span>
<a href="#l10.989"></a><span id="l10.989" class="difflineplus">+              fire.sync();</span>
<a href="#l10.990"></a><span id="l10.990" class="difflineplus">+            };</span>
<a href="#l10.991"></a><span id="l10.991" class="difflineplus">+            extension.on(&quot;webext-menu-hidden&quot;, listener);</span>
<a href="#l10.992"></a><span id="l10.992" class="difflineplus">+            return () =&gt; {</span>
<a href="#l10.993"></a><span id="l10.993" class="difflineplus">+              extension.off(&quot;webext-menu-hidden&quot;, listener);</span>
<a href="#l10.994"></a><span id="l10.994" class="difflineplus">+            };</span>
<a href="#l10.995"></a><span id="l10.995" class="difflineplus">+          },</span>
<a href="#l10.996"></a><span id="l10.996" class="difflineplus">+        }).api(),</span>
<a href="#l10.997"></a><span id="l10.997" class="difflineplus">+</span>
<a href="#l10.998"></a><span id="l10.998" class="difflineplus">+        create(createProperties) {</span>
<a href="#l10.999"></a><span id="l10.999" class="difflineplus">+          // Note that the id is required by the schema. If the addon did not set</span>
<a href="#l10.1000"></a><span id="l10.1000" class="difflineplus">+          // it, the implementation of menus.create in the child should</span>
<a href="#l10.1001"></a><span id="l10.1001" class="difflineplus">+          // have added it.</span>
<a href="#l10.1002"></a><span id="l10.1002" class="difflineplus">+          let menuItem = new MenuItem(extension, createProperties);</span>
<a href="#l10.1003"></a><span id="l10.1003" class="difflineplus">+          gMenuMap.get(extension).set(menuItem.id, menuItem);</span>
<a href="#l10.1004"></a><span id="l10.1004" class="difflineplus">+        },</span>
<a href="#l10.1005"></a><span id="l10.1005" class="difflineplus">+</span>
<a href="#l10.1006"></a><span id="l10.1006" class="difflineplus">+        update(id, updateProperties) {</span>
<a href="#l10.1007"></a><span id="l10.1007" class="difflineplus">+          let menuItem = gMenuMap.get(extension).get(id);</span>
<a href="#l10.1008"></a><span id="l10.1008" class="difflineplus">+          if (menuItem) {</span>
<a href="#l10.1009"></a><span id="l10.1009" class="difflineplus">+            menuItem.setProps(updateProperties);</span>
<a href="#l10.1010"></a><span id="l10.1010" class="difflineplus">+          }</span>
<a href="#l10.1011"></a><span id="l10.1011" class="difflineplus">+        },</span>
<a href="#l10.1012"></a><span id="l10.1012" class="difflineplus">+</span>
<a href="#l10.1013"></a><span id="l10.1013" class="difflineplus">+        remove(id) {</span>
<a href="#l10.1014"></a><span id="l10.1014" class="difflineplus">+          let menuItem = gMenuMap.get(extension).get(id);</span>
<a href="#l10.1015"></a><span id="l10.1015" class="difflineplus">+          if (menuItem) {</span>
<a href="#l10.1016"></a><span id="l10.1016" class="difflineplus">+            menuItem.remove();</span>
<a href="#l10.1017"></a><span id="l10.1017" class="difflineplus">+          }</span>
<a href="#l10.1018"></a><span id="l10.1018" class="difflineplus">+        },</span>
<a href="#l10.1019"></a><span id="l10.1019" class="difflineplus">+</span>
<a href="#l10.1020"></a><span id="l10.1020" class="difflineplus">+        removeAll() {</span>
<a href="#l10.1021"></a><span id="l10.1021" class="difflineplus">+          let root = gRootItems.get(extension);</span>
<a href="#l10.1022"></a><span id="l10.1022" class="difflineplus">+          if (root) {</span>
<a href="#l10.1023"></a><span id="l10.1023" class="difflineplus">+            root.remove();</span>
<a href="#l10.1024"></a><span id="l10.1024" class="difflineplus">+          }</span>
<a href="#l10.1025"></a><span id="l10.1025" class="difflineplus">+        },</span>
<a href="#l10.1026"></a><span id="l10.1026" class="difflineplus">+</span>
<a href="#l10.1027"></a><span id="l10.1027" class="difflineplus">+        onClicked: new EventManager({</span>
<a href="#l10.1028"></a><span id="l10.1028" class="difflineplus">+          context,</span>
<a href="#l10.1029"></a><span id="l10.1029" class="difflineplus">+          name: &quot;menus.onClicked&quot;,</span>
<a href="#l10.1030"></a><span id="l10.1030" class="difflineplus">+          register: fire =&gt; {</span>
<a href="#l10.1031"></a><span id="l10.1031" class="difflineplus">+            let listener = (event, info, nativeTab) =&gt; {</span>
<a href="#l10.1032"></a><span id="l10.1032" class="difflineplus">+              let {linkedBrowser} = nativeTab || tabTracker.activeTab;</span>
<a href="#l10.1033"></a><span id="l10.1033" class="difflineplus">+              let tab = nativeTab &amp;&amp; extension.tabManager.convert(nativeTab);</span>
<a href="#l10.1034"></a><span id="l10.1034" class="difflineplus">+              context.withPendingBrowser(linkedBrowser,</span>
<a href="#l10.1035"></a><span id="l10.1035" class="difflineplus">+                                         () =&gt; fire.sync(info, tab));</span>
<a href="#l10.1036"></a><span id="l10.1036" class="difflineplus">+            };</span>
<a href="#l10.1037"></a><span id="l10.1037" class="difflineplus">+</span>
<a href="#l10.1038"></a><span id="l10.1038" class="difflineplus">+            extension.on(&quot;webext-menu-menuitem-click&quot;, listener);</span>
<a href="#l10.1039"></a><span id="l10.1039" class="difflineplus">+            return () =&gt; {</span>
<a href="#l10.1040"></a><span id="l10.1040" class="difflineplus">+              extension.off(&quot;webext-menu-menuitem-click&quot;, listener);</span>
<a href="#l10.1041"></a><span id="l10.1041" class="difflineplus">+            };</span>
<a href="#l10.1042"></a><span id="l10.1042" class="difflineplus">+          },</span>
<a href="#l10.1043"></a><span id="l10.1043" class="difflineplus">+        }).api(),</span>
<a href="#l10.1044"></a><span id="l10.1044" class="difflineplus">+      },</span>
<a href="#l10.1045"></a><span id="l10.1045" class="difflineplus">+    };</span>
<a href="#l10.1046"></a><span id="l10.1046" class="difflineplus">+  }</span>
<a href="#l10.1047"></a><span id="l10.1047" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">new file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- /dev/null</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ b/mail/components/extensions/schemas/menus.json</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -0,0 +1,577 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineplus">+// Copyright (c) 2012 The Chromium Authors. All rights reserved.</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineplus">+// Use of this source code is governed by a BSD-style license that can be</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineplus">+// found in the LICENSE file.</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineplus">+</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineplus">+[</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineplus">+  {</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineplus">+    &quot;namespace&quot;: &quot;manifest&quot;,</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+    &quot;types&quot;: [</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+      {</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+        &quot;$extend&quot;: &quot;Permission&quot;,</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+        &quot;choices&quot;: [{</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+          &quot;type&quot;: &quot;string&quot;,</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+          &quot;enum&quot;: [</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+            &quot;menus&quot;</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+          ]</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+        }]</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+      }, {</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+        &quot;$extend&quot;: &quot;OptionalPermission&quot;,</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+        &quot;choices&quot;: [{</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+          &quot;type&quot;: &quot;string&quot;,</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+          &quot;enum&quot;: [</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+            &quot;menus.overrideContext&quot;</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineplus">+          ]</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineplus">+        }]</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineplus">+      }</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+    ]</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+  },</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+  {</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+    &quot;namespace&quot;: &quot;menus&quot;,</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+    &quot;permissions&quot;: [&quot;menus&quot;],</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+    &quot;description&quot;: &quot;Use the browser.menus API to add items to the browser's menus. You can choose what types of objects your context menu additions apply to, such as images, hyperlinks, and pages.&quot;,</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+    &quot;properties&quot;: {</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+      &quot;ACTION_MENU_TOP_LEVEL_LIMIT&quot;: {</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineplus">+        &quot;value&quot;: 6,</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+        &quot;description&quot;: &quot;The maximum number of top level extension items that can be added to an extension action context menu. Any items beyond this limit will be ignored.&quot;</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+      }</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+    },</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+    &quot;types&quot;: [</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+      {</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+        &quot;id&quot;: &quot;ContextType&quot;,</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineplus">+        &quot;type&quot;: &quot;string&quot;,</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+        &quot;enum&quot;: [&quot;all&quot;, &quot;page&quot;, &quot;frame&quot;, &quot;selection&quot;, &quot;link&quot;, &quot;editable&quot;, &quot;password&quot;, &quot;image&quot;, &quot;video&quot;, &quot;audio&quot;, &quot;browser_action&quot;, &quot;tab&quot;, &quot;message_list&quot;, &quot;folder_pane&quot;],</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineplus">+        &quot;description&quot;: &quot;The different contexts a menu can appear in. Specifying 'all' is equivalent to the combination of all other contexts except for 'tab'.&quot;</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+      },</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineplus">+      {</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineplus">+        &quot;id&quot;: &quot;ItemType&quot;,</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+        &quot;type&quot;: &quot;string&quot;,</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineplus">+        &quot;enum&quot;: [&quot;normal&quot;, &quot;checkbox&quot;, &quot;radio&quot;, &quot;separator&quot;],</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+        &quot;description&quot;: &quot;The type of menu item.&quot;</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineplus">+      },</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+      {</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineplus">+        &quot;id&quot;: &quot;OnClickData&quot;,</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+        &quot;type&quot;: &quot;object&quot;,</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineplus">+        &quot;description&quot;: &quot;Information sent when a context menu item is clicked.&quot;,</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineplus">+        &quot;properties&quot;: {</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineplus">+          &quot;menuItemId&quot;: {</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineplus">+            &quot;choices&quot;: [</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineplus">+              { &quot;type&quot;: &quot;integer&quot; },</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineplus">+              { &quot;type&quot;: &quot;string&quot; }</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineplus">+            ],</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineplus">+            &quot;description&quot;: &quot;The ID of the menu item that was clicked.&quot;</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+          },</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineplus">+          &quot;parentMenuItemId&quot;: {</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineplus">+            &quot;choices&quot;: [</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineplus">+              { &quot;type&quot;: &quot;integer&quot; },</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineplus">+              { &quot;type&quot;: &quot;string&quot; }</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+            ],</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+            &quot;optional&quot;: true,</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineplus">+            &quot;description&quot;: &quot;The parent ID, if any, for the item clicked.&quot;</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineplus">+          },</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineplus">+          &quot;viewType&quot;: {</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineplus">+            &quot;$ref&quot;: &quot;extension.ViewType&quot;,</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineplus">+            &quot;optional&quot;: true,</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineplus">+            &quot;description&quot;: &quot;The type of view where the menu is clicked. May be unset if the menu is not associated with a view.&quot;</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineplus">+          },</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineplus">+          &quot;mediaType&quot;: {</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineplus">+            &quot;type&quot;: &quot;string&quot;,</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineplus">+            &quot;optional&quot;: true,</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineplus">+            &quot;description&quot;: &quot;One of 'image', 'video', or 'audio' if the context menu was activated on one of these types of elements.&quot;</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineplus">+          },</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineplus">+          &quot;linkText&quot;: {</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineplus">+            &quot;type&quot;: &quot;string&quot;,</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineplus">+            &quot;optional&quot;: true,</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineplus">+            &quot;description&quot;: &quot;If the element is a link, the text of that link.&quot;</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineplus">+          },</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineplus">+          &quot;linkUrl&quot;: {</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineplus">+            &quot;type&quot;: &quot;string&quot;,</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineplus">+            &quot;optional&quot;: true,</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineplus">+            &quot;description&quot;: &quot;If the element is a link, the URL it points to.&quot;</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineplus">+          },</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineplus">+          &quot;srcUrl&quot;: {</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineplus">+            &quot;type&quot;: &quot;string&quot;,</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineplus">+            &quot;optional&quot;: true,</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineplus">+            &quot;description&quot;: &quot;Will be present for elements with a 'src' URL.&quot;</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineplus">+          },</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineplus">+          &quot;pageUrl&quot;: {</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineplus">+            &quot;type&quot;: &quot;string&quot;,</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineplus">+            &quot;optional&quot;: true,</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineplus">+            &quot;description&quot;: &quot;The URL of the page where the menu item was clicked. This property is not set if the click occured in a context where there is no current page, such as in a launcher context menu.&quot;</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineplus">+          },</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineplus">+          &quot;frameId&quot;: {</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineplus">+           &quot;type&quot;: &quot;integer&quot;,</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineplus">+           &quot;optional&quot;: true,</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineplus">+           &quot;minimum&quot;: 0,</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineplus">+           &quot;description&quot;: &quot;The id of the frame of the element where the context menu was clicked.&quot;</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineplus">+          },</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineplus">+          &quot;frameUrl&quot;: {</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineplus">+            &quot;type&quot;: &quot;string&quot;,</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineplus">+            &quot;optional&quot;: true,</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineplus">+            &quot;description&quot;: &quot; The URL of the frame of the element where the context menu was clicked, if it was in a frame.&quot;</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineplus">+          },</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineplus">+          &quot;selectionText&quot;: {</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineplus">+            &quot;type&quot;: &quot;string&quot;,</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineplus">+            &quot;optional&quot;: true,</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineplus">+            &quot;description&quot;: &quot;The text for the context selection, if any.&quot;</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineplus">+          },</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineplus">+          &quot;editable&quot;: {</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineplus">+            &quot;type&quot;: &quot;boolean&quot;,</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineplus">+            &quot;description&quot;: &quot;A flag indicating whether the element is editable (text input, textarea, etc.).&quot;</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineplus">+          },</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineplus">+          &quot;wasChecked&quot;: {</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineplus">+            &quot;type&quot;: &quot;boolean&quot;,</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineplus">+            &quot;optional&quot;: true,</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineplus">+            &quot;description&quot;: &quot;A flag indicating the state of a checkbox or radio item before it was clicked.&quot;</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineplus">+          },</span>
<a href="#l11.130"></a><span id="l11.130" class="difflineplus">+          &quot;checked&quot;: {</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineplus">+            &quot;type&quot;: &quot;boolean&quot;,</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineplus">+            &quot;optional&quot;: true,</span>
<a href="#l11.133"></a><span id="l11.133" class="difflineplus">+            &quot;description&quot;: &quot;A flag indicating the state of a checkbox or radio item after it is clicked.&quot;</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineplus">+          },</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineplus">+          &quot;modifiers&quot;: {</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineplus">+            &quot;type&quot;: &quot;array&quot;,</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineplus">+            &quot;items&quot;: {</span>
<a href="#l11.138"></a><span id="l11.138" class="difflineplus">+              &quot;type&quot;: &quot;string&quot;,</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineplus">+              &quot;enum&quot;: [&quot;Shift&quot;, &quot;Alt&quot;, &quot;Command&quot;, &quot;Ctrl&quot;, &quot;MacCtrl&quot;]</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineplus">+            },</span>
<a href="#l11.141"></a><span id="l11.141" class="difflineplus">+            &quot;description&quot;: &quot;An array of keyboard modifiers that were held while the menu item was clicked.&quot;</span>
<a href="#l11.142"></a><span id="l11.142" class="difflineplus">+          },</span>
<a href="#l11.143"></a><span id="l11.143" class="difflineplus">+          &quot;button&quot;: {</span>
<a href="#l11.144"></a><span id="l11.144" class="difflineplus">+            &quot;type&quot;: &quot;integer&quot;,</span>
<a href="#l11.145"></a><span id="l11.145" class="difflineplus">+            &quot;optional&quot;: true,</span>
<a href="#l11.146"></a><span id="l11.146" class="difflineplus">+            &quot;description&quot;: &quot;An integer value of button by which menu item was clicked.&quot;</span>
<a href="#l11.147"></a><span id="l11.147" class="difflineplus">+          },</span>
<a href="#l11.148"></a><span id="l11.148" class="difflineplus">+          &quot;targetElementId&quot;: {</span>
<a href="#l11.149"></a><span id="l11.149" class="difflineplus">+            &quot;type&quot;: &quot;integer&quot;,</span>
<a href="#l11.150"></a><span id="l11.150" class="difflineplus">+            &quot;optional&quot;: true,</span>
<a href="#l11.151"></a><span id="l11.151" class="difflineplus">+            &quot;description&quot;: &quot;An identifier of the clicked element, if any. Use menus.getTargetElement in the page to find the corresponding element.&quot;</span>
<a href="#l11.152"></a><span id="l11.152" class="difflineplus">+          },</span>
<a href="#l11.153"></a><span id="l11.153" class="difflineplus">+          &quot;selectedMessages&quot;: {</span>
<a href="#l11.154"></a><span id="l11.154" class="difflineplus">+            &quot;$ref&quot;: &quot;messages.MessageList&quot;,</span>
<a href="#l11.155"></a><span id="l11.155" class="difflineplus">+            &quot;optional&quot;: true,</span>
<a href="#l11.156"></a><span id="l11.156" class="difflineplus">+            &quot;description&quot;: &quot;The selected messages, if the context menu was opened in the message list.&quot;</span>
<a href="#l11.157"></a><span id="l11.157" class="difflineplus">+          },</span>
<a href="#l11.158"></a><span id="l11.158" class="difflineplus">+          &quot;displayedFolder&quot;: {</span>
<a href="#l11.159"></a><span id="l11.159" class="difflineplus">+            &quot;$ref&quot;: &quot;accounts.MailFolder&quot;,</span>
<a href="#l11.160"></a><span id="l11.160" class="difflineplus">+            &quot;optional&quot;: true,</span>
<a href="#l11.161"></a><span id="l11.161" class="difflineplus">+            &quot;description&quot;: &quot;The displayed folder, if the context menu was opened in the message list.&quot;</span>
<a href="#l11.162"></a><span id="l11.162" class="difflineplus">+          },</span>
<a href="#l11.163"></a><span id="l11.163" class="difflineplus">+          &quot;selectedFolder&quot;: {</span>
<a href="#l11.164"></a><span id="l11.164" class="difflineplus">+            &quot;$ref&quot;: &quot;accounts.MailFolder&quot;,</span>
<a href="#l11.165"></a><span id="l11.165" class="difflineplus">+            &quot;optional&quot;: true,</span>
<a href="#l11.166"></a><span id="l11.166" class="difflineplus">+            &quot;description&quot;: &quot;The selected folder, if the context menu was opened in the folder pane.&quot;</span>
<a href="#l11.167"></a><span id="l11.167" class="difflineplus">+          }</span>
<a href="#l11.168"></a><span id="l11.168" class="difflineplus">+        }</span>
<a href="#l11.169"></a><span id="l11.169" class="difflineplus">+      }</span>
<a href="#l11.170"></a><span id="l11.170" class="difflineplus">+    ],</span>
<a href="#l11.171"></a><span id="l11.171" class="difflineplus">+    &quot;functions&quot;: [</span>
<a href="#l11.172"></a><span id="l11.172" class="difflineplus">+      {</span>
<a href="#l11.173"></a><span id="l11.173" class="difflineplus">+        &quot;name&quot;: &quot;create&quot;,</span>
<a href="#l11.174"></a><span id="l11.174" class="difflineplus">+        &quot;type&quot;: &quot;function&quot;,</span>
<a href="#l11.175"></a><span id="l11.175" class="difflineplus">+        &quot;description&quot;: &quot;Creates a new context menu item. Note that if an error occurs during creation, you may not find out until the creation callback fires (the details will be in $(ref:runtime.lastError)).&quot;,</span>
<a href="#l11.176"></a><span id="l11.176" class="difflineplus">+        &quot;returns&quot;: {</span>
<a href="#l11.177"></a><span id="l11.177" class="difflineplus">+          &quot;choices&quot;: [</span>
<a href="#l11.178"></a><span id="l11.178" class="difflineplus">+            { &quot;type&quot;: &quot;integer&quot; },</span>
<a href="#l11.179"></a><span id="l11.179" class="difflineplus">+            { &quot;type&quot;: &quot;string&quot; }</span>
<a href="#l11.180"></a><span id="l11.180" class="difflineplus">+          ],</span>
<a href="#l11.181"></a><span id="l11.181" class="difflineplus">+          &quot;description&quot;: &quot;The ID of the newly created item.&quot;</span>
<a href="#l11.182"></a><span id="l11.182" class="difflineplus">+        },</span>
<a href="#l11.183"></a><span id="l11.183" class="difflineplus">+        &quot;parameters&quot;: [</span>
<a href="#l11.184"></a><span id="l11.184" class="difflineplus">+          {</span>
<a href="#l11.185"></a><span id="l11.185" class="difflineplus">+            &quot;type&quot;: &quot;object&quot;,</span>
<a href="#l11.186"></a><span id="l11.186" class="difflineplus">+            &quot;name&quot;: &quot;createProperties&quot;,</span>
<a href="#l11.187"></a><span id="l11.187" class="difflineplus">+            &quot;properties&quot;: {</span>
<a href="#l11.188"></a><span id="l11.188" class="difflineplus">+              &quot;type&quot;: {</span>
<a href="#l11.189"></a><span id="l11.189" class="difflineplus">+                &quot;$ref&quot;: &quot;ItemType&quot;,</span>
<a href="#l11.190"></a><span id="l11.190" class="difflineplus">+                &quot;optional&quot;: true,</span>
<a href="#l11.191"></a><span id="l11.191" class="difflineplus">+                &quot;description&quot;: &quot;The type of menu item. Defaults to 'normal' if not specified.&quot;</span>
<a href="#l11.192"></a><span id="l11.192" class="difflineplus">+              },</span>
<a href="#l11.193"></a><span id="l11.193" class="difflineplus">+              &quot;id&quot;: {</span>
<a href="#l11.194"></a><span id="l11.194" class="difflineplus">+                &quot;type&quot;: &quot;string&quot;,</span>
<a href="#l11.195"></a><span id="l11.195" class="difflineplus">+                &quot;optional&quot;: true,</span>
<a href="#l11.196"></a><span id="l11.196" class="difflineplus">+                &quot;description&quot;: &quot;The unique ID to assign to this item. Mandatory for event pages. Cannot be the same as another ID for this extension.&quot;</span>
<a href="#l11.197"></a><span id="l11.197" class="difflineplus">+              },</span>
<a href="#l11.198"></a><span id="l11.198" class="difflineplus">+              &quot;icons&quot;: {</span>
<a href="#l11.199"></a><span id="l11.199" class="difflineplus">+                &quot;type&quot;: &quot;object&quot;,</span>
<a href="#l11.200"></a><span id="l11.200" class="difflineplus">+                &quot;optional&quot; : true,</span>
<a href="#l11.201"></a><span id="l11.201" class="difflineplus">+                &quot;patternProperties&quot; : {</span>
<a href="#l11.202"></a><span id="l11.202" class="difflineplus">+                  &quot;^[1-9]\\d*$&quot;: { &quot;type&quot; : &quot;string&quot; }</span>
<a href="#l11.203"></a><span id="l11.203" class="difflineplus">+                }</span>
<a href="#l11.204"></a><span id="l11.204" class="difflineplus">+              },</span>
<a href="#l11.205"></a><span id="l11.205" class="difflineplus">+              &quot;title&quot;: {</span>
<a href="#l11.206"></a><span id="l11.206" class="difflineplus">+                &quot;type&quot;: &quot;string&quot;,</span>
<a href="#l11.207"></a><span id="l11.207" class="difflineplus">+                &quot;optional&quot;: true,</span>
<a href="#l11.208"></a><span id="l11.208" class="difflineplus">+                &quot;description&quot;: &quot;The text to be displayed in the item; this is &lt;em&gt;required&lt;/em&gt; unless &lt;code&gt;type&lt;/code&gt; is 'separator'. When the context is 'selection', you can use &lt;code&gt;%s&lt;/code&gt; within the string to show the selected text. For example, if this parameter's value is \&quot;Translate '%s' to Pig Latin\&quot; and the user selects the word \&quot;cool\&quot;, the context menu item for the selection is \&quot;Translate 'cool' to Pig Latin\&quot;.&quot;</span>
<a href="#l11.209"></a><span id="l11.209" class="difflineplus">+              },</span>
<a href="#l11.210"></a><span id="l11.210" class="difflineplus">+              &quot;checked&quot;: {</span>
<a href="#l11.211"></a><span id="l11.211" class="difflineplus">+                &quot;type&quot;: &quot;boolean&quot;,</span>
<a href="#l11.212"></a><span id="l11.212" class="difflineplus">+                &quot;optional&quot;: true,</span>
<a href="#l11.213"></a><span id="l11.213" class="difflineplus">+                &quot;description&quot;: &quot;The initial state of a checkbox or radio item: true for selected and false for unselected. Only one radio item can be selected at a time in a given group of radio items.&quot;</span>
<a href="#l11.214"></a><span id="l11.214" class="difflineplus">+              },</span>
<a href="#l11.215"></a><span id="l11.215" class="difflineplus">+              &quot;contexts&quot;: {</span>
<a href="#l11.216"></a><span id="l11.216" class="difflineplus">+                &quot;type&quot;: &quot;array&quot;,</span>
<a href="#l11.217"></a><span id="l11.217" class="difflineplus">+                &quot;items&quot;: {</span>
<a href="#l11.218"></a><span id="l11.218" class="difflineplus">+                  &quot;$ref&quot;: &quot;ContextType&quot;</span>
<a href="#l11.219"></a><span id="l11.219" class="difflineplus">+                },</span>
<a href="#l11.220"></a><span id="l11.220" class="difflineplus">+                &quot;minItems&quot;: 1,</span>
<a href="#l11.221"></a><span id="l11.221" class="difflineplus">+                &quot;optional&quot;: true,</span>
<a href="#l11.222"></a><span id="l11.222" class="difflineplus">+                &quot;description&quot;: &quot;List of contexts this menu item will appear in. Defaults to ['page'] if not specified.&quot;</span>
<a href="#l11.223"></a><span id="l11.223" class="difflineplus">+              },</span>
<a href="#l11.224"></a><span id="l11.224" class="difflineplus">+              &quot;viewTypes&quot;: {</span>
<a href="#l11.225"></a><span id="l11.225" class="difflineplus">+                &quot;type&quot;: &quot;array&quot;,</span>
<a href="#l11.226"></a><span id="l11.226" class="difflineplus">+                &quot;items&quot;: {</span>
<a href="#l11.227"></a><span id="l11.227" class="difflineplus">+                  &quot;$ref&quot;: &quot;extension.ViewType&quot;</span>
<a href="#l11.228"></a><span id="l11.228" class="difflineplus">+                },</span>
<a href="#l11.229"></a><span id="l11.229" class="difflineplus">+                &quot;minItems&quot;: 1,</span>
<a href="#l11.230"></a><span id="l11.230" class="difflineplus">+                &quot;optional&quot;: true,</span>
<a href="#l11.231"></a><span id="l11.231" class="difflineplus">+                &quot;description&quot;: &quot;List of view types where the menu item will be shown. Defaults to any view, including those without a viewType.&quot;</span>
<a href="#l11.232"></a><span id="l11.232" class="difflineplus">+              },</span>
<a href="#l11.233"></a><span id="l11.233" class="difflineplus">+              &quot;visible&quot;: {</span>
<a href="#l11.234"></a><span id="l11.234" class="difflineplus">+                &quot;type&quot;: &quot;boolean&quot;,</span>
<a href="#l11.235"></a><span id="l11.235" class="difflineplus">+                &quot;optional&quot;: true,</span>
<a href="#l11.236"></a><span id="l11.236" class="difflineplus">+                &quot;description&quot;: &quot;Whether the item is visible in the menu.&quot;</span>
<a href="#l11.237"></a><span id="l11.237" class="difflineplus">+              },</span>
<a href="#l11.238"></a><span id="l11.238" class="difflineplus">+              &quot;onclick&quot;: {</span>
<a href="#l11.239"></a><span id="l11.239" class="difflineplus">+                &quot;type&quot;: &quot;function&quot;,</span>
<a href="#l11.240"></a><span id="l11.240" class="difflineplus">+                &quot;optional&quot;: true,</span>
<a href="#l11.241"></a><span id="l11.241" class="difflineplus">+                &quot;description&quot;: &quot;A function that will be called back when the menu item is clicked. Event pages cannot use this.&quot;,</span>
<a href="#l11.242"></a><span id="l11.242" class="difflineplus">+                &quot;parameters&quot;: [</span>
<a href="#l11.243"></a><span id="l11.243" class="difflineplus">+                  {</span>
<a href="#l11.244"></a><span id="l11.244" class="difflineplus">+                    &quot;name&quot;: &quot;info&quot;,</span>
<a href="#l11.245"></a><span id="l11.245" class="difflineplus">+                    &quot;$ref&quot;: &quot;OnClickData&quot;,</span>
<a href="#l11.246"></a><span id="l11.246" class="difflineplus">+                    &quot;description&quot;: &quot;Information about the item clicked and the context where the click happened.&quot;</span>
<a href="#l11.247"></a><span id="l11.247" class="difflineplus">+                  },</span>
<a href="#l11.248"></a><span id="l11.248" class="difflineplus">+                  {</span>
<a href="#l11.249"></a><span id="l11.249" class="difflineplus">+                    &quot;name&quot;: &quot;tab&quot;,</span>
<a href="#l11.250"></a><span id="l11.250" class="difflineplus">+                    &quot;$ref&quot;: &quot;tabs.Tab&quot;,</span>
<a href="#l11.251"></a><span id="l11.251" class="difflineplus">+                    &quot;description&quot;: &quot;The details of the tab where the click took place. Note: this parameter only present for extensions.&quot;</span>
<a href="#l11.252"></a><span id="l11.252" class="difflineplus">+                  }</span>
<a href="#l11.253"></a><span id="l11.253" class="difflineplus">+                ]</span>
<a href="#l11.254"></a><span id="l11.254" class="difflineplus">+              },</span>
<a href="#l11.255"></a><span id="l11.255" class="difflineplus">+              &quot;parentId&quot;: {</span>
<a href="#l11.256"></a><span id="l11.256" class="difflineplus">+                &quot;choices&quot;: [</span>
<a href="#l11.257"></a><span id="l11.257" class="difflineplus">+                  { &quot;type&quot;: &quot;integer&quot; },</span>
<a href="#l11.258"></a><span id="l11.258" class="difflineplus">+                  { &quot;type&quot;: &quot;string&quot; }</span>
<a href="#l11.259"></a><span id="l11.259" class="difflineplus">+                ],</span>
<a href="#l11.260"></a><span id="l11.260" class="difflineplus">+                &quot;optional&quot;: true,</span>
<a href="#l11.261"></a><span id="l11.261" class="difflineplus">+                &quot;description&quot;: &quot;The ID of a parent menu item; this makes the item a child of a previously added item.&quot;</span>
<a href="#l11.262"></a><span id="l11.262" class="difflineplus">+              },</span>
<a href="#l11.263"></a><span id="l11.263" class="difflineplus">+              &quot;documentUrlPatterns&quot;: {</span>
<a href="#l11.264"></a><span id="l11.264" class="difflineplus">+                &quot;type&quot;: &quot;array&quot;,</span>
<a href="#l11.265"></a><span id="l11.265" class="difflineplus">+                &quot;items&quot;: {&quot;type&quot;: &quot;string&quot;},</span>
<a href="#l11.266"></a><span id="l11.266" class="difflineplus">+                &quot;optional&quot;: true,</span>
<a href="#l11.267"></a><span id="l11.267" class="difflineplus">+                &quot;description&quot;: &quot;Lets you restrict the item to apply only to documents whose URL matches one of the given patterns. (This applies to frames as well.) For details on the format of a pattern, see $(topic:match_patterns)[Match Patterns].&quot;</span>
<a href="#l11.268"></a><span id="l11.268" class="difflineplus">+              },</span>
<a href="#l11.269"></a><span id="l11.269" class="difflineplus">+              &quot;targetUrlPatterns&quot;: {</span>
<a href="#l11.270"></a><span id="l11.270" class="difflineplus">+                &quot;type&quot;: &quot;array&quot;,</span>
<a href="#l11.271"></a><span id="l11.271" class="difflineplus">+                &quot;items&quot;: {&quot;type&quot;: &quot;string&quot;},</span>
<a href="#l11.272"></a><span id="l11.272" class="difflineplus">+                &quot;optional&quot;: true,</span>
<a href="#l11.273"></a><span id="l11.273" class="difflineplus">+                &quot;description&quot;: &quot;Similar to documentUrlPatterns, but lets you filter based on the src attribute of img/audio/video tags and the href of anchor tags.&quot;</span>
<a href="#l11.274"></a><span id="l11.274" class="difflineplus">+              },</span>
<a href="#l11.275"></a><span id="l11.275" class="difflineplus">+              &quot;enabled&quot;: {</span>
<a href="#l11.276"></a><span id="l11.276" class="difflineplus">+                &quot;type&quot;: &quot;boolean&quot;,</span>
<a href="#l11.277"></a><span id="l11.277" class="difflineplus">+                &quot;optional&quot;: true,</span>
<a href="#l11.278"></a><span id="l11.278" class="difflineplus">+                &quot;description&quot;: &quot;Whether this context menu item is enabled or disabled. Defaults to true.&quot;</span>
<a href="#l11.279"></a><span id="l11.279" class="difflineplus">+              },</span>
<a href="#l11.280"></a><span id="l11.280" class="difflineplus">+              &quot;command&quot;: {</span>
<a href="#l11.281"></a><span id="l11.281" class="difflineplus">+                &quot;type&quot;: &quot;string&quot;,</span>
<a href="#l11.282"></a><span id="l11.282" class="difflineplus">+                &quot;optional&quot;: true,</span>
<a href="#l11.283"></a><span id="l11.283" class="difflineplus">+                &quot;description&quot;: &quot;Specifies a command to issue for the context click.  Currently supports internal command _execute_browser_action.&quot;</span>
<a href="#l11.284"></a><span id="l11.284" class="difflineplus">+              }</span>
<a href="#l11.285"></a><span id="l11.285" class="difflineplus">+            }</span>
<a href="#l11.286"></a><span id="l11.286" class="difflineplus">+          },</span>
<a href="#l11.287"></a><span id="l11.287" class="difflineplus">+          {</span>
<a href="#l11.288"></a><span id="l11.288" class="difflineplus">+            &quot;type&quot;: &quot;function&quot;,</span>
<a href="#l11.289"></a><span id="l11.289" class="difflineplus">+            &quot;name&quot;: &quot;callback&quot;,</span>
<a href="#l11.290"></a><span id="l11.290" class="difflineplus">+            &quot;optional&quot;: true,</span>
<a href="#l11.291"></a><span id="l11.291" class="difflineplus">+            &quot;description&quot;: &quot;Called when the item has been created in the browser. If there were any problems creating the item, details will be available in $(ref:runtime.lastError).&quot;,</span>
<a href="#l11.292"></a><span id="l11.292" class="difflineplus">+            &quot;parameters&quot;: []</span>
<a href="#l11.293"></a><span id="l11.293" class="difflineplus">+          }</span>
<a href="#l11.294"></a><span id="l11.294" class="difflineplus">+        ]</span>
<a href="#l11.295"></a><span id="l11.295" class="difflineplus">+      },</span>
<a href="#l11.296"></a><span id="l11.296" class="difflineplus">+      {</span>
<a href="#l11.297"></a><span id="l11.297" class="difflineplus">+        &quot;name&quot;: &quot;update&quot;,</span>
<a href="#l11.298"></a><span id="l11.298" class="difflineplus">+        &quot;type&quot;: &quot;function&quot;,</span>
<a href="#l11.299"></a><span id="l11.299" class="difflineplus">+        &quot;description&quot;: &quot;Updates a previously created context menu item.&quot;,</span>
<a href="#l11.300"></a><span id="l11.300" class="difflineplus">+        &quot;async&quot;: &quot;callback&quot;,</span>
<a href="#l11.301"></a><span id="l11.301" class="difflineplus">+        &quot;parameters&quot;: [</span>
<a href="#l11.302"></a><span id="l11.302" class="difflineplus">+          {</span>
<a href="#l11.303"></a><span id="l11.303" class="difflineplus">+            &quot;choices&quot;: [</span>
<a href="#l11.304"></a><span id="l11.304" class="difflineplus">+              { &quot;type&quot;: &quot;integer&quot; },</span>
<a href="#l11.305"></a><span id="l11.305" class="difflineplus">+              { &quot;type&quot;: &quot;string&quot; }</span>
<a href="#l11.306"></a><span id="l11.306" class="difflineplus">+            ],</span>
<a href="#l11.307"></a><span id="l11.307" class="difflineplus">+            &quot;name&quot;: &quot;id&quot;,</span>
<a href="#l11.308"></a><span id="l11.308" class="difflineplus">+            &quot;description&quot;: &quot;The ID of the item to update.&quot;</span>
<a href="#l11.309"></a><span id="l11.309" class="difflineplus">+          },</span>
<a href="#l11.310"></a><span id="l11.310" class="difflineplus">+          {</span>
<a href="#l11.311"></a><span id="l11.311" class="difflineplus">+            &quot;type&quot;: &quot;object&quot;,</span>
<a href="#l11.312"></a><span id="l11.312" class="difflineplus">+            &quot;name&quot;: &quot;updateProperties&quot;,</span>
<a href="#l11.313"></a><span id="l11.313" class="difflineplus">+            &quot;description&quot;: &quot;The properties to update. Accepts the same values as the create function.&quot;,</span>
<a href="#l11.314"></a><span id="l11.314" class="difflineplus">+            &quot;properties&quot;: {</span>
<a href="#l11.315"></a><span id="l11.315" class="difflineplus">+              &quot;type&quot;: {</span>
<a href="#l11.316"></a><span id="l11.316" class="difflineplus">+                &quot;$ref&quot;: &quot;ItemType&quot;,</span>
<a href="#l11.317"></a><span id="l11.317" class="difflineplus">+                &quot;optional&quot;: true</span>
<a href="#l11.318"></a><span id="l11.318" class="difflineplus">+              },</span>
<a href="#l11.319"></a><span id="l11.319" class="difflineplus">+              &quot;icons&quot;: {</span>
<a href="#l11.320"></a><span id="l11.320" class="difflineplus">+                &quot;type&quot;: &quot;object&quot;,</span>
<a href="#l11.321"></a><span id="l11.321" class="difflineplus">+                &quot;optional&quot;: &quot;omit-key-if-missing&quot;,</span>
<a href="#l11.322"></a><span id="l11.322" class="difflineplus">+                &quot;patternProperties&quot; : {</span>
<a href="#l11.323"></a><span id="l11.323" class="difflineplus">+                  &quot;^[1-9]\\d*$&quot;: { &quot;type&quot; : &quot;string&quot; }</span>
<a href="#l11.324"></a><span id="l11.324" class="difflineplus">+                }</span>
<a href="#l11.325"></a><span id="l11.325" class="difflineplus">+              },</span>
<a href="#l11.326"></a><span id="l11.326" class="difflineplus">+              &quot;title&quot;: {</span>
<a href="#l11.327"></a><span id="l11.327" class="difflineplus">+                &quot;type&quot;: &quot;string&quot;,</span>
<a href="#l11.328"></a><span id="l11.328" class="difflineplus">+                &quot;optional&quot;: true</span>
<a href="#l11.329"></a><span id="l11.329" class="difflineplus">+              },</span>
<a href="#l11.330"></a><span id="l11.330" class="difflineplus">+              &quot;checked&quot;: {</span>
<a href="#l11.331"></a><span id="l11.331" class="difflineplus">+                &quot;type&quot;: &quot;boolean&quot;,</span>
<a href="#l11.332"></a><span id="l11.332" class="difflineplus">+                &quot;optional&quot;: true</span>
<a href="#l11.333"></a><span id="l11.333" class="difflineplus">+              },</span>
<a href="#l11.334"></a><span id="l11.334" class="difflineplus">+              &quot;contexts&quot;: {</span>
<a href="#l11.335"></a><span id="l11.335" class="difflineplus">+                &quot;type&quot;: &quot;array&quot;,</span>
<a href="#l11.336"></a><span id="l11.336" class="difflineplus">+                &quot;items&quot;: {</span>
<a href="#l11.337"></a><span id="l11.337" class="difflineplus">+                  &quot;$ref&quot;: &quot;ContextType&quot;</span>
<a href="#l11.338"></a><span id="l11.338" class="difflineplus">+                },</span>
<a href="#l11.339"></a><span id="l11.339" class="difflineplus">+                &quot;minItems&quot;: 1,</span>
<a href="#l11.340"></a><span id="l11.340" class="difflineplus">+                &quot;optional&quot;: true</span>
<a href="#l11.341"></a><span id="l11.341" class="difflineplus">+              },</span>
<a href="#l11.342"></a><span id="l11.342" class="difflineplus">+              &quot;viewTypes&quot;: {</span>
<a href="#l11.343"></a><span id="l11.343" class="difflineplus">+                &quot;type&quot;: &quot;array&quot;,</span>
<a href="#l11.344"></a><span id="l11.344" class="difflineplus">+                &quot;items&quot;: {</span>
<a href="#l11.345"></a><span id="l11.345" class="difflineplus">+                  &quot;$ref&quot;: &quot;extension.ViewType&quot;</span>
<a href="#l11.346"></a><span id="l11.346" class="difflineplus">+                },</span>
<a href="#l11.347"></a><span id="l11.347" class="difflineplus">+                &quot;minItems&quot;: 1,</span>
<a href="#l11.348"></a><span id="l11.348" class="difflineplus">+                &quot;optional&quot;: true</span>
<a href="#l11.349"></a><span id="l11.349" class="difflineplus">+              },</span>
<a href="#l11.350"></a><span id="l11.350" class="difflineplus">+              &quot;visible&quot;: {</span>
<a href="#l11.351"></a><span id="l11.351" class="difflineplus">+                &quot;type&quot;: &quot;boolean&quot;,</span>
<a href="#l11.352"></a><span id="l11.352" class="difflineplus">+                &quot;optional&quot;: true,</span>
<a href="#l11.353"></a><span id="l11.353" class="difflineplus">+                &quot;description&quot;: &quot;Whether the item is visible in the menu.&quot;</span>
<a href="#l11.354"></a><span id="l11.354" class="difflineplus">+              },</span>
<a href="#l11.355"></a><span id="l11.355" class="difflineplus">+              &quot;onclick&quot;: {</span>
<a href="#l11.356"></a><span id="l11.356" class="difflineplus">+                &quot;type&quot;: &quot;function&quot;,</span>
<a href="#l11.357"></a><span id="l11.357" class="difflineplus">+                &quot;optional&quot;: &quot;omit-key-if-missing&quot;,</span>
<a href="#l11.358"></a><span id="l11.358" class="difflineplus">+                &quot;parameters&quot;: [</span>
<a href="#l11.359"></a><span id="l11.359" class="difflineplus">+                  {</span>
<a href="#l11.360"></a><span id="l11.360" class="difflineplus">+                    &quot;name&quot;: &quot;info&quot;,</span>
<a href="#l11.361"></a><span id="l11.361" class="difflineplus">+                    &quot;$ref&quot;: &quot;OnClickData&quot;</span>
<a href="#l11.362"></a><span id="l11.362" class="difflineplus">+                  },</span>
<a href="#l11.363"></a><span id="l11.363" class="difflineplus">+                  {</span>
<a href="#l11.364"></a><span id="l11.364" class="difflineplus">+                    &quot;name&quot;: &quot;tab&quot;,</span>
<a href="#l11.365"></a><span id="l11.365" class="difflineplus">+                    &quot;$ref&quot;: &quot;tabs.Tab&quot;,</span>
<a href="#l11.366"></a><span id="l11.366" class="difflineplus">+                    &quot;description&quot;: &quot;The details of the tab where the click took place. Note: this parameter only present for extensions.&quot;</span>
<a href="#l11.367"></a><span id="l11.367" class="difflineplus">+                  }</span>
<a href="#l11.368"></a><span id="l11.368" class="difflineplus">+                ]</span>
<a href="#l11.369"></a><span id="l11.369" class="difflineplus">+              },</span>
<a href="#l11.370"></a><span id="l11.370" class="difflineplus">+              &quot;parentId&quot;: {</span>
<a href="#l11.371"></a><span id="l11.371" class="difflineplus">+                &quot;choices&quot;: [</span>
<a href="#l11.372"></a><span id="l11.372" class="difflineplus">+                  { &quot;type&quot;: &quot;integer&quot; },</span>
<a href="#l11.373"></a><span id="l11.373" class="difflineplus">+                  { &quot;type&quot;: &quot;string&quot; }</span>
<a href="#l11.374"></a><span id="l11.374" class="difflineplus">+                ],</span>
<a href="#l11.375"></a><span id="l11.375" class="difflineplus">+                &quot;optional&quot;: true,</span>
<a href="#l11.376"></a><span id="l11.376" class="difflineplus">+                &quot;description&quot;: &quot;Note: You cannot change an item to be a child of one of its own descendants.&quot;</span>
<a href="#l11.377"></a><span id="l11.377" class="difflineplus">+              },</span>
<a href="#l11.378"></a><span id="l11.378" class="difflineplus">+              &quot;documentUrlPatterns&quot;: {</span>
<a href="#l11.379"></a><span id="l11.379" class="difflineplus">+                &quot;type&quot;: &quot;array&quot;,</span>
<a href="#l11.380"></a><span id="l11.380" class="difflineplus">+                &quot;items&quot;: {&quot;type&quot;: &quot;string&quot;},</span>
<a href="#l11.381"></a><span id="l11.381" class="difflineplus">+                &quot;optional&quot;: true</span>
<a href="#l11.382"></a><span id="l11.382" class="difflineplus">+              },</span>
<a href="#l11.383"></a><span id="l11.383" class="difflineplus">+              &quot;targetUrlPatterns&quot;: {</span>
<a href="#l11.384"></a><span id="l11.384" class="difflineplus">+                &quot;type&quot;: &quot;array&quot;,</span>
<a href="#l11.385"></a><span id="l11.385" class="difflineplus">+                &quot;items&quot;: {&quot;type&quot;: &quot;string&quot;},</span>
<a href="#l11.386"></a><span id="l11.386" class="difflineplus">+                &quot;optional&quot;: true</span>
<a href="#l11.387"></a><span id="l11.387" class="difflineplus">+              },</span>
<a href="#l11.388"></a><span id="l11.388" class="difflineplus">+              &quot;enabled&quot;: {</span>
<a href="#l11.389"></a><span id="l11.389" class="difflineplus">+                &quot;type&quot;: &quot;boolean&quot;,</span>
<a href="#l11.390"></a><span id="l11.390" class="difflineplus">+                &quot;optional&quot;: true</span>
<a href="#l11.391"></a><span id="l11.391" class="difflineplus">+              }</span>
<a href="#l11.392"></a><span id="l11.392" class="difflineplus">+            }</span>
<a href="#l11.393"></a><span id="l11.393" class="difflineplus">+          },</span>
<a href="#l11.394"></a><span id="l11.394" class="difflineplus">+          {</span>
<a href="#l11.395"></a><span id="l11.395" class="difflineplus">+            &quot;type&quot;: &quot;function&quot;,</span>
<a href="#l11.396"></a><span id="l11.396" class="difflineplus">+            &quot;name&quot;: &quot;callback&quot;,</span>
<a href="#l11.397"></a><span id="l11.397" class="difflineplus">+            &quot;optional&quot;: true,</span>
<a href="#l11.398"></a><span id="l11.398" class="difflineplus">+            &quot;parameters&quot;: [],</span>
<a href="#l11.399"></a><span id="l11.399" class="difflineplus">+            &quot;description&quot;: &quot;Called when the context menu has been updated.&quot;</span>
<a href="#l11.400"></a><span id="l11.400" class="difflineplus">+          }</span>
<a href="#l11.401"></a><span id="l11.401" class="difflineplus">+        ]</span>
<a href="#l11.402"></a><span id="l11.402" class="difflineplus">+      },</span>
<a href="#l11.403"></a><span id="l11.403" class="difflineplus">+      {</span>
<a href="#l11.404"></a><span id="l11.404" class="difflineplus">+        &quot;name&quot;: &quot;remove&quot;,</span>
<a href="#l11.405"></a><span id="l11.405" class="difflineplus">+        &quot;type&quot;: &quot;function&quot;,</span>
<a href="#l11.406"></a><span id="l11.406" class="difflineplus">+        &quot;description&quot;: &quot;Removes a context menu item.&quot;,</span>
<a href="#l11.407"></a><span id="l11.407" class="difflineplus">+        &quot;async&quot;: &quot;callback&quot;,</span>
<a href="#l11.408"></a><span id="l11.408" class="difflineplus">+        &quot;parameters&quot;: [</span>
<a href="#l11.409"></a><span id="l11.409" class="difflineplus">+          {</span>
<a href="#l11.410"></a><span id="l11.410" class="difflineplus">+            &quot;choices&quot;: [</span>
<a href="#l11.411"></a><span id="l11.411" class="difflineplus">+              { &quot;type&quot;: &quot;integer&quot; },</span>
<a href="#l11.412"></a><span id="l11.412" class="difflineplus">+              { &quot;type&quot;: &quot;string&quot; }</span>
<a href="#l11.413"></a><span id="l11.413" class="difflineplus">+            ],</span>
<a href="#l11.414"></a><span id="l11.414" class="difflineplus">+            &quot;name&quot;: &quot;menuItemId&quot;,</span>
<a href="#l11.415"></a><span id="l11.415" class="difflineplus">+            &quot;description&quot;: &quot;The ID of the context menu item to remove.&quot;</span>
<a href="#l11.416"></a><span id="l11.416" class="difflineplus">+          },</span>
<a href="#l11.417"></a><span id="l11.417" class="difflineplus">+          {</span>
<a href="#l11.418"></a><span id="l11.418" class="difflineplus">+            &quot;type&quot;: &quot;function&quot;,</span>
<a href="#l11.419"></a><span id="l11.419" class="difflineplus">+            &quot;name&quot;: &quot;callback&quot;,</span>
<a href="#l11.420"></a><span id="l11.420" class="difflineplus">+            &quot;optional&quot;: true,</span>
<a href="#l11.421"></a><span id="l11.421" class="difflineplus">+            &quot;parameters&quot;: [],</span>
<a href="#l11.422"></a><span id="l11.422" class="difflineplus">+            &quot;description&quot;: &quot;Called when the context menu has been removed.&quot;</span>
<a href="#l11.423"></a><span id="l11.423" class="difflineplus">+          }</span>
<a href="#l11.424"></a><span id="l11.424" class="difflineplus">+        ]</span>
<a href="#l11.425"></a><span id="l11.425" class="difflineplus">+      },</span>
<a href="#l11.426"></a><span id="l11.426" class="difflineplus">+      {</span>
<a href="#l11.427"></a><span id="l11.427" class="difflineplus">+        &quot;name&quot;: &quot;removeAll&quot;,</span>
<a href="#l11.428"></a><span id="l11.428" class="difflineplus">+        &quot;type&quot;: &quot;function&quot;,</span>
<a href="#l11.429"></a><span id="l11.429" class="difflineplus">+        &quot;description&quot;: &quot;Removes all context menu items added by this extension.&quot;,</span>
<a href="#l11.430"></a><span id="l11.430" class="difflineplus">+        &quot;async&quot;: &quot;callback&quot;,</span>
<a href="#l11.431"></a><span id="l11.431" class="difflineplus">+        &quot;parameters&quot;: [</span>
<a href="#l11.432"></a><span id="l11.432" class="difflineplus">+          {</span>
<a href="#l11.433"></a><span id="l11.433" class="difflineplus">+            &quot;type&quot;: &quot;function&quot;,</span>
<a href="#l11.434"></a><span id="l11.434" class="difflineplus">+            &quot;name&quot;: &quot;callback&quot;,</span>
<a href="#l11.435"></a><span id="l11.435" class="difflineplus">+            &quot;optional&quot;: true,</span>
<a href="#l11.436"></a><span id="l11.436" class="difflineplus">+            &quot;parameters&quot;: [],</span>
<a href="#l11.437"></a><span id="l11.437" class="difflineplus">+            &quot;description&quot;: &quot;Called when removal is complete.&quot;</span>
<a href="#l11.438"></a><span id="l11.438" class="difflineplus">+          }</span>
<a href="#l11.439"></a><span id="l11.439" class="difflineplus">+        ]</span>
<a href="#l11.440"></a><span id="l11.440" class="difflineplus">+      },</span>
<a href="#l11.441"></a><span id="l11.441" class="difflineplus">+      {</span>
<a href="#l11.442"></a><span id="l11.442" class="difflineplus">+        &quot;name&quot;: &quot;overrideContext&quot;,</span>
<a href="#l11.443"></a><span id="l11.443" class="difflineplus">+        &quot;permissions&quot;: [&quot;menus.overrideContext&quot;],</span>
<a href="#l11.444"></a><span id="l11.444" class="difflineplus">+        &quot;type&quot;: &quot;function&quot;,</span>
<a href="#l11.445"></a><span id="l11.445" class="difflineplus">+        &quot;description&quot;: &quot;Show the matching menu items from this extension instead of the default menu. This should be called during a 'contextmenu' DOM event handler, and only applies to the menu that opens after this event.&quot;,</span>
<a href="#l11.446"></a><span id="l11.446" class="difflineplus">+        &quot;parameters&quot;: [</span>
<a href="#l11.447"></a><span id="l11.447" class="difflineplus">+          {</span>
<a href="#l11.448"></a><span id="l11.448" class="difflineplus">+            &quot;name&quot;: &quot;contextOptions&quot;,</span>
<a href="#l11.449"></a><span id="l11.449" class="difflineplus">+            &quot;type&quot;: &quot;object&quot;,</span>
<a href="#l11.450"></a><span id="l11.450" class="difflineplus">+            &quot;properties&quot;: {</span>
<a href="#l11.451"></a><span id="l11.451" class="difflineplus">+              &quot;showDefaults&quot;: {</span>
<a href="#l11.452"></a><span id="l11.452" class="difflineplus">+                &quot;type&quot;: &quot;boolean&quot;,</span>
<a href="#l11.453"></a><span id="l11.453" class="difflineplus">+                &quot;optional&quot;: true,</span>
<a href="#l11.454"></a><span id="l11.454" class="difflineplus">+                &quot;default&quot;: false,</span>
<a href="#l11.455"></a><span id="l11.455" class="difflineplus">+                &quot;description&quot;: &quot;Whether to also include default menu items in the menu.&quot;</span>
<a href="#l11.456"></a><span id="l11.456" class="difflineplus">+              },</span>
<a href="#l11.457"></a><span id="l11.457" class="difflineplus">+              &quot;context&quot;: {</span>
<a href="#l11.458"></a><span id="l11.458" class="difflineplus">+                &quot;type&quot;: &quot;string&quot;,</span>
<a href="#l11.459"></a><span id="l11.459" class="difflineplus">+                &quot;enum&quot;: [&quot;tab&quot;],</span>
<a href="#l11.460"></a><span id="l11.460" class="difflineplus">+                &quot;optional&quot;: true,</span>
<a href="#l11.461"></a><span id="l11.461" class="difflineplus">+                &quot;description&quot;: &quot;ContextType to override, to allow menu items from other extensions in the menu. Currently only 'tab' is supported. showDefaults cannot be used with this option.&quot;</span>
<a href="#l11.462"></a><span id="l11.462" class="difflineplus">+              },</span>
<a href="#l11.463"></a><span id="l11.463" class="difflineplus">+              &quot;tabId&quot;: {</span>
<a href="#l11.464"></a><span id="l11.464" class="difflineplus">+                &quot;type&quot;: &quot;integer&quot;,</span>
<a href="#l11.465"></a><span id="l11.465" class="difflineplus">+                &quot;minimum&quot;: 0,</span>
<a href="#l11.466"></a><span id="l11.466" class="difflineplus">+                &quot;optional&quot;: true,</span>
<a href="#l11.467"></a><span id="l11.467" class="difflineplus">+                &quot;description&quot;: &quot;Required when context is 'tab'. Requires 'tabs' permission.&quot;</span>
<a href="#l11.468"></a><span id="l11.468" class="difflineplus">+              }</span>
<a href="#l11.469"></a><span id="l11.469" class="difflineplus">+            }</span>
<a href="#l11.470"></a><span id="l11.470" class="difflineplus">+          }</span>
<a href="#l11.471"></a><span id="l11.471" class="difflineplus">+        ]</span>
<a href="#l11.472"></a><span id="l11.472" class="difflineplus">+      },</span>
<a href="#l11.473"></a><span id="l11.473" class="difflineplus">+      {</span>
<a href="#l11.474"></a><span id="l11.474" class="difflineplus">+        &quot;name&quot;: &quot;refresh&quot;,</span>
<a href="#l11.475"></a><span id="l11.475" class="difflineplus">+        &quot;type&quot;: &quot;function&quot;,</span>
<a href="#l11.476"></a><span id="l11.476" class="difflineplus">+        &quot;description&quot;: &quot;Updates the extension items in the shown menu, including changes that have been made since the menu was shown. Has no effect if the menu is hidden. Rebuilding a shown menu is an expensive operation, only invoke this method when necessary.&quot;,</span>
<a href="#l11.477"></a><span id="l11.477" class="difflineplus">+        &quot;async&quot;: true,</span>
<a href="#l11.478"></a><span id="l11.478" class="difflineplus">+        &quot;parameters&quot;: []</span>
<a href="#l11.479"></a><span id="l11.479" class="difflineplus">+      }</span>
<a href="#l11.480"></a><span id="l11.480" class="difflineplus">+    ],</span>
<a href="#l11.481"></a><span id="l11.481" class="difflineplus">+    &quot;events&quot;: [</span>
<a href="#l11.482"></a><span id="l11.482" class="difflineplus">+      {</span>
<a href="#l11.483"></a><span id="l11.483" class="difflineplus">+        &quot;name&quot;: &quot;onClicked&quot;,</span>
<a href="#l11.484"></a><span id="l11.484" class="difflineplus">+        &quot;type&quot;: &quot;function&quot;,</span>
<a href="#l11.485"></a><span id="l11.485" class="difflineplus">+        &quot;description&quot;: &quot;Fired when a context menu item is clicked.&quot;,</span>
<a href="#l11.486"></a><span id="l11.486" class="difflineplus">+        &quot;parameters&quot;: [</span>
<a href="#l11.487"></a><span id="l11.487" class="difflineplus">+          {</span>
<a href="#l11.488"></a><span id="l11.488" class="difflineplus">+            &quot;name&quot;: &quot;info&quot;,</span>
<a href="#l11.489"></a><span id="l11.489" class="difflineplus">+            &quot;$ref&quot;: &quot;OnClickData&quot;,</span>
<a href="#l11.490"></a><span id="l11.490" class="difflineplus">+            &quot;description&quot;: &quot;Information about the item clicked and the context where the click happened.&quot;</span>
<a href="#l11.491"></a><span id="l11.491" class="difflineplus">+          },</span>
<a href="#l11.492"></a><span id="l11.492" class="difflineplus">+          {</span>
<a href="#l11.493"></a><span id="l11.493" class="difflineplus">+            &quot;name&quot;: &quot;tab&quot;,</span>
<a href="#l11.494"></a><span id="l11.494" class="difflineplus">+            &quot;$ref&quot;: &quot;tabs.Tab&quot;,</span>
<a href="#l11.495"></a><span id="l11.495" class="difflineplus">+            &quot;description&quot;: &quot;The details of the tab where the click took place. If the click did not take place in a tab, this parameter will be missing.&quot;,</span>
<a href="#l11.496"></a><span id="l11.496" class="difflineplus">+            &quot;optional&quot;: true</span>
<a href="#l11.497"></a><span id="l11.497" class="difflineplus">+          }</span>
<a href="#l11.498"></a><span id="l11.498" class="difflineplus">+        ]</span>
<a href="#l11.499"></a><span id="l11.499" class="difflineplus">+      },</span>
<a href="#l11.500"></a><span id="l11.500" class="difflineplus">+      {</span>
<a href="#l11.501"></a><span id="l11.501" class="difflineplus">+        &quot;name&quot;: &quot;onShown&quot;,</span>
<a href="#l11.502"></a><span id="l11.502" class="difflineplus">+        &quot;type&quot;: &quot;function&quot;,</span>
<a href="#l11.503"></a><span id="l11.503" class="difflineplus">+        &quot;description&quot;: &quot;Fired when a menu is shown. The extension can add, modify or remove menu items and call menus.refresh() to update the menu.&quot;,</span>
<a href="#l11.504"></a><span id="l11.504" class="difflineplus">+        &quot;parameters&quot;: [</span>
<a href="#l11.505"></a><span id="l11.505" class="difflineplus">+          {</span>
<a href="#l11.506"></a><span id="l11.506" class="difflineplus">+            &quot;name&quot;: &quot;info&quot;,</span>
<a href="#l11.507"></a><span id="l11.507" class="difflineplus">+            &quot;type&quot;: &quot;object&quot;,</span>
<a href="#l11.508"></a><span id="l11.508" class="difflineplus">+            &quot;description&quot;: &quot;Information about the context of the menu action and the created menu items. For more information about each property, see OnClickData. The following properties are only set if the extension has host permissions for the given context: linkUrl, linkText, srcUrl, pageUrl, frameUrl, selectionText.&quot;,</span>
<a href="#l11.509"></a><span id="l11.509" class="difflineplus">+            &quot;properties&quot;: {</span>
<a href="#l11.510"></a><span id="l11.510" class="difflineplus">+              &quot;menuIds&quot;: {</span>
<a href="#l11.511"></a><span id="l11.511" class="difflineplus">+                &quot;description&quot;: &quot;A list of IDs of the menu items that were shown.&quot;,</span>
<a href="#l11.512"></a><span id="l11.512" class="difflineplus">+                &quot;type&quot;: &quot;array&quot;,</span>
<a href="#l11.513"></a><span id="l11.513" class="difflineplus">+                &quot;items&quot;: {</span>
<a href="#l11.514"></a><span id="l11.514" class="difflineplus">+                  &quot;choices&quot;: [</span>
<a href="#l11.515"></a><span id="l11.515" class="difflineplus">+                    { &quot;type&quot;: &quot;integer&quot; },</span>
<a href="#l11.516"></a><span id="l11.516" class="difflineplus">+                    { &quot;type&quot;: &quot;string&quot; }</span>
<a href="#l11.517"></a><span id="l11.517" class="difflineplus">+                  ]</span>
<a href="#l11.518"></a><span id="l11.518" class="difflineplus">+                }</span>
<a href="#l11.519"></a><span id="l11.519" class="difflineplus">+              },</span>
<a href="#l11.520"></a><span id="l11.520" class="difflineplus">+              &quot;contexts&quot;: {</span>
<a href="#l11.521"></a><span id="l11.521" class="difflineplus">+                &quot;description&quot;: &quot;A list of all contexts that apply to the menu.&quot;,</span>
<a href="#l11.522"></a><span id="l11.522" class="difflineplus">+                &quot;type&quot;: &quot;array&quot;,</span>
<a href="#l11.523"></a><span id="l11.523" class="difflineplus">+                &quot;items&quot;: {&quot;$ref&quot;: &quot;ContextType&quot;}</span>
<a href="#l11.524"></a><span id="l11.524" class="difflineplus">+              },</span>
<a href="#l11.525"></a><span id="l11.525" class="difflineplus">+              &quot;viewType&quot;: {</span>
<a href="#l11.526"></a><span id="l11.526" class="difflineplus">+                &quot;$ref&quot;: &quot;extension.ViewType&quot;,</span>
<a href="#l11.527"></a><span id="l11.527" class="difflineplus">+                &quot;optional&quot;: true</span>
<a href="#l11.528"></a><span id="l11.528" class="difflineplus">+              },</span>
<a href="#l11.529"></a><span id="l11.529" class="difflineplus">+              &quot;editable&quot;: {</span>
<a href="#l11.530"></a><span id="l11.530" class="difflineplus">+                &quot;type&quot;: &quot;boolean&quot;</span>
<a href="#l11.531"></a><span id="l11.531" class="difflineplus">+              },</span>
<a href="#l11.532"></a><span id="l11.532" class="difflineplus">+              &quot;mediaType&quot;: {</span>
<a href="#l11.533"></a><span id="l11.533" class="difflineplus">+                &quot;type&quot;: &quot;string&quot;,</span>
<a href="#l11.534"></a><span id="l11.534" class="difflineplus">+                &quot;optional&quot;: true</span>
<a href="#l11.535"></a><span id="l11.535" class="difflineplus">+              },</span>
<a href="#l11.536"></a><span id="l11.536" class="difflineplus">+              &quot;linkUrl&quot;: {</span>
<a href="#l11.537"></a><span id="l11.537" class="difflineplus">+                &quot;type&quot;: &quot;string&quot;,</span>
<a href="#l11.538"></a><span id="l11.538" class="difflineplus">+                &quot;optional&quot;: true</span>
<a href="#l11.539"></a><span id="l11.539" class="difflineplus">+              },</span>
<a href="#l11.540"></a><span id="l11.540" class="difflineplus">+              &quot;linkText&quot;: {</span>
<a href="#l11.541"></a><span id="l11.541" class="difflineplus">+                &quot;type&quot;: &quot;string&quot;,</span>
<a href="#l11.542"></a><span id="l11.542" class="difflineplus">+                &quot;optional&quot;: true</span>
<a href="#l11.543"></a><span id="l11.543" class="difflineplus">+              },</span>
<a href="#l11.544"></a><span id="l11.544" class="difflineplus">+              &quot;srcUrl&quot;: {</span>
<a href="#l11.545"></a><span id="l11.545" class="difflineplus">+                &quot;type&quot;: &quot;string&quot;,</span>
<a href="#l11.546"></a><span id="l11.546" class="difflineplus">+                &quot;optional&quot;: true</span>
<a href="#l11.547"></a><span id="l11.547" class="difflineplus">+              },</span>
<a href="#l11.548"></a><span id="l11.548" class="difflineplus">+              &quot;pageUrl&quot;: {</span>
<a href="#l11.549"></a><span id="l11.549" class="difflineplus">+                &quot;type&quot;: &quot;string&quot;,</span>
<a href="#l11.550"></a><span id="l11.550" class="difflineplus">+                &quot;optional&quot;: true</span>
<a href="#l11.551"></a><span id="l11.551" class="difflineplus">+              },</span>
<a href="#l11.552"></a><span id="l11.552" class="difflineplus">+              &quot;frameUrl&quot;: {</span>
<a href="#l11.553"></a><span id="l11.553" class="difflineplus">+                &quot;type&quot;: &quot;string&quot;,</span>
<a href="#l11.554"></a><span id="l11.554" class="difflineplus">+                &quot;optional&quot;: true</span>
<a href="#l11.555"></a><span id="l11.555" class="difflineplus">+              },</span>
<a href="#l11.556"></a><span id="l11.556" class="difflineplus">+              &quot;selectionText&quot;: {</span>
<a href="#l11.557"></a><span id="l11.557" class="difflineplus">+                &quot;type&quot;: &quot;string&quot;,</span>
<a href="#l11.558"></a><span id="l11.558" class="difflineplus">+                &quot;optional&quot;: true</span>
<a href="#l11.559"></a><span id="l11.559" class="difflineplus">+              },</span>
<a href="#l11.560"></a><span id="l11.560" class="difflineplus">+              &quot;targetElementId&quot;: {</span>
<a href="#l11.561"></a><span id="l11.561" class="difflineplus">+                &quot;type&quot;: &quot;integer&quot;,</span>
<a href="#l11.562"></a><span id="l11.562" class="difflineplus">+                &quot;optional&quot;: true</span>
<a href="#l11.563"></a><span id="l11.563" class="difflineplus">+              }</span>
<a href="#l11.564"></a><span id="l11.564" class="difflineplus">+            }</span>
<a href="#l11.565"></a><span id="l11.565" class="difflineplus">+          },</span>
<a href="#l11.566"></a><span id="l11.566" class="difflineplus">+          {</span>
<a href="#l11.567"></a><span id="l11.567" class="difflineplus">+            &quot;name&quot;: &quot;tab&quot;,</span>
<a href="#l11.568"></a><span id="l11.568" class="difflineplus">+            &quot;$ref&quot;: &quot;tabs.Tab&quot;,</span>
<a href="#l11.569"></a><span id="l11.569" class="difflineplus">+            &quot;description&quot;: &quot;The details of the tab where the menu was opened.&quot;</span>
<a href="#l11.570"></a><span id="l11.570" class="difflineplus">+          }</span>
<a href="#l11.571"></a><span id="l11.571" class="difflineplus">+        ]</span>
<a href="#l11.572"></a><span id="l11.572" class="difflineplus">+      },</span>
<a href="#l11.573"></a><span id="l11.573" class="difflineplus">+      {</span>
<a href="#l11.574"></a><span id="l11.574" class="difflineplus">+        &quot;name&quot;: &quot;onHidden&quot;,</span>
<a href="#l11.575"></a><span id="l11.575" class="difflineplus">+        &quot;type&quot;: &quot;function&quot;,</span>
<a href="#l11.576"></a><span id="l11.576" class="difflineplus">+        &quot;description&quot;: &quot;Fired when a menu is hidden. This event is only fired if onShown has fired before.&quot;,</span>
<a href="#l11.577"></a><span id="l11.577" class="difflineplus">+        &quot;parameters&quot;: []</span>
<a href="#l11.578"></a><span id="l11.578" class="difflineplus">+      }</span>
<a href="#l11.579"></a><span id="l11.579" class="difflineplus">+    ]</span>
<a href="#l11.580"></a><span id="l11.580" class="difflineplus">+  }</span>
<a href="#l11.581"></a><span id="l11.581" class="difflineplus">+]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">new file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- /dev/null</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ b/mail/components/extensions/schemas/menus_child.json</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -0,0 +1,29 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineplus">+[</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineplus">+  {</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineplus">+    &quot;namespace&quot;: &quot;menus&quot;,</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineplus">+    &quot;permissions&quot;: [&quot;menus&quot;],</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineplus">+    &quot;allowedContexts&quot;: [&quot;content&quot;, &quot;devtools&quot;],</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineplus">+    &quot;description&quot;: &quot;The part of the menus API that is available in all extension contexts, including content scripts.&quot;,</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineplus">+    &quot;functions&quot;: [</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+      {</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+        &quot;name&quot;: &quot;getTargetElement&quot;,</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+        &quot;type&quot;: &quot;function&quot;,</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+        &quot;allowedContexts&quot;: [&quot;content&quot;, &quot;devtools&quot;],</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+        &quot;description&quot;: &quot;Retrieve the element that was associated with a recent contextmenu event.&quot;,</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+        &quot;parameters&quot;: [</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+          {</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+            &quot;type&quot;: &quot;integer&quot;,</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+            &quot;description&quot;: &quot;The identifier of the clicked element, available as info.targetElementId in the menus.onShown, onClicked or onclick event.&quot;,</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+            &quot;name&quot;: &quot;targetElementId&quot;</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineplus">+          }</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineplus">+        ],</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+        &quot;returns&quot;: {</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+          &quot;type&quot;: &quot;object&quot;,</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+          &quot;optional&quot;: true,</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineplus">+          &quot;isInstanceOf&quot;: &quot;Element&quot;,</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineplus">+          &quot;additionalProperties&quot;: { &quot;type&quot;: &quot;any&quot; }</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineplus">+        }</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineplus">+      }</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+    ]</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+  }</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineplus">+]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mail/components/extensions/test/browser/browser.ini</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mail/components/extensions/test/browser/browser.ini</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -1,10 +1,11 @@</span>
<a href="#l13.4"></a><span id="l13.4"> [DEFAULT]</span>
<a href="#l13.5"></a><span id="l13.5"> head = head.js</span>
<a href="#l13.6"></a><span id="l13.6"> subsuite = thunderbird</span>
<a href="#l13.7"></a><span id="l13.7"> tags = webextensions</span>
<a href="#l13.8"></a><span id="l13.8"> </span>
<a href="#l13.9"></a><span id="l13.9"> [browser_ext_addressBooksUI.js]</span>
<a href="#l13.10"></a><span id="l13.10"> [browser_ext_browserAction.js]</span>
<a href="#l13.11"></a><span id="l13.11"> [browser_ext_composeAction.js]</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+[browser_ext_menus.js]</span>
<a href="#l13.13"></a><span id="l13.13"> [browser_ext_mailTabs.js]</span>
<a href="#l13.14"></a><span id="l13.14"> [browser_ext_quickFilter.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">new file mode 100644</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineminus">--- /dev/null</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineplus">+++ b/mail/components/extensions/test/browser/browser_ext_menus.js</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineat">@@ -0,0 +1,154 @@</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l14.7"></a><span id="l14.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineplus">+</span>
<a href="#l14.9"></a><span id="l14.9" class="difflineplus">+let gAccount, gFolders;</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineplus">+</span>
<a href="#l14.11"></a><span id="l14.11" class="difflineplus">+function treeClick(tree, row, column, event) {</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+  let coords = tree.treeBoxObject.getCoordsForCellItem(row, tree.columns[column], &quot;cell&quot;);</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+  let treeChildren = tree.lastElementChild;</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+  EventUtils.synthesizeMouse(</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+    treeChildren,</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+    coords.x + (coords.width / 2),</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+    coords.y + (coords.height / 2),</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineplus">+    event,</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineplus">+    window</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineplus">+  );</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineplus">+}</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineplus">+</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineplus">+async function checkEvent(extension, menuIds, contexts) {</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineplus">+  let [event, tab] = await extension.awaitMessage(&quot;onShown&quot;);</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineplus">+  is(event.menuIds.length, menuIds.length);</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineplus">+  for (let i = 0; i &lt; menuIds.length; i++) {</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+    is(event.menuIds[i], menuIds[i]);</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineplus">+  }</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+  is(event.contexts.length, contexts.length);</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+  for (let i = 0; i &lt; contexts.length; i++) {</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+    is(event.contexts[i], contexts[i]);</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+  }</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+  return [event, tab];</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+}</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+function createExtension() {</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+  return ExtensionTestUtils.loadExtension({</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+    async background() {</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+      for (let context of [</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+        &quot;audio&quot;,</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+        &quot;browser_action&quot;,</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+        &quot;editable&quot;,</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineplus">+        &quot;frame&quot;,</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+        &quot;image&quot;,</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+        &quot;link&quot;,</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineplus">+        &quot;page&quot;,</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineplus">+        &quot;password&quot;,</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+        &quot;selection&quot;,</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+        &quot;tab&quot;,</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+        &quot;video&quot;,</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+        &quot;message_list&quot;,</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+        &quot;folder_pane&quot;,</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+      ]) {</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+        browser.menus.create({ id: context, title: context, contexts: [context] });</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineplus">+      }</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineplus">+</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineplus">+      browser.menus.onShown.addListener((...args) =&gt; {</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineplus">+        browser.test.sendMessage(&quot;onShown&quot;, args);</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+      });</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineplus">+    },</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineplus">+    manifest: {</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineplus">+      applications: {</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineplus">+        gecko: {</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineplus">+          id: &quot;test1@mochi.test&quot;,</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+        },</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+      },</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineplus">+      permissions: [&quot;accountsRead&quot;, &quot;menus&quot;, &quot;messagesRead&quot;],</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineplus">+    },</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+  });</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+}</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineplus">+add_task(async function set_up() {</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineplus">+  gAccount = createAccount();</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineplus">+  gFolders = [...gAccount.incomingServer.rootFolder.subFolders];</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineplus">+  createMessages(gFolders[0], 10);</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineplus">+});</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineplus">+</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineplus">+add_task(async function test_folder_pane() {</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineplus">+  let extension = createExtension();</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineplus">+  await extension.startup();</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineplus">+</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineplus">+  let folderTree = document.getElementById(&quot;folderTree&quot;);</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineplus">+  treeClick(folderTree, 1, 0, {});</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineplus">+  treeClick(folderTree, 1, 0, {type: &quot;contextmenu&quot;});</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineplus">+</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineplus">+  let menu = document.getElementById(&quot;folderPaneContext&quot;);</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineplus">+  await BrowserTestUtils.waitForEvent(menu, &quot;popupshown&quot;);</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineplus">+  ok(menu.querySelector(&quot;#test1_mochi_test-menuitem-_folder_pane&quot;));</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineplus">+  menu.hidePopup();</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineplus">+</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineplus">+  let [event] = await checkEvent(extension, [&quot;folder_pane&quot;], [&quot;folder_pane&quot;, &quot;all&quot;]);</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineplus">+  is(event.selectedFolder.accountId, gAccount.key);</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineplus">+  is(event.selectedFolder.path, &quot;/Trash&quot;);</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineplus">+  ok(!event.displayedFolder);</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineplus">+  ok(!event.selectedMessages);</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineplus">+</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineplus">+  await extension.unload();</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineplus">+});</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineplus">+</span>
<a href="#l14.100"></a><span id="l14.100" class="difflineplus">+add_task(async function test_thread_pane() {</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineplus">+  let extension = createExtension();</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineplus">+  await extension.startup();</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineplus">+</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineplus">+  let threadTree = document.getElementById(&quot;threadTree&quot;);</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineplus">+  treeClick(threadTree, 0, 0, {});</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineplus">+  treeClick(threadTree, 0, 0, {type: &quot;contextmenu&quot;});</span>
<a href="#l14.107"></a><span id="l14.107" class="difflineplus">+</span>
<a href="#l14.108"></a><span id="l14.108" class="difflineplus">+  let menu = document.getElementById(&quot;mailContext&quot;);</span>
<a href="#l14.109"></a><span id="l14.109" class="difflineplus">+  await BrowserTestUtils.waitForEvent(menu, &quot;popupshown&quot;);</span>
<a href="#l14.110"></a><span id="l14.110" class="difflineplus">+  ok(menu.querySelector(&quot;#test1_mochi_test-menuitem-_message_list&quot;));</span>
<a href="#l14.111"></a><span id="l14.111" class="difflineplus">+  menu.hidePopup();</span>
<a href="#l14.112"></a><span id="l14.112" class="difflineplus">+</span>
<a href="#l14.113"></a><span id="l14.113" class="difflineplus">+  let [event] = await checkEvent(extension, [&quot;message_list&quot;], [&quot;message_list&quot;, &quot;all&quot;]);</span>
<a href="#l14.114"></a><span id="l14.114" class="difflineplus">+  is(event.displayedFolder.accountId, gAccount.key);</span>
<a href="#l14.115"></a><span id="l14.115" class="difflineplus">+  is(event.displayedFolder.path, &quot;/Trash&quot;);</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineplus">+  is(event.selectedMessages.cursor, null);</span>
<a href="#l14.117"></a><span id="l14.117" class="difflineplus">+  ok(!event.selectedFolder);</span>
<a href="#l14.118"></a><span id="l14.118" class="difflineplus">+</span>
<a href="#l14.119"></a><span id="l14.119" class="difflineplus">+  await extension.unload();</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineplus">+});</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineplus">+</span>
<a href="#l14.122"></a><span id="l14.122" class="difflineplus">+add_task(async function test_tab() {</span>
<a href="#l14.123"></a><span id="l14.123" class="difflineplus">+  async function checkTabEvent(index, active, isMail3Pane) {</span>
<a href="#l14.124"></a><span id="l14.124" class="difflineplus">+    EventUtils.synthesizeMouseAtCenter(tabs[index], {type: &quot;contextmenu&quot;}, window);</span>
<a href="#l14.125"></a><span id="l14.125" class="difflineplus">+</span>
<a href="#l14.126"></a><span id="l14.126" class="difflineplus">+    await BrowserTestUtils.waitForEvent(menu, &quot;popupshown&quot;);</span>
<a href="#l14.127"></a><span id="l14.127" class="difflineplus">+    ok(menu.querySelector(&quot;#test1_mochi_test-menuitem-_tab&quot;));</span>
<a href="#l14.128"></a><span id="l14.128" class="difflineplus">+    menu.hidePopup();</span>
<a href="#l14.129"></a><span id="l14.129" class="difflineplus">+</span>
<a href="#l14.130"></a><span id="l14.130" class="difflineplus">+    let [event, tab] = await checkEvent(extension, [&quot;tab&quot;], [&quot;tab&quot;]);</span>
<a href="#l14.131"></a><span id="l14.131" class="difflineplus">+    ok(!event.selectedFolder);</span>
<a href="#l14.132"></a><span id="l14.132" class="difflineplus">+    ok(!event.displayedFolder);</span>
<a href="#l14.133"></a><span id="l14.133" class="difflineplus">+    ok(!event.selectedMessages);</span>
<a href="#l14.134"></a><span id="l14.134" class="difflineplus">+    is(tab.active, active);</span>
<a href="#l14.135"></a><span id="l14.135" class="difflineplus">+    is(tab.index, index);</span>
<a href="#l14.136"></a><span id="l14.136" class="difflineplus">+    is(tab.isMail3Pane, isMail3Pane);</span>
<a href="#l14.137"></a><span id="l14.137" class="difflineplus">+  }</span>
<a href="#l14.138"></a><span id="l14.138" class="difflineplus">+</span>
<a href="#l14.139"></a><span id="l14.139" class="difflineplus">+  let extension = createExtension();</span>
<a href="#l14.140"></a><span id="l14.140" class="difflineplus">+  await extension.startup();</span>
<a href="#l14.141"></a><span id="l14.141" class="difflineplus">+</span>
<a href="#l14.142"></a><span id="l14.142" class="difflineplus">+  let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l14.143"></a><span id="l14.143" class="difflineplus">+  window.openContentTab(&quot;about:config&quot;);</span>
<a href="#l14.144"></a><span id="l14.144" class="difflineplus">+  window.openContentTab(&quot;about:mozilla&quot;);</span>
<a href="#l14.145"></a><span id="l14.145" class="difflineplus">+  tabmail.openTab(&quot;folder&quot;, { folder: gFolders[0] });</span>
<a href="#l14.146"></a><span id="l14.146" class="difflineplus">+</span>
<a href="#l14.147"></a><span id="l14.147" class="difflineplus">+  let tabs = tabmail.tabbox.tabs.children;</span>
<a href="#l14.148"></a><span id="l14.148" class="difflineplus">+  let menu = document.getElementById(&quot;tabContextMenu&quot;);</span>
<a href="#l14.149"></a><span id="l14.149" class="difflineplus">+</span>
<a href="#l14.150"></a><span id="l14.150" class="difflineplus">+  await checkTabEvent(0, false, true);</span>
<a href="#l14.151"></a><span id="l14.151" class="difflineplus">+  await checkTabEvent(1, false, false);</span>
<a href="#l14.152"></a><span id="l14.152" class="difflineplus">+  await checkTabEvent(2, false, false);</span>
<a href="#l14.153"></a><span id="l14.153" class="difflineplus">+  await checkTabEvent(3, true, true);</span>
<a href="#l14.154"></a><span id="l14.154" class="difflineplus">+</span>
<a href="#l14.155"></a><span id="l14.155" class="difflineplus">+  await extension.unload();</span>
<a href="#l14.156"></a><span id="l14.156" class="difflineplus">+</span>
<a href="#l14.157"></a><span id="l14.157" class="difflineplus">+  tabmail.closeOtherTabs(tabmail.tabModes.folder.tabs[0]);</span>
<a href="#l14.158"></a><span id="l14.158" class="difflineplus">+});</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:31Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

