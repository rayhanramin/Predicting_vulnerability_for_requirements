<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 12461:98c3da4179afb7cc8734a67921f927ace4d64664</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 98c3da4179afb7cc8734a67921f927ace4d64664" />
<meta property="og:url" content="/comm-central/rev/98c3da4179afb7cc8734a67921f927ace4d64664" />
<meta property="og:description" content="Bug 856577 - Make new message import from movemail more robust and fail cleanly if the file can't be parsed. r=jcranmer" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 98c3da4179afb7cc8734a67921f927ace4d64664 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/98c3da4179afb7cc8734a67921f927ace4d64664">shortlog</a> |
<a href="/comm-central/log/98c3da4179afb7cc8734a67921f927ace4d64664">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/98c3da4179afb7cc8734a67921f927ace4d64664">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/98c3da4179afb7cc8734a67921f927ace4d64664">files</a> |
changeset |
<a href="/comm-central/raw-rev/98c3da4179afb7cc8734a67921f927ace4d64664">raw</a>  | <a href="/comm-central/archive/98c3da4179afb7cc8734a67921f927ace4d64664.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=856577">Bug 856577</a> - Make new message import from movemail more robust and fail cleanly if the file can't be parsed. r=jcranmer
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#97;&#99;&#101;&#109;&#97;&#110;&#32;&#60;&#97;&#99;&#101;&#108;&#105;&#115;&#116;&#115;&#64;&#97;&#116;&#108;&#97;&#115;&#46;&#115;&#107;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 16 May 2013 16:50:00 -0400</td></tr>

<tr>
 <td>changeset 12461</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/98c3da4179afb7cc8734a67921f927ace4d64664">98c3da4179afb7cc8734a67921f927ace4d64664</a></td>
</tr>



<tr>
<td>parent 12460</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/1b9445a7c2dccea4822dfbf6634b5629569547c3">1b9445a7c2dccea4822dfbf6634b5629569547c3</a>
</td>
</tr>

<tr>
<td>child 12462</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/e67cfca5b6c0af3bc213dfda2cd5446e2fa7e8c3">e67cfca5b6c0af3bc213dfda2cd5446e2fa7e8c3</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=98c3da4179afb7cc8734a67921f927ace4d64664">9185</a></td></tr>
<tr><td>push user</td><td>ryanvm@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Thu, 16 May 2013 20:50:50 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@98c3da4179af [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=98c3da4179afb7cc8734a67921f927ace4d64664">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=98c3da4179afb7cc8734a67921f927ace4d64664&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=98c3da4179afb7cc8734a67921f927ace4d64664&newProject=comm-central&newRevision=98c3da4179afb7cc8734a67921f927ace4d64664&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=98c3da4179afb7cc8734a67921f927ace4d64664&newProject=comm-central&newRevision=98c3da4179afb7cc8734a67921f927ace4d64664&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=98c3da4179afb7cc8734a67921f927ace4d64664&newProject=comm-central&newRevision=98c3da4179afb7cc8734a67921f927ace4d64664&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28jcranmer%29&revcount=50">jcranmer</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=856577">856577</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=856577">Bug 856577</a> - Make new message import from movemail more robust and fail cleanly if the file can't be parsed. r=jcranmer</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/98c3da4179afb7cc8734a67921f927ace4d64664/mail/locales/en-US/chrome/messenger/localMsgs.properties">mail/locales/en-US/chrome/messenger/localMsgs.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/98c3da4179afb7cc8734a67921f927ace4d64664/mail/locales/en-US/chrome/messenger/localMsgs.properties">file</a> |
<a href="/comm-central/annotate/98c3da4179afb7cc8734a67921f927ace4d64664/mail/locales/en-US/chrome/messenger/localMsgs.properties">annotate</a> |
<a href="/comm-central/diff/98c3da4179afb7cc8734a67921f927ace4d64664/mail/locales/en-US/chrome/messenger/localMsgs.properties">diff</a> |
<a href="/comm-central/comparison/98c3da4179afb7cc8734a67921f927ace4d64664/mail/locales/en-US/chrome/messenger/localMsgs.properties">comparison</a> |
<a href="/comm-central/log/98c3da4179afb7cc8734a67921f927ace4d64664/mail/locales/en-US/chrome/messenger/localMsgs.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/98c3da4179afb7cc8734a67921f927ace4d64664/mailnews/local/src/nsMovemailService.cpp">mailnews/local/src/nsMovemailService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/98c3da4179afb7cc8734a67921f927ace4d64664/mailnews/local/src/nsMovemailService.cpp">file</a> |
<a href="/comm-central/annotate/98c3da4179afb7cc8734a67921f927ace4d64664/mailnews/local/src/nsMovemailService.cpp">annotate</a> |
<a href="/comm-central/diff/98c3da4179afb7cc8734a67921f927ace4d64664/mailnews/local/src/nsMovemailService.cpp">diff</a> |
<a href="/comm-central/comparison/98c3da4179afb7cc8734a67921f927ace4d64664/mailnews/local/src/nsMovemailService.cpp">comparison</a> |
<a href="/comm-central/log/98c3da4179afb7cc8734a67921f927ace4d64664/mailnews/local/src/nsMovemailService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/98c3da4179afb7cc8734a67921f927ace4d64664/mailnews/local/src/nsMovemailService.h">mailnews/local/src/nsMovemailService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/98c3da4179afb7cc8734a67921f927ace4d64664/mailnews/local/src/nsMovemailService.h">file</a> |
<a href="/comm-central/annotate/98c3da4179afb7cc8734a67921f927ace4d64664/mailnews/local/src/nsMovemailService.h">annotate</a> |
<a href="/comm-central/diff/98c3da4179afb7cc8734a67921f927ace4d64664/mailnews/local/src/nsMovemailService.h">diff</a> |
<a href="/comm-central/comparison/98c3da4179afb7cc8734a67921f927ace4d64664/mailnews/local/src/nsMovemailService.h">comparison</a> |
<a href="/comm-central/log/98c3da4179afb7cc8734a67921f927ace4d64664/mailnews/local/src/nsMovemailService.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/98c3da4179afb7cc8734a67921f927ace4d64664/suite/locales/en-US/chrome/mailnews/localMsgs.properties">suite/locales/en-US/chrome/mailnews/localMsgs.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/98c3da4179afb7cc8734a67921f927ace4d64664/suite/locales/en-US/chrome/mailnews/localMsgs.properties">file</a> |
<a href="/comm-central/annotate/98c3da4179afb7cc8734a67921f927ace4d64664/suite/locales/en-US/chrome/mailnews/localMsgs.properties">annotate</a> |
<a href="/comm-central/diff/98c3da4179afb7cc8734a67921f927ace4d64664/suite/locales/en-US/chrome/mailnews/localMsgs.properties">diff</a> |
<a href="/comm-central/comparison/98c3da4179afb7cc8734a67921f927ace4d64664/suite/locales/en-US/chrome/mailnews/localMsgs.properties">comparison</a> |
<a href="/comm-central/log/98c3da4179afb7cc8734a67921f927ace4d64664/suite/locales/en-US/chrome/mailnews/localMsgs.properties">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/localMsgs.properties</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/localMsgs.properties</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -98,16 +98,19 @@ movemailCantOpenSpoolFile=Unable to open</span>
<a href="#l1.4"></a><span id="l1.4"> movemailCantCreateLock=Unable to create lock file %S. For movemail to work, it is necessary to create lock files in the mail spool directory. On many systems, this is best accomplished by making the spool directory be mode 01777.</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6"> movemailCantDeleteLock=Unable to delete lock file %S.</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> movemailCantTruncateSpoolFile=Unable to truncate spool file %S.</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10"> movemailSpoolFileNotFound=Unable to locate mail spool file.</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+#LOCALIZATION NOTE (movemailCantParseSpool): %S is file name</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+movemailCantParseSpool=Unable to parse spool file %S. The file may be corrupt or not valid.</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+</span>
<a href="#l1.15"></a><span id="l1.15"> pop3TmpDownloadError=There was an error downloading the following message:   \nFrom: %S\n   Subject: %S\n This message may contain a virus or there is not enough disk space. Skip this message?</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17"> # Status - the server doesn't support UIDL…</span>
<a href="#l1.18"></a><span id="l1.18"> # LOCALIZATION NOTE(pop3ServerDoesNotSupportUidlEtc): The following sentence should be translated in this way:</span>
<a href="#l1.19"></a><span id="l1.19"> # Do not translate &quot;POP3&quot;</span>
<a href="#l1.20"></a><span id="l1.20"> # Do not translate &quot;%S&quot;. Place %S in your translation where the name of the server should appear.</span>
<a href="#l1.21"></a><span id="l1.21"> # Do not translate &quot;UIDL&quot;</span>
<a href="#l1.22"></a><span id="l1.22"> pop3ServerDoesNotSupportUidlEtc=The POP3 mail server (%S) does not support UIDL or XTND XLST, which are required to implement the ``Leave on Server'', ``Maximum Message Size'' or ``Fetch Headers Only'' options. To download your mail, turn off these options in the Server Settings for your mail server in the Account Settings window.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/local/src/nsMovemailService.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/local/src/nsMovemailService.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1,9 +1,9 @@</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l2.6"></a><span id="l2.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.7"></a><span id="l2.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.8"></a><span id="l2.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10"> #ifdef MOZ_LOGGING</span>
<a href="#l2.11"></a><span id="l2.11"> #define FORCE_PR_LOG</span>
<a href="#l2.12"></a><span id="l2.12"> #endif</span>
<a href="#l2.13"></a><span id="l2.13"> </span>
<a href="#l2.14"></a><span id="l2.14" class="difflineat">@@ -23,18 +23,16 @@</span>
<a href="#l2.15"></a><span id="l2.15"> #include &quot;nsParseMailbox.h&quot;</span>
<a href="#l2.16"></a><span id="l2.16"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l2.17"></a><span id="l2.17"> #include &quot;nsIPrompt.h&quot;</span>
<a href="#l2.18"></a><span id="l2.18"> </span>
<a href="#l2.19"></a><span id="l2.19"> #include &quot;nsIFile.h&quot;</span>
<a href="#l2.20"></a><span id="l2.20"> #include &quot;nsMailDirServiceDefs.h&quot;</span>
<a href="#l2.21"></a><span id="l2.21"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l2.22"></a><span id="l2.22"> </span>
<a href="#l2.23"></a><span id="l2.23" class="difflineminus">-#include &quot;nsMsgLocalCID.h&quot;</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineminus">-#include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l2.25"></a><span id="l2.25"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l2.26"></a><span id="l2.26"> #include &quot;nsMsgFolderFlags.h&quot;</span>
<a href="#l2.27"></a><span id="l2.27"> </span>
<a href="#l2.28"></a><span id="l2.28"> #include &quot;nsILineInputStream.h&quot;</span>
<a href="#l2.29"></a><span id="l2.29"> #include &quot;nsISeekableStream.h&quot;</span>
<a href="#l2.30"></a><span id="l2.30"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l2.31"></a><span id="l2.31"> #include &quot;nsAutoPtr.h&quot;</span>
<a href="#l2.32"></a><span id="l2.32"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineat">@@ -50,24 +48,59 @@ static PRLogModuleInfo *gMovemailLog = n</span>
<a href="#l2.34"></a><span id="l2.34"> #define LOG(args) PR_LOG(gMovemailLog, PR_LOG_DEBUG, args)</span>
<a href="#l2.35"></a><span id="l2.35"> #else</span>
<a href="#l2.36"></a><span id="l2.36"> #define LOG(args)</span>
<a href="#l2.37"></a><span id="l2.37"> #endif</span>
<a href="#l2.38"></a><span id="l2.38"> </span>
<a href="#l2.39"></a><span id="l2.39"> #define PREF_MAIL_ROOT_MOVEMAIL &quot;mail.root.movemail&quot;            // old - for backward compatibility only</span>
<a href="#l2.40"></a><span id="l2.40"> #define PREF_MAIL_ROOT_MOVEMAIL_REL &quot;mail.root.movemail-rel&quot;</span>
<a href="#l2.41"></a><span id="l2.41"> </span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+#define LOCK_SUFFIX &quot;.lock&quot;</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+#define MOZLOCK_SUFFIX &quot;.mozlock&quot;</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+</span>
<a href="#l2.45"></a><span id="l2.45"> const char * gDefaultSpoolPaths[] = {</span>
<a href="#l2.46"></a><span id="l2.46">   &quot;/var/spool/mail/&quot;,</span>
<a href="#l2.47"></a><span id="l2.47">   &quot;/usr/spool/mail/&quot;,</span>
<a href="#l2.48"></a><span id="l2.48">   &quot;/var/mail/&quot;,</span>
<a href="#l2.49"></a><span id="l2.49">   &quot;/usr/mail/&quot;</span>
<a href="#l2.50"></a><span id="l2.50"> };</span>
<a href="#l2.51"></a><span id="l2.51"> #define NUM_DEFAULT_SPOOL_PATHS (sizeof(gDefaultSpoolPaths)/sizeof(gDefaultSpoolPaths[0]))</span>
<a href="#l2.52"></a><span id="l2.52"> </span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+namespace {</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+class MOZ_STACK_CLASS SpoolLock</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+{</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+public:</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+  /**</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+   * Try to create a lock for the spool file while we operate on it.</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+   *</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+   * @param aSpoolName  The path to the spool file.</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+   * @param aSeconds    The number of seconds to retry the locking.</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+   * @param aMovemail   The movemail service requesting the lock.</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+   * @param aServer     The nsIMsgIncomingServer requesting the lock.</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+   */</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+  SpoolLock(nsACString *aSpoolPath, int aSeconds, nsMovemailService &amp;aMovemail,</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+            nsIMsgIncomingServer *aServer);</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+  ~SpoolLock();</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+  bool isLocked();</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+private:</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+  bool mLocked;</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+  nsCString mSpoolName;</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+  bool mUsingLockFile;</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+  nsRefPtr&lt;nsMovemailService&gt; mOwningService;</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIncomingServer&gt; mServer;</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+  bool ObtainSpoolLock(unsigned int aSeconds);</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+  bool YieldSpoolLock();</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+};</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineplus">+</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineplus">+}</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+</span>
<a href="#l2.85"></a><span id="l2.85"> nsMovemailService::nsMovemailService()</span>
<a href="#l2.86"></a><span id="l2.86"> {</span>
<a href="#l2.87"></a><span id="l2.87"> #if defined(PR_LOGGING)</span>
<a href="#l2.88"></a><span id="l2.88">   if (!gMovemailLog)</span>
<a href="#l2.89"></a><span id="l2.89">       gMovemailLog = PR_NewLogModule(&quot;Movemail&quot;);</span>
<a href="#l2.90"></a><span id="l2.90"> #endif</span>
<a href="#l2.91"></a><span id="l2.91">   LOG((&quot;nsMovemailService created: 0x%x\n&quot;, this));</span>
<a href="#l2.92"></a><span id="l2.92"> }</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineat">@@ -122,52 +155,82 @@ nsMovemailService::Error(const char* err</span>
<a href="#l2.94"></a><span id="l2.94">     bundle-&gt;GetStringFromName(NS_ConvertASCIItoUTF16(errorCode).get(),</span>
<a href="#l2.95"></a><span id="l2.95">                               getter_Copies(errStr));</span>
<a href="#l2.96"></a><span id="l2.96"> </span>
<a href="#l2.97"></a><span id="l2.97">   if (!errStr.IsEmpty()) {</span>
<a href="#l2.98"></a><span id="l2.98">     dialog-&gt;Alert(nullptr, errStr.get());</span>
<a href="#l2.99"></a><span id="l2.99">   }</span>
<a href="#l2.100"></a><span id="l2.100"> }</span>
<a href="#l2.101"></a><span id="l2.101"> </span>
<a href="#l2.102"></a><span id="l2.102" class="difflineplus">+SpoolLock::SpoolLock(nsACString *aSpoolName, int aSeconds,</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineplus">+                     nsMovemailService &amp;aMovemail,</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineplus">+                     nsIMsgIncomingServer *aServer)</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineplus">+: mLocked(false),</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineplus">+  mSpoolName(*aSpoolName),</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineplus">+  mOwningService(&amp;aMovemail),</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineplus">+  mServer(aServer)</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineplus">+{</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineplus">+  if (!ObtainSpoolLock(aSeconds)) {</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineplus">+    NS_ConvertUTF8toUTF16 lockFile(mSpoolName);</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineplus">+    lockFile.AppendLiteral(LOCK_SUFFIX);</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineplus">+    const PRUnichar* params[] = { lockFile.get() };</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineplus">+    mOwningService-&gt;Error(&quot;movemailCantCreateLock&quot;, params, 1);</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineplus">+    return;</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineplus">+  }</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineplus">+  mServer-&gt;SetServerBusy(true);</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineplus">+  mLocked = true;</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineplus">+}</span>
<a href="#l2.120"></a><span id="l2.120"> </span>
<a href="#l2.121"></a><span id="l2.121" class="difflineminus">-bool ObtainSpoolLock(const char *aSpoolName,</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineminus">-                       int aSeconds /* number of seconds to retry */,</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineminus">-                       bool *aUsingLockFile)</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineplus">+SpoolLock::~SpoolLock() {</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineplus">+  if (mLocked &amp;&amp; !YieldSpoolLock()) {</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineplus">+    NS_ConvertUTF8toUTF16 lockFile(mSpoolName);</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineplus">+    lockFile.AppendLiteral(LOCK_SUFFIX);</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineplus">+    const PRUnichar* params[] = { lockFile.get() };</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineplus">+    mOwningService-&gt;Error(&quot;movemailCantDeleteLock&quot;, params, 1);</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineplus">+  }</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineplus">+  mServer-&gt;SetServerBusy(false);</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineplus">+}</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineplus">+</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineplus">+bool</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineplus">+SpoolLock::isLocked() {</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineplus">+  return mLocked;</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineplus">+}</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineplus">+</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineplus">+bool</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineplus">+SpoolLock::ObtainSpoolLock(unsigned int aSeconds /* number of seconds to retry */)</span>
<a href="#l2.141"></a><span id="l2.141"> {</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineminus">-  NS_ENSURE_TRUE(aUsingLockFile, false);</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineminus">-</span>
<a href="#l2.144"></a><span id="l2.144">   /*</span>
<a href="#l2.145"></a><span id="l2.145">    * Locking procedures:</span>
<a href="#l2.146"></a><span id="l2.146">    * If the directory is not writable, we want to use the appropriate system</span>
<a href="#l2.147"></a><span id="l2.147">    * utilites to lock the file.</span>
<a href="#l2.148"></a><span id="l2.148">    * If the directory is writable, we want to go through the create-and-link</span>
<a href="#l2.149"></a><span id="l2.149">    * locking procedures to make it atomic for certain networked file systems.</span>
<a href="#l2.150"></a><span id="l2.150">    * This involves creating a .mozlock file and attempting to hard-link it to</span>
<a href="#l2.151"></a><span id="l2.151">    * the customary .lock file.</span>
<a href="#l2.152"></a><span id="l2.152">    */</span>
<a href="#l2.153"></a><span id="l2.153">   nsCOMPtr&lt;nsIFile&gt; spoolFile;</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineminus">-  nsresult rv = NS_NewNativeLocalFile(nsDependentCString(aSpoolName),</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineplus">+  nsresult rv = NS_NewNativeLocalFile(mSpoolName,</span>
<a href="#l2.156"></a><span id="l2.156">                                       true,</span>
<a href="#l2.157"></a><span id="l2.157">                                       getter_AddRefs(spoolFile));</span>
<a href="#l2.158"></a><span id="l2.158">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l2.159"></a><span id="l2.159"> </span>
<a href="#l2.160"></a><span id="l2.160">   nsCOMPtr&lt;nsIFile&gt; directory;</span>
<a href="#l2.161"></a><span id="l2.161">   rv = spoolFile-&gt;GetParent(getter_AddRefs(directory));</span>
<a href="#l2.162"></a><span id="l2.162">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l2.163"></a><span id="l2.163"> </span>
<a href="#l2.164"></a><span id="l2.164" class="difflineminus">-  rv = directory-&gt;IsWritable(aUsingLockFile);</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineplus">+  rv = directory-&gt;IsWritable(&amp;mUsingLockFile);</span>
<a href="#l2.166"></a><span id="l2.166">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l2.167"></a><span id="l2.167"> </span>
<a href="#l2.168"></a><span id="l2.168" class="difflineminus">-  if (!*aUsingLockFile) {</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineplus">+  if (!mUsingLockFile) {</span>
<a href="#l2.170"></a><span id="l2.170">     LOG((&quot;Attempting to use kernel file lock&quot;));</span>
<a href="#l2.171"></a><span id="l2.171">     PRFileDesc *fd;</span>
<a href="#l2.172"></a><span id="l2.172">     rv = spoolFile-&gt;OpenNSPRFileDesc(PR_RDWR, 0, &amp;fd);</span>
<a href="#l2.173"></a><span id="l2.173">     NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l2.174"></a><span id="l2.174">     PRStatus lock_result;</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineminus">-    int retry_count = 0;</span>
<a href="#l2.176"></a><span id="l2.176" class="difflineplus">+    unsigned int retry_count = 0;</span>
<a href="#l2.177"></a><span id="l2.177"> </span>
<a href="#l2.178"></a><span id="l2.178">     do {</span>
<a href="#l2.179"></a><span id="l2.179">       lock_result = PR_TLockFile(fd);</span>
<a href="#l2.180"></a><span id="l2.180">   </span>
<a href="#l2.181"></a><span id="l2.181">       retry_count++;</span>
<a href="#l2.182"></a><span id="l2.182">       LOG((&quot;Attempt %d of %d to lock file&quot;, retry_count, aSeconds));</span>
<a href="#l2.183"></a><span id="l2.183">       if (aSeconds &gt; 0 &amp;&amp; lock_result == PR_FAILURE) {</span>
<a href="#l2.184"></a><span id="l2.184">         // pause 1sec, waiting for .lock to go away</span>
<a href="#l2.185"></a><span id="l2.185" class="difflineat">@@ -186,47 +249,46 @@ bool ObtainSpoolLock(const char *aSpoolN</span>
<a href="#l2.186"></a><span id="l2.186">   //        2a: if SPOOLNAME.lock is &gt;60sec old then nuke it from orbit</span>
<a href="#l2.187"></a><span id="l2.187">   //        2b: repeat step 2 until retry-count expired or hard-link succeeds</span>
<a href="#l2.188"></a><span id="l2.188">   // step 3: remove SPOOLNAME.mozlock</span>
<a href="#l2.189"></a><span id="l2.189">   // step 4: If step 2 hard-link failed, fail hard; we do not hold the lock</span>
<a href="#l2.190"></a><span id="l2.190">   // DONE.</span>
<a href="#l2.191"></a><span id="l2.191">   //</span>
<a href="#l2.192"></a><span id="l2.192">   // (step 2a not yet implemented)</span>
<a href="#l2.193"></a><span id="l2.193"> </span>
<a href="#l2.194"></a><span id="l2.194" class="difflineminus">-</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineminus">-  nsAutoCString mozlockstr(aSpoolName);</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineminus">-  mozlockstr.Append(&quot;.mozlock&quot;);</span>
<a href="#l2.197"></a><span id="l2.197" class="difflineminus">-  nsAutoCString lockstr(aSpoolName);</span>
<a href="#l2.198"></a><span id="l2.198" class="difflineminus">-  lockstr.Append(&quot;.lock&quot;);</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineplus">+  nsAutoCString mozlockstr(mSpoolName);</span>
<a href="#l2.200"></a><span id="l2.200" class="difflineplus">+  mozlockstr.AppendLiteral(MOZLOCK_SUFFIX);</span>
<a href="#l2.201"></a><span id="l2.201" class="difflineplus">+  nsAutoCString lockstr(mSpoolName);</span>
<a href="#l2.202"></a><span id="l2.202" class="difflineplus">+  lockstr.AppendLiteral(LOCK_SUFFIX);</span>
<a href="#l2.203"></a><span id="l2.203"> </span>
<a href="#l2.204"></a><span id="l2.204">   // Create nsIFile for the spool.mozlock file</span>
<a href="#l2.205"></a><span id="l2.205">   nsCOMPtr&lt;nsIFile&gt; tmplocfile;</span>
<a href="#l2.206"></a><span id="l2.206">   rv = NS_NewNativeLocalFile(mozlockstr, true, getter_AddRefs(tmplocfile));</span>
<a href="#l2.207"></a><span id="l2.207" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l2.208"></a><span id="l2.208" class="difflineminus">-    return false;</span>
<a href="#l2.209"></a><span id="l2.209" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineplus">+</span>
<a href="#l2.211"></a><span id="l2.211">   // THOUGHT: hmm, perhaps use MakeUnique to generate us a unique mozlock?</span>
<a href="#l2.212"></a><span id="l2.212">   // ... perhaps not, MakeUnique implementation looks racey -- use mktemp()?</span>
<a href="#l2.213"></a><span id="l2.213"> </span>
<a href="#l2.214"></a><span id="l2.214">   // step 1: create SPOOLNAME.mozlock</span>
<a href="#l2.215"></a><span id="l2.215">   rv = tmplocfile-&gt;Create(nsIFile::NORMAL_FILE_TYPE, 0666);</span>
<a href="#l2.216"></a><span id="l2.216">   if (NS_FAILED(rv) &amp;&amp; rv != NS_ERROR_FILE_ALREADY_EXISTS) {</span>
<a href="#l2.217"></a><span id="l2.217">     // can't create our .mozlock file... game over already</span>
<a href="#l2.218"></a><span id="l2.218">     LOG((&quot;Failed to create file %s\n&quot;, mozlockstr.get()));</span>
<a href="#l2.219"></a><span id="l2.219">     return false;</span>
<a href="#l2.220"></a><span id="l2.220">   }</span>
<a href="#l2.221"></a><span id="l2.221"> </span>
<a href="#l2.222"></a><span id="l2.222">   // step 2: hard-link .mozlock file to .lock file (this wackiness</span>
<a href="#l2.223"></a><span id="l2.223">   //         is necessary for non-racey locking on NFS-mounted spool dirs)</span>
<a href="#l2.224"></a><span id="l2.224">   // n.b. XPCOM utilities don't support hard-linking yet, so we</span>
<a href="#l2.225"></a><span id="l2.225">   // skip out to &lt;unistd.h&gt; and the POSIX interface for link()</span>
<a href="#l2.226"></a><span id="l2.226">   int link_result = 0;</span>
<a href="#l2.227"></a><span id="l2.227" class="difflineminus">-  int retry_count = 0;</span>
<a href="#l2.228"></a><span id="l2.228" class="difflineplus">+  unsigned int retry_count = 0;</span>
<a href="#l2.229"></a><span id="l2.229"> </span>
<a href="#l2.230"></a><span id="l2.230">   do {</span>
<a href="#l2.231"></a><span id="l2.231" class="difflineminus">-    link_result = link(mozlockstr.get(),lockstr.get());</span>
<a href="#l2.232"></a><span id="l2.232" class="difflineplus">+    link_result = link(mozlockstr.get(), lockstr.get());</span>
<a href="#l2.233"></a><span id="l2.233"> </span>
<a href="#l2.234"></a><span id="l2.234">     retry_count++;</span>
<a href="#l2.235"></a><span id="l2.235">     LOG((&quot;Attempt %d of %d to create lock file&quot;, retry_count, aSeconds));</span>
<a href="#l2.236"></a><span id="l2.236"> </span>
<a href="#l2.237"></a><span id="l2.237">     if (aSeconds &gt; 0 &amp;&amp; link_result == -1) {</span>
<a href="#l2.238"></a><span id="l2.238">       // pause 1sec, waiting for .lock to go away</span>
<a href="#l2.239"></a><span id="l2.239">       PRIntervalTime sleepTime = 1000; // 1 second</span>
<a href="#l2.240"></a><span id="l2.240">       PR_Sleep(sleepTime);</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineat">@@ -242,62 +304,62 @@ bool ObtainSpoolLock(const char *aSpoolN</span>
<a href="#l2.242"></a><span id="l2.242">     LOG((&quot;Unable to delete %s&quot;, mozlockstr.get()));</span>
<a href="#l2.243"></a><span id="l2.243">   }</span>
<a href="#l2.244"></a><span id="l2.244"> </span>
<a href="#l2.245"></a><span id="l2.245">   // step 4: now we know whether we succeeded or failed</span>
<a href="#l2.246"></a><span id="l2.246">   return link_result == 0;</span>
<a href="#l2.247"></a><span id="l2.247"> }</span>
<a href="#l2.248"></a><span id="l2.248"> </span>
<a href="#l2.249"></a><span id="l2.249"> </span>
<a href="#l2.250"></a><span id="l2.250" class="difflineminus">-// Remove our mail-spool-file lock (n.b. we should only try this if</span>
<a href="#l2.251"></a><span id="l2.251" class="difflineminus">-// we're the ones who made the lock in the first place!)</span>
<a href="#l2.252"></a><span id="l2.252" class="difflineminus">-bool YieldSpoolLock(const char *aSpoolName, bool aUsingLockFile)</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineplus">+/**</span>
<a href="#l2.254"></a><span id="l2.254" class="difflineplus">+ * Remove our mail-spool-file lock (n.b. we should only try this if</span>
<a href="#l2.255"></a><span id="l2.255" class="difflineplus">+ * we're the ones who made the lock in the first place! I.e. if mLocked is true.)</span>
<a href="#l2.256"></a><span id="l2.256" class="difflineplus">+ */</span>
<a href="#l2.257"></a><span id="l2.257" class="difflineplus">+bool</span>
<a href="#l2.258"></a><span id="l2.258" class="difflineplus">+SpoolLock::YieldSpoolLock()</span>
<a href="#l2.259"></a><span id="l2.259"> {</span>
<a href="#l2.260"></a><span id="l2.260" class="difflineminus">-  LOG((&quot;YieldSpoolLock(%s)&quot;, aSpoolName));</span>
<a href="#l2.261"></a><span id="l2.261" class="difflineplus">+  LOG((&quot;YieldSpoolLock(%s)&quot;, mSpoolName.get()));</span>
<a href="#l2.262"></a><span id="l2.262"> </span>
<a href="#l2.263"></a><span id="l2.263" class="difflineminus">-  if (!aUsingLockFile) {</span>
<a href="#l2.264"></a><span id="l2.264" class="difflineplus">+  if (!mUsingLockFile) {</span>
<a href="#l2.265"></a><span id="l2.265">     nsCOMPtr&lt;nsIFile&gt; spoolFile;</span>
<a href="#l2.266"></a><span id="l2.266" class="difflineminus">-    nsresult rv = NS_NewNativeLocalFile(nsDependentCString(aSpoolName),</span>
<a href="#l2.267"></a><span id="l2.267" class="difflineplus">+    nsresult rv = NS_NewNativeLocalFile(mSpoolName,</span>
<a href="#l2.268"></a><span id="l2.268">                                         true,</span>
<a href="#l2.269"></a><span id="l2.269">                                         getter_AddRefs(spoolFile));</span>
<a href="#l2.270"></a><span id="l2.270">     NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l2.271"></a><span id="l2.271"> </span>
<a href="#l2.272"></a><span id="l2.272">     PRFileDesc *fd;</span>
<a href="#l2.273"></a><span id="l2.273">     rv = spoolFile-&gt;OpenNSPRFileDesc(PR_RDWR, 0, &amp;fd);</span>
<a href="#l2.274"></a><span id="l2.274">     NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l2.275"></a><span id="l2.275"> </span>
<a href="#l2.276"></a><span id="l2.276">     bool unlockSucceeded = PR_UnlockFile(fd) == PR_SUCCESS;</span>
<a href="#l2.277"></a><span id="l2.277">     PR_Close(fd);</span>
<a href="#l2.278"></a><span id="l2.278">     if (unlockSucceeded)</span>
<a href="#l2.279"></a><span id="l2.279">       LOG((&quot;YieldSpoolLock was successful.&quot;));</span>
<a href="#l2.280"></a><span id="l2.280">     return unlockSucceeded;</span>
<a href="#l2.281"></a><span id="l2.281">   }</span>
<a href="#l2.282"></a><span id="l2.282"> </span>
<a href="#l2.283"></a><span id="l2.283" class="difflineminus">-  nsAutoCString lockstr(aSpoolName);</span>
<a href="#l2.284"></a><span id="l2.284" class="difflineminus">-  lockstr.Append(&quot;.lock&quot;);</span>
<a href="#l2.285"></a><span id="l2.285" class="difflineplus">+  nsAutoCString lockstr(mSpoolName);</span>
<a href="#l2.286"></a><span id="l2.286" class="difflineplus">+  lockstr.AppendLiteral(LOCK_SUFFIX);</span>
<a href="#l2.287"></a><span id="l2.287"> </span>
<a href="#l2.288"></a><span id="l2.288">   nsresult rv;</span>
<a href="#l2.289"></a><span id="l2.289"> </span>
<a href="#l2.290"></a><span id="l2.290">   // Create nsIFile for the spool.lock file</span>
<a href="#l2.291"></a><span id="l2.291">   nsCOMPtr&lt;nsIFile&gt; locklocfile;</span>
<a href="#l2.292"></a><span id="l2.292">   rv = NS_NewNativeLocalFile(lockstr, true, getter_AddRefs(locklocfile));</span>
<a href="#l2.293"></a><span id="l2.293" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l2.294"></a><span id="l2.294" class="difflineminus">-    return false;</span>
<a href="#l2.295"></a><span id="l2.295" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l2.296"></a><span id="l2.296"> </span>
<a href="#l2.297"></a><span id="l2.297">   // Check if the lock file exists</span>
<a href="#l2.298"></a><span id="l2.298">   bool exists;</span>
<a href="#l2.299"></a><span id="l2.299">   rv = locklocfile-&gt;Exists(&amp;exists);</span>
<a href="#l2.300"></a><span id="l2.300" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l2.301"></a><span id="l2.301" class="difflineminus">-    return false;</span>
<a href="#l2.302"></a><span id="l2.302" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l2.303"></a><span id="l2.303"> </span>
<a href="#l2.304"></a><span id="l2.304">   // Delete the file if it exists</span>
<a href="#l2.305"></a><span id="l2.305">   if (exists) {</span>
<a href="#l2.306"></a><span id="l2.306">     rv = locklocfile-&gt;Remove(false /* non-recursive */);</span>
<a href="#l2.307"></a><span id="l2.307" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.308"></a><span id="l2.308" class="difflineminus">-      return false;</span>
<a href="#l2.309"></a><span id="l2.309" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l2.310"></a><span id="l2.310">   }</span>
<a href="#l2.311"></a><span id="l2.311"> </span>
<a href="#l2.312"></a><span id="l2.312">   LOG((&quot;YieldSpoolLock was successful.&quot;));</span>
<a href="#l2.313"></a><span id="l2.313"> </span>
<a href="#l2.314"></a><span id="l2.314">   // Success.</span>
<a href="#l2.315"></a><span id="l2.315">   return true;</span>
<a href="#l2.316"></a><span id="l2.316"> }</span>
<a href="#l2.317"></a><span id="l2.317"> </span>
<a href="#l2.318"></a><span id="l2.318" class="difflineat">@@ -341,173 +403,166 @@ LocateSpoolFile(nsACString &amp; spoolPath)</span>
<a href="#l2.319"></a><span id="l2.319">     }</span>
<a href="#l2.320"></a><span id="l2.320">   }</span>
<a href="#l2.321"></a><span id="l2.321"> </span>
<a href="#l2.322"></a><span id="l2.322">   return rv;</span>
<a href="#l2.323"></a><span id="l2.323"> }</span>
<a href="#l2.324"></a><span id="l2.324"> </span>
<a href="#l2.325"></a><span id="l2.325"> nsresult</span>
<a href="#l2.326"></a><span id="l2.326"> nsMovemailService::GetNewMail(nsIMsgWindow *aMsgWindow,</span>
<a href="#l2.327"></a><span id="l2.327" class="difflineminus">-                              nsIUrlListener *aUrlListener,</span>
<a href="#l2.328"></a><span id="l2.328" class="difflineminus">-                              nsIMsgFolder *aMsgFolder,</span>
<a href="#l2.329"></a><span id="l2.329" class="difflineminus">-                              nsIMovemailIncomingServer *movemailServer,</span>
<a href="#l2.330"></a><span id="l2.330" class="difflineminus">-                              nsIURI ** aURL)</span>
<a href="#l2.331"></a><span id="l2.331" class="difflineplus">+                              nsIUrlListener* /* aUrlListener */,</span>
<a href="#l2.332"></a><span id="l2.332" class="difflineplus">+                              nsIMsgFolder* /* aMsgFolder */,</span>
<a href="#l2.333"></a><span id="l2.333" class="difflineplus">+                              nsIMovemailIncomingServer *aMovemailServer,</span>
<a href="#l2.334"></a><span id="l2.334" class="difflineplus">+                              nsIURI ** /* aURL */)</span>
<a href="#l2.335"></a><span id="l2.335"> {</span>
<a href="#l2.336"></a><span id="l2.336">   LOG((&quot;nsMovemailService::GetNewMail&quot;));</span>
<a href="#l2.337"></a><span id="l2.337" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l2.338"></a><span id="l2.338" class="difflineplus">+</span>
<a href="#l2.339"></a><span id="l2.339" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aMovemailServer);</span>
<a href="#l2.340"></a><span id="l2.340" class="difflineplus">+  // It is OK if aMsgWindow is null.</span>
<a href="#l2.341"></a><span id="l2.341" class="difflineplus">+  mMsgWindow = aMsgWindow;</span>
<a href="#l2.342"></a><span id="l2.342" class="difflineplus">+</span>
<a href="#l2.343"></a><span id="l2.343" class="difflineplus">+  nsresult rv;</span>
<a href="#l2.344"></a><span id="l2.344"> </span>
<a href="#l2.345"></a><span id="l2.345">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; in_server =</span>
<a href="#l2.346"></a><span id="l2.346" class="difflineminus">-      do_QueryInterface(movemailServer);</span>
<a href="#l2.347"></a><span id="l2.347" class="difflineminus">-  if (!in_server)</span>
<a href="#l2.348"></a><span id="l2.348" class="difflineminus">-      return NS_MSG_INVALID_OR_MISSING_SERVER;</span>
<a href="#l2.349"></a><span id="l2.349" class="difflineminus">-  mMsgWindow = aMsgWindow;</span>
<a href="#l2.350"></a><span id="l2.350" class="difflineplus">+      do_QueryInterface(aMovemailServer, &amp;rv);</span>
<a href="#l2.351"></a><span id="l2.351" class="difflineplus">+  NS_ENSURE_TRUE(NS_SUCCEEDED(rv) &amp;&amp; in_server,</span>
<a href="#l2.352"></a><span id="l2.352" class="difflineplus">+    NS_MSG_INVALID_OR_MISSING_SERVER);</span>
<a href="#l2.353"></a><span id="l2.353"> </span>
<a href="#l2.354"></a><span id="l2.354">   // Attempt to locate the mail spool file</span>
<a href="#l2.355"></a><span id="l2.355">   nsAutoCString spoolPath;</span>
<a href="#l2.356"></a><span id="l2.356">   rv = in_server-&gt;GetCharValue(&quot;spoolDir&quot;, spoolPath);</span>
<a href="#l2.357"></a><span id="l2.357" class="difflineminus">-  if (spoolPath.IsEmpty())</span>
<a href="#l2.358"></a><span id="l2.358" class="difflineplus">+  if (NS_FAILED(rv) || spoolPath.IsEmpty())</span>
<a href="#l2.359"></a><span id="l2.359">     rv = LocateSpoolFile(spoolPath);</span>
<a href="#l2.360"></a><span id="l2.360">   if (NS_FAILED(rv) || spoolPath.IsEmpty()) {</span>
<a href="#l2.361"></a><span id="l2.361">     Error(&quot;movemailSpoolFileNotFound&quot;, nullptr, 0);</span>
<a href="#l2.362"></a><span id="l2.362">     return NS_ERROR_FAILURE;</span>
<a href="#l2.363"></a><span id="l2.363">   }</span>
<a href="#l2.364"></a><span id="l2.364"> </span>
<a href="#l2.365"></a><span id="l2.365" class="difflineplus">+  NS_ConvertUTF8toUTF16 wideSpoolPath(spoolPath);</span>
<a href="#l2.366"></a><span id="l2.366" class="difflineplus">+  const PRUnichar* spoolPathString[] = { wideSpoolPath.get() };</span>
<a href="#l2.367"></a><span id="l2.367" class="difflineplus">+</span>
<a href="#l2.368"></a><span id="l2.368">   // Create an input stream for the spool file</span>
<a href="#l2.369"></a><span id="l2.369">   nsCOMPtr&lt;nsIFile&gt; spoolFile;</span>
<a href="#l2.370"></a><span id="l2.370">   rv = NS_NewNativeLocalFile(spoolPath, true, getter_AddRefs(spoolFile));</span>
<a href="#l2.371"></a><span id="l2.371">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.372"></a><span id="l2.372">   nsCOMPtr&lt;nsIInputStream&gt; spoolInputStream;</span>
<a href="#l2.373"></a><span id="l2.373">   rv = NS_NewLocalFileInputStream(getter_AddRefs(spoolInputStream), spoolFile);</span>
<a href="#l2.374"></a><span id="l2.374">   if (NS_FAILED(rv)) {</span>
<a href="#l2.375"></a><span id="l2.375" class="difflineminus">-    const PRUnichar *params[] = {</span>
<a href="#l2.376"></a><span id="l2.376" class="difflineminus">-      NS_ConvertUTF8toUTF16(spoolPath).get()</span>
<a href="#l2.377"></a><span id="l2.377" class="difflineminus">-    };</span>
<a href="#l2.378"></a><span id="l2.378" class="difflineminus">-    Error(&quot;movemailCantOpenSpoolFile&quot;, params, 1);</span>
<a href="#l2.379"></a><span id="l2.379" class="difflineplus">+    Error(&quot;movemailCantOpenSpoolFile&quot;, spoolPathString, 1);</span>
<a href="#l2.380"></a><span id="l2.380">     return rv;</span>
<a href="#l2.381"></a><span id="l2.381">   }</span>
<a href="#l2.382"></a><span id="l2.382"> </span>
<a href="#l2.383"></a><span id="l2.383">   // Get a line input interface for the spool file</span>
<a href="#l2.384"></a><span id="l2.384">   nsCOMPtr&lt;nsILineInputStream&gt; lineInputStream =</span>
<a href="#l2.385"></a><span id="l2.385">     do_QueryInterface(spoolInputStream, &amp;rv);</span>
<a href="#l2.386"></a><span id="l2.386" class="difflineminus">-  if (!lineInputStream)</span>
<a href="#l2.387"></a><span id="l2.387" class="difflineminus">-    return rv;</span>
<a href="#l2.388"></a><span id="l2.388" class="difflineplus">+  NS_ENSURE_TRUE(NS_SUCCEEDED(rv) &amp;&amp; lineInputStream, rv);</span>
<a href="#l2.389"></a><span id="l2.389"> </span>
<a href="#l2.390"></a><span id="l2.390">   nsCOMPtr&lt;nsIMsgFolder&gt; serverFolder;</span>
<a href="#l2.391"></a><span id="l2.391">   nsCOMPtr&lt;nsIMsgFolder&gt; inbox;</span>
<a href="#l2.392"></a><span id="l2.392" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolder&gt; rootMsgFolder;</span>
<a href="#l2.393"></a><span id="l2.393"> </span>
<a href="#l2.394"></a><span id="l2.394">   rv = in_server-&gt;GetRootFolder(getter_AddRefs(serverFolder));</span>
<a href="#l2.395"></a><span id="l2.395">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.396"></a><span id="l2.396"> </span>
<a href="#l2.397"></a><span id="l2.397" class="difflineminus">-  rootMsgFolder = do_QueryInterface(serverFolder, &amp;rv);</span>
<a href="#l2.398"></a><span id="l2.398" class="difflineminus">-  if (!rootMsgFolder)</span>
<a href="#l2.399"></a><span id="l2.399" class="difflineminus">-    return rv;</span>
<a href="#l2.400"></a><span id="l2.400" class="difflineminus">-  rv = rootMsgFolder-&gt;GetFolderWithFlags(nsMsgFolderFlags::Inbox,</span>
<a href="#l2.401"></a><span id="l2.401" class="difflineminus">-                                         getter_AddRefs(inbox));</span>
<a href="#l2.402"></a><span id="l2.402" class="difflineplus">+  rv = serverFolder-&gt;GetFolderWithFlags(nsMsgFolderFlags::Inbox,</span>
<a href="#l2.403"></a><span id="l2.403" class="difflineplus">+                                        getter_AddRefs(inbox));</span>
<a href="#l2.404"></a><span id="l2.404" class="difflineplus">+  NS_ENSURE_TRUE(NS_SUCCEEDED(rv) &amp;&amp; inbox, rv);</span>
<a href="#l2.405"></a><span id="l2.405"> </span>
<a href="#l2.406"></a><span id="l2.406" class="difflineminus">-  NS_ENSURE_TRUE(inbox, NS_ERROR_FAILURE);</span>
<a href="#l2.407"></a><span id="l2.407" class="difflineminus">-  nsCOMPtr &lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l2.408"></a><span id="l2.408">   nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l2.409"></a><span id="l2.409" class="difflineminus">-  nsCOMPtr&lt;nsIMsgDBHdr&gt; newHdr;</span>
<a href="#l2.410"></a><span id="l2.410">   rv = in_server-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l2.411"></a><span id="l2.411">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.412"></a><span id="l2.412" class="difflineminus">-  bool reusable;</span>
<a href="#l2.413"></a><span id="l2.413" class="difflineplus">+</span>
<a href="#l2.414"></a><span id="l2.414">   // create a new mail parser</span>
<a href="#l2.415"></a><span id="l2.415">   nsRefPtr&lt;nsParseNewMailState&gt; newMailParser = new nsParseNewMailState;</span>
<a href="#l2.416"></a><span id="l2.416" class="difflineminus">-  NS_ENSURE_TRUE(newMailParser, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l2.417"></a><span id="l2.417" class="difflineminus">-</span>
<a href="#l2.418"></a><span id="l2.418" class="difflineminus">-  in_server-&gt;SetServerBusy(true);</span>
<a href="#l2.419"></a><span id="l2.419"> </span>
<a href="#l2.420"></a><span id="l2.420" class="difflineminus">-  // Try and obtain the lock for the spool file</span>
<a href="#l2.421"></a><span id="l2.421" class="difflineminus">-  bool usingLockFile;</span>
<a href="#l2.422"></a><span id="l2.422" class="difflineminus">-  if (!ObtainSpoolLock(spoolPath.get(), 5, &amp;usingLockFile)) {</span>
<a href="#l2.423"></a><span id="l2.423" class="difflineminus">-    nsAutoString lockFile = NS_ConvertUTF8toUTF16(spoolPath);</span>
<a href="#l2.424"></a><span id="l2.424" class="difflineminus">-    lockFile.AppendLiteral(&quot;.lock&quot;);</span>
<a href="#l2.425"></a><span id="l2.425" class="difflineminus">-    const PRUnichar *params[] = {</span>
<a href="#l2.426"></a><span id="l2.426" class="difflineminus">-      lockFile.get()</span>
<a href="#l2.427"></a><span id="l2.427" class="difflineminus">-    };</span>
<a href="#l2.428"></a><span id="l2.428" class="difflineminus">-    Error(&quot;movemailCantCreateLock&quot;, params, 1);</span>
<a href="#l2.429"></a><span id="l2.429" class="difflineplus">+  // Try and obtain the lock for the spool file.</span>
<a href="#l2.430"></a><span id="l2.430" class="difflineplus">+  SpoolLock lock(&amp;spoolPath, 5, *this, in_server);</span>
<a href="#l2.431"></a><span id="l2.431" class="difflineplus">+  if (!lock.isLocked())</span>
<a href="#l2.432"></a><span id="l2.432">     return NS_ERROR_FAILURE;</span>
<a href="#l2.433"></a><span id="l2.433" class="difflineminus">-  }</span>
<a href="#l2.434"></a><span id="l2.434" class="difflineplus">+</span>
<a href="#l2.435"></a><span id="l2.435" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; newHdr;</span>
<a href="#l2.436"></a><span id="l2.436" class="difflineplus">+  nsCOMPtr&lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l2.437"></a><span id="l2.437"> </span>
<a href="#l2.438"></a><span id="l2.438">   // MIDDLE of the FUN : consume the mailbox data.</span>
<a href="#l2.439"></a><span id="l2.439">   bool isMore = true;</span>
<a href="#l2.440"></a><span id="l2.440">   nsAutoCString buffer;</span>
<a href="#l2.441"></a><span id="l2.441" class="difflineminus">-  uint32_t bytesWritten;</span>
<a href="#l2.442"></a><span id="l2.442" class="difflineminus">-</span>
<a href="#l2.443"></a><span id="l2.443" class="difflineplus">+  uint32_t bytesWritten = 0;</span>
<a href="#l2.444"></a><span id="l2.444">   while (isMore &amp;&amp;</span>
<a href="#l2.445"></a><span id="l2.445">          NS_SUCCEEDED(lineInputStream-&gt;ReadLine(buffer, &amp;isMore)))</span>
<a href="#l2.446"></a><span id="l2.446">   {</span>
<a href="#l2.447"></a><span id="l2.447" class="difflineminus">-</span>
<a href="#l2.448"></a><span id="l2.448">     // If first string is empty and we're now at EOF then abort parsing.</span>
<a href="#l2.449"></a><span id="l2.449" class="difflineminus">-    if (buffer.IsEmpty() &amp;&amp; !isMore) {</span>
<a href="#l2.450"></a><span id="l2.450" class="difflineplus">+    if (buffer.IsEmpty() &amp;&amp; !isMore &amp;&amp; !bytesWritten) {</span>
<a href="#l2.451"></a><span id="l2.451">       LOG((&quot;Empty spool file&quot;));</span>
<a href="#l2.452"></a><span id="l2.452">       break;</span>
<a href="#l2.453"></a><span id="l2.453">     }</span>
<a href="#l2.454"></a><span id="l2.454"> </span>
<a href="#l2.455"></a><span id="l2.455" class="difflineminus">-    buffer += MSG_LINEBREAK;</span>
<a href="#l2.456"></a><span id="l2.456" class="difflineplus">+    buffer.AppendLiteral(MSG_LINEBREAK);</span>
<a href="#l2.457"></a><span id="l2.457"> </span>
<a href="#l2.458"></a><span id="l2.458" class="difflineminus">-    if (isMore &amp;&amp; !strncmp(buffer.get(), &quot;From &quot;, 5)) {</span>
<a href="#l2.459"></a><span id="l2.459" class="difflineminus">-      // finish prev header, if any.</span>
<a href="#l2.460"></a><span id="l2.460" class="difflineplus">+    if (isMore &amp;&amp; StringBeginsWith(buffer, NS_LITERAL_CSTRING(&quot;From &quot;))) {</span>
<a href="#l2.461"></a><span id="l2.461" class="difflineplus">+      // Finish previous header and message, if any.</span>
<a href="#l2.462"></a><span id="l2.462">       if (newHdr) {</span>
<a href="#l2.463"></a><span id="l2.463">         outputStream-&gt;Flush();</span>
<a href="#l2.464"></a><span id="l2.464">         newMailParser-&gt;PublishMsgHeader(nullptr);</span>
<a href="#l2.465"></a><span id="l2.465" class="difflineminus">-        msgStore-&gt;FinishNewMessage(outputStream, newHdr);</span>
<a href="#l2.466"></a><span id="l2.466" class="difflineplus">+        rv = msgStore-&gt;FinishNewMessage(outputStream, newHdr);</span>
<a href="#l2.467"></a><span id="l2.467" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.468"></a><span id="l2.468">         newMailParser-&gt;Clear();</span>
<a href="#l2.469"></a><span id="l2.469">       }</span>
<a href="#l2.470"></a><span id="l2.470" class="difflineminus">-      msgStore-&gt;GetNewMsgOutputStream(inbox, getter_AddRefs(newHdr),</span>
<a href="#l2.471"></a><span id="l2.471" class="difflineminus">-                                      &amp;reusable, getter_AddRefs(outputStream));</span>
<a href="#l2.472"></a><span id="l2.472" class="difflineplus">+      bool reusable;</span>
<a href="#l2.473"></a><span id="l2.473" class="difflineplus">+      rv = msgStore-&gt;GetNewMsgOutputStream(inbox, getter_AddRefs(newHdr),</span>
<a href="#l2.474"></a><span id="l2.474" class="difflineplus">+                                           &amp;reusable, getter_AddRefs(outputStream));</span>
<a href="#l2.475"></a><span id="l2.475">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.476"></a><span id="l2.476" class="difflineminus">-      nsCOMPtr &lt;nsIInputStream&gt; inputStream = do_QueryInterface(outputStream);</span>
<a href="#l2.477"></a><span id="l2.477" class="difflineplus">+</span>
<a href="#l2.478"></a><span id="l2.478" class="difflineplus">+      nsCOMPtr&lt;nsIInputStream&gt; inputStream = do_QueryInterface(outputStream, &amp;rv);</span>
<a href="#l2.479"></a><span id="l2.479" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.480"></a><span id="l2.480" class="difflineplus">+</span>
<a href="#l2.481"></a><span id="l2.481">       rv = newMailParser-&gt;Init(serverFolder, inbox,</span>
<a href="#l2.482"></a><span id="l2.482">                                nullptr, newHdr, outputStream);</span>
<a href="#l2.483"></a><span id="l2.483">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.484"></a><span id="l2.484" class="difflineminus">-      </span>
<a href="#l2.485"></a><span id="l2.485">     }</span>
<a href="#l2.486"></a><span id="l2.486" class="difflineplus">+    if (!outputStream) {</span>
<a href="#l2.487"></a><span id="l2.487" class="difflineplus">+      // If we do not have outputStream here, something bad happened.</span>
<a href="#l2.488"></a><span id="l2.488" class="difflineplus">+      // We probably didn't find the proper message start delimiter &quot;From &quot;</span>
<a href="#l2.489"></a><span id="l2.489" class="difflineplus">+      // and are now reading in the middle of a message. Bail out.</span>
<a href="#l2.490"></a><span id="l2.490" class="difflineplus">+      Error(&quot;movemailCantParseSpool&quot;, spoolPathString, 1);</span>
<a href="#l2.491"></a><span id="l2.491" class="difflineplus">+      return NS_ERROR_UNEXPECTED;</span>
<a href="#l2.492"></a><span id="l2.492" class="difflineplus">+    }</span>
<a href="#l2.493"></a><span id="l2.493" class="difflineplus">+</span>
<a href="#l2.494"></a><span id="l2.494">     newMailParser-&gt;HandleLine(buffer.BeginWriting(), buffer.Length());</span>
<a href="#l2.495"></a><span id="l2.495" class="difflineminus">-    outputStream-&gt;Write(buffer.get(), buffer.Length(), &amp;bytesWritten);</span>
<a href="#l2.496"></a><span id="l2.496" class="difflineplus">+    rv = outputStream-&gt;Write(buffer.get(), buffer.Length(), &amp;bytesWritten);</span>
<a href="#l2.497"></a><span id="l2.497" class="difflineplus">+    NS_ENSURE_TRUE(NS_SUCCEEDED(rv) &amp;&amp; (bytesWritten == buffer.Length()),</span>
<a href="#l2.498"></a><span id="l2.498" class="difflineplus">+                   NS_ERROR_FAILURE);</span>
<a href="#l2.499"></a><span id="l2.499"> </span>
<a href="#l2.500"></a><span id="l2.500" class="difflineminus">-    // 'From' lines delimit messages</span>
<a href="#l2.501"></a><span id="l2.501" class="difflineminus">-    if (isMore &amp;&amp; !strncmp(buffer.get(), &quot;From &quot;, 5)) {</span>
<a href="#l2.502"></a><span id="l2.502" class="difflineplus">+    // &quot;From &quot; lines delimit messages, start a new one here.</span>
<a href="#l2.503"></a><span id="l2.503" class="difflineplus">+    if (isMore &amp;&amp; StringBeginsWith(buffer, NS_LITERAL_CSTRING(&quot;From &quot;))) {</span>
<a href="#l2.504"></a><span id="l2.504">       buffer.AssignLiteral(&quot;X-Mozilla-Status: 8000&quot; MSG_LINEBREAK);</span>
<a href="#l2.505"></a><span id="l2.505">       newMailParser-&gt;HandleLine(buffer.BeginWriting(), buffer.Length());</span>
<a href="#l2.506"></a><span id="l2.506" class="difflineminus">-      outputStream-&gt;Write(buffer.get(), buffer.Length(), &amp;bytesWritten);</span>
<a href="#l2.507"></a><span id="l2.507" class="difflineplus">+      rv = outputStream-&gt;Write(buffer.get(), buffer.Length(), &amp;bytesWritten);</span>
<a href="#l2.508"></a><span id="l2.508" class="difflineplus">+      NS_ENSURE_TRUE(NS_SUCCEEDED(rv) &amp;&amp; (bytesWritten == buffer.Length()),</span>
<a href="#l2.509"></a><span id="l2.509" class="difflineplus">+                     NS_ERROR_FAILURE);</span>
<a href="#l2.510"></a><span id="l2.510" class="difflineplus">+</span>
<a href="#l2.511"></a><span id="l2.511">       buffer.AssignLiteral(&quot;X-Mozilla-Status2: 00000000&quot; MSG_LINEBREAK);</span>
<a href="#l2.512"></a><span id="l2.512">       newMailParser-&gt;HandleLine(buffer.BeginWriting(), buffer.Length());</span>
<a href="#l2.513"></a><span id="l2.513" class="difflineminus">-      outputStream-&gt;Write(buffer.get(), buffer.Length(), &amp;bytesWritten);</span>
<a href="#l2.514"></a><span id="l2.514" class="difflineplus">+      rv = outputStream-&gt;Write(buffer.get(), buffer.Length(), &amp;bytesWritten);</span>
<a href="#l2.515"></a><span id="l2.515" class="difflineplus">+      NS_ENSURE_TRUE(NS_SUCCEEDED(rv) &amp;&amp; (bytesWritten == buffer.Length()),</span>
<a href="#l2.516"></a><span id="l2.516" class="difflineplus">+                     NS_ERROR_FAILURE);</span>
<a href="#l2.517"></a><span id="l2.517">     }</span>
<a href="#l2.518"></a><span id="l2.518">   }</span>
<a href="#l2.519"></a><span id="l2.519">   if (outputStream) {</span>
<a href="#l2.520"></a><span id="l2.520">     outputStream-&gt;Flush();</span>
<a href="#l2.521"></a><span id="l2.521">     newMailParser-&gt;PublishMsgHeader(nullptr);</span>
<a href="#l2.522"></a><span id="l2.522">     newMailParser-&gt;OnStopRequest(nullptr, nullptr, NS_OK);</span>
<a href="#l2.523"></a><span id="l2.523" class="difflineminus">-    msgStore-&gt;FinishNewMessage(outputStream, newHdr);</span>
<a href="#l2.524"></a><span id="l2.524" class="difflineplus">+    rv = msgStore-&gt;FinishNewMessage(outputStream, newHdr);</span>
<a href="#l2.525"></a><span id="l2.525" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.526"></a><span id="l2.526">     outputStream-&gt;Close();</span>
<a href="#l2.527"></a><span id="l2.527">   }</span>
<a href="#l2.528"></a><span id="l2.528" class="difflineminus">-</span>
<a href="#l2.529"></a><span id="l2.529" class="difflineminus">-  // Truncate the spool file</span>
<a href="#l2.530"></a><span id="l2.530" class="difflineplus">+  // Truncate the spool file as we parsed it successfully.</span>
<a href="#l2.531"></a><span id="l2.531">   rv = spoolFile-&gt;SetFileSize(0);</span>
<a href="#l2.532"></a><span id="l2.532">   if (NS_FAILED(rv)) {</span>
<a href="#l2.533"></a><span id="l2.533" class="difflineminus">-    const PRUnichar *params[] = {</span>
<a href="#l2.534"></a><span id="l2.534" class="difflineminus">-      NS_ConvertUTF8toUTF16(spoolPath).get()</span>
<a href="#l2.535"></a><span id="l2.535" class="difflineminus">-    };</span>
<a href="#l2.536"></a><span id="l2.536" class="difflineminus">-    Error(&quot;movemailCantTruncateSpoolFile&quot;, params, 1);</span>
<a href="#l2.537"></a><span id="l2.537" class="difflineplus">+    Error(&quot;movemailCantTruncateSpoolFile&quot;, spoolPathString, 1);</span>
<a href="#l2.538"></a><span id="l2.538">   }</span>
<a href="#l2.539"></a><span id="l2.539"> </span>
<a href="#l2.540"></a><span id="l2.540" class="difflineminus">-  if (!YieldSpoolLock(spoolPath.get(), usingLockFile)) {</span>
<a href="#l2.541"></a><span id="l2.541" class="difflineminus">-    nsAutoString spoolLock = NS_ConvertUTF8toUTF16(spoolPath);</span>
<a href="#l2.542"></a><span id="l2.542" class="difflineminus">-    spoolLock.AppendLiteral(&quot;.lock&quot;);</span>
<a href="#l2.543"></a><span id="l2.543" class="difflineminus">-    const PRUnichar *params[] = {</span>
<a href="#l2.544"></a><span id="l2.544" class="difflineminus">-      spoolLock.get()</span>
<a href="#l2.545"></a><span id="l2.545" class="difflineminus">-    };</span>
<a href="#l2.546"></a><span id="l2.546" class="difflineminus">-    Error(&quot;movemailCantDeleteLock&quot;, params, 1);</span>
<a href="#l2.547"></a><span id="l2.547" class="difflineminus">-  }</span>
<a href="#l2.548"></a><span id="l2.548" class="difflineminus">-</span>
<a href="#l2.549"></a><span id="l2.549" class="difflineminus">-  in_server-&gt;SetServerBusy(false);</span>
<a href="#l2.550"></a><span id="l2.550" class="difflineminus">-</span>
<a href="#l2.551"></a><span id="l2.551">   LOG((&quot;GetNewMail returning rv=%d&quot;, rv));</span>
<a href="#l2.552"></a><span id="l2.552">   return rv;</span>
<a href="#l2.553"></a><span id="l2.553"> }</span>
<a href="#l2.554"></a><span id="l2.554"> </span>
<a href="#l2.555"></a><span id="l2.555"> </span>
<a href="#l2.556"></a><span id="l2.556"> NS_IMETHODIMP</span>
<a href="#l2.557"></a><span id="l2.557"> nsMovemailService::SetDefaultLocalPath(nsIFile *aPath)</span>
<a href="#l2.558"></a><span id="l2.558"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/local/src/nsMovemailService.h</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/local/src/nsMovemailService.h</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,35 +1,32 @@</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l3.6"></a><span id="l3.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.7"></a><span id="l3.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.8"></a><span id="l3.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10"> #ifndef nsMovemailService_h___</span>
<a href="#l3.11"></a><span id="l3.11"> #define nsMovemailService_h___</span>
<a href="#l3.12"></a><span id="l3.12"> </span>
<a href="#l3.13"></a><span id="l3.13"> #include &quot;nscore.h&quot;</span>
<a href="#l3.14"></a><span id="l3.14"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l3.15"></a><span id="l3.15"> </span>
<a href="#l3.16"></a><span id="l3.16"> #include &quot;nsIMovemailService.h&quot;</span>
<a href="#l3.17"></a><span id="l3.17"> #include &quot;nsIMsgProtocolInfo.h&quot;</span>
<a href="#l3.18"></a><span id="l3.18"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l3.19"></a><span id="l3.19"> </span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-class nsParseNewMailState;</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-class nsIMsgFolder;</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-</span>
<a href="#l3.23"></a><span id="l3.23"> class nsMovemailService : public nsIMsgProtocolInfo, public nsIMovemailService</span>
<a href="#l3.24"></a><span id="l3.24"> {</span>
<a href="#l3.25"></a><span id="l3.25"> public:</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-</span>
<a href="#l3.27"></a><span id="l3.27">   nsMovemailService();</span>
<a href="#l3.28"></a><span id="l3.28">   virtual ~nsMovemailService();</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-  </span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+</span>
<a href="#l3.31"></a><span id="l3.31">   NS_DECL_ISUPPORTS</span>
<a href="#l3.32"></a><span id="l3.32">   NS_DECL_NSIMOVEMAILSERVICE</span>
<a href="#l3.33"></a><span id="l3.33">   NS_DECL_NSIMSGPROTOCOLINFO</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-  </span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+  void Error(const char* errorCode, const PRUnichar **params, uint32_t length);</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+</span>
<a href="#l3.38"></a><span id="l3.38"> private:</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">-  void Error(const char* errorCode, const PRUnichar **params, uint32_t length);</span>
<a href="#l3.40"></a><span id="l3.40">   nsCOMPtr&lt;nsIMsgWindow&gt; mMsgWindow;</span>
<a href="#l3.41"></a><span id="l3.41"> };</span>
<a href="#l3.42"></a><span id="l3.42"> </span>
<a href="#l3.43"></a><span id="l3.43"> #endif /* nsMovemailService_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/suite/locales/en-US/chrome/mailnews/localMsgs.properties</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/suite/locales/en-US/chrome/mailnews/localMsgs.properties</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -98,16 +98,19 @@ movemailCantOpenSpoolFile=Unable to open</span>
<a href="#l4.4"></a><span id="l4.4"> movemailCantCreateLock=Unable to create lock file %S. For movemail to work, it is necessary to create lock files in the mail spool directory. On many systems, this is best accomplished by making the spool directory be mode 01777.</span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6"> movemailCantDeleteLock=Unable to delete lock file %S.</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8"> movemailCantTruncateSpoolFile=Unable to truncate spool file %S.</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10"> movemailSpoolFileNotFound=Unable to locate mail spool file.</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+#LOCALIZATION NOTE (movemailCantParseSpool): %S is file name</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+movemailCantParseSpool=Unable to parse spool file %S. The file may be corrupt or not valid.</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+</span>
<a href="#l4.15"></a><span id="l4.15"> pop3TmpDownloadError=There was an error downloading the following message:   \nFrom: %S\n   Subject: %S\n This message may contain a virus or there is not enough disk space. Skip this message?</span>
<a href="#l4.16"></a><span id="l4.16"> </span>
<a href="#l4.17"></a><span id="l4.17"> # Status - the server doesn't support UIDL…</span>
<a href="#l4.18"></a><span id="l4.18"> # LOCALIZATION NOTE(pop3ServerDoesNotSupportUidlEtc): The following sentence should be translated in this way:</span>
<a href="#l4.19"></a><span id="l4.19"> # Do not translate &quot;POP3&quot;</span>
<a href="#l4.20"></a><span id="l4.20"> # Do not translate &quot;%S&quot;. Place %S in your translation where the name of the server should appear.</span>
<a href="#l4.21"></a><span id="l4.21"> # Do not translate &quot;UIDL&quot;</span>
<a href="#l4.22"></a><span id="l4.22"> pop3ServerDoesNotSupportUidlEtc=The POP3 mail server (%S) does not support UIDL or XTND XLST, which are required to implement the ``Leave on Server'', ``Maximum Message Size'' or ``Fetch Headers Only'' options. To download your mail, turn off these options in the Server Settings for your mail server in the Account Settings window.</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

