<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 1939:1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b" />
<meta property="og:url" content="/comm-central/rev/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b" />
<meta property="og:description" content="Bug 459550 - Port Bug 448976 (turn the Session Restore prompt into an error page) to SeaMonkey. r+sr=Neil, a=wanted2+." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b">shortlog</a> |
<a href="/comm-central/log/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b">files</a> |
changeset |
<a href="/comm-central/raw-rev/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b">raw</a>  | <a href="/comm-central/archive/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=459550">Bug 459550</a> - Port <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=448976">Bug 448976</a> (turn the Session Restore prompt into an error page) to SeaMonkey. r+sr=Neil, a=wanted2+.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#77;&#105;&#115;&#97;&#107;&#32;&#75;&#104;&#97;&#99;&#104;&#97;&#116;&#114;&#121;&#97;&#110;&#32;&#60;&#109;&#105;&#115;&#97;&#107;&#64;&#120;&#116;&#101;&#114;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 13 Feb 2009 19:51:08 +0100</td></tr>

<tr>
 <td>changeset 1939</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b">1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b</a></td>
</tr>



<tr>
<td>parent 1938</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/212adb96ed90119daf0027a44b176240f198569a">212adb96ed90119daf0027a44b176240f198569a</a>
</td>
</tr>

<tr>
<td>child 1940</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/000d44cb19cc718345f6656c03208f1cddc05e5d">000d44cb19cc718345f6656c03208f1cddc05e5d</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b">1569</a></td></tr>
<tr><td>push user</td><td>stefanh@inbox.com</td></tr>
<tr><td>push date</td><td class="date age">Fri, 13 Feb 2009 18:51:16 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@1cba9a3b59cb [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b&newProject=comm-central&newRevision=1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b&newProject=comm-central&newRevision=1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b&newProject=comm-central&newRevision=1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28wanted2%29&revcount=50">wanted2</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=459550">459550</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=448976">448976</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=459550">Bug 459550</a> - Port <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=448976">Bug 448976</a> (turn the Session Restore prompt into an error page) to SeaMonkey. r+sr=Neil, a=wanted2+.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/browser/browser-prefs.js">suite/browser/browser-prefs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/browser/browser-prefs.js">file</a> |
<a href="/comm-central/annotate/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/browser/browser-prefs.js">annotate</a> |
<a href="/comm-central/diff/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/browser/browser-prefs.js">diff</a> |
<a href="/comm-central/comparison/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/browser/browser-prefs.js">comparison</a> |
<a href="/comm-central/log/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/browser/browser-prefs.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/browser/tabbrowser.xml">suite/browser/tabbrowser.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/browser/tabbrowser.xml">file</a> |
<a href="/comm-central/annotate/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/browser/tabbrowser.xml">annotate</a> |
<a href="/comm-central/diff/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/browser/tabbrowser.xml">diff</a> |
<a href="/comm-central/comparison/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/browser/tabbrowser.xml">comparison</a> |
<a href="/comm-central/log/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/browser/tabbrowser.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/common/aboutSessionRestore.js">suite/common/aboutSessionRestore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/common/aboutSessionRestore.js">file</a> |
<a href="/comm-central/annotate/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/common/aboutSessionRestore.js">annotate</a> |
<a href="/comm-central/diff/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/common/aboutSessionRestore.js">diff</a> |
<a href="/comm-central/comparison/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/common/aboutSessionRestore.js">comparison</a> |
<a href="/comm-central/log/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/common/aboutSessionRestore.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/common/aboutSessionRestore.xhtml">suite/common/aboutSessionRestore.xhtml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/common/aboutSessionRestore.xhtml">file</a> |
<a href="/comm-central/annotate/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/common/aboutSessionRestore.xhtml">annotate</a> |
<a href="/comm-central/diff/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/common/aboutSessionRestore.xhtml">diff</a> |
<a href="/comm-central/comparison/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/common/aboutSessionRestore.xhtml">comparison</a> |
<a href="/comm-central/log/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/common/aboutSessionRestore.xhtml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/common/jar.mn">suite/common/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/common/jar.mn">file</a> |
<a href="/comm-central/annotate/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/common/jar.mn">annotate</a> |
<a href="/comm-central/diff/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/common/jar.mn">diff</a> |
<a href="/comm-central/comparison/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/common/jar.mn">comparison</a> |
<a href="/comm-central/log/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/common/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/common/src/Makefile.in">suite/common/src/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/common/src/Makefile.in">file</a> |
<a href="/comm-central/annotate/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/common/src/Makefile.in">annotate</a> |
<a href="/comm-central/diff/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/common/src/Makefile.in">diff</a> |
<a href="/comm-central/comparison/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/common/src/Makefile.in">comparison</a> |
<a href="/comm-central/log/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/common/src/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/common/src/nsAboutSessionRestore.js">suite/common/src/nsAboutSessionRestore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/common/src/nsAboutSessionRestore.js">file</a> |
<a href="/comm-central/annotate/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/common/src/nsAboutSessionRestore.js">annotate</a> |
<a href="/comm-central/diff/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/common/src/nsAboutSessionRestore.js">diff</a> |
<a href="/comm-central/comparison/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/common/src/nsAboutSessionRestore.js">comparison</a> |
<a href="/comm-central/log/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/common/src/nsAboutSessionRestore.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/common/src/nsSessionStartup.js">suite/common/src/nsSessionStartup.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/common/src/nsSessionStartup.js">file</a> |
<a href="/comm-central/annotate/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/common/src/nsSessionStartup.js">annotate</a> |
<a href="/comm-central/diff/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/common/src/nsSessionStartup.js">diff</a> |
<a href="/comm-central/comparison/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/common/src/nsSessionStartup.js">comparison</a> |
<a href="/comm-central/log/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/common/src/nsSessionStartup.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/common/src/nsSessionStore.js">suite/common/src/nsSessionStore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/common/src/nsSessionStore.js">file</a> |
<a href="/comm-central/annotate/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/common/src/nsSessionStore.js">annotate</a> |
<a href="/comm-central/diff/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/common/src/nsSessionStore.js">diff</a> |
<a href="/comm-central/comparison/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/common/src/nsSessionStore.js">comparison</a> |
<a href="/comm-central/log/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/common/src/nsSessionStore.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/installer/unix/packages">suite/installer/unix/packages</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/installer/unix/packages">file</a> |
<a href="/comm-central/annotate/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/installer/unix/packages">annotate</a> |
<a href="/comm-central/diff/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/installer/unix/packages">diff</a> |
<a href="/comm-central/comparison/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/installer/unix/packages">comparison</a> |
<a href="/comm-central/log/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/installer/unix/packages">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/installer/windows/packages">suite/installer/windows/packages</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/installer/windows/packages">file</a> |
<a href="/comm-central/annotate/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/installer/windows/packages">annotate</a> |
<a href="/comm-central/diff/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/installer/windows/packages">diff</a> |
<a href="/comm-central/comparison/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/installer/windows/packages">comparison</a> |
<a href="/comm-central/log/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/installer/windows/packages">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/locales/en-US/chrome/common/aboutSessionRestore.dtd">suite/locales/en-US/chrome/common/aboutSessionRestore.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/locales/en-US/chrome/common/aboutSessionRestore.dtd">file</a> |
<a href="/comm-central/annotate/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/locales/en-US/chrome/common/aboutSessionRestore.dtd">annotate</a> |
<a href="/comm-central/diff/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/locales/en-US/chrome/common/aboutSessionRestore.dtd">diff</a> |
<a href="/comm-central/comparison/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/locales/en-US/chrome/common/aboutSessionRestore.dtd">comparison</a> |
<a href="/comm-central/log/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/locales/en-US/chrome/common/aboutSessionRestore.dtd">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/locales/en-US/chrome/common/sessionstore.properties">suite/locales/en-US/chrome/common/sessionstore.properties</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/locales/en-US/chrome/common/sessionstore.properties">diff</a> |
<a href="/comm-central/comparison/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/locales/en-US/chrome/common/sessionstore.properties">comparison</a> |
<a href="/comm-central/log/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/locales/en-US/chrome/common/sessionstore.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/locales/jar.mn">suite/locales/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/locales/jar.mn">file</a> |
<a href="/comm-central/annotate/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/locales/jar.mn">annotate</a> |
<a href="/comm-central/diff/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/locales/jar.mn">diff</a> |
<a href="/comm-central/comparison/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/locales/jar.mn">comparison</a> |
<a href="/comm-central/log/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/locales/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/themes/classic/communicator/aboutSessionRestore.css">suite/themes/classic/communicator/aboutSessionRestore.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/themes/classic/communicator/aboutSessionRestore.css">file</a> |
<a href="/comm-central/annotate/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/themes/classic/communicator/aboutSessionRestore.css">annotate</a> |
<a href="/comm-central/diff/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/themes/classic/communicator/aboutSessionRestore.css">diff</a> |
<a href="/comm-central/comparison/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/themes/classic/communicator/aboutSessionRestore.css">comparison</a> |
<a href="/comm-central/log/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/themes/classic/communicator/aboutSessionRestore.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/themes/classic/jar.mn">suite/themes/classic/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/themes/classic/jar.mn">file</a> |
<a href="/comm-central/annotate/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/themes/classic/jar.mn">annotate</a> |
<a href="/comm-central/diff/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/themes/classic/jar.mn">diff</a> |
<a href="/comm-central/comparison/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/themes/classic/jar.mn">comparison</a> |
<a href="/comm-central/log/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/themes/classic/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/themes/modern/communicator/aboutSessionRestore.css">suite/themes/modern/communicator/aboutSessionRestore.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/themes/modern/communicator/aboutSessionRestore.css">file</a> |
<a href="/comm-central/annotate/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/themes/modern/communicator/aboutSessionRestore.css">annotate</a> |
<a href="/comm-central/diff/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/themes/modern/communicator/aboutSessionRestore.css">diff</a> |
<a href="/comm-central/comparison/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/themes/modern/communicator/aboutSessionRestore.css">comparison</a> |
<a href="/comm-central/log/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/themes/modern/communicator/aboutSessionRestore.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/themes/modern/jar.mn">suite/themes/modern/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/themes/modern/jar.mn">file</a> |
<a href="/comm-central/annotate/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/themes/modern/jar.mn">annotate</a> |
<a href="/comm-central/diff/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/themes/modern/jar.mn">diff</a> |
<a href="/comm-central/comparison/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/themes/modern/jar.mn">comparison</a> |
<a href="/comm-central/log/1cba9a3b59cbaf9becb554b1cf9b1f4d0198c04b/suite/themes/modern/jar.mn">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/suite/browser/browser-prefs.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/suite/browser/browser-prefs.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -191,17 +191,16 @@ pref(&quot;places.frecency.unvisitedTypedBonu</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5"> // Tabbed browser</span>
<a href="#l1.6"></a><span id="l1.6"> pref(&quot;browser.tabs.loadDivertedInBackground&quot;, false);</span>
<a href="#l1.7"></a><span id="l1.7"> pref(&quot;browser.tabs.loadInBackground&quot;, false);</span>
<a href="#l1.8"></a><span id="l1.8"> pref(&quot;browser.tabs.opentabfor.middleclick&quot;, false);</span>
<a href="#l1.9"></a><span id="l1.9"> pref(&quot;browser.tabs.opentabfor.urlbar&quot;, false);</span>
<a href="#l1.10"></a><span id="l1.10"> pref(&quot;browser.tabs.tooltippreview.enable&quot;, true);</span>
<a href="#l1.11"></a><span id="l1.11"> pref(&quot;browser.tabs.tooltippreview.width&quot;, 300);</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-pref(&quot;browser.tabs.undoclose.depth&quot;, 3);</span>
<a href="#l1.13"></a><span id="l1.13"> pref(&quot;browser.tabs.autoHide&quot;, true);</span>
<a href="#l1.14"></a><span id="l1.14"> pref(&quot;browser.tabs.forceHide&quot;, false);</span>
<a href="#l1.15"></a><span id="l1.15"> pref(&quot;browser.tabs.warnOnClose&quot;, true);</span>
<a href="#l1.16"></a><span id="l1.16"> pref(&quot;browser.tabs.warnOnCloseOther&quot;, true);</span>
<a href="#l1.17"></a><span id="l1.17"> pref(&quot;browser.tabs.warnOnOpen&quot;, true);</span>
<a href="#l1.18"></a><span id="l1.18"> pref(&quot;browser.tabs.maxOpenBeforeWarn&quot;, 15);</span>
<a href="#l1.19"></a><span id="l1.19"> // 0 = append, 1 = replace</span>
<a href="#l1.20"></a><span id="l1.20"> pref(&quot;browser.tabs.loadGroup&quot;, 1);</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineat">@@ -316,16 +315,21 @@ pref(&quot;browser.sessionstore.resume_sessio</span>
<a href="#l1.22"></a><span id="l1.22"> // minimal interval between two save operations in milliseconds</span>
<a href="#l1.23"></a><span id="l1.23"> pref(&quot;browser.sessionstore.interval&quot;, 10000);</span>
<a href="#l1.24"></a><span id="l1.24"> // maximum amount of POSTDATA to be saved in bytes per history entry (-1 = all of it)</span>
<a href="#l1.25"></a><span id="l1.25"> // (NB: POSTDATA will be saved either entirely or not at all)</span>
<a href="#l1.26"></a><span id="l1.26"> pref(&quot;browser.sessionstore.postdata&quot;, 0);</span>
<a href="#l1.27"></a><span id="l1.27"> // on which sites to save text data, POSTDATA and cookies</span>
<a href="#l1.28"></a><span id="l1.28"> // 0 = everywhere, 1 = unencrypted sites, 2 = nowhere</span>
<a href="#l1.29"></a><span id="l1.29"> pref(&quot;browser.sessionstore.privacy_level&quot;, 1);</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+// number of crashes that can occur before the about:sessionrestore page is displayed</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+// (this pref has no effect if more than 6 hours have passed since the last crash)</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+pref(&quot;browser.sessionstore.max_resumed_crashes&quot;, 1);</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+// how many tabs can be reopened (per window)</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+pref(&quot;browser.sessionstore.max_tabs_undo&quot;, 10);</span>
<a href="#l1.35"></a><span id="l1.35"> </span>
<a href="#l1.36"></a><span id="l1.36"> pref(&quot;shell.checkDefaultClient&quot;, true);</span>
<a href="#l1.37"></a><span id="l1.37"> // We want to check if we are the default client for browser and mail. See </span>
<a href="#l1.38"></a><span id="l1.38"> // suite/shell/public/nsIShellService.idl for the possible constants you can use</span>
<a href="#l1.39"></a><span id="l1.39"> pref(&quot;shell.checkDefaultApps&quot;, 3);</span>
<a href="#l1.40"></a><span id="l1.40"> </span>
<a href="#l1.41"></a><span id="l1.41"> pref(&quot;app.releaseNotesURL&quot;, &quot;chrome://branding/locale/brand.properties&quot;);</span>
<a href="#l1.42"></a><span id="l1.42"> pref(&quot;app.vendorURL&quot;, &quot;chrome://branding/locale/brand.properties&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/suite/browser/tabbrowser.xml</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/suite/browser/tabbrowser.xml</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -739,17 +739,17 @@</span>
<a href="#l2.4"></a><span id="l2.4">             this.mContextTab = document.popupNode;</span>
<a href="#l2.5"></a><span id="l2.5">             var disabled = this.mTabs.length == 1;</span>
<a href="#l2.6"></a><span id="l2.6">             var menuItems = aPopupMenu.getElementsByAttribute(&quot;tbattr&quot;, &quot;tabbrowser-multiple&quot;);</span>
<a href="#l2.7"></a><span id="l2.7">             for (var i = 0; i &lt; menuItems.length; i++)</span>
<a href="#l2.8"></a><span id="l2.8">               menuItems[i].setAttribute(&quot;disabled&quot;, disabled);</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10">             var undoItem = document.getAnonymousElementByAttribute(this, &quot;tbattr&quot;, &quot;tabbrowser-undoclosetab&quot;);</span>
<a href="#l2.11"></a><span id="l2.11">             undoItem.setAttribute(&quot;disabled&quot;, this.savedBrowsers.length == 0);</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-            undoItem.hidden = this.mPrefs.getIntPref(&quot;browser.tabs.undoclose.depth&quot;) &lt;= 0;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+            undoItem.hidden = this.mPrefs.getIntPref(&quot;browser.sessionstore.max_tabs_undo&quot;) &lt;= 0;</span>
<a href="#l2.14"></a><span id="l2.14">           ]]&gt;</span>
<a href="#l2.15"></a><span id="l2.15">         &lt;/body&gt;</span>
<a href="#l2.16"></a><span id="l2.16">       &lt;/method&gt;</span>
<a href="#l2.17"></a><span id="l2.17"> </span>
<a href="#l2.18"></a><span id="l2.18">       &lt;method name=&quot;updateCurrentBrowser&quot;&gt;</span>
<a href="#l2.19"></a><span id="l2.19">         &lt;body&gt;</span>
<a href="#l2.20"></a><span id="l2.20">           &lt;![CDATA[</span>
<a href="#l2.21"></a><span id="l2.21">             // we only want to return to the parent tab if no other</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -1420,17 +1420,17 @@</span>
<a href="#l2.23"></a><span id="l2.23">               // We need to explicitly clear this, because updateCurrentBrowser</span>
<a href="#l2.24"></a><span id="l2.24">               // doesn't get called for a background tab</span>
<a href="#l2.25"></a><span id="l2.25">               this.mPreviousTab = null;</span>
<a href="#l2.26"></a><span id="l2.26">             }</span>
<a href="#l2.27"></a><span id="l2.27"> </span>
<a href="#l2.28"></a><span id="l2.28">             // Save the tab for undo.</span>
<a href="#l2.29"></a><span id="l2.29">             // Even though we navigate to about:blank, it costs more RAM than</span>
<a href="#l2.30"></a><span id="l2.30">             // really closing the tab.  The pref controls how far you can undo</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-            var maxUndoDepth = this.mPrefs.getIntPref(&quot;browser.tabs.undoclose.depth&quot;);</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+            var maxUndoDepth = this.mPrefs.getIntPref(&quot;browser.sessionstore.max_tabs_undo&quot;);</span>
<a href="#l2.33"></a><span id="l2.33">             var oldSH = oldBrowser.webNavigation.sessionHistory;</span>
<a href="#l2.34"></a><span id="l2.34">             var inOnLoad = oldBrowser.docShell.isExecutingOnLoadHandler;</span>
<a href="#l2.35"></a><span id="l2.35">             if (maxUndoDepth &lt;= 0 || oldSH.count == 0 || aDisableUndo || inOnLoad) {</span>
<a href="#l2.36"></a><span id="l2.36">               // Undo is disabled/tab is blank.  Kill the browser for real.</span>
<a href="#l2.37"></a><span id="l2.37">               // Because of the way XBL works (fields just set JS</span>
<a href="#l2.38"></a><span id="l2.38">               // properties on the element) and the code we have in place</span>
<a href="#l2.39"></a><span id="l2.39">               // to preserve the JS objects for any elements that have</span>
<a href="#l2.40"></a><span id="l2.40">               // JS properties set on them, the browser element won't be</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">new file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- /dev/null</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ b/suite/common/aboutSessionRestore.js</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -0,0 +1,328 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineplus">+ *</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+ *</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+ * License.</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+ *</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+ * The Original Code is the nsSessionStore component.</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+ *</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+ * Simon BÃ¼nzli &lt;zeniko@gmail.com&gt;</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+ *</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+ *</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+ *</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+var gStateObject;</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+var gTreeData;</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+// Page initialization</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+window.onload = function() {</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+  // the crashed session state is kept inside a textbox so that SessionStore picks it up</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+  // (for when the tab is closed or the session crashes right again)</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+  var sessionData = document.getElementById(&quot;sessionData&quot;);</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+  if (!sessionData.value) {</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+    var ss = Components.classes[&quot;@mozilla.org/suite/sessionstartup;1&quot;].getService(Components.interfaces.nsISessionStartup);</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+    sessionData.value = ss.state;</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+    if (!sessionData.value) {</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+      document.getElementById(&quot;errorTryAgain&quot;).disabled = true;</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+      return;</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+    }</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+  }</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+  // make sure the data is tracked to be restored in case of a subsequent crash</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+  var event = document.createEvent(&quot;UIEvents&quot;);</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+  event.initUIEvent(&quot;input&quot;, true, true, window, 0);</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+  sessionData.dispatchEvent(event);</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+  var s = new Components.utils.Sandbox(&quot;about:blank&quot;);</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+  gStateObject = Components.utils.evalInSandbox(&quot;(&quot; + sessionData.value + &quot;)&quot;, s);</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+  initTreeView();</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+  document.getElementById(&quot;errorTryAgain&quot;).focus();</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+};</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+function initTreeView() {</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+  var tabList = document.getElementById(&quot;tabList&quot;);</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+  var winLabel = tabList.getAttribute(&quot;_window_label&quot;);</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+  gTreeData = [];</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+  gStateObject.windows.forEach(function(aWinData, aIx) {</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+    var winState = {</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+      label: winLabel.replace(&quot;%S&quot;, (aIx + 1)),</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+      open: true,</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+      checked: true,</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+      ix: aIx</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+    };</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+    winState.tabs = aWinData.tabs.map(function(aTabData) {</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+      var entry = aTabData.entries[aTabData.index - 1] || { url: &quot;about:blank&quot; };</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+      var iconURL = aTabData.attributes &amp;&amp; aTabData.attributes.image || null;</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+      // don't initiate a connection just to fetch a favicon (see bug 462863)</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+      if (/^https?:/.test(iconURL))</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+        iconURL = &quot;moz-anno:favicon:&quot; + iconURL;</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+      return {</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+        label: entry.title || entry.url,</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+        checked: true,</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+        src: iconURL,</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+        parent: winState</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+      };</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineplus">+    });</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+    gTreeData.push(winState);</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+    for each (var tab in winState.tabs)</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineplus">+      gTreeData.push(tab);</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+  }, this);</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineplus">+  tabList.view = treeView;</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+  tabList.view.selection.select(0);</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+}</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineplus">+// User actions</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineplus">+</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineplus">+function restoreSession() {</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+  document.getElementById(&quot;errorTryAgain&quot;).disabled = true;</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineplus">+</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineplus">+  // remove all unselected tabs from the state before restoring it</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineplus">+  var ix = gStateObject.windows.length - 1;</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineplus">+  for (var t = gTreeData.length - 1; t &gt;= 0; t--) {</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineplus">+    if (treeView.isContainer(t)) {</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineplus">+      if (gTreeData[t].checked === 0)</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineplus">+        // this window will be restored partially</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+        gStateObject.windows[ix].tabs =</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineplus">+          gStateObject.windows[ix].tabs.filter(function(aTabData, aIx)</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineplus">+                                                 gTreeData[t].tabs[aIx].checked);</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineplus">+      else if (!gTreeData[t].checked)</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineplus">+        // this window won't be restored at all</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineplus">+        gStateObject.windows.splice(ix, 1);</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineplus">+      ix--;</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineplus">+    }</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineplus">+  }</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineplus">+  var stateString = gStateObject.toSource();</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineplus">+</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineplus">+  var ss = Components.classes[&quot;@mozilla.org/suite/sessionstore;1&quot;].getService(Components.interfaces.nsISessionStore);</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineplus">+  var top = getBrowserWindow();</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineplus">+</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineplus">+  // if there's only this page open, reuse the window for restoring the session</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineplus">+  if (top.gBrowser.tabContainer.childNodes.length == 1) {</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineplus">+    ss.setWindowState(top, stateString, true);</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineplus">+    return;</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineplus">+  }</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineplus">+</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineplus">+  // restore the session into a new window and close the current tab</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineplus">+  var newWindow = top.openDialog(top.location, &quot;_blank&quot;, &quot;chrome,dialog=no,all&quot;, &quot;about:blank&quot;);</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineplus">+  var tab = top.gBrowser.selectedTab;</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineplus">+  newWindow.addEventListener(&quot;load&quot;, function() {</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineplus">+    newWindow.removeEventListener(&quot;load&quot;, arguments.callee, true);</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineplus">+    ss.setWindowState(newWindow, stateString, true);</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineplus">+</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineplus">+    top.gBrowser.removeTab(tab);</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineplus">+  }, true);</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineplus">+}</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineplus">+</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineplus">+function startNewSession() {</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineplus">+  getBrowserWindow().BrowserHome();</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineplus">+}</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineplus">+</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineplus">+function onListClick(aEvent) {</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineplus">+  // don't react to right-clicks</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineplus">+  if (aEvent.button == 2)</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineplus">+    return;</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineplus">+</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineplus">+  var row = {}, col = {};</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineplus">+  treeView.treeBox.getCellAt(aEvent.clientX, aEvent.clientY, row, col, {});</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineplus">+  if (col.value) {</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineplus">+    // restore this specific tab in the same window for middle-clicking</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineplus">+    // or Ctrl+clicking on a tab's title</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineplus">+    if ((aEvent.button == 1 || aEvent.ctrlKey) &amp;&amp; col.value.id == &quot;title&quot; &amp;&amp;</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineplus">+        !treeView.isContainer(row.value))</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineplus">+      restoreSingleTab(row.value, aEvent.shiftKey);</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineplus">+    else if (col.value.id == &quot;restore&quot;)</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineplus">+      toggleRowChecked(row.value);</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineplus">+  }</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineplus">+}</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineplus">+</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineplus">+function onListKeyDown(aEvent) {</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineplus">+  switch (aEvent.keyCode)</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineplus">+  {</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineplus">+  case KeyEvent.DOM_VK_SPACE:</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineplus">+    toggleRowChecked(document.getElementById(&quot;tabList&quot;).currentIndex);</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineplus">+    break;</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineplus">+  case KeyEvent.DOM_VK_RETURN:</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineplus">+    var ix = document.getElementById(&quot;tabList&quot;).currentIndex;</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineplus">+    if (aEvent.ctrlKey &amp;&amp; !treeView.isContainer(ix))</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineplus">+      restoreSingleTab(ix, aEvent.shiftKey);</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineplus">+    break;</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineplus">+  case KeyEvent.DOM_VK_UP:</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineplus">+  case KeyEvent.DOM_VK_DOWN:</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineplus">+  case KeyEvent.DOM_VK_PAGE_UP:</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineplus">+  case KeyEvent.DOM_VK_PAGE_DOWN:</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineplus">+  case KeyEvent.DOM_VK_HOME:</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineplus">+  case KeyEvent.DOM_VK_END:</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineplus">+    aEvent.preventDefault(); // else the page scrolls unwantedly</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineplus">+    break;</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineplus">+  }</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineplus">+}</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineplus">+</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineplus">+// Helper functions</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineplus">+</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineplus">+function getBrowserWindow() {</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineplus">+  return window.QueryInterface(Components.interfaces.nsIInterfaceRequestor).getInterface(Components.interfaces.nsIWebNavigation)</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineplus">+               .QueryInterface(Components.interfaces.nsIDocShellTreeItem).rootTreeItem</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineplus">+               .QueryInterface(Components.interfaces.nsIInterfaceRequestor).getInterface(Components.interfaces.nsIDOMWindow);</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineplus">+}</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineplus">+</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineplus">+function toggleRowChecked(aIx) {</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineplus">+  var item = gTreeData[aIx];</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineplus">+  item.checked = !item.checked;</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineplus">+  treeView.treeBox.invalidateRow(aIx);</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineplus">+</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineplus">+  function isChecked(aItem) aItem.checked;</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineplus">+</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineplus">+  if (treeView.isContainer(aIx)) {</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineplus">+    // (un)check all tabs of this window as well</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineplus">+    for each (var tab in item.tabs) {</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineplus">+      tab.checked = item.checked;</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineplus">+      treeView.treeBox.invalidateRow(gTreeData.indexOf(tab));</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineplus">+    }</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineplus">+  }</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineplus">+  else {</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineplus">+    // update the window's checkmark as well (0 means &quot;partially checked&quot;)</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineplus">+    item.parent.checked = item.parent.tabs.every(isChecked) ? true :</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineplus">+                          item.parent.tabs.some(isChecked) ? 0 : false;</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineplus">+    treeView.treeBox.invalidateRow(gTreeData.indexOf(item.parent));</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineplus">+  }</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineplus">+</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineplus">+  document.getElementById(&quot;errorTryAgain&quot;).disabled = !gTreeData.some(isChecked);</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineplus">+}</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineplus">+</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineplus">+function restoreSingleTab(aIx, aShifted) {</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineplus">+  var tabbrowser = getBrowserWindow().gBrowser;</span>
<a href="#l3.225"></a><span id="l3.225" class="difflineplus">+  var newTab = tabbrowser.addTab();</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineplus">+  var item = gTreeData[aIx];</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineplus">+</span>
<a href="#l3.228"></a><span id="l3.228" class="difflineplus">+  var ss = Components.classes[&quot;@mozilla.org/suite/sessionstore;1&quot;].getService(Components.interfaces.nsISessionStore);</span>
<a href="#l3.229"></a><span id="l3.229" class="difflineplus">+  var tabState = gStateObject.windows[item.parent.ix]</span>
<a href="#l3.230"></a><span id="l3.230" class="difflineplus">+                             .tabs[aIx - gTreeData.indexOf(item.parent) - 1];</span>
<a href="#l3.231"></a><span id="l3.231" class="difflineplus">+  ss.setTabState(newTab, tabState.toSource());</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineplus">+</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineplus">+  // respect the preference as to whether to select the tab (the Shift key inverses)</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineplus">+  var prefBranch = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;].getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineplus">+  if (prefBranch.getBoolPref(&quot;browser.tabs.loadInBackground&quot;) != !aShifted)</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineplus">+    tabbrowser.selectedTab = newTab;</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineplus">+}</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineplus">+</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineplus">+// Tree controller</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineplus">+</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineplus">+var treeView = {</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineplus">+  _atoms: {},</span>
<a href="#l3.243"></a><span id="l3.243" class="difflineplus">+  _getAtom: function(aName)</span>
<a href="#l3.244"></a><span id="l3.244" class="difflineplus">+  {</span>
<a href="#l3.245"></a><span id="l3.245" class="difflineplus">+    if (!this._atoms[aName]) {</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineplus">+      var as = Components.classes[&quot;@mozilla.org/atom-service;1&quot;].getService(Components.interfaces.nsIAtomService);</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineplus">+      this._atoms[aName] = as.getAtom(aName);</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineplus">+    }</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineplus">+    return this._atoms[aName];</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineplus">+  },</span>
<a href="#l3.251"></a><span id="l3.251" class="difflineplus">+</span>
<a href="#l3.252"></a><span id="l3.252" class="difflineplus">+  treeBox: null,</span>
<a href="#l3.253"></a><span id="l3.253" class="difflineplus">+  selection: null,</span>
<a href="#l3.254"></a><span id="l3.254" class="difflineplus">+</span>
<a href="#l3.255"></a><span id="l3.255" class="difflineplus">+  get rowCount()                     { return gTreeData.length; },</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineplus">+  setTree: function(treeBox)         { this.treeBox = treeBox; },</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineplus">+  getCellText: function(idx, column) { return gTreeData[idx].label; },</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineplus">+  isContainer: function(idx)         { return &quot;open&quot; in gTreeData[idx]; },</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineplus">+  getCellValue: function(idx, column){ return gTreeData[idx].checked; },</span>
<a href="#l3.260"></a><span id="l3.260" class="difflineplus">+  isContainerOpen: function(idx)     { return gTreeData[idx].open; },</span>
<a href="#l3.261"></a><span id="l3.261" class="difflineplus">+  isContainerEmpty: function(idx)    { return false; },</span>
<a href="#l3.262"></a><span id="l3.262" class="difflineplus">+  isSeparator: function(idx)         { return false; },</span>
<a href="#l3.263"></a><span id="l3.263" class="difflineplus">+  isSorted: function()               { return false; },</span>
<a href="#l3.264"></a><span id="l3.264" class="difflineplus">+  isEditable: function(idx, column)  { return false; },</span>
<a href="#l3.265"></a><span id="l3.265" class="difflineplus">+  getLevel: function(idx)            { return this.isContainer(idx) ? 0 : 1; },</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineplus">+</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineplus">+  getParentIndex: function(idx) {</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineplus">+    if (!this.isContainer(idx))</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineplus">+      for (var t = idx - 1; t &gt;= 0 ; t--)</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineplus">+        if (this.isContainer(t))</span>
<a href="#l3.271"></a><span id="l3.271" class="difflineplus">+          return t;</span>
<a href="#l3.272"></a><span id="l3.272" class="difflineplus">+    return -1;</span>
<a href="#l3.273"></a><span id="l3.273" class="difflineplus">+  },</span>
<a href="#l3.274"></a><span id="l3.274" class="difflineplus">+</span>
<a href="#l3.275"></a><span id="l3.275" class="difflineplus">+  hasNextSibling: function(idx, after) {</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineplus">+    var thisLevel = this.getLevel(idx);</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineplus">+    for (var t = after + 1; t &lt; gTreeData.length; t++)</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineplus">+      if (this.getLevel(t) &lt;= thisLevel)</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineplus">+        return this.getLevel(t) == thisLevel;</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineplus">+    return false;</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineplus">+  },</span>
<a href="#l3.282"></a><span id="l3.282" class="difflineplus">+</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineplus">+  toggleOpenState: function(idx) {</span>
<a href="#l3.284"></a><span id="l3.284" class="difflineplus">+    if (!this.isContainer(idx))</span>
<a href="#l3.285"></a><span id="l3.285" class="difflineplus">+      return;</span>
<a href="#l3.286"></a><span id="l3.286" class="difflineplus">+    var item = gTreeData[idx];</span>
<a href="#l3.287"></a><span id="l3.287" class="difflineplus">+    if (item.open) {</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineplus">+      // remove this window's tab rows from the view</span>
<a href="#l3.289"></a><span id="l3.289" class="difflineplus">+      var thisLevel = this.getLevel(idx);</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineplus">+      for (var t = idx + 1; t &lt; gTreeData.length &amp;&amp; this.getLevel(t) &gt; thisLevel; t++);</span>
<a href="#l3.291"></a><span id="l3.291" class="difflineplus">+      var deletecount = t - idx - 1;</span>
<a href="#l3.292"></a><span id="l3.292" class="difflineplus">+      gTreeData.splice(idx + 1, deletecount);</span>
<a href="#l3.293"></a><span id="l3.293" class="difflineplus">+      this.treeBox.rowCountChanged(idx + 1, -deletecount);</span>
<a href="#l3.294"></a><span id="l3.294" class="difflineplus">+    }</span>
<a href="#l3.295"></a><span id="l3.295" class="difflineplus">+    else {</span>
<a href="#l3.296"></a><span id="l3.296" class="difflineplus">+      // add this window's tab rows to the view</span>
<a href="#l3.297"></a><span id="l3.297" class="difflineplus">+      var toinsert = gTreeData[idx].tabs;</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineplus">+      for (var i = 0; i &lt; toinsert.length; i++)</span>
<a href="#l3.299"></a><span id="l3.299" class="difflineplus">+        gTreeData.splice(idx + i + 1, 0, toinsert[i]);</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineplus">+      this.treeBox.rowCountChanged(idx + 1, toinsert.length);</span>
<a href="#l3.301"></a><span id="l3.301" class="difflineplus">+    }</span>
<a href="#l3.302"></a><span id="l3.302" class="difflineplus">+    item.open = !item.open;</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineplus">+    this.treeBox.invalidateRow(idx);</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineplus">+  },</span>
<a href="#l3.305"></a><span id="l3.305" class="difflineplus">+</span>
<a href="#l3.306"></a><span id="l3.306" class="difflineplus">+  getCellProperties: function(idx, column, prop) {</span>
<a href="#l3.307"></a><span id="l3.307" class="difflineplus">+    if (column.id == &quot;restore&quot; &amp;&amp; this.isContainer(idx) &amp;&amp; gTreeData[idx].checked === 0)</span>
<a href="#l3.308"></a><span id="l3.308" class="difflineplus">+      prop.AppendElement(this._getAtom(&quot;partial&quot;));</span>
<a href="#l3.309"></a><span id="l3.309" class="difflineplus">+    if (column.id == &quot;title&quot;)</span>
<a href="#l3.310"></a><span id="l3.310" class="difflineplus">+      prop.AppendElement(this._getAtom(this.getImageSrc(idx, column) ? &quot;icon&quot; : &quot;noicon&quot;));</span>
<a href="#l3.311"></a><span id="l3.311" class="difflineplus">+  },</span>
<a href="#l3.312"></a><span id="l3.312" class="difflineplus">+</span>
<a href="#l3.313"></a><span id="l3.313" class="difflineplus">+  getRowProperties: function(idx, prop) {</span>
<a href="#l3.314"></a><span id="l3.314" class="difflineplus">+    var winState = gTreeData[idx].parent || gTreeData[idx];</span>
<a href="#l3.315"></a><span id="l3.315" class="difflineplus">+    if (winState.ix % 2 != 0)</span>
<a href="#l3.316"></a><span id="l3.316" class="difflineplus">+      prop.AppendElement(this._getAtom(&quot;alternate&quot;));</span>
<a href="#l3.317"></a><span id="l3.317" class="difflineplus">+  },</span>
<a href="#l3.318"></a><span id="l3.318" class="difflineplus">+</span>
<a href="#l3.319"></a><span id="l3.319" class="difflineplus">+  getImageSrc: function(idx, column) {</span>
<a href="#l3.320"></a><span id="l3.320" class="difflineplus">+    if (column.id == &quot;title&quot;)</span>
<a href="#l3.321"></a><span id="l3.321" class="difflineplus">+      return gTreeData[idx].src || null;</span>
<a href="#l3.322"></a><span id="l3.322" class="difflineplus">+    return null;</span>
<a href="#l3.323"></a><span id="l3.323" class="difflineplus">+  },</span>
<a href="#l3.324"></a><span id="l3.324" class="difflineplus">+</span>
<a href="#l3.325"></a><span id="l3.325" class="difflineplus">+  getProgressMode : function(idx, column) { },</span>
<a href="#l3.326"></a><span id="l3.326" class="difflineplus">+  cycleHeader: function(column) { },</span>
<a href="#l3.327"></a><span id="l3.327" class="difflineplus">+  cycleCell: function(idx, column) { },</span>
<a href="#l3.328"></a><span id="l3.328" class="difflineplus">+  selectionChanged: function() { },</span>
<a href="#l3.329"></a><span id="l3.329" class="difflineplus">+  performAction: function(action) { },</span>
<a href="#l3.330"></a><span id="l3.330" class="difflineplus">+  performActionOnCell: function(action, index, column) { },</span>
<a href="#l3.331"></a><span id="l3.331" class="difflineplus">+  getColumnProperties: function(column, prop) { }</span>
<a href="#l3.332"></a><span id="l3.332" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">new file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- /dev/null</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ b/suite/common/aboutSessionRestore.xhtml</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -0,0 +1,119 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineplus">+&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineplus">+&lt;!--</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineplus">+# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineplus">+# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+#</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+# the License. You may obtain a copy of the License at</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+# http://www.mozilla.org/MPL/</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+#</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+# for the specific language governing rights and limitations under the</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+# License.</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+#</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+# The Original Code is the nsSessionStore component.</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+#</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+# The Initial Developer of the Original Code is</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+# Simon BÃ¼nzli &lt;zeniko@gmail.com&gt;</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+# Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+# the Initial Developer. All Rights Reserved.</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+#</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+# Contributor(s):</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+#</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+# either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+# the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+# the provisions above, a recipient may use your version of this file under</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+#</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+# ***** END LICENSE BLOCK *****</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+--&gt;</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+&lt;!DOCTYPE html [</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+&lt;!ENTITY % brandDTD SYSTEM &quot;chrome://branding/locale/brand.dtd&quot; &gt;</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+  %brandDTD;</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+  &lt;!ENTITY % htmlDTD PUBLIC &quot;-//W3C//DTD XHTML 1.0 Strict//EN&quot; &quot;DTD/xhtml1-strict.dtd&quot;&gt;</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+  %htmlDTD;</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+  &lt;!ENTITY % netErrorDTD SYSTEM &quot;chrome://global/locale/netError.dtd&quot;&gt;</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+  %netErrorDTD;</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+  &lt;!ENTITY % globalDTD SYSTEM &quot;chrome://global/locale/global.dtd&quot;&gt;</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+  %globalDTD;</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+  &lt;!ENTITY % restorepageDTD SYSTEM &quot;chrome://communicator/locale/aboutSessionRestore.dtd&quot;&gt;</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+  %restorepageDTD;</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+]&gt;</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+  &lt;head&gt;</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+    &lt;title&gt;&amp;restorepage.tabtitle;&lt;/title&gt;</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+    &lt;link rel=&quot;stylesheet&quot; href=&quot;chrome://global/skin/netError.css&quot; type=&quot;text/css&quot; media=&quot;all&quot;/&gt;</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+    &lt;link rel=&quot;stylesheet&quot; href=&quot;chrome://communicator/skin/aboutSessionRestore.css&quot; type=&quot;text/css&quot; media=&quot;all&quot;/&gt;</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+    &lt;link rel=&quot;icon&quot; type=&quot;image/png&quot; href=&quot;chrome://global/skin/icons/question-16.png&quot;/&gt;</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+    &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://communicator/content/aboutSessionRestore.js&quot;/&gt;</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+  &lt;/head&gt;</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+  &lt;body dir=&quot;&amp;locale.dir;&quot;&gt;</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+    &lt;!-- PAGE CONTAINER (for styling purposes only) --&gt;</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+    &lt;div id=&quot;errorPageContainer&quot;&gt;</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+      &lt;!-- Error Title --&gt;</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+      &lt;div id=&quot;errorTitle&quot;&gt;</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+        &lt;h1 id=&quot;errorTitleText&quot;&gt;&amp;restorepage.pagetitle;&lt;/h1&gt;</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+      &lt;/div&gt;</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+      &lt;!-- LONG CONTENT (the section most likely to require scrolling) --&gt;</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+      &lt;div id=&quot;errorLongContent&quot;&gt;</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+        &lt;!-- Short Description --&gt;</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+        &lt;div id=&quot;errorShortDesc&quot;&gt;</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+          &lt;p id=&quot;errorShortDescText&quot;&gt;&amp;restorepage.issueDesc;&lt;/p&gt;</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+        &lt;/div&gt;</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+        &lt;!-- Long Description (Note: See netError.dtd for used XHTML tags) --&gt;</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+        &lt;div id=&quot;errorLongDesc&quot;&gt;</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+          &lt;p&gt;&amp;restorepage.remedies;&lt;/p&gt;</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+          &lt;ul&gt;</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+            &lt;li&gt;&amp;restorepage.dueToChrome;&lt;/li&gt;</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+            &lt;li&gt;&amp;restorepage.dueToContent;&lt;/li&gt;</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+          &lt;/ul&gt;</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+        &lt;/div&gt;</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+        &lt;!-- Short Description --&gt;</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+        &lt;div id=&quot;errorTrailerDesc&quot;&gt;</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+          &lt;tree xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+                id=&quot;tabList&quot; flex=&quot;1&quot; seltype=&quot;single&quot; hidecolumnpicker=&quot;true&quot;</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+                onclick=&quot;onListClick(event);&quot; onkeydown=&quot;onListKeyDown(event);&quot;</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+                _window_label=&quot;&amp;restorepage.windowLabel;&quot;&gt;</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+            &lt;treecols&gt;</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+              &lt;treecol id=&quot;restore&quot; type=&quot;checkbox&quot; label=&quot;&amp;restorepage.restoreHeader;&quot;/&gt;</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+              &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+              &lt;treecol primary=&quot;true&quot; id=&quot;title&quot; label=&quot;&amp;restorepage.listHeader;&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+            &lt;/treecols&gt;</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+            &lt;treechildren flex=&quot;1&quot;/&gt;</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+          &lt;/tree&gt;</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+        &lt;/div&gt;</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+      &lt;/div&gt;</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+      &lt;!-- Buttons --&gt;</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+      &lt;hbox xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot; id=&quot;buttons&quot;&gt;</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineplus">+        &lt;button id=&quot;errorTryAgain&quot; label=&quot;&amp;restorepage.restoreButton;&quot;</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+                accesskey=&quot;&amp;restorepage.restore.access;&quot;</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+                oncommand=&quot;restoreSession();&quot;/&gt;</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+        &lt;button id=&quot;errorCancel&quot; label=&quot;&amp;restorepage.cancelButton;&quot;</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineplus">+                accesskey=&quot;&amp;restorepage.cancel.access;&quot;</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+                oncommand=&quot;startNewSession();&quot;/&gt;</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+      &lt;/hbox&gt;</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+      &lt;!-- holds the session data for when the tab is closed --&gt;</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+      &lt;input type=&quot;text&quot; id=&quot;sessionData&quot; style=&quot;display: none;&quot;/&gt;</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineplus">+    &lt;/div&gt;</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineplus">+</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineplus">+  &lt;/body&gt;</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineplus">+&lt;/html&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/suite/common/jar.mn</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/suite/common/jar.mn</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -41,16 +41,18 @@ comm.jar:</span>
<a href="#l5.4"></a><span id="l5.4"> % overlay chrome://messenger/content/msgSelectOffline.xul chrome://communicator/content/helpMessengerOverlay.xul</span>
<a href="#l5.5"></a><span id="l5.5"> % overlay chrome://messenger/content/subscribe.xul chrome://communicator/content/helpMessengerOverlay.xul</span>
<a href="#l5.6"></a><span id="l5.6"> % overlay chrome://messenger/content/mailViewList.xul chrome://communicator/content/helpMessengerOverlay.xul</span>
<a href="#l5.7"></a><span id="l5.7"> % overlay chrome://messenger/content/mailViewSetup.xul chrome://communicator/content/helpMessengerOverlay.xul</span>
<a href="#l5.8"></a><span id="l5.8"> % overlay chrome://messenger-smime/content/msgCompSecurityInfo.xul chrome://communicator/content/helpMessengerOverlay.xul</span>
<a href="#l5.9"></a><span id="l5.9"> % overlay chrome://messenger-smime/content/msgReadSecurityInfo.xul chrome://communicator/content/helpMessengerOverlay.xul</span>
<a href="#l5.10"></a><span id="l5.10"> % content communicator-platform %content/communicator-platform/ platform xpcnativewrappers=yes</span>
<a href="#l5.11"></a><span id="l5.11"> % content communicator-region %content/communicator-region/ xpcnativewrappers=yes</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+   content/communicator/aboutSessionRestore.js</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+   content/communicator/aboutSessionRestore.xhtml</span>
<a href="#l5.14"></a><span id="l5.14">    content/communicator/askViewZoom.xul</span>
<a href="#l5.15"></a><span id="l5.15">    content/communicator/askViewZoom.js</span>
<a href="#l5.16"></a><span id="l5.16">    content/communicator/browserBindings.xul</span>
<a href="#l5.17"></a><span id="l5.17">    content/communicator/certError.xhtml</span>
<a href="#l5.18"></a><span id="l5.18">    content/communicator/communicator.css</span>
<a href="#l5.19"></a><span id="l5.19">    content/communicator/consoleOverlay.xul</span>
<a href="#l5.20"></a><span id="l5.20">    content/communicator/contentAreaUtils.js</span>
<a href="#l5.21"></a><span id="l5.21">    content/communicator/contentAreaDD.js</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/suite/common/src/Makefile.in</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/suite/common/src/Makefile.in</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -41,15 +41,16 @@ srcdir		= @srcdir@</span>
<a href="#l6.4"></a><span id="l6.4"> VPATH		= @srcdir@</span>
<a href="#l6.5"></a><span id="l6.5"> </span>
<a href="#l6.6"></a><span id="l6.6"> include $(DEPTH)/config/autoconf.mk</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8"> MODULE		= suitecommon</span>
<a href="#l6.9"></a><span id="l6.9"> </span>
<a href="#l6.10"></a><span id="l6.10"> EXTRA_COMPONENTS = \</span>
<a href="#l6.11"></a><span id="l6.11"> 	nsAboutCertError.js \</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+	nsAboutSessionRestore.js \</span>
<a href="#l6.13"></a><span id="l6.13"> 	nsSessionStartup.js \</span>
<a href="#l6.14"></a><span id="l6.14"> 	nsSessionStore.js \</span>
<a href="#l6.15"></a><span id="l6.15"> 	nsSuiteGlue.js \</span>
<a href="#l6.16"></a><span id="l6.16"> 	$(NULL)</span>
<a href="#l6.17"></a><span id="l6.17"> </span>
<a href="#l6.18"></a><span id="l6.18"> include $(topsrcdir)/config/rules.mk</span>
<a href="#l6.19"></a><span id="l6.19"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">new file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- /dev/null</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ b/suite/common/src/nsAboutSessionRestore.js</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -0,0 +1,61 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineplus">+ *</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+ *</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+ * License.</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+ *</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+ * The Original Code is the nsSessionStore component.</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+ *</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+ * Simon BÃ¼nzli &lt;zeniko@gmail.com&gt;</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+ *</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+ *</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+ *</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+function AboutSessionRestore() { }</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+AboutSessionRestore.prototype = {</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+  classDescription: &quot;about:sessionrestore&quot;,</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+  contractID: &quot;@mozilla.org/network/protocol/about;1?what=sessionrestore&quot;,</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+  classID: Components.ID(&quot;{a03c813e-abe8-41de-8d0c-5aa85f877696}&quot;),</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+  QueryInterface: XPCOMUtils.generateQI([Components.interfaces.nsIAboutModule]),</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+  getURIFlags: function(aURI) {</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+    return Components.interfaces.nsIAboutModule.ALLOW_SCRIPT;</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+  },</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+  newChannel: function(aURI) {</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+    let ios = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;].getService(Components.interfaces.nsIIOService);</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+    let channel = ios.newChannel(&quot;chrome://communicator/content/aboutSessionRestore.xhtml&quot;,</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+                                 null, null);</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+    channel.originalURI = aURI;</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+    return channel;</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+  }</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+};</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+function NSGetModule(compMgr, fileSpec) {</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+  return XPCOMUtils.generateModule([AboutSessionRestore]);</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/suite/common/src/nsSessionStartup.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/suite/common/src/nsSessionStartup.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -85,31 +85,31 @@ SessionStartup.prototype = {</span>
<a href="#l8.4"></a><span id="l8.4">   _sessionType: Components.interfaces.nsISessionStartup.NO_SESSION,</span>
<a href="#l8.5"></a><span id="l8.5"> </span>
<a href="#l8.6"></a><span id="l8.6"> /* ........ Global Event Handlers .............. */</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8">   /**</span>
<a href="#l8.9"></a><span id="l8.9">    * Initialize the component</span>
<a href="#l8.10"></a><span id="l8.10">    */</span>
<a href="#l8.11"></a><span id="l8.11">   init: function sss_init() {</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-    this._prefBranch = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-                                 .getService(Components.interfaces.nsIPrefService)</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-                                 .getBranch(&quot;browser.&quot;);</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+    let prefBranch = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+                               .getService(Components.interfaces.nsIPrefService)</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+                               .getBranch(&quot;browser.&quot;);</span>
<a href="#l8.18"></a><span id="l8.18"> </span>
<a href="#l8.19"></a><span id="l8.19">     // get file references</span>
<a href="#l8.20"></a><span id="l8.20">     var dirService = Components.classes[&quot;@mozilla.org/file/directory_service;1&quot;]</span>
<a href="#l8.21"></a><span id="l8.21">                                .getService(Components.interfaces.nsIProperties);</span>
<a href="#l8.22"></a><span id="l8.22">     let sessionFile = dirService.get(&quot;ProfD&quot;, Components.interfaces.nsILocalFile);</span>
<a href="#l8.23"></a><span id="l8.23">     sessionFile.append(&quot;sessionstore.js&quot;);</span>
<a href="#l8.24"></a><span id="l8.24"> </span>
<a href="#l8.25"></a><span id="l8.25" class="difflineminus">-    let doResumeSession = this._prefBranch.getBoolPref(&quot;sessionstore.resume_session_once&quot;) ||</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineminus">-                          this._prefBranch.getIntPref(&quot;startup.page&quot;) == 3;</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+    let doResumeSession = prefBranch.getBoolPref(&quot;sessionstore.resume_session_once&quot;) ||</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+                          prefBranch.getIntPref(&quot;startup.page&quot;) == 3;</span>
<a href="#l8.29"></a><span id="l8.29"> </span>
<a href="#l8.30"></a><span id="l8.30">     // only read the session file if config allows possibility of restoring</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-    var resumeFromCrash = this._prefBranch.getBoolPref(&quot;sessionstore.resume_from_crash&quot;);</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+    var resumeFromCrash = prefBranch.getBoolPref(&quot;sessionstore.resume_from_crash&quot;);</span>
<a href="#l8.33"></a><span id="l8.33">     if ((!resumeFromCrash &amp;&amp; !doResumeSession) || !sessionFile.exists())</span>
<a href="#l8.34"></a><span id="l8.34">       return;</span>
<a href="#l8.35"></a><span id="l8.35"> </span>
<a href="#l8.36"></a><span id="l8.36">     // get string containing session state</span>
<a href="#l8.37"></a><span id="l8.37">     this._iniString = this._readStateFile(sessionFile);</span>
<a href="#l8.38"></a><span id="l8.38">     if (!this._iniString)</span>
<a href="#l8.39"></a><span id="l8.39">       return;</span>
<a href="#l8.40"></a><span id="l8.40"> </span>
<a href="#l8.41"></a><span id="l8.41" class="difflineat">@@ -125,17 +125,17 @@ SessionStartup.prototype = {</span>
<a href="#l8.42"></a><span id="l8.42">       debug(&quot;The session file is invalid: &quot; + ex);</span>
<a href="#l8.43"></a><span id="l8.43">     }</span>
<a href="#l8.44"></a><span id="l8.44"> </span>
<a href="#l8.45"></a><span id="l8.45">     let lastSessionCrashed =</span>
<a href="#l8.46"></a><span id="l8.46">       initialState &amp;&amp; initialState.session &amp;&amp; initialState.session.state &amp;&amp;</span>
<a href="#l8.47"></a><span id="l8.47">       initialState.session.state == STATE_RUNNING_STR;</span>
<a href="#l8.48"></a><span id="l8.48"> </span>
<a href="#l8.49"></a><span id="l8.49">     // set the startup type</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">-    if (lastSessionCrashed &amp;&amp; resumeFromCrash &amp;&amp; this._doRecoverSession())</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+    if (lastSessionCrashed &amp;&amp; resumeFromCrash)</span>
<a href="#l8.52"></a><span id="l8.52">       this._sessionType = Components.interfaces.nsISessionStartup.RECOVER_SESSION;</span>
<a href="#l8.53"></a><span id="l8.53">     else if (!lastSessionCrashed &amp;&amp; doResumeSession)</span>
<a href="#l8.54"></a><span id="l8.54">       this._sessionType = Components.interfaces.nsISessionStartup.RESUME_SESSION;</span>
<a href="#l8.55"></a><span id="l8.55">     else</span>
<a href="#l8.56"></a><span id="l8.56">       this._iniString = null; // reset the state string</span>
<a href="#l8.57"></a><span id="l8.57"> </span>
<a href="#l8.58"></a><span id="l8.58">     if (this._sessionType != Components.interfaces.nsISessionStartup.NO_SESSION) {</span>
<a href="#l8.59"></a><span id="l8.59">       // wait for the first browser window to open</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineat">@@ -196,88 +196,16 @@ SessionStartup.prototype = {</span>
<a href="#l8.61"></a><span id="l8.61"> </span>
<a href="#l8.62"></a><span id="l8.62">   /**</span>
<a href="#l8.63"></a><span id="l8.63">    * Get the type of pending session store, if any.</span>
<a href="#l8.64"></a><span id="l8.64">    */</span>
<a href="#l8.65"></a><span id="l8.65">   get sessionType() {</span>
<a href="#l8.66"></a><span id="l8.66">     return this._sessionType;</span>
<a href="#l8.67"></a><span id="l8.67">   },</span>
<a href="#l8.68"></a><span id="l8.68"> </span>
<a href="#l8.69"></a><span id="l8.69" class="difflineminus">-/* ........ Auxiliary Functions .............. */</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineminus">-</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineminus">-  /**</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineminus">-   * prompt user whether or not to restore the previous session,</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineminus">-   * if the browser crashed</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineminus">-   * @returns bool</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineminus">-   */</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineminus">-  _doRecoverSession: function sss_doRecoverSession() {</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineminus">-    // if the prompt fails, recover anyway</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineminus">-    var recover = true;</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineminus">-</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineminus">-    // allow extensions to hook in a more elaborate restore prompt</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineminus">-    // XXXzeniko drop this when we're using our own dialog instead of a standard prompt</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineminus">-    var dialogURI = null;</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineminus">-    try {</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineminus">-      dialogURI = this._prefBranch.getCharPref(&quot;sessionstore.restore_prompt_uri&quot;);</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineminus">-    }</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineminus">-    catch (ex) { }</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineminus">-</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineminus">-    try {</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineminus">-      if (dialogURI) { // extension provided dialog</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineminus">-        var params = Components.classes[&quot;@mozilla.org/embedcomp/dialogparam;1&quot;]</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineminus">-                               .createInstance(Components.interfaces.nsIDialogParamBlock);</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineminus">-        // default to recovering</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineminus">-        params.SetInt(0, 0);</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineminus">-        Components.classes[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineminus">-                  .getService(Components.interfaces.nsIWindowWatcher)</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineminus">-                  .openWindow(null, dialogURI, &quot;_blank&quot;, &quot;chrome,modal,centerscreen,titlebar&quot;, params);</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineminus">-        recover = params.GetInt(0) == 0;</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineminus">-      }</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineminus">-      else { // basic prompt with no options</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineminus">-        // get app name from branding properties</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineminus">-        var brandStringBundle = this._getStringBundle(&quot;chrome://branding/locale/brand.properties&quot;);</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineminus">-        var brandShortName = brandStringBundle.GetStringFromName(&quot;brandShortName&quot;);</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineminus">-</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineminus">-        // create prompt strings</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineminus">-        var ssStringBundle = this._getStringBundle(&quot;chrome://communicator/locale/sessionstore.properties&quot;);</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineminus">-        var restoreTitle = ssStringBundle.formatStringFromName(&quot;restoredTitle&quot;, [brandShortName], 1);</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineminus">-        var restoreText = ssStringBundle.formatStringFromName(&quot;restoredMsg&quot;, [brandShortName], 1);</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineminus">-        var okTitle = ssStringBundle.GetStringFromName(&quot;okTitle&quot;);</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineminus">-        var cancelTitle = ssStringBundle.GetStringFromName(&quot;cancelTitle&quot;);</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineminus">-</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineminus">-        var promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineminus">-                                      .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineminus">-</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineminus">-        // set the buttons that will appear on the dialog</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineminus">-        var flags = promptService.BUTTON_TITLE_IS_STRING * promptService.BUTTON_POS_0 +</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineminus">-                    promptService.BUTTON_TITLE_IS_STRING * promptService.BUTTON_POS_1 +</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineminus">-                    promptService.BUTTON_POS_0_DEFAULT;</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineminus">-        var buttonChoice = promptService.confirmEx(null, restoreTitle, restoreText,</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineminus">-                                          flags, okTitle, cancelTitle, null,</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineminus">-                                          null, {});</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineminus">-        recover = (buttonChoice == 0);</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineminus">-      }</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineminus">-    }</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineminus">-    catch (ex) { dump(ex + &quot;\n&quot;); } // if the prompt fails, recover anyway</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineminus">-    return recover;</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineminus">-  },</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineminus">-</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineminus">-  /**</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineminus">-   * Convenience method to get localized string bundles</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineminus">-   * @param aURI</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineminus">-   * @returns nsIStringBundle</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineminus">-   */</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineminus">-  _getStringBundle: function sss_getStringBundle(aURI) {</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineminus">-    var bundleService = Components.classes[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineminus">-                                  .getService(Components.interfaces.nsIStringBundleService);</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineminus">-    var appLocale = Components.classes[&quot;@mozilla.org/intl/nslocaleservice;1&quot;]</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineminus">-                              .getService(Components.interfaces.nsILocaleService).getApplicationLocale();</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineminus">-    return bundleService.createBundle(aURI, appLocale);</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineminus">-  },</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineminus">-</span>
<a href="#l8.141"></a><span id="l8.141"> /* ........ Storage API .............. */</span>
<a href="#l8.142"></a><span id="l8.142"> </span>
<a href="#l8.143"></a><span id="l8.143">   /**</span>
<a href="#l8.144"></a><span id="l8.144">    * Reads a session state file into a string and lets</span>
<a href="#l8.145"></a><span id="l8.145">    * observers modify the state before it's being used</span>
<a href="#l8.146"></a><span id="l8.146">    *</span>
<a href="#l8.147"></a><span id="l8.147">    * @param aFile is any nsIFile</span>
<a href="#l8.148"></a><span id="l8.148">    * @returns a session state string</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/suite/common/src/nsSessionStore.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/suite/common/src/nsSessionStore.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -15,16 +15,17 @@</span>
<a href="#l9.4"></a><span id="l9.4">  *</span>
<a href="#l9.5"></a><span id="l9.5">  * The Initial Developer of the Original Code is</span>
<a href="#l9.6"></a><span id="l9.6">  * Simon BÃ¼nzli &lt;zeniko@gmail.com&gt;</span>
<a href="#l9.7"></a><span id="l9.7">  * Portions created by the Initial Developer are Copyright (C) 2006</span>
<a href="#l9.8"></a><span id="l9.8">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l9.9"></a><span id="l9.9">  *</span>
<a href="#l9.10"></a><span id="l9.10">  * Contributor(s):</span>
<a href="#l9.11"></a><span id="l9.11">  *   Dietrich Ayala &lt;dietrich@mozilla.com&gt;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+ *   Ehsan Akhgari &lt;ehsan.akhgari@gmail.com&gt;</span>
<a href="#l9.13"></a><span id="l9.13">  *</span>
<a href="#l9.14"></a><span id="l9.14">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l9.15"></a><span id="l9.15">  * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l9.16"></a><span id="l9.16">  * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l9.17"></a><span id="l9.17">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l9.18"></a><span id="l9.18">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l9.19"></a><span id="l9.19">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l9.20"></a><span id="l9.20">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineat">@@ -88,18 +89,16 @@ const WINDOW_HIDEABLE_FEATURES = [</span>
<a href="#l9.22"></a><span id="l9.22"> docShell capabilities to (re)store</span>
<a href="#l9.23"></a><span id="l9.23"> Restored in restoreHistory()</span>
<a href="#l9.24"></a><span id="l9.24"> eg: browser.docShell[&quot;allow&quot; + aCapability] = false;</span>
<a href="#l9.25"></a><span id="l9.25"> */</span>
<a href="#l9.26"></a><span id="l9.26"> const CAPABILITIES = [</span>
<a href="#l9.27"></a><span id="l9.27">   &quot;Subframes&quot;, &quot;Plugins&quot;, &quot;Javascript&quot;, &quot;MetaRedirects&quot;, &quot;Images&quot;</span>
<a href="#l9.28"></a><span id="l9.28"> ];</span>
<a href="#l9.29"></a><span id="l9.29"> </span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-// module for JSON conversion (needed for the nsISessionStore API)</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-Components.utils.import(&quot;resource://gre/modules/JSON.jsm&quot;);</span>
<a href="#l9.32"></a><span id="l9.32"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l9.33"></a><span id="l9.33"> </span>
<a href="#l9.34"></a><span id="l9.34"> function debug(aMsg) {</span>
<a href="#l9.35"></a><span id="l9.35">   Components.classes[&quot;@mozilla.org/consoleservice;1&quot;]</span>
<a href="#l9.36"></a><span id="l9.36">             .getService(Components.interfaces.nsIConsoleService)</span>
<a href="#l9.37"></a><span id="l9.37">             .logStringMessage(&quot;SessionStore: &quot; + aMsg);</span>
<a href="#l9.38"></a><span id="l9.38"> }</span>
<a href="#l9.39"></a><span id="l9.39"> </span>
<a href="#l9.40"></a><span id="l9.40" class="difflineat">@@ -112,18 +111,19 @@ SessionStoreService.prototype = {</span>
<a href="#l9.41"></a><span id="l9.41">   classDescription: &quot;Suite Session Store Service&quot;,</span>
<a href="#l9.42"></a><span id="l9.42">   contractID: &quot;@mozilla.org/suite/sessionstore;1&quot;,</span>
<a href="#l9.43"></a><span id="l9.43">   classID: Components.ID(&quot;{d37ccdf1-496f-4135-9575-037180af010d}&quot;),</span>
<a href="#l9.44"></a><span id="l9.44">   QueryInterface: XPCOMUtils.generateQI([Components.interfaces.nsISessionStore,</span>
<a href="#l9.45"></a><span id="l9.45">                                          Components.interfaces.nsIDOMEventListener,</span>
<a href="#l9.46"></a><span id="l9.46">                                          Components.interfaces.nsIObserver,</span>
<a href="#l9.47"></a><span id="l9.47">                                          Components.interfaces.nsISupportsWeakReference]),</span>
<a href="#l9.48"></a><span id="l9.48"> </span>
<a href="#l9.49"></a><span id="l9.49" class="difflineminus">-  // xul:tab attributes to (re)store (extensions might want to hook in here)</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">-  xulAttributes: [],</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+  // xul:tab attributes to (re)store (extensions might want to hook in here);</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+  // the favicon is always saved for the about:sessionrestore page</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+  xulAttributes: [&quot;image&quot;],</span>
<a href="#l9.54"></a><span id="l9.54"> </span>
<a href="#l9.55"></a><span id="l9.55">   // set default load state</span>
<a href="#l9.56"></a><span id="l9.56">   _loadState: STATE_STOPPED,</span>
<a href="#l9.57"></a><span id="l9.57"> </span>
<a href="#l9.58"></a><span id="l9.58">   // minimal interval between two save operations (in milliseconds)</span>
<a href="#l9.59"></a><span id="l9.59">   _interval: 10000,</span>
<a href="#l9.60"></a><span id="l9.60"> </span>
<a href="#l9.61"></a><span id="l9.61">   // when crash recovery is disabled, session data is not written to disk</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineat">@@ -140,16 +140,22 @@ SessionStoreService.prototype = {</span>
<a href="#l9.63"></a><span id="l9.63"> </span>
<a href="#l9.64"></a><span id="l9.64">   // in case the last closed window ain't a navigator:browser one</span>
<a href="#l9.65"></a><span id="l9.65">   // (also contains browser popup windows closed after the last non-popup one)</span>
<a href="#l9.66"></a><span id="l9.66">   _lastClosedWindows: null,</span>
<a href="#l9.67"></a><span id="l9.67"> </span>
<a href="#l9.68"></a><span id="l9.68">   // not-&quot;dirty&quot; windows usually don't need to have their data updated</span>
<a href="#l9.69"></a><span id="l9.69">   _dirtyWindows: {},</span>
<a href="#l9.70"></a><span id="l9.70"> </span>
<a href="#l9.71"></a><span id="l9.71" class="difflineplus">+  // collection of session states yet to be restored</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineplus">+  _statesToRestore: {},</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineplus">+</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineplus">+  // counts the number of crashes since the last clean start</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineplus">+  _recentCrashes: 0,</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineplus">+</span>
<a href="#l9.77"></a><span id="l9.77"> /* ........ Global Event Handlers .............. */</span>
<a href="#l9.78"></a><span id="l9.78"> </span>
<a href="#l9.79"></a><span id="l9.79">   /**</span>
<a href="#l9.80"></a><span id="l9.80">    * Initialize the component</span>
<a href="#l9.81"></a><span id="l9.81">    */</span>
<a href="#l9.82"></a><span id="l9.82">   init: function sss_init(aWindow) {</span>
<a href="#l9.83"></a><span id="l9.83">     if (!aWindow || this._loadState == STATE_RUNNING) {</span>
<a href="#l9.84"></a><span id="l9.84">       // make sure that all browser windows which try to initialize</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineat">@@ -174,19 +180,19 @@ SessionStoreService.prototype = {</span>
<a href="#l9.86"></a><span id="l9.86">     // get interval from prefs - used often, so caching/observing instead of fetching on-demand</span>
<a href="#l9.87"></a><span id="l9.87">     this._interval = this._prefBranch.getIntPref(&quot;sessionstore.interval&quot;);</span>
<a href="#l9.88"></a><span id="l9.88">     this._prefBranch.addObserver(&quot;sessionstore.interval&quot;, this, true);</span>
<a href="#l9.89"></a><span id="l9.89"> </span>
<a href="#l9.90"></a><span id="l9.90">     // get crash recovery state from prefs and allow for proper reaction to state changes</span>
<a href="#l9.91"></a><span id="l9.91">     this._resume_from_crash = this._prefBranch.getBoolPref(&quot;sessionstore.resume_from_crash&quot;);</span>
<a href="#l9.92"></a><span id="l9.92">     this._prefBranch.addObserver(&quot;sessionstore.resume_from_crash&quot;, this, true);</span>
<a href="#l9.93"></a><span id="l9.93"> </span>
<a href="#l9.94"></a><span id="l9.94" class="difflineminus">-    // observe prefs changes so we can modify stored data to match</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineminus">-    this._prefBranch.addObserver(&quot;tabs.undoclose.depth&quot;, this, true);</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineminus">-    this._prefBranch.addObserver(&quot;sessionstore.max_tabs_undo&quot;, this, true);</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineplus">+    // this pref is only read at startup, so no need to observe it</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineplus">+    this._sessionhistory_max_entries =</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineplus">+      this._prefBranch.getIntPref(&quot;sessionhistory.max_entries&quot;);</span>
<a href="#l9.100"></a><span id="l9.100"> </span>
<a href="#l9.101"></a><span id="l9.101">     // get file references</span>
<a href="#l9.102"></a><span id="l9.102">     var dirService = Components.classes[&quot;@mozilla.org/file/directory_service;1&quot;]</span>
<a href="#l9.103"></a><span id="l9.103">                                .getService(Components.interfaces.nsIProperties);</span>
<a href="#l9.104"></a><span id="l9.104">     this._sessionFile = dirService.get(&quot;ProfD&quot;, Components.interfaces.nsILocalFile);</span>
<a href="#l9.105"></a><span id="l9.105">     this._sessionFileBackup = this._sessionFile.clone();</span>
<a href="#l9.106"></a><span id="l9.106">     this._sessionFile.append(&quot;sessionstore.js&quot;);</span>
<a href="#l9.107"></a><span id="l9.107">     this._sessionFileBackup.append(&quot;sessionstore.bak&quot;);</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineat">@@ -206,16 +212,30 @@ SessionStoreService.prototype = {</span>
<a href="#l9.109"></a><span id="l9.109">         // parse the session state into JS objects</span>
<a href="#l9.110"></a><span id="l9.110">         this._initialState = this._safeEval(iniString);</span>
<a href="#l9.111"></a><span id="l9.111">       }</span>
<a href="#l9.112"></a><span id="l9.112">       catch (ex) { debug(&quot;The session file is invalid: &quot; + ex); }</span>
<a href="#l9.113"></a><span id="l9.113"> </span>
<a href="#l9.114"></a><span id="l9.114">       let lastSessionCrashed =</span>
<a href="#l9.115"></a><span id="l9.115">         this._initialState &amp;&amp; this._initialState.session &amp;&amp; this._initialState.session.state &amp;&amp;</span>
<a href="#l9.116"></a><span id="l9.116">         this._initialState.session.state == STATE_RUNNING_STR;</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineplus">+       // if last session crashed, backup the session</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineplus">+       if (lastSessionCrashed) {</span>
<a href="#l9.119"></a><span id="l9.119" class="difflineplus">+        this._recentCrashes = (this._initialState.session &amp;&amp;</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineplus">+                               this._initialState.session.recentCrashes || 0) + 1;</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineplus">+</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineplus">+        if (this._needsRestorePage(this._initialState, this._recentCrashes)) {</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineplus">+          // replace the crashed session with a restore-page-only session</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineplus">+          let pageData = {</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineplus">+            url: &quot;about:sessionrestore&quot;,</span>
<a href="#l9.126"></a><span id="l9.126" class="difflineplus">+            formdata: { &quot;#sessionData&quot;: iniString }</span>
<a href="#l9.127"></a><span id="l9.127" class="difflineplus">+          };</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineplus">+          this._initialState = { windows: [{ tabs: [{ entries: [pageData] }] }] };</span>
<a href="#l9.129"></a><span id="l9.129" class="difflineplus">+        }</span>
<a href="#l9.130"></a><span id="l9.130" class="difflineplus">+       }</span>
<a href="#l9.131"></a><span id="l9.131">       // make sure that at least the first window doesn't have anything hidden</span>
<a href="#l9.132"></a><span id="l9.132">       if (this._initialState.windows[0])</span>
<a href="#l9.133"></a><span id="l9.133">         delete this._initialState.windows[0].hidden;</span>
<a href="#l9.134"></a><span id="l9.134">     }</span>
<a href="#l9.135"></a><span id="l9.135"> </span>
<a href="#l9.136"></a><span id="l9.136">     // remove the session data files if crash recovery is disabled</span>
<a href="#l9.137"></a><span id="l9.137">     if (!this._resume_from_crash)</span>
<a href="#l9.138"></a><span id="l9.138">       this._clearDisk();</span>
<a href="#l9.139"></a><span id="l9.139" class="difflineat">@@ -319,28 +339,16 @@ SessionStoreService.prototype = {</span>
<a href="#l9.140"></a><span id="l9.140">       var win = this._getMostRecentBrowserWindow();</span>
<a href="#l9.141"></a><span id="l9.141">       if (win)</span>
<a href="#l9.142"></a><span id="l9.142">         win.setTimeout(function() { _this.saveState(true); }, 0);</span>
<a href="#l9.143"></a><span id="l9.143">       else if (this._loadState == STATE_RUNNING)</span>
<a href="#l9.144"></a><span id="l9.144">         this.saveState(true);</span>
<a href="#l9.145"></a><span id="l9.145">       break;</span>
<a href="#l9.146"></a><span id="l9.146">     case &quot;nsPref:changed&quot;: // catch pref changes</span>
<a href="#l9.147"></a><span id="l9.147">       switch (aData) {</span>
<a href="#l9.148"></a><span id="l9.148" class="difflineminus">-      // if the user decreases the max number of closed tabs they want</span>
<a href="#l9.149"></a><span id="l9.149" class="difflineminus">-      // preserved update our internal states to match that max</span>
<a href="#l9.150"></a><span id="l9.150" class="difflineminus">-      // misak: this shouldn't be needed, will remove in final patch</span>
<a href="#l9.151"></a><span id="l9.151" class="difflineminus">-      //case &quot;tabs.undoclose.depth&quot;:</span>
<a href="#l9.152"></a><span id="l9.152" class="difflineminus">-      //  var ix;</span>
<a href="#l9.153"></a><span id="l9.153" class="difflineminus">-      //  for (ix in this._windows) {</span>
<a href="#l9.154"></a><span id="l9.154" class="difflineminus">-      //    this._windows[ix]._closedTabs.splice(this._prefBranch.getIntPref(&quot;tabs.undoclose.depth&quot;));</span>
<a href="#l9.155"></a><span id="l9.155" class="difflineminus">-      //  }</span>
<a href="#l9.156"></a><span id="l9.156" class="difflineminus">-      //  break;</span>
<a href="#l9.157"></a><span id="l9.157" class="difflineminus">-      case &quot;sessionstore.max_tabs_undo&quot;:</span>
<a href="#l9.158"></a><span id="l9.158" class="difflineminus">-        //todo: we need some way to syncronise sessionstore.max_tabs_undo and tabs.undoclose.depth</span>
<a href="#l9.159"></a><span id="l9.159" class="difflineminus">-        break;</span>
<a href="#l9.160"></a><span id="l9.160">       case &quot;sessionstore.interval&quot;:</span>
<a href="#l9.161"></a><span id="l9.161">         this._interval = this._prefBranch.getIntPref(&quot;sessionstore.interval&quot;);</span>
<a href="#l9.162"></a><span id="l9.162">         // reset timer and save</span>
<a href="#l9.163"></a><span id="l9.163">         if (this._saveTimer) {</span>
<a href="#l9.164"></a><span id="l9.164">           this._saveTimer.cancel();</span>
<a href="#l9.165"></a><span id="l9.165">           this._saveTimer = null;</span>
<a href="#l9.166"></a><span id="l9.166">         }</span>
<a href="#l9.167"></a><span id="l9.167">         this.saveStateDelayed(null, -1);</span>
<a href="#l9.168"></a><span id="l9.168" class="difflineat">@@ -428,35 +436,42 @@ SessionStoreService.prototype = {</span>
<a href="#l9.169"></a><span id="l9.169">     if (!aWindow.toolbar.visible)</span>
<a href="#l9.170"></a><span id="l9.170">       this._windows[aWindow.__SSi].isPopup = true;</span>
<a href="#l9.171"></a><span id="l9.171"> </span>
<a href="#l9.172"></a><span id="l9.172">     // perform additional initialization when the first window is loading</span>
<a href="#l9.173"></a><span id="l9.173">     if (this._loadState == STATE_STOPPED) {</span>
<a href="#l9.174"></a><span id="l9.174">       this._loadState = STATE_RUNNING;</span>
<a href="#l9.175"></a><span id="l9.175">       this._lastSaveTime = Date.now();</span>
<a href="#l9.176"></a><span id="l9.176"> </span>
<a href="#l9.177"></a><span id="l9.177" class="difflineminus">-      // don't save during the first ten seconds</span>
<a href="#l9.178"></a><span id="l9.178" class="difflineminus">-      // (until most of the pages have been restored)</span>
<a href="#l9.179"></a><span id="l9.179" class="difflineminus">-      this.saveStateDelayed(aWindow, 10000);</span>
<a href="#l9.180"></a><span id="l9.180" class="difflineminus">-</span>
<a href="#l9.181"></a><span id="l9.181">       // restore a crashed session resp. resume the last session if requested</span>
<a href="#l9.182"></a><span id="l9.182">       if (this._initialState) {</span>
<a href="#l9.183"></a><span id="l9.183">         // make sure that the restored tabs are first in the window</span>
<a href="#l9.184"></a><span id="l9.184">         this._initialState._firstTabs = true;</span>
<a href="#l9.185"></a><span id="l9.185">         this._restoreCount = this._initialState.windows ? this._initialState.windows.length : 0;</span>
<a href="#l9.186"></a><span id="l9.186">         this.restoreWindow(aWindow, this._initialState, this._isCmdLineEmpty(aWindow));</span>
<a href="#l9.187"></a><span id="l9.187">         delete this._initialState;</span>
<a href="#l9.188"></a><span id="l9.188" class="difflineplus">+</span>
<a href="#l9.189"></a><span id="l9.189" class="difflineplus">+        // mark ourselves as running</span>
<a href="#l9.190"></a><span id="l9.190" class="difflineplus">+        this.saveState(true);</span>
<a href="#l9.191"></a><span id="l9.191">       }</span>
<a href="#l9.192"></a><span id="l9.192">       else {</span>
<a href="#l9.193"></a><span id="l9.193">         // Nothing to restore, notify observers things are complete.</span>
<a href="#l9.194"></a><span id="l9.194">         var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l9.195"></a><span id="l9.195">                                         .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l9.196"></a><span id="l9.196">         observerService.notifyObservers(null, NOTIFY_WINDOWS_RESTORED, &quot;&quot;);</span>
<a href="#l9.197"></a><span id="l9.197" class="difflineplus">+</span>
<a href="#l9.198"></a><span id="l9.198" class="difflineplus">+        // the next delayed save request should execute immediately</span>
<a href="#l9.199"></a><span id="l9.199" class="difflineplus">+        this._lastSaveTime -= this._interval;</span>
<a href="#l9.200"></a><span id="l9.200">       }</span>
<a href="#l9.201"></a><span id="l9.201">     }</span>
<a href="#l9.202"></a><span id="l9.202" class="difflineplus">+    // this window was opened by _openWindowWithState</span>
<a href="#l9.203"></a><span id="l9.203" class="difflineplus">+    else if (!this._isWindowLoaded(aWindow)) {</span>
<a href="#l9.204"></a><span id="l9.204" class="difflineplus">+      let followUp = this._statesToRestore[aWindow.__SS_restoreID].windows.length == 1;</span>
<a href="#l9.205"></a><span id="l9.205" class="difflineplus">+      this.restoreWindow(aWindow, this._statesToRestore[aWindow.__SS_restoreID], true, followUp);</span>
<a href="#l9.206"></a><span id="l9.206" class="difflineplus">+    }</span>
<a href="#l9.207"></a><span id="l9.207"> </span>
<a href="#l9.208"></a><span id="l9.208">     var tabbrowser = aWindow.getBrowser();</span>
<a href="#l9.209"></a><span id="l9.209">     var tabpanels = tabbrowser.mPanelContainer;</span>
<a href="#l9.210"></a><span id="l9.210"> </span>
<a href="#l9.211"></a><span id="l9.211">     // add tab change listeners to all already existing tabs</span>
<a href="#l9.212"></a><span id="l9.212">     for (var i = 0; i &lt; tabpanels.childNodes.length; i++) {</span>
<a href="#l9.213"></a><span id="l9.213">       this.onTabAdd(aWindow, tabpanels.childNodes[i], true);</span>
<a href="#l9.214"></a><span id="l9.214">     }</span>
<a href="#l9.215"></a><span id="l9.215" class="difflineat">@@ -469,69 +484,73 @@ SessionStoreService.prototype = {</span>
<a href="#l9.216"></a><span id="l9.216">   /**</span>
<a href="#l9.217"></a><span id="l9.217">    * On window close...</span>
<a href="#l9.218"></a><span id="l9.218">    * - remove event listeners from tabs</span>
<a href="#l9.219"></a><span id="l9.219">    * - save all window data</span>
<a href="#l9.220"></a><span id="l9.220">    * @param aWindow</span>
<a href="#l9.221"></a><span id="l9.221">    *        Window reference</span>
<a href="#l9.222"></a><span id="l9.222">    */</span>
<a href="#l9.223"></a><span id="l9.223">   onClose: function sss_onClose(aWindow) {</span>
<a href="#l9.224"></a><span id="l9.224" class="difflineplus">+    // this window was about to be restored - conserve its original data, if any</span>
<a href="#l9.225"></a><span id="l9.225" class="difflineplus">+    let isFullyLoaded = this._isWindowLoaded(aWindow);</span>
<a href="#l9.226"></a><span id="l9.226" class="difflineplus">+    if (!isFullyLoaded) {</span>
<a href="#l9.227"></a><span id="l9.227" class="difflineplus">+      if (!aWindow.__SSi)</span>
<a href="#l9.228"></a><span id="l9.228" class="difflineplus">+        aWindow.__SSi = &quot;window&quot; + Date.now();</span>
<a href="#l9.229"></a><span id="l9.229" class="difflineplus">+      this._window[aWindow.__SSi] = this._statesToRestore[aWindow.__SS_restoreID];</span>
<a href="#l9.230"></a><span id="l9.230" class="difflineplus">+      delete this._statesToRestore[aWindow.__SS_restoreID];</span>
<a href="#l9.231"></a><span id="l9.231" class="difflineplus">+      delete aWindow.__SS_restoreID;</span>
<a href="#l9.232"></a><span id="l9.232" class="difflineplus">+    }</span>
<a href="#l9.233"></a><span id="l9.233" class="difflineplus">+</span>
<a href="#l9.234"></a><span id="l9.234">     // ignore windows not tracked by SessionStore</span>
<a href="#l9.235"></a><span id="l9.235">     if (!aWindow.__SSi || !this._windows[aWindow.__SSi]) {</span>
<a href="#l9.236"></a><span id="l9.236">       return;</span>
<a href="#l9.237"></a><span id="l9.237">     }</span>
<a href="#l9.238"></a><span id="l9.238"> </span>
<a href="#l9.239"></a><span id="l9.239">     if (this.windowToFocus &amp;&amp; this.windowToFocus == aWindow) {</span>
<a href="#l9.240"></a><span id="l9.240">       delete this.windowToFocus;</span>
<a href="#l9.241"></a><span id="l9.241">     }</span>
<a href="#l9.242"></a><span id="l9.242"> </span>
<a href="#l9.243"></a><span id="l9.243">     var tabbrowser = aWindow.getBrowser();</span>
<a href="#l9.244"></a><span id="l9.244">     var tabpanels = tabbrowser.mPanelContainer;</span>
<a href="#l9.245"></a><span id="l9.245"> </span>
<a href="#l9.246"></a><span id="l9.246">     tabbrowser.removeEventListener(&quot;TabOpen&quot;, this, true);</span>
<a href="#l9.247"></a><span id="l9.247">     tabbrowser.removeEventListener(&quot;TabClose&quot;, this, true);</span>
<a href="#l9.248"></a><span id="l9.248">     tabbrowser.removeEventListener(&quot;TabSelect&quot;, this, true);</span>
<a href="#l9.249"></a><span id="l9.249"> </span>
<a href="#l9.250"></a><span id="l9.250" class="difflineplus">+    let winData = this._windows[aWindow.__SSi];</span>
<a href="#l9.251"></a><span id="l9.251" class="difflineplus">+    windata._closedTabs = tabbrowser.savedBrowsers.map(function(e) { return e.tabData; });</span>
<a href="#l9.252"></a><span id="l9.252">     if (this._loadState == STATE_RUNNING) { // window not closed during a regular shut-down</span>
<a href="#l9.253"></a><span id="l9.253">       // update all window data for a last time</span>
<a href="#l9.254"></a><span id="l9.254">       this._collectWindowData(aWindow);</span>
<a href="#l9.255"></a><span id="l9.255"> </span>
<a href="#l9.256"></a><span id="l9.256">       // preserve this window's data (in case it was the last navigator:browser)</span>
<a href="#l9.257"></a><span id="l9.257" class="difflineminus">-      var winData = this._windows[aWindow.__SSi];</span>
<a href="#l9.258"></a><span id="l9.258" class="difflineminus">-      winData.title = aWindow.content.document.title;</span>
<a href="#l9.259"></a><span id="l9.259" class="difflineminus">-      winData._closedTabs = tabbrowser.savedBrowsers.map(function(e) { return e.tabData; });</span>
<a href="#l9.260"></a><span id="l9.260" class="difflineminus">-</span>
<a href="#l9.261"></a><span id="l9.261">       // if this is a popup window, append it to what we've already got (cf. bug 368677)</span>
<a href="#l9.262"></a><span id="l9.262">       if (!this._lastClosedWindows || !winData.isPopup)</span>
<a href="#l9.263"></a><span id="l9.263">         this._lastClosedWindows = [winData];</span>
<a href="#l9.264"></a><span id="l9.264">       else</span>
<a href="#l9.265"></a><span id="l9.265">         this._lastClosedWindows.push(winData);</span>
<a href="#l9.266"></a><span id="l9.266"> </span>
<a href="#l9.267"></a><span id="l9.267" class="difflineminus">-      this._updateCookies(this._lastClosedWindows);</span>
<a href="#l9.268"></a><span id="l9.268" class="difflineplus">+      if (isFullyLoaded) {</span>
<a href="#l9.269"></a><span id="l9.269" class="difflineplus">+        winData.title = aWindow.content.document.title;</span>
<a href="#l9.270"></a><span id="l9.270" class="difflineplus">+        this._updateCookies(this._lastClosedWindows);</span>
<a href="#l9.271"></a><span id="l9.271" class="difflineplus">+      }</span>
<a href="#l9.272"></a><span id="l9.272"> </span>
<a href="#l9.273"></a><span id="l9.273">       // clear this window from the list</span>
<a href="#l9.274"></a><span id="l9.274">       delete this._windows[aWindow.__SSi];</span>
<a href="#l9.275"></a><span id="l9.275"> </span>
<a href="#l9.276"></a><span id="l9.276">       // save the state without this window to disk</span>
<a href="#l9.277"></a><span id="l9.277">       this.saveStateDelayed();</span>
<a href="#l9.278"></a><span id="l9.278">     }</span>
<a href="#l9.279"></a><span id="l9.279"> </span>
<a href="#l9.280"></a><span id="l9.280">     for (var i = 0; i &lt; tabpanels.childNodes.length; i++) {</span>
<a href="#l9.281"></a><span id="l9.281">       this.onTabRemove(aWindow, tabpanels.childNodes[i], true);</span>
<a href="#l9.282"></a><span id="l9.282">     }</span>
<a href="#l9.283"></a><span id="l9.283"> </span>
<a href="#l9.284"></a><span id="l9.284">     // cache the window state until the window is completely gone</span>
<a href="#l9.285"></a><span id="l9.285" class="difflineminus">-    aWindow.__SS_dyingCache = this._windows[aWindow.__SSi] || winData;</span>
<a href="#l9.286"></a><span id="l9.286" class="difflineminus">-</span>
<a href="#l9.287"></a><span id="l9.287" class="difflineminus">-    // reset the _tab property to avoid keeping the tab's XUL element alive</span>
<a href="#l9.288"></a><span id="l9.288" class="difflineminus">-    // longer than we need it</span>
<a href="#l9.289"></a><span id="l9.289" class="difflineminus">-    var tabCount = aWindow.__SS_dyingCache.tabs.length;</span>
<a href="#l9.290"></a><span id="l9.290" class="difflineminus">-    for (var t = 0; t &lt; tabCount; t++) {</span>
<a href="#l9.291"></a><span id="l9.291" class="difflineminus">-      delete aWindow.__SS_dyingCache.tabs[t]._tab;</span>
<a href="#l9.292"></a><span id="l9.292" class="difflineminus">-    }</span>
<a href="#l9.293"></a><span id="l9.293" class="difflineplus">+    aWindow.__SS_dyingCache = winData;</span>
<a href="#l9.294"></a><span id="l9.294"> </span>
<a href="#l9.295"></a><span id="l9.295">     delete aWindow.__SSi;</span>
<a href="#l9.296"></a><span id="l9.296">   },</span>
<a href="#l9.297"></a><span id="l9.297"> </span>
<a href="#l9.298"></a><span id="l9.298">   /**</span>
<a href="#l9.299"></a><span id="l9.299">    * set up listeners for a new tab</span>
<a href="#l9.300"></a><span id="l9.300">    * @param aWindow</span>
<a href="#l9.301"></a><span id="l9.301">    *        Window reference</span>
<a href="#l9.302"></a><span id="l9.302" class="difflineat">@@ -586,30 +605,26 @@ SessionStoreService.prototype = {</span>
<a href="#l9.303"></a><span id="l9.303">    */</span>
<a href="#l9.304"></a><span id="l9.304">   onTabClose: function sss_onTabClose(aWindow, aTab) {</span>
<a href="#l9.305"></a><span id="l9.305">     // notify the tabbrowser that the tab state will be retrieved for the last time</span>
<a href="#l9.306"></a><span id="l9.306">     // (so that extension authors can easily set data on soon-to-be-closed tabs)</span>
<a href="#l9.307"></a><span id="l9.307">     var event = aWindow.document.createEvent(&quot;Events&quot;);</span>
<a href="#l9.308"></a><span id="l9.308">     event.initEvent(&quot;SSTabClosing&quot;, true, false);</span>
<a href="#l9.309"></a><span id="l9.309">     aTab.dispatchEvent(event);</span>
<a href="#l9.310"></a><span id="l9.310"> </span>
<a href="#l9.311"></a><span id="l9.311" class="difflineminus">-    var maxTabsUndo = this._prefBranch.getIntPref(&quot;tabs.undoclose.depth&quot;);</span>
<a href="#l9.312"></a><span id="l9.312" class="difflineplus">+    var maxTabsUndo = this._prefBranch.getIntPref(&quot;browser.sessionstore.max_tabs_undo&quot;);</span>
<a href="#l9.313"></a><span id="l9.313">     // don't update our internal state if we don't have to</span>
<a href="#l9.314"></a><span id="l9.314">     if (maxTabsUndo == 0) {</span>
<a href="#l9.315"></a><span id="l9.315">       return;</span>
<a href="#l9.316"></a><span id="l9.316">     }</span>
<a href="#l9.317"></a><span id="l9.317"> </span>
<a href="#l9.318"></a><span id="l9.318">     // make sure that the tab related data is up-to-date</span>
<a href="#l9.319"></a><span id="l9.319">     var tabState = this._collectTabData(aTab);</span>
<a href="#l9.320"></a><span id="l9.320">     this._updateTextAndScrollDataForTab(aWindow, aTab.linkedBrowser, tabState);</span>
<a href="#l9.321"></a><span id="l9.321"> </span>
<a href="#l9.322"></a><span id="l9.322" class="difflineminus">-    // reset the _tab property to avoid keeping the tab's XUL element alive</span>
<a href="#l9.323"></a><span id="l9.323" class="difflineminus">-    // longer than we need it</span>
<a href="#l9.324"></a><span id="l9.324" class="difflineminus">-    delete tabState._tab;</span>
<a href="#l9.325"></a><span id="l9.325" class="difflineminus">-</span>
<a href="#l9.326"></a><span id="l9.326">     // store closed-tab data for undo</span>
<a href="#l9.327"></a><span id="l9.327">     if (tabState.entries.length &gt; 0) {</span>
<a href="#l9.328"></a><span id="l9.328">       let tabTitle = aTab.label;</span>
<a href="#l9.329"></a><span id="l9.329">       let tabbrowser = aWindow.gBrowser;</span>
<a href="#l9.330"></a><span id="l9.330">       // replace &quot;Loading...&quot; with the document title (with minimal side-effects)</span>
<a href="#l9.331"></a><span id="l9.331">       if (tabTitle == tabbrowser.mStringBundle.getString(&quot;tabs.loading&quot;)) {</span>
<a href="#l9.332"></a><span id="l9.332">         tabbrowser.setTabTitle(aTab);</span>
<a href="#l9.333"></a><span id="l9.333">         [tabTitle, aTab.label] = [aTab.label, tabTitle];</span>
<a href="#l9.334"></a><span id="l9.334" class="difflineat">@@ -690,31 +705,38 @@ SessionStoreService.prototype = {</span>
<a href="#l9.335"></a><span id="l9.335"> </span>
<a href="#l9.336"></a><span id="l9.336"> /* ........ nsISessionStore API .............. */</span>
<a href="#l9.337"></a><span id="l9.337"> </span>
<a href="#l9.338"></a><span id="l9.338">   getBrowserState: function sss_getBrowserState() {</span>
<a href="#l9.339"></a><span id="l9.339">     return this._toJSONString(this._getCurrentState());</span>
<a href="#l9.340"></a><span id="l9.340">   },</span>
<a href="#l9.341"></a><span id="l9.341"> </span>
<a href="#l9.342"></a><span id="l9.342">   setBrowserState: function sss_setBrowserState(aState) {</span>
<a href="#l9.343"></a><span id="l9.343" class="difflineplus">+    try {</span>
<a href="#l9.344"></a><span id="l9.344" class="difflineplus">+      var state = this._safeEval(&quot;(&quot; + aState + &quot;)&quot;);</span>
<a href="#l9.345"></a><span id="l9.345" class="difflineplus">+    }</span>
<a href="#l9.346"></a><span id="l9.346" class="difflineplus">+    catch (ex) { /* invalid state object - don't restore anything */ }</span>
<a href="#l9.347"></a><span id="l9.347" class="difflineplus">+    if (!state || !state.windows)</span>
<a href="#l9.348"></a><span id="l9.348" class="difflineplus">+      throw (Components.returnCode = Components.results.NS_ERROR_INVALID_ARG);</span>
<a href="#l9.349"></a><span id="l9.349" class="difflineplus">+</span>
<a href="#l9.350"></a><span id="l9.350">     var window = this._getMostRecentBrowserWindow();</span>
<a href="#l9.351"></a><span id="l9.351">     if (!window) {</span>
<a href="#l9.352"></a><span id="l9.352" class="difflineminus">-      this._openWindowWithState(&quot;(&quot; + aState + &quot;)&quot;);</span>
<a href="#l9.353"></a><span id="l9.353" class="difflineplus">+      this._openWindowWithState(state);</span>
<a href="#l9.354"></a><span id="l9.354">       return;</span>
<a href="#l9.355"></a><span id="l9.355">     }</span>
<a href="#l9.356"></a><span id="l9.356"> </span>
<a href="#l9.357"></a><span id="l9.357">     // close all other browser windows</span>
<a href="#l9.358"></a><span id="l9.358">     this._forEachBrowserWindow(function(aWindow) {</span>
<a href="#l9.359"></a><span id="l9.359">       if (aWindow != window) {</span>
<a href="#l9.360"></a><span id="l9.360">         aWindow.close();</span>
<a href="#l9.361"></a><span id="l9.361">       }</span>
<a href="#l9.362"></a><span id="l9.362">     });</span>
<a href="#l9.363"></a><span id="l9.363"> </span>
<a href="#l9.364"></a><span id="l9.364">     // restore to the given state</span>
<a href="#l9.365"></a><span id="l9.365" class="difflineminus">-    this.restoreWindow(window, &quot;(&quot; + aState + &quot;)&quot;, true);</span>
<a href="#l9.366"></a><span id="l9.366" class="difflineplus">+    this.restoreWindow(window, state, true);</span>
<a href="#l9.367"></a><span id="l9.367">   },</span>
<a href="#l9.368"></a><span id="l9.368"> </span>
<a href="#l9.369"></a><span id="l9.369">   getWindowState: function sss_getWindowState(aWindow) {</span>
<a href="#l9.370"></a><span id="l9.370">     if (!aWindow.__SSi &amp;&amp; !aWindow.__SS_dyingCache)</span>
<a href="#l9.371"></a><span id="l9.371">       throw (Components.returnCode = Components.results.NS_ERROR_INVALID_ARG);</span>
<a href="#l9.372"></a><span id="l9.372"> </span>
<a href="#l9.373"></a><span id="l9.373">     if (!aWindow.__SSi)</span>
<a href="#l9.374"></a><span id="l9.374">       return this._toJSONString({ windows: [aWindow.__SS_dyingCache] });</span>
<a href="#l9.375"></a><span id="l9.375" class="difflineat">@@ -740,58 +762,55 @@ SessionStoreService.prototype = {</span>
<a href="#l9.376"></a><span id="l9.376">     return this._toJSONString(tabState);</span>
<a href="#l9.377"></a><span id="l9.377">   },</span>
<a href="#l9.378"></a><span id="l9.378"> </span>
<a href="#l9.379"></a><span id="l9.379">   setTabState: function sss_setTabState(aTab, aState) {</span>
<a href="#l9.380"></a><span id="l9.380">     var tabState = this._safeEval(&quot;(&quot; + aState + &quot;)&quot;);</span>
<a href="#l9.381"></a><span id="l9.381">     if (!tabState.entries || !aTab.ownerDocument || !aTab.ownerDocument.defaultView.__SSi)</span>
<a href="#l9.382"></a><span id="l9.382">       throw (Components.returnCode = Components.results.NS_ERROR_INVALID_ARG);</span>
<a href="#l9.383"></a><span id="l9.383"> </span>
<a href="#l9.384"></a><span id="l9.384" class="difflineminus">-    tabState._tab = aTab;</span>
<a href="#l9.385"></a><span id="l9.385" class="difflineminus">-</span>
<a href="#l9.386"></a><span id="l9.386">     var window = aTab.ownerDocument.defaultView;</span>
<a href="#l9.387"></a><span id="l9.387" class="difflineminus">-    this.restoreHistoryPrecursor(window, [tabState], 0, 0, 0);</span>
<a href="#l9.388"></a><span id="l9.388" class="difflineplus">+    this.restoreHistoryPrecursor(window, [aTab], [tabState], 0, 0, 0);</span>
<a href="#l9.389"></a><span id="l9.389">   },</span>
<a href="#l9.390"></a><span id="l9.390"> </span>
<a href="#l9.391"></a><span id="l9.391">   duplicateTab: function sss_duplicateTab(aWindow, aTab) {</span>
<a href="#l9.392"></a><span id="l9.392">     if (!aTab.ownerDocument || !aTab.ownerDocument.defaultView.__SSi ||</span>
<a href="#l9.393"></a><span id="l9.393">         !aWindow.getBrowser)</span>
<a href="#l9.394"></a><span id="l9.394">       throw (Components.returnCode = Components.results.NS_ERROR_INVALID_ARG);</span>
<a href="#l9.395"></a><span id="l9.395"> </span>
<a href="#l9.396"></a><span id="l9.396">     var tabState = this._collectTabData(aTab, true);</span>
<a href="#l9.397"></a><span id="l9.397">     var sourceWindow = aTab.ownerDocument.defaultView;</span>
<a href="#l9.398"></a><span id="l9.398">     this._updateTextAndScrollDataForTab(sourceWindow, aTab.linkedBrowser, tabState, true);</span>
<a href="#l9.399"></a><span id="l9.399"> </span>
<a href="#l9.400"></a><span id="l9.400">     var newTab = aWindow.getBrowser().addTab();</span>
<a href="#l9.401"></a><span id="l9.401" class="difflineminus">-    tabState._tab = newTab;</span>
<a href="#l9.402"></a><span id="l9.402" class="difflineminus">-    this.restoreHistoryPrecursor(aWindow, [tabState], 0, 0, 0);</span>
<a href="#l9.403"></a><span id="l9.403" class="difflineplus">+    this.restoreHistoryPrecursor(aWindow, [newTab], [tabState], 0, 0, 0);</span>
<a href="#l9.404"></a><span id="l9.404"> </span>
<a href="#l9.405"></a><span id="l9.405">     return newTab;</span>
<a href="#l9.406"></a><span id="l9.406">   },</span>
<a href="#l9.407"></a><span id="l9.407"> </span>
<a href="#l9.408"></a><span id="l9.408">   getClosedTabCount: function sss_getClosedTabCount(aWindow) {</span>
<a href="#l9.409"></a><span id="l9.409" class="difflineminus">-    //misak: 2 lines uncommented</span>
<a href="#l9.410"></a><span id="l9.410">     if (!aWindow.__SSi &amp;&amp; aWindow.__SS_dyingCache)</span>
<a href="#l9.411"></a><span id="l9.411">       return aWindow.__SS_dyingCache._closedTabs.length;</span>
<a href="#l9.412"></a><span id="l9.412"> </span>
<a href="#l9.413"></a><span id="l9.413">     if (!aWindow.__SSi)</span>
<a href="#l9.414"></a><span id="l9.414">       // XXXzeniko shouldn't we throw here?</span>
<a href="#l9.415"></a><span id="l9.415">       return 0; // not a browser window, or not otherwise tracked by SS.</span>
<a href="#l9.416"></a><span id="l9.416"> </span>
<a href="#l9.417"></a><span id="l9.417" class="difflineminus">-    return aWindow.getBrowser().savedBrowsers.length;</span>
<a href="#l9.418"></a><span id="l9.418" class="difflineminus">-    //return this._windows[aWindow.__SSi]._closedTabs.length;</span>
<a href="#l9.419"></a><span id="l9.419" class="difflineplus">+    let closedTabs = aWindow.getBrowser().savedBrowsers.map(function(e) { return e.tabData; });</span>
<a href="#l9.420"></a><span id="l9.420" class="difflineplus">+    return closedTabs.length;</span>
<a href="#l9.421"></a><span id="l9.421">   },</span>
<a href="#l9.422"></a><span id="l9.422"> </span>
<a href="#l9.423"></a><span id="l9.423">   getClosedTabData: function sss_getClosedTabDataAt(aWindow) {</span>
<a href="#l9.424"></a><span id="l9.424">     if (!aWindow.__SSi &amp;&amp; !aWindow.__SS_dyingCache)</span>
<a href="#l9.425"></a><span id="l9.425">       throw (Components.returnCode = Components.results.NS_ERROR_INVALID_ARG);</span>
<a href="#l9.426"></a><span id="l9.426"> </span>
<a href="#l9.427"></a><span id="l9.427">     if (!aWindow.__SSi)</span>
<a href="#l9.428"></a><span id="l9.428">       return this._toJSONString(aWindow.__SS_dyingCache._closedTabs);</span>
<a href="#l9.429"></a><span id="l9.429" class="difflineminus">-    return this._toJSONString(aWindow.getBrowser().savedBrowsers.map(function(e) { return e.tabData; }))</span>
<a href="#l9.430"></a><span id="l9.430" class="difflineplus">+    let closedTabs = aWindow.getBrowser().savedBrowsers.map(function(e) { return e.tabData; });</span>
<a href="#l9.431"></a><span id="l9.431" class="difflineplus">+    return this._toJSONString(closedTabs);</span>
<a href="#l9.432"></a><span id="l9.432">   },</span>
<a href="#l9.433"></a><span id="l9.433"> </span>
<a href="#l9.434"></a><span id="l9.434">   undoCloseTab: function sss_undoCloseTab(aWindow, aIndex) {</span>
<a href="#l9.435"></a><span id="l9.435">     if (!aWindow.__SSi)</span>
<a href="#l9.436"></a><span id="l9.436">       throw (Components.returnCode = Components.results.NS_ERROR_INVALID_ARG);</span>
<a href="#l9.437"></a><span id="l9.437"> </span>
<a href="#l9.438"></a><span id="l9.438">     var closedTabs = aWindow.getBrowser().savedBrowsers.map(function(e) { return e.tabData; });</span>
<a href="#l9.439"></a><span id="l9.439">     // default to the most-recently closed tab</span>
<a href="#l9.440"></a><span id="l9.440" class="difflineat">@@ -799,19 +818,19 @@ SessionStoreService.prototype = {</span>
<a href="#l9.441"></a><span id="l9.441">     aIndex = aIndex || 0;</span>
<a href="#l9.442"></a><span id="l9.442">     if (!(aIndex in closedTabs))</span>
<a href="#l9.443"></a><span id="l9.443">       throw (Components.returnCode = Components.results.NS_ERROR_INVALID_ARG);</span>
<a href="#l9.444"></a><span id="l9.444"> </span>
<a href="#l9.445"></a><span id="l9.445">     //var browser = aWindow.getBrowser();</span>
<a href="#l9.446"></a><span id="l9.446">     let browser = aWindow.gBrowser;</span>
<a href="#l9.447"></a><span id="l9.447"> </span>
<a href="#l9.448"></a><span id="l9.448">     // Seamonkey has it's own undoclosetab functionality</span>
<a href="#l9.449"></a><span id="l9.449" class="difflineminus">-    tab = browser.restoreTab(aIndex);</span>
<a href="#l9.450"></a><span id="l9.450" class="difflineplus">+    var newTab = browser.restoreTab(aIndex);</span>
<a href="#l9.451"></a><span id="l9.451"> </span>
<a href="#l9.452"></a><span id="l9.452" class="difflineminus">-    return tab;</span>
<a href="#l9.453"></a><span id="l9.453" class="difflineplus">+    return newTab;</span>
<a href="#l9.454"></a><span id="l9.454">   },</span>
<a href="#l9.455"></a><span id="l9.455"> </span>
<a href="#l9.456"></a><span id="l9.456">   getWindowValue: function sss_getWindowValue(aWindow, aKey) {</span>
<a href="#l9.457"></a><span id="l9.457">     if (aWindow.__SSi) {</span>
<a href="#l9.458"></a><span id="l9.458">       var data = this._windows[aWindow.__SSi].extData || {};</span>
<a href="#l9.459"></a><span id="l9.459">       return data[aKey] || &quot;&quot;;</span>
<a href="#l9.460"></a><span id="l9.460">     }</span>
<a href="#l9.461"></a><span id="l9.461">     if (aWindow.__SS_dyingCache) {</span>
<a href="#l9.462"></a><span id="l9.462" class="difflineat">@@ -898,28 +917,31 @@ SessionStoreService.prototype = {</span>
<a href="#l9.463"></a><span id="l9.463">    */</span>
<a href="#l9.464"></a><span id="l9.464">   _collectTabData: function sss_collectTabData(aTab, aFullData) {</span>
<a href="#l9.465"></a><span id="l9.465">     var tabData = { entries: [] };</span>
<a href="#l9.466"></a><span id="l9.466">     var browser = aTab.linkedBrowser;</span>
<a href="#l9.467"></a><span id="l9.467"> </span>
<a href="#l9.468"></a><span id="l9.468">     if (!browser || !browser.currentURI)</span>
<a href="#l9.469"></a><span id="l9.469">       // can happen when calling this function right after .addTab()</span>
<a href="#l9.470"></a><span id="l9.470">       return tabData;</span>
<a href="#l9.471"></a><span id="l9.471" class="difflineminus">-    else if (browser.parentNode.__SS_data &amp;&amp; browser.parentNode.__SS_data._tab)</span>
<a href="#l9.472"></a><span id="l9.472" class="difflineplus">+    else if (browser.parentNode.__SS_data &amp;&amp; browser.parentNode.__SS_data._tabStillLoading)</span>
<a href="#l9.473"></a><span id="l9.473">       // use the data to be restored when the tab hasn't been completely loaded</span>
<a href="#l9.474"></a><span id="l9.474">       return browser.parentNode.__SS_data;</span>
<a href="#l9.475"></a><span id="l9.475"> </span>
<a href="#l9.476"></a><span id="l9.476">     var history = null;</span>
<a href="#l9.477"></a><span id="l9.477">     try {</span>
<a href="#l9.478"></a><span id="l9.478">       history = browser.sessionHistory;</span>
<a href="#l9.479"></a><span id="l9.479">     }</span>
<a href="#l9.480"></a><span id="l9.480">     catch (ex) { } // this could happen if we catch a tab during (de)initialization</span>
<a href="#l9.481"></a><span id="l9.481"> </span>
<a href="#l9.482"></a><span id="l9.482" class="difflineplus">+    // XXXzeniko anchor navigation doesn't reset __SS_data, so we could reuse</span>
<a href="#l9.483"></a><span id="l9.483" class="difflineplus">+    //           data even when we shouldn't (e.g. Back, different anchor)</span>
<a href="#l9.484"></a><span id="l9.484">     if (history &amp;&amp; browser.parentNode.__SS_data &amp;&amp;</span>
<a href="#l9.485"></a><span id="l9.485" class="difflineminus">-        browser.parentNode.__SS_data.entries[history.index] &amp;&amp; !aFullData) {</span>
<a href="#l9.486"></a><span id="l9.486" class="difflineplus">+        browser.parentNode.__SS_data.entries[history.index] &amp;&amp;</span>
<a href="#l9.487"></a><span id="l9.487" class="difflineplus">+        history.index &lt; this._sessionhistory_max_entries - 1 &amp;&amp; !aFullData) {</span>
<a href="#l9.488"></a><span id="l9.488">       tabData = browser.parentNode.__SS_data;</span>
<a href="#l9.489"></a><span id="l9.489">       tabData.index = history.index + 1;</span>
<a href="#l9.490"></a><span id="l9.490">     }</span>
<a href="#l9.491"></a><span id="l9.491">     else if (history &amp;&amp; history.count &gt; 0) {</span>
<a href="#l9.492"></a><span id="l9.492">       for (var j = 0; j &lt; history.count; j++)</span>
<a href="#l9.493"></a><span id="l9.493">         tabData.entries.push(this._serializeHistoryEntry(history.getEntryAtIndex(j, false),</span>
<a href="#l9.494"></a><span id="l9.494">                                                          aFullData));</span>
<a href="#l9.495"></a><span id="l9.495">       tabData.index = history.index + 1;</span>
<a href="#l9.496"></a><span id="l9.496" class="difflineat">@@ -1136,17 +1158,18 @@ SessionStoreService.prototype = {</span>
<a href="#l9.497"></a><span id="l9.497">    * @param aWindow</span>
<a href="#l9.498"></a><span id="l9.498">    *        Window reference</span>
<a href="#l9.499"></a><span id="l9.499">    */</span>
<a href="#l9.500"></a><span id="l9.500">   _updateTextAndScrollData: function sss_updateTextAndScrollData(aWindow) {</span>
<a href="#l9.501"></a><span id="l9.501">     var browsers = aWindow.getBrowser().browsers;</span>
<a href="#l9.502"></a><span id="l9.502">     for (var i = 0; i &lt; browsers.length; i++) {</span>
<a href="#l9.503"></a><span id="l9.503">       try {</span>
<a href="#l9.504"></a><span id="l9.504">         var tabData = this._windows[aWindow.__SSi].tabs[i];</span>
<a href="#l9.505"></a><span id="l9.505" class="difflineminus">-        if (browsers[i].parentNode.__SS_data &amp;&amp; browsers[i].parentNode.__SS_data._tab)</span>
<a href="#l9.506"></a><span id="l9.506" class="difflineplus">+        if (browsers[i].parentNode.__SS_data &amp;&amp;</span>
<a href="#l9.507"></a><span id="l9.507" class="difflineplus">+            browsers[i].parentNode.__SS_data._tabStillLoading)</span>
<a href="#l9.508"></a><span id="l9.508">           continue; // ignore incompletely initialized tabs</span>
<a href="#l9.509"></a><span id="l9.509">         this._updateTextAndScrollDataForTab(aWindow, browsers[i], tabData);</span>
<a href="#l9.510"></a><span id="l9.510">       }</span>
<a href="#l9.511"></a><span id="l9.511">       catch (ex) { debug(ex); } // get as much data as possible, ignore failures (might succeed the next time)</span>
<a href="#l9.512"></a><span id="l9.512">     }</span>
<a href="#l9.513"></a><span id="l9.513">   },</span>
<a href="#l9.514"></a><span id="l9.514"> </span>
<a href="#l9.515"></a><span id="l9.515">   /**</span>
<a href="#l9.516"></a><span id="l9.516" class="difflineat">@@ -1204,17 +1227,18 @@ SessionStoreService.prototype = {</span>
<a href="#l9.517"></a><span id="l9.517">                                                  aUpdateFormData, aFullData) {</span>
<a href="#l9.518"></a><span id="l9.518">     for (var i = 0; i &lt; aContent.frames.length; i++) {</span>
<a href="#l9.519"></a><span id="l9.519">       if (aData.children &amp;&amp; aData.children[i])</span>
<a href="#l9.520"></a><span id="l9.520">         this._updateTextAndScrollDataForFrame(aWindow, aContent.frames[i],</span>
<a href="#l9.521"></a><span id="l9.521">                                               aData.children[i], aUpdateFormData, aFullData);</span>
<a href="#l9.522"></a><span id="l9.522">     }</span>
<a href="#l9.523"></a><span id="l9.523">     var isHTTPS = this._getURIFromString((aContent.parent || aContent).</span>
<a href="#l9.524"></a><span id="l9.524">                                          document.location.href).schemeIs(&quot;https&quot;);</span>
<a href="#l9.525"></a><span id="l9.525" class="difflineminus">-    if (aFullData || this._checkPrivacyLevel(isHTTPS)) {</span>
<a href="#l9.526"></a><span id="l9.526" class="difflineplus">+    if (aFullData || this._checkPrivacyLevel(isHTTPS) ||</span>
<a href="#l9.527"></a><span id="l9.527" class="difflineplus">+        aContent.top.document.location.href == &quot;about:sessionrestore&quot;) {</span>
<a href="#l9.528"></a><span id="l9.528">       if (aFullData || aUpdateFormData) {</span>
<a href="#l9.529"></a><span id="l9.529">         let formData = this._collectFormDataForFrame(aContent.document);</span>
<a href="#l9.530"></a><span id="l9.530">         if (formData)</span>
<a href="#l9.531"></a><span id="l9.531">           aData.formdata = formData;</span>
<a href="#l9.532"></a><span id="l9.532">         else if (aData.formdata)</span>
<a href="#l9.533"></a><span id="l9.533">           delete aData.formdata;</span>
<a href="#l9.534"></a><span id="l9.534">       }</span>
<a href="#l9.535"></a><span id="l9.535"> </span>
<a href="#l9.536"></a><span id="l9.536" class="difflineat">@@ -1266,18 +1290,22 @@ SessionStoreService.prototype = {</span>
<a href="#l9.537"></a><span id="l9.537">                                        Components.interfaces.nsIDOMXPathResult.UNORDERED_NODE_ITERATOR_TYPE, null);</span>
<a href="#l9.538"></a><span id="l9.538">     let node = formNodes.iterateNext();</span>
<a href="#l9.539"></a><span id="l9.539">     if (!node)</span>
<a href="#l9.540"></a><span id="l9.540">       return null;</span>
<a href="#l9.541"></a><span id="l9.541"> </span>
<a href="#l9.542"></a><span id="l9.542">     let data = {};</span>
<a href="#l9.543"></a><span id="l9.543">     do {</span>
<a href="#l9.544"></a><span id="l9.544">       let id = node.id ? &quot;#&quot; + node.id : XPathHelper.generate(node);</span>
<a href="#l9.545"></a><span id="l9.545" class="difflineminus">-      if (node instanceof Components.interfaces.nsIDOMHTMLInputElement)</span>
<a href="#l9.546"></a><span id="l9.546" class="difflineminus">-        data[id] = node.type == &quot;checkbox&quot; || node.type == &quot;radio&quot; ? node.checked : node.value;</span>
<a href="#l9.547"></a><span id="l9.547" class="difflineplus">+      if (node instanceof Components.interfaces.nsIDOMHTMLInputElement) {</span>
<a href="#l9.548"></a><span id="l9.548" class="difflineplus">+        if (node.type != &quot;file&quot;)</span>
<a href="#l9.549"></a><span id="l9.549" class="difflineplus">+          data[id] = node.type == &quot;checkbox&quot; || node.type == &quot;radio&quot; ? node.checked : node.value;</span>
<a href="#l9.550"></a><span id="l9.550" class="difflineplus">+        else</span>
<a href="#l9.551"></a><span id="l9.551" class="difflineplus">+          data[id] = { type: &quot;file&quot;, value: node.value };</span>
<a href="#l9.552"></a><span id="l9.552" class="difflineplus">+      }</span>
<a href="#l9.553"></a><span id="l9.553">       else if (node instanceof Components.interfaces.nsIDOMHTMLTextAreaElement)</span>
<a href="#l9.554"></a><span id="l9.554">         data[id] = node.value;</span>
<a href="#l9.555"></a><span id="l9.555">       else if (!node.multiple)</span>
<a href="#l9.556"></a><span id="l9.556">         data[id] = node.selectedIndex;</span>
<a href="#l9.557"></a><span id="l9.557">       else {</span>
<a href="#l9.558"></a><span id="l9.558">         let options = Array.map(node.options, function(aOpt, aIx) aOpt.selected ? aIx : -1);</span>
<a href="#l9.559"></a><span id="l9.559">         data[id] = options.filter(function(aIx) aIx &gt;= 0);</span>
<a href="#l9.560"></a><span id="l9.560">       }</span>
<a href="#l9.561"></a><span id="l9.561" class="difflineat">@@ -1393,16 +1421,18 @@ SessionStoreService.prototype = {</span>
<a href="#l9.562"></a><span id="l9.562">    * @returns string</span>
<a href="#l9.563"></a><span id="l9.563">    */</span>
<a href="#l9.564"></a><span id="l9.564">   _getCurrentState: function sss_getCurrentState(aUpdateAll) {</span>
<a href="#l9.565"></a><span id="l9.565">     var activeWindow = this._getMostRecentBrowserWindow();</span>
<a href="#l9.566"></a><span id="l9.566"> </span>
<a href="#l9.567"></a><span id="l9.567">     if (this._loadState == STATE_RUNNING) {</span>
<a href="#l9.568"></a><span id="l9.568">       // update the data for all windows with activities since the last save operation</span>
<a href="#l9.569"></a><span id="l9.569">       this._forEachBrowserWindow(function(aWindow) {</span>
<a href="#l9.570"></a><span id="l9.570" class="difflineplus">+        if (!this._isWindowLoaded(aWindow)) // window data is still in _statesToRestore</span>
<a href="#l9.571"></a><span id="l9.571" class="difflineplus">+          return;</span>
<a href="#l9.572"></a><span id="l9.572">         if (aUpdateAll || this._dirtyWindows[aWindow.__SSi] || aWindow == activeWindow) {</span>
<a href="#l9.573"></a><span id="l9.573">           this._collectWindowData(aWindow);</span>
<a href="#l9.574"></a><span id="l9.574">         }</span>
<a href="#l9.575"></a><span id="l9.575">         else { // always update the window features (whose change alone never triggers a save operation)</span>
<a href="#l9.576"></a><span id="l9.576">           this._updateWindowFeatures(aWindow);</span>
<a href="#l9.577"></a><span id="l9.577">         }</span>
<a href="#l9.578"></a><span id="l9.578">       }, this);</span>
<a href="#l9.579"></a><span id="l9.579">       this._dirtyWindows = [];</span>
<a href="#l9.580"></a><span id="l9.580" class="difflineat">@@ -1414,16 +1444,26 @@ SessionStoreService.prototype = {</span>
<a href="#l9.581"></a><span id="l9.581">     var ix;</span>
<a href="#l9.582"></a><span id="l9.582">     for (ix in this._windows) {</span>
<a href="#l9.583"></a><span id="l9.583">       total.push(this._windows[ix]);</span>
<a href="#l9.584"></a><span id="l9.584">       windows.push(ix);</span>
<a href="#l9.585"></a><span id="l9.585">       if (!this._windows[ix].isPopup)</span>
<a href="#l9.586"></a><span id="l9.586">         nonPopupCount++;</span>
<a href="#l9.587"></a><span id="l9.587">     }</span>
<a href="#l9.588"></a><span id="l9.588">     this._updateCookies(total);</span>
<a href="#l9.589"></a><span id="l9.589" class="difflineplus">+</span>
<a href="#l9.590"></a><span id="l9.590" class="difflineplus">+    // collect the data for all windows yet to be restored</span>
<a href="#l9.591"></a><span id="l9.591" class="difflineplus">+    for (ix in this._statesToRestore) {</span>
<a href="#l9.592"></a><span id="l9.592" class="difflineplus">+      for each (let winData in this._statesToRestore[ix].windows) {</span>
<a href="#l9.593"></a><span id="l9.593" class="difflineplus">+        total.push(winData);</span>
<a href="#l9.594"></a><span id="l9.594" class="difflineplus">+        if (!winData.isPopup)</span>
<a href="#l9.595"></a><span id="l9.595" class="difflineplus">+          nonPopupCount++;</span>
<a href="#l9.596"></a><span id="l9.596" class="difflineplus">+      }</span>
<a href="#l9.597"></a><span id="l9.597" class="difflineplus">+    }</span>
<a href="#l9.598"></a><span id="l9.598" class="difflineplus">+</span>
<a href="#l9.599"></a><span id="l9.599">     // if no non-popup browser window remains open, return the state of the last closed window(s)</span>
<a href="#l9.600"></a><span id="l9.600">     if (nonPopupCount == 0 &amp;&amp; this._lastClosedWindows) {</span>
<a href="#l9.601"></a><span id="l9.601">       // prepend the last non-popup browser window, so that if the user loads more tabs</span>
<a href="#l9.602"></a><span id="l9.602">       // at startup we don't accidentally add them to a popup window</span>
<a href="#l9.603"></a><span id="l9.603">       total = this._lastClosedWindows.concat(total);</span>
<a href="#l9.604"></a><span id="l9.604">     }</span>
<a href="#l9.605"></a><span id="l9.605">     if (activeWindow) {</span>
<a href="#l9.606"></a><span id="l9.606">       this.activeWindowSSiCache = activeWindow.__SSi || &quot;&quot;;</span>
<a href="#l9.607"></a><span id="l9.607" class="difflineat">@@ -1434,28 +1474,34 @@ SessionStoreService.prototype = {</span>
<a href="#l9.608"></a><span id="l9.608"> </span>
<a href="#l9.609"></a><span id="l9.609">   /**</span>
<a href="#l9.610"></a><span id="l9.610">    * serialize session data for a window</span>
<a href="#l9.611"></a><span id="l9.611">    * @param aWindow</span>
<a href="#l9.612"></a><span id="l9.612">    *        Window reference</span>
<a href="#l9.613"></a><span id="l9.613">    * @returns string</span>
<a href="#l9.614"></a><span id="l9.614">    */</span>
<a href="#l9.615"></a><span id="l9.615">   _getWindowState: function sss_getWindowState(aWindow) {</span>
<a href="#l9.616"></a><span id="l9.616" class="difflineplus">+    if (!this._isWindowLoaded(aWindow))</span>
<a href="#l9.617"></a><span id="l9.617" class="difflineplus">+      return this._statesToRestore[aWindow.__SS_restoreID];</span>
<a href="#l9.618"></a><span id="l9.618" class="difflineplus">+</span>
<a href="#l9.619"></a><span id="l9.619">     if (this._loadState == STATE_RUNNING) {</span>
<a href="#l9.620"></a><span id="l9.620">       this._collectWindowData(aWindow);</span>
<a href="#l9.621"></a><span id="l9.621">     }</span>
<a href="#l9.622"></a><span id="l9.622"> </span>
<a href="#l9.623"></a><span id="l9.623">     var total = [this._windows[aWindow.__SSi]];</span>
<a href="#l9.624"></a><span id="l9.624">     total._closedTabs = this._windows[aWindow.__SSi].getBrowser().savedBrowsers.map(function(e) { return e.tabData; });</span>
<a href="#l9.625"></a><span id="l9.625">     this._updateCookies(total);</span>
<a href="#l9.626"></a><span id="l9.626"> </span>
<a href="#l9.627"></a><span id="l9.627">     return { windows: total };</span>
<a href="#l9.628"></a><span id="l9.628">   },</span>
<a href="#l9.629"></a><span id="l9.629"> </span>
<a href="#l9.630"></a><span id="l9.630">   _collectWindowData: function sss_collectWindowData(aWindow) {</span>
<a href="#l9.631"></a><span id="l9.631" class="difflineplus">+    if (!this._isWindowLoaded(aWindow))</span>
<a href="#l9.632"></a><span id="l9.632" class="difflineplus">+      return;</span>
<a href="#l9.633"></a><span id="l9.633" class="difflineplus">+</span>
<a href="#l9.634"></a><span id="l9.634">     // update the internal state data for this window</span>
<a href="#l9.635"></a><span id="l9.635">     this._saveWindowHistory(aWindow);</span>
<a href="#l9.636"></a><span id="l9.636">     this._updateTextAndScrollData(aWindow);</span>
<a href="#l9.637"></a><span id="l9.637">     this._updateCookieHosts(aWindow);</span>
<a href="#l9.638"></a><span id="l9.638">     this._updateWindowFeatures(aWindow);</span>
<a href="#l9.639"></a><span id="l9.639"> </span>
<a href="#l9.640"></a><span id="l9.640">     this._windows[aWindow.__SSi]._closedTabs = aWindow.getBrowser().savedBrowsers.map(function(e) { return e.tabData; });</span>
<a href="#l9.641"></a><span id="l9.641"> </span>
<a href="#l9.642"></a><span id="l9.642" class="difflineat">@@ -1520,39 +1566,40 @@ SessionStoreService.prototype = {</span>
<a href="#l9.643"></a><span id="l9.643">     else if (root._firstTabs &amp;&amp; !aOverwriteTabs &amp;&amp; winData.tabs.length == 1 &amp;&amp;</span>
<a href="#l9.644"></a><span id="l9.644">              (!winData.tabs[0].entries || winData.tabs[0].entries.length == 0)) {</span>
<a href="#l9.645"></a><span id="l9.645">       winData.tabs = [];</span>
<a href="#l9.646"></a><span id="l9.646">     }</span>
<a href="#l9.647"></a><span id="l9.647"> </span>
<a href="#l9.648"></a><span id="l9.648">     var tabbrowser = aWindow.getBrowser();</span>
<a href="#l9.649"></a><span id="l9.649">     var openTabCount = aOverwriteTabs ? tabbrowser.browsers.length : -1;</span>
<a href="#l9.650"></a><span id="l9.650">     var newTabCount = winData.tabs.length;</span>
<a href="#l9.651"></a><span id="l9.651" class="difflineplus">+    let tabs = [];</span>
<a href="#l9.652"></a><span id="l9.652"> </span>
<a href="#l9.653"></a><span id="l9.653">     for (var t = 0; t &lt; newTabCount; t++) {</span>
<a href="#l9.654"></a><span id="l9.654" class="difflineminus">-      winData.tabs[t]._tab = t &lt; openTabCount ? tabbrowser.mTabs[t] : tabbrowser.addTab();</span>
<a href="#l9.655"></a><span id="l9.655" class="difflineplus">+      tabs.push(t &lt; openTabCount ? tabbrowser.mTabs[t] : tabbrowser.addTab());</span>
<a href="#l9.656"></a><span id="l9.656">       // when resuming at startup: add additionally requested pages to the end</span>
<a href="#l9.657"></a><span id="l9.657">       if (!aOverwriteTabs &amp;&amp; root._firstTabs) {</span>
<a href="#l9.658"></a><span id="l9.658" class="difflineminus">-        tabbrowser.moveTabTo(winData.tabs[t]._tab, t);</span>
<a href="#l9.659"></a><span id="l9.659" class="difflineplus">+        tabbrowser.moveTabTo(tabs[t], t);</span>
<a href="#l9.660"></a><span id="l9.660">       }</span>
<a href="#l9.661"></a><span id="l9.661">     }</span>
<a href="#l9.662"></a><span id="l9.662"> </span>
<a href="#l9.663"></a><span id="l9.663">     // when overwriting tabs, remove all superflous ones</span>
<a href="#l9.664"></a><span id="l9.664">     for (t = openTabCount - 1; t &gt;= newTabCount; t--) {</span>
<a href="#l9.665"></a><span id="l9.665">       tabbrowser.removeTab(tabbrowser.mTabs[t]);</span>
<a href="#l9.666"></a><span id="l9.666">     }</span>
<a href="#l9.667"></a><span id="l9.667"> </span>
<a href="#l9.668"></a><span id="l9.668">     if (aOverwriteTabs) {</span>
<a href="#l9.669"></a><span id="l9.669">       this.restoreWindowFeatures(aWindow, winData);</span>
<a href="#l9.670"></a><span id="l9.670">     }</span>
<a href="#l9.671"></a><span id="l9.671">     if (winData.cookies) {</span>
<a href="#l9.672"></a><span id="l9.672">       this.restoreCookies(winData.cookies);</span>
<a href="#l9.673"></a><span id="l9.673">     }</span>
<a href="#l9.674"></a><span id="l9.674">     if (winData.extData) {</span>
<a href="#l9.675"></a><span id="l9.675" class="difflineminus">-      if (!this._windows[aWindow.__SSi].extData) {</span>
<a href="#l9.676"></a><span id="l9.676" class="difflineminus">-        this._windows[aWindow.__SSi].extData = {}</span>
<a href="#l9.677"></a><span id="l9.677" class="difflineplus">+      if (aOverwriteTabs  || !this._windows[aWindow.__SSi].extData) {</span>
<a href="#l9.678"></a><span id="l9.678" class="difflineplus">+        this._windows[aWindow.__SSi].extData = {};</span>
<a href="#l9.679"></a><span id="l9.679">       }</span>
<a href="#l9.680"></a><span id="l9.680">       for (var key in winData.extData) {</span>
<a href="#l9.681"></a><span id="l9.681">         this._windows[aWindow.__SSi].extData[key] = winData.extData[key];</span>
<a href="#l9.682"></a><span id="l9.682">       }</span>
<a href="#l9.683"></a><span id="l9.683">     }</span>
<a href="#l9.684"></a><span id="l9.684">     //this is firefox part of code, keeping it for reference only. Will be removed in final patch</span>
<a href="#l9.685"></a><span id="l9.685">     //misak if (winData._closedTabs &amp;&amp; (root._firstTabs || aOverwriteTabs)) {</span>
<a href="#l9.686"></a><span id="l9.686">     //  this._windows[aWindow.__SSi]._closedTabs = winData._closedTabs;</span>
<a href="#l9.687"></a><span id="l9.687" class="difflineat">@@ -1564,134 +1611,152 @@ SessionStoreService.prototype = {</span>
<a href="#l9.688"></a><span id="l9.688">       //aWindow.getBrowser().savedBrowsers.tabData = winData._closedTabs;</span>
<a href="#l9.689"></a><span id="l9.689">       //aWindow.getBrowser().savedBrowsers.map(function(e) { return e.tabData; })</span>
<a href="#l9.690"></a><span id="l9.690">     //  for ( var iix = winData._closedTabs.length - 1; iix &gt;= 0 ; iix--) {</span>
<a href="#l9.691"></a><span id="l9.691">         //aWindow.getBrowser().savedBrowsers[iix].tabData = winData._closedTabs[iix];</span>
<a href="#l9.692"></a><span id="l9.692">     //    aWindow.getBrowser().savedBrowsers.unshift({browser: aWindow.getBrowser(), history: {}, tabData: winData._closedTabs[iix] });</span>
<a href="#l9.693"></a><span id="l9.693">     //  }</span>
<a href="#l9.694"></a><span id="l9.694">     //}</span>
<a href="#l9.695"></a><span id="l9.695"> </span>
<a href="#l9.696"></a><span id="l9.696" class="difflineminus">-    this.restoreHistoryPrecursor(aWindow, winData.tabs, (aOverwriteTabs ?</span>
<a href="#l9.697"></a><span id="l9.697" class="difflineminus">-      (parseInt(winData.selected) || 1) : 0), 0, 0);</span>
<a href="#l9.698"></a><span id="l9.698" class="difflineplus">+    this.restoreHistoryPrecursor(aWindow, tabs, winData.tabs,</span>
<a href="#l9.699"></a><span id="l9.699" class="difflineplus">+      (aOverwriteTabs ? (parseInt(winData.selected) || 1) : 0), 0, 0);</span>
<a href="#l9.700"></a><span id="l9.700"> </span>
<a href="#l9.701"></a><span id="l9.701">     this._notifyIfAllWindowsRestored();</span>
<a href="#l9.702"></a><span id="l9.702">   },</span>
<a href="#l9.703"></a><span id="l9.703"> </span>
<a href="#l9.704"></a><span id="l9.704">   /**</span>
<a href="#l9.705"></a><span id="l9.705">    * Manage history restoration for a window</span>
<a href="#l9.706"></a><span id="l9.706" class="difflineplus">+   * @param aWindow</span>
<a href="#l9.707"></a><span id="l9.707" class="difflineplus">+   *        Window to restore the tabs into</span>
<a href="#l9.708"></a><span id="l9.708">    * @param aTabs</span>
<a href="#l9.709"></a><span id="l9.709" class="difflineplus">+   *        Array of tab references</span>
<a href="#l9.710"></a><span id="l9.710" class="difflineplus">+   * @param aTabData</span>
<a href="#l9.711"></a><span id="l9.711">    *        Array of tab data</span>
<a href="#l9.712"></a><span id="l9.712" class="difflineminus">-   * @param aCurrentTabs</span>
<a href="#l9.713"></a><span id="l9.713" class="difflineminus">-   *        Array of tab references</span>
<a href="#l9.714"></a><span id="l9.714">    * @param aSelectTab</span>
<a href="#l9.715"></a><span id="l9.715">    *        Index of selected tab</span>
<a href="#l9.716"></a><span id="l9.716">    * @param aIx</span>
<a href="#l9.717"></a><span id="l9.717">    *        Index of the next tab to check readyness for</span>
<a href="#l9.718"></a><span id="l9.718">    * @param aCount</span>
<a href="#l9.719"></a><span id="l9.719">    *        Counter for number of times delaying b/c browser or history aren't ready</span>
<a href="#l9.720"></a><span id="l9.720">    */</span>
<a href="#l9.721"></a><span id="l9.721" class="difflineminus">-  restoreHistoryPrecursor: function sss_restoreHistoryPrecursor(aWindow, aTabs, aSelectTab, aIx, aCount) {</span>
<a href="#l9.722"></a><span id="l9.722" class="difflineplus">+  restoreHistoryPrecursor:</span>
<a href="#l9.723"></a><span id="l9.723" class="difflineplus">+    function sss_restoreHistoryPrecursor(aWindow, aTabs, aTabData, aSelectTab, aIx, aCount) {</span>
<a href="#l9.724"></a><span id="l9.724">     var tabbrowser = aWindow.getBrowser();</span>
<a href="#l9.725"></a><span id="l9.725"> </span>
<a href="#l9.726"></a><span id="l9.726">     // make sure that all browsers and their histories are available</span>
<a href="#l9.727"></a><span id="l9.727">     // - if one's not, resume this check in 100ms (repeat at most 10 times)</span>
<a href="#l9.728"></a><span id="l9.728">     for (var t = aIx; t &lt; aTabs.length; t++) {</span>
<a href="#l9.729"></a><span id="l9.729">       try {</span>
<a href="#l9.730"></a><span id="l9.730" class="difflineminus">-        if (!tabbrowser.getBrowserForTab(aTabs[t]._tab).webNavigation.sessionHistory) {</span>
<a href="#l9.731"></a><span id="l9.731" class="difflineplus">+        if (!tabbrowser.getBrowserForTab(aTabs[t]).webNavigation.sessionHistory) {</span>
<a href="#l9.732"></a><span id="l9.732">           throw new Error();</span>
<a href="#l9.733"></a><span id="l9.733">         }</span>
<a href="#l9.734"></a><span id="l9.734">       }</span>
<a href="#l9.735"></a><span id="l9.735">       catch (ex) { // in case browser or history aren't ready yet</span>
<a href="#l9.736"></a><span id="l9.736">         if (aCount &lt; 10) {</span>
<a href="#l9.737"></a><span id="l9.737">           var restoreHistoryFunc = function(self) {</span>
<a href="#l9.738"></a><span id="l9.738" class="difflineminus">-            self.restoreHistoryPrecursor(aWindow, aTabs, aSelectTab, aIx, aCount + 1);</span>
<a href="#l9.739"></a><span id="l9.739" class="difflineplus">+            self.restoreHistoryPrecursor(aWindow, aTabs, aTabData, aSelectTab, aIx, aCount + 1);</span>
<a href="#l9.740"></a><span id="l9.740">           }</span>
<a href="#l9.741"></a><span id="l9.741">           aWindow.setTimeout(restoreHistoryFunc, 100, this);</span>
<a href="#l9.742"></a><span id="l9.742">           return;</span>
<a href="#l9.743"></a><span id="l9.743">         }</span>
<a href="#l9.744"></a><span id="l9.744">       }</span>
<a href="#l9.745"></a><span id="l9.745">     }</span>
<a href="#l9.746"></a><span id="l9.746"> </span>
<a href="#l9.747"></a><span id="l9.747">     // mark the tabs as loading</span>
<a href="#l9.748"></a><span id="l9.748">     for (t = 0; t &lt; aTabs.length; t++) {</span>
<a href="#l9.749"></a><span id="l9.749" class="difflineminus">-      var tab = aTabs[t]._tab;</span>
<a href="#l9.750"></a><span id="l9.750" class="difflineplus">+      var tab = aTabs[t];</span>
<a href="#l9.751"></a><span id="l9.751">       var browser = tabbrowser.getBrowserForTab(tab);</span>
<a href="#l9.752"></a><span id="l9.752"> </span>
<a href="#l9.753"></a><span id="l9.753" class="difflineminus">-      if (!aTabs[t].entries || aTabs[t].entries.length == 0) {</span>
<a href="#l9.754"></a><span id="l9.754" class="difflineplus">+      aTabData[t]._tabStillLoading = true;</span>
<a href="#l9.755"></a><span id="l9.755" class="difflineplus">+      if (!aTabData[t].entries || aTabData[t].entries.length == 0) {</span>
<a href="#l9.756"></a><span id="l9.756">         // make sure to blank out this tab's content</span>
<a href="#l9.757"></a><span id="l9.757">         // (just purging the tab's history won't be enough)</span>
<a href="#l9.758"></a><span id="l9.758">         browser.contentDocument.location = &quot;about:blank&quot;;</span>
<a href="#l9.759"></a><span id="l9.759">         continue;</span>
<a href="#l9.760"></a><span id="l9.760">       }</span>
<a href="#l9.761"></a><span id="l9.761"> </span>
<a href="#l9.762"></a><span id="l9.762">       browser.stop(); // in case about:blank isn't done yet</span>
<a href="#l9.763"></a><span id="l9.763"> </span>
<a href="#l9.764"></a><span id="l9.764">       tab.setAttribute(&quot;busy&quot;, &quot;true&quot;);</span>
<a href="#l9.765"></a><span id="l9.765">       tab.removeAttribute(&quot;image&quot;);</span>
<a href="#l9.766"></a><span id="l9.766">       // not implemented in suite - replacing with two lines tabbrowser.setTabTitleLoading(tab);</span>
<a href="#l9.767"></a><span id="l9.767">       // tab.label = this.mStringBundle.getString(&quot;tabs.loading&quot;);</span>
<a href="#l9.768"></a><span id="l9.768">       // tab.setAttribute(&quot;crop&quot;, &quot;end&quot;);</span>
<a href="#l9.769"></a><span id="l9.769"> </span>
<a href="#l9.770"></a><span id="l9.770">       // wall-paper fix for bug 439675: make sure that the URL to be loaded</span>
<a href="#l9.771"></a><span id="l9.771">       // is always visible in the address bar</span>
<a href="#l9.772"></a><span id="l9.772" class="difflineminus">-      let activeIndex = (aTabs[t].index || aTabs[t].entries.length) - 1;</span>
<a href="#l9.773"></a><span id="l9.773" class="difflineminus">-      let activePageData = aTabs[t].entries[activeIndex] || null;</span>
<a href="#l9.774"></a><span id="l9.774" class="difflineplus">+      let activeIndex = (aTabData[t].index || aTabData[t].entries.length) - 1;</span>
<a href="#l9.775"></a><span id="l9.775" class="difflineplus">+      let activePageData = aTabData[t].entries[activeIndex] || null;</span>
<a href="#l9.776"></a><span id="l9.776">       browser.userTypedValue = activePageData ? activePageData.url || null : null;</span>
<a href="#l9.777"></a><span id="l9.777"> </span>
<a href="#l9.778"></a><span id="l9.778">       // keep the data around to prevent dataloss in case</span>
<a href="#l9.779"></a><span id="l9.779">       // a tab gets closed before it's been properly restored</span>
<a href="#l9.780"></a><span id="l9.780" class="difflineminus">-      browser.parentNode.__SS_data = aTabs[t];</span>
<a href="#l9.781"></a><span id="l9.781" class="difflineplus">+      browser.parentNode.__SS_data = aTabData[t];</span>
<a href="#l9.782"></a><span id="l9.782">     }</span>
<a href="#l9.783"></a><span id="l9.783"> </span>
<a href="#l9.784"></a><span id="l9.784">     // make sure to restore the selected tab first (if any)</span>
<a href="#l9.785"></a><span id="l9.785">     if (aSelectTab-- &amp;&amp; aTabs[aSelectTab]) {</span>
<a href="#l9.786"></a><span id="l9.786">         aTabs.unshift(aTabs.splice(aSelectTab, 1)[0]);</span>
<a href="#l9.787"></a><span id="l9.787" class="difflineminus">-        tabbrowser.selectedTab = aTabs[0]._tab;</span>
<a href="#l9.788"></a><span id="l9.788" class="difflineplus">+        aTabData.unshift(aTabData.splice(aSelectTab, 1)[0]);</span>
<a href="#l9.789"></a><span id="l9.789" class="difflineplus">+        tabbrowser.selectedTab = aTabs[0];</span>
<a href="#l9.790"></a><span id="l9.790" class="difflineplus">+    }</span>
<a href="#l9.791"></a><span id="l9.791" class="difflineplus">+</span>
<a href="#l9.792"></a><span id="l9.792" class="difflineplus">+    if (!this._isWindowLoaded(aWindow)) {</span>
<a href="#l9.793"></a><span id="l9.793" class="difflineplus">+      // from now on, the data will come from the actual window</span>
<a href="#l9.794"></a><span id="l9.794" class="difflineplus">+      delete this._statesToRestore[aWindow.__SS_restoreID];</span>
<a href="#l9.795"></a><span id="l9.795" class="difflineplus">+      delete aWindow.__SS_restoreID;</span>
<a href="#l9.796"></a><span id="l9.796">     }</span>
<a href="#l9.797"></a><span id="l9.797"> </span>
<a href="#l9.798"></a><span id="l9.798">     // helper hash for ensuring unique frame IDs</span>
<a href="#l9.799"></a><span id="l9.799">     var idMap = { used: {} };</span>
<a href="#l9.800"></a><span id="l9.800" class="difflineminus">-    this.restoreHistory(aWindow, aTabs, idMap);</span>
<a href="#l9.801"></a><span id="l9.801" class="difflineplus">+    this.restoreHistory(aWindow, aTabs, aTabData, idMap);</span>
<a href="#l9.802"></a><span id="l9.802">   },</span>
<a href="#l9.803"></a><span id="l9.803"> </span>
<a href="#l9.804"></a><span id="l9.804">   /**</span>
<a href="#l9.805"></a><span id="l9.805">    * Restore history for a window</span>
<a href="#l9.806"></a><span id="l9.806">    * @param aWindow</span>
<a href="#l9.807"></a><span id="l9.807">    *        Window reference</span>
<a href="#l9.808"></a><span id="l9.808">    * @param aTabs</span>
<a href="#l9.809"></a><span id="l9.809" class="difflineplus">+   *        Array of tab references</span>
<a href="#l9.810"></a><span id="l9.810" class="difflineplus">+   * @param aTabData</span>
<a href="#l9.811"></a><span id="l9.811">    *        Array of tab data</span>
<a href="#l9.812"></a><span id="l9.812">    * @param aIdMap</span>
<a href="#l9.813"></a><span id="l9.813">    *        Hash for ensuring unique frame IDs</span>
<a href="#l9.814"></a><span id="l9.814">    */</span>
<a href="#l9.815"></a><span id="l9.815" class="difflineminus">-  restoreHistory: function sss_restoreHistory(aWindow, aTabs, aIdMap) {</span>
<a href="#l9.816"></a><span id="l9.816" class="difflineplus">+  restoreHistory: function sss_restoreHistory(aWindow, aTabs, aTabData, aIdMap) {</span>
<a href="#l9.817"></a><span id="l9.817">     var _this = this;</span>
<a href="#l9.818"></a><span id="l9.818" class="difflineminus">-    while (aTabs.length &gt; 0 &amp;&amp; (!aTabs[0]._tab || !aTabs[0]._tab.parentNode)) {</span>
<a href="#l9.819"></a><span id="l9.819" class="difflineplus">+    while (aTabs.length &gt; 0 &amp;&amp; (!aTabData[0]._tabStillLoading || !aTabs[0].parentNode)) {</span>
<a href="#l9.820"></a><span id="l9.820">       aTabs.shift(); // this tab got removed before being completely restored</span>
<a href="#l9.821"></a><span id="l9.821" class="difflineplus">+      aTabData.shift();</span>
<a href="#l9.822"></a><span id="l9.822">     }</span>
<a href="#l9.823"></a><span id="l9.823">     if (aTabs.length == 0) {</span>
<a href="#l9.824"></a><span id="l9.824">       return; // no more tabs to restore</span>
<a href="#l9.825"></a><span id="l9.825">     }</span>
<a href="#l9.826"></a><span id="l9.826"> </span>
<a href="#l9.827"></a><span id="l9.827" class="difflineminus">-    var tabData = aTabs.shift();</span>
<a href="#l9.828"></a><span id="l9.828" class="difflineplus">+    var tab = aTabs.shift();</span>
<a href="#l9.829"></a><span id="l9.829" class="difflineplus">+    var tabData = aTabData.shift();</span>
<a href="#l9.830"></a><span id="l9.830"> </span>
<a href="#l9.831"></a><span id="l9.831" class="difflineminus">-    var tab = tabData._tab;</span>
<a href="#l9.832"></a><span id="l9.832">     var browser = aWindow.getBrowser().getBrowserForTab(tab);</span>
<a href="#l9.833"></a><span id="l9.833">     var history = browser.webNavigation.sessionHistory;</span>
<a href="#l9.834"></a><span id="l9.834"> </span>
<a href="#l9.835"></a><span id="l9.835">     if (history.count &gt; 0) {</span>
<a href="#l9.836"></a><span id="l9.836">       history.PurgeHistory(history.count);</span>
<a href="#l9.837"></a><span id="l9.837">     }</span>
<a href="#l9.838"></a><span id="l9.838">     history.QueryInterface(Components.interfaces.nsISHistoryInternal);</span>
<a href="#l9.839"></a><span id="l9.839"> </span>
<a href="#l9.840"></a><span id="l9.840">     if (!tabData.entries) {</span>
<a href="#l9.841"></a><span id="l9.841">       tabData.entries = [];</span>
<a href="#l9.842"></a><span id="l9.842">     }</span>
<a href="#l9.843"></a><span id="l9.843">     if (tabData.extData) {</span>
<a href="#l9.844"></a><span id="l9.844" class="difflineminus">-      tab.__SS_extdata = tabData.extData;</span>
<a href="#l9.845"></a><span id="l9.845" class="difflineplus">+      tab.__SS_extdata = {};</span>
<a href="#l9.846"></a><span id="l9.846" class="difflineplus">+      for (let key in tabData.extData)</span>
<a href="#l9.847"></a><span id="l9.847" class="difflineplus">+        tab.__SS_extdata[key] = tabData.extData[key];</span>
<a href="#l9.848"></a><span id="l9.848">     }</span>
<a href="#l9.849"></a><span id="l9.849" class="difflineplus">+    else</span>
<a href="#l9.850"></a><span id="l9.850" class="difflineplus">+      delete tab.__SS_extdata;</span>
<a href="#l9.851"></a><span id="l9.851"> </span>
<a href="#l9.852"></a><span id="l9.852">     for (var i = 0; i &lt; tabData.entries.length; i++) {</span>
<a href="#l9.853"></a><span id="l9.853">       history.addEntry(this._deserializeHistoryEntry(tabData.entries[i], aIdMap), true);</span>
<a href="#l9.854"></a><span id="l9.854">     }</span>
<a href="#l9.855"></a><span id="l9.855"> </span>
<a href="#l9.856"></a><span id="l9.856">     // make sure to reset the capabilities and attributes, in case this tab gets reused</span>
<a href="#l9.857"></a><span id="l9.857">     var disallow = (tabData.disallow)?tabData.disallow.split(&quot;,&quot;):[];</span>
<a href="#l9.858"></a><span id="l9.858">     CAPABILITIES.forEach(function(aCapability) {</span>
<a href="#l9.859"></a><span id="l9.859" class="difflineat">@@ -1738,17 +1803,17 @@ SessionStoreService.prototype = {</span>
<a href="#l9.860"></a><span id="l9.860">       browser.__SS_restore_data = tabData.entries[activeIndex] || {};</span>
<a href="#l9.861"></a><span id="l9.861">       browser.__SS_restore_text = tabData.text || &quot;&quot;;</span>
<a href="#l9.862"></a><span id="l9.862">       browser.__SS_restore_pageStyle = tabData.pageStyle || &quot;&quot;;</span>
<a href="#l9.863"></a><span id="l9.863">       browser.__SS_restore_tab = tab;</span>
<a href="#l9.864"></a><span id="l9.864">       browser.__SS_restore = this.restoreDocument_proxy;</span>
<a href="#l9.865"></a><span id="l9.865">       browser.addEventListener(&quot;load&quot;, browser.__SS_restore, true);</span>
<a href="#l9.866"></a><span id="l9.866">     }</span>
<a href="#l9.867"></a><span id="l9.867"> </span>
<a href="#l9.868"></a><span id="l9.868" class="difflineminus">-    aWindow.setTimeout(function(){ _this.restoreHistory(aWindow, aTabs, aIdMap); }, 0);</span>
<a href="#l9.869"></a><span id="l9.869" class="difflineplus">+    aWindow.setTimeout(function(){ _this.restoreHistory(aWindow, aTabs, aTabData, aIdMap); }, 0);</span>
<a href="#l9.870"></a><span id="l9.870">   },</span>
<a href="#l9.871"></a><span id="l9.871"> </span>
<a href="#l9.872"></a><span id="l9.872">   /**</span>
<a href="#l9.873"></a><span id="l9.873">    * expands serialized history data into a session-history-entry instance</span>
<a href="#l9.874"></a><span id="l9.874">    * @param aEntry</span>
<a href="#l9.875"></a><span id="l9.875">    *        Object containing serialized history data for a URL</span>
<a href="#l9.876"></a><span id="l9.876">    * @param aIdMap</span>
<a href="#l9.877"></a><span id="l9.877">    *        Hash for ensuring unique frame IDs</span>
<a href="#l9.878"></a><span id="l9.878" class="difflineat">@@ -1837,17 +1902,17 @@ SessionStoreService.prototype = {</span>
<a href="#l9.879"></a><span id="l9.879">   /**</span>
<a href="#l9.880"></a><span id="l9.880">    * restores all sessionStorage &quot;super cookies&quot;</span>
<a href="#l9.881"></a><span id="l9.881">    * @param aStorageData</span>
<a href="#l9.882"></a><span id="l9.882">    *        Storage data to be restored</span>
<a href="#l9.883"></a><span id="l9.883">    * @param aDocShell</span>
<a href="#l9.884"></a><span id="l9.884">    *        A tab's docshell (containing the sessionStorage)</span>
<a href="#l9.885"></a><span id="l9.885">    */</span>
<a href="#l9.886"></a><span id="l9.886">   _deserializeSessionStorage: function sss_deserializeSessionStorage(aStorageData, aDocShell) {</span>
<a href="#l9.887"></a><span id="l9.887" class="difflineminus">-    let ioService = Cc[&quot;@mozilla.org/network/io-service;1&quot;].getService(Components.interfaces.nsIIOService);</span>
<a href="#l9.888"></a><span id="l9.888" class="difflineplus">+    let ioService = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;].getService(Components.interfaces.nsIIOService);</span>
<a href="#l9.889"></a><span id="l9.889">     for (let url in aStorageData) {</span>
<a href="#l9.890"></a><span id="l9.890">       let uri = ioService.newURI(url, null, null);</span>
<a href="#l9.891"></a><span id="l9.891">       let storage = aDocShell.getSessionStorageForURI(uri);</span>
<a href="#l9.892"></a><span id="l9.892">       for (let key in aStorageData[url]) {</span>
<a href="#l9.893"></a><span id="l9.893">         try {</span>
<a href="#l9.894"></a><span id="l9.894">           storage.setItem(key, aStorageData[url][key].value);</span>
<a href="#l9.895"></a><span id="l9.895">           if (uri.schemeIs(&quot;https&quot;))</span>
<a href="#l9.896"></a><span id="l9.896">             storage.getItem(key).secure = aStorageData[url][key].secure || false;</span>
<a href="#l9.897"></a><span id="l9.897" class="difflineat">@@ -1873,17 +1938,17 @@ SessionStoreService.prototype = {</span>
<a href="#l9.898"></a><span id="l9.898">     // restore text data saved by SeaMonkey</span>
<a href="#l9.899"></a><span id="l9.899">     var textArray = this.__SS_restore_text ? this.__SS_restore_text.split(&quot; &quot;) : [];</span>
<a href="#l9.900"></a><span id="l9.900">     function restoreTextData(aContent, aPrefix, aURL) {</span>
<a href="#l9.901"></a><span id="l9.901">       textArray.forEach(function(aEntry) {</span>
<a href="#l9.902"></a><span id="l9.902">         if (/^((?:\d+\|)*)(#?)([^\s=]+)=(.*)$/.test(aEntry) &amp;&amp;</span>
<a href="#l9.903"></a><span id="l9.903">             RegExp.$1 == aPrefix &amp;&amp; hasExpectedURL(aContent.document, aURL)) {</span>
<a href="#l9.904"></a><span id="l9.904">           var document = aContent.document;</span>
<a href="#l9.905"></a><span id="l9.905">           var node = RegExp.$2 ? document.getElementById(RegExp.$3) : document.getElementsByName(RegExp.$3)[0] || null;</span>
<a href="#l9.906"></a><span id="l9.906" class="difflineminus">-          if (node &amp;&amp; &quot;value&quot; in node) {</span>
<a href="#l9.907"></a><span id="l9.907" class="difflineplus">+          if (node &amp;&amp; &quot;value&quot; in node &amp;&amp; node.type != &quot;file&quot;) {</span>
<a href="#l9.908"></a><span id="l9.908">             node.value = decodeURI(RegExp.$4);</span>
<a href="#l9.909"></a><span id="l9.909"> </span>
<a href="#l9.910"></a><span id="l9.910">             var event = document.createEvent(&quot;UIEvents&quot;);</span>
<a href="#l9.911"></a><span id="l9.911">             event.initUIEvent(&quot;input&quot;, true, true, aContent, 0);</span>
<a href="#l9.912"></a><span id="l9.912">             node.dispatchEvent(event);</span>
<a href="#l9.913"></a><span id="l9.913">           }</span>
<a href="#l9.914"></a><span id="l9.914">         }</span>
<a href="#l9.915"></a><span id="l9.915">       });</span>
<a href="#l9.916"></a><span id="l9.916" class="difflineat">@@ -1895,29 +1960,34 @@ SessionStoreService.prototype = {</span>
<a href="#l9.917"></a><span id="l9.917">           return;</span>
<a href="#l9.918"></a><span id="l9.918"> </span>
<a href="#l9.919"></a><span id="l9.919">         let node = key.charAt(0) == &quot;#&quot; ? aDocument.getElementById(key.slice(1)) :</span>
<a href="#l9.920"></a><span id="l9.920">                                           XPathHelper.resolve(aDocument, key);</span>
<a href="#l9.921"></a><span id="l9.921">         if (!node)</span>
<a href="#l9.922"></a><span id="l9.922">           continue;</span>
<a href="#l9.923"></a><span id="l9.923"> </span>
<a href="#l9.924"></a><span id="l9.924">         let value = aData[key];</span>
<a href="#l9.925"></a><span id="l9.925" class="difflineminus">-        if (typeof value == &quot;string&quot;) {</span>
<a href="#l9.926"></a><span id="l9.926" class="difflineplus">+        if (typeof value == &quot;string&quot; &amp;&amp; node.type != &quot;file&quot;) {</span>
<a href="#l9.927"></a><span id="l9.927" class="difflineplus">+          if (node.value == value)</span>
<a href="#l9.928"></a><span id="l9.928" class="difflineplus">+            continue; // don't dispatch an input event for no change</span>
<a href="#l9.929"></a><span id="l9.929" class="difflineplus">+</span>
<a href="#l9.930"></a><span id="l9.930">           node.value = value;</span>
<a href="#l9.931"></a><span id="l9.931"> </span>
<a href="#l9.932"></a><span id="l9.932">           let event = aDocument.createEvent(&quot;UIEvents&quot;);</span>
<a href="#l9.933"></a><span id="l9.933">           event.initUIEvent(&quot;input&quot;, true, true, aDocument.defaultView, 0);</span>
<a href="#l9.934"></a><span id="l9.934">           node.dispatchEvent(event);</span>
<a href="#l9.935"></a><span id="l9.935">         }</span>
<a href="#l9.936"></a><span id="l9.936">         else if (typeof value == &quot;boolean&quot;)</span>
<a href="#l9.937"></a><span id="l9.937">           node.checked = value;</span>
<a href="#l9.938"></a><span id="l9.938">         else if (typeof value == &quot;number&quot;)</span>
<a href="#l9.939"></a><span id="l9.939">           try {</span>
<a href="#l9.940"></a><span id="l9.940">             node.selectedIndex = value;</span>
<a href="#l9.941"></a><span id="l9.941">           } catch (ex) { /* throws for invalid indices */ }</span>
<a href="#l9.942"></a><span id="l9.942" class="difflineplus">+        else if (value &amp;&amp; value.type &amp;&amp; value.type == node.type)</span>
<a href="#l9.943"></a><span id="l9.943" class="difflineplus">+          node.value = value.value;</span>
<a href="#l9.944"></a><span id="l9.944">         else if (value &amp;&amp; typeof value.indexOf == &quot;function&quot; &amp;&amp; node.options) {</span>
<a href="#l9.945"></a><span id="l9.945">           Array.forEach(node.options, function(aOpt, aIx) {</span>
<a href="#l9.946"></a><span id="l9.946">             aOpt.selected = value.indexOf(aIx) &gt; -1;</span>
<a href="#l9.947"></a><span id="l9.947">           });</span>
<a href="#l9.948"></a><span id="l9.948">         }</span>
<a href="#l9.949"></a><span id="l9.949">         // NB: dispatching &quot;change&quot; events might have unintended side-effects</span>
<a href="#l9.950"></a><span id="l9.950">       }</span>
<a href="#l9.951"></a><span id="l9.951">     }</span>
<a href="#l9.952"></a><span id="l9.952" class="difflineat">@@ -2026,30 +2096,39 @@ SessionStoreService.prototype = {</span>
<a href="#l9.953"></a><span id="l9.953"> </span>
<a href="#l9.954"></a><span id="l9.954">     // only modify those aspects which aren't correct yet</span>
<a href="#l9.955"></a><span id="l9.955">     if (aWidth &amp;&amp; aHeight &amp;&amp; (aWidth != win_(&quot;width&quot;) || aHeight != win_(&quot;height&quot;))) {</span>
<a href="#l9.956"></a><span id="l9.956">       aWindow.resizeTo(aWidth, aHeight);</span>
<a href="#l9.957"></a><span id="l9.957">     }</span>
<a href="#l9.958"></a><span id="l9.958">     if (!isNaN(aLeft) &amp;&amp; !isNaN(aTop) &amp;&amp; (aLeft != win_(&quot;screenX&quot;) || aTop != win_(&quot;screenY&quot;))) {</span>
<a href="#l9.959"></a><span id="l9.959">       aWindow.moveTo(aLeft, aTop);</span>
<a href="#l9.960"></a><span id="l9.960">     }</span>
<a href="#l9.961"></a><span id="l9.961" class="difflineminus">-    if (aSizeMode == &quot;maximized&quot; &amp;&amp; win_(&quot;sizemode&quot;) != &quot;maximized&quot;) {</span>
<a href="#l9.962"></a><span id="l9.962" class="difflineminus">-      aWindow.maximize();</span>
<a href="#l9.963"></a><span id="l9.963" class="difflineminus">-    }</span>
<a href="#l9.964"></a><span id="l9.964" class="difflineminus">-    else if (aSizeMode &amp;&amp; aSizeMode != &quot;maximized&quot; &amp;&amp; win_(&quot;sizemode&quot;) != &quot;normal&quot;) {</span>
<a href="#l9.965"></a><span id="l9.965" class="difflineminus">-      aWindow.restore();</span>
<a href="#l9.966"></a><span id="l9.966" class="difflineplus">+    switch (aSizeMode)</span>
<a href="#l9.967"></a><span id="l9.967" class="difflineplus">+    {</span>
<a href="#l9.968"></a><span id="l9.968" class="difflineplus">+    case &quot;maximized&quot;:</span>
<a href="#l9.969"></a><span id="l9.969" class="difflineplus">+       if (win_(&quot;sizemode&quot;) != &quot;maximized&quot;)</span>
<a href="#l9.970"></a><span id="l9.970" class="difflineplus">+         aWindow.maximize();</span>
<a href="#l9.971"></a><span id="l9.971" class="difflineplus">+    break</span>
<a href="#l9.972"></a><span id="l9.972" class="difflineplus">+    case &quot;minimized&quot;:</span>
<a href="#l9.973"></a><span id="l9.973" class="difflineplus">+       if (win_(&quot;sizemode&quot;) != &quot;minimized&quot;)</span>
<a href="#l9.974"></a><span id="l9.974" class="difflineplus">+         aWindow.minimize();</span>
<a href="#l9.975"></a><span id="l9.975" class="difflineplus">+       break</span>
<a href="#l9.976"></a><span id="l9.976" class="difflineplus">+    default:</span>
<a href="#l9.977"></a><span id="l9.977" class="difflineplus">+       if (win_(&quot;sizemode&quot;) != &quot;normal&quot;)</span>
<a href="#l9.978"></a><span id="l9.978" class="difflineplus">+         aWindow.restore();</span>
<a href="#l9.979"></a><span id="l9.979" class="difflineplus">+       break</span>
<a href="#l9.980"></a><span id="l9.980">     }</span>
<a href="#l9.981"></a><span id="l9.981">     var sidebar = aWindow.document.getElementById(&quot;sidebar-box&quot;);</span>
<a href="#l9.982"></a><span id="l9.982">     if (sidebar.getAttribute(&quot;sidebarcommand&quot;) != aSidebar) {</span>
<a href="#l9.983"></a><span id="l9.983">       aWindow.toggleSidebar(aSidebar);</span>
<a href="#l9.984"></a><span id="l9.984">     }</span>
<a href="#l9.985"></a><span id="l9.985">     // since resizing/moving a window brings it to the foreground,</span>
<a href="#l9.986"></a><span id="l9.986">     // we might want to re-focus the last focused window</span>
<a href="#l9.987"></a><span id="l9.987">     if (this.windowToFocus) {</span>
<a href="#l9.988"></a><span id="l9.988" class="difflineminus">-      this.windowToFocus.focus();</span>
<a href="#l9.989"></a><span id="l9.989" class="difflineplus">+      this.windowToFocus.content.focus();</span>
<a href="#l9.990"></a><span id="l9.990">     }</span>
<a href="#l9.991"></a><span id="l9.991">   },</span>
<a href="#l9.992"></a><span id="l9.992"> </span>
<a href="#l9.993"></a><span id="l9.993">   /**</span>
<a href="#l9.994"></a><span id="l9.994">    * Restores cookies (accepting both Firefox 2.0 and current format)</span>
<a href="#l9.995"></a><span id="l9.995">    * @param aCookies</span>
<a href="#l9.996"></a><span id="l9.996">    *        Array of cookie objects</span>
<a href="#l9.997"></a><span id="l9.997">    */</span>
<a href="#l9.998"></a><span id="l9.998" class="difflineat">@@ -2119,21 +2198,34 @@ SessionStoreService.prototype = {</span>
<a href="#l9.999"></a><span id="l9.999">    *        Bool update all windows</span>
<a href="#l9.1000"></a><span id="l9.1000">    */</span>
<a href="#l9.1001"></a><span id="l9.1001">   saveState: function sss_saveState(aUpdateAll) {</span>
<a href="#l9.1002"></a><span id="l9.1002">     // if crash recovery is disabled, only save session resuming information</span>
<a href="#l9.1003"></a><span id="l9.1003">     if (!this._resume_from_crash &amp;&amp; this._loadState == STATE_RUNNING)</span>
<a href="#l9.1004"></a><span id="l9.1004">       return;</span>
<a href="#l9.1005"></a><span id="l9.1005"> </span>
<a href="#l9.1006"></a><span id="l9.1006">     var oState = this._getCurrentState(aUpdateAll);</span>
<a href="#l9.1007"></a><span id="l9.1007" class="difflineminus">-    oState.session = { state: ((this._loadState == STATE_RUNNING) ? STATE_RUNNING_STR : STATE_STOPPED_STR) };</span>
<a href="#l9.1008"></a><span id="l9.1008" class="difflineplus">+    oState.session = {</span>
<a href="#l9.1009"></a><span id="l9.1009" class="difflineplus">+      state: this._loadState == STATE_RUNNING ? STATE_RUNNING_STR : STATE_STOPPED_STR,</span>
<a href="#l9.1010"></a><span id="l9.1010" class="difflineplus">+      lastUpdate: Date.now()</span>
<a href="#l9.1011"></a><span id="l9.1011" class="difflineplus">+    };</span>
<a href="#l9.1012"></a><span id="l9.1012" class="difflineplus">+    if (this._recentCrashes)</span>
<a href="#l9.1013"></a><span id="l9.1013" class="difflineplus">+      oState.session.recentCrashes = this._recentCrashes;</span>
<a href="#l9.1014"></a><span id="l9.1014"> </span>
<a href="#l9.1015"></a><span id="l9.1015" class="difflineplus">+    this._saveStateObject(oState);</span>
<a href="#l9.1016"></a><span id="l9.1016" class="difflineplus">+  },</span>
<a href="#l9.1017"></a><span id="l9.1017" class="difflineplus">+</span>
<a href="#l9.1018"></a><span id="l9.1018" class="difflineplus">+  /**</span>
<a href="#l9.1019"></a><span id="l9.1019" class="difflineplus">+   * write a state object to disk</span>
<a href="#l9.1020"></a><span id="l9.1020" class="difflineplus">+   */</span>
<a href="#l9.1021"></a><span id="l9.1021" class="difflineplus">+  _saveStateObject: function sss_saveStateObject(aStateObj) {</span>
<a href="#l9.1022"></a><span id="l9.1022">     var stateString = Components.classes[&quot;@mozilla.org/supports-string;1&quot;]</span>
<a href="#l9.1023"></a><span id="l9.1023">                                 .createInstance(Components.interfaces.nsISupportsString);</span>
<a href="#l9.1024"></a><span id="l9.1024" class="difflineminus">-    stateString.data = oState.toSource();</span>
<a href="#l9.1025"></a><span id="l9.1025" class="difflineplus">+    // parentheses are for backwards compatibility with older sessionstore files</span>
<a href="#l9.1026"></a><span id="l9.1026" class="difflineplus">+    stateString.data = &quot;(&quot; + this._toJSONString(aStateObj) + &quot;)&quot;;</span>
<a href="#l9.1027"></a><span id="l9.1027"> </span>
<a href="#l9.1028"></a><span id="l9.1028">     var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l9.1029"></a><span id="l9.1029">                                     .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l9.1030"></a><span id="l9.1030">     observerService.notifyObservers(stateString, &quot;sessionstore-state-write&quot;, &quot;&quot;);</span>
<a href="#l9.1031"></a><span id="l9.1031"> </span>
<a href="#l9.1032"></a><span id="l9.1032">     // don't touch the file if an observer has deleted all state data</span>
<a href="#l9.1033"></a><span id="l9.1033">     if (stateString.data)</span>
<a href="#l9.1034"></a><span id="l9.1034">       this._writeFile(this._sessionFile, stateString.data);</span>
<a href="#l9.1035"></a><span id="l9.1035" class="difflineat">@@ -2202,23 +2294,20 @@ SessionStoreService.prototype = {</span>
<a href="#l9.1036"></a><span id="l9.1036">     argString.data = &quot;about:blank&quot;;</span>
<a href="#l9.1037"></a><span id="l9.1037"> </span>
<a href="#l9.1038"></a><span id="l9.1038">     //XXXzeniko shouldn't it be possible to set the window's dimensions here (as feature)?</span>
<a href="#l9.1039"></a><span id="l9.1039">     var window = Components.classes[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l9.1040"></a><span id="l9.1040">                            .getService(Components.interfaces.nsIWindowWatcher)</span>
<a href="#l9.1041"></a><span id="l9.1041">                            .openWindow(null, this._prefBranch.getCharPref(&quot;chromeURL&quot;), &quot;_blank&quot;,</span>
<a href="#l9.1042"></a><span id="l9.1042">                             &quot;chrome,dialog=no,all&quot;, argString);</span>
<a href="#l9.1043"></a><span id="l9.1043"> </span>
<a href="#l9.1044"></a><span id="l9.1044" class="difflineminus">-    window.__SS_state = aState;</span>
<a href="#l9.1045"></a><span id="l9.1045" class="difflineminus">-    var _this = this;</span>
<a href="#l9.1046"></a><span id="l9.1046" class="difflineminus">-    window.addEventListener(&quot;load&quot;, function(aEvent) {</span>
<a href="#l9.1047"></a><span id="l9.1047" class="difflineminus">-      aEvent.currentTarget.removeEventListener(&quot;load&quot;, arguments.callee, true);</span>
<a href="#l9.1048"></a><span id="l9.1048" class="difflineminus">-      _this.restoreWindow(aEvent.currentTarget, aEvent.currentTarget.__SS_state, true, true);</span>
<a href="#l9.1049"></a><span id="l9.1049" class="difflineminus">-      delete aEvent.currentTarget.__SS_state;</span>
<a href="#l9.1050"></a><span id="l9.1050" class="difflineminus">-    }, true);</span>
<a href="#l9.1051"></a><span id="l9.1051" class="difflineplus">+    do {</span>
<a href="#l9.1052"></a><span id="l9.1052" class="difflineplus">+      var ID = &quot;window&quot; + Math.random();</span>
<a href="#l9.1053"></a><span id="l9.1053" class="difflineplus">+    } while (ID in this._statesToRestore);</span>
<a href="#l9.1054"></a><span id="l9.1054" class="difflineplus">+    this._statesToRestore[(window.__SS_restoreID = ID)] = aState;</span>
<a href="#l9.1055"></a><span id="l9.1055"> </span>
<a href="#l9.1056"></a><span id="l9.1056">     return window;</span>
<a href="#l9.1057"></a><span id="l9.1057">   },</span>
<a href="#l9.1058"></a><span id="l9.1058"> </span>
<a href="#l9.1059"></a><span id="l9.1059">   /**</span>
<a href="#l9.1060"></a><span id="l9.1060">    * Whether or not to resume session, if not recovering from a crash.</span>
<a href="#l9.1061"></a><span id="l9.1061">    * @returns bool</span>
<a href="#l9.1062"></a><span id="l9.1062">    */</span>
<a href="#l9.1063"></a><span id="l9.1063" class="difflineat">@@ -2338,54 +2427,90 @@ SessionStoreService.prototype = {</span>
<a href="#l9.1064"></a><span id="l9.1064">     catch (ex) {</span>
<a href="#l9.1065"></a><span id="l9.1065">       // don't make noise when crashreporter is built but not enabled</span>
<a href="#l9.1066"></a><span id="l9.1066">       if (ex.result != Components.results.NS_ERROR_NOT_INITIALIZED)</span>
<a href="#l9.1067"></a><span id="l9.1067">         debug(ex);</span>
<a href="#l9.1068"></a><span id="l9.1068">     }</span>
<a href="#l9.1069"></a><span id="l9.1069">   },</span>
<a href="#l9.1070"></a><span id="l9.1070"> </span>
<a href="#l9.1071"></a><span id="l9.1071">   /**</span>
<a href="#l9.1072"></a><span id="l9.1072" class="difflineplus">+   * @param aState is a session state</span>
<a href="#l9.1073"></a><span id="l9.1073" class="difflineplus">+   * @param aRecentCrashes is the number of consecutive crashes</span>
<a href="#l9.1074"></a><span id="l9.1074" class="difflineplus">+   * @returns whether a restore page will be needed for the session state</span>
<a href="#l9.1075"></a><span id="l9.1075" class="difflineplus">+   */</span>
<a href="#l9.1076"></a><span id="l9.1076" class="difflineplus">+  _needsRestorePage: function sss_needsRestorePage(aState, aRecentCrashes) {</span>
<a href="#l9.1077"></a><span id="l9.1077" class="difflineplus">+    const SIX_HOURS_IN_MS = 6 * 60 * 60 * 1000;</span>
<a href="#l9.1078"></a><span id="l9.1078" class="difflineplus">+</span>
<a href="#l9.1079"></a><span id="l9.1079" class="difflineplus">+    // don't wrap a single about:sessionrestore page</span>
<a href="#l9.1080"></a><span id="l9.1080" class="difflineplus">+    let winData = aState.windows || null;</span>
<a href="#l9.1081"></a><span id="l9.1081" class="difflineplus">+    if (winData &amp;&amp; winData.length == 1 &amp;&amp; winData[0].tabs &amp;&amp;</span>
<a href="#l9.1082"></a><span id="l9.1082" class="difflineplus">+        winData[0].tabs.length == 1 &amp;&amp; winData[0].tabs[0].entries &amp;&amp;</span>
<a href="#l9.1083"></a><span id="l9.1083" class="difflineplus">+        winData[0].tabs[0].entries.length == 1 &amp;&amp;</span>
<a href="#l9.1084"></a><span id="l9.1084" class="difflineplus">+        winData[0].tabs[0].entries[0].url == &quot;about:sessionrestore&quot;)</span>
<a href="#l9.1085"></a><span id="l9.1085" class="difflineplus">+      return false;</span>
<a href="#l9.1086"></a><span id="l9.1086" class="difflineplus">+</span>
<a href="#l9.1087"></a><span id="l9.1087" class="difflineplus">+    // don't automatically restore in Safe Mode</span>
<a href="#l9.1088"></a><span id="l9.1088" class="difflineplus">+    let XRE = Components.classes[&quot;@mozilla.org/xre/app-info;1&quot;].getService(Components.interfaces.nsIXULRuntime);</span>
<a href="#l9.1089"></a><span id="l9.1089" class="difflineplus">+    if (XRE.inSafeMode)</span>
<a href="#l9.1090"></a><span id="l9.1090" class="difflineplus">+      return true;</span>
<a href="#l9.1091"></a><span id="l9.1091" class="difflineplus">+</span>
<a href="#l9.1092"></a><span id="l9.1092" class="difflineplus">+    let max_resumed_crashes =</span>
<a href="#l9.1093"></a><span id="l9.1093" class="difflineplus">+      this._prefBranch.getIntPref(&quot;sessionstore.max_resumed_crashes&quot;);</span>
<a href="#l9.1094"></a><span id="l9.1094" class="difflineplus">+    let sessionAge = aState.session &amp;&amp; aState.session.lastUpdate &amp;&amp;</span>
<a href="#l9.1095"></a><span id="l9.1095" class="difflineplus">+                     (Date.now() - aState.session.lastUpdate);</span>
<a href="#l9.1096"></a><span id="l9.1096" class="difflineplus">+</span>
<a href="#l9.1097"></a><span id="l9.1097" class="difflineplus">+    return max_resumed_crashes != -1 &amp;&amp;</span>
<a href="#l9.1098"></a><span id="l9.1098" class="difflineplus">+           (aRecentCrashes &gt; max_resumed_crashes ||</span>
<a href="#l9.1099"></a><span id="l9.1099" class="difflineplus">+            sessionAge &amp;&amp; sessionAge &gt;= SIX_HOURS_IN_MS);</span>
<a href="#l9.1100"></a><span id="l9.1100" class="difflineplus">+  },</span>
<a href="#l9.1101"></a><span id="l9.1101" class="difflineplus">+</span>
<a href="#l9.1102"></a><span id="l9.1102" class="difflineplus">+  /**</span>
<a href="#l9.1103"></a><span id="l9.1103">    * safe eval'ing</span>
<a href="#l9.1104"></a><span id="l9.1104">    */</span>
<a href="#l9.1105"></a><span id="l9.1105">   _safeEval: function sss_safeEval(aStr) {</span>
<a href="#l9.1106"></a><span id="l9.1106">     return Components.utils.evalInSandbox(aStr, new Components.utils.Sandbox(&quot;about:blank&quot;));</span>
<a href="#l9.1107"></a><span id="l9.1107">   },</span>
<a href="#l9.1108"></a><span id="l9.1108"> </span>
<a href="#l9.1109"></a><span id="l9.1109">   /**</span>
<a href="#l9.1110"></a><span id="l9.1110">    * Converts a JavaScript object into a JSON string</span>
<a href="#l9.1111"></a><span id="l9.1111">    * (see http://www.json.org/ for more information).</span>
<a href="#l9.1112"></a><span id="l9.1112">    *</span>
<a href="#l9.1113"></a><span id="l9.1113" class="difflineminus">-   * The inverse operation consists of eval(&quot;(&quot; + JSON_string + &quot;)&quot;);</span>
<a href="#l9.1114"></a><span id="l9.1114" class="difflineminus">-   * and should be provably safe.</span>
<a href="#l9.1115"></a><span id="l9.1115" class="difflineplus">+   * The inverse operation consists of JSON.parse(JSON_string).</span>
<a href="#l9.1116"></a><span id="l9.1116">    *</span>
<a href="#l9.1117"></a><span id="l9.1117">    * @param aJSObject is the object to be converted</span>
<a href="#l9.1118"></a><span id="l9.1118" class="difflineminus">-   * @return the object's JSON representation</span>
<a href="#l9.1119"></a><span id="l9.1119" class="difflineplus">+   * @returns the object's JSON representation</span>
<a href="#l9.1120"></a><span id="l9.1120">    */</span>
<a href="#l9.1121"></a><span id="l9.1121">   _toJSONString: function sss_toJSONString(aJSObject) {</span>
<a href="#l9.1122"></a><span id="l9.1122" class="difflineminus">-    let str = JSONModule.toString(aJSObject, [&quot;_tab&quot;, &quot;_hosts&quot;, &quot;_formDataSaved&quot;] /* keys to drop */);</span>
<a href="#l9.1123"></a><span id="l9.1123" class="difflineminus">-</span>
<a href="#l9.1124"></a><span id="l9.1124" class="difflineminus">-    // sanity check - so that API consumers can just eval this string</span>
<a href="#l9.1125"></a><span id="l9.1125" class="difflineminus">-    if (!JSONModule.isMostlyHarmless(str))</span>
<a href="#l9.1126"></a><span id="l9.1126" class="difflineminus">-      throw new Error(&quot;JSON conversion failed unexpectedly!&quot;);</span>
<a href="#l9.1127"></a><span id="l9.1127" class="difflineminus">-</span>
<a href="#l9.1128"></a><span id="l9.1128" class="difflineminus">-    return str;</span>
<a href="#l9.1129"></a><span id="l9.1129" class="difflineplus">+    // XXXzeniko drop the following keys used only for internal bookkeeping:</span>
<a href="#l9.1130"></a><span id="l9.1130" class="difflineplus">+    //           _tabStillLoading, _hosts, _formDataSaved</span>
<a href="#l9.1131"></a><span id="l9.1131" class="difflineplus">+    return JSON.stringify(aJSObject);</span>
<a href="#l9.1132"></a><span id="l9.1132">   },</span>
<a href="#l9.1133"></a><span id="l9.1133"> </span>
<a href="#l9.1134"></a><span id="l9.1134">   _notifyIfAllWindowsRestored: function sss_notifyIfAllWindowsRestored() {</span>
<a href="#l9.1135"></a><span id="l9.1135">     if (this._restoreCount) {</span>
<a href="#l9.1136"></a><span id="l9.1136">       this._restoreCount--;</span>
<a href="#l9.1137"></a><span id="l9.1137">       if (this._restoreCount == 0) {</span>
<a href="#l9.1138"></a><span id="l9.1138">         // This was the last window restored at startup, notify observers.</span>
<a href="#l9.1139"></a><span id="l9.1139">         var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l9.1140"></a><span id="l9.1140">                                         .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l9.1141"></a><span id="l9.1141">         observerService.notifyObservers(null, NOTIFY_WINDOWS_RESTORED, &quot;&quot;);</span>
<a href="#l9.1142"></a><span id="l9.1142">       }</span>
<a href="#l9.1143"></a><span id="l9.1143">     }</span>
<a href="#l9.1144"></a><span id="l9.1144">   },</span>
<a href="#l9.1145"></a><span id="l9.1145"> </span>
<a href="#l9.1146"></a><span id="l9.1146" class="difflineplus">+  /**</span>
<a href="#l9.1147"></a><span id="l9.1147" class="difflineplus">+   * @param aWindow</span>
<a href="#l9.1148"></a><span id="l9.1148" class="difflineplus">+   *        Window reference</span>
<a href="#l9.1149"></a><span id="l9.1149" class="difflineplus">+   * @returns whether this window's data is still cached in _statesToRestore</span>
<a href="#l9.1150"></a><span id="l9.1150" class="difflineplus">+   *          because it's not fully loaded yet</span>
<a href="#l9.1151"></a><span id="l9.1151" class="difflineplus">+   */</span>
<a href="#l9.1152"></a><span id="l9.1152" class="difflineplus">+  _isWindowLoaded: function sss_isWindowLoaded(aWindow) {</span>
<a href="#l9.1153"></a><span id="l9.1153" class="difflineplus">+    return !aWindow.__SS_restoreID;</span>
<a href="#l9.1154"></a><span id="l9.1154" class="difflineplus">+  },</span>
<a href="#l9.1155"></a><span id="l9.1155" class="difflineplus">+</span>
<a href="#l9.1156"></a><span id="l9.1156"> /* ........ Storage API .............. */</span>
<a href="#l9.1157"></a><span id="l9.1157"> </span>
<a href="#l9.1158"></a><span id="l9.1158">   /**</span>
<a href="#l9.1159"></a><span id="l9.1159">    * write file to disk</span>
<a href="#l9.1160"></a><span id="l9.1160">    * @param aFile</span>
<a href="#l9.1161"></a><span id="l9.1161">    *        nsIFile</span>
<a href="#l9.1162"></a><span id="l9.1162">    * @param aData</span>
<a href="#l9.1163"></a><span id="l9.1163">    *        String data</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/suite/installer/unix/packages</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/suite/installer/unix/packages</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -237,16 +237,17 @@ bin/components/xpinstall.xpt</span>
<a href="#l10.4"></a><span id="l10.4"> bin/components/xulapp.xpt</span>
<a href="#l10.5"></a><span id="l10.5"> bin/components/xuldoc.xpt</span>
<a href="#l10.6"></a><span id="l10.6"> bin/components/xultmpl.xpt</span>
<a href="#l10.7"></a><span id="l10.7"> bin/components/zipwriter.xpt</span>
<a href="#l10.8"></a><span id="l10.8"> bin/components/libzipwriter.so</span>
<a href="#l10.9"></a><span id="l10.9"> bin/components/nsSessionStartup.js</span>
<a href="#l10.10"></a><span id="l10.10"> bin/components/nsSessionStore.js</span>
<a href="#l10.11"></a><span id="l10.11"> bin/components/sessionstore.xpt</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+bin/components/aboutSessionRestore.js</span>
<a href="#l10.13"></a><span id="l10.13"> </span>
<a href="#l10.14"></a><span id="l10.14"> ; JavaScript components</span>
<a href="#l10.15"></a><span id="l10.15"> bin/components/FeedProcessor.js</span>
<a href="#l10.16"></a><span id="l10.16"> bin/components/jsconsole-clhandler.js</span>
<a href="#l10.17"></a><span id="l10.17"> bin/components/nsAboutAbout.js</span>
<a href="#l10.18"></a><span id="l10.18"> bin/components/nsAboutCertError.js</span>
<a href="#l10.19"></a><span id="l10.19"> bin/components/nsAddonRepository.js</span>
<a href="#l10.20"></a><span id="l10.20"> bin/components/nsBadCertHandler.js</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/suite/installer/windows/packages</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/suite/installer/windows/packages</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -241,16 +241,17 @@ bin\components\zipwriter.xpt</span>
<a href="#l11.4"></a><span id="l11.4"> bin\components\zipwriter.dll</span>
<a href="#l11.5"></a><span id="l11.5"> bin\plugins\npnul32.dll</span>
<a href="#l11.6"></a><span id="l11.6"> bin\components\helperAppDlg.xpt</span>
<a href="#l11.7"></a><span id="l11.7"> bin\AccessibleMarshal.dll</span>
<a href="#l11.8"></a><span id="l11.8"> bin\sqlite3.dll</span>
<a href="#l11.9"></a><span id="l11.9"> bin\components\nsSessionStartup.js</span>
<a href="#l11.10"></a><span id="l11.10"> bin\components\nsSessionStore.js</span>
<a href="#l11.11"></a><span id="l11.11"> bin\components\sessionstore.xpt</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+bin\components\aboutSessionRestore.js</span>
<a href="#l11.13"></a><span id="l11.13"> </span>
<a href="#l11.14"></a><span id="l11.14"> ; JavaScript components</span>
<a href="#l11.15"></a><span id="l11.15"> bin\components\FeedProcessor.js</span>
<a href="#l11.16"></a><span id="l11.16"> bin\components\jsconsole-clhandler.js</span>
<a href="#l11.17"></a><span id="l11.17"> bin\components\nsAboutCertError.js</span>
<a href="#l11.18"></a><span id="l11.18"> bin\components\nsAddonRepository.js</span>
<a href="#l11.19"></a><span id="l11.19"> bin\components\nsAxSecurityPolicy.js</span>
<a href="#l11.20"></a><span id="l11.20"> bin\components\nsBadCertHandler.js</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">new file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- /dev/null</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ b/suite/locales/en-US/chrome/common/aboutSessionRestore.dtd</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -0,0 +1,18 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineplus">+&lt;!ENTITY restorepage.tabtitle       &quot;Restore Session&quot;&gt;</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineplus">+&lt;!ENTITY restorepage.pagetitle      &quot;Would you like to restore your session?&quot;&gt;</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineplus">+&lt;!-- LOCALIZATION NOTE: If &quot;closed unexpectedly&quot; sounds too awkward in the translation,</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineplus">+                        you may translate &quot;crash&quot; instead (even though it's IT-speak) --&gt;</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineplus">+&lt;!ENTITY restorepage.issueDesc      &quot;Your previous &amp;brandShortName; session closed unexpectedly. We sincerely apologize for the inconvenience. You can restore the tabs and windows from your previous session, or start a new session if they are no longer needed.&quot;&gt;</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineplus">+&lt;!ENTITY restorepage.remedies       &quot;If &amp;brandShortName; closes repeatedly:&quot;&gt;</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineplus">+&lt;!ENTITY restorepage.dueToChrome    &quot;Try disabling any recently added extensions in the Add-ons Manager.&quot;&gt;</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+&lt;!ENTITY restorepage.dueToContent   &quot;Try restoring your session without any Web pages you suspect might be causing the problem:&quot;&gt;</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+&lt;!ENTITY restorepage.restoreButton  &quot;Restore Previous Session&quot;&gt;</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+&lt;!ENTITY restorepage.restore.access &quot;R&quot;&gt;</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+&lt;!ENTITY restorepage.cancelButton   &quot;Start New Session&quot;&gt;</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+&lt;!ENTITY restorepage.cancel.access  &quot;S&quot;&gt;</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+&lt;!ENTITY restorepage.restoreHeader  &quot;Restore&quot;&gt;</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+&lt;!ENTITY restorepage.listHeader     &quot;Windows and Tabs&quot;&gt;</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+&lt;!-- LOCALIZATION NOTE: &amp;#37;S will be replaced with a number. --&gt;</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineplus">+&lt;!ENTITY restorepage.windowLabel    &quot;Window &amp;#37;S&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">deleted file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- a/suite/locales/en-US/chrome/common/sessionstore.properties</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ /dev/null</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -1,7 +0,0 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineminus">-restoredTitle= %S - Restore Previous Session</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineminus">-restoredMsg=Your last %S session closed unexpectedly. You can restore the tabs and windows from your previous session, or start a new session if you think the problem was related to a page you were viewing.</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineminus">-</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineminus">-# Localization note: It is recommended that okTitle be longer than cancelTitle</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineminus">-# so that hitting the more prominent button doesn't lead to dataloss (see bug 346264).</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineminus">-okTitle=Restore Previous Session</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineminus">-cancelTitle=Start New Session</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/suite/locales/jar.mn</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/suite/locales/jar.mn</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -24,25 +24,25 @@</span>
<a href="#l14.4"></a><span id="l14.4">   locale/@AB_CD@/communicator/contentAreaCommands.dtd                       (%chrome/common/contentAreaCommands.dtd)</span>
<a href="#l14.5"></a><span id="l14.5">   locale/@AB_CD@/communicator/contentAreaCommands.properties                (%chrome/common/contentAreaCommands.properties)</span>
<a href="#l14.6"></a><span id="l14.6">   locale/@AB_CD@/communicator/defaultClientDialog.dtd                       (%chrome/common/defaultClientDialog.dtd)</span>
<a href="#l14.7"></a><span id="l14.7">   locale/@AB_CD@/communicator/notification.properties                       (%chrome/common/notification.properties)</span>
<a href="#l14.8"></a><span id="l14.8">   locale/@AB_CD@/communicator/openLocation.dtd                              (%chrome/common/openLocation.dtd)</span>
<a href="#l14.9"></a><span id="l14.9">   locale/@AB_CD@/communicator/openLocation.properties                       (%chrome/common/openLocation.properties)</span>
<a href="#l14.10"></a><span id="l14.10">   locale/@AB_CD@/communicator/passwordManager.dtd                           (%chrome/common/passwordManager.dtd)</span>
<a href="#l14.11"></a><span id="l14.11">   locale/@AB_CD@/communicator/printPreview.dtd                              (%chrome/common/printPreview.dtd)</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-  locale/@AB_CD@/communicator/sessionstore.properties                       (%chrome/common/sessionstore.properties)</span>
<a href="#l14.13"></a><span id="l14.13">   locale/@AB_CD@/communicator/shellservice.properties                       (%chrome/common/shellservice.properties)</span>
<a href="#l14.14"></a><span id="l14.14">   locale/@AB_CD@/communicator/sanitize.dtd                                  (%chrome/common/sanitize.dtd)</span>
<a href="#l14.15"></a><span id="l14.15">   locale/@AB_CD@/communicator/tasksOverlay.dtd                              (%chrome/common/tasksOverlay.dtd)</span>
<a href="#l14.16"></a><span id="l14.16">   locale/@AB_CD@/communicator/typeaheadfind.properties                      (%chrome/common/typeaheadfind.properties)</span>
<a href="#l14.17"></a><span id="l14.17">   locale/@AB_CD@/communicator/utilityOverlay.dtd                            (%chrome/common/utilityOverlay.dtd)</span>
<a href="#l14.18"></a><span id="l14.18">   locale/@AB_CD@/communicator/utilityOverlay.properties                     (%chrome/common/utilityOverlay.properties)</span>
<a href="#l14.19"></a><span id="l14.19">   locale/@AB_CD@/communicator/viewZoomOverlay.dtd                           (%chrome/common/viewZoomOverlay.dtd)</span>
<a href="#l14.20"></a><span id="l14.20">   locale/@AB_CD@/communicator/viewZoomOverlay.properties                    (%chrome/common/viewZoomOverlay.properties)</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineplus">+  locale/@AB_CD@/communicator/aboutSessionRestore.dtd                       (%chrome/common/aboutSessionRestore.dtd)</span>
<a href="#l14.22"></a><span id="l14.22">   locale/@AB_CD@/communicator/bookmarks/addBookmark.dtd                     (%chrome/common/bookmarks/addBookmark.dtd)</span>
<a href="#l14.23"></a><span id="l14.23">   locale/@AB_CD@/communicator/bookmarks/bm-props.dtd                        (%chrome/common/bookmarks/bm-props.dtd)</span>
<a href="#l14.24"></a><span id="l14.24">   locale/@AB_CD@/communicator/bookmarks/bookmarks.dtd                       (%chrome/common/bookmarks/bookmarks.dtd)</span>
<a href="#l14.25"></a><span id="l14.25">   locale/@AB_CD@/communicator/bookmarks/bookmarks.properties                (%chrome/common/bookmarks/bookmarks.properties)</span>
<a href="#l14.26"></a><span id="l14.26">   locale/@AB_CD@/communicator/bookmarks/findBookmark.dtd                    (%chrome/common/bookmarks/findBookmark.dtd)</span>
<a href="#l14.27"></a><span id="l14.27">   locale/@AB_CD@/communicator/bookmarks/sortFolder.dtd                      (%chrome/common/bookmarks/sortFolder.dtd)</span>
<a href="#l14.28"></a><span id="l14.28">   locale/@AB_CD@/communicator/directory/directory.dtd                       (%chrome/common/directory/directory.dtd)</span>
<a href="#l14.29"></a><span id="l14.29">   locale/@AB_CD@/communicator/help/cert_dialog_help.xhtml                   (%chrome/common/help/cert_dialog_help.xhtml)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1">new file mode 100644</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineminus">--- /dev/null</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineplus">+++ b/suite/themes/classic/communicator/aboutSessionRestore.css</span>
<a href="#l15.4"></a><span id="l15.4" class="difflineat">@@ -0,0 +1,85 @@</span>
<a href="#l15.5"></a><span id="l15.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l15.6"></a><span id="l15.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l15.7"></a><span id="l15.7" class="difflineplus">+ *</span>
<a href="#l15.8"></a><span id="l15.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l15.9"></a><span id="l15.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l15.10"></a><span id="l15.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l15.11"></a><span id="l15.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+ *</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+ * License.</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineplus">+ *</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineplus">+ * The Original Code is the nsSessionStore component.</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineplus">+ *</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineplus">+ * Simon BÃ¼nzli &lt;zeniko@gmail.com&gt;</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineplus">+ *</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineplus">+ *    Michael Ventnor &lt;m.ventnor@gmail.com&gt;</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineplus">+ *</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineplus">+ *</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineplus">+</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineplus">+#tabList {</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineplus">+  width: 100%;</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineplus">+  height: 12em;</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineplus">+}</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineplus">+</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineplus">+treechildren::-moz-tree-image(icon),</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineplus">+treechildren::-moz-tree-image(noicon) {</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineplus">+  padding-right: 2px;</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineplus">+  margin: 0px 2px;</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+  width: 16px;</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineplus">+  height: 16px;</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineplus">+}</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineplus">+</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineplus">+treechildren::-moz-tree-image(noicon) {</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-item.png&quot;);</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineplus">+}</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineplus">+</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineplus">+treechildren::-moz-tree-image(container, noicon) {</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-folder-closed.png&quot;);</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineplus">+}</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineplus">+</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineplus">+treechildren::-moz-tree-image(container, noicon, open) {</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-folder-open.png&quot;);</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineplus">+}</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineplus">+</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineplus">+treechildren::-moz-tree-checkbox(checked) {</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineplus">+  list-style-image: url(&quot;chrome://global/skin/checkbox/cbox-check.gif&quot;);</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineplus">+}</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineplus">+</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineplus">+treechildren::-moz-tree-checkbox(partial) {</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineplus">+  list-style-image: url(&quot;chrome://global/skin/checkbox/cbox-check-dis.gif&quot;);</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineplus">+}</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineplus">+</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineplus">+treechildren::-moz-tree-row(alternate) {</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineplus">+  background-color: -moz-oddtreerow;</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineplus">+}</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineplus">+</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineplus">+treechildren::-moz-tree-row(alternate, selected) {</span>
<a href="#l15.80"></a><span id="l15.80" class="difflineplus">+  background-color: Highlight;</span>
<a href="#l15.81"></a><span id="l15.81" class="difflineplus">+}</span>
<a href="#l15.82"></a><span id="l15.82" class="difflineplus">+</span>
<a href="#l15.83"></a><span id="l15.83" class="difflineplus">+#buttons {</span>
<a href="#l15.84"></a><span id="l15.84" class="difflineplus">+  -moz-margin-start: 80px;</span>
<a href="#l15.85"></a><span id="l15.85" class="difflineplus">+}</span>
<a href="#l15.86"></a><span id="l15.86" class="difflineplus">+#buttons &gt; button {</span>
<a href="#l15.87"></a><span id="l15.87" class="difflineplus">+  margin-top: 2em;</span>
<a href="#l15.88"></a><span id="l15.88" class="difflineplus">+  -moz-margin-start: 5px;</span>
<a href="#l15.89"></a><span id="l15.89" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/suite/themes/classic/jar.mn</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/suite/themes/classic/jar.mn</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -16,16 +16,17 @@ classic.jar:</span>
<a href="#l16.4"></a><span id="l16.4">   skin/classic/communicator/certError.css                               (communicator/certError.css)</span>
<a href="#l16.5"></a><span id="l16.5">   skin/classic/communicator/dialogs.css                                 (communicator/dialogs.css)</span>
<a href="#l16.6"></a><span id="l16.6">   skin/classic/communicator/communicator.css                            (communicator/communicator.css)</span>
<a href="#l16.7"></a><span id="l16.7">   skin/classic/communicator/communicatorBindings.xml                    (communicator/communicatorBindings.xml)</span>
<a href="#l16.8"></a><span id="l16.8">   skin/classic/communicator/helpOverlay.css                             (communicator/helpOverlay.css)</span>
<a href="#l16.9"></a><span id="l16.9">   skin/classic/communicator/preferences.css                             (communicator/preferences.css)</span>
<a href="#l16.10"></a><span id="l16.10">   skin/classic/communicator/prefpanels.css                              (communicator/prefpanels.css)</span>
<a href="#l16.11"></a><span id="l16.11">   skin/classic/communicator/smileys.css                                 (communicator/smileys.css)</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+  skin/classic/communicator/aboutSessionRestore.css                     (communicator/aboutSessionRestore.css)</span>
<a href="#l16.13"></a><span id="l16.13">   skin/classic/communicator/bookmarks/bookmark-folder-button.gif        (communicator/bookmarks/bookmark-folder-button.gif)</span>
<a href="#l16.14"></a><span id="l16.14">   skin/classic/communicator/bookmarks/bookmark-folder-closed.png        (communicator/bookmarks/bookmark-folder-closed.png)</span>
<a href="#l16.15"></a><span id="l16.15">   skin/classic/communicator/bookmarks/bookmark-folder-dis.png           (communicator/bookmarks/bookmark-folder-dis.png)</span>
<a href="#l16.16"></a><span id="l16.16">   skin/classic/communicator/bookmarks/bookmark-folder-open.png          (communicator/bookmarks/bookmark-folder-open.png)</span>
<a href="#l16.17"></a><span id="l16.17">   skin/classic/communicator/bookmarks/bookmark-group.png                (communicator/bookmarks/bookmark-group.png)</span>
<a href="#l16.18"></a><span id="l16.18">   skin/classic/communicator/bookmarks/bookmark-item-dis.png             (communicator/bookmarks/bookmark-item-dis.png)</span>
<a href="#l16.19"></a><span id="l16.19">   skin/classic/communicator/bookmarks/bookmark-item-updated.png         (communicator/bookmarks/bookmark-item-updated.png)</span>
<a href="#l16.20"></a><span id="l16.20">   skin/classic/communicator/bookmarks/bookmark-item.png                 (communicator/bookmarks/bookmark-item.png)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1">new file mode 100644</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineminus">--- /dev/null</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineplus">+++ b/suite/themes/modern/communicator/aboutSessionRestore.css</span>
<a href="#l17.4"></a><span id="l17.4" class="difflineat">@@ -0,0 +1,73 @@</span>
<a href="#l17.5"></a><span id="l17.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l17.6"></a><span id="l17.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l17.7"></a><span id="l17.7" class="difflineplus">+ *</span>
<a href="#l17.8"></a><span id="l17.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l17.9"></a><span id="l17.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l17.10"></a><span id="l17.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l17.11"></a><span id="l17.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+ *</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+ * License.</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+ *</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineplus">+ * The Original Code is the nsSessionStore component.</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineplus">+ *</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineplus">+ * Simon BÃ¼nzli &lt;zeniko@gmail.com&gt;</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineplus">+ *</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineplus">+ *    Michael Ventnor &lt;m.ventnor@gmail.com&gt;</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineplus">+ *</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineplus">+ *</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineplus">+</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineplus">+#tabList {</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineplus">+  width: 100%;</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineplus">+  height: 12em;</span>
<a href="#l17.45"></a><span id="l17.45" class="difflineplus">+}</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineplus">+</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineplus">+treechildren::-moz-tree-image(icon),</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineplus">+treechildren::-moz-tree-image(noicon) {</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineplus">+  padding-right: 2px;</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineplus">+  margin: 0px 2px;</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineplus">+  width: 16px;</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineplus">+  height: 16px;</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineplus">+}</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineplus">+</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineplus">+treechildren::-moz-tree-image(noicon) {</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-item.png&quot;);</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineplus">+}</span>
<a href="#l17.58"></a><span id="l17.58" class="difflineplus">+</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineplus">+treechildren::-moz-tree-image(container, noicon) {</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-folder-closed.gif&quot;);</span>
<a href="#l17.61"></a><span id="l17.61" class="difflineplus">+}</span>
<a href="#l17.62"></a><span id="l17.62" class="difflineplus">+</span>
<a href="#l17.63"></a><span id="l17.63" class="difflineplus">+treechildren::-moz-tree-image(container, noicon, open) {</span>
<a href="#l17.64"></a><span id="l17.64" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-folder-open.gif&quot;);</span>
<a href="#l17.65"></a><span id="l17.65" class="difflineplus">+}</span>
<a href="#l17.66"></a><span id="l17.66" class="difflineplus">+</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineplus">+treechildren::-moz-tree-checkbox {</span>
<a href="#l17.68"></a><span id="l17.68" class="difflineplus">+  list-style-image: url(&quot;chrome://global/skin/checkbox/cbox.gif&quot;);</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineplus">+}</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineplus">+</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineplus">+treechildren::-moz-tree-checkbox(checked) {</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineplus">+  list-style-image: url(&quot;chrome://global/skin/checkbox/cbox-check.gif&quot;);</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineplus">+}</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineplus">+</span>
<a href="#l17.75"></a><span id="l17.75" class="difflineplus">+treechildren::-moz-tree-checkbox(partial) {</span>
<a href="#l17.76"></a><span id="l17.76" class="difflineplus">+  list-style-image: url(&quot;chrome://global/skin/checkbox/cbox-check-dis.gif&quot;);</span>
<a href="#l17.77"></a><span id="l17.77" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/suite/themes/modern/jar.mn</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/suite/themes/modern/jar.mn</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -13,16 +13,17 @@ modern.jar:</span>
<a href="#l18.4"></a><span id="l18.4">   skin/modern/communicator/preferences.css                         (communicator/preferences.css)</span>
<a href="#l18.5"></a><span id="l18.5">   skin/modern/communicator/tasksOverlay.css                        (communicator/tasksOverlay.css)</span>
<a href="#l18.6"></a><span id="l18.6">   skin/modern/communicator/button.css                              (communicator/button.css)</span>
<a href="#l18.7"></a><span id="l18.7">   skin/modern/communicator/toolbar.css                             (communicator/toolbar.css)</span>
<a href="#l18.8"></a><span id="l18.8">   skin/modern/communicator/dialogs.css                             (communicator/dialogs.css)</span>
<a href="#l18.9"></a><span id="l18.9">   skin/modern/communicator/helpOverlay.css                         (communicator/helpOverlay.css)</span>
<a href="#l18.10"></a><span id="l18.10">   skin/modern/communicator/smileys.css                             (communicator/smileys.css)</span>
<a href="#l18.11"></a><span id="l18.11">   skin/modern/communicator/communicator.css                        (communicator/communicator.css)</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+  skin/modern/communicator/aboutSessionRestore.css                 (communicator/aboutSessionRestore.css)</span>
<a href="#l18.13"></a><span id="l18.13">   skin/modern/communicator/bookmarks/bookmark-folder-closed.gif    (communicator/bookmarks/bookmark-folder-closed.gif)</span>
<a href="#l18.14"></a><span id="l18.14">   skin/modern/communicator/bookmarks/bookmark-folder-dis.gif       (communicator/bookmarks/bookmark-folder-dis.gif)</span>
<a href="#l18.15"></a><span id="l18.15">   skin/modern/communicator/bookmarks/bookmark-folder-open.gif      (communicator/bookmarks/bookmark-folder-open.gif)</span>
<a href="#l18.16"></a><span id="l18.16">   skin/modern/communicator/bookmarks/bookmark-group.gif            (communicator/bookmarks/bookmark-group.gif)</span>
<a href="#l18.17"></a><span id="l18.17">   skin/modern/communicator/bookmarks/bookmark-item-dis.gif         (communicator/bookmarks/bookmark-item-dis.gif)</span>
<a href="#l18.18"></a><span id="l18.18">   skin/modern/communicator/bookmarks/bookmark-item-updated.gif     (communicator/bookmarks/bookmark-item-updated.gif)</span>
<a href="#l18.19"></a><span id="l18.19">   skin/modern/communicator/bookmarks/bookmark-item.gif             (communicator/bookmarks/bookmark-item.gif)</span>
<a href="#l18.20"></a><span id="l18.20">   skin/modern/communicator/bookmarks/bookmarks.css                 (communicator/bookmarks/bookmarks.css)</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

