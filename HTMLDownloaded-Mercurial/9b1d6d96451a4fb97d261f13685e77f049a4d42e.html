<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 8532:9b1d6d96451a4fb97d261f13685e77f049a4d42e</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 9b1d6d96451a4fb97d261f13685e77f049a4d42e" />
<meta property="og:url" content="/comm-central/rev/9b1d6d96451a4fb97d261f13685e77f049a4d42e" />
<meta property="og:description" content="make message sending scriptable, r=protz, sr=neil, bug 679476" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 9b1d6d96451a4fb97d261f13685e77f049a4d42e 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/9b1d6d96451a4fb97d261f13685e77f049a4d42e">shortlog</a> |
<a href="/comm-central/log/9b1d6d96451a4fb97d261f13685e77f049a4d42e">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/9b1d6d96451a4fb97d261f13685e77f049a4d42e">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/9b1d6d96451a4fb97d261f13685e77f049a4d42e">files</a> |
changeset |
<a href="/comm-central/raw-rev/9b1d6d96451a4fb97d261f13685e77f049a4d42e">raw</a>  | <a href="/comm-central/archive/9b1d6d96451a4fb97d261f13685e77f049a4d42e.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
make message sending scriptable, r=protz, sr=neil, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=679476">bug 679476</a>
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#68;&#97;&#118;&#105;&#100;&#32;&#66;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#32;&#60;&#98;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#64;&#110;&#118;&#101;&#110;&#116;&#117;&#114;&#101;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 22 Sep 2011 07:27:20 -0700</td></tr>

<tr>
 <td>changeset 8532</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/9b1d6d96451a4fb97d261f13685e77f049a4d42e">9b1d6d96451a4fb97d261f13685e77f049a4d42e</a></td>
</tr>



<tr>
<td>parent 8531</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/dfe1e3af4773acdd80f42516a25409b7e6c82fd6">dfe1e3af4773acdd80f42516a25409b7e6c82fd6</a>
</td>
</tr>

<tr>
<td>child 8533</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/2e9070d54ee683515cbbfae062fd6e756fcbde46">2e9070d54ee683515cbbfae062fd6e756fcbde46</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=9b1d6d96451a4fb97d261f13685e77f049a4d42e">6556</a></td></tr>
<tr><td>push user</td><td>bienvenu@nventure.com</td></tr>
<tr><td>push date</td><td class="date age">Thu, 22 Sep 2011 14:27:13 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@9b1d6d96451a [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=9b1d6d96451a4fb97d261f13685e77f049a4d42e">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=9b1d6d96451a4fb97d261f13685e77f049a4d42e&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9b1d6d96451a4fb97d261f13685e77f049a4d42e&newProject=comm-central&newRevision=9b1d6d96451a4fb97d261f13685e77f049a4d42e&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9b1d6d96451a4fb97d261f13685e77f049a4d42e&newProject=comm-central&newRevision=9b1d6d96451a4fb97d261f13685e77f049a4d42e&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9b1d6d96451a4fb97d261f13685e77f049a4d42e&newProject=comm-central&newRevision=9b1d6d96451a4fb97d261f13685e77f049a4d42e&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28protz%29&revcount=50">protz</a>, <a href="/comm-central/log?rev=reviewer%28neil%29&revcount=50">neil</a>, <a href="/comm-central/log?rev=reviewer%28bug%29&revcount=50">bug</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=679476">679476</a></td></tr>




</table></div>

<div class="page_body description">make message sending scriptable, r=protz, sr=neil, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=679476">bug 679476</a></div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/build/nsMailModule.cpp">mailnews/build/nsMailModule.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/build/nsMailModule.cpp">file</a> |
<a href="/comm-central/annotate/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/build/nsMailModule.cpp">annotate</a> |
<a href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/build/nsMailModule.cpp">diff</a> |
<a href="/comm-central/comparison/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/build/nsMailModule.cpp">comparison</a> |
<a href="/comm-central/log/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/build/nsMailModule.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/public/nsIMsgCompose.idl">mailnews/compose/public/nsIMsgCompose.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/public/nsIMsgCompose.idl">file</a> |
<a href="/comm-central/annotate/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/public/nsIMsgCompose.idl">annotate</a> |
<a href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/public/nsIMsgCompose.idl">diff</a> |
<a href="/comm-central/comparison/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/public/nsIMsgCompose.idl">comparison</a> |
<a href="/comm-central/log/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/public/nsIMsgCompose.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/public/nsIMsgSend.idl">mailnews/compose/public/nsIMsgSend.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/public/nsIMsgSend.idl">file</a> |
<a href="/comm-central/annotate/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/public/nsIMsgSend.idl">annotate</a> |
<a href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/public/nsIMsgSend.idl">diff</a> |
<a href="/comm-central/comparison/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/public/nsIMsgSend.idl">comparison</a> |
<a href="/comm-central/log/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/public/nsIMsgSend.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/public/nsMsgCompCID.h">mailnews/compose/public/nsMsgCompCID.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/public/nsMsgCompCID.h">file</a> |
<a href="/comm-central/annotate/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/public/nsMsgCompCID.h">annotate</a> |
<a href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/public/nsMsgCompCID.h">diff</a> |
<a href="/comm-central/comparison/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/public/nsMsgCompCID.h">comparison</a> |
<a href="/comm-central/log/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/public/nsMsgCompCID.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/src/nsMsgAttachmentHandler.cpp">mailnews/compose/src/nsMsgAttachmentHandler.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/src/nsMsgAttachmentHandler.cpp">file</a> |
<a href="/comm-central/annotate/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/src/nsMsgAttachmentHandler.cpp">annotate</a> |
<a href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/src/nsMsgAttachmentHandler.cpp">diff</a> |
<a href="/comm-central/comparison/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/src/nsMsgAttachmentHandler.cpp">comparison</a> |
<a href="/comm-central/log/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/src/nsMsgAttachmentHandler.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/src/nsMsgAttachmentHandler.h">mailnews/compose/src/nsMsgAttachmentHandler.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/src/nsMsgAttachmentHandler.h">file</a> |
<a href="/comm-central/annotate/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/src/nsMsgAttachmentHandler.h">annotate</a> |
<a href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/src/nsMsgAttachmentHandler.h">diff</a> |
<a href="/comm-central/comparison/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/src/nsMsgAttachmentHandler.h">comparison</a> |
<a href="/comm-central/log/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/src/nsMsgAttachmentHandler.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/src/nsMsgCompUtils.cpp">mailnews/compose/src/nsMsgCompUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/src/nsMsgCompUtils.cpp">file</a> |
<a href="/comm-central/annotate/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/src/nsMsgCompUtils.cpp">annotate</a> |
<a href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/src/nsMsgCompUtils.cpp">diff</a> |
<a href="/comm-central/comparison/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/src/nsMsgCompUtils.cpp">comparison</a> |
<a href="/comm-central/log/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/src/nsMsgCompUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/src/nsMsgCompose.cpp">mailnews/compose/src/nsMsgCompose.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/src/nsMsgCompose.cpp">file</a> |
<a href="/comm-central/annotate/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/src/nsMsgCompose.cpp">annotate</a> |
<a href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/src/nsMsgCompose.cpp">diff</a> |
<a href="/comm-central/comparison/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/src/nsMsgCompose.cpp">comparison</a> |
<a href="/comm-central/log/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/src/nsMsgCompose.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/src/nsMsgSend.cpp">mailnews/compose/src/nsMsgSend.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/src/nsMsgSend.cpp">file</a> |
<a href="/comm-central/annotate/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/src/nsMsgSend.cpp">annotate</a> |
<a href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/src/nsMsgSend.cpp">diff</a> |
<a href="/comm-central/comparison/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/src/nsMsgSend.cpp">comparison</a> |
<a href="/comm-central/log/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/src/nsMsgSend.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/src/nsMsgSend.h">mailnews/compose/src/nsMsgSend.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/src/nsMsgSend.h">file</a> |
<a href="/comm-central/annotate/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/src/nsMsgSend.h">annotate</a> |
<a href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/src/nsMsgSend.h">diff</a> |
<a href="/comm-central/comparison/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/src/nsMsgSend.h">comparison</a> |
<a href="/comm-central/log/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/compose/src/nsMsgSend.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/eudora/src/nsEudoraCompose.cpp">mailnews/import/eudora/src/nsEudoraCompose.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/eudora/src/nsEudoraCompose.cpp">file</a> |
<a href="/comm-central/annotate/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/eudora/src/nsEudoraCompose.cpp">annotate</a> |
<a href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/eudora/src/nsEudoraCompose.cpp">diff</a> |
<a href="/comm-central/comparison/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/eudora/src/nsEudoraCompose.cpp">comparison</a> |
<a href="/comm-central/log/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/eudora/src/nsEudoraCompose.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/eudora/src/nsEudoraCompose.h">mailnews/import/eudora/src/nsEudoraCompose.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/eudora/src/nsEudoraCompose.h">file</a> |
<a href="/comm-central/annotate/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/eudora/src/nsEudoraCompose.h">annotate</a> |
<a href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/eudora/src/nsEudoraCompose.h">diff</a> |
<a href="/comm-central/comparison/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/eudora/src/nsEudoraCompose.h">comparison</a> |
<a href="/comm-central/log/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/eudora/src/nsEudoraCompose.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/eudora/src/nsEudoraImport.cpp">mailnews/import/eudora/src/nsEudoraImport.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/eudora/src/nsEudoraImport.cpp">file</a> |
<a href="/comm-central/annotate/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/eudora/src/nsEudoraImport.cpp">annotate</a> |
<a href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/eudora/src/nsEudoraImport.cpp">diff</a> |
<a href="/comm-central/comparison/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/eudora/src/nsEudoraImport.cpp">comparison</a> |
<a href="/comm-central/log/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/eudora/src/nsEudoraImport.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/outlook/src/MapiMessage.cpp">mailnews/import/outlook/src/MapiMessage.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/outlook/src/MapiMessage.cpp">file</a> |
<a href="/comm-central/annotate/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/outlook/src/MapiMessage.cpp">annotate</a> |
<a href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/outlook/src/MapiMessage.cpp">diff</a> |
<a href="/comm-central/comparison/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/outlook/src/MapiMessage.cpp">comparison</a> |
<a href="/comm-central/log/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/outlook/src/MapiMessage.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/outlook/src/MapiMessage.h">mailnews/import/outlook/src/MapiMessage.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/outlook/src/MapiMessage.h">file</a> |
<a href="/comm-central/annotate/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/outlook/src/MapiMessage.h">annotate</a> |
<a href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/outlook/src/MapiMessage.h">diff</a> |
<a href="/comm-central/comparison/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/outlook/src/MapiMessage.h">comparison</a> |
<a href="/comm-central/log/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/outlook/src/MapiMessage.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/outlook/src/nsOutlookCompose.cpp">mailnews/import/outlook/src/nsOutlookCompose.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/outlook/src/nsOutlookCompose.cpp">file</a> |
<a href="/comm-central/annotate/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/outlook/src/nsOutlookCompose.cpp">annotate</a> |
<a href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/outlook/src/nsOutlookCompose.cpp">diff</a> |
<a href="/comm-central/comparison/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/outlook/src/nsOutlookCompose.cpp">comparison</a> |
<a href="/comm-central/log/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/outlook/src/nsOutlookCompose.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/public/nsIImportService.idl">mailnews/import/public/nsIImportService.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/public/nsIImportService.idl">file</a> |
<a href="/comm-central/annotate/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/public/nsIImportService.idl">annotate</a> |
<a href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/public/nsIImportService.idl">diff</a> |
<a href="/comm-central/comparison/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/public/nsIImportService.idl">comparison</a> |
<a href="/comm-central/log/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/public/nsIImportService.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/src/nsImportService.cpp">mailnews/import/src/nsImportService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/src/nsImportService.cpp">file</a> |
<a href="/comm-central/annotate/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/src/nsImportService.cpp">annotate</a> |
<a href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/src/nsImportService.cpp">diff</a> |
<a href="/comm-central/comparison/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/src/nsImportService.cpp">comparison</a> |
<a href="/comm-central/log/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/import/src/nsImportService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/mime/src/mimedrft.cpp">mailnews/mime/src/mimedrft.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/mime/src/mimedrft.cpp">file</a> |
<a href="/comm-central/annotate/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/mime/src/mimedrft.cpp">annotate</a> |
<a href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/mime/src/mimedrft.cpp">diff</a> |
<a href="/comm-central/comparison/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/mime/src/mimedrft.cpp">comparison</a> |
<a href="/comm-central/log/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/mime/src/mimedrft.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/mime/src/mimehdrs.cpp">mailnews/mime/src/mimehdrs.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/mime/src/mimehdrs.cpp">file</a> |
<a href="/comm-central/annotate/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/mime/src/mimehdrs.cpp">annotate</a> |
<a href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/mime/src/mimehdrs.cpp">diff</a> |
<a href="/comm-central/comparison/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/mime/src/mimehdrs.cpp">comparison</a> |
<a href="/comm-central/log/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/mime/src/mimehdrs.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/mime/src/mimehdrs.h">mailnews/mime/src/mimehdrs.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/mime/src/mimehdrs.h">file</a> |
<a href="/comm-central/annotate/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/mime/src/mimehdrs.h">annotate</a> |
<a href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/mime/src/mimehdrs.h">diff</a> |
<a href="/comm-central/comparison/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/mime/src/mimehdrs.h">comparison</a> |
<a href="/comm-central/log/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/mime/src/mimehdrs.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/mime/src/mimemoz2.cpp">mailnews/mime/src/mimemoz2.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/mime/src/mimemoz2.cpp">file</a> |
<a href="/comm-central/annotate/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/mime/src/mimemoz2.cpp">annotate</a> |
<a href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/mime/src/mimemoz2.cpp">diff</a> |
<a href="/comm-central/comparison/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/mime/src/mimemoz2.cpp">comparison</a> |
<a href="/comm-central/log/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/mime/src/mimemoz2.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/mime/src/mimemoz2.h">mailnews/mime/src/mimemoz2.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/mime/src/mimemoz2.h">file</a> |
<a href="/comm-central/annotate/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/mime/src/mimemoz2.h">annotate</a> |
<a href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/mime/src/mimemoz2.h">diff</a> |
<a href="/comm-central/comparison/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/mime/src/mimemoz2.h">comparison</a> |
<a href="/comm-central/log/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/mime/src/mimemoz2.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/mime/src/mimemrel.cpp">mailnews/mime/src/mimemrel.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/mime/src/mimemrel.cpp">file</a> |
<a href="/comm-central/annotate/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/mime/src/mimemrel.cpp">annotate</a> |
<a href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/mime/src/mimemrel.cpp">diff</a> |
<a href="/comm-central/comparison/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/mime/src/mimemrel.cpp">comparison</a> |
<a href="/comm-central/log/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/mime/src/mimemrel.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/mime/src/nsStreamConverter.cpp">mailnews/mime/src/nsStreamConverter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/mime/src/nsStreamConverter.cpp">file</a> |
<a href="/comm-central/annotate/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/mime/src/nsStreamConverter.cpp">annotate</a> |
<a href="/comm-central/diff/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/mime/src/nsStreamConverter.cpp">diff</a> |
<a href="/comm-central/comparison/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/mime/src/nsStreamConverter.cpp">comparison</a> |
<a href="/comm-central/log/9b1d6d96451a4fb97d261f13685e77f049a4d42e/mailnews/mime/src/nsStreamConverter.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/build/nsMailModule.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/build/nsMailModule.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -569,16 +569,18 @@ NS_DEFINE_NAMED_CID(NS_BAYESIANFILTER_CI</span>
<a href="#l1.4"></a><span id="l1.4"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsSmtpService)</span>
<a href="#l1.5"></a><span id="l1.5"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsSmtpServer)</span>
<a href="#l1.6"></a><span id="l1.6"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgCompose)</span>
<a href="#l1.7"></a><span id="l1.7"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgComposeParams)</span>
<a href="#l1.8"></a><span id="l1.8"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgComposeSendListener)</span>
<a href="#l1.9"></a><span id="l1.9"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgComposeProgressParams)</span>
<a href="#l1.10"></a><span id="l1.10"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgCompFields)</span>
<a href="#l1.11"></a><span id="l1.11"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgAttachment)</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgAttachmentData)</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgAttachedFile)</span>
<a href="#l1.14"></a><span id="l1.14"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgComposeAndSend)</span>
<a href="#l1.15"></a><span id="l1.15"> NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsMsgSendLater, Init)</span>
<a href="#l1.16"></a><span id="l1.16"> NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsMsgComposeService, Init)</span>
<a href="#l1.17"></a><span id="l1.17"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgComposeContentHandler)</span>
<a href="#l1.18"></a><span id="l1.18"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgQuote)</span>
<a href="#l1.19"></a><span id="l1.19"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgQuoteListener)</span>
<a href="#l1.20"></a><span id="l1.20"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsSmtpUrl)</span>
<a href="#l1.21"></a><span id="l1.21"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMailtoUrl)</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -588,16 +590,18 @@ NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgComp</span>
<a href="#l1.23"></a><span id="l1.23"> NS_DEFINE_NAMED_CID(NS_MSGCOMPOSE_CID);</span>
<a href="#l1.24"></a><span id="l1.24"> NS_DEFINE_NAMED_CID(NS_MSGCOMPOSESERVICE_CID);</span>
<a href="#l1.25"></a><span id="l1.25"> NS_DEFINE_NAMED_CID(NS_MSGCOMPOSECONTENTHANDLER_CID);</span>
<a href="#l1.26"></a><span id="l1.26"> NS_DEFINE_NAMED_CID(NS_MSGCOMPOSEPARAMS_CID);</span>
<a href="#l1.27"></a><span id="l1.27"> NS_DEFINE_NAMED_CID(NS_MSGCOMPOSESENDLISTENER_CID);</span>
<a href="#l1.28"></a><span id="l1.28"> NS_DEFINE_NAMED_CID(NS_MSGCOMPOSEPROGRESSPARAMS_CID);</span>
<a href="#l1.29"></a><span id="l1.29"> NS_DEFINE_NAMED_CID(NS_MSGCOMPFIELDS_CID);</span>
<a href="#l1.30"></a><span id="l1.30"> NS_DEFINE_NAMED_CID(NS_MSGATTACHMENT_CID);</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+NS_DEFINE_NAMED_CID(NS_MSGATTACHMENTDATA_CID);</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+NS_DEFINE_NAMED_CID(NS_MSGATTACHEDFILE_CID);</span>
<a href="#l1.33"></a><span id="l1.33"> NS_DEFINE_NAMED_CID(NS_MSGSEND_CID);</span>
<a href="#l1.34"></a><span id="l1.34"> NS_DEFINE_NAMED_CID(NS_MSGSENDLATER_CID);</span>
<a href="#l1.35"></a><span id="l1.35"> NS_DEFINE_NAMED_CID(NS_SMTPSERVICE_CID);</span>
<a href="#l1.36"></a><span id="l1.36"> NS_DEFINE_NAMED_CID(NS_SMTPSERVER_CID);</span>
<a href="#l1.37"></a><span id="l1.37"> NS_DEFINE_NAMED_CID(NS_SMTPURL_CID);</span>
<a href="#l1.38"></a><span id="l1.38"> NS_DEFINE_NAMED_CID(NS_MAILTOURL_CID);</span>
<a href="#l1.39"></a><span id="l1.39"> NS_DEFINE_NAMED_CID(NS_MSGQUOTE_CID);</span>
<a href="#l1.40"></a><span id="l1.40"> NS_DEFINE_NAMED_CID(NS_MSGQUOTELISTENER_CID);</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineat">@@ -906,16 +910,18 @@ const mozilla::Module::CIDEntry kMailNew</span>
<a href="#l1.42"></a><span id="l1.42">   { &amp;kNS_MSGCOMPOSE_CID, false, NULL, nsMsgComposeConstructor},</span>
<a href="#l1.43"></a><span id="l1.43">   { &amp;kNS_MSGCOMPOSESERVICE_CID, false, NULL, nsMsgComposeServiceConstructor},</span>
<a href="#l1.44"></a><span id="l1.44">   { &amp;kNS_MSGCOMPOSECONTENTHANDLER_CID, false, NULL, nsMsgComposeContentHandlerConstructor},</span>
<a href="#l1.45"></a><span id="l1.45">   { &amp;kNS_MSGCOMPOSEPARAMS_CID, false, NULL, nsMsgComposeParamsConstructor},</span>
<a href="#l1.46"></a><span id="l1.46">   { &amp;kNS_MSGCOMPOSESENDLISTENER_CID, false, NULL, nsMsgComposeSendListenerConstructor},</span>
<a href="#l1.47"></a><span id="l1.47">   { &amp;kNS_MSGCOMPOSEPROGRESSPARAMS_CID, false, NULL, nsMsgComposeProgressParamsConstructor},</span>
<a href="#l1.48"></a><span id="l1.48">   { &amp;kNS_MSGCOMPFIELDS_CID, false, NULL, nsMsgCompFieldsConstructor},</span>
<a href="#l1.49"></a><span id="l1.49">   { &amp;kNS_MSGATTACHMENT_CID, false, NULL, nsMsgAttachmentConstructor},</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+  { &amp;kNS_MSGATTACHMENTDATA_CID, false, NULL, nsMsgAttachmentDataConstructor},</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+  { &amp;kNS_MSGATTACHEDFILE_CID, false, NULL, nsMsgAttachedFileConstructor},</span>
<a href="#l1.52"></a><span id="l1.52">   { &amp;kNS_MSGSEND_CID, false, NULL, nsMsgComposeAndSendConstructor},</span>
<a href="#l1.53"></a><span id="l1.53">   { &amp;kNS_MSGSENDLATER_CID, false, NULL, nsMsgSendLaterConstructor},</span>
<a href="#l1.54"></a><span id="l1.54">   { &amp;kNS_SMTPSERVICE_CID, false, NULL, nsSmtpServiceConstructor},</span>
<a href="#l1.55"></a><span id="l1.55">   { &amp;kNS_SMTPSERVER_CID, false, NULL, nsSmtpServerConstructor},</span>
<a href="#l1.56"></a><span id="l1.56">   { &amp;kNS_SMTPURL_CID, false, NULL, nsSmtpUrlConstructor},</span>
<a href="#l1.57"></a><span id="l1.57">   { &amp;kNS_MAILTOURL_CID, false, NULL, nsMailtoUrlConstructor},</span>
<a href="#l1.58"></a><span id="l1.58">   { &amp;kNS_MSGQUOTE_CID, false, NULL, nsMsgQuoteConstructor},</span>
<a href="#l1.59"></a><span id="l1.59">   { &amp;kNS_MSGQUOTELISTENER_CID, false, NULL, nsMsgQuoteListenerConstructor},</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineat">@@ -1107,16 +1113,18 @@ const mozilla::Module::ContractIDEntry k</span>
<a href="#l1.61"></a><span id="l1.61">   { NS_MSGCOMPOSESERVICE_CONTRACTID, &amp;kNS_MSGCOMPOSESERVICE_CID },</span>
<a href="#l1.62"></a><span id="l1.62">   { NS_MSGCOMPOSESTARTUPHANDLER_CONTRACTID, &amp;kNS_MSGCOMPOSESERVICE_CID },</span>
<a href="#l1.63"></a><span id="l1.63">   { NS_MSGCOMPOSECONTENTHANDLER_CONTRACTID, &amp;kNS_MSGCOMPOSECONTENTHANDLER_CID },</span>
<a href="#l1.64"></a><span id="l1.64">   { NS_MSGCOMPOSEPARAMS_CONTRACTID, &amp;kNS_MSGCOMPOSEPARAMS_CID },</span>
<a href="#l1.65"></a><span id="l1.65">   { NS_MSGCOMPOSESENDLISTENER_CONTRACTID, &amp;kNS_MSGCOMPOSESENDLISTENER_CID },</span>
<a href="#l1.66"></a><span id="l1.66">   { NS_MSGCOMPOSEPROGRESSPARAMS_CONTRACTID, &amp;kNS_MSGCOMPOSEPROGRESSPARAMS_CID },</span>
<a href="#l1.67"></a><span id="l1.67">   { NS_MSGCOMPFIELDS_CONTRACTID, &amp;kNS_MSGCOMPFIELDS_CID },</span>
<a href="#l1.68"></a><span id="l1.68">   { NS_MSGATTACHMENT_CONTRACTID, &amp;kNS_MSGATTACHMENT_CID },</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+  { NS_MSGATTACHMENTDATA_CONTRACTID, &amp;kNS_MSGATTACHMENTDATA_CID },</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+  { NS_MSGATTACHEDFILE_CONTRACTID, &amp;kNS_MSGATTACHEDFILE_CID },</span>
<a href="#l1.71"></a><span id="l1.71">   { NS_MSGSEND_CONTRACTID, &amp;kNS_MSGSEND_CID },</span>
<a href="#l1.72"></a><span id="l1.72">   { NS_MSGSENDLATER_CONTRACTID, &amp;kNS_MSGSENDLATER_CID },</span>
<a href="#l1.73"></a><span id="l1.73">   { NS_SMTPSERVICE_CONTRACTID, &amp;kNS_SMTPSERVICE_CID },</span>
<a href="#l1.74"></a><span id="l1.74">   { NS_MAILTOHANDLER_CONTRACTID, &amp;kNS_SMTPSERVICE_CID },</span>
<a href="#l1.75"></a><span id="l1.75">   { NS_SMTPSERVER_CONTRACTID, &amp;kNS_SMTPSERVER_CID },</span>
<a href="#l1.76"></a><span id="l1.76">   { NS_SMTPURL_CONTRACTID, &amp;kNS_SMTPURL_CID },</span>
<a href="#l1.77"></a><span id="l1.77">   { NS_MAILTOURL_CONTRACTID, &amp;kNS_MAILTOURL_CID },</span>
<a href="#l1.78"></a><span id="l1.78">   { NS_MSGQUOTE_CONTRACTID, &amp;kNS_MSGQUOTE_CID },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/compose/public/nsIMsgCompose.idl</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/compose/public/nsIMsgCompose.idl</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -313,15 +313,15 @@ interface nsIMsgCompose : nsIMsgSendList</span>
<a href="#l2.4"></a><span id="l2.4">   void addMsgSendListener(in nsIMsgSendListener sendListener);</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6">   /* for easier use of nsIMsgSendListener */</span>
<a href="#l2.7"></a><span id="l2.7">   void removeMsgSendListener(in nsIMsgSendListener sendListener);</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9"> };</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11"> /* send listener interface */</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-[noscript, uuid(ACC72780-2CEA-11D5-9DAA-BACDEAC1EEFC)]</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+[uuid(ACC72780-2CEA-11D5-9DAA-BACDEAC1EEFC)]</span>
<a href="#l2.14"></a><span id="l2.14"> interface nsIMsgComposeSendListener : nsISupports {</span>
<a href="#l2.15"></a><span id="l2.15"> </span>
<a href="#l2.16"></a><span id="l2.16">   void setMsgCompose(in nsIMsgCompose msgCompose);</span>
<a href="#l2.17"></a><span id="l2.17">   void setDeliverMode(in MSG_DeliverMode deliverMode);</span>
<a href="#l2.18"></a><span id="l2.18">  </span>
<a href="#l2.19"></a><span id="l2.19"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/compose/public/nsIMsgSend.idl</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/compose/public/nsIMsgSend.idl</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -51,126 +51,213 @@</span>
<a href="#l3.4"></a><span id="l3.4"> #include &quot;nsIMsgSendReport.idl&quot;</span>
<a href="#l3.5"></a><span id="l3.5"> #include &quot;domstubs.idl&quot;</span>
<a href="#l3.6"></a><span id="l3.6"> #include &quot;nsIPrompt.idl&quot;</span>
<a href="#l3.7"></a><span id="l3.7"> #include &quot;MailNewsTypes2.idl&quot;</span>
<a href="#l3.8"></a><span id="l3.8"> #include &quot;nsIMsgComposeParams.idl&quot;</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10"> %{C++</span>
<a href="#l3.11"></a><span id="l3.11"> #include &quot;nsIURL.h&quot;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+#include &quot;nsStringGlue.h&quot;</span>
<a href="#l3.13"></a><span id="l3.13"> %}</span>
<a href="#l3.14"></a><span id="l3.14"> </span>
<a href="#l3.15"></a><span id="l3.15"> interface nsIMsgProgress;</span>
<a href="#l3.16"></a><span id="l3.16"> interface nsIURI;</span>
<a href="#l3.17"></a><span id="l3.17"> interface nsIRequest;</span>
<a href="#l3.18"></a><span id="l3.18"> interface nsIMsgDBHdr;</span>
<a href="#l3.19"></a><span id="l3.19"> interface nsIMsgHdr;</span>
<a href="#l3.20"></a><span id="l3.20"> interface nsIDocShell;</span>
<a href="#l3.21"></a><span id="l3.21"> interface nsIFile;</span>
<a href="#l3.22"></a><span id="l3.22"> interface nsILocalFile;</span>
<a href="#l3.23"></a><span id="l3.23"> interface nsIOutputStream;</span>
<a href="#l3.24"></a><span id="l3.24"> interface nsIMsgComposeSecure;</span>
<a href="#l3.25"></a><span id="l3.25"> interface nsIMsgStatusFeedback;</span>
<a href="#l3.26"></a><span id="l3.26"> interface nsIEditor;</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+interface nsIArray;</span>
<a href="#l3.28"></a><span id="l3.28"> </span>
<a href="#l3.29"></a><span id="l3.29"> typedef long nsMsgDeliverMode;</span>
<a href="#l3.30"></a><span id="l3.30"> </span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-%{ C++</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-//</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-// Callback declarations for message delivery</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-//</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-// For completion of send/message creation operations...</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-typedef nsresult (*nsMsgSendCompletionCallback) (nsresult aExitCode, void *tagData, nsILocalFile *returnFile);</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+[scriptable, uuid(d664fd40-87b6-487f-a01f-c54ab2e29314)]</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+interface nsIMsgAttachmentData : nsISupports</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+{</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+  /// The URL to attach.</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+  attribute nsIURI url;</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+  /**</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+   * The type to which this document should be</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+   * converted.  Legal values are NULL, TEXT_PLAIN</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+   * and APPLICATION_POSTSCRIPT (which are macros</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+   * defined in net.h); other values are ignored.</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+   */</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+  attribute ACString desiredType;</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+  /**</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+   * The type of the URL if known, otherwise empty. For example, if</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+   * you were attaching a temp file which was known to contain HTML data,</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+   * you would pass in TEXT_HTML as the realType, to override whatever type</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+   * the name of the tmp file might otherwise indicate.</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+   */</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+  attribute ACString realType;</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+  /// Goes along with real_type.</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+  attribute ACString realEncoding; </span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+  /**</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+   * The original name of this document, which will eventually show up in the</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+   * Content-Disposition header. For example, if you had copied a document to a</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+   * tmp file, this would be the original, human-readable name of the document.</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+   */</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+  attribute ACString realName;</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+  /**</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+   * If you put a string here, it will show up as the Content-Description</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+   * header. This can be any explanatory text; it's not a file name.</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+   */</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+  attribute ACString description;</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+  /// mac-specific info</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+  attribute ACString xMacType;</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+  /// mac-specific info</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+  attribute ACString xMacCreator;</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+};</span>
<a href="#l3.80"></a><span id="l3.80"> </span>
<a href="#l3.81"></a><span id="l3.81" class="difflineminus">-// For completion of sending unsent messages operations...</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineminus">-typedef nsresult (*nsMsgSendUnsentMessagesCallback) (nsresult aExitCode, PRUint32 totalSentCount,</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineminus">-                                                     PRUint32 totalSentSuccessfully, void *tagData);</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineminus">-%}</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+/**</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+ * When we have downloaded a URL to a tmp file for attaching, this</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+ * represents everything we learned about it (and did to it) in the</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+ * process.</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+ */</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+[scriptable, uuid(156bad99-c5a1-425d-8319-3e79c02571d4)]</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+interface nsIMsgAttachedFile : nsISupports</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+{</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+  /// Where it came from on the network (or even elsewhere on the local disk.)</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+  attribute nsIURI origUrl;</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineplus">+</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+  /// The tmp file in which the (possibly converted) data now resides.</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+  attribute nsILocalFile tmpFile;</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineplus">+</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+  /// The type of the data in file_name (not necessarily the same as the type of orig_url.)</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+  attribute ACString type;</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineplus">+</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+  /**</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+   * The encoding of the tmp file. This will be set only if the original</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+   * document had an encoding already; we don't do base64 encoding and so forth</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineplus">+   * until it's time to assemble a full MIME message of all parts.</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineplus">+   */</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineplus">+  attribute ACString encoding;</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+  /// For Content-Description header.</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineplus">+  attribute ACString description;</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineplus">+</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineplus">+  attribute ACString xMacType;    // mac-specific info </span>
<a href="#l3.112"></a><span id="l3.112" class="difflineplus">+  attribute ACString xMacCreator; // mac-specific info </span>
<a href="#l3.113"></a><span id="l3.113" class="difflineplus">+  attribute ACString realName;      // The real name of the file. </span>
<a href="#l3.114"></a><span id="l3.114" class="difflineplus">+</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineplus">+  /**</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+   * Some statistics about the data that was written to the file, so that when</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineplus">+   * it comes time to compose a MIME message, we can make an informed decision</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineplus">+   * about what Content-Transfer-Encoding would be best for this attachment.</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineplus">+   * (If it's encoded already, we ignore this information and ship it as-is.)</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineplus">+   */</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineplus">+  attribute unsigned long size;</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineplus">+  attribute unsigned long unprintableCount;</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineplus">+  attribute unsigned long highbitCount;</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineplus">+  attribute unsigned long ctlCount;</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineplus">+  attribute unsigned long nullCount;</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineplus">+  attribute unsigned long maxLineLength;</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineplus">+};</span>
<a href="#l3.128"></a><span id="l3.128"> </span>
<a href="#l3.129"></a><span id="l3.129"> %{ C++</span>
<a href="#l3.130"></a><span id="l3.130"> // Forward declaration</span>
<a href="#l3.131"></a><span id="l3.131"> class nsMsgAttachmentHandler;</span>
<a href="#l3.132"></a><span id="l3.132"> </span>
<a href="#l3.133"></a><span id="l3.133" class="difflineminus">-// Attachment file/URL structures</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineminus">-struct nsMsgAttachmentData</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineplus">+// Attachment file/URL structures - we're letting libmime use this directly</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineplus">+class nsMsgAttachmentData : public nsIMsgAttachmentData</span>
<a href="#l3.137"></a><span id="l3.137"> {</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineminus">-  nsIURI* url;            // The URL to attach. This should be 0 to signify &quot;end of list&quot;.</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineplus">+public:</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineplus">+  NS_DECL_NSIMSGATTACHMENTDATA</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l3.142"></a><span id="l3.142"> </span>
<a href="#l3.143"></a><span id="l3.143" class="difflineminus">-  char *desired_type;      // The type to which this document should be</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineplus">+  nsMsgAttachmentData();</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineplus">+  ~nsMsgAttachmentData();</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineplus">+</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineplus">+  nsCOMPtr&lt;nsIURI&gt; m_url; // The URL to attach.</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineplus">+</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineplus">+  nsCString m_desiredType; // The type to which this document should be</span>
<a href="#l3.150"></a><span id="l3.150">                           // converted.  Legal values are NULL, TEXT_PLAIN</span>
<a href="#l3.151"></a><span id="l3.151">                           // and APPLICATION_POSTSCRIPT (which are macros</span>
<a href="#l3.152"></a><span id="l3.152">                           // defined in net.h); other values are ignored.</span>
<a href="#l3.153"></a><span id="l3.153"> </span>
<a href="#l3.154"></a><span id="l3.154" class="difflineminus">-  char *real_type;        // The type of the URL if known, otherwise NULL. For example, if </span>
<a href="#l3.155"></a><span id="l3.155" class="difflineplus">+  nsCString m_realType;        // The type of the URL if known, otherwise NULL. For example, if </span>
<a href="#l3.156"></a><span id="l3.156">                           // you were attaching a temp file which was known to contain HTML data, </span>
<a href="#l3.157"></a><span id="l3.157">                           // you would pass in TEXT_HTML as the real_type, to override whatever type </span>
<a href="#l3.158"></a><span id="l3.158">                           // the name of the tmp file might otherwise indicate.</span>
<a href="#l3.159"></a><span id="l3.159"> </span>
<a href="#l3.160"></a><span id="l3.160" class="difflineminus">-  char *real_encoding;    // Goes along with real_type </span>
<a href="#l3.161"></a><span id="l3.161" class="difflineplus">+  nsCString m_realEncoding;    // Goes along with real_type </span>
<a href="#l3.162"></a><span id="l3.162"> </span>
<a href="#l3.163"></a><span id="l3.163" class="difflineminus">-  char *real_name;        // The original name of this document, which will eventually show up in the </span>
<a href="#l3.164"></a><span id="l3.164" class="difflineplus">+  nsCString m_realName;        // The original name of this document, which will eventually show up in the </span>
<a href="#l3.165"></a><span id="l3.165">                           // Content-Disposition header. For example, if you had copied a document to a </span>
<a href="#l3.166"></a><span id="l3.166">                           // tmp file, this would be the original, human-readable name of the document.</span>
<a href="#l3.167"></a><span id="l3.167"> </span>
<a href="#l3.168"></a><span id="l3.168" class="difflineminus">-  char *description;      // If you put a string here, it will show up as the Content-Description header.  </span>
<a href="#l3.169"></a><span id="l3.169" class="difflineplus">+  nsCString m_description;      // If you put a string here, it will show up as the Content-Description header.  </span>
<a href="#l3.170"></a><span id="l3.170">                           // This can be any explanatory text; it's not a file name.             </span>
<a href="#l3.171"></a><span id="l3.171"> </span>
<a href="#l3.172"></a><span id="l3.172" class="difflineminus">-  char *x_mac_type, *x_mac_creator; // Mac-specific data that should show up as optional parameters</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineminus">-                                    // to the content-type header.</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineminus">-  PRInt32 size;                  // The size of the attachment. May be 0.</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineminus">-  PRBool  isExternalAttachment;  // Flag for determining if the attachment is external</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineminus">-  PRBool  isDownloaded;          // Flag for determining if the attachment has already been downloaded</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineminus">-  PRBool  hasFilename;           // Tells whether the name is provided by us or if it's a Part 1.2-like attachment</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineplus">+  // Mac-specific data that should show up as optional parameters</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineplus">+  // to the content-type header.</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineplus">+  nsCString m_xMacType;</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineplus">+  nsCString m_xMacCreator;</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineplus">+</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineplus">+  PRInt32 m_size;                  // The size of the attachment. May be 0.</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineplus">+  PRBool  m_isExternalAttachment;  // Flag for determining if the attachment is external</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineplus">+  PRBool  m_isDownloaded;          // Flag for determining if the attachment has already been downloaded</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineplus">+  PRBool  m_hasFilename;           // Tells whether the name is provided by us or if it's a Part 1.2-like attachment</span>
<a href="#l3.187"></a><span id="l3.187"> };</span>
<a href="#l3.188"></a><span id="l3.188"> </span>
<a href="#l3.189"></a><span id="l3.189" class="difflineminus">-</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineminus">-//</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineminus">-// When we have downloaded a URL to a tmp file for attaching, this</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineminus">-// represents everything we learned about it (and did to it) in the</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineminus">-// process. </span>
<a href="#l3.194"></a><span id="l3.194" class="difflineminus">-//</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineminus">-typedef struct nsMsgAttachedFile</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineplus">+class nsMsgAttachedFile : public nsIMsgAttachedFile</span>
<a href="#l3.197"></a><span id="l3.197"> {</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineminus">-  nsCOMPtr&lt;nsIURI&gt; orig_url;  // Where it came from on the network (or even elsewhere on the local disk.)</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineplus">+public:</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineplus">+  NS_DECL_NSIMSGATTACHEDFILE</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineplus">+</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineplus">+  nsMsgAttachedFile();</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineplus">+  ~nsMsgAttachedFile();</span>
<a href="#l3.205"></a><span id="l3.205"> </span>
<a href="#l3.206"></a><span id="l3.206" class="difflineminus">-  nsCOMPtr &lt;nsILocalFile&gt;  tmp_file;    // The tmp file in which the (possibly converted) data now resides.</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineminus">-  </span>
<a href="#l3.208"></a><span id="l3.208" class="difflineminus">-  char        *type;        // The type of the data in file_name (not necessarily the same as the type of orig_url.)</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineplus">+  nsCOMPtr&lt;nsIURI&gt; m_origUrl; // Where it came from on the network (or even elsewhere on the local disk.)</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineplus">+</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt;  m_tmpFile;    // The tmp file in which the (possibly converted) data now resides.</span>
<a href="#l3.212"></a><span id="l3.212"> </span>
<a href="#l3.213"></a><span id="l3.213" class="difflineminus">-  char        *encoding;    // Likewise, the encoding of the tmp file. This will be set only if the original </span>
<a href="#l3.214"></a><span id="l3.214" class="difflineplus">+  nsCString m_type;        // The type of the data in file_name (not necessarily the same as the type of orig_url.)</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineplus">+</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineplus">+  nsCString m_encoding;    // Likewise, the encoding of the tmp file. This will be set only if the original </span>
<a href="#l3.217"></a><span id="l3.217">                             // document had an encoding already; we don't do base64 encoding and so forth until </span>
<a href="#l3.218"></a><span id="l3.218">                             // it's time to assemble a full MIME message of all parts.</span>
<a href="#l3.219"></a><span id="l3.219"> </span>
<a href="#l3.220"></a><span id="l3.220"> </span>
<a href="#l3.221"></a><span id="l3.221" class="difflineminus">-  char        *description;    // For Content-Description header </span>
<a href="#l3.222"></a><span id="l3.222" class="difflineminus">-  char        *x_mac_type;    // mac-specific info </span>
<a href="#l3.223"></a><span id="l3.223" class="difflineminus">-  char        *x_mac_creator; // mac-specific info </span>
<a href="#l3.224"></a><span id="l3.224" class="difflineminus">-  char        *real_name;      // The real name of the file. </span>
<a href="#l3.225"></a><span id="l3.225" class="difflineplus">+  nsCString m_description;    // For Content-Description header </span>
<a href="#l3.226"></a><span id="l3.226" class="difflineplus">+  nsCString m_xMacType;    // mac-specific info </span>
<a href="#l3.227"></a><span id="l3.227" class="difflineplus">+  nsCString m_xMacCreator; // mac-specific info </span>
<a href="#l3.228"></a><span id="l3.228" class="difflineplus">+  nsCString m_realName;      // The real name of the file. </span>
<a href="#l3.229"></a><span id="l3.229"> </span>
<a href="#l3.230"></a><span id="l3.230">   // Some statistics about the data that was written to the file, so that when</span>
<a href="#l3.231"></a><span id="l3.231">   // it comes time to compose a MIME message, we can make an informed decision</span>
<a href="#l3.232"></a><span id="l3.232">   // about what Content-Transfer-Encoding would be best for this attachment.</span>
<a href="#l3.233"></a><span id="l3.233">   // (If it's encoded already, we ignore this information and ship it as-is.)</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineminus">-  PRUint32    size;</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineminus">-  PRUint32    unprintable_count;</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineminus">-  PRUint32    highbit_count;</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineminus">-  PRUint32    ctl_count;</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineminus">-  PRUint32    null_count;</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineminus">-  PRUint32    max_line_length;</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineminus">-  </span>
<a href="#l3.241"></a><span id="l3.241" class="difflineminus">-} nsMsgAttachedFile;</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineplus">+  PRUint32    m_size;</span>
<a href="#l3.243"></a><span id="l3.243" class="difflineplus">+  PRUint32    m_unprintableCount;</span>
<a href="#l3.244"></a><span id="l3.244" class="difflineplus">+  PRUint32    m_highbitCount;</span>
<a href="#l3.245"></a><span id="l3.245" class="difflineplus">+  PRUint32    m_ctlCount;</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineplus">+  PRUint32    m_nullCount;</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineplus">+  PRUint32    m_maxLineLength;</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineplus">+};</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineplus">+</span>
<a href="#l3.250"></a><span id="l3.250"> %}</span>
<a href="#l3.251"></a><span id="l3.251"> </span>
<a href="#l3.252"></a><span id="l3.252" class="difflineminus">-</span>
<a href="#l3.253"></a><span id="l3.253" class="difflineminus">-[ptr] native nsMsgAttachmentData(nsMsgAttachmentData);</span>
<a href="#l3.254"></a><span id="l3.254" class="difflineplus">+[ptr] native nsMsgAttachmentHandler(nsMsgAttachmentHandler);</span>
<a href="#l3.255"></a><span id="l3.255"> [ptr] native nsMsgAttachedFile(nsMsgAttachedFile);</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineminus">-[ptr] native nsMsgAttachmentHandler(nsMsgAttachmentHandler);</span>
<a href="#l3.257"></a><span id="l3.257"> </span>
<a href="#l3.258"></a><span id="l3.258" class="difflineminus">-[scriptable, uuid(8a3eb87e-6643-439b-bf0c-3aa2ede692ef)]</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineminus">-interface nsIMsgSend : nsISupports </span>
<a href="#l3.260"></a><span id="l3.260" class="difflineplus">+[scriptable, uuid(95b2fafb-1b2a-4cea-8774-72b15f31f428)]</span>
<a href="#l3.261"></a><span id="l3.261" class="difflineplus">+interface nsIMsgSend : nsISupports</span>
<a href="#l3.262"></a><span id="l3.262"> {</span>
<a href="#l3.263"></a><span id="l3.263">   //</span>
<a href="#l3.264"></a><span id="l3.264">   // This is the primary interface for creating and sending RFC822 messages</span>
<a href="#l3.265"></a><span id="l3.265">   // in the new architecture. Currently, this method supports many arguments</span>
<a href="#l3.266"></a><span id="l3.266">   // that change the behavior of the operation. This will change in time to </span>
<a href="#l3.267"></a><span id="l3.267">   // be separate calls that will be more singluar in nature.</span>
<a href="#l3.268"></a><span id="l3.268">   //</span>
<a href="#l3.269"></a><span id="l3.269">   // NOTE: when aEditor is non-null, a multipart related MHTML message will </span>
<a href="#l3.270"></a><span id="l3.270" class="difflineat">@@ -188,38 +275,59 @@ interface nsIMsgSend : nsISupports</span>
<a href="#l3.271"></a><span id="l3.271">   const nsMsgDeliverMode nsMsgSaveAs = 3;</span>
<a href="#l3.272"></a><span id="l3.272">   const nsMsgDeliverMode nsMsgSaveAsDraft = 4;</span>
<a href="#l3.273"></a><span id="l3.273">   const nsMsgDeliverMode nsMsgSaveAsTemplate = 5;</span>
<a href="#l3.274"></a><span id="l3.274">   const nsMsgDeliverMode nsMsgSendUnsent = 6;</span>
<a href="#l3.275"></a><span id="l3.275"> </span>
<a href="#l3.276"></a><span id="l3.276">   /// Queue the message in the unsent folder and send it in the background.</span>
<a href="#l3.277"></a><span id="l3.277">   const nsMsgDeliverMode nsMsgDeliverBackground = 8;</span>
<a href="#l3.278"></a><span id="l3.278"> </span>
<a href="#l3.279"></a><span id="l3.279" class="difflineminus">-    [noscript]</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineminus">-    void createAndSendMessage(in nsIEditor                    aEditor,</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineminus">-                              in nsIMsgIdentity               aUserIdentity,</span>
<a href="#l3.282"></a><span id="l3.282" class="difflineminus">-                              in string                       aAccountKey,</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineminus">-                              in nsIMsgCompFields             fields,</span>
<a href="#l3.284"></a><span id="l3.284" class="difflineminus">-                              in boolean                      digest_p,</span>
<a href="#l3.285"></a><span id="l3.285" class="difflineminus">-                              in boolean                      dont_deliver_p,</span>
<a href="#l3.286"></a><span id="l3.286" class="difflineminus">-                              in nsMsgDeliverMode             mode, </span>
<a href="#l3.287"></a><span id="l3.287" class="difflineminus">-                              in nsIMsgDBHdr                  msgToReplace,</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineminus">-                              in string               attachment1_type,</span>
<a href="#l3.289"></a><span id="l3.289" class="difflineminus">-                              in string               attachment1_body,</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineminus">-                              in PRUint32                     attachment1_body_length,</span>
<a href="#l3.291"></a><span id="l3.291" class="difflineminus">-                              [const] in nsMsgAttachmentData  attachments,</span>
<a href="#l3.292"></a><span id="l3.292" class="difflineminus">-                              [const] in nsMsgAttachedFile    preloaded_attachments,</span>
<a href="#l3.293"></a><span id="l3.293" class="difflineminus">-                              in voidPtr                      relatedPart,</span>
<a href="#l3.294"></a><span id="l3.294" class="difflineminus">-                              in nsIDOMWindow                 parentWindow,</span>
<a href="#l3.295"></a><span id="l3.295" class="difflineminus">-                              in nsIMsgProgress               progress,</span>
<a href="#l3.296"></a><span id="l3.296" class="difflineminus">-                              in nsIMsgSendListener           aListener,</span>
<a href="#l3.297"></a><span id="l3.297" class="difflineminus">-                              in string                       password,</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineminus">-                              in AUTF8String                  aOriginalMsgURI,</span>
<a href="#l3.299"></a><span id="l3.299" class="difflineminus">-                              in MSG_ComposeType              aType</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineminus">-                             );</span>
<a href="#l3.301"></a><span id="l3.301" class="difflineplus">+  /**</span>
<a href="#l3.302"></a><span id="l3.302" class="difflineplus">+   * Create an rfc822 message and send it.</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineplus">+   * @param aEditor nsIEditor instance that contains message. May be a dummy,</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineplus">+   *                especially in the case of import.</span>
<a href="#l3.305"></a><span id="l3.305" class="difflineplus">+   * @param aUserIdentity identity to send from.</span>
<a href="#l3.306"></a><span id="l3.306" class="difflineplus">+   * @param aAccountKey account we're sending message from. May be null.</span>
<a href="#l3.307"></a><span id="l3.307" class="difflineplus">+   * @param aFields composition fields from addressing widget</span>
<a href="#l3.308"></a><span id="l3.308" class="difflineplus">+   * @param aIsDigest is this a digest message?</span>
<a href="#l3.309"></a><span id="l3.309" class="difflineplus">+   * @param aDontDeliver Set to false by the import code - used when we're</span>
<a href="#l3.310"></a><span id="l3.310" class="difflineplus">+   *                     trying to create a message from parts.</span>
<a href="#l3.311"></a><span id="l3.311" class="difflineplus">+   * @param aMode delivery mode</span>
<a href="#l3.312"></a><span id="l3.312" class="difflineplus">+   * @param aMsgToReplace e.g., when saving a draft over an old draft. May be 0</span>
<a href="#l3.313"></a><span id="l3.313" class="difflineplus">+   * @param aBodyType content type of message body</span>
<a href="#l3.314"></a><span id="l3.314" class="difflineplus">+   * @param aBody message body text (should have native line endings)</span>
<a href="#l3.315"></a><span id="l3.315" class="difflineplus">+   * @param aBodyLength passed in to avoid extra strlen call.</span>
<a href="#l3.316"></a><span id="l3.316" class="difflineplus">+   * @param aAttachments Array of nsIMsgAttachmentData</span>
<a href="#l3.317"></a><span id="l3.317" class="difflineplus">+   * @param aPreloadedAttachments Array of nsIMsgAttachedFile</span>
<a href="#l3.318"></a><span id="l3.318" class="difflineplus">+   * @param aParentWindow compose window; may be null.</span>
<a href="#l3.319"></a><span id="l3.319" class="difflineplus">+   * @param aProgress where to send progress info; may be null.</span>
<a href="#l3.320"></a><span id="l3.320" class="difflineplus">+   * @param aListener optional listener for send progress</span>
<a href="#l3.321"></a><span id="l3.321" class="difflineplus">+   * @param aPassword optional smtp server password</span>
<a href="#l3.322"></a><span id="l3.322" class="difflineplus">+   * @param aOriginalMsgURI may be null.</span>
<a href="#l3.323"></a><span id="l3.323" class="difflineplus">+   * @param aType see nsIMsgComposeParams.idl</span>
<a href="#l3.324"></a><span id="l3.324" class="difflineplus">+   */</span>
<a href="#l3.325"></a><span id="l3.325" class="difflineplus">+    void createAndSendMessage(in nsIEditor aEditor,</span>
<a href="#l3.326"></a><span id="l3.326" class="difflineplus">+                              in nsIMsgIdentity aUserIdentity,</span>
<a href="#l3.327"></a><span id="l3.327" class="difflineplus">+                              in string aAccountKey,</span>
<a href="#l3.328"></a><span id="l3.328" class="difflineplus">+                              in nsIMsgCompFields aFields,</span>
<a href="#l3.329"></a><span id="l3.329" class="difflineplus">+                              in boolean aIsDigest,</span>
<a href="#l3.330"></a><span id="l3.330" class="difflineplus">+                              in boolean aDontDeliver,</span>
<a href="#l3.331"></a><span id="l3.331" class="difflineplus">+                              in nsMsgDeliverMode aMode,</span>
<a href="#l3.332"></a><span id="l3.332" class="difflineplus">+                              in nsIMsgDBHdr aMsgToReplace,</span>
<a href="#l3.333"></a><span id="l3.333" class="difflineplus">+                              in string aBodyType,</span>
<a href="#l3.334"></a><span id="l3.334" class="difflineplus">+                              in string aBody,</span>
<a href="#l3.335"></a><span id="l3.335" class="difflineplus">+                              in unsigned long aBodyLength,</span>
<a href="#l3.336"></a><span id="l3.336" class="difflineplus">+                              in nsIArray aAttachments,</span>
<a href="#l3.337"></a><span id="l3.337" class="difflineplus">+                              in nsIArray aPreloadedAttachments,</span>
<a href="#l3.338"></a><span id="l3.338" class="difflineplus">+                              in nsIDOMWindow aParentWindow,</span>
<a href="#l3.339"></a><span id="l3.339" class="difflineplus">+                              in nsIMsgProgress aProgress,</span>
<a href="#l3.340"></a><span id="l3.340" class="difflineplus">+                              in nsIMsgSendListener aListener,</span>
<a href="#l3.341"></a><span id="l3.341" class="difflineplus">+                              in string aPassword,</span>
<a href="#l3.342"></a><span id="l3.342" class="difflineplus">+                              in AUTF8String aOriginalMsgURI,</span>
<a href="#l3.343"></a><span id="l3.343" class="difflineplus">+                              in MSG_ComposeType aType);</span>
<a href="#l3.344"></a><span id="l3.344"> </span>
<a href="#l3.345"></a><span id="l3.345">   /**</span>
<a href="#l3.346"></a><span id="l3.346">    * Sends a file to the specified composition fields, via the user identity</span>
<a href="#l3.347"></a><span id="l3.347">    * provided.</span>
<a href="#l3.348"></a><span id="l3.348">    *</span>
<a href="#l3.349"></a><span id="l3.349">    * @param aUserIdentity    The user identity to use for sending this email.</span>
<a href="#l3.350"></a><span id="l3.350">    * @param aAccountKey      The key of the account that this message relates</span>
<a href="#l3.351"></a><span id="l3.351">    *                         to.</span>
<a href="#l3.352"></a><span id="l3.352" class="difflineat">@@ -257,58 +365,58 @@ interface nsIMsgSend : nsISupports</span>
<a href="#l3.353"></a><span id="l3.353">                        in nsIMsgDBHdr          aMsgToReplace,</span>
<a href="#l3.354"></a><span id="l3.354">                        in nsIMsgSendListener   aListener,</span>
<a href="#l3.355"></a><span id="l3.355">                        in nsIMsgStatusFeedback aStatusFeedback,</span>
<a href="#l3.356"></a><span id="l3.356">                        in string               aPassword</span>
<a href="#l3.357"></a><span id="l3.357">                        ); </span>
<a href="#l3.358"></a><span id="l3.358"> </span>
<a href="#l3.359"></a><span id="l3.359">     /* Abort current send/save operation */</span>
<a href="#l3.360"></a><span id="l3.360">     void abort();</span>
<a href="#l3.361"></a><span id="l3.361" class="difflineminus">-    </span>
<a href="#l3.362"></a><span id="l3.362" class="difflineplus">+</span>
<a href="#l3.363"></a><span id="l3.363">     /* Report a send failure */</span>
<a href="#l3.364"></a><span id="l3.364">     nsresult fail(in nsresult failure_code, in wstring error_msg);</span>
<a href="#l3.365"></a><span id="l3.365"> </span>
<a href="#l3.366"></a><span id="l3.366">     /* Disable UI notification (alert message) */</span>
<a href="#l3.367"></a><span id="l3.367">     void setGUINotificationState(in boolean aEnableFlag);</span>
<a href="#l3.368"></a><span id="l3.368" class="difflineminus">-    </span>
<a href="#l3.369"></a><span id="l3.369" class="difflineplus">+</span>
<a href="#l3.370"></a><span id="l3.370">     /* Crypto */</span>
<a href="#l3.371"></a><span id="l3.371">     void BeginCryptoEncapsulation();</span>
<a href="#l3.372"></a><span id="l3.372"> </span>
<a href="#l3.373"></a><span id="l3.373">     /* retreive the last send process report*/</span>
<a href="#l3.374"></a><span id="l3.374">     readonly attribute nsIMsgSendReport sendReport; </span>
<a href="#l3.375"></a><span id="l3.375" class="difflineminus">-    </span>
<a href="#l3.376"></a><span id="l3.376" class="difflineplus">+</span>
<a href="#l3.377"></a><span id="l3.377">     /* methods for send listener ... */</span>
<a href="#l3.378"></a><span id="l3.378" class="difflineminus">-    [noscript] void notifyListenerOnStartSending(in string aMsgID, in unsigned long aMsgSize);</span>
<a href="#l3.379"></a><span id="l3.379" class="difflineminus">-    [noscript] void notifyListenerOnProgress(in string aMsgID, in unsigned long aProgress, in unsigned long aProgressMax);</span>
<a href="#l3.380"></a><span id="l3.380" class="difflineminus">-    [noscript] void notifyListenerOnStatus(in string aMsgID, in wstring aMsg);</span>
<a href="#l3.381"></a><span id="l3.381" class="difflineminus">-    [noscript] void notifyListenerOnStopSending(in string aMsgID, in nsresult aStatus, in wstring aMsg, in nsIFile returnFile);</span>
<a href="#l3.382"></a><span id="l3.382" class="difflineminus">-    [noscript] void deliverAsMailExit(in nsIURI aUrl, in nsresult aExitCode);</span>
<a href="#l3.383"></a><span id="l3.383" class="difflineminus">-    [noscript] void deliverAsNewsExit(in nsIURI aUrl, in nsresult aExitCode);</span>
<a href="#l3.384"></a><span id="l3.384" class="difflineplus">+    void notifyListenerOnStartSending(in string aMsgID, in unsigned long aMsgSize);</span>
<a href="#l3.385"></a><span id="l3.385" class="difflineplus">+    void notifyListenerOnProgress(in string aMsgID, in unsigned long aProgress, in unsigned long aProgressMax);</span>
<a href="#l3.386"></a><span id="l3.386" class="difflineplus">+    void notifyListenerOnStatus(in string aMsgID, in wstring aMsg);</span>
<a href="#l3.387"></a><span id="l3.387" class="difflineplus">+    void notifyListenerOnStopSending(in string aMsgID, in nsresult aStatus, in wstring aMsg, in nsIFile returnFile);</span>
<a href="#l3.388"></a><span id="l3.388" class="difflineplus">+    void deliverAsMailExit(in nsIURI aUrl, in nsresult aExitCode);</span>
<a href="#l3.389"></a><span id="l3.389" class="difflineplus">+    void deliverAsNewsExit(in nsIURI aUrl, in nsresult aExitCode);</span>
<a href="#l3.390"></a><span id="l3.390">     </span>
<a href="#l3.391"></a><span id="l3.391" class="difflineminus">-    [noscript] void sendDeliveryCallback(in nsIURI aUrl, in boolean inIsNewsDelivery, in nsresult aExitCode);</span>
<a href="#l3.392"></a><span id="l3.392" class="difflineplus">+    void sendDeliveryCallback(in nsIURI aUrl, in boolean inIsNewsDelivery, in nsresult aExitCode);</span>
<a href="#l3.393"></a><span id="l3.393"> </span>
<a href="#l3.394"></a><span id="l3.394">     /* methods for copy listener ... */</span>
<a href="#l3.395"></a><span id="l3.395" class="difflineminus">-    [noscript] void notifyListenerOnStartCopy(); </span>
<a href="#l3.396"></a><span id="l3.396" class="difflineminus">-    [noscript] void notifyListenerOnProgressCopy(in unsigned long aProgress, in unsigned long aProgressMax);</span>
<a href="#l3.397"></a><span id="l3.397" class="difflineminus">-    [noscript] void notifyListenerOnStopCopy(in nsresult aStatus);</span>
<a href="#l3.398"></a><span id="l3.398" class="difflineplus">+    void notifyListenerOnStartCopy(); </span>
<a href="#l3.399"></a><span id="l3.399" class="difflineplus">+    void notifyListenerOnProgressCopy(in unsigned long aProgress, in unsigned long aProgressMax);</span>
<a href="#l3.400"></a><span id="l3.400" class="difflineplus">+    void notifyListenerOnStopCopy(in nsresult aStatus);</span>
<a href="#l3.401"></a><span id="l3.401">     void getMessageId(out ACString messageID);</span>
<a href="#l3.402"></a><span id="l3.402" class="difflineminus">-    [noscript] attribute nsMsgKey messageKey;</span>
<a href="#l3.403"></a><span id="l3.403" class="difflineplus">+    attribute nsMsgKey messageKey;</span>
<a href="#l3.404"></a><span id="l3.404"> </span>
<a href="#l3.405"></a><span id="l3.405" class="difflineminus">-    [noscript] nsIPrompt getDefaultPrompt();</span>
<a href="#l3.406"></a><span id="l3.406" class="difflineminus">-    </span>
<a href="#l3.407"></a><span id="l3.407" class="difflineplus">+    nsIPrompt getDefaultPrompt();</span>
<a href="#l3.408"></a><span id="l3.408" class="difflineplus">+</span>
<a href="#l3.409"></a><span id="l3.409">     /* process attachment */</span>
<a href="#l3.410"></a><span id="l3.410" class="difflineminus">-    [noscript] void gatherMimeAttachments();</span>
<a href="#l3.411"></a><span id="l3.411" class="difflineminus">-    [noscript] boolean getProcessAttachmentsSynchronously();</span>
<a href="#l3.412"></a><span id="l3.412" class="difflineplus">+    void gatherMimeAttachments();</span>
<a href="#l3.413"></a><span id="l3.413" class="difflineplus">+    readonly attribute boolean processAttachmentsSynchronously;</span>
<a href="#l3.414"></a><span id="l3.414">     [noscript] nsMsgAttachmentHandler getAttachmentHandlers();</span>
<a href="#l3.415"></a><span id="l3.415" class="difflineminus">-    [noscript] readonly attribute unsigned long attachmentCount;</span>
<a href="#l3.416"></a><span id="l3.416" class="difflineminus">-    [noscript] attribute unsigned long pendingAttachmentCount;</span>
<a href="#l3.417"></a><span id="l3.417" class="difflineminus">-    [noscript] readonly attribute nsMsgDeliverMode deliveryMode;</span>
<a href="#l3.418"></a><span id="l3.418" class="difflineplus">+    readonly attribute unsigned long attachmentCount;</span>
<a href="#l3.419"></a><span id="l3.419" class="difflineplus">+    attribute unsigned long pendingAttachmentCount;</span>
<a href="#l3.420"></a><span id="l3.420" class="difflineplus">+    readonly attribute nsMsgDeliverMode deliveryMode;</span>
<a href="#l3.421"></a><span id="l3.421"> </span>
<a href="#l3.422"></a><span id="l3.422" class="difflineminus">-    [noscript] nsIMsgProgress getProgress();</span>
<a href="#l3.423"></a><span id="l3.423" class="difflineminus">-    </span>
<a href="#l3.424"></a><span id="l3.424" class="difflineplus">+    nsIMsgProgress getProgress();</span>
<a href="#l3.425"></a><span id="l3.425" class="difflineplus">+</span>
<a href="#l3.426"></a><span id="l3.426">     nsIOutputStream getOutputStream();</span>
<a href="#l3.427"></a><span id="l3.427"> </span>
<a href="#l3.428"></a><span id="l3.428" class="difflineminus">-    [noscript] attribute nsIRequest runningRequest;</span>
<a href="#l3.429"></a><span id="l3.429" class="difflineplus">+    attribute nsIRequest runningRequest;</span>
<a href="#l3.430"></a><span id="l3.430"> </span>
<a href="#l3.431"></a><span id="l3.431" class="difflineminus">-    [noscript] attribute nsresult status;</span>
<a href="#l3.432"></a><span id="l3.432" class="difflineplus">+    attribute nsresult status;</span>
<a href="#l3.433"></a><span id="l3.433"> </span>
<a href="#l3.434"></a><span id="l3.434" class="difflineminus">-    [noscript] attribute nsIMsgComposeSecure cryptoclosure;</span>
<a href="#l3.435"></a><span id="l3.435" class="difflineplus">+    attribute nsIMsgComposeSecure cryptoclosure;</span>
<a href="#l3.436"></a><span id="l3.436"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/compose/public/nsMsgCompCID.h</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/compose/public/nsMsgCompCID.h</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -134,16 +134,38 @@ 0x0b63fb80, 0xbbba, 0x11d4,             </span>
<a href="#l4.4"></a><span id="l4.4">   &quot;@mozilla.org/messengercompose/attachment;1&quot;</span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6"> #define NS_MSGATTACHMENT_CID                    \</span>
<a href="#l4.7"></a><span id="l4.7"> { /* 27B8D045-8D9F-4fa8-BFB6-8A0F8D09CE89 */    \</span>
<a href="#l4.8"></a><span id="l4.8">  0x27b8d045, 0x8d9f, 0x4fa8,                    \</span>
<a href="#l4.9"></a><span id="l4.9">  {0xbf, 0xb6, 0x8a, 0xf, 0x8d, 0x9, 0xce, 0x89}}</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11"> //</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+// nsMsgAttachmentData</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+//</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+#define NS_MSGATTACHMENTDATA_CONTRACTID \</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+  &quot;@mozilla.org/messengercompose/attachmentdata;1&quot;</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+#define NS_MSGATTACHMENTDATA_CID                    \</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+{ /* 9e16958d-d9e9-4cae-b723-a5bccf104998 */ \</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+ 0x9e16958d, 0xd9e9, 0x4cae, \</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+ {0xb7, 0x23, 0xa5, 0xbc, 0xcf, 0x10, 0x49, 0x98}}</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+//</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+// nsMsgAttachedFile</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+//</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+#define NS_MSGATTACHEDFILE_CONTRACTID \</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+  &quot;@mozilla.org/messengercompose/attachedfile;1&quot;</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+#define NS_MSGATTACHEDFILE_CID                    \</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+{ /* ef173501-4e14-42b9-ae1f-7770de235c29 */ \</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+ 0xef173501, 0x4e14, 0x42b9, \</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+ {0xae, 0x1f, 0x77, 0x70, 0xde, 0x23, 0x5c, 0x29}}</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+//</span>
<a href="#l4.34"></a><span id="l4.34"> // nsMsgSend</span>
<a href="#l4.35"></a><span id="l4.35"> //</span>
<a href="#l4.36"></a><span id="l4.36"> #define NS_MSGSEND_CONTRACTID \</span>
<a href="#l4.37"></a><span id="l4.37">   &quot;@mozilla.org/messengercompose/send;1&quot;</span>
<a href="#l4.38"></a><span id="l4.38"> </span>
<a href="#l4.39"></a><span id="l4.39"> #define NS_MSGSEND_CID                \</span>
<a href="#l4.40"></a><span id="l4.40"> { /* 935284E0-C5D8-11d2-8297-000000000000 */      \</span>
<a href="#l4.41"></a><span id="l4.41">  0x935284e0, 0xc5d8, 0x11d2,                      \</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAttachmentHandler.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAttachmentHandler.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -140,34 +140,20 @@ nsresult nsSimpleZipper::AddToZip(nsIZip</span>
<a href="#l5.4"></a><span id="l5.4"> #endif // XP_MACOSX</span>
<a href="#l5.5"></a><span id="l5.5"> </span>
<a href="#l5.6"></a><span id="l5.6"> //</span>
<a href="#l5.7"></a><span id="l5.7"> // Class implementation...</span>
<a href="#l5.8"></a><span id="l5.8"> //</span>
<a href="#l5.9"></a><span id="l5.9"> nsMsgAttachmentHandler::nsMsgAttachmentHandler() :</span>
<a href="#l5.10"></a><span id="l5.10">   mRequest(nsnull),</span>
<a href="#l5.11"></a><span id="l5.11">   mCompFields(nsnull),   // Message composition fields for the sender</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  </span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-  m_x_mac_type(nsnull),</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-  m_x_mac_creator(nsnull),</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+  m_bogus_attachment(PR_FALSE),</span>
<a href="#l5.17"></a><span id="l5.17">   m_done(PR_FALSE),</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineminus">-  m_charset(nsnull),</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineminus">-  m_content_id(nsnull),</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineminus">-  m_type(nsnull),</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineminus">-  m_type_param(nsnull),</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineminus">-  m_override_type(nsnull),</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineminus">-  m_override_encoding(nsnull),</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">-  m_desired_type(nsnull),</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">-  m_description(nsnull),</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineminus">-  m_real_name(nsnull),</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineminus">-  m_encoding(nsnull),</span>
<a href="#l5.28"></a><span id="l5.28">   m_already_encoded_p(PR_FALSE),</span>
<a href="#l5.29"></a><span id="l5.29">   m_decrypted_p(PR_FALSE),</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-  </span>
<a href="#l5.31"></a><span id="l5.31">   mDeleteFile(PR_FALSE),</span>
<a href="#l5.32"></a><span id="l5.32">   mMHTMLPart(PR_FALSE),</span>
<a href="#l5.33"></a><span id="l5.33">   mPartUserOmissionOverride(PR_FALSE),</span>
<a href="#l5.34"></a><span id="l5.34">   mMainBody(PR_FALSE),</span>
<a href="#l5.35"></a><span id="l5.35"> </span>
<a href="#l5.36"></a><span id="l5.36">   // For analyzing the attachment file...</span>
<a href="#l5.37"></a><span id="l5.37">   m_size(0),</span>
<a href="#l5.38"></a><span id="l5.38">   m_unprintable_count(0),</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineat">@@ -179,44 +165,29 @@ nsMsgAttachmentHandler::nsMsgAttachmentH</span>
<a href="#l5.40"></a><span id="l5.40">   m_have_crlf(0),</span>
<a href="#l5.41"></a><span id="l5.41">   m_prev_char_was_cr(PR_FALSE),</span>
<a href="#l5.42"></a><span id="l5.42">   m_current_column(0),</span>
<a href="#l5.43"></a><span id="l5.43">   m_max_column(0),</span>
<a href="#l5.44"></a><span id="l5.44">   m_lines(0),</span>
<a href="#l5.45"></a><span id="l5.45">   m_file_analyzed(PR_FALSE),</span>
<a href="#l5.46"></a><span id="l5.46"> </span>
<a href="#l5.47"></a><span id="l5.47">   // Mime</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineminus">-  m_encoder_data(nsnull),</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineminus">-  m_uri(nsnull)</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+  m_encoder_data(nsnull)</span>
<a href="#l5.51"></a><span id="l5.51"> {</span>
<a href="#l5.52"></a><span id="l5.52"> }</span>
<a href="#l5.53"></a><span id="l5.53"> </span>
<a href="#l5.54"></a><span id="l5.54"> nsMsgAttachmentHandler::~nsMsgAttachmentHandler()</span>
<a href="#l5.55"></a><span id="l5.55"> {</span>
<a href="#l5.56"></a><span id="l5.56">   if (mTmpFile &amp;&amp; mDeleteFile)</span>
<a href="#l5.57"></a><span id="l5.57">     mTmpFile-&gt;Remove(PR_FALSE);</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">-    </span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+</span>
<a href="#l5.60"></a><span id="l5.60">   if (mOutFile)</span>
<a href="#l5.61"></a><span id="l5.61">     mOutFile-&gt;Close();</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineminus">-    </span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+</span>
<a href="#l5.64"></a><span id="l5.64">   CleanupTempFile();</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineminus">-</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineminus">-  PR_Free(m_charset);</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineminus">-  PR_Free(m_type);</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineminus">-  PR_Free(m_type_param);</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineminus">-  PR_Free(m_content_id);</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineminus">-  PR_Free(m_desired_type);</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineminus">-  PR_Free(m_encoding);</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineminus">-  PR_Free(m_override_type);</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineminus">-  PR_Free(m_description);</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineminus">-  PR_Free(m_real_name);</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineminus">-  PR_Free(m_override_encoding);</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineminus">-  PR_Free(m_x_mac_type);</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineminus">-  PR_Free(m_x_mac_creator);</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineminus">-  PR_Free(m_uri);</span>
<a href="#l5.79"></a><span id="l5.79"> }</span>
<a href="#l5.80"></a><span id="l5.80"> </span>
<a href="#l5.81"></a><span id="l5.81"> void</span>
<a href="#l5.82"></a><span id="l5.82"> nsMsgAttachmentHandler::CleanupTempFile()</span>
<a href="#l5.83"></a><span id="l5.83"> {</span>
<a href="#l5.84"></a><span id="l5.84"> #ifdef XP_MACOSX</span>
<a href="#l5.85"></a><span id="l5.85">   if (mEncodedWorkingFile) {</span>
<a href="#l5.86"></a><span id="l5.86">     mEncodedWorkingFile-&gt;Remove(PR_FALSE);</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineat">@@ -334,17 +305,17 @@ nsMsgAttachmentHandler::PickEncoding(con</span>
<a href="#l5.88"></a><span id="l5.88"> </span>
<a href="#l5.89"></a><span id="l5.89">   AnalyzeSnarfedFile();</span>
<a href="#l5.90"></a><span id="l5.90"> </span>
<a href="#l5.91"></a><span id="l5.91">   /* Allow users to override our percentage-wise guess on whether</span>
<a href="#l5.92"></a><span id="l5.92">   the file is text or binary */</span>
<a href="#l5.93"></a><span id="l5.93">   if (pPrefBranch)</span>
<a href="#l5.94"></a><span id="l5.94">     pPrefBranch-&gt;GetBoolPref (&quot;mail.file_attach_binary&quot;, &amp;forceB64);</span>
<a href="#l5.95"></a><span id="l5.95"> </span>
<a href="#l5.96"></a><span id="l5.96" class="difflineminus">-  if (!mMainBody &amp;&amp; (forceB64 || mime_type_requires_b64_p (m_type) ||</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineplus">+  if (!mMainBody &amp;&amp; (forceB64 || mime_type_requires_b64_p (m_type.get()) ||</span>
<a href="#l5.98"></a><span id="l5.98">     m_have_cr+m_have_lf+m_have_crlf != 1 || m_current_column != 0))</span>
<a href="#l5.99"></a><span id="l5.99">   {</span>
<a href="#l5.100"></a><span id="l5.100">   /* If the content-type is &quot;image/&quot; or something else known to be binary</span>
<a href="#l5.101"></a><span id="l5.101">   or several flavors of newlines are present or last line is incomplete,</span>
<a href="#l5.102"></a><span id="l5.102">   always use base64 (so that we don't get confused by newline</span>
<a href="#l5.103"></a><span id="l5.103">   conversions.)</span>
<a href="#l5.104"></a><span id="l5.104">      */</span>
<a href="#l5.105"></a><span id="l5.105">     needsB64 = PR_TRUE;</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineat">@@ -379,86 +350,69 @@ nsMsgAttachmentHandler::PickEncoding(con</span>
<a href="#l5.107"></a><span id="l5.107">       else if (m_null_count)  /* If there are nulls, we must always encode,</span>
<a href="#l5.108"></a><span id="l5.108">         because sendmail will blow up. */</span>
<a href="#l5.109"></a><span id="l5.109">         encode_p = PR_TRUE;</span>
<a href="#l5.110"></a><span id="l5.110">       else</span>
<a href="#l5.111"></a><span id="l5.111">         encode_p = PR_FALSE;</span>
<a href="#l5.112"></a><span id="l5.112"> </span>
<a href="#l5.113"></a><span id="l5.113">         /* MIME requires a special case that these types never be encoded.</span>
<a href="#l5.114"></a><span id="l5.114">       */</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineminus">-      if (!PL_strncasecmp (m_type, &quot;message&quot;, 7) ||</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineminus">-        !PL_strncasecmp (m_type, &quot;multipart&quot;, 9))</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineplus">+      if (StringBeginsWith(m_type, NS_LITERAL_CSTRING(&quot;message&quot;),</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineplus">+                           nsCaseInsensitiveCStringComparator()) ||</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineplus">+         StringBeginsWith(m_type, NS_LITERAL_CSTRING(&quot;multipart&quot;),</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineplus">+                          nsCaseInsensitiveCStringComparator()))</span>
<a href="#l5.121"></a><span id="l5.121">       {</span>
<a href="#l5.122"></a><span id="l5.122">         encode_p = PR_FALSE;</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineminus">-        if (m_desired_type &amp;&amp; !PL_strcasecmp (m_desired_type, TEXT_PLAIN))</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineminus">-        {</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineminus">-          PR_Free (m_desired_type);</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineminus">-          m_desired_type = 0;</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineminus">-        }</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineplus">+        if (m_desiredType.LowerCaseEqualsLiteral(TEXT_PLAIN))</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineplus">+          m_desiredType.Truncate();</span>
<a href="#l5.130"></a><span id="l5.130">       }</span>
<a href="#l5.131"></a><span id="l5.131"> </span>
<a href="#l5.132"></a><span id="l5.132">       // If the Mail charset is multibyte, we force it to use Base64 for attachments.</span>
<a href="#l5.133"></a><span id="l5.133">       if ((!mMainBody &amp;&amp; charset &amp;&amp; nsMsgI18Nmultibyte_charset(charset)) &amp;&amp;</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineminus">-        ((PL_strcasecmp(m_type, TEXT_HTML) == 0) ||</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineminus">-        (PL_strcasecmp(m_type, TEXT_MDL) == 0) ||</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineminus">-        (PL_strcasecmp(m_type, TEXT_PLAIN) == 0) ||</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineminus">-        (PL_strcasecmp(m_type, TEXT_RICHTEXT) == 0) ||</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineminus">-        (PL_strcasecmp(m_type, TEXT_ENRICHED) == 0) ||</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineminus">-        (PL_strcasecmp(m_type, TEXT_VCARD) == 0) ||</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineminus">-        (PL_strcasecmp(m_type, APPLICATION_DIRECTORY) == 0) || /* text/x-vcard synonym */</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineminus">-        (PL_strcasecmp(m_type, TEXT_CSS) == 0) ||</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineminus">-        (PL_strcasecmp(m_type, TEXT_JSSS) == 0)))</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineminus">-      {</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineplus">+          (m_type.LowerCaseEqualsLiteral(TEXT_HTML) ||</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineplus">+           m_type.LowerCaseEqualsLiteral(TEXT_MDL) ||</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineplus">+           m_type.LowerCaseEqualsLiteral(TEXT_PLAIN) ||</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineplus">+           m_type.LowerCaseEqualsLiteral(TEXT_RICHTEXT) ||</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineplus">+           m_type.LowerCaseEqualsLiteral(TEXT_ENRICHED) ||</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineplus">+           m_type.LowerCaseEqualsLiteral(TEXT_VCARD) ||</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineplus">+           m_type.LowerCaseEqualsLiteral(APPLICATION_DIRECTORY) || /* text/x-vcard synonym */</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineplus">+           m_type.LowerCaseEqualsLiteral(TEXT_CSS) ||</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineplus">+           m_type.LowerCaseEqualsLiteral(TEXT_JSSS)))</span>
<a href="#l5.153"></a><span id="l5.153">         needsB64 = PR_TRUE;</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineminus">-      }</span>
<a href="#l5.155"></a><span id="l5.155">       else if (charset &amp;&amp; nsMsgI18Nstateful_charset(charset))</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineminus">-      {</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineminus">-        PR_Free(m_encoding);</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineminus">-        m_encoding = PL_strdup (ENCODING_7BIT);</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineminus">-      }</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineplus">+        m_encoding = ENCODING_7BIT;</span>
<a href="#l5.161"></a><span id="l5.161">       else if (encode_p &amp;&amp;</span>
<a href="#l5.162"></a><span id="l5.162">         m_unprintable_count &gt; (m_size / 10))</span>
<a href="#l5.163"></a><span id="l5.163">         /* If the document contains more than 10% unprintable characters,</span>
<a href="#l5.164"></a><span id="l5.164">         then that seems like a good candidate for base64 instead of</span>
<a href="#l5.165"></a><span id="l5.165">         quoted-printable.</span>
<a href="#l5.166"></a><span id="l5.166">         */</span>
<a href="#l5.167"></a><span id="l5.167">         needsB64 = PR_TRUE;</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineminus">-      else if (encode_p) {</span>
<a href="#l5.169"></a><span id="l5.169" class="difflineminus">-        PR_Free(m_encoding);</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineminus">-        m_encoding = PL_strdup (ENCODING_QUOTED_PRINTABLE);</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineminus">-      }</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineminus">-      else if (m_highbit_count &gt; 0) {</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineminus">-        PR_Free(m_encoding);</span>
<a href="#l5.174"></a><span id="l5.174" class="difflineminus">-        m_encoding = PL_strdup (ENCODING_8BIT);</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineminus">-      }</span>
<a href="#l5.176"></a><span id="l5.176" class="difflineminus">-      else {</span>
<a href="#l5.177"></a><span id="l5.177" class="difflineminus">-        PR_Free(m_encoding);</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineminus">-        m_encoding = PL_strdup (ENCODING_7BIT);</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineminus">-      }</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineplus">+      else if (encode_p)</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineplus">+        m_encoding = ENCODING_QUOTED_PRINTABLE;</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineplus">+      else if (m_highbit_count &gt; 0)</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineplus">+        m_encoding = ENCODING_8BIT;</span>
<a href="#l5.184"></a><span id="l5.184" class="difflineplus">+      else</span>
<a href="#l5.185"></a><span id="l5.185" class="difflineplus">+        m_encoding = ENCODING_7BIT;</span>
<a href="#l5.186"></a><span id="l5.186">   }</span>
<a href="#l5.187"></a><span id="l5.187"> </span>
<a href="#l5.188"></a><span id="l5.188" class="difflineplus">+  // always base64 binary data.</span>
<a href="#l5.189"></a><span id="l5.189">   if (needsB64)</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineminus">-  {</span>
<a href="#l5.191"></a><span id="l5.191" class="difflineminus">-    //</span>
<a href="#l5.192"></a><span id="l5.192" class="difflineminus">-    // always base64 binary data.</span>
<a href="#l5.193"></a><span id="l5.193" class="difflineminus">-    //</span>
<a href="#l5.194"></a><span id="l5.194" class="difflineminus">-    PR_Free(m_encoding);</span>
<a href="#l5.195"></a><span id="l5.195" class="difflineminus">-    m_encoding = PL_strdup (ENCODING_BASE64);</span>
<a href="#l5.196"></a><span id="l5.196" class="difflineminus">-  }</span>
<a href="#l5.197"></a><span id="l5.197" class="difflineplus">+    m_encoding = ENCODING_BASE64;</span>
<a href="#l5.198"></a><span id="l5.198"> </span>
<a href="#l5.199"></a><span id="l5.199">   /* Now that we've picked an encoding, initialize the filter.</span>
<a href="#l5.200"></a><span id="l5.200">   */</span>
<a href="#l5.201"></a><span id="l5.201">   NS_ASSERTION(!m_encoder_data, &quot;not-null m_encoder_data&quot;);</span>
<a href="#l5.202"></a><span id="l5.202" class="difflineminus">-  if (!PL_strcasecmp(m_encoding, ENCODING_BASE64))</span>
<a href="#l5.203"></a><span id="l5.203" class="difflineplus">+  if (m_encoding.LowerCaseEqualsLiteral(ENCODING_BASE64))</span>
<a href="#l5.204"></a><span id="l5.204">   {</span>
<a href="#l5.205"></a><span id="l5.205">     m_encoder_data = MIME_B64EncoderInit(mime_encoder_output_fn,</span>
<a href="#l5.206"></a><span id="l5.206">       mime_delivery_state);</span>
<a href="#l5.207"></a><span id="l5.207">     if (!m_encoder_data) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l5.208"></a><span id="l5.208">   }</span>
<a href="#l5.209"></a><span id="l5.209" class="difflineminus">-  else if (!PL_strcasecmp(m_encoding, ENCODING_QUOTED_PRINTABLE))</span>
<a href="#l5.210"></a><span id="l5.210" class="difflineplus">+  else if (m_encoding.LowerCaseEqualsLiteral(ENCODING_QUOTED_PRINTABLE))</span>
<a href="#l5.211"></a><span id="l5.211">   {</span>
<a href="#l5.212"></a><span id="l5.212">     m_encoder_data = MIME_QPEncoderInit(mime_encoder_output_fn,</span>
<a href="#l5.213"></a><span id="l5.213">       mime_delivery_state);</span>
<a href="#l5.214"></a><span id="l5.214">     if (!m_encoder_data) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l5.215"></a><span id="l5.215">   }</span>
<a href="#l5.216"></a><span id="l5.216">   else</span>
<a href="#l5.217"></a><span id="l5.217">   {</span>
<a href="#l5.218"></a><span id="l5.218">     m_encoder_data = 0;</span>
<a href="#l5.219"></a><span id="l5.219" class="difflineat">@@ -480,59 +434,57 @@ nsMsgAttachmentHandler::PickEncoding(con</span>
<a href="#l5.220"></a><span id="l5.220">         bad charset things happen as well.</span>
<a href="#l5.221"></a><span id="l5.221"> </span>
<a href="#l5.222"></a><span id="l5.222">           So, the heuristic we use is, if the type is unknown, then the type is</span>
<a href="#l5.223"></a><span id="l5.223">           set to application/octet-stream for data which needs base64 (binary data)</span>
<a href="#l5.224"></a><span id="l5.224">           and is set to text/plain for data which didn't need base64 (unencoded or</span>
<a href="#l5.225"></a><span id="l5.225">           lightly encoded data.)</span>
<a href="#l5.226"></a><span id="l5.226">   */</span>
<a href="#l5.227"></a><span id="l5.227"> DONE:</span>
<a href="#l5.228"></a><span id="l5.228" class="difflineminus">-  if (!m_type || !*m_type || !PL_strcasecmp(m_type, UNKNOWN_CONTENT_TYPE))</span>
<a href="#l5.229"></a><span id="l5.229" class="difflineplus">+  if (m_type.IsEmpty() || m_type.LowerCaseEqualsLiteral(UNKNOWN_CONTENT_TYPE))</span>
<a href="#l5.230"></a><span id="l5.230">   {</span>
<a href="#l5.231"></a><span id="l5.231" class="difflineminus">-    PR_Free(m_type);</span>
<a href="#l5.232"></a><span id="l5.232">     if (m_already_encoded_p)</span>
<a href="#l5.233"></a><span id="l5.233" class="difflineminus">-      m_type = PL_strdup (APPLICATION_OCTET_STREAM);</span>
<a href="#l5.234"></a><span id="l5.234" class="difflineminus">-    else if (m_encoding &amp;&amp;</span>
<a href="#l5.235"></a><span id="l5.235" class="difflineminus">-         (!PL_strcasecmp(m_encoding, ENCODING_BASE64) ||</span>
<a href="#l5.236"></a><span id="l5.236" class="difflineminus">-         !PL_strcasecmp(m_encoding, ENCODING_UUENCODE)))</span>
<a href="#l5.237"></a><span id="l5.237" class="difflineminus">-         m_type = PL_strdup (APPLICATION_OCTET_STREAM);</span>
<a href="#l5.238"></a><span id="l5.238" class="difflineplus">+      m_type = APPLICATION_OCTET_STREAM;</span>
<a href="#l5.239"></a><span id="l5.239" class="difflineplus">+    else if (m_encoding.LowerCaseEqualsLiteral(ENCODING_BASE64) ||</span>
<a href="#l5.240"></a><span id="l5.240" class="difflineplus">+             m_encoding.LowerCaseEqualsLiteral(ENCODING_UUENCODE))</span>
<a href="#l5.241"></a><span id="l5.241" class="difflineplus">+      m_type = APPLICATION_OCTET_STREAM;</span>
<a href="#l5.242"></a><span id="l5.242">     else</span>
<a href="#l5.243"></a><span id="l5.243" class="difflineminus">-      m_type = PL_strdup (TEXT_PLAIN);</span>
<a href="#l5.244"></a><span id="l5.244" class="difflineplus">+      m_type = TEXT_PLAIN;</span>
<a href="#l5.245"></a><span id="l5.245">   }</span>
<a href="#l5.246"></a><span id="l5.246">   return 0;</span>
<a href="#l5.247"></a><span id="l5.247"> }</span>
<a href="#l5.248"></a><span id="l5.248"> </span>
<a href="#l5.249"></a><span id="l5.249"> class CharsetDetectionObserver : public nsICharsetDetectionObserver</span>
<a href="#l5.250"></a><span id="l5.250"> {</span>
<a href="#l5.251"></a><span id="l5.251"> public:</span>
<a href="#l5.252"></a><span id="l5.252">   NS_DECL_ISUPPORTS</span>
<a href="#l5.253"></a><span id="l5.253">   CharsetDetectionObserver(nsMsgAttachmentHandler* aAttachment)</span>
<a href="#l5.254"></a><span id="l5.254">   {</span>
<a href="#l5.255"></a><span id="l5.255">     m_attachment = aAttachment;</span>
<a href="#l5.256"></a><span id="l5.256">   };</span>
<a href="#l5.257"></a><span id="l5.257"> </span>
<a href="#l5.258"></a><span id="l5.258">   virtual ~CharsetDetectionObserver() {};</span>
<a href="#l5.259"></a><span id="l5.259">   NS_IMETHOD Notify(const char* aCharset, nsDetectionConfident aConf)</span>
<a href="#l5.260"></a><span id="l5.260">   {</span>
<a href="#l5.261"></a><span id="l5.261" class="difflineminus">-    m_attachment-&gt;m_charset = PL_strdup(aCharset);</span>
<a href="#l5.262"></a><span id="l5.262" class="difflineplus">+    m_attachment-&gt;m_charset = aCharset;</span>
<a href="#l5.263"></a><span id="l5.263">     return NS_OK;</span>
<a href="#l5.264"></a><span id="l5.264">   };</span>
<a href="#l5.265"></a><span id="l5.265"> </span>
<a href="#l5.266"></a><span id="l5.266"> private:</span>
<a href="#l5.267"></a><span id="l5.267">   nsMsgAttachmentHandler* m_attachment;</span>
<a href="#l5.268"></a><span id="l5.268"> };</span>
<a href="#l5.269"></a><span id="l5.269"> </span>
<a href="#l5.270"></a><span id="l5.270"> NS_IMPL_ISUPPORTS1(CharsetDetectionObserver, nsICharsetDetectionObserver)</span>
<a href="#l5.271"></a><span id="l5.271"> </span>
<a href="#l5.272"></a><span id="l5.272"> nsresult</span>
<a href="#l5.273"></a><span id="l5.273"> nsMsgAttachmentHandler::PickCharset()</span>
<a href="#l5.274"></a><span id="l5.274"> {</span>
<a href="#l5.275"></a><span id="l5.275"> </span>
<a href="#l5.276"></a><span id="l5.276" class="difflineminus">-  if (m_charset || strcmp(m_type, TEXT_PLAIN))</span>
<a href="#l5.277"></a><span id="l5.277" class="difflineminus">-    return NS_OK;;</span>
<a href="#l5.278"></a><span id="l5.278" class="difflineplus">+  if (!m_charset.IsEmpty() || !m_type.LowerCaseEqualsLiteral(TEXT_PLAIN))</span>
<a href="#l5.279"></a><span id="l5.279" class="difflineplus">+    return NS_OK;</span>
<a href="#l5.280"></a><span id="l5.280"> </span>
<a href="#l5.281"></a><span id="l5.281">   nsCOMPtr&lt;nsILocalFile&gt; tmpFile =</span>
<a href="#l5.282"></a><span id="l5.282">     do_QueryInterface(mTmpFile);</span>
<a href="#l5.283"></a><span id="l5.283">   if (!tmpFile)</span>
<a href="#l5.284"></a><span id="l5.284">     return NS_OK;</span>
<a href="#l5.285"></a><span id="l5.285">   </span>
<a href="#l5.286"></a><span id="l5.286">   nsCOMPtr&lt;nsICharsetDetector&gt; detector =</span>
<a href="#l5.287"></a><span id="l5.287">     do_CreateInstance(NS_CHARSET_DETECTOR_CONTRACTID_BASE</span>
<a href="#l5.288"></a><span id="l5.288" class="difflineat">@@ -611,54 +563,46 @@ FetcherURLDoneCallback(nsresult aStatus,</span>
<a href="#l5.289"></a><span id="l5.289">     ma-&gt;m_size = totalSize;</span>
<a href="#l5.290"></a><span id="l5.290">     if (!aContentType.IsEmpty())</span>
<a href="#l5.291"></a><span id="l5.291">     {</span>
<a href="#l5.292"></a><span id="l5.292"> #ifdef XP_MACOSX</span>
<a href="#l5.293"></a><span id="l5.293">       //Do not change the type if we are dealing with an encoded (e.g., appledouble or zip) file</span>
<a href="#l5.294"></a><span id="l5.294">       if (!ma-&gt;mEncodedWorkingFile)</span>
<a href="#l5.295"></a><span id="l5.295"> #else</span>
<a href="#l5.296"></a><span id="l5.296">         // can't send appledouble on non-macs</span>
<a href="#l5.297"></a><span id="l5.297" class="difflineminus">-        if (!aContentType.EqualsLiteral(&quot;multipart/appledouble&quot;))</span>
<a href="#l5.298"></a><span id="l5.298" class="difflineplus">+      if (!aContentType.EqualsLiteral(&quot;multipart/appledouble&quot;))</span>
<a href="#l5.299"></a><span id="l5.299"> #endif</span>
<a href="#l5.300"></a><span id="l5.300" class="difflineminus">-      {</span>
<a href="#l5.301"></a><span id="l5.301" class="difflineminus">-        PR_Free(ma-&gt;m_type);</span>
<a href="#l5.302"></a><span id="l5.302" class="difflineminus">-        ma-&gt;m_type = ToNewCString(aContentType);</span>
<a href="#l5.303"></a><span id="l5.303" class="difflineminus">-      }</span>
<a href="#l5.304"></a><span id="l5.304" class="difflineplus">+        ma-&gt;m_type = aContentType;</span>
<a href="#l5.305"></a><span id="l5.305">     }</span>
<a href="#l5.306"></a><span id="l5.306"> </span>
<a href="#l5.307"></a><span id="l5.307">     if (!aCharset.IsEmpty())</span>
<a href="#l5.308"></a><span id="l5.308" class="difflineminus">-    {</span>
<a href="#l5.309"></a><span id="l5.309" class="difflineminus">-      PR_Free(ma-&gt;m_charset);</span>
<a href="#l5.310"></a><span id="l5.310" class="difflineminus">-      ma-&gt;m_charset = ToNewCString(aCharset);</span>
<a href="#l5.311"></a><span id="l5.311" class="difflineminus">-    }</span>
<a href="#l5.312"></a><span id="l5.312" class="difflineplus">+      ma-&gt;m_charset = aCharset;</span>
<a href="#l5.313"></a><span id="l5.313"> </span>
<a href="#l5.314"></a><span id="l5.314">     return ma-&gt;UrlExit(aStatus, aMsg);</span>
<a href="#l5.315"></a><span id="l5.315">   }</span>
<a href="#l5.316"></a><span id="l5.316">   else</span>
<a href="#l5.317"></a><span id="l5.317">     return NS_OK;</span>
<a href="#l5.318"></a><span id="l5.318"> }</span>
<a href="#l5.319"></a><span id="l5.319"> </span>
<a href="#l5.320"></a><span id="l5.320"> nsresult</span>
<a href="#l5.321"></a><span id="l5.321"> nsMsgAttachmentHandler::SnarfMsgAttachment(nsMsgCompFields *compFields)</span>
<a href="#l5.322"></a><span id="l5.322"> {</span>
<a href="#l5.323"></a><span id="l5.323">   nsresult rv = NS_ERROR_INVALID_ARG;</span>
<a href="#l5.324"></a><span id="l5.324">   nsCOMPtr &lt;nsIMsgMessageService&gt; messageService;</span>
<a href="#l5.325"></a><span id="l5.325"> </span>
<a href="#l5.326"></a><span id="l5.326" class="difflineminus">-  if (PL_strcasestr(m_uri, &quot;-message:&quot;))</span>
<a href="#l5.327"></a><span id="l5.327" class="difflineplus">+  if (m_uri.Find(&quot;-message:&quot;, CaseInsensitiveCompare) != -1)</span>
<a href="#l5.328"></a><span id="l5.328">   {</span>
<a href="#l5.329"></a><span id="l5.329">     nsCOMPtr &lt;nsIFile&gt; tmpFile;</span>
<a href="#l5.330"></a><span id="l5.330">     rv = nsMsgCreateTempFile(&quot;nsmail.tmp&quot;, getter_AddRefs(tmpFile));</span>
<a href="#l5.331"></a><span id="l5.331">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.332"></a><span id="l5.332">     mTmpFile = do_QueryInterface(tmpFile);</span>
<a href="#l5.333"></a><span id="l5.333">     mDeleteFile = PR_TRUE;</span>
<a href="#l5.334"></a><span id="l5.334">     mCompFields = compFields;</span>
<a href="#l5.335"></a><span id="l5.335" class="difflineminus">-    PR_Free(m_type);</span>
<a href="#l5.336"></a><span id="l5.336" class="difflineminus">-    m_type = PL_strdup(MESSAGE_RFC822);</span>
<a href="#l5.337"></a><span id="l5.337" class="difflineminus">-    PR_Free(m_override_type);</span>
<a href="#l5.338"></a><span id="l5.338" class="difflineminus">-    m_override_type = PL_strdup(MESSAGE_RFC822);</span>
<a href="#l5.339"></a><span id="l5.339" class="difflineplus">+    m_type = MESSAGE_RFC822;</span>
<a href="#l5.340"></a><span id="l5.340" class="difflineplus">+    m_overrideType = MESSAGE_RFC822;</span>
<a href="#l5.341"></a><span id="l5.341">     if (!mTmpFile)</span>
<a href="#l5.342"></a><span id="l5.342">     {</span>
<a href="#l5.343"></a><span id="l5.343">       rv = NS_ERROR_FAILURE;</span>
<a href="#l5.344"></a><span id="l5.344">       goto done;</span>
<a href="#l5.345"></a><span id="l5.345">     }</span>
<a href="#l5.346"></a><span id="l5.346"> </span>
<a href="#l5.347"></a><span id="l5.347">     rv = MsgNewBufferedFileOutputStream(getter_AddRefs(mOutFile), mTmpFile, -1, 00600);</span>
<a href="#l5.348"></a><span id="l5.348">     if (NS_FAILED(rv) || !mOutFile)</span>
<a href="#l5.349"></a><span id="l5.349" class="difflineat">@@ -682,17 +626,17 @@ nsMsgAttachmentHandler::SnarfMsgAttachme</span>
<a href="#l5.350"></a><span id="l5.350">     if (NS_FAILED(rv) || !fetcher)</span>
<a href="#l5.351"></a><span id="l5.351">     {</span>
<a href="#l5.352"></a><span id="l5.352">       if (NS_SUCCEEDED(rv))</span>
<a href="#l5.353"></a><span id="l5.353">         rv =  NS_ERROR_UNEXPECTED;</span>
<a href="#l5.354"></a><span id="l5.354">       goto done;</span>
<a href="#l5.355"></a><span id="l5.355">     }</span>
<a href="#l5.356"></a><span id="l5.356"> </span>
<a href="#l5.357"></a><span id="l5.357">     rv = fetcher-&gt;Initialize(mTmpFile, mOutFile, FetcherURLDoneCallback, this);</span>
<a href="#l5.358"></a><span id="l5.358" class="difflineminus">-    rv = GetMessageServiceFromURI(nsDependentCString(m_uri), getter_AddRefs(messageService));</span>
<a href="#l5.359"></a><span id="l5.359" class="difflineplus">+    rv = GetMessageServiceFromURI(m_uri, getter_AddRefs(messageService));</span>
<a href="#l5.360"></a><span id="l5.360">     if (NS_SUCCEEDED(rv) &amp;&amp; messageService)</span>
<a href="#l5.361"></a><span id="l5.361">     {</span>
<a href="#l5.362"></a><span id="l5.362">       nsCAutoString uri(m_uri);</span>
<a href="#l5.363"></a><span id="l5.363">       uri += (uri.FindChar('?') == kNotFound) ? '?' : '&amp;';</span>
<a href="#l5.364"></a><span id="l5.364">       uri.Append(&quot;fetchCompleteMessage=true&quot;);</span>
<a href="#l5.365"></a><span id="l5.365">       nsCOMPtr&lt;nsIStreamListener&gt; strListener;</span>
<a href="#l5.366"></a><span id="l5.366">       fetcher-&gt;QueryInterface(NS_GET_IID(nsIStreamListener), getter_AddRefs(strListener));</span>
<a href="#l5.367"></a><span id="l5.367"> </span>
<a href="#l5.368"></a><span id="l5.368" class="difflineat">@@ -860,30 +804,28 @@ nsMsgAttachmentHandler::ConvertToZipFile</span>
<a href="#l5.369"></a><span id="l5.369">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.370"></a><span id="l5.370">   zippedName.AppendLiteral(&quot;.zip&quot;);</span>
<a href="#l5.371"></a><span id="l5.371"> </span>
<a href="#l5.372"></a><span id="l5.372">   // create a temporary file that we'll work on</span>
<a href="#l5.373"></a><span id="l5.373">   nsCOMPtr &lt;nsIFile&gt; tmpFile;</span>
<a href="#l5.374"></a><span id="l5.374">   rv = nsMsgCreateTempFile(zippedName.get(), getter_AddRefs(tmpFile));</span>
<a href="#l5.375"></a><span id="l5.375">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.376"></a><span id="l5.376">   mEncodedWorkingFile = do_QueryInterface(tmpFile);</span>
<a href="#l5.377"></a><span id="l5.377" class="difflineminus">-  </span>
<a href="#l5.378"></a><span id="l5.378" class="difflineplus">+</span>
<a href="#l5.379"></a><span id="l5.379">   // point our URL at the zipped temp file</span>
<a href="#l5.380"></a><span id="l5.380">   NS_NewFileURI(getter_AddRefs(mURL), mEncodedWorkingFile);</span>
<a href="#l5.381"></a><span id="l5.381" class="difflineminus">-  </span>
<a href="#l5.382"></a><span id="l5.382" class="difflineplus">+</span>
<a href="#l5.383"></a><span id="l5.383">   // zip it!</span>
<a href="#l5.384"></a><span id="l5.384">   rv = nsSimpleZipper::Zip(aSourceFile, mEncodedWorkingFile);</span>
<a href="#l5.385"></a><span id="l5.385">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.386"></a><span id="l5.386" class="difflineminus">-  </span>
<a href="#l5.387"></a><span id="l5.387" class="difflineplus">+</span>
<a href="#l5.388"></a><span id="l5.388">   // set some metadata for this attachment, that will affect the MIME headers.</span>
<a href="#l5.389"></a><span id="l5.389" class="difflineminus">-  PR_Free(m_type);</span>
<a href="#l5.390"></a><span id="l5.390" class="difflineminus">-  m_type = PL_strdup(APPLICATION_ZIP);</span>
<a href="#l5.391"></a><span id="l5.391" class="difflineminus">-  PR_Free(m_real_name);</span>
<a href="#l5.392"></a><span id="l5.392" class="difflineminus">-  m_real_name = PL_strdup(zippedName.get());</span>
<a href="#l5.393"></a><span id="l5.393" class="difflineminus">-  </span>
<a href="#l5.394"></a><span id="l5.394" class="difflineplus">+  m_type = APPLICATION_ZIP;</span>
<a href="#l5.395"></a><span id="l5.395" class="difflineplus">+  m_real_name = zippedName.get();</span>
<a href="#l5.396"></a><span id="l5.396" class="difflineplus">+</span>
<a href="#l5.397"></a><span id="l5.397">   return NS_OK;</span>
<a href="#l5.398"></a><span id="l5.398"> }</span>
<a href="#l5.399"></a><span id="l5.399"> </span>
<a href="#l5.400"></a><span id="l5.400"> nsresult</span>
<a href="#l5.401"></a><span id="l5.401"> nsMsgAttachmentHandler::ConvertToAppleEncoding(const nsCString &amp;aFileURI, </span>
<a href="#l5.402"></a><span id="l5.402">                                                const nsCString &amp;aFilePath, </span>
<a href="#l5.403"></a><span id="l5.403">                                                nsILocalFileMac *aSourceFile)</span>
<a href="#l5.404"></a><span id="l5.404"> {</span>
<a href="#l5.405"></a><span id="l5.405" class="difflineat">@@ -894,25 +836,23 @@ nsMsgAttachmentHandler::ConvertToAppleEn</span>
<a href="#l5.406"></a><span id="l5.406"> </span>
<a href="#l5.407"></a><span id="l5.407">   char fileInfo[32];</span>
<a href="#l5.408"></a><span id="l5.408">   OSType type, creator;</span>
<a href="#l5.409"></a><span id="l5.409"> </span>
<a href="#l5.410"></a><span id="l5.410">   nsresult rv = aSourceFile-&gt;GetFileType(&amp;type);</span>
<a href="#l5.411"></a><span id="l5.411">   if (NS_FAILED(rv))</span>
<a href="#l5.412"></a><span id="l5.412">     return PR_FALSE;</span>
<a href="#l5.413"></a><span id="l5.413">   PR_snprintf(fileInfo, sizeof(fileInfo), &quot;%X&quot;, type);</span>
<a href="#l5.414"></a><span id="l5.414" class="difflineminus">-  PR_Free(m_x_mac_type);</span>
<a href="#l5.415"></a><span id="l5.415" class="difflineminus">-  m_x_mac_type = PL_strdup(fileInfo);</span>
<a href="#l5.416"></a><span id="l5.416" class="difflineplus">+  m_xMacType = fileInfo;</span>
<a href="#l5.417"></a><span id="l5.417"> </span>
<a href="#l5.418"></a><span id="l5.418">   rv = aSourceFile-&gt;GetFileCreator(&amp;creator);</span>
<a href="#l5.419"></a><span id="l5.419">   if (NS_FAILED(rv))</span>
<a href="#l5.420"></a><span id="l5.420">     return PR_FALSE;</span>
<a href="#l5.421"></a><span id="l5.421">   PR_snprintf(fileInfo, sizeof(fileInfo), &quot;%X&quot;, creator);</span>
<a href="#l5.422"></a><span id="l5.422" class="difflineminus">-  PR_Free(m_x_mac_creator);</span>
<a href="#l5.423"></a><span id="l5.423" class="difflineminus">-  m_x_mac_creator = PL_strdup(fileInfo);</span>
<a href="#l5.424"></a><span id="l5.424" class="difflineplus">+  m_xMacCreator = fileInfo;</span>
<a href="#l5.425"></a><span id="l5.425"> </span>
<a href="#l5.426"></a><span id="l5.426">   FSRef fsRef;</span>
<a href="#l5.427"></a><span id="l5.427">   aSourceFile-&gt;GetFSRef(&amp;fsRef);</span>
<a href="#l5.428"></a><span id="l5.428">   PRBool sendResourceFork = HasResourceFork(&amp;fsRef);</span>
<a href="#l5.429"></a><span id="l5.429"> </span>
<a href="#l5.430"></a><span id="l5.430">   // if we have a resource fork, check the filename extension, maybe we don't need the resource fork!</span>
<a href="#l5.431"></a><span id="l5.431">   if (sendResourceFork)</span>
<a href="#l5.432"></a><span id="l5.432">   {</span>
<a href="#l5.433"></a><span id="l5.433" class="difflineat">@@ -1057,39 +997,37 @@ nsMsgAttachmentHandler::ConvertToAppleEn</span>
<a href="#l5.434"></a><span id="l5.434">       PR_FREEIF(separator);</span>
<a href="#l5.435"></a><span id="l5.435">       return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l5.436"></a><span id="l5.436">     }</span>
<a href="#l5.437"></a><span id="l5.437"> </span>
<a href="#l5.438"></a><span id="l5.438">     // Now after conversion, also patch the types.</span>
<a href="#l5.439"></a><span id="l5.439">     char        tmp[128];</span>
<a href="#l5.440"></a><span id="l5.440">     PR_snprintf(tmp, sizeof(tmp), MULTIPART_APPLEDOUBLE &quot;;\r\n boundary=\&quot;%s\&quot;&quot;, separator);</span>
<a href="#l5.441"></a><span id="l5.441">     PR_FREEIF(separator);</span>
<a href="#l5.442"></a><span id="l5.442" class="difflineminus">-    PR_Free(m_type);</span>
<a href="#l5.443"></a><span id="l5.443" class="difflineminus">-    m_type = PL_strdup(tmp);</span>
<a href="#l5.444"></a><span id="l5.444" class="difflineplus">+    m_type = tmp;</span>
<a href="#l5.445"></a><span id="l5.445">   }</span>
<a href="#l5.446"></a><span id="l5.446">   else</span>
<a href="#l5.447"></a><span id="l5.447">   {</span>
<a href="#l5.448"></a><span id="l5.448">     if ( sendResourceFork )</span>
<a href="#l5.449"></a><span id="l5.449">     {</span>
<a href="#l5.450"></a><span id="l5.450">       // For now, just do the encoding, but in the old world we would ask the</span>
<a href="#l5.451"></a><span id="l5.451">       // user about doing this conversion</span>
<a href="#l5.452"></a><span id="l5.452">       printf(&quot;...we could ask the user about this conversion, but for now, nahh..\n&quot;);</span>
<a href="#l5.453"></a><span id="l5.453">     }</span>
<a href="#l5.454"></a><span id="l5.454"> </span>
<a href="#l5.455"></a><span id="l5.455">     PRBool    useDefault;</span>
<a href="#l5.456"></a><span id="l5.456">     char      *macType, *macEncoding;</span>
<a href="#l5.457"></a><span id="l5.457" class="difflineminus">-    if (m_type == NULL || !PL_strcasecmp (m_type, TEXT_PLAIN))</span>
<a href="#l5.458"></a><span id="l5.458" class="difflineplus">+    if (m_type.IsEmpty() || m_type.LowerCaseEqualsLiteral(TEXT_PLAIN))</span>
<a href="#l5.459"></a><span id="l5.459">     {</span>
<a href="#l5.460"></a><span id="l5.460"> # define TEXT_TYPE  0x54455854  /* the characters 'T' 'E' 'X' 'T' */</span>
<a href="#l5.461"></a><span id="l5.461"> # define text_TYPE  0x74657874  /* the characters 't' 'e' 'x' 't' */</span>
<a href="#l5.462"></a><span id="l5.462"> </span>
<a href="#l5.463"></a><span id="l5.463">       if (type != TEXT_TYPE &amp;&amp; type != text_TYPE)</span>
<a href="#l5.464"></a><span id="l5.464">       {</span>
<a href="#l5.465"></a><span id="l5.465">         MacGetFileType(aSourceFile, &amp;useDefault, &amp;macType, &amp;macEncoding);</span>
<a href="#l5.466"></a><span id="l5.466" class="difflineminus">-        PR_Free(m_type);</span>
<a href="#l5.467"></a><span id="l5.467">         m_type = macType;</span>
<a href="#l5.468"></a><span id="l5.468">       }</span>
<a href="#l5.469"></a><span id="l5.469">     }</span>
<a href="#l5.470"></a><span id="l5.470">     // don't bother to set the types if we failed in getting the file info.</span>
<a href="#l5.471"></a><span id="l5.471">   }</span>
<a href="#l5.472"></a><span id="l5.472"> </span>
<a href="#l5.473"></a><span id="l5.473">   return NS_OK;</span>
<a href="#l5.474"></a><span id="l5.474"> }</span>
<a href="#l5.475"></a><span id="l5.475" class="difflineat">@@ -1117,17 +1055,17 @@ nsMsgAttachmentHandler::LoadDataFromFile</span>
<a href="#l5.476"></a><span id="l5.476"> </span>
<a href="#l5.477"></a><span id="l5.477">   PRUint32 bytesRead;</span>
<a href="#l5.478"></a><span id="l5.478">   inputFile-&gt;Read(readBuf, readSize, &amp;bytesRead);</span>
<a href="#l5.479"></a><span id="l5.479">   inputFile-&gt;Close();</span>
<a href="#l5.480"></a><span id="l5.480"> </span>
<a href="#l5.481"></a><span id="l5.481">   nsDependentCString cstringReadBuf(readBuf, bytesRead);</span>
<a href="#l5.482"></a><span id="l5.482">   if (charsetConversion)</span>
<a href="#l5.483"></a><span id="l5.483">   {</span>
<a href="#l5.484"></a><span id="l5.484" class="difflineminus">-    if (NS_FAILED(ConvertToUnicode(m_charset, cstringReadBuf, sigData)))</span>
<a href="#l5.485"></a><span id="l5.485" class="difflineplus">+    if (NS_FAILED(ConvertToUnicode(m_charset.get(), cstringReadBuf, sigData)))</span>
<a href="#l5.486"></a><span id="l5.486">       CopyASCIItoUTF16(cstringReadBuf, sigData);</span>
<a href="#l5.487"></a><span id="l5.487">   }</span>
<a href="#l5.488"></a><span id="l5.488">   else</span>
<a href="#l5.489"></a><span id="l5.489">     CopyASCIItoUTF16(cstringReadBuf, sigData);</span>
<a href="#l5.490"></a><span id="l5.490"> </span>
<a href="#l5.491"></a><span id="l5.491">   PR_FREEIF(readBuf);</span>
<a href="#l5.492"></a><span id="l5.492">   return NS_OK;</span>
<a href="#l5.493"></a><span id="l5.493"> }</span>
<a href="#l5.494"></a><span id="l5.494" class="difflineat">@@ -1177,29 +1115,19 @@ nsMsgAttachmentHandler::UrlExit(nsresult</span>
<a href="#l5.495"></a><span id="l5.495">   mRequest = nsnull;</span>
<a href="#l5.496"></a><span id="l5.496"> </span>
<a href="#l5.497"></a><span id="l5.497">   // First things first, we are now going to see if this is an HTML</span>
<a href="#l5.498"></a><span id="l5.498">   // Doc and if it is, we need to see if we can determine the charset</span>
<a href="#l5.499"></a><span id="l5.499">   // for this part by sniffing the HTML file.</span>
<a href="#l5.500"></a><span id="l5.500">   // This is needed only when the charset is not set already.</span>
<a href="#l5.501"></a><span id="l5.501">   // (e.g. a charset may be specified in HTTP header)</span>
<a href="#l5.502"></a><span id="l5.502">   //</span>
<a href="#l5.503"></a><span id="l5.503" class="difflineminus">-  if ( (m_type) &amp;&amp;  (*m_type) &amp;&amp;</span>
<a href="#l5.504"></a><span id="l5.504" class="difflineminus">-       (!m_charset || !(*m_charset)) )</span>
<a href="#l5.505"></a><span id="l5.505" class="difflineminus">-  {</span>
<a href="#l5.506"></a><span id="l5.506" class="difflineminus">-    if (PL_strcasecmp(m_type, TEXT_HTML) == 0)</span>
<a href="#l5.507"></a><span id="l5.507" class="difflineminus">-    {</span>
<a href="#l5.508"></a><span id="l5.508" class="difflineminus">-      char *tmpCharset = (char *)nsMsgI18NParseMetaCharset(mTmpFile);</span>
<a href="#l5.509"></a><span id="l5.509" class="difflineminus">-      if (tmpCharset[0] != '\0')</span>
<a href="#l5.510"></a><span id="l5.510" class="difflineminus">-      {</span>
<a href="#l5.511"></a><span id="l5.511" class="difflineminus">-        PR_Free(m_charset);</span>
<a href="#l5.512"></a><span id="l5.512" class="difflineminus">-        m_charset = PL_strdup(tmpCharset);</span>
<a href="#l5.513"></a><span id="l5.513" class="difflineminus">-      }</span>
<a href="#l5.514"></a><span id="l5.514" class="difflineminus">-    }</span>
<a href="#l5.515"></a><span id="l5.515" class="difflineminus">-  }</span>
<a href="#l5.516"></a><span id="l5.516" class="difflineplus">+  if (!m_type.IsEmpty() &amp;&amp; m_charset.IsEmpty() &amp;&amp;</span>
<a href="#l5.517"></a><span id="l5.517" class="difflineplus">+      m_type.LowerCaseEqualsLiteral(TEXT_HTML))</span>
<a href="#l5.518"></a><span id="l5.518" class="difflineplus">+    m_charset = nsMsgI18NParseMetaCharset(mTmpFile);</span>
<a href="#l5.519"></a><span id="l5.519"> </span>
<a href="#l5.520"></a><span id="l5.520">   nsresult mimeDeliveryStatus;</span>
<a href="#l5.521"></a><span id="l5.521">   m_mime_delivery_state-&gt;GetStatus(&amp;mimeDeliveryStatus);</span>
<a href="#l5.522"></a><span id="l5.522"> </span>
<a href="#l5.523"></a><span id="l5.523">   if (mimeDeliveryStatus == NS_ERROR_ABORT)</span>
<a href="#l5.524"></a><span id="l5.524">     status = NS_ERROR_ABORT;</span>
<a href="#l5.525"></a><span id="l5.525"> </span>
<a href="#l5.526"></a><span id="l5.526">   if (NS_FAILED(status) &amp;&amp; status != NS_ERROR_ABORT &amp;&amp; NS_SUCCEEDED(mimeDeliveryStatus))</span>
<a href="#l5.527"></a><span id="l5.527" class="difflineat">@@ -1218,28 +1146,27 @@ nsMsgAttachmentHandler::UrlExit(nsresult</span>
<a href="#l5.528"></a><span id="l5.528">     rv = bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/messengercompose/composeMsgs.properties&quot;, getter_AddRefs(bundle));</span>
<a href="#l5.529"></a><span id="l5.529">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.530"></a><span id="l5.530">     nsMsgDeliverMode mode = nsIMsgSend::nsMsgDeliverNow;</span>
<a href="#l5.531"></a><span id="l5.531">     m_mime_delivery_state-&gt;GetDeliveryMode(&amp;mode);</span>
<a href="#l5.532"></a><span id="l5.532">     if (mode == nsIMsgSend::nsMsgSaveAsDraft || mode == nsIMsgSend::nsMsgSaveAsTemplate)</span>
<a href="#l5.533"></a><span id="l5.533">       bundle-&gt;GetStringFromID(NS_MSG_FAILURE_ON_OBJ_EMBED_WHILE_SAVING, getter_Copies(msg));</span>
<a href="#l5.534"></a><span id="l5.534">     else</span>
<a href="#l5.535"></a><span id="l5.535">       bundle-&gt;GetStringFromID(NS_MSG_FAILURE_ON_OBJ_EMBED_WHILE_SENDING, getter_Copies(msg));</span>
<a href="#l5.536"></a><span id="l5.536" class="difflineminus">-    if (m_real_name &amp;&amp; *m_real_name)</span>
<a href="#l5.537"></a><span id="l5.537" class="difflineminus">-      printfString = nsTextFormatter::smprintf(msg.get(), m_real_name);</span>
<a href="#l5.538"></a><span id="l5.538" class="difflineminus">-    else</span>
<a href="#l5.539"></a><span id="l5.539" class="difflineminus">-    if (NS_SUCCEEDED(mURL-&gt;GetSpec(turl)) &amp;&amp; !turl.IsEmpty())</span>
<a href="#l5.540"></a><span id="l5.540" class="difflineminus">-      {</span>
<a href="#l5.541"></a><span id="l5.541" class="difflineminus">-        nsCAutoString unescapedUrl;</span>
<a href="#l5.542"></a><span id="l5.542" class="difflineminus">-        MsgUnescapeString(turl, 0, unescapedUrl);</span>
<a href="#l5.543"></a><span id="l5.543" class="difflineminus">-        if (unescapedUrl.IsEmpty())</span>
<a href="#l5.544"></a><span id="l5.544" class="difflineminus">-          printfString = nsTextFormatter::smprintf(msg.get(), turl.get());</span>
<a href="#l5.545"></a><span id="l5.545" class="difflineminus">-        else</span>
<a href="#l5.546"></a><span id="l5.546" class="difflineminus">-          printfString = nsTextFormatter::smprintf(msg.get(), unescapedUrl.get());</span>
<a href="#l5.547"></a><span id="l5.547" class="difflineminus">-      }</span>
<a href="#l5.548"></a><span id="l5.548" class="difflineplus">+    if (!m_realName.IsEmpty())</span>
<a href="#l5.549"></a><span id="l5.549" class="difflineplus">+      printfString = nsTextFormatter::smprintf(msg.get(), m_realName.get());</span>
<a href="#l5.550"></a><span id="l5.550" class="difflineplus">+    else if (NS_SUCCEEDED(mURL-&gt;GetSpec(turl)) &amp;&amp; !turl.IsEmpty())</span>
<a href="#l5.551"></a><span id="l5.551" class="difflineplus">+    {</span>
<a href="#l5.552"></a><span id="l5.552" class="difflineplus">+      nsCAutoString unescapedUrl;</span>
<a href="#l5.553"></a><span id="l5.553" class="difflineplus">+      MsgUnescapeString(turl, 0, unescapedUrl);</span>
<a href="#l5.554"></a><span id="l5.554" class="difflineplus">+      if (unescapedUrl.IsEmpty())</span>
<a href="#l5.555"></a><span id="l5.555" class="difflineplus">+        printfString = nsTextFormatter::smprintf(msg.get(), turl.get());</span>
<a href="#l5.556"></a><span id="l5.556" class="difflineplus">+      else</span>
<a href="#l5.557"></a><span id="l5.557" class="difflineplus">+        printfString = nsTextFormatter::smprintf(msg.get(), unescapedUrl.get());</span>
<a href="#l5.558"></a><span id="l5.558" class="difflineplus">+    }</span>
<a href="#l5.559"></a><span id="l5.559">     else</span>
<a href="#l5.560"></a><span id="l5.560">       printfString = nsTextFormatter::smprintf(msg.get(), &quot;?&quot;);</span>
<a href="#l5.561"></a><span id="l5.561"> </span>
<a href="#l5.562"></a><span id="l5.562">     nsCOMPtr&lt;nsIPrompt&gt; aPrompt;</span>
<a href="#l5.563"></a><span id="l5.563">     if (m_mime_delivery_state)</span>
<a href="#l5.564"></a><span id="l5.564">       m_mime_delivery_state-&gt;GetDefaultPrompt(getter_AddRefs(aPrompt));</span>
<a href="#l5.565"></a><span id="l5.565">     nsMsgAskBooleanQuestionByString(aPrompt, printfString, &amp;keepOnGoing);</span>
<a href="#l5.566"></a><span id="l5.566">     PR_FREEIF(printfString);</span>
<a href="#l5.567"></a><span id="l5.567" class="difflineat">@@ -1263,82 +1190,78 @@ nsMsgAttachmentHandler::UrlExit(nsresult</span>
<a href="#l5.568"></a><span id="l5.568"> </span>
<a href="#l5.569"></a><span id="l5.569">   m_done = PR_TRUE;</span>
<a href="#l5.570"></a><span id="l5.570"> </span>
<a href="#l5.571"></a><span id="l5.571">   //</span>
<a href="#l5.572"></a><span id="l5.572">   // Ok, now that we have the file here on disk, we need to see if there was</span>
<a href="#l5.573"></a><span id="l5.573">   // a need to do conversion to plain text...if so, the magic happens here,</span>
<a href="#l5.574"></a><span id="l5.574">   // otherwise, just move on to other attachments...</span>
<a href="#l5.575"></a><span id="l5.575">   //</span>
<a href="#l5.576"></a><span id="l5.576" class="difflineminus">-  if (NS_SUCCEEDED(status) &amp;&amp; m_type &amp;&amp; PL_strcasecmp(m_type, TEXT_PLAIN) )</span>
<a href="#l5.577"></a><span id="l5.577" class="difflineplus">+  if (NS_SUCCEEDED(status) &amp;&amp; m_type.LowerCaseEqualsLiteral(TEXT_PLAIN) &amp;&amp;</span>
<a href="#l5.578"></a><span id="l5.578" class="difflineplus">+      m_desiredType.LowerCaseEqualsLiteral(TEXT_PLAIN))</span>
<a href="#l5.579"></a><span id="l5.579">   {</span>
<a href="#l5.580"></a><span id="l5.580" class="difflineminus">-    if (m_desired_type &amp;&amp; !PL_strcasecmp(m_desired_type, TEXT_PLAIN) )</span>
<a href="#l5.581"></a><span id="l5.581" class="difflineplus">+    //</span>
<a href="#l5.582"></a><span id="l5.582" class="difflineplus">+    // Conversion to plain text desired.</span>
<a href="#l5.583"></a><span id="l5.583" class="difflineplus">+    //</span>
<a href="#l5.584"></a><span id="l5.584" class="difflineplus">+    PRInt32       width = 72;</span>
<a href="#l5.585"></a><span id="l5.585" class="difflineplus">+    nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l5.586"></a><span id="l5.586" class="difflineplus">+    if (pPrefBranch)</span>
<a href="#l5.587"></a><span id="l5.587" class="difflineplus">+      pPrefBranch-&gt;GetIntPref(&quot;mailnews.wraplength&quot;, &amp;width);</span>
<a href="#l5.588"></a><span id="l5.588" class="difflineplus">+    // Let sanity reign!</span>
<a href="#l5.589"></a><span id="l5.589" class="difflineplus">+    if (width == 0)</span>
<a href="#l5.590"></a><span id="l5.590" class="difflineplus">+      width = 72;</span>
<a href="#l5.591"></a><span id="l5.591" class="difflineplus">+    else if (width &lt; 10)</span>
<a href="#l5.592"></a><span id="l5.592" class="difflineplus">+      width = 10;</span>
<a href="#l5.593"></a><span id="l5.593" class="difflineplus">+    else if (width &gt; 30000)</span>
<a href="#l5.594"></a><span id="l5.594" class="difflineplus">+      width = 30000;</span>
<a href="#l5.595"></a><span id="l5.595" class="difflineplus">+</span>
<a href="#l5.596"></a><span id="l5.596" class="difflineplus">+    //</span>
<a href="#l5.597"></a><span id="l5.597" class="difflineplus">+    // Now use the converter service here to do the right</span>
<a href="#l5.598"></a><span id="l5.598" class="difflineplus">+    // thing and convert this data to plain text for us!</span>
<a href="#l5.599"></a><span id="l5.599" class="difflineplus">+    //</span>
<a href="#l5.600"></a><span id="l5.600" class="difflineplus">+    nsAutoString      conData;</span>
<a href="#l5.601"></a><span id="l5.601" class="difflineplus">+</span>
<a href="#l5.602"></a><span id="l5.602" class="difflineplus">+    if (NS_SUCCEEDED(LoadDataFromFile(mTmpFile, conData, PR_TRUE)))</span>
<a href="#l5.603"></a><span id="l5.603">     {</span>
<a href="#l5.604"></a><span id="l5.604" class="difflineminus">-      //</span>
<a href="#l5.605"></a><span id="l5.605" class="difflineminus">-      // Conversion to plain text desired.</span>
<a href="#l5.606"></a><span id="l5.606" class="difflineminus">-      //</span>
<a href="#l5.607"></a><span id="l5.607" class="difflineminus">-      PRInt32       width = 72;</span>
<a href="#l5.608"></a><span id="l5.608" class="difflineminus">-      nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l5.609"></a><span id="l5.609" class="difflineminus">-      if (pPrefBranch)</span>
<a href="#l5.610"></a><span id="l5.610" class="difflineminus">-        pPrefBranch-&gt;GetIntPref(&quot;mailnews.wraplength&quot;, &amp;width);</span>
<a href="#l5.611"></a><span id="l5.611" class="difflineminus">-      // Let sanity reign!</span>
<a href="#l5.612"></a><span id="l5.612" class="difflineminus">-      if (width == 0)</span>
<a href="#l5.613"></a><span id="l5.613" class="difflineminus">-        width = 72;</span>
<a href="#l5.614"></a><span id="l5.614" class="difflineminus">-      else if (width &lt; 10)</span>
<a href="#l5.615"></a><span id="l5.615" class="difflineminus">-        width = 10;</span>
<a href="#l5.616"></a><span id="l5.616" class="difflineminus">-      else if (width &gt; 30000)</span>
<a href="#l5.617"></a><span id="l5.617" class="difflineminus">-        width = 30000;</span>
<a href="#l5.618"></a><span id="l5.618" class="difflineplus">+      if (NS_SUCCEEDED(ConvertBufToPlainText(conData, UseFormatFlowed(m_charset.get()))))</span>
<a href="#l5.619"></a><span id="l5.619" class="difflineplus">+      {</span>
<a href="#l5.620"></a><span id="l5.620" class="difflineplus">+        if (mDeleteFile)</span>
<a href="#l5.621"></a><span id="l5.621" class="difflineplus">+          mTmpFile-&gt;Remove(PR_FALSE);</span>
<a href="#l5.622"></a><span id="l5.622"> </span>
<a href="#l5.623"></a><span id="l5.623" class="difflineminus">-      //</span>
<a href="#l5.624"></a><span id="l5.624" class="difflineminus">-      // Now use the converter service here to do the right</span>
<a href="#l5.625"></a><span id="l5.625" class="difflineminus">-      // thing and convert this data to plain text for us!</span>
<a href="#l5.626"></a><span id="l5.626" class="difflineminus">-      //</span>
<a href="#l5.627"></a><span id="l5.627" class="difflineminus">-      nsAutoString      conData;</span>
<a href="#l5.628"></a><span id="l5.628" class="difflineplus">+        nsCOMPtr&lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l5.629"></a><span id="l5.629" class="difflineplus">+        nsresult rv = NS_NewLocalFileOutputStream(getter_AddRefs(outputStream), mTmpFile,  PR_WRONLY | PR_CREATE_FILE, 00600);</span>
<a href="#l5.630"></a><span id="l5.630"> </span>
<a href="#l5.631"></a><span id="l5.631" class="difflineminus">-      if (NS_SUCCEEDED(LoadDataFromFile(mTmpFile, conData, PR_TRUE)))</span>
<a href="#l5.632"></a><span id="l5.632" class="difflineminus">-      {</span>
<a href="#l5.633"></a><span id="l5.633" class="difflineminus">-        if (NS_SUCCEEDED(ConvertBufToPlainText(conData, UseFormatFlowed(m_charset))))</span>
<a href="#l5.634"></a><span id="l5.634" class="difflineplus">+        if (NS_SUCCEEDED(rv))</span>
<a href="#l5.635"></a><span id="l5.635">         {</span>
<a href="#l5.636"></a><span id="l5.636" class="difflineminus">-          if (mDeleteFile)</span>
<a href="#l5.637"></a><span id="l5.637" class="difflineminus">-            mTmpFile-&gt;Remove(PR_FALSE);</span>
<a href="#l5.638"></a><span id="l5.638" class="difflineminus">-</span>
<a href="#l5.639"></a><span id="l5.639" class="difflineminus">-          nsCOMPtr&lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l5.640"></a><span id="l5.640" class="difflineminus">-          nsresult rv = NS_NewLocalFileOutputStream(getter_AddRefs(outputStream), mTmpFile,  PR_WRONLY | PR_CREATE_FILE, 00600);</span>
<a href="#l5.641"></a><span id="l5.641" class="difflineminus">-</span>
<a href="#l5.642"></a><span id="l5.642" class="difflineminus">-          if (NS_SUCCEEDED(rv))</span>
<a href="#l5.643"></a><span id="l5.643" class="difflineplus">+          nsCAutoString tData;</span>
<a href="#l5.644"></a><span id="l5.644" class="difflineplus">+          if (NS_FAILED(ConvertFromUnicode(m_charset.get(), conData, tData)))</span>
<a href="#l5.645"></a><span id="l5.645" class="difflineplus">+            LossyCopyUTF16toASCII(conData, tData);</span>
<a href="#l5.646"></a><span id="l5.646" class="difflineplus">+          if (!tData.IsEmpty())</span>
<a href="#l5.647"></a><span id="l5.647">           {</span>
<a href="#l5.648"></a><span id="l5.648" class="difflineminus">-            nsCAutoString tData;</span>
<a href="#l5.649"></a><span id="l5.649" class="difflineminus">-            if (NS_FAILED(ConvertFromUnicode(m_charset, conData, tData)))</span>
<a href="#l5.650"></a><span id="l5.650" class="difflineminus">-              LossyCopyUTF16toASCII(conData, tData);</span>
<a href="#l5.651"></a><span id="l5.651" class="difflineminus">-            if (!tData.IsEmpty())</span>
<a href="#l5.652"></a><span id="l5.652" class="difflineminus">-            {</span>
<a href="#l5.653"></a><span id="l5.653" class="difflineminus">-              PRUint32 bytesWritten;</span>
<a href="#l5.654"></a><span id="l5.654" class="difflineminus">-              (void) outputStream-&gt;Write(tData.get(), tData.Length(), &amp;bytesWritten);</span>
<a href="#l5.655"></a><span id="l5.655" class="difflineminus">-            }</span>
<a href="#l5.656"></a><span id="l5.656" class="difflineminus">-            outputStream-&gt;Close();</span>
<a href="#l5.657"></a><span id="l5.657" class="difflineminus">-            // this silliness is because Windows nsILocalFile caches its file size</span>
<a href="#l5.658"></a><span id="l5.658" class="difflineminus">-            // so if an output stream writes to it, it will still return the original</span>
<a href="#l5.659"></a><span id="l5.659" class="difflineminus">-            // cached size.</span>
<a href="#l5.660"></a><span id="l5.660" class="difflineminus">-            if (mTmpFile)</span>
<a href="#l5.661"></a><span id="l5.661" class="difflineminus">-            {</span>
<a href="#l5.662"></a><span id="l5.662" class="difflineminus">-              nsCOMPtr &lt;nsIFile&gt; tmpFile;</span>
<a href="#l5.663"></a><span id="l5.663" class="difflineminus">-              mTmpFile-&gt;Clone(getter_AddRefs(tmpFile));</span>
<a href="#l5.664"></a><span id="l5.664" class="difflineminus">-              mTmpFile = do_QueryInterface(tmpFile);</span>
<a href="#l5.665"></a><span id="l5.665" class="difflineminus">-            }</span>
<a href="#l5.666"></a><span id="l5.666" class="difflineplus">+            PRUint32 bytesWritten;</span>
<a href="#l5.667"></a><span id="l5.667" class="difflineplus">+            (void) outputStream-&gt;Write(tData.get(), tData.Length(), &amp;bytesWritten);</span>
<a href="#l5.668"></a><span id="l5.668" class="difflineplus">+          }</span>
<a href="#l5.669"></a><span id="l5.669" class="difflineplus">+          outputStream-&gt;Close();</span>
<a href="#l5.670"></a><span id="l5.670" class="difflineplus">+          // this silliness is because Windows nsILocalFile caches its file size</span>
<a href="#l5.671"></a><span id="l5.671" class="difflineplus">+          // so if an output stream writes to it, it will still return the original</span>
<a href="#l5.672"></a><span id="l5.672" class="difflineplus">+          // cached size.</span>
<a href="#l5.673"></a><span id="l5.673" class="difflineplus">+          if (mTmpFile)</span>
<a href="#l5.674"></a><span id="l5.674" class="difflineplus">+          {</span>
<a href="#l5.675"></a><span id="l5.675" class="difflineplus">+            nsCOMPtr &lt;nsIFile&gt; tmpFile;</span>
<a href="#l5.676"></a><span id="l5.676" class="difflineplus">+            mTmpFile-&gt;Clone(getter_AddRefs(tmpFile));</span>
<a href="#l5.677"></a><span id="l5.677" class="difflineplus">+            mTmpFile = do_QueryInterface(tmpFile);</span>
<a href="#l5.678"></a><span id="l5.678" class="difflineplus">+          }</span>
<a href="#l5.679"></a><span id="l5.679"> </span>
<a href="#l5.680"></a><span id="l5.680" class="difflineminus">-          }</span>
<a href="#l5.681"></a><span id="l5.681">         }</span>
<a href="#l5.682"></a><span id="l5.682">       }</span>
<a href="#l5.683"></a><span id="l5.683" class="difflineplus">+    }</span>
<a href="#l5.684"></a><span id="l5.684"> </span>
<a href="#l5.685"></a><span id="l5.685" class="difflineminus">-      PR_FREEIF(m_type);</span>
<a href="#l5.686"></a><span id="l5.686" class="difflineminus">-      m_type = m_desired_type;</span>
<a href="#l5.687"></a><span id="l5.687" class="difflineminus">-      m_desired_type = nsnull;</span>
<a href="#l5.688"></a><span id="l5.688" class="difflineminus">-      PR_FREEIF(m_encoding);</span>
<a href="#l5.689"></a><span id="l5.689" class="difflineminus">-      m_encoding = nsnull;</span>
<a href="#l5.690"></a><span id="l5.690" class="difflineminus">-    }</span>
<a href="#l5.691"></a><span id="l5.691" class="difflineplus">+    m_type = m_desiredType;</span>
<a href="#l5.692"></a><span id="l5.692" class="difflineplus">+    m_desiredType.Truncate();</span>
<a href="#l5.693"></a><span id="l5.693" class="difflineplus">+    m_encoding.Truncate();</span>
<a href="#l5.694"></a><span id="l5.694">   }</span>
<a href="#l5.695"></a><span id="l5.695"> </span>
<a href="#l5.696"></a><span id="l5.696">   PRUint32 pendingAttachmentCount = 0;</span>
<a href="#l5.697"></a><span id="l5.697">   m_mime_delivery_state-&gt;GetPendingAttachmentCount(&amp;pendingAttachmentCount);</span>
<a href="#l5.698"></a><span id="l5.698">   NS_ASSERTION (pendingAttachmentCount &gt; 0, &quot;no more pending attachment&quot;);</span>
<a href="#l5.699"></a><span id="l5.699"> </span>
<a href="#l5.700"></a><span id="l5.700">   m_mime_delivery_state-&gt;SetPendingAttachmentCount(pendingAttachmentCount - 1);</span>
<a href="#l5.701"></a><span id="l5.701"> </span>
<a href="#l5.702"></a><span id="l5.702" class="difflineat">@@ -1364,17 +1287,17 @@ nsMsgAttachmentHandler::UrlExit(nsresult</span>
<a href="#l5.703"></a><span id="l5.703">       {</span>
<a href="#l5.704"></a><span id="l5.704">         next = &amp;attachments[i];</span>
<a href="#l5.705"></a><span id="l5.705">         //</span>
<a href="#l5.706"></a><span id="l5.706">         // rhp: We need to get a little more understanding to failed URL</span>
<a href="#l5.707"></a><span id="l5.707">         // requests. So, at this point if most of next is NULL, then we</span>
<a href="#l5.708"></a><span id="l5.708">         // should just mark it fetched and move on! We probably ignored</span>
<a href="#l5.709"></a><span id="l5.709">         // this earlier on in the send process.</span>
<a href="#l5.710"></a><span id="l5.710">         //</span>
<a href="#l5.711"></a><span id="l5.711" class="difflineminus">-        if ( (!next-&gt;mURL) &amp;&amp; (!next-&gt;m_uri) )</span>
<a href="#l5.712"></a><span id="l5.712" class="difflineplus">+        if ( (!next-&gt;mURL) &amp;&amp; (next-&gt;m_uri.IsEmpty()) )</span>
<a href="#l5.713"></a><span id="l5.713">         {</span>
<a href="#l5.714"></a><span id="l5.714">           attachments[i].m_done = PR_TRUE;</span>
<a href="#l5.715"></a><span id="l5.715">           m_mime_delivery_state-&gt;GetPendingAttachmentCount(&amp;pendingAttachmentCount);</span>
<a href="#l5.716"></a><span id="l5.716">           m_mime_delivery_state-&gt;SetPendingAttachmentCount(pendingAttachmentCount - 1);</span>
<a href="#l5.717"></a><span id="l5.717">           next-&gt;mPartUserOmissionOverride = PR_TRUE;</span>
<a href="#l5.718"></a><span id="l5.718">           next = nsnull;</span>
<a href="#l5.719"></a><span id="l5.719">           continue;</span>
<a href="#l5.720"></a><span id="l5.720">         }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAttachmentHandler.h</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAttachmentHandler.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -123,47 +123,47 @@ private:</span>
<a href="#l6.4"></a><span id="l6.4">                                                nsILocalFileMac *aSourceFile);</span>
<a href="#l6.5"></a><span id="l6.5">   // zips this attachment and does the work to make this attachment handler handle it properly.</span>
<a href="#l6.6"></a><span id="l6.6">   nsresult ConvertToZipFile(nsILocalFileMac *aSourceFile);</span>
<a href="#l6.7"></a><span id="l6.7">   PRBool HasResourceFork(FSRef *fsRef);</span>
<a href="#l6.8"></a><span id="l6.8"> #endif</span>
<a href="#l6.9"></a><span id="l6.9"> </span>
<a href="#l6.10"></a><span id="l6.10">   //</span>
<a href="#l6.11"></a><span id="l6.11"> public:</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  nsCOMPtr &lt;nsIURI&gt; mURL;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-  nsCOMPtr &lt;nsILocalFile&gt;        mTmpFile;         // The temp file to which we save it </span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+  nsCOMPtr&lt;nsIURI&gt; mURL;</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt;        mTmpFile;         // The temp file to which we save it </span>
<a href="#l6.16"></a><span id="l6.16">   nsCOMPtr&lt;nsIOutputStream&gt;  mOutFile;          </span>
<a href="#l6.17"></a><span id="l6.17">   nsCOMPtr&lt;nsIRequest&gt; mRequest; // The live request used while fetching an attachment</span>
<a href="#l6.18"></a><span id="l6.18">   nsMsgCompFields       *mCompFields;       // Message composition fields for the sender</span>
<a href="#l6.19"></a><span id="l6.19">   PRBool                m_bogus_attachment; // This is to catch problem children...</span>
<a href="#l6.20"></a><span id="l6.20">   </span>
<a href="#l6.21"></a><span id="l6.21"> #ifdef XP_MACOSX</span>
<a href="#l6.22"></a><span id="l6.22">   // if we need to encode this file into for example an appledouble, or zip file,</span>
<a href="#l6.23"></a><span id="l6.23">   // this file is our working file. currently only needed on mac.</span>
<a href="#l6.24"></a><span id="l6.24">   nsCOMPtr&lt;nsILocalFile&gt; mEncodedWorkingFile;</span>
<a href="#l6.25"></a><span id="l6.25"> #endif</span>
<a href="#l6.26"></a><span id="l6.26"> </span>
<a href="#l6.27"></a><span id="l6.27" class="difflineminus">-  char                  *m_x_mac_type;      // Mac file type</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineminus">-  char                  *m_x_mac_creator;   // Mac file creator</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineminus">-  </span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-  PRBool                m_done;</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-  char                  *m_charset;         // charset name </span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-  char                  *m_content_id;      // This is for mutipart/related Content-ID's</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-  char                  *m_type;            // The real type, once we know it.</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-  char                  *m_type_param;      // Any addition parameters to add to the content-type (other than charset, macType and maccreator)</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-  char                  *m_override_type;   // The type we should assume it to be</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+  nsCString m_xMacType;      // Mac file type</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+  nsCString m_xMacCreator;   // Mac file creator</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+  PRBool m_done;</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+  nsCString m_charset;         // charset name </span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+  nsCString m_contentId;      // This is for mutipart/related Content-ID's</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+  nsCString m_type;            // The real type, once we know it.</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+  nsCString m_typeParam;      // Any addition parameters to add to the content-type (other than charset, macType and maccreator)</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+  nsCString m_overrideType;   // The type we should assume it to be</span>
<a href="#l6.45"></a><span id="l6.45">                                             // or 0, if we should get it from the</span>
<a href="#l6.46"></a><span id="l6.46">                                             // server)</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineminus">-  char                  *m_override_encoding; // Goes along with override_type </span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+  nsCString m_overrideEncoding; // Goes along with override_type </span>
<a href="#l6.49"></a><span id="l6.49"> </span>
<a href="#l6.50"></a><span id="l6.50" class="difflineminus">-  char                  *m_desired_type;    // The type it should be converted to. </span>
<a href="#l6.51"></a><span id="l6.51" class="difflineminus">-  char                  *m_description;     // For Content-Description header</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineminus">-  char                  *m_real_name;       // The name for the headers, if different</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+  nsCString m_desiredType;    // The type it should be converted to. </span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+  nsCString m_description;     // For Content-Description header</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+  nsCString m_realName;       // The name for the headers, if different</span>
<a href="#l6.56"></a><span id="l6.56">                                             // from the URL. </span>
<a href="#l6.57"></a><span id="l6.57" class="difflineminus">-  char                  *m_encoding;        // The encoding, once we've decided. */</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+  nsCString m_encoding;        // The encoding, once we've decided. */</span>
<a href="#l6.59"></a><span id="l6.59">   PRBool                m_already_encoded_p; // If we attach a document that is already</span>
<a href="#l6.60"></a><span id="l6.60">                                              // encoded, we just pass it through.</span>
<a href="#l6.61"></a><span id="l6.61"> </span>
<a href="#l6.62"></a><span id="l6.62">   PRBool                m_decrypted_p;  /* S/MIME -- when attaching a message that was</span>
<a href="#l6.63"></a><span id="l6.63">                                            encrypted, it's necessary to decrypt it first</span>
<a href="#l6.64"></a><span id="l6.64">                                            (since nobody but the original recipient can</span>
<a href="#l6.65"></a><span id="l6.65">                                            read it -- if you forward it to someone in the</span>
<a href="#l6.66"></a><span id="l6.66">                                            raw, it will be useless to them.)  This flag</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineat">@@ -190,18 +190,18 @@ public:</span>
<a href="#l6.68"></a><span id="l6.68">   PRUint8               m_have_cr, m_have_lf, m_have_crlf; </span>
<a href="#l6.69"></a><span id="l6.69">   PRBool                m_prev_char_was_cr;</span>
<a href="#l6.70"></a><span id="l6.70">   PRUint32              m_current_column;</span>
<a href="#l6.71"></a><span id="l6.71">   PRUint32              m_max_column;</span>
<a href="#l6.72"></a><span id="l6.72">   PRUint32              m_lines;</span>
<a href="#l6.73"></a><span id="l6.73">   PRBool                m_file_analyzed;</span>
<a href="#l6.74"></a><span id="l6.74"> </span>
<a href="#l6.75"></a><span id="l6.75">   MimeEncoderData       *m_encoder_data;  /* Opaque state for base64/qp encoder. */</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineminus">-  char *                m_uri; // original uri string</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineminus">-  </span>
<a href="#l6.78"></a><span id="l6.78" class="difflineplus">+  nsCString             m_uri; // original uri string</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineplus">+</span>
<a href="#l6.80"></a><span id="l6.80">   nsresult              GetMimeDeliveryState(nsIMsgSend** _retval);</span>
<a href="#l6.81"></a><span id="l6.81">   nsresult              SetMimeDeliveryState(nsIMsgSend* mime_delivery_state);</span>
<a href="#l6.82"></a><span id="l6.82"> private:</span>
<a href="#l6.83"></a><span id="l6.83">   nsCOMPtr&lt;nsIMsgSend&gt;  m_mime_delivery_state;</span>
<a href="#l6.84"></a><span id="l6.84">   nsCOMPtr&lt;nsIStreamConverter&gt; m_mime_parser;</span>
<a href="#l6.85"></a><span id="l6.85">   nsCOMPtr&lt;nsIChannel&gt;  m_converter_channel;</span>
<a href="#l6.86"></a><span id="l6.86"> };</span>
<a href="#l6.87"></a><span id="l6.87"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompUtils.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompUtils.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1599,24 +1599,23 @@ msg_make_filename_qtext(const char *srcT</span>
<a href="#l7.4"></a><span id="l7.4"> }</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6"> /* Rip apart the URL and extract a reasonable value for the `real_name' slot.</span>
<a href="#l7.7"></a><span id="l7.7">  */</span>
<a href="#l7.8"></a><span id="l7.8"> void</span>
<a href="#l7.9"></a><span id="l7.9"> msg_pick_real_name (nsMsgAttachmentHandler *attachment, const PRUnichar *proposedName, const char *charset)</span>
<a href="#l7.10"></a><span id="l7.10"> {</span>
<a href="#l7.11"></a><span id="l7.11">   const char *s, *s2;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  char *s3;</span>
<a href="#l7.13"></a><span id="l7.13"> </span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-  if ( (attachment-&gt;m_real_name) &amp;&amp; (*attachment-&gt;m_real_name))</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+  if (!attachment-&gt;m_realName.IsEmpty())</span>
<a href="#l7.16"></a><span id="l7.16">     return;</span>
<a href="#l7.17"></a><span id="l7.17"> </span>
<a href="#l7.18"></a><span id="l7.18">   if (proposedName &amp;&amp; *proposedName)</span>
<a href="#l7.19"></a><span id="l7.19">   {</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">-    attachment-&gt;m_real_name = ToNewUTF8String(nsAutoString(proposedName));</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+    attachment-&gt;m_realName.Adopt(ToNewUTF8String(nsAutoString(proposedName)));</span>
<a href="#l7.22"></a><span id="l7.22">   }</span>
<a href="#l7.23"></a><span id="l7.23">   else //Let's extract the name from the URL</span>
<a href="#l7.24"></a><span id="l7.24">   {</span>
<a href="#l7.25"></a><span id="l7.25">     nsCString url;</span>
<a href="#l7.26"></a><span id="l7.26">     attachment-&gt;mURL-&gt;GetSpec(url);</span>
<a href="#l7.27"></a><span id="l7.27"> </span>
<a href="#l7.28"></a><span id="l7.28">     s = url.get();</span>
<a href="#l7.29"></a><span id="l7.29">     s2 = PL_strchr (s, ':');</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineat">@@ -1639,19 +1638,18 @@ msg_pick_real_name (nsMsgAttachmentHandl</span>
<a href="#l7.31"></a><span id="l7.31">       nsCString nonDataPart(Substring(url, 5, endNonData - 5));</span>
<a href="#l7.32"></a><span id="l7.32">       PRInt32 filenamePos = nonDataPart.Find(&quot;filename=&quot;);</span>
<a href="#l7.33"></a><span id="l7.33">       if (filenamePos != -1)</span>
<a href="#l7.34"></a><span id="l7.34">       {</span>
<a href="#l7.35"></a><span id="l7.35">         filenamePos += 9;</span>
<a href="#l7.36"></a><span id="l7.36">         PRInt32 endFilename = nonDataPart.FindChar(';', filenamePos);</span>
<a href="#l7.37"></a><span id="l7.37">         if (endFilename == -1)</span>
<a href="#l7.38"></a><span id="l7.38">           endFilename = endNonData;</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-        PR_FREEIF(attachment-&gt;m_real_name);</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">-        attachment-&gt;m_real_name = ToNewCString(Substring(nonDataPart, filenamePos,</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineminus">-                                                         endFilename - filenamePos));</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+        attachment-&gt;m_realName = Substring(nonDataPart, filenamePos,</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+                                           endFilename - filenamePos);</span>
<a href="#l7.44"></a><span id="l7.44">       }</span>
<a href="#l7.45"></a><span id="l7.45">       else</span>
<a href="#l7.46"></a><span id="l7.46">       {</span>
<a href="#l7.47"></a><span id="l7.47">         // no filename; need to construct one based on the content type.</span>
<a href="#l7.48"></a><span id="l7.48">         nsCOMPtr&lt;nsIMIMEService&gt; mimeService(do_GetService(NS_MIMESERVICE_CONTRACTID));</span>
<a href="#l7.49"></a><span id="l7.49">         if (!mimeService)</span>
<a href="#l7.50"></a><span id="l7.50">           return;</span>
<a href="#l7.51"></a><span id="l7.51">         nsCOMPtr&lt;nsIMIMEInfo&gt; mimeInfo;</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineat">@@ -1663,42 +1661,41 @@ msg_pick_real_name (nsMsgAttachmentHandl</span>
<a href="#l7.53"></a><span id="l7.53">         nsCString extension;</span>
<a href="#l7.54"></a><span id="l7.54">         mimeInfo-&gt;GetPrimaryExtension(extension);</span>
<a href="#l7.55"></a><span id="l7.55">         unsigned char filePrefix[10];</span>
<a href="#l7.56"></a><span id="l7.56">         GenerateGlobalRandomBytes(filePrefix, 8);</span>
<a href="#l7.57"></a><span id="l7.57">         for (PRInt32 i = 0; i &lt; 8; i++)</span>
<a href="#l7.58"></a><span id="l7.58">           filename.Append(filePrefix[i] + 'a');</span>
<a href="#l7.59"></a><span id="l7.59">         filename.Append('.');</span>
<a href="#l7.60"></a><span id="l7.60">         filename.Append(extension);</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineminus">-        PR_FREEIF(attachment-&gt;m_real_name);</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineminus">-        attachment-&gt;m_real_name = ToNewCString(filename);</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+        attachment-&gt;m_realName = filename;</span>
<a href="#l7.64"></a><span id="l7.64">       }</span>
<a href="#l7.65"></a><span id="l7.65">     }</span>
<a href="#l7.66"></a><span id="l7.66">     else</span>
<a href="#l7.67"></a><span id="l7.67">     {</span>
<a href="#l7.68"></a><span id="l7.68">       /* Take the part of the file name after the last / or \ */</span>
<a href="#l7.69"></a><span id="l7.69">       s2 = PL_strrchr (s, '/');</span>
<a href="#l7.70"></a><span id="l7.70">       if (s2) s = s2+1;</span>
<a href="#l7.71"></a><span id="l7.71">       s2 = PL_strrchr (s, '\\');</span>
<a href="#l7.72"></a><span id="l7.72"> </span>
<a href="#l7.73"></a><span id="l7.73">       if (s2) s = s2+1;</span>
<a href="#l7.74"></a><span id="l7.74">       /* Copy it into the attachment struct. */</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineminus">-      PR_FREEIF(attachment-&gt;m_real_name);</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineminus">-      attachment-&gt;m_real_name = PL_strdup (s);</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+      attachment-&gt;m_realName = s;</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+      PRInt32 charPos = attachment-&gt;m_realName.FindChar('?');</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+      if (charPos != -1)</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+        attachment-&gt;m_realName.SetLength(charPos);</span>
<a href="#l7.81"></a><span id="l7.81">       /* Now trim off any named anchors or search data. */</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineminus">-      s3 = PL_strchr (attachment-&gt;m_real_name, '?');</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineminus">-      if (s3) *s3 = 0;</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineminus">-      s3 = PL_strchr (attachment-&gt;m_real_name, '#');</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineminus">-      if (s3) *s3 = 0;</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+      charPos = attachment-&gt;m_realName.FindChar('#');</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+      if (charPos != -1)</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+        attachment-&gt;m_realName.SetLength(charPos);</span>
<a href="#l7.89"></a><span id="l7.89">     }</span>
<a href="#l7.90"></a><span id="l7.90">     /* Now lose the %XX crap. */</span>
<a href="#l7.91"></a><span id="l7.91">     nsCString unescaped_real_name;</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineminus">-    MsgUnescapeString(nsDependentCString(attachment-&gt;m_real_name), 0, unescaped_real_name);</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineminus">-    NS_Free(attachment-&gt;m_real_name);</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineminus">-    attachment-&gt;m_real_name = ToNewCString(unescaped_real_name);</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+    MsgUnescapeString(attachment-&gt;m_realName, 0, unescaped_real_name);</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+    attachment-&gt;m_realName = unescaped_real_name;</span>
<a href="#l7.97"></a><span id="l7.97">   }</span>
<a href="#l7.98"></a><span id="l7.98"> </span>
<a href="#l7.99"></a><span id="l7.99">   /* Now a special case for attaching uuencoded files...</span>
<a href="#l7.100"></a><span id="l7.100"> </span>
<a href="#l7.101"></a><span id="l7.101">    If we attach a file &quot;foo.txt.uu&quot;, we will send it out with</span>
<a href="#l7.102"></a><span id="l7.102">    Content-Type: text/plain; Content-Transfer-Encoding: x-uuencode.</span>
<a href="#l7.103"></a><span id="l7.103">    When saving such a file, a mail reader will generally decode it first</span>
<a href="#l7.104"></a><span id="l7.104">    (thus removing the uuencoding.)  So, let's make life a little easier by</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineat">@@ -1706,54 +1703,37 @@ msg_pick_real_name (nsMsgAttachmentHandl</span>
<a href="#l7.106"></a><span id="l7.106">    will presumably make the file name in the Content-Disposition header be</span>
<a href="#l7.107"></a><span id="l7.107">    the same as the file name in the &quot;begin&quot; line of the uuencoded data.)</span>
<a href="#l7.108"></a><span id="l7.108"> </span>
<a href="#l7.109"></a><span id="l7.109">    However, since there are mailers out there (including earlier versions of</span>
<a href="#l7.110"></a><span id="l7.110">    Mozilla) that will use &quot;foo.txt.uu&quot; as the file name, we still need to</span>
<a href="#l7.111"></a><span id="l7.111">    cope with that; the code which copes with that is in the MIME parser, in</span>
<a href="#l7.112"></a><span id="l7.112">    libmime/mimei.c.</span>
<a href="#l7.113"></a><span id="l7.113">    */</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineminus">-  if (attachment-&gt;m_already_encoded_p &amp;&amp;</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineminus">-    attachment-&gt;m_encoding)</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineplus">+  if (attachment-&gt;m_already_encoded_p &amp;&amp; !attachment-&gt;m_encoding.IsEmpty())</span>
<a href="#l7.117"></a><span id="l7.117">   {</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineminus">-    char *result = attachment-&gt;m_real_name;</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineminus">-    PRInt32 L = PL_strlen(result);</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineminus">-    const char **exts = 0;</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineminus">-</span>
<a href="#l7.122"></a><span id="l7.122">     /* #### TOTAL KLUDGE.</span>
<a href="#l7.123"></a><span id="l7.123">      I'd like to ask the mime.types file, &quot;what extensions correspond</span>
<a href="#l7.124"></a><span id="l7.124">      to obj-&gt;encoding (which happens to be &quot;x-uuencode&quot;) but doing that</span>
<a href="#l7.125"></a><span id="l7.125">      in a non-sphagetti way would require brain surgery.  So, since</span>
<a href="#l7.126"></a><span id="l7.126">      currently uuencode is the only content-transfer-encoding which we</span>
<a href="#l7.127"></a><span id="l7.127">      understand which traditionally has an extension, we just special-</span>
<a href="#l7.128"></a><span id="l7.128">      case it here!</span>
<a href="#l7.129"></a><span id="l7.129"> </span>
<a href="#l7.130"></a><span id="l7.130">      Note that it's special-cased in a similar way in libmime/mimei.c.</span>
<a href="#l7.131"></a><span id="l7.131">      */</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineminus">-    if (!PL_strcasecmp(attachment-&gt;m_encoding, ENCODING_UUENCODE) ||</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineminus">-      !PL_strcasecmp(attachment-&gt;m_encoding, ENCODING_UUENCODE2) ||</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineminus">-      !PL_strcasecmp(attachment-&gt;m_encoding, ENCODING_UUENCODE3) ||</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineminus">-      !PL_strcasecmp(attachment-&gt;m_encoding, ENCODING_UUENCODE4))</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineminus">-    {</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineminus">-      static const char *uue_exts[] = { &quot;uu&quot;, &quot;uue&quot;, 0 };</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineminus">-      exts = uue_exts;</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineminus">-    }</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineminus">-</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineminus">-    while (exts &amp;&amp; *exts)</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineplus">+    if (attachment-&gt;m_encoding.LowerCaseEqualsLiteral(ENCODING_UUENCODE) ||</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineplus">+        attachment-&gt;m_encoding.LowerCaseEqualsLiteral(ENCODING_UUENCODE2) ||</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineplus">+        attachment-&gt;m_encoding.LowerCaseEqualsLiteral(ENCODING_UUENCODE3) ||</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineplus">+        attachment-&gt;m_encoding.LowerCaseEqualsLiteral(ENCODING_UUENCODE4))</span>
<a href="#l7.146"></a><span id="l7.146">     {</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineminus">-      const char *ext = *exts;</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineminus">-      PRInt32 L2 = PL_strlen(ext);</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineminus">-      if (L &gt; L2 + 1 &amp;&amp;             /* long enough */</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineminus">-        result[L - L2 - 1] == '.' &amp;&amp;      /* '.' in right place*/</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineminus">-        !PL_strcasecmp(ext, result + (L - L2))) /* ext matches */</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineminus">-      {</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineminus">-        result[L - L2 - 1] = 0;   /* truncate at '.' and stop. */</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineminus">-        break;</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineminus">-      }</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineminus">-      exts++;</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineplus">+      if (StringEndsWith(attachment-&gt;m_realName, NS_LITERAL_CSTRING(&quot;.uu&quot;)))</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineplus">+        attachment-&gt;m_realName.Cut(attachment-&gt;m_realName.Length() - 3, 3);</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineplus">+      else if (StringEndsWith(attachment-&gt;m_realName, NS_LITERAL_CSTRING(&quot;.uue&quot;)))</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineplus">+        attachment-&gt;m_realName.Cut(attachment-&gt;m_realName.Length() - 4, 4);</span>
<a href="#l7.161"></a><span id="l7.161">     }</span>
<a href="#l7.162"></a><span id="l7.162">   }</span>
<a href="#l7.163"></a><span id="l7.163"> }</span>
<a href="#l7.164"></a><span id="l7.164"> </span>
<a href="#l7.165"></a><span id="l7.165"> // Utility to create a nsIURI object...</span>
<a href="#l7.166"></a><span id="l7.166"> nsresult</span>
<a href="#l7.167"></a><span id="l7.167"> nsMsgNewURL(nsIURI** aInstancePtrResult, const char * aSpec)</span>
<a href="#l7.168"></a><span id="l7.168"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1030,19 +1030,18 @@ nsresult nsMsgCompose::_SendMsg(MSG_Deli</span>
<a href="#l8.4"></a><span id="l8.4">                     m_compFields,</span>
<a href="#l8.5"></a><span id="l8.5">                     PR_FALSE,                           // PRBool                            digest_p,</span>
<a href="#l8.6"></a><span id="l8.6">                     PR_FALSE,                           // PRBool                            dont_deliver_p,</span>
<a href="#l8.7"></a><span id="l8.7">                     (nsMsgDeliverMode)deliverMode,      // nsMsgDeliverMode                  mode,</span>
<a href="#l8.8"></a><span id="l8.8">                     nsnull,                             // nsIMsgDBHdr                       *msgToReplace,</span>
<a href="#l8.9"></a><span id="l8.9">                     m_composeHTML?TEXT_HTML:TEXT_PLAIN, // const char                        *attachment1_type,</span>
<a href="#l8.10"></a><span id="l8.10">                     bodyString,                         // const char                        *attachment1_body,</span>
<a href="#l8.11"></a><span id="l8.11">                     bodyLength,                         // PRUint32                          attachment1_body_length,</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-                    nsnull,                             // const struct nsMsgAttachmentData  *attachments,</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-                    nsnull,                             // const struct nsMsgAttachedFile    *preloaded_attachments,</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-                    nsnull,                             // nsMsgSendPart                     *relatedPart,</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+                    nsnull,                             // nsIArray  *attachments,</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+                    nsnull,                             // nsIArray preloaded_attachments,</span>
<a href="#l8.17"></a><span id="l8.17">                     m_window,                           // nsIDOMWindow                      *parentWindow;</span>
<a href="#l8.18"></a><span id="l8.18">                     mProgress,                          // nsIMsgProgress                    *progress,</span>
<a href="#l8.19"></a><span id="l8.19">                     sendListener,                       // listener</span>
<a href="#l8.20"></a><span id="l8.20">                     mSmtpPassword.get(),</span>
<a href="#l8.21"></a><span id="l8.21">                     mOriginalMsgURI,</span>
<a href="#l8.22"></a><span id="l8.22">                     mType);</span>
<a href="#l8.23"></a><span id="l8.23"> </span>
<a href="#l8.24"></a><span id="l8.24">       // Cleanup converted body...</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -103,16 +103,18 @@</span>
<a href="#l9.4"></a><span id="l9.4"> #include &quot;nsIAbCard.h&quot;</span>
<a href="#l9.5"></a><span id="l9.5"> #include &quot;nsIMsgProgress.h&quot;</span>
<a href="#l9.6"></a><span id="l9.6"> #include &quot;nsIMsgMessageService.h&quot;</span>
<a href="#l9.7"></a><span id="l9.7"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l9.8"></a><span id="l9.8"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l9.9"></a><span id="l9.9"> #include &quot;nsComposeStrings.h&quot;</span>
<a href="#l9.10"></a><span id="l9.10"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l9.11"></a><span id="l9.11"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+#include &quot;nsIArray.h&quot;</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+#include &quot;nsArrayUtils.h&quot;</span>
<a href="#l9.14"></a><span id="l9.14"> </span>
<a href="#l9.15"></a><span id="l9.15"> static NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l9.16"></a><span id="l9.16"> </span>
<a href="#l9.17"></a><span id="l9.17"> #define PREF_MAIL_SEND_STRUCT &quot;mail.send_struct&quot;</span>
<a href="#l9.18"></a><span id="l9.18"> #define PREF_MAIL_STRICTLY_MIME &quot;mail.strictly_mime&quot;</span>
<a href="#l9.19"></a><span id="l9.19"> #define PREF_MAIL_MESSAGE_WARNING_SIZE &quot;mailnews.message_warning_size&quot;</span>
<a href="#l9.20"></a><span id="l9.20"> #define PREF_MAIL_COLLECT_EMAIL_ADDRESS_OUTGOING &quot;mail.collect_email_address_outgoing&quot;</span>
<a href="#l9.21"></a><span id="l9.21"> #define PREF_MAIL_DONT_ATTACH_SOURCE &quot;mail.compose.dont_attach_source_of_local_network_links&quot;</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineat">@@ -526,68 +528,55 @@ nsMsgComposeAndSend::GatherMimeAttachmen</span>
<a href="#l9.23"></a><span id="l9.23">   if (status &lt; 0)</span>
<a href="#l9.24"></a><span id="l9.24">     goto FAIL;</span>
<a href="#l9.25"></a><span id="l9.25"> </span>
<a href="#l9.26"></a><span id="l9.26">   if (m_attachments_only_p)</span>
<a href="#l9.27"></a><span id="l9.27">   {</span>
<a href="#l9.28"></a><span id="l9.28">     /* If we get here, we should be fetching attachments only! */</span>
<a href="#l9.29"></a><span id="l9.29">     if (m_attachments_done_callback)</span>
<a href="#l9.30"></a><span id="l9.30">     {</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-      struct nsMsgAttachedFile *attachments;</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+      nsMsgAttachedFile *attachments;</span>
<a href="#l9.33"></a><span id="l9.33"> </span>
<a href="#l9.34"></a><span id="l9.34">       NS_ASSERTION(m_attachment_count &gt; 0, &quot;not more attachment&quot;);</span>
<a href="#l9.35"></a><span id="l9.35">       if (m_attachment_count &lt;= 0)</span>
<a href="#l9.36"></a><span id="l9.36">       {</span>
<a href="#l9.37"></a><span id="l9.37">         m_attachments_done_callback (nsnull, nsnull, nsnull);</span>
<a href="#l9.38"></a><span id="l9.38">         m_attachments_done_callback = nsnull;</span>
<a href="#l9.39"></a><span id="l9.39">         goto FAIL;</span>
<a href="#l9.40"></a><span id="l9.40">       }</span>
<a href="#l9.41"></a><span id="l9.41"> </span>
<a href="#l9.42"></a><span id="l9.42" class="difflineminus">-      attachments = (struct nsMsgAttachedFile *)PR_Malloc((m_attachment_count + 1) * sizeof(*attachments));</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+      attachments = new nsMsgAttachedFile[m_attachment_count + 1];</span>
<a href="#l9.44"></a><span id="l9.44"> </span>
<a href="#l9.45"></a><span id="l9.45">       if (!attachments)</span>
<a href="#l9.46"></a><span id="l9.46">         goto FAILMEM;</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineminus">-      memset(attachments, 0, ((m_attachment_count + 1) * sizeof(*attachments)));</span>
<a href="#l9.48"></a><span id="l9.48">       for (i = 0; i &lt; m_attachment_count; i++)</span>
<a href="#l9.49"></a><span id="l9.49">       {</span>
<a href="#l9.50"></a><span id="l9.50">         nsMsgAttachmentHandler *ma = &amp;m_attachments[i];</span>
<a href="#l9.51"></a><span id="l9.51"> </span>
<a href="#l9.52"></a><span id="l9.52" class="difflineminus">-#undef SNARF</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineminus">-#define SNARF(x,y) do { if((y) &amp;&amp; *(y) &amp;&amp; !(x)) { ((x) = (y)); ((y) = 0); }} \</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineminus">-           while(0)</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineminus">-        // Rather than copying the strings and dealing with allocation</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineminus">-        // failures, we'll just &quot;move&quot; them into the other struct (this</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineminus">-        // should be ok since this file uses PR_FREEIF when discarding</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineminus">-        // the mime_attachment objects.)</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineminus">-        //</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineminus">-        attachments[i].orig_url = ma-&gt;mURL;</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineminus">-        attachments[i].tmp_file = ma-&gt;mTmpFile;</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineminus">-</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-        SNARF(attachments[i].type, ma-&gt;m_type);</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineminus">-        SNARF(attachments[i].encoding, ma-&gt;m_encoding);</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineminus">-        SNARF(attachments[i].description, ma-&gt;m_description);</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineminus">-        SNARF(attachments[i].x_mac_type, ma-&gt;m_x_mac_type);</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineminus">-        SNARF(attachments[i].x_mac_creator, ma-&gt;m_x_mac_creator);</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineminus">-</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineminus">-#undef SNARF</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineminus">-        attachments[i].size = ma-&gt;m_size;</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineminus">-        attachments[i].unprintable_count = ma-&gt;m_unprintable_count;</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineminus">-        attachments[i].highbit_count = ma-&gt;m_highbit_count;</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineminus">-        attachments[i].ctl_count = ma-&gt;m_ctl_count;</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineminus">-        attachments[i].null_count = ma-&gt;m_null_count;</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineminus">-        attachments[i].max_line_length = ma-&gt;m_max_column;</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineplus">+        attachments[i].m_origUrl = ma-&gt;mURL;</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineplus">+        attachments[i].m_tmpFile = ma-&gt;mTmpFile;</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineplus">+</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineplus">+        attachments[i].m_type = ma-&gt;m_type;</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineplus">+        attachments[i].m_encoding, ma-&gt;m_encoding;</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineplus">+        attachments[i].m_description = ma-&gt;m_description;</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineplus">+        attachments[i].m_xMacType = ma-&gt;m_xMacType;</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineplus">+        attachments[i].m_xMacCreator = ma-&gt;m_xMacCreator;</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineplus">+</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineplus">+        attachments[i].m_size = ma-&gt;m_size;</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineplus">+        attachments[i].m_unprintableCount = ma-&gt;m_unprintable_count;</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineplus">+        attachments[i].m_highbitCount = ma-&gt;m_highbit_count;</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineplus">+        attachments[i].m_ctlCount = ma-&gt;m_ctl_count;</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineplus">+        attachments[i].m_nullCount = ma-&gt;m_null_count;</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineplus">+        attachments[i].m_maxLineLength = ma-&gt;m_max_column;</span>
<a href="#l9.91"></a><span id="l9.91"> </span>
<a href="#l9.92"></a><span id="l9.92">         /* Doesn't really matter, but let's not lie about encoding</span>
<a href="#l9.93"></a><span id="l9.93">            in case it does someday. */</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineminus">-        if (attachments[i].highbit_count &gt; 0 &amp;&amp; attachments[i].encoding &amp;&amp;</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineminus">-            !PL_strcasecmp(attachments[i].encoding, ENCODING_7BIT))</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineminus">-        {</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineminus">-          PR_Free(attachments[i].encoding);</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineminus">-          attachments[i].encoding = PL_strdup(ENCODING_8BIT);</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineminus">-        }</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineplus">+        if (attachments[i].m_highbitCount &gt; 0 &amp;&amp;</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineplus">+            attachments[i].m_encoding.LowerCaseEqualsLiteral(ENCODING_7BIT))</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineplus">+          attachments[i].m_encoding = ENCODING_8BIT;</span>
<a href="#l9.103"></a><span id="l9.103">       }</span>
<a href="#l9.104"></a><span id="l9.104"> </span>
<a href="#l9.105"></a><span id="l9.105">       m_attachments_done_callback(nsnull, nsnull, attachments);</span>
<a href="#l9.106"></a><span id="l9.106">       PR_FREEIF(attachments);</span>
<a href="#l9.107"></a><span id="l9.107">       m_attachments_done_callback = nsnull;</span>
<a href="#l9.108"></a><span id="l9.108">     }</span>
<a href="#l9.109"></a><span id="l9.109">     goto FAIL;</span>
<a href="#l9.110"></a><span id="l9.110">   }</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineat">@@ -667,22 +656,19 @@ nsMsgComposeAndSend::GatherMimeAttachmen</span>
<a href="#l9.112"></a><span id="l9.112">     rv = NS_GetURLSpecFromFile(mHTMLFile, tempURL);</span>
<a href="#l9.113"></a><span id="l9.113">     if (NS_FAILED(rv) || NS_FAILED(nsMsgNewURL(getter_AddRefs(m_plaintext-&gt;mURL), tempURL.get())))</span>
<a href="#l9.114"></a><span id="l9.114">     {</span>
<a href="#l9.115"></a><span id="l9.115">       delete m_plaintext;</span>
<a href="#l9.116"></a><span id="l9.116">       m_plaintext = nsnull;</span>
<a href="#l9.117"></a><span id="l9.117">       goto FAILMEM;</span>
<a href="#l9.118"></a><span id="l9.118">     }</span>
<a href="#l9.119"></a><span id="l9.119"> </span>
<a href="#l9.120"></a><span id="l9.120" class="difflineminus">-    PR_FREEIF(m_plaintext-&gt;m_type);</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineminus">-    m_plaintext-&gt;m_type = PL_strdup(TEXT_HTML);</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineminus">-    PR_FREEIF(m_plaintext-&gt;m_charset);</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineminus">-    m_plaintext-&gt;m_charset = PL_strdup(mCompFields-&gt;GetCharacterSet());</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineminus">-    PR_FREEIF(m_plaintext-&gt;m_desired_type);</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineminus">-    m_plaintext-&gt;m_desired_type = PL_strdup(TEXT_PLAIN);</span>
<a href="#l9.126"></a><span id="l9.126" class="difflineplus">+    m_plaintext-&gt;m_type = TEXT_HTML;</span>
<a href="#l9.127"></a><span id="l9.127" class="difflineplus">+    m_plaintext-&gt;m_charset = mCompFields-&gt;GetCharacterSet();</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineplus">+    m_plaintext-&gt;m_desiredType = TEXT_PLAIN;</span>
<a href="#l9.129"></a><span id="l9.129">     m_attachment_pending_count ++;</span>
<a href="#l9.130"></a><span id="l9.130">     status = m_plaintext-&gt;SnarfAttachment(mCompFields);</span>
<a href="#l9.131"></a><span id="l9.131">     if (NS_FAILED(status))</span>
<a href="#l9.132"></a><span id="l9.132">       goto FAIL;</span>
<a href="#l9.133"></a><span id="l9.133">     if (m_attachment_pending_count &gt; 0)</span>
<a href="#l9.134"></a><span id="l9.134">       return NS_OK;</span>
<a href="#l9.135"></a><span id="l9.135">   }</span>
<a href="#l9.136"></a><span id="l9.136"> </span>
<a href="#l9.137"></a><span id="l9.137" class="difflineat">@@ -784,22 +770,22 @@ nsMsgComposeAndSend::GatherMimeAttachmen</span>
<a href="#l9.138"></a><span id="l9.138">     if (status &lt; 0)</span>
<a href="#l9.139"></a><span id="l9.139">       goto FAIL;</span>
<a href="#l9.140"></a><span id="l9.140"> </span>
<a href="#l9.141"></a><span id="l9.141">     m_plaintext-&gt;mMainBody = PR_TRUE;</span>
<a href="#l9.142"></a><span id="l9.142"> </span>
<a href="#l9.143"></a><span id="l9.143">     // Determine Content-Transfer-Encoding for the attachments.</span>
<a href="#l9.144"></a><span id="l9.144">     m_plaintext-&gt;PickEncoding(mCompFields-&gt;GetCharacterSet(), this);</span>
<a href="#l9.145"></a><span id="l9.145">     const char *charset = mCompFields-&gt;GetCharacterSet();</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineminus">-    hdrs = mime_generate_attachment_headers(m_plaintext-&gt;m_type,</span>
<a href="#l9.147"></a><span id="l9.147" class="difflineplus">+    hdrs = mime_generate_attachment_headers(m_plaintext-&gt;m_type.get(),</span>
<a href="#l9.148"></a><span id="l9.148">                         nsnull,</span>
<a href="#l9.149"></a><span id="l9.149" class="difflineminus">-                        m_plaintext-&gt;m_encoding,</span>
<a href="#l9.150"></a><span id="l9.150" class="difflineminus">-                        m_plaintext-&gt;m_description,</span>
<a href="#l9.151"></a><span id="l9.151" class="difflineminus">-                        m_plaintext-&gt;m_x_mac_type,</span>
<a href="#l9.152"></a><span id="l9.152" class="difflineminus">-                        m_plaintext-&gt;m_x_mac_creator,</span>
<a href="#l9.153"></a><span id="l9.153" class="difflineplus">+                        m_plaintext-&gt;m_encoding.get(),</span>
<a href="#l9.154"></a><span id="l9.154" class="difflineplus">+                        m_plaintext-&gt;m_description.get(),</span>
<a href="#l9.155"></a><span id="l9.155" class="difflineplus">+                        m_plaintext-&gt;m_xMacType.get(),</span>
<a href="#l9.156"></a><span id="l9.156" class="difflineplus">+                        m_plaintext-&gt;m_xMacCreator.get(),</span>
<a href="#l9.157"></a><span id="l9.157">                         nsnull, 0,</span>
<a href="#l9.158"></a><span id="l9.158">                         m_digest_p,</span>
<a href="#l9.159"></a><span id="l9.159">                         m_plaintext,</span>
<a href="#l9.160"></a><span id="l9.160">                         charset,</span>
<a href="#l9.161"></a><span id="l9.161">                         charset,</span>
<a href="#l9.162"></a><span id="l9.162">                         body_is_us_ascii,</span>
<a href="#l9.163"></a><span id="l9.163">                         nsnull,</span>
<a href="#l9.164"></a><span id="l9.164">                         PR_TRUE);</span>
<a href="#l9.165"></a><span id="l9.165" class="difflineat">@@ -832,27 +818,27 @@ nsMsgComposeAndSend::GatherMimeAttachmen</span>
<a href="#l9.166"></a><span id="l9.166">         goto FAIL;</span>
<a href="#l9.167"></a><span id="l9.167"> </span>
<a href="#l9.168"></a><span id="l9.168">       // Create the encoder for the plaintext part here,</span>
<a href="#l9.169"></a><span id="l9.169">       // because we aren't the main part (attachment1).</span>
<a href="#l9.170"></a><span id="l9.170">       // (This, along with the rest of the routine, should really</span>
<a href="#l9.171"></a><span id="l9.171">       // be restructured so that no special treatment is given to</span>
<a href="#l9.172"></a><span id="l9.172">       // the main body text that came in. Best to put attachment1_text</span>
<a href="#l9.173"></a><span id="l9.173">       // etc. into a nsMsgSendPart, then reshuffle the parts. Sigh.)</span>
<a href="#l9.174"></a><span id="l9.174" class="difflineminus">-      if (!PL_strcasecmp(m_plaintext-&gt;m_encoding, ENCODING_QUOTED_PRINTABLE))</span>
<a href="#l9.175"></a><span id="l9.175" class="difflineplus">+      if (m_plaintext-&gt;m_encoding.LowerCaseEqualsLiteral(ENCODING_QUOTED_PRINTABLE))</span>
<a href="#l9.176"></a><span id="l9.176">       {</span>
<a href="#l9.177"></a><span id="l9.177">         MimeEncoderData *plaintext_enc = MIME_QPEncoderInit(mime_encoder_output_fn, this);</span>
<a href="#l9.178"></a><span id="l9.178">         if (!plaintext_enc)</span>
<a href="#l9.179"></a><span id="l9.179">         {</span>
<a href="#l9.180"></a><span id="l9.180">           status = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l9.181"></a><span id="l9.181">           goto FAIL;</span>
<a href="#l9.182"></a><span id="l9.182">         }</span>
<a href="#l9.183"></a><span id="l9.183">         plainpart-&gt;SetEncoderData(plaintext_enc);</span>
<a href="#l9.184"></a><span id="l9.184">       }</span>
<a href="#l9.185"></a><span id="l9.185" class="difflineminus">-      else if (!PL_strcasecmp(m_plaintext-&gt;m_encoding, ENCODING_BASE64))</span>
<a href="#l9.186"></a><span id="l9.186" class="difflineplus">+      else if (m_plaintext-&gt;m_encoding.LowerCaseEqualsLiteral(ENCODING_BASE64))</span>
<a href="#l9.187"></a><span id="l9.187">       {</span>
<a href="#l9.188"></a><span id="l9.188">         MimeEncoderData *plaintext_enc = MIME_B64EncoderInit(mime_encoder_output_fn, this);</span>
<a href="#l9.189"></a><span id="l9.189">         if (!plaintext_enc)</span>
<a href="#l9.190"></a><span id="l9.190">         {</span>
<a href="#l9.191"></a><span id="l9.191">           status = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l9.192"></a><span id="l9.192">           goto FAIL;</span>
<a href="#l9.193"></a><span id="l9.193">         }</span>
<a href="#l9.194"></a><span id="l9.194">         plainpart-&gt;SetEncoderData(plaintext_enc);</span>
<a href="#l9.195"></a><span id="l9.195" class="difflineat">@@ -867,17 +853,17 @@ nsMsgComposeAndSend::GatherMimeAttachmen</span>
<a href="#l9.196"></a><span id="l9.196">       mainbody = maincontainer;</span>
<a href="#l9.197"></a><span id="l9.197">       PR_FREEIF(m_attachment1_type);</span>
<a href="#l9.198"></a><span id="l9.198">       m_attachment1_type = PL_strdup(TEXT_PLAIN);</span>
<a href="#l9.199"></a><span id="l9.199">       if (!m_attachment1_type)</span>
<a href="#l9.200"></a><span id="l9.200">         goto FAILMEM;</span>
<a href="#l9.201"></a><span id="l9.201"> </span>
<a href="#l9.202"></a><span id="l9.202">       /* Override attachment1_encoding here. */</span>
<a href="#l9.203"></a><span id="l9.203">       PR_FREEIF(m_attachment1_encoding);</span>
<a href="#l9.204"></a><span id="l9.204" class="difflineminus">-      m_attachment1_encoding = PL_strdup(m_plaintext-&gt;m_encoding);</span>
<a href="#l9.205"></a><span id="l9.205" class="difflineplus">+      m_attachment1_encoding = ToNewCString(m_plaintext-&gt;m_encoding);</span>
<a href="#l9.206"></a><span id="l9.206"> </span>
<a href="#l9.207"></a><span id="l9.207">       plaintext_is_mainbody_p = PR_TRUE; // converted plaintext is mainbody</span>
<a href="#l9.208"></a><span id="l9.208">     }</span>
<a href="#l9.209"></a><span id="l9.209">   }</span>
<a href="#l9.210"></a><span id="l9.210"> </span>
<a href="#l9.211"></a><span id="l9.211">   // check if we need to encapsulate the message in a multipart/mixed or multipart/digest</span>
<a href="#l9.212"></a><span id="l9.212">   if (m_attachment_count &gt; multipartRelatedCount)</span>
<a href="#l9.213"></a><span id="l9.213">   {</span>
<a href="#l9.214"></a><span id="l9.214" class="difflineat">@@ -1154,63 +1140,59 @@ nsMsgComposeAndSend::PreProcessPart(nsMs</span>
<a href="#l9.215"></a><span id="l9.215">   // If this was one of those dead parts from a quoted web page,</span>
<a href="#l9.216"></a><span id="l9.216">   // then just return safely.</span>
<a href="#l9.217"></a><span id="l9.217">   //</span>
<a href="#l9.218"></a><span id="l9.218">   if (ma-&gt;m_bogus_attachment)</span>
<a href="#l9.219"></a><span id="l9.219">     return 0;</span>
<a href="#l9.220"></a><span id="l9.220"> </span>
<a href="#l9.221"></a><span id="l9.221">   // If at this point we *still* don't have a content-type, then</span>
<a href="#l9.222"></a><span id="l9.222">   // we're never going to get one.</span>
<a href="#l9.223"></a><span id="l9.223" class="difflineminus">-  if (ma-&gt;m_type == nsnull)</span>
<a href="#l9.224"></a><span id="l9.224" class="difflineminus">-  {</span>
<a href="#l9.225"></a><span id="l9.225" class="difflineminus">-    ma-&gt;m_type = PL_strdup(UNKNOWN_CONTENT_TYPE);</span>
<a href="#l9.226"></a><span id="l9.226" class="difflineminus">-    if (ma-&gt;m_type == nsnull)</span>
<a href="#l9.227"></a><span id="l9.227" class="difflineminus">-      return 0;</span>
<a href="#l9.228"></a><span id="l9.228" class="difflineminus">-  }</span>
<a href="#l9.229"></a><span id="l9.229" class="difflineplus">+  if (ma-&gt;m_type.IsEmpty())</span>
<a href="#l9.230"></a><span id="l9.230" class="difflineplus">+    ma-&gt;m_type = UNKNOWN_CONTENT_TYPE;</span>
<a href="#l9.231"></a><span id="l9.231"> </span>
<a href="#l9.232"></a><span id="l9.232">   ma-&gt;PickEncoding (mCompFields-&gt;GetCharacterSet(), this);</span>
<a href="#l9.233"></a><span id="l9.233">   ma-&gt;PickCharset();</span>
<a href="#l9.234"></a><span id="l9.234"> </span>
<a href="#l9.235"></a><span id="l9.235">   part = new nsMsgSendPart(this);</span>
<a href="#l9.236"></a><span id="l9.236">   if (!part)</span>
<a href="#l9.237"></a><span id="l9.237">     return 0;</span>
<a href="#l9.238"></a><span id="l9.238">   status = toppart-&gt;AddChild(part);</span>
<a href="#l9.239"></a><span id="l9.239">   if (NS_FAILED(status))</span>
<a href="#l9.240"></a><span id="l9.240">     return 0;</span>
<a href="#l9.241"></a><span id="l9.241" class="difflineminus">-  status = part-&gt;SetType(ma-&gt;m_type);</span>
<a href="#l9.242"></a><span id="l9.242" class="difflineplus">+  status = part-&gt;SetType(ma-&gt;m_type.get());</span>
<a href="#l9.243"></a><span id="l9.243">   if (NS_FAILED(status))</span>
<a href="#l9.244"></a><span id="l9.244">     return 0;</span>
<a href="#l9.245"></a><span id="l9.245"> </span>
<a href="#l9.246"></a><span id="l9.246">   nsCString turl;</span>
<a href="#l9.247"></a><span id="l9.247">   if (!ma-&gt;mURL)</span>
<a href="#l9.248"></a><span id="l9.248" class="difflineminus">-    {</span>
<a href="#l9.249"></a><span id="l9.249" class="difflineminus">-      if (ma-&gt;m_uri)</span>
<a href="#l9.250"></a><span id="l9.250" class="difflineminus">-        turl = ma-&gt;m_uri;</span>
<a href="#l9.251"></a><span id="l9.251" class="difflineminus">-    }</span>
<a href="#l9.252"></a><span id="l9.252" class="difflineplus">+  {</span>
<a href="#l9.253"></a><span id="l9.253" class="difflineplus">+    if (!ma-&gt;m_uri.IsEmpty())</span>
<a href="#l9.254"></a><span id="l9.254" class="difflineplus">+      turl = ma-&gt;m_uri;</span>
<a href="#l9.255"></a><span id="l9.255" class="difflineplus">+  }</span>
<a href="#l9.256"></a><span id="l9.256">   else</span>
<a href="#l9.257"></a><span id="l9.257">     ma-&gt;mURL-&gt;GetSpec(turl);</span>
<a href="#l9.258"></a><span id="l9.258" class="difflineminus">-  hdrs = mime_generate_attachment_headers (ma-&gt;m_type,</span>
<a href="#l9.259"></a><span id="l9.259" class="difflineminus">-                                           ma-&gt;m_type_param,</span>
<a href="#l9.260"></a><span id="l9.260" class="difflineminus">-                                           ma-&gt;m_encoding,</span>
<a href="#l9.261"></a><span id="l9.261" class="difflineminus">-                                           ma-&gt;m_description,</span>
<a href="#l9.262"></a><span id="l9.262" class="difflineminus">-                                           ma-&gt;m_x_mac_type,</span>
<a href="#l9.263"></a><span id="l9.263" class="difflineminus">-                                           ma-&gt;m_x_mac_creator,</span>
<a href="#l9.264"></a><span id="l9.264" class="difflineminus">-                                           ma-&gt;m_real_name,</span>
<a href="#l9.265"></a><span id="l9.265" class="difflineplus">+  hdrs = mime_generate_attachment_headers (ma-&gt;m_type.get(),</span>
<a href="#l9.266"></a><span id="l9.266" class="difflineplus">+                                           ma-&gt;m_typeParam.get(),</span>
<a href="#l9.267"></a><span id="l9.267" class="difflineplus">+                                           ma-&gt;m_encoding.get(),</span>
<a href="#l9.268"></a><span id="l9.268" class="difflineplus">+                                           ma-&gt;m_description.get(),</span>
<a href="#l9.269"></a><span id="l9.269" class="difflineplus">+                                           ma-&gt;m_xMacType.get(),</span>
<a href="#l9.270"></a><span id="l9.270" class="difflineplus">+                                           ma-&gt;m_xMacCreator.get(),</span>
<a href="#l9.271"></a><span id="l9.271" class="difflineplus">+                                           ma-&gt;m_realName.get(),</span>
<a href="#l9.272"></a><span id="l9.272">                                            turl.get(),</span>
<a href="#l9.273"></a><span id="l9.273">                                            m_digest_p,</span>
<a href="#l9.274"></a><span id="l9.274">                                            ma,</span>
<a href="#l9.275"></a><span id="l9.275" class="difflineminus">-                                           ma-&gt;m_charset, // rhp - this needs</span>
<a href="#l9.276"></a><span id="l9.276" class="difflineplus">+                                           ma-&gt;m_charset.get(), // rhp - this needs</span>
<a href="#l9.277"></a><span id="l9.277">                                                           // to be the charset</span>
<a href="#l9.278"></a><span id="l9.278">                                                           // we determine from</span>
<a href="#l9.279"></a><span id="l9.279">                                                           // the file or none</span>
<a href="#l9.280"></a><span id="l9.280">                                                           // at all!</span>
<a href="#l9.281"></a><span id="l9.281">                                            mCompFields-&gt;GetCharacterSet(),</span>
<a href="#l9.282"></a><span id="l9.282">                                            PR_FALSE,      // bodyIsAsciiOnly to false</span>
<a href="#l9.283"></a><span id="l9.283">                                                           // for attachments</span>
<a href="#l9.284"></a><span id="l9.284" class="difflineminus">-                                           ma-&gt;m_content_id,</span>
<a href="#l9.285"></a><span id="l9.285" class="difflineplus">+                                           ma-&gt;m_contentId.get(),</span>
<a href="#l9.286"></a><span id="l9.286">                                            PR_FALSE);</span>
<a href="#l9.287"></a><span id="l9.287">   if (!hdrs)</span>
<a href="#l9.288"></a><span id="l9.288">     return 0;</span>
<a href="#l9.289"></a><span id="l9.289"> </span>
<a href="#l9.290"></a><span id="l9.290">   status = part-&gt;SetOtherHeaders(hdrs);</span>
<a href="#l9.291"></a><span id="l9.291">   PR_FREEIF(hdrs);</span>
<a href="#l9.292"></a><span id="l9.292">   if (NS_FAILED(status))</span>
<a href="#l9.293"></a><span id="l9.293">     return 0;</span>
<a href="#l9.294"></a><span id="l9.294" class="difflineat">@@ -1222,19 +1204,18 @@ nsMsgComposeAndSend::PreProcessPart(nsMs</span>
<a href="#l9.295"></a><span id="l9.295">     status = part-&gt;SetEncoderData(ma-&gt;m_encoder_data);</span>
<a href="#l9.296"></a><span id="l9.296">     if (NS_FAILED(status))</span>
<a href="#l9.297"></a><span id="l9.297">       return 0;</span>
<a href="#l9.298"></a><span id="l9.298">     ma-&gt;m_encoder_data = nsnull;</span>
<a href="#l9.299"></a><span id="l9.299">   }</span>
<a href="#l9.300"></a><span id="l9.300"> </span>
<a href="#l9.301"></a><span id="l9.301">   ma-&gt;m_current_column = 0;</span>
<a href="#l9.302"></a><span id="l9.302"> </span>
<a href="#l9.303"></a><span id="l9.303" class="difflineminus">-  if (ma-&gt;m_type &amp;&amp;</span>
<a href="#l9.304"></a><span id="l9.304" class="difflineminus">-      (!PL_strcasecmp (ma-&gt;m_type, MESSAGE_RFC822) ||</span>
<a href="#l9.305"></a><span id="l9.305" class="difflineminus">-      !PL_strcasecmp (ma-&gt;m_type, MESSAGE_NEWS))) {</span>
<a href="#l9.306"></a><span id="l9.306" class="difflineplus">+  if (ma-&gt;m_type.LowerCaseEqualsLiteral(MESSAGE_RFC822) ||</span>
<a href="#l9.307"></a><span id="l9.307" class="difflineplus">+      ma-&gt;m_type.LowerCaseEqualsLiteral(MESSAGE_NEWS)) {</span>
<a href="#l9.308"></a><span id="l9.308">     status = part-&gt;SetStripSensitiveHeaders(PR_TRUE);</span>
<a href="#l9.309"></a><span id="l9.309">     if (NS_FAILED(status))</span>
<a href="#l9.310"></a><span id="l9.310">       return 0;</span>
<a href="#l9.311"></a><span id="l9.311">   }</span>
<a href="#l9.312"></a><span id="l9.312"> </span>
<a href="#l9.313"></a><span id="l9.313">   return 1;</span>
<a href="#l9.314"></a><span id="l9.314"> }</span>
<a href="#l9.315"></a><span id="l9.315"> </span>
<a href="#l9.316"></a><span id="l9.316" class="difflineat">@@ -1342,17 +1323,16 @@ nsMsgComposeAndSend::GetEmbeddedObjectIn</span>
<a href="#l9.317"></a><span id="l9.317">   NS_ENSURE_ARG_POINTER(acceptObject);</span>
<a href="#l9.318"></a><span id="l9.318"> </span>
<a href="#l9.319"></a><span id="l9.319"> // GetEmbeddedObjectInfo will determine if we need to attach the source of the embedded object with the message</span>
<a href="#l9.320"></a><span id="l9.320"> // The decision is made automatically unless the attribute moz-do-not-send has been set to true or false</span>
<a href="#l9.321"></a><span id="l9.321"> // The default rule is that all image and anchor objects are attached as well link to a local file</span>
<a href="#l9.322"></a><span id="l9.322">   nsresult rv;</span>
<a href="#l9.323"></a><span id="l9.323"> </span>
<a href="#l9.324"></a><span id="l9.324">   // Reset this structure to null!</span>
<a href="#l9.325"></a><span id="l9.325" class="difflineminus">-  memset(attachment, 0, sizeof(nsMsgAttachmentData));</span>
<a href="#l9.326"></a><span id="l9.326">   *acceptObject = PR_FALSE;</span>
<a href="#l9.327"></a><span id="l9.327"> </span>
<a href="#l9.328"></a><span id="l9.328">   // Check if the object has a moz-do-not-send attribute set. If it's true,</span>
<a href="#l9.329"></a><span id="l9.329">   // we must ignore it, if false set forceToBeAttached to be true.</span>
<a href="#l9.330"></a><span id="l9.330"> </span>
<a href="#l9.331"></a><span id="l9.331">   PRBool forceToBeAttached = PR_FALSE;</span>
<a href="#l9.332"></a><span id="l9.332">   nsCOMPtr&lt;nsIDOMElement&gt; domElement = do_QueryInterface(node);</span>
<a href="#l9.333"></a><span id="l9.333">   if (domElement)</span>
<a href="#l9.334"></a><span id="l9.334" class="difflineat">@@ -1378,34 +1358,32 @@ nsMsgComposeAndSend::GetEmbeddedObjectIn</span>
<a href="#l9.335"></a><span id="l9.335">   // First, try to see if the body as a background image</span>
<a href="#l9.336"></a><span id="l9.336">   if (body)</span>
<a href="#l9.337"></a><span id="l9.337">   {</span>
<a href="#l9.338"></a><span id="l9.338">     nsAutoString    tUrl;</span>
<a href="#l9.339"></a><span id="l9.339">     if (NS_SUCCEEDED(body-&gt;GetBackground(tUrl)))</span>
<a href="#l9.340"></a><span id="l9.340">     {</span>
<a href="#l9.341"></a><span id="l9.341">       nsCAutoString turlC;</span>
<a href="#l9.342"></a><span id="l9.342">       CopyUTF16toUTF8(tUrl, turlC);</span>
<a href="#l9.343"></a><span id="l9.343" class="difflineminus">-      if (NS_SUCCEEDED(nsMsgNewURL(&amp;attachment-&gt;url, turlC.get())))</span>
<a href="#l9.344"></a><span id="l9.344" class="difflineminus">-        NS_IF_ADDREF(attachment-&gt;url);</span>
<a href="#l9.345"></a><span id="l9.345" class="difflineminus">-      else</span>
<a href="#l9.346"></a><span id="l9.346" class="difflineplus">+      if (NS_FAILED(nsMsgNewURL(getter_AddRefs(attachment-&gt;m_url), turlC.get())))</span>
<a href="#l9.347"></a><span id="l9.347">         return NS_OK;</span>
<a href="#l9.348"></a><span id="l9.348">      }</span>
<a href="#l9.349"></a><span id="l9.349">   }</span>
<a href="#l9.350"></a><span id="l9.350">   else if (image)        // Is this an image?</span>
<a href="#l9.351"></a><span id="l9.351">   {</span>
<a href="#l9.352"></a><span id="l9.352">     nsString    tUrl;</span>
<a href="#l9.353"></a><span id="l9.353">     nsString    tName;</span>
<a href="#l9.354"></a><span id="l9.354">     nsString    tDesc;</span>
<a href="#l9.355"></a><span id="l9.355"> </span>
<a href="#l9.356"></a><span id="l9.356">     // Create the URI</span>
<a href="#l9.357"></a><span id="l9.357">     if (NS_FAILED(image-&gt;GetSrc(tUrl)))</span>
<a href="#l9.358"></a><span id="l9.358">       return NS_ERROR_FAILURE;</span>
<a href="#l9.359"></a><span id="l9.359">     nsCAutoString turlC;</span>
<a href="#l9.360"></a><span id="l9.360">     CopyUTF16toUTF8(tUrl, turlC);</span>
<a href="#l9.361"></a><span id="l9.361" class="difflineminus">-    if (NS_FAILED(nsMsgNewURL(&amp;attachment-&gt;url, turlC.get())))</span>
<a href="#l9.362"></a><span id="l9.362" class="difflineplus">+    if (NS_FAILED(nsMsgNewURL(getter_AddRefs(attachment-&gt;m_url), turlC.get())))</span>
<a href="#l9.363"></a><span id="l9.363">     {</span>
<a href="#l9.364"></a><span id="l9.364">       // Well, the first time failed...which means we probably didn't get</span>
<a href="#l9.365"></a><span id="l9.365">       // the full path name...</span>
<a href="#l9.366"></a><span id="l9.366">       //</span>
<a href="#l9.367"></a><span id="l9.367">       nsIDOMDocument    *ownerDocument = nsnull;</span>
<a href="#l9.368"></a><span id="l9.368">       node-&gt;GetOwnerDocument(&amp;ownerDocument);</span>
<a href="#l9.369"></a><span id="l9.369">       if (ownerDocument)</span>
<a href="#l9.370"></a><span id="l9.370">       {</span>
<a href="#l9.371"></a><span id="l9.371" class="difflineat">@@ -1425,83 +1403,74 @@ nsMsgComposeAndSend::GetEmbeddedObjectIn</span>
<a href="#l9.372"></a><span id="l9.372">         // got from the GetSrc() call....</span>
<a href="#l9.373"></a><span id="l9.373">         NS_ConvertUTF8toUTF16 workURL(spec);</span>
<a href="#l9.374"></a><span id="l9.374"> </span>
<a href="#l9.375"></a><span id="l9.375">         PRInt32 loc = workURL.RFindChar('/');</span>
<a href="#l9.376"></a><span id="l9.376">         if (loc &gt;= 0)</span>
<a href="#l9.377"></a><span id="l9.377">           workURL.SetLength(loc+1);</span>
<a href="#l9.378"></a><span id="l9.378">         workURL.Append(tUrl);</span>
<a href="#l9.379"></a><span id="l9.379">         NS_ConvertUTF16toUTF8 workurlC(workURL);</span>
<a href="#l9.380"></a><span id="l9.380" class="difflineminus">-        if (NS_FAILED(nsMsgNewURL(&amp;attachment-&gt;url, workurlC.get())))</span>
<a href="#l9.381"></a><span id="l9.381" class="difflineminus">-        {</span>
<a href="#l9.382"></a><span id="l9.382" class="difflineplus">+        if (NS_FAILED(nsMsgNewURL(getter_AddRefs(attachment-&gt;m_url), workurlC.get())))</span>
<a href="#l9.383"></a><span id="l9.383">           // rhp - just try to continue and send it without this image.</span>
<a href="#l9.384"></a><span id="l9.384">           return NS_OK;</span>
<a href="#l9.385"></a><span id="l9.385" class="difflineminus">-        }</span>
<a href="#l9.386"></a><span id="l9.386">       }</span>
<a href="#l9.387"></a><span id="l9.387">     }</span>
<a href="#l9.388"></a><span id="l9.388"> </span>
<a href="#l9.389"></a><span id="l9.389" class="difflineminus">-    NS_IF_ADDREF(attachment-&gt;url);</span>
<a href="#l9.390"></a><span id="l9.390" class="difflineminus">-</span>
<a href="#l9.391"></a><span id="l9.391">     rv = image-&gt;GetName(tName);</span>
<a href="#l9.392"></a><span id="l9.392">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.393"></a><span id="l9.393"> </span>
<a href="#l9.394"></a><span id="l9.394" class="difflineminus">-    attachment-&gt;real_name = ToNewCString(NS_LossyConvertUTF16toASCII(tName)); // XXX i18n</span>
<a href="#l9.395"></a><span id="l9.395" class="difflineplus">+    LossyCopyUTF16toASCII(tName, attachment-&gt;m_realName);</span>
<a href="#l9.396"></a><span id="l9.396">     rv = image-&gt;GetLongDesc(tDesc);</span>
<a href="#l9.397"></a><span id="l9.397">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.398"></a><span id="l9.398" class="difflineminus">-    attachment-&gt;description = ToNewCString(NS_LossyConvertUTF16toASCII(tDesc)); // XXX i18n</span>
<a href="#l9.399"></a><span id="l9.399" class="difflineminus">-</span>
<a href="#l9.400"></a><span id="l9.400" class="difflineplus">+    attachment-&gt;m_description = NS_LossyConvertUTF16toASCII(tDesc); // XXX i18n</span>
<a href="#l9.401"></a><span id="l9.401">   }</span>
<a href="#l9.402"></a><span id="l9.402">   else if (link)        // Is this a link?</span>
<a href="#l9.403"></a><span id="l9.403">   {</span>
<a href="#l9.404"></a><span id="l9.404">     nsString    tUrl;</span>
<a href="#l9.405"></a><span id="l9.405"> </span>
<a href="#l9.406"></a><span id="l9.406">     // Create the URI</span>
<a href="#l9.407"></a><span id="l9.407">     rv = link-&gt;GetHref(tUrl);</span>
<a href="#l9.408"></a><span id="l9.408">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.409"></a><span id="l9.409">     nsCAutoString turlC;</span>
<a href="#l9.410"></a><span id="l9.410">     CopyUTF16toUTF8(tUrl, turlC);</span>
<a href="#l9.411"></a><span id="l9.411" class="difflineminus">-    rv = nsMsgNewURL(&amp;attachment-&gt;url, turlC.get());</span>
<a href="#l9.412"></a><span id="l9.412" class="difflineplus">+    rv = nsMsgNewURL(getter_AddRefs(attachment-&gt;m_url), turlC.get());</span>
<a href="#l9.413"></a><span id="l9.413">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.414"></a><span id="l9.414" class="difflineminus">-</span>
<a href="#l9.415"></a><span id="l9.415" class="difflineminus">-    NS_IF_ADDREF(attachment-&gt;url);</span>
<a href="#l9.416"></a><span id="l9.416">   }</span>
<a href="#l9.417"></a><span id="l9.417">   else if (anchor)</span>
<a href="#l9.418"></a><span id="l9.418">   {</span>
<a href="#l9.419"></a><span id="l9.419">     nsString    tUrl;</span>
<a href="#l9.420"></a><span id="l9.420">     nsString    tName;</span>
<a href="#l9.421"></a><span id="l9.421"> </span>
<a href="#l9.422"></a><span id="l9.422">     // Create the URI</span>
<a href="#l9.423"></a><span id="l9.423">     rv = anchor-&gt;GetHref(tUrl);</span>
<a href="#l9.424"></a><span id="l9.424">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.425"></a><span id="l9.425">     nsCAutoString turlC;</span>
<a href="#l9.426"></a><span id="l9.426">     CopyUTF16toUTF8(tUrl, turlC);</span>
<a href="#l9.427"></a><span id="l9.427" class="difflineminus">-    rv = nsMsgNewURL(&amp;attachment-&gt;url, turlC.get());</span>
<a href="#l9.428"></a><span id="l9.428" class="difflineplus">+    rv = nsMsgNewURL(getter_AddRefs(attachment-&gt;m_url), turlC.get());</span>
<a href="#l9.429"></a><span id="l9.429">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.430"></a><span id="l9.430"> </span>
<a href="#l9.431"></a><span id="l9.431" class="difflineminus">-    NS_IF_ADDREF(attachment-&gt;url);</span>
<a href="#l9.432"></a><span id="l9.432" class="difflineminus">-</span>
<a href="#l9.433"></a><span id="l9.433">     rv = anchor-&gt;GetName(tName);</span>
<a href="#l9.434"></a><span id="l9.434">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.435"></a><span id="l9.435" class="difflineminus">-    attachment-&gt;real_name = ToNewCString(NS_LossyConvertUTF16toASCII(tName));</span>
<a href="#l9.436"></a><span id="l9.436" class="difflineplus">+    LossyCopyUTF16toASCII(tName, attachment-&gt;m_realName);</span>
<a href="#l9.437"></a><span id="l9.437">   }</span>
<a href="#l9.438"></a><span id="l9.438">   else</span>
<a href="#l9.439"></a><span id="l9.439">   {</span>
<a href="#l9.440"></a><span id="l9.440">     // If we get here, we got something we didn't expect!</span>
<a href="#l9.441"></a><span id="l9.441">     // Just try to continue and send it without this thing.</span>
<a href="#l9.442"></a><span id="l9.442">     return NS_OK;</span>
<a href="#l9.443"></a><span id="l9.443">   }</span>
<a href="#l9.444"></a><span id="l9.444"> </span>
<a href="#l9.445"></a><span id="l9.445">   //</span>
<a href="#l9.446"></a><span id="l9.446">   // Before going further, check if we are dealing with a local file and</span>
<a href="#l9.447"></a><span id="l9.447">   // if it's the case be sure the file exist!</span>
<a href="#l9.448"></a><span id="l9.448">   PRBool schemeIsFile = PR_FALSE;</span>
<a href="#l9.449"></a><span id="l9.449" class="difflineminus">-  rv = attachment-&gt;url-&gt;SchemeIs(&quot;file&quot;, &amp;schemeIsFile);</span>
<a href="#l9.450"></a><span id="l9.450" class="difflineplus">+  rv = attachment-&gt;m_url-&gt;SchemeIs(&quot;file&quot;, &amp;schemeIsFile);</span>
<a href="#l9.451"></a><span id="l9.451">   if (NS_SUCCEEDED(rv) &amp;&amp; schemeIsFile)</span>
<a href="#l9.452"></a><span id="l9.452">   {</span>
<a href="#l9.453"></a><span id="l9.453" class="difflineminus">-    nsCOMPtr&lt;nsIFileURL&gt; fileUrl (do_QueryInterface(attachment-&gt;url));</span>
<a href="#l9.454"></a><span id="l9.454" class="difflineplus">+    nsCOMPtr&lt;nsIFileURL&gt; fileUrl (do_QueryInterface(attachment-&gt;m_url));</span>
<a href="#l9.455"></a><span id="l9.455">     if (fileUrl)</span>
<a href="#l9.456"></a><span id="l9.456">     {</span>
<a href="#l9.457"></a><span id="l9.457">       PRBool isAValidFile = PR_FALSE;</span>
<a href="#l9.458"></a><span id="l9.458"> </span>
<a href="#l9.459"></a><span id="l9.459">       nsCOMPtr&lt;nsIFile&gt; aFile;</span>
<a href="#l9.460"></a><span id="l9.460">       rv = fileUrl-&gt;GetFile(getter_AddRefs(aFile));</span>
<a href="#l9.461"></a><span id="l9.461">       if (NS_SUCCEEDED(rv) &amp;&amp; aFile)</span>
<a href="#l9.462"></a><span id="l9.462">       {</span>
<a href="#l9.463"></a><span id="l9.463" class="difflineat">@@ -1513,17 +1482,17 @@ nsMsgComposeAndSend::GetEmbeddedObjectIn</span>
<a href="#l9.464"></a><span id="l9.464">             isAValidFile = PR_FALSE;</span>
<a href="#l9.465"></a><span id="l9.465">           else</span>
<a href="#l9.466"></a><span id="l9.466">           {</span>
<a href="#l9.467"></a><span id="l9.467">             if (anchor)</span>
<a href="#l9.468"></a><span id="l9.468">             {</span>
<a href="#l9.469"></a><span id="l9.469">               // One more test, if the anchor points to a local network server, let's check what the pref</span>
<a href="#l9.470"></a><span id="l9.470">               // mail.compose.dont_attach_source_of_local_network_links tells us to do.</span>
<a href="#l9.471"></a><span id="l9.471">               nsCAutoString urlSpec;</span>
<a href="#l9.472"></a><span id="l9.472" class="difflineminus">-              rv = attachment-&gt;url-&gt;GetSpec(urlSpec);</span>
<a href="#l9.473"></a><span id="l9.473" class="difflineplus">+              rv = attachment-&gt;m_url-&gt;GetSpec(urlSpec);</span>
<a href="#l9.474"></a><span id="l9.474">               if (NS_SUCCEEDED(rv))</span>
<a href="#l9.475"></a><span id="l9.475">                 if (StringBeginsWith(urlSpec, NS_LITERAL_CSTRING(&quot;file://///&quot;)))</span>
<a href="#l9.476"></a><span id="l9.476">                 {</span>
<a href="#l9.477"></a><span id="l9.477">                   nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l9.478"></a><span id="l9.478">                   if (pPrefBranch)</span>
<a href="#l9.479"></a><span id="l9.479">                   {</span>
<a href="#l9.480"></a><span id="l9.480">                     PRBool dontSend = PR_FALSE;</span>
<a href="#l9.481"></a><span id="l9.481">                     rv = pPrefBranch-&gt;GetBoolPref(PREF_MAIL_DONT_ATTACH_SOURCE, &amp;dontSend);</span>
<a href="#l9.482"></a><span id="l9.482" class="difflineat">@@ -1580,17 +1549,16 @@ nsMsgComposeAndSend::GetMultipartRelated</span>
<a href="#l9.483"></a><span id="l9.483"> </span>
<a href="#l9.484"></a><span id="l9.484">       PRInt32 i;</span>
<a href="#l9.485"></a><span id="l9.485">       nsCOMPtr&lt;nsIDOMNode&gt; node;</span>
<a href="#l9.486"></a><span id="l9.486">       nsCOMPtr &lt;nsISupports&gt; isupp;</span>
<a href="#l9.487"></a><span id="l9.487"> </span>
<a href="#l9.488"></a><span id="l9.488">       for (i = count - 1, count = 0; i &gt;= 0; i --)</span>
<a href="#l9.489"></a><span id="l9.489">       {</span>
<a href="#l9.490"></a><span id="l9.490">         // Reset this structure to null!</span>
<a href="#l9.491"></a><span id="l9.491" class="difflineminus">-        memset(&amp;attachment, 0, sizeof(nsMsgAttachmentData));</span>
<a href="#l9.492"></a><span id="l9.492"> </span>
<a href="#l9.493"></a><span id="l9.493">         // now we need to get the element in the array and do the magic</span>
<a href="#l9.494"></a><span id="l9.494">         // to process this element.</span>
<a href="#l9.495"></a><span id="l9.495">         //</span>
<a href="#l9.496"></a><span id="l9.496">         mEmbeddedObjectList-&gt;QueryElementAt(i, NS_GET_IID(nsIDOMNode), getter_AddRefs(node));</span>
<a href="#l9.497"></a><span id="l9.497">         if (!node)</span>
<a href="#l9.498"></a><span id="l9.498">           continue;</span>
<a href="#l9.499"></a><span id="l9.499"> </span>
<a href="#l9.500"></a><span id="l9.500" class="difflineat">@@ -1897,19 +1865,16 @@ nsMsgComposeAndSend::ProcessMultipartRel</span>
<a href="#l9.501"></a><span id="l9.501">     if (!domSaveArray)</span>
<a href="#l9.502"></a><span id="l9.502">       return NS_ERROR_MIME_MPART_ATTACHMENT_ERROR;</span>
<a href="#l9.503"></a><span id="l9.503">     memset(domSaveArray, 0, sizeof(domSaveStruct) * multipartCount);</span>
<a href="#l9.504"></a><span id="l9.504">   }</span>
<a href="#l9.505"></a><span id="l9.505"> </span>
<a href="#l9.506"></a><span id="l9.506">   nsCOMPtr&lt;nsIDOMNode&gt; node;</span>
<a href="#l9.507"></a><span id="l9.507">   for (i = mPreloadedAttachmentCount; i &lt; (mPreloadedAttachmentCount + multipartCount); i++)</span>
<a href="#l9.508"></a><span id="l9.508">   {</span>
<a href="#l9.509"></a><span id="l9.509" class="difflineminus">-    // Reset this structure to null!</span>
<a href="#l9.510"></a><span id="l9.510" class="difflineminus">-    memset(&amp;attachment, 0, sizeof(nsMsgAttachmentData));</span>
<a href="#l9.511"></a><span id="l9.511" class="difflineminus">-</span>
<a href="#l9.512"></a><span id="l9.512">     // MUST set this to get placed in the correct part of the message</span>
<a href="#l9.513"></a><span id="l9.513">     m_attachments[i].mMHTMLPart = PR_TRUE;</span>
<a href="#l9.514"></a><span id="l9.514"> </span>
<a href="#l9.515"></a><span id="l9.515">     locCount++;</span>
<a href="#l9.516"></a><span id="l9.516">     m_attachments[i].mDeleteFile = PR_TRUE;</span>
<a href="#l9.517"></a><span id="l9.517">     m_attachments[i].m_done = PR_FALSE;</span>
<a href="#l9.518"></a><span id="l9.518">     m_attachments[i].SetMimeDeliveryState(this);</span>
<a href="#l9.519"></a><span id="l9.519"> </span>
<a href="#l9.520"></a><span id="l9.520" class="difflineat">@@ -1931,64 +1896,52 @@ nsMsgComposeAndSend::ProcessMultipartRel</span>
<a href="#l9.521"></a><span id="l9.521">     j++;</span>
<a href="#l9.522"></a><span id="l9.522">     domSaveArray[j].node = node;</span>
<a href="#l9.523"></a><span id="l9.523"> </span>
<a href="#l9.524"></a><span id="l9.524">     // check if we have alreay attached this object, don't need to attach it twice</span>
<a href="#l9.525"></a><span id="l9.525">     duplicateOf = -1;</span>
<a href="#l9.526"></a><span id="l9.526">     for (k = mPreloadedAttachmentCount; k &lt; i; k++)</span>
<a href="#l9.527"></a><span id="l9.527">     {</span>
<a href="#l9.528"></a><span id="l9.528">       PRBool isEqual = PR_FALSE;</span>
<a href="#l9.529"></a><span id="l9.529" class="difflineminus">-      (void)attachment.url-&gt;Equals(m_attachments[k].mURL, &amp;isEqual);</span>
<a href="#l9.530"></a><span id="l9.530" class="difflineplus">+      (void)attachment.m_url-&gt;Equals(m_attachments[k].mURL, &amp;isEqual);</span>
<a href="#l9.531"></a><span id="l9.531">       if (isEqual)</span>
<a href="#l9.532"></a><span id="l9.532">       {</span>
<a href="#l9.533"></a><span id="l9.533">         duplicateOf = k;</span>
<a href="#l9.534"></a><span id="l9.534">         break;</span>
<a href="#l9.535"></a><span id="l9.535">       }</span>
<a href="#l9.536"></a><span id="l9.536">     }</span>
<a href="#l9.537"></a><span id="l9.537"> </span>
<a href="#l9.538"></a><span id="l9.538">     if (duplicateOf == -1)</span>
<a href="#l9.539"></a><span id="l9.539">     {</span>
<a href="#l9.540"></a><span id="l9.540">       //</span>
<a href="#l9.541"></a><span id="l9.541">       // Now we have to get all of the interesting information from</span>
<a href="#l9.542"></a><span id="l9.542">       // the nsIDOMNode we have in hand...</span>
<a href="#l9.543"></a><span id="l9.543" class="difflineminus">-      m_attachments[i].mURL = attachment.url;</span>
<a href="#l9.544"></a><span id="l9.544" class="difflineminus">-</span>
<a href="#l9.545"></a><span id="l9.545" class="difflineminus">-      PR_FREEIF(m_attachments[i].m_override_type);</span>
<a href="#l9.546"></a><span id="l9.546" class="difflineminus">-      m_attachments[i].m_override_type = PL_strdup (attachment.real_type);</span>
<a href="#l9.547"></a><span id="l9.547" class="difflineminus">-      PR_FREEIF(m_attachments[i].m_override_encoding);</span>
<a href="#l9.548"></a><span id="l9.548" class="difflineminus">-      m_attachments[i].m_override_encoding = PL_strdup (attachment.real_encoding);</span>
<a href="#l9.549"></a><span id="l9.549" class="difflineminus">-      PR_FREEIF(m_attachments[i].m_desired_type);</span>
<a href="#l9.550"></a><span id="l9.550" class="difflineminus">-      m_attachments[i].m_desired_type = PL_strdup (attachment.desired_type);</span>
<a href="#l9.551"></a><span id="l9.551" class="difflineminus">-      PR_FREEIF(m_attachments[i].m_description);</span>
<a href="#l9.552"></a><span id="l9.552" class="difflineminus">-      m_attachments[i].m_description = PL_strdup (attachment.description);</span>
<a href="#l9.553"></a><span id="l9.553" class="difflineminus">-      PR_FREEIF(m_attachments[i].m_real_name);</span>
<a href="#l9.554"></a><span id="l9.554" class="difflineminus">-      m_attachments[i].m_real_name = PL_strdup (attachment.real_name);</span>
<a href="#l9.555"></a><span id="l9.555" class="difflineminus">-      PR_FREEIF(m_attachments[i].m_x_mac_type);</span>
<a href="#l9.556"></a><span id="l9.556" class="difflineminus">-      m_attachments[i].m_x_mac_type = PL_strdup (attachment.x_mac_type);</span>
<a href="#l9.557"></a><span id="l9.557" class="difflineminus">-      PR_FREEIF(m_attachments[i].m_x_mac_creator);</span>
<a href="#l9.558"></a><span id="l9.558" class="difflineminus">-      m_attachments[i].m_x_mac_creator = PL_strdup (attachment.x_mac_creator);</span>
<a href="#l9.559"></a><span id="l9.559" class="difflineminus">-</span>
<a href="#l9.560"></a><span id="l9.560" class="difflineminus">-      PR_FREEIF(m_attachments[i].m_charset);</span>
<a href="#l9.561"></a><span id="l9.561" class="difflineminus">-      m_attachments[i].m_charset = PL_strdup (mCompFields-&gt;GetCharacterSet());</span>
<a href="#l9.562"></a><span id="l9.562" class="difflineminus">-      PR_FREEIF(m_attachments[i].m_encoding);</span>
<a href="#l9.563"></a><span id="l9.563" class="difflineminus">-      m_attachments[i].m_encoding = PL_strdup (&quot;7bit&quot;);</span>
<a href="#l9.564"></a><span id="l9.564" class="difflineplus">+      m_attachments[i].mURL = attachment.m_url;</span>
<a href="#l9.565"></a><span id="l9.565" class="difflineplus">+</span>
<a href="#l9.566"></a><span id="l9.566" class="difflineplus">+      m_attachments[i].m_overrideType = attachment.m_realType;</span>
<a href="#l9.567"></a><span id="l9.567" class="difflineplus">+      m_attachments[i].m_overrideEncoding = attachment.m_realEncoding;</span>
<a href="#l9.568"></a><span id="l9.568" class="difflineplus">+      m_attachments[i].m_desiredType = attachment.m_desiredType;</span>
<a href="#l9.569"></a><span id="l9.569" class="difflineplus">+      m_attachments[i].m_description = attachment.m_description;</span>
<a href="#l9.570"></a><span id="l9.570" class="difflineplus">+      m_attachments[i].m_realName = attachment.m_realName;</span>
<a href="#l9.571"></a><span id="l9.571" class="difflineplus">+      m_attachments[i].m_xMacType = attachment.m_xMacType;</span>
<a href="#l9.572"></a><span id="l9.572" class="difflineplus">+      m_attachments[i].m_xMacCreator = attachment.m_xMacCreator;</span>
<a href="#l9.573"></a><span id="l9.573" class="difflineplus">+</span>
<a href="#l9.574"></a><span id="l9.574" class="difflineplus">+      m_attachments[i].m_charset = mCompFields-&gt;GetCharacterSet();</span>
<a href="#l9.575"></a><span id="l9.575" class="difflineplus">+      m_attachments[i].m_encoding = &quot;7bit&quot;;</span>
<a href="#l9.576"></a><span id="l9.576"> </span>
<a href="#l9.577"></a><span id="l9.577">       if (m_attachments[i].mURL)</span>
<a href="#l9.578"></a><span id="l9.578">         msg_pick_real_name(&amp;m_attachments[i], nsnull, mCompFields-&gt;GetCharacterSet());</span>
<a href="#l9.579"></a><span id="l9.579"> </span>
<a href="#l9.580"></a><span id="l9.580">       //</span>
<a href="#l9.581"></a><span id="l9.581">       // Next, generate a content id for use with this part</span>
<a href="#l9.582"></a><span id="l9.582">       //</span>
<a href="#l9.583"></a><span id="l9.583">       nsCString email;</span>
<a href="#l9.584"></a><span id="l9.584">       mUserIdentity-&gt;GetEmail(email);</span>
<a href="#l9.585"></a><span id="l9.585">       email.StripWhitespace();</span>
<a href="#l9.586"></a><span id="l9.586" class="difflineminus">-      m_attachments[i].m_content_id = mime_gen_content_id(locCount+1, email.get());</span>
<a href="#l9.587"></a><span id="l9.587" class="difflineminus">-</span>
<a href="#l9.588"></a><span id="l9.588" class="difflineminus">-      if (!m_attachments[i].m_content_id)</span>
<a href="#l9.589"></a><span id="l9.589" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l9.590"></a><span id="l9.590" class="difflineplus">+      m_attachments[i].m_contentId = mime_gen_content_id(locCount+1, email.get());</span>
<a href="#l9.591"></a><span id="l9.591"> </span>
<a href="#l9.592"></a><span id="l9.592">       //</span>
<a href="#l9.593"></a><span id="l9.593">       // Start counting the attachments which are going to come from mail folders</span>
<a href="#l9.594"></a><span id="l9.594">       // and from NNTP servers.</span>
<a href="#l9.595"></a><span id="l9.595">       //</span>
<a href="#l9.596"></a><span id="l9.596">       if (m_attachments[i].mURL)</span>
<a href="#l9.597"></a><span id="l9.597">       {</span>
<a href="#l9.598"></a><span id="l9.598">         nsIURI *uri = m_attachments[i].mURL;</span>
<a href="#l9.599"></a><span id="l9.599" class="difflineat">@@ -1997,35 +1950,26 @@ nsMsgComposeAndSend::ProcessMultipartRel</span>
<a href="#l9.600"></a><span id="l9.600">            (NS_SUCCEEDED(uri-&gt;SchemeIs(&quot;imap&quot;, &amp;match)) &amp;&amp; match))</span>
<a href="#l9.601"></a><span id="l9.601">           (*aMailboxCount)++;</span>
<a href="#l9.602"></a><span id="l9.602">         else if ((NS_SUCCEEDED(uri-&gt;SchemeIs(&quot;news&quot;, &amp;match)) &amp;&amp; match) ||</span>
<a href="#l9.603"></a><span id="l9.603">                 (NS_SUCCEEDED(uri-&gt;SchemeIs(&quot;snews&quot;, &amp;match)) &amp;&amp; match))</span>
<a href="#l9.604"></a><span id="l9.604">           (*aNewsCount)++;</span>
<a href="#l9.605"></a><span id="l9.605">       }</span>
<a href="#l9.606"></a><span id="l9.606">     }</span>
<a href="#l9.607"></a><span id="l9.607"> </span>
<a href="#l9.608"></a><span id="l9.608" class="difflineminus">-    // Ok, cleanup the temp structure...</span>
<a href="#l9.609"></a><span id="l9.609" class="difflineminus">-    PR_Free(attachment.real_name);</span>
<a href="#l9.610"></a><span id="l9.610" class="difflineminus">-    PR_Free(attachment.description);</span>
<a href="#l9.611"></a><span id="l9.611" class="difflineminus">-    PR_Free(attachment.real_type);</span>
<a href="#l9.612"></a><span id="l9.612" class="difflineminus">-    PR_Free(attachment.real_encoding);</span>
<a href="#l9.613"></a><span id="l9.613" class="difflineminus">-    PR_Free(attachment.desired_type);</span>
<a href="#l9.614"></a><span id="l9.614" class="difflineminus">-    PR_Free(attachment.x_mac_type);</span>
<a href="#l9.615"></a><span id="l9.615" class="difflineminus">-    PR_Free(attachment.x_mac_creator);</span>
<a href="#l9.616"></a><span id="l9.616" class="difflineminus">-</span>
<a href="#l9.617"></a><span id="l9.617">     //</span>
<a href="#l9.618"></a><span id="l9.618">     // Ok, while we are here, we should whack the DOM with the generated</span>
<a href="#l9.619"></a><span id="l9.619">     // Content-ID for this object. This will be necessary for generating</span>
<a href="#l9.620"></a><span id="l9.620">     // the HTML we need.</span>
<a href="#l9.621"></a><span id="l9.621">     //</span>
<a href="#l9.622"></a><span id="l9.622">     nsString domURL;</span>
<a href="#l9.623"></a><span id="l9.623" class="difflineminus">-    if (m_attachments[duplicateOf == -1 ? i : duplicateOf].m_content_id)</span>
<a href="#l9.624"></a><span id="l9.624" class="difflineplus">+    if (!m_attachments[duplicateOf == -1 ? i : duplicateOf].m_contentId.IsEmpty())</span>
<a href="#l9.625"></a><span id="l9.625">     {</span>
<a href="#l9.626"></a><span id="l9.626">       nsString   newSpec(NS_LITERAL_STRING(&quot;cid:&quot;));</span>
<a href="#l9.627"></a><span id="l9.627" class="difflineminus">-      newSpec.Append(NS_ConvertASCIItoUTF16(m_attachments[duplicateOf == -1 ? i : duplicateOf].m_content_id));</span>
<a href="#l9.628"></a><span id="l9.628" class="difflineplus">+      newSpec.Append(NS_ConvertASCIItoUTF16(m_attachments[duplicateOf == -1 ? i : duplicateOf].m_contentId));</span>
<a href="#l9.629"></a><span id="l9.629"> </span>
<a href="#l9.630"></a><span id="l9.630">       // Now, we know the types of objects this node can be, so we will do</span>
<a href="#l9.631"></a><span id="l9.631">       // our query interface here and see what we come up with</span>
<a href="#l9.632"></a><span id="l9.632">       nsCOMPtr&lt;nsIDOMHTMLBodyElement&gt;     body = (do_QueryInterface(domSaveArray[j].node));</span>
<a href="#l9.633"></a><span id="l9.633">       nsCOMPtr&lt;nsIDOMHTMLImageElement&gt;    image = (do_QueryInterface(domSaveArray[j].node));</span>
<a href="#l9.634"></a><span id="l9.634">       nsCOMPtr&lt;nsIDOMHTMLLinkElement&gt;     link = (do_QueryInterface(domSaveArray[j].node));</span>
<a href="#l9.635"></a><span id="l9.635">       nsCOMPtr&lt;nsIDOMHTMLAnchorElement&gt;   anchor = (do_QueryInterface(domSaveArray[j].node));</span>
<a href="#l9.636"></a><span id="l9.636"> </span>
<a href="#l9.637"></a><span id="l9.637" class="difflineat">@@ -2236,105 +2180,99 @@ nsMsgComposeAndSend::AddCompFieldLocalAt</span>
<a href="#l9.638"></a><span id="l9.638"> </span>
<a href="#l9.639"></a><span id="l9.639">   #ifdef MAC_OSX</span>
<a href="#l9.640"></a><span id="l9.640">           //Mac always need to snarf the file to figure out how to send it, maybe we need to use apple double...</span>
<a href="#l9.641"></a><span id="l9.641">           //  unless caller has already set the content type, in which case, trust them.</span>
<a href="#l9.642"></a><span id="l9.642">           PRBool mustSnarfAttachment = PR_TRUE;</span>
<a href="#l9.643"></a><span id="l9.643">   #else</span>
<a href="#l9.644"></a><span id="l9.644">           PRBool mustSnarfAttachment = PR_FALSE;</span>
<a href="#l9.645"></a><span id="l9.645">   #endif</span>
<a href="#l9.646"></a><span id="l9.646" class="difflineminus">-          PR_FREEIF(m_attachments[newLoc].m_type);</span>
<a href="#l9.647"></a><span id="l9.647" class="difflineminus">-          attachment-&gt;GetContentType(&amp;m_attachments[newLoc].m_type);</span>
<a href="#l9.648"></a><span id="l9.648" class="difflineminus">-          if (!m_attachments[newLoc].m_type || !(*m_attachments[newLoc].m_type))</span>
<a href="#l9.649"></a><span id="l9.649" class="difflineplus">+          attachment-&gt;GetContentType(getter_Copies(m_attachments[newLoc].m_type));</span>
<a href="#l9.650"></a><span id="l9.650" class="difflineplus">+          if (m_attachments[newLoc].m_type.IsEmpty())</span>
<a href="#l9.651"></a><span id="l9.651">           {</span>
<a href="#l9.652"></a><span id="l9.652">             nsresult  rv = NS_OK;</span>
<a href="#l9.653"></a><span id="l9.653">             nsCOMPtr&lt;nsIMIMEService&gt; mimeFinder (do_GetService(NS_MIMESERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l9.654"></a><span id="l9.654">             if (NS_SUCCEEDED(rv) &amp;&amp; mimeFinder)</span>
<a href="#l9.655"></a><span id="l9.655">             {</span>
<a href="#l9.656"></a><span id="l9.656">               nsCOMPtr&lt;nsIURL&gt; fileUrl(do_CreateInstance(NS_STANDARDURL_CONTRACTID));</span>
<a href="#l9.657"></a><span id="l9.657">               if (fileUrl)</span>
<a href="#l9.658"></a><span id="l9.658">               {</span>
<a href="#l9.659"></a><span id="l9.659">                 nsCAutoString fileExt;</span>
<a href="#l9.660"></a><span id="l9.660">                 //First try using the real file name</span>
<a href="#l9.661"></a><span id="l9.661" class="difflineminus">-                rv = fileUrl-&gt;SetFileName(nsDependentCString(m_attachments[newLoc].m_real_name));</span>
<a href="#l9.662"></a><span id="l9.662" class="difflineplus">+                rv = fileUrl-&gt;SetFileName(m_attachments[newLoc].m_realName);</span>
<a href="#l9.663"></a><span id="l9.663">                 if (NS_SUCCEEDED(rv))</span>
<a href="#l9.664"></a><span id="l9.664">                 {</span>
<a href="#l9.665"></a><span id="l9.665">                   rv = fileUrl-&gt;GetFileExtension(fileExt);</span>
<a href="#l9.666"></a><span id="l9.666">                   if (NS_SUCCEEDED(rv) &amp;&amp; !fileExt.IsEmpty()) {</span>
<a href="#l9.667"></a><span id="l9.667">                     nsCAutoString type;</span>
<a href="#l9.668"></a><span id="l9.668">                     mimeFinder-&gt;GetTypeFromExtension(fileExt, type);</span>
<a href="#l9.669"></a><span id="l9.669">   #ifndef XP_MACOSX</span>
<a href="#l9.670"></a><span id="l9.670">                     if (!type.Equals(&quot;multipart/appledouble&quot;))  // can't do apple double on non-macs</span>
<a href="#l9.671"></a><span id="l9.671">   #endif</span>
<a href="#l9.672"></a><span id="l9.672" class="difflineminus">-                    m_attachments[newLoc].m_type = ToNewCString(type);</span>
<a href="#l9.673"></a><span id="l9.673" class="difflineplus">+                    m_attachments[newLoc].m_type = type;</span>
<a href="#l9.674"></a><span id="l9.674">                   }</span>
<a href="#l9.675"></a><span id="l9.675">                 }</span>
<a href="#l9.676"></a><span id="l9.676"> </span>
<a href="#l9.677"></a><span id="l9.677">                 //Then try using the url if we still haven't figured out the content type</span>
<a href="#l9.678"></a><span id="l9.678" class="difflineminus">-                if ((!m_attachments[newLoc].m_type) ||  (!*m_attachments[newLoc].m_type))</span>
<a href="#l9.679"></a><span id="l9.679" class="difflineplus">+                if (m_attachments[newLoc].m_type.IsEmpty())</span>
<a href="#l9.680"></a><span id="l9.680">                 {</span>
<a href="#l9.681"></a><span id="l9.681">                   rv = fileUrl-&gt;SetSpec(url);</span>
<a href="#l9.682"></a><span id="l9.682">                   if (NS_SUCCEEDED(rv))</span>
<a href="#l9.683"></a><span id="l9.683">                   {</span>
<a href="#l9.684"></a><span id="l9.684">                     rv = fileUrl-&gt;GetFileExtension(fileExt);</span>
<a href="#l9.685"></a><span id="l9.685">                     if (NS_SUCCEEDED(rv) &amp;&amp; !fileExt.IsEmpty()) {</span>
<a href="#l9.686"></a><span id="l9.686">                       nsCAutoString type;</span>
<a href="#l9.687"></a><span id="l9.687">                       mimeFinder-&gt;GetTypeFromExtension(fileExt, type);</span>
<a href="#l9.688"></a><span id="l9.688">   #ifndef XP_MACOSX</span>
<a href="#l9.689"></a><span id="l9.689">                     if (!type.Equals(&quot;multipart/appledouble&quot;))  // can't do apple double on non-macs</span>
<a href="#l9.690"></a><span id="l9.690">   #endif</span>
<a href="#l9.691"></a><span id="l9.691" class="difflineminus">-                      m_attachments[newLoc].m_type = ToNewCString(type);</span>
<a href="#l9.692"></a><span id="l9.692" class="difflineplus">+                      m_attachments[newLoc].m_type = type;</span>
<a href="#l9.693"></a><span id="l9.693">                     // rtf and vcs files may look like text to sniffers,</span>
<a href="#l9.694"></a><span id="l9.694">                     // but they're not human readable.</span>
<a href="#l9.695"></a><span id="l9.695">                     if (type.IsEmpty() &amp;&amp; !fileExt.IsEmpty() &amp;&amp;</span>
<a href="#l9.696"></a><span id="l9.696">                          (MsgLowerCaseEqualsLiteral(fileExt, &quot;rtf&quot;) ||</span>
<a href="#l9.697"></a><span id="l9.697">                           MsgLowerCaseEqualsLiteral(fileExt, &quot;vcs&quot;)))</span>
<a href="#l9.698"></a><span id="l9.698" class="difflineminus">-                      m_attachments[newLoc].m_type = PL_strdup(APPLICATION_OCTET_STREAM);</span>
<a href="#l9.699"></a><span id="l9.699" class="difflineplus">+                      m_attachments[newLoc].m_type = APPLICATION_OCTET_STREAM;</span>
<a href="#l9.700"></a><span id="l9.700">                     }</span>
<a href="#l9.701"></a><span id="l9.701">                   }</span>
<a href="#l9.702"></a><span id="l9.702">                 }</span>
<a href="#l9.703"></a><span id="l9.703">               }</span>
<a href="#l9.704"></a><span id="l9.704">             }</span>
<a href="#l9.705"></a><span id="l9.705">           }</span>
<a href="#l9.706"></a><span id="l9.706">           else</span>
<a href="#l9.707"></a><span id="l9.707">           {</span>
<a href="#l9.708"></a><span id="l9.708" class="difflineminus">-            attachment-&gt;GetContentTypeParam(&amp;m_attachments[newLoc].m_type_param);</span>
<a href="#l9.709"></a><span id="l9.709" class="difflineplus">+            attachment-&gt;GetContentTypeParam(getter_Copies(m_attachments[newLoc].m_typeParam));</span>
<a href="#l9.710"></a><span id="l9.710">             mustSnarfAttachment = PR_FALSE;</span>
<a href="#l9.711"></a><span id="l9.711">           }</span>
<a href="#l9.712"></a><span id="l9.712"> </span>
<a href="#l9.713"></a><span id="l9.713">           //We need to snarf the file to figure out how to send it only if we don't have a content type...</span>
<a href="#l9.714"></a><span id="l9.714" class="difflineminus">-          if (mustSnarfAttachment || (!m_attachments[newLoc].m_type) || (!*m_attachments[newLoc].m_type))</span>
<a href="#l9.715"></a><span id="l9.715" class="difflineplus">+          if (mustSnarfAttachment || m_attachments[newLoc].m_type.IsEmpty())</span>
<a href="#l9.716"></a><span id="l9.716">           {</span>
<a href="#l9.717"></a><span id="l9.717">             m_attachments[newLoc].m_done = PR_FALSE;</span>
<a href="#l9.718"></a><span id="l9.718">             m_attachments[newLoc].SetMimeDeliveryState(this);</span>
<a href="#l9.719"></a><span id="l9.719">           }</span>
<a href="#l9.720"></a><span id="l9.720">           else</span>
<a href="#l9.721"></a><span id="l9.721">           {</span>
<a href="#l9.722"></a><span id="l9.722">             m_attachments[newLoc].m_done = PR_TRUE;</span>
<a href="#l9.723"></a><span id="l9.723">             m_attachments[newLoc].SetMimeDeliveryState(nsnull);</span>
<a href="#l9.724"></a><span id="l9.724">           }</span>
<a href="#l9.725"></a><span id="l9.725">           // For local files, if they are HTML docs and we don't have a charset, we should</span>
<a href="#l9.726"></a><span id="l9.726">           // sniff the file and see if we can figure it out.</span>
<a href="#l9.727"></a><span id="l9.727" class="difflineminus">-          if ( (m_attachments[newLoc].m_type) &amp;&amp;  (*m_attachments[newLoc].m_type) )</span>
<a href="#l9.728"></a><span id="l9.728" class="difflineplus">+          if (!m_attachments[newLoc].m_type.IsEmpty())</span>
<a href="#l9.729"></a><span id="l9.729">           {</span>
<a href="#l9.730"></a><span id="l9.730" class="difflineminus">-            if (PL_strcasecmp(m_attachments[newLoc].m_type, TEXT_HTML) == 0)</span>
<a href="#l9.731"></a><span id="l9.731" class="difflineplus">+            if (m_attachments[newLoc].m_type.LowerCaseEqualsLiteral(TEXT_HTML))</span>
<a href="#l9.732"></a><span id="l9.732">             {</span>
<a href="#l9.733"></a><span id="l9.733">               char *tmpCharset = (char *)nsMsgI18NParseMetaCharset(m_attachments[newLoc].mTmpFile);</span>
<a href="#l9.734"></a><span id="l9.734">               if (tmpCharset[0] != '\0')</span>
<a href="#l9.735"></a><span id="l9.735" class="difflineminus">-              {</span>
<a href="#l9.736"></a><span id="l9.736" class="difflineminus">-                PR_FREEIF(m_attachments[newLoc].m_charset);</span>
<a href="#l9.737"></a><span id="l9.737" class="difflineminus">-                m_attachments[newLoc].m_charset = PL_strdup(tmpCharset);</span>
<a href="#l9.738"></a><span id="l9.738" class="difflineminus">-              }</span>
<a href="#l9.739"></a><span id="l9.739" class="difflineplus">+                m_attachments[newLoc].m_charset = tmpCharset;</span>
<a href="#l9.740"></a><span id="l9.740">             }</span>
<a href="#l9.741"></a><span id="l9.741">           }</span>
<a href="#l9.742"></a><span id="l9.742"> </span>
<a href="#l9.743"></a><span id="l9.743" class="difflineminus">-          PR_FREEIF(m_attachments[newLoc].m_x_mac_type);</span>
<a href="#l9.744"></a><span id="l9.744" class="difflineminus">-          attachment-&gt;GetMacType(&amp;m_attachments[newLoc].m_x_mac_type);</span>
<a href="#l9.745"></a><span id="l9.745" class="difflineminus">-          PR_FREEIF(m_attachments[newLoc].m_x_mac_creator);</span>
<a href="#l9.746"></a><span id="l9.746" class="difflineminus">-          attachment-&gt;GetMacCreator(&amp;m_attachments[newLoc].m_x_mac_creator);</span>
<a href="#l9.747"></a><span id="l9.747" class="difflineplus">+          attachment-&gt;GetMacType(getter_Copies(m_attachments[newLoc].m_xMacType));</span>
<a href="#l9.748"></a><span id="l9.748" class="difflineplus">+          attachment-&gt;GetMacCreator(getter_Copies(m_attachments[newLoc].m_xMacCreator));</span>
<a href="#l9.749"></a><span id="l9.749"> </span>
<a href="#l9.750"></a><span id="l9.750">           ++newLoc;</span>
<a href="#l9.751"></a><span id="l9.751">         }</span>
<a href="#l9.752"></a><span id="l9.752">       }</span>
<a href="#l9.753"></a><span id="l9.753">     }</span>
<a href="#l9.754"></a><span id="l9.754">   }</span>
<a href="#l9.755"></a><span id="l9.755">   return NS_OK;</span>
<a href="#l9.756"></a><span id="l9.756"> }</span>
<a href="#l9.757"></a><span id="l9.757" class="difflineat">@@ -2380,36 +2318,33 @@ nsMsgComposeAndSend::AddCompFieldRemoteA</span>
<a href="#l9.758"></a><span id="l9.758"> </span>
<a href="#l9.759"></a><span id="l9.759">           m_attachments[newLoc].mDeleteFile = PR_TRUE;</span>
<a href="#l9.760"></a><span id="l9.760">           m_attachments[newLoc].m_done = PR_FALSE;</span>
<a href="#l9.761"></a><span id="l9.761">           m_attachments[newLoc].SetMimeDeliveryState(this);</span>
<a href="#l9.762"></a><span id="l9.762"> </span>
<a href="#l9.763"></a><span id="l9.763">           if (!isAMessageAttachment)</span>
<a href="#l9.764"></a><span id="l9.764">             nsMsgNewURL(getter_AddRefs(m_attachments[newLoc].mURL), url.get());</span>
<a href="#l9.765"></a><span id="l9.765"> </span>
<a href="#l9.766"></a><span id="l9.766" class="difflineminus">-          PR_FREEIF(m_attachments[newLoc].m_encoding);</span>
<a href="#l9.767"></a><span id="l9.767" class="difflineminus">-          m_attachments[newLoc].m_encoding = PL_strdup (&quot;7bit&quot;);</span>
<a href="#l9.768"></a><span id="l9.768" class="difflineminus">-</span>
<a href="#l9.769"></a><span id="l9.769" class="difflineminus">-          PR_FREEIF(m_attachments[newLoc].m_x_mac_type);</span>
<a href="#l9.770"></a><span id="l9.770" class="difflineminus">-          attachment-&gt;GetMacType(&amp;m_attachments[newLoc].m_x_mac_type);</span>
<a href="#l9.771"></a><span id="l9.771" class="difflineminus">-          PR_FREEIF(m_attachments[newLoc].m_x_mac_creator);</span>
<a href="#l9.772"></a><span id="l9.772" class="difflineminus">-          attachment-&gt;GetMacCreator(&amp;m_attachments[newLoc].m_x_mac_creator);</span>
<a href="#l9.773"></a><span id="l9.773" class="difflineplus">+          m_attachments[newLoc].m_encoding = &quot;7bit&quot;;</span>
<a href="#l9.774"></a><span id="l9.774" class="difflineplus">+</span>
<a href="#l9.775"></a><span id="l9.775" class="difflineplus">+          attachment-&gt;GetMacType(getter_Copies(m_attachments[newLoc].m_xMacType));</span>
<a href="#l9.776"></a><span id="l9.776" class="difflineplus">+          attachment-&gt;GetMacCreator(getter_Copies(m_attachments[newLoc].m_xMacCreator));</span>
<a href="#l9.777"></a><span id="l9.777"> </span>
<a href="#l9.778"></a><span id="l9.778">           /* Count up attachments which are going to come from mail folders</span>
<a href="#l9.779"></a><span id="l9.779">              and from NNTP servers. */</span>
<a href="#l9.780"></a><span id="l9.780">           PRBool do_add_attachment = PR_FALSE;</span>
<a href="#l9.781"></a><span id="l9.781">           if (isAMessageAttachment)</span>
<a href="#l9.782"></a><span id="l9.782">           {</span>
<a href="#l9.783"></a><span id="l9.783">             do_add_attachment = PR_TRUE;</span>
<a href="#l9.784"></a><span id="l9.784">             if (!PL_strncasecmp(url.get(), &quot;news-message://&quot;, 15))</span>
<a href="#l9.785"></a><span id="l9.785">               (*aNewsCount)++;</span>
<a href="#l9.786"></a><span id="l9.786">             else</span>
<a href="#l9.787"></a><span id="l9.787">               (*aMailboxCount)++;</span>
<a href="#l9.788"></a><span id="l9.788"> </span>
<a href="#l9.789"></a><span id="l9.789" class="difflineminus">-            m_attachments[newLoc].m_uri = PL_strdup(url.get());</span>
<a href="#l9.790"></a><span id="l9.790" class="difflineplus">+            m_attachments[newLoc].m_uri = url;</span>
<a href="#l9.791"></a><span id="l9.791">             m_attachments[newLoc].mURL = nsnull;</span>
<a href="#l9.792"></a><span id="l9.792">           }</span>
<a href="#l9.793"></a><span id="l9.793">           else</span>
<a href="#l9.794"></a><span id="l9.794">             do_add_attachment = (nsnull != m_attachments[newLoc].mURL);</span>
<a href="#l9.795"></a><span id="l9.795"> </span>
<a href="#l9.796"></a><span id="l9.796">           if (do_add_attachment)</span>
<a href="#l9.797"></a><span id="l9.797">           {</span>
<a href="#l9.798"></a><span id="l9.798">             nsAutoString proposedName;</span>
<a href="#l9.799"></a><span id="l9.799" class="difflineat">@@ -2420,151 +2355,137 @@ nsMsgComposeAndSend::AddCompFieldRemoteA</span>
<a href="#l9.800"></a><span id="l9.800">         }</span>
<a href="#l9.801"></a><span id="l9.801">       }</span>
<a href="#l9.802"></a><span id="l9.802">     }</span>
<a href="#l9.803"></a><span id="l9.803">   }</span>
<a href="#l9.804"></a><span id="l9.804">   return NS_OK;</span>
<a href="#l9.805"></a><span id="l9.805"> }</span>
<a href="#l9.806"></a><span id="l9.806"> </span>
<a href="#l9.807"></a><span id="l9.807"> nsresult</span>
<a href="#l9.808"></a><span id="l9.808" class="difflineminus">-nsMsgComposeAndSend::HackAttachments(const nsMsgAttachmentData *attachments,</span>
<a href="#l9.809"></a><span id="l9.809" class="difflineminus">-                                     const nsMsgAttachedFile *preloaded_attachments)</span>
<a href="#l9.810"></a><span id="l9.810" class="difflineplus">+nsMsgComposeAndSend::HackAttachments(nsIArray *attachments,</span>
<a href="#l9.811"></a><span id="l9.811" class="difflineplus">+                                     nsIArray *preloadedAttachments)</span>
<a href="#l9.812"></a><span id="l9.812"> {</span>
<a href="#l9.813"></a><span id="l9.813">   //</span>
<a href="#l9.814"></a><span id="l9.814">   // First, count the total number of attachments we are going to process</span>
<a href="#l9.815"></a><span id="l9.815">   // for this operation! This is a little more complicated than you might</span>
<a href="#l9.816"></a><span id="l9.816">   // think because we have a few ways to specify attachments. Via the nsMsgAttachmentData</span>
<a href="#l9.817"></a><span id="l9.817">   // as well as the composition fields.</span>
<a href="#l9.818"></a><span id="l9.818">   //</span>
<a href="#l9.819"></a><span id="l9.819">   CountCompFieldAttachments();</span>
<a href="#l9.820"></a><span id="l9.820"> </span>
<a href="#l9.821"></a><span id="l9.821">   // Count the preloaded attachments!</span>
<a href="#l9.822"></a><span id="l9.822">   mPreloadedAttachmentCount = 0;</span>
<a href="#l9.823"></a><span id="l9.823"> </span>
<a href="#l9.824"></a><span id="l9.824">   // For now, manually add the local attachments in the comp field!</span>
<a href="#l9.825"></a><span id="l9.825">   mPreloadedAttachmentCount += mCompFieldLocalAttachments;</span>
<a href="#l9.826"></a><span id="l9.826" class="difflineminus">-</span>
<a href="#l9.827"></a><span id="l9.827" class="difflineminus">-  if (preloaded_attachments &amp;&amp; preloaded_attachments[0].orig_url)</span>
<a href="#l9.828"></a><span id="l9.828" class="difflineminus">-  {</span>
<a href="#l9.829"></a><span id="l9.829" class="difflineminus">-    while (preloaded_attachments[mPreloadedAttachmentCount].orig_url)</span>
<a href="#l9.830"></a><span id="l9.830" class="difflineminus">-      mPreloadedAttachmentCount++;</span>
<a href="#l9.831"></a><span id="l9.831" class="difflineminus">-  }</span>
<a href="#l9.832"></a><span id="l9.832" class="difflineplus">+  PRUint32 numAttachments = 0, numPreloadedAttachments = 0;</span>
<a href="#l9.833"></a><span id="l9.833" class="difflineplus">+  if (attachments)</span>
<a href="#l9.834"></a><span id="l9.834" class="difflineplus">+    attachments-&gt;GetLength(&amp;numAttachments);</span>
<a href="#l9.835"></a><span id="l9.835" class="difflineplus">+  if (preloadedAttachments)</span>
<a href="#l9.836"></a><span id="l9.836" class="difflineplus">+    preloadedAttachments-&gt;GetLength(&amp;numPreloadedAttachments);</span>
<a href="#l9.837"></a><span id="l9.837" class="difflineplus">+  mPreloadedAttachmentCount += numPreloadedAttachments;</span>
<a href="#l9.838"></a><span id="l9.838"> </span>
<a href="#l9.839"></a><span id="l9.839">   // Count the attachments we have to go retrieve! Keep in mind, that these</span>
<a href="#l9.840"></a><span id="l9.840">   // will be APPENDED to the current list of URL's that we have gathered if</span>
<a href="#l9.841"></a><span id="l9.841">   // this is a multpart/related send operation</span>
<a href="#l9.842"></a><span id="l9.842">   mRemoteAttachmentCount = GetMultipartRelatedCount();</span>
<a href="#l9.843"></a><span id="l9.843"> </span>
<a href="#l9.844"></a><span id="l9.844">   // For now, manually add the remote attachments in the comp field!</span>
<a href="#l9.845"></a><span id="l9.845">   mRemoteAttachmentCount += mCompFieldRemoteAttachments;</span>
<a href="#l9.846"></a><span id="l9.846"> </span>
<a href="#l9.847"></a><span id="l9.847" class="difflineminus">-  PRInt32     tCount = 0;</span>
<a href="#l9.848"></a><span id="l9.848" class="difflineminus">-  if (attachments &amp;&amp; attachments[0].url)</span>
<a href="#l9.849"></a><span id="l9.849" class="difflineminus">-  {</span>
<a href="#l9.850"></a><span id="l9.850" class="difflineminus">-    while (attachments[tCount].url)</span>
<a href="#l9.851"></a><span id="l9.851" class="difflineminus">-    {</span>
<a href="#l9.852"></a><span id="l9.852" class="difflineminus">-      mRemoteAttachmentCount++;</span>
<a href="#l9.853"></a><span id="l9.853" class="difflineminus">-      tCount++;</span>
<a href="#l9.854"></a><span id="l9.854" class="difflineminus">-    }</span>
<a href="#l9.855"></a><span id="l9.855" class="difflineminus">-  }</span>
<a href="#l9.856"></a><span id="l9.856" class="difflineplus">+  PRInt32 tCount = 0;</span>
<a href="#l9.857"></a><span id="l9.857" class="difflineplus">+  mRemoteAttachmentCount += numAttachments;</span>
<a href="#l9.858"></a><span id="l9.858" class="difflineplus">+  tCount += numAttachments;</span>
<a href="#l9.859"></a><span id="l9.859"> </span>
<a href="#l9.860"></a><span id="l9.860">   m_attachment_count = mPreloadedAttachmentCount + mRemoteAttachmentCount;</span>
<a href="#l9.861"></a><span id="l9.861"> </span>
<a href="#l9.862"></a><span id="l9.862">   // Now create the array of attachment handlers...</span>
<a href="#l9.863"></a><span id="l9.863">   m_attachments = (nsMsgAttachmentHandler *) new nsMsgAttachmentHandler[m_attachment_count];</span>
<a href="#l9.864"></a><span id="l9.864">   if (! m_attachments)</span>
<a href="#l9.865"></a><span id="l9.865">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l9.866"></a><span id="l9.866"> </span>
<a href="#l9.867"></a><span id="l9.867">   // clear this new memory...</span>
<a href="#l9.868"></a><span id="l9.868" class="difflineminus">-  memset(m_attachments, 0, (sizeof(nsMsgAttachmentHandler) * m_attachment_count));</span>
<a href="#l9.869"></a><span id="l9.869">   PRUint32     i;    // counter for location in attachment array...</span>
<a href="#l9.870"></a><span id="l9.870"> </span>
<a href="#l9.871"></a><span id="l9.871">   //</span>
<a href="#l9.872"></a><span id="l9.872">   // First, we need to attach the files that are defined in the comp fields...</span>
<a href="#l9.873"></a><span id="l9.873">   if (NS_FAILED(AddCompFieldLocalAttachments()))</span>
<a href="#l9.874"></a><span id="l9.874">     return NS_ERROR_INVALID_ARG;</span>
<a href="#l9.875"></a><span id="l9.875"> </span>
<a href="#l9.876"></a><span id="l9.876">   // Now handle the preloaded attachments...</span>
<a href="#l9.877"></a><span id="l9.877" class="difflineminus">-  if (preloaded_attachments &amp;&amp; preloaded_attachments[0].orig_url)</span>
<a href="#l9.878"></a><span id="l9.878" class="difflineplus">+  if (numPreloadedAttachments &gt; 0)</span>
<a href="#l9.879"></a><span id="l9.879">   {</span>
<a href="#l9.880"></a><span id="l9.880">     // These are attachments which have already been downloaded to tmp files.</span>
<a href="#l9.881"></a><span id="l9.881">     // We merely need to point the internal attachment data at those tmp</span>
<a href="#l9.882"></a><span id="l9.882">     // files.</span>
<a href="#l9.883"></a><span id="l9.883">     m_pre_snarfed_attachments_p = PR_TRUE;</span>
<a href="#l9.884"></a><span id="l9.884"> </span>
<a href="#l9.885"></a><span id="l9.885">     for (i = mCompFieldLocalAttachments; i &lt; mPreloadedAttachmentCount; i++)</span>
<a href="#l9.886"></a><span id="l9.886">     {</span>
<a href="#l9.887"></a><span id="l9.887" class="difflineplus">+      nsCOMPtr&lt;nsIMsgAttachedFile&gt; attachedFile = do_QueryElementAt(preloadedAttachments, i);</span>
<a href="#l9.888"></a><span id="l9.888" class="difflineplus">+      if (!attachedFile)</span>
<a href="#l9.889"></a><span id="l9.889" class="difflineplus">+        continue;</span>
<a href="#l9.890"></a><span id="l9.890" class="difflineplus">+</span>
<a href="#l9.891"></a><span id="l9.891">       /* These attachments are already &quot;snarfed&quot;. */</span>
<a href="#l9.892"></a><span id="l9.892">       m_attachments[i].mDeleteFile = PR_FALSE;</span>
<a href="#l9.893"></a><span id="l9.893">       m_attachments[i].SetMimeDeliveryState(nsnull);</span>
<a href="#l9.894"></a><span id="l9.894">       m_attachments[i].m_done = PR_TRUE;</span>
<a href="#l9.895"></a><span id="l9.895" class="difflineminus">-      NS_ASSERTION (preloaded_attachments[i].orig_url, &quot;null url&quot;);</span>
<a href="#l9.896"></a><span id="l9.896" class="difflineminus">-</span>
<a href="#l9.897"></a><span id="l9.897" class="difflineminus">-      m_attachments[i].mURL = preloaded_attachments[i].orig_url;</span>
<a href="#l9.898"></a><span id="l9.898" class="difflineminus">-</span>
<a href="#l9.899"></a><span id="l9.899" class="difflineminus">-      PR_FREEIF(m_attachments[i].m_type);</span>
<a href="#l9.900"></a><span id="l9.900" class="difflineminus">-      m_attachments[i].m_type = PL_strdup (preloaded_attachments[i].type);</span>
<a href="#l9.901"></a><span id="l9.901" class="difflineplus">+</span>
<a href="#l9.902"></a><span id="l9.902" class="difflineplus">+      attachedFile-&gt;GetOrigUrl(getter_AddRefs(m_attachments[i].mURL));</span>
<a href="#l9.903"></a><span id="l9.903" class="difflineplus">+</span>
<a href="#l9.904"></a><span id="l9.904" class="difflineplus">+      attachedFile-&gt;GetType(m_attachments[i].m_type);</span>
<a href="#l9.905"></a><span id="l9.905"> </span>
<a href="#l9.906"></a><span id="l9.906">       // Set it to the compose fields for a default...</span>
<a href="#l9.907"></a><span id="l9.907" class="difflineminus">-      PR_FREEIF(m_attachments[i].m_charset);</span>
<a href="#l9.908"></a><span id="l9.908" class="difflineminus">-      m_attachments[i].m_charset = PL_strdup (mCompFields-&gt;GetCharacterSet());</span>
<a href="#l9.909"></a><span id="l9.909" class="difflineplus">+      m_attachments[i].m_charset = mCompFields-&gt;GetCharacterSet();</span>
<a href="#l9.910"></a><span id="l9.910"> </span>
<a href="#l9.911"></a><span id="l9.911">       // If we still don't have a content type, we should really try sniff one out!</span>
<a href="#l9.912"></a><span id="l9.912" class="difflineminus">-      if ((!m_attachments[i].m_type) || (!*m_attachments[i].m_type))</span>
<a href="#l9.913"></a><span id="l9.913" class="difflineminus">-      {</span>
<a href="#l9.914"></a><span id="l9.914" class="difflineplus">+      if (m_attachments[i].m_type.IsEmpty())</span>
<a href="#l9.915"></a><span id="l9.915">         m_attachments[i].PickEncoding(mCompFields-&gt;GetCharacterSet(), this);</span>
<a href="#l9.916"></a><span id="l9.916" class="difflineminus">-      }</span>
<a href="#l9.917"></a><span id="l9.917"> </span>
<a href="#l9.918"></a><span id="l9.918">       // For local files, if they are HTML docs and we don't have a charset, we should</span>
<a href="#l9.919"></a><span id="l9.919">       // sniff the file and see if we can figure it out.</span>
<a href="#l9.920"></a><span id="l9.920" class="difflineminus">-      if ( (m_attachments[i].m_type) &amp;&amp;  (*m_attachments[i].m_type) )</span>
<a href="#l9.921"></a><span id="l9.921" class="difflineplus">+      if (!m_attachments[i].m_type.IsEmpty())</span>
<a href="#l9.922"></a><span id="l9.922">       {</span>
<a href="#l9.923"></a><span id="l9.923" class="difflineminus">-        if ( (PL_strcasecmp(m_attachments[i].m_type, TEXT_HTML) == 0) &amp;&amp; (preloaded_attachments[i].tmp_file) )</span>
<a href="#l9.924"></a><span id="l9.924" class="difflineplus">+        nsCOMPtr&lt;nsILocalFile&gt; tmpFile;</span>
<a href="#l9.925"></a><span id="l9.925" class="difflineplus">+        attachedFile-&gt;GetTmpFile(getter_AddRefs(tmpFile));</span>
<a href="#l9.926"></a><span id="l9.926" class="difflineplus">+        if (m_attachments[i].m_type.LowerCaseEqualsLiteral(TEXT_HTML) &amp;&amp; tmpFile)</span>
<a href="#l9.927"></a><span id="l9.927">         {</span>
<a href="#l9.928"></a><span id="l9.928" class="difflineminus">-          char *tmpCharset = (char *)nsMsgI18NParseMetaCharset(preloaded_attachments[i].tmp_file);</span>
<a href="#l9.929"></a><span id="l9.929" class="difflineplus">+          char *tmpCharset = (char *)nsMsgI18NParseMetaCharset(tmpFile);</span>
<a href="#l9.930"></a><span id="l9.930">           if (tmpCharset[0] != '\0')</span>
<a href="#l9.931"></a><span id="l9.931" class="difflineminus">-          {</span>
<a href="#l9.932"></a><span id="l9.932" class="difflineminus">-            PR_FREEIF(m_attachments[i].m_charset);</span>
<a href="#l9.933"></a><span id="l9.933" class="difflineminus">-            m_attachments[i].m_charset = PL_strdup(tmpCharset);</span>
<a href="#l9.934"></a><span id="l9.934" class="difflineminus">-          }</span>
<a href="#l9.935"></a><span id="l9.935" class="difflineplus">+            m_attachments[i].m_charset = tmpCharset;</span>
<a href="#l9.936"></a><span id="l9.936">         }</span>
<a href="#l9.937"></a><span id="l9.937">       }</span>
<a href="#l9.938"></a><span id="l9.938"> </span>
<a href="#l9.939"></a><span id="l9.939" class="difflineminus">-      PR_FREEIF(m_attachments[i].m_description);</span>
<a href="#l9.940"></a><span id="l9.940" class="difflineminus">-      m_attachments[i].m_description = PL_strdup (preloaded_attachments[i].description);</span>
<a href="#l9.941"></a><span id="l9.941" class="difflineminus">-      PR_FREEIF(m_attachments[i].m_real_name);</span>
<a href="#l9.942"></a><span id="l9.942" class="difflineminus">-      m_attachments[i].m_real_name = PL_strdup (preloaded_attachments[i].real_name);</span>
<a href="#l9.943"></a><span id="l9.943" class="difflineminus">-      PR_FREEIF(m_attachments[i].m_x_mac_type);</span>
<a href="#l9.944"></a><span id="l9.944" class="difflineminus">-      m_attachments[i].m_x_mac_type = PL_strdup (preloaded_attachments[i].x_mac_type);</span>
<a href="#l9.945"></a><span id="l9.945" class="difflineminus">-      PR_FREEIF(m_attachments[i].m_x_mac_creator);</span>
<a href="#l9.946"></a><span id="l9.946" class="difflineminus">-      m_attachments[i].m_x_mac_creator = PL_strdup (preloaded_attachments[i].x_mac_creator);</span>
<a href="#l9.947"></a><span id="l9.947" class="difflineminus">-      PR_FREEIF(m_attachments[i].m_encoding);</span>
<a href="#l9.948"></a><span id="l9.948" class="difflineminus">-      m_attachments[i].m_encoding = PL_strdup (preloaded_attachments[i].encoding);</span>
<a href="#l9.949"></a><span id="l9.949" class="difflineplus">+      attachedFile-&gt;GetDescription(m_attachments[i].m_description);</span>
<a href="#l9.950"></a><span id="l9.950" class="difflineplus">+      attachedFile-&gt;GetRealName(m_attachments[i].m_realName);</span>
<a href="#l9.951"></a><span id="l9.951" class="difflineplus">+      attachedFile-&gt;GetXMacType(m_attachments[i].m_xMacType);</span>
<a href="#l9.952"></a><span id="l9.952" class="difflineplus">+      attachedFile-&gt;GetXMacCreator(m_attachments[i].m_xMacCreator);</span>
<a href="#l9.953"></a><span id="l9.953" class="difflineplus">+      attachedFile-&gt;GetEncoding(m_attachments[i].m_encoding);</span>
<a href="#l9.954"></a><span id="l9.954"> </span>
<a href="#l9.955"></a><span id="l9.955">       if (m_attachments[i].mTmpFile)</span>
<a href="#l9.956"></a><span id="l9.956">       {</span>
<a href="#l9.957"></a><span id="l9.957">         if (m_attachments[i].mDeleteFile)</span>
<a href="#l9.958"></a><span id="l9.958">           m_attachments[i].mTmpFile-&gt;Remove(PR_FALSE);</span>
<a href="#l9.959"></a><span id="l9.959">         m_attachments[i].mTmpFile = nsnull;</span>
<a href="#l9.960"></a><span id="l9.960">       }</span>
<a href="#l9.961"></a><span id="l9.961" class="difflineminus">-      m_attachments[i].mTmpFile = preloaded_attachments[i].tmp_file;</span>
<a href="#l9.962"></a><span id="l9.962" class="difflineminus">-</span>
<a href="#l9.963"></a><span id="l9.963" class="difflineminus">-      m_attachments[i].m_size = preloaded_attachments[i].size;</span>
<a href="#l9.964"></a><span id="l9.964" class="difflineminus">-      m_attachments[i].m_unprintable_count = preloaded_attachments[i].unprintable_count;</span>
<a href="#l9.965"></a><span id="l9.965" class="difflineminus">-      m_attachments[i].m_highbit_count = preloaded_attachments[i].highbit_count;</span>
<a href="#l9.966"></a><span id="l9.966" class="difflineminus">-      m_attachments[i].m_ctl_count = preloaded_attachments[i].ctl_count;</span>
<a href="#l9.967"></a><span id="l9.967" class="difflineminus">-      m_attachments[i].m_null_count = preloaded_attachments[i].null_count;</span>
<a href="#l9.968"></a><span id="l9.968" class="difflineminus">-      m_attachments[i].m_max_column = preloaded_attachments[i].max_line_length;</span>
<a href="#l9.969"></a><span id="l9.969" class="difflineplus">+      attachedFile-&gt;GetTmpFile(getter_AddRefs(m_attachments[i].mTmpFile));</span>
<a href="#l9.970"></a><span id="l9.970" class="difflineplus">+</span>
<a href="#l9.971"></a><span id="l9.971" class="difflineplus">+      attachedFile-&gt;GetSize(&amp;m_attachments[i].m_size);</span>
<a href="#l9.972"></a><span id="l9.972" class="difflineplus">+      attachedFile-&gt;GetUnprintableCount(&amp;m_attachments[i].m_unprintable_count);</span>
<a href="#l9.973"></a><span id="l9.973" class="difflineplus">+      attachedFile-&gt;GetHighbitCount(&amp;m_attachments[i].m_highbit_count);</span>
<a href="#l9.974"></a><span id="l9.974" class="difflineplus">+      attachedFile-&gt;GetCtlCount(&amp;m_attachments[i].m_ctl_count);</span>
<a href="#l9.975"></a><span id="l9.975" class="difflineplus">+      attachedFile-&gt;GetNullCount(&amp;m_attachments[i].m_null_count);</span>
<a href="#l9.976"></a><span id="l9.976" class="difflineplus">+      attachedFile-&gt;GetMaxLineLength(&amp;m_attachments[i].m_max_column);</span>
<a href="#l9.977"></a><span id="l9.977"> </span>
<a href="#l9.978"></a><span id="l9.978">       /* If the attachment has an encoding, and it's not one of</span>
<a href="#l9.979"></a><span id="l9.979">       the &quot;null&quot; encodings, then keep it. */</span>
<a href="#l9.980"></a><span id="l9.980" class="difflineminus">-      if (m_attachments[i].m_encoding &amp;&amp;</span>
<a href="#l9.981"></a><span id="l9.981" class="difflineminus">-          PL_strcasecmp (m_attachments[i].m_encoding, ENCODING_7BIT) &amp;&amp;</span>
<a href="#l9.982"></a><span id="l9.982" class="difflineminus">-          PL_strcasecmp (m_attachments[i].m_encoding, ENCODING_8BIT) &amp;&amp;</span>
<a href="#l9.983"></a><span id="l9.983" class="difflineminus">-          PL_strcasecmp (m_attachments[i].m_encoding, ENCODING_BINARY))</span>
<a href="#l9.984"></a><span id="l9.984" class="difflineplus">+      if (!m_attachments[i].m_encoding.IsEmpty() &amp;&amp;</span>
<a href="#l9.985"></a><span id="l9.985" class="difflineplus">+          !m_attachments[i].m_encoding.LowerCaseEqualsLiteral(ENCODING_7BIT) &amp;&amp;</span>
<a href="#l9.986"></a><span id="l9.986" class="difflineplus">+          !m_attachments[i].m_encoding.LowerCaseEqualsLiteral(ENCODING_8BIT) &amp;&amp;</span>
<a href="#l9.987"></a><span id="l9.987" class="difflineplus">+          !m_attachments[i].m_encoding.LowerCaseEqualsLiteral(ENCODING_BINARY))</span>
<a href="#l9.988"></a><span id="l9.988">         m_attachments[i].m_already_encoded_p = PR_TRUE;</span>
<a href="#l9.989"></a><span id="l9.989"> </span>
<a href="#l9.990"></a><span id="l9.990">             if (m_attachments[i].mURL)</span>
<a href="#l9.991"></a><span id="l9.991">         msg_pick_real_name(&amp;m_attachments[i], nsnull, mCompFields-&gt;GetCharacterSet());</span>
<a href="#l9.992"></a><span id="l9.992">     }</span>
<a href="#l9.993"></a><span id="l9.993">   }</span>
<a href="#l9.994"></a><span id="l9.994"> </span>
<a href="#l9.995"></a><span id="l9.995">   // First, handle the multipart related attachments if any...</span>
<a href="#l9.996"></a><span id="l9.996" class="difflineat">@@ -2588,48 +2509,41 @@ nsMsgComposeAndSend::HackAttachments(con</span>
<a href="#l9.997"></a><span id="l9.997">   if (NS_FAILED( AddCompFieldRemoteAttachments( (mPreloadedAttachmentCount + multipartRelatedCount),</span>
<a href="#l9.998"></a><span id="l9.998">                                                  &amp;mailbox_count, &amp;news_count) ))</span>
<a href="#l9.999"></a><span id="l9.999">     return NS_ERROR_INVALID_ARG;</span>
<a href="#l9.1000"></a><span id="l9.1000"> </span>
<a href="#l9.1001"></a><span id="l9.1001">   //</span>
<a href="#l9.1002"></a><span id="l9.1002">   // Now deal remote attachments and attach multipart/related attachments (url's and such..)</span>
<a href="#l9.1003"></a><span id="l9.1003">   // first!</span>
<a href="#l9.1004"></a><span id="l9.1004">   //</span>
<a href="#l9.1005"></a><span id="l9.1005" class="difflineminus">-  if (attachments &amp;&amp; attachments[0].url)</span>
<a href="#l9.1006"></a><span id="l9.1006" class="difflineplus">+  if (attachments)</span>
<a href="#l9.1007"></a><span id="l9.1007">   {</span>
<a href="#l9.1008"></a><span id="l9.1008">     PRInt32     locCount = -1;</span>
<a href="#l9.1009"></a><span id="l9.1009"> </span>
<a href="#l9.1010"></a><span id="l9.1010">     for (i = (mPreloadedAttachmentCount + GetMultipartRelatedCount() + mCompFieldRemoteAttachments); i &lt; m_attachment_count; i++)</span>
<a href="#l9.1011"></a><span id="l9.1011">     {</span>
<a href="#l9.1012"></a><span id="l9.1012">       locCount++;</span>
<a href="#l9.1013"></a><span id="l9.1013" class="difflineplus">+      nsCOMPtr&lt;nsIMsgAttachmentData&gt; attachment(do_QueryElementAt(attachments, i));</span>
<a href="#l9.1014"></a><span id="l9.1014" class="difflineplus">+      if (!attachment)</span>
<a href="#l9.1015"></a><span id="l9.1015" class="difflineplus">+        continue;</span>
<a href="#l9.1016"></a><span id="l9.1016">       m_attachments[i].mDeleteFile = PR_TRUE;</span>
<a href="#l9.1017"></a><span id="l9.1017">       m_attachments[i].m_done = PR_FALSE;</span>
<a href="#l9.1018"></a><span id="l9.1018">       m_attachments[i].SetMimeDeliveryState(this);</span>
<a href="#l9.1019"></a><span id="l9.1019" class="difflineminus">-      NS_ASSERTION (attachments[locCount].url, &quot;null url&quot;);</span>
<a href="#l9.1020"></a><span id="l9.1020" class="difflineminus">-</span>
<a href="#l9.1021"></a><span id="l9.1021" class="difflineminus">-      m_attachments[i].mURL = attachments[locCount].url;</span>
<a href="#l9.1022"></a><span id="l9.1022" class="difflineminus">-</span>
<a href="#l9.1023"></a><span id="l9.1023" class="difflineminus">-      PR_FREEIF(m_attachments[i].m_override_type);</span>
<a href="#l9.1024"></a><span id="l9.1024" class="difflineminus">-      m_attachments[i].m_override_type = PL_strdup (attachments[locCount].real_type);</span>
<a href="#l9.1025"></a><span id="l9.1025" class="difflineminus">-      PR_FREEIF(m_attachments[i].m_charset);</span>
<a href="#l9.1026"></a><span id="l9.1026" class="difflineminus">-      m_attachments[i].m_charset = PL_strdup (mCompFields-&gt;GetCharacterSet());</span>
<a href="#l9.1027"></a><span id="l9.1027" class="difflineminus">-      PR_FREEIF(m_attachments[i].m_override_encoding);</span>
<a href="#l9.1028"></a><span id="l9.1028" class="difflineminus">-      m_attachments[i].m_override_encoding = PL_strdup (attachments[locCount].real_encoding);</span>
<a href="#l9.1029"></a><span id="l9.1029" class="difflineminus">-      PR_FREEIF(m_attachments[i].m_desired_type);</span>
<a href="#l9.1030"></a><span id="l9.1030" class="difflineminus">-      m_attachments[i].m_desired_type = PL_strdup (attachments[locCount].desired_type);</span>
<a href="#l9.1031"></a><span id="l9.1031" class="difflineminus">-      PR_FREEIF(m_attachments[i].m_description);</span>
<a href="#l9.1032"></a><span id="l9.1032" class="difflineminus">-      m_attachments[i].m_description = PL_strdup (attachments[locCount].description);</span>
<a href="#l9.1033"></a><span id="l9.1033" class="difflineminus">-      PR_FREEIF(m_attachments[i].m_real_name);</span>
<a href="#l9.1034"></a><span id="l9.1034" class="difflineminus">-      m_attachments[i].m_real_name = PL_strdup (attachments[locCount].real_name);</span>
<a href="#l9.1035"></a><span id="l9.1035" class="difflineminus">-      PR_FREEIF(m_attachments[i].m_x_mac_type);</span>
<a href="#l9.1036"></a><span id="l9.1036" class="difflineminus">-      m_attachments[i].m_x_mac_type = PL_strdup (attachments[locCount].x_mac_type);</span>
<a href="#l9.1037"></a><span id="l9.1037" class="difflineminus">-      PR_FREEIF(m_attachments[i].m_x_mac_creator);</span>
<a href="#l9.1038"></a><span id="l9.1038" class="difflineminus">-      m_attachments[i].m_x_mac_creator = PL_strdup (attachments[locCount].x_mac_creator);</span>
<a href="#l9.1039"></a><span id="l9.1039" class="difflineminus">-      PR_FREEIF(m_attachments[i].m_encoding);</span>
<a href="#l9.1040"></a><span id="l9.1040" class="difflineminus">-      m_attachments[i].m_encoding = PL_strdup (&quot;7bit&quot;);</span>
<a href="#l9.1041"></a><span id="l9.1041" class="difflineplus">+</span>
<a href="#l9.1042"></a><span id="l9.1042" class="difflineplus">+      attachment-&gt;GetUrl(getter_AddRefs(m_attachments[i].mURL));</span>
<a href="#l9.1043"></a><span id="l9.1043" class="difflineplus">+</span>
<a href="#l9.1044"></a><span id="l9.1044" class="difflineplus">+      attachment-&gt;GetRealType(m_attachments[i].m_overrideType);</span>
<a href="#l9.1045"></a><span id="l9.1045" class="difflineplus">+      m_attachments[i].m_charset = mCompFields-&gt;GetCharacterSet();</span>
<a href="#l9.1046"></a><span id="l9.1046" class="difflineplus">+      attachment-&gt;GetRealEncoding(m_attachments[i].m_overrideEncoding);</span>
<a href="#l9.1047"></a><span id="l9.1047" class="difflineplus">+      attachment-&gt;GetDesiredType(m_attachments[i].m_desiredType);</span>
<a href="#l9.1048"></a><span id="l9.1048" class="difflineplus">+      attachment-&gt;GetDescription(m_attachments[i].m_description);</span>
<a href="#l9.1049"></a><span id="l9.1049" class="difflineplus">+      attachment-&gt;GetRealName(m_attachments[i].m_realName);</span>
<a href="#l9.1050"></a><span id="l9.1050" class="difflineplus">+      attachment-&gt;GetXMacType(m_attachments[i].m_xMacType);</span>
<a href="#l9.1051"></a><span id="l9.1051" class="difflineplus">+      attachment-&gt;GetXMacCreator(m_attachments[i].m_xMacCreator);</span>
<a href="#l9.1052"></a><span id="l9.1052" class="difflineplus">+      m_attachments[i].m_encoding = &quot;7bit&quot;;</span>
<a href="#l9.1053"></a><span id="l9.1053"> </span>
<a href="#l9.1054"></a><span id="l9.1054">       // real name is set in the case of vcard so don't change it.  XXX STILL NEEDED?</span>
<a href="#l9.1055"></a><span id="l9.1055">       // m_attachments[i].m_real_name = 0;</span>
<a href="#l9.1056"></a><span id="l9.1056"> </span>
<a href="#l9.1057"></a><span id="l9.1057">       /* Count up attachments which are going to come from mail folders</span>
<a href="#l9.1058"></a><span id="l9.1058">       and from NNTP servers. */</span>
<a href="#l9.1059"></a><span id="l9.1059">     if (m_attachments[i].mURL)</span>
<a href="#l9.1060"></a><span id="l9.1060">     {</span>
<a href="#l9.1061"></a><span id="l9.1061" class="difflineat">@@ -2668,17 +2582,17 @@ nsMsgComposeAndSend::HackAttachments(con</span>
<a href="#l9.1062"></a><span id="l9.1062">       {</span>
<a href="#l9.1063"></a><span id="l9.1063">         m_attachment_pending_count--;</span>
<a href="#l9.1064"></a><span id="l9.1064">         continue;</span>
<a href="#l9.1065"></a><span id="l9.1065">       }</span>
<a href="#l9.1066"></a><span id="l9.1066"> </span>
<a href="#l9.1067"></a><span id="l9.1067">       //</span>
<a href="#l9.1068"></a><span id="l9.1068">       //  IF we get here and the URL is NULL, just dec the pending count and move on!!!</span>
<a href="#l9.1069"></a><span id="l9.1069">       //</span>
<a href="#l9.1070"></a><span id="l9.1070" class="difflineminus">-      if ( (!m_attachments[i].mURL) &amp;&amp; (!m_attachments[i].m_uri) )</span>
<a href="#l9.1071"></a><span id="l9.1071" class="difflineplus">+      if ( (!m_attachments[i].mURL) &amp;&amp; (!m_attachments[i].m_uri.Length()) )</span>
<a href="#l9.1072"></a><span id="l9.1072">       {</span>
<a href="#l9.1073"></a><span id="l9.1073">         m_attachments[i].m_bogus_attachment = PR_TRUE;</span>
<a href="#l9.1074"></a><span id="l9.1074">         m_attachments[i].m_done = PR_TRUE;</span>
<a href="#l9.1075"></a><span id="l9.1075">         m_attachments[i].SetMimeDeliveryState(nsnull);</span>
<a href="#l9.1076"></a><span id="l9.1076">         m_attachment_pending_count--;</span>
<a href="#l9.1077"></a><span id="l9.1077">         continue;</span>
<a href="#l9.1078"></a><span id="l9.1078">       }</span>
<a href="#l9.1079"></a><span id="l9.1079"> </span>
<a href="#l9.1080"></a><span id="l9.1080" class="difflineat">@@ -2687,20 +2601,17 @@ nsMsgComposeAndSend::HackAttachments(con</span>
<a href="#l9.1081"></a><span id="l9.1081">       // (and thus no exit routine was or will be called.)</span>
<a href="#l9.1082"></a><span id="l9.1082">       //</span>
<a href="#l9.1083"></a><span id="l9.1083"> </span>
<a href="#l9.1084"></a><span id="l9.1084">       // Display some feedback to user...</span>
<a href="#l9.1085"></a><span id="l9.1085">       PRUnichar     *printfString = nsnull;</span>
<a href="#l9.1086"></a><span id="l9.1086">       nsString msg;</span>
<a href="#l9.1087"></a><span id="l9.1087">       mComposeBundle-&gt;GetStringFromID(NS_MSG_GATHERING_ATTACHMENT, getter_Copies(msg));</span>
<a href="#l9.1088"></a><span id="l9.1088"> </span>
<a href="#l9.1089"></a><span id="l9.1089" class="difflineminus">-      if (m_attachments[i].m_real_name)</span>
<a href="#l9.1090"></a><span id="l9.1090" class="difflineminus">-        printfString = nsTextFormatter::smprintf(msg.get(), m_attachments[i].m_real_name);</span>
<a href="#l9.1091"></a><span id="l9.1091" class="difflineminus">-      else</span>
<a href="#l9.1092"></a><span id="l9.1092" class="difflineminus">-        printfString = nsTextFormatter::smprintf(msg.get(), &quot;&quot;);</span>
<a href="#l9.1093"></a><span id="l9.1093" class="difflineplus">+      printfString = nsTextFormatter::smprintf(msg.get(), m_attachments[i].m_realName.get());</span>
<a href="#l9.1094"></a><span id="l9.1094"> </span>
<a href="#l9.1095"></a><span id="l9.1095">       if (printfString)</span>
<a href="#l9.1096"></a><span id="l9.1096">       {</span>
<a href="#l9.1097"></a><span id="l9.1097">         SetStatusMessage(nsDependentString(printfString));</span>
<a href="#l9.1098"></a><span id="l9.1098">         PR_Free(printfString);</span>
<a href="#l9.1099"></a><span id="l9.1099">       }</span>
<a href="#l9.1100"></a><span id="l9.1100"> </span>
<a href="#l9.1101"></a><span id="l9.1101">       /* As SnarfAttachment will call GatherMimeAttachments when it will be done (this is an async process),</span>
<a href="#l9.1102"></a><span id="l9.1102" class="difflineat">@@ -2708,17 +2619,17 @@ nsMsgComposeAndSend::HackAttachments(con</span>
<a href="#l9.1103"></a><span id="l9.1103">       */</span>
<a href="#l9.1104"></a><span id="l9.1104">       needToCallGatherMimeAttachments = PR_FALSE;</span>
<a href="#l9.1105"></a><span id="l9.1105"> </span>
<a href="#l9.1106"></a><span id="l9.1106">       nsresult status = m_attachments[i].SnarfAttachment(mCompFields);</span>
<a href="#l9.1107"></a><span id="l9.1107">       if (NS_FAILED(status))</span>
<a href="#l9.1108"></a><span id="l9.1108">       {</span>
<a href="#l9.1109"></a><span id="l9.1109">         nsString errorMsg;</span>
<a href="#l9.1110"></a><span id="l9.1110">         nsAutoString attachmentFileName;</span>
<a href="#l9.1111"></a><span id="l9.1111" class="difflineminus">-        nsresult rv = ConvertToUnicode(nsMsgI18NFileSystemCharset(), m_attachments[i].m_real_name, attachmentFileName);</span>
<a href="#l9.1112"></a><span id="l9.1112" class="difflineplus">+        nsresult rv = ConvertToUnicode(nsMsgI18NFileSystemCharset(), m_attachments[i].m_realName, attachmentFileName);</span>
<a href="#l9.1113"></a><span id="l9.1113">         if (NS_SUCCEEDED(rv))</span>
<a href="#l9.1114"></a><span id="l9.1114">         {</span>
<a href="#l9.1115"></a><span id="l9.1115">           nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l9.1116"></a><span id="l9.1116">           const PRUnichar *params[] = { attachmentFileName.get() };</span>
<a href="#l9.1117"></a><span id="l9.1117">           mComposeBundle-&gt;FormatStringFromID(NS_ERROR_GET_CODE(NS_MSG_ERROR_ATTACHING_FILE), params, 1, getter_Copies(errorMsg));</span>
<a href="#l9.1118"></a><span id="l9.1118">           mSendReport-&gt;SetMessage(nsIMsgSendReport::process_Current, errorMsg.get(), PR_FALSE);</span>
<a href="#l9.1119"></a><span id="l9.1119">           mSendReport-&gt;SetError(nsIMsgSendReport::process_Current, NS_MSG_GENERATE_FAILURE(NS_MSG_ERROR_ATTACHING_FILE) /* status */,</span>
<a href="#l9.1120"></a><span id="l9.1120">                                 PR_FALSE);</span>
<a href="#l9.1121"></a><span id="l9.1121" class="difflineat">@@ -3311,18 +3222,18 @@ nsMsgComposeAndSend::Init(</span>
<a href="#l9.1122"></a><span id="l9.1122">               nsIFile      *sendFile,</span>
<a href="#l9.1123"></a><span id="l9.1123">               PRBool digest_p,</span>
<a href="#l9.1124"></a><span id="l9.1124">               PRBool dont_deliver_p,</span>
<a href="#l9.1125"></a><span id="l9.1125">               nsMsgDeliverMode mode,</span>
<a href="#l9.1126"></a><span id="l9.1126">               nsIMsgDBHdr *msgToReplace,</span>
<a href="#l9.1127"></a><span id="l9.1127">               const char *attachment1_type,</span>
<a href="#l9.1128"></a><span id="l9.1128">               const char *attachment1_body,</span>
<a href="#l9.1129"></a><span id="l9.1129">               PRUint32 attachment1_body_length,</span>
<a href="#l9.1130"></a><span id="l9.1130" class="difflineminus">-              const nsMsgAttachmentData *attachments,</span>
<a href="#l9.1131"></a><span id="l9.1131" class="difflineminus">-              const nsMsgAttachedFile *preloaded_attachments,</span>
<a href="#l9.1132"></a><span id="l9.1132" class="difflineplus">+              nsIArray *attachments,</span>
<a href="#l9.1133"></a><span id="l9.1133" class="difflineplus">+              nsIArray *preloaded_attachments,</span>
<a href="#l9.1134"></a><span id="l9.1134">               const char *password,</span>
<a href="#l9.1135"></a><span id="l9.1135">               const nsACString &amp;aOriginalMsgURI,</span>
<a href="#l9.1136"></a><span id="l9.1136">               MSG_ComposeType aType)</span>
<a href="#l9.1137"></a><span id="l9.1137"> {</span>
<a href="#l9.1138"></a><span id="l9.1138">   nsresult      rv = NS_OK;</span>
<a href="#l9.1139"></a><span id="l9.1139"> </span>
<a href="#l9.1140"></a><span id="l9.1140">   //Reset last error</span>
<a href="#l9.1141"></a><span id="l9.1141">   mLastErrorReported = NS_OK;</span>
<a href="#l9.1142"></a><span id="l9.1142" class="difflineat">@@ -4240,20 +4151,19 @@ nsMsgComposeAndSend::CreateAndSendMessag</span>
<a href="#l9.1143"></a><span id="l9.1143">               const char                        *aAccountKey,</span>
<a href="#l9.1144"></a><span id="l9.1144">               nsIMsgCompFields                  *fields,</span>
<a href="#l9.1145"></a><span id="l9.1145">               PRBool                            digest_p,</span>
<a href="#l9.1146"></a><span id="l9.1146">               PRBool                            dont_deliver_p,</span>
<a href="#l9.1147"></a><span id="l9.1147">               nsMsgDeliverMode                  mode,</span>
<a href="#l9.1148"></a><span id="l9.1148">               nsIMsgDBHdr                       *msgToReplace,</span>
<a href="#l9.1149"></a><span id="l9.1149">               const char                        *attachment1_type,</span>
<a href="#l9.1150"></a><span id="l9.1150">               const char                        *attachment1_body,</span>
<a href="#l9.1151"></a><span id="l9.1151" class="difflineminus">-              PRUint32                          attachment1_body_length,</span>
<a href="#l9.1152"></a><span id="l9.1152" class="difflineminus">-              const nsMsgAttachmentData         *attachments,</span>
<a href="#l9.1153"></a><span id="l9.1153" class="difflineminus">-              const nsMsgAttachedFile           *preloaded_attachments,</span>
<a href="#l9.1154"></a><span id="l9.1154" class="difflineminus">-              void                              *relatedPart,</span>
<a href="#l9.1155"></a><span id="l9.1155" class="difflineplus">+              PRUint32 attachment1_body_length,</span>
<a href="#l9.1156"></a><span id="l9.1156" class="difflineplus">+              nsIArray *attachments,</span>
<a href="#l9.1157"></a><span id="l9.1157" class="difflineplus">+              nsIArray *preloaded_attachments,</span>
<a href="#l9.1158"></a><span id="l9.1158">               nsIDOMWindow                      *parentWindow,</span>
<a href="#l9.1159"></a><span id="l9.1159">               nsIMsgProgress                    *progress,</span>
<a href="#l9.1160"></a><span id="l9.1160">               nsIMsgSendListener                *aListener,</span>
<a href="#l9.1161"></a><span id="l9.1161">               const char                        *password,</span>
<a href="#l9.1162"></a><span id="l9.1162">               const nsACString                  &amp;aOriginalMsgURI,</span>
<a href="#l9.1163"></a><span id="l9.1163">               MSG_ComposeType                   aType</span>
<a href="#l9.1164"></a><span id="l9.1164">               )</span>
<a href="#l9.1165"></a><span id="l9.1165"> {</span>
<a href="#l9.1166"></a><span id="l9.1166" class="difflineat">@@ -4347,42 +4257,41 @@ nsMsgComposeAndSend::SendMessageFile(</span>
<a href="#l9.1167"></a><span id="l9.1167"> </span>
<a href="#l9.1168"></a><span id="l9.1168">   return rv;</span>
<a href="#l9.1169"></a><span id="l9.1169"> }</span>
<a href="#l9.1170"></a><span id="l9.1170"> </span>
<a href="#l9.1171"></a><span id="l9.1171"> nsMsgAttachmentData *</span>
<a href="#l9.1172"></a><span id="l9.1172"> BuildURLAttachmentData(nsIURI *url)</span>
<a href="#l9.1173"></a><span id="l9.1173"> {</span>
<a href="#l9.1174"></a><span id="l9.1174">   int                 attachCount = 2;  // one entry and one empty entry</span>
<a href="#l9.1175"></a><span id="l9.1175" class="difflineminus">-  nsMsgAttachmentData *attachments = nsnull;</span>
<a href="#l9.1176"></a><span id="l9.1176" class="difflineplus">+  nsMsgAttachmentData *attachments;</span>
<a href="#l9.1177"></a><span id="l9.1177">   const char          *theName = nsnull;</span>
<a href="#l9.1178"></a><span id="l9.1178"> </span>
<a href="#l9.1179"></a><span id="l9.1179">   if (!url)</span>
<a href="#l9.1180"></a><span id="l9.1180">     return nsnull;</span>
<a href="#l9.1181"></a><span id="l9.1181"> </span>
<a href="#l9.1182"></a><span id="l9.1182" class="difflineminus">-  attachments = (nsMsgAttachmentData *) PR_Malloc(sizeof(nsMsgAttachmentData) * attachCount);</span>
<a href="#l9.1183"></a><span id="l9.1183" class="difflineplus">+  attachments = new nsMsgAttachmentData[attachCount];</span>
<a href="#l9.1184"></a><span id="l9.1184">   if (!attachments)</span>
<a href="#l9.1185"></a><span id="l9.1185">     return nsnull;</span>
<a href="#l9.1186"></a><span id="l9.1186"> </span>
<a href="#l9.1187"></a><span id="l9.1187">   // Now get a readable name...</span>
<a href="#l9.1188"></a><span id="l9.1188">   nsCAutoString spec;</span>
<a href="#l9.1189"></a><span id="l9.1189">   url-&gt;GetSpec(spec);</span>
<a href="#l9.1190"></a><span id="l9.1190">   if (!spec.IsEmpty())</span>
<a href="#l9.1191"></a><span id="l9.1191">   {</span>
<a href="#l9.1192"></a><span id="l9.1192">     theName = strrchr(spec.get(), '/');</span>
<a href="#l9.1193"></a><span id="l9.1193">   }</span>
<a href="#l9.1194"></a><span id="l9.1194"> </span>
<a href="#l9.1195"></a><span id="l9.1195">   if (!theName)</span>
<a href="#l9.1196"></a><span id="l9.1196">     theName = &quot;Unknown&quot;; // Don't I18N this string...should never happen...</span>
<a href="#l9.1197"></a><span id="l9.1197">   else</span>
<a href="#l9.1198"></a><span id="l9.1198">     theName++;</span>
<a href="#l9.1199"></a><span id="l9.1199"> </span>
<a href="#l9.1200"></a><span id="l9.1200" class="difflineminus">-  memset(attachments, 0, sizeof(nsMsgAttachmentData) * attachCount);</span>
<a href="#l9.1201"></a><span id="l9.1201" class="difflineminus">-  attachments[0].url = url; // The URL to attach. This should be 0 to signify &quot;end of list&quot;.</span>
<a href="#l9.1202"></a><span id="l9.1202" class="difflineminus">-  attachments[0].real_name = (char *)PL_strdup(theName);  // The original name of this document, which will eventually show up in the</span>
<a href="#l9.1203"></a><span id="l9.1203" class="difflineplus">+  attachments[0].m_url = url; // The URL to attach.</span>
<a href="#l9.1204"></a><span id="l9.1204" class="difflineplus">+  attachments[0].m_realName = theName;  // The original name of this document, which will eventually show up in the</span>
<a href="#l9.1205"></a><span id="l9.1205"> </span>
<a href="#l9.1206"></a><span id="l9.1206">   NS_IF_ADDREF(url);</span>
<a href="#l9.1207"></a><span id="l9.1207">   return attachments;</span>
<a href="#l9.1208"></a><span id="l9.1208"> }</span>
<a href="#l9.1209"></a><span id="l9.1209"> </span>
<a href="#l9.1210"></a><span id="l9.1210"> //</span>
<a href="#l9.1211"></a><span id="l9.1211"> // Send the message to the magic folder, and runs the completion/failure</span>
<a href="#l9.1212"></a><span id="l9.1212"> // callback.</span>
<a href="#l9.1213"></a><span id="l9.1213" class="difflineat">@@ -5076,8 +4985,302 @@ NS_IMETHODIMP nsMsgComposeAndSend::GetCr</span>
<a href="#l9.1214"></a><span id="l9.1214"> }</span>
<a href="#l9.1215"></a><span id="l9.1215"> </span>
<a href="#l9.1216"></a><span id="l9.1216"> NS_IMETHODIMP nsMsgComposeAndSend::SetCryptoclosure(nsIMsgComposeSecure * aCryptoclosure)</span>
<a href="#l9.1217"></a><span id="l9.1217"> {</span>
<a href="#l9.1218"></a><span id="l9.1218">   m_crypto_closure = aCryptoclosure;</span>
<a href="#l9.1219"></a><span id="l9.1219">   return NS_OK;</span>
<a href="#l9.1220"></a><span id="l9.1220"> }</span>
<a href="#l9.1221"></a><span id="l9.1221"> </span>
<a href="#l9.1222"></a><span id="l9.1222" class="difflineplus">+NS_IMPL_ISUPPORTS1(nsMsgAttachmentData, nsIMsgAttachmentData)</span>
<a href="#l9.1223"></a><span id="l9.1223" class="difflineplus">+</span>
<a href="#l9.1224"></a><span id="l9.1224" class="difflineplus">+nsMsgAttachmentData::nsMsgAttachmentData() :  m_size(0), m_isExternalAttachment(0),</span>
<a href="#l9.1225"></a><span id="l9.1225" class="difflineplus">+  m_isDownloaded(PR_FALSE), m_hasFilename(PR_FALSE)</span>
<a href="#l9.1226"></a><span id="l9.1226" class="difflineplus">+{</span>
<a href="#l9.1227"></a><span id="l9.1227" class="difflineplus">+}</span>
<a href="#l9.1228"></a><span id="l9.1228" class="difflineplus">+</span>
<a href="#l9.1229"></a><span id="l9.1229" class="difflineplus">+nsMsgAttachmentData::~nsMsgAttachmentData()</span>
<a href="#l9.1230"></a><span id="l9.1230" class="difflineplus">+{</span>
<a href="#l9.1231"></a><span id="l9.1231" class="difflineplus">+}</span>
<a href="#l9.1232"></a><span id="l9.1232" class="difflineplus">+</span>
<a href="#l9.1233"></a><span id="l9.1233" class="difflineplus">+NS_IMETHODIMP nsMsgAttachmentData::GetUrl(nsIURI **aUrl)</span>
<a href="#l9.1234"></a><span id="l9.1234" class="difflineplus">+{</span>
<a href="#l9.1235"></a><span id="l9.1235" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aUrl);</span>
<a href="#l9.1236"></a><span id="l9.1236" class="difflineplus">+  NS_IF_ADDREF(*aUrl = m_url);</span>
<a href="#l9.1237"></a><span id="l9.1237" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.1238"></a><span id="l9.1238" class="difflineplus">+}</span>
<a href="#l9.1239"></a><span id="l9.1239" class="difflineplus">+</span>
<a href="#l9.1240"></a><span id="l9.1240" class="difflineplus">+NS_IMETHODIMP nsMsgAttachmentData::SetUrl(nsIURI *aUrl)</span>
<a href="#l9.1241"></a><span id="l9.1241" class="difflineplus">+{</span>
<a href="#l9.1242"></a><span id="l9.1242" class="difflineplus">+  m_url = aUrl;</span>
<a href="#l9.1243"></a><span id="l9.1243" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.1244"></a><span id="l9.1244" class="difflineplus">+}</span>
<a href="#l9.1245"></a><span id="l9.1245" class="difflineplus">+</span>
<a href="#l9.1246"></a><span id="l9.1246" class="difflineplus">+NS_IMETHODIMP nsMsgAttachmentData::GetDesiredType(nsACString &amp;aDesiredType)</span>
<a href="#l9.1247"></a><span id="l9.1247" class="difflineplus">+{</span>
<a href="#l9.1248"></a><span id="l9.1248" class="difflineplus">+  aDesiredType = m_desiredType;</span>
<a href="#l9.1249"></a><span id="l9.1249" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.1250"></a><span id="l9.1250" class="difflineplus">+}</span>
<a href="#l9.1251"></a><span id="l9.1251" class="difflineplus">+</span>
<a href="#l9.1252"></a><span id="l9.1252" class="difflineplus">+NS_IMETHODIMP nsMsgAttachmentData::SetDesiredType(const nsACString &amp;aDesiredType)</span>
<a href="#l9.1253"></a><span id="l9.1253" class="difflineplus">+{</span>
<a href="#l9.1254"></a><span id="l9.1254" class="difflineplus">+  m_desiredType = aDesiredType;</span>
<a href="#l9.1255"></a><span id="l9.1255" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.1256"></a><span id="l9.1256" class="difflineplus">+}</span>
<a href="#l9.1257"></a><span id="l9.1257" class="difflineplus">+</span>
<a href="#l9.1258"></a><span id="l9.1258" class="difflineplus">+NS_IMETHODIMP nsMsgAttachmentData::GetRealType(nsACString &amp;aRealType)</span>
<a href="#l9.1259"></a><span id="l9.1259" class="difflineplus">+{</span>
<a href="#l9.1260"></a><span id="l9.1260" class="difflineplus">+  aRealType = m_realType;</span>
<a href="#l9.1261"></a><span id="l9.1261" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.1262"></a><span id="l9.1262" class="difflineplus">+}</span>
<a href="#l9.1263"></a><span id="l9.1263" class="difflineplus">+</span>
<a href="#l9.1264"></a><span id="l9.1264" class="difflineplus">+NS_IMETHODIMP nsMsgAttachmentData::SetRealType(const nsACString &amp;aRealType)</span>
<a href="#l9.1265"></a><span id="l9.1265" class="difflineplus">+{</span>
<a href="#l9.1266"></a><span id="l9.1266" class="difflineplus">+  m_realType = aRealType;</span>
<a href="#l9.1267"></a><span id="l9.1267" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.1268"></a><span id="l9.1268" class="difflineplus">+}</span>
<a href="#l9.1269"></a><span id="l9.1269" class="difflineplus">+</span>
<a href="#l9.1270"></a><span id="l9.1270" class="difflineplus">+NS_IMETHODIMP nsMsgAttachmentData::GetRealEncoding(nsACString &amp;aRealEncoding)</span>
<a href="#l9.1271"></a><span id="l9.1271" class="difflineplus">+{</span>
<a href="#l9.1272"></a><span id="l9.1272" class="difflineplus">+  aRealEncoding = m_realEncoding;</span>
<a href="#l9.1273"></a><span id="l9.1273" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.1274"></a><span id="l9.1274" class="difflineplus">+}</span>
<a href="#l9.1275"></a><span id="l9.1275" class="difflineplus">+</span>
<a href="#l9.1276"></a><span id="l9.1276" class="difflineplus">+NS_IMETHODIMP nsMsgAttachmentData::SetRealEncoding(const nsACString &amp;aRealEncoding)</span>
<a href="#l9.1277"></a><span id="l9.1277" class="difflineplus">+{</span>
<a href="#l9.1278"></a><span id="l9.1278" class="difflineplus">+  m_realEncoding = aRealEncoding;</span>
<a href="#l9.1279"></a><span id="l9.1279" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.1280"></a><span id="l9.1280" class="difflineplus">+}</span>
<a href="#l9.1281"></a><span id="l9.1281" class="difflineplus">+</span>
<a href="#l9.1282"></a><span id="l9.1282" class="difflineplus">+NS_IMETHODIMP nsMsgAttachmentData::GetRealName(nsACString &amp;aRealName)</span>
<a href="#l9.1283"></a><span id="l9.1283" class="difflineplus">+{</span>
<a href="#l9.1284"></a><span id="l9.1284" class="difflineplus">+  aRealName = m_realName;</span>
<a href="#l9.1285"></a><span id="l9.1285" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.1286"></a><span id="l9.1286" class="difflineplus">+}</span>
<a href="#l9.1287"></a><span id="l9.1287" class="difflineplus">+</span>
<a href="#l9.1288"></a><span id="l9.1288" class="difflineplus">+NS_IMETHODIMP nsMsgAttachmentData::SetRealName(const nsACString &amp;aRealName)</span>
<a href="#l9.1289"></a><span id="l9.1289" class="difflineplus">+{</span>
<a href="#l9.1290"></a><span id="l9.1290" class="difflineplus">+  m_realName = aRealName;</span>
<a href="#l9.1291"></a><span id="l9.1291" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.1292"></a><span id="l9.1292" class="difflineplus">+}</span>
<a href="#l9.1293"></a><span id="l9.1293" class="difflineplus">+</span>
<a href="#l9.1294"></a><span id="l9.1294" class="difflineplus">+NS_IMETHODIMP nsMsgAttachmentData::GetDescription(nsACString &amp;aDescription)</span>
<a href="#l9.1295"></a><span id="l9.1295" class="difflineplus">+{</span>
<a href="#l9.1296"></a><span id="l9.1296" class="difflineplus">+  aDescription = m_description;</span>
<a href="#l9.1297"></a><span id="l9.1297" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.1298"></a><span id="l9.1298" class="difflineplus">+}</span>
<a href="#l9.1299"></a><span id="l9.1299" class="difflineplus">+</span>
<a href="#l9.1300"></a><span id="l9.1300" class="difflineplus">+NS_IMETHODIMP nsMsgAttachmentData::SetDescription(const nsACString &amp;aDescription)</span>
<a href="#l9.1301"></a><span id="l9.1301" class="difflineplus">+{</span>
<a href="#l9.1302"></a><span id="l9.1302" class="difflineplus">+  m_description = aDescription;</span>
<a href="#l9.1303"></a><span id="l9.1303" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.1304"></a><span id="l9.1304" class="difflineplus">+}</span>
<a href="#l9.1305"></a><span id="l9.1305" class="difflineplus">+</span>
<a href="#l9.1306"></a><span id="l9.1306" class="difflineplus">+NS_IMETHODIMP nsMsgAttachmentData::GetXMacType(nsACString &amp; aXMacType)</span>
<a href="#l9.1307"></a><span id="l9.1307" class="difflineplus">+{</span>
<a href="#l9.1308"></a><span id="l9.1308" class="difflineplus">+  aXMacType = m_xMacType;</span>
<a href="#l9.1309"></a><span id="l9.1309" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.1310"></a><span id="l9.1310" class="difflineplus">+}</span>
<a href="#l9.1311"></a><span id="l9.1311" class="difflineplus">+</span>
<a href="#l9.1312"></a><span id="l9.1312" class="difflineplus">+NS_IMETHODIMP nsMsgAttachmentData::SetXMacType(const nsACString &amp; aXMacType)</span>
<a href="#l9.1313"></a><span id="l9.1313" class="difflineplus">+{</span>
<a href="#l9.1314"></a><span id="l9.1314" class="difflineplus">+  m_xMacType = aXMacType;</span>
<a href="#l9.1315"></a><span id="l9.1315" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.1316"></a><span id="l9.1316" class="difflineplus">+}</span>
<a href="#l9.1317"></a><span id="l9.1317" class="difflineplus">+</span>
<a href="#l9.1318"></a><span id="l9.1318" class="difflineplus">+NS_IMETHODIMP nsMsgAttachmentData::GetXMacCreator(nsACString &amp; aXMacCreator)</span>
<a href="#l9.1319"></a><span id="l9.1319" class="difflineplus">+{</span>
<a href="#l9.1320"></a><span id="l9.1320" class="difflineplus">+  aXMacCreator = m_xMacCreator;</span>
<a href="#l9.1321"></a><span id="l9.1321" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.1322"></a><span id="l9.1322" class="difflineplus">+}</span>
<a href="#l9.1323"></a><span id="l9.1323" class="difflineplus">+</span>
<a href="#l9.1324"></a><span id="l9.1324" class="difflineplus">+NS_IMETHODIMP nsMsgAttachmentData::SetXMacCreator(const nsACString &amp; aXMacCreator)</span>
<a href="#l9.1325"></a><span id="l9.1325" class="difflineplus">+{</span>
<a href="#l9.1326"></a><span id="l9.1326" class="difflineplus">+  m_xMacCreator = aXMacCreator;</span>
<a href="#l9.1327"></a><span id="l9.1327" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.1328"></a><span id="l9.1328" class="difflineplus">+}</span>
<a href="#l9.1329"></a><span id="l9.1329" class="difflineplus">+</span>
<a href="#l9.1330"></a><span id="l9.1330" class="difflineplus">+NS_IMPL_ISUPPORTS1(nsMsgAttachedFile, nsIMsgAttachedFile)</span>
<a href="#l9.1331"></a><span id="l9.1331" class="difflineplus">+</span>
<a href="#l9.1332"></a><span id="l9.1332" class="difflineplus">+nsMsgAttachedFile::nsMsgAttachedFile() :  m_size(0), m_unprintableCount(0),</span>
<a href="#l9.1333"></a><span id="l9.1333" class="difflineplus">+  m_highbitCount(0), m_ctlCount(0), m_nullCount(0), m_maxLineLength(0)</span>
<a href="#l9.1334"></a><span id="l9.1334" class="difflineplus">+{</span>
<a href="#l9.1335"></a><span id="l9.1335" class="difflineplus">+}</span>
<a href="#l9.1336"></a><span id="l9.1336" class="difflineplus">+</span>
<a href="#l9.1337"></a><span id="l9.1337" class="difflineplus">+nsMsgAttachedFile::~nsMsgAttachedFile()</span>
<a href="#l9.1338"></a><span id="l9.1338" class="difflineplus">+{</span>
<a href="#l9.1339"></a><span id="l9.1339" class="difflineplus">+}</span>
<a href="#l9.1340"></a><span id="l9.1340" class="difflineplus">+</span>
<a href="#l9.1341"></a><span id="l9.1341" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::GetOrigUrl(nsIURI **aOrigUrl)</span>
<a href="#l9.1342"></a><span id="l9.1342" class="difflineplus">+{</span>
<a href="#l9.1343"></a><span id="l9.1343" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aOrigUrl);</span>
<a href="#l9.1344"></a><span id="l9.1344" class="difflineplus">+  NS_IF_ADDREF(*aOrigUrl = m_origUrl);</span>
<a href="#l9.1345"></a><span id="l9.1345" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.1346"></a><span id="l9.1346" class="difflineplus">+}</span>
<a href="#l9.1347"></a><span id="l9.1347" class="difflineplus">+</span>
<a href="#l9.1348"></a><span id="l9.1348" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::SetOrigUrl(nsIURI *aOrigUrl)</span>
<a href="#l9.1349"></a><span id="l9.1349" class="difflineplus">+{</span>
<a href="#l9.1350"></a><span id="l9.1350" class="difflineplus">+  m_origUrl = aOrigUrl;</span>
<a href="#l9.1351"></a><span id="l9.1351" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.1352"></a><span id="l9.1352" class="difflineplus">+}</span>
<a href="#l9.1353"></a><span id="l9.1353" class="difflineplus">+</span>
<a href="#l9.1354"></a><span id="l9.1354" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::GetTmpFile(nsILocalFile **aTmpFile)</span>
<a href="#l9.1355"></a><span id="l9.1355" class="difflineplus">+{</span>
<a href="#l9.1356"></a><span id="l9.1356" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aTmpFile);</span>
<a href="#l9.1357"></a><span id="l9.1357" class="difflineplus">+  NS_IF_ADDREF(*aTmpFile = m_tmpFile);</span>
<a href="#l9.1358"></a><span id="l9.1358" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.1359"></a><span id="l9.1359" class="difflineplus">+}</span>
<a href="#l9.1360"></a><span id="l9.1360" class="difflineplus">+</span>
<a href="#l9.1361"></a><span id="l9.1361" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::SetTmpFile(nsILocalFile *aTmpFile)</span>
<a href="#l9.1362"></a><span id="l9.1362" class="difflineplus">+{</span>
<a href="#l9.1363"></a><span id="l9.1363" class="difflineplus">+  m_tmpFile = aTmpFile;</span>
<a href="#l9.1364"></a><span id="l9.1364" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.1365"></a><span id="l9.1365" class="difflineplus">+}</span>
<a href="#l9.1366"></a><span id="l9.1366" class="difflineplus">+</span>
<a href="#l9.1367"></a><span id="l9.1367" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::GetType(nsACString &amp;aType)</span>
<a href="#l9.1368"></a><span id="l9.1368" class="difflineplus">+{</span>
<a href="#l9.1369"></a><span id="l9.1369" class="difflineplus">+  aType = m_type;</span>
<a href="#l9.1370"></a><span id="l9.1370" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.1371"></a><span id="l9.1371" class="difflineplus">+}</span>
<a href="#l9.1372"></a><span id="l9.1372" class="difflineplus">+</span>
<a href="#l9.1373"></a><span id="l9.1373" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::SetType(const nsACString &amp;aType)</span>
<a href="#l9.1374"></a><span id="l9.1374" class="difflineplus">+{</span>
<a href="#l9.1375"></a><span id="l9.1375" class="difflineplus">+  m_type = aType;</span>
<a href="#l9.1376"></a><span id="l9.1376" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.1377"></a><span id="l9.1377" class="difflineplus">+}</span>
<a href="#l9.1378"></a><span id="l9.1378" class="difflineplus">+</span>
<a href="#l9.1379"></a><span id="l9.1379" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::GetEncoding(nsACString &amp;aEncoding)</span>
<a href="#l9.1380"></a><span id="l9.1380" class="difflineplus">+{</span>
<a href="#l9.1381"></a><span id="l9.1381" class="difflineplus">+  aEncoding = m_encoding;</span>
<a href="#l9.1382"></a><span id="l9.1382" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.1383"></a><span id="l9.1383" class="difflineplus">+}</span>
<a href="#l9.1384"></a><span id="l9.1384" class="difflineplus">+</span>
<a href="#l9.1385"></a><span id="l9.1385" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::SetEncoding(const nsACString &amp;aEncoding)</span>
<a href="#l9.1386"></a><span id="l9.1386" class="difflineplus">+{</span>
<a href="#l9.1387"></a><span id="l9.1387" class="difflineplus">+  m_encoding = aEncoding;</span>
<a href="#l9.1388"></a><span id="l9.1388" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.1389"></a><span id="l9.1389" class="difflineplus">+}</span>
<a href="#l9.1390"></a><span id="l9.1390" class="difflineplus">+</span>
<a href="#l9.1391"></a><span id="l9.1391" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::GetDescription(nsACString &amp;aDescription)</span>
<a href="#l9.1392"></a><span id="l9.1392" class="difflineplus">+{</span>
<a href="#l9.1393"></a><span id="l9.1393" class="difflineplus">+  aDescription = m_description;</span>
<a href="#l9.1394"></a><span id="l9.1394" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.1395"></a><span id="l9.1395" class="difflineplus">+}</span>
<a href="#l9.1396"></a><span id="l9.1396" class="difflineplus">+</span>
<a href="#l9.1397"></a><span id="l9.1397" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::SetDescription(const nsACString &amp;aDescription)</span>
<a href="#l9.1398"></a><span id="l9.1398" class="difflineplus">+{</span>
<a href="#l9.1399"></a><span id="l9.1399" class="difflineplus">+  m_description = aDescription;</span>
<a href="#l9.1400"></a><span id="l9.1400" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.1401"></a><span id="l9.1401" class="difflineplus">+}</span>
<a href="#l9.1402"></a><span id="l9.1402" class="difflineplus">+</span>
<a href="#l9.1403"></a><span id="l9.1403" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::GetXMacType(nsACString &amp; aXMacType)</span>
<a href="#l9.1404"></a><span id="l9.1404" class="difflineplus">+{</span>
<a href="#l9.1405"></a><span id="l9.1405" class="difflineplus">+  aXMacType = m_xMacType;</span>
<a href="#l9.1406"></a><span id="l9.1406" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.1407"></a><span id="l9.1407" class="difflineplus">+}</span>
<a href="#l9.1408"></a><span id="l9.1408" class="difflineplus">+</span>
<a href="#l9.1409"></a><span id="l9.1409" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::SetXMacType(const nsACString &amp; aXMacType)</span>
<a href="#l9.1410"></a><span id="l9.1410" class="difflineplus">+{</span>
<a href="#l9.1411"></a><span id="l9.1411" class="difflineplus">+  m_xMacType = aXMacType;</span>
<a href="#l9.1412"></a><span id="l9.1412" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.1413"></a><span id="l9.1413" class="difflineplus">+}</span>
<a href="#l9.1414"></a><span id="l9.1414" class="difflineplus">+</span>
<a href="#l9.1415"></a><span id="l9.1415" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::GetXMacCreator(nsACString &amp; aXMacCreator)</span>
<a href="#l9.1416"></a><span id="l9.1416" class="difflineplus">+{</span>
<a href="#l9.1417"></a><span id="l9.1417" class="difflineplus">+  aXMacCreator = m_xMacCreator;</span>
<a href="#l9.1418"></a><span id="l9.1418" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.1419"></a><span id="l9.1419" class="difflineplus">+}</span>
<a href="#l9.1420"></a><span id="l9.1420" class="difflineplus">+</span>
<a href="#l9.1421"></a><span id="l9.1421" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::SetXMacCreator(const nsACString &amp; aXMacCreator)</span>
<a href="#l9.1422"></a><span id="l9.1422" class="difflineplus">+{</span>
<a href="#l9.1423"></a><span id="l9.1423" class="difflineplus">+  m_xMacCreator = aXMacCreator;</span>
<a href="#l9.1424"></a><span id="l9.1424" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.1425"></a><span id="l9.1425" class="difflineplus">+}</span>
<a href="#l9.1426"></a><span id="l9.1426" class="difflineplus">+</span>
<a href="#l9.1427"></a><span id="l9.1427" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::GetRealName(nsACString &amp; aRealName)</span>
<a href="#l9.1428"></a><span id="l9.1428" class="difflineplus">+{</span>
<a href="#l9.1429"></a><span id="l9.1429" class="difflineplus">+  aRealName = m_realName;</span>
<a href="#l9.1430"></a><span id="l9.1430" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.1431"></a><span id="l9.1431" class="difflineplus">+}</span>
<a href="#l9.1432"></a><span id="l9.1432" class="difflineplus">+</span>
<a href="#l9.1433"></a><span id="l9.1433" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::SetRealName(const nsACString &amp; aRealName)</span>
<a href="#l9.1434"></a><span id="l9.1434" class="difflineplus">+{</span>
<a href="#l9.1435"></a><span id="l9.1435" class="difflineplus">+  m_realName = aRealName;</span>
<a href="#l9.1436"></a><span id="l9.1436" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.1437"></a><span id="l9.1437" class="difflineplus">+}</span>
<a href="#l9.1438"></a><span id="l9.1438" class="difflineplus">+</span>
<a href="#l9.1439"></a><span id="l9.1439" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::GetSize(PRUint32 *aSize)</span>
<a href="#l9.1440"></a><span id="l9.1440" class="difflineplus">+{</span>
<a href="#l9.1441"></a><span id="l9.1441" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aSize);</span>
<a href="#l9.1442"></a><span id="l9.1442" class="difflineplus">+  *aSize = m_size;</span>
<a href="#l9.1443"></a><span id="l9.1443" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.1444"></a><span id="l9.1444" class="difflineplus">+}</span>
<a href="#l9.1445"></a><span id="l9.1445" class="difflineplus">+</span>
<a href="#l9.1446"></a><span id="l9.1446" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::SetSize(PRUint32 aSize)</span>
<a href="#l9.1447"></a><span id="l9.1447" class="difflineplus">+{</span>
<a href="#l9.1448"></a><span id="l9.1448" class="difflineplus">+  m_size = aSize;</span>
<a href="#l9.1449"></a><span id="l9.1449" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.1450"></a><span id="l9.1450" class="difflineplus">+}</span>
<a href="#l9.1451"></a><span id="l9.1451" class="difflineplus">+</span>
<a href="#l9.1452"></a><span id="l9.1452" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::GetUnprintableCount(PRUint32 *aUnprintableCount)</span>
<a href="#l9.1453"></a><span id="l9.1453" class="difflineplus">+{</span>
<a href="#l9.1454"></a><span id="l9.1454" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aUnprintableCount);</span>
<a href="#l9.1455"></a><span id="l9.1455" class="difflineplus">+  *aUnprintableCount = m_unprintableCount;</span>
<a href="#l9.1456"></a><span id="l9.1456" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.1457"></a><span id="l9.1457" class="difflineplus">+}</span>
<a href="#l9.1458"></a><span id="l9.1458" class="difflineplus">+</span>
<a href="#l9.1459"></a><span id="l9.1459" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::SetUnprintableCount(PRUint32 aUnprintableCount)</span>
<a href="#l9.1460"></a><span id="l9.1460" class="difflineplus">+{</span>
<a href="#l9.1461"></a><span id="l9.1461" class="difflineplus">+  m_unprintableCount = aUnprintableCount;</span>
<a href="#l9.1462"></a><span id="l9.1462" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.1463"></a><span id="l9.1463" class="difflineplus">+}</span>
<a href="#l9.1464"></a><span id="l9.1464" class="difflineplus">+</span>
<a href="#l9.1465"></a><span id="l9.1465" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::GetHighbitCount(PRUint32 *aHighbitCount)</span>
<a href="#l9.1466"></a><span id="l9.1466" class="difflineplus">+{</span>
<a href="#l9.1467"></a><span id="l9.1467" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aHighbitCount);</span>
<a href="#l9.1468"></a><span id="l9.1468" class="difflineplus">+  *aHighbitCount = m_highbitCount;</span>
<a href="#l9.1469"></a><span id="l9.1469" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.1470"></a><span id="l9.1470" class="difflineplus">+}</span>
<a href="#l9.1471"></a><span id="l9.1471" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::SetHighbitCount(PRUint32 aHighbitCount)</span>
<a href="#l9.1472"></a><span id="l9.1472" class="difflineplus">+{</span>
<a href="#l9.1473"></a><span id="l9.1473" class="difflineplus">+  m_highbitCount = aHighbitCount;</span>
<a href="#l9.1474"></a><span id="l9.1474" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.1475"></a><span id="l9.1475" class="difflineplus">+}</span>
<a href="#l9.1476"></a><span id="l9.1476" class="difflineplus">+</span>
<a href="#l9.1477"></a><span id="l9.1477" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::GetCtlCount(PRUint32 *aCtlCount)</span>
<a href="#l9.1478"></a><span id="l9.1478" class="difflineplus">+{</span>
<a href="#l9.1479"></a><span id="l9.1479" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aCtlCount);</span>
<a href="#l9.1480"></a><span id="l9.1480" class="difflineplus">+  *aCtlCount = m_ctlCount;</span>
<a href="#l9.1481"></a><span id="l9.1481" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.1482"></a><span id="l9.1482" class="difflineplus">+}</span>
<a href="#l9.1483"></a><span id="l9.1483" class="difflineplus">+</span>
<a href="#l9.1484"></a><span id="l9.1484" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::SetCtlCount(PRUint32 aCtlCount)</span>
<a href="#l9.1485"></a><span id="l9.1485" class="difflineplus">+{</span>
<a href="#l9.1486"></a><span id="l9.1486" class="difflineplus">+  m_ctlCount = aCtlCount;</span>
<a href="#l9.1487"></a><span id="l9.1487" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.1488"></a><span id="l9.1488" class="difflineplus">+}</span>
<a href="#l9.1489"></a><span id="l9.1489" class="difflineplus">+</span>
<a href="#l9.1490"></a><span id="l9.1490" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::GetNullCount(PRUint32 *aNullCount)</span>
<a href="#l9.1491"></a><span id="l9.1491" class="difflineplus">+{</span>
<a href="#l9.1492"></a><span id="l9.1492" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aNullCount);</span>
<a href="#l9.1493"></a><span id="l9.1493" class="difflineplus">+  *aNullCount = m_nullCount;</span>
<a href="#l9.1494"></a><span id="l9.1494" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.1495"></a><span id="l9.1495" class="difflineplus">+}</span>
<a href="#l9.1496"></a><span id="l9.1496" class="difflineplus">+</span>
<a href="#l9.1497"></a><span id="l9.1497" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::SetNullCount(PRUint32 aNullCount)</span>
<a href="#l9.1498"></a><span id="l9.1498" class="difflineplus">+{</span>
<a href="#l9.1499"></a><span id="l9.1499" class="difflineplus">+  m_nullCount = aNullCount;</span>
<a href="#l9.1500"></a><span id="l9.1500" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.1501"></a><span id="l9.1501" class="difflineplus">+}</span>
<a href="#l9.1502"></a><span id="l9.1502" class="difflineplus">+</span>
<a href="#l9.1503"></a><span id="l9.1503" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::GetMaxLineLength(PRUint32 *aMaxLineLength)</span>
<a href="#l9.1504"></a><span id="l9.1504" class="difflineplus">+{</span>
<a href="#l9.1505"></a><span id="l9.1505" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aMaxLineLength);</span>
<a href="#l9.1506"></a><span id="l9.1506" class="difflineplus">+  *aMaxLineLength = m_maxLineLength;</span>
<a href="#l9.1507"></a><span id="l9.1507" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.1508"></a><span id="l9.1508" class="difflineplus">+}</span>
<a href="#l9.1509"></a><span id="l9.1509" class="difflineplus">+</span>
<a href="#l9.1510"></a><span id="l9.1510" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::SetMaxLineLength(PRUint32 aMaxLineLength)</span>
<a href="#l9.1511"></a><span id="l9.1511" class="difflineplus">+{</span>
<a href="#l9.1512"></a><span id="l9.1512" class="difflineplus">+  m_maxLineLength = aMaxLineLength;</span>
<a href="#l9.1513"></a><span id="l9.1513" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.1514"></a><span id="l9.1514" class="difflineplus">+}</span>
<a href="#l9.1515"></a><span id="l9.1515" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSend.h</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSend.h</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -156,17 +156,16 @@</span>
<a href="#l10.4"></a><span id="l10.4"> #include &quot;nsIMsgIdentity.h&quot;</span>
<a href="#l10.5"></a><span id="l10.5"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l10.6"></a><span id="l10.6"> #include &quot;nsIMsgIdentity.h&quot;</span>
<a href="#l10.7"></a><span id="l10.7"> #include &quot;nsWeakReference.h&quot;</span>
<a href="#l10.8"></a><span id="l10.8"> #include &quot;nsIDOMWindow.h&quot;</span>
<a href="#l10.9"></a><span id="l10.9"> #include &quot;nsIMsgComposeSecure.h&quot;</span>
<a href="#l10.10"></a><span id="l10.10"> #include &quot;nsAutoPtr.h&quot;</span>
<a href="#l10.11"></a><span id="l10.11"> #include &quot;nsISupportsArray.h&quot;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-</span>
<a href="#l10.13"></a><span id="l10.13"> //</span>
<a href="#l10.14"></a><span id="l10.14"> // Some necessary defines...</span>
<a href="#l10.15"></a><span id="l10.15"> //</span>
<a href="#l10.16"></a><span id="l10.16"> #define TEN_K                 10240</span>
<a href="#l10.17"></a><span id="l10.17"> #define MIME_BUFFER_SIZE      4096 // must be greater than 1000</span>
<a href="#l10.18"></a><span id="l10.18">                                    // SMTP (RFC821) limit</span>
<a href="#l10.19"></a><span id="l10.19"> </span>
<a href="#l10.20"></a><span id="l10.20"> //</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineat">@@ -192,17 +191,17 @@ class nsMsgComposeAndSend : public nsIMs</span>
<a href="#l10.22"></a><span id="l10.22"> public:</span>
<a href="#l10.23"></a><span id="l10.23">   //</span>
<a href="#l10.24"></a><span id="l10.24">   // The exit method used when downloading attachments only.</span>
<a href="#l10.25"></a><span id="l10.25">   // This still may be useful because of the fact that it is an</span>
<a href="#l10.26"></a><span id="l10.26">   // internal callback only. This way, no thread boundry issues and</span>
<a href="#l10.27"></a><span id="l10.27">   // we can get away without all of the listener array code.</span>
<a href="#l10.28"></a><span id="l10.28">   //</span>
<a href="#l10.29"></a><span id="l10.29">   void (*m_attachments_done_callback) (nsresult  status,</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">-        const PRUnichar *error_msg, struct nsMsgAttachedFile *attachments);</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+        const PRUnichar *error_msg, nsMsgAttachedFile *attachments);</span>
<a href="#l10.32"></a><span id="l10.32"> </span>
<a href="#l10.33"></a><span id="l10.33">   //</span>
<a href="#l10.34"></a><span id="l10.34">   // Define QueryInterface, AddRef and Release for this class</span>
<a href="#l10.35"></a><span id="l10.35">   //</span>
<a href="#l10.36"></a><span id="l10.36">   NS_DECL_ISUPPORTS</span>
<a href="#l10.37"></a><span id="l10.37"> </span>
<a href="#l10.38"></a><span id="l10.38">   nsMsgComposeAndSend();</span>
<a href="#l10.39"></a><span id="l10.39">   virtual     ~nsMsgComposeAndSend();</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineat">@@ -245,18 +244,18 @@ public:</span>
<a href="#l10.41"></a><span id="l10.41">                    nsIFile          *sendFile,</span>
<a href="#l10.42"></a><span id="l10.42">                    PRBool           digest_p,</span>
<a href="#l10.43"></a><span id="l10.43">                    PRBool           dont_deliver_p,</span>
<a href="#l10.44"></a><span id="l10.44">                    nsMsgDeliverMode mode,</span>
<a href="#l10.45"></a><span id="l10.45">                    nsIMsgDBHdr      *msgToReplace,</span>
<a href="#l10.46"></a><span id="l10.46">                    const char       *attachment1_type,</span>
<a href="#l10.47"></a><span id="l10.47">                    const char       *attachment1_body,</span>
<a href="#l10.48"></a><span id="l10.48">                    PRUint32         attachment1_body_length,</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineminus">-                   const nsMsgAttachmentData   *attachments,</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineminus">-                   const nsMsgAttachedFile     *preloaded_attachments,</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+                   nsIArray   *attachments,</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+                   nsIArray     *preloaded_attachments,</span>
<a href="#l10.53"></a><span id="l10.53">                    const char       *password,</span>
<a href="#l10.54"></a><span id="l10.54">                    const nsACString &amp;aOriginalMsgURI,</span>
<a href="#l10.55"></a><span id="l10.55">                    MSG_ComposeType  aType);</span>
<a href="#l10.56"></a><span id="l10.56"> </span>
<a href="#l10.57"></a><span id="l10.57">   //</span>
<a href="#l10.58"></a><span id="l10.58">   // Setup the composition fields</span>
<a href="#l10.59"></a><span id="l10.59">   //</span>
<a href="#l10.60"></a><span id="l10.60">   nsresult    InitCompositionFields(nsMsgCompFields *fields,</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineat">@@ -265,18 +264,18 @@ public:</span>
<a href="#l10.62"></a><span id="l10.62"> </span>
<a href="#l10.63"></a><span id="l10.63">   int         SetMimeHeader(nsMsgCompFields::MsgHeaderID header, const char *value);</span>
<a href="#l10.64"></a><span id="l10.64">   NS_IMETHOD  GetBodyFromEditor();</span>
<a href="#l10.65"></a><span id="l10.65"> </span>
<a href="#l10.66"></a><span id="l10.66"> </span>
<a href="#l10.67"></a><span id="l10.67">   //</span>
<a href="#l10.68"></a><span id="l10.68">   // Attachment processing...</span>
<a href="#l10.69"></a><span id="l10.69">   //</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineminus">-  nsresult    HackAttachments(const struct nsMsgAttachmentData *attachments,</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineminus">-                              const struct nsMsgAttachedFile *preloaded_attachments);</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineplus">+  nsresult    HackAttachments(nsIArray *attachments,</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineplus">+                              nsIArray *preloaded_attachments);</span>
<a href="#l10.74"></a><span id="l10.74">   nsresult    CountCompFieldAttachments();</span>
<a href="#l10.75"></a><span id="l10.75">   nsresult    AddCompFieldLocalAttachments();</span>
<a href="#l10.76"></a><span id="l10.76">   nsresult    AddCompFieldRemoteAttachments(PRUint32  aStartLocation, PRInt32 *aMailboxCount, PRInt32 *aNewsCount);</span>
<a href="#l10.77"></a><span id="l10.77"> </span>
<a href="#l10.78"></a><span id="l10.78">   // Deal with multipart related data</span>
<a href="#l10.79"></a><span id="l10.79">   nsresult    ProcessMultipartRelated(PRInt32 *aMailboxCount, PRInt32 *aNewsCount);</span>
<a href="#l10.80"></a><span id="l10.80">   nsresult    GetEmbeddedObjectInfo(nsIDOMNode *node, nsMsgAttachmentData *attachment, PRBool *acceptObject);</span>
<a href="#l10.81"></a><span id="l10.81">   PRUint32    GetMultipartRelatedCount(PRBool forceToBeCalculated = PR_FALSE);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraCompose.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/import/eudora/src/nsEudoraCompose.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -66,16 +66,17 @@</span>
<a href="#l11.4"></a><span id="l11.4"> #include &quot;nsEudoraEditor.h&quot;</span>
<a href="#l11.5"></a><span id="l11.5"> </span>
<a href="#l11.6"></a><span id="l11.6"> #include &quot;EudoraDebugLog.h&quot;</span>
<a href="#l11.7"></a><span id="l11.7"> </span>
<a href="#l11.8"></a><span id="l11.8"> #include &quot;nsMimeTypes.h&quot;</span>
<a href="#l11.9"></a><span id="l11.9"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l11.10"></a><span id="l11.10"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l11.11"></a><span id="l11.11"> #include &quot;nsAutoPtr.h&quot;</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+#include &quot;nsIMutableArray.h&quot;</span>
<a href="#l11.13"></a><span id="l11.13"> </span>
<a href="#l11.14"></a><span id="l11.14"> static NS_DEFINE_CID( kMsgSendCID, NS_MSGSEND_CID);</span>
<a href="#l11.15"></a><span id="l11.15"> static NS_DEFINE_CID( kMsgCompFieldsCID, NS_MSGCOMPFIELDS_CID);</span>
<a href="#l11.16"></a><span id="l11.16"> </span>
<a href="#l11.17"></a><span id="l11.17"> // We need to do some calculations to set these numbers to something reasonable!</span>
<a href="#l11.18"></a><span id="l11.18"> // Unless of course, CreateAndSendMessage will NEVER EVER leave us in the lurch</span>
<a href="#l11.19"></a><span id="l11.19"> #define kHungCount 100000</span>
<a href="#l11.20"></a><span id="l11.20"> #define kHungAbortCount 1000</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineat">@@ -505,80 +506,64 @@ void nsEudoraCompose::ExtractType( nsStr</span>
<a href="#l11.22"></a><span id="l11.22">   // valid multipart!</span>
<a href="#l11.23"></a><span id="l11.23">   if (str.Length() &gt; 10) {</span>
<a href="#l11.24"></a><span id="l11.24">     str.Left( tStr, 10);</span>
<a href="#l11.25"></a><span id="l11.25">     if (tStr.LowerCaseEqualsLiteral(&quot;multipart/&quot;))</span>
<a href="#l11.26"></a><span id="l11.26">       str.Truncate();</span>
<a href="#l11.27"></a><span id="l11.27">   }</span>
<a href="#l11.28"></a><span id="l11.28"> }</span>
<a href="#l11.29"></a><span id="l11.29"> </span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-void nsEudoraCompose::CleanUpAttach( nsMsgAttachedFile *a, PRInt32 count)</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-{</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-  for (PRInt32 i = 0; i &lt; count; i++) {</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-    a[i].orig_url=nsnull;</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-    if (a[i].type)</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineminus">-      NS_Free( a[i].type);</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineminus">-    if (a[i].description)</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineminus">-      NS_Free( a[i].description);</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineminus">-    if (a[i].encoding)</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-      NS_Free( a[i].encoding);</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineminus">-  }</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineminus">-  delete [] a;</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineminus">-}</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineminus">-</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineminus">-nsMsgAttachedFile * nsEudoraCompose::GetLocalAttachments( void)</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineplus">+nsresult nsEudoraCompose::GetLocalAttachments(nsIArray **aArray)</span>
<a href="#l11.46"></a><span id="l11.46"> {</span>
<a href="#l11.47"></a><span id="l11.47">   /*</span>
<a href="#l11.48"></a><span id="l11.48">   nsIURI      *url = nsnull;</span>
<a href="#l11.49"></a><span id="l11.49">   */</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineminus">-</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+  nsresult rv;</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; attachments (do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineplus">+  NS_IF_ADDREF(*aArray = attachments);</span>
<a href="#l11.55"></a><span id="l11.55">   PRInt32 count = 0;</span>
<a href="#l11.56"></a><span id="l11.56">   if (m_pAttachments)</span>
<a href="#l11.57"></a><span id="l11.57">     count = m_pAttachments-&gt;Count();</span>
<a href="#l11.58"></a><span id="l11.58">   if (!count)</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineminus">-    return( nsnull);</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineminus">-</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineminus">-  nsMsgAttachedFile *a = (nsMsgAttachedFile *) new nsMsgAttachedFile[count + 1];</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineminus">-  if (!a)</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineminus">-    return( nsnull);</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineminus">-  memset(a, 0, sizeof(nsMsgAttachedFile) * (count + 1));</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineplus">+    return NS_OK;</span>
<a href="#l11.66"></a><span id="l11.66"> </span>
<a href="#l11.67"></a><span id="l11.67">   nsCString urlStr;</span>
<a href="#l11.68"></a><span id="l11.68">   ImportAttachment * pAttach;</span>
<a href="#l11.69"></a><span id="l11.69"> </span>
<a href="#l11.70"></a><span id="l11.70">   for (PRInt32 i = 0; i &lt; count; i++) {</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+    nsCOMPtr&lt;nsIMsgAttachedFile&gt; a(do_CreateInstance(NS_MSGATTACHEDFILE_CONTRACTID, &amp;rv));</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.73"></a><span id="l11.73">     // nsMsgNewURL(&amp;url, &quot;file://C:/boxster.jpg&quot;);</span>
<a href="#l11.74"></a><span id="l11.74">     // a[i].orig_url = url;</span>
<a href="#l11.75"></a><span id="l11.75"> </span>
<a href="#l11.76"></a><span id="l11.76">     // NS_PRECONDITION( PR_FALSE, &quot;Forced Break&quot;);</span>
<a href="#l11.77"></a><span id="l11.77"> </span>
<a href="#l11.78"></a><span id="l11.78">     pAttach = (ImportAttachment *) m_pAttachments-&gt;ElementAt( i);</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineminus">-                a[i].tmp_file = do_QueryInterface(pAttach-&gt;pAttachment);</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineplus">+    nsCOMPtr&lt;nsILocalFile&gt; tmpFile = do_QueryInterface(pAttach-&gt;pAttachment);</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineplus">+    a-&gt;SetTmpFile(tmpFile);</span>
<a href="#l11.82"></a><span id="l11.82">     urlStr.Adopt(0);</span>
<a href="#l11.83"></a><span id="l11.83"> </span>
<a href="#l11.84"></a><span id="l11.84">     nsCOMPtr &lt;nsIURI&gt; uri;</span>
<a href="#l11.85"></a><span id="l11.85">     nsresult rv = NS_NewFileURI(getter_AddRefs(uri), pAttach-&gt;pAttachment);</span>
<a href="#l11.86"></a><span id="l11.86">     NS_ENSURE_SUCCESS(rv, nsnull);</span>
<a href="#l11.87"></a><span id="l11.87">     uri-&gt;GetSpec(urlStr);</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineminus">-    if (urlStr.IsEmpty()) {</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineminus">-      CleanUpAttach( a, count);</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineminus">-      return( nsnull);</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineminus">-    }</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineminus">-    rv = m_pIOService-&gt;NewURI( urlStr, nsnull, nsnull, getter_AddRefs(a[i].orig_url));</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineminus">-    if (NS_FAILED( rv)) {</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineminus">-      CleanUpAttach( a, count);</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineminus">-      return( nsnull);</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineminus">-    }</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineplus">+    if (urlStr.IsEmpty())</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineplus">+      return NS_ERROR_FAILURE;</span>
<a href="#l11.99"></a><span id="l11.99"> </span>
<a href="#l11.100"></a><span id="l11.100" class="difflineminus">-    a[i].type = strdup( pAttach-&gt;mimeType);</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineminus">-    a[i].real_name = strdup( pAttach-&gt;description);</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineminus">-    a[i].encoding = strdup( ENCODING_BINARY);</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineplus">+    nsCOMPtr&lt;nsIURI&gt; origUrl;</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineplus">+    rv = m_pIOService-&gt;NewURI( urlStr, nsnull, nsnull, getter_AddRefs(origUrl));</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineplus">+    a-&gt;SetOrigUrl(origUrl);</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineplus">+    a-&gt;SetType(nsDependentCString(pAttach-&gt;mimeType));</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineplus">+    a-&gt;SetRealName(nsDependentCString(pAttach-&gt;description));</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineplus">+    a-&gt;SetEncoding(NS_LITERAL_CSTRING(ENCODING_BINARY));</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineplus">+    attachments-&gt;AppendElement(a, PR_FALSE);</span>
<a href="#l11.111"></a><span id="l11.111">   }</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineminus">-</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineminus">-  return( a);</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.115"></a><span id="l11.115"> }</span>
<a href="#l11.116"></a><span id="l11.116"> </span>
<a href="#l11.117"></a><span id="l11.117"> // Test a message send????</span>
<a href="#l11.118"></a><span id="l11.118"> nsresult nsEudoraCompose::SendTheMessage(nsIFile *pMailImportLocation, nsIFile **pMsg)</span>
<a href="#l11.119"></a><span id="l11.119"> {</span>
<a href="#l11.120"></a><span id="l11.120">   nsresult rv = CreateComponents();</span>
<a href="#l11.121"></a><span id="l11.121">   if (NS_SUCCEEDED( rv))</span>
<a href="#l11.122"></a><span id="l11.122">     rv = CreateIdentity();</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineat">@@ -639,18 +624,18 @@ nsresult nsEudoraCompose::SendTheMessage</span>
<a href="#l11.124"></a><span id="l11.124">   // what about all of the other headers?!?!?!?!?!?!</span>
<a href="#l11.125"></a><span id="l11.125">   char *pMimeType;</span>
<a href="#l11.126"></a><span id="l11.126">   if (!bodyType.IsEmpty())</span>
<a href="#l11.127"></a><span id="l11.127">     pMimeType = ToNewCString(bodyType);</span>
<a href="#l11.128"></a><span id="l11.128">   else</span>
<a href="#l11.129"></a><span id="l11.129">     pMimeType = ToNewCString(m_bodyType);</span>
<a href="#l11.130"></a><span id="l11.130"> </span>
<a href="#l11.131"></a><span id="l11.131">   // IMPORT_LOG0( &quot;Outlook compose calling CreateAndSendMessage\n&quot;);</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineminus">-  nsMsgAttachedFile *pAttach = GetLocalAttachments();</span>
<a href="#l11.133"></a><span id="l11.133" class="difflineminus">-</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineplus">+  nsCOMPtr&lt;nsIArray&gt; pAttach;</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineplus">+  GetLocalAttachments(getter_AddRefs(pAttach));</span>
<a href="#l11.136"></a><span id="l11.136"> </span>
<a href="#l11.137"></a><span id="l11.137">   /*</span>
<a href="#l11.138"></a><span id="l11.138">     l10n - I have the body of the message in the system charset,</span>
<a href="#l11.139"></a><span id="l11.139">     I need to &quot;encode&quot; it to be the charset for the message</span>
<a href="#l11.140"></a><span id="l11.140">     *UNLESS* of course, I don't know what the charset of the message</span>
<a href="#l11.141"></a><span id="l11.141">     should be?  How do I determine what the charset should</span>
<a href="#l11.142"></a><span id="l11.142">     be if it doesn't exist?</span>
<a href="#l11.143"></a><span id="l11.143"> </span>
<a href="#l11.144"></a><span id="l11.144" class="difflineat">@@ -706,19 +691,16 @@ nsresult nsEudoraCompose::SendTheMessage</span>
<a href="#l11.145"></a><span id="l11.145">                         pMimeType,                    // body type</span>
<a href="#l11.146"></a><span id="l11.146">                         body.get(),                   // body pointer</span>
<a href="#l11.147"></a><span id="l11.147">                         body.Length(),                // body length</span>
<a href="#l11.148"></a><span id="l11.148">                         pAttach,                      // local attachments</span>
<a href="#l11.149"></a><span id="l11.149">                         m_pListener);              // originalMsgURI</span>
<a href="#l11.150"></a><span id="l11.150"> </span>
<a href="#l11.151"></a><span id="l11.151">   // IMPORT_LOG0( &quot;Returned from ProxySend\n&quot;);</span>
<a href="#l11.152"></a><span id="l11.152"> </span>
<a href="#l11.153"></a><span id="l11.153" class="difflineminus">-  if (pAttach)</span>
<a href="#l11.154"></a><span id="l11.154" class="difflineminus">-    delete [] pAttach;</span>
<a href="#l11.155"></a><span id="l11.155" class="difflineminus">-</span>
<a href="#l11.156"></a><span id="l11.156">   EudoraSendListener *pListen = (EudoraSendListener *)m_pListener;</span>
<a href="#l11.157"></a><span id="l11.157">   if (NS_FAILED( rv)) {</span>
<a href="#l11.158"></a><span id="l11.158">     IMPORT_LOG1( &quot;*** Error, CreateAndSendMessage FAILED: 0x%lx\n&quot;, rv);</span>
<a href="#l11.159"></a><span id="l11.159">     // IMPORT_LOG1( &quot;Headers: %80s\n&quot;, m_pHeaders);</span>
<a href="#l11.160"></a><span id="l11.160">   }</span>
<a href="#l11.161"></a><span id="l11.161">   else {</span>
<a href="#l11.162"></a><span id="l11.162">     // wait for the listener to get done!</span>
<a href="#l11.163"></a><span id="l11.163">     PRInt32 abortCnt = 0;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraCompose.h</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/import/eudora/src/nsEudoraCompose.h</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -155,18 +155,17 @@ private:</span>
<a href="#l12.4"></a><span id="l12.4">     val.Truncate();</span>
<a href="#l12.5"></a><span id="l12.5">     nsCString  hVal;</span>
<a href="#l12.6"></a><span id="l12.6">     GetHeaderValue( pData, dataLen, pHeader, hVal, PR_TRUE);</span>
<a href="#l12.7"></a><span id="l12.7">     NS_CopyNativeToUnicode( hVal, val);</span>
<a href="#l12.8"></a><span id="l12.8">   }</span>
<a href="#l12.9"></a><span id="l12.9">   void    ExtractCharset( nsString&amp; str);</span>
<a href="#l12.10"></a><span id="l12.10">   void    ExtractType( nsString&amp; str);</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-  nsMsgAttachedFile * GetLocalAttachments( void);</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-  void        CleanUpAttach( nsMsgAttachedFile *a, PRInt32 count);</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+  nsresult GetLocalAttachments(nsIArray **aArray);</span>
<a href="#l12.15"></a><span id="l12.15"> </span>
<a href="#l12.16"></a><span id="l12.16">   nsresult  ReadHeaders( ReadFileState *pState, SimpleBufferTonyRCopiedOnce&amp; copy, SimpleBufferTonyRCopiedOnce&amp; header);</span>
<a href="#l12.17"></a><span id="l12.17">   PRInt32    FindNextEndLine( SimpleBufferTonyRCopiedOnce&amp; data);</span>
<a href="#l12.18"></a><span id="l12.18">   PRInt32    IsEndHeaders( SimpleBufferTonyRCopiedOnce&amp; data);</span>
<a href="#l12.19"></a><span id="l12.19">   PRInt32    IsSpecialHeader( const char *pHeader);</span>
<a href="#l12.20"></a><span id="l12.20">   nsresult  WriteHeaders( nsIOutputStream *pDst, SimpleBufferTonyRCopiedOnce&amp; newHeaders);</span>
<a href="#l12.21"></a><span id="l12.21">   PRBool    IsReplaceHeader( const char *pHeader);</span>
<a href="#l12.22"></a><span id="l12.22"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraImport.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/import/eudora/src/nsEudoraImport.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -523,19 +523,16 @@ NS_IMETHODIMP ImportEudoraMailImpl::Impo</span>
<a href="#l13.4"></a><span id="l13.4">             PRUnichar **pErrorLog,</span>
<a href="#l13.5"></a><span id="l13.5">             PRUnichar **pSuccessLog,</span>
<a href="#l13.6"></a><span id="l13.6">             PRBool *fatalError)</span>
<a href="#l13.7"></a><span id="l13.7"> {</span>
<a href="#l13.8"></a><span id="l13.8">   NS_PRECONDITION(pSource != nsnull, &quot;null ptr&quot;);</span>
<a href="#l13.9"></a><span id="l13.9">   NS_PRECONDITION(pDestination != nsnull, &quot;null ptr&quot;);</span>
<a href="#l13.10"></a><span id="l13.10">   NS_PRECONDITION(fatalError != nsnull, &quot;null ptr&quot;);</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-  nsCOMPtr&lt;nsIStringBundle&gt; bundle( dont_AddRef( nsEudoraStringBundle::GetStringBundle()));</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-</span>
<a href="#l13.15"></a><span id="l13.15">   nsString  success;</span>
<a href="#l13.16"></a><span id="l13.16">   nsString  error;</span>
<a href="#l13.17"></a><span id="l13.17">   if (!pSource || !pDestination || !fatalError)</span>
<a href="#l13.18"></a><span id="l13.18">   {</span>
<a href="#l13.19"></a><span id="l13.19">     IMPORT_LOG0( &quot;*** Bad param passed to eudora mailbox import\n&quot;);</span>
<a href="#l13.20"></a><span id="l13.20">     nsEudoraStringBundle::GetStringByID( EUDORAIMPORT_MAILBOX_BADPARAM, error);</span>
<a href="#l13.21"></a><span id="l13.21">     if (fatalError)</span>
<a href="#l13.22"></a><span id="l13.22">       *fatalError = PR_TRUE;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/import/outlook/src/MapiMessage.cpp</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/import/outlook/src/MapiMessage.cpp</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -45,16 +45,18 @@</span>
<a href="#l14.4"></a><span id="l14.4"> </span>
<a href="#l14.5"></a><span id="l14.5"> #include &quot;nscore.h&quot;</span>
<a href="#l14.6"></a><span id="l14.6"> #include &lt;time.h&gt;</span>
<a href="#l14.7"></a><span id="l14.7"> #include &quot;nsString.h&quot;</span>
<a href="#l14.8"></a><span id="l14.8"> #include &quot;nsDirectoryServiceDefs.h&quot;</span>
<a href="#l14.9"></a><span id="l14.9"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l14.10"></a><span id="l14.10"> #include &quot;nsMimeTypes.h&quot;</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+#include &quot;nsMsgCompCID.h&quot;</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+#include &quot;nsIMutableArray.h&quot;</span>
<a href="#l14.14"></a><span id="l14.14"> #include &quot;MapiDbgLog.h&quot;</span>
<a href="#l14.15"></a><span id="l14.15"> #include &quot;MapiApi.h&quot;</span>
<a href="#l14.16"></a><span id="l14.16"> </span>
<a href="#l14.17"></a><span id="l14.17"> #include &quot;MapiMimeTypes.h&quot;</span>
<a href="#l14.18"></a><span id="l14.18"> </span>
<a href="#l14.19"></a><span id="l14.19"> #include &lt;algorithm&gt;</span>
<a href="#l14.20"></a><span id="l14.20"> #include &quot;nsMsgI18N.h&quot;</span>
<a href="#l14.21"></a><span id="l14.21"> #include &quot;nsICharsetConverterManager.h&quot;</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineat">@@ -1202,34 +1204,35 @@ void CMapiMessage::ProcessAttachments()</span>
<a href="#l14.23"></a><span id="l14.23">   LPMAPITABLE pTable = NULL;</span>
<a href="#l14.24"></a><span id="l14.24">   HRESULT hr = m_lpMsg-&gt;GetAttachmentTable( 0, &amp;pTable);</span>
<a href="#l14.25"></a><span id="l14.25">   if (FAILED( hr) || !pTable)</span>
<a href="#l14.26"></a><span id="l14.26">     return;</span>
<a href="#l14.27"></a><span id="l14.27">   IterateAttachTable(pTable);</span>
<a href="#l14.28"></a><span id="l14.28">   pTable-&gt;Release();</span>
<a href="#l14.29"></a><span id="l14.29"> }</span>
<a href="#l14.30"></a><span id="l14.30"> </span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-nsMsgAttachedFile* CMapiMessage::GetAttachments()</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+nsresult CMapiMessage::GetAttachments(nsIArray **aArray)</span>
<a href="#l14.33"></a><span id="l14.33"> {</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineminus">-  nsMsgAttachedFile* result = new nsMsgAttachedFile[m_stdattachments.size()+1];</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineminus">-  if (!result)</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineminus">-    return 0;</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineminus">-  memset(result, 0, sizeof(nsMsgAttachedFile)*m_stdattachments.size()+1);</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+  nsresult rv;</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; attachments (do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+  NS_IF_ADDREF(*aArray = attachments);</span>
<a href="#l14.42"></a><span id="l14.42"> </span>
<a href="#l14.43"></a><span id="l14.43" class="difflineminus">-  nsMsgAttachedFile* pos=result;</span>
<a href="#l14.44"></a><span id="l14.44">   for (std::vector&lt;attach_data*&gt;::const_iterator it = m_stdattachments.begin();</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineminus">-       it != m_stdattachments.end(); pos++, it++) {</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineminus">-    pos-&gt;orig_url = (*it)-&gt;orig_url;</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineminus">-    pos-&gt;tmp_file = (*it)-&gt;tmp_file;</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineminus">-    pos-&gt;encoding = (*it)-&gt;encoding;</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineminus">-    pos-&gt;real_name = (*it)-&gt;real_name;</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineminus">-    pos-&gt;type = (*it)-&gt;type;</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+       it != m_stdattachments.end(); it++) {</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+    nsCOMPtr&lt;nsIMsgAttachedFile&gt; a(do_CreateInstance(NS_MSGATTACHEDFILE_CONTRACTID, &amp;rv));</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+    a-&gt;SetOrigUrl((*it)-&gt;orig_url);</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineplus">+    a-&gt;SetTmpFile((*it)-&gt;tmp_file);</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineplus">+    a-&gt;SetEncoding(nsDependentCString((*it)-&gt;encoding));</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineplus">+    a-&gt;SetRealName(nsDependentCString((*it)-&gt;real_name));</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineplus">+    a-&gt;SetType(nsDependentCString((*it)-&gt;type));</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+    attachments-&gt;AppendElement(a, PR_FALSE);</span>
<a href="#l14.60"></a><span id="l14.60">   }</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineminus">-</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineminus">-  return result;</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineplus">+  return rv;</span>
<a href="#l14.64"></a><span id="l14.64"> }</span>
<a href="#l14.65"></a><span id="l14.65"> </span>
<a href="#l14.66"></a><span id="l14.66"> bool CMapiMessage::GetEmbeddedAttachmentInfo(unsigned int i, nsIURI **uri,</span>
<a href="#l14.67"></a><span id="l14.67">                                              const char **cid,</span>
<a href="#l14.68"></a><span id="l14.68">                                              const char **name) const</span>
<a href="#l14.69"></a><span id="l14.69"> {</span>
<a href="#l14.70"></a><span id="l14.70">   if ((i &lt; 0) || ( i &gt;= m_embattachments.size()))</span>
<a href="#l14.71"></a><span id="l14.71">     return false;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/import/outlook/src/MapiMessage.h</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/import/outlook/src/MapiMessage.h</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -179,19 +179,18 @@ private:</span>
<a href="#l15.4"></a><span id="l15.4"> //////////////////////////////////////////////////////</span>
<a href="#l15.5"></a><span id="l15.5"> </span>
<a href="#l15.6"></a><span id="l15.6"> class CMapiMessage {</span>
<a href="#l15.7"></a><span id="l15.7"> public:</span>
<a href="#l15.8"></a><span id="l15.8">   CMapiMessage( LPMESSAGE  lpMsg);</span>
<a href="#l15.9"></a><span id="l15.9">   ~CMapiMessage();</span>
<a href="#l15.10"></a><span id="l15.10"> </span>
<a href="#l15.11"></a><span id="l15.11">   // Attachments</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-  // Ordinary (not embedded) attachments; result MUST be disposed of with DisposeAttachments()</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-  nsMsgAttachedFile* GetAttachments();</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineminus">-  static void DisposeAttachments(nsMsgAttachedFile* att) { delete[] att; }</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+  // Ordinary (not embedded) attachments.</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+  nsresult GetAttachments(nsIArray **aArray);</span>
<a href="#l15.17"></a><span id="l15.17">   // Embedded attachments</span>
<a href="#l15.18"></a><span id="l15.18">   size_t EmbeddedAttachmentsCount() const { return m_embattachments.size(); }</span>
<a href="#l15.19"></a><span id="l15.19">   bool GetEmbeddedAttachmentInfo(unsigned int i, nsIURI **uri, const char **cid,</span>
<a href="#l15.20"></a><span id="l15.20">                                  const char **name) const;</span>
<a href="#l15.21"></a><span id="l15.21">   // We don't check MSGFLAG_HASATTACH, since it returns true even if there are</span>
<a href="#l15.22"></a><span id="l15.22">   // only embedded attachmentsin the message. TB only counts the ordinary</span>
<a href="#l15.23"></a><span id="l15.23">   // attachments when shows the message status, so here we check only for the</span>
<a href="#l15.24"></a><span id="l15.24">   // ordinary attachments.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/import/outlook/src/nsOutlookCompose.cpp</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/import/outlook/src/nsOutlookCompose.cpp</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -50,17 +50,17 @@</span>
<a href="#l16.4"></a><span id="l16.4"> #include &quot;nsIProxyObjectManager.h&quot;</span>
<a href="#l16.5"></a><span id="l16.5"> #include &quot;nsProxiedService.h&quot;</span>
<a href="#l16.6"></a><span id="l16.6"> #include &quot;nsMsgI18N.h&quot;</span>
<a href="#l16.7"></a><span id="l16.7"> #include &quot;nsNativeCharsetUtils.h&quot;</span>
<a href="#l16.8"></a><span id="l16.8"> #include &quot;nsIOutputStream.h&quot;</span>
<a href="#l16.9"></a><span id="l16.9"> </span>
<a href="#l16.10"></a><span id="l16.10"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l16.11"></a><span id="l16.11"> #include &quot;nsMsgCompCID.h&quot;</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+#include &quot;nsIArray.h&quot;</span>
<a href="#l16.14"></a><span id="l16.14"> #include &quot;nsIMsgCompose.h&quot;</span>
<a href="#l16.15"></a><span id="l16.15"> #include &quot;nsIMsgCompFields.h&quot;</span>
<a href="#l16.16"></a><span id="l16.16"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l16.17"></a><span id="l16.17"> </span>
<a href="#l16.18"></a><span id="l16.18"> #include &quot;nsNetCID.h&quot;</span>
<a href="#l16.19"></a><span id="l16.19"> </span>
<a href="#l16.20"></a><span id="l16.20"> #include &quot;nsOutlookCompose.h&quot;</span>
<a href="#l16.21"></a><span id="l16.21"> </span>
<a href="#l16.22"></a><span id="l16.22" class="difflineat">@@ -321,17 +321,18 @@ nsresult nsOutlookCompose::ComposeTheMes</span>
<a href="#l16.23"></a><span id="l16.23">   LossyCopyUTF16toASCII(headers-&gt;Value(CMapiMessageHeaders::hdrMessageID),</span>
<a href="#l16.24"></a><span id="l16.24">                         asciiHeaderVal); // Message-Id cannot fold</span>
<a href="#l16.25"></a><span id="l16.25">   m_pMsgFields-&gt;SetMessageId(asciiHeaderVal.get());</span>
<a href="#l16.26"></a><span id="l16.26">   // We only use those headers that may need to be processed by Thunderbird</span>
<a href="#l16.27"></a><span id="l16.27">   // to create a good rfc822 document, or need to be encoded (like To and Cc).</span>
<a href="#l16.28"></a><span id="l16.28">   // These will replace the originals on import. All the other headers</span>
<a href="#l16.29"></a><span id="l16.29">   // will be copied to the destination unaltered in CopyComposedMessage().</span>
<a href="#l16.30"></a><span id="l16.30"> </span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-  nsMsgAttachedFile *pAttach = msg.GetAttachments();</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineplus">+  nsCOMPtr&lt;nsIArray&gt; pAttach;</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineplus">+  msg.GetAttachments(getter_AddRefs(pAttach));</span>
<a href="#l16.34"></a><span id="l16.34"> </span>
<a href="#l16.35"></a><span id="l16.35">   nsString bodyW;</span>
<a href="#l16.36"></a><span id="l16.36">   // Bug 593907</span>
<a href="#l16.37"></a><span id="l16.37">   if (GenerateHackSequence(msg.GetBody(), msg.GetBodyLen()))</span>
<a href="#l16.38"></a><span id="l16.38">     HackBody(msg.GetBody(), msg.GetBodyLen(), bodyW);</span>
<a href="#l16.39"></a><span id="l16.39">   // End Bug 593907</span>
<a href="#l16.40"></a><span id="l16.40"> </span>
<a href="#l16.41"></a><span id="l16.41">   // We only get the editor interface when there's embedded content.</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineat">@@ -400,19 +401,16 @@ nsresult nsOutlookCompose::ComposeTheMes</span>
<a href="#l16.43"></a><span id="l16.43">     if (abortCnt &gt;= kHungAbortCount) {</span>
<a href="#l16.44"></a><span id="l16.44">       IMPORT_LOG0( &quot;**** Create and send message hung\n&quot;);</span>
<a href="#l16.45"></a><span id="l16.45"> //      IMPORT_LOG1( &quot;Headers: %s\n&quot;, m_Headers.get());</span>
<a href="#l16.46"></a><span id="l16.46"> //      IMPORT_LOG1( &quot;Body: %s\n&quot;, m_Body.get());</span>
<a href="#l16.47"></a><span id="l16.47">       rv = NS_ERROR_FAILURE;</span>
<a href="#l16.48"></a><span id="l16.48">     }</span>
<a href="#l16.49"></a><span id="l16.49">   }</span>
<a href="#l16.50"></a><span id="l16.50"> </span>
<a href="#l16.51"></a><span id="l16.51" class="difflineminus">-  if (pAttach)</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineminus">-    msg.DisposeAttachments(pAttach);</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineminus">-</span>
<a href="#l16.54"></a><span id="l16.54">   if (pListen-&gt;m_location) {</span>
<a href="#l16.55"></a><span id="l16.55">     pListen-&gt;m_location-&gt;Clone(pMsg);</span>
<a href="#l16.56"></a><span id="l16.56">     rv = NS_OK;</span>
<a href="#l16.57"></a><span id="l16.57">   }</span>
<a href="#l16.58"></a><span id="l16.58">   else {</span>
<a href="#l16.59"></a><span id="l16.59">     rv = NS_ERROR_FAILURE;</span>
<a href="#l16.60"></a><span id="l16.60">     IMPORT_LOG0( &quot;*** Error, Outlook compose unsuccessful\n&quot;);</span>
<a href="#l16.61"></a><span id="l16.61">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/import/public/nsIImportService.idl</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/import/public/nsIImportService.idl</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -47,18 +47,19 @@</span>
<a href="#l17.4"></a><span id="l17.4"> interface nsIImportModule;</span>
<a href="#l17.5"></a><span id="l17.5"> interface nsIImportMailboxDescriptor;</span>
<a href="#l17.6"></a><span id="l17.6"> interface nsIImportABDescriptor;</span>
<a href="#l17.7"></a><span id="l17.7"> interface nsIImportGeneric;</span>
<a href="#l17.8"></a><span id="l17.8"> interface nsIImportFieldMap;</span>
<a href="#l17.9"></a><span id="l17.9"> interface nsIMsgSendListener;</span>
<a href="#l17.10"></a><span id="l17.10"> interface nsIMsgCompFields;</span>
<a href="#l17.11"></a><span id="l17.11"> interface nsIMsgSendListener;</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+interface nsIArray;</span>
<a href="#l17.13"></a><span id="l17.13"> </span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">-[scriptable, uuid(55a52e05-8ce7-4e23-8a2f-a9226b01bcfb)]</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+[scriptable, uuid(8de585fc-8557-402e-b784-875b82e79b1a)]</span>
<a href="#l17.16"></a><span id="l17.16"> interface nsIImportService : nsISupports</span>
<a href="#l17.17"></a><span id="l17.17"> {</span>
<a href="#l17.18"></a><span id="l17.18">     void DiscoverModules();</span>
<a href="#l17.19"></a><span id="l17.19"> </span>
<a href="#l17.20"></a><span id="l17.20">   long GetModuleCount( in string filter);</span>
<a href="#l17.21"></a><span id="l17.21">   void GetModuleInfo( in string filter, in long index, out wstring name, out wstring description);</span>
<a href="#l17.22"></a><span id="l17.22">   wstring GetModuleName( in string filter, in long index);</span>
<a href="#l17.23"></a><span id="l17.23">   wstring GetModuleDescription( in string filter, in long index);</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineat">@@ -71,17 +72,17 @@ interface nsIImportService : nsISupports</span>
<a href="#l17.25"></a><span id="l17.25">   nsIImportGeneric      CreateNewGenericMail();</span>
<a href="#l17.26"></a><span id="l17.26">   nsIImportGeneric      CreateNewGenericAddressBooks();</span>
<a href="#l17.27"></a><span id="l17.27">   [noscript] void ProxySend(in nsIEditor aEditor, in nsIMsgIdentity aIdentity,</span>
<a href="#l17.28"></a><span id="l17.28">                             in nsIMsgCompFields aMsgFields,</span>
<a href="#l17.29"></a><span id="l17.29">                             in nsMsgDeliverMode aDeliverMode,</span>
<a href="#l17.30"></a><span id="l17.30">                             in string attachment1_type,</span>
<a href="#l17.31"></a><span id="l17.31">                             in string attachment1_body,</span>
<a href="#l17.32"></a><span id="l17.32">                             in PRUint32 attachment1_body_length,</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineminus">-                            [const] in nsMsgAttachedFile loaded_attachments,</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineplus">+                            in nsIArray loaded_attachments,</span>
<a href="#l17.35"></a><span id="l17.35">                             in nsIMsgSendListener aListener);</span>
<a href="#l17.36"></a><span id="l17.36"> </span>
<a href="#l17.37"></a><span id="l17.37"> };</span>
<a href="#l17.38"></a><span id="l17.38"> </span>
<a href="#l17.39"></a><span id="l17.39"> %{ C++</span>
<a href="#l17.40"></a><span id="l17.40"> #define NS_IMPORTSERVICE_CID              \</span>
<a href="#l17.41"></a><span id="l17.41"> { /* 5df96d60-1726-11d3-a206-00a0cc26da63 */      \</span>
<a href="#l17.42"></a><span id="l17.42">    0x5df96d60, 0x1726, 0x11d3,                   \</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/import/src/nsImportService.cpp</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/import/src/nsImportService.cpp</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -66,16 +66,17 @@</span>
<a href="#l18.4"></a><span id="l18.4"> #include &quot;nsThreadUtils.h&quot;</span>
<a href="#l18.5"></a><span id="l18.5"> #include &quot;nsIEditor.h&quot;</span>
<a href="#l18.6"></a><span id="l18.6"> #include &quot;ImportDebug.h&quot;</span>
<a href="#l18.7"></a><span id="l18.7"> #include &quot;nsImportService.h&quot;</span>
<a href="#l18.8"></a><span id="l18.8"> #include &quot;nsImportStringBundle.h&quot;</span>
<a href="#l18.9"></a><span id="l18.9"> #include &quot;nsCRTGlue.h&quot;</span>
<a href="#l18.10"></a><span id="l18.10"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l18.11"></a><span id="l18.11"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+#include &quot;nsIMutableArray.h&quot;</span>
<a href="#l18.13"></a><span id="l18.13"> </span>
<a href="#l18.14"></a><span id="l18.14"> PRLogModuleInfo *IMPORTLOGMODULE = nsnull;</span>
<a href="#l18.15"></a><span id="l18.15"> </span>
<a href="#l18.16"></a><span id="l18.16"> static nsIImportService *  gImportService = nsnull;</span>
<a href="#l18.17"></a><span id="l18.17"> static const char *  kWhitespace = &quot;\b\t\r\n &quot;;</span>
<a href="#l18.18"></a><span id="l18.18"> </span>
<a href="#l18.19"></a><span id="l18.19"> </span>
<a href="#l18.20"></a><span id="l18.20"> ////////////////////////////////////////////////////////////////////////</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineat">@@ -320,39 +321,39 @@ class nsProxySendRunnable : public nsRun</span>
<a href="#l18.22"></a><span id="l18.22"> {</span>
<a href="#l18.23"></a><span id="l18.23"> public:</span>
<a href="#l18.24"></a><span id="l18.24">   nsProxySendRunnable(nsIEditor *aEditor, nsIMsgIdentity *aIdentity,</span>
<a href="#l18.25"></a><span id="l18.25">                        nsIMsgCompFields *aMsgFields,</span>
<a href="#l18.26"></a><span id="l18.26">                        nsMsgDeliverMode aDeliverMode,</span>
<a href="#l18.27"></a><span id="l18.27">                        const char *attachment1_type,</span>
<a href="#l18.28"></a><span id="l18.28">                        const char *attachment1_body,</span>
<a href="#l18.29"></a><span id="l18.29">                        PRUint32 attachment1_body_length,</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineminus">-                       const nsMsgAttachedFile *loaded_attachments,</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineplus">+                       nsIArray *loaded_attachments,</span>
<a href="#l18.32"></a><span id="l18.32">                        nsIMsgSendListener *aListener);</span>
<a href="#l18.33"></a><span id="l18.33">   NS_DECL_NSIRUNNABLE</span>
<a href="#l18.34"></a><span id="l18.34"> private:</span>
<a href="#l18.35"></a><span id="l18.35">   nsCOMPtr&lt;nsIEditor&gt; m_editor;</span>
<a href="#l18.36"></a><span id="l18.36">   nsCOMPtr&lt;nsIMsgIdentity&gt; m_identity;</span>
<a href="#l18.37"></a><span id="l18.37">   nsCOMPtr&lt;nsIMsgCompFields&gt; m_compFields;</span>
<a href="#l18.38"></a><span id="l18.38">   nsMsgDeliverMode m_deliverMode;</span>
<a href="#l18.39"></a><span id="l18.39">   nsCString m_bodyType;</span>
<a href="#l18.40"></a><span id="l18.40">   nsCString m_body;</span>
<a href="#l18.41"></a><span id="l18.41">   PRUint32 m_bodyLength;</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineminus">-  const nsMsgAttachedFile *m_loadedAttachments;</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineplus">+  nsCOMPtr&lt;nsIArray&gt; m_loadedAttachments;</span>
<a href="#l18.44"></a><span id="l18.44">   nsCOMPtr&lt;nsIMsgSendListener&gt; m_listener;</span>
<a href="#l18.45"></a><span id="l18.45"> </span>
<a href="#l18.46"></a><span id="l18.46"> };</span>
<a href="#l18.47"></a><span id="l18.47"> </span>
<a href="#l18.48"></a><span id="l18.48"> nsProxySendRunnable::nsProxySendRunnable(nsIEditor *aEditor, nsIMsgIdentity *aIdentity,</span>
<a href="#l18.49"></a><span id="l18.49">                                          nsIMsgCompFields *aMsgFields,</span>
<a href="#l18.50"></a><span id="l18.50">                                          nsMsgDeliverMode aDeliverMode,</span>
<a href="#l18.51"></a><span id="l18.51">                                          const char *aBodyType,</span>
<a href="#l18.52"></a><span id="l18.52">                                          const char *aBody,</span>
<a href="#l18.53"></a><span id="l18.53">                                          PRUint32 aBodyLength,</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineminus">-                                         const nsMsgAttachedFile *aLoadedAttachments,</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineplus">+                                         nsIArray *aLoadedAttachments,</span>
<a href="#l18.56"></a><span id="l18.56">                                          nsIMsgSendListener *aListener) :</span>
<a href="#l18.57"></a><span id="l18.57">   m_editor(aEditor), m_identity(aIdentity), m_compFields(aMsgFields),</span>
<a href="#l18.58"></a><span id="l18.58">   m_deliverMode(aDeliverMode), m_bodyType(aBodyType),</span>
<a href="#l18.59"></a><span id="l18.59">   m_body(aBody), m_bodyLength(aBodyLength), m_loadedAttachments(aLoadedAttachments),</span>
<a href="#l18.60"></a><span id="l18.60">   m_listener(aListener)</span>
<a href="#l18.61"></a><span id="l18.61"> {</span>
<a href="#l18.62"></a><span id="l18.62"> }</span>
<a href="#l18.63"></a><span id="l18.63"> </span>
<a href="#l18.64"></a><span id="l18.64" class="difflineat">@@ -361,28 +362,28 @@ NS_IMETHODIMP nsProxySendRunnable::Run()</span>
<a href="#l18.65"></a><span id="l18.65">   nsresult rv;</span>
<a href="#l18.66"></a><span id="l18.66">   nsCOMPtr&lt;nsIMsgSend&gt; msgSend = do_CreateInstance(NS_MSGSEND_CONTRACTID, &amp;rv);</span>
<a href="#l18.67"></a><span id="l18.67">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.68"></a><span id="l18.68"> </span>
<a href="#l18.69"></a><span id="l18.69">   return msgSend-&gt;CreateAndSendMessage(m_editor, m_identity, nsnull, m_compFields,</span>
<a href="#l18.70"></a><span id="l18.70">                                        PR_FALSE, PR_TRUE, </span>
<a href="#l18.71"></a><span id="l18.71">                                        m_deliverMode, nsnull, m_bodyType.get(), m_body.get(),</span>
<a href="#l18.72"></a><span id="l18.72">                                        m_bodyLength, nsnull, m_loadedAttachments,</span>
<a href="#l18.73"></a><span id="l18.73" class="difflineminus">-                                       nsnull, nsnull, nsnull, m_listener, nsnull,</span>
<a href="#l18.74"></a><span id="l18.74" class="difflineplus">+                                       nsnull, nsnull, m_listener, nsnull,</span>
<a href="#l18.75"></a><span id="l18.75">                                        EmptyCString(), nsnull);</span>
<a href="#l18.76"></a><span id="l18.76"> }</span>
<a href="#l18.77"></a><span id="l18.77"> </span>
<a href="#l18.78"></a><span id="l18.78"> </span>
<a href="#l18.79"></a><span id="l18.79"> NS_IMETHODIMP nsImportService::ProxySend(nsIEditor *aEditor, nsIMsgIdentity *aIdentity,</span>
<a href="#l18.80"></a><span id="l18.80">                                          nsIMsgCompFields *aMsgFields,</span>
<a href="#l18.81"></a><span id="l18.81">                                          nsMsgDeliverMode aDeliverMode,</span>
<a href="#l18.82"></a><span id="l18.82">                                          const char *attachment1_type,</span>
<a href="#l18.83"></a><span id="l18.83">                                          const char *attachment1_body,</span>
<a href="#l18.84"></a><span id="l18.84">                                          PRUint32 attachment1_body_length,</span>
<a href="#l18.85"></a><span id="l18.85" class="difflineminus">-                                         const nsMsgAttachedFile *loaded_attachments,</span>
<a href="#l18.86"></a><span id="l18.86" class="difflineplus">+                                         nsIArray *loaded_attachments,</span>
<a href="#l18.87"></a><span id="l18.87">                                          nsIMsgSendListener *aListener)</span>
<a href="#l18.88"></a><span id="l18.88"> {</span>
<a href="#l18.89"></a><span id="l18.89">     nsRefPtr&lt;nsProxySendRunnable&gt; runnable =</span>
<a href="#l18.90"></a><span id="l18.90">       new nsProxySendRunnable(aEditor, aIdentity,</span>
<a href="#l18.91"></a><span id="l18.91">                                        aMsgFields,</span>
<a href="#l18.92"></a><span id="l18.92">                                        aDeliverMode,</span>
<a href="#l18.93"></a><span id="l18.93">                                        attachment1_type,</span>
<a href="#l18.94"></a><span id="l18.94">                                        attachment1_body,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/mime/src/mimedrft.cpp</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/mime/src/mimedrft.cpp</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -97,16 +97,24 @@ extern &quot;C&quot; char     *MIME_StripContinuat</span>
<a href="#l19.4"></a><span id="l19.4"> nsresult            mime_decompose_file_init_fn ( void *stream_closure, MimeHeaders *headers );</span>
<a href="#l19.5"></a><span id="l19.5"> nsresult            mime_decompose_file_output_fn ( const char *buf, PRInt32 size, void *stream_closure );</span>
<a href="#l19.6"></a><span id="l19.6"> nsresult            mime_decompose_file_close_fn ( void *stream_closure );</span>
<a href="#l19.7"></a><span id="l19.7"> extern int          MimeHeaders_build_heads_list(MimeHeaders *hdrs);</span>
<a href="#l19.8"></a><span id="l19.8"> </span>
<a href="#l19.9"></a><span id="l19.9"> // CID's</span>
<a href="#l19.10"></a><span id="l19.10"> static NS_DEFINE_CID(kCMsgComposeServiceCID,  NS_MSGCOMPOSESERVICE_CID);</span>
<a href="#l19.11"></a><span id="l19.11"> </span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+mime_draft_data::mime_draft_data() : url_name(nsnull), format_out(0),</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+  stream(nsnull), obj(nsnull), options(nsnull), headers(nsnull),</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+  messageBody(nsnull), curAttachment(nsnull),</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineplus">+  decoder_data(nsnull), mailcharset(nsnull), forwardInline(PR_FALSE),</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineplus">+  forwardInlineFilter(PR_FALSE), overrideComposeFormat(PR_FALSE),</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineplus">+  originalMsgURI(nsnull)</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineplus">+{</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineplus">+}</span>
<a href="#l19.20"></a><span id="l19.20"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l19.21"></a><span id="l19.21"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l19.22"></a><span id="l19.22"> // THIS SHOULD ALL MOVE TO ANOTHER FILE AFTER LANDING!</span>
<a href="#l19.23"></a><span id="l19.23"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l19.24"></a><span id="l19.24"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l19.25"></a><span id="l19.25"> </span>
<a href="#l19.26"></a><span id="l19.26"> // safe filename for all OSes</span>
<a href="#l19.27"></a><span id="l19.27"> #define SAFE_TMP_FILENAME &quot;nsmime.tmp&quot;</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineat">@@ -151,36 +159,36 @@ typedef enum {</span>
<a href="#l19.29"></a><span id="l19.29">                                   // DON'T remove.</span>
<a href="#l19.30"></a><span id="l19.30"> } nsMsgBoolHeaderSet;</span>
<a href="#l19.31"></a><span id="l19.31"> </span>
<a href="#l19.32"></a><span id="l19.32"> #ifdef NS_DEBUG</span>
<a href="#l19.33"></a><span id="l19.33"> extern &quot;C&quot; void</span>
<a href="#l19.34"></a><span id="l19.34"> mime_dump_attachments ( nsMsgAttachmentData *attachData )</span>
<a href="#l19.35"></a><span id="l19.35"> {</span>
<a href="#l19.36"></a><span id="l19.36">   PRInt32     i = 0;</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineminus">-  struct nsMsgAttachmentData  *tmp = attachData;</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineplus">+  class nsMsgAttachmentData  *tmp = attachData;</span>
<a href="#l19.39"></a><span id="l19.39"> </span>
<a href="#l19.40"></a><span id="l19.40" class="difflineminus">-  while ( (tmp) &amp;&amp; (tmp-&gt;real_name) )</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineplus">+  while ( (tmp) &amp;&amp; (tmp-&gt;m_url) )</span>
<a href="#l19.42"></a><span id="l19.42">   {</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineminus">-    printf(&quot;Real Name         : %s\n&quot;, tmp-&gt;real_name);</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineplus">+    printf(&quot;Real Name         : %s\n&quot;, tmp-&gt;m_realName.get());</span>
<a href="#l19.45"></a><span id="l19.45"> </span>
<a href="#l19.46"></a><span id="l19.46" class="difflineminus">-    if ( tmp-&gt;url )</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineplus">+    if ( tmp-&gt;m_url )</span>
<a href="#l19.48"></a><span id="l19.48">     {</span>
<a href="#l19.49"></a><span id="l19.49">       nsCAutoString spec;</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineminus">-      tmp-&gt;url-&gt;GetSpec(spec);</span>
<a href="#l19.51"></a><span id="l19.51" class="difflineplus">+      tmp-&gt;m_url-&gt;GetSpec(spec);</span>
<a href="#l19.52"></a><span id="l19.52">       printf(&quot;URL               : %s\n&quot;, spec.get());</span>
<a href="#l19.53"></a><span id="l19.53">     }</span>
<a href="#l19.54"></a><span id="l19.54"> </span>
<a href="#l19.55"></a><span id="l19.55" class="difflineminus">-    printf(&quot;Desired Type      : %s\n&quot;, tmp-&gt;desired_type ? tmp-&gt;desired_type : &quot;nsnull&quot;);</span>
<a href="#l19.56"></a><span id="l19.56" class="difflineminus">-    printf(&quot;Real Type         : %s\n&quot;, tmp-&gt;real_type ? tmp-&gt;real_type : &quot;nsnull&quot;);</span>
<a href="#l19.57"></a><span id="l19.57" class="difflineminus">-    printf(&quot;Real Encoding     : %s\n&quot;, tmp-&gt;real_encoding ? tmp-&gt;real_encoding : &quot;nsnull&quot;);</span>
<a href="#l19.58"></a><span id="l19.58" class="difflineminus">-    printf(&quot;Description       : %s\n&quot;, tmp-&gt;description ? tmp-&gt;description : &quot;nsnull&quot;);</span>
<a href="#l19.59"></a><span id="l19.59" class="difflineminus">-    printf(&quot;Mac Type          : %s\n&quot;, tmp-&gt;x_mac_type ? tmp-&gt;x_mac_type : &quot;nsnull&quot;);</span>
<a href="#l19.60"></a><span id="l19.60" class="difflineminus">-    printf(&quot;Mac Creator       : %s\n&quot;, tmp-&gt;x_mac_creator ? tmp-&gt;x_mac_creator : &quot;nsnull&quot;);</span>
<a href="#l19.61"></a><span id="l19.61" class="difflineminus">-    printf(&quot;Size in bytes     : %d\n&quot;, tmp-&gt;size);</span>
<a href="#l19.62"></a><span id="l19.62" class="difflineplus">+    printf(&quot;Desired Type      : %s\n&quot;, tmp-&gt;m_desiredType.get());</span>
<a href="#l19.63"></a><span id="l19.63" class="difflineplus">+    printf(&quot;Real Type         : %s\n&quot;, tmp-&gt;m_realType.get());</span>
<a href="#l19.64"></a><span id="l19.64" class="difflineplus">+    printf(&quot;Real Encoding     : %s\n&quot;, tmp-&gt;m_realEncoding.get());</span>
<a href="#l19.65"></a><span id="l19.65" class="difflineplus">+    printf(&quot;Description       : %s\n&quot;, tmp-&gt;m_description.get());</span>
<a href="#l19.66"></a><span id="l19.66" class="difflineplus">+    printf(&quot;Mac Type          : %s\n&quot;, tmp-&gt;m_xMacType);</span>
<a href="#l19.67"></a><span id="l19.67" class="difflineplus">+    printf(&quot;Mac Creator       : %s\n&quot;, tmp-&gt;m_xMacCreator);</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineplus">+    printf(&quot;Size in bytes     : %d\n&quot;, tmp-&gt;m_size);</span>
<a href="#l19.69"></a><span id="l19.69">     i++;</span>
<a href="#l19.70"></a><span id="l19.70">     tmp++;</span>
<a href="#l19.71"></a><span id="l19.71">   }</span>
<a href="#l19.72"></a><span id="l19.72"> }</span>
<a href="#l19.73"></a><span id="l19.73"> #endif</span>
<a href="#l19.74"></a><span id="l19.74"> </span>
<a href="#l19.75"></a><span id="l19.75"> nsresult CreateComposeParams(nsCOMPtr&lt;nsIMsgComposeParams&gt; &amp;pMsgComposeParams,</span>
<a href="#l19.76"></a><span id="l19.76">                              nsIMsgCompFields * compFields,</span>
<a href="#l19.77"></a><span id="l19.77" class="difflineat">@@ -196,35 +204,35 @@ nsresult CreateComposeParams(nsCOMPtr&lt;ns</span>
<a href="#l19.78"></a><span id="l19.78"> #endif</span>
<a href="#l19.79"></a><span id="l19.79"> </span>
<a href="#l19.80"></a><span id="l19.80">   nsresult rv;</span>
<a href="#l19.81"></a><span id="l19.81">   nsMsgAttachmentData *curAttachment = attachmentList;</span>
<a href="#l19.82"></a><span id="l19.82">   if (curAttachment)</span>
<a href="#l19.83"></a><span id="l19.83">   {</span>
<a href="#l19.84"></a><span id="l19.84">     nsCAutoString spec;</span>
<a href="#l19.85"></a><span id="l19.85"> </span>
<a href="#l19.86"></a><span id="l19.86" class="difflineminus">-    while (curAttachment &amp;&amp; curAttachment-&gt;real_name) //JFD: Why do we check for real_name?</span>
<a href="#l19.87"></a><span id="l19.87" class="difflineplus">+    while (curAttachment &amp;&amp; curAttachment-&gt;m_url)</span>
<a href="#l19.88"></a><span id="l19.88">     {</span>
<a href="#l19.89"></a><span id="l19.89" class="difflineminus">-      rv = curAttachment-&gt;url-&gt;GetSpec(spec);</span>
<a href="#l19.90"></a><span id="l19.90" class="difflineplus">+      rv = curAttachment-&gt;m_url-&gt;GetSpec(spec);</span>
<a href="#l19.91"></a><span id="l19.91">       if (NS_SUCCEEDED(rv))</span>
<a href="#l19.92"></a><span id="l19.92">       {</span>
<a href="#l19.93"></a><span id="l19.93">         nsCOMPtr&lt;nsIMsgAttachment&gt; attachment = do_CreateInstance(NS_MSGATTACHMENT_CONTRACTID, &amp;rv);</span>
<a href="#l19.94"></a><span id="l19.94">         if (NS_SUCCEEDED(rv) &amp;&amp; attachment)</span>
<a href="#l19.95"></a><span id="l19.95">         {</span>
<a href="#l19.96"></a><span id="l19.96">           nsAutoString nameStr;</span>
<a href="#l19.97"></a><span id="l19.97" class="difflineminus">-          rv = ConvertToUnicode(&quot;UTF-8&quot;, curAttachment-&gt;real_name, nameStr);</span>
<a href="#l19.98"></a><span id="l19.98" class="difflineplus">+          rv = ConvertToUnicode(&quot;UTF-8&quot;, curAttachment-&gt;m_realName.get(), nameStr);</span>
<a href="#l19.99"></a><span id="l19.99">           if (NS_FAILED(rv))</span>
<a href="#l19.100"></a><span id="l19.100" class="difflineminus">-            CopyASCIItoUTF16(nsDependentCString(curAttachment-&gt;real_name), nameStr);</span>
<a href="#l19.101"></a><span id="l19.101" class="difflineplus">+            CopyASCIItoUTF16(curAttachment-&gt;m_realName, nameStr);</span>
<a href="#l19.102"></a><span id="l19.102">           attachment-&gt;SetName(nameStr);</span>
<a href="#l19.103"></a><span id="l19.103">           attachment-&gt;SetUrl(spec);</span>
<a href="#l19.104"></a><span id="l19.104">           attachment-&gt;SetTemporary(PR_TRUE);</span>
<a href="#l19.105"></a><span id="l19.105" class="difflineminus">-          attachment-&gt;SetContentType(curAttachment-&gt;real_type);</span>
<a href="#l19.106"></a><span id="l19.106" class="difflineminus">-          attachment-&gt;SetMacType(curAttachment-&gt;x_mac_type);</span>
<a href="#l19.107"></a><span id="l19.107" class="difflineminus">-          attachment-&gt;SetMacCreator(curAttachment-&gt;x_mac_creator);</span>
<a href="#l19.108"></a><span id="l19.108" class="difflineminus">-          attachment-&gt;SetSize(curAttachment-&gt;size);</span>
<a href="#l19.109"></a><span id="l19.109" class="difflineplus">+          attachment-&gt;SetContentType(curAttachment-&gt;m_realType.get());</span>
<a href="#l19.110"></a><span id="l19.110" class="difflineplus">+          attachment-&gt;SetMacType(curAttachment-&gt;m_xMacType.get());</span>
<a href="#l19.111"></a><span id="l19.111" class="difflineplus">+          attachment-&gt;SetMacCreator(curAttachment-&gt;m_xMacCreator.get());</span>
<a href="#l19.112"></a><span id="l19.112" class="difflineplus">+          attachment-&gt;SetSize(curAttachment-&gt;m_size);</span>
<a href="#l19.113"></a><span id="l19.113">           compFields-&gt;AddAttachment(attachment);</span>
<a href="#l19.114"></a><span id="l19.114">         }</span>
<a href="#l19.115"></a><span id="l19.115">       }</span>
<a href="#l19.116"></a><span id="l19.116">       curAttachment++;</span>
<a href="#l19.117"></a><span id="l19.117">     }</span>
<a href="#l19.118"></a><span id="l19.118">   }</span>
<a href="#l19.119"></a><span id="l19.119"> </span>
<a href="#l19.120"></a><span id="l19.120">   MSG_ComposeFormat format = composeFormat; // Format to actually use.</span>
<a href="#l19.121"></a><span id="l19.121" class="difflineat">@@ -456,184 +464,118 @@ dummy_file_write( char *buf, PRInt32 siz</span>
<a href="#l19.122"></a><span id="l19.122">   PRUint32 bytesWritten;</span>
<a href="#l19.123"></a><span id="l19.123">   tStream-&gt;Write(buf, size, &amp;bytesWritten);</span>
<a href="#l19.124"></a><span id="l19.124">   return (int) bytesWritten;</span>
<a href="#l19.125"></a><span id="l19.125"> }</span>
<a href="#l19.126"></a><span id="l19.126"> </span>
<a href="#l19.127"></a><span id="l19.127"> static int</span>
<a href="#l19.128"></a><span id="l19.128"> mime_parse_stream_write ( nsMIMESession *stream, const char *buf, PRInt32 size )</span>
<a href="#l19.129"></a><span id="l19.129"> {</span>
<a href="#l19.130"></a><span id="l19.130" class="difflineminus">-  struct mime_draft_data *mdd = (struct mime_draft_data *) stream-&gt;data_object;</span>
<a href="#l19.131"></a><span id="l19.131" class="difflineplus">+  mime_draft_data *mdd = (mime_draft_data *) stream-&gt;data_object;</span>
<a href="#l19.132"></a><span id="l19.132">   NS_ASSERTION ( mdd, &quot;null mime draft data!&quot; );</span>
<a href="#l19.133"></a><span id="l19.133"> </span>
<a href="#l19.134"></a><span id="l19.134">   if ( !mdd || !mdd-&gt;obj )</span>
<a href="#l19.135"></a><span id="l19.135">     return -1;</span>
<a href="#l19.136"></a><span id="l19.136"> </span>
<a href="#l19.137"></a><span id="l19.137">   return mdd-&gt;obj-&gt;clazz-&gt;parse_buffer ((char *) buf, size, mdd-&gt;obj);</span>
<a href="#l19.138"></a><span id="l19.138"> }</span>
<a href="#l19.139"></a><span id="l19.139"> </span>
<a href="#l19.140"></a><span id="l19.140"> static void</span>
<a href="#l19.141"></a><span id="l19.141" class="difflineminus">-mime_free_attach_data ( nsMsgAttachmentData *attachData)</span>
<a href="#l19.142"></a><span id="l19.142" class="difflineplus">+mime_free_attachments(nsTArray&lt;nsMsgAttachedFile *&gt; &amp;attachments)</span>
<a href="#l19.143"></a><span id="l19.143"> {</span>
<a href="#l19.144"></a><span id="l19.144" class="difflineminus">-  struct nsMsgAttachmentData  *tmp = attachData;</span>
<a href="#l19.145"></a><span id="l19.145" class="difflineminus">-</span>
<a href="#l19.146"></a><span id="l19.146" class="difflineminus">-  while (tmp &amp;&amp; tmp-&gt;real_name)</span>
<a href="#l19.147"></a><span id="l19.147" class="difflineminus">-  {</span>
<a href="#l19.148"></a><span id="l19.148" class="difflineminus">-    NS_IF_RELEASE(tmp-&gt;url);</span>
<a href="#l19.149"></a><span id="l19.149" class="difflineminus">-    PR_FREEIF(tmp-&gt;real_name);</span>
<a href="#l19.150"></a><span id="l19.150" class="difflineminus">-</span>
<a href="#l19.151"></a><span id="l19.151" class="difflineminus">-    PR_FREEIF(tmp-&gt;desired_type);</span>
<a href="#l19.152"></a><span id="l19.152" class="difflineminus">-    PR_FREEIF(tmp-&gt;real_type);</span>
<a href="#l19.153"></a><span id="l19.153" class="difflineminus">-    PR_FREEIF(tmp-&gt;real_encoding);</span>
<a href="#l19.154"></a><span id="l19.154" class="difflineminus">-    PR_FREEIF(tmp-&gt;description);</span>
<a href="#l19.155"></a><span id="l19.155" class="difflineminus">-    PR_FREEIF(tmp-&gt;x_mac_type);</span>
<a href="#l19.156"></a><span id="l19.156" class="difflineminus">-    PR_FREEIF(tmp-&gt;x_mac_creator);</span>
<a href="#l19.157"></a><span id="l19.157" class="difflineminus">-</span>
<a href="#l19.158"></a><span id="l19.158" class="difflineminus">-    tmp++;</span>
<a href="#l19.159"></a><span id="l19.159" class="difflineminus">-  }</span>
<a href="#l19.160"></a><span id="l19.160" class="difflineminus">-}</span>
<a href="#l19.161"></a><span id="l19.161" class="difflineminus">-</span>
<a href="#l19.162"></a><span id="l19.162" class="difflineminus">-static void</span>
<a href="#l19.163"></a><span id="l19.163" class="difflineminus">-mime_free_attachments ( nsMsgAttachedFile *attachments, int count )</span>
<a href="#l19.164"></a><span id="l19.164" class="difflineminus">-{</span>
<a href="#l19.165"></a><span id="l19.165" class="difflineminus">-  int               i;</span>
<a href="#l19.166"></a><span id="l19.166" class="difflineminus">-  nsMsgAttachedFile *cur = attachments;</span>
<a href="#l19.167"></a><span id="l19.167" class="difflineminus">-</span>
<a href="#l19.168"></a><span id="l19.168" class="difflineminus">-  NS_ASSERTION ( attachments &amp;&amp; count &gt; 0, &quot;freeing attachments but there aren't any&quot;);</span>
<a href="#l19.169"></a><span id="l19.169" class="difflineminus">-  if ( !attachments || count &lt;= 0 )</span>
<a href="#l19.170"></a><span id="l19.170" class="difflineplus">+  if (attachments.Length() &lt;= 0)</span>
<a href="#l19.171"></a><span id="l19.171">     return;</span>
<a href="#l19.172"></a><span id="l19.172"> </span>
<a href="#l19.173"></a><span id="l19.173" class="difflineminus">-  for ( i = 0; i &lt; count; i++, cur++ )</span>
<a href="#l19.174"></a><span id="l19.174" class="difflineplus">+  for (int i = 0; i &lt; attachments.Length(); i++)</span>
<a href="#l19.175"></a><span id="l19.175">   {</span>
<a href="#l19.176"></a><span id="l19.176" class="difflineminus">-    cur-&gt;orig_url=nsnull;</span>
<a href="#l19.177"></a><span id="l19.177" class="difflineminus">-</span>
<a href="#l19.178"></a><span id="l19.178" class="difflineminus">-    PR_FREEIF ( cur-&gt;type );</span>
<a href="#l19.179"></a><span id="l19.179" class="difflineminus">-    PR_FREEIF ( cur-&gt;encoding );</span>
<a href="#l19.180"></a><span id="l19.180" class="difflineminus">-    PR_FREEIF ( cur-&gt;description );</span>
<a href="#l19.181"></a><span id="l19.181" class="difflineminus">-    PR_FREEIF ( cur-&gt;x_mac_type );</span>
<a href="#l19.182"></a><span id="l19.182" class="difflineminus">-    PR_FREEIF ( cur-&gt;x_mac_creator );</span>
<a href="#l19.183"></a><span id="l19.183" class="difflineminus">-    if ( cur-&gt;tmp_file )</span>
<a href="#l19.184"></a><span id="l19.184" class="difflineplus">+    if (attachments[i]-&gt;m_tmpFile)</span>
<a href="#l19.185"></a><span id="l19.185">     {</span>
<a href="#l19.186"></a><span id="l19.186" class="difflineminus">-      cur-&gt;tmp_file-&gt;Remove(PR_FALSE);</span>
<a href="#l19.187"></a><span id="l19.187" class="difflineminus">-      cur-&gt;tmp_file = nsnull;</span>
<a href="#l19.188"></a><span id="l19.188" class="difflineplus">+      attachments[i]-&gt;m_tmpFile-&gt;Remove(PR_FALSE);</span>
<a href="#l19.189"></a><span id="l19.189" class="difflineplus">+      attachments[i]-&gt;m_tmpFile = nsnull;</span>
<a href="#l19.190"></a><span id="l19.190">     }</span>
<a href="#l19.191"></a><span id="l19.191" class="difflineplus">+    delete attachments[i];</span>
<a href="#l19.192"></a><span id="l19.192">   }</span>
<a href="#l19.193"></a><span id="l19.193" class="difflineminus">-</span>
<a href="#l19.194"></a><span id="l19.194" class="difflineminus">-  PR_FREEIF( attachments );</span>
<a href="#l19.195"></a><span id="l19.195"> }</span>
<a href="#l19.196"></a><span id="l19.196"> </span>
<a href="#l19.197"></a><span id="l19.197"> static nsMsgAttachmentData *</span>
<a href="#l19.198"></a><span id="l19.198"> mime_draft_process_attachments(mime_draft_data *mdd)</span>
<a href="#l19.199"></a><span id="l19.199"> {</span>
<a href="#l19.200"></a><span id="l19.200">   if (!mdd)</span>
<a href="#l19.201"></a><span id="l19.201">     return nsnull;</span>
<a href="#l19.202"></a><span id="l19.202"> </span>
<a href="#l19.203"></a><span id="l19.203">   nsMsgAttachmentData         *attachData = NULL, *tmp = NULL;</span>
<a href="#l19.204"></a><span id="l19.204">   nsMsgAttachedFile           *tmpFile = NULL;</span>
<a href="#l19.205"></a><span id="l19.205" class="difflineminus">-  int                         i;</span>
<a href="#l19.206"></a><span id="l19.206"> </span>
<a href="#l19.207"></a><span id="l19.207">   //It's possible we must treat the message body as attachment!</span>
<a href="#l19.208"></a><span id="l19.208">   PRBool bodyAsAttachment = PR_FALSE;</span>
<a href="#l19.209"></a><span id="l19.209">   if (  mdd-&gt;messageBody &amp;&amp;</span>
<a href="#l19.210"></a><span id="l19.210" class="difflineminus">-        mdd-&gt;messageBody-&gt;type &amp;&amp; *mdd-&gt;messageBody-&gt;type &amp;&amp;</span>
<a href="#l19.211"></a><span id="l19.211" class="difflineminus">-        ( PL_strcasestr(mdd-&gt;messageBody-&gt;type, &quot;text/html&quot;) == nsnull ) &amp;&amp;</span>
<a href="#l19.212"></a><span id="l19.212" class="difflineminus">-        ( PL_strcasestr(mdd-&gt;messageBody-&gt;type, &quot;text/plain&quot;) == nsnull ) &amp;&amp;</span>
<a href="#l19.213"></a><span id="l19.213" class="difflineminus">-        ( PL_strcasecmp(mdd-&gt;messageBody-&gt;type, &quot;text&quot;) != 0 )</span>
<a href="#l19.214"></a><span id="l19.214" class="difflineminus">-     )</span>
<a href="#l19.215"></a><span id="l19.215" class="difflineplus">+        mdd-&gt;messageBody-&gt;m_type.Find(&quot;text/html&quot;, CaseInsensitiveCompare) == -1 &amp;&amp;</span>
<a href="#l19.216"></a><span id="l19.216" class="difflineplus">+        mdd-&gt;messageBody-&gt;m_type.Find(&quot;text/plain&quot;, CaseInsensitiveCompare) == -1 &amp;&amp;</span>
<a href="#l19.217"></a><span id="l19.217" class="difflineplus">+        mdd-&gt;messageBody-&gt;m_type.Find(&quot;text&quot;, CaseInsensitiveCompare) == -1)</span>
<a href="#l19.218"></a><span id="l19.218">      bodyAsAttachment = PR_TRUE;</span>
<a href="#l19.219"></a><span id="l19.219"> </span>
<a href="#l19.220"></a><span id="l19.220" class="difflineminus">-  if ( (!mdd-&gt;attachments || !mdd-&gt;attachments_count) &amp;&amp; !bodyAsAttachment)</span>
<a href="#l19.221"></a><span id="l19.221" class="difflineplus">+  if (!mdd-&gt;attachments.Length() &amp;&amp; !bodyAsAttachment)</span>
<a href="#l19.222"></a><span id="l19.222">     return nsnull;</span>
<a href="#l19.223"></a><span id="l19.223"> </span>
<a href="#l19.224"></a><span id="l19.224" class="difflineminus">-  PRInt32 totalCount = mdd-&gt;attachments_count;</span>
<a href="#l19.225"></a><span id="l19.225" class="difflineplus">+  PRInt32 totalCount = mdd-&gt;attachments.Length();</span>
<a href="#l19.226"></a><span id="l19.226">   if (bodyAsAttachment)</span>
<a href="#l19.227"></a><span id="l19.227" class="difflineminus">-    totalCount ++;</span>
<a href="#l19.228"></a><span id="l19.228" class="difflineminus">-  attachData = (nsMsgAttachmentData *) PR_CALLOC( ( (totalCount + 1) * sizeof (nsMsgAttachmentData) ) );</span>
<a href="#l19.229"></a><span id="l19.229" class="difflineplus">+    totalCount++;</span>
<a href="#l19.230"></a><span id="l19.230" class="difflineplus">+  attachData = new nsMsgAttachmentData[totalCount + 1];</span>
<a href="#l19.231"></a><span id="l19.231">   if ( !attachData )</span>
<a href="#l19.232"></a><span id="l19.232">     return nsnull;</span>
<a href="#l19.233"></a><span id="l19.233"> </span>
<a href="#l19.234"></a><span id="l19.234" class="difflineminus">-  //mdd-&gt;messageBody and mdd-&gt;attachments are the same type!</span>
<a href="#l19.235"></a><span id="l19.235" class="difflineminus">-  if (bodyAsAttachment)</span>
<a href="#l19.236"></a><span id="l19.236" class="difflineminus">-    tmpFile = mdd-&gt;messageBody;</span>
<a href="#l19.237"></a><span id="l19.237" class="difflineminus">-  else</span>
<a href="#l19.238"></a><span id="l19.238" class="difflineminus">-    tmpFile = mdd-&gt;attachments;</span>
<a href="#l19.239"></a><span id="l19.239">   tmp = attachData;</span>
<a href="#l19.240"></a><span id="l19.240"> </span>
<a href="#l19.241"></a><span id="l19.241" class="difflineminus">-  for ( i=0; i &lt; totalCount; i++, tmp++)</span>
<a href="#l19.242"></a><span id="l19.242" class="difflineplus">+  for (int i = 0, attachmentsIndex = 0; i &lt; totalCount; i++, tmp++)</span>
<a href="#l19.243"></a><span id="l19.243">   {</span>
<a href="#l19.244"></a><span id="l19.244" class="difflineminus">-    if (tmpFile-&gt;type)</span>
<a href="#l19.245"></a><span id="l19.245" class="difflineminus">-    {</span>
<a href="#l19.246"></a><span id="l19.246" class="difflineminus">-      if (PL_strcasecmp ( tmpFile-&gt;type, &quot;text/x-vcard&quot;) == 0)</span>
<a href="#l19.247"></a><span id="l19.247" class="difflineminus">-        NS_MsgSACopy (&amp;(tmp-&gt;real_name), tmpFile-&gt;description);</span>
<a href="#l19.248"></a><span id="l19.248" class="difflineminus">-    }</span>
<a href="#l19.249"></a><span id="l19.249" class="difflineplus">+    if (bodyAsAttachment &amp;&amp; i == 0)</span>
<a href="#l19.250"></a><span id="l19.250" class="difflineplus">+      tmpFile = mdd-&gt;messageBody;</span>
<a href="#l19.251"></a><span id="l19.251" class="difflineplus">+    else</span>
<a href="#l19.252"></a><span id="l19.252" class="difflineplus">+      tmpFile = mdd-&gt;attachments[attachmentsIndex++];</span>
<a href="#l19.253"></a><span id="l19.253"> </span>
<a href="#l19.254"></a><span id="l19.254" class="difflineminus">-    if ( tmpFile-&gt;orig_url )</span>
<a href="#l19.255"></a><span id="l19.255" class="difflineplus">+    if (tmpFile-&gt;m_type.LowerCaseEqualsLiteral(&quot;text/x-vcard&quot;))</span>
<a href="#l19.256"></a><span id="l19.256" class="difflineplus">+      tmp-&gt;m_realName = tmpFile-&gt;m_description;</span>
<a href="#l19.257"></a><span id="l19.257" class="difflineplus">+</span>
<a href="#l19.258"></a><span id="l19.258" class="difflineplus">+    if ( tmpFile-&gt;m_origUrl )</span>
<a href="#l19.259"></a><span id="l19.259">     {</span>
<a href="#l19.260"></a><span id="l19.260">       nsCAutoString tmpSpec;</span>
<a href="#l19.261"></a><span id="l19.261" class="difflineminus">-      if (NS_FAILED(tmpFile-&gt;orig_url-&gt;GetSpec(tmpSpec)))</span>
<a href="#l19.262"></a><span id="l19.262" class="difflineplus">+      if (NS_FAILED(tmpFile-&gt;m_origUrl-&gt;GetSpec(tmpSpec)))</span>
<a href="#l19.263"></a><span id="l19.263">         goto FAIL;</span>
<a href="#l19.264"></a><span id="l19.264"> </span>
<a href="#l19.265"></a><span id="l19.265" class="difflineminus">-      if (NS_FAILED(nsMimeNewURI(&amp;(tmp-&gt;url), tmpSpec.get(), nsnull)))</span>
<a href="#l19.266"></a><span id="l19.266" class="difflineplus">+      if (NS_FAILED(nsMimeNewURI(getter_AddRefs(tmp-&gt;m_url), tmpSpec.get(), nsnull)))</span>
<a href="#l19.267"></a><span id="l19.267">         goto FAIL;</span>
<a href="#l19.268"></a><span id="l19.268"> </span>
<a href="#l19.269"></a><span id="l19.269" class="difflineminus">-      if (!tmp-&gt;real_name)</span>
<a href="#l19.270"></a><span id="l19.270" class="difflineplus">+      if (tmp-&gt;m_realName.IsEmpty())</span>
<a href="#l19.271"></a><span id="l19.271">       {</span>
<a href="#l19.272"></a><span id="l19.272" class="difflineminus">-        if (tmpFile-&gt;real_name)</span>
<a href="#l19.273"></a><span id="l19.273" class="difflineminus">-          NS_MsgSACopy ( &amp;(tmp-&gt;real_name), tmpFile-&gt;real_name );</span>
<a href="#l19.274"></a><span id="l19.274" class="difflineplus">+        if (!tmpFile-&gt;m_realName.IsEmpty())</span>
<a href="#l19.275"></a><span id="l19.275" class="difflineplus">+          tmp-&gt;m_realName = tmpFile-&gt;m_realName;</span>
<a href="#l19.276"></a><span id="l19.276">         else {</span>
<a href="#l19.277"></a><span id="l19.277" class="difflineminus">-          if (PL_strstr(tmpFile-&gt;type, MESSAGE_RFC822))</span>
<a href="#l19.278"></a><span id="l19.278" class="difflineplus">+          if (tmpFile-&gt;m_type.Find(MESSAGE_RFC822, CaseInsensitiveCompare) != -1)</span>
<a href="#l19.279"></a><span id="l19.279">             // we have the odd case of processing an e-mail that had an unnamed</span>
<a href="#l19.280"></a><span id="l19.280">             // eml message attached</span>
<a href="#l19.281"></a><span id="l19.281" class="difflineminus">-            NS_MsgSACopy( &amp;(tmp-&gt;real_name), &quot;ForwardedMessage.eml&quot; );</span>
<a href="#l19.282"></a><span id="l19.282" class="difflineplus">+            tmp-&gt;m_realName = &quot;ForwardedMessage.eml&quot;;</span>
<a href="#l19.283"></a><span id="l19.283"> </span>
<a href="#l19.284"></a><span id="l19.284">           else</span>
<a href="#l19.285"></a><span id="l19.285" class="difflineminus">-            NS_MsgSACopy ( &amp;(tmp-&gt;real_name), tmpSpec.get() );</span>
<a href="#l19.286"></a><span id="l19.286" class="difflineplus">+            tmp-&gt;m_realName = tmpSpec.get();</span>
<a href="#l19.287"></a><span id="l19.287">         }</span>
<a href="#l19.288"></a><span id="l19.288">       }</span>
<a href="#l19.289"></a><span id="l19.289">     }</span>
<a href="#l19.290"></a><span id="l19.290"> </span>
<a href="#l19.291"></a><span id="l19.291" class="difflineminus">-    if ( tmpFile-&gt;type )</span>
<a href="#l19.292"></a><span id="l19.292" class="difflineminus">-    {</span>
<a href="#l19.293"></a><span id="l19.293" class="difflineminus">-      NS_MsgSACopy ( &amp;(tmp-&gt;desired_type), tmpFile-&gt;type );</span>
<a href="#l19.294"></a><span id="l19.294" class="difflineminus">-      NS_MsgSACopy ( &amp;(tmp-&gt;real_type), tmpFile-&gt;type );</span>
<a href="#l19.295"></a><span id="l19.295" class="difflineminus">-    }</span>
<a href="#l19.296"></a><span id="l19.296" class="difflineminus">-</span>
<a href="#l19.297"></a><span id="l19.297" class="difflineminus">-    if ( tmpFile-&gt;encoding )</span>
<a href="#l19.298"></a><span id="l19.298" class="difflineminus">-    {</span>
<a href="#l19.299"></a><span id="l19.299" class="difflineminus">-      NS_MsgSACopy ( &amp;(tmp-&gt;real_encoding), tmpFile-&gt;encoding );</span>
<a href="#l19.300"></a><span id="l19.300" class="difflineminus">-    }</span>
<a href="#l19.301"></a><span id="l19.301" class="difflineminus">-</span>
<a href="#l19.302"></a><span id="l19.302" class="difflineminus">-    if ( tmpFile-&gt;description )</span>
<a href="#l19.303"></a><span id="l19.303" class="difflineminus">-    {</span>
<a href="#l19.304"></a><span id="l19.304" class="difflineminus">-      NS_MsgSACopy ( &amp;(tmp-&gt;description), tmpFile-&gt;description );</span>
<a href="#l19.305"></a><span id="l19.305" class="difflineminus">-    }</span>
<a href="#l19.306"></a><span id="l19.306" class="difflineminus">-</span>
<a href="#l19.307"></a><span id="l19.307" class="difflineminus">-    if ( tmpFile-&gt;x_mac_type )</span>
<a href="#l19.308"></a><span id="l19.308" class="difflineminus">-    {</span>
<a href="#l19.309"></a><span id="l19.309" class="difflineminus">-      NS_MsgSACopy ( &amp;(tmp-&gt;x_mac_type), tmpFile-&gt;x_mac_type );</span>
<a href="#l19.310"></a><span id="l19.310" class="difflineminus">-    }</span>
<a href="#l19.311"></a><span id="l19.311" class="difflineminus">-</span>
<a href="#l19.312"></a><span id="l19.312" class="difflineminus">-    if ( tmpFile-&gt;x_mac_creator )</span>
<a href="#l19.313"></a><span id="l19.313" class="difflineminus">-    {</span>
<a href="#l19.314"></a><span id="l19.314" class="difflineminus">-      NS_MsgSACopy ( &amp;(tmp-&gt;x_mac_creator), tmpFile-&gt;x_mac_creator );</span>
<a href="#l19.315"></a><span id="l19.315" class="difflineminus">-    }</span>
<a href="#l19.316"></a><span id="l19.316" class="difflineminus">-</span>
<a href="#l19.317"></a><span id="l19.317" class="difflineminus">-    tmp-&gt;size = tmpFile-&gt;size;</span>
<a href="#l19.318"></a><span id="l19.318" class="difflineminus">-</span>
<a href="#l19.319"></a><span id="l19.319" class="difflineminus">-    if (bodyAsAttachment &amp;&amp; (i == 0))</span>
<a href="#l19.320"></a><span id="l19.320" class="difflineminus">-      tmpFile = mdd-&gt;attachments;</span>
<a href="#l19.321"></a><span id="l19.321" class="difflineminus">-    else</span>
<a href="#l19.322"></a><span id="l19.322" class="difflineminus">-      tmpFile++;</span>
<a href="#l19.323"></a><span id="l19.323" class="difflineplus">+    tmp-&gt;m_desiredType = tmpFile-&gt;m_type;</span>
<a href="#l19.324"></a><span id="l19.324" class="difflineplus">+    tmp-&gt;m_realType = tmpFile-&gt;m_type;</span>
<a href="#l19.325"></a><span id="l19.325" class="difflineplus">+    tmp-&gt;m_realEncoding = tmpFile-&gt;m_encoding;</span>
<a href="#l19.326"></a><span id="l19.326" class="difflineplus">+    tmp-&gt;m_description = tmpFile-&gt;m_description;</span>
<a href="#l19.327"></a><span id="l19.327" class="difflineplus">+    tmp-&gt;m_xMacType = tmpFile-&gt;m_xMacType;</span>
<a href="#l19.328"></a><span id="l19.328" class="difflineplus">+    tmp-&gt;m_xMacCreator = tmpFile-&gt;m_xMacCreator;</span>
<a href="#l19.329"></a><span id="l19.329" class="difflineplus">+    tmp-&gt;m_size = tmpFile-&gt;m_size;</span>
<a href="#l19.330"></a><span id="l19.330">   }</span>
<a href="#l19.331"></a><span id="l19.331" class="difflineminus">-</span>
<a href="#l19.332"></a><span id="l19.332" class="difflineminus">-  return (attachData);</span>
<a href="#l19.333"></a><span id="l19.333" class="difflineplus">+  return attachData;</span>
<a href="#l19.334"></a><span id="l19.334"> </span>
<a href="#l19.335"></a><span id="l19.335"> FAIL:</span>
<a href="#l19.336"></a><span id="l19.336" class="difflineminus">-  mime_free_attach_data (attachData);</span>
<a href="#l19.337"></a><span id="l19.337" class="difflineminus">-  PR_FREEIF(attachData);</span>
<a href="#l19.338"></a><span id="l19.338" class="difflineplus">+  delete [] attachData;</span>
<a href="#l19.339"></a><span id="l19.339">   return nsnull;</span>
<a href="#l19.340"></a><span id="l19.340"> }</span>
<a href="#l19.341"></a><span id="l19.341"> </span>
<a href="#l19.342"></a><span id="l19.342"> static void</span>
<a href="#l19.343"></a><span id="l19.343"> mime_fix_up_html_address( char **addr)</span>
<a href="#l19.344"></a><span id="l19.344"> {</span>
<a href="#l19.345"></a><span id="l19.345">   //</span>
<a href="#l19.346"></a><span id="l19.346">   // We need to replace paired &lt;&gt; they are treated as HTML tag</span>
<a href="#l19.347"></a><span id="l19.347" class="difflineat">@@ -1218,17 +1160,17 @@ mime_insert_forwarded_message_headers(ch</span>
<a href="#l19.348"></a><span id="l19.348">     mime_insert_all_headers(body, headers, composeFormat, mailcharset);</span>
<a href="#l19.349"></a><span id="l19.349">     break;</span>
<a href="#l19.350"></a><span id="l19.350">   }</span>
<a href="#l19.351"></a><span id="l19.351"> }</span>
<a href="#l19.352"></a><span id="l19.352"> </span>
<a href="#l19.353"></a><span id="l19.353"> static void</span>
<a href="#l19.354"></a><span id="l19.354"> mime_parse_stream_complete (nsMIMESession *stream)</span>
<a href="#l19.355"></a><span id="l19.355"> {</span>
<a href="#l19.356"></a><span id="l19.356" class="difflineminus">-  struct mime_draft_data *mdd = (struct mime_draft_data *) stream-&gt;data_object;</span>
<a href="#l19.357"></a><span id="l19.357" class="difflineplus">+  mime_draft_data *mdd = (mime_draft_data *) stream-&gt;data_object;</span>
<a href="#l19.358"></a><span id="l19.358">   nsCOMPtr&lt;nsIMsgCompFields&gt; fields;</span>
<a href="#l19.359"></a><span id="l19.359">   int htmlAction = 0;</span>
<a href="#l19.360"></a><span id="l19.360">   int lineWidth = 0;</span>
<a href="#l19.361"></a><span id="l19.361"> </span>
<a href="#l19.362"></a><span id="l19.362">   char *host = 0;</span>
<a href="#l19.363"></a><span id="l19.363">   char *news_host = 0;</span>
<a href="#l19.364"></a><span id="l19.364">   char *to_and_cc = 0;</span>
<a href="#l19.365"></a><span id="l19.365">   char *re_subject = 0;</span>
<a href="#l19.366"></a><span id="l19.366" class="difflineat">@@ -1425,65 +1367,63 @@ mime_parse_stream_complete (nsMIMESessio</span>
<a href="#l19.367"></a><span id="l19.367">             if ( NS_SUCCEEDED(rv) &amp;&amp; overrulingIdentity )</span>
<a href="#l19.368"></a><span id="l19.368">                 mdd-&gt;identity = overrulingIdentity;</span>
<a href="#l19.369"></a><span id="l19.369">         }</span>
<a href="#l19.370"></a><span id="l19.370">     }</span>
<a href="#l19.371"></a><span id="l19.371"> </span>
<a href="#l19.372"></a><span id="l19.372">     if (mdd-&gt;messageBody)</span>
<a href="#l19.373"></a><span id="l19.373">     {</span>
<a href="#l19.374"></a><span id="l19.374">       MSG_ComposeFormat composeFormat = nsIMsgCompFormat::Default;</span>
<a href="#l19.375"></a><span id="l19.375" class="difflineminus">-      if (mdd-&gt;messageBody-&gt;type &amp;&amp; *mdd-&gt;messageBody-&gt;type)</span>
<a href="#l19.376"></a><span id="l19.376" class="difflineplus">+      if (!mdd-&gt;messageBody-&gt;m_type.IsEmpty())</span>
<a href="#l19.377"></a><span id="l19.377">       {</span>
<a href="#l19.378"></a><span id="l19.378" class="difflineminus">-        if( PL_strcasestr(mdd-&gt;messageBody-&gt;type, &quot;text/html&quot;))</span>
<a href="#l19.379"></a><span id="l19.379" class="difflineplus">+        if(mdd-&gt;messageBody-&gt;m_type.Find(&quot;text/html&quot;, CaseInsensitiveCompare) != -1)</span>
<a href="#l19.380"></a><span id="l19.380">           composeFormat = nsIMsgCompFormat::HTML;</span>
<a href="#l19.381"></a><span id="l19.381" class="difflineminus">-        else if ( PL_strcasestr(mdd-&gt;messageBody-&gt;type, &quot;text/plain&quot;) ||</span>
<a href="#l19.382"></a><span id="l19.382" class="difflineminus">-                  !PL_strcasecmp(mdd-&gt;messageBody-&gt;type, &quot;text&quot;) )</span>
<a href="#l19.383"></a><span id="l19.383" class="difflineplus">+        else if (mdd-&gt;messageBody-&gt;m_type.Find(&quot;text/plain&quot;, CaseInsensitiveCompare) != -1 ||</span>
<a href="#l19.384"></a><span id="l19.384" class="difflineplus">+                 mdd-&gt;messageBody-&gt;m_type.LowerCaseEqualsLiteral(&quot;text&quot;))</span>
<a href="#l19.385"></a><span id="l19.385">           composeFormat = nsIMsgCompFormat::PlainText;</span>
<a href="#l19.386"></a><span id="l19.386">         else</span>
<a href="#l19.387"></a><span id="l19.387" class="difflineminus">-        {</span>
<a href="#l19.388"></a><span id="l19.388">           //We cannot use this kind of data for the message body! Therefore, move it as attachment</span>
<a href="#l19.389"></a><span id="l19.389">           bodyAsAttachment = PR_TRUE;</span>
<a href="#l19.390"></a><span id="l19.390" class="difflineminus">-        }</span>
<a href="#l19.391"></a><span id="l19.391">       }</span>
<a href="#l19.392"></a><span id="l19.392">       else</span>
<a href="#l19.393"></a><span id="l19.393">         composeFormat = nsIMsgCompFormat::PlainText;</span>
<a href="#l19.394"></a><span id="l19.394"> </span>
<a href="#l19.395"></a><span id="l19.395">       char *body = nsnull;</span>
<a href="#l19.396"></a><span id="l19.396">       PRUint32 bodyLen = 0;</span>
<a href="#l19.397"></a><span id="l19.397"> </span>
<a href="#l19.398"></a><span id="l19.398">       if (!bodyAsAttachment)</span>
<a href="#l19.399"></a><span id="l19.399">       {</span>
<a href="#l19.400"></a><span id="l19.400">         PRInt64 fileSize;</span>
<a href="#l19.401"></a><span id="l19.401">         nsCOMPtr&lt;nsIFile&gt; tempFileCopy;</span>
<a href="#l19.402"></a><span id="l19.402" class="difflineminus">-        mdd-&gt;messageBody-&gt;tmp_file-&gt;Clone(getter_AddRefs(tempFileCopy));</span>
<a href="#l19.403"></a><span id="l19.403" class="difflineminus">-        mdd-&gt;messageBody-&gt;tmp_file = do_QueryInterface(tempFileCopy);</span>
<a href="#l19.404"></a><span id="l19.404" class="difflineplus">+        mdd-&gt;messageBody-&gt;m_tmpFile-&gt;Clone(getter_AddRefs(tempFileCopy));</span>
<a href="#l19.405"></a><span id="l19.405" class="difflineplus">+        mdd-&gt;messageBody-&gt;m_tmpFile = do_QueryInterface(tempFileCopy);</span>
<a href="#l19.406"></a><span id="l19.406">         tempFileCopy = nsnull;</span>
<a href="#l19.407"></a><span id="l19.407" class="difflineminus">-        mdd-&gt;messageBody-&gt;tmp_file-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l19.408"></a><span id="l19.408" class="difflineplus">+        mdd-&gt;messageBody-&gt;m_tmpFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l19.409"></a><span id="l19.409">         bodyLen = fileSize;</span>
<a href="#l19.410"></a><span id="l19.410">         body = (char *)PR_MALLOC (bodyLen + 1);</span>
<a href="#l19.411"></a><span id="l19.411">         if (body)</span>
<a href="#l19.412"></a><span id="l19.412">         {</span>
<a href="#l19.413"></a><span id="l19.413">           memset (body, 0, bodyLen+1);</span>
<a href="#l19.414"></a><span id="l19.414"> </span>
<a href="#l19.415"></a><span id="l19.415">           PRUint32 bytesRead;</span>
<a href="#l19.416"></a><span id="l19.416">           nsCOMPtr &lt;nsIInputStream&gt; inputStream;</span>
<a href="#l19.417"></a><span id="l19.417"> </span>
<a href="#l19.418"></a><span id="l19.418" class="difflineminus">-          nsresult rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream), mdd-&gt;messageBody-&gt;tmp_file);</span>
<a href="#l19.419"></a><span id="l19.419" class="difflineplus">+          nsresult rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream), mdd-&gt;messageBody-&gt;m_tmpFile);</span>
<a href="#l19.420"></a><span id="l19.420">           if (NS_FAILED(rv))</span>
<a href="#l19.421"></a><span id="l19.421">             return;</span>
<a href="#l19.422"></a><span id="l19.422"> </span>
<a href="#l19.423"></a><span id="l19.423">           inputStream-&gt;Read(body, bodyLen, &amp;bytesRead);</span>
<a href="#l19.424"></a><span id="l19.424"> </span>
<a href="#l19.425"></a><span id="l19.425">           inputStream-&gt;Close();</span>
<a href="#l19.426"></a><span id="l19.426"> </span>
<a href="#l19.427"></a><span id="l19.427">           // Convert the body to UTF-8</span>
<a href="#l19.428"></a><span id="l19.428">           char *mimeCharset = nsnull;</span>
<a href="#l19.429"></a><span id="l19.429">           // Get a charset from the header if no override is set.</span>
<a href="#l19.430"></a><span id="l19.430">           if (!charsetOverride)</span>
<a href="#l19.431"></a><span id="l19.431" class="difflineminus">-            mimeCharset = MimeHeaders_get_parameter (mdd-&gt;messageBody-&gt;type, &quot;charset&quot;, nsnull, nsnull);</span>
<a href="#l19.432"></a><span id="l19.432" class="difflineplus">+            mimeCharset = MimeHeaders_get_parameter (mdd-&gt;messageBody-&gt;m_type.get(), &quot;charset&quot;, nsnull, nsnull);</span>
<a href="#l19.433"></a><span id="l19.433">           // If no charset is specified in the header then use the default.</span>
<a href="#l19.434"></a><span id="l19.434">           char *bodyCharset = mimeCharset ? mimeCharset : mdd-&gt;mailcharset;</span>
<a href="#l19.435"></a><span id="l19.435">           if (bodyCharset)</span>
<a href="#l19.436"></a><span id="l19.436">           {</span>
<a href="#l19.437"></a><span id="l19.437">             nsAutoString tmpUnicodeBody;</span>
<a href="#l19.438"></a><span id="l19.438">             rv = ConvertToUnicode(bodyCharset, body, tmpUnicodeBody);</span>
<a href="#l19.439"></a><span id="l19.439">             if (NS_FAILED(rv)) // Tough luck, ASCII/ISO-8859-1 then...</span>
<a href="#l19.440"></a><span id="l19.440">               CopyASCIItoUTF16(nsDependentCString(body), tmpUnicodeBody);</span>
<a href="#l19.441"></a><span id="l19.441" class="difflineat">@@ -1661,30 +1601,25 @@ mime_parse_stream_complete (nsMIMESessio</span>
<a href="#l19.442"></a><span id="l19.442">     MimeHeaders_free ( mdd-&gt;headers );</span>
<a href="#l19.443"></a><span id="l19.443"> </span>
<a href="#l19.444"></a><span id="l19.444">   //</span>
<a href="#l19.445"></a><span id="l19.445">   // Free the original attachment structure...</span>
<a href="#l19.446"></a><span id="l19.446">   // Make sure we only cleanup the local copy of the memory and not kill</span>
<a href="#l19.447"></a><span id="l19.447">   // files we need on disk</span>
<a href="#l19.448"></a><span id="l19.448">   //</span>
<a href="#l19.449"></a><span id="l19.449">   if (bodyAsAttachment)</span>
<a href="#l19.450"></a><span id="l19.450" class="difflineminus">-    mdd-&gt;messageBody-&gt;tmp_file = nsnull;</span>
<a href="#l19.451"></a><span id="l19.451" class="difflineminus">-</span>
<a href="#l19.452"></a><span id="l19.452" class="difflineminus">-  mime_free_attachments (mdd-&gt;messageBody, 1);</span>
<a href="#l19.453"></a><span id="l19.453" class="difflineplus">+    mdd-&gt;messageBody-&gt;m_tmpFile = nsnull;</span>
<a href="#l19.454"></a><span id="l19.454" class="difflineplus">+  else if (mdd-&gt;messageBody-&gt;m_tmpFile)</span>
<a href="#l19.455"></a><span id="l19.455" class="difflineplus">+    mdd-&gt;messageBody-&gt;m_tmpFile-&gt;Remove(PR_FALSE);</span>
<a href="#l19.456"></a><span id="l19.456"> </span>
<a href="#l19.457"></a><span id="l19.457" class="difflineminus">-  if (mdd-&gt;attachments)</span>
<a href="#l19.458"></a><span id="l19.458" class="difflineminus">-  {</span>
<a href="#l19.459"></a><span id="l19.459" class="difflineminus">-    int               i;</span>
<a href="#l19.460"></a><span id="l19.460" class="difflineminus">-    nsMsgAttachedFile *cur = mdd-&gt;attachments;</span>
<a href="#l19.461"></a><span id="l19.461" class="difflineplus">+  delete mdd-&gt;messageBody;</span>
<a href="#l19.462"></a><span id="l19.462"> </span>
<a href="#l19.463"></a><span id="l19.463" class="difflineminus">-    for ( i = 0; i &lt; mdd-&gt;attachments_count; i++, cur++ )</span>
<a href="#l19.464"></a><span id="l19.464" class="difflineminus">-        cur-&gt;tmp_file = nsnull;</span>
<a href="#l19.465"></a><span id="l19.465" class="difflineplus">+  for (int i = 0; i &lt; mdd-&gt;attachments.Length(); i++)</span>
<a href="#l19.466"></a><span id="l19.466" class="difflineplus">+    mdd-&gt;attachments[i]-&gt;m_tmpFile = nsnull;</span>
<a href="#l19.467"></a><span id="l19.467"> </span>
<a href="#l19.468"></a><span id="l19.468" class="difflineminus">-    mime_free_attachments( mdd-&gt;attachments, mdd-&gt;attachments_count );</span>
<a href="#l19.469"></a><span id="l19.469" class="difflineminus">-  }</span>
<a href="#l19.470"></a><span id="l19.470">   PR_FREEIF(mdd-&gt;mailcharset);</span>
<a href="#l19.471"></a><span id="l19.471"> </span>
<a href="#l19.472"></a><span id="l19.472">   mdd-&gt;identity = nsnull;</span>
<a href="#l19.473"></a><span id="l19.473">   PR_Free(mdd-&gt;url_name);</span>
<a href="#l19.474"></a><span id="l19.474">   PR_Free(mdd-&gt;originalMsgURI);</span>
<a href="#l19.475"></a><span id="l19.475">   mdd-&gt;origMsgHdr = nsnull;</span>
<a href="#l19.476"></a><span id="l19.476">   PR_Free(mdd);</span>
<a href="#l19.477"></a><span id="l19.477"> </span>
<a href="#l19.478"></a><span id="l19.478" class="difflineat">@@ -1700,23 +1635,23 @@ mime_parse_stream_complete (nsMIMESessio</span>
<a href="#l19.479"></a><span id="l19.479">   PR_FREEIF(to);</span>
<a href="#l19.480"></a><span id="l19.480">   PR_FREEIF(cc);</span>
<a href="#l19.481"></a><span id="l19.481">   PR_FREEIF(grps);</span>
<a href="#l19.482"></a><span id="l19.482">   PR_FREEIF(foll);</span>
<a href="#l19.483"></a><span id="l19.483">   PR_FREEIF(priority);</span>
<a href="#l19.484"></a><span id="l19.484">   PR_FREEIF(draftInfo);</span>
<a href="#l19.485"></a><span id="l19.485">   PR_Free(identityKey);</span>
<a href="#l19.486"></a><span id="l19.486"> </span>
<a href="#l19.487"></a><span id="l19.487" class="difflineminus">-  mime_free_attach_data(newAttachData);</span>
<a href="#l19.488"></a><span id="l19.488" class="difflineplus">+  delete [] newAttachData;</span>
<a href="#l19.489"></a><span id="l19.489"> }</span>
<a href="#l19.490"></a><span id="l19.490"> </span>
<a href="#l19.491"></a><span id="l19.491"> static void</span>
<a href="#l19.492"></a><span id="l19.492"> mime_parse_stream_abort (nsMIMESession *stream, int status )</span>
<a href="#l19.493"></a><span id="l19.493"> {</span>
<a href="#l19.494"></a><span id="l19.494" class="difflineminus">-  struct mime_draft_data *mdd = (struct mime_draft_data *) stream-&gt;data_object;</span>
<a href="#l19.495"></a><span id="l19.495" class="difflineplus">+  mime_draft_data *mdd = (mime_draft_data *) stream-&gt;data_object;</span>
<a href="#l19.496"></a><span id="l19.496">   NS_ASSERTION (mdd, &quot;null mime draft data&quot;);</span>
<a href="#l19.497"></a><span id="l19.497"> </span>
<a href="#l19.498"></a><span id="l19.498">   if (!mdd)</span>
<a href="#l19.499"></a><span id="l19.499">     return;</span>
<a href="#l19.500"></a><span id="l19.500"> </span>
<a href="#l19.501"></a><span id="l19.501">   if (mdd-&gt;obj)</span>
<a href="#l19.502"></a><span id="l19.502">   {</span>
<a href="#l19.503"></a><span id="l19.503">     int status=0;</span>
<a href="#l19.504"></a><span id="l19.504" class="difflineat">@@ -1742,28 +1677,27 @@ mime_parse_stream_abort (nsMIMESession *</span>
<a href="#l19.505"></a><span id="l19.505">       mdd-&gt;stream = 0;</span>
<a href="#l19.506"></a><span id="l19.506">     }</span>
<a href="#l19.507"></a><span id="l19.507">   }</span>
<a href="#l19.508"></a><span id="l19.508"> </span>
<a href="#l19.509"></a><span id="l19.509">   if ( mdd-&gt;headers )</span>
<a href="#l19.510"></a><span id="l19.510">     MimeHeaders_free (mdd-&gt;headers);</span>
<a href="#l19.511"></a><span id="l19.511"> </span>
<a href="#l19.512"></a><span id="l19.512"> </span>
<a href="#l19.513"></a><span id="l19.513" class="difflineminus">-  if (mdd-&gt;attachments)</span>
<a href="#l19.514"></a><span id="l19.514" class="difflineminus">-    mime_free_attachments( mdd-&gt;attachments, mdd-&gt;attachments_count );</span>
<a href="#l19.515"></a><span id="l19.515" class="difflineplus">+  mime_free_attachments(mdd-&gt;attachments);</span>
<a href="#l19.516"></a><span id="l19.516"> </span>
<a href="#l19.517"></a><span id="l19.517">   PR_FREEIF(mdd-&gt;mailcharset);</span>
<a href="#l19.518"></a><span id="l19.518"> </span>
<a href="#l19.519"></a><span id="l19.519">   PR_Free (mdd);</span>
<a href="#l19.520"></a><span id="l19.520"> }</span>
<a href="#l19.521"></a><span id="l19.521"> </span>
<a href="#l19.522"></a><span id="l19.522"> static int</span>
<a href="#l19.523"></a><span id="l19.523"> make_mime_headers_copy ( void *closure, MimeHeaders *headers )</span>
<a href="#l19.524"></a><span id="l19.524"> {</span>
<a href="#l19.525"></a><span id="l19.525" class="difflineminus">-  struct mime_draft_data *mdd = (struct mime_draft_data *) closure;</span>
<a href="#l19.526"></a><span id="l19.526" class="difflineplus">+  mime_draft_data *mdd = (mime_draft_data *) closure;</span>
<a href="#l19.527"></a><span id="l19.527"> </span>
<a href="#l19.528"></a><span id="l19.528">   NS_ASSERTION ( mdd &amp;&amp; headers, &quot;null mime draft data and/or headers&quot; );</span>
<a href="#l19.529"></a><span id="l19.529"> </span>
<a href="#l19.530"></a><span id="l19.530">   if ( !mdd || ! headers )</span>
<a href="#l19.531"></a><span id="l19.531">     return 0;</span>
<a href="#l19.532"></a><span id="l19.532"> </span>
<a href="#l19.533"></a><span id="l19.533">   NS_ASSERTION ( mdd-&gt;headers == NULL , &quot;non null mime draft data headers&quot;);</span>
<a href="#l19.534"></a><span id="l19.534"> </span>
<a href="#l19.535"></a><span id="l19.535" class="difflineat">@@ -1771,158 +1705,137 @@ make_mime_headers_copy ( void *closure, </span>
<a href="#l19.536"></a><span id="l19.536">   mdd-&gt;options-&gt;done_parsing_outer_headers = PR_TRUE;</span>
<a href="#l19.537"></a><span id="l19.537"> </span>
<a href="#l19.538"></a><span id="l19.538">   return 0;</span>
<a href="#l19.539"></a><span id="l19.539"> }</span>
<a href="#l19.540"></a><span id="l19.540"> </span>
<a href="#l19.541"></a><span id="l19.541"> nsresult</span>
<a href="#l19.542"></a><span id="l19.542"> mime_decompose_file_init_fn ( void *stream_closure, MimeHeaders *headers )</span>
<a href="#l19.543"></a><span id="l19.543"> {</span>
<a href="#l19.544"></a><span id="l19.544" class="difflineminus">-  struct mime_draft_data *mdd = (struct mime_draft_data *) stream_closure;</span>
<a href="#l19.545"></a><span id="l19.545" class="difflineplus">+  mime_draft_data *mdd = (mime_draft_data *) stream_closure;</span>
<a href="#l19.546"></a><span id="l19.546">   nsMsgAttachedFile *attachments = 0, *newAttachment = 0;</span>
<a href="#l19.547"></a><span id="l19.547">   int nAttachments = 0;</span>
<a href="#l19.548"></a><span id="l19.548">   //char *hdr_value = NULL;</span>
<a href="#l19.549"></a><span id="l19.549">   char *parm_value = NULL;</span>
<a href="#l19.550"></a><span id="l19.550">   PRBool needURL = PR_FALSE;</span>
<a href="#l19.551"></a><span id="l19.551">   PRBool creatingMsgBody = PR_TRUE;</span>
<a href="#l19.552"></a><span id="l19.552">   PRBool bodyPart = PR_FALSE;</span>
<a href="#l19.553"></a><span id="l19.553"> </span>
<a href="#l19.554"></a><span id="l19.554">   NS_ASSERTION (mdd &amp;&amp; headers, &quot;null mime draft data and/or headers&quot;);</span>
<a href="#l19.555"></a><span id="l19.555">   if (!mdd || !headers)</span>
<a href="#l19.556"></a><span id="l19.556">     return -1;</span>
<a href="#l19.557"></a><span id="l19.557"> </span>
<a href="#l19.558"></a><span id="l19.558">   if (mdd-&gt;options-&gt;decompose_init_count)</span>
<a href="#l19.559"></a><span id="l19.559">   {</span>
<a href="#l19.560"></a><span id="l19.560">     mdd-&gt;options-&gt;decompose_init_count++;</span>
<a href="#l19.561"></a><span id="l19.561">     NS_ASSERTION(mdd-&gt;curAttachment, &quot;missing attachment in mime_decompose_file_init_fn&quot;);</span>
<a href="#l19.562"></a><span id="l19.562" class="difflineminus">-    if (mdd-&gt;curAttachment) {</span>
<a href="#l19.563"></a><span id="l19.563" class="difflineminus">-      char *ct = MimeHeaders_get(headers, HEADER_CONTENT_TYPE, PR_TRUE, PR_FALSE);</span>
<a href="#l19.564"></a><span id="l19.564" class="difflineminus">-      if (ct)</span>
<a href="#l19.565"></a><span id="l19.565" class="difflineminus">-        NS_MsgSACopy(&amp;(mdd-&gt;curAttachment-&gt;type), ct);</span>
<a href="#l19.566"></a><span id="l19.566" class="difflineminus">-      PR_FREEIF(ct);</span>
<a href="#l19.567"></a><span id="l19.567" class="difflineminus">-    }</span>
<a href="#l19.568"></a><span id="l19.568" class="difflineplus">+    if (mdd-&gt;curAttachment)</span>
<a href="#l19.569"></a><span id="l19.569" class="difflineplus">+      mdd-&gt;curAttachment-&gt;m_type.Adopt(MimeHeaders_get(headers,</span>
<a href="#l19.570"></a><span id="l19.570" class="difflineplus">+                                                       HEADER_CONTENT_TYPE,</span>
<a href="#l19.571"></a><span id="l19.571" class="difflineplus">+                                                       PR_TRUE, PR_FALSE));</span>
<a href="#l19.572"></a><span id="l19.572">     return 0;</span>
<a href="#l19.573"></a><span id="l19.573">   }</span>
<a href="#l19.574"></a><span id="l19.574">   else</span>
<a href="#l19.575"></a><span id="l19.575">     mdd-&gt;options-&gt;decompose_init_count++;</span>
<a href="#l19.576"></a><span id="l19.576"> </span>
<a href="#l19.577"></a><span id="l19.577" class="difflineminus">-  nAttachments = mdd-&gt;attachments_count;</span>
<a href="#l19.578"></a><span id="l19.578" class="difflineplus">+  nAttachments = mdd-&gt;attachments.Length();</span>
<a href="#l19.579"></a><span id="l19.579"> </span>
<a href="#l19.580"></a><span id="l19.580">   if (!nAttachments &amp;&amp; !mdd-&gt;messageBody)</span>
<a href="#l19.581"></a><span id="l19.581">   {</span>
<a href="#l19.582"></a><span id="l19.582">     // if we've been told to use an override charset then do so....otherwise use the charset</span>
<a href="#l19.583"></a><span id="l19.583">     // inside the message header...</span>
<a href="#l19.584"></a><span id="l19.584">     if (mdd-&gt;options &amp;&amp; mdd-&gt;options-&gt;override_charset)</span>
<a href="#l19.585"></a><span id="l19.585">         mdd-&gt;mailcharset = strdup(mdd-&gt;options-&gt;default_charset);</span>
<a href="#l19.586"></a><span id="l19.586">     else</span>
<a href="#l19.587"></a><span id="l19.587">     {</span>
<a href="#l19.588"></a><span id="l19.588" class="difflineminus">-      char *contentType = NULL;</span>
<a href="#l19.589"></a><span id="l19.589" class="difflineplus">+      char *contentType;</span>
<a href="#l19.590"></a><span id="l19.590">       contentType = MimeHeaders_get(headers, HEADER_CONTENT_TYPE, PR_FALSE, PR_FALSE);</span>
<a href="#l19.591"></a><span id="l19.591">       if (contentType)</span>
<a href="#l19.592"></a><span id="l19.592">       {</span>
<a href="#l19.593"></a><span id="l19.593">         mdd-&gt;mailcharset = MimeHeaders_get_parameter(contentType, &quot;charset&quot;, NULL, NULL);</span>
<a href="#l19.594"></a><span id="l19.594">         PR_FREEIF(contentType);</span>
<a href="#l19.595"></a><span id="l19.595">       }</span>
<a href="#l19.596"></a><span id="l19.596">     }</span>
<a href="#l19.597"></a><span id="l19.597"> </span>
<a href="#l19.598"></a><span id="l19.598" class="difflineminus">-    mdd-&gt;messageBody = PR_NEWZAP (nsMsgAttachedFile);</span>
<a href="#l19.599"></a><span id="l19.599" class="difflineminus">-    NS_ASSERTION (mdd-&gt;messageBody, &quot;missing messageBody in mime_decompose_file_init_fn&quot;);</span>
<a href="#l19.600"></a><span id="l19.600" class="difflineplus">+    mdd-&gt;messageBody = new nsMsgAttachedFile;</span>
<a href="#l19.601"></a><span id="l19.601">     if (!mdd-&gt;messageBody)</span>
<a href="#l19.602"></a><span id="l19.602">       return MIME_OUT_OF_MEMORY;</span>
<a href="#l19.603"></a><span id="l19.603">     newAttachment = mdd-&gt;messageBody;</span>
<a href="#l19.604"></a><span id="l19.604">     creatingMsgBody = PR_TRUE;</span>
<a href="#l19.605"></a><span id="l19.605">     bodyPart = PR_TRUE;</span>
<a href="#l19.606"></a><span id="l19.606">   }</span>
<a href="#l19.607"></a><span id="l19.607">   else</span>
<a href="#l19.608"></a><span id="l19.608">   {</span>
<a href="#l19.609"></a><span id="l19.609">     /* always allocate one more extra; don't ask me why */</span>
<a href="#l19.610"></a><span id="l19.610">     needURL = PR_TRUE;</span>
<a href="#l19.611"></a><span id="l19.611" class="difflineminus">-    if ( nAttachments )</span>
<a href="#l19.612"></a><span id="l19.612" class="difflineminus">-    {</span>
<a href="#l19.613"></a><span id="l19.613" class="difflineminus">-      NS_ASSERTION (mdd-&gt;attachments, &quot;no attachments&quot;);</span>
<a href="#l19.614"></a><span id="l19.614" class="difflineminus">-</span>
<a href="#l19.615"></a><span id="l19.615" class="difflineminus">-      attachments = (nsMsgAttachedFile *)PR_REALLOC(mdd-&gt;attachments,</span>
<a href="#l19.616"></a><span id="l19.616" class="difflineminus">-                                                    sizeof (nsMsgAttachedFile) *</span>
<a href="#l19.617"></a><span id="l19.617" class="difflineminus">-                                                    (nAttachments + 2));</span>
<a href="#l19.618"></a><span id="l19.618" class="difflineminus">-    if (!attachments)</span>
<a href="#l19.619"></a><span id="l19.619" class="difflineminus">-        return MIME_OUT_OF_MEMORY;</span>
<a href="#l19.620"></a><span id="l19.620" class="difflineminus">-      mdd-&gt;attachments = attachments;</span>
<a href="#l19.621"></a><span id="l19.621" class="difflineminus">-      mdd-&gt;attachments_count++;</span>
<a href="#l19.622"></a><span id="l19.622" class="difflineminus">-    }</span>
<a href="#l19.623"></a><span id="l19.623" class="difflineminus">-    else {</span>
<a href="#l19.624"></a><span id="l19.624" class="difflineminus">-      NS_ASSERTION (!mdd-&gt;attachments, &quot;have attachments but count is 0&quot;);</span>
<a href="#l19.625"></a><span id="l19.625" class="difflineminus">-</span>
<a href="#l19.626"></a><span id="l19.626" class="difflineminus">-      attachments = (nsMsgAttachedFile *) PR_MALLOC ( sizeof (nsMsgAttachedFile) * 2);</span>
<a href="#l19.627"></a><span id="l19.627" class="difflineminus">-      if (!attachments)</span>
<a href="#l19.628"></a><span id="l19.628" class="difflineminus">-        return MIME_OUT_OF_MEMORY;</span>
<a href="#l19.629"></a><span id="l19.629" class="difflineminus">-      mdd-&gt;attachments_count++;</span>
<a href="#l19.630"></a><span id="l19.630" class="difflineminus">-      mdd-&gt;attachments = attachments;</span>
<a href="#l19.631"></a><span id="l19.631" class="difflineminus">-    }</span>
<a href="#l19.632"></a><span id="l19.632" class="difflineminus">-</span>
<a href="#l19.633"></a><span id="l19.633" class="difflineminus">-    newAttachment = attachments + nAttachments;</span>
<a href="#l19.634"></a><span id="l19.634" class="difflineminus">-    memset ( newAttachment, 0, sizeof (nsMsgAttachedFile) * 2 );</span>
<a href="#l19.635"></a><span id="l19.635" class="difflineplus">+    newAttachment = new nsMsgAttachedFile;</span>
<a href="#l19.636"></a><span id="l19.636" class="difflineplus">+    if (!newAttachment)</span>
<a href="#l19.637"></a><span id="l19.637" class="difflineplus">+      return MIME_OUT_OF_MEMORY;</span>
<a href="#l19.638"></a><span id="l19.638" class="difflineplus">+    mdd-&gt;attachments.AppendElement(newAttachment);</span>
<a href="#l19.639"></a><span id="l19.639">   }</span>
<a href="#l19.640"></a><span id="l19.640"> </span>
<a href="#l19.641"></a><span id="l19.641">   char *workURLSpec = nsnull;</span>
<a href="#l19.642"></a><span id="l19.642">   char *contLoc = nsnull;</span>
<a href="#l19.643"></a><span id="l19.643"> </span>
<a href="#l19.644"></a><span id="l19.644" class="difflineminus">-  newAttachment-&gt;real_name = MimeHeaders_get_name ( headers, mdd-&gt;options );</span>
<a href="#l19.645"></a><span id="l19.645" class="difflineplus">+  newAttachment-&gt;m_realName.Adopt(MimeHeaders_get_name(headers, mdd-&gt;options));</span>
<a href="#l19.646"></a><span id="l19.646">   contLoc = MimeHeaders_get( headers, HEADER_CONTENT_LOCATION, PR_FALSE, PR_FALSE );</span>
<a href="#l19.647"></a><span id="l19.647">   if (!contLoc)</span>
<a href="#l19.648"></a><span id="l19.648">       contLoc = MimeHeaders_get( headers, HEADER_CONTENT_BASE, PR_FALSE, PR_FALSE );</span>
<a href="#l19.649"></a><span id="l19.649"> </span>
<a href="#l19.650"></a><span id="l19.650" class="difflineminus">-  if ( (!contLoc) &amp;&amp; (newAttachment-&gt;real_name) )</span>
<a href="#l19.651"></a><span id="l19.651" class="difflineminus">-    workURLSpec = strdup(newAttachment-&gt;real_name);</span>
<a href="#l19.652"></a><span id="l19.652" class="difflineplus">+  if (!contLoc &amp;&amp; !newAttachment-&gt;m_realName.IsEmpty())</span>
<a href="#l19.653"></a><span id="l19.653" class="difflineplus">+    workURLSpec = ToNewCString(newAttachment-&gt;m_realName);</span>
<a href="#l19.654"></a><span id="l19.654">   if ( (contLoc) &amp;&amp; (!workURLSpec) )</span>
<a href="#l19.655"></a><span id="l19.655">     workURLSpec = strdup(contLoc);</span>
<a href="#l19.656"></a><span id="l19.656"> </span>
<a href="#l19.657"></a><span id="l19.657">   PR_FREEIF(contLoc);</span>
<a href="#l19.658"></a><span id="l19.658"> </span>
<a href="#l19.659"></a><span id="l19.659">   mdd-&gt;curAttachment = newAttachment;</span>
<a href="#l19.660"></a><span id="l19.660" class="difflineminus">-  newAttachment-&gt;type =  MimeHeaders_get ( headers, HEADER_CONTENT_TYPE, PR_FALSE, PR_FALSE );</span>
<a href="#l19.661"></a><span id="l19.661" class="difflineplus">+  newAttachment-&gt;m_type.Adopt(MimeHeaders_get ( headers, HEADER_CONTENT_TYPE, PR_FALSE, PR_FALSE ));</span>
<a href="#l19.662"></a><span id="l19.662"> </span>
<a href="#l19.663"></a><span id="l19.663">   //</span>
<a href="#l19.664"></a><span id="l19.664">   // This is to handle the degenerated Apple Double attachment.</span>
<a href="#l19.665"></a><span id="l19.665">   //</span>
<a href="#l19.666"></a><span id="l19.666">   parm_value = MimeHeaders_get( headers, HEADER_CONTENT_TYPE, PR_FALSE, PR_FALSE );</span>
<a href="#l19.667"></a><span id="l19.667">   if (parm_value)</span>
<a href="#l19.668"></a><span id="l19.668">   {</span>
<a href="#l19.669"></a><span id="l19.669">     char *boundary = NULL;</span>
<a href="#l19.670"></a><span id="l19.670">     char *tmp_value = NULL;</span>
<a href="#l19.671"></a><span id="l19.671">     boundary = MimeHeaders_get_parameter(parm_value, &quot;boundary&quot;, NULL, NULL);</span>
<a href="#l19.672"></a><span id="l19.672">     if (boundary)</span>
<a href="#l19.673"></a><span id="l19.673">       tmp_value = PR_smprintf(&quot;; boundary=\&quot;%s\&quot;&quot;, boundary);</span>
<a href="#l19.674"></a><span id="l19.674">     if (tmp_value)</span>
<a href="#l19.675"></a><span id="l19.675" class="difflineminus">-      NS_MsgSACat(&amp;(newAttachment-&gt;type), tmp_value);</span>
<a href="#l19.676"></a><span id="l19.676" class="difflineminus">-    newAttachment-&gt;x_mac_type = MimeHeaders_get_parameter(parm_value, &quot;x-mac-type&quot;, NULL, NULL);</span>
<a href="#l19.677"></a><span id="l19.677" class="difflineminus">-    newAttachment-&gt;x_mac_creator = MimeHeaders_get_parameter(parm_value, &quot;x-mac-creator&quot;, NULL, NULL);</span>
<a href="#l19.678"></a><span id="l19.678" class="difflineplus">+      newAttachment-&gt;m_type = tmp_value;</span>
<a href="#l19.679"></a><span id="l19.679" class="difflineplus">+    newAttachment-&gt;m_xMacType.Adopt(</span>
<a href="#l19.680"></a><span id="l19.680" class="difflineplus">+      MimeHeaders_get_parameter(parm_value, &quot;x-mac-type&quot;, NULL, NULL));</span>
<a href="#l19.681"></a><span id="l19.681" class="difflineplus">+    newAttachment-&gt;m_xMacCreator.Adopt(</span>
<a href="#l19.682"></a><span id="l19.682" class="difflineplus">+      MimeHeaders_get_parameter(parm_value, &quot;x-mac-creator&quot;, NULL, NULL));</span>
<a href="#l19.683"></a><span id="l19.683">     PR_FREEIF(parm_value);</span>
<a href="#l19.684"></a><span id="l19.684">     PR_FREEIF(boundary);</span>
<a href="#l19.685"></a><span id="l19.685">     PR_FREEIF(tmp_value);</span>
<a href="#l19.686"></a><span id="l19.686">   }</span>
<a href="#l19.687"></a><span id="l19.687" class="difflineminus">-  newAttachment-&gt;size = 0;</span>
<a href="#l19.688"></a><span id="l19.688" class="difflineminus">-  newAttachment-&gt;encoding = MimeHeaders_get ( headers, HEADER_CONTENT_TRANSFER_ENCODING,</span>
<a href="#l19.689"></a><span id="l19.689" class="difflineminus">-                                              PR_FALSE, PR_FALSE );</span>
<a href="#l19.690"></a><span id="l19.690" class="difflineminus">-  newAttachment-&gt;description = MimeHeaders_get( headers, HEADER_CONTENT_DESCRIPTION,</span>
<a href="#l19.691"></a><span id="l19.691" class="difflineminus">-                                                PR_FALSE, PR_FALSE );</span>
<a href="#l19.692"></a><span id="l19.692" class="difflineplus">+  newAttachment-&gt;m_size = 0;</span>
<a href="#l19.693"></a><span id="l19.693" class="difflineplus">+  newAttachment-&gt;m_encoding.Adopt(MimeHeaders_get (headers, HEADER_CONTENT_TRANSFER_ENCODING,</span>
<a href="#l19.694"></a><span id="l19.694" class="difflineplus">+                                                   PR_FALSE, PR_FALSE ));</span>
<a href="#l19.695"></a><span id="l19.695" class="difflineplus">+  newAttachment-&gt;m_description.Adopt(MimeHeaders_get(headers, HEADER_CONTENT_DESCRIPTION,</span>
<a href="#l19.696"></a><span id="l19.696" class="difflineplus">+                                                     PR_FALSE, PR_FALSE ));</span>
<a href="#l19.697"></a><span id="l19.697">   //</span>
<a href="#l19.698"></a><span id="l19.698">   // If we came up empty for description or the orig URL, we should do something about it.</span>
<a href="#l19.699"></a><span id="l19.699">   //</span>
<a href="#l19.700"></a><span id="l19.700" class="difflineminus">-  if  ( ( (!newAttachment-&gt;description) || (!*newAttachment-&gt;description) ) &amp;&amp; (workURLSpec) )</span>
<a href="#l19.701"></a><span id="l19.701" class="difflineminus">-    newAttachment-&gt;description = strdup(workURLSpec);</span>
<a href="#l19.702"></a><span id="l19.702" class="difflineplus">+  if (newAttachment-&gt;m_description.IsEmpty() &amp;&amp; workURLSpec)</span>
<a href="#l19.703"></a><span id="l19.703" class="difflineplus">+    newAttachment-&gt;m_description = workURLSpec;</span>
<a href="#l19.704"></a><span id="l19.704"> </span>
<a href="#l19.705"></a><span id="l19.705">   nsCOMPtr &lt;nsIFile&gt; tmpFile = nsnull;</span>
<a href="#l19.706"></a><span id="l19.706">   {</span>
<a href="#l19.707"></a><span id="l19.707">     // Let's build a temp file with an extension based on the content-type: nsmail.&lt;extension&gt;</span>
<a href="#l19.708"></a><span id="l19.708"> </span>
<a href="#l19.709"></a><span id="l19.709">     nsCAutoString  newAttachName (&quot;nsmail&quot;);</span>
<a href="#l19.710"></a><span id="l19.710">     PRBool extensionAdded = PR_FALSE;</span>
<a href="#l19.711"></a><span id="l19.711">     // the content type may contain a charset. i.e. text/html; ISO-2022-JP...we want to strip off the charset</span>
<a href="#l19.712"></a><span id="l19.712">     // before we ask the mime service for a mime info for this content type.</span>
<a href="#l19.713"></a><span id="l19.713" class="difflineminus">-    nsCAutoString contentType (newAttachment-&gt;type);</span>
<a href="#l19.714"></a><span id="l19.714" class="difflineplus">+    nsCAutoString contentType (newAttachment-&gt;m_type);</span>
<a href="#l19.715"></a><span id="l19.715">     PRInt32 pos = contentType.FindChar(';');</span>
<a href="#l19.716"></a><span id="l19.716">     if (pos &gt; 0)</span>
<a href="#l19.717"></a><span id="l19.717">       contentType.SetLength(pos);</span>
<a href="#l19.718"></a><span id="l19.718">     nsresult  rv = NS_OK;</span>
<a href="#l19.719"></a><span id="l19.719">     nsCOMPtr&lt;nsIMIMEService&gt; mimeFinder (do_GetService(NS_MIMESERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l19.720"></a><span id="l19.720">     if (NS_SUCCEEDED(rv) &amp;&amp; mimeFinder)</span>
<a href="#l19.721"></a><span id="l19.721">     {</span>
<a href="#l19.722"></a><span id="l19.722">       nsCAutoString fileExtension;</span>
<a href="#l19.723"></a><span id="l19.723" class="difflineat">@@ -1948,59 +1861,57 @@ mime_decompose_file_init_fn ( void *stre</span>
<a href="#l19.724"></a><span id="l19.724">   // This needs to be done so the attachment structure has a handle</span>
<a href="#l19.725"></a><span id="l19.725">   // on the temp file for this attachment...</span>
<a href="#l19.726"></a><span id="l19.726">   // if ( (tmpFile) &amp;&amp; (!bodyPart) )</span>
<a href="#l19.727"></a><span id="l19.727">   if (tmpFile)</span>
<a href="#l19.728"></a><span id="l19.728">   {</span>
<a href="#l19.729"></a><span id="l19.729">       nsCAutoString fileURL;</span>
<a href="#l19.730"></a><span id="l19.730">       rv = NS_GetURLSpecFromFile(tmpFile, fileURL);</span>
<a href="#l19.731"></a><span id="l19.731">       if (NS_SUCCEEDED(rv))</span>
<a href="#l19.732"></a><span id="l19.732" class="difflineminus">-        nsMimeNewURI(getter_AddRefs(newAttachment-&gt;orig_url),</span>
<a href="#l19.733"></a><span id="l19.733" class="difflineplus">+        nsMimeNewURI(getter_AddRefs(newAttachment-&gt;m_origUrl),</span>
<a href="#l19.734"></a><span id="l19.734">                      fileURL.get(), nsnull);</span>
<a href="#l19.735"></a><span id="l19.735">   }</span>
<a href="#l19.736"></a><span id="l19.736"> </span>
<a href="#l19.737"></a><span id="l19.737">   PR_FREEIF(workURLSpec);</span>
<a href="#l19.738"></a><span id="l19.738">   if (!tmpFile)</span>
<a href="#l19.739"></a><span id="l19.739">     return MIME_OUT_OF_MEMORY;</span>
<a href="#l19.740"></a><span id="l19.740"> </span>
<a href="#l19.741"></a><span id="l19.741">   mdd-&gt;tmpFile = do_QueryInterface(tmpFile);</span>
<a href="#l19.742"></a><span id="l19.742"> </span>
<a href="#l19.743"></a><span id="l19.743" class="difflineminus">-  newAttachment-&gt;tmp_file = mdd-&gt;tmpFile;</span>
<a href="#l19.744"></a><span id="l19.744" class="difflineplus">+  newAttachment-&gt;m_tmpFile = mdd-&gt;tmpFile;</span>
<a href="#l19.745"></a><span id="l19.745"> </span>
<a href="#l19.746"></a><span id="l19.746">   rv = MsgNewBufferedFileOutputStream(getter_AddRefs(mdd-&gt;tmpFileStream), tmpFile,PR_WRONLY | PR_CREATE_FILE, 00600);</span>
<a href="#l19.747"></a><span id="l19.747">   if (NS_FAILED(rv))</span>
<a href="#l19.748"></a><span id="l19.748">     return MIME_UNABLE_TO_OPEN_TMP_FILE;</span>
<a href="#l19.749"></a><span id="l19.749"> </span>
<a href="#l19.750"></a><span id="l19.750">   // For now, we are always going to decode all of the attachments</span>
<a href="#l19.751"></a><span id="l19.751">   // for the message. This way, we have native data</span>
<a href="#l19.752"></a><span id="l19.752">   if (creatingMsgBody)</span>
<a href="#l19.753"></a><span id="l19.753">   {</span>
<a href="#l19.754"></a><span id="l19.754">     MimeDecoderData *(*fn) (nsresult (*) (const char*, PRInt32, void*), void*) = 0;</span>
<a href="#l19.755"></a><span id="l19.755"> </span>
<a href="#l19.756"></a><span id="l19.756">     //</span>
<a href="#l19.757"></a><span id="l19.757">     // Initialize a decoder if necessary.</span>
<a href="#l19.758"></a><span id="l19.758">     //</span>
<a href="#l19.759"></a><span id="l19.759" class="difflineminus">-    if (!newAttachment-&gt;encoding)</span>
<a href="#l19.760"></a><span id="l19.760" class="difflineminus">-      ;</span>
<a href="#l19.761"></a><span id="l19.761" class="difflineminus">-    else if (!PL_strcasecmp(newAttachment-&gt;encoding, ENCODING_BASE64))</span>
<a href="#l19.762"></a><span id="l19.762" class="difflineplus">+    if (newAttachment-&gt;m_encoding.LowerCaseEqualsLiteral(ENCODING_BASE64))</span>
<a href="#l19.763"></a><span id="l19.763">       fn = &amp;MimeB64DecoderInit;</span>
<a href="#l19.764"></a><span id="l19.764" class="difflineminus">-    else if (!PL_strcasecmp(newAttachment-&gt;encoding, ENCODING_QUOTED_PRINTABLE))</span>
<a href="#l19.765"></a><span id="l19.765" class="difflineplus">+    else if (newAttachment-&gt;m_encoding.LowerCaseEqualsLiteral(ENCODING_QUOTED_PRINTABLE))</span>
<a href="#l19.766"></a><span id="l19.766">     {</span>
<a href="#l19.767"></a><span id="l19.767">       mdd-&gt;decoder_data = MimeQPDecoderInit (/* The (nsresult (*) ...) cast is to turn the `void' argument into `MimeObject'. */</span>
<a href="#l19.768"></a><span id="l19.768">                               ((nsresult (*) (const char *, PRInt32, void *))</span>
<a href="#l19.769"></a><span id="l19.769">                               dummy_file_write), mdd-&gt;tmpFileStream);</span>
<a href="#l19.770"></a><span id="l19.770">       if (!mdd-&gt;decoder_data)</span>
<a href="#l19.771"></a><span id="l19.771">         return MIME_OUT_OF_MEMORY;</span>
<a href="#l19.772"></a><span id="l19.772">     }</span>
<a href="#l19.773"></a><span id="l19.773" class="difflineminus">-    else if (!PL_strcasecmp(newAttachment-&gt;encoding, ENCODING_UUENCODE) ||</span>
<a href="#l19.774"></a><span id="l19.774" class="difflineminus">-             !PL_strcasecmp(newAttachment-&gt;encoding, ENCODING_UUENCODE2) ||</span>
<a href="#l19.775"></a><span id="l19.775" class="difflineminus">-             !PL_strcasecmp(newAttachment-&gt;encoding, ENCODING_UUENCODE3) ||</span>
<a href="#l19.776"></a><span id="l19.776" class="difflineminus">-             !PL_strcasecmp(newAttachment-&gt;encoding, ENCODING_UUENCODE4))</span>
<a href="#l19.777"></a><span id="l19.777" class="difflineplus">+    else if (newAttachment-&gt;m_encoding.LowerCaseEqualsLiteral(ENCODING_UUENCODE) ||</span>
<a href="#l19.778"></a><span id="l19.778" class="difflineplus">+             newAttachment-&gt;m_encoding.LowerCaseEqualsLiteral(ENCODING_UUENCODE2) ||</span>
<a href="#l19.779"></a><span id="l19.779" class="difflineplus">+             newAttachment-&gt;m_encoding.LowerCaseEqualsLiteral(ENCODING_UUENCODE3) ||</span>
<a href="#l19.780"></a><span id="l19.780" class="difflineplus">+             newAttachment-&gt;m_encoding.LowerCaseEqualsLiteral(ENCODING_UUENCODE4))</span>
<a href="#l19.781"></a><span id="l19.781">       fn = &amp;MimeUUDecoderInit;</span>
<a href="#l19.782"></a><span id="l19.782" class="difflineminus">-    else if (!PL_strcasecmp(newAttachment-&gt;encoding, ENCODING_YENCODE))</span>
<a href="#l19.783"></a><span id="l19.783" class="difflineplus">+    else if (newAttachment-&gt;m_encoding.LowerCaseEqualsLiteral(ENCODING_YENCODE))</span>
<a href="#l19.784"></a><span id="l19.784">       fn = &amp;MimeYDecoderInit;</span>
<a href="#l19.785"></a><span id="l19.785"> </span>
<a href="#l19.786"></a><span id="l19.786">     if (fn)</span>
<a href="#l19.787"></a><span id="l19.787">     {</span>
<a href="#l19.788"></a><span id="l19.788">       mdd-&gt;decoder_data = fn (/* The (nsresult (*) ...) cast is to turn the `void' argument into `MimeObject'. */</span>
<a href="#l19.789"></a><span id="l19.789">                               ((nsresult (*) (const char *, PRInt32, void *))</span>
<a href="#l19.790"></a><span id="l19.790">                               dummy_file_write), mdd-&gt;tmpFileStream);</span>
<a href="#l19.791"></a><span id="l19.791">       if (!mdd-&gt;decoder_data)</span>
<a href="#l19.792"></a><span id="l19.792" class="difflineat">@@ -2011,48 +1922,48 @@ mime_decompose_file_init_fn ( void *stre</span>
<a href="#l19.793"></a><span id="l19.793">   return 0;</span>
<a href="#l19.794"></a><span id="l19.794"> }</span>
<a href="#l19.795"></a><span id="l19.795"> </span>
<a href="#l19.796"></a><span id="l19.796"> nsresult</span>
<a href="#l19.797"></a><span id="l19.797"> mime_decompose_file_output_fn (const char     *buf,</span>
<a href="#l19.798"></a><span id="l19.798">                                PRInt32  size,</span>
<a href="#l19.799"></a><span id="l19.799">                                void     *stream_closure )</span>
<a href="#l19.800"></a><span id="l19.800"> {</span>
<a href="#l19.801"></a><span id="l19.801" class="difflineminus">-  struct mime_draft_data *mdd = (struct mime_draft_data *) stream_closure;</span>
<a href="#l19.802"></a><span id="l19.802" class="difflineplus">+  mime_draft_data *mdd = (mime_draft_data *) stream_closure;</span>
<a href="#l19.803"></a><span id="l19.803">   int ret = 0;</span>
<a href="#l19.804"></a><span id="l19.804"> </span>
<a href="#l19.805"></a><span id="l19.805">   NS_ASSERTION (mdd &amp;&amp; buf, &quot;missing mime draft data and/or buf&quot;);</span>
<a href="#l19.806"></a><span id="l19.806">   if (!mdd || !buf) return -1;</span>
<a href="#l19.807"></a><span id="l19.807">   if (!size) return NS_OK;</span>
<a href="#l19.808"></a><span id="l19.808"> </span>
<a href="#l19.809"></a><span id="l19.809">   if ( !mdd-&gt;tmpFileStream )</span>
<a href="#l19.810"></a><span id="l19.810">     return NS_OK;</span>
<a href="#l19.811"></a><span id="l19.811"> </span>
<a href="#l19.812"></a><span id="l19.812">   if (mdd-&gt;decoder_data) {</span>
<a href="#l19.813"></a><span id="l19.813">     PRInt32 outsize;</span>
<a href="#l19.814"></a><span id="l19.814">     ret = MimeDecoderWrite(mdd-&gt;decoder_data, buf, size, &amp;outsize);</span>
<a href="#l19.815"></a><span id="l19.815">     if (ret == -1) return -1;</span>
<a href="#l19.816"></a><span id="l19.816" class="difflineminus">-    mdd-&gt;curAttachment-&gt;size += outsize;</span>
<a href="#l19.817"></a><span id="l19.817" class="difflineplus">+    mdd-&gt;curAttachment-&gt;m_size += outsize;</span>
<a href="#l19.818"></a><span id="l19.818">   }</span>
<a href="#l19.819"></a><span id="l19.819">   else</span>
<a href="#l19.820"></a><span id="l19.820">   {</span>
<a href="#l19.821"></a><span id="l19.821">     PRUint32 bytesWritten;</span>
<a href="#l19.822"></a><span id="l19.822">     mdd-&gt;tmpFileStream-&gt;Write(buf, size, &amp;bytesWritten);</span>
<a href="#l19.823"></a><span id="l19.823">     if (bytesWritten &lt; size)</span>
<a href="#l19.824"></a><span id="l19.824">       return MIME_ERROR_WRITING_FILE;</span>
<a href="#l19.825"></a><span id="l19.825" class="difflineminus">-    mdd-&gt;curAttachment-&gt;size += size;</span>
<a href="#l19.826"></a><span id="l19.826" class="difflineplus">+    mdd-&gt;curAttachment-&gt;m_size += size;</span>
<a href="#l19.827"></a><span id="l19.827">   }</span>
<a href="#l19.828"></a><span id="l19.828"> </span>
<a href="#l19.829"></a><span id="l19.829">   return NS_OK;</span>
<a href="#l19.830"></a><span id="l19.830"> }</span>
<a href="#l19.831"></a><span id="l19.831"> </span>
<a href="#l19.832"></a><span id="l19.832"> nsresult</span>
<a href="#l19.833"></a><span id="l19.833"> mime_decompose_file_close_fn ( void *stream_closure )</span>
<a href="#l19.834"></a><span id="l19.834"> {</span>
<a href="#l19.835"></a><span id="l19.835" class="difflineminus">-  struct mime_draft_data *mdd = (struct mime_draft_data *) stream_closure;</span>
<a href="#l19.836"></a><span id="l19.836" class="difflineplus">+  mime_draft_data *mdd = (mime_draft_data *) stream_closure;</span>
<a href="#l19.837"></a><span id="l19.837"> </span>
<a href="#l19.838"></a><span id="l19.838">   if ( !mdd || !mdd-&gt;tmpFileStream )</span>
<a href="#l19.839"></a><span id="l19.839">     return -1;</span>
<a href="#l19.840"></a><span id="l19.840"> </span>
<a href="#l19.841"></a><span id="l19.841">   if ( --mdd-&gt;options-&gt;decompose_init_count &gt; 0 )</span>
<a href="#l19.842"></a><span id="l19.842">       return 0;</span>
<a href="#l19.843"></a><span id="l19.843"> </span>
<a href="#l19.844"></a><span id="l19.844">   if (mdd-&gt;decoder_data) {</span>
<a href="#l19.845"></a><span id="l19.845" class="difflineat">@@ -2073,23 +1984,23 @@ extern &quot;C&quot; void  *</span>
<a href="#l19.846"></a><span id="l19.846"> mime_bridge_create_draft_stream(</span>
<a href="#l19.847"></a><span id="l19.847">                           nsIMimeEmitter      *newEmitter,</span>
<a href="#l19.848"></a><span id="l19.848">                           nsStreamConverter   *newPluginObj2,</span>
<a href="#l19.849"></a><span id="l19.849">                           nsIURI              *uri,</span>
<a href="#l19.850"></a><span id="l19.850">                           nsMimeOutputType    format_out)</span>
<a href="#l19.851"></a><span id="l19.851"> {</span>
<a href="#l19.852"></a><span id="l19.852">   int                     status = 0;</span>
<a href="#l19.853"></a><span id="l19.853">   nsMIMESession           *stream = nsnull;</span>
<a href="#l19.854"></a><span id="l19.854" class="difflineminus">-  struct mime_draft_data  *mdd = nsnull;</span>
<a href="#l19.855"></a><span id="l19.855" class="difflineplus">+  mime_draft_data  *mdd = nsnull;</span>
<a href="#l19.856"></a><span id="l19.856">   MimeObject              *obj = nsnull;</span>
<a href="#l19.857"></a><span id="l19.857"> </span>
<a href="#l19.858"></a><span id="l19.858">   if ( !uri )</span>
<a href="#l19.859"></a><span id="l19.859">     return nsnull;</span>
<a href="#l19.860"></a><span id="l19.860"> </span>
<a href="#l19.861"></a><span id="l19.861" class="difflineminus">-  mdd = PR_NEWZAP(struct mime_draft_data);</span>
<a href="#l19.862"></a><span id="l19.862" class="difflineplus">+  mdd = new mime_draft_data;</span>
<a href="#l19.863"></a><span id="l19.863">   if (!mdd)</span>
<a href="#l19.864"></a><span id="l19.864">     return nsnull;</span>
<a href="#l19.865"></a><span id="l19.865"> </span>
<a href="#l19.866"></a><span id="l19.866">   nsCAutoString turl;</span>
<a href="#l19.867"></a><span id="l19.867">   nsCOMPtr &lt;nsIMsgMessageService&gt; msgService;</span>
<a href="#l19.868"></a><span id="l19.868">   nsCOMPtr&lt;nsIURI&gt; aURL;</span>
<a href="#l19.869"></a><span id="l19.869">   nsCAutoString urlString;</span>
<a href="#l19.870"></a><span id="l19.870">   nsresult rv;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/mime/src/mimehdrs.cpp</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/mime/src/mimehdrs.cpp</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -687,17 +687,17 @@ MIME_StripContinuations(char *original)</span>
<a href="#l20.4"></a><span id="l20.4">   return original;</span>
<a href="#l20.5"></a><span id="l20.5"> }</span>
<a href="#l20.6"></a><span id="l20.6"> </span>
<a href="#l20.7"></a><span id="l20.7"> extern PRInt16 INTL_DefaultMailToWinCharSetID(PRInt16 csid);</span>
<a href="#l20.8"></a><span id="l20.8"> </span>
<a href="#l20.9"></a><span id="l20.9"> /* Given text purporting to be a qtext header value, strip backslashes that</span>
<a href="#l20.10"></a><span id="l20.10">   may be escaping other chars in the string. */</span>
<a href="#l20.11"></a><span id="l20.11"> char *</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-mime_decode_filename(char *name, const char *charset,</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+mime_decode_filename(const char *name, const char *charset,</span>
<a href="#l20.14"></a><span id="l20.14">                      MimeDisplayOptions *opt)</span>
<a href="#l20.15"></a><span id="l20.15"> {</span>
<a href="#l20.16"></a><span id="l20.16">   nsresult rv;</span>
<a href="#l20.17"></a><span id="l20.17">   nsCOMPtr &lt;nsIMIMEHeaderParam&gt; mimehdrpar =</span>
<a href="#l20.18"></a><span id="l20.18">     do_GetService(NS_MIMEHEADERPARAM_CONTRACTID, &amp;rv);</span>
<a href="#l20.19"></a><span id="l20.19"> </span>
<a href="#l20.20"></a><span id="l20.20">   if (NS_FAILED(rv))</span>
<a href="#l20.21"></a><span id="l20.21">     return nsnull;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/mime/src/mimehdrs.h</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/mime/src/mimehdrs.h</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -101,17 +101,17 @@ extern char *MimeHeaders_make_crypto_sta</span>
<a href="#l21.4"></a><span id="l21.4">    PRBool close_parent_stamp_p,</span>
<a href="#l21.5"></a><span id="l21.5"> </span>
<a href="#l21.6"></a><span id="l21.6">    const char *stamp_url);</span>
<a href="#l21.7"></a><span id="l21.7"> </span>
<a href="#l21.8"></a><span id="l21.8"> /* Does all the heuristic silliness to find the filename in the given headers.</span>
<a href="#l21.9"></a><span id="l21.9">  */</span>
<a href="#l21.10"></a><span id="l21.10"> extern char *MimeHeaders_get_name(MimeHeaders *hdrs, MimeDisplayOptions *opt);</span>
<a href="#l21.11"></a><span id="l21.11"> </span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-extern char *mime_decode_filename(char *name, const char* charset,</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+extern char *mime_decode_filename(const char *name, const char* charset,</span>
<a href="#l21.14"></a><span id="l21.14">                                   MimeDisplayOptions *opt);</span>
<a href="#l21.15"></a><span id="l21.15"> </span>
<a href="#l21.16"></a><span id="l21.16"> extern &quot;C&quot;  char * MIME_StripContinuations(char *original);</span>
<a href="#l21.17"></a><span id="l21.17"> </span>
<a href="#l21.18"></a><span id="l21.18"> /**</span>
<a href="#l21.19"></a><span id="l21.19">  * Convert this value to a unicode string, based on the charset.</span>
<a href="#l21.20"></a><span id="l21.20">  */</span>
<a href="#l21.21"></a><span id="l21.21"> extern void MimeHeaders_convert_header_value(MimeDisplayOptions *opt,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/mime/src/mimemoz2.cpp</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/mime/src/mimemoz2.cpp</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -127,43 +127,41 @@ ProcessBodyAsAttachment(MimeObject *obj,</span>
<a href="#l22.4"></a><span id="l22.4">   // Ok, this is the special case when somebody sends an &quot;attachment&quot; as the body</span>
<a href="#l22.5"></a><span id="l22.5">   // of an RFC822 message...I really don't think this is the way this should be done.</span>
<a href="#l22.6"></a><span id="l22.6">   // I belive this should really be a multipart/mixed message with an empty body part,</span>
<a href="#l22.7"></a><span id="l22.7">   // but what can ya do...our friends to the North seem to do this.</span>
<a href="#l22.8"></a><span id="l22.8">   //</span>
<a href="#l22.9"></a><span id="l22.9">   MimeObject    *child = obj;</span>
<a href="#l22.10"></a><span id="l22.10"> </span>
<a href="#l22.11"></a><span id="l22.11">   n = 1;</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-  *data = (nsMsgAttachmentData *)PR_Malloc( (n + 1) * sizeof(nsMsgAttachmentData));</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+  *data = new nsMsgAttachmentData[2];</span>
<a href="#l22.14"></a><span id="l22.14">   if (!*data)</span>
<a href="#l22.15"></a><span id="l22.15">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l22.16"></a><span id="l22.16"> </span>
<a href="#l22.17"></a><span id="l22.17">   tmp = *data;</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineminus">-  memset(*data, 0, (n + 1) * sizeof(nsMsgAttachmentData));</span>
<a href="#l22.19"></a><span id="l22.19" class="difflineminus">-  tmp-&gt;real_type = child-&gt;content_type ? strdup(child-&gt;content_type) : NULL;</span>
<a href="#l22.20"></a><span id="l22.20" class="difflineminus">-  tmp-&gt;real_encoding = child-&gt;encoding ? strdup(child-&gt;encoding) : NULL;</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineplus">+  tmp-&gt;m_realType = child-&gt;content_type;</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineplus">+  tmp-&gt;m_realEncoding = child-&gt;encoding;</span>
<a href="#l22.23"></a><span id="l22.23">   disp = MimeHeaders_get(child-&gt;headers, HEADER_CONTENT_DISPOSITION, PR_FALSE, PR_FALSE);</span>
<a href="#l22.24"></a><span id="l22.24" class="difflineminus">-  tmp-&gt;real_name = MimeHeaders_get_parameter(disp, &quot;name&quot;, &amp;charset, NULL);</span>
<a href="#l22.25"></a><span id="l22.25" class="difflineminus">-  if (tmp-&gt;real_name)</span>
<a href="#l22.26"></a><span id="l22.26" class="difflineplus">+  tmp-&gt;m_realName.Adopt(MimeHeaders_get_parameter(disp, &quot;name&quot;, &amp;charset, NULL));</span>
<a href="#l22.27"></a><span id="l22.27" class="difflineplus">+  if (!tmp-&gt;m_realName.IsEmpty())</span>
<a href="#l22.28"></a><span id="l22.28">   {</span>
<a href="#l22.29"></a><span id="l22.29">     char *fname = NULL;</span>
<a href="#l22.30"></a><span id="l22.30" class="difflineminus">-    fname = mime_decode_filename(tmp-&gt;real_name, charset, obj-&gt;options);</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineplus">+    fname = mime_decode_filename(tmp-&gt;m_realName.get(), charset, obj-&gt;options);</span>
<a href="#l22.32"></a><span id="l22.32">     nsMemory::Free(charset);</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineminus">-    if (fname &amp;&amp; fname != tmp-&gt;real_name)</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineminus">-    {</span>
<a href="#l22.35"></a><span id="l22.35" class="difflineminus">-      PR_Free(tmp-&gt;real_name);</span>
<a href="#l22.36"></a><span id="l22.36" class="difflineminus">-      tmp-&gt;real_name = fname;</span>
<a href="#l22.37"></a><span id="l22.37" class="difflineminus">-    }</span>
<a href="#l22.38"></a><span id="l22.38" class="difflineplus">+    if (fname)</span>
<a href="#l22.39"></a><span id="l22.39" class="difflineplus">+      tmp-&gt;m_realName.Adopt(fname);</span>
<a href="#l22.40"></a><span id="l22.40">   }</span>
<a href="#l22.41"></a><span id="l22.41">   else</span>
<a href="#l22.42"></a><span id="l22.42">   {</span>
<a href="#l22.43"></a><span id="l22.43" class="difflineminus">-    tmp-&gt;real_name = MimeHeaders_get_name(child-&gt;headers, obj-&gt;options);</span>
<a href="#l22.44"></a><span id="l22.44" class="difflineplus">+    tmp-&gt;m_realName.Adopt(MimeHeaders_get_name(child-&gt;headers, obj-&gt;options));</span>
<a href="#l22.45"></a><span id="l22.45">   }</span>
<a href="#l22.46"></a><span id="l22.46"> </span>
<a href="#l22.47"></a><span id="l22.47" class="difflineminus">-  if ( (!tmp-&gt;real_name) &amp;&amp; (tmp-&gt;real_type) &amp;&amp; (PL_strncasecmp(tmp-&gt;real_type, &quot;text&quot;, 4)) )</span>
<a href="#l22.48"></a><span id="l22.48" class="difflineplus">+  if (tmp-&gt;m_realName.IsEmpty() &amp;&amp;</span>
<a href="#l22.49"></a><span id="l22.49" class="difflineplus">+      StringBeginsWith(tmp-&gt;m_realType, NS_LITERAL_CSTRING(&quot;text&quot;),</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineplus">+                       nsCaseInsensitiveCStringComparator()))</span>
<a href="#l22.51"></a><span id="l22.51">     ValidateRealName(tmp, child-&gt;headers);</span>
<a href="#l22.52"></a><span id="l22.52"> </span>
<a href="#l22.53"></a><span id="l22.53">   char  *tmpURL = nsnull;</span>
<a href="#l22.54"></a><span id="l22.54">   char  *id = nsnull;</span>
<a href="#l22.55"></a><span id="l22.55">   char  *id_imap = nsnull;</span>
<a href="#l22.56"></a><span id="l22.56"> </span>
<a href="#l22.57"></a><span id="l22.57">   id = mime_part_address (obj);</span>
<a href="#l22.58"></a><span id="l22.58">   if (obj-&gt;options-&gt;missing_parts)</span>
<a href="#l22.59"></a><span id="l22.59" class="difflineat">@@ -179,37 +177,37 @@ ProcessBodyAsAttachment(MimeObject *obj,</span>
<a href="#l22.60"></a><span id="l22.60">   if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;url)</span>
<a href="#l22.61"></a><span id="l22.61">   {</span>
<a href="#l22.62"></a><span id="l22.62">     const char  *url = obj-&gt;options-&gt;url;</span>
<a href="#l22.63"></a><span id="l22.63">     nsresult    rv;</span>
<a href="#l22.64"></a><span id="l22.64">     if (id_imap &amp;&amp; id)</span>
<a href="#l22.65"></a><span id="l22.65">     {</span>
<a href="#l22.66"></a><span id="l22.66">       // if this is an IMAP part.</span>
<a href="#l22.67"></a><span id="l22.67">       tmpURL = mime_set_url_imap_part(url, id_imap, id);</span>
<a href="#l22.68"></a><span id="l22.68" class="difflineminus">-      rv = nsMimeNewURI(&amp;(tmp-&gt;url), tmpURL, nsnull);</span>
<a href="#l22.69"></a><span id="l22.69" class="difflineplus">+      rv = nsMimeNewURI(getter_AddRefs(tmp-&gt;m_url), tmpURL, nsnull);</span>
<a href="#l22.70"></a><span id="l22.70">     }</span>
<a href="#l22.71"></a><span id="l22.71">     else</span>
<a href="#l22.72"></a><span id="l22.72">     {</span>
<a href="#l22.73"></a><span id="l22.73">       // This is just a normal MIME part as usual.</span>
<a href="#l22.74"></a><span id="l22.74">       tmpURL = mime_set_url_part(url, id, PR_TRUE);</span>
<a href="#l22.75"></a><span id="l22.75" class="difflineminus">-      rv = nsMimeNewURI(&amp;(tmp-&gt;url), tmpURL, nsnull);</span>
<a href="#l22.76"></a><span id="l22.76" class="difflineplus">+      rv = nsMimeNewURI(getter_AddRefs(tmp-&gt;m_url), tmpURL, nsnull);</span>
<a href="#l22.77"></a><span id="l22.77">     }</span>
<a href="#l22.78"></a><span id="l22.78"> </span>
<a href="#l22.79"></a><span id="l22.79" class="difflineminus">-    if ( (!tmp-&gt;url) || (NS_FAILED(rv)) )</span>
<a href="#l22.80"></a><span id="l22.80" class="difflineplus">+    if (!tmp-&gt;m_url || NS_FAILED(rv))</span>
<a href="#l22.81"></a><span id="l22.81">     {</span>
<a href="#l22.82"></a><span id="l22.82">       PR_FREEIF(*data);</span>
<a href="#l22.83"></a><span id="l22.83">       PR_FREEIF(id);</span>
<a href="#l22.84"></a><span id="l22.84">       PR_FREEIF(id_imap);</span>
<a href="#l22.85"></a><span id="l22.85">       return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l22.86"></a><span id="l22.86">     }</span>
<a href="#l22.87"></a><span id="l22.87">   }</span>
<a href="#l22.88"></a><span id="l22.88">   PR_FREEIF(id);</span>
<a href="#l22.89"></a><span id="l22.89">   PR_FREEIF(id_imap);</span>
<a href="#l22.90"></a><span id="l22.90">   PR_FREEIF(tmpURL);</span>
<a href="#l22.91"></a><span id="l22.91" class="difflineminus">-  tmp-&gt;description = MimeHeaders_get(child-&gt;headers, HEADER_CONTENT_DESCRIPTION, PR_FALSE, PR_FALSE);</span>
<a href="#l22.92"></a><span id="l22.92" class="difflineplus">+  tmp-&gt;m_description.Adopt(MimeHeaders_get(child-&gt;headers, HEADER_CONTENT_DESCRIPTION, PR_FALSE, PR_FALSE));</span>
<a href="#l22.93"></a><span id="l22.93">   return NS_OK;</span>
<a href="#l22.94"></a><span id="l22.94"> }</span>
<a href="#l22.95"></a><span id="l22.95"> </span>
<a href="#l22.96"></a><span id="l22.96"> PRInt32</span>
<a href="#l22.97"></a><span id="l22.97"> CountTotalMimeAttachments(MimeContainer *aObj)</span>
<a href="#l22.98"></a><span id="l22.98"> {</span>
<a href="#l22.99"></a><span id="l22.99">   PRInt32     i;</span>
<a href="#l22.100"></a><span id="l22.100">   PRInt32     rc = 0;</span>
<a href="#l22.101"></a><span id="l22.101" class="difflineat">@@ -229,62 +227,64 @@ CountTotalMimeAttachments(MimeContainer </span>
<a href="#l22.102"></a><span id="l22.102"> void</span>
<a href="#l22.103"></a><span id="l22.103"> ValidateRealName(nsMsgAttachmentData *aAttach, MimeHeaders *aHdrs)</span>
<a href="#l22.104"></a><span id="l22.104"> {</span>
<a href="#l22.105"></a><span id="l22.105">   // Sanity.</span>
<a href="#l22.106"></a><span id="l22.106">   if (!aAttach)</span>
<a href="#l22.107"></a><span id="l22.107">     return;</span>
<a href="#l22.108"></a><span id="l22.108"> </span>
<a href="#l22.109"></a><span id="l22.109">   // Do we need to validate?</span>
<a href="#l22.110"></a><span id="l22.110" class="difflineminus">-  if ( (aAttach-&gt;real_name) &amp;&amp; (*(aAttach-&gt;real_name)) )</span>
<a href="#l22.111"></a><span id="l22.111" class="difflineplus">+  if (!aAttach-&gt;m_realName.IsEmpty())</span>
<a href="#l22.112"></a><span id="l22.112">     return;</span>
<a href="#l22.113"></a><span id="l22.113"> </span>
<a href="#l22.114"></a><span id="l22.114">   // Internal MIME structures need not be named!</span>
<a href="#l22.115"></a><span id="l22.115" class="difflineminus">-  if ( (!aAttach-&gt;real_type) || (aAttach-&gt;real_type &amp;&amp;</span>
<a href="#l22.116"></a><span id="l22.116" class="difflineminus">-                                 !PL_strncasecmp(aAttach-&gt;real_type, &quot;multipart&quot;, 9)) )</span>
<a href="#l22.117"></a><span id="l22.117" class="difflineplus">+  if (aAttach-&gt;m_realType.IsEmpty() ||</span>
<a href="#l22.118"></a><span id="l22.118" class="difflineplus">+      StringBeginsWith(aAttach-&gt;m_realType, NS_LITERAL_CSTRING(&quot;multipart&quot;),</span>
<a href="#l22.119"></a><span id="l22.119" class="difflineplus">+                       nsCaseInsensitiveCStringComparator()))</span>
<a href="#l22.120"></a><span id="l22.120">     return;</span>
<a href="#l22.121"></a><span id="l22.121"> </span>
<a href="#l22.122"></a><span id="l22.122">   // Special case...if this is a enclosed RFC822 message, give it a nice</span>
<a href="#l22.123"></a><span id="l22.123">   // name.</span>
<a href="#l22.124"></a><span id="l22.124" class="difflineminus">-  if (aAttach-&gt;real_type &amp;&amp; !PL_strcasecmp(aAttach-&gt;real_type, MESSAGE_RFC822))</span>
<a href="#l22.125"></a><span id="l22.125" class="difflineplus">+  if (aAttach-&gt;m_realType.LowerCaseEqualsLiteral(MESSAGE_RFC822))</span>
<a href="#l22.126"></a><span id="l22.126">   {</span>
<a href="#l22.127"></a><span id="l22.127">     NS_ASSERTION(aHdrs, &quot;How comes the object's headers is null!&quot;);</span>
<a href="#l22.128"></a><span id="l22.128">     if (aHdrs &amp;&amp; aHdrs-&gt;munged_subject)</span>
<a href="#l22.129"></a><span id="l22.129" class="difflineminus">-      aAttach-&gt;real_name = PR_smprintf(&quot;%s.eml&quot;, aHdrs-&gt;munged_subject);</span>
<a href="#l22.130"></a><span id="l22.130" class="difflineplus">+    {</span>
<a href="#l22.131"></a><span id="l22.131" class="difflineplus">+      aAttach-&gt;m_realName.Assign(aHdrs-&gt;munged_subject);</span>
<a href="#l22.132"></a><span id="l22.132" class="difflineplus">+      aAttach-&gt;m_realName.Append(&quot;.eml&quot;);</span>
<a href="#l22.133"></a><span id="l22.133" class="difflineplus">+    }</span>
<a href="#l22.134"></a><span id="l22.134">     else</span>
<a href="#l22.135"></a><span id="l22.135" class="difflineminus">-      NS_MsgSACopy(&amp;(aAttach-&gt;real_name), &quot;ForwardedMessage.eml&quot;);</span>
<a href="#l22.136"></a><span id="l22.136" class="difflineplus">+      aAttach-&gt;m_realName = &quot;ForwardedMessage.eml&quot;;</span>
<a href="#l22.137"></a><span id="l22.137">     return;</span>
<a href="#l22.138"></a><span id="l22.138">   }</span>
<a href="#l22.139"></a><span id="l22.139"> </span>
<a href="#l22.140"></a><span id="l22.140">   //</span>
<a href="#l22.141"></a><span id="l22.141">   // Now validate any other name we have for the attachment!</span>
<a href="#l22.142"></a><span id="l22.142">   //</span>
<a href="#l22.143"></a><span id="l22.143" class="difflineminus">-  if (!aAttach-&gt;real_name || *aAttach-&gt;real_name == 0)</span>
<a href="#l22.144"></a><span id="l22.144" class="difflineplus">+  if (aAttach-&gt;m_realName.IsEmpty())</span>
<a href="#l22.145"></a><span id="l22.145">   {</span>
<a href="#l22.146"></a><span id="l22.146" class="difflineminus">-    nsCString newAttachName(NS_LITERAL_CSTRING(&quot;attachment&quot;));</span>
<a href="#l22.147"></a><span id="l22.147" class="difflineplus">+    aAttach-&gt;m_realName = &quot;attachment&quot;;</span>
<a href="#l22.148"></a><span id="l22.148">     nsresult rv = NS_OK;</span>
<a href="#l22.149"></a><span id="l22.149" class="difflineminus">-    nsCAutoString contentType (aAttach-&gt;real_type);</span>
<a href="#l22.150"></a><span id="l22.150" class="difflineplus">+    nsCAutoString contentType (aAttach-&gt;m_realType);</span>
<a href="#l22.151"></a><span id="l22.151">     PRInt32 pos = contentType.FindChar(';');</span>
<a href="#l22.152"></a><span id="l22.152">     if (pos &gt; 0)</span>
<a href="#l22.153"></a><span id="l22.153">       contentType.SetLength(pos);</span>
<a href="#l22.154"></a><span id="l22.154"> </span>
<a href="#l22.155"></a><span id="l22.155">     nsCOMPtr&lt;nsIMIMEService&gt; mimeFinder (do_GetService(NS_MIMESERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l22.156"></a><span id="l22.156">     if (NS_SUCCEEDED(rv))</span>
<a href="#l22.157"></a><span id="l22.157">     {</span>
<a href="#l22.158"></a><span id="l22.158">       nsCAutoString fileExtension;</span>
<a href="#l22.159"></a><span id="l22.159">       rv = mimeFinder-&gt;GetPrimaryExtension(contentType, EmptyCString(), fileExtension);</span>
<a href="#l22.160"></a><span id="l22.160"> </span>
<a href="#l22.161"></a><span id="l22.161">       if (NS_SUCCEEDED(rv) &amp;&amp; !fileExtension.IsEmpty())</span>
<a href="#l22.162"></a><span id="l22.162">       {</span>
<a href="#l22.163"></a><span id="l22.163" class="difflineminus">-        newAttachName.Append('.');</span>
<a href="#l22.164"></a><span id="l22.164" class="difflineminus">-        newAttachName.Append(fileExtension);</span>
<a href="#l22.165"></a><span id="l22.165" class="difflineplus">+        aAttach-&gt;m_realName.Append('.');</span>
<a href="#l22.166"></a><span id="l22.166" class="difflineplus">+        aAttach-&gt;m_realName.Append(fileExtension);</span>
<a href="#l22.167"></a><span id="l22.167">       }</span>
<a href="#l22.168"></a><span id="l22.168">     }</span>
<a href="#l22.169"></a><span id="l22.169" class="difflineminus">-</span>
<a href="#l22.170"></a><span id="l22.170" class="difflineminus">-    aAttach-&gt;real_name = ToNewCString(newAttachName);</span>
<a href="#l22.171"></a><span id="l22.171">   }</span>
<a href="#l22.172"></a><span id="l22.172"> }</span>
<a href="#l22.173"></a><span id="l22.173"> </span>
<a href="#l22.174"></a><span id="l22.174"> static  PRInt32     attIndex = 0;</span>
<a href="#l22.175"></a><span id="l22.175"> </span>
<a href="#l22.176"></a><span id="l22.176"> nsresult</span>
<a href="#l22.177"></a><span id="l22.177"> GenerateAttachmentData(MimeObject *object, const char *aMessageURL, MimeDisplayOptions *options,</span>
<a href="#l22.178"></a><span id="l22.178">                        PRBool isAnAppleDoublePart, PRInt32 attSize, nsMsgAttachmentData *aAttachData)</span>
<a href="#l22.179"></a><span id="l22.179" class="difflineat">@@ -336,156 +336,146 @@ GenerateAttachmentData(MimeObject *objec</span>
<a href="#l22.180"></a><span id="l22.180">   if (!urlSpec)</span>
<a href="#l22.181"></a><span id="l22.181">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l22.182"></a><span id="l22.182"> </span>
<a href="#l22.183"></a><span id="l22.183">   if ((options-&gt;format_out == nsMimeOutput::nsMimeMessageBodyDisplay) &amp;&amp; (PL_strncasecmp(aMessageURL, urlSpec, strlen(urlSpec)) == 0))</span>
<a href="#l22.184"></a><span id="l22.184">     return NS_OK;</span>
<a href="#l22.185"></a><span id="l22.185"> </span>
<a href="#l22.186"></a><span id="l22.186">   nsMsgAttachmentData *tmp = &amp;(aAttachData[attIndex++]);</span>
<a href="#l22.187"></a><span id="l22.187"> </span>
<a href="#l22.188"></a><span id="l22.188" class="difflineminus">-  tmp-&gt;real_type = object-&gt;content_type ? strdup(object-&gt;content_type) : nsnull;</span>
<a href="#l22.189"></a><span id="l22.189" class="difflineminus">-  tmp-&gt;real_encoding = object-&gt;encoding ? strdup(object-&gt;encoding) : nsnull;</span>
<a href="#l22.190"></a><span id="l22.190" class="difflineminus">-  tmp-&gt;isExternalAttachment = isExternalAttachment;</span>
<a href="#l22.191"></a><span id="l22.191" class="difflineminus">-  tmp-&gt;size = attSize;</span>
<a href="#l22.192"></a><span id="l22.192" class="difflineplus">+  tmp-&gt;m_realType = object-&gt;content_type;</span>
<a href="#l22.193"></a><span id="l22.193" class="difflineplus">+  tmp-&gt;m_realEncoding = object-&gt;encoding;</span>
<a href="#l22.194"></a><span id="l22.194" class="difflineplus">+  tmp-&gt;m_isExternalAttachment = isExternalAttachment;</span>
<a href="#l22.195"></a><span id="l22.195" class="difflineplus">+  tmp-&gt;m_size = attSize;</span>
<a href="#l22.196"></a><span id="l22.196"> </span>
<a href="#l22.197"></a><span id="l22.197">   char *part_addr = mime_imap_part_address(object);</span>
<a href="#l22.198"></a><span id="l22.198" class="difflineminus">-  tmp-&gt;isDownloaded = (part_addr == nsnull);</span>
<a href="#l22.199"></a><span id="l22.199" class="difflineplus">+  tmp-&gt;m_isDownloaded = (part_addr == nsnull);</span>
<a href="#l22.200"></a><span id="l22.200">   PR_FREEIF(part_addr);</span>
<a href="#l22.201"></a><span id="l22.201"> </span>
<a href="#l22.202"></a><span id="l22.202">   PRInt32 i;</span>
<a href="#l22.203"></a><span id="l22.203">   char *charset = nsnull;</span>
<a href="#l22.204"></a><span id="l22.204">   char *disp = MimeHeaders_get(object-&gt;headers, HEADER_CONTENT_DISPOSITION, PR_FALSE, PR_FALSE);</span>
<a href="#l22.205"></a><span id="l22.205">   if (disp)</span>
<a href="#l22.206"></a><span id="l22.206">   {</span>
<a href="#l22.207"></a><span id="l22.207" class="difflineminus">-    tmp-&gt;real_name = MimeHeaders_get_parameter(disp, &quot;filename&quot;, &amp;charset, nsnull);</span>
<a href="#l22.208"></a><span id="l22.208" class="difflineplus">+    tmp-&gt;m_realName.Adopt(MimeHeaders_get_parameter(disp, &quot;filename&quot;, &amp;charset, nsnull));</span>
<a href="#l22.209"></a><span id="l22.209">     if (isAnAppleDoublePart)</span>
<a href="#l22.210"></a><span id="l22.210" class="difflineminus">-      for (i = 0; i &lt; 2 &amp;&amp; !tmp-&gt;real_name; i ++)</span>
<a href="#l22.211"></a><span id="l22.211" class="difflineplus">+      for (i = 0; i &lt; 2 &amp;&amp; tmp-&gt;m_realName.IsEmpty(); i ++)</span>
<a href="#l22.212"></a><span id="l22.212">       {</span>
<a href="#l22.213"></a><span id="l22.213">         PR_FREEIF(disp);</span>
<a href="#l22.214"></a><span id="l22.214">         nsMemory::Free(charset);</span>
<a href="#l22.215"></a><span id="l22.215">         disp = MimeHeaders_get(((MimeContainer *)object)-&gt;children[i]-&gt;headers, HEADER_CONTENT_DISPOSITION, PR_FALSE, PR_FALSE);</span>
<a href="#l22.216"></a><span id="l22.216" class="difflineminus">-        tmp-&gt;real_name = MimeHeaders_get_parameter(disp, &quot;filename&quot;, &amp;charset, nsnull);</span>
<a href="#l22.217"></a><span id="l22.217" class="difflineplus">+        tmp-&gt;m_realName.Adopt(MimeHeaders_get_parameter(disp, &quot;filename&quot;, &amp;charset, nsnull));</span>
<a href="#l22.218"></a><span id="l22.218">       }</span>
<a href="#l22.219"></a><span id="l22.219"> </span>
<a href="#l22.220"></a><span id="l22.220" class="difflineminus">-    if (tmp-&gt;real_name)</span>
<a href="#l22.221"></a><span id="l22.221" class="difflineplus">+    if (!tmp-&gt;m_realName.IsEmpty())</span>
<a href="#l22.222"></a><span id="l22.222">     {</span>
<a href="#l22.223"></a><span id="l22.223">       // check encoded type</span>
<a href="#l22.224"></a><span id="l22.224">       //</span>
<a href="#l22.225"></a><span id="l22.225">       // The parameter of Content-Disposition must use RFC 2231.</span>
<a href="#l22.226"></a><span id="l22.226">       // But old Netscape 4.x and Outlook Express etc. use RFC2047.</span>
<a href="#l22.227"></a><span id="l22.227">       // So we should parse both types.</span>
<a href="#l22.228"></a><span id="l22.228"> </span>
<a href="#l22.229"></a><span id="l22.229">       char *fname = nsnull;</span>
<a href="#l22.230"></a><span id="l22.230" class="difflineminus">-      fname = mime_decode_filename(tmp-&gt;real_name, charset, options);</span>
<a href="#l22.231"></a><span id="l22.231" class="difflineplus">+      fname = mime_decode_filename(tmp-&gt;m_realName.get(), charset, options);</span>
<a href="#l22.232"></a><span id="l22.232">       nsMemory::Free(charset);</span>
<a href="#l22.233"></a><span id="l22.233"> </span>
<a href="#l22.234"></a><span id="l22.234" class="difflineminus">-      if (fname &amp;&amp; fname != tmp-&gt;real_name)</span>
<a href="#l22.235"></a><span id="l22.235" class="difflineminus">-      {</span>
<a href="#l22.236"></a><span id="l22.236" class="difflineminus">-        PR_FREEIF(tmp-&gt;real_name);</span>
<a href="#l22.237"></a><span id="l22.237" class="difflineminus">-        tmp-&gt;real_name = fname;</span>
<a href="#l22.238"></a><span id="l22.238" class="difflineminus">-      }</span>
<a href="#l22.239"></a><span id="l22.239" class="difflineplus">+      if (fname)</span>
<a href="#l22.240"></a><span id="l22.240" class="difflineplus">+        tmp-&gt;m_realName.Adopt(fname);</span>
<a href="#l22.241"></a><span id="l22.241">     }</span>
<a href="#l22.242"></a><span id="l22.242"> </span>
<a href="#l22.243"></a><span id="l22.243">     PR_FREEIF(disp);</span>
<a href="#l22.244"></a><span id="l22.244">   }</span>
<a href="#l22.245"></a><span id="l22.245"> </span>
<a href="#l22.246"></a><span id="l22.246">   disp = MimeHeaders_get(object-&gt;headers, HEADER_CONTENT_TYPE, PR_FALSE, PR_FALSE);</span>
<a href="#l22.247"></a><span id="l22.247">   if (disp)</span>
<a href="#l22.248"></a><span id="l22.248">   {</span>
<a href="#l22.249"></a><span id="l22.249" class="difflineminus">-    tmp-&gt;x_mac_type   = MimeHeaders_get_parameter(disp, PARAM_X_MAC_TYPE, nsnull, nsnull);</span>
<a href="#l22.250"></a><span id="l22.250" class="difflineminus">-    tmp-&gt;x_mac_creator= MimeHeaders_get_parameter(disp, PARAM_X_MAC_CREATOR, nsnull, nsnull);</span>
<a href="#l22.251"></a><span id="l22.251" class="difflineplus">+    tmp-&gt;m_xMacType.Adopt(MimeHeaders_get_parameter(disp, PARAM_X_MAC_TYPE, nsnull, nsnull));</span>
<a href="#l22.252"></a><span id="l22.252" class="difflineplus">+    tmp-&gt;m_xMacCreator.Adopt(MimeHeaders_get_parameter(disp, PARAM_X_MAC_CREATOR, nsnull, nsnull));</span>
<a href="#l22.253"></a><span id="l22.253"> </span>
<a href="#l22.254"></a><span id="l22.254" class="difflineminus">-    if (!tmp-&gt;real_name || *tmp-&gt;real_name == 0)</span>
<a href="#l22.255"></a><span id="l22.255" class="difflineplus">+    if (tmp-&gt;m_realName.IsEmpty())</span>
<a href="#l22.256"></a><span id="l22.256">     {</span>
<a href="#l22.257"></a><span id="l22.257" class="difflineminus">-      PR_FREEIF(tmp-&gt;real_name);</span>
<a href="#l22.258"></a><span id="l22.258" class="difflineminus">-      tmp-&gt;real_name = MimeHeaders_get_parameter(disp, &quot;name&quot;, &amp;charset, nsnull);</span>
<a href="#l22.259"></a><span id="l22.259" class="difflineplus">+      tmp-&gt;m_realName.Adopt(MimeHeaders_get_parameter(disp, &quot;name&quot;, &amp;charset, nsnull));</span>
<a href="#l22.260"></a><span id="l22.260">       if (isAnAppleDoublePart)</span>
<a href="#l22.261"></a><span id="l22.261">         // the data fork is the 2nd part, and we should ALWAYS look there first for the file name</span>
<a href="#l22.262"></a><span id="l22.262" class="difflineminus">-        for (i = 1; i &gt;= 0 &amp;&amp; !tmp-&gt;real_name; i --)</span>
<a href="#l22.263"></a><span id="l22.263" class="difflineplus">+        for (i = 1; i &gt;= 0 &amp;&amp; tmp-&gt;m_realName.IsEmpty(); i --)</span>
<a href="#l22.264"></a><span id="l22.264">         {</span>
<a href="#l22.265"></a><span id="l22.265">           PR_FREEIF(disp);</span>
<a href="#l22.266"></a><span id="l22.266">           nsMemory::Free(charset);</span>
<a href="#l22.267"></a><span id="l22.267">           disp = MimeHeaders_get(((MimeContainer *)object)-&gt;children[i]-&gt;headers, HEADER_CONTENT_TYPE, PR_FALSE, PR_FALSE);</span>
<a href="#l22.268"></a><span id="l22.268" class="difflineminus">-          tmp-&gt;real_name = MimeHeaders_get_parameter(disp, &quot;name&quot;, &amp;charset, nsnull);</span>
<a href="#l22.269"></a><span id="l22.269" class="difflineminus">-          tmp-&gt;real_type =</span>
<a href="#l22.270"></a><span id="l22.270" class="difflineplus">+          tmp-&gt;m_realName.Adopt(MimeHeaders_get_parameter(disp, &quot;name&quot;, &amp;charset, nsnull));</span>
<a href="#l22.271"></a><span id="l22.271" class="difflineplus">+          tmp-&gt;m_realType.Adopt(</span>
<a href="#l22.272"></a><span id="l22.272">             MimeHeaders_get(((MimeContainer *)object)-&gt;children[i]-&gt;headers,</span>
<a href="#l22.273"></a><span id="l22.273" class="difflineminus">-                            HEADER_CONTENT_TYPE, PR_TRUE, PR_FALSE);</span>
<a href="#l22.274"></a><span id="l22.274" class="difflineplus">+                            HEADER_CONTENT_TYPE, PR_TRUE, PR_FALSE));</span>
<a href="#l22.275"></a><span id="l22.275">         }</span>
<a href="#l22.276"></a><span id="l22.276"> </span>
<a href="#l22.277"></a><span id="l22.277" class="difflineminus">-      if (tmp-&gt;real_name)</span>
<a href="#l22.278"></a><span id="l22.278" class="difflineplus">+      if (!tmp-&gt;m_realName.IsEmpty())</span>
<a href="#l22.279"></a><span id="l22.279">       {</span>
<a href="#l22.280"></a><span id="l22.280">         // check encoded type</span>
<a href="#l22.281"></a><span id="l22.281">         //</span>
<a href="#l22.282"></a><span id="l22.282">         // The parameter of Content-Disposition must use RFC 2231.</span>
<a href="#l22.283"></a><span id="l22.283">         // But old Netscape 4.x and Outlook Express etc. use RFC2047.</span>
<a href="#l22.284"></a><span id="l22.284">         // So we should parse both types.</span>
<a href="#l22.285"></a><span id="l22.285"> </span>
<a href="#l22.286"></a><span id="l22.286">         char *fname = nsnull;</span>
<a href="#l22.287"></a><span id="l22.287" class="difflineminus">-        fname = mime_decode_filename(tmp-&gt;real_name, charset, options);</span>
<a href="#l22.288"></a><span id="l22.288" class="difflineplus">+        fname = mime_decode_filename(tmp-&gt;m_realName.get(), charset, options);</span>
<a href="#l22.289"></a><span id="l22.289">         nsMemory::Free(charset);</span>
<a href="#l22.290"></a><span id="l22.290"> </span>
<a href="#l22.291"></a><span id="l22.291" class="difflineminus">-        if (fname &amp;&amp; fname != tmp-&gt;real_name)</span>
<a href="#l22.292"></a><span id="l22.292" class="difflineminus">-        {</span>
<a href="#l22.293"></a><span id="l22.293" class="difflineminus">-          PR_Free(tmp-&gt;real_name);</span>
<a href="#l22.294"></a><span id="l22.294" class="difflineminus">-          tmp-&gt;real_name = fname;</span>
<a href="#l22.295"></a><span id="l22.295" class="difflineminus">-        }</span>
<a href="#l22.296"></a><span id="l22.296" class="difflineplus">+        if (fname)</span>
<a href="#l22.297"></a><span id="l22.297" class="difflineplus">+          tmp-&gt;m_realName.Adopt(fname);</span>
<a href="#l22.298"></a><span id="l22.298">       }</span>
<a href="#l22.299"></a><span id="l22.299">     }</span>
<a href="#l22.300"></a><span id="l22.300">     PR_FREEIF(disp);</span>
<a href="#l22.301"></a><span id="l22.301">   }</span>
<a href="#l22.302"></a><span id="l22.302"> </span>
<a href="#l22.303"></a><span id="l22.303" class="difflineminus">-  tmp-&gt;description = MimeHeaders_get(object-&gt;headers, HEADER_CONTENT_DESCRIPTION,</span>
<a href="#l22.304"></a><span id="l22.304" class="difflineminus">-                                     PR_FALSE, PR_FALSE);</span>
<a href="#l22.305"></a><span id="l22.305" class="difflineplus">+  tmp-&gt;m_description.Adopt(MimeHeaders_get(object-&gt;headers, HEADER_CONTENT_DESCRIPTION,</span>
<a href="#l22.306"></a><span id="l22.306" class="difflineplus">+                                           PR_FALSE, PR_FALSE));</span>
<a href="#l22.307"></a><span id="l22.307"> </span>
<a href="#l22.308"></a><span id="l22.308">   // Now, do the right thing with the name!</span>
<a href="#l22.309"></a><span id="l22.309" class="difflineminus">-  if (!tmp-&gt;real_name &amp;&amp; PL_strcasecmp(tmp-&gt;real_type, MESSAGE_RFC822))</span>
<a href="#l22.310"></a><span id="l22.310" class="difflineplus">+  if (tmp-&gt;m_realName.IsEmpty() &amp;&amp; !(tmp-&gt;m_realType.LowerCaseEqualsLiteral(MESSAGE_RFC822)))</span>
<a href="#l22.311"></a><span id="l22.311">   {</span>
<a href="#l22.312"></a><span id="l22.312">     // Keep in mind that the name was provided by us and this is probably not a</span>
<a href="#l22.313"></a><span id="l22.313">     // real attachment.</span>
<a href="#l22.314"></a><span id="l22.314" class="difflineminus">-    tmp-&gt;hasFilename = PR_FALSE;</span>
<a href="#l22.315"></a><span id="l22.315" class="difflineplus">+    tmp-&gt;m_hasFilename = PR_FALSE;</span>
<a href="#l22.316"></a><span id="l22.316">     /* If this attachment doesn't have a name, just give it one... */</span>
<a href="#l22.317"></a><span id="l22.317" class="difflineminus">-    tmp-&gt;real_name = MimeGetStringByID(MIME_MSG_DEFAULT_ATTACHMENT_NAME);</span>
<a href="#l22.318"></a><span id="l22.318" class="difflineminus">-    if (tmp-&gt;real_name)</span>
<a href="#l22.319"></a><span id="l22.319" class="difflineplus">+    tmp-&gt;m_realName.Adopt(MimeGetStringByID(MIME_MSG_DEFAULT_ATTACHMENT_NAME));</span>
<a href="#l22.320"></a><span id="l22.320" class="difflineplus">+    if (!tmp-&gt;m_realName.IsEmpty())</span>
<a href="#l22.321"></a><span id="l22.321">     {</span>
<a href="#l22.322"></a><span id="l22.322" class="difflineminus">-      char *newName = PR_smprintf(tmp-&gt;real_name, part.get());</span>
<a href="#l22.323"></a><span id="l22.323" class="difflineplus">+      char *newName = PR_smprintf(tmp-&gt;m_realName.get(), part.get());</span>
<a href="#l22.324"></a><span id="l22.324">       if (newName)</span>
<a href="#l22.325"></a><span id="l22.325" class="difflineminus">-      {</span>
<a href="#l22.326"></a><span id="l22.326" class="difflineminus">-        PR_Free(tmp-&gt;real_name);</span>
<a href="#l22.327"></a><span id="l22.327" class="difflineminus">-        tmp-&gt;real_name = newName;</span>
<a href="#l22.328"></a><span id="l22.328" class="difflineminus">-      }</span>
<a href="#l22.329"></a><span id="l22.329" class="difflineplus">+        tmp-&gt;m_realName.Adopt(newName);</span>
<a href="#l22.330"></a><span id="l22.330">     }</span>
<a href="#l22.331"></a><span id="l22.331">     else</span>
<a href="#l22.332"></a><span id="l22.332" class="difflineminus">-      tmp-&gt;real_name = mime_part_address(object);</span>
<a href="#l22.333"></a><span id="l22.333" class="difflineplus">+      tmp-&gt;m_realName.Adopt(mime_part_address(object));</span>
<a href="#l22.334"></a><span id="l22.334">   } else {</span>
<a href="#l22.335"></a><span id="l22.335" class="difflineminus">-    tmp-&gt;hasFilename = PR_TRUE;</span>
<a href="#l22.336"></a><span id="l22.336" class="difflineplus">+    tmp-&gt;m_hasFilename = PR_TRUE;</span>
<a href="#l22.337"></a><span id="l22.337">   }</span>
<a href="#l22.338"></a><span id="l22.338">   nsCString urlString(urlSpec);</span>
<a href="#l22.339"></a><span id="l22.339"> </span>
<a href="#l22.340"></a><span id="l22.340" class="difflineminus">-  if (tmp-&gt;real_name &amp;&amp; !tmp-&gt;isExternalAttachment)</span>
<a href="#l22.341"></a><span id="l22.341" class="difflineplus">+  if (!tmp-&gt;m_realName.IsEmpty() &amp;&amp; !tmp-&gt;m_isExternalAttachment)</span>
<a href="#l22.342"></a><span id="l22.342">   {</span>
<a href="#l22.343"></a><span id="l22.343">     urlString.Append(&quot;&amp;filename=&quot;);</span>
<a href="#l22.344"></a><span id="l22.344">     nsCAutoString aResult;</span>
<a href="#l22.345"></a><span id="l22.345" class="difflineminus">-    if (NS_SUCCEEDED(MsgEscapeString(nsDependentCString(tmp-&gt;real_name),</span>
<a href="#l22.346"></a><span id="l22.346" class="difflineplus">+    if (NS_SUCCEEDED(MsgEscapeString(tmp-&gt;m_realName,</span>
<a href="#l22.347"></a><span id="l22.347">                                      nsINetUtil::ESCAPE_XALPHAS, aResult)))</span>
<a href="#l22.348"></a><span id="l22.348">       urlString.Append(aResult);</span>
<a href="#l22.349"></a><span id="l22.349">     else</span>
<a href="#l22.350"></a><span id="l22.350" class="difflineminus">-      urlString.Append(tmp-&gt;real_name);</span>
<a href="#l22.351"></a><span id="l22.351" class="difflineminus">-    if (tmp-&gt;real_type &amp;&amp; !strcmp(tmp-&gt;real_type, &quot;message/rfc822&quot;) &amp;&amp;</span>
<a href="#l22.352"></a><span id="l22.352" class="difflineplus">+      urlString.Append(tmp-&gt;m_realName);</span>
<a href="#l22.353"></a><span id="l22.353" class="difflineplus">+    if (tmp-&gt;m_realType.EqualsLiteral(&quot;message/rfc822&quot;) &amp;&amp;</span>
<a href="#l22.354"></a><span id="l22.354">            !StringEndsWith(urlString, NS_LITERAL_CSTRING(&quot;.eml&quot;), nsCaseInsensitiveCStringComparator()))</span>
<a href="#l22.355"></a><span id="l22.355">       urlString.Append(&quot;.eml&quot;);</span>
<a href="#l22.356"></a><span id="l22.356" class="difflineminus">-  } else if (tmp-&gt;isExternalAttachment) {</span>
<a href="#l22.357"></a><span id="l22.357" class="difflineplus">+  } else if (tmp-&gt;m_isExternalAttachment) {</span>
<a href="#l22.358"></a><span id="l22.358">     // Allows the JS mime emitter to figure out the part information.</span>
<a href="#l22.359"></a><span id="l22.359">     urlString.Append(&quot;?part=&quot;);</span>
<a href="#l22.360"></a><span id="l22.360">     urlString.Append(part);</span>
<a href="#l22.361"></a><span id="l22.361">   }</span>
<a href="#l22.362"></a><span id="l22.362" class="difflineminus">-  nsresult rv = nsMimeNewURI(&amp;(tmp-&gt;url), urlString.get(), nsnull);</span>
<a href="#l22.363"></a><span id="l22.363" class="difflineplus">+  nsresult rv = nsMimeNewURI(getter_AddRefs(tmp-&gt;m_url), urlString.get(), nsnull);</span>
<a href="#l22.364"></a><span id="l22.364"> </span>
<a href="#l22.365"></a><span id="l22.365">   PR_FREEIF(urlSpec);</span>
<a href="#l22.366"></a><span id="l22.366"> </span>
<a href="#l22.367"></a><span id="l22.367" class="difflineminus">-  if ( (NS_FAILED(rv)) || (!tmp-&gt;url) )</span>
<a href="#l22.368"></a><span id="l22.368" class="difflineplus">+  if (NS_FAILED(rv) || !tmp-&gt;m_url)</span>
<a href="#l22.369"></a><span id="l22.369">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l22.370"></a><span id="l22.370"> </span>
<a href="#l22.371"></a><span id="l22.371">   ValidateRealName(tmp, object-&gt;headers);</span>
<a href="#l22.372"></a><span id="l22.372"> </span>
<a href="#l22.373"></a><span id="l22.373">   return NS_OK;</span>
<a href="#l22.374"></a><span id="l22.374"> }</span>
<a href="#l22.375"></a><span id="l22.375"> </span>
<a href="#l22.376"></a><span id="l22.376"> nsresult MimeGetSize(MimeObject *child, PRInt32 *size) {</span>
<a href="#l22.377"></a><span id="l22.377" class="difflineat">@@ -624,114 +614,83 @@ MimeGetAttachmentList(MimeObject *tobj, </span>
<a href="#l22.378"></a><span id="l22.378">   if (n &lt;= 0)</span>
<a href="#l22.379"></a><span id="l22.379">     return n;</span>
<a href="#l22.380"></a><span id="l22.380"> </span>
<a href="#l22.381"></a><span id="l22.381">   // in case of an inline message (as body), we need an extra slot for the</span>
<a href="#l22.382"></a><span id="l22.382">   // message itself that we will fill later...</span>
<a href="#l22.383"></a><span id="l22.383">   if (isAnInlineMessage)</span>
<a href="#l22.384"></a><span id="l22.384">     n ++;</span>
<a href="#l22.385"></a><span id="l22.385"> </span>
<a href="#l22.386"></a><span id="l22.386" class="difflineminus">-  *data = (nsMsgAttachmentData *)PR_Malloc( (n + 1) * sizeof(nsMsgAttachmentData));</span>
<a href="#l22.387"></a><span id="l22.387" class="difflineplus">+  *data = new nsMsgAttachmentData[n + 1];</span>
<a href="#l22.388"></a><span id="l22.388">   if (!*data)</span>
<a href="#l22.389"></a><span id="l22.389">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l22.390"></a><span id="l22.390"> </span>
<a href="#l22.391"></a><span id="l22.391">   attIndex = 0;</span>
<a href="#l22.392"></a><span id="l22.392" class="difflineminus">-  memset(*data, 0, (n + 1) * sizeof(nsMsgAttachmentData));</span>
<a href="#l22.393"></a><span id="l22.393"> </span>
<a href="#l22.394"></a><span id="l22.394">   // Now, build the list!</span>
<a href="#l22.395"></a><span id="l22.395"> </span>
<a href="#l22.396"></a><span id="l22.396">   nsresult rv;</span>
<a href="#l22.397"></a><span id="l22.397"> </span>
<a href="#l22.398"></a><span id="l22.398">   if (isAnInlineMessage)</span>
<a href="#l22.399"></a><span id="l22.399">   {</span>
<a href="#l22.400"></a><span id="l22.400">     rv = GenerateAttachmentData(obj, aMessageURL, obj-&gt;options, PR_FALSE, -1, *data);</span>
<a href="#l22.401"></a><span id="l22.401">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.402"></a><span id="l22.402">   }</span>
<a href="#l22.403"></a><span id="l22.403">   return BuildAttachmentList((MimeObject *) cobj, *data, aMessageURL);</span>
<a href="#l22.404"></a><span id="l22.404"> }</span>
<a href="#l22.405"></a><span id="l22.405"> </span>
<a href="#l22.406"></a><span id="l22.406"> extern &quot;C&quot; void</span>
<a href="#l22.407"></a><span id="l22.407"> MimeFreeAttachmentList(nsMsgAttachmentData *data)</span>
<a href="#l22.408"></a><span id="l22.408"> {</span>
<a href="#l22.409"></a><span id="l22.409" class="difflineminus">-  if (data)</span>
<a href="#l22.410"></a><span id="l22.410" class="difflineminus">-  {</span>
<a href="#l22.411"></a><span id="l22.411" class="difflineminus">-    nsMsgAttachmentData   *tmp;</span>
<a href="#l22.412"></a><span id="l22.412" class="difflineminus">-    for (tmp = data ; tmp-&gt;url ; tmp++)</span>
<a href="#l22.413"></a><span id="l22.413" class="difflineminus">-    {</span>
<a href="#l22.414"></a><span id="l22.414" class="difflineminus">-      /* Can't do PR_FREEIF on `const' values... */</span>
<a href="#l22.415"></a><span id="l22.415" class="difflineminus">-      NS_IF_RELEASE(tmp-&gt;url);</span>
<a href="#l22.416"></a><span id="l22.416" class="difflineminus">-      if (tmp-&gt;real_type) PR_Free((char *) tmp-&gt;real_type);</span>
<a href="#l22.417"></a><span id="l22.417" class="difflineminus">-      if (tmp-&gt;real_encoding) PR_Free((char *) tmp-&gt;real_encoding);</span>
<a href="#l22.418"></a><span id="l22.418" class="difflineminus">-      if (tmp-&gt;real_name) PR_Free((char *) tmp-&gt;real_name);</span>
<a href="#l22.419"></a><span id="l22.419" class="difflineminus">-      if (tmp-&gt;x_mac_type) PR_Free((char *) tmp-&gt;x_mac_type);</span>
<a href="#l22.420"></a><span id="l22.420" class="difflineminus">-      if (tmp-&gt;x_mac_creator) PR_Free((char *) tmp-&gt;x_mac_creator);</span>
<a href="#l22.421"></a><span id="l22.421" class="difflineminus">-      if (tmp-&gt;description) PR_Free((char *) tmp-&gt;description);</span>
<a href="#l22.422"></a><span id="l22.422" class="difflineminus">-      tmp-&gt;url = 0;</span>
<a href="#l22.423"></a><span id="l22.423" class="difflineminus">-      tmp-&gt;real_type = 0;</span>
<a href="#l22.424"></a><span id="l22.424" class="difflineminus">-      tmp-&gt;real_name = 0;</span>
<a href="#l22.425"></a><span id="l22.425" class="difflineminus">-      tmp-&gt;description = 0;</span>
<a href="#l22.426"></a><span id="l22.426" class="difflineminus">-    }</span>
<a href="#l22.427"></a><span id="l22.427" class="difflineminus">-    PR_Free(data);</span>
<a href="#l22.428"></a><span id="l22.428" class="difflineminus">-  }</span>
<a href="#l22.429"></a><span id="l22.429" class="difflineplus">+  delete [] data;</span>
<a href="#l22.430"></a><span id="l22.430"> }</span>
<a href="#l22.431"></a><span id="l22.431"> </span>
<a href="#l22.432"></a><span id="l22.432"> extern &quot;C&quot; void</span>
<a href="#l22.433"></a><span id="l22.433"> NotifyEmittersOfAttachmentList(MimeDisplayOptions     *opt,</span>
<a href="#l22.434"></a><span id="l22.434">                                nsMsgAttachmentData    *data)</span>
<a href="#l22.435"></a><span id="l22.435"> {</span>
<a href="#l22.436"></a><span id="l22.436">   PRInt32     i = 0;</span>
<a href="#l22.437"></a><span id="l22.437" class="difflineminus">-  struct      nsMsgAttachmentData  *tmp = data;</span>
<a href="#l22.438"></a><span id="l22.438" class="difflineplus">+  nsMsgAttachmentData  *tmp = data;</span>
<a href="#l22.439"></a><span id="l22.439"> </span>
<a href="#l22.440"></a><span id="l22.440">   if (!tmp)</span>
<a href="#l22.441"></a><span id="l22.441">     return;</span>
<a href="#l22.442"></a><span id="l22.442"> </span>
<a href="#l22.443"></a><span id="l22.443" class="difflineminus">-  while (tmp-&gt;url)</span>
<a href="#l22.444"></a><span id="l22.444" class="difflineplus">+  while (tmp-&gt;m_url)</span>
<a href="#l22.445"></a><span id="l22.445">   {</span>
<a href="#l22.446"></a><span id="l22.446" class="difflineminus">-    if (!tmp-&gt;real_name || (!tmp-&gt;hasFilename &amp;&amp; (opt-&gt;html_as_p != 4 || opt-&gt;metadata_only)))</span>
<a href="#l22.447"></a><span id="l22.447" class="difflineplus">+    if (tmp-&gt;m_realName.IsEmpty() || (!tmp-&gt;m_hasFilename &amp;&amp;</span>
<a href="#l22.448"></a><span id="l22.448" class="difflineplus">+        (opt-&gt;html_as_p != 4 || opt-&gt;metadata_only)))</span>
<a href="#l22.449"></a><span id="l22.449">     {</span>
<a href="#l22.450"></a><span id="l22.450">       ++i;</span>
<a href="#l22.451"></a><span id="l22.451">       ++tmp;</span>
<a href="#l22.452"></a><span id="l22.452">       continue;</span>
<a href="#l22.453"></a><span id="l22.453">     }</span>
<a href="#l22.454"></a><span id="l22.454"> </span>
<a href="#l22.455"></a><span id="l22.455">     nsCAutoString spec;</span>
<a href="#l22.456"></a><span id="l22.456" class="difflineminus">-    if ( tmp-&gt;url )</span>
<a href="#l22.457"></a><span id="l22.457" class="difflineminus">-      tmp-&gt;url-&gt;GetSpec(spec);</span>
<a href="#l22.458"></a><span id="l22.458" class="difflineplus">+    if (tmp-&gt;m_url)</span>
<a href="#l22.459"></a><span id="l22.459" class="difflineplus">+      tmp-&gt;m_url-&gt;GetSpec(spec);</span>
<a href="#l22.460"></a><span id="l22.460"> </span>
<a href="#l22.461"></a><span id="l22.461">     nsCAutoString sizeStr;</span>
<a href="#l22.462"></a><span id="l22.462" class="difflineminus">-    sizeStr.AppendInt(tmp-&gt;size);</span>
<a href="#l22.463"></a><span id="l22.463" class="difflineplus">+    sizeStr.AppendInt(tmp-&gt;m_size);</span>
<a href="#l22.464"></a><span id="l22.464">     nsCAutoString downloadedStr;</span>
<a href="#l22.465"></a><span id="l22.465" class="difflineminus">-    downloadedStr.AppendInt(tmp-&gt;isDownloaded);</span>
<a href="#l22.466"></a><span id="l22.466" class="difflineplus">+    downloadedStr.AppendInt(tmp-&gt;m_isDownloaded);</span>
<a href="#l22.467"></a><span id="l22.467"> </span>
<a href="#l22.468"></a><span id="l22.468" class="difflineminus">-    mimeEmitterStartAttachment(opt, tmp-&gt;real_name, tmp-&gt;real_type, spec.get(), tmp-&gt;isExternalAttachment);</span>
<a href="#l22.469"></a><span id="l22.469" class="difflineplus">+    mimeEmitterStartAttachment(opt, tmp-&gt;m_realName.get(), tmp-&gt;m_realType.get(),</span>
<a href="#l22.470"></a><span id="l22.470" class="difflineplus">+                               spec.get(), tmp-&gt;m_isExternalAttachment);</span>
<a href="#l22.471"></a><span id="l22.471">     mimeEmitterAddAttachmentField(opt, HEADER_X_MOZILLA_PART_URL, spec.get());</span>
<a href="#l22.472"></a><span id="l22.472">     mimeEmitterAddAttachmentField(opt, HEADER_X_MOZILLA_PART_SIZE, sizeStr.get());</span>
<a href="#l22.473"></a><span id="l22.473">     mimeEmitterAddAttachmentField(opt, HEADER_X_MOZILLA_PART_DOWNLOADED, downloadedStr.get());</span>
<a href="#l22.474"></a><span id="l22.474"> </span>
<a href="#l22.475"></a><span id="l22.475">     if ( (opt-&gt;format_out == nsMimeOutput::nsMimeMessageQuoting) ||</span>
<a href="#l22.476"></a><span id="l22.476">          (opt-&gt;format_out == nsMimeOutput::nsMimeMessageBodyQuoting) ||</span>
<a href="#l22.477"></a><span id="l22.477">          (opt-&gt;format_out == nsMimeOutput::nsMimeMessageSaveAs) ||</span>
<a href="#l22.478"></a><span id="l22.478">          (opt-&gt;format_out == nsMimeOutput::nsMimeMessagePrintOutput))</span>
<a href="#l22.479"></a><span id="l22.479">     {</span>
<a href="#l22.480"></a><span id="l22.480" class="difflineminus">-      mimeEmitterAddAttachmentField(opt, HEADER_CONTENT_DESCRIPTION, tmp-&gt;description);</span>
<a href="#l22.481"></a><span id="l22.481" class="difflineminus">-      mimeEmitterAddAttachmentField(opt, HEADER_CONTENT_TYPE, tmp-&gt;real_type);</span>
<a href="#l22.482"></a><span id="l22.482" class="difflineminus">-      mimeEmitterAddAttachmentField(opt, HEADER_CONTENT_ENCODING,    tmp-&gt;real_encoding);</span>
<a href="#l22.483"></a><span id="l22.483" class="difflineminus">-</span>
<a href="#l22.484"></a><span id="l22.484" class="difflineminus">-      /* rhp - for now, just leave these here, but they are really</span>
<a href="#l22.485"></a><span id="l22.485" class="difflineminus">-               not necessary</span>
<a href="#l22.486"></a><span id="l22.486" class="difflineminus">-      printf(&quot;URL for Part      : %s\n&quot;, spec.get());</span>
<a href="#l22.487"></a><span id="l22.487" class="difflineminus">-      printf(&quot;Real Name         : %s\n&quot;, tmp-&gt;real_name);</span>
<a href="#l22.488"></a><span id="l22.488" class="difflineminus">-      printf(&quot;Desired Type      : %s\n&quot;, tmp-&gt;desired_type);</span>
<a href="#l22.489"></a><span id="l22.489" class="difflineminus">-      printf(&quot;Real Type         : %s\n&quot;, tmp-&gt;real_type);</span>
<a href="#l22.490"></a><span id="l22.490" class="difflineminus">-      printf(&quot;Real Encoding     : %s\n&quot;, tmp-&gt;real_encoding);</span>
<a href="#l22.491"></a><span id="l22.491" class="difflineminus">-      printf(&quot;Description       : %s\n&quot;, tmp-&gt;description);</span>
<a href="#l22.492"></a><span id="l22.492" class="difflineminus">-      printf(&quot;Mac Type          : %s\n&quot;, tmp-&gt;x_mac_type);</span>
<a href="#l22.493"></a><span id="l22.493" class="difflineminus">-      printf(&quot;Mac Creator       : %s\n&quot;, tmp-&gt;x_mac_creator);</span>
<a href="#l22.494"></a><span id="l22.494" class="difflineminus">-      printf(&quot;Size              : %d\n&quot;, tmp-&gt;size);</span>
<a href="#l22.495"></a><span id="l22.495" class="difflineminus">-      */</span>
<a href="#l22.496"></a><span id="l22.496" class="difflineplus">+      mimeEmitterAddAttachmentField(opt, HEADER_CONTENT_DESCRIPTION, tmp-&gt;m_description.get());</span>
<a href="#l22.497"></a><span id="l22.497" class="difflineplus">+      mimeEmitterAddAttachmentField(opt, HEADER_CONTENT_TYPE, tmp-&gt;m_realType.get());</span>
<a href="#l22.498"></a><span id="l22.498" class="difflineplus">+      mimeEmitterAddAttachmentField(opt, HEADER_CONTENT_ENCODING, tmp-&gt;m_realEncoding.get());</span>
<a href="#l22.499"></a><span id="l22.499">     }</span>
<a href="#l22.500"></a><span id="l22.500"> </span>
<a href="#l22.501"></a><span id="l22.501">     mimeEmitterEndAttachment(opt);</span>
<a href="#l22.502"></a><span id="l22.502">     ++i;</span>
<a href="#l22.503"></a><span id="l22.503">     ++tmp;</span>
<a href="#l22.504"></a><span id="l22.504">   }</span>
<a href="#l22.505"></a><span id="l22.505">   mimeEmitterEndAllAttachments(opt);</span>
<a href="#l22.506"></a><span id="l22.506"> }</span>
<a href="#l22.507"></a><span id="l22.507" class="difflineat">@@ -1993,18 +1952,18 @@ mimeEmitterEndHeader(MimeDisplayOptions </span>
<a href="#l22.508"></a><span id="l22.508">     nsIMimeEmitter *emitter = (nsIMimeEmitter *)msd-&gt;output_emitter;</span>
<a href="#l22.509"></a><span id="l22.509"> </span>
<a href="#l22.510"></a><span id="l22.510">     nsCString name;</span>
<a href="#l22.511"></a><span id="l22.511">     nsMsgAttachmentData *attachments = nsnull;</span>
<a href="#l22.512"></a><span id="l22.512">     if (msd-&gt;format_out == nsMimeOutput::nsMimeMessageSplitDisplay ||</span>
<a href="#l22.513"></a><span id="l22.513">         msd-&gt;format_out == nsMimeOutput::nsMimeMessageHeaderDisplay ||</span>
<a href="#l22.514"></a><span id="l22.514">         msd-&gt;format_out == nsMimeOutput::nsMimeMessageBodyDisplay) {</span>
<a href="#l22.515"></a><span id="l22.515">       nsresult rv = MimeGetAttachmentList(msd-&gt;obj, msd-&gt;url_name, &amp;attachments);</span>
<a href="#l22.516"></a><span id="l22.516" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; attachments &amp;&amp; attachments-&gt;real_name)</span>
<a href="#l22.517"></a><span id="l22.517" class="difflineminus">-        name.Assign(attachments-&gt;real_name);</span>
<a href="#l22.518"></a><span id="l22.518" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; attachments)</span>
<a href="#l22.519"></a><span id="l22.519" class="difflineplus">+        name.Assign(attachments-&gt;m_realName);</span>
<a href="#l22.520"></a><span id="l22.520">     }</span>
<a href="#l22.521"></a><span id="l22.521"> </span>
<a href="#l22.522"></a><span id="l22.522">     MimeHeaders_convert_header_value(opt, name, false);</span>
<a href="#l22.523"></a><span id="l22.523">     MimeFreeAttachmentList(attachments);</span>
<a href="#l22.524"></a><span id="l22.524">     return emitter-&gt;EndHeader(name);</span>
<a href="#l22.525"></a><span id="l22.525">   }</span>
<a href="#l22.526"></a><span id="l22.526"> </span>
<a href="#l22.527"></a><span id="l22.527">   return NS_ERROR_FAILURE;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/mime/src/mimemoz2.h</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/mime/src/mimemoz2.h</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -125,33 +125,29 @@ struct mime_stream_data {           /* T</span>
<a href="#l23.4"></a><span id="l23.4">   MimeDisplayOptions  *options;     /* Data for communicating with libmime.a */</span>
<a href="#l23.5"></a><span id="l23.5">   MimeHeaders         *headers;     /* Copy of outer most mime header */</span>
<a href="#l23.6"></a><span id="l23.6"> </span>
<a href="#l23.7"></a><span id="l23.7">   nsIMimeEmitter      *output_emitter;  /* Output emitter engine for libmime */</span>
<a href="#l23.8"></a><span id="l23.8">   PRBool              firstCheck;   /* Is this the first look at the stream data */</span>
<a href="#l23.9"></a><span id="l23.9"> };</span>
<a href="#l23.10"></a><span id="l23.10"> </span>
<a href="#l23.11"></a><span id="l23.11"> //</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-// This struct is the state we use for loading drafts and templates...</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+// This object is the state we use for loading drafts and templates...</span>
<a href="#l23.14"></a><span id="l23.14"> //</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineminus">-struct mime_draft_data</span>
<a href="#l23.16"></a><span id="l23.16" class="difflineplus">+class mime_draft_data</span>
<a href="#l23.17"></a><span id="l23.17"> {</span>
<a href="#l23.18"></a><span id="l23.18" class="difflineminus">-  /* WARNING: You cannot use a c++ object, in that structure, which is dependent on its constructor or</span>
<a href="#l23.19"></a><span id="l23.19" class="difflineminus">-           destructor as mime_draft_data is not created using the new operator. nsCOMPtr however are ok</span>
<a href="#l23.20"></a><span id="l23.20" class="difflineminus">-           to use as long you set it to null before the structure get freed.</span>
<a href="#l23.21"></a><span id="l23.21" class="difflineminus">-  */</span>
<a href="#l23.22"></a><span id="l23.22" class="difflineminus">-</span>
<a href="#l23.23"></a><span id="l23.23" class="difflineplus">+public:</span>
<a href="#l23.24"></a><span id="l23.24" class="difflineplus">+  mime_draft_data();</span>
<a href="#l23.25"></a><span id="l23.25">   char                *url_name;           // original url name */</span>
<a href="#l23.26"></a><span id="l23.26">   nsMimeOutputType    format_out;          // intended output format; should be FO_OPEN_DRAFT */</span>
<a href="#l23.27"></a><span id="l23.27">   nsMIMESession       *stream;             // not used for now</span>
<a href="#l23.28"></a><span id="l23.28">   MimeObject          *obj;                // The root</span>
<a href="#l23.29"></a><span id="l23.29">   MimeDisplayOptions  *options;            // data for communicating with libmime</span>
<a href="#l23.30"></a><span id="l23.30">   MimeHeaders         *headers;            // Copy of outer most mime header</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineminus">-  PRInt32             attachments_count;   // how many attachments we have</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineminus">-  nsMsgAttachedFile   *attachments;        // attachments</span>
<a href="#l23.33"></a><span id="l23.33" class="difflineplus">+  nsTArray&lt;nsMsgAttachedFile*&gt; attachments;// attachments</span>
<a href="#l23.34"></a><span id="l23.34">   nsMsgAttachedFile   *messageBody;        // message body</span>
<a href="#l23.35"></a><span id="l23.35">   nsMsgAttachedFile   *curAttachment;       // temp</span>
<a href="#l23.36"></a><span id="l23.36"> </span>
<a href="#l23.37"></a><span id="l23.37">   nsCOMPtr &lt;nsILocalFile&gt; tmpFile;</span>
<a href="#l23.38"></a><span id="l23.38">   nsCOMPtr &lt;nsIOutputStream&gt; tmpFileStream;      // output file handle</span>
<a href="#l23.39"></a><span id="l23.39"> </span>
<a href="#l23.40"></a><span id="l23.40">   MimeDecoderData     *decoder_data;</span>
<a href="#l23.41"></a><span id="l23.41">   char                *mailcharset;        // get it from CHARSET of Content-Type</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/mime/src/mimemrel.cpp</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/mime/src/mimemrel.cpp</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -764,17 +764,17 @@ real_write(MimeMultipartRelated* relobj,</span>
<a href="#l24.4"></a><span id="l24.4">   {</span>
<a href="#l24.5"></a><span id="l24.5"> </span>
<a href="#l24.6"></a><span id="l24.6">     // the buf here has already been decoded, but we want to use general output</span>
<a href="#l24.7"></a><span id="l24.7">     // functions here that permit decoded or encoded input, using the closure</span>
<a href="#l24.8"></a><span id="l24.8">     // to tell the difference. We'll temporarily disable the closure's decoder, </span>
<a href="#l24.9"></a><span id="l24.9">     // then restore it when we are done. Not sure if we shouldn't just turn it off</span>
<a href="#l24.10"></a><span id="l24.10">     // permanently though.</span>
<a href="#l24.11"></a><span id="l24.11"> </span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-    struct mime_draft_data *mdd = (struct mime_draft_data *) obj-&gt;options-&gt;stream_closure;</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+    mime_draft_data *mdd = (mime_draft_data *) obj-&gt;options-&gt;stream_closure;</span>
<a href="#l24.14"></a><span id="l24.14">     MimeDecoderData* old_decoder_data = mdd-&gt;decoder_data;</span>
<a href="#l24.15"></a><span id="l24.15">     mdd-&gt;decoder_data = nsnull;</span>
<a href="#l24.16"></a><span id="l24.16">     int status = obj-&gt;options-&gt;decompose_file_output_fn</span>
<a href="#l24.17"></a><span id="l24.17">                  (buf, size, (void *)mdd);</span>
<a href="#l24.18"></a><span id="l24.18">     mdd-&gt;decoder_data = old_decoder_data;</span>
<a href="#l24.19"></a><span id="l24.19">     return status;</span>
<a href="#l24.20"></a><span id="l24.20">   }</span>
<a href="#l24.21"></a><span id="l24.21">   else</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/mime/src/nsStreamConverter.cpp</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/mime/src/nsStreamConverter.cpp</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -138,17 +138,17 @@ bridge_new_new_uri(void *bridgeStream, n</span>
<a href="#l25.4"></a><span id="l25.4">     {</span>
<a href="#l25.5"></a><span id="l25.5">       PRBool   *override_charset = nsnull;</span>
<a href="#l25.6"></a><span id="l25.6">       char    **default_charset = nsnull;</span>
<a href="#l25.7"></a><span id="l25.7">       char    **url_name = nsnull;</span>
<a href="#l25.8"></a><span id="l25.8"> </span>
<a href="#l25.9"></a><span id="l25.9">       if  ( (aOutputType == nsMimeOutput::nsMimeMessageDraftOrTemplate) ||</span>
<a href="#l25.10"></a><span id="l25.10">             (aOutputType == nsMimeOutput::nsMimeMessageEditorTemplate) )</span>
<a href="#l25.11"></a><span id="l25.11">       {</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-        struct mime_draft_data *mdd = (struct mime_draft_data *)session-&gt;data_object;</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+        mime_draft_data *mdd = (mime_draft_data *)session-&gt;data_object;</span>
<a href="#l25.14"></a><span id="l25.14">         if (mdd-&gt;options)</span>
<a href="#l25.15"></a><span id="l25.15">         {</span>
<a href="#l25.16"></a><span id="l25.16">           default_charset = &amp;(mdd-&gt;options-&gt;default_charset);</span>
<a href="#l25.17"></a><span id="l25.17">           override_charset = &amp;(mdd-&gt;options-&gt;override_charset);</span>
<a href="#l25.18"></a><span id="l25.18">           url_name = &amp;(mdd-&gt;url_name);</span>
<a href="#l25.19"></a><span id="l25.19">         }</span>
<a href="#l25.20"></a><span id="l25.20">       }</span>
<a href="#l25.21"></a><span id="l25.21">       else</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineat">@@ -275,17 +275,17 @@ bridge_set_mime_stream_converter_listene</span>
<a href="#l25.23"></a><span id="l25.23"> {</span>
<a href="#l25.24"></a><span id="l25.24">   nsMIMESession *session = (nsMIMESession *)bridgeStream;</span>
<a href="#l25.25"></a><span id="l25.25"> </span>
<a href="#l25.26"></a><span id="l25.26">   if ( (session) &amp;&amp; (session-&gt;data_object) )</span>
<a href="#l25.27"></a><span id="l25.27">   {</span>
<a href="#l25.28"></a><span id="l25.28">     if  ( (aOutputType == nsMimeOutput::nsMimeMessageDraftOrTemplate) ||</span>
<a href="#l25.29"></a><span id="l25.29">           (aOutputType == nsMimeOutput::nsMimeMessageEditorTemplate) )</span>
<a href="#l25.30"></a><span id="l25.30">     {</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineminus">-      struct mime_draft_data *mdd = (struct mime_draft_data *)session-&gt;data_object;</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineplus">+      mime_draft_data *mdd = (mime_draft_data *)session-&gt;data_object;</span>
<a href="#l25.33"></a><span id="l25.33">       if (mdd-&gt;options)</span>
<a href="#l25.34"></a><span id="l25.34">       {</span>
<a href="#l25.35"></a><span id="l25.35">         if (listener)</span>
<a href="#l25.36"></a><span id="l25.36">         {</span>
<a href="#l25.37"></a><span id="l25.37">           mdd-&gt;options-&gt;caller_need_root_headers = PR_TRUE;</span>
<a href="#l25.38"></a><span id="l25.38">           mdd-&gt;options-&gt;decompose_headers_info_fn = mime_headers_callback;</span>
<a href="#l25.39"></a><span id="l25.39">         }</span>
<a href="#l25.40"></a><span id="l25.40">         else</span>
<a href="#l25.41"></a><span id="l25.41" class="difflineat">@@ -1053,17 +1053,17 @@ nsStreamConverter::OnStopRequest(nsIRequ</span>
<a href="#l25.42"></a><span id="l25.42">     if (mMimeStreamConverterListener)</span>
<a href="#l25.43"></a><span id="l25.43">     {</span>
<a href="#l25.44"></a><span id="l25.44"> </span>
<a href="#l25.45"></a><span id="l25.45">       MimeHeaders    **workHeaders = nsnull;</span>
<a href="#l25.46"></a><span id="l25.46"> </span>
<a href="#l25.47"></a><span id="l25.47">       if  ( (mOutputType == nsMimeOutput::nsMimeMessageDraftOrTemplate) ||</span>
<a href="#l25.48"></a><span id="l25.48">             (mOutputType == nsMimeOutput::nsMimeMessageEditorTemplate) )</span>
<a href="#l25.49"></a><span id="l25.49">       {</span>
<a href="#l25.50"></a><span id="l25.50" class="difflineminus">-        struct mime_draft_data *mdd = (struct mime_draft_data *)tSession-&gt;data_object;</span>
<a href="#l25.51"></a><span id="l25.51" class="difflineplus">+        mime_draft_data *mdd = (mime_draft_data *)tSession-&gt;data_object;</span>
<a href="#l25.52"></a><span id="l25.52">         if (mdd)</span>
<a href="#l25.53"></a><span id="l25.53">           workHeaders = &amp;(mdd-&gt;headers);</span>
<a href="#l25.54"></a><span id="l25.54">       }</span>
<a href="#l25.55"></a><span id="l25.55">       else</span>
<a href="#l25.56"></a><span id="l25.56">       {</span>
<a href="#l25.57"></a><span id="l25.57">         struct mime_stream_data *msd = (struct mime_stream_data *)tSession-&gt;data_object;</span>
<a href="#l25.58"></a><span id="l25.58">         if (msd)</span>
<a href="#l25.59"></a><span id="l25.59">           workHeaders = &amp;(msd-&gt;headers);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

