<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 23495:cb57855b5455242cd123fe4c625d4bd118208a33</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ cb57855b5455242cd123fe4c625d4bd118208a33" />
<meta property="og:url" content="/comm-central/rev/cb57855b5455242cd123fe4c625d4bd118208a33" />
<meta property="og:description" content="Bug 856087 - Implement a pluggable store converter (mbox &lt;-&gt; maildir). r=mkmelin,aceman" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / cb57855b5455242cd123fe4c625d4bd118208a33 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/cb57855b5455242cd123fe4c625d4bd118208a33">shortlog</a> |
<a href="/comm-central/log/cb57855b5455242cd123fe4c625d4bd118208a33">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/cb57855b5455242cd123fe4c625d4bd118208a33">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/cb57855b5455242cd123fe4c625d4bd118208a33">files</a> |
changeset |
<a href="/comm-central/raw-rev/cb57855b5455242cd123fe4c625d4bd118208a33">raw</a>  | <a href="/comm-central/archive/cb57855b5455242cd123fe4c625d4bd118208a33.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=856087">Bug 856087</a> - Implement a pluggable store converter (mbox &lt;-&gt; maildir). r=mkmelin,aceman
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#110;&#105;&#110;&#100;&#121;&#97;&#45;&#80;&#97;&#110;&#100;&#101;&#121;&#32;&#60;&#97;&#110;&#105;&#110;&#100;&#121;&#97;&#112;&#97;&#110;&#100;&#101;&#121;&#62;</td></tr>
<tr><td></td><td class="date age">Sat, 07 Jan 2017 23:52:00 +0200</td></tr>

<tr>
 <td>changeset 23495</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/cb57855b5455242cd123fe4c625d4bd118208a33">cb57855b5455242cd123fe4c625d4bd118208a33</a></td>
</tr>



<tr>
<td>parent 23494</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/50cd20fcaba79db7c682dfb05ad092686098bd4b">50cd20fcaba79db7c682dfb05ad092686098bd4b</a>
</td>
</tr>

<tr>
<td>child 23496</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/be57cca86031e6b25598cdc7d05dc50d3f54c319">be57cca86031e6b25598cdc7d05dc50d3f54c319</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=cb57855b5455242cd123fe4c625d4bd118208a33">14183</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Sun, 11 Mar 2018 23:09:08 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@59c0f6e4825c [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=59c0f6e4825c4db83eb64c4dbd6ed11aee7be98e">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=59c0f6e4825c4db83eb64c4dbd6ed11aee7be98e&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=59c0f6e4825c4db83eb64c4dbd6ed11aee7be98e&newProject=comm-central&newRevision=50cd20fcaba79db7c682dfb05ad092686098bd4b&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=59c0f6e4825c4db83eb64c4dbd6ed11aee7be98e&newProject=comm-central&newRevision=50cd20fcaba79db7c682dfb05ad092686098bd4b&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=59c0f6e4825c4db83eb64c4dbd6ed11aee7be98e&newProject=comm-central&newRevision=50cd20fcaba79db7c682dfb05ad092686098bd4b&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a>, <a href="/comm-central/log?rev=reviewer%28aceman%29&revcount=50">aceman</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=856087">856087</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=856087">Bug 856087</a> - Implement a pluggable store converter (mbox &lt;-&gt; maildir). r=mkmelin,aceman</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cb57855b5455242cd123fe4c625d4bd118208a33/mail/locales/en-US/chrome/messenger/converterDialog.dtd">mail/locales/en-US/chrome/messenger/converterDialog.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cb57855b5455242cd123fe4c625d4bd118208a33/mail/locales/en-US/chrome/messenger/converterDialog.dtd">file</a> |
<a href="/comm-central/annotate/cb57855b5455242cd123fe4c625d4bd118208a33/mail/locales/en-US/chrome/messenger/converterDialog.dtd">annotate</a> |
<a href="/comm-central/diff/cb57855b5455242cd123fe4c625d4bd118208a33/mail/locales/en-US/chrome/messenger/converterDialog.dtd">diff</a> |
<a href="/comm-central/comparison/cb57855b5455242cd123fe4c625d4bd118208a33/mail/locales/en-US/chrome/messenger/converterDialog.dtd">comparison</a> |
<a href="/comm-central/log/cb57855b5455242cd123fe4c625d4bd118208a33/mail/locales/en-US/chrome/messenger/converterDialog.dtd">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cb57855b5455242cd123fe4c625d4bd118208a33/mail/locales/en-US/chrome/messenger/converterDialog.properties">mail/locales/en-US/chrome/messenger/converterDialog.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cb57855b5455242cd123fe4c625d4bd118208a33/mail/locales/en-US/chrome/messenger/converterDialog.properties">file</a> |
<a href="/comm-central/annotate/cb57855b5455242cd123fe4c625d4bd118208a33/mail/locales/en-US/chrome/messenger/converterDialog.properties">annotate</a> |
<a href="/comm-central/diff/cb57855b5455242cd123fe4c625d4bd118208a33/mail/locales/en-US/chrome/messenger/converterDialog.properties">diff</a> |
<a href="/comm-central/comparison/cb57855b5455242cd123fe4c625d4bd118208a33/mail/locales/en-US/chrome/messenger/converterDialog.properties">comparison</a> |
<a href="/comm-central/log/cb57855b5455242cd123fe4c625d4bd118208a33/mail/locales/en-US/chrome/messenger/converterDialog.properties">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cb57855b5455242cd123fe4c625d4bd118208a33/mail/locales/jar.mn">mail/locales/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cb57855b5455242cd123fe4c625d4bd118208a33/mail/locales/jar.mn">file</a> |
<a href="/comm-central/annotate/cb57855b5455242cd123fe4c625d4bd118208a33/mail/locales/jar.mn">annotate</a> |
<a href="/comm-central/diff/cb57855b5455242cd123fe4c625d4bd118208a33/mail/locales/jar.mn">diff</a> |
<a href="/comm-central/comparison/cb57855b5455242cd123fe4c625d4bd118208a33/mail/locales/jar.mn">comparison</a> |
<a href="/comm-central/log/cb57855b5455242cd123fe4c625d4bd118208a33/mail/locales/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/prefs/content/am-server.js">mailnews/base/prefs/content/am-server.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/prefs/content/am-server.js">file</a> |
<a href="/comm-central/annotate/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/prefs/content/am-server.js">annotate</a> |
<a href="/comm-central/diff/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/prefs/content/am-server.js">diff</a> |
<a href="/comm-central/comparison/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/prefs/content/am-server.js">comparison</a> |
<a href="/comm-central/log/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/prefs/content/am-server.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/prefs/content/am-server.xul">mailnews/base/prefs/content/am-server.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/prefs/content/am-server.xul">file</a> |
<a href="/comm-central/annotate/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/prefs/content/am-server.xul">annotate</a> |
<a href="/comm-central/diff/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/prefs/content/am-server.xul">diff</a> |
<a href="/comm-central/comparison/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/prefs/content/am-server.xul">comparison</a> |
<a href="/comm-central/log/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/prefs/content/am-server.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/prefs/content/am-serverwithnoidentities.js">mailnews/base/prefs/content/am-serverwithnoidentities.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/prefs/content/am-serverwithnoidentities.js">file</a> |
<a href="/comm-central/annotate/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/prefs/content/am-serverwithnoidentities.js">annotate</a> |
<a href="/comm-central/diff/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/prefs/content/am-serverwithnoidentities.js">diff</a> |
<a href="/comm-central/comparison/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/prefs/content/am-serverwithnoidentities.js">comparison</a> |
<a href="/comm-central/log/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/prefs/content/am-serverwithnoidentities.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/prefs/content/am-serverwithnoidentities.xul">mailnews/base/prefs/content/am-serverwithnoidentities.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/prefs/content/am-serverwithnoidentities.xul">file</a> |
<a href="/comm-central/annotate/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/prefs/content/am-serverwithnoidentities.xul">annotate</a> |
<a href="/comm-central/diff/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/prefs/content/am-serverwithnoidentities.xul">diff</a> |
<a href="/comm-central/comparison/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/prefs/content/am-serverwithnoidentities.xul">comparison</a> |
<a href="/comm-central/log/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/prefs/content/am-serverwithnoidentities.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/prefs/content/converterDialog.js">mailnews/base/prefs/content/converterDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/prefs/content/converterDialog.js">file</a> |
<a href="/comm-central/annotate/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/prefs/content/converterDialog.js">annotate</a> |
<a href="/comm-central/diff/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/prefs/content/converterDialog.js">diff</a> |
<a href="/comm-central/comparison/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/prefs/content/converterDialog.js">comparison</a> |
<a href="/comm-central/log/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/prefs/content/converterDialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/prefs/content/converterDialog.xhtml">mailnews/base/prefs/content/converterDialog.xhtml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/prefs/content/converterDialog.xhtml">file</a> |
<a href="/comm-central/annotate/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/prefs/content/converterDialog.xhtml">annotate</a> |
<a href="/comm-central/diff/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/prefs/content/converterDialog.xhtml">diff</a> |
<a href="/comm-central/comparison/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/prefs/content/converterDialog.xhtml">comparison</a> |
<a href="/comm-central/log/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/prefs/content/converterDialog.xhtml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/test/unit/test_converterDeferredAccount.js">mailnews/base/test/unit/test_converterDeferredAccount.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/test/unit/test_converterDeferredAccount.js">file</a> |
<a href="/comm-central/annotate/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/test/unit/test_converterDeferredAccount.js">annotate</a> |
<a href="/comm-central/diff/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/test/unit/test_converterDeferredAccount.js">diff</a> |
<a href="/comm-central/comparison/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/test/unit/test_converterDeferredAccount.js">comparison</a> |
<a href="/comm-central/log/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/test/unit/test_converterDeferredAccount.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/test/unit/test_mailstoreConverter.js">mailnews/base/test/unit/test_mailstoreConverter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/test/unit/test_mailstoreConverter.js">file</a> |
<a href="/comm-central/annotate/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/test/unit/test_mailstoreConverter.js">annotate</a> |
<a href="/comm-central/diff/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/test/unit/test_mailstoreConverter.js">diff</a> |
<a href="/comm-central/comparison/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/test/unit/test_mailstoreConverter.js">comparison</a> |
<a href="/comm-central/log/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/test/unit/test_mailstoreConverter.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/test/unit/xpcshell.ini">mailnews/base/test/unit/xpcshell.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/test/unit/xpcshell.ini">file</a> |
<a href="/comm-central/annotate/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/test/unit/xpcshell.ini">annotate</a> |
<a href="/comm-central/diff/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/test/unit/xpcshell.ini">diff</a> |
<a href="/comm-central/comparison/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/test/unit/xpcshell.ini">comparison</a> |
<a href="/comm-central/log/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/test/unit/xpcshell.ini">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/util/converterWorker.js">mailnews/base/util/converterWorker.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/util/converterWorker.js">file</a> |
<a href="/comm-central/annotate/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/util/converterWorker.js">annotate</a> |
<a href="/comm-central/diff/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/util/converterWorker.js">diff</a> |
<a href="/comm-central/comparison/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/util/converterWorker.js">comparison</a> |
<a href="/comm-central/log/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/util/converterWorker.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/util/mailstoreConverter.jsm">mailnews/base/util/mailstoreConverter.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/util/mailstoreConverter.jsm">file</a> |
<a href="/comm-central/annotate/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/util/mailstoreConverter.jsm">annotate</a> |
<a href="/comm-central/diff/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/util/mailstoreConverter.jsm">diff</a> |
<a href="/comm-central/comparison/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/util/mailstoreConverter.jsm">comparison</a> |
<a href="/comm-central/log/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/util/mailstoreConverter.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/util/moz.build">mailnews/base/util/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/util/moz.build">file</a> |
<a href="/comm-central/annotate/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/util/moz.build">annotate</a> |
<a href="/comm-central/diff/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/util/moz.build">diff</a> |
<a href="/comm-central/comparison/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/util/moz.build">comparison</a> |
<a href="/comm-central/log/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/base/util/moz.build">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/imap/test/unit/test_converterImap.js">mailnews/imap/test/unit/test_converterImap.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/imap/test/unit/test_converterImap.js">file</a> |
<a href="/comm-central/annotate/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/imap/test/unit/test_converterImap.js">annotate</a> |
<a href="/comm-central/diff/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/imap/test/unit/test_converterImap.js">diff</a> |
<a href="/comm-central/comparison/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/imap/test/unit/test_converterImap.js">comparison</a> |
<a href="/comm-central/log/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/imap/test/unit/test_converterImap.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/imap/test/unit/xpcshell.ini">mailnews/imap/test/unit/xpcshell.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/imap/test/unit/xpcshell.ini">file</a> |
<a href="/comm-central/annotate/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/imap/test/unit/xpcshell.ini">annotate</a> |
<a href="/comm-central/diff/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/imap/test/unit/xpcshell.ini">diff</a> |
<a href="/comm-central/comparison/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/imap/test/unit/xpcshell.ini">comparison</a> |
<a href="/comm-central/log/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/imap/test/unit/xpcshell.ini">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/jar.mn">mailnews/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/jar.mn">file</a> |
<a href="/comm-central/annotate/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/jar.mn">annotate</a> |
<a href="/comm-central/diff/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/jar.mn">diff</a> |
<a href="/comm-central/comparison/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/jar.mn">comparison</a> |
<a href="/comm-central/log/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/mailnews.js">mailnews/mailnews.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/mailnews.js">file</a> |
<a href="/comm-central/annotate/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/mailnews.js">annotate</a> |
<a href="/comm-central/diff/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/mailnews.js">diff</a> |
<a href="/comm-central/comparison/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/mailnews.js">comparison</a> |
<a href="/comm-central/log/cb57855b5455242cd123fe4c625d4bd118208a33/mailnews/mailnews.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1">new file mode 100644</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineminus">--- /dev/null</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/converterDialog.dtd</span>
<a href="#l1.4"></a><span id="l1.4" class="difflineat">@@ -0,0 +1,11 @@</span>
<a href="#l1.5"></a><span id="l1.5" class="difflineplus">+&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.6"></a><span id="l1.6" class="difflineplus">+   - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.7"></a><span id="l1.7" class="difflineplus">+   - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l1.8"></a><span id="l1.8" class="difflineplus">+</span>
<a href="#l1.9"></a><span id="l1.9" class="difflineplus">+&lt;!ENTITY converterDialog.title &quot;Message Store Type Converter&quot;&gt;</span>
<a href="#l1.10"></a><span id="l1.10" class="difflineplus">+&lt;!ENTITY converterDialog.continueButton &quot;Continue&quot;&gt;</span>
<a href="#l1.11"></a><span id="l1.11" class="difflineplus">+&lt;!ENTITY converterDialog.cancelButton &quot;Cancel&quot;&gt;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+&lt;!ENTITY converterDialog.finishButton &quot;Finish&quot;&gt;</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+&lt;!ENTITY converterDialog.complete &quot;The conversion is complete. &amp;brandShortName; will now restart.&quot;&gt;</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+&lt;!ENTITY converterDialog.error &quot;Conversion failed.&quot;&gt;</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">new file mode 100644</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineminus">--- /dev/null</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/converterDialog.properties</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineat">@@ -0,0 +1,41 @@</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineplus">+# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineplus">+# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.7"></a><span id="l2.7" class="difflineplus">+# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l2.8"></a><span id="l2.8" class="difflineplus">+</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineplus">+# LOCALIZATION NOTE (converterDialog.warning):</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+# %1$S will be replaced by the name of the account which is going to be converted.</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineplus">+# %2$S will be replaced by the format into which the account will be converted.</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+# %3$S will be replaced by $BrandShortName.</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+converterDialog.warning=The messages in the account %1$S will now be converted to the %2$S format. %3$S will restart after the conversion is complete.</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+# LOCALIZATION NOTE (converterDialog.message):</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+# %1$S will be replaced by the name of the account which is being converted.</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+# %2$S will be replaced by the format into which the account will be converted.</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+converterDialog.message=Converting the account %1$S to %2$S…</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+# LOCALIZATION NOTE (converterDialog.warningForDeferredAccount):</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+# %1$S will be replaced by the name of the deferred account for which migration is initiated by the user.</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+# %2$S will be replaced by the name of the account to which the deferred account is deferred ie the name of the deferred-to account.</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+# %3$S will be replaced by the name of the deferred-to account.</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+# %4$S will be replaced by a comma separated list of names of accounts which are deferred to the deferred-to account.</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+# %5$S will be replaced by a comma separated list of names of accounts which are going to get converted.</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+# %6$S will be replaced by the format into which the accounts will be converted.</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+# %7$S will be replaced by $BrandShortName.</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+converterDialog.warningForDeferredAccount=%1$S is deferred to %2$S. Accounts deferred to %3$S: %4$S. The messages in the accounts %5$S will now be converted to the %6$S format. %7$S will restart after the conversion is complete.</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+# LOCALIZATION NOTE (converterDialog.warningForDeferredToAccount):</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+# %1$S will be replaced by the name of the deferred-to account for which migration is initiated by the user and to which other accounts are deferred.</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+# %2$S will be replaced by a comma separated list of names of accounts which are deferred to the deferred-to account.</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+# %3$S will be replaced by a comma separated list of names of accounts which are going to get converted.</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+# %4$S will be replaced by the format into which the accounts will be converted.</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+# %5$S will be replaced by $BrandShortName.</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+converterDialog.warningForDeferredToAccount=Accounts deferred to %1$S: %2$S. The messages in the accounts %3$S will now be converted to the %4$S format. %5$S will restart after the conversion is complete.</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+# LOCALIZATION NOTE (converterDialog.messageForDeferredAccount):</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+# %1$S will be replaced by a comma separated list of names of accounts which are being converted.</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+# %2$S will be replaced by the format into which the accounts will be converted.</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+converterDialog.messageForDeferredAccount=Converting the accounts %1$S to %2$S…</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+# LOCALIZATION NOTE (converterDialog.percentDone):</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+# %1$S will be replaced by the percentage of conversion that is complete.</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+converterDialog.percentDone=%1$S%% done</span>
<a href="#l2.46"></a><span id="l2.46">\ No newline at end of file</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/locales/jar.mn</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/locales/jar.mn</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -44,16 +44,18 @@</span>
<a href="#l3.4"></a><span id="l3.4">   locale/@AB_CD@/messenger/AccountWizard.dtd                            (%chrome/messenger/AccountWizard.dtd)</span>
<a href="#l3.5"></a><span id="l3.5">   locale/@AB_CD@/messenger/am-advanced.dtd                              (%chrome/messenger/am-advanced.dtd)</span>
<a href="#l3.6"></a><span id="l3.6">   locale/@AB_CD@/messenger/am-server-advanced.dtd                       (%chrome/messenger/am-server-advanced.dtd)</span>
<a href="#l3.7"></a><span id="l3.7">   locale/@AB_CD@/messenger/am-copies.dtd                                (%chrome/messenger/am-copies.dtd)</span>
<a href="#l3.8"></a><span id="l3.8">   locale/@AB_CD@/messenger/am-offline.dtd                               (%chrome/messenger/am-offline.dtd)</span>
<a href="#l3.9"></a><span id="l3.9">   locale/@AB_CD@/messenger/am-addressing.dtd                            (%chrome/messenger/am-addressing.dtd)</span>
<a href="#l3.10"></a><span id="l3.10">   locale/@AB_CD@/messenger/am-main.dtd                                  (%chrome/messenger/am-main.dtd)</span>
<a href="#l3.11"></a><span id="l3.11">   locale/@AB_CD@/messenger/am-server-top.dtd                            (%chrome/messenger/am-server-top.dtd)</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+  locale/@AB_CD@/messenger/converterDialog.dtd                          (%chrome/messenger/converterDialog.dtd)</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+  locale/@AB_CD@/messenger/converterDialog.properties                   (%chrome/messenger/converterDialog.properties)</span>
<a href="#l3.14"></a><span id="l3.14">   locale/@AB_CD@/messenger/am-identities-list.dtd                       (%chrome/messenger/am-identities-list.dtd)</span>
<a href="#l3.15"></a><span id="l3.15">   locale/@AB_CD@/messenger/am-identity-edit.dtd                         (%chrome/messenger/am-identity-edit.dtd)</span>
<a href="#l3.16"></a><span id="l3.16">   locale/@AB_CD@/messenger/am-im.dtd                                    (%chrome/messenger/am-im.dtd)</span>
<a href="#l3.17"></a><span id="l3.17">   locale/@AB_CD@/messenger/am-serverwithnoidentities.dtd                (%chrome/messenger/am-serverwithnoidentities.dtd)</span>
<a href="#l3.18"></a><span id="l3.18">   locale/@AB_CD@/messenger/am-junk.dtd                                  (%chrome/messenger/am-junk.dtd)</span>
<a href="#l3.19"></a><span id="l3.19">   locale/@AB_CD@/messenger/prefs.properties                             (%chrome/messenger/prefs.properties)</span>
<a href="#l3.20"></a><span id="l3.20">   locale/@AB_CD@/messenger/smtpEditOverlay.dtd                          (%chrome/messenger/smtpEditOverlay.dtd)</span>
<a href="#l3.21"></a><span id="l3.21">   locale/@AB_CD@/messenger/am-smime.dtd                                 (%chrome/messenger/am-smime.dtd)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-server.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-server.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -3,16 +3,68 @@</span>
<a href="#l4.4"></a><span id="l4.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.5"></a><span id="l4.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7"> ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l4.8"></a><span id="l4.8"> ChromeUtils.import(&quot;resource:///modules/MailUtils.js&quot;);</span>
<a href="#l4.9"></a><span id="l4.9"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11"> var gServer;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+var gOriginalStoreType;</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+/**</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+ * Called when the store type menu is clicked.</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+ * @param {Object} aStoreTypeElement - store type menu list element.</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+ */</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+function clickStoreTypeMenu(aStoreTypeElement) {</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+  if (aStoreTypeElement.value == gOriginalStoreType) {</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+    return;</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+  }</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+  // Response from migration dialog modal. If the conversion is complete</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+  // 'response.newRootFolder' will hold the path to the new account root folder,</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+  // otherwise 'response.newRootFolder' will be null.</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+  let response = { newRootFolder: null };</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+  // Send 'response' as an argument to converterDialog.xhtml.</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+  window.openDialog(&quot;converterDialog.xhtml&quot;,&quot;mailnews:mailstoreconverter&quot;,</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+                    &quot;modal,centerscreen,width=800,height=180&quot;, gServer,</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+                    aStoreTypeElement.value, response);</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+  changeStoreType(response);</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+}</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+/**</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+ * Revert store type to the original store type if converter modal closes</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+ * before migration is complete, otherwise change original store type to</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+ * currently selected store type.</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+ * @param {Object} aResponse - response from migration dialog modal.</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+ */</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+function changeStoreType(aResponse) {</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+  if (aResponse.newRootFolder) {</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+    // The conversion is complete.</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+    // Set local path to the new account root folder which is present</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+    // in 'aResponse.newRootFolder'.</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+    if (gServer.type == &quot;nntp&quot;) {</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+      let newRootFolder = aResponse.newRootFolder;</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+      let lastSlash = newRootFolder.lastIndexOf(&quot;/&quot;);</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+      let newsrc = newRootFolder.slice(0, lastSlash) + &quot;/newsrc-&quot; +</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+                   newRootFolder.slice(lastSlash + 1);</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+      document.getElementById(&quot;nntp.newsrcFilePath&quot;).value = newsrc;</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+    }</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+    document.getElementById(&quot;server.localPath&quot;).value = aResponse.newRootFolder;</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+    gOriginalStoreType = document.getElementById(&quot;server.storeTypeMenulist&quot;)</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+                                 .value;</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+    BrowserUtils.restartApplication();</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+  } else {</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+    // The conversion failed or was cancelled.</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+    // Restore selected item to what was selected before conversion.</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+    document.getElementById(&quot;server.storeTypeMenulist&quot;).value =</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+      gOriginalStoreType;</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+  }</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+}</span>
<a href="#l4.64"></a><span id="l4.64"> </span>
<a href="#l4.65"></a><span id="l4.65"> function onSave()</span>
<a href="#l4.66"></a><span id="l4.66"> {</span>
<a href="#l4.67"></a><span id="l4.67">   let storeContractID = document.getElementById(&quot;server.storeTypeMenulist&quot;)</span>
<a href="#l4.68"></a><span id="l4.68">                                 .selectedItem</span>
<a href="#l4.69"></a><span id="l4.69">                                 .value;</span>
<a href="#l4.70"></a><span id="l4.70">   document.getElementById(&quot;server.storeContractID&quot;)</span>
<a href="#l4.71"></a><span id="l4.71">           .setAttribute(&quot;value&quot;, storeContractID);</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineat">@@ -41,19 +93,22 @@ function onInit(aPageId, aServerId)</span>
<a href="#l4.73"></a><span id="l4.73"> </span>
<a href="#l4.74"></a><span id="l4.74">   // UI for account store type.</span>
<a href="#l4.75"></a><span id="l4.75">   let storeTypeElement = document.getElementById(&quot;server.storeTypeMenulist&quot;);</span>
<a href="#l4.76"></a><span id="l4.76">   // set the menuitem to match the account</span>
<a href="#l4.77"></a><span id="l4.77">   let currentStoreID = document.getElementById(&quot;server.storeContractID&quot;)</span>
<a href="#l4.78"></a><span id="l4.78">                                .getAttribute(&quot;value&quot;);</span>
<a href="#l4.79"></a><span id="l4.79">   let targetItem = storeTypeElement.getElementsByAttribute(&quot;value&quot;, currentStoreID);</span>
<a href="#l4.80"></a><span id="l4.80">   storeTypeElement.selectedItem = targetItem[0];</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineminus">-  // disable store type change if store has already been used</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+  // Disable store type change if store has not been used yet.</span>
<a href="#l4.83"></a><span id="l4.83">   storeTypeElement.setAttribute(&quot;disabled&quot;,</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineminus">-    gServer.getBoolValue(&quot;canChangeStoreType&quot;) ? &quot;false&quot; : &quot;true&quot;);</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+    gServer.getBoolValue(&quot;canChangeStoreType&quot;) ?</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+      &quot;false&quot; : !Services.prefs.getBoolPref(&quot;mail.store_conversion_enabled&quot;));</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+  // Initialise 'gOriginalStoreType' to the item that was originally selected.</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+  gOriginalStoreType = storeTypeElement.value;</span>
<a href="#l4.89"></a><span id="l4.89"> }</span>
<a href="#l4.90"></a><span id="l4.90"> </span>
<a href="#l4.91"></a><span id="l4.91"> function onPreInit(account, accountValues)</span>
<a href="#l4.92"></a><span id="l4.92"> {</span>
<a href="#l4.93"></a><span id="l4.93">   var type = parent.getAccountValue(account, accountValues, &quot;server&quot;, &quot;type&quot;, null, false);</span>
<a href="#l4.94"></a><span id="l4.94">   hideShowControls(type);</span>
<a href="#l4.95"></a><span id="l4.95"> </span>
<a href="#l4.96"></a><span id="l4.96">   Services.obs.notifyObservers(null, &quot;charsetmenu-selected&quot;, &quot;other&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-server.xul</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-server.xul</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -395,17 +395,18 @@</span>
<a href="#l5.4"></a><span id="l5.4">                 id=&quot;server.popAdvancedButton&quot;</span>
<a href="#l5.5"></a><span id="l5.5">                 prefstring=&quot;mail.server.%serverkey%.advanced.disable&quot;</span>
<a href="#l5.6"></a><span id="l5.6">                 hidefor=&quot;imap,nntp,movemail&quot;/&gt;</span>
<a href="#l5.7"></a><span id="l5.7">       &lt;/hbox&gt;</span>
<a href="#l5.8"></a><span id="l5.8">       &lt;hbox align=&quot;center&quot;&gt;</span>
<a href="#l5.9"></a><span id="l5.9">         &lt;label value=&quot;&amp;storeType.label;&quot;</span>
<a href="#l5.10"></a><span id="l5.10">                accesskey=&quot;&amp;storeType.accesskey;&quot;</span>
<a href="#l5.11"></a><span id="l5.11">                control=&quot;server.storeTypeMenulist&quot;/&gt;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-        &lt;menulist id=&quot;server.storeTypeMenulist&quot;&gt;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+        &lt;menulist id=&quot;server.storeTypeMenulist&quot;</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+                  oncommand=&quot;clickStoreTypeMenu(this);&quot;&gt;</span>
<a href="#l5.15"></a><span id="l5.15">           &lt;menupopup id=&quot;server.storeTypeMenupopup&quot;&gt;</span>
<a href="#l5.16"></a><span id="l5.16">             &lt;menuitem id=&quot;server.mboxStore&quot;</span>
<a href="#l5.17"></a><span id="l5.17">                       value=&quot;@mozilla.org/msgstore/berkeleystore;1&quot;</span>
<a href="#l5.18"></a><span id="l5.18">                       label=&quot;&amp;mboxStore2.label;&quot;/&gt;</span>
<a href="#l5.19"></a><span id="l5.19">             &lt;menuitem id=&quot;server.maildirStore&quot;</span>
<a href="#l5.20"></a><span id="l5.20">                       value=&quot;@mozilla.org/msgstore/maildirstore;1&quot;</span>
<a href="#l5.21"></a><span id="l5.21">                       label=&quot;&amp;maildirStore.label;&quot;/&gt;</span>
<a href="#l5.22"></a><span id="l5.22">           &lt;/menupopup&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-serverwithnoidentities.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-serverwithnoidentities.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1,27 +1,72 @@</span>
<a href="#l6.4"></a><span id="l6.4"> /* -*- Mode: Java; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l6.5"></a><span id="l6.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.6"></a><span id="l6.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.7"></a><span id="l6.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/BrowserUtils.jsm&quot;);</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineplus">+</span>
<a href="#l6.11"></a><span id="l6.11"> var gServer;</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+var gOriginalStoreType;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+/**</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+ * Called when the store type menu is clicked.</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+ * @param {Object} aStoreTypeElement - store type menu list element.</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+ */</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+function clickStoreTypeMenu(aStoreTypeElement) {</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+  if (aStoreTypeElement.value == gOriginalStoreType) {</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+    return;</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+  }</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+  // Response from migration dialog modal. If the conversion is complete</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+  // 'response.newRootFolder' will hold the path to the new account root folder,</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+  // otherwise 'response.newRootFolder' will be null.</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+  let response = { newRootFolder: null };</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+  // Send 'response' as an argument to converterDialog.xhtml.</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+  window.openDialog(&quot;converterDialog.xhtml&quot;,&quot;mailnews:mailstoreconverter&quot;,</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+                    &quot;modal,centerscreen,width=800,height=180&quot;, gServer,</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+                    aStoreTypeElement.value, response);</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+  changeStoreType(response);</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+}</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+/**</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+ * Revert store type to the original store type if converter modal closes</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+ * before migration is complete, otherwise change original store type to</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+ * currently selected store type.</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+ * @param {Object} aResponse - response from migration dialog modal.</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+ */</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+function changeStoreType(aResponse) {</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+  if (aResponse.newRootFolder) {</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+    // The conversion is complete.</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+    // Set local path to the new account root folder which is present</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+    // in 'aResponse.newRootFolder'.</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+    document.getElementById(&quot;server.localPath&quot;).value = aResponse.newRootFolder;</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+    gOriginalStoreType = document.getElementById(&quot;server.storeTypeMenulist&quot;)</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+                                 .value;</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+    BrowserUtils.restartApplication();</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+  } else {</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+    // The conversion failed or was cancelled.</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+    // Restore selected item to what was selected before conversion.</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+    document.getElementById(&quot;server.storeTypeMenulist&quot;).value =</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+      gOriginalStoreType;</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+  }</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+}</span>
<a href="#l6.56"></a><span id="l6.56"> </span>
<a href="#l6.57"></a><span id="l6.57"> function onInit(aPageId, aServerId) {</span>
<a href="#l6.58"></a><span id="l6.58"> </span>
<a href="#l6.59"></a><span id="l6.59">   // UI for account store type</span>
<a href="#l6.60"></a><span id="l6.60">   let storeTypeElement = document.getElementById(&quot;server.storeTypeMenulist&quot;);</span>
<a href="#l6.61"></a><span id="l6.61">   // set the menuitem to match the account</span>
<a href="#l6.62"></a><span id="l6.62">   let currentStoreID = document.getElementById(&quot;server.storeContractID&quot;)</span>
<a href="#l6.63"></a><span id="l6.63">                                .getAttribute(&quot;value&quot;);</span>
<a href="#l6.64"></a><span id="l6.64">   let targetItem = storeTypeElement.getElementsByAttribute(&quot;value&quot;, currentStoreID);</span>
<a href="#l6.65"></a><span id="l6.65">   storeTypeElement.selectedItem = targetItem[0];</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineminus">-  // disable store type change if store has already been used</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineminus">-  storeTypeElement.setAttribute(&quot;disabled&quot;,</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineminus">-    gServer.getBoolValue(&quot;canChangeStoreType&quot;) ? &quot;false&quot; : &quot;true&quot;);</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+  // Initialise 'gOriginalStoreType' to the item that was originally selected.</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+  gOriginalStoreType = storeTypeElement.value;</span>
<a href="#l6.71"></a><span id="l6.71"> }</span>
<a href="#l6.72"></a><span id="l6.72"> </span>
<a href="#l6.73"></a><span id="l6.73"> function onPreInit(account, accountValues) {</span>
<a href="#l6.74"></a><span id="l6.74">   gServer = account.incomingServer;</span>
<a href="#l6.75"></a><span id="l6.75"> }</span>
<a href="#l6.76"></a><span id="l6.76"> </span>
<a href="#l6.77"></a><span id="l6.77"> function onSave()</span>
<a href="#l6.78"></a><span id="l6.78"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-serverwithnoidentities.xul</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-serverwithnoidentities.xul</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -46,17 +46,18 @@</span>
<a href="#l7.4"></a><span id="l7.4">                 label=&quot;&amp;emptyTrashOnExit.label;&quot;</span>
<a href="#l7.5"></a><span id="l7.5">                 accesskey=&quot;&amp;emptyTrashOnExit.accesskey;&quot;</span>
<a href="#l7.6"></a><span id="l7.6">                 prefattribute=&quot;value&quot;</span>
<a href="#l7.7"></a><span id="l7.7">                 prefstring=&quot;mail.server.%serverkey%.empty_trash_on_exit&quot;/&gt;</span>
<a href="#l7.8"></a><span id="l7.8">       &lt;hbox align=&quot;center&quot;&gt;</span>
<a href="#l7.9"></a><span id="l7.9">         &lt;label value=&quot;&amp;storeType.label;&quot;</span>
<a href="#l7.10"></a><span id="l7.10">                accesskey=&quot;&amp;storeType.accesskey;&quot;</span>
<a href="#l7.11"></a><span id="l7.11">                control=&quot;server.storeTypeMenulist&quot;/&gt;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-        &lt;menulist id=&quot;server.storeTypeMenulist&quot;&gt;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+        &lt;menulist id=&quot;server.storeTypeMenulist&quot;</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+                  oncommand=&quot;clickStoreTypeMenu(this);&quot;&gt;</span>
<a href="#l7.15"></a><span id="l7.15">           &lt;menupopup id=&quot;server.storeTypeMenupopup&quot;&gt;</span>
<a href="#l7.16"></a><span id="l7.16">             &lt;menuitem id=&quot;server.mboxStore&quot;</span>
<a href="#l7.17"></a><span id="l7.17">                       value=&quot;@mozilla.org/msgstore/berkeleystore;1&quot;</span>
<a href="#l7.18"></a><span id="l7.18">                       label=&quot;&amp;mboxStore2.label;&quot;/&gt;</span>
<a href="#l7.19"></a><span id="l7.19">             &lt;menuitem id=&quot;server.maildirStore&quot;</span>
<a href="#l7.20"></a><span id="l7.20">                       value=&quot;@mozilla.org/msgstore/maildirstore;1&quot;</span>
<a href="#l7.21"></a><span id="l7.21">                       label=&quot;&amp;maildirStore.label;&quot;/&gt;</span>
<a href="#l7.22"></a><span id="l7.22">           &lt;/menupopup&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">new file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- /dev/null</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ b/mailnews/base/prefs/content/converterDialog.js</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -0,0 +1,323 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineplus">+</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineplus">+/**</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineplus">+ * This file contains functionality for the front-end part of the mail store</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineplus">+ * type conversion.</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+ */</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/BrowserUtils.jsm&quot;);</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+ChromeUtils.import(&quot;resource:///modules/MailUtils.js&quot;);</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/FileUtils.jsm&quot;);</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/Log.jsm&quot;);</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+ChromeUtils.import(&quot;resource:///modules/mailstoreConverter.jsm&quot;);</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+ChromeUtils.import(&quot;resource:///modules/folderUtils.jsm&quot;);</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+var log = Log.repository.getLogger(&quot;MailStoreConverter&quot;);</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+// {nsIMsgIncomingServer} server for the account to be migrated.</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+var gServer;</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+// {nsIMsgFolder} account root folder.</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+var gFolder;</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+// 'gResponse.newRootFolder' is path to the new account root folder if migration</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+// is complete, else null.</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+// 'gResponse' is set to the modified response parameter received from</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+// am-server.js.</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+var gResponse;</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+// Array to hold deferred accounts.</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+var gDeferredAccounts = [];</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+// Value of Services.io.offline before migration.</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+var gOriginalOffline;</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+/**</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+ * Place account name in migration dialog modal.</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+ * @param {nsIMsgIncomingServer} aServer - account server.</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+ */</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+function placeAccountName(aServer) {</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+  gOriginalOffline = Services.io.offline;</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+  let bundle = Cc[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+    .getService(Ci.nsIStringBundleService)</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+    .createBundle(&quot;chrome://messenger/locale/converterDialog.properties&quot;);</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+  let brandShortName = Cc[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+    .getService(Ci.nsIStringBundleService)</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+    .createBundle(&quot;chrome://branding/locale/brand.properties&quot;)</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+    .GetStringFromName(&quot;brandShortName&quot;);</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+  // 'deferredToRootFolder' holds path of rootMsgFolder of account to which</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+  // other accounts have been deferred.</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+  let deferredToRootFolder = aServer.rootMsgFolder.filePath.path;</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+  // String to hold names of deferred accounts separated by commas.</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+  let deferredAccountsString = &quot;&quot;;</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+  // Account to which other accounts have been deferred.</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+  let deferredToAccount;</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+  // Array of all accounts.</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+  let accounts = allAccountsSorted(true);</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+  for (let account of accounts) {</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+    if (account.incomingServer.rootFolder.filePath.path ==</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+        deferredToRootFolder) {</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+      // Other accounts may be deferred to this account.</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+      deferredToAccount = account;</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+    } else if (account.incomingServer.rootMsgFolder.filePath.path ==</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+               deferredToRootFolder) {</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+      // This is a deferred account.</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+      gDeferredAccounts.push(account);</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+    }</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+  }</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+  // String to hold the names of accounts to be converted separated by commas.</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+  let accountsToConvert = &quot;&quot;;</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+  if (gDeferredAccounts.length &gt;= 1) {</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+    // Add account names to 'accountsToConvert' and 'deferredAccountsString'.</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+    for (let i = 0; i &lt; gDeferredAccounts.length; i++) {</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+      if (i &lt; gDeferredAccounts.length - 1) {</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+        accountsToConvert += gDeferredAccounts[i].incomingServer.username + &quot;, &quot;;</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+        deferredAccountsString += gDeferredAccounts[i].incomingServer.username + &quot;, &quot;;</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+      } else {</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+        accountsToConvert += gDeferredAccounts[i].incomingServer.username;</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+        deferredAccountsString += gDeferredAccounts[i].incomingServer.username;</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+      }</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+    }</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+    // Username of Local Folders is &quot;nobody&quot;. So it's better to use</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineplus">+    // its hostname which is &quot;Local Folders&quot;.</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineplus">+    // TODO: maybe test against .key == MailServices.accounts.localFoldersServer.key ?</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineplus">+    if (deferredToAccount.incomingServer.hostName == &quot;Local Folders&quot;) {</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+      accountsToConvert += &quot;, &quot; + deferredToAccount.incomingServer.prettyName;</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+    } else {</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+      accountsToConvert += &quot;, &quot; + deferredToAccount.incomingServer.prettyName;</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineplus">+    }</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineplus">+    log.info(accountsToConvert + &quot; will be converted&quot;);</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineplus">+    let storeContractId = Services.prefs.getCharPref(&quot;mail.server.&quot; +</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+      deferredToAccount.incomingServer.key + &quot;.storeContractID&quot;);</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineplus">+</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineplus">+    if (storeContractId == &quot;@mozilla.org/msgstore/berkeleystore;1&quot;) {</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineplus">+      storeContractId = &quot;maildir&quot;;</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineplus">+    } else {</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineplus">+      storeContractId = &quot;mbox&quot;;</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineplus">+    }</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineplus">+</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineplus">+    // Username of Local Folders is &quot;nobody&quot;. So it's better to use</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineplus">+    // its hostname which is &quot;Local Folders&quot;.</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+    // TODO: maybe test against .key != MailServices.accounts.localFoldersServer.key ?</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineplus">+    let deferredToAccountName = deferredToAccount.incomingServer.hostName;</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineplus">+    if (deferredToAccountName != &quot;Local Folders&quot;) {</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineplus">+      deferredToAccountName = deferredToAccount.incomingServer.username;</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineplus">+    }</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineplus">+</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineplus">+    if (aServer.rootFolder.filePath.path != deferredToRootFolder) {</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineplus">+      document.getElementById(&quot;warningSpan&quot;).innerHTML =</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineplus">+        bundle.formatStringFromName(</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineplus">+          &quot;converterDialog.warningForDeferredAccount&quot;,</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineplus">+          [aServer.username, deferredToAccountName, deferredToAccountName,</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+          deferredAccountsString,</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineplus">+          accountsToConvert, storeContractId, brandShortName], 7);</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineplus">+    } else {</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineplus">+      document.getElementById(&quot;warningSpan&quot;).innerHTML =</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineplus">+        bundle.formatStringFromName(</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineplus">+          &quot;converterDialog.warningForDeferredToAccount&quot;,</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineplus">+          [deferredToAccountName,</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineplus">+          deferredAccountsString,</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineplus">+          accountsToConvert, storeContractId, brandShortName], 5);</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+    }</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineplus">+</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineplus">+    document.getElementById(&quot;messageSpan&quot;).innerHTML =</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineplus">+      bundle.formatStringFromName(&quot;converterDialog.messageForDeferredAccount&quot;,</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineplus">+                                  [accountsToConvert, storeContractId], 2);</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineplus">+    gServer = deferredToAccount.incomingServer;</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineplus">+</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineplus">+  } else {</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineplus">+    // No account is deferred.</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineplus">+    let storeContractId = Services.prefs.getCharPref(</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineplus">+      &quot;mail.server.&quot; + aServer.key + &quot;.storeContractID&quot;);</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineplus">+    if (storeContractId == &quot;@mozilla.org/msgstore/berkeleystore;1&quot;) {</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineplus">+      storeContractId = &quot;maildir&quot;;</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineplus">+    } else {</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineplus">+      storeContractId = &quot;mbox&quot;;</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineplus">+    }</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineplus">+</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineplus">+    let tempName = aServer.username;</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineplus">+    if (tempName == &quot;nobody&quot;) {</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineplus">+      tempName = &quot;Local Folders&quot;;</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineplus">+    } else if (!tempName) {</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineplus">+      tempName = aServer.hostName;</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineplus">+    }</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineplus">+</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineplus">+    document.getElementById(&quot;warningSpan&quot;).innerHTML =</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineplus">+      bundle.formatStringFromName(&quot;converterDialog.warning&quot;,</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineplus">+                                  [tempName, storeContractId, brandShortName],</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineplus">+                                  3);</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineplus">+    document.getElementById(&quot;messageSpan&quot;).innerHTML =</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineplus">+      bundle.formatStringFromName(&quot;converterDialog.message&quot;,</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineplus">+                                  [tempName, storeContractId], 2);</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineplus">+    gServer = aServer;</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineplus">+  }</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineplus">+}</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineplus">+</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineplus">+/**</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineplus">+ * Start the conversion process.</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineplus">+ * @param {String} aSelectedStoreType - mailstore type selected by user.</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineplus">+ * @param {Object} aResponse - response from the migration dialog modal.</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineplus">+ */</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineplus">+function startContinue(aSelectedStoreType, aResponse) {</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineplus">+  gResponse = aResponse;</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineplus">+  gFolder = gServer.rootFolder.filePath;</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineplus">+</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineplus">+  let bundle = Cc[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineplus">+    .getService(Ci.nsIStringBundleService)</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineplus">+    .createBundle(&quot;chrome://messenger/locale/converterDialog.properties&quot;);</span>
<a href="#l8.178"></a><span id="l8.178" class="difflineplus">+</span>
<a href="#l8.179"></a><span id="l8.179" class="difflineplus">+  document.getElementById(&quot;progress&quot;).addEventListener(&quot;progress&quot;, function(e) {</span>
<a href="#l8.180"></a><span id="l8.180" class="difflineplus">+   document.getElementById(&quot;progress&quot;).value = e.detail;</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineplus">+   document.getElementById(&quot;progressPrcnt&quot;).innerHTML =</span>
<a href="#l8.182"></a><span id="l8.182" class="difflineplus">+     bundle.formatStringFromName(&quot;converterDialog.percentDone&quot;, [e.detail], 1);</span>
<a href="#l8.183"></a><span id="l8.183" class="difflineplus">+  });</span>
<a href="#l8.184"></a><span id="l8.184" class="difflineplus">+</span>
<a href="#l8.185"></a><span id="l8.185" class="difflineplus">+  document.getElementById(&quot;warning&quot;).style.display = &quot;none&quot;;</span>
<a href="#l8.186"></a><span id="l8.186" class="difflineplus">+  document.getElementById(&quot;progressDiv&quot;).style.display = &quot;block&quot;;</span>
<a href="#l8.187"></a><span id="l8.187" class="difflineplus">+</span>
<a href="#l8.188"></a><span id="l8.188" class="difflineplus">+  // Storing original prefs and root folder path</span>
<a href="#l8.189"></a><span id="l8.189" class="difflineplus">+  // to revert changes in case of error.</span>
<a href="#l8.190"></a><span id="l8.190" class="difflineplus">+  let p1 = &quot;mail.server.&quot; + gServer.key + &quot;.directory&quot;;</span>
<a href="#l8.191"></a><span id="l8.191" class="difflineplus">+  let p2 = &quot;mail.server.&quot; + gServer.key + &quot;.directory-rel&quot;;</span>
<a href="#l8.192"></a><span id="l8.192" class="difflineplus">+  let p3 = &quot;mail.server.&quot; + gServer.key + &quot;.newsrc.file&quot;;</span>
<a href="#l8.193"></a><span id="l8.193" class="difflineplus">+  let p4 = &quot;mail.server.&quot; + gServer.key + &quot;.newsrc.file-rel&quot;;</span>
<a href="#l8.194"></a><span id="l8.194" class="difflineplus">+  let p5 = &quot;mail.server.&quot; + gServer.key + &quot;.storeContractID&quot;;</span>
<a href="#l8.195"></a><span id="l8.195" class="difflineplus">+</span>
<a href="#l8.196"></a><span id="l8.196" class="difflineplus">+  let originalDirectoryPref = Services.prefs.getCharPref(p1);</span>
<a href="#l8.197"></a><span id="l8.197" class="difflineplus">+  let originalDirectoryRelPref = Services.prefs.getCharPref(p2);</span>
<a href="#l8.198"></a><span id="l8.198" class="difflineplus">+  let originalNewsrcFilePref;</span>
<a href="#l8.199"></a><span id="l8.199" class="difflineplus">+  let originalNewsrcFileRelPref;</span>
<a href="#l8.200"></a><span id="l8.200" class="difflineplus">+  if (gServer.type == &quot;nntp&quot;) {</span>
<a href="#l8.201"></a><span id="l8.201" class="difflineplus">+    originalNewsrcFilePref = Services.prefs.getCharPref(p3);</span>
<a href="#l8.202"></a><span id="l8.202" class="difflineplus">+    originalNewsrcFileRelPref = Services.prefs.getCharPref(p4);</span>
<a href="#l8.203"></a><span id="l8.203" class="difflineplus">+  }</span>
<a href="#l8.204"></a><span id="l8.204" class="difflineplus">+  let originalStoreContractID = Services.prefs.getCharPref(p5);</span>
<a href="#l8.205"></a><span id="l8.205" class="difflineplus">+  let originalRootFolderPath = gServer.rootFolder.filePath.path;</span>
<a href="#l8.206"></a><span id="l8.206" class="difflineplus">+</span>
<a href="#l8.207"></a><span id="l8.207" class="difflineplus">+  /**</span>
<a href="#l8.208"></a><span id="l8.208" class="difflineplus">+   * Called when promise returned by convertMailStoreTo() is rejected.</span>
<a href="#l8.209"></a><span id="l8.209" class="difflineplus">+   * @param {String} aReason - error because of which the promise was rejected.</span>
<a href="#l8.210"></a><span id="l8.210" class="difflineplus">+   */</span>
<a href="#l8.211"></a><span id="l8.211" class="difflineplus">+  function promiseRejected(aReason){</span>
<a href="#l8.212"></a><span id="l8.212" class="difflineplus">+    log.error(&quot;Conversion to '&quot; + mailstoreContractId + &quot;' failed: &quot; +</span>
<a href="#l8.213"></a><span id="l8.213" class="difflineplus">+      aReason);</span>
<a href="#l8.214"></a><span id="l8.214" class="difflineplus">+    document.getElementById(&quot;messageSpan&quot;).style.display = &quot;none&quot;;</span>
<a href="#l8.215"></a><span id="l8.215" class="difflineplus">+</span>
<a href="#l8.216"></a><span id="l8.216" class="difflineplus">+    document.getElementById(&quot;errorSpan&quot;).style.display = &quot;block&quot;;</span>
<a href="#l8.217"></a><span id="l8.217" class="difflineplus">+      gResponse.newRootFolder = null;</span>
<a href="#l8.218"></a><span id="l8.218" class="difflineplus">+</span>
<a href="#l8.219"></a><span id="l8.219" class="difflineplus">+    // Revert prefs.</span>
<a href="#l8.220"></a><span id="l8.220" class="difflineplus">+    Services.prefs.setCharPref(p1, originalDirectoryPref);</span>
<a href="#l8.221"></a><span id="l8.221" class="difflineplus">+    Services.prefs.setCharPref(p2, originalDirectoryRelPref);</span>
<a href="#l8.222"></a><span id="l8.222" class="difflineplus">+    if (gServer.type == &quot;nntp&quot;) {</span>
<a href="#l8.223"></a><span id="l8.223" class="difflineplus">+      Services.prefs.setCharPref(p3, originalNewsrcFilePref);</span>
<a href="#l8.224"></a><span id="l8.224" class="difflineplus">+      Services.prefs.setCharPref(p4, originalNewsrcFileRelPref);</span>
<a href="#l8.225"></a><span id="l8.225" class="difflineplus">+    }</span>
<a href="#l8.226"></a><span id="l8.226" class="difflineplus">+    Services.prefs.setCharPref(p5, originalStoreContractID);</span>
<a href="#l8.227"></a><span id="l8.227" class="difflineplus">+    Services.prefs.savePrefFile(null);</span>
<a href="#l8.228"></a><span id="l8.228" class="difflineplus">+    if (gServer.rootFolder.filePath.path != originalRootFolderPath)</span>
<a href="#l8.229"></a><span id="l8.229" class="difflineplus">+      gServer.rootFolder.filePath = new FileUtils.File(originalRootFolderPath);</span>
<a href="#l8.230"></a><span id="l8.230" class="difflineplus">+    Services.io.offline = gOriginalOffline;</span>
<a href="#l8.231"></a><span id="l8.231" class="difflineplus">+  }</span>
<a href="#l8.232"></a><span id="l8.232" class="difflineplus">+</span>
<a href="#l8.233"></a><span id="l8.233" class="difflineplus">+  /**</span>
<a href="#l8.234"></a><span id="l8.234" class="difflineplus">+   * Called when promise returned by convertMailStoreTo() is resolved.</span>
<a href="#l8.235"></a><span id="l8.235" class="difflineplus">+   * @param {String} aVal - path of the new account root folder with which the</span>
<a href="#l8.236"></a><span id="l8.236" class="difflineplus">+   * promise returned by convertMailStoreTo() is resolved.</span>
<a href="#l8.237"></a><span id="l8.237" class="difflineplus">+   */</span>
<a href="#l8.238"></a><span id="l8.238" class="difflineplus">+  function promiseResolved(aVal) {</span>
<a href="#l8.239"></a><span id="l8.239" class="difflineplus">+    let newMailstoreContractId = aSelectedStoreType;</span>
<a href="#l8.240"></a><span id="l8.240" class="difflineplus">+    log.info(&quot;Converted to '&quot; + newMailstoreContractId + &quot;' - &quot; + aVal);</span>
<a href="#l8.241"></a><span id="l8.241" class="difflineplus">+</span>
<a href="#l8.242"></a><span id="l8.242" class="difflineplus">+    gResponse.newRootFolder = aVal;</span>
<a href="#l8.243"></a><span id="l8.243" class="difflineplus">+    for (let deferredAccount of gDeferredAccounts) {</span>
<a href="#l8.244"></a><span id="l8.244" class="difflineplus">+      let defServer = deferredAccount.incomingServer;</span>
<a href="#l8.245"></a><span id="l8.245" class="difflineplus">+      defServer.rootMsgFolder.filePath = new FileUtils.File(aVal);</span>
<a href="#l8.246"></a><span id="l8.246" class="difflineplus">+      Services.prefs.setCharPref(&quot;mail.server.&quot; + defServer.key +</span>
<a href="#l8.247"></a><span id="l8.247" class="difflineplus">+        &quot;.storeContractID&quot;, newMailstoreContractId);</span>
<a href="#l8.248"></a><span id="l8.248" class="difflineplus">+    }</span>
<a href="#l8.249"></a><span id="l8.249" class="difflineplus">+</span>
<a href="#l8.250"></a><span id="l8.250" class="difflineplus">+    Services.io.offline = gOriginalOffline;</span>
<a href="#l8.251"></a><span id="l8.251" class="difflineplus">+    document.getElementById(&quot;cancel&quot;).style.display = &quot;none&quot;;</span>
<a href="#l8.252"></a><span id="l8.252" class="difflineplus">+    document.getElementById(&quot;finish&quot;).style.display = &quot;inline-block&quot;;</span>
<a href="#l8.253"></a><span id="l8.253" class="difflineplus">+    document.getElementById(&quot;messageSpan&quot;).style.display = &quot;none&quot;;</span>
<a href="#l8.254"></a><span id="l8.254" class="difflineplus">+    document.getElementById(&quot;completeSpan&quot;).style.display = &quot;block&quot;;</span>
<a href="#l8.255"></a><span id="l8.255" class="difflineplus">+  }</span>
<a href="#l8.256"></a><span id="l8.256" class="difflineplus">+</span>
<a href="#l8.257"></a><span id="l8.257" class="difflineplus">+  /**</span>
<a href="#l8.258"></a><span id="l8.258" class="difflineplus">+   * Check whether an mbox folder can be compacted or not.</span>
<a href="#l8.259"></a><span id="l8.259" class="difflineplus">+   * @param {nsIMsgFolder} aFolder - mbox folder that is to be checked.</span>
<a href="#l8.260"></a><span id="l8.260" class="difflineplus">+   */</span>
<a href="#l8.261"></a><span id="l8.261" class="difflineplus">+  function canCompact(aFolder) {</span>
<a href="#l8.262"></a><span id="l8.262" class="difflineplus">+    if (aFolder.expungedBytes != 0)</span>
<a href="#l8.263"></a><span id="l8.263" class="difflineplus">+      return true;</span>
<a href="#l8.264"></a><span id="l8.264" class="difflineplus">+    if (aFolder.hasSubFolders) {</span>
<a href="#l8.265"></a><span id="l8.265" class="difflineplus">+      let subFolders = aFolder.subFolders;</span>
<a href="#l8.266"></a><span id="l8.266" class="difflineplus">+      while (subFolders.hasMoreElements()) {</span>
<a href="#l8.267"></a><span id="l8.267" class="difflineplus">+        if (canCompact(subFolders.getNext().QueryInterface(Ci.nsIMsgFolder)))</span>
<a href="#l8.268"></a><span id="l8.268" class="difflineplus">+          return true;</span>
<a href="#l8.269"></a><span id="l8.269" class="difflineplus">+      }</span>
<a href="#l8.270"></a><span id="l8.270" class="difflineplus">+    }</span>
<a href="#l8.271"></a><span id="l8.271" class="difflineplus">+    return false;</span>
<a href="#l8.272"></a><span id="l8.272" class="difflineplus">+  }</span>
<a href="#l8.273"></a><span id="l8.273" class="difflineplus">+</span>
<a href="#l8.274"></a><span id="l8.274" class="difflineplus">+  // Compaction (compactAll()) works only for mbox folders which satisfy one of</span>
<a href="#l8.275"></a><span id="l8.275" class="difflineplus">+  // the following 2 conditions -</span>
<a href="#l8.276"></a><span id="l8.276" class="difflineplus">+  //   1. Messages are moved out of the folder.</span>
<a href="#l8.277"></a><span id="l8.277" class="difflineplus">+  //   2. Messages are moved out of some descendant folder of the folder.</span>
<a href="#l8.278"></a><span id="l8.278" class="difflineplus">+  // If the account root folder can be compacted, start the conversion after</span>
<a href="#l8.279"></a><span id="l8.279" class="difflineplus">+  // compacting it.</span>
<a href="#l8.280"></a><span id="l8.280" class="difflineplus">+  if (originalStoreContractID == &quot;@mozilla.org/msgstore/berkeleystore;1&quot;</span>
<a href="#l8.281"></a><span id="l8.281" class="difflineplus">+    &amp;&amp;</span>
<a href="#l8.282"></a><span id="l8.282" class="difflineplus">+    canCompact(gServer.rootFolder)) {</span>
<a href="#l8.283"></a><span id="l8.283" class="difflineplus">+    let urlListener = {</span>
<a href="#l8.284"></a><span id="l8.284" class="difflineplus">+      OnStartRunningUrl: function (aUrl) {</span>
<a href="#l8.285"></a><span id="l8.285" class="difflineplus">+      },</span>
<a href="#l8.286"></a><span id="l8.286" class="difflineplus">+      OnStopRunningUrl: function (aUrl, aExitCode) {</span>
<a href="#l8.287"></a><span id="l8.287" class="difflineplus">+        let pConvert = convertMailStoreTo(originalStoreContractID,</span>
<a href="#l8.288"></a><span id="l8.288" class="difflineplus">+          gServer, document.getElementById(&quot;progress&quot;));</span>
<a href="#l8.289"></a><span id="l8.289" class="difflineplus">+        pConvert.then(function(val) {</span>
<a href="#l8.290"></a><span id="l8.290" class="difflineplus">+          promiseResolved(val);</span>
<a href="#l8.291"></a><span id="l8.291" class="difflineplus">+        }).catch(function(reason) {</span>
<a href="#l8.292"></a><span id="l8.292" class="difflineplus">+          promiseRejected(reason);</span>
<a href="#l8.293"></a><span id="l8.293" class="difflineplus">+        });</span>
<a href="#l8.294"></a><span id="l8.294" class="difflineplus">+      }</span>
<a href="#l8.295"></a><span id="l8.295" class="difflineplus">+    };</span>
<a href="#l8.296"></a><span id="l8.296" class="difflineplus">+    gServer.rootFolder.compactAll(urlListener, null, gServer.type == &quot;imap&quot; ||</span>
<a href="#l8.297"></a><span id="l8.297" class="difflineplus">+      gServer.type == &quot;nntp&quot;);</span>
<a href="#l8.298"></a><span id="l8.298" class="difflineplus">+  }</span>
<a href="#l8.299"></a><span id="l8.299" class="difflineplus">+  else {</span>
<a href="#l8.300"></a><span id="l8.300" class="difflineplus">+    let pConvert = convertMailStoreTo(originalStoreContractID,</span>
<a href="#l8.301"></a><span id="l8.301" class="difflineplus">+      gServer, document.getElementById(&quot;progress&quot;));</span>
<a href="#l8.302"></a><span id="l8.302" class="difflineplus">+    pConvert.then(function(val) {</span>
<a href="#l8.303"></a><span id="l8.303" class="difflineplus">+      promiseResolved(val);</span>
<a href="#l8.304"></a><span id="l8.304" class="difflineplus">+    }).catch(function(reason) {</span>
<a href="#l8.305"></a><span id="l8.305" class="difflineplus">+      promiseRejected(reason);</span>
<a href="#l8.306"></a><span id="l8.306" class="difflineplus">+    });</span>
<a href="#l8.307"></a><span id="l8.307" class="difflineplus">+  }</span>
<a href="#l8.308"></a><span id="l8.308" class="difflineplus">+}</span>
<a href="#l8.309"></a><span id="l8.309" class="difflineplus">+</span>
<a href="#l8.310"></a><span id="l8.310" class="difflineplus">+/**</span>
<a href="#l8.311"></a><span id="l8.311" class="difflineplus">+ * Cancel the conversion.</span>
<a href="#l8.312"></a><span id="l8.312" class="difflineplus">+ * @param {Object} aResponse - response param from the migration dialog modal.</span>
<a href="#l8.313"></a><span id="l8.313" class="difflineplus">+ */</span>
<a href="#l8.314"></a><span id="l8.314" class="difflineplus">+function cancelConversion(aResponse) {</span>
<a href="#l8.315"></a><span id="l8.315" class="difflineplus">+  gResponse = aResponse;</span>
<a href="#l8.316"></a><span id="l8.316" class="difflineplus">+  gResponse.newRootFolder = null;</span>
<a href="#l8.317"></a><span id="l8.317" class="difflineplus">+  terminateWorkers();</span>
<a href="#l8.318"></a><span id="l8.318" class="difflineplus">+  Services.io.offline = gOriginalOffline;</span>
<a href="#l8.319"></a><span id="l8.319" class="difflineplus">+  window.close();</span>
<a href="#l8.320"></a><span id="l8.320" class="difflineplus">+}</span>
<a href="#l8.321"></a><span id="l8.321" class="difflineplus">+</span>
<a href="#l8.322"></a><span id="l8.322" class="difflineplus">+/**</span>
<a href="#l8.323"></a><span id="l8.323" class="difflineplus">+ * Called when &quot;finish&quot; button is clicked.</span>
<a href="#l8.324"></a><span id="l8.324" class="difflineplus">+ */</span>
<a href="#l8.325"></a><span id="l8.325" class="difflineplus">+function finishConversion() {</span>
<a href="#l8.326"></a><span id="l8.326" class="difflineplus">+  window.close();</span>
<a href="#l8.327"></a><span id="l8.327" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">new file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- /dev/null</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ b/mailnews/base/prefs/content/converterDialog.xhtml</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -0,0 +1,63 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineplus">+&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineplus">+   - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineplus">+   - file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineplus">+--&gt;</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineplus">+&lt;!DOCTYPE html [</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineplus">+&lt;!ENTITY % brandDTD SYSTEM &quot;chrome://branding/locale/brand.dtd&quot;&gt;</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineplus">+%brandDTD;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+&lt;!ENTITY % converterDTD SYSTEM &quot;chrome://messenger/locale/converterDialog.dtd&quot;&gt;</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+%converterDTD;</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+]&gt;</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+&lt;head&gt;</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+  &lt;meta charset=&quot;UTF-8&quot; /&gt;</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+  &lt;title&gt;&amp;converterDialog.title;&lt;/title&gt;</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+  &lt;style&gt;</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+    .controls {</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+      width: 97%;</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+      position: fixed;</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+      bottom: 20px;</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+      text-align: right;</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineplus">+    }</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+    #progressDiv {</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineplus">+      margin: 1%;</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineplus">+    }</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+    #progress {</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+      width: 80%;</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+    }</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+  &lt;/style&gt;</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+  &lt;script src=&quot;converterDialog.js&quot; /&gt;</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineplus">+&lt;/head&gt;</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+&lt;body onload=&quot;placeAccountName(window.arguments[0]);&quot;&gt;</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+  &lt;div id=&quot;warning&quot;&gt;</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+    &lt;p id=&quot;warningSpan&quot;&gt;[The messages in the account XXX will now be converted to the maildir format.]&lt;/p&gt;</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+    &lt;div class=&quot;controls&quot;&gt;</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+      &lt;button onclick=&quot;cancelConversion(window.arguments[2]);&quot;&gt;</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+       &amp;converterDialog.cancelButton;</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+      &lt;/button&gt;</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+      &lt;button onclick=&quot;startContinue(window.arguments[1], window.arguments[2]);&quot;&gt;</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+       &amp;converterDialog.continueButton;</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+      &lt;/button&gt;</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+    &lt;/div&gt;</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+  &lt;/div&gt;</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+  &lt;div id=&quot;progressDiv&quot; hidden=&quot;hidden&quot;&gt;</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+    &lt;p id=&quot;messageSpan&quot;&gt;[Messages go here]&lt;/p&gt;</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+    &lt;p id=&quot;completeSpan&quot; hidden=&quot;hidden&quot;&gt;&amp;converterDialog.complete;&lt;/p&gt;</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+    &lt;p id=&quot;errorSpan&quot; hidden=&quot;hidden&quot;&gt;&amp;converterDialog.error;&lt;/p&gt;</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+    &lt;p&gt;</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+      &lt;progress id=&quot;progress&quot; value=&quot;0&quot; max=&quot;100&quot;&gt;&lt;/progress&gt;</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+      &lt;span id=&quot;progressPrcnt&quot;&gt;0% done&lt;/span&gt;</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineplus">+    &lt;/p&gt;</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+    &lt;div class=&quot;controls&quot;&gt;</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+      &lt;button id=&quot;cancel&quot; onclick=&quot;cancelConversion(window.arguments[1]);&quot;&gt;</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+       &amp;converterDialog.cancelButton;</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineplus">+      &lt;/button&gt;</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+      &lt;button id=&quot;finish&quot; onclick=&quot;finishConversion();&quot; hidden=&quot;hidden&quot;&gt;</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineplus">+       &amp;converterDialog.finishButton;</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineplus">+      &lt;/button&gt;</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineplus">+    &lt;/div&gt;</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+  &lt;/div&gt;</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineplus">+&lt;/body&gt;</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineplus">+&lt;/html&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">new file mode 100644</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineminus">--- /dev/null</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineplus">+++ b/mailnews/base/test/unit/test_converterDeferredAccount.js</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineat">@@ -0,0 +1,179 @@</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l10.7"></a><span id="l10.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l10.8"></a><span id="l10.8" class="difflineplus">+</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/FileUtils.jsm&quot;);</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineplus">+ChromeUtils.import(&quot;resource://testing-common/mailnews/PromiseTestUtils.jsm&quot;);</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+ChromeUtils.import(&quot;resource:///modules/mailstoreConverter.jsm&quot;);</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/Log.jsm&quot;);</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+ChromeUtils.import(&quot;resource:///modules/folderUtils.jsm&quot;);</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+// XXX: merge into test_converter.js</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+var log = Log.repository.getLogger(&quot;MailStoreConverter&quot;);</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+Services.prefs.setCharPref(&quot;mail.serverDefaultStoreContractID&quot;,</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+                           &quot;@mozilla.org/msgstore/berkeleystore;1&quot;);</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+// No. of messages/files and folders copied.</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+var gProgressValue = 0;</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+var gMsgHdrs = [];</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineplus">+// {nsIMsgLocalMailFolder} folder carrying messages for the pop server.</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+var gInbox;</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineplus">+// {nsIMsgIncomingServer} server for first deferred pop account.</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+var gServer1;</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+// {nsIMsgIncomingServer} server for second deferred pop account.</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+var gServer2;</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+// {nsIMsgIncomingServer} server to convert.</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+var gServer;</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineplus">+var copyListenerWrap = {</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+  SetMessageKey: function(aKey) {</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+    let hdr = gInbox.GetMessageHeader(aKey);</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+    gMsgHdrs.push({hdr: hdr, ID: hdr.messageId});</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+  },</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+  OnStopCopy: function(aStatus) {</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+    // Check: message successfully copied.</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+    Assert.equal(aStatus, 0);</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+  }</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+};</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineplus">+var EventTarget = function () {</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineplus">+  this.dispatchEvent = function (event) {</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+    if (event.type == &quot;progress&quot;) {</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+      log.trace(&quot;Progress: &quot; + event.detail);</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+    }</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+  };</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+};</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineplus">+function copyFileMessage(file, destFolder, isDraftOrTemplate)</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+{</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineplus">+  let listener = new PromiseTestUtils.PromiseCopyListener(copyListenerWrap);</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineplus">+  MailServices.copy.CopyFileMessage(file, destFolder, null, isDraftOrTemplate,</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineplus">+                                    0, &quot;&quot;, listener, null);</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineplus">+  return listener.promise;</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineplus">+}</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+/**</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineplus">+ * Check that conversion worked for the given source.</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineplus">+ * @param source - mbox source directory</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineplus">+ * @param target - maildir target directory</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineplus">+ */</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineplus">+function checkConversion(source, target) {</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineplus">+  let sourceContents = source.directoryEntries;</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineplus">+</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineplus">+  while (sourceContents.hasMoreElements()) {</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineplus">+    let sourceContent = sourceContents.getNext().QueryInterface(Ci.nsIFile);</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineplus">+    let sourceContentName = sourceContent.leafName;</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineplus">+    let ext = sourceContentName.substr(-4);</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineplus">+    let targetFile = FileUtils.File(OS.Path.join(target.path,sourceContentName));</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineplus">+    log.debug(&quot;Checking path: &quot; + targetFile.path);</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineplus">+    if (ext == &quot;.dat&quot;) {</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineplus">+      Assert.ok(targetFile.exists());</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineplus">+    } else if (sourceContent.isDirectory()) {</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineplus">+      Assert.ok(targetFile.exists());</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineplus">+      checkConversion(sourceContent, targetFile);</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineplus">+    } else if (ext != &quot;.msf&quot;) {</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineplus">+      Assert.ok(targetFile.exists());</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineplus">+      let cur = FileUtils.File(OS.Path.join(targetFile.path,&quot;cur&quot;));</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineplus">+      Assert.ok(cur.exists());</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineplus">+      let tmp = FileUtils.File(OS.Path.join(targetFile.path,&quot;tmp&quot;));</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineplus">+      Assert.ok(tmp.exists());</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineplus">+      if (targetFile.leafName == &quot;Inbox&quot;) {</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineplus">+        let curContents = cur.directoryEntries;</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineplus">+        let curContentsCount = 0;</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineplus">+        while (curContents.hasMoreElements()) {</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineplus">+          let curContent = curContents.getNext();</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineplus">+          curContentsCount++;</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineplus">+        }</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineplus">+        Assert.equal(curContentsCount, 1000);</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineplus">+      }</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineplus">+    }</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineplus">+  }</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineplus">+}</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineplus">+</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineplus">+function run_test() {</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineplus">+  localAccountUtils.loadLocalMailAccount();</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineplus">+</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineplus">+  // Set up two deferred pop accounts.</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineplus">+  gServer1 = MailServices.accounts.createIncomingServer(&quot;test1&quot;, &quot;localhost1&quot;,</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineplus">+                                                        &quot;pop3&quot;);</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineplus">+  gServer2 = MailServices.accounts.createIncomingServer(&quot;test2&quot;, &quot;localhost2&quot;,</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineplus">+                                                        &quot;pop3&quot;);</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineplus">+  var accountPop1 = MailServices.accounts.createAccount();</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineplus">+  var accountPop2 = MailServices.accounts.createAccount();</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineplus">+</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineplus">+  // Set incoming servers.</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineplus">+  accountPop1.incomingServer = gServer1;</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineplus">+  gServer1.QueryInterface(Ci.nsIPop3IncomingServer);</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineplus">+  gServer1.valid = true;</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineplus">+  accountPop2.incomingServer = gServer2;</span>
<a href="#l10.116"></a><span id="l10.116" class="difflineplus">+  gServer2.QueryInterface(Ci.nsIPop3IncomingServer);</span>
<a href="#l10.117"></a><span id="l10.117" class="difflineplus">+  gServer2.valid = true;</span>
<a href="#l10.118"></a><span id="l10.118" class="difflineplus">+</span>
<a href="#l10.119"></a><span id="l10.119" class="difflineplus">+  // Defer accounts to Local Folders.</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineplus">+  gServer1.deferredToAccount = localAccountUtils.msgAccount.key;</span>
<a href="#l10.121"></a><span id="l10.121" class="difflineplus">+  gServer2.deferredToAccount = localAccountUtils.msgAccount.key;</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineplus">+</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineplus">+  // 'gServer1' should be deferred. Get the path of the root folder to which</span>
<a href="#l10.124"></a><span id="l10.124" class="difflineplus">+  // other accounts are deferred.</span>
<a href="#l10.125"></a><span id="l10.125" class="difflineplus">+  ok(gServer1.rootFolder.filePath.path !=</span>
<a href="#l10.126"></a><span id="l10.126" class="difflineplus">+    gServer1.rootMsgFolder.filePath.path);</span>
<a href="#l10.127"></a><span id="l10.127" class="difflineplus">+  let deferredToRootFolder = gServer1.rootMsgFolder.filePath.path;</span>
<a href="#l10.128"></a><span id="l10.128" class="difflineplus">+</span>
<a href="#l10.129"></a><span id="l10.129" class="difflineplus">+  // Account to which other accounts have been deferred.</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineplus">+  let deferredToAccount;</span>
<a href="#l10.131"></a><span id="l10.131" class="difflineplus">+  // String to hold names of accounts to convert.</span>
<a href="#l10.132"></a><span id="l10.132" class="difflineplus">+  let accountsToConvert = &quot;&quot;;</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineplus">+</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineplus">+  let accounts = allAccountsSorted(true);</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineplus">+  for (let account of accounts) {</span>
<a href="#l10.136"></a><span id="l10.136" class="difflineplus">+    if (account.incomingServer.rootFolder.filePath.path ==</span>
<a href="#l10.137"></a><span id="l10.137" class="difflineplus">+        deferredToRootFolder) {</span>
<a href="#l10.138"></a><span id="l10.138" class="difflineplus">+      // Other accounts may be deferred to this account.</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineplus">+      deferredToAccount = account;</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineplus">+    } else if (account.incomingServer.rootMsgFolder.filePath.path ==</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineplus">+               deferredToRootFolder) {</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineplus">+      // This is a deferred account.</span>
<a href="#l10.143"></a><span id="l10.143" class="difflineplus">+      accountsToConvert += account.incomingServer.username + &quot;, &quot;;</span>
<a href="#l10.144"></a><span id="l10.144" class="difflineplus">+    }</span>
<a href="#l10.145"></a><span id="l10.145" class="difflineplus">+  }</span>
<a href="#l10.146"></a><span id="l10.146" class="difflineplus">+</span>
<a href="#l10.147"></a><span id="l10.147" class="difflineplus">+  accountsToConvert = accountsToConvert +</span>
<a href="#l10.148"></a><span id="l10.148" class="difflineplus">+    deferredToAccount.incomingServer.username;</span>
<a href="#l10.149"></a><span id="l10.149" class="difflineplus">+  log.info(accountsToConvert + &quot; will be converted&quot;);</span>
<a href="#l10.150"></a><span id="l10.150" class="difflineplus">+</span>
<a href="#l10.151"></a><span id="l10.151" class="difflineplus">+  gInbox = localAccountUtils.inboxFolder;</span>
<a href="#l10.152"></a><span id="l10.152" class="difflineplus">+  gServer = deferredToAccount.incomingServer;</span>
<a href="#l10.153"></a><span id="l10.153" class="difflineplus">+</span>
<a href="#l10.154"></a><span id="l10.154" class="difflineplus">+  run_next_test();</span>
<a href="#l10.155"></a><span id="l10.155" class="difflineplus">+}</span>
<a href="#l10.156"></a><span id="l10.156" class="difflineplus">+</span>
<a href="#l10.157"></a><span id="l10.157" class="difflineplus">+add_task(function* setupMessages() {</span>
<a href="#l10.158"></a><span id="l10.158" class="difflineplus">+  let msgFile = do_get_file(&quot;../../../data/bugmail10&quot;);</span>
<a href="#l10.159"></a><span id="l10.159" class="difflineplus">+  // Add 1000 messages to the &quot;Inbox&quot; folder.</span>
<a href="#l10.160"></a><span id="l10.160" class="difflineplus">+  for (let i = 0; i &lt; 1000; i++) {</span>
<a href="#l10.161"></a><span id="l10.161" class="difflineplus">+    yield copyFileMessage(msgFile, gInbox, false);</span>
<a href="#l10.162"></a><span id="l10.162" class="difflineplus">+  }</span>
<a href="#l10.163"></a><span id="l10.163" class="difflineplus">+});</span>
<a href="#l10.164"></a><span id="l10.164" class="difflineplus">+</span>
<a href="#l10.165"></a><span id="l10.165" class="difflineplus">+add_task(function testMaildirConversion() {</span>
<a href="#l10.166"></a><span id="l10.166" class="difflineplus">+  let mailstoreContractId = Services.prefs.getCharPref(</span>
<a href="#l10.167"></a><span id="l10.167" class="difflineplus">+    &quot;mail.server.&quot; + gServer.key + &quot;.storeContractID&quot;);</span>
<a href="#l10.168"></a><span id="l10.168" class="difflineplus">+</span>
<a href="#l10.169"></a><span id="l10.169" class="difflineplus">+  do_test_pending();</span>
<a href="#l10.170"></a><span id="l10.170" class="difflineplus">+  let pConverted = convertMailStoreTo(mailstoreContractId, gServer,</span>
<a href="#l10.171"></a><span id="l10.171" class="difflineplus">+                                      new EventTarget());</span>
<a href="#l10.172"></a><span id="l10.172" class="difflineplus">+  let originalRootFolder = gServer.rootFolder.filePath;</span>
<a href="#l10.173"></a><span id="l10.173" class="difflineplus">+</span>
<a href="#l10.174"></a><span id="l10.174" class="difflineplus">+  pConverted.then(function(val) {</span>
<a href="#l10.175"></a><span id="l10.175" class="difflineplus">+    log.debug(&quot;Conversion done: &quot; + originalRootFolder.path + &quot; =&gt; &quot; + val);</span>
<a href="#l10.176"></a><span id="l10.176" class="difflineplus">+    let newRootFolder = gServer.rootFolder.filePath;</span>
<a href="#l10.177"></a><span id="l10.177" class="difflineplus">+    checkConversion(originalRootFolder, newRootFolder);</span>
<a href="#l10.178"></a><span id="l10.178" class="difflineplus">+    do_test_finished();</span>
<a href="#l10.179"></a><span id="l10.179" class="difflineplus">+  }).catch (function(reason) {</span>
<a href="#l10.180"></a><span id="l10.180" class="difflineplus">+    log.error(&quot;Conversion failed: &quot; + reason.error);</span>
<a href="#l10.181"></a><span id="l10.181" class="difflineplus">+    ok(false); //Fail the test!</span>
<a href="#l10.182"></a><span id="l10.182" class="difflineplus">+  });</span>
<a href="#l10.183"></a><span id="l10.183" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">new file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- /dev/null</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ b/mailnews/base/test/unit/test_mailstoreConverter.js</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -0,0 +1,133 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineplus">+</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/FileUtils.jsm&quot;);</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineplus">+ChromeUtils.import(&quot;resource://testing-common/mailnews/PromiseTestUtils.jsm&quot;);</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+ChromeUtils.import(&quot;resource:///modules/mailstoreConverter.jsm&quot;);</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/Log.jsm&quot;);</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+var log = Log.repository.getLogger(&quot;MailStoreConverter&quot;);</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+Services.prefs.setCharPref(&quot;mail.serverDefaultStoreContractID&quot;,</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+                           &quot;@mozilla.org/msgstore/berkeleystore;1&quot;);</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+var gMsgHdrs = [];</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+// {nsIMsgLocalMailFolder} folder carrying messages for the pop server.</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+var gInbox;</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+// {nsIMsgAccount} Account to convert.</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+var gAccount;</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+// Server for the account to convert.</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+var gServer;</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineplus">+</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineplus">+var copyListenerWrap = {</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineplus">+  SetMessageKey: function(aKey) {</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+    let hdr = gInbox.GetMessageHeader(aKey);</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+    gMsgHdrs.push({hdr: hdr, ID: hdr.messageId});</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+  },</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+  OnStopCopy: function(aStatus) {</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+    // Check: message successfully copied.</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+    Assert.equal(aStatus, 0);</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+  }</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+};</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineplus">+</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+var EventTarget = function () {</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+  this.dispatchEvent = function(aEvent) {</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+    if (aEvent.type == &quot;progress&quot;) {</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+      log.trace(&quot;Progress: &quot; + aEvent.detail);</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+    }</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+  };</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineplus">+};</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineplus">+function copyFileMessage(aFile, aDestFolder, aIsDraftOrTemplate)</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+{</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineplus">+  let listener = new PromiseTestUtils.PromiseCopyListener(copyListenerWrap);</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineplus">+  MailServices.copy.CopyFileMessage(aFile, aDestFolder, null, aIsDraftOrTemplate,</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+                                    0, &quot;&quot;, listener, null);</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineplus">+  return listener.promise;</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+}</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineplus">+</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+/**</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineplus">+ * Check that conversion worked for the given source.</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+ * @param aSource - mbox source directory</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineplus">+ * @param aTarget - maildir target directory</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineplus">+ */</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineplus">+function checkConversion(aSource, aTarget) {</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineplus">+  let sourceContents = aSource.directoryEntries;</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineplus">+</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineplus">+  while (sourceContents.hasMoreElements()) {</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineplus">+    let sourceContent = sourceContents.getNext().QueryInterface(Ci.nsIFile);</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineplus">+    let sourceContentName = sourceContent.leafName;</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+    let ext = sourceContentName.substr(-4);</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineplus">+    let targetFile = FileUtils.File(OS.Path.join(aTarget.path,sourceContentName));</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineplus">+    log.debug(&quot;Checking path: &quot; + targetFile.path);</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineplus">+    if (ext == &quot;.dat&quot;) {</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineplus">+      Assert.ok(targetFile.exists());</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+    } else if (sourceContent.isDirectory()) {</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+      Assert.ok(targetFile.exists());</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineplus">+      checkConversion(sourceContent, targetFile);</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineplus">+    } else if (ext != &quot;.msf&quot;) {</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineplus">+      Assert.ok(targetFile.exists());</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineplus">+      let cur = FileUtils.File(OS.Path.join(targetFile.path,&quot;cur&quot;));</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineplus">+      Assert.ok(cur.exists());</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineplus">+      let tmp = FileUtils.File(OS.Path.join(targetFile.path,&quot;tmp&quot;));</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineplus">+      Assert.ok(tmp.exists());</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineplus">+      if (targetFile.leafName == &quot;Inbox&quot;) {</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineplus">+        let curContents = cur.directoryEntries;</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineplus">+        let curContentsCount = 0;</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineplus">+        while (curContents.hasMoreElements()) {</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineplus">+          let curContent = curContents.getNext();</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineplus">+          curContentsCount++;</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineplus">+        }</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineplus">+        // We had 1000 msgs in the old folder. We should have that after</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineplus">+        // conversion too.</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineplus">+        Assert.equal(curContentsCount, 1000);</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineplus">+      }</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineplus">+    }</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineplus">+  }</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineplus">+}</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineplus">+</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineplus">+function run_test() {</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineplus">+  localAccountUtils.loadLocalMailAccount();</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineplus">+</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineplus">+  // {nsIMsgIncomingServer} pop server for the test.</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineplus">+  gServer = MailServices.accounts.createIncomingServer(&quot;test&quot;,&quot;localhost&quot;,</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineplus">+                                                       &quot;pop3&quot;);</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineplus">+  gAccount = MailServices.accounts.createAccount();</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineplus">+  gAccount.incomingServer = gServer;</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineplus">+  gServer.QueryInterface(Ci.nsIPop3IncomingServer);</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineplus">+  gServer.valid = true;</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineplus">+</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineplus">+  gInbox = gAccount.incomingServer.rootFolder</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineplus">+    .getFolderWithFlags(Ci.nsMsgFolderFlags.Inbox);</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineplus">+</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineplus">+  run_next_test();</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineplus">+}</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineplus">+</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineplus">+add_task(function* setupMessages() {</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineplus">+  let msgFile = do_get_file(&quot;../../../data/bugmail10&quot;);</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineplus">+</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineplus">+  // Add 1000 messages to the &quot;Inbox&quot; folder.</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineplus">+  for (let i = 0; i &lt; 1000; i++) {</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineplus">+    yield copyFileMessage(msgFile, gInbox, false);</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineplus">+  }</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineplus">+});</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineplus">+</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineplus">+add_task(function testMaildirConversion() {</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineplus">+  let mailstoreContractId = Services.prefs.getCharPref(</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineplus">+    &quot;mail.server.&quot; + gServer.key + &quot;.storeContractID&quot;);</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineplus">+  do_test_pending();</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineplus">+  let pConverted = convertMailStoreTo(mailstoreContractId, gServer,</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineplus">+                                      new EventTarget());</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineplus">+  let originalRootFolder = gServer.rootFolder.filePath;</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineplus">+  pConverted.then(function(aVal) {</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineplus">+    log.debug(&quot;Conversion done: &quot; + originalRootFolder.path + &quot; =&gt; &quot; + aVal);</span>
<a href="#l11.130"></a><span id="l11.130" class="difflineplus">+    let newRootFolder = gServer.rootFolder.filePath;</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineplus">+    checkConversion(originalRootFolder, newRootFolder);</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineplus">+    do_test_finished();</span>
<a href="#l11.133"></a><span id="l11.133" class="difflineplus">+  }).catch(function(aReason) {</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineplus">+    log.error(&quot;Conversion Failed: &quot; + aReason.error);</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineplus">+    ok(false); // Fail the test!</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineplus">+  });</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/base/test/unit/xpcshell.ini</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/base/test/unit/xpcshell.ini</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -15,16 +15,18 @@ support-files = nodelist_test.xml data/*</span>
<a href="#l12.4"></a><span id="l12.4"> [test_bug404489.js]</span>
<a href="#l12.5"></a><span id="l12.5"> [test_bug428427.js]</span>
<a href="#l12.6"></a><span id="l12.6"> [test_bug434810.js]</span>
<a href="#l12.7"></a><span id="l12.7"> [test_bug465805.js]</span>
<a href="#l12.8"></a><span id="l12.8"> [test_bug471682.js]</span>
<a href="#l12.9"></a><span id="l12.9"> [test_bug514945.js]</span>
<a href="#l12.10"></a><span id="l12.10"> [test_compactFailure.js]</span>
<a href="#l12.11"></a><span id="l12.11"> [test_compactColumnSave.js]</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+[test_mailstoreConverter.js]</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+[test_converterDeferredAccount.js]</span>
<a href="#l12.14"></a><span id="l12.14"> [test_copyChaining.js]</span>
<a href="#l12.15"></a><span id="l12.15"> [test_copyThenMoveManual.js]</span>
<a href="#l12.16"></a><span id="l12.16"> [test_copyToInvalidDB.js]</span>
<a href="#l12.17"></a><span id="l12.17"> [test_detachToFile.js]</span>
<a href="#l12.18"></a><span id="l12.18"> [test_emptyTrash.js]</span>
<a href="#l12.19"></a><span id="l12.19"> [test_fix_deferred_accounts.js]</span>
<a href="#l12.20"></a><span id="l12.20"> [test_folderCompact.js]</span>
<a href="#l12.21"></a><span id="l12.21"> [test_folderLookupService.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">new file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- /dev/null</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ b/mailnews/base/util/converterWorker.js</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -0,0 +1,272 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineplus">+</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineplus">+self.importScripts(&quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineplus">+self.addEventListener(&quot;message&quot;, function(e) {</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineplus">+  try {</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+    // {String} sourceFile - path to file or directory encountered.</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+    var sourceFile = e.data[1];</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+    // {String} dest - path to directory in which the new files or directories</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+    // need to be created.</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+    var dest = e.data[0];</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+    // {String} destFile - name of the file or directory encountered.</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+    var destFile = e.data[2];</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineplus">+    var mailstoreContractId = e.data[3];</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+    var tmpDir = e.data[4];</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineplus">+    var serverType = e.data[5];</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineplus">+    var stat = OS.File.stat(sourceFile);</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+    const constNoOfBytes = 10000000;</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineplus">+    if (mailstoreContractId == &quot;@mozilla.org/msgstore/maildirstore;1&quot; &amp;&amp;</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineplus">+        stat.isDir &amp;&amp; sourceFile.substr(-4) != &quot;.sbd&quot;) {</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineplus">+      // Mailstore type is maildir and a maildir msg folder is encountered.</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineplus">+      // Create a directory with path 'dest'.</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+      OS.File.makeDir(dest, {from: tmpDir});</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+      // If the file with path 'dest/destFile' does not exist, create it,</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+      // open it for writing. This is the mbox msg file with the same name as</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+      // 'sourceFile'.</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+      let mboxFile;</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+      if (!OS.File.exists(OS.Path.join(dest,destFile))) {</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+        mboxFile = OS.File.open(OS.Path.join(dest,destFile), {write: true,</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+          create: true}, {});</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+      }</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineplus">+      // If length of 'e.data' is greater than 6, we know that e.data carries</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+      // maildir msg file names.</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+      if (e.data.length &gt; 6) {</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+        for(let msgCount = 0; msgCount &lt; e.data.length - 6; msgCount++) {</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineplus">+          let n = e.data[msgCount + 6];</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+          // Open the file 'sourceFile/cur/msgFile' for reading.</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+          let msgFileOpen = OS.File.open(OS.Path.join(sourceFile, &quot;cur&quot;, n));</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+          mboxFile.write(msgFileOpen.read());</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+          msgFileOpen.close();</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+          // Send a message to &quot;mailstoreConverter.jsm&quot; indicating that a</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+          // msg was copied. This would indicate &quot;progress&quot; for both imap and</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+          // pop accounts if mailstore type is maildir and the no. of</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+          // msgs in the account is greater than zero.</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+          self.postMessage([&quot;copied&quot;, OS.Path.join(sourceFile, &quot;cur&quot;, n)]);</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineplus">+        }</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineplus">+      }</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineplus">+</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineplus">+      mboxFile.close();</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineplus">+      // Send a message to &quot;mailstoreConverter.jsm&quot; indicating that an mbox msg</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineplus">+      // file was created. This would indicate &quot;progress&quot; for both imap and pop</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineplus">+      // accounts if mailstore type is maildir and the no. of messages in</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineplus">+      // the account is 0.</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineplus">+      self.postMessage([&quot;file&quot;, sourceFile, e.data.length]);</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineplus">+</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineplus">+    } else if (stat.isDir) {</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineplus">+      // A directory is encountered. This is a &quot;.sbd&quot; directory.</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineplus">+</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineplus">+      // Create a directory with path 'dest'.</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineplus">+      OS.File.makeDir(dest, {from: tmpDir});</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineplus">+</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineplus">+      // Create a directory with same name as 'sourceFile' in the</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineplus">+      // directory whose path is in 'dest'.</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineplus">+      OS.File.makeDir(OS.Path.join(dest, destFile), {from: tmpDir});</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineplus">+</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineplus">+      // Send message to &quot;mailstoreConverter.jsm&quot; indicating that a directory</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineplus">+      // was created.</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineplus">+      // This would indicate &quot;progress&quot; for an imap account but not for a pop</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineplus">+      // account if the number of messages in the pop account is more than 0 and</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineplus">+      // mailstore type is mbox.</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineplus">+      // This would indicate &quot;progress&quot; for a pop account if the number of</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineplus">+      // messages in the pop account is 0 and the mailstore type is</span>
<a href="#l13.84"></a><span id="l13.84" class="difflineplus">+      // mbox.</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineplus">+      // This would indicate &quot;progress&quot; for pop or imap account if the noumber</span>
<a href="#l13.86"></a><span id="l13.86" class="difflineplus">+      // of messages in the account is 0.</span>
<a href="#l13.87"></a><span id="l13.87" class="difflineplus">+      self.postMessage([&quot;dir&quot;, sourceFile]);</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineplus">+</span>
<a href="#l13.89"></a><span id="l13.89" class="difflineplus">+    } else {</span>
<a href="#l13.90"></a><span id="l13.90" class="difflineplus">+      // If a file is encountered, then if it is a .dat file, copy the</span>
<a href="#l13.91"></a><span id="l13.91" class="difflineplus">+      // file to the directory whose path is in 'dest'.</span>
<a href="#l13.92"></a><span id="l13.92" class="difflineplus">+      // For Local Folders, pop3, and movemail accounts, when the .msf files</span>
<a href="#l13.93"></a><span id="l13.93" class="difflineplus">+      // are copied, something goes wrong with the .msf files and the messages</span>
<a href="#l13.94"></a><span id="l13.94" class="difflineplus">+      // don't show up. Thunderbird automatically creates .msf files. So to</span>
<a href="#l13.95"></a><span id="l13.95" class="difflineplus">+      // resolve this, .msf files are not copied for Local Folders, pop3 and</span>
<a href="#l13.96"></a><span id="l13.96" class="difflineplus">+      // movemail accounts.</span>
<a href="#l13.97"></a><span id="l13.97" class="difflineplus">+      let ext = sourceFile.substr(-4);</span>
<a href="#l13.98"></a><span id="l13.98" class="difflineplus">+      if ((ext == &quot;.msf&quot;) || (ext == &quot;.dat&quot;)) {</span>
<a href="#l13.99"></a><span id="l13.99" class="difflineplus">+        if (ext == &quot;.dat&quot; || (serverType == &quot;imap&quot; || serverType == &quot;nntp&quot;)) {</span>
<a href="#l13.100"></a><span id="l13.100" class="difflineplus">+          // If the directory with path 'dest' does not exist, create it.</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineplus">+          if (!OS.File.exists(dest)) {</span>
<a href="#l13.102"></a><span id="l13.102" class="difflineplus">+            OS.File.makeDir(dest, {from: tmpDir});</span>
<a href="#l13.103"></a><span id="l13.103" class="difflineplus">+          }</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineplus">+          OS.File.copy(sourceFile, OS.Path.join(dest,destFile));</span>
<a href="#l13.105"></a><span id="l13.105" class="difflineplus">+        }</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineplus">+</span>
<a href="#l13.107"></a><span id="l13.107" class="difflineplus">+        // Send a message to &quot;mailstoreConverter.jsm&quot; indicating that a .msf or</span>
<a href="#l13.108"></a><span id="l13.108" class="difflineplus">+        // .dat file was copied.</span>
<a href="#l13.109"></a><span id="l13.109" class="difflineplus">+        // This is used to indicate progress on IMAP accounts if mailstore</span>
<a href="#l13.110"></a><span id="l13.110" class="difflineplus">+        // type is mbox.</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineplus">+        // This is used to indicate progress on pop accounts if the no. of msgs</span>
<a href="#l13.112"></a><span id="l13.112" class="difflineplus">+        // in the account is 0 and mailstore type is mbox.</span>
<a href="#l13.113"></a><span id="l13.113" class="difflineplus">+        // This is used to indicate progress on pop and imap accounts if the</span>
<a href="#l13.114"></a><span id="l13.114" class="difflineplus">+        // no. of msgs in the account is 0 and mailstore type is maildir.</span>
<a href="#l13.115"></a><span id="l13.115" class="difflineplus">+        self.postMessage([&quot;msfdat&quot;, sourceFile]);</span>
<a href="#l13.116"></a><span id="l13.116" class="difflineplus">+</span>
<a href="#l13.117"></a><span id="l13.117" class="difflineplus">+      } else if (mailstoreContractId != &quot;@mozilla.org/msgstore/maildirstore;1&quot;) {</span>
<a href="#l13.118"></a><span id="l13.118" class="difflineplus">+        // An mbox message file is encountered.</span>
<a href="#l13.119"></a><span id="l13.119" class="difflineplus">+</span>
<a href="#l13.120"></a><span id="l13.120" class="difflineplus">+        // Create a directory with path 'dest'.</span>
<a href="#l13.121"></a><span id="l13.121" class="difflineplus">+        OS.File.makeDir(dest, {from: tmpDir});</span>
<a href="#l13.122"></a><span id="l13.122" class="difflineplus">+</span>
<a href="#l13.123"></a><span id="l13.123" class="difflineplus">+        // Create a directory with same name as the file encountered in the</span>
<a href="#l13.124"></a><span id="l13.124" class="difflineplus">+        // directory with path 'dest'.</span>
<a href="#l13.125"></a><span id="l13.125" class="difflineplus">+        // In this directory create a directory with name &quot;cur&quot; and a directory</span>
<a href="#l13.126"></a><span id="l13.126" class="difflineplus">+        // with name &quot;tmp&quot;.</span>
<a href="#l13.127"></a><span id="l13.127" class="difflineplus">+        OS.File.makeDir(OS.Path.join(dest, destFile));</span>
<a href="#l13.128"></a><span id="l13.128" class="difflineplus">+        OS.File.makeDir(OS.Path.join(dest, destFile, &quot;cur&quot;));</span>
<a href="#l13.129"></a><span id="l13.129" class="difflineplus">+        OS.File.makeDir(OS.Path.join(dest, destFile, &quot;tmp&quot;));</span>
<a href="#l13.130"></a><span id="l13.130" class="difflineplus">+</span>
<a href="#l13.131"></a><span id="l13.131" class="difflineplus">+        let decoder = new TextDecoder();</span>
<a href="#l13.132"></a><span id="l13.132" class="difflineplus">+        let encoder = new TextEncoder();</span>
<a href="#l13.133"></a><span id="l13.133" class="difflineplus">+</span>
<a href="#l13.134"></a><span id="l13.134" class="difflineplus">+        // File to which the message is to be copied.</span>
<a href="#l13.135"></a><span id="l13.135" class="difflineplus">+        let targetFile = null;</span>
<a href="#l13.136"></a><span id="l13.136" class="difflineplus">+        // Get a timestamp for file name.</span>
<a href="#l13.137"></a><span id="l13.137" class="difflineplus">+        let name = Date.now();</span>
<a href="#l13.138"></a><span id="l13.138" class="difflineplus">+        // No. of bytes to be read from the source file.</span>
<a href="#l13.139"></a><span id="l13.139" class="difflineplus">+        // Needs to be a large size to read in chunks.</span>
<a href="#l13.140"></a><span id="l13.140" class="difflineplus">+        let noOfBytes = constNoOfBytes;</span>
<a href="#l13.141"></a><span id="l13.141" class="difflineplus">+        // 'text' holds the string that was read.</span>
<a href="#l13.142"></a><span id="l13.142" class="difflineplus">+        let text = null;</span>
<a href="#l13.143"></a><span id="l13.143" class="difflineplus">+        // Index of last match in 'text'.</span>
<a href="#l13.144"></a><span id="l13.144" class="difflineplus">+        let lastMatchIndex;</span>
<a href="#l13.145"></a><span id="l13.145" class="difflineplus">+        // Current position in the source file before reading bytes from it.</span>
<a href="#l13.146"></a><span id="l13.146" class="difflineplus">+        let position;</span>
<a href="#l13.147"></a><span id="l13.147" class="difflineplus">+        // New position in the source file after reading bytes from it.</span>
<a href="#l13.148"></a><span id="l13.148" class="difflineplus">+        let nextPos;</span>
<a href="#l13.149"></a><span id="l13.149" class="difflineplus">+        // New length of the text read from source file.</span>
<a href="#l13.150"></a><span id="l13.150" class="difflineplus">+        let nextLen;</span>
<a href="#l13.151"></a><span id="l13.151" class="difflineplus">+        // Position in the file after reading the bytes in the previous</span>
<a href="#l13.152"></a><span id="l13.152" class="difflineplus">+        // iteration.</span>
<a href="#l13.153"></a><span id="l13.153" class="difflineplus">+        let prevPos = 0;</span>
<a href="#l13.154"></a><span id="l13.154" class="difflineplus">+        // Length of the text read from source file in the previous</span>
<a href="#l13.155"></a><span id="l13.155" class="difflineplus">+        // iteration.</span>
<a href="#l13.156"></a><span id="l13.156" class="difflineplus">+        let prevLen = 0;</span>
<a href="#l13.157"></a><span id="l13.157" class="difflineplus">+        // Bytes read from the source file are decoded into a string and</span>
<a href="#l13.158"></a><span id="l13.158" class="difflineplus">+        // assigned to 'textNew'.</span>
<a href="#l13.159"></a><span id="l13.159" class="difflineplus">+        let textNew;</span>
<a href="#l13.160"></a><span id="l13.160" class="difflineplus">+</span>
<a href="#l13.161"></a><span id="l13.161" class="difflineplus">+        // Read the file. Since the files can be large, we read it in chunks.</span>
<a href="#l13.162"></a><span id="l13.162" class="difflineplus">+        let sourceFileOpen = OS.File.open(sourceFile);</span>
<a href="#l13.163"></a><span id="l13.163" class="difflineplus">+        while (true) {</span>
<a href="#l13.164"></a><span id="l13.164" class="difflineplus">+          position = sourceFileOpen.getPosition();</span>
<a href="#l13.165"></a><span id="l13.165" class="difflineplus">+          let array = sourceFileOpen.read(noOfBytes);</span>
<a href="#l13.166"></a><span id="l13.166" class="difflineplus">+          textNew = decoder.decode(array);</span>
<a href="#l13.167"></a><span id="l13.167" class="difflineplus">+          nextPos = sourceFileOpen.getPosition();</span>
<a href="#l13.168"></a><span id="l13.168" class="difflineplus">+          nextLen = textNew.length;</span>
<a href="#l13.169"></a><span id="l13.169" class="difflineplus">+</span>
<a href="#l13.170"></a><span id="l13.170" class="difflineplus">+          if (nextPos == prevPos &amp;&amp; nextLen == prevLen) {</span>
<a href="#l13.171"></a><span id="l13.171" class="difflineplus">+            // Reached the last message in the source file.</span>
<a href="#l13.172"></a><span id="l13.172" class="difflineplus">+            if (text !== null) {</span>
<a href="#l13.173"></a><span id="l13.173" class="difflineplus">+              // Array to hold indices of &quot;From -&quot; matches found within 'text'.</span>
<a href="#l13.174"></a><span id="l13.174" class="difflineplus">+              let lastPos = [];</span>
<a href="#l13.175"></a><span id="l13.175" class="difflineplus">+              // Regular expression to find &quot;From - &quot; at beginning of lines.</span>
<a href="#l13.176"></a><span id="l13.176" class="difflineplus">+              let regexpLast = /^(From - )/gm;</span>
<a href="#l13.177"></a><span id="l13.177" class="difflineplus">+              let resultLast = regexpLast.exec(text);</span>
<a href="#l13.178"></a><span id="l13.178" class="difflineplus">+              while (resultLast !== null) {</span>
<a href="#l13.179"></a><span id="l13.179" class="difflineplus">+                lastPos[lastPos.length] = resultLast.index;</span>
<a href="#l13.180"></a><span id="l13.180" class="difflineplus">+                resultLast = regexpLast.exec(text);</span>
<a href="#l13.181"></a><span id="l13.181" class="difflineplus">+              }</span>
<a href="#l13.182"></a><span id="l13.182" class="difflineplus">+</span>
<a href="#l13.183"></a><span id="l13.183" class="difflineplus">+              // Create a maildir message file in 'dest/destFile/cur/'</span>
<a href="#l13.184"></a><span id="l13.184" class="difflineplus">+              // and open it for writing.</span>
<a href="#l13.185"></a><span id="l13.185" class="difflineplus">+              targetFile = OS.File.open(OS.Path.join(dest, destFile, &quot;cur&quot;,</span>
<a href="#l13.186"></a><span id="l13.186" class="difflineplus">+                name.toString()), {write: true, create: true}, {});</span>
<a href="#l13.187"></a><span id="l13.187" class="difflineplus">+</span>
<a href="#l13.188"></a><span id="l13.188" class="difflineplus">+              // Extract the text in 'text' between 'lastPos[0]' ie the</span>
<a href="#l13.189"></a><span id="l13.189" class="difflineplus">+              // index of the first &quot;From - &quot; match and the end of 'text'.</span>
<a href="#l13.190"></a><span id="l13.190" class="difflineplus">+              targetFile.write(encoder.encode(text.substring(lastPos[0],</span>
<a href="#l13.191"></a><span id="l13.191" class="difflineplus">+                text.length)));</span>
<a href="#l13.192"></a><span id="l13.192" class="difflineplus">+              targetFile.close();</span>
<a href="#l13.193"></a><span id="l13.193" class="difflineplus">+</span>
<a href="#l13.194"></a><span id="l13.194" class="difflineplus">+              // Send a message indicating that a message was copied.</span>
<a href="#l13.195"></a><span id="l13.195" class="difflineplus">+              // This indicates progress for a pop account if the no. of msgs</span>
<a href="#l13.196"></a><span id="l13.196" class="difflineplus">+              // in the account is more than 0 and mailstore type is mbox.</span>
<a href="#l13.197"></a><span id="l13.197" class="difflineplus">+              self.postMessage([&quot;copied&quot;, name, position]);</span>
<a href="#l13.198"></a><span id="l13.198" class="difflineplus">+            }</span>
<a href="#l13.199"></a><span id="l13.199" class="difflineplus">+</span>
<a href="#l13.200"></a><span id="l13.200" class="difflineplus">+            break;</span>
<a href="#l13.201"></a><span id="l13.201" class="difflineplus">+          }  else {</span>
<a href="#l13.202"></a><span id="l13.202" class="difflineplus">+            // We might have more messages in the source file.</span>
<a href="#l13.203"></a><span id="l13.203" class="difflineplus">+            prevPos = nextPos;</span>
<a href="#l13.204"></a><span id="l13.204" class="difflineplus">+            prevLen = nextLen;</span>
<a href="#l13.205"></a><span id="l13.205" class="difflineplus">+            text = textNew;</span>
<a href="#l13.206"></a><span id="l13.206" class="difflineplus">+          }</span>
<a href="#l13.207"></a><span id="l13.207" class="difflineplus">+</span>
<a href="#l13.208"></a><span id="l13.208" class="difflineplus">+          // Array to hold indices of &quot;From -&quot; matches found within 'text'.</span>
<a href="#l13.209"></a><span id="l13.209" class="difflineplus">+          let msgPos = [];</span>
<a href="#l13.210"></a><span id="l13.210" class="difflineplus">+          // Regular expression to find &quot;From - &quot; at beginning of lines.</span>
<a href="#l13.211"></a><span id="l13.211" class="difflineplus">+          let regexp = /^(From - )/gm;</span>
<a href="#l13.212"></a><span id="l13.212" class="difflineplus">+          let result = regexp.exec(text);</span>
<a href="#l13.213"></a><span id="l13.213" class="difflineplus">+          while (result !== null) {</span>
<a href="#l13.214"></a><span id="l13.214" class="difflineplus">+            msgPos[msgPos.length] = result.index;</span>
<a href="#l13.215"></a><span id="l13.215" class="difflineplus">+            result = regexp.exec(text);</span>
<a href="#l13.216"></a><span id="l13.216" class="difflineplus">+          }</span>
<a href="#l13.217"></a><span id="l13.217" class="difflineplus">+</span>
<a href="#l13.218"></a><span id="l13.218" class="difflineplus">+          if (msgPos.length &gt; 1) {</span>
<a href="#l13.219"></a><span id="l13.219" class="difflineplus">+            // More than one &quot;From - &quot; match is found.</span>
<a href="#l13.220"></a><span id="l13.220" class="difflineplus">+            noOfBytes = constNoOfBytes;</span>
<a href="#l13.221"></a><span id="l13.221" class="difflineplus">+            for (let i = 0; i &lt; msgPos.length - 1; i++) {</span>
<a href="#l13.222"></a><span id="l13.222" class="difflineplus">+              // Create and open a new file in 'dest/destFile/cur'</span>
<a href="#l13.223"></a><span id="l13.223" class="difflineplus">+              // to hold the next mail.</span>
<a href="#l13.224"></a><span id="l13.224" class="difflineplus">+              targetFile = OS.File.open(OS.Path.join(dest, destFile, &quot;cur&quot;,</span>
<a href="#l13.225"></a><span id="l13.225" class="difflineplus">+                name.toString()), {write: true, create: true}, {});</span>
<a href="#l13.226"></a><span id="l13.226" class="difflineplus">+              // Extract the text lying between consecutive indices, encode</span>
<a href="#l13.227"></a><span id="l13.227" class="difflineplus">+              // it and write it.</span>
<a href="#l13.228"></a><span id="l13.228" class="difflineplus">+              targetFile.write(encoder.encode(text.substring(msgPos[i],</span>
<a href="#l13.229"></a><span id="l13.229" class="difflineplus">+                msgPos[i + 1])));</span>
<a href="#l13.230"></a><span id="l13.230" class="difflineplus">+              targetFile.close();</span>
<a href="#l13.231"></a><span id="l13.231" class="difflineplus">+</span>
<a href="#l13.232"></a><span id="l13.232" class="difflineplus">+              // Send a message indicating that a mail was copied.</span>
<a href="#l13.233"></a><span id="l13.233" class="difflineplus">+              // This indicates progress for a pop account if the no. of msgs</span>
<a href="#l13.234"></a><span id="l13.234" class="difflineplus">+              // in the account is more than 0 and mailstore type is mbox.</span>
<a href="#l13.235"></a><span id="l13.235" class="difflineplus">+              self.postMessage([&quot;copied&quot;, name, position + msgPos[i],</span>
<a href="#l13.236"></a><span id="l13.236" class="difflineplus">+                position + msgPos[i + 1]]);</span>
<a href="#l13.237"></a><span id="l13.237" class="difflineplus">+</span>
<a href="#l13.238"></a><span id="l13.238" class="difflineplus">+              // Increment 'name' to get a new file name.</span>
<a href="#l13.239"></a><span id="l13.239" class="difflineplus">+              // Cannot use Date.now() because it is possible to get the</span>
<a href="#l13.240"></a><span id="l13.240" class="difflineplus">+              // same timestamp as before.</span>
<a href="#l13.241"></a><span id="l13.241" class="difflineplus">+              name++;</span>
<a href="#l13.242"></a><span id="l13.242" class="difflineplus">+</span>
<a href="#l13.243"></a><span id="l13.243" class="difflineplus">+              // Set index of the (i+1)th &quot;From - &quot; match found in 'text'.</span>
<a href="#l13.244"></a><span id="l13.244" class="difflineplus">+              lastMatchIndex = msgPos[i + 1];</span>
<a href="#l13.245"></a><span id="l13.245" class="difflineplus">+            }</span>
<a href="#l13.246"></a><span id="l13.246" class="difflineplus">+</span>
<a href="#l13.247"></a><span id="l13.247" class="difflineplus">+            // Now 'lastMatchIndex' holds the index of the last match found in</span>
<a href="#l13.248"></a><span id="l13.248" class="difflineplus">+            // 'text'. So we move the position in the file to 'position +</span>
<a href="#l13.249"></a><span id="l13.249" class="difflineplus">+            // lastMatchIndex' from the beginning of the file.</span>
<a href="#l13.250"></a><span id="l13.250" class="difflineplus">+            // This ensures that the next 'text' starts from &quot;From - &quot;</span>
<a href="#l13.251"></a><span id="l13.251" class="difflineplus">+            // and that there is at least 1 match everytime.</span>
<a href="#l13.252"></a><span id="l13.252" class="difflineplus">+            sourceFileOpen.setPosition(position + lastMatchIndex,</span>
<a href="#l13.253"></a><span id="l13.253" class="difflineplus">+              OS.File.POS_START);</span>
<a href="#l13.254"></a><span id="l13.254" class="difflineplus">+          } else {</span>
<a href="#l13.255"></a><span id="l13.255" class="difflineplus">+            // If 1 match is found increase the no. of bytes to be extracted by</span>
<a href="#l13.256"></a><span id="l13.256" class="difflineplus">+            // 1000000 and move the position in the file to 'position', i.e. the</span>
<a href="#l13.257"></a><span id="l13.257" class="difflineplus">+            // position in the file before reading the bytes.</span>
<a href="#l13.258"></a><span id="l13.258" class="difflineplus">+            sourceFileOpen.setPosition(position, OS.File.POS_START);</span>
<a href="#l13.259"></a><span id="l13.259" class="difflineplus">+            noOfBytes = noOfBytes + 1000000;</span>
<a href="#l13.260"></a><span id="l13.260" class="difflineplus">+          }</span>
<a href="#l13.261"></a><span id="l13.261" class="difflineplus">+        }</span>
<a href="#l13.262"></a><span id="l13.262" class="difflineplus">+</span>
<a href="#l13.263"></a><span id="l13.263" class="difflineplus">+        // Send a message indicating that a message file was encountered.</span>
<a href="#l13.264"></a><span id="l13.264" class="difflineplus">+        // This indicates progress for an imap account if mailstore type is</span>
<a href="#l13.265"></a><span id="l13.265" class="difflineplus">+        // mbox.</span>
<a href="#l13.266"></a><span id="l13.266" class="difflineplus">+        // This indicates progress for a pop account if mailstore type is</span>
<a href="#l13.267"></a><span id="l13.267" class="difflineplus">+        // mbox and the no. of msgs in the account is 0.</span>
<a href="#l13.268"></a><span id="l13.268" class="difflineplus">+        self.postMessage([&quot;file&quot;, sourceFile, textNew.length]);</span>
<a href="#l13.269"></a><span id="l13.269" class="difflineplus">+      }</span>
<a href="#l13.270"></a><span id="l13.270" class="difflineplus">+    }</span>
<a href="#l13.271"></a><span id="l13.271" class="difflineplus">+  } catch (e) {</span>
<a href="#l13.272"></a><span id="l13.272" class="difflineplus">+    // We try-catch the error because otherwise the error from File.OS is</span>
<a href="#l13.273"></a><span id="l13.273" class="difflineplus">+    // not properly propagated back to the worker error handling.</span>
<a href="#l13.274"></a><span id="l13.274" class="difflineplus">+    throw new Error(e);</span>
<a href="#l13.275"></a><span id="l13.275" class="difflineplus">+  }</span>
<a href="#l13.276"></a><span id="l13.276" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">new file mode 100644</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineminus">--- /dev/null</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineplus">+++ b/mailnews/base/util/mailstoreConverter.jsm</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineat">@@ -0,0 +1,512 @@</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l14.7"></a><span id="l14.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineplus">+</span>
<a href="#l14.9"></a><span id="l14.9" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;convertMailStoreTo&quot;, &quot;terminateWorkers&quot;];</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineplus">+</span>
<a href="#l14.11"></a><span id="l14.11" class="difflineplus">+ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+ChromeUtils.import(&quot;resource:///modules/MailUtils.js&quot;);</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+ChromeUtils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/FileUtils.jsm&quot;);</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/Log.jsm&quot;);</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineplus">+</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineplus">+var log = Log.repository.getLogger(&quot;MailStoreConverter&quot;);</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineplus">+log.level = Log.Level.Debug;</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineplus">+log.addAppender(new Log.DumpAppender(new Log.BasicFormatter()));</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineplus">+</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineplus">+// Array to hold workers.</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineplus">+var gConverterWorkerArray = [];</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineplus">+</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineplus">+/**</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+ * Creates &quot;Converter&quot; folder in tmp dir, moves the folder hierarchy of the</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineplus">+ * account root folder creating the same folder hierarchy in Converter</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+ * folder in tmp dir, copies the .msf and .dat files to proper places in</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+ * Converter folder, parses the mbox files and creates corresponding folders</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+ * and maildir files in proper places in &quot;Converter&quot; folder and returns a</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+ * promise.</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+ * @param aMailstoreContractId          - account mailstore contract id</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+ * @param {nsIMsgIncominserver} aServer - server for the account</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+ * @param aEventTarget                  - target on which the &quot;progress&quot;</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+ *                                        event will be dispatched</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+ * @return {Promise}                    - new root folder path of the converted</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+ *                                        server.</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+ */</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+function convertMailStoreTo(aMailstoreContractId, aServer, aEventTarget) {</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+  // {nsIMsgfolder} account root folder.</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+  var accountRootFolder = aServer.rootFolder.filePath;</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineplus">+  // {nsIFile} tmp dir.</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+  var tmpDir = FileUtils.getDir(&quot;TmpD&quot;, [], false);</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+  // Array to hold path to the Converter folder in tmp dir.</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineplus">+  var pathArray;</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineplus">+  // No. of messages that have been copied in case of a pop account, movemail</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+  // account, Local Folders account or any account with maildir mailstore type</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+  // having at least 1 message.</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+  // No. of files and folders that have been copied in case of a pop account,</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+  // movemail account, Local Folders account or any account with maildir</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+  // mailstore type having 0 messages.</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+  // No. of files and folders that have been copied in case of an imap account</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+  // or an nntp account.</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineplus">+  var progressValue = 0;</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineplus">+  // No. of files and folders in original account root folder for imap account</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineplus">+  // if mailstore type is mbox, or an nntp account.</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineplus">+  // No. of files and folders in original account root folder for a pop</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+  // account, Local Folders account or movemail account if no. of msgs is 0</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineplus">+  // and mailstore type is mbox.</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineplus">+  // No. of files and folders in any non nntp account if no. of msgs is</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineplus">+  // 0 and mailstore type is maildir.</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineplus">+  // No. of messages in a pop account, Local Folders account or movemail</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineplus">+  // account if no. of msgs is more than 0 and mailstore type is mbox.</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+  // No. of messages in any non nntp account if no. of msgs is more than 0 and</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+  // mailstore type is maildir.</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineplus">+  var count = 0;</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineplus">+  // If there are zero msgs in the account &quot;zeroMessages&quot; is true else it is</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+  // false.</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+  var zeroMessages = false;</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineplus">+  // No. of files and folders in original account root folder for imap account.</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineplus">+  // We use a progress bar to show the status of the conversion process.</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineplus">+  // So, we need a value as the maximum value of the progress bar to measure the</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineplus">+  // progress.</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineplus">+  // During the conversion there are three kinds of files or folders that can be</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineplus">+  // encountered.</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineplus">+  // 1. A directory - This simply requires a directory to be created in the right</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineplus">+  //                  place. So this a single step.</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineplus">+  // 2. A .msf or a .dat file - This simply requires the file to be copied to the</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineplus">+  //                            right place. This too is a single step.</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineplus">+  // 3. A message file - A message file contains several messages and each one</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineplus">+  //                     needs to be copied to a separate file in the right</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineplus">+  //                     place. So parsing a parsing a message file consists of</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineplus">+  //                     several steps.</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineplus">+  //</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineplus">+  // So, it's the parsing of message files that is actually time consuming and</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineplus">+  // dealing with a directory, .msf, .dat file takes very little time.</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineplus">+  //</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineplus">+  // So it makes more sense to measure progress as the no. of messages copied.</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineplus">+  // But for an imap account, getTotalMessages(true) does not give the no. of</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineplus">+  // messages actually present in the account root folder, but gives the no. of</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineplus">+  // messages shown on Thunderbird which is less than the no. of messages</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineplus">+  // actually present in the account root folder. So can't use that.</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineplus">+  //</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineplus">+  // But we still need a way to measure progress for an imap account.</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineplus">+  // So we measure progress by the total no. of files and folders in the account</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineplus">+  // root folder and we increment the value of the progress bar every time a</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineplus">+  // .msf, .dat, or a message file or a directory is encountered during</span>
<a href="#l14.100"></a><span id="l14.100" class="difflineplus">+  // conversion.</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineplus">+</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineplus">+  /**</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineplus">+   * Count no. of files and folders in the account root folder for imap</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineplus">+   * accounts.</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineplus">+   * @param {nsIMsgFolder} aFolder - account root folder.</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineplus">+   */</span>
<a href="#l14.107"></a><span id="l14.107" class="difflineplus">+  var countImapFileFolders = function(aFolder) {</span>
<a href="#l14.108"></a><span id="l14.108" class="difflineplus">+    var count = 0;</span>
<a href="#l14.109"></a><span id="l14.109" class="difflineplus">+    var contents = aFolder.directoryEntries;</span>
<a href="#l14.110"></a><span id="l14.110" class="difflineplus">+    while (contents.hasMoreElements()) {</span>
<a href="#l14.111"></a><span id="l14.111" class="difflineplus">+      var content = contents.getNext()</span>
<a href="#l14.112"></a><span id="l14.112" class="difflineplus">+                            .QueryInterface(Ci.nsIFile);</span>
<a href="#l14.113"></a><span id="l14.113" class="difflineplus">+      if (content.isDirectory()) {</span>
<a href="#l14.114"></a><span id="l14.114" class="difflineplus">+        count = count + 1 + countImapFileFolders(content);</span>
<a href="#l14.115"></a><span id="l14.115" class="difflineplus">+      } else {</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineplus">+        count++;</span>
<a href="#l14.117"></a><span id="l14.117" class="difflineplus">+      }</span>
<a href="#l14.118"></a><span id="l14.118" class="difflineplus">+    }</span>
<a href="#l14.119"></a><span id="l14.119" class="difflineplus">+    return count;</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineplus">+  }</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineplus">+</span>
<a href="#l14.122"></a><span id="l14.122" class="difflineplus">+  /**</span>
<a href="#l14.123"></a><span id="l14.123" class="difflineplus">+   * Count the no. of msgs in account root folder if the mailstore type is</span>
<a href="#l14.124"></a><span id="l14.124" class="difflineplus">+   * maildir.</span>
<a href="#l14.125"></a><span id="l14.125" class="difflineplus">+   * @param {nsIMsgFolder} aFolder - account root folder.</span>
<a href="#l14.126"></a><span id="l14.126" class="difflineplus">+   */</span>
<a href="#l14.127"></a><span id="l14.127" class="difflineplus">+  var countMaildirMsgs = function(aFolder) {</span>
<a href="#l14.128"></a><span id="l14.128" class="difflineplus">+    var count = 0;</span>
<a href="#l14.129"></a><span id="l14.129" class="difflineplus">+    var contents = aFolder.directoryEntries;</span>
<a href="#l14.130"></a><span id="l14.130" class="difflineplus">+    while (contents.hasMoreElements()) {</span>
<a href="#l14.131"></a><span id="l14.131" class="difflineplus">+      var content = contents.getNext().QueryInterface(Ci.nsIFile);</span>
<a href="#l14.132"></a><span id="l14.132" class="difflineplus">+      if (content.isDirectory() &amp;&amp; content.leafName.substr(-4) != &quot;.sbd&quot;) {</span>
<a href="#l14.133"></a><span id="l14.133" class="difflineplus">+        var cur = FileUtils.File(OS.Path.join(content.path,&quot;cur&quot;));</span>
<a href="#l14.134"></a><span id="l14.134" class="difflineplus">+        var curContents = cur.directoryEntries;</span>
<a href="#l14.135"></a><span id="l14.135" class="difflineplus">+        while (curContents.hasMoreElements()) {</span>
<a href="#l14.136"></a><span id="l14.136" class="difflineplus">+          curContents.getNext();</span>
<a href="#l14.137"></a><span id="l14.137" class="difflineplus">+          count++;</span>
<a href="#l14.138"></a><span id="l14.138" class="difflineplus">+        }</span>
<a href="#l14.139"></a><span id="l14.139" class="difflineplus">+      } else if (content.isDirectory()) {</span>
<a href="#l14.140"></a><span id="l14.140" class="difflineplus">+        count = count + countMaildirMsgs(content);</span>
<a href="#l14.141"></a><span id="l14.141" class="difflineplus">+      }</span>
<a href="#l14.142"></a><span id="l14.142" class="difflineplus">+    }</span>
<a href="#l14.143"></a><span id="l14.143" class="difflineplus">+    return count;</span>
<a href="#l14.144"></a><span id="l14.144" class="difflineplus">+  }</span>
<a href="#l14.145"></a><span id="l14.145" class="difflineplus">+</span>
<a href="#l14.146"></a><span id="l14.146" class="difflineplus">+  /**</span>
<a href="#l14.147"></a><span id="l14.147" class="difflineplus">+   * Count the no. of files and folders in account root folder if the mailstore</span>
<a href="#l14.148"></a><span id="l14.148" class="difflineplus">+   * type is maildir and the no. of msgs in the account is 0.</span>
<a href="#l14.149"></a><span id="l14.149" class="difflineplus">+   * @param {nsIMsgFolder} aFolder - account root folder.</span>
<a href="#l14.150"></a><span id="l14.150" class="difflineplus">+   */</span>
<a href="#l14.151"></a><span id="l14.151" class="difflineplus">+  var countMaildirZeroMsgs = function(aFolder) {</span>
<a href="#l14.152"></a><span id="l14.152" class="difflineplus">+    var count = 0;</span>
<a href="#l14.153"></a><span id="l14.153" class="difflineplus">+    var contents = aFolder.directoryEntries;</span>
<a href="#l14.154"></a><span id="l14.154" class="difflineplus">+    while (contents.hasMoreElements()) {</span>
<a href="#l14.155"></a><span id="l14.155" class="difflineplus">+      var content = contents.getNext().QueryInterface(Ci.nsIFile);</span>
<a href="#l14.156"></a><span id="l14.156" class="difflineplus">+      // Count maildir msg folders as 1 and don't count &quot;cur&quot; and &quot;tmp&quot;</span>
<a href="#l14.157"></a><span id="l14.157" class="difflineplus">+      // folders.</span>
<a href="#l14.158"></a><span id="l14.158" class="difflineplus">+      if ((content.isDirectory() &amp;&amp; content.leafName.substr(-4) != &quot;.sbd&quot;) ||</span>
<a href="#l14.159"></a><span id="l14.159" class="difflineplus">+            !content.isDirectory()) {</span>
<a href="#l14.160"></a><span id="l14.160" class="difflineplus">+        count++;</span>
<a href="#l14.161"></a><span id="l14.161" class="difflineplus">+      } else if (content.isDirectory()) {</span>
<a href="#l14.162"></a><span id="l14.162" class="difflineplus">+        count = count + 1 + countMaildirMsgs(content);</span>
<a href="#l14.163"></a><span id="l14.163" class="difflineplus">+      }</span>
<a href="#l14.164"></a><span id="l14.164" class="difflineplus">+    }</span>
<a href="#l14.165"></a><span id="l14.165" class="difflineplus">+    return count;</span>
<a href="#l14.166"></a><span id="l14.166" class="difflineplus">+  }</span>
<a href="#l14.167"></a><span id="l14.167" class="difflineplus">+</span>
<a href="#l14.168"></a><span id="l14.168" class="difflineplus">+  var isMaildir = (aMailstoreContractId == &quot;@mozilla.org/msgstore/maildirstore;1&quot;);</span>
<a href="#l14.169"></a><span id="l14.169" class="difflineplus">+</span>
<a href="#l14.170"></a><span id="l14.170" class="difflineplus">+  var conversionOk; // Resolve callback function.</span>
<a href="#l14.171"></a><span id="l14.171" class="difflineplus">+  var conversionFailed; // Reject callback function.</span>
<a href="#l14.172"></a><span id="l14.172" class="difflineplus">+</span>
<a href="#l14.173"></a><span id="l14.173" class="difflineplus">+  /**</span>
<a href="#l14.174"></a><span id="l14.174" class="difflineplus">+   * Moves the folder hierarchy of the account root folder creating the same</span>
<a href="#l14.175"></a><span id="l14.175" class="difflineplus">+   * folder hierarchy in Converter folder in tmp dir, copies the .msf</span>
<a href="#l14.176"></a><span id="l14.176" class="difflineplus">+   * and .dat files to proper places in Converter folder, parses the mbox</span>
<a href="#l14.177"></a><span id="l14.177" class="difflineplus">+   * files and creates corresponding folders and maildir files in proper</span>
<a href="#l14.178"></a><span id="l14.178" class="difflineplus">+   * places in &quot;Converter&quot; folder and resolves the promise returned by</span>
<a href="#l14.179"></a><span id="l14.179" class="difflineplus">+   * convertmailStoreTo().</span>
<a href="#l14.180"></a><span id="l14.180" class="difflineplus">+   *</span>
<a href="#l14.181"></a><span id="l14.181" class="difflineplus">+   * @param {nsIFile} aFolder   - account root folder. Folder from where the</span>
<a href="#l14.182"></a><span id="l14.182" class="difflineplus">+   *                              files and directories are to be migrated.</span>
<a href="#l14.183"></a><span id="l14.183" class="difflineplus">+   * @param {nsIFile} aDestPath - &quot;Converter&quot; folder. Folder into which the</span>
<a href="#l14.184"></a><span id="l14.184" class="difflineplus">+   *                              files directories are to be migrated.</span>
<a href="#l14.185"></a><span id="l14.185" class="difflineplus">+   */</span>
<a href="#l14.186"></a><span id="l14.186" class="difflineplus">+  var subDir = function(aFolder, aDestPath) {</span>
<a href="#l14.187"></a><span id="l14.187" class="difflineplus">+    let contents = aFolder.directoryEntries;</span>
<a href="#l14.188"></a><span id="l14.188" class="difflineplus">+    while (contents.hasMoreElements()) {</span>
<a href="#l14.189"></a><span id="l14.189" class="difflineplus">+      let content = contents.getNext()</span>
<a href="#l14.190"></a><span id="l14.190" class="difflineplus">+                            .QueryInterface(Ci.nsIFile);</span>
<a href="#l14.191"></a><span id="l14.191" class="difflineplus">+      let converterWorker = new ChromeWorker(</span>
<a href="#l14.192"></a><span id="l14.192" class="difflineplus">+        &quot;resource:///modules/converterWorker.js&quot;);</span>
<a href="#l14.193"></a><span id="l14.193" class="difflineplus">+      gConverterWorkerArray.push(converterWorker);</span>
<a href="#l14.194"></a><span id="l14.194" class="difflineplus">+      log.debug(&quot;Processing &quot; + content.path + &quot; =&gt; : &quot; + aDestPath.path +</span>
<a href="#l14.195"></a><span id="l14.195" class="difflineplus">+                &quot; - &quot;+ count + &quot;items&quot;);</span>
<a href="#l14.196"></a><span id="l14.196" class="difflineplus">+</span>
<a href="#l14.197"></a><span id="l14.197" class="difflineplus">+      // Data to be passed to the worker. Initially &quot;dataArray&quot; contains</span>
<a href="#l14.198"></a><span id="l14.198" class="difflineplus">+      // path of the directory in which the files and directories are to be</span>
<a href="#l14.199"></a><span id="l14.199" class="difflineplus">+      // migrated, path of the file or directory encountered, name of the file</span>
<a href="#l14.200"></a><span id="l14.200" class="difflineplus">+      // or directory encountered and the mailstore type, path of tmp dir,</span>
<a href="#l14.201"></a><span id="l14.201" class="difflineplus">+      // server type.</span>
<a href="#l14.202"></a><span id="l14.202" class="difflineplus">+      let dataArray = [</span>
<a href="#l14.203"></a><span id="l14.203" class="difflineplus">+        aDestPath.path,</span>
<a href="#l14.204"></a><span id="l14.204" class="difflineplus">+        content.path,</span>
<a href="#l14.205"></a><span id="l14.205" class="difflineplus">+        content.leafName,</span>
<a href="#l14.206"></a><span id="l14.206" class="difflineplus">+        aMailstoreContractId,</span>
<a href="#l14.207"></a><span id="l14.207" class="difflineplus">+        tmpDir.path,</span>
<a href="#l14.208"></a><span id="l14.208" class="difflineplus">+        aServer.type</span>
<a href="#l14.209"></a><span id="l14.209" class="difflineplus">+      ];</span>
<a href="#l14.210"></a><span id="l14.210" class="difflineplus">+</span>
<a href="#l14.211"></a><span id="l14.211" class="difflineplus">+      if (content.isDirectory()) {</span>
<a href="#l14.212"></a><span id="l14.212" class="difflineplus">+        // If it is not a &quot;.sbd&quot; directory we know that it is a maildir msg</span>
<a href="#l14.213"></a><span id="l14.213" class="difflineplus">+        // folder.</span>
<a href="#l14.214"></a><span id="l14.214" class="difflineplus">+        if (content.leafName.substr(-4) != &quot;.sbd&quot;) {</span>
<a href="#l14.215"></a><span id="l14.215" class="difflineplus">+          // Array to hold unsorted list of maildir msg filenames.</span>
<a href="#l14.216"></a><span id="l14.216" class="difflineplus">+          let dataArrayUnsorted = [];</span>
<a href="#l14.217"></a><span id="l14.217" class="difflineplus">+          // &quot;cur&quot; directory inside the maildir msg folder.</span>
<a href="#l14.218"></a><span id="l14.218" class="difflineplus">+          let cur = FileUtils.File(OS.Path.join(content.path,&quot;cur&quot;));</span>
<a href="#l14.219"></a><span id="l14.219" class="difflineplus">+          // Msg files inside &quot;cur&quot; directory.</span>
<a href="#l14.220"></a><span id="l14.220" class="difflineplus">+          let msgs = cur.directoryEntries;</span>
<a href="#l14.221"></a><span id="l14.221" class="difflineplus">+</span>
<a href="#l14.222"></a><span id="l14.222" class="difflineplus">+          while (msgs.hasMoreElements()) {</span>
<a href="#l14.223"></a><span id="l14.223" class="difflineplus">+            // Add filenames as integers into 'dataArrayUnsorted'.</span>
<a href="#l14.224"></a><span id="l14.224" class="difflineplus">+            let msg = msgs.getNext()</span>
<a href="#l14.225"></a><span id="l14.225" class="difflineplus">+                          .QueryInterface(Ci.nsIFile);</span>
<a href="#l14.226"></a><span id="l14.226" class="difflineplus">+            dataArrayUnsorted.push(parseInt(msg.leafName));</span>
<a href="#l14.227"></a><span id="l14.227" class="difflineplus">+          }</span>
<a href="#l14.228"></a><span id="l14.228" class="difflineplus">+          dataArrayUnsorted.sort()</span>
<a href="#l14.229"></a><span id="l14.229" class="difflineplus">+          // Add the maildir msg filenames into 'dataArray' in a sorted order.</span>
<a href="#l14.230"></a><span id="l14.230" class="difflineplus">+          for (let elem of dataArrayUnsorted) {</span>
<a href="#l14.231"></a><span id="l14.231" class="difflineplus">+            dataArray.push(elem.toString());</span>
<a href="#l14.232"></a><span id="l14.232" class="difflineplus">+          }</span>
<a href="#l14.233"></a><span id="l14.233" class="difflineplus">+        }</span>
<a href="#l14.234"></a><span id="l14.234" class="difflineplus">+      }</span>
<a href="#l14.235"></a><span id="l14.235" class="difflineplus">+</span>
<a href="#l14.236"></a><span id="l14.236" class="difflineplus">+      // Send 'dataArray' to the worker.</span>
<a href="#l14.237"></a><span id="l14.237" class="difflineplus">+      converterWorker.postMessage(dataArray);</span>
<a href="#l14.238"></a><span id="l14.238" class="difflineplus">+      converterWorker.addEventListener(&quot;message&quot;, function(e) {</span>
<a href="#l14.239"></a><span id="l14.239" class="difflineplus">+        var responseWorker = e.data[0];</span>
<a href="#l14.240"></a><span id="l14.240" class="difflineplus">+        log.debug(&quot;Type of file or folder encountered: &quot; + e.data);</span>
<a href="#l14.241"></a><span id="l14.241" class="difflineplus">+</span>
<a href="#l14.242"></a><span id="l14.242" class="difflineplus">+        // Dispatch the &quot;progress&quot; event on the event target and increment</span>
<a href="#l14.243"></a><span id="l14.243" class="difflineplus">+        // &quot;progressValue&quot; every time.</span>
<a href="#l14.244"></a><span id="l14.244" class="difflineplus">+        //</span>
<a href="#l14.245"></a><span id="l14.245" class="difflineplus">+        // mbox:</span>
<a href="#l14.246"></a><span id="l14.246" class="difflineplus">+        // - IMAP: a file or folder is copied.</span>
<a href="#l14.247"></a><span id="l14.247" class="difflineplus">+        //   This is because we cannot get the no. of messages actually present</span>
<a href="#l14.248"></a><span id="l14.248" class="difflineplus">+        //   in an imap account so we need some  other way to measure the</span>
<a href="#l14.249"></a><span id="l14.249" class="difflineplus">+        //   progress.</span>
<a href="#l14.250"></a><span id="l14.250" class="difflineplus">+        // - POP: a msg is copied if the no. of msgs in the account is more than</span>
<a href="#l14.251"></a><span id="l14.251" class="difflineplus">+        //   0. A file or folder is copied if the no. of msgs in the account is 0.</span>
<a href="#l14.252"></a><span id="l14.252" class="difflineplus">+        // - NNTP: a file or folder is copied.</span>
<a href="#l14.253"></a><span id="l14.253" class="difflineplus">+        // - MOVEMAIL: Same as POP.</span>
<a href="#l14.254"></a><span id="l14.254" class="difflineplus">+        // - NONE (LOCAL FOLDERS): Same as POP.</span>
<a href="#l14.255"></a><span id="l14.255" class="difflineplus">+        //</span>
<a href="#l14.256"></a><span id="l14.256" class="difflineplus">+        // maildir:</span>
<a href="#l14.257"></a><span id="l14.257" class="difflineplus">+        // - A msg is copied if the no. of msgs in the account is more than 0.</span>
<a href="#l14.258"></a><span id="l14.258" class="difflineplus">+        // - A file or folder is copied if the no. of msgs in the account is 0.</span>
<a href="#l14.259"></a><span id="l14.259" class="difflineplus">+        let popOrLocalOrMoveMailOrMaildir =</span>
<a href="#l14.260"></a><span id="l14.260" class="difflineplus">+           aServer.type == &quot;pop3&quot; || aServer.type == &quot;none&quot; ||</span>
<a href="#l14.261"></a><span id="l14.261" class="difflineplus">+           aServer.type == &quot;movemail&quot; || isMaildir;</span>
<a href="#l14.262"></a><span id="l14.262" class="difflineplus">+        if (((responseWorker == &quot;copied&quot; || (responseWorker != &quot;copied&quot; &amp;&amp; zeroMessages))</span>
<a href="#l14.263"></a><span id="l14.263" class="difflineplus">+                                         &amp;&amp; popOrLocalOrMoveMailOrMaildir)</span>
<a href="#l14.264"></a><span id="l14.264" class="difflineplus">+           ||</span>
<a href="#l14.265"></a><span id="l14.265" class="difflineplus">+             (responseWorker != &quot;copied&quot; &amp;&amp; !popOrLocalOrMoveMailOrMaildir)</span>
<a href="#l14.266"></a><span id="l14.266" class="difflineplus">+           ||</span>
<a href="#l14.267"></a><span id="l14.267" class="difflineplus">+             (responseWorker != &quot;copied&quot; &amp;&amp; aServer.type == &quot;nntp&quot;)</span>
<a href="#l14.268"></a><span id="l14.268" class="difflineplus">+           ) {</span>
<a href="#l14.269"></a><span id="l14.269" class="difflineplus">+          progressValue++;</span>
<a href="#l14.270"></a><span id="l14.270" class="difflineplus">+          log.debug(&quot;Progress: &quot; + progressValue);</span>
<a href="#l14.271"></a><span id="l14.271" class="difflineplus">+</span>
<a href="#l14.272"></a><span id="l14.272" class="difflineplus">+          let event = new Event(&quot;progress&quot;);</span>
<a href="#l14.273"></a><span id="l14.273" class="difflineplus">+          event.detail = parseInt((progressValue/count) * 100);</span>
<a href="#l14.274"></a><span id="l14.274" class="difflineplus">+          aEventTarget.dispatchEvent(event);</span>
<a href="#l14.275"></a><span id="l14.275" class="difflineplus">+          if (progressValue == count) {</span>
<a href="#l14.276"></a><span id="l14.276" class="difflineplus">+            log.info(&quot;Migration completed. Migrated &quot; + count + &quot; items&quot;);</span>
<a href="#l14.277"></a><span id="l14.277" class="difflineplus">+</span>
<a href="#l14.278"></a><span id="l14.278" class="difflineplus">+            // Migration is complete, get path of parent of account root</span>
<a href="#l14.279"></a><span id="l14.279" class="difflineplus">+            // folder into &quot;parentPath&quot; check if Converter folder already</span>
<a href="#l14.280"></a><span id="l14.280" class="difflineplus">+            // exists in &quot;parentPath&quot;. If yes, remove it.</span>
<a href="#l14.281"></a><span id="l14.281" class="difflineplus">+            let lastSlash = accountRootFolder.path.lastIndexOf(&quot;/&quot;);</span>
<a href="#l14.282"></a><span id="l14.282" class="difflineplus">+            let parentPath = accountRootFolder.parent.path;</span>
<a href="#l14.283"></a><span id="l14.283" class="difflineplus">+            log.info(&quot;Path to parent folder of account root&quot; +</span>
<a href="#l14.284"></a><span id="l14.284" class="difflineplus">+                     &quot; folder: &quot; + parentPath);</span>
<a href="#l14.285"></a><span id="l14.285" class="difflineplus">+</span>
<a href="#l14.286"></a><span id="l14.286" class="difflineplus">+            let parent = new FileUtils.File(parentPath);</span>
<a href="#l14.287"></a><span id="l14.287" class="difflineplus">+            log.info(&quot;Path to parent folder of account root folder: &quot; +</span>
<a href="#l14.288"></a><span id="l14.288" class="difflineplus">+              parent.path);</span>
<a href="#l14.289"></a><span id="l14.289" class="difflineplus">+</span>
<a href="#l14.290"></a><span id="l14.290" class="difflineplus">+            var converterFolder = new FileUtils.File(OS.Path.join(parent.path,</span>
<a href="#l14.291"></a><span id="l14.291" class="difflineplus">+              dir.leafName));</span>
<a href="#l14.292"></a><span id="l14.292" class="difflineplus">+            if (converterFolder.exists()) {</span>
<a href="#l14.293"></a><span id="l14.293" class="difflineplus">+              log.info(&quot;Converter folder exists in &quot; + parentPath +</span>
<a href="#l14.294"></a><span id="l14.294" class="difflineplus">+                       &quot;. Removing already existing folder&quot;);</span>
<a href="#l14.295"></a><span id="l14.295" class="difflineplus">+              converterFolder.remove(true);</span>
<a href="#l14.296"></a><span id="l14.296" class="difflineplus">+            }</span>
<a href="#l14.297"></a><span id="l14.297" class="difflineplus">+</span>
<a href="#l14.298"></a><span id="l14.298" class="difflineplus">+            // Move Converter folder into the parent of account root folder.</span>
<a href="#l14.299"></a><span id="l14.299" class="difflineplus">+            try {</span>
<a href="#l14.300"></a><span id="l14.300" class="difflineplus">+              dir.moveTo(parent, dir.leafName);</span>
<a href="#l14.301"></a><span id="l14.301" class="difflineplus">+              // {nsIFile} new account root folder.</span>
<a href="#l14.302"></a><span id="l14.302" class="difflineplus">+              var newRootFolder = new FileUtils.File(OS.Path.join(parent.path,</span>
<a href="#l14.303"></a><span id="l14.303" class="difflineplus">+                dir.leafName));</span>
<a href="#l14.304"></a><span id="l14.304" class="difflineplus">+              log.info(&quot;Path to new account root folder: &quot; +</span>
<a href="#l14.305"></a><span id="l14.305" class="difflineplus">+                       newRootFolder.path);</span>
<a href="#l14.306"></a><span id="l14.306" class="difflineplus">+            } catch (e) {</span>
<a href="#l14.307"></a><span id="l14.307" class="difflineplus">+              // Cleanup.</span>
<a href="#l14.308"></a><span id="l14.308" class="difflineplus">+              log.error(e);</span>
<a href="#l14.309"></a><span id="l14.309" class="difflineplus">+              var newRootFolder = new FileUtils.File(OS.Path.join(parent.path,</span>
<a href="#l14.310"></a><span id="l14.310" class="difflineplus">+                dir.leafName));</span>
<a href="#l14.311"></a><span id="l14.311" class="difflineplus">+              log.error(&quot;Trying to remove converter folder: &quot; +</span>
<a href="#l14.312"></a><span id="l14.312" class="difflineplus">+                newRootFolder.path);</span>
<a href="#l14.313"></a><span id="l14.313" class="difflineplus">+              newRootFolder.remove(true);</span>
<a href="#l14.314"></a><span id="l14.314" class="difflineplus">+              conversionFailed(e);</span>
<a href="#l14.315"></a><span id="l14.315" class="difflineplus">+            }</span>
<a href="#l14.316"></a><span id="l14.316" class="difflineplus">+</span>
<a href="#l14.317"></a><span id="l14.317" class="difflineplus">+            // If the account is imap then copy the msf file for the original</span>
<a href="#l14.318"></a><span id="l14.318" class="difflineplus">+            // root folder and rename the copy with the name of the new root</span>
<a href="#l14.319"></a><span id="l14.319" class="difflineplus">+            // folder.</span>
<a href="#l14.320"></a><span id="l14.320" class="difflineplus">+            if (aServer.type != &quot;pop3&quot; &amp;&amp; aServer.type != &quot;none&quot; &amp;&amp;</span>
<a href="#l14.321"></a><span id="l14.321" class="difflineplus">+              aServer.type != &quot;movemail&quot;) {</span>
<a href="#l14.322"></a><span id="l14.322" class="difflineplus">+              let converterFolderMsf = new FileUtils.File(OS.Path.join(</span>
<a href="#l14.323"></a><span id="l14.323" class="difflineplus">+                parent.path,dir.leafName + &quot;.msf&quot;));</span>
<a href="#l14.324"></a><span id="l14.324" class="difflineplus">+              if (converterFolderMsf.exists()) {</span>
<a href="#l14.325"></a><span id="l14.325" class="difflineplus">+                converterFolderMsf.remove(true);</span>
<a href="#l14.326"></a><span id="l14.326" class="difflineplus">+              }</span>
<a href="#l14.327"></a><span id="l14.327" class="difflineplus">+</span>
<a href="#l14.328"></a><span id="l14.328" class="difflineplus">+              let oldRootFolderMsf = new FileUtils.File(OS.Path.join(</span>
<a href="#l14.329"></a><span id="l14.329" class="difflineplus">+                parent.path,accountRootFolder.leafName + &quot;.msf&quot;));</span>
<a href="#l14.330"></a><span id="l14.330" class="difflineplus">+              if (oldRootFolderMsf.exists()) {</span>
<a href="#l14.331"></a><span id="l14.331" class="difflineplus">+                oldRootFolderMsf.copyTo(parent, converterFolderMsf.leafName);</span>
<a href="#l14.332"></a><span id="l14.332" class="difflineplus">+              }</span>
<a href="#l14.333"></a><span id="l14.333" class="difflineplus">+            }</span>
<a href="#l14.334"></a><span id="l14.334" class="difflineplus">+</span>
<a href="#l14.335"></a><span id="l14.335" class="difflineplus">+            if (aServer.type == &quot;nntp&quot;) {</span>
<a href="#l14.336"></a><span id="l14.336" class="difflineplus">+              let converterFolderNewsrc = new FileUtils.File(OS.Path.join(</span>
<a href="#l14.337"></a><span id="l14.337" class="difflineplus">+                parent.path,&quot;newsrc-&quot; + dir.leafName));</span>
<a href="#l14.338"></a><span id="l14.338" class="difflineplus">+              if (converterFolderNewsrc.exists()) {</span>
<a href="#l14.339"></a><span id="l14.339" class="difflineplus">+                converterFolderNewsrc.remove(true);</span>
<a href="#l14.340"></a><span id="l14.340" class="difflineplus">+              }</span>
<a href="#l14.341"></a><span id="l14.341" class="difflineplus">+              let oldNewsrc = new FileUtils.File(OS.Path.join(parent.path,</span>
<a href="#l14.342"></a><span id="l14.342" class="difflineplus">+                &quot;newsrc-&quot; + accountRootFolder.leafName));</span>
<a href="#l14.343"></a><span id="l14.343" class="difflineplus">+              if (oldNewsrc.exists()) {</span>
<a href="#l14.344"></a><span id="l14.344" class="difflineplus">+                oldNewsrc.copyTo(parent, converterFolderNewsrc.leafName);</span>
<a href="#l14.345"></a><span id="l14.345" class="difflineplus">+              }</span>
<a href="#l14.346"></a><span id="l14.346" class="difflineplus">+            }</span>
<a href="#l14.347"></a><span id="l14.347" class="difflineplus">+</span>
<a href="#l14.348"></a><span id="l14.348" class="difflineplus">+            aServer.rootFolder.filePath = newRootFolder;</span>
<a href="#l14.349"></a><span id="l14.349" class="difflineplus">+            aServer.localPath = newRootFolder;</span>
<a href="#l14.350"></a><span id="l14.350" class="difflineplus">+            log.info(&quot;Path to account root folder: &quot; +</span>
<a href="#l14.351"></a><span id="l14.351" class="difflineplus">+                     aServer.rootFolder.filePath.path);</span>
<a href="#l14.352"></a><span id="l14.352" class="difflineplus">+</span>
<a href="#l14.353"></a><span id="l14.353" class="difflineplus">+            // Set various preferences.</span>
<a href="#l14.354"></a><span id="l14.354" class="difflineplus">+            let p1 = &quot;mail.server.&quot; + aServer.key + &quot;.directory&quot;;</span>
<a href="#l14.355"></a><span id="l14.355" class="difflineplus">+            let p2 = &quot;mail.server.&quot; + aServer.key + &quot;.directory-rel&quot;;</span>
<a href="#l14.356"></a><span id="l14.356" class="difflineplus">+            let p3 = &quot;mail.server.&quot; + aServer.key + &quot;.newsrc.file&quot;;</span>
<a href="#l14.357"></a><span id="l14.357" class="difflineplus">+            let p4 = &quot;mail.server.&quot; + aServer.key + &quot;.newsrc.file-rel&quot;;</span>
<a href="#l14.358"></a><span id="l14.358" class="difflineplus">+            let p5 = &quot;mail.server.&quot; + aServer.key + &quot;.storeContractID&quot;;</span>
<a href="#l14.359"></a><span id="l14.359" class="difflineplus">+</span>
<a href="#l14.360"></a><span id="l14.360" class="difflineplus">+            Services.prefs.setCharPref(p1, newRootFolder.path);</span>
<a href="#l14.361"></a><span id="l14.361" class="difflineplus">+            log.info(p1 + &quot;: &quot; + newRootFolder.path)</span>
<a href="#l14.362"></a><span id="l14.362" class="difflineplus">+</span>
<a href="#l14.363"></a><span id="l14.363" class="difflineplus">+            // The directory-rel pref is of the form &quot;[ProfD]Mail/pop.gmail.com</span>
<a href="#l14.364"></a><span id="l14.364" class="difflineplus">+            // &quot; (pop accounts) or &quot;[ProfD]ImapMail/imap.gmail.com&quot; (imap</span>
<a href="#l14.365"></a><span id="l14.365" class="difflineplus">+            // accounts) ie the last slash &quot;/&quot; is followed by the root folder</span>
<a href="#l14.366"></a><span id="l14.366" class="difflineplus">+            // name. So, replace the old root folder name that follows the last</span>
<a href="#l14.367"></a><span id="l14.367" class="difflineplus">+            // slash with the new root folder name to set the correct value of</span>
<a href="#l14.368"></a><span id="l14.368" class="difflineplus">+            // directory-rel pref.</span>
<a href="#l14.369"></a><span id="l14.369" class="difflineplus">+            let directoryRel = Services.prefs.getCharPref(p2);</span>
<a href="#l14.370"></a><span id="l14.370" class="difflineplus">+            lastSlash = directoryRel.lastIndexOf(&quot;/&quot;);</span>
<a href="#l14.371"></a><span id="l14.371" class="difflineplus">+            directoryRel = directoryRel.slice(0, lastSlash) + &quot;/&quot; +</span>
<a href="#l14.372"></a><span id="l14.372" class="difflineplus">+                                              newRootFolder.leafName;</span>
<a href="#l14.373"></a><span id="l14.373" class="difflineplus">+            Services.prefs.setCharPref(p2, directoryRel);</span>
<a href="#l14.374"></a><span id="l14.374" class="difflineplus">+            log.info(p2 + &quot;: &quot; + directoryRel);</span>
<a href="#l14.375"></a><span id="l14.375" class="difflineplus">+</span>
<a href="#l14.376"></a><span id="l14.376" class="difflineplus">+            if (aServer.type == &quot;nntp&quot;) {</span>
<a href="#l14.377"></a><span id="l14.377" class="difflineplus">+              let newNewsrc = FileUtils.File(OS.Path.join(parent.path,</span>
<a href="#l14.378"></a><span id="l14.378" class="difflineplus">+                &quot;newsrc-&quot; + newRootFolder.leafName));</span>
<a href="#l14.379"></a><span id="l14.379" class="difflineplus">+              Services.prefs.setCharPref(p3, newNewsrc.path);</span>
<a href="#l14.380"></a><span id="l14.380" class="difflineplus">+</span>
<a href="#l14.381"></a><span id="l14.381" class="difflineplus">+              // The newsrc.file-rel pref is of the form &quot;[ProfD]News/newsrc-</span>
<a href="#l14.382"></a><span id="l14.382" class="difflineplus">+              // news.mozilla.org&quot; ie the last slash &quot;/&quot; is followed by the</span>
<a href="#l14.383"></a><span id="l14.383" class="difflineplus">+              // newsrc file name. So, replace the old newsrc file name that</span>
<a href="#l14.384"></a><span id="l14.384" class="difflineplus">+              // follows the last slash with the new newsrc file name to set</span>
<a href="#l14.385"></a><span id="l14.385" class="difflineplus">+              // the correct value of newsrc.file-rel pref.</span>
<a href="#l14.386"></a><span id="l14.386" class="difflineplus">+              let newsrcRel = Services.prefs.getCharPref(p4);</span>
<a href="#l14.387"></a><span id="l14.387" class="difflineplus">+              lastSlash = newsrcRel.lastIndexOf(&quot;/&quot;);</span>
<a href="#l14.388"></a><span id="l14.388" class="difflineplus">+              newsrcRel = newsrcRel.slice(0, lastSlash) + &quot;/&quot; +</span>
<a href="#l14.389"></a><span id="l14.389" class="difflineplus">+                                          newNewsrc.leafName;</span>
<a href="#l14.390"></a><span id="l14.390" class="difflineplus">+              Services.prefs.setCharPref(p4, newsrcRel);</span>
<a href="#l14.391"></a><span id="l14.391" class="difflineplus">+              log.info(p4 + &quot;: &quot; + newsrcRel);</span>
<a href="#l14.392"></a><span id="l14.392" class="difflineplus">+            }</span>
<a href="#l14.393"></a><span id="l14.393" class="difflineplus">+</span>
<a href="#l14.394"></a><span id="l14.394" class="difflineplus">+            Services.prefs.setCharPref(p5, isMaildir ?</span>
<a href="#l14.395"></a><span id="l14.395" class="difflineplus">+              &quot;@mozilla.org/msgstore/berkeleystore;1&quot; :</span>
<a href="#l14.396"></a><span id="l14.396" class="difflineplus">+              &quot;@mozilla.org/msgstore/maildirstore;1&quot;);</span>
<a href="#l14.397"></a><span id="l14.397" class="difflineplus">+</span>
<a href="#l14.398"></a><span id="l14.398" class="difflineplus">+            Services.prefs.savePrefFile(null);</span>
<a href="#l14.399"></a><span id="l14.399" class="difflineplus">+            log.info(&quot;Conversion done!&quot;);</span>
<a href="#l14.400"></a><span id="l14.400" class="difflineplus">+</span>
<a href="#l14.401"></a><span id="l14.401" class="difflineplus">+            // Resolve the promise with the path of the new account root</span>
<a href="#l14.402"></a><span id="l14.402" class="difflineplus">+            // folder.</span>
<a href="#l14.403"></a><span id="l14.403" class="difflineplus">+            conversionOk(newRootFolder.path);</span>
<a href="#l14.404"></a><span id="l14.404" class="difflineplus">+          }</span>
<a href="#l14.405"></a><span id="l14.405" class="difflineplus">+        }</span>
<a href="#l14.406"></a><span id="l14.406" class="difflineplus">+      });</span>
<a href="#l14.407"></a><span id="l14.407" class="difflineplus">+</span>
<a href="#l14.408"></a><span id="l14.408" class="difflineplus">+      converterWorker.addEventListener(&quot;error&quot;, function(e) {</span>
<a href="#l14.409"></a><span id="l14.409" class="difflineplus">+        let reasonString =</span>
<a href="#l14.410"></a><span id="l14.410" class="difflineplus">+          &quot;Error at &quot; + e.filename + &quot;:&quot; + e.lineno + &quot; - &quot; +  e.message;</span>
<a href="#l14.411"></a><span id="l14.411" class="difflineplus">+        log.error(reasonString);</span>
<a href="#l14.412"></a><span id="l14.412" class="difflineplus">+        terminateWorkers();</span>
<a href="#l14.413"></a><span id="l14.413" class="difflineplus">+        // Cleanup.</span>
<a href="#l14.414"></a><span id="l14.414" class="difflineplus">+        log.error(&quot;Trying to remove converter folder: &quot; +</span>
<a href="#l14.415"></a><span id="l14.415" class="difflineplus">+          aDestPath.path);</span>
<a href="#l14.416"></a><span id="l14.416" class="difflineplus">+        aDestPath.remove(true);</span>
<a href="#l14.417"></a><span id="l14.417" class="difflineplus">+        conversionFailed(e.message);</span>
<a href="#l14.418"></a><span id="l14.418" class="difflineplus">+      });</span>
<a href="#l14.419"></a><span id="l14.419" class="difflineplus">+</span>
<a href="#l14.420"></a><span id="l14.420" class="difflineplus">+      if (content.isDirectory()) {</span>
<a href="#l14.421"></a><span id="l14.421" class="difflineplus">+        if (content.leafName.substr(-4) == &quot;.sbd&quot;) {</span>
<a href="#l14.422"></a><span id="l14.422" class="difflineplus">+          let dirNew = new FileUtils.File(OS.Path.join(aDestPath.path,</span>
<a href="#l14.423"></a><span id="l14.423" class="difflineplus">+            content.leafName));</span>
<a href="#l14.424"></a><span id="l14.424" class="difflineplus">+          subDir(content, dirNew);</span>
<a href="#l14.425"></a><span id="l14.425" class="difflineplus">+        }</span>
<a href="#l14.426"></a><span id="l14.426" class="difflineplus">+      }</span>
<a href="#l14.427"></a><span id="l14.427" class="difflineplus">+    }</span>
<a href="#l14.428"></a><span id="l14.428" class="difflineplus">+  }</span>
<a href="#l14.429"></a><span id="l14.429" class="difflineplus">+</span>
<a href="#l14.430"></a><span id="l14.430" class="difflineplus">+  /**</span>
<a href="#l14.431"></a><span id="l14.431" class="difflineplus">+   * Checks if Converter folder exists in tmp dir, removes it and creates a new</span>
<a href="#l14.432"></a><span id="l14.432" class="difflineplus">+   * &quot;Converter&quot; folder.</span>
<a href="#l14.433"></a><span id="l14.433" class="difflineplus">+   * @param {nsIFile} aFolder - account root folder.</span>
<a href="#l14.434"></a><span id="l14.434" class="difflineplus">+   */</span>
<a href="#l14.435"></a><span id="l14.435" class="difflineplus">+  var createTmpConverterFolder = function(aFolder) {</span>
<a href="#l14.436"></a><span id="l14.436" class="difflineplus">+    let tmpFolder;</span>
<a href="#l14.437"></a><span id="l14.437" class="difflineplus">+    switch (aMailstoreContractId) {</span>
<a href="#l14.438"></a><span id="l14.438" class="difflineplus">+      case &quot;@mozilla.org/msgstore/maildirstore;1&quot;: {</span>
<a href="#l14.439"></a><span id="l14.439" class="difflineplus">+        if (aFolder.leafName.substr(-8) == &quot;-maildir&quot;) {</span>
<a href="#l14.440"></a><span id="l14.440" class="difflineplus">+          tmpFolder = new FileUtils.File(OS.Path.join(tmpDir.path,</span>
<a href="#l14.441"></a><span id="l14.441" class="difflineplus">+            aFolder.leafName.substr(0, aFolder.leafName.length - 8) + &quot;-mbox&quot;));</span>
<a href="#l14.442"></a><span id="l14.442" class="difflineplus">+        } else {</span>
<a href="#l14.443"></a><span id="l14.443" class="difflineplus">+          tmpFolder = new FileUtils.File(OS.Path.join(tmpDir.path,</span>
<a href="#l14.444"></a><span id="l14.444" class="difflineplus">+            aFolder.leafName + &quot;-mbox&quot;));</span>
<a href="#l14.445"></a><span id="l14.445" class="difflineplus">+        }</span>
<a href="#l14.446"></a><span id="l14.446" class="difflineplus">+</span>
<a href="#l14.447"></a><span id="l14.447" class="difflineplus">+        if (tmpFolder.exists()) {</span>
<a href="#l14.448"></a><span id="l14.448" class="difflineplus">+          log.info(&quot;Temporary Converter folder &quot; + tmpFolder.path +</span>
<a href="#l14.449"></a><span id="l14.449" class="difflineplus">+                   &quot;exists in tmp dir. Removing it&quot;);</span>
<a href="#l14.450"></a><span id="l14.450" class="difflineplus">+          tmpFolder.remove(true);</span>
<a href="#l14.451"></a><span id="l14.451" class="difflineplus">+        }</span>
<a href="#l14.452"></a><span id="l14.452" class="difflineplus">+        return FileUtils.getDir(&quot;TmpD&quot;, [tmpFolder.leafName], true);</span>
<a href="#l14.453"></a><span id="l14.453" class="difflineplus">+      }</span>
<a href="#l14.454"></a><span id="l14.454" class="difflineplus">+</span>
<a href="#l14.455"></a><span id="l14.455" class="difflineplus">+      case &quot;@mozilla.org/msgstore/berkeleystore;1&quot;: {</span>
<a href="#l14.456"></a><span id="l14.456" class="difflineplus">+        if (aFolder.leafName.substr(-5) == &quot;-mbox&quot;) {</span>
<a href="#l14.457"></a><span id="l14.457" class="difflineplus">+          tmpFolder = new FileUtils.File(OS.Path.join(tmpDir.path,</span>
<a href="#l14.458"></a><span id="l14.458" class="difflineplus">+            aFolder.leafName.substr(0, aFolder.leafName.length - 5) +</span>
<a href="#l14.459"></a><span id="l14.459" class="difflineplus">+              &quot;-maildir&quot;));</span>
<a href="#l14.460"></a><span id="l14.460" class="difflineplus">+        } else {</span>
<a href="#l14.461"></a><span id="l14.461" class="difflineplus">+          tmpFolder = new FileUtils.File(OS.Path.join(tmpDir.path,</span>
<a href="#l14.462"></a><span id="l14.462" class="difflineplus">+            aFolder.leafName + &quot;-maildir&quot;));</span>
<a href="#l14.463"></a><span id="l14.463" class="difflineplus">+        }</span>
<a href="#l14.464"></a><span id="l14.464" class="difflineplus">+</span>
<a href="#l14.465"></a><span id="l14.465" class="difflineplus">+        if (tmpFolder.exists()) {</span>
<a href="#l14.466"></a><span id="l14.466" class="difflineplus">+          log.info(&quot;Temporary Converter folder &quot; + tmpFolder.path +</span>
<a href="#l14.467"></a><span id="l14.467" class="difflineplus">+                   &quot;exists in tmp dir. Removing it&quot;);</span>
<a href="#l14.468"></a><span id="l14.468" class="difflineplus">+          tmpFolder.remove(true);</span>
<a href="#l14.469"></a><span id="l14.469" class="difflineplus">+        }</span>
<a href="#l14.470"></a><span id="l14.470" class="difflineplus">+        return FileUtils.getDir(&quot;TmpD&quot;, [tmpFolder.leafName], true);</span>
<a href="#l14.471"></a><span id="l14.471" class="difflineplus">+      }</span>
<a href="#l14.472"></a><span id="l14.472" class="difflineplus">+</span>
<a href="#l14.473"></a><span id="l14.473" class="difflineplus">+      default: {</span>
<a href="#l14.474"></a><span id="l14.474" class="difflineplus">+        throw new Error(&quot;Unexpected mailstoreContractId: &quot; +</span>
<a href="#l14.475"></a><span id="l14.475" class="difflineplus">+                        aMailstoreContractId);</span>
<a href="#l14.476"></a><span id="l14.476" class="difflineplus">+      }</span>
<a href="#l14.477"></a><span id="l14.477" class="difflineplus">+    }</span>
<a href="#l14.478"></a><span id="l14.478" class="difflineplus">+  }</span>
<a href="#l14.479"></a><span id="l14.479" class="difflineplus">+</span>
<a href="#l14.480"></a><span id="l14.480" class="difflineplus">+  if (isMaildir &amp;&amp; aServer.type != &quot;nntp&quot;) {</span>
<a href="#l14.481"></a><span id="l14.481" class="difflineplus">+    count = countMaildirMsgs(accountRootFolder);</span>
<a href="#l14.482"></a><span id="l14.482" class="difflineplus">+    if (count == 0) {</span>
<a href="#l14.483"></a><span id="l14.483" class="difflineplus">+      count = countMaildirZeroMsgs(accountRootFolder);</span>
<a href="#l14.484"></a><span id="l14.484" class="difflineplus">+      zeroMessages = true;</span>
<a href="#l14.485"></a><span id="l14.485" class="difflineplus">+    }</span>
<a href="#l14.486"></a><span id="l14.486" class="difflineplus">+  } else if (aServer.type == &quot;pop3&quot; ||</span>
<a href="#l14.487"></a><span id="l14.487" class="difflineplus">+             aServer.type == &quot;none&quot; || // none: Local Folders.</span>
<a href="#l14.488"></a><span id="l14.488" class="difflineplus">+             aServer.type == &quot;movemail&quot;) {</span>
<a href="#l14.489"></a><span id="l14.489" class="difflineplus">+    count = aServer.rootFolder.getTotalMessages(true);</span>
<a href="#l14.490"></a><span id="l14.490" class="difflineplus">+    if (count == 0) {</span>
<a href="#l14.491"></a><span id="l14.491" class="difflineplus">+      count = countImapFileFolders(accountRootFolder);</span>
<a href="#l14.492"></a><span id="l14.492" class="difflineplus">+      zeroMessages = true;</span>
<a href="#l14.493"></a><span id="l14.493" class="difflineplus">+    }</span>
<a href="#l14.494"></a><span id="l14.494" class="difflineplus">+  } else if (aServer.type == &quot;imap&quot; || aServer.type == &quot;nntp&quot;) {</span>
<a href="#l14.495"></a><span id="l14.495" class="difflineplus">+    count = countImapFileFolders(accountRootFolder);</span>
<a href="#l14.496"></a><span id="l14.496" class="difflineplus">+  }</span>
<a href="#l14.497"></a><span id="l14.497" class="difflineplus">+</span>
<a href="#l14.498"></a><span id="l14.498" class="difflineplus">+  // Go offline before conversion, so there aren't messages coming in during</span>
<a href="#l14.499"></a><span id="l14.499" class="difflineplus">+  // the process.</span>
<a href="#l14.500"></a><span id="l14.500" class="difflineplus">+  Services.io.offline = true;</span>
<a href="#l14.501"></a><span id="l14.501" class="difflineplus">+  let dir = createTmpConverterFolder(accountRootFolder);</span>
<a href="#l14.502"></a><span id="l14.502" class="difflineplus">+  return new Promise(function(resolve, reject) {</span>
<a href="#l14.503"></a><span id="l14.503" class="difflineplus">+    conversionOk = resolve;</span>
<a href="#l14.504"></a><span id="l14.504" class="difflineplus">+    conversionFailed = reject;</span>
<a href="#l14.505"></a><span id="l14.505" class="difflineplus">+    subDir(accountRootFolder, dir);</span>
<a href="#l14.506"></a><span id="l14.506" class="difflineplus">+  });</span>
<a href="#l14.507"></a><span id="l14.507" class="difflineplus">+}</span>
<a href="#l14.508"></a><span id="l14.508" class="difflineplus">+</span>
<a href="#l14.509"></a><span id="l14.509" class="difflineplus">+/**</span>
<a href="#l14.510"></a><span id="l14.510" class="difflineplus">+ * Terminate all workers.</span>
<a href="#l14.511"></a><span id="l14.511" class="difflineplus">+ */</span>
<a href="#l14.512"></a><span id="l14.512" class="difflineplus">+function terminateWorkers() {</span>
<a href="#l14.513"></a><span id="l14.513" class="difflineplus">+  for (let worker of gConverterWorkerArray) {</span>
<a href="#l14.514"></a><span id="l14.514" class="difflineplus">+    worker.terminate();</span>
<a href="#l14.515"></a><span id="l14.515" class="difflineplus">+  }</span>
<a href="#l14.516"></a><span id="l14.516" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/base/util/moz.build</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/base/util/moz.build</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -44,25 +44,27 @@ SOURCES += [</span>
<a href="#l15.4"></a><span id="l15.4">     'nsMsgTxn.cpp',</span>
<a href="#l15.5"></a><span id="l15.5">     'nsMsgUtils.cpp',</span>
<a href="#l15.6"></a><span id="l15.6">     'nsStopwatch.cpp',</span>
<a href="#l15.7"></a><span id="l15.7">     'Services.cpp',</span>
<a href="#l15.8"></a><span id="l15.8"> ]</span>
<a href="#l15.9"></a><span id="l15.9"> </span>
<a href="#l15.10"></a><span id="l15.10"> EXTRA_JS_MODULES += [</span>
<a href="#l15.11"></a><span id="l15.11">     'ABQueryUtils.jsm',</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+    'converterWorker.js',</span>
<a href="#l15.13"></a><span id="l15.13">     'errUtils.js',</span>
<a href="#l15.14"></a><span id="l15.14">     'folderUtils.jsm',</span>
<a href="#l15.15"></a><span id="l15.15">     'hostnameUtils.jsm',</span>
<a href="#l15.16"></a><span id="l15.16">     'IOUtils.js',</span>
<a href="#l15.17"></a><span id="l15.17">     'iteratorUtils.jsm',</span>
<a href="#l15.18"></a><span id="l15.18">     'jsTreeSelection.js',</span>
<a href="#l15.19"></a><span id="l15.19">     'JXON.js',</span>
<a href="#l15.20"></a><span id="l15.20">     'mailnewsMigrator.js',</span>
<a href="#l15.21"></a><span id="l15.21">     'mailServices.js',</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineplus">+    'mailstoreConverter.jsm',</span>
<a href="#l15.23"></a><span id="l15.23">     'msgDBCacheManager.js',</span>
<a href="#l15.24"></a><span id="l15.24">     'OAuth2.jsm',</span>
<a href="#l15.25"></a><span id="l15.25">     'OAuth2Providers.jsm',</span>
<a href="#l15.26"></a><span id="l15.26">     'StringBundle.js',</span>
<a href="#l15.27"></a><span id="l15.27">     'templateUtils.js',</span>
<a href="#l15.28"></a><span id="l15.28">     'traceHelper.js',</span>
<a href="#l15.29"></a><span id="l15.29"> ]</span>
<a href="#l15.30"></a><span id="l15.30"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1">new file mode 100644</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineminus">--- /dev/null</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineplus">+++ b/mailnews/imap/test/unit/test_converterImap.js</span>
<a href="#l16.4"></a><span id="l16.4" class="difflineat">@@ -0,0 +1,151 @@</span>
<a href="#l16.5"></a><span id="l16.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l16.6"></a><span id="l16.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l16.7"></a><span id="l16.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l16.8"></a><span id="l16.8" class="difflineplus">+</span>
<a href="#l16.9"></a><span id="l16.9" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l16.10"></a><span id="l16.10" class="difflineplus">+ChromeUtils.import(&quot;resource:///modules/mailstoreConverter.jsm&quot;);</span>
<a href="#l16.11"></a><span id="l16.11" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/Log.jsm&quot;);</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+Services.prefs.setCharPref(&quot;mail.serverDefaultStoreContractID&quot;,</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+                           &quot;@mozilla.org/msgstore/berkeleystore;1&quot;);</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineplus">+load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineplus">+load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineplus">+</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineplus">+var log = Log.repository.getLogger(&quot;MailStoreConverter&quot;);</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineplus">+</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineplus">+var FileUtils = ChromeUtils.import(&quot;resource://gre/modules/FileUtils.jsm&quot;)</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineplus">+                                .FileUtils;</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineplus">+</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineplus">+// Globals</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineplus">+var gRootFolder;</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineplus">+</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineplus">+var gMsgFile1 = do_get_file(&quot;../../../data/bugmail10&quot;);</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineplus">+</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineplus">+// Copied straight from the example files</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineplus">+var gMsgId1 = &quot;200806061706.m56H6RWT004933@mrapp54.mozilla.org&quot;;</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineplus">+var gMsgId2 = &quot;200804111417.m3BEHTk4030129@mrapp51.mozilla.org&quot;;</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineplus">+var gMsgId3 = &quot;4849BF7B.2030800@example.com&quot;;</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+var gMsgId4 = &quot;bugmail7.m47LtAEf007542@mrapp51.mozilla.org&quot;;</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+var gMsgId5 = &quot;bugmail6.m47LtAEf007542@mrapp51.mozilla.org&quot;;</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineplus">+</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineplus">+function checkConversion(aSource, aTarget) {</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineplus">+  let sourceContents = aSource.directoryEntries;</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineplus">+</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineplus">+  while (sourceContents.hasMoreElements()) {</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineplus">+    let sourceContent = sourceContents.getNext().QueryInterface(Ci.nsIFile);</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineplus">+    let sourceContentName = sourceContent.leafName;</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineplus">+    let ext = sourceContentName.slice(-4);</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineplus">+    let targetFile = FileUtils.File(OS.Path.join(aTarget.path,sourceContentName));</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineplus">+    log.debug(&quot;Checking path: &quot; + targetFile.path);</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineplus">+</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineplus">+    if (ext == &quot;.msf&quot; || ext == &quot;.dat&quot;) {</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineplus">+      Assert.ok(targetFile.exists());</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineplus">+    } else if (sourceContent.isDirectory()) {</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineplus">+      Assert.ok(targetFile.exists());</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineplus">+      checkConversion(sourceContent, targetFile);</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineplus">+    } else {</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineplus">+      Assert.ok(targetFile.exists());</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineplus">+      let cur = FileUtils.File(OS.Path.join(targetFile.path,&quot;cur&quot;));</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineplus">+      Assert.ok(cur.exists());</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineplus">+      let tmp = FileUtils.File(OS.Path.join(targetFile.path,&quot;tmp&quot;));</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineplus">+      Assert.ok(tmp.exists());</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineplus">+      if (targetFile.leafName == &quot;INBOX&quot;) {</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineplus">+        let curContents = cur.directoryEntries;</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineplus">+        let curContentsCount = 0;</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineplus">+        while (curContents.hasMoreElements()) {</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineplus">+          let curContent = curContents.getNext();</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineplus">+          curContentsCount += 1;</span>
<a href="#l16.65"></a><span id="l16.65" class="difflineplus">+        }</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineplus">+        Assert.equal(curContentsCount, 8);</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineplus">+      }</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineplus">+    }</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineplus">+  }</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineplus">+}</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineplus">+</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineplus">+var EventTarget = function () {</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineplus">+  this.dispatchEvent = function (aEvent) {</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineplus">+    if (aEvent.type == &quot;progress&quot;) {</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineplus">+      log.trace(&quot;Progress: &quot; + aEvent.detail);</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineplus">+    }</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineplus">+  };</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineplus">+};</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineplus">+</span>
<a href="#l16.80"></a><span id="l16.80" class="difflineplus">+// Adds some messages directly to a mailbox (eg new mail).</span>
<a href="#l16.81"></a><span id="l16.81" class="difflineplus">+function addMessagesToServer(aMessages, aMailbox)</span>
<a href="#l16.82"></a><span id="l16.82" class="difflineplus">+{</span>
<a href="#l16.83"></a><span id="l16.83" class="difflineplus">+  // For every message we have, we need to convert it to a file:/// URI</span>
<a href="#l16.84"></a><span id="l16.84" class="difflineplus">+  aMessages.forEach(function (message)</span>
<a href="#l16.85"></a><span id="l16.85" class="difflineplus">+  {</span>
<a href="#l16.86"></a><span id="l16.86" class="difflineplus">+    let URI =</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineplus">+      Services.io.newFileURI(message.file).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineplus">+    message.spec = URI.spec;</span>
<a href="#l16.89"></a><span id="l16.89" class="difflineplus">+  });</span>
<a href="#l16.90"></a><span id="l16.90" class="difflineplus">+</span>
<a href="#l16.91"></a><span id="l16.91" class="difflineplus">+  // Create the imapMessages and store them on the mailbox.</span>
<a href="#l16.92"></a><span id="l16.92" class="difflineplus">+  aMessages.forEach(function (message)</span>
<a href="#l16.93"></a><span id="l16.93" class="difflineplus">+  {</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineplus">+    aMailbox.addMessage(new imapMessage(message.spec, aMailbox.uidnext++, []));</span>
<a href="#l16.95"></a><span id="l16.95" class="difflineplus">+  });</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineplus">+}</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineplus">+</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineplus">+function setup() {</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineplus">+  setupIMAPPump();</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineplus">+</span>
<a href="#l16.101"></a><span id="l16.101" class="difflineplus">+  gRootFolder = IMAPPump.incomingServer.rootFolder;</span>
<a href="#l16.102"></a><span id="l16.102" class="difflineplus">+  // These hacks are required because we've created the inbox before</span>
<a href="#l16.103"></a><span id="l16.103" class="difflineplus">+  // running initial folder discovery, and adding the folder bails</span>
<a href="#l16.104"></a><span id="l16.104" class="difflineplus">+  // out before we set it as verified online, so we bail out, and</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineplus">+  // then remove the INBOX folder since it's not verified.</span>
<a href="#l16.106"></a><span id="l16.106" class="difflineplus">+  IMAPPump.inbox.hierarchyDelimiter = '/';</span>
<a href="#l16.107"></a><span id="l16.107" class="difflineplus">+  IMAPPump.inbox.verifiedAsOnlineFolder = true;</span>
<a href="#l16.108"></a><span id="l16.108" class="difflineplus">+</span>
<a href="#l16.109"></a><span id="l16.109" class="difflineplus">+  // Add a couple of messages to the INBOX.</span>
<a href="#l16.110"></a><span id="l16.110" class="difflineplus">+  // This is synchronous.</span>
<a href="#l16.111"></a><span id="l16.111" class="difflineplus">+  addMessagesToServer([{file: gMsgFile1, messageId: gMsgId1},</span>
<a href="#l16.112"></a><span id="l16.112" class="difflineplus">+                       {file: gMsgFile1, messageId: gMsgId4},</span>
<a href="#l16.113"></a><span id="l16.113" class="difflineplus">+                       {file: gMsgFile1, messageId: gMsgId2},</span>
<a href="#l16.114"></a><span id="l16.114" class="difflineplus">+                       {file: gMsgFile1, messageId: gMsgId5}],</span>
<a href="#l16.115"></a><span id="l16.115" class="difflineplus">+                       IMAPPump.daemon.getMailbox(&quot;INBOX&quot;), IMAPPump.inbox);</span>
<a href="#l16.116"></a><span id="l16.116" class="difflineplus">+}</span>
<a href="#l16.117"></a><span id="l16.117" class="difflineplus">+</span>
<a href="#l16.118"></a><span id="l16.118" class="difflineplus">+function run_test() {</span>
<a href="#l16.119"></a><span id="l16.119" class="difflineplus">+  setup();</span>
<a href="#l16.120"></a><span id="l16.120" class="difflineplus">+  run_next_test();</span>
<a href="#l16.121"></a><span id="l16.121" class="difflineplus">+}</span>
<a href="#l16.122"></a><span id="l16.122" class="difflineplus">+</span>
<a href="#l16.123"></a><span id="l16.123" class="difflineplus">+add_task(function* downloadForOffline() {</span>
<a href="#l16.124"></a><span id="l16.124" class="difflineplus">+  // Download for offline use.</span>
<a href="#l16.125"></a><span id="l16.125" class="difflineplus">+  dump(&quot;Downloading for offline use\n&quot;);</span>
<a href="#l16.126"></a><span id="l16.126" class="difflineplus">+  let promiseUrlListener = new PromiseTestUtils.PromiseUrlListener();</span>
<a href="#l16.127"></a><span id="l16.127" class="difflineplus">+  IMAPPump.inbox.downloadAllForOffline(promiseUrlListener, null);</span>
<a href="#l16.128"></a><span id="l16.128" class="difflineplus">+  yield promiseUrlListener.promise;</span>
<a href="#l16.129"></a><span id="l16.129" class="difflineplus">+});</span>
<a href="#l16.130"></a><span id="l16.130" class="difflineplus">+</span>
<a href="#l16.131"></a><span id="l16.131" class="difflineplus">+add_task(function convert() {</span>
<a href="#l16.132"></a><span id="l16.132" class="difflineplus">+  let mailstoreContractId = Services.prefs.getCharPref(</span>
<a href="#l16.133"></a><span id="l16.133" class="difflineplus">+  &quot;mail.server.&quot; + IMAPPump.incomingServer.key + &quot;.storeContractID&quot;);</span>
<a href="#l16.134"></a><span id="l16.134" class="difflineplus">+  let eventTarget = new EventTarget();</span>
<a href="#l16.135"></a><span id="l16.135" class="difflineplus">+  let pConverted = convertMailStoreTo(mailstoreContractId,</span>
<a href="#l16.136"></a><span id="l16.136" class="difflineplus">+    IMAPPump.incomingServer, eventTarget);</span>
<a href="#l16.137"></a><span id="l16.137" class="difflineplus">+  do_test_pending();</span>
<a href="#l16.138"></a><span id="l16.138" class="difflineplus">+  let originalRootFolder = IMAPPump.incomingServer.rootFolder.filePath;</span>
<a href="#l16.139"></a><span id="l16.139" class="difflineplus">+  pConverted.then(function(val) {</span>
<a href="#l16.140"></a><span id="l16.140" class="difflineplus">+    log.debug(&quot;Conversion done: &quot; + originalRootFolder.path + &quot; =&gt; &quot; + val);</span>
<a href="#l16.141"></a><span id="l16.141" class="difflineplus">+    let newRootFolder = IMAPPump.incomingServer.rootFolder.filePath;</span>
<a href="#l16.142"></a><span id="l16.142" class="difflineplus">+    checkConversion(originalRootFolder, newRootFolder);</span>
<a href="#l16.143"></a><span id="l16.143" class="difflineplus">+    let newRootFolderMsf = FileUtils.File(newRootFolder.path + &quot;.msf&quot;);</span>
<a href="#l16.144"></a><span id="l16.144" class="difflineplus">+    Assert.ok(newRootFolderMsf.exists());</span>
<a href="#l16.145"></a><span id="l16.145" class="difflineplus">+    do_test_finished();</span>
<a href="#l16.146"></a><span id="l16.146" class="difflineplus">+  }).catch (function(reason) {</span>
<a href="#l16.147"></a><span id="l16.147" class="difflineplus">+    log.error(&quot;Conversion Failed: &quot; + reason.error);</span>
<a href="#l16.148"></a><span id="l16.148" class="difflineplus">+    do_test_finished();</span>
<a href="#l16.149"></a><span id="l16.149" class="difflineplus">+  });</span>
<a href="#l16.150"></a><span id="l16.150" class="difflineplus">+});</span>
<a href="#l16.151"></a><span id="l16.151" class="difflineplus">+</span>
<a href="#l16.152"></a><span id="l16.152" class="difflineplus">+add_task(function teardown() {</span>
<a href="#l16.153"></a><span id="l16.153" class="difflineplus">+  gRootFolder = null;</span>
<a href="#l16.154"></a><span id="l16.154" class="difflineplus">+  teardownIMAPPump();</span>
<a href="#l16.155"></a><span id="l16.155" class="difflineplus">+});</span>
<a href="#l16.156"></a><span id="l16.156">\ No newline at end of file</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/imap/test/unit/xpcshell.ini</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/imap/test/unit/xpcshell.ini</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -2,16 +2,17 @@</span>
<a href="#l17.4"></a><span id="l17.4"> head = head_server.js</span>
<a href="#l17.5"></a><span id="l17.5"> tail =</span>
<a href="#l17.6"></a><span id="l17.6"> </span>
<a href="#l17.7"></a><span id="l17.7"> [test_autosync_date_constraints.js]</span>
<a href="#l17.8"></a><span id="l17.8"> [test_bccProperty.js]</span>
<a href="#l17.9"></a><span id="l17.9"> [test_bug460636.js]</span>
<a href="#l17.10"></a><span id="l17.10"> [test_chunkLastLF.js]</span>
<a href="#l17.11"></a><span id="l17.11"> [test_compactOfflineStore.js]</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+[test_converterImap.js]</span>
<a href="#l17.13"></a><span id="l17.13"> [test_copyThenMove.js]</span>
<a href="#l17.14"></a><span id="l17.14"> [test_customCommandReturnsFetchResponse.js]</span>
<a href="#l17.15"></a><span id="l17.15"> [test_dod.js]</span>
<a href="#l17.16"></a><span id="l17.16"> [test_dontStatNoSelect.js]</span>
<a href="#l17.17"></a><span id="l17.17"> [test_downloadOffline.js]</span>
<a href="#l17.18"></a><span id="l17.18"> [test_fetchCustomAttribute.js]</span>
<a href="#l17.19"></a><span id="l17.19"> [test_filterCustomHeaders.js]</span>
<a href="#l17.20"></a><span id="l17.20"> [test_filterNeedsBody.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/jar.mn</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/jar.mn</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -60,16 +60,18 @@ messenger.jar:</span>
<a href="#l18.4"></a><span id="l18.4">     content/messenger/aw-done.js                                               (base/prefs/content/aw-done.js)</span>
<a href="#l18.5"></a><span id="l18.5">     content/messenger/accountUtils.js                                          (base/prefs/content/accountUtils.js)</span>
<a href="#l18.6"></a><span id="l18.6">     content/messenger/amUtils.js                                               (base/prefs/content/amUtils.js)</span>
<a href="#l18.7"></a><span id="l18.7">     content/messenger/ispUtils.js                                              (base/prefs/content/ispUtils.js)</span>
<a href="#l18.8"></a><span id="l18.8">     content/messenger/SmtpServerEdit.xul                                       (base/prefs/content/SmtpServerEdit.xul)</span>
<a href="#l18.9"></a><span id="l18.9">     content/messenger/SmtpServerEdit.js                                        (base/prefs/content/SmtpServerEdit.js)</span>
<a href="#l18.10"></a><span id="l18.10">     content/messenger/smtpEditOverlay.xul                                      (base/prefs/content/smtpEditOverlay.xul)</span>
<a href="#l18.11"></a><span id="l18.11">     content/messenger/smtpEditOverlay.js                                       (base/prefs/content/smtpEditOverlay.js)</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+    content/messenger/converterDialog.xhtml                                    (base/prefs/content/converterDialog.xhtml)</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+    content/messenger/converterDialog.js                                       (base/prefs/content/converterDialog.js)</span>
<a href="#l18.14"></a><span id="l18.14">     content/messenger/removeAccount.xul                                        (base/prefs/content/removeAccount.xul)</span>
<a href="#l18.15"></a><span id="l18.15">     content/messenger/removeAccount.js                                         (base/prefs/content/removeAccount.js)</span>
<a href="#l18.16"></a><span id="l18.16">     content/messenger/msgSelectOfflineFolders.xul                              (base/content/msgSelectOfflineFolders.xul)</span>
<a href="#l18.17"></a><span id="l18.17">     content/messenger/msgSelectOfflineFolders.js                               (base/content/msgSelectOfflineFolders.js)</span>
<a href="#l18.18"></a><span id="l18.18">     content/messenger/msgSynchronize.xul                                       (base/content/msgSynchronize.xul)</span>
<a href="#l18.19"></a><span id="l18.19">     content/messenger/msgSynchronize.js                                        (base/content/msgSynchronize.js)</span>
<a href="#l18.20"></a><span id="l18.20">     content/messenger/folderProps.xul                                          (base/content/folderProps.xul)</span>
<a href="#l18.21"></a><span id="l18.21">     content/messenger/folderProps.js                                           (base/content/folderProps.js)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/mailnews.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/mailnews.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -531,19 +531,26 @@ pref(&quot;mail.imap.force_select_detect&quot;, &quot;\</span>
<a href="#l19.4"></a><span id="l19.4"> </span>
<a href="#l19.5"></a><span id="l19.5"> // to activate auto-sync feature (preemptive message download for imap) by default</span>
<a href="#l19.6"></a><span id="l19.6"> pref(&quot;mail.server.default.autosync_offline_stores&quot;,true);</span>
<a href="#l19.7"></a><span id="l19.7"> pref(&quot;mail.server.default.offline_download&quot;,true);</span>
<a href="#l19.8"></a><span id="l19.8"> </span>
<a href="#l19.9"></a><span id="l19.9"> // -1 means no limit, no purging of offline stores.</span>
<a href="#l19.10"></a><span id="l19.10"> pref(&quot;mail.server.default.autosync_max_age_days&quot;, -1);</span>
<a href="#l19.11"></a><span id="l19.11"> </span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-// can we change the store type?</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+// Can we change the store type without conversion? (=has the store been used)</span>
<a href="#l19.14"></a><span id="l19.14"> pref(&quot;mail.server.default.canChangeStoreType&quot;, false);</span>
<a href="#l19.15"></a><span id="l19.15"> </span>
<a href="#l19.16"></a><span id="l19.16" class="difflineplus">+// Store conversion (mbox &lt;-&gt; maildir)</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineplus">+#ifndef RELEASE_OR_BETA</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineplus">+pref(&quot;mail.store_conversion_enabled&quot;, true);</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineplus">+#else</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineplus">+pref(&quot;mail.store_conversion_enabled&quot;, false);</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineplus">+#endif</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineplus">+</span>
<a href="#l19.23"></a><span id="l19.23"> // This is the default store contractID for newly created servers.</span>
<a href="#l19.24"></a><span id="l19.24"> // We don't use mail.server.default because we want to ensure that the</span>
<a href="#l19.25"></a><span id="l19.25"> // store contract id is always written out to prefs.js</span>
<a href="#l19.26"></a><span id="l19.26"> pref(&quot;mail.serverDefaultStoreContractID&quot;, &quot;@mozilla.org/msgstore/berkeleystore;1&quot;);</span>
<a href="#l19.27"></a><span id="l19.27"> // the probablilty threshold over which messages are classified as junk</span>
<a href="#l19.28"></a><span id="l19.28"> // this number is divided by 100 before it is used. The classifier can be fine tuned</span>
<a href="#l19.29"></a><span id="l19.29"> // by changing this pref. Typical values are .99, .95, .90, .5, etc.</span>
<a href="#l19.30"></a><span id="l19.30"> pref(&quot;mail.adaptivefilters.junk_threshold&quot;, 90);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

