<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 11315:cc0ff188f5bc5e7e2cd6f37ceb211a460c8e6557</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ cc0ff188f5bc5e7e2cd6f37ceb211a460c8e6557" />
<meta property="og:url" content="/comm-central/rev/cc0ff188f5bc5e7e2cd6f37ceb211a460c8e6557" />
<meta property="og:description" content="Bug 801383 Fix fallout from bug 779473 - make nsresult an enum class. Fix nsNNTPProtocol. r=Standard8 CLOSED TREE" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / cc0ff188f5bc5e7e2cd6f37ceb211a460c8e6557 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/cc0ff188f5bc5e7e2cd6f37ceb211a460c8e6557">shortlog</a> |
<a href="/comm-central/log/cc0ff188f5bc5e7e2cd6f37ceb211a460c8e6557">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/cc0ff188f5bc5e7e2cd6f37ceb211a460c8e6557">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/cc0ff188f5bc5e7e2cd6f37ceb211a460c8e6557">files</a> |
changeset |
<a href="/comm-central/raw-rev/cc0ff188f5bc5e7e2cd6f37ceb211a460c8e6557">raw</a>  | <a href="/comm-central/archive/cc0ff188f5bc5e7e2cd6f37ceb211a460c8e6557.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=801383">Bug 801383</a> Fix fallout from <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=779473">bug 779473</a> - make nsresult an enum class. Fix nsNNTPProtocol. r=Standard8 CLOSED TREE
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#115;&#104;&#117;&#97;&#32;&#67;&#114;&#97;&#110;&#109;&#101;&#114;&#32;&#60;&#80;&#105;&#100;&#103;&#101;&#111;&#116;&#49;&#56;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 16 Oct 2012 11:24:19 +0100</td></tr>

<tr>
 <td>changeset 11315</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/cc0ff188f5bc5e7e2cd6f37ceb211a460c8e6557">cc0ff188f5bc5e7e2cd6f37ceb211a460c8e6557</a></td>
</tr>



<tr>
<td>parent 11314</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/65b8e2fa4eba178e960aa0b2125cac986a90c0c3">65b8e2fa4eba178e960aa0b2125cac986a90c0c3</a>
</td>
</tr>

<tr>
<td>child 11316</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/8e0464b88631e3599b72703d8def26facd87c27c">8e0464b88631e3599b72703d8def26facd87c27c</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=cc0ff188f5bc5e7e2cd6f37ceb211a460c8e6557">8466</a></td></tr>
<tr><td>push user</td><td>bugzilla@standard8.plus.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 16 Oct 2012 10:25:50 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@cc0ff188f5bc [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=cc0ff188f5bc5e7e2cd6f37ceb211a460c8e6557">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=cc0ff188f5bc5e7e2cd6f37ceb211a460c8e6557&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=cc0ff188f5bc5e7e2cd6f37ceb211a460c8e6557&newProject=comm-central&newRevision=65b8e2fa4eba178e960aa0b2125cac986a90c0c3&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=cc0ff188f5bc5e7e2cd6f37ceb211a460c8e6557&newProject=comm-central&newRevision=65b8e2fa4eba178e960aa0b2125cac986a90c0c3&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=cc0ff188f5bc5e7e2cd6f37ceb211a460c8e6557&newProject=comm-central&newRevision=65b8e2fa4eba178e960aa0b2125cac986a90c0c3&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Standard8%29&revcount=50">Standard8</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=801383">801383</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=779473">779473</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=801383">Bug 801383</a> Fix fallout from <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=779473">bug 779473</a> - make nsresult an enum class. Fix nsNNTPProtocol. r=Standard8 CLOSED TREE</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cc0ff188f5bc5e7e2cd6f37ceb211a460c8e6557/mailnews/news/src/nntpCore.h">mailnews/news/src/nntpCore.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cc0ff188f5bc5e7e2cd6f37ceb211a460c8e6557/mailnews/news/src/nntpCore.h">file</a> |
<a href="/comm-central/annotate/cc0ff188f5bc5e7e2cd6f37ceb211a460c8e6557/mailnews/news/src/nntpCore.h">annotate</a> |
<a href="/comm-central/diff/cc0ff188f5bc5e7e2cd6f37ceb211a460c8e6557/mailnews/news/src/nntpCore.h">diff</a> |
<a href="/comm-central/comparison/cc0ff188f5bc5e7e2cd6f37ceb211a460c8e6557/mailnews/news/src/nntpCore.h">comparison</a> |
<a href="/comm-central/log/cc0ff188f5bc5e7e2cd6f37ceb211a460c8e6557/mailnews/news/src/nntpCore.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cc0ff188f5bc5e7e2cd6f37ceb211a460c8e6557/mailnews/news/src/nsNNTPProtocol.cpp">mailnews/news/src/nsNNTPProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cc0ff188f5bc5e7e2cd6f37ceb211a460c8e6557/mailnews/news/src/nsNNTPProtocol.cpp">file</a> |
<a href="/comm-central/annotate/cc0ff188f5bc5e7e2cd6f37ceb211a460c8e6557/mailnews/news/src/nsNNTPProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/cc0ff188f5bc5e7e2cd6f37ceb211a460c8e6557/mailnews/news/src/nsNNTPProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/cc0ff188f5bc5e7e2cd6f37ceb211a460c8e6557/mailnews/news/src/nsNNTPProtocol.cpp">comparison</a> |
<a href="/comm-central/log/cc0ff188f5bc5e7e2cd6f37ceb211a460c8e6557/mailnews/news/src/nsNNTPProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cc0ff188f5bc5e7e2cd6f37ceb211a460c8e6557/mailnews/news/src/nsNNTPProtocol.h">mailnews/news/src/nsNNTPProtocol.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cc0ff188f5bc5e7e2cd6f37ceb211a460c8e6557/mailnews/news/src/nsNNTPProtocol.h">file</a> |
<a href="/comm-central/annotate/cc0ff188f5bc5e7e2cd6f37ceb211a460c8e6557/mailnews/news/src/nsNNTPProtocol.h">annotate</a> |
<a href="/comm-central/diff/cc0ff188f5bc5e7e2cd6f37ceb211a460c8e6557/mailnews/news/src/nsNNTPProtocol.h">diff</a> |
<a href="/comm-central/comparison/cc0ff188f5bc5e7e2cd6f37ceb211a460c8e6557/mailnews/news/src/nsNNTPProtocol.h">comparison</a> |
<a href="/comm-central/log/cc0ff188f5bc5e7e2cd6f37ceb211a460c8e6557/mailnews/news/src/nsNNTPProtocol.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/news/src/nntpCore.h</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/news/src/nntpCore.h</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -137,17 +137,16 @@</span>
<a href="#l1.4"></a><span id="l1.4"> #define XP_PROGRESS_READ_NEWSGROUPINFO     1</span>
<a href="#l1.5"></a><span id="l1.5"> #define XP_PROGRESS_RECEIVE_ARTICLE       1</span>
<a href="#l1.6"></a><span id="l1.6"> #define XP_PROGRESS_RECEIVE_LISTARTICLES   1</span>
<a href="#l1.7"></a><span id="l1.7"> #define XP_PROGRESS_RECEIVE_NEWSGROUP     1</span>
<a href="#l1.8"></a><span id="l1.8"> #define XP_PROGRESS_SORT_ARTICLES         1</span>
<a href="#l1.9"></a><span id="l1.9"> #define XP_PROGRESS_READ_NEWSGROUP_COUNTS   1</span>
<a href="#l1.10"></a><span id="l1.10"> #define XP_THERMO_PERCENT_FORM         1</span>
<a href="#l1.11"></a><span id="l1.11"> #define XP_PROMPT_ENTER_USERNAME       1</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-#define MK_BAD_NNTP_CONNECTION        -216</span>
<a href="#l1.13"></a><span id="l1.13"> #define MK_NNTP_AUTH_FAILED            -260</span>
<a href="#l1.14"></a><span id="l1.14"> #define MK_NNTP_ERROR_MESSAGE          -304</span>
<a href="#l1.15"></a><span id="l1.15"> #define MK_NNTP_NEWSGROUP_SCAN_ERROR    -305</span>
<a href="#l1.16"></a><span id="l1.16"> #define MK_NNTP_SERVER_ERROR          -217</span>
<a href="#l1.17"></a><span id="l1.17"> #define MK_NNTP_SERVER_NOT_CONFIGURED     -307</span>
<a href="#l1.18"></a><span id="l1.18"> #define MK_TCP_READ_ERROR          -252</span>
<a href="#l1.19"></a><span id="l1.19"> #define MK_TCP_WRITE_ERROR          -236</span>
<a href="#l1.20"></a><span id="l1.20"> #define MK_NNTP_CANCEL_ERROR        -428</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/news/src/nsNNTPProtocol.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/news/src/nsNNTPProtocol.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1104,17 +1104,17 @@ nsresult nsNNTPProtocol::LoadUrl(nsIURI </span>
<a href="#l2.4"></a><span id="l2.4"> #endif</span>
<a href="#l2.5"></a><span id="l2.5">       ce-&gt;format_out = CLEAR_CACHE_BIT (ce-&gt;format_out);</span>
<a href="#l2.6"></a><span id="l2.6"> #endif</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9"> FAIL:</span>
<a href="#l2.10"></a><span id="l2.10">     if (NS_FAILED(rv))</span>
<a href="#l2.11"></a><span id="l2.11">     {</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-      AlertError(rv, nullptr);</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+      AlertError(0, nullptr);</span>
<a href="#l2.14"></a><span id="l2.14">       return rv;</span>
<a href="#l2.15"></a><span id="l2.15">     }</span>
<a href="#l2.16"></a><span id="l2.16">     else</span>
<a href="#l2.17"></a><span id="l2.17">     {</span>
<a href="#l2.18"></a><span id="l2.18">       if (!m_socketIsOpen)</span>
<a href="#l2.19"></a><span id="l2.19">       {</span>
<a href="#l2.20"></a><span id="l2.20">         m_nextStateAfterResponse = m_nextState;</span>
<a href="#l2.21"></a><span id="l2.21">         m_nextState = NNTP_RESPONSE;</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -1293,31 +1293,31 @@ nsresult nsNNTPProtocol::SendData(const </span>
<a href="#l2.23"></a><span id="l2.23">   return nsMsgProtocol::SendData(dataBuffer); // base class actually transmits the data</span>
<a href="#l2.24"></a><span id="l2.24"> }</span>
<a href="#l2.25"></a><span id="l2.25"> </span>
<a href="#l2.26"></a><span id="l2.26"> /* gets the response code from the nntp server and the</span>
<a href="#l2.27"></a><span id="l2.27">  * response line</span>
<a href="#l2.28"></a><span id="l2.28">  *</span>
<a href="#l2.29"></a><span id="l2.29">  * returns the TCP return code from the read</span>
<a href="#l2.30"></a><span id="l2.30">  */</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-int32_t nsNNTPProtocol::NewsResponse(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+nsresult nsNNTPProtocol::NewsResponse(nsIInputStream *inputStream, uint32_t length)</span>
<a href="#l2.33"></a><span id="l2.33"> {</span>
<a href="#l2.34"></a><span id="l2.34">   uint32_t status = 0;</span>
<a href="#l2.35"></a><span id="l2.35"> </span>
<a href="#l2.36"></a><span id="l2.36">   NS_PRECONDITION(nullptr != inputStream, &quot;invalid input stream&quot;);</span>
<a href="#l2.37"></a><span id="l2.37"> </span>
<a href="#l2.38"></a><span id="l2.38">   bool pauseForMoreData = false;</span>
<a href="#l2.39"></a><span id="l2.39">   char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData);</span>
<a href="#l2.40"></a><span id="l2.40"> </span>
<a href="#l2.41"></a><span id="l2.41">   NNTP_LOG_READ(line);</span>
<a href="#l2.42"></a><span id="l2.42"> </span>
<a href="#l2.43"></a><span id="l2.43">   if(pauseForMoreData)</span>
<a href="#l2.44"></a><span id="l2.44">   {</span>
<a href="#l2.45"></a><span id="l2.45">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineminus">-    return 0;</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.48"></a><span id="l2.48">   }</span>
<a href="#l2.49"></a><span id="l2.49"> </span>
<a href="#l2.50"></a><span id="l2.50">   if(!line)</span>
<a href="#l2.51"></a><span id="l2.51">     return NS_ERROR_FAILURE;</span>
<a href="#l2.52"></a><span id="l2.52"> </span>
<a href="#l2.53"></a><span id="l2.53">   ClearFlag(NNTP_PAUSE_FOR_READ);  /* don't pause if we got a line */</span>
<a href="#l2.54"></a><span id="l2.54"> </span>
<a href="#l2.55"></a><span id="l2.55">   /* almost correct */</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineat">@@ -1341,62 +1341,62 @@ int32_t nsNNTPProtocol::NewsResponse(nsI</span>
<a href="#l2.57"></a><span id="l2.57">   if (MK_NNTP_RESPONSE_AUTHINFO_REQUIRE == m_responseCode ||</span>
<a href="#l2.58"></a><span id="l2.58">     MK_NNTP_RESPONSE_AUTHINFO_SIMPLE_REQUIRE == m_responseCode)</span>
<a href="#l2.59"></a><span id="l2.59">   {</span>
<a href="#l2.60"></a><span id="l2.60">     m_nextState = NNTP_BEGIN_AUTHORIZE;</span>
<a href="#l2.61"></a><span id="l2.61">   }</span>
<a href="#l2.62"></a><span id="l2.62">   else if (MK_NNTP_RESPONSE_PERMISSION_DENIED == m_responseCode)</span>
<a href="#l2.63"></a><span id="l2.63">   {</span>
<a href="#l2.64"></a><span id="l2.64">     PR_FREEIF(line);</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineminus">-    return (0);</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.67"></a><span id="l2.67">   }</span>
<a href="#l2.68"></a><span id="l2.68">   else {</span>
<a href="#l2.69"></a><span id="l2.69">     m_nextState = m_nextStateAfterResponse;</span>
<a href="#l2.70"></a><span id="l2.70">   }</span>
<a href="#l2.71"></a><span id="l2.71"> </span>
<a href="#l2.72"></a><span id="l2.72">   PR_FREEIF(line);</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineminus">-  return(0);  /* everything ok */</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+  return NS_OK;</span>
<a href="#l2.75"></a><span id="l2.75"> }</span>
<a href="#l2.76"></a><span id="l2.76"> </span>
<a href="#l2.77"></a><span id="l2.77"> /* interpret the server response after the connect</span>
<a href="#l2.78"></a><span id="l2.78">  *</span>
<a href="#l2.79"></a><span id="l2.79">  * returns negative if the server responds unexpectedly</span>
<a href="#l2.80"></a><span id="l2.80">  */</span>
<a href="#l2.81"></a><span id="l2.81"> </span>
<a href="#l2.82"></a><span id="l2.82" class="difflineminus">-int32_t nsNNTPProtocol::LoginResponse()</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineplus">+nsresult nsNNTPProtocol::LoginResponse()</span>
<a href="#l2.84"></a><span id="l2.84"> {</span>
<a href="#l2.85"></a><span id="l2.85">   bool postingAllowed = m_responseCode == MK_NNTP_RESPONSE_POSTING_ALLOWED;</span>
<a href="#l2.86"></a><span id="l2.86"> </span>
<a href="#l2.87"></a><span id="l2.87">   if(MK_NNTP_RESPONSE_TYPE(m_responseCode)!=MK_NNTP_RESPONSE_TYPE_OK)</span>
<a href="#l2.88"></a><span id="l2.88">   {</span>
<a href="#l2.89"></a><span id="l2.89">     AlertError(MK_NNTP_ERROR_MESSAGE, m_responseText);</span>
<a href="#l2.90"></a><span id="l2.90"> </span>
<a href="#l2.91"></a><span id="l2.91">     m_nextState = NNTP_ERROR;</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineminus">-    return MK_BAD_NNTP_CONNECTION;</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l2.94"></a><span id="l2.94">   }</span>
<a href="#l2.95"></a><span id="l2.95"> </span>
<a href="#l2.96"></a><span id="l2.96">   m_nntpServer-&gt;SetPostingAllowed(postingAllowed);</span>
<a href="#l2.97"></a><span id="l2.97">   m_nextState = NNTP_SEND_MODE_READER;</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineminus">-  return(0);  /* good */</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineplus">+  return NS_OK;</span>
<a href="#l2.100"></a><span id="l2.100"> }</span>
<a href="#l2.101"></a><span id="l2.101"> </span>
<a href="#l2.102"></a><span id="l2.102" class="difflineminus">-int32_t nsNNTPProtocol::SendModeReader()</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineplus">+nsresult nsNNTPProtocol::SendModeReader()</span>
<a href="#l2.104"></a><span id="l2.104"> {</span>
<a href="#l2.105"></a><span id="l2.105">   nsresult rv = NS_OK;</span>
<a href="#l2.106"></a><span id="l2.106"> </span>
<a href="#l2.107"></a><span id="l2.107">   rv = SendData(NNTP_CMD_MODE_READER);</span>
<a href="#l2.108"></a><span id="l2.108">     m_nextState = NNTP_RESPONSE;</span>
<a href="#l2.109"></a><span id="l2.109">     m_nextStateAfterResponse = NNTP_SEND_MODE_READER_RESPONSE;</span>
<a href="#l2.110"></a><span id="l2.110">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.111"></a><span id="l2.111"> </span>
<a href="#l2.112"></a><span id="l2.112">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l2.113"></a><span id="l2.113">     return rv;</span>
<a href="#l2.114"></a><span id="l2.114"> }</span>
<a href="#l2.115"></a><span id="l2.115"> </span>
<a href="#l2.116"></a><span id="l2.116" class="difflineminus">-int32_t nsNNTPProtocol::SendModeReaderResponse()</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineplus">+nsresult nsNNTPProtocol::SendModeReaderResponse()</span>
<a href="#l2.118"></a><span id="l2.118"> {</span>
<a href="#l2.119"></a><span id="l2.119">   SetFlag(NNTP_READER_PERFORMED);</span>
<a href="#l2.120"></a><span id="l2.120"> </span>
<a href="#l2.121"></a><span id="l2.121">   /* ignore the response code and continue</span>
<a href="#l2.122"></a><span id="l2.122">    */</span>
<a href="#l2.123"></a><span id="l2.123">   bool pushAuth = false;</span>
<a href="#l2.124"></a><span id="l2.124">   nsresult rv = NS_OK;</span>
<a href="#l2.125"></a><span id="l2.125"> </span>
<a href="#l2.126"></a><span id="l2.126" class="difflineat">@@ -1413,46 +1413,46 @@ int32_t nsNNTPProtocol::SendModeReaderRe</span>
<a href="#l2.127"></a><span id="l2.127">   else {</span>
<a href="#l2.128"></a><span id="l2.128"> #ifdef HAVE_NNTP_EXTENSIONS</span>
<a href="#l2.129"></a><span id="l2.129">     m_nextState = SEND_LIST_EXTENSIONS;</span>
<a href="#l2.130"></a><span id="l2.130"> #else</span>
<a href="#l2.131"></a><span id="l2.131">     m_nextState = SEND_FIRST_NNTP_COMMAND;</span>
<a href="#l2.132"></a><span id="l2.132"> #endif  /* HAVE_NNTP_EXTENSIONS */</span>
<a href="#l2.133"></a><span id="l2.133">   }</span>
<a href="#l2.134"></a><span id="l2.134"> </span>
<a href="#l2.135"></a><span id="l2.135" class="difflineminus">-  return(0);</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineplus">+  return NS_OK;</span>
<a href="#l2.137"></a><span id="l2.137"> }</span>
<a href="#l2.138"></a><span id="l2.138"> </span>
<a href="#l2.139"></a><span id="l2.139" class="difflineminus">-int32_t nsNNTPProtocol::SendListExtensions()</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineplus">+nsresult nsNNTPProtocol::SendListExtensions()</span>
<a href="#l2.141"></a><span id="l2.141"> {</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineminus">-  int32_t status = 0;</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineminus">-  status = SendData(NNTP_CMD_LIST_EXTENSIONS);</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineplus">+  nsresult rv = SendData(NNTP_CMD_LIST_EXTENSIONS);</span>
<a href="#l2.145"></a><span id="l2.145"> </span>
<a href="#l2.146"></a><span id="l2.146">   m_nextState = NNTP_RESPONSE;</span>
<a href="#l2.147"></a><span id="l2.147">   m_nextStateAfterResponse = SEND_LIST_EXTENSIONS_RESPONSE;</span>
<a href="#l2.148"></a><span id="l2.148">   ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineminus">-  return status;</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineplus">+  return rv;</span>
<a href="#l2.151"></a><span id="l2.151"> }</span>
<a href="#l2.152"></a><span id="l2.152"> </span>
<a href="#l2.153"></a><span id="l2.153" class="difflineminus">-int32_t nsNNTPProtocol::SendListExtensionsResponse(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineplus">+nsresult nsNNTPProtocol::SendListExtensionsResponse(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l2.155"></a><span id="l2.155"> {</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineminus">-  uint32_t status = 0;</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l2.158"></a><span id="l2.158"> </span>
<a href="#l2.159"></a><span id="l2.159">   if (MK_NNTP_RESPONSE_TYPE(m_responseCode) == MK_NNTP_RESPONSE_TYPE_OK)</span>
<a href="#l2.160"></a><span id="l2.160">   {</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineplus">+    uint32_t status = 0;</span>
<a href="#l2.162"></a><span id="l2.162">     bool pauseForMoreData = false;</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineminus">-    char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData);</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineplus">+    char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData, &amp;rv);</span>
<a href="#l2.165"></a><span id="l2.165"> </span>
<a href="#l2.166"></a><span id="l2.166">     if(pauseForMoreData)</span>
<a href="#l2.167"></a><span id="l2.167">     {</span>
<a href="#l2.168"></a><span id="l2.168">       SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineminus">-      return 0;</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineplus">+      return NS_OK;</span>
<a href="#l2.171"></a><span id="l2.171">     }</span>
<a href="#l2.172"></a><span id="l2.172">     if (!line)</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineminus">-      return status;  /* no line yet */</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineplus">+      return rv;  /* no line yet */</span>
<a href="#l2.175"></a><span id="l2.175"> </span>
<a href="#l2.176"></a><span id="l2.176">         if ('.' != line[0]) {</span>
<a href="#l2.177"></a><span id="l2.177">             m_nntpServer-&gt;AddExtension(line);</span>
<a href="#l2.178"></a><span id="l2.178">         }</span>
<a href="#l2.179"></a><span id="l2.179">     else</span>
<a href="#l2.180"></a><span id="l2.180">     {</span>
<a href="#l2.181"></a><span id="l2.181">       /* tell libmsg that it's ok to ask this news host for extensions */</span>
<a href="#l2.182"></a><span id="l2.182">       m_nntpServer-&gt;SetSupportsExtensions(true);</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineat">@@ -1466,62 +1466,62 @@ int32_t nsNNTPProtocol::SendListExtensio</span>
<a href="#l2.184"></a><span id="l2.184">     /* LIST EXTENSIONS not recognized</span>
<a href="#l2.185"></a><span id="l2.185">      * tell libmsg not to ask for any more extensions and move on to</span>
<a href="#l2.186"></a><span id="l2.186">      * the real NNTP command we were trying to do. */</span>
<a href="#l2.187"></a><span id="l2.187"> </span>
<a href="#l2.188"></a><span id="l2.188">      m_nntpServer-&gt;SetSupportsExtensions(false);</span>
<a href="#l2.189"></a><span id="l2.189">      m_nextState = SEND_FIRST_NNTP_COMMAND;</span>
<a href="#l2.190"></a><span id="l2.190">   }</span>
<a href="#l2.191"></a><span id="l2.191"> </span>
<a href="#l2.192"></a><span id="l2.192" class="difflineminus">-  return status;</span>
<a href="#l2.193"></a><span id="l2.193" class="difflineplus">+  return NS_OK;</span>
<a href="#l2.194"></a><span id="l2.194"> }</span>
<a href="#l2.195"></a><span id="l2.195"> </span>
<a href="#l2.196"></a><span id="l2.196" class="difflineminus">-int32_t nsNNTPProtocol::SendListSearches()</span>
<a href="#l2.197"></a><span id="l2.197" class="difflineplus">+nsresult nsNNTPProtocol::SendListSearches()</span>
<a href="#l2.198"></a><span id="l2.198"> {</span>
<a href="#l2.199"></a><span id="l2.199">     nsresult rv;</span>
<a href="#l2.200"></a><span id="l2.200">     bool searchable=false;</span>
<a href="#l2.201"></a><span id="l2.201" class="difflineminus">-  int32_t status = 0;</span>
<a href="#l2.202"></a><span id="l2.202"> </span>
<a href="#l2.203"></a><span id="l2.203">     rv = m_nntpServer-&gt;QueryExtension(&quot;SEARCH&quot;,&amp;searchable);</span>
<a href="#l2.204"></a><span id="l2.204">     if (NS_SUCCEEDED(rv) &amp;&amp; searchable)</span>
<a href="#l2.205"></a><span id="l2.205">   {</span>
<a href="#l2.206"></a><span id="l2.206" class="difflineminus">-    status = SendData(NNTP_CMD_LIST_SEARCHES);</span>
<a href="#l2.207"></a><span id="l2.207" class="difflineplus">+    rv = SendData(NNTP_CMD_LIST_SEARCHES);</span>
<a href="#l2.208"></a><span id="l2.208"> </span>
<a href="#l2.209"></a><span id="l2.209">     m_nextState = NNTP_RESPONSE;</span>
<a href="#l2.210"></a><span id="l2.210">     m_nextStateAfterResponse = SEND_LIST_SEARCHES_RESPONSE;</span>
<a href="#l2.211"></a><span id="l2.211">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.212"></a><span id="l2.212">   }</span>
<a href="#l2.213"></a><span id="l2.213">   else</span>
<a href="#l2.214"></a><span id="l2.214">   {</span>
<a href="#l2.215"></a><span id="l2.215">     /* since SEARCH isn't supported, move on to GET */</span>
<a href="#l2.216"></a><span id="l2.216">     m_nextState = NNTP_GET_PROPERTIES;</span>
<a href="#l2.217"></a><span id="l2.217">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.218"></a><span id="l2.218">   }</span>
<a href="#l2.219"></a><span id="l2.219"> </span>
<a href="#l2.220"></a><span id="l2.220" class="difflineminus">-  return status;</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineplus">+  return rv;</span>
<a href="#l2.222"></a><span id="l2.222"> }</span>
<a href="#l2.223"></a><span id="l2.223"> </span>
<a href="#l2.224"></a><span id="l2.224" class="difflineminus">-int32_t nsNNTPProtocol::SendListSearchesResponse(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l2.225"></a><span id="l2.225" class="difflineplus">+nsresult nsNNTPProtocol::SendListSearchesResponse(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l2.226"></a><span id="l2.226"> {</span>
<a href="#l2.227"></a><span id="l2.227">   uint32_t status = 0;</span>
<a href="#l2.228"></a><span id="l2.228" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l2.229"></a><span id="l2.229"> </span>
<a href="#l2.230"></a><span id="l2.230">   NS_PRECONDITION(inputStream, &quot;invalid input stream&quot;);</span>
<a href="#l2.231"></a><span id="l2.231"> </span>
<a href="#l2.232"></a><span id="l2.232">   bool pauseForMoreData = false;</span>
<a href="#l2.233"></a><span id="l2.233" class="difflineminus">-  char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData);</span>
<a href="#l2.234"></a><span id="l2.234" class="difflineplus">+  char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData, &amp;rv);</span>
<a href="#l2.235"></a><span id="l2.235"> </span>
<a href="#l2.236"></a><span id="l2.236">   NNTP_LOG_READ(line);</span>
<a href="#l2.237"></a><span id="l2.237"> </span>
<a href="#l2.238"></a><span id="l2.238">   if(pauseForMoreData)</span>
<a href="#l2.239"></a><span id="l2.239">   {</span>
<a href="#l2.240"></a><span id="l2.240">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineminus">-    return 0;</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.243"></a><span id="l2.243">   }</span>
<a href="#l2.244"></a><span id="l2.244">   if (!line)</span>
<a href="#l2.245"></a><span id="l2.245" class="difflineminus">-    return status;  /* no line yet */</span>
<a href="#l2.246"></a><span id="l2.246" class="difflineplus">+    return rv;  /* no line yet */</span>
<a href="#l2.247"></a><span id="l2.247"> </span>
<a href="#l2.248"></a><span id="l2.248">   if ('.' != line[0])</span>
<a href="#l2.249"></a><span id="l2.249">   {</span>
<a href="#l2.250"></a><span id="l2.250">         nsAutoCString charset;</span>
<a href="#l2.251"></a><span id="l2.251">         nsAutoString lineUtf16;</span>
<a href="#l2.252"></a><span id="l2.252">         if (NS_FAILED(m_nntpServer-&gt;GetCharset(charset)) ||</span>
<a href="#l2.253"></a><span id="l2.253">             NS_FAILED(nsMsgI18NConvertToUnicode(charset.get(),</span>
<a href="#l2.254"></a><span id="l2.254">                                                 nsDependentCString(line),</span>
<a href="#l2.255"></a><span id="l2.255" class="difflineat">@@ -1535,95 +1535,95 @@ int32_t nsNNTPProtocol::SendListSearches</span>
<a href="#l2.256"></a><span id="l2.256">     /* all searchable groups received */</span>
<a href="#l2.257"></a><span id="l2.257">     /* LIST SRCHFIELDS is legal if the server supports the SEARCH extension, which */</span>
<a href="#l2.258"></a><span id="l2.258">     /* we already know it does */</span>
<a href="#l2.259"></a><span id="l2.259">     m_nextState = NNTP_LIST_SEARCH_HEADERS;</span>
<a href="#l2.260"></a><span id="l2.260">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.261"></a><span id="l2.261">   }</span>
<a href="#l2.262"></a><span id="l2.262"> </span>
<a href="#l2.263"></a><span id="l2.263">   PR_FREEIF(line);</span>
<a href="#l2.264"></a><span id="l2.264" class="difflineminus">-  return status;</span>
<a href="#l2.265"></a><span id="l2.265" class="difflineplus">+  return rv;</span>
<a href="#l2.266"></a><span id="l2.266"> }</span>
<a href="#l2.267"></a><span id="l2.267"> </span>
<a href="#l2.268"></a><span id="l2.268" class="difflineminus">-int32_t nsNNTPProtocol::SendListSearchHeaders()</span>
<a href="#l2.269"></a><span id="l2.269" class="difflineplus">+nsresult nsNNTPProtocol::SendListSearchHeaders()</span>
<a href="#l2.270"></a><span id="l2.270"> {</span>
<a href="#l2.271"></a><span id="l2.271" class="difflineminus">-  int32_t status = 0;</span>
<a href="#l2.272"></a><span id="l2.272" class="difflineminus">-  status = SendData(NNTP_CMD_LIST_SEARCH_FIELDS);</span>
<a href="#l2.273"></a><span id="l2.273" class="difflineplus">+  nsresult rv = SendData(NNTP_CMD_LIST_SEARCH_FIELDS);</span>
<a href="#l2.274"></a><span id="l2.274"> </span>
<a href="#l2.275"></a><span id="l2.275">   m_nextState = NNTP_RESPONSE;</span>
<a href="#l2.276"></a><span id="l2.276">   m_nextStateAfterResponse = NNTP_LIST_SEARCH_HEADERS_RESPONSE;</span>
<a href="#l2.277"></a><span id="l2.277">   SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.278"></a><span id="l2.278"> </span>
<a href="#l2.279"></a><span id="l2.279" class="difflineminus">-  return status;</span>
<a href="#l2.280"></a><span id="l2.280" class="difflineplus">+  return rv;</span>
<a href="#l2.281"></a><span id="l2.281"> }</span>
<a href="#l2.282"></a><span id="l2.282"> </span>
<a href="#l2.283"></a><span id="l2.283" class="difflineminus">-int32_t nsNNTPProtocol::SendListSearchHeadersResponse(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l2.284"></a><span id="l2.284" class="difflineplus">+nsresult nsNNTPProtocol::SendListSearchHeadersResponse(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l2.285"></a><span id="l2.285"> {</span>
<a href="#l2.286"></a><span id="l2.286">   uint32_t status = 0;</span>
<a href="#l2.287"></a><span id="l2.287" class="difflineplus">+  nsresult rv;</span>
<a href="#l2.288"></a><span id="l2.288"> </span>
<a href="#l2.289"></a><span id="l2.289">   bool pauseForMoreData = false;</span>
<a href="#l2.290"></a><span id="l2.290" class="difflineminus">-  char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData);</span>
<a href="#l2.291"></a><span id="l2.291" class="difflineplus">+  char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData, &amp;rv);</span>
<a href="#l2.292"></a><span id="l2.292"> </span>
<a href="#l2.293"></a><span id="l2.293">   if(pauseForMoreData)</span>
<a href="#l2.294"></a><span id="l2.294">   {</span>
<a href="#l2.295"></a><span id="l2.295">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.296"></a><span id="l2.296" class="difflineminus">-    return 0;</span>
<a href="#l2.297"></a><span id="l2.297" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.298"></a><span id="l2.298">   }</span>
<a href="#l2.299"></a><span id="l2.299">   if (!line)</span>
<a href="#l2.300"></a><span id="l2.300" class="difflineminus">-    return status;  /* no line yet */</span>
<a href="#l2.301"></a><span id="l2.301" class="difflineplus">+    return rv;  /* no line yet */</span>
<a href="#l2.302"></a><span id="l2.302"> </span>
<a href="#l2.303"></a><span id="l2.303">   if ('.' != line[0])</span>
<a href="#l2.304"></a><span id="l2.304">         m_nntpServer-&gt;AddSearchableHeader(line);</span>
<a href="#l2.305"></a><span id="l2.305">   else</span>
<a href="#l2.306"></a><span id="l2.306">   {</span>
<a href="#l2.307"></a><span id="l2.307">     m_nextState = NNTP_GET_PROPERTIES;</span>
<a href="#l2.308"></a><span id="l2.308">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.309"></a><span id="l2.309">   }</span>
<a href="#l2.310"></a><span id="l2.310"> </span>
<a href="#l2.311"></a><span id="l2.311">   PR_FREEIF(line);</span>
<a href="#l2.312"></a><span id="l2.312" class="difflineminus">-  return status;</span>
<a href="#l2.313"></a><span id="l2.313" class="difflineplus">+  return rv;</span>
<a href="#l2.314"></a><span id="l2.314"> }</span>
<a href="#l2.315"></a><span id="l2.315"> </span>
<a href="#l2.316"></a><span id="l2.316" class="difflineminus">-int32_t nsNNTPProtocol::GetProperties()</span>
<a href="#l2.317"></a><span id="l2.317" class="difflineplus">+nsresult nsNNTPProtocol::GetProperties()</span>
<a href="#l2.318"></a><span id="l2.318"> {</span>
<a href="#l2.319"></a><span id="l2.319">     nsresult rv;</span>
<a href="#l2.320"></a><span id="l2.320">     bool setget=false;</span>
<a href="#l2.321"></a><span id="l2.321" class="difflineminus">-  int32_t status = 0;</span>
<a href="#l2.322"></a><span id="l2.322"> </span>
<a href="#l2.323"></a><span id="l2.323">     rv = m_nntpServer-&gt;QueryExtension(&quot;SETGET&quot;,&amp;setget);</span>
<a href="#l2.324"></a><span id="l2.324">     if (NS_SUCCEEDED(rv) &amp;&amp; setget)</span>
<a href="#l2.325"></a><span id="l2.325">   {</span>
<a href="#l2.326"></a><span id="l2.326" class="difflineminus">-    status = SendData(NNTP_CMD_GET_PROPERTIES);</span>
<a href="#l2.327"></a><span id="l2.327" class="difflineplus">+    rv = SendData(NNTP_CMD_GET_PROPERTIES);</span>
<a href="#l2.328"></a><span id="l2.328">     m_nextState = NNTP_RESPONSE;</span>
<a href="#l2.329"></a><span id="l2.329">     m_nextStateAfterResponse = NNTP_GET_PROPERTIES_RESPONSE;</span>
<a href="#l2.330"></a><span id="l2.330">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.331"></a><span id="l2.331">   }</span>
<a href="#l2.332"></a><span id="l2.332">   else</span>
<a href="#l2.333"></a><span id="l2.333">   {</span>
<a href="#l2.334"></a><span id="l2.334">     /* since GET isn't supported, move on LIST SUBSCRIPTIONS */</span>
<a href="#l2.335"></a><span id="l2.335">     m_nextState = SEND_LIST_SUBSCRIPTIONS;</span>
<a href="#l2.336"></a><span id="l2.336">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.337"></a><span id="l2.337">   }</span>
<a href="#l2.338"></a><span id="l2.338" class="difflineminus">-  return status;</span>
<a href="#l2.339"></a><span id="l2.339" class="difflineplus">+  return rv;</span>
<a href="#l2.340"></a><span id="l2.340"> }</span>
<a href="#l2.341"></a><span id="l2.341"> </span>
<a href="#l2.342"></a><span id="l2.342" class="difflineminus">-int32_t nsNNTPProtocol::GetPropertiesResponse(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l2.343"></a><span id="l2.343" class="difflineplus">+nsresult nsNNTPProtocol::GetPropertiesResponse(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l2.344"></a><span id="l2.344"> {</span>
<a href="#l2.345"></a><span id="l2.345">   uint32_t status = 0;</span>
<a href="#l2.346"></a><span id="l2.346" class="difflineplus">+  nsresult rv;</span>
<a href="#l2.347"></a><span id="l2.347"> </span>
<a href="#l2.348"></a><span id="l2.348">   bool pauseForMoreData = false;</span>
<a href="#l2.349"></a><span id="l2.349" class="difflineminus">-  char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData);</span>
<a href="#l2.350"></a><span id="l2.350" class="difflineplus">+  char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData, &amp;rv);</span>
<a href="#l2.351"></a><span id="l2.351"> </span>
<a href="#l2.352"></a><span id="l2.352">   if(pauseForMoreData)</span>
<a href="#l2.353"></a><span id="l2.353">   {</span>
<a href="#l2.354"></a><span id="l2.354">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.355"></a><span id="l2.355" class="difflineminus">-    return 0;</span>
<a href="#l2.356"></a><span id="l2.356" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.357"></a><span id="l2.357">   }</span>
<a href="#l2.358"></a><span id="l2.358">   if (!line)</span>
<a href="#l2.359"></a><span id="l2.359" class="difflineminus">-    return status;  /* no line yet */</span>
<a href="#l2.360"></a><span id="l2.360" class="difflineplus">+    return rv;  /* no line yet */</span>
<a href="#l2.361"></a><span id="l2.361"> </span>
<a href="#l2.362"></a><span id="l2.362">   if ('.' != line[0])</span>
<a href="#l2.363"></a><span id="l2.363">   {</span>
<a href="#l2.364"></a><span id="l2.364">     char *propertyName = NS_strdup(line);</span>
<a href="#l2.365"></a><span id="l2.365">     if (propertyName)</span>
<a href="#l2.366"></a><span id="l2.366">     {</span>
<a href="#l2.367"></a><span id="l2.367">       char *space = PL_strchr(propertyName, ' ');</span>
<a href="#l2.368"></a><span id="l2.368">       if (space)</span>
<a href="#l2.369"></a><span id="l2.369" class="difflineat">@@ -1638,60 +1638,60 @@ int32_t nsNNTPProtocol::GetPropertiesRes</span>
<a href="#l2.370"></a><span id="l2.370">   else</span>
<a href="#l2.371"></a><span id="l2.371">   {</span>
<a href="#l2.372"></a><span id="l2.372">     /* all GET properties received, move on to LIST SUBSCRIPTIONS */</span>
<a href="#l2.373"></a><span id="l2.373">     m_nextState = SEND_LIST_SUBSCRIPTIONS;</span>
<a href="#l2.374"></a><span id="l2.374">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.375"></a><span id="l2.375">   }</span>
<a href="#l2.376"></a><span id="l2.376"> </span>
<a href="#l2.377"></a><span id="l2.377">   PR_FREEIF(line);</span>
<a href="#l2.378"></a><span id="l2.378" class="difflineminus">-  return status;</span>
<a href="#l2.379"></a><span id="l2.379" class="difflineplus">+  return rv;</span>
<a href="#l2.380"></a><span id="l2.380"> }</span>
<a href="#l2.381"></a><span id="l2.381"> </span>
<a href="#l2.382"></a><span id="l2.382" class="difflineminus">-int32_t nsNNTPProtocol::SendListSubscriptions()</span>
<a href="#l2.383"></a><span id="l2.383" class="difflineplus">+nsresult nsNNTPProtocol::SendListSubscriptions()</span>
<a href="#l2.384"></a><span id="l2.384"> {</span>
<a href="#l2.385"></a><span id="l2.385" class="difflineminus">-   int32_t status = 0;</span>
<a href="#l2.386"></a><span id="l2.386" class="difflineplus">+    nsresult rv = NS_OK;</span>
<a href="#l2.387"></a><span id="l2.387"> #if 0</span>
<a href="#l2.388"></a><span id="l2.388" class="difflineminus">-    nsresult rv;</span>
<a href="#l2.389"></a><span id="l2.389">     bool searchable=false;</span>
<a href="#l2.390"></a><span id="l2.390">     rv = m_nntpServer-&gt;QueryExtension(&quot;LISTSUBSCR&quot;,&amp;listsubscr);</span>
<a href="#l2.391"></a><span id="l2.391">     if (NS_SUCCEEDED(rv) &amp;&amp; listsubscr)</span>
<a href="#l2.392"></a><span id="l2.392"> #else</span>
<a href="#l2.393"></a><span id="l2.393">   if (0)</span>
<a href="#l2.394"></a><span id="l2.394"> #endif</span>
<a href="#l2.395"></a><span id="l2.395">   {</span>
<a href="#l2.396"></a><span id="l2.396" class="difflineminus">-    status = SendData(NNTP_CMD_LIST_SUBSCRIPTIONS);</span>
<a href="#l2.397"></a><span id="l2.397" class="difflineplus">+    rv = SendData(NNTP_CMD_LIST_SUBSCRIPTIONS);</span>
<a href="#l2.398"></a><span id="l2.398">     m_nextState = NNTP_RESPONSE;</span>
<a href="#l2.399"></a><span id="l2.399">     m_nextStateAfterResponse = SEND_LIST_SUBSCRIPTIONS_RESPONSE;</span>
<a href="#l2.400"></a><span id="l2.400">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.401"></a><span id="l2.401">   }</span>
<a href="#l2.402"></a><span id="l2.402">   else</span>
<a href="#l2.403"></a><span id="l2.403">   {</span>
<a href="#l2.404"></a><span id="l2.404">     /* since LIST SUBSCRIPTIONS isn't supported, move on to real work */</span>
<a href="#l2.405"></a><span id="l2.405">     m_nextState = SEND_FIRST_NNTP_COMMAND;</span>
<a href="#l2.406"></a><span id="l2.406">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.407"></a><span id="l2.407">   }</span>
<a href="#l2.408"></a><span id="l2.408"> </span>
<a href="#l2.409"></a><span id="l2.409" class="difflineminus">-  return status;</span>
<a href="#l2.410"></a><span id="l2.410" class="difflineplus">+  return rv;</span>
<a href="#l2.411"></a><span id="l2.411"> }</span>
<a href="#l2.412"></a><span id="l2.412"> </span>
<a href="#l2.413"></a><span id="l2.413" class="difflineminus">-int32_t nsNNTPProtocol::SendListSubscriptionsResponse(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l2.414"></a><span id="l2.414" class="difflineplus">+nsresult nsNNTPProtocol::SendListSubscriptionsResponse(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l2.415"></a><span id="l2.415"> {</span>
<a href="#l2.416"></a><span id="l2.416">   uint32_t status = 0;</span>
<a href="#l2.417"></a><span id="l2.417" class="difflineplus">+  nsresult rv;</span>
<a href="#l2.418"></a><span id="l2.418"> </span>
<a href="#l2.419"></a><span id="l2.419">   bool pauseForMoreData = false;</span>
<a href="#l2.420"></a><span id="l2.420" class="difflineminus">-  char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData);</span>
<a href="#l2.421"></a><span id="l2.421" class="difflineplus">+  char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData, &amp;rv);</span>
<a href="#l2.422"></a><span id="l2.422"> </span>
<a href="#l2.423"></a><span id="l2.423">   if(pauseForMoreData)</span>
<a href="#l2.424"></a><span id="l2.424">   {</span>
<a href="#l2.425"></a><span id="l2.425">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.426"></a><span id="l2.426" class="difflineminus">-    return 0;</span>
<a href="#l2.427"></a><span id="l2.427" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.428"></a><span id="l2.428">   }</span>
<a href="#l2.429"></a><span id="l2.429">   if (!line)</span>
<a href="#l2.430"></a><span id="l2.430" class="difflineminus">-    return status;  /* no line yet */</span>
<a href="#l2.431"></a><span id="l2.431" class="difflineplus">+    return rv;  /* no line yet */</span>
<a href="#l2.432"></a><span id="l2.432"> </span>
<a href="#l2.433"></a><span id="l2.433">   if ('.' != line[0])</span>
<a href="#l2.434"></a><span id="l2.434">   {</span>
<a href="#l2.435"></a><span id="l2.435">         NS_ERROR(&quot;fix me&quot;);</span>
<a href="#l2.436"></a><span id="l2.436"> #if 0</span>
<a href="#l2.437"></a><span id="l2.437">     char *url = PR_smprintf (&quot;%s//%s/%s&quot;, NEWS_SCHEME, m_hostName, line);</span>
<a href="#l2.438"></a><span id="l2.438">     if (url)</span>
<a href="#l2.439"></a><span id="l2.439">       MSG_AddSubscribedNewsgroup (cd-&gt;pane, url);</span>
<a href="#l2.440"></a><span id="l2.440" class="difflineat">@@ -1700,27 +1700,26 @@ int32_t nsNNTPProtocol::SendListSubscrip</span>
<a href="#l2.441"></a><span id="l2.441">   else</span>
<a href="#l2.442"></a><span id="l2.442">   {</span>
<a href="#l2.443"></a><span id="l2.443">     /* all default subscriptions received */</span>
<a href="#l2.444"></a><span id="l2.444">     m_nextState = SEND_FIRST_NNTP_COMMAND;</span>
<a href="#l2.445"></a><span id="l2.445">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.446"></a><span id="l2.446">   }</span>
<a href="#l2.447"></a><span id="l2.447"> </span>
<a href="#l2.448"></a><span id="l2.448">   PR_FREEIF(line);</span>
<a href="#l2.449"></a><span id="l2.449" class="difflineminus">-  return status;</span>
<a href="#l2.450"></a><span id="l2.450" class="difflineplus">+  return rv;</span>
<a href="#l2.451"></a><span id="l2.451"> }</span>
<a href="#l2.452"></a><span id="l2.452"> </span>
<a href="#l2.453"></a><span id="l2.453"> /* figure out what the first command is and send it</span>
<a href="#l2.454"></a><span id="l2.454">  *</span>
<a href="#l2.455"></a><span id="l2.455">  * returns the status from the NETWrite */</span>
<a href="#l2.456"></a><span id="l2.456"> </span>
<a href="#l2.457"></a><span id="l2.457" class="difflineminus">-int32_t nsNNTPProtocol::SendFirstNNTPCommand(nsIURI * url)</span>
<a href="#l2.458"></a><span id="l2.458" class="difflineplus">+nsresult nsNNTPProtocol::SendFirstNNTPCommand(nsIURI * url)</span>
<a href="#l2.459"></a><span id="l2.459"> {</span>
<a href="#l2.460"></a><span id="l2.460">     char *command=0;</span>
<a href="#l2.461"></a><span id="l2.461" class="difflineminus">-    int32_t status = 0;</span>
<a href="#l2.462"></a><span id="l2.462"> </span>
<a href="#l2.463"></a><span id="l2.463">     if (m_typeWanted == ARTICLE_WANTED) {</span>
<a href="#l2.464"></a><span id="l2.464">         if (m_key != nsMsgKey_None) {</span>
<a href="#l2.465"></a><span id="l2.465">             nsresult rv;</span>
<a href="#l2.466"></a><span id="l2.466">             nsCString newsgroupName;</span>
<a href="#l2.467"></a><span id="l2.467">             if (m_newsFolder) {</span>
<a href="#l2.468"></a><span id="l2.468">                 rv = m_newsFolder-&gt;GetRawName(newsgroupName);</span>
<a href="#l2.469"></a><span id="l2.469">                 NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l2.470"></a><span id="l2.470" class="difflineat">@@ -1731,36 +1730,36 @@ int32_t nsNNTPProtocol::SendFirstNNTPCom</span>
<a href="#l2.471"></a><span id="l2.471">             // if the current group is the desired group, we can just issue the ARTICLE command</span>
<a href="#l2.472"></a><span id="l2.472">             // if not, we have to do a GROUP first</span>
<a href="#l2.473"></a><span id="l2.473">             if (newsgroupName.Equals(m_currentGroup))</span>
<a href="#l2.474"></a><span id="l2.474">               m_nextState = NNTP_SEND_ARTICLE_NUMBER;</span>
<a href="#l2.475"></a><span id="l2.475">             else</span>
<a href="#l2.476"></a><span id="l2.476">               m_nextState = NNTP_SEND_GROUP_FOR_ARTICLE;</span>
<a href="#l2.477"></a><span id="l2.477"> </span>
<a href="#l2.478"></a><span id="l2.478">             ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.479"></a><span id="l2.479" class="difflineminus">-            return 0;</span>
<a href="#l2.480"></a><span id="l2.480" class="difflineplus">+            return NS_OK;</span>
<a href="#l2.481"></a><span id="l2.481">         }</span>
<a href="#l2.482"></a><span id="l2.482">     }</span>
<a href="#l2.483"></a><span id="l2.483"> </span>
<a href="#l2.484"></a><span id="l2.484">     if(m_typeWanted == NEWS_POST)</span>
<a href="#l2.485"></a><span id="l2.485">     {  /* posting to the news group */</span>
<a href="#l2.486"></a><span id="l2.486">         NS_MsgSACopy(&amp;command, &quot;POST&quot;);</span>
<a href="#l2.487"></a><span id="l2.487">     }</span>
<a href="#l2.488"></a><span id="l2.488">   else if (m_typeWanted == NEW_GROUPS)</span>
<a href="#l2.489"></a><span id="l2.489">   {</span>
<a href="#l2.490"></a><span id="l2.490">       uint32_t last_update;</span>
<a href="#l2.491"></a><span id="l2.491">       nsresult rv;</span>
<a href="#l2.492"></a><span id="l2.492"> </span>
<a href="#l2.493"></a><span id="l2.493">       if (!m_nntpServer)</span>
<a href="#l2.494"></a><span id="l2.494">       {</span>
<a href="#l2.495"></a><span id="l2.495">         NNTP_LOG_NOTE(&quot;m_nntpServer is null, panic!&quot;);</span>
<a href="#l2.496"></a><span id="l2.496" class="difflineminus">-        return -1;</span>
<a href="#l2.497"></a><span id="l2.497" class="difflineplus">+        return NS_ERROR_FAILURE;</span>
<a href="#l2.498"></a><span id="l2.498">       }</span>
<a href="#l2.499"></a><span id="l2.499">       rv = m_nntpServer-&gt;GetLastUpdatedTime(&amp;last_update);</span>
<a href="#l2.500"></a><span id="l2.500" class="difflineminus">-      if (NS_FAILED(rv)) return -1;</span>
<a href="#l2.501"></a><span id="l2.501" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.502"></a><span id="l2.502"> </span>
<a href="#l2.503"></a><span id="l2.503">       if (!last_update)</span>
<a href="#l2.504"></a><span id="l2.504">     {</span>
<a href="#l2.505"></a><span id="l2.505">         NS_MsgSACopy(&amp;command, &quot;LIST&quot;);</span>
<a href="#l2.506"></a><span id="l2.506">       }</span>
<a href="#l2.507"></a><span id="l2.507">     else</span>
<a href="#l2.508"></a><span id="l2.508">       {</span>
<a href="#l2.509"></a><span id="l2.509">         char small_buf[64];</span>
<a href="#l2.510"></a><span id="l2.510" class="difflineat">@@ -1776,17 +1775,17 @@ int32_t nsNNTPProtocol::SendFirstNNTPCom</span>
<a href="#l2.511"></a><span id="l2.511">     {</span>
<a href="#l2.512"></a><span id="l2.512">       nsresult rv;</span>
<a href="#l2.513"></a><span id="l2.513"> </span>
<a href="#l2.514"></a><span id="l2.514">     ClearFlag(NNTP_USE_FANCY_NEWSGROUP);</span>
<a href="#l2.515"></a><span id="l2.515"> </span>
<a href="#l2.516"></a><span id="l2.516">         NS_ASSERTION(m_nntpServer, &quot;no m_nntpServer&quot;);</span>
<a href="#l2.517"></a><span id="l2.517">     if (!m_nntpServer) {</span>
<a href="#l2.518"></a><span id="l2.518">           NNTP_LOG_NOTE(&quot;m_nntpServer is null, panic!&quot;);</span>
<a href="#l2.519"></a><span id="l2.519" class="difflineminus">-          return -1;</span>
<a href="#l2.520"></a><span id="l2.520" class="difflineplus">+          return NS_ERROR_FAILURE;</span>
<a href="#l2.521"></a><span id="l2.521">     }</span>
<a href="#l2.522"></a><span id="l2.522"> </span>
<a href="#l2.523"></a><span id="l2.523">       bool xactive=false;</span>
<a href="#l2.524"></a><span id="l2.524">       rv = m_nntpServer-&gt;QueryExtension(&quot;XACTIVE&quot;,&amp;xactive);</span>
<a href="#l2.525"></a><span id="l2.525">       if (NS_SUCCEEDED(rv) &amp;&amp; xactive)</span>
<a href="#l2.526"></a><span id="l2.526">       {</span>
<a href="#l2.527"></a><span id="l2.527">         NS_MsgSACopy(&amp;command, &quot;LIST XACTIVE&quot;);</span>
<a href="#l2.528"></a><span id="l2.528">         SetFlag(NNTP_USE_FANCY_NEWSGROUP);</span>
<a href="#l2.529"></a><span id="l2.529" class="difflineat">@@ -1796,60 +1795,60 @@ int32_t nsNNTPProtocol::SendFirstNNTPCom</span>
<a href="#l2.530"></a><span id="l2.530">         NS_MsgSACopy(&amp;command, &quot;LIST&quot;);</span>
<a href="#l2.531"></a><span id="l2.531">       }</span>
<a href="#l2.532"></a><span id="l2.532">   }</span>
<a href="#l2.533"></a><span id="l2.533">   else if(m_typeWanted == GROUP_WANTED)</span>
<a href="#l2.534"></a><span id="l2.534">     {</span>
<a href="#l2.535"></a><span id="l2.535">         nsresult rv = NS_ERROR_NULL_POINTER;</span>
<a href="#l2.536"></a><span id="l2.536"> </span>
<a href="#l2.537"></a><span id="l2.537">         NS_ASSERTION(m_newsFolder, &quot;m_newsFolder is null, panic!&quot;);</span>
<a href="#l2.538"></a><span id="l2.538" class="difflineminus">-        if (!m_newsFolder) return -1;</span>
<a href="#l2.539"></a><span id="l2.539" class="difflineplus">+        if (!m_newsFolder) return NS_ERROR_FAILURE;</span>
<a href="#l2.540"></a><span id="l2.540"> </span>
<a href="#l2.541"></a><span id="l2.541">         nsCString group_name;</span>
<a href="#l2.542"></a><span id="l2.542">         rv = m_newsFolder-&gt;GetRawName(group_name);</span>
<a href="#l2.543"></a><span id="l2.543">         NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to get newsgroup name&quot;);</span>
<a href="#l2.544"></a><span id="l2.544" class="difflineminus">-        if (NS_FAILED(rv)) return -1;</span>
<a href="#l2.545"></a><span id="l2.545" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.546"></a><span id="l2.546"> </span>
<a href="#l2.547"></a><span id="l2.547">         m_firstArticle = 0;</span>
<a href="#l2.548"></a><span id="l2.548">         m_lastArticle = 0;</span>
<a href="#l2.549"></a><span id="l2.549"> </span>
<a href="#l2.550"></a><span id="l2.550">         NS_MsgSACopy(&amp;command, &quot;GROUP &quot;);</span>
<a href="#l2.551"></a><span id="l2.551">         NS_MsgSACat(&amp;command, group_name.get());</span>
<a href="#l2.552"></a><span id="l2.552">       }</span>
<a href="#l2.553"></a><span id="l2.553">   else if (m_typeWanted == SEARCH_WANTED)</span>
<a href="#l2.554"></a><span id="l2.554">   {</span>
<a href="#l2.555"></a><span id="l2.555">     nsresult rv;</span>
<a href="#l2.556"></a><span id="l2.556">     PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;(%p) doing GROUP for XPAT&quot;, this));</span>
<a href="#l2.557"></a><span id="l2.557">     nsCString group_name;</span>
<a href="#l2.558"></a><span id="l2.558"> </span>
<a href="#l2.559"></a><span id="l2.559">     /* for XPAT, we have to GROUP into the group before searching */</span>
<a href="#l2.560"></a><span id="l2.560">     if (!m_newsFolder) {</span>
<a href="#l2.561"></a><span id="l2.561">         NNTP_LOG_NOTE(&quot;m_newsFolder is null, panic!&quot;);</span>
<a href="#l2.562"></a><span id="l2.562" class="difflineminus">-        return -1;</span>
<a href="#l2.563"></a><span id="l2.563" class="difflineplus">+        return NS_ERROR_FAILURE;</span>
<a href="#l2.564"></a><span id="l2.564">     }</span>
<a href="#l2.565"></a><span id="l2.565">     rv = m_newsFolder-&gt;GetRawName(group_name);</span>
<a href="#l2.566"></a><span id="l2.566" class="difflineminus">-    if (NS_FAILED(rv)) return -1;</span>
<a href="#l2.567"></a><span id="l2.567" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.568"></a><span id="l2.568"> </span>
<a href="#l2.569"></a><span id="l2.569">     NS_MsgSACopy(&amp;command, &quot;GROUP &quot;);</span>
<a href="#l2.570"></a><span id="l2.570">     NS_MsgSACat (&amp;command, group_name.get());</span>
<a href="#l2.571"></a><span id="l2.571"> </span>
<a href="#l2.572"></a><span id="l2.572">     // force a GROUP next time</span>
<a href="#l2.573"></a><span id="l2.573">     m_currentGroup.Truncate();</span>
<a href="#l2.574"></a><span id="l2.574">     m_nextState = NNTP_RESPONSE;</span>
<a href="#l2.575"></a><span id="l2.575">     m_nextStateAfterResponse = NNTP_XPAT_SEND;</span>
<a href="#l2.576"></a><span id="l2.576">   }</span>
<a href="#l2.577"></a><span id="l2.577">   else if (m_typeWanted == IDS_WANTED)</span>
<a href="#l2.578"></a><span id="l2.578">   {</span>
<a href="#l2.579"></a><span id="l2.579">     m_nextState = NNTP_LIST_GROUP;</span>
<a href="#l2.580"></a><span id="l2.580" class="difflineminus">-    return 0;</span>
<a href="#l2.581"></a><span id="l2.581" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.582"></a><span id="l2.582">   }</span>
<a href="#l2.583"></a><span id="l2.583">   else  /* article or cancel */</span>
<a href="#l2.584"></a><span id="l2.584">   {</span>
<a href="#l2.585"></a><span id="l2.585">     NS_ASSERTION(!m_messageID.IsEmpty(), &quot;No message ID, bailing!&quot;);</span>
<a href="#l2.586"></a><span id="l2.586" class="difflineminus">-    if (m_messageID.IsEmpty()) return -1;</span>
<a href="#l2.587"></a><span id="l2.587" class="difflineplus">+    if (m_messageID.IsEmpty()) return NS_ERROR_FAILURE;</span>
<a href="#l2.588"></a><span id="l2.588"> </span>
<a href="#l2.589"></a><span id="l2.589">     if (m_typeWanted == CANCEL_WANTED)</span>
<a href="#l2.590"></a><span id="l2.590">       NS_MsgSACopy(&amp;command, &quot;HEAD &quot;);</span>
<a href="#l2.591"></a><span id="l2.591">     else {</span>
<a href="#l2.592"></a><span id="l2.592">       NS_ASSERTION(m_typeWanted == ARTICLE_WANTED, &quot;not cancel, and not article&quot;);</span>
<a href="#l2.593"></a><span id="l2.593">       NS_MsgSACopy(&amp;command, &quot;ARTICLE &quot;);</span>
<a href="#l2.594"></a><span id="l2.594">     }</span>
<a href="#l2.595"></a><span id="l2.595"> </span>
<a href="#l2.596"></a><span id="l2.596" class="difflineat">@@ -1858,46 +1857,45 @@ int32_t nsNNTPProtocol::SendFirstNNTPCom</span>
<a href="#l2.597"></a><span id="l2.597"> </span>
<a href="#l2.598"></a><span id="l2.598">     NS_MsgSACat(&amp;command, m_messageID.get());</span>
<a href="#l2.599"></a><span id="l2.599"> </span>
<a href="#l2.600"></a><span id="l2.600">     if (PL_strchr(command+8, '&gt;')==0)</span>
<a href="#l2.601"></a><span id="l2.601">       NS_MsgSACat(&amp;command,&quot;&gt;&quot;);</span>
<a href="#l2.602"></a><span id="l2.602">   }</span>
<a href="#l2.603"></a><span id="l2.603"> </span>
<a href="#l2.604"></a><span id="l2.604">   NS_MsgSACat(&amp;command, CRLF);</span>
<a href="#l2.605"></a><span id="l2.605" class="difflineminus">-  status = SendData(command);</span>
<a href="#l2.606"></a><span id="l2.606" class="difflineplus">+  nsresult rv = SendData(command);</span>
<a href="#l2.607"></a><span id="l2.607">   PR_Free(command);</span>
<a href="#l2.608"></a><span id="l2.608"> </span>
<a href="#l2.609"></a><span id="l2.609">   m_nextState = NNTP_RESPONSE;</span>
<a href="#l2.610"></a><span id="l2.610">   if (m_typeWanted != SEARCH_WANTED)</span>
<a href="#l2.611"></a><span id="l2.611">     m_nextStateAfterResponse = SEND_FIRST_NNTP_COMMAND_RESPONSE;</span>
<a href="#l2.612"></a><span id="l2.612">   SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.613"></a><span id="l2.613" class="difflineminus">-    return(status);</span>
<a href="#l2.614"></a><span id="l2.614" class="difflineplus">+  return rv;</span>
<a href="#l2.615"></a><span id="l2.615"> } /* sent first command */</span>
<a href="#l2.616"></a><span id="l2.616"> </span>
<a href="#l2.617"></a><span id="l2.617"> </span>
<a href="#l2.618"></a><span id="l2.618"> /* interprets the server response from the first command sent</span>
<a href="#l2.619"></a><span id="l2.619">  *</span>
<a href="#l2.620"></a><span id="l2.620">  * returns negative if the server responds unexpectedly</span>
<a href="#l2.621"></a><span id="l2.621">  */</span>
<a href="#l2.622"></a><span id="l2.622"> </span>
<a href="#l2.623"></a><span id="l2.623" class="difflineminus">-int32_t nsNNTPProtocol::SendFirstNNTPCommandResponse()</span>
<a href="#l2.624"></a><span id="l2.624" class="difflineplus">+nsresult nsNNTPProtocol::SendFirstNNTPCommandResponse()</span>
<a href="#l2.625"></a><span id="l2.625"> {</span>
<a href="#l2.626"></a><span id="l2.626" class="difflineminus">-  int32_t status = 0;</span>
<a href="#l2.627"></a><span id="l2.627">   int32_t major_opcode = MK_NNTP_RESPONSE_TYPE(m_responseCode);</span>
<a href="#l2.628"></a><span id="l2.628"> </span>
<a href="#l2.629"></a><span id="l2.629">   if((major_opcode == MK_NNTP_RESPONSE_TYPE_CONT &amp;&amp;</span>
<a href="#l2.630"></a><span id="l2.630">     m_typeWanted == NEWS_POST)</span>
<a href="#l2.631"></a><span id="l2.631">     || (major_opcode == MK_NNTP_RESPONSE_TYPE_OK &amp;&amp;</span>
<a href="#l2.632"></a><span id="l2.632">     m_typeWanted != NEWS_POST) )</span>
<a href="#l2.633"></a><span id="l2.633">   {</span>
<a href="#l2.634"></a><span id="l2.634"> </span>
<a href="#l2.635"></a><span id="l2.635">     m_nextState = SETUP_NEWS_STREAM;</span>
<a href="#l2.636"></a><span id="l2.636">     SetFlag(NNTP_SOME_PROTOCOL_SUCCEEDED);</span>
<a href="#l2.637"></a><span id="l2.637" class="difflineminus">-    return(0);  /* good */</span>
<a href="#l2.638"></a><span id="l2.638" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.639"></a><span id="l2.639">   }</span>
<a href="#l2.640"></a><span id="l2.640">   else</span>
<a href="#l2.641"></a><span id="l2.641">   {</span>
<a href="#l2.642"></a><span id="l2.642">     nsresult rv = NS_OK;</span>
<a href="#l2.643"></a><span id="l2.643"> </span>
<a href="#l2.644"></a><span id="l2.644">     nsString group_name;</span>
<a href="#l2.645"></a><span id="l2.645">     NS_ASSERTION(m_newsFolder, &quot;no newsFolder&quot;);</span>
<a href="#l2.646"></a><span id="l2.646">     if (m_newsFolder)</span>
<a href="#l2.647"></a><span id="l2.647" class="difflineat">@@ -1996,48 +1994,47 @@ int32_t nsNNTPProtocol::SendFirstNNTPCom</span>
<a href="#l2.648"></a><span id="l2.648">     // it again.</span>
<a href="#l2.649"></a><span id="l2.649">     else if (savingArticleOffline)</span>
<a href="#l2.650"></a><span id="l2.650">     {</span>
<a href="#l2.651"></a><span id="l2.651">       if ((m_key != nsMsgKey_None) &amp;&amp; (m_newsFolder)) {</span>
<a href="#l2.652"></a><span id="l2.652">          rv = m_newsFolder-&gt;RemoveMessage(m_key);</span>
<a href="#l2.653"></a><span id="l2.653">       }</span>
<a href="#l2.654"></a><span id="l2.654">     }</span>
<a href="#l2.655"></a><span id="l2.655"> </span>
<a href="#l2.656"></a><span id="l2.656" class="difflineminus">-    return MK_NNTP_SERVER_ERROR;</span>
<a href="#l2.657"></a><span id="l2.657" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l2.658"></a><span id="l2.658">   }</span>
<a href="#l2.659"></a><span id="l2.659"> </span>
<a href="#l2.660"></a><span id="l2.660">   /* start the graph progress indicator</span>
<a href="#l2.661"></a><span id="l2.661">   */</span>
<a href="#l2.662"></a><span id="l2.662">   NNTP_LOG_NOTE(&quot;start the graph progress indicator&quot;);</span>
<a href="#l2.663"></a><span id="l2.663">   SetFlag(NNTP_DESTROY_PROGRESS_GRAPH);</span>
<a href="#l2.664"></a><span id="l2.664" class="difflineminus">-  return(status);</span>
<a href="#l2.665"></a><span id="l2.665" class="difflineplus">+  return NS_OK;</span>
<a href="#l2.666"></a><span id="l2.666"> }</span>
<a href="#l2.667"></a><span id="l2.667"> </span>
<a href="#l2.668"></a><span id="l2.668" class="difflineminus">-int32_t nsNNTPProtocol::SendGroupForArticle()</span>
<a href="#l2.669"></a><span id="l2.669" class="difflineplus">+nsresult nsNNTPProtocol::SendGroupForArticle()</span>
<a href="#l2.670"></a><span id="l2.670"> {</span>
<a href="#l2.671"></a><span id="l2.671">   nsresult rv;</span>
<a href="#l2.672"></a><span id="l2.672" class="difflineminus">-  int32_t status = 0;</span>
<a href="#l2.673"></a><span id="l2.673"> </span>
<a href="#l2.674"></a><span id="l2.674">   nsCString groupname;</span>
<a href="#l2.675"></a><span id="l2.675">   rv = m_newsFolder-&gt;GetRawName(groupname);</span>
<a href="#l2.676"></a><span id="l2.676">   NS_ASSERTION(NS_SUCCEEDED(rv) &amp;&amp; !groupname.IsEmpty(), &quot;no group name&quot;);</span>
<a href="#l2.677"></a><span id="l2.677"> </span>
<a href="#l2.678"></a><span id="l2.678">   char outputBuffer[OUTPUT_BUFFER_SIZE];</span>
<a href="#l2.679"></a><span id="l2.679"> </span>
<a href="#l2.680"></a><span id="l2.680">   PR_snprintf(outputBuffer,</span>
<a href="#l2.681"></a><span id="l2.681">       OUTPUT_BUFFER_SIZE,</span>
<a href="#l2.682"></a><span id="l2.682">       &quot;GROUP %.512s&quot; CRLF,</span>
<a href="#l2.683"></a><span id="l2.683">       groupname.get());</span>
<a href="#l2.684"></a><span id="l2.684"> </span>
<a href="#l2.685"></a><span id="l2.685" class="difflineminus">-  status = SendData(outputBuffer);</span>
<a href="#l2.686"></a><span id="l2.686" class="difflineplus">+  rv = SendData(outputBuffer);</span>
<a href="#l2.687"></a><span id="l2.687"> </span>
<a href="#l2.688"></a><span id="l2.688">   m_nextState = NNTP_RESPONSE;</span>
<a href="#l2.689"></a><span id="l2.689">   m_nextStateAfterResponse = NNTP_SEND_GROUP_FOR_ARTICLE_RESPONSE;</span>
<a href="#l2.690"></a><span id="l2.690">   SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.691"></a><span id="l2.691" class="difflineminus">-  return(status);</span>
<a href="#l2.692"></a><span id="l2.692" class="difflineplus">+  return rv;</span>
<a href="#l2.693"></a><span id="l2.693"> }</span>
<a href="#l2.694"></a><span id="l2.694"> </span>
<a href="#l2.695"></a><span id="l2.695"> nsresult</span>
<a href="#l2.696"></a><span id="l2.696"> nsNNTPProtocol::SetCurrentGroup()</span>
<a href="#l2.697"></a><span id="l2.697"> {</span>
<a href="#l2.698"></a><span id="l2.698">   nsresult rv;</span>
<a href="#l2.699"></a><span id="l2.699">   nsCString groupname;</span>
<a href="#l2.700"></a><span id="l2.700">   NS_ASSERTION(m_newsFolder, &quot;no news folder&quot;);</span>
<a href="#l2.701"></a><span id="l2.701" class="difflineat">@@ -2048,48 +2045,44 @@ nsNNTPProtocol::SetCurrentGroup()</span>
<a href="#l2.702"></a><span id="l2.702"> </span>
<a href="#l2.703"></a><span id="l2.703">   rv = m_newsFolder-&gt;GetRawName(groupname);</span>
<a href="#l2.704"></a><span id="l2.704">   NS_ASSERTION(NS_SUCCEEDED(rv) &amp;&amp; !groupname.IsEmpty(), &quot;no group name&quot;);</span>
<a href="#l2.705"></a><span id="l2.705">   PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;(%p) SetCurrentGroup to %s&quot;,this, groupname.get()));</span>
<a href="#l2.706"></a><span id="l2.706">   m_currentGroup = groupname;</span>
<a href="#l2.707"></a><span id="l2.707">   return NS_OK;</span>
<a href="#l2.708"></a><span id="l2.708"> }</span>
<a href="#l2.709"></a><span id="l2.709"> </span>
<a href="#l2.710"></a><span id="l2.710" class="difflineminus">-int32_t nsNNTPProtocol::SendGroupForArticleResponse()</span>
<a href="#l2.711"></a><span id="l2.711" class="difflineplus">+nsresult nsNNTPProtocol::SendGroupForArticleResponse()</span>
<a href="#l2.712"></a><span id="l2.712"> {</span>
<a href="#l2.713"></a><span id="l2.713">   /* ignore the response code and continue</span>
<a href="#l2.714"></a><span id="l2.714">    */</span>
<a href="#l2.715"></a><span id="l2.715">   m_nextState = NNTP_SEND_ARTICLE_NUMBER;</span>
<a href="#l2.716"></a><span id="l2.716"> </span>
<a href="#l2.717"></a><span id="l2.717" class="difflineminus">-  SetCurrentGroup();</span>
<a href="#l2.718"></a><span id="l2.718" class="difflineminus">-</span>
<a href="#l2.719"></a><span id="l2.719" class="difflineminus">-  return(0);</span>
<a href="#l2.720"></a><span id="l2.720" class="difflineplus">+  return SetCurrentGroup();</span>
<a href="#l2.721"></a><span id="l2.721"> }</span>
<a href="#l2.722"></a><span id="l2.722"> </span>
<a href="#l2.723"></a><span id="l2.723"> </span>
<a href="#l2.724"></a><span id="l2.724" class="difflineminus">-int32_t nsNNTPProtocol::SendArticleNumber()</span>
<a href="#l2.725"></a><span id="l2.725" class="difflineplus">+nsresult nsNNTPProtocol::SendArticleNumber()</span>
<a href="#l2.726"></a><span id="l2.726"> {</span>
<a href="#l2.727"></a><span id="l2.727">   char outputBuffer[OUTPUT_BUFFER_SIZE];</span>
<a href="#l2.728"></a><span id="l2.728" class="difflineminus">-  int32_t status = 0;</span>
<a href="#l2.729"></a><span id="l2.729">   PR_snprintf(outputBuffer, OUTPUT_BUFFER_SIZE, &quot;ARTICLE %lu&quot; CRLF, m_key);</span>
<a href="#l2.730"></a><span id="l2.730"> </span>
<a href="#l2.731"></a><span id="l2.731" class="difflineminus">-  status = SendData(outputBuffer);</span>
<a href="#l2.732"></a><span id="l2.732" class="difflineplus">+  nsresult rv = SendData(outputBuffer);</span>
<a href="#l2.733"></a><span id="l2.733"> </span>
<a href="#l2.734"></a><span id="l2.734">     m_nextState = NNTP_RESPONSE;</span>
<a href="#l2.735"></a><span id="l2.735">     m_nextStateAfterResponse = SEND_FIRST_NNTP_COMMAND_RESPONSE;</span>
<a href="#l2.736"></a><span id="l2.736">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.737"></a><span id="l2.737"> </span>
<a href="#l2.738"></a><span id="l2.738" class="difflineminus">-    return(status);</span>
<a href="#l2.739"></a><span id="l2.739" class="difflineplus">+  return rv;</span>
<a href="#l2.740"></a><span id="l2.740"> }</span>
<a href="#l2.741"></a><span id="l2.741"> </span>
<a href="#l2.742"></a><span id="l2.742" class="difflineminus">-int32_t nsNNTPProtocol::BeginArticle()</span>
<a href="#l2.743"></a><span id="l2.743" class="difflineplus">+nsresult nsNNTPProtocol::BeginArticle()</span>
<a href="#l2.744"></a><span id="l2.744"> {</span>
<a href="#l2.745"></a><span id="l2.745" class="difflineminus">-  if (m_typeWanted != ARTICLE_WANTED &amp;&amp;</span>
<a href="#l2.746"></a><span id="l2.746" class="difflineminus">-    m_typeWanted != CANCEL_WANTED)</span>
<a href="#l2.747"></a><span id="l2.747" class="difflineminus">-  return 0;</span>
<a href="#l2.748"></a><span id="l2.748" class="difflineplus">+  if (m_typeWanted != ARTICLE_WANTED &amp;&amp; m_typeWanted != CANCEL_WANTED)</span>
<a href="#l2.749"></a><span id="l2.749" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.750"></a><span id="l2.750"> </span>
<a href="#l2.751"></a><span id="l2.751">   /*  Set up the HTML stream</span>
<a href="#l2.752"></a><span id="l2.752">    */</span>
<a href="#l2.753"></a><span id="l2.753"> </span>
<a href="#l2.754"></a><span id="l2.754"> #ifdef NO_ARTICLE_CACHEING</span>
<a href="#l2.755"></a><span id="l2.755">   ce-&gt;format_out = CLEAR_CACHE_BIT (ce-&gt;format_out);</span>
<a href="#l2.756"></a><span id="l2.756"> #endif</span>
<a href="#l2.757"></a><span id="l2.757"> </span>
<a href="#l2.758"></a><span id="l2.758" class="difflineat">@@ -2109,37 +2102,37 @@ int32_t nsNNTPProtocol::BeginArticle()</span>
<a href="#l2.759"></a><span id="l2.759">       // TODO: return on failure?</span>
<a href="#l2.760"></a><span id="l2.760"> </span>
<a href="#l2.761"></a><span id="l2.761">       pipe-&gt;GetInputStream(getter_AddRefs(mDisplayInputStream));</span>
<a href="#l2.762"></a><span id="l2.762">       pipe-&gt;GetOutputStream(getter_AddRefs(mDisplayOutputStream));</span>
<a href="#l2.763"></a><span id="l2.763">   }</span>
<a href="#l2.764"></a><span id="l2.764"> </span>
<a href="#l2.765"></a><span id="l2.765">   m_nextState = NNTP_READ_ARTICLE;</span>
<a href="#l2.766"></a><span id="l2.766"> </span>
<a href="#l2.767"></a><span id="l2.767" class="difflineminus">-  return 0;</span>
<a href="#l2.768"></a><span id="l2.768" class="difflineplus">+  return NS_OK;</span>
<a href="#l2.769"></a><span id="l2.769"> }</span>
<a href="#l2.770"></a><span id="l2.770"> </span>
<a href="#l2.771"></a><span id="l2.771" class="difflineminus">-int32_t nsNNTPProtocol::DisplayArticle(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l2.772"></a><span id="l2.772" class="difflineplus">+nsresult nsNNTPProtocol::DisplayArticle(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l2.773"></a><span id="l2.773"> {</span>
<a href="#l2.774"></a><span id="l2.774">   uint32_t line_length = 0;</span>
<a href="#l2.775"></a><span id="l2.775"> </span>
<a href="#l2.776"></a><span id="l2.776">   bool pauseForMoreData = false;</span>
<a href="#l2.777"></a><span id="l2.777">   if (m_channelListener)</span>
<a href="#l2.778"></a><span id="l2.778">   {</span>
<a href="#l2.779"></a><span id="l2.779">     nsresult rv = NS_OK;</span>
<a href="#l2.780"></a><span id="l2.780">     char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, line_length, pauseForMoreData, &amp;rv, true);</span>
<a href="#l2.781"></a><span id="l2.781">     if (pauseForMoreData)</span>
<a href="#l2.782"></a><span id="l2.782">     {</span>
<a href="#l2.783"></a><span id="l2.783">       uint64_t inlength = 0;</span>
<a href="#l2.784"></a><span id="l2.784">       mDisplayInputStream-&gt;Available(&amp;inlength);</span>
<a href="#l2.785"></a><span id="l2.785">       if (inlength &gt; 0) // broadcast our batched up ODA changes</span>
<a href="#l2.786"></a><span id="l2.786">         m_channelListener-&gt;OnDataAvailable(this, m_channelContext, mDisplayInputStream, 0, NS_MIN(inlength, PR_UINT32_MAX));</span>
<a href="#l2.787"></a><span id="l2.787">       SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.788"></a><span id="l2.788">       PR_Free(line);</span>
<a href="#l2.789"></a><span id="l2.789" class="difflineminus">-      return line_length;</span>
<a href="#l2.790"></a><span id="l2.790" class="difflineplus">+      return rv;</span>
<a href="#l2.791"></a><span id="l2.791">     }</span>
<a href="#l2.792"></a><span id="l2.792"> </span>
<a href="#l2.793"></a><span id="l2.793">     if (m_newsFolder)</span>
<a href="#l2.794"></a><span id="l2.794">       m_newsFolder-&gt;NotifyDownloadedLine(line, m_key);</span>
<a href="#l2.795"></a><span id="l2.795"> </span>
<a href="#l2.796"></a><span id="l2.796">     // line only contains a single dot -&gt; message end</span>
<a href="#l2.797"></a><span id="l2.797">     if (line_length == 1 + MSG_LINEBREAK_LEN &amp;&amp; line[0] == '.')</span>
<a href="#l2.798"></a><span id="l2.798">     {</span>
<a href="#l2.799"></a><span id="l2.799" class="difflineat">@@ -2147,89 +2140,90 @@ int32_t nsNNTPProtocol::DisplayArticle(n</span>
<a href="#l2.800"></a><span id="l2.800"> </span>
<a href="#l2.801"></a><span id="l2.801">       ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.802"></a><span id="l2.802"> </span>
<a href="#l2.803"></a><span id="l2.803">       uint64_t inlength = 0;</span>
<a href="#l2.804"></a><span id="l2.804">       mDisplayInputStream-&gt;Available(&amp;inlength);</span>
<a href="#l2.805"></a><span id="l2.805">       if (inlength &gt; 0) // broadcast our batched up ODA changes</span>
<a href="#l2.806"></a><span id="l2.806">         m_channelListener-&gt;OnDataAvailable(this, m_channelContext, mDisplayInputStream, 0, NS_MIN(inlength, PR_UINT32_MAX));</span>
<a href="#l2.807"></a><span id="l2.807">       PR_Free(line);</span>
<a href="#l2.808"></a><span id="l2.808" class="difflineminus">-      return line_length;</span>
<a href="#l2.809"></a><span id="l2.809" class="difflineplus">+      return rv;</span>
<a href="#l2.810"></a><span id="l2.810">     }</span>
<a href="#l2.811"></a><span id="l2.811">     else // we aren't finished with the message yet</span>
<a href="#l2.812"></a><span id="l2.812">     {</span>
<a href="#l2.813"></a><span id="l2.813">       uint32_t count = 0;</span>
<a href="#l2.814"></a><span id="l2.814"> </span>
<a href="#l2.815"></a><span id="l2.815">       // skip over the quoted '.'</span>
<a href="#l2.816"></a><span id="l2.816">       if (line_length &gt; 1 &amp;&amp; line[0] == '.' &amp;&amp; line[1] == '.')</span>
<a href="#l2.817"></a><span id="l2.817">         mDisplayOutputStream-&gt;Write(line+1, line_length-1, &amp;count);</span>
<a href="#l2.818"></a><span id="l2.818">       else</span>
<a href="#l2.819"></a><span id="l2.819">         mDisplayOutputStream-&gt;Write(line, line_length, &amp;count);</span>
<a href="#l2.820"></a><span id="l2.820">     }</span>
<a href="#l2.821"></a><span id="l2.821"> </span>
<a href="#l2.822"></a><span id="l2.822">     PR_Free(line);</span>
<a href="#l2.823"></a><span id="l2.823">   }</span>
<a href="#l2.824"></a><span id="l2.824"> </span>
<a href="#l2.825"></a><span id="l2.825" class="difflineminus">-  return 0;</span>
<a href="#l2.826"></a><span id="l2.826" class="difflineplus">+  return NS_OK;</span>
<a href="#l2.827"></a><span id="l2.827"> }</span>
<a href="#l2.828"></a><span id="l2.828"> </span>
<a href="#l2.829"></a><span id="l2.829" class="difflineminus">-int32_t nsNNTPProtocol::ReadArticle(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l2.830"></a><span id="l2.830" class="difflineplus">+nsresult nsNNTPProtocol::ReadArticle(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l2.831"></a><span id="l2.831"> {</span>
<a href="#l2.832"></a><span id="l2.832">   uint32_t status = 0;</span>
<a href="#l2.833"></a><span id="l2.833" class="difflineplus">+  nsresult rv;</span>
<a href="#l2.834"></a><span id="l2.834">   char *outputBuffer;</span>
<a href="#l2.835"></a><span id="l2.835"> </span>
<a href="#l2.836"></a><span id="l2.836">   bool pauseForMoreData = false;</span>
<a href="#l2.837"></a><span id="l2.837"> </span>
<a href="#l2.838"></a><span id="l2.838">   // if we have a channel listener, spool directly to it....</span>
<a href="#l2.839"></a><span id="l2.839">   // otherwise we must be doing something like save to disk or cancel</span>
<a href="#l2.840"></a><span id="l2.840">   // in which case we are doing the work.</span>
<a href="#l2.841"></a><span id="l2.841">   if (m_channelListener)</span>
<a href="#l2.842"></a><span id="l2.842">     return DisplayArticle(inputStream, length);</span>
<a href="#l2.843"></a><span id="l2.843"> </span>
<a href="#l2.844"></a><span id="l2.844"> </span>
<a href="#l2.845"></a><span id="l2.845" class="difflineminus">-  char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData, nullptr, true);</span>
<a href="#l2.846"></a><span id="l2.846" class="difflineplus">+  char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData, &amp;rv, true);</span>
<a href="#l2.847"></a><span id="l2.847">   if (m_newsFolder &amp;&amp; line)</span>
<a href="#l2.848"></a><span id="l2.848">   {</span>
<a href="#l2.849"></a><span id="l2.849">     const char *unescapedLine = line;</span>
<a href="#l2.850"></a><span id="l2.850">     // lines beginning with '.' are escaped by nntp server</span>
<a href="#l2.851"></a><span id="l2.851">     // or is it just '.' on a line by itself?</span>
<a href="#l2.852"></a><span id="l2.852">     if (line[0] == '.' &amp;&amp; line[1] == '.')</span>
<a href="#l2.853"></a><span id="l2.853">       unescapedLine++;</span>
<a href="#l2.854"></a><span id="l2.854">     m_newsFolder-&gt;NotifyDownloadedLine(unescapedLine, m_key);</span>
<a href="#l2.855"></a><span id="l2.855"> </span>
<a href="#l2.856"></a><span id="l2.856">   }</span>
<a href="#l2.857"></a><span id="l2.857"> </span>
<a href="#l2.858"></a><span id="l2.858">   if(pauseForMoreData)</span>
<a href="#l2.859"></a><span id="l2.859">   {</span>
<a href="#l2.860"></a><span id="l2.860">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.861"></a><span id="l2.861" class="difflineminus">-    return 0;</span>
<a href="#l2.862"></a><span id="l2.862" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.863"></a><span id="l2.863">   }</span>
<a href="#l2.864"></a><span id="l2.864">   if(status &gt; 1)</span>
<a href="#l2.865"></a><span id="l2.865">   {</span>
<a href="#l2.866"></a><span id="l2.866"> #ifdef UNREADY_CODE</span>
<a href="#l2.867"></a><span id="l2.867">     ce-&gt;bytes_received += status;</span>
<a href="#l2.868"></a><span id="l2.868">     FE_GraphProgress(ce-&gt;window_id, ce-&gt;URL_s,</span>
<a href="#l2.869"></a><span id="l2.869">       ce-&gt;bytes_received, status,</span>
<a href="#l2.870"></a><span id="l2.870">       ce-&gt;URL_s-&gt;content_length);</span>
<a href="#l2.871"></a><span id="l2.871"> #else</span>
<a href="#l2.872"></a><span id="l2.872">     mBytesReceived += status;</span>
<a href="#l2.873"></a><span id="l2.873">     mBytesReceivedSinceLastStatusUpdate += status;</span>
<a href="#l2.874"></a><span id="l2.874"> #endif</span>
<a href="#l2.875"></a><span id="l2.875">   }</span>
<a href="#l2.876"></a><span id="l2.876"> </span>
<a href="#l2.877"></a><span id="l2.877">   if(!line)</span>
<a href="#l2.878"></a><span id="l2.878" class="difflineminus">-    return(status);  /* no line yet or error */</span>
<a href="#l2.879"></a><span id="l2.879" class="difflineplus">+    return rv;  /* no line yet or error */</span>
<a href="#l2.880"></a><span id="l2.880"> </span>
<a href="#l2.881"></a><span id="l2.881">   nsCOMPtr&lt;nsISupports&gt; ctxt = do_QueryInterface(m_runningURL);</span>
<a href="#l2.882"></a><span id="l2.882"> </span>
<a href="#l2.883"></a><span id="l2.883">   if (m_typeWanted == CANCEL_WANTED &amp;&amp; m_responseCode != MK_NNTP_RESPONSE_ARTICLE_HEAD)</span>
<a href="#l2.884"></a><span id="l2.884">   {</span>
<a href="#l2.885"></a><span id="l2.885">     /* HEAD command failed. */</span>
<a href="#l2.886"></a><span id="l2.886">     PR_FREEIF(line);</span>
<a href="#l2.887"></a><span id="l2.887" class="difflineminus">-    return MK_NNTP_CANCEL_ERROR;</span>
<a href="#l2.888"></a><span id="l2.888" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l2.889"></a><span id="l2.889">   }</span>
<a href="#l2.890"></a><span id="l2.890"> </span>
<a href="#l2.891"></a><span id="l2.891">   if (line[0] == '.' &amp;&amp; line[MSG_LINEBREAK_LEN + 1] == 0)</span>
<a href="#l2.892"></a><span id="l2.892">   {</span>
<a href="#l2.893"></a><span id="l2.893">     if (m_typeWanted == CANCEL_WANTED)</span>
<a href="#l2.894"></a><span id="l2.894">       m_nextState = NEWS_START_CANCEL;</span>
<a href="#l2.895"></a><span id="l2.895">     else</span>
<a href="#l2.896"></a><span id="l2.896">       m_nextState = NEWS_DONE;</span>
<a href="#l2.897"></a><span id="l2.897" class="difflineat">@@ -2254,17 +2248,17 @@ int32_t nsNNTPProtocol::ReadArticle(nsII</span>
<a href="#l2.898"></a><span id="l2.898">         ParseHeaderForCancel(outputBuffer);</span>
<a href="#l2.899"></a><span id="l2.899">       }</span>
<a href="#l2.900"></a><span id="l2.900"> </span>
<a href="#l2.901"></a><span id="l2.901">     }</span>
<a href="#l2.902"></a><span id="l2.902">   }</span>
<a href="#l2.903"></a><span id="l2.903"> </span>
<a href="#l2.904"></a><span id="l2.904">   PR_Free(line);</span>
<a href="#l2.905"></a><span id="l2.905"> </span>
<a href="#l2.906"></a><span id="l2.906" class="difflineminus">-  return 0;</span>
<a href="#l2.907"></a><span id="l2.907" class="difflineplus">+  return NS_OK;</span>
<a href="#l2.908"></a><span id="l2.908"> }</span>
<a href="#l2.909"></a><span id="l2.909"> </span>
<a href="#l2.910"></a><span id="l2.910"> void nsNNTPProtocol::ParseHeaderForCancel(char *buf)</span>
<a href="#l2.911"></a><span id="l2.911"> {</span>
<a href="#l2.912"></a><span id="l2.912">     nsAutoCString header(buf);</span>
<a href="#l2.913"></a><span id="l2.913">     int32_t colon = header.FindChar(':');</span>
<a href="#l2.914"></a><span id="l2.914">     if (!colon)</span>
<a href="#l2.915"></a><span id="l2.915">     return;</span>
<a href="#l2.916"></a><span id="l2.916" class="difflineat">@@ -2297,53 +2291,52 @@ void nsNNTPProtocol::ParseHeaderForCance</span>
<a href="#l2.917"></a><span id="l2.917">       m_cancelDistribution = ToNewCString(value);</span>
<a href="#l2.918"></a><span id="l2.918">         }</span>
<a href="#l2.919"></a><span id="l2.919">         break;</span>
<a href="#l2.920"></a><span id="l2.920">     }</span>
<a href="#l2.921"></a><span id="l2.921"> </span>
<a href="#l2.922"></a><span id="l2.922">   return;</span>
<a href="#l2.923"></a><span id="l2.923"> }</span>
<a href="#l2.924"></a><span id="l2.924"> </span>
<a href="#l2.925"></a><span id="l2.925" class="difflineminus">-int32_t nsNNTPProtocol::BeginAuthorization()</span>
<a href="#l2.926"></a><span id="l2.926" class="difflineplus">+nsresult nsNNTPProtocol::BeginAuthorization()</span>
<a href="#l2.927"></a><span id="l2.927"> {</span>
<a href="#l2.928"></a><span id="l2.928">   char * command = 0;</span>
<a href="#l2.929"></a><span id="l2.929">   nsresult rv = NS_OK;</span>
<a href="#l2.930"></a><span id="l2.930" class="difflineminus">-  int32_t status = 0;</span>
<a href="#l2.931"></a><span id="l2.931"> </span>
<a href="#l2.932"></a><span id="l2.932">   if (!m_newsFolder &amp;&amp; m_nntpServer) {</span>
<a href="#l2.933"></a><span id="l2.933">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(m_nntpServer);</span>
<a href="#l2.934"></a><span id="l2.934">     if (m_nntpServer) {</span>
<a href="#l2.935"></a><span id="l2.935">       nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l2.936"></a><span id="l2.936">       rv = server-&gt;GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l2.937"></a><span id="l2.937">       if (NS_SUCCEEDED(rv) &amp;&amp; rootFolder) {</span>
<a href="#l2.938"></a><span id="l2.938">         m_newsFolder = do_QueryInterface(rootFolder);</span>
<a href="#l2.939"></a><span id="l2.939">       }</span>
<a href="#l2.940"></a><span id="l2.940">     }</span>
<a href="#l2.941"></a><span id="l2.941">   }</span>
<a href="#l2.942"></a><span id="l2.942"> </span>
<a href="#l2.943"></a><span id="l2.943">   NS_ASSERTION(m_newsFolder, &quot;no m_newsFolder&quot;);</span>
<a href="#l2.944"></a><span id="l2.944">   if (!m_newsFolder)</span>
<a href="#l2.945"></a><span id="l2.945" class="difflineminus">-    return MK_NNTP_AUTH_FAILED;</span>
<a href="#l2.946"></a><span id="l2.946" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l2.947"></a><span id="l2.947"> </span>
<a href="#l2.948"></a><span id="l2.948">   // We want to get authentication credentials, but it is possible that the</span>
<a href="#l2.949"></a><span id="l2.949">   // master password prompt will end up being synchronous. In that case, check</span>
<a href="#l2.950"></a><span id="l2.950">   // to see if we already have the credentials stored.</span>
<a href="#l2.951"></a><span id="l2.951">   nsCString username, password;</span>
<a href="#l2.952"></a><span id="l2.952">   rv = m_newsFolder-&gt;GetGroupUsername(username);</span>
<a href="#l2.953"></a><span id="l2.953" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, MK_NNTP_AUTH_FAILED);</span>
<a href="#l2.954"></a><span id="l2.954" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.955"></a><span id="l2.955">   rv = m_newsFolder-&gt;GetGroupPassword(password);</span>
<a href="#l2.956"></a><span id="l2.956" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, MK_NNTP_AUTH_FAILED);</span>
<a href="#l2.957"></a><span id="l2.957" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.958"></a><span id="l2.958"> </span>
<a href="#l2.959"></a><span id="l2.959">   // If we don't have either a username or a password, queue an asynchronous</span>
<a href="#l2.960"></a><span id="l2.960">   // prompt.</span>
<a href="#l2.961"></a><span id="l2.961">   if (username.IsEmpty() || password.IsEmpty())</span>
<a href="#l2.962"></a><span id="l2.962">   {</span>
<a href="#l2.963"></a><span id="l2.963">     nsCOMPtr&lt;nsIMsgAsyncPrompter&gt; asyncPrompter =</span>
<a href="#l2.964"></a><span id="l2.964">       do_GetService(NS_MSGASYNCPROMPTER_CONTRACTID, &amp;rv);</span>
<a href="#l2.965"></a><span id="l2.965" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, MK_NNTP_AUTH_FAILED);</span>
<a href="#l2.966"></a><span id="l2.966" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.967"></a><span id="l2.967"> </span>
<a href="#l2.968"></a><span id="l2.968">     // Get the key to coalesce auth prompts.</span>
<a href="#l2.969"></a><span id="l2.969">     bool singleSignon = false;</span>
<a href="#l2.970"></a><span id="l2.970">     m_nntpServer-&gt;GetSingleSignon(&amp;singleSignon);</span>
<a href="#l2.971"></a><span id="l2.971">     </span>
<a href="#l2.972"></a><span id="l2.972">     nsCString queueKey;</span>
<a href="#l2.973"></a><span id="l2.973">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(m_nntpServer);</span>
<a href="#l2.974"></a><span id="l2.974">     server-&gt;GetKey(queueKey);</span>
<a href="#l2.975"></a><span id="l2.975" class="difflineat">@@ -2355,45 +2348,44 @@ int32_t nsNNTPProtocol::BeginAuthorizati</span>
<a href="#l2.976"></a><span id="l2.976">     }</span>
<a href="#l2.977"></a><span id="l2.977"> </span>
<a href="#l2.978"></a><span id="l2.978">     // If we were called back from HandleAuthenticationFailure, we must have</span>
<a href="#l2.979"></a><span id="l2.979">     // been handling the response of an authorization state. In that case,</span>
<a href="#l2.980"></a><span id="l2.980">     // let's hurry up on the auth request</span>
<a href="#l2.981"></a><span id="l2.981">     bool didAuthFail = m_nextStateAfterResponse == NNTP_AUTHORIZE_RESPONSE ||</span>
<a href="#l2.982"></a><span id="l2.982">       m_nextStateAfterResponse == NNTP_PASSWORD_RESPONSE;</span>
<a href="#l2.983"></a><span id="l2.983">     rv = asyncPrompter-&gt;QueueAsyncAuthPrompt(queueKey, didAuthFail, this);</span>
<a href="#l2.984"></a><span id="l2.984" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, MK_NNTP_AUTH_FAILED);</span>
<a href="#l2.985"></a><span id="l2.985" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.986"></a><span id="l2.986"> </span>
<a href="#l2.987"></a><span id="l2.987">     m_nextState = NNTP_SUSPENDED;</span>
<a href="#l2.988"></a><span id="l2.988">     if (m_request)</span>
<a href="#l2.989"></a><span id="l2.989">       m_request-&gt;Suspend();</span>
<a href="#l2.990"></a><span id="l2.990" class="difflineminus">-    return 0;</span>
<a href="#l2.991"></a><span id="l2.991" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.992"></a><span id="l2.992">   }</span>
<a href="#l2.993"></a><span id="l2.993"> </span>
<a href="#l2.994"></a><span id="l2.994">   NS_MsgSACopy(&amp;command, &quot;AUTHINFO user &quot;);</span>
<a href="#l2.995"></a><span id="l2.995">   PR_LOG(NNTP, PR_LOG_ALWAYS,(&quot;(%p) use %s as the username&quot;, this, username.get()));</span>
<a href="#l2.996"></a><span id="l2.996">   NS_MsgSACat(&amp;command, username.get());</span>
<a href="#l2.997"></a><span id="l2.997">   NS_MsgSACat(&amp;command, CRLF);</span>
<a href="#l2.998"></a><span id="l2.998"> </span>
<a href="#l2.999"></a><span id="l2.999" class="difflineminus">-  status = SendData(command);</span>
<a href="#l2.1000"></a><span id="l2.1000" class="difflineplus">+  rv = SendData(command);</span>
<a href="#l2.1001"></a><span id="l2.1001"> </span>
<a href="#l2.1002"></a><span id="l2.1002">   PR_Free(command);</span>
<a href="#l2.1003"></a><span id="l2.1003"> </span>
<a href="#l2.1004"></a><span id="l2.1004">   m_nextState = NNTP_RESPONSE;</span>
<a href="#l2.1005"></a><span id="l2.1005">   m_nextStateAfterResponse = NNTP_AUTHORIZE_RESPONSE;</span>
<a href="#l2.1006"></a><span id="l2.1006"> </span>
<a href="#l2.1007"></a><span id="l2.1007">   SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.1008"></a><span id="l2.1008"> </span>
<a href="#l2.1009"></a><span id="l2.1009" class="difflineminus">-  return status;</span>
<a href="#l2.1010"></a><span id="l2.1010" class="difflineplus">+  return rv;</span>
<a href="#l2.1011"></a><span id="l2.1011"> }</span>
<a href="#l2.1012"></a><span id="l2.1012"> </span>
<a href="#l2.1013"></a><span id="l2.1013" class="difflineminus">-int32_t nsNNTPProtocol::AuthorizationResponse()</span>
<a href="#l2.1014"></a><span id="l2.1014" class="difflineplus">+nsresult nsNNTPProtocol::AuthorizationResponse()</span>
<a href="#l2.1015"></a><span id="l2.1015"> {</span>
<a href="#l2.1016"></a><span id="l2.1016">   nsresult rv = NS_OK;</span>
<a href="#l2.1017"></a><span id="l2.1017" class="difflineminus">-  int32_t status = 0;</span>
<a href="#l2.1018"></a><span id="l2.1018"> </span>
<a href="#l2.1019"></a><span id="l2.1019">   if (MK_NNTP_RESPONSE_AUTHINFO_OK == m_responseCode ||</span>
<a href="#l2.1020"></a><span id="l2.1020">     MK_NNTP_RESPONSE_AUTHINFO_SIMPLE_OK == m_responseCode)</span>
<a href="#l2.1021"></a><span id="l2.1021">   {</span>
<a href="#l2.1022"></a><span id="l2.1022">     /* successful login */</span>
<a href="#l2.1023"></a><span id="l2.1023"> #ifdef HAVE_NNTP_EXTENSIONS</span>
<a href="#l2.1024"></a><span id="l2.1024">     bool pushAuth;</span>
<a href="#l2.1025"></a><span id="l2.1025">     /* If we're here because the host demanded authentication before we</span>
<a href="#l2.1026"></a><span id="l2.1026" class="difflineat">@@ -2413,57 +2405,57 @@ int32_t nsNNTPProtocol::AuthorizationRes</span>
<a href="#l2.1027"></a><span id="l2.1027">       m_nextState = SEND_FIRST_NNTP_COMMAND;</span>
<a href="#l2.1028"></a><span id="l2.1028"> #else</span>
<a href="#l2.1029"></a><span id="l2.1029">     if (!TestFlag(NNTP_READER_PERFORMED))</span>
<a href="#l2.1030"></a><span id="l2.1030">       m_nextState = NNTP_SEND_MODE_READER;</span>
<a href="#l2.1031"></a><span id="l2.1031">     else</span>
<a href="#l2.1032"></a><span id="l2.1032">       m_nextState = SEND_FIRST_NNTP_COMMAND;</span>
<a href="#l2.1033"></a><span id="l2.1033"> #endif /* HAVE_NNTP_EXTENSIONS */</span>
<a href="#l2.1034"></a><span id="l2.1034"> </span>
<a href="#l2.1035"></a><span id="l2.1035" class="difflineminus">-    return(0);</span>
<a href="#l2.1036"></a><span id="l2.1036" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.1037"></a><span id="l2.1037">   }</span>
<a href="#l2.1038"></a><span id="l2.1038">   else if (MK_NNTP_RESPONSE_AUTHINFO_CONT == m_responseCode)</span>
<a href="#l2.1039"></a><span id="l2.1039">   {</span>
<a href="#l2.1040"></a><span id="l2.1040">     char * command = 0;</span>
<a href="#l2.1041"></a><span id="l2.1041"> </span>
<a href="#l2.1042"></a><span id="l2.1042">     // Since we had to have called BeginAuthorization to get here, we've already</span>
<a href="#l2.1043"></a><span id="l2.1043">     // prompted for the authorization credentials. Just grab them without a</span>
<a href="#l2.1044"></a><span id="l2.1044">     // further prompt.</span>
<a href="#l2.1045"></a><span id="l2.1045">     nsCString password;</span>
<a href="#l2.1046"></a><span id="l2.1046">     rv = m_newsFolder-&gt;GetGroupPassword(password);</span>
<a href="#l2.1047"></a><span id="l2.1047">     if (NS_FAILED(rv) || password.IsEmpty())</span>
<a href="#l2.1048"></a><span id="l2.1048" class="difflineminus">-      return MK_NNTP_AUTH_FAILED;</span>
<a href="#l2.1049"></a><span id="l2.1049" class="difflineplus">+      return NS_ERROR_FAILURE;</span>
<a href="#l2.1050"></a><span id="l2.1050"> </span>
<a href="#l2.1051"></a><span id="l2.1051">     NS_MsgSACopy(&amp;command, &quot;AUTHINFO pass &quot;);</span>
<a href="#l2.1052"></a><span id="l2.1052">     NS_MsgSACat(&amp;command, password.get());</span>
<a href="#l2.1053"></a><span id="l2.1053">     NS_MsgSACat(&amp;command, CRLF);</span>
<a href="#l2.1054"></a><span id="l2.1054"> </span>
<a href="#l2.1055"></a><span id="l2.1055" class="difflineminus">-    status = SendData(command, true);</span>
<a href="#l2.1056"></a><span id="l2.1056" class="difflineplus">+    rv = SendData(command, true);</span>
<a href="#l2.1057"></a><span id="l2.1057"> </span>
<a href="#l2.1058"></a><span id="l2.1058">     PR_FREEIF(command);</span>
<a href="#l2.1059"></a><span id="l2.1059"> </span>
<a href="#l2.1060"></a><span id="l2.1060">     m_nextState = NNTP_RESPONSE;</span>
<a href="#l2.1061"></a><span id="l2.1061">     m_nextStateAfterResponse = NNTP_PASSWORD_RESPONSE;</span>
<a href="#l2.1062"></a><span id="l2.1062">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.1063"></a><span id="l2.1063"> </span>
<a href="#l2.1064"></a><span id="l2.1064" class="difflineminus">-    return status;</span>
<a href="#l2.1065"></a><span id="l2.1065" class="difflineplus">+    return rv;</span>
<a href="#l2.1066"></a><span id="l2.1066">   }</span>
<a href="#l2.1067"></a><span id="l2.1067">   else</span>
<a href="#l2.1068"></a><span id="l2.1068">   {</span>
<a href="#l2.1069"></a><span id="l2.1069">     /* login failed */</span>
<a href="#l2.1070"></a><span id="l2.1070">     HandleAuthenticationFailure();</span>
<a href="#l2.1071"></a><span id="l2.1071" class="difflineminus">-    return status;</span>
<a href="#l2.1072"></a><span id="l2.1072" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.1073"></a><span id="l2.1073">   }</span>
<a href="#l2.1074"></a><span id="l2.1074"> </span>
<a href="#l2.1075"></a><span id="l2.1075">   NS_ERROR(&quot;should never get here&quot;);</span>
<a href="#l2.1076"></a><span id="l2.1076" class="difflineminus">-  return(-1);</span>
<a href="#l2.1077"></a><span id="l2.1077" class="difflineplus">+  return NS_ERROR_FAILURE;</span>
<a href="#l2.1078"></a><span id="l2.1078"> </span>
<a href="#l2.1079"></a><span id="l2.1079"> }</span>
<a href="#l2.1080"></a><span id="l2.1080"> </span>
<a href="#l2.1081"></a><span id="l2.1081" class="difflineminus">-int32_t nsNNTPProtocol::PasswordResponse()</span>
<a href="#l2.1082"></a><span id="l2.1082" class="difflineplus">+nsresult nsNNTPProtocol::PasswordResponse()</span>
<a href="#l2.1083"></a><span id="l2.1083"> {</span>
<a href="#l2.1084"></a><span id="l2.1084">   if (MK_NNTP_RESPONSE_AUTHINFO_OK == m_responseCode ||</span>
<a href="#l2.1085"></a><span id="l2.1085">     MK_NNTP_RESPONSE_AUTHINFO_SIMPLE_OK == m_responseCode)</span>
<a href="#l2.1086"></a><span id="l2.1086">   {</span>
<a href="#l2.1087"></a><span id="l2.1087">     /* successful login */</span>
<a href="#l2.1088"></a><span id="l2.1088"> #ifdef HAVE_NNTP_EXTENSIONS</span>
<a href="#l2.1089"></a><span id="l2.1089">     bool pushAuth;</span>
<a href="#l2.1090"></a><span id="l2.1090">     /* If we're here because the host demanded authentication before we</span>
<a href="#l2.1091"></a><span id="l2.1091" class="difflineat">@@ -2482,26 +2474,26 @@ int32_t nsNNTPProtocol::PasswordResponse</span>
<a href="#l2.1092"></a><span id="l2.1092">       /* Normal authentication */</span>
<a href="#l2.1093"></a><span id="l2.1093">       m_nextState = SEND_FIRST_NNTP_COMMAND;</span>
<a href="#l2.1094"></a><span id="l2.1094"> #else</span>
<a href="#l2.1095"></a><span id="l2.1095">     if (!TestFlag(NNTP_READER_PERFORMED))</span>
<a href="#l2.1096"></a><span id="l2.1096">       m_nextState = NNTP_SEND_MODE_READER;</span>
<a href="#l2.1097"></a><span id="l2.1097">     else</span>
<a href="#l2.1098"></a><span id="l2.1098">       m_nextState = SEND_FIRST_NNTP_COMMAND;</span>
<a href="#l2.1099"></a><span id="l2.1099"> #endif /* HAVE_NNTP_EXTENSIONS */</span>
<a href="#l2.1100"></a><span id="l2.1100" class="difflineminus">-    return(0);</span>
<a href="#l2.1101"></a><span id="l2.1101" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.1102"></a><span id="l2.1102">   }</span>
<a href="#l2.1103"></a><span id="l2.1103">   else</span>
<a href="#l2.1104"></a><span id="l2.1104">   {</span>
<a href="#l2.1105"></a><span id="l2.1105">     HandleAuthenticationFailure();</span>
<a href="#l2.1106"></a><span id="l2.1106" class="difflineminus">-    return 0;</span>
<a href="#l2.1107"></a><span id="l2.1107" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.1108"></a><span id="l2.1108">   }</span>
<a href="#l2.1109"></a><span id="l2.1109"> </span>
<a href="#l2.1110"></a><span id="l2.1110">   NS_ERROR(&quot;should never get here&quot;);</span>
<a href="#l2.1111"></a><span id="l2.1111" class="difflineminus">-  return(-1);</span>
<a href="#l2.1112"></a><span id="l2.1112" class="difflineplus">+  return NS_ERROR_FAILURE;</span>
<a href="#l2.1113"></a><span id="l2.1113"> }</span>
<a href="#l2.1114"></a><span id="l2.1114"> </span>
<a href="#l2.1115"></a><span id="l2.1115"> NS_IMETHODIMP nsNNTPProtocol::OnPromptStart(bool *authAvailable)</span>
<a href="#l2.1116"></a><span id="l2.1116"> {</span>
<a href="#l2.1117"></a><span id="l2.1117">   NS_ENSURE_ARG_POINTER(authAvailable);</span>
<a href="#l2.1118"></a><span id="l2.1118">   NS_ENSURE_STATE(m_nextState == NNTP_SUSPENDED);</span>
<a href="#l2.1119"></a><span id="l2.1119">   </span>
<a href="#l2.1120"></a><span id="l2.1120">   if (!m_newsFolder)</span>
<a href="#l2.1121"></a><span id="l2.1121" class="difflineat">@@ -2545,54 +2537,53 @@ NS_IMETHODIMP nsNNTPProtocol::OnPromptCa</span>
<a href="#l2.1122"></a><span id="l2.1122">     m_request-&gt;Resume();</span>
<a href="#l2.1123"></a><span id="l2.1123"> </span>
<a href="#l2.1124"></a><span id="l2.1124">   // Since the prompt was canceled, we can no longer continue the connection.</span>
<a href="#l2.1125"></a><span id="l2.1125">   // Thus, we need to go to the NNTP_ERROR state.</span>
<a href="#l2.1126"></a><span id="l2.1126">   m_nextState = NNTP_ERROR;</span>
<a href="#l2.1127"></a><span id="l2.1127">   return ProcessProtocolState(nullptr, nullptr, 0, 0);</span>
<a href="#l2.1128"></a><span id="l2.1128"> }</span>
<a href="#l2.1129"></a><span id="l2.1129"> </span>
<a href="#l2.1130"></a><span id="l2.1130" class="difflineminus">-int32_t nsNNTPProtocol::DisplayNewsgroups()</span>
<a href="#l2.1131"></a><span id="l2.1131" class="difflineplus">+nsresult nsNNTPProtocol::DisplayNewsgroups()</span>
<a href="#l2.1132"></a><span id="l2.1132"> {</span>
<a href="#l2.1133"></a><span id="l2.1133">   m_nextState = NEWS_DONE;</span>
<a href="#l2.1134"></a><span id="l2.1134">   ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.1135"></a><span id="l2.1135"> </span>
<a href="#l2.1136"></a><span id="l2.1136">   PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;(%p) DisplayNewsgroups()&quot;,this));</span>
<a href="#l2.1137"></a><span id="l2.1137"> </span>
<a href="#l2.1138"></a><span id="l2.1138" class="difflineminus">-  return(MK_DATA_LOADED);  /* all finished */</span>
<a href="#l2.1139"></a><span id="l2.1139" class="difflineplus">+  return NS_OK;</span>
<a href="#l2.1140"></a><span id="l2.1140"> }</span>
<a href="#l2.1141"></a><span id="l2.1141"> </span>
<a href="#l2.1142"></a><span id="l2.1142" class="difflineminus">-int32_t nsNNTPProtocol::BeginNewsgroups()</span>
<a href="#l2.1143"></a><span id="l2.1143" class="difflineplus">+nsresult nsNNTPProtocol::BeginNewsgroups()</span>
<a href="#l2.1144"></a><span id="l2.1144"> {</span>
<a href="#l2.1145"></a><span id="l2.1145" class="difflineminus">-  int32_t status = 0;</span>
<a href="#l2.1146"></a><span id="l2.1146">   m_nextState = NNTP_NEWGROUPS;</span>
<a href="#l2.1147"></a><span id="l2.1147">   mBytesReceived = 0;</span>
<a href="#l2.1148"></a><span id="l2.1148">     mBytesReceivedSinceLastStatusUpdate = 0;</span>
<a href="#l2.1149"></a><span id="l2.1149">     m_startTime = PR_Now();</span>
<a href="#l2.1150"></a><span id="l2.1150" class="difflineminus">-  return(status);</span>
<a href="#l2.1151"></a><span id="l2.1151" class="difflineplus">+  return NS_OK;</span>
<a href="#l2.1152"></a><span id="l2.1152"> }</span>
<a href="#l2.1153"></a><span id="l2.1153"> </span>
<a href="#l2.1154"></a><span id="l2.1154" class="difflineminus">-int32_t nsNNTPProtocol::ProcessNewsgroups(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l2.1155"></a><span id="l2.1155" class="difflineplus">+nsresult nsNNTPProtocol::ProcessNewsgroups(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l2.1156"></a><span id="l2.1156"> {</span>
<a href="#l2.1157"></a><span id="l2.1157">   char *line, *lineToFree, *s, *s1=NULL, *s2=NULL, *flag=NULL;</span>
<a href="#l2.1158"></a><span id="l2.1158">   int32_t oldest, youngest;</span>
<a href="#l2.1159"></a><span id="l2.1159">   uint32_t status = 0;</span>
<a href="#l2.1160"></a><span id="l2.1160">   nsresult rv = NS_OK;</span>
<a href="#l2.1161"></a><span id="l2.1161"> </span>
<a href="#l2.1162"></a><span id="l2.1162">   bool pauseForMoreData = false;</span>
<a href="#l2.1163"></a><span id="l2.1163" class="difflineminus">-  line = lineToFree = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData);</span>
<a href="#l2.1164"></a><span id="l2.1164" class="difflineplus">+  line = lineToFree = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData, &amp;rv);</span>
<a href="#l2.1165"></a><span id="l2.1165"> </span>
<a href="#l2.1166"></a><span id="l2.1166">   if(pauseForMoreData)</span>
<a href="#l2.1167"></a><span id="l2.1167">   {</span>
<a href="#l2.1168"></a><span id="l2.1168">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.1169"></a><span id="l2.1169" class="difflineminus">-    return 0;</span>
<a href="#l2.1170"></a><span id="l2.1170" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.1171"></a><span id="l2.1171">   }</span>
<a href="#l2.1172"></a><span id="l2.1172"> </span>
<a href="#l2.1173"></a><span id="l2.1173">   if(!line)</span>
<a href="#l2.1174"></a><span id="l2.1174" class="difflineminus">-    return(status);  /* no line yet */</span>
<a href="#l2.1175"></a><span id="l2.1175" class="difflineplus">+    return rv;  /* no line yet */</span>
<a href="#l2.1176"></a><span id="l2.1176"> </span>
<a href="#l2.1177"></a><span id="l2.1177">                      /* End of list?</span>
<a href="#l2.1178"></a><span id="l2.1178">    */</span>
<a href="#l2.1179"></a><span id="l2.1179">   if (line[0]=='.' &amp;&amp; line[1]=='\0')</span>
<a href="#l2.1180"></a><span id="l2.1180">   {</span>
<a href="#l2.1181"></a><span id="l2.1181">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.1182"></a><span id="l2.1182">     bool xactive=false;</span>
<a href="#l2.1183"></a><span id="l2.1183">     rv = m_nntpServer-&gt;QueryExtension(&quot;XACTIVE&quot;,&amp;xactive);</span>
<a href="#l2.1184"></a><span id="l2.1184" class="difflineat">@@ -2602,33 +2593,33 @@ int32_t nsNNTPProtocol::ProcessNewsgroup</span>
<a href="#l2.1185"></a><span id="l2.1185">       rv = m_nntpServer-&gt;GetFirstGroupNeedingExtraInfo(groupName);</span>
<a href="#l2.1186"></a><span id="l2.1186">       if (NS_SUCCEEDED(rv)) {</span>
<a href="#l2.1187"></a><span id="l2.1187">         rv = m_nntpServer-&gt;FindGroup(groupName, getter_AddRefs(m_newsFolder));</span>
<a href="#l2.1188"></a><span id="l2.1188">         NS_ASSERTION(NS_SUCCEEDED(rv), &quot;FindGroup failed&quot;);</span>
<a href="#l2.1189"></a><span id="l2.1189">         m_nextState = NNTP_LIST_XACTIVE;</span>
<a href="#l2.1190"></a><span id="l2.1190">         PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;(%p) listing xactive for %s&quot;, this,</span>
<a href="#l2.1191"></a><span id="l2.1191">                                    groupName.get()));</span>
<a href="#l2.1192"></a><span id="l2.1192">         PR_Free(lineToFree);</span>
<a href="#l2.1193"></a><span id="l2.1193" class="difflineminus">-        return 0;</span>
<a href="#l2.1194"></a><span id="l2.1194" class="difflineplus">+        return NS_OK;</span>
<a href="#l2.1195"></a><span id="l2.1195">       }</span>
<a href="#l2.1196"></a><span id="l2.1196">     }</span>
<a href="#l2.1197"></a><span id="l2.1197">     m_nextState = NEWS_DONE;</span>
<a href="#l2.1198"></a><span id="l2.1198"> </span>
<a href="#l2.1199"></a><span id="l2.1199"> #ifdef UNREADY_CODE</span>
<a href="#l2.1200"></a><span id="l2.1200">     if(ce-&gt;bytes_received == 0)</span>
<a href="#l2.1201"></a><span id="l2.1201">     {</span>
<a href="#l2.1202"></a><span id="l2.1202">       /* #### no new groups */</span>
<a href="#l2.1203"></a><span id="l2.1203">     }</span>
<a href="#l2.1204"></a><span id="l2.1204"> #endif</span>
<a href="#l2.1205"></a><span id="l2.1205"> </span>
<a href="#l2.1206"></a><span id="l2.1206">     PR_Free(lineToFree);</span>
<a href="#l2.1207"></a><span id="l2.1207">     if(status &gt; 0)</span>
<a href="#l2.1208"></a><span id="l2.1208" class="difflineminus">-      return MK_DATA_LOADED;</span>
<a href="#l2.1209"></a><span id="l2.1209" class="difflineplus">+      return NS_OK;</span>
<a href="#l2.1210"></a><span id="l2.1210">     else</span>
<a href="#l2.1211"></a><span id="l2.1211" class="difflineminus">-      return status;</span>
<a href="#l2.1212"></a><span id="l2.1212" class="difflineplus">+      return rv;</span>
<a href="#l2.1213"></a><span id="l2.1213">   }</span>
<a href="#l2.1214"></a><span id="l2.1214">   else if (line [0] == '.' &amp;&amp; line [1] == '.')</span>
<a href="#l2.1215"></a><span id="l2.1215">     /* The NNTP server quotes all lines beginning with &quot;.&quot; by doubling it. */</span>
<a href="#l2.1216"></a><span id="l2.1216">     line++;</span>
<a href="#l2.1217"></a><span id="l2.1217"> </span>
<a href="#l2.1218"></a><span id="l2.1218">     /* almost correct</span>
<a href="#l2.1219"></a><span id="l2.1219">   */</span>
<a href="#l2.1220"></a><span id="l2.1220">   if(status &gt; 1)</span>
<a href="#l2.1221"></a><span id="l2.1221" class="difflineat">@@ -2690,37 +2681,35 @@ int32_t nsNNTPProtocol::ProcessNewsgroup</span>
<a href="#l2.1222"></a><span id="l2.1222">                                                lineUtf16, true)))</span>
<a href="#l2.1223"></a><span id="l2.1223">       m_nntpServer-&gt;SetGroupNeedsExtraInfo(NS_ConvertUTF16toUTF8(lineUtf16),</span>
<a href="#l2.1224"></a><span id="l2.1224">                                            true);</span>
<a href="#l2.1225"></a><span id="l2.1225">     else</span>
<a href="#l2.1226"></a><span id="l2.1226">       m_nntpServer-&gt;SetGroupNeedsExtraInfo(nsDependentCString(line), true);</span>
<a href="#l2.1227"></a><span id="l2.1227">   }</span>
<a href="#l2.1228"></a><span id="l2.1228"> </span>
<a href="#l2.1229"></a><span id="l2.1229">   PR_Free(lineToFree);</span>
<a href="#l2.1230"></a><span id="l2.1230" class="difflineminus">-  return(status);</span>
<a href="#l2.1231"></a><span id="l2.1231" class="difflineplus">+  return rv;</span>
<a href="#l2.1232"></a><span id="l2.1232"> }</span>
<a href="#l2.1233"></a><span id="l2.1233"> </span>
<a href="#l2.1234"></a><span id="l2.1234"> /* Ahhh, this like print's out the headers and stuff</span>
<a href="#l2.1235"></a><span id="l2.1235">  *</span>
<a href="#l2.1236"></a><span id="l2.1236">  * always returns 0</span>
<a href="#l2.1237"></a><span id="l2.1237">  */</span>
<a href="#l2.1238"></a><span id="l2.1238"> </span>
<a href="#l2.1239"></a><span id="l2.1239" class="difflineminus">-int32_t nsNNTPProtocol::BeginReadNewsList()</span>
<a href="#l2.1240"></a><span id="l2.1240" class="difflineplus">+nsresult nsNNTPProtocol::BeginReadNewsList()</span>
<a href="#l2.1241"></a><span id="l2.1241"> {</span>
<a href="#l2.1242"></a><span id="l2.1242">   m_readNewsListCount = 0;</span>
<a href="#l2.1243"></a><span id="l2.1243">     mNumGroupsListed = 0;</span>
<a href="#l2.1244"></a><span id="l2.1244">     m_nextState = NNTP_READ_LIST;</span>
<a href="#l2.1245"></a><span id="l2.1245"> </span>
<a href="#l2.1246"></a><span id="l2.1246">     mBytesReceived = 0;</span>
<a href="#l2.1247"></a><span id="l2.1247">     mBytesReceivedSinceLastStatusUpdate = 0;</span>
<a href="#l2.1248"></a><span id="l2.1248">     m_startTime = PR_Now();</span>
<a href="#l2.1249"></a><span id="l2.1249"> </span>
<a href="#l2.1250"></a><span id="l2.1250" class="difflineminus">-  int32_t status = 0;</span>
<a href="#l2.1251"></a><span id="l2.1251" class="difflineminus">-</span>
<a href="#l2.1252"></a><span id="l2.1252" class="difflineminus">-    return(status);</span>
<a href="#l2.1253"></a><span id="l2.1253" class="difflineplus">+  return NS_OK;</span>
<a href="#l2.1254"></a><span id="l2.1254"> }</span>
<a href="#l2.1255"></a><span id="l2.1255"> </span>
<a href="#l2.1256"></a><span id="l2.1256"> #define RATE_CONSTANT 976.5625      /* PR_USEC_PER_SEC / 1024 bytes */</span>
<a href="#l2.1257"></a><span id="l2.1257"> </span>
<a href="#l2.1258"></a><span id="l2.1258"> static void ComputeRate(int32_t bytes, PRTime startTime, float *rate)</span>
<a href="#l2.1259"></a><span id="l2.1259"> {</span>
<a href="#l2.1260"></a><span id="l2.1260">   // rate = (bytes / USECS since start) * RATE_CONSTANT</span>
<a href="#l2.1261"></a><span id="l2.1261"> </span>
<a href="#l2.1262"></a><span id="l2.1262" class="difflineat">@@ -2734,62 +2723,62 @@ static void ComputeRate(int32_t bytes, P</span>
<a href="#l2.1263"></a><span id="l2.1263">   else {</span>
<a href="#l2.1264"></a><span id="l2.1264">     *rate = 0.0;</span>
<a href="#l2.1265"></a><span id="l2.1265">   }</span>
<a href="#l2.1266"></a><span id="l2.1266"> }</span>
<a href="#l2.1267"></a><span id="l2.1267"> </span>
<a href="#l2.1268"></a><span id="l2.1268"> /* display a list of all or part of the newsgroups list</span>
<a href="#l2.1269"></a><span id="l2.1269">  * from the news server</span>
<a href="#l2.1270"></a><span id="l2.1270">  */</span>
<a href="#l2.1271"></a><span id="l2.1271" class="difflineminus">-int32_t nsNNTPProtocol::ReadNewsList(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l2.1272"></a><span id="l2.1272" class="difflineplus">+nsresult nsNNTPProtocol::ReadNewsList(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l2.1273"></a><span id="l2.1273"> {</span>
<a href="#l2.1274"></a><span id="l2.1274">   nsresult rv = NS_OK;</span>
<a href="#l2.1275"></a><span id="l2.1275">   int32_t i=0;</span>
<a href="#l2.1276"></a><span id="l2.1276">   uint32_t status = 1;</span>
<a href="#l2.1277"></a><span id="l2.1277"> </span>
<a href="#l2.1278"></a><span id="l2.1278">   bool pauseForMoreData = false;</span>
<a href="#l2.1279"></a><span id="l2.1279">   char *line, *lineToFree;</span>
<a href="#l2.1280"></a><span id="l2.1280" class="difflineminus">-  line = lineToFree = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData);</span>
<a href="#l2.1281"></a><span id="l2.1281" class="difflineplus">+  line = lineToFree = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData, &amp;rv);</span>
<a href="#l2.1282"></a><span id="l2.1282"> </span>
<a href="#l2.1283"></a><span id="l2.1283">   if (pauseForMoreData)</span>
<a href="#l2.1284"></a><span id="l2.1284">   {</span>
<a href="#l2.1285"></a><span id="l2.1285">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.1286"></a><span id="l2.1286">     PR_Free(lineToFree);</span>
<a href="#l2.1287"></a><span id="l2.1287" class="difflineminus">-    return 0;</span>
<a href="#l2.1288"></a><span id="l2.1288" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.1289"></a><span id="l2.1289">   }</span>
<a href="#l2.1290"></a><span id="l2.1290"> </span>
<a href="#l2.1291"></a><span id="l2.1291">   if (!line)</span>
<a href="#l2.1292"></a><span id="l2.1292" class="difflineminus">-    return(status);  /* no line yet */</span>
<a href="#l2.1293"></a><span id="l2.1293" class="difflineplus">+    return rv;  /* no line yet */</span>
<a href="#l2.1294"></a><span id="l2.1294"> </span>
<a href="#l2.1295"></a><span id="l2.1295">   /* End of list? */</span>
<a href="#l2.1296"></a><span id="l2.1296">   if (line[0]=='.' &amp;&amp; line[1]=='\0')</span>
<a href="#l2.1297"></a><span id="l2.1297">   {</span>
<a href="#l2.1298"></a><span id="l2.1298">     bool listpnames=false;</span>
<a href="#l2.1299"></a><span id="l2.1299">     NS_ASSERTION(m_nntpServer, &quot;no nntp incoming server&quot;);</span>
<a href="#l2.1300"></a><span id="l2.1300">     if (m_nntpServer) {</span>
<a href="#l2.1301"></a><span id="l2.1301">       rv = m_nntpServer-&gt;QueryExtension(&quot;LISTPNAMES&quot;,&amp;listpnames);</span>
<a href="#l2.1302"></a><span id="l2.1302">     }</span>
<a href="#l2.1303"></a><span id="l2.1303">     if (NS_SUCCEEDED(rv) &amp;&amp; listpnames)</span>
<a href="#l2.1304"></a><span id="l2.1304">       m_nextState = NNTP_LIST_PRETTY_NAMES;</span>
<a href="#l2.1305"></a><span id="l2.1305">     else</span>
<a href="#l2.1306"></a><span id="l2.1306">       m_nextState = DISPLAY_NEWSGROUPS;</span>
<a href="#l2.1307"></a><span id="l2.1307">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.1308"></a><span id="l2.1308">     PR_Free(lineToFree);</span>
<a href="#l2.1309"></a><span id="l2.1309" class="difflineminus">-    return 0;</span>
<a href="#l2.1310"></a><span id="l2.1310" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.1311"></a><span id="l2.1311">   }</span>
<a href="#l2.1312"></a><span id="l2.1312">   else if (line[0] == '.')</span>
<a href="#l2.1313"></a><span id="l2.1313">   {</span>
<a href="#l2.1314"></a><span id="l2.1314">     if ((line[1] == ' ') || (line[1] == '.' &amp;&amp; line [2] == '.' &amp;&amp; line[3] == ' '))</span>
<a href="#l2.1315"></a><span id="l2.1315">     {</span>
<a href="#l2.1316"></a><span id="l2.1316">       // some servers send &quot;... 0000000001 0000000002 y&quot;</span>
<a href="#l2.1317"></a><span id="l2.1317">       // and some servers send &quot;. 0000000001 0000000002 y&quot;</span>
<a href="#l2.1318"></a><span id="l2.1318">       // just skip that those lines</span>
<a href="#l2.1319"></a><span id="l2.1319">       // see bug #69231 and #123560</span>
<a href="#l2.1320"></a><span id="l2.1320">       PR_Free(lineToFree);</span>
<a href="#l2.1321"></a><span id="l2.1321" class="difflineminus">-      return status;</span>
<a href="#l2.1322"></a><span id="l2.1322" class="difflineplus">+      return rv;</span>
<a href="#l2.1323"></a><span id="l2.1323">     }</span>
<a href="#l2.1324"></a><span id="l2.1324">     // The NNTP server quotes all lines beginning with &quot;.&quot; by doubling it, so unquote</span>
<a href="#l2.1325"></a><span id="l2.1325">     line++;</span>
<a href="#l2.1326"></a><span id="l2.1326">   }</span>
<a href="#l2.1327"></a><span id="l2.1327"> </span>
<a href="#l2.1328"></a><span id="l2.1328">   /* almost correct</span>
<a href="#l2.1329"></a><span id="l2.1329">   */</span>
<a href="#l2.1330"></a><span id="l2.1330">   if(status &gt; 1)</span>
<a href="#l2.1331"></a><span id="l2.1331" class="difflineat">@@ -2872,43 +2861,41 @@ int32_t nsNNTPProtocol::ReadNewsList(nsI</span>
<a href="#l2.1332"></a><span id="l2.1332">     if (mUpdateTimer) {</span>
<a href="#l2.1333"></a><span id="l2.1333">       mUpdateTimer-&gt;Cancel();</span>
<a href="#l2.1334"></a><span id="l2.1334">       mUpdateTimer = nullptr;</span>
<a href="#l2.1335"></a><span id="l2.1335">     }</span>
<a href="#l2.1336"></a><span id="l2.1336">     mUpdateTimer = do_CreateInstance(&quot;@mozilla.org/timer;1&quot;, &amp;rv);</span>
<a href="#l2.1337"></a><span id="l2.1337">     NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to create timer&quot;);</span>
<a href="#l2.1338"></a><span id="l2.1338">     if (NS_FAILED(rv)) {</span>
<a href="#l2.1339"></a><span id="l2.1339">       PR_Free(lineToFree);</span>
<a href="#l2.1340"></a><span id="l2.1340" class="difflineminus">-      return -1;</span>
<a href="#l2.1341"></a><span id="l2.1341" class="difflineplus">+      return rv;</span>
<a href="#l2.1342"></a><span id="l2.1342">     }</span>
<a href="#l2.1343"></a><span id="l2.1343"> </span>
<a href="#l2.1344"></a><span id="l2.1344">     mInputStream = inputStream;</span>
<a href="#l2.1345"></a><span id="l2.1345"> </span>
<a href="#l2.1346"></a><span id="l2.1346">     const uint32_t kUpdateTimerDelay = READ_NEWS_LIST_TIMEOUT;</span>
<a href="#l2.1347"></a><span id="l2.1347">     rv = mUpdateTimer-&gt;InitWithCallback(static_cast&lt;nsITimerCallback*&gt;(this), kUpdateTimerDelay,</span>
<a href="#l2.1348"></a><span id="l2.1348">       nsITimer::TYPE_ONE_SHOT);</span>
<a href="#l2.1349"></a><span id="l2.1349">     NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to init timer&quot;);</span>
<a href="#l2.1350"></a><span id="l2.1350">     if (NS_FAILED(rv)) {</span>
<a href="#l2.1351"></a><span id="l2.1351">       PR_Free(lineToFree);</span>
<a href="#l2.1352"></a><span id="l2.1352" class="difflineminus">-      return -1;</span>
<a href="#l2.1353"></a><span id="l2.1353" class="difflineplus">+      return rv;</span>
<a href="#l2.1354"></a><span id="l2.1354">     }</span>
<a href="#l2.1355"></a><span id="l2.1355"> </span>
<a href="#l2.1356"></a><span id="l2.1356">     m_nextState = NNTP_SUSPENDED;</span>
<a href="#l2.1357"></a><span id="l2.1357"> </span>
<a href="#l2.1358"></a><span id="l2.1358">     // suspend necko request until timeout</span>
<a href="#l2.1359"></a><span id="l2.1359">     // might not have a request if someone called CloseSocket()</span>
<a href="#l2.1360"></a><span id="l2.1360">     // see bug #195440</span>
<a href="#l2.1361"></a><span id="l2.1361">     if (m_request)</span>
<a href="#l2.1362"></a><span id="l2.1362">       m_request-&gt;Suspend();</span>
<a href="#l2.1363"></a><span id="l2.1363">   }</span>
<a href="#l2.1364"></a><span id="l2.1364"> </span>
<a href="#l2.1365"></a><span id="l2.1365">   PR_Free(lineToFree);</span>
<a href="#l2.1366"></a><span id="l2.1366" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l2.1367"></a><span id="l2.1367" class="difflineminus">-    return -1;</span>
<a href="#l2.1368"></a><span id="l2.1368" class="difflineminus">-  return(status);</span>
<a href="#l2.1369"></a><span id="l2.1369" class="difflineplus">+  return rv;</span>
<a href="#l2.1370"></a><span id="l2.1370"> }</span>
<a href="#l2.1371"></a><span id="l2.1371"> </span>
<a href="#l2.1372"></a><span id="l2.1372"> NS_IMETHODIMP</span>
<a href="#l2.1373"></a><span id="l2.1373"> nsNNTPProtocol::Notify(nsITimer *timer)</span>
<a href="#l2.1374"></a><span id="l2.1374"> {</span>
<a href="#l2.1375"></a><span id="l2.1375">   NS_ASSERTION(timer == mUpdateTimer.get(), &quot;Hey, this ain't my timer!&quot;);</span>
<a href="#l2.1376"></a><span id="l2.1376">   mUpdateTimer = nullptr;    // release my hold</span>
<a href="#l2.1377"></a><span id="l2.1377">   TimerCallback();</span>
<a href="#l2.1378"></a><span id="l2.1378" class="difflineat">@@ -2977,23 +2964,23 @@ void nsNNTPProtocol::HandleAuthenticatio</span>
<a href="#l2.1379"></a><span id="l2.1379"> }</span>
<a href="#l2.1380"></a><span id="l2.1380"> </span>
<a href="#l2.1381"></a><span id="l2.1381"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l2.1382"></a><span id="l2.1382"> // XOVER, XHDR, and HEAD processing code</span>
<a href="#l2.1383"></a><span id="l2.1383"> // Used for filters</span>
<a href="#l2.1384"></a><span id="l2.1384"> // State machine explanation located in doxygen comments for nsNNTPProtocol</span>
<a href="#l2.1385"></a><span id="l2.1385"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l2.1386"></a><span id="l2.1386"> </span>
<a href="#l2.1387"></a><span id="l2.1387" class="difflineminus">-int32_t nsNNTPProtocol::BeginReadXover()</span>
<a href="#l2.1388"></a><span id="l2.1388" class="difflineplus">+nsresult nsNNTPProtocol::BeginReadXover()</span>
<a href="#l2.1389"></a><span id="l2.1389"> {</span>
<a href="#l2.1390"></a><span id="l2.1390">   int32_t count;     /* Response fields */</span>
<a href="#l2.1391"></a><span id="l2.1391">   nsresult rv = NS_OK;</span>
<a href="#l2.1392"></a><span id="l2.1392"> </span>
<a href="#l2.1393"></a><span id="l2.1393">   rv = SetCurrentGroup();</span>
<a href="#l2.1394"></a><span id="l2.1394" class="difflineminus">-  if (NS_FAILED(rv)) return -1;</span>
<a href="#l2.1395"></a><span id="l2.1395" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.1396"></a><span id="l2.1396"> </span>
<a href="#l2.1397"></a><span id="l2.1397">   /* Make sure we never close and automatically reopen the connection at this</span>
<a href="#l2.1398"></a><span id="l2.1398">   point; we'll confuse libmsg too much... */</span>
<a href="#l2.1399"></a><span id="l2.1399"> </span>
<a href="#l2.1400"></a><span id="l2.1400">   SetFlag(NNTP_SOME_PROTOCOL_SUCCEEDED);</span>
<a href="#l2.1401"></a><span id="l2.1401"> </span>
<a href="#l2.1402"></a><span id="l2.1402">   /* We have just issued a GROUP command and read the response.</span>
<a href="#l2.1403"></a><span id="l2.1403">   Now parse that response to help decide which articles to request</span>
<a href="#l2.1404"></a><span id="l2.1404" class="difflineat">@@ -3001,139 +2988,133 @@ int32_t nsNNTPProtocol::BeginReadXover()</span>
<a href="#l2.1405"></a><span id="l2.1405">    */</span>
<a href="#l2.1406"></a><span id="l2.1406">   PR_sscanf(m_responseText,</span>
<a href="#l2.1407"></a><span id="l2.1407">     &quot;%d %d %d&quot;,</span>
<a href="#l2.1408"></a><span id="l2.1408">     &amp;count,</span>
<a href="#l2.1409"></a><span id="l2.1409">     &amp;m_firstPossibleArticle,</span>
<a href="#l2.1410"></a><span id="l2.1410">     &amp;m_lastPossibleArticle);</span>
<a href="#l2.1411"></a><span id="l2.1411"> </span>
<a href="#l2.1412"></a><span id="l2.1412">   m_newsgroupList = do_CreateInstance(NS_NNTPNEWSGROUPLIST_CONTRACTID, &amp;rv);</span>
<a href="#l2.1413"></a><span id="l2.1413" class="difflineminus">-  if (NS_FAILED(rv)) return -1;</span>
<a href="#l2.1414"></a><span id="l2.1414" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.1415"></a><span id="l2.1415"> </span>
<a href="#l2.1416"></a><span id="l2.1416">   rv = m_newsgroupList-&gt;Initialize(m_runningURL, m_newsFolder);</span>
<a href="#l2.1417"></a><span id="l2.1417" class="difflineminus">-  if (NS_FAILED(rv)) return -1;</span>
<a href="#l2.1418"></a><span id="l2.1418" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.1419"></a><span id="l2.1419"> </span>
<a href="#l2.1420"></a><span id="l2.1420">   rv = m_newsFolder-&gt;UpdateSummaryFromNNTPInfo(m_firstPossibleArticle, m_lastPossibleArticle, count);</span>
<a href="#l2.1421"></a><span id="l2.1421" class="difflineminus">-  if (NS_FAILED(rv)) return -1;</span>
<a href="#l2.1422"></a><span id="l2.1422" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.1423"></a><span id="l2.1423"> </span>
<a href="#l2.1424"></a><span id="l2.1424">   m_numArticlesLoaded = 0;</span>
<a href="#l2.1425"></a><span id="l2.1425"> </span>
<a href="#l2.1426"></a><span id="l2.1426">   // if the user sets max_articles to a bogus value, get them everything</span>
<a href="#l2.1427"></a><span id="l2.1427">   m_numArticlesWanted = m_maxArticles &gt; 0 ? m_maxArticles : 1L &lt;&lt; 30;</span>
<a href="#l2.1428"></a><span id="l2.1428"> </span>
<a href="#l2.1429"></a><span id="l2.1429">   m_nextState = NNTP_FIGURE_NEXT_CHUNK;</span>
<a href="#l2.1430"></a><span id="l2.1430">   ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.1431"></a><span id="l2.1431" class="difflineminus">-  return 0;</span>
<a href="#l2.1432"></a><span id="l2.1432" class="difflineplus">+  return NS_OK;</span>
<a href="#l2.1433"></a><span id="l2.1433"> }</span>
<a href="#l2.1434"></a><span id="l2.1434"> </span>
<a href="#l2.1435"></a><span id="l2.1435" class="difflineminus">-int32_t nsNNTPProtocol::FigureNextChunk()</span>
<a href="#l2.1436"></a><span id="l2.1436" class="difflineplus">+nsresult nsNNTPProtocol::FigureNextChunk()</span>
<a href="#l2.1437"></a><span id="l2.1437"> {</span>
<a href="#l2.1438"></a><span id="l2.1438">     nsresult rv = NS_OK;</span>
<a href="#l2.1439"></a><span id="l2.1439">   int32_t status = 0;</span>
<a href="#l2.1440"></a><span id="l2.1440"> </span>
<a href="#l2.1441"></a><span id="l2.1441">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(m_runningURL);</span>
<a href="#l2.1442"></a><span id="l2.1442">   if (m_firstArticle &gt; 0)</span>
<a href="#l2.1443"></a><span id="l2.1443">   {</span>
<a href="#l2.1444"></a><span id="l2.1444">       PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;(%p) add to known articles:  %d - %d&quot;, this, m_firstArticle, m_lastArticle));</span>
<a href="#l2.1445"></a><span id="l2.1445"> </span>
<a href="#l2.1446"></a><span id="l2.1446">       if (NS_SUCCEEDED(rv) &amp;&amp; m_newsgroupList) {</span>
<a href="#l2.1447"></a><span id="l2.1447">           rv = m_newsgroupList-&gt;AddToKnownArticles(m_firstArticle,</span>
<a href="#l2.1448"></a><span id="l2.1448">                                                  m_lastArticle);</span>
<a href="#l2.1449"></a><span id="l2.1449">       }</span>
<a href="#l2.1450"></a><span id="l2.1450"> </span>
<a href="#l2.1451"></a><span id="l2.1451" class="difflineminus">-    if (NS_FAILED(rv)) return status;</span>
<a href="#l2.1452"></a><span id="l2.1452" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.1453"></a><span id="l2.1453">   }</span>
<a href="#l2.1454"></a><span id="l2.1454"> </span>
<a href="#l2.1455"></a><span id="l2.1455">   if (m_numArticlesLoaded &gt;= m_numArticlesWanted)</span>
<a href="#l2.1456"></a><span id="l2.1456">   {</span>
<a href="#l2.1457"></a><span id="l2.1457">     m_nextState = NEWS_PROCESS_XOVER;</span>
<a href="#l2.1458"></a><span id="l2.1458">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.1459"></a><span id="l2.1459" class="difflineminus">-    return 0;</span>
<a href="#l2.1460"></a><span id="l2.1460" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.1461"></a><span id="l2.1461">   }</span>
<a href="#l2.1462"></a><span id="l2.1462"> </span>
<a href="#l2.1463"></a><span id="l2.1463">     NS_ASSERTION(m_newsgroupList, &quot;no newsgroupList&quot;);</span>
<a href="#l2.1464"></a><span id="l2.1464" class="difflineminus">-    if (!m_newsgroupList) return -1;</span>
<a href="#l2.1465"></a><span id="l2.1465" class="difflineplus">+    if (!m_newsgroupList) return NS_ERROR_FAILURE;</span>
<a href="#l2.1466"></a><span id="l2.1466"> </span>
<a href="#l2.1467"></a><span id="l2.1467">     bool getOldMessages = false;</span>
<a href="#l2.1468"></a><span id="l2.1468">     if (m_runningURL) {</span>
<a href="#l2.1469"></a><span id="l2.1469">       rv = m_runningURL-&gt;GetGetOldMessages(&amp;getOldMessages);</span>
<a href="#l2.1470"></a><span id="l2.1470" class="difflineminus">-      if (NS_FAILED(rv)) return status;</span>
<a href="#l2.1471"></a><span id="l2.1471" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.1472"></a><span id="l2.1472">     }</span>
<a href="#l2.1473"></a><span id="l2.1473"> </span>
<a href="#l2.1474"></a><span id="l2.1474">     rv = m_newsgroupList-&gt;SetGetOldMessages(getOldMessages);</span>
<a href="#l2.1475"></a><span id="l2.1475" class="difflineminus">-    if (NS_FAILED(rv)) return status;</span>
<a href="#l2.1476"></a><span id="l2.1476" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.1477"></a><span id="l2.1477"> </span>
<a href="#l2.1478"></a><span id="l2.1478">     rv = m_newsgroupList-&gt;GetRangeOfArtsToDownload(m_msgWindow,</span>
<a href="#l2.1479"></a><span id="l2.1479">       m_firstPossibleArticle,</span>
<a href="#l2.1480"></a><span id="l2.1480">       m_lastPossibleArticle,</span>
<a href="#l2.1481"></a><span id="l2.1481">       m_numArticlesWanted - m_numArticlesLoaded,</span>
<a href="#l2.1482"></a><span id="l2.1482">       &amp;(m_firstArticle),</span>
<a href="#l2.1483"></a><span id="l2.1483">       &amp;(m_lastArticle),</span>
<a href="#l2.1484"></a><span id="l2.1484">       &amp;status);</span>
<a href="#l2.1485"></a><span id="l2.1485"> </span>
<a href="#l2.1486"></a><span id="l2.1486" class="difflineminus">-  if (NS_FAILED(rv)) return status;</span>
<a href="#l2.1487"></a><span id="l2.1487" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.1488"></a><span id="l2.1488"> </span>
<a href="#l2.1489"></a><span id="l2.1489">   if (m_firstArticle &lt;= 0 || m_firstArticle &gt; m_lastArticle)</span>
<a href="#l2.1490"></a><span id="l2.1490">   {</span>
<a href="#l2.1491"></a><span id="l2.1491">     /* Nothing more to get. */</span>
<a href="#l2.1492"></a><span id="l2.1492">     m_nextState = NEWS_PROCESS_XOVER;</span>
<a href="#l2.1493"></a><span id="l2.1493">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.1494"></a><span id="l2.1494" class="difflineminus">-    return 0;</span>
<a href="#l2.1495"></a><span id="l2.1495" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.1496"></a><span id="l2.1496">   }</span>
<a href="#l2.1497"></a><span id="l2.1497"> </span>
<a href="#l2.1498"></a><span id="l2.1498">   PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;(%p) Chunk will be (%d-%d)&quot;, this, m_firstArticle, m_lastArticle));</span>
<a href="#l2.1499"></a><span id="l2.1499"> </span>
<a href="#l2.1500"></a><span id="l2.1500">   m_articleNumber = m_firstArticle;</span>
<a href="#l2.1501"></a><span id="l2.1501"> </span>
<a href="#l2.1502"></a><span id="l2.1502">     /* was MSG_InitXOVER() */</span>
<a href="#l2.1503"></a><span id="l2.1503">     if (m_newsgroupList) {</span>
<a href="#l2.1504"></a><span id="l2.1504">         rv = m_newsgroupList-&gt;InitXOVER(m_firstArticle, m_lastArticle);</span>
<a href="#l2.1505"></a><span id="l2.1505">   }</span>
<a href="#l2.1506"></a><span id="l2.1506"> </span>
<a href="#l2.1507"></a><span id="l2.1507" class="difflineminus">-    /* convert nsresult-&gt;status */</span>
<a href="#l2.1508"></a><span id="l2.1508" class="difflineminus">-    status = NS_FAILED(rv);</span>
<a href="#l2.1509"></a><span id="l2.1509" class="difflineminus">-</span>
<a href="#l2.1510"></a><span id="l2.1510" class="difflineminus">-  if (status &lt; 0)</span>
<a href="#l2.1511"></a><span id="l2.1511" class="difflineminus">-    return status;</span>
<a href="#l2.1512"></a><span id="l2.1512" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.1513"></a><span id="l2.1513"> </span>
<a href="#l2.1514"></a><span id="l2.1514">   ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.1515"></a><span id="l2.1515">   if (TestFlag(NNTP_NO_XOVER_SUPPORT))</span>
<a href="#l2.1516"></a><span id="l2.1516">     m_nextState = NNTP_READ_GROUP;</span>
<a href="#l2.1517"></a><span id="l2.1517">   else</span>
<a href="#l2.1518"></a><span id="l2.1518">     m_nextState = NNTP_XOVER_SEND;</span>
<a href="#l2.1519"></a><span id="l2.1519"> </span>
<a href="#l2.1520"></a><span id="l2.1520" class="difflineminus">-  return 0;</span>
<a href="#l2.1521"></a><span id="l2.1521" class="difflineplus">+  return NS_OK;</span>
<a href="#l2.1522"></a><span id="l2.1522"> }</span>
<a href="#l2.1523"></a><span id="l2.1523"> </span>
<a href="#l2.1524"></a><span id="l2.1524" class="difflineminus">-int32_t nsNNTPProtocol::XoverSend()</span>
<a href="#l2.1525"></a><span id="l2.1525" class="difflineplus">+nsresult nsNNTPProtocol::XoverSend()</span>
<a href="#l2.1526"></a><span id="l2.1526"> {</span>
<a href="#l2.1527"></a><span id="l2.1527">   char outputBuffer[OUTPUT_BUFFER_SIZE];</span>
<a href="#l2.1528"></a><span id="l2.1528" class="difflineminus">-  int32_t status = 0;</span>
<a href="#l2.1529"></a><span id="l2.1529"> </span>
<a href="#l2.1530"></a><span id="l2.1530">     PR_snprintf(outputBuffer,</span>
<a href="#l2.1531"></a><span id="l2.1531">         OUTPUT_BUFFER_SIZE,</span>
<a href="#l2.1532"></a><span id="l2.1532">         &quot;XOVER %d-%d&quot; CRLF,</span>
<a href="#l2.1533"></a><span id="l2.1533">         m_firstArticle,</span>
<a href="#l2.1534"></a><span id="l2.1534">         m_lastArticle);</span>
<a href="#l2.1535"></a><span id="l2.1535"> </span>
<a href="#l2.1536"></a><span id="l2.1536">     m_nextState = NNTP_RESPONSE;</span>
<a href="#l2.1537"></a><span id="l2.1537">     m_nextStateAfterResponse = NNTP_XOVER_RESPONSE;</span>
<a href="#l2.1538"></a><span id="l2.1538">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.1539"></a><span id="l2.1539"> </span>
<a href="#l2.1540"></a><span id="l2.1540" class="difflineminus">-  status = SendData(outputBuffer);</span>
<a href="#l2.1541"></a><span id="l2.1541" class="difflineminus">-  return status;</span>
<a href="#l2.1542"></a><span id="l2.1542" class="difflineplus">+  return SendData(outputBuffer);</span>
<a href="#l2.1543"></a><span id="l2.1543"> }</span>
<a href="#l2.1544"></a><span id="l2.1544"> </span>
<a href="#l2.1545"></a><span id="l2.1545"> /* see if the xover response is going to return us data</span>
<a href="#l2.1546"></a><span id="l2.1546">  * if the proper code isn't returned then assume xover</span>
<a href="#l2.1547"></a><span id="l2.1547">  * isn't supported and use</span>
<a href="#l2.1548"></a><span id="l2.1548">  * normal read_group</span>
<a href="#l2.1549"></a><span id="l2.1549">  */</span>
<a href="#l2.1550"></a><span id="l2.1550"> </span>
<a href="#l2.1551"></a><span id="l2.1551" class="difflineminus">-int32_t nsNNTPProtocol::ReadXoverResponse()</span>
<a href="#l2.1552"></a><span id="l2.1552" class="difflineplus">+nsresult nsNNTPProtocol::ReadXoverResponse()</span>
<a href="#l2.1553"></a><span id="l2.1553"> {</span>
<a href="#l2.1554"></a><span id="l2.1554"> #ifdef TEST_NO_XOVER_SUPPORT</span>
<a href="#l2.1555"></a><span id="l2.1555">   m_responseCode = MK_NNTP_RESPONSE_CHECK_ERROR; /* pretend XOVER generated an error */</span>
<a href="#l2.1556"></a><span id="l2.1556"> #endif</span>
<a href="#l2.1557"></a><span id="l2.1557"> </span>
<a href="#l2.1558"></a><span id="l2.1558">     if(m_responseCode != MK_NNTP_RESPONSE_XOVER_OK)</span>
<a href="#l2.1559"></a><span id="l2.1559">     {</span>
<a href="#l2.1560"></a><span id="l2.1560">         /* If we didn't get back &quot;224 data follows&quot; from the XOVER request,</span>
<a href="#l2.1561"></a><span id="l2.1561" class="difflineat">@@ -3149,47 +3130,47 @@ int32_t nsNNTPProtocol::ReadXoverRespons</span>
<a href="#l2.1562"></a><span id="l2.1562">     m_nextState = NNTP_READ_GROUP;</span>
<a href="#l2.1563"></a><span id="l2.1563">     SetFlag(NNTP_NO_XOVER_SUPPORT);</span>
<a href="#l2.1564"></a><span id="l2.1564">     }</span>
<a href="#l2.1565"></a><span id="l2.1565">     else</span>
<a href="#l2.1566"></a><span id="l2.1566">     {</span>
<a href="#l2.1567"></a><span id="l2.1567">         m_nextState = NNTP_XOVER;</span>
<a href="#l2.1568"></a><span id="l2.1568">     }</span>
<a href="#l2.1569"></a><span id="l2.1569"> </span>
<a href="#l2.1570"></a><span id="l2.1570" class="difflineminus">-    return(0);  /* continue */</span>
<a href="#l2.1571"></a><span id="l2.1571" class="difflineplus">+    return NS_OK;  /* continue */</span>
<a href="#l2.1572"></a><span id="l2.1572"> }</span>
<a href="#l2.1573"></a><span id="l2.1573"> </span>
<a href="#l2.1574"></a><span id="l2.1574"> /* process the xover list as it comes from the server</span>
<a href="#l2.1575"></a><span id="l2.1575">  * and load it into the sort list.</span>
<a href="#l2.1576"></a><span id="l2.1576">  */</span>
<a href="#l2.1577"></a><span id="l2.1577"> </span>
<a href="#l2.1578"></a><span id="l2.1578" class="difflineminus">-int32_t nsNNTPProtocol::ReadXover(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l2.1579"></a><span id="l2.1579" class="difflineplus">+nsresult nsNNTPProtocol::ReadXover(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l2.1580"></a><span id="l2.1580"> {</span>
<a href="#l2.1581"></a><span id="l2.1581">   char *line, *lineToFree;</span>
<a href="#l2.1582"></a><span id="l2.1582">   nsresult rv;</span>
<a href="#l2.1583"></a><span id="l2.1583">   uint32_t status = 1;</span>
<a href="#l2.1584"></a><span id="l2.1584"> </span>
<a href="#l2.1585"></a><span id="l2.1585">   bool pauseForMoreData = false;</span>
<a href="#l2.1586"></a><span id="l2.1586" class="difflineminus">-  line = lineToFree = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData);</span>
<a href="#l2.1587"></a><span id="l2.1587" class="difflineplus">+  line = lineToFree = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData, &amp;rv);</span>
<a href="#l2.1588"></a><span id="l2.1588"> </span>
<a href="#l2.1589"></a><span id="l2.1589">   if(pauseForMoreData)</span>
<a href="#l2.1590"></a><span id="l2.1590">   {</span>
<a href="#l2.1591"></a><span id="l2.1591">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.1592"></a><span id="l2.1592" class="difflineminus">-    return 0;</span>
<a href="#l2.1593"></a><span id="l2.1593" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.1594"></a><span id="l2.1594">   }</span>
<a href="#l2.1595"></a><span id="l2.1595"> </span>
<a href="#l2.1596"></a><span id="l2.1596">   if(!line)</span>
<a href="#l2.1597"></a><span id="l2.1597" class="difflineminus">-    return(status);  /* no line yet or TCP error */</span>
<a href="#l2.1598"></a><span id="l2.1598" class="difflineplus">+    return rv;  /* no line yet or TCP error */</span>
<a href="#l2.1599"></a><span id="l2.1599"> </span>
<a href="#l2.1600"></a><span id="l2.1600">   if(line[0] == '.' &amp;&amp; line[1] == '\0')</span>
<a href="#l2.1601"></a><span id="l2.1601">   {</span>
<a href="#l2.1602"></a><span id="l2.1602">     m_nextState = NNTP_XHDR_SEND;</span>
<a href="#l2.1603"></a><span id="l2.1603">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.1604"></a><span id="l2.1604">     PR_Free(lineToFree);</span>
<a href="#l2.1605"></a><span id="l2.1605" class="difflineminus">-    return(0);</span>
<a href="#l2.1606"></a><span id="l2.1606" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.1607"></a><span id="l2.1607">   }</span>
<a href="#l2.1608"></a><span id="l2.1608">   else if (line [0] == '.' &amp;&amp; line [1] == '.')</span>
<a href="#l2.1609"></a><span id="l2.1609">     /* The NNTP server quotes all lines beginning with &quot;.&quot; by doubling it. */</span>
<a href="#l2.1610"></a><span id="l2.1610">     line++;</span>
<a href="#l2.1611"></a><span id="l2.1611"> </span>
<a href="#l2.1612"></a><span id="l2.1612">     /* almost correct</span>
<a href="#l2.1613"></a><span id="l2.1613">   */</span>
<a href="#l2.1614"></a><span id="l2.1614">   if(status &gt; 1)</span>
<a href="#l2.1615"></a><span id="l2.1615" class="difflineat">@@ -3198,125 +3179,125 @@ int32_t nsNNTPProtocol::ReadXover(nsIInp</span>
<a href="#l2.1616"></a><span id="l2.1616">     mBytesReceivedSinceLastStatusUpdate += status;</span>
<a href="#l2.1617"></a><span id="l2.1617">   }</span>
<a href="#l2.1618"></a><span id="l2.1618"> </span>
<a href="#l2.1619"></a><span id="l2.1619">   rv = m_newsgroupList-&gt;ProcessXOVERLINE(line, &amp;status);</span>
<a href="#l2.1620"></a><span id="l2.1620">   NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to process the XOVERLINE&quot;);</span>
<a href="#l2.1621"></a><span id="l2.1621"> </span>
<a href="#l2.1622"></a><span id="l2.1622">   m_numArticlesLoaded++;</span>
<a href="#l2.1623"></a><span id="l2.1623">   PR_Free(lineToFree);</span>
<a href="#l2.1624"></a><span id="l2.1624" class="difflineminus">-  return NS_SUCCEEDED(rv) ? (int32_t)status : -1; /* keep going if no error */</span>
<a href="#l2.1625"></a><span id="l2.1625" class="difflineplus">+  return rv;</span>
<a href="#l2.1626"></a><span id="l2.1626"> }</span>
<a href="#l2.1627"></a><span id="l2.1627"> </span>
<a href="#l2.1628"></a><span id="l2.1628"> /* Finished processing all the XOVER data.</span>
<a href="#l2.1629"></a><span id="l2.1629"> */</span>
<a href="#l2.1630"></a><span id="l2.1630"> </span>
<a href="#l2.1631"></a><span id="l2.1631" class="difflineminus">-int32_t nsNNTPProtocol::ProcessXover()</span>
<a href="#l2.1632"></a><span id="l2.1632" class="difflineplus">+nsresult nsNNTPProtocol::ProcessXover()</span>
<a href="#l2.1633"></a><span id="l2.1633"> {</span>
<a href="#l2.1634"></a><span id="l2.1634">   nsresult rv;</span>
<a href="#l2.1635"></a><span id="l2.1635"> </span>
<a href="#l2.1636"></a><span id="l2.1636">   /* xover_parse_state stored in MSG_Pane cd-&gt;pane */</span>
<a href="#l2.1637"></a><span id="l2.1637">   NS_ASSERTION(m_newsgroupList, &quot;no newsgroupList&quot;);</span>
<a href="#l2.1638"></a><span id="l2.1638" class="difflineminus">-  if (!m_newsgroupList) return -1;</span>
<a href="#l2.1639"></a><span id="l2.1639" class="difflineplus">+  if (!m_newsgroupList) return NS_ERROR_FAILURE;</span>
<a href="#l2.1640"></a><span id="l2.1640"> </span>
<a href="#l2.1641"></a><span id="l2.1641">   // Some people may use the notifications in CallFilters to close the cached</span>
<a href="#l2.1642"></a><span id="l2.1642">   // connections, which will clear m_newsgroupList. So we keep a copy for</span>
<a href="#l2.1643"></a><span id="l2.1643">   // ourselves to ward off this threat.</span>
<a href="#l2.1644"></a><span id="l2.1644">   nsCOMPtr&lt;nsINNTPNewsgroupList&gt; list(m_newsgroupList);</span>
<a href="#l2.1645"></a><span id="l2.1645">   list-&gt;CallFilters();</span>
<a href="#l2.1646"></a><span id="l2.1646">   int32_t status = 0;</span>
<a href="#l2.1647"></a><span id="l2.1647">   rv = list-&gt;FinishXOVERLINE(0, &amp;status);</span>
<a href="#l2.1648"></a><span id="l2.1648">   m_newsgroupList = nullptr;</span>
<a href="#l2.1649"></a><span id="l2.1649" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; status &lt; 0) return status;</span>
<a href="#l2.1650"></a><span id="l2.1650" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; status &lt; 0) return NS_ERROR_FAILURE;</span>
<a href="#l2.1651"></a><span id="l2.1651"> </span>
<a href="#l2.1652"></a><span id="l2.1652">   m_nextState = NEWS_DONE;</span>
<a href="#l2.1653"></a><span id="l2.1653"> </span>
<a href="#l2.1654"></a><span id="l2.1654" class="difflineminus">-  return(MK_DATA_LOADED);</span>
<a href="#l2.1655"></a><span id="l2.1655" class="difflineplus">+  return NS_OK;</span>
<a href="#l2.1656"></a><span id="l2.1656"> }</span>
<a href="#l2.1657"></a><span id="l2.1657"> </span>
<a href="#l2.1658"></a><span id="l2.1658" class="difflineminus">-int32_t nsNNTPProtocol::XhdrSend()</span>
<a href="#l2.1659"></a><span id="l2.1659" class="difflineplus">+nsresult nsNNTPProtocol::XhdrSend()</span>
<a href="#l2.1660"></a><span id="l2.1660"> {</span>
<a href="#l2.1661"></a><span id="l2.1661">   nsCString header;</span>
<a href="#l2.1662"></a><span id="l2.1662">   m_newsgroupList-&gt;InitXHDR(header);</span>
<a href="#l2.1663"></a><span id="l2.1663">   if (header.IsEmpty())</span>
<a href="#l2.1664"></a><span id="l2.1664">   {</span>
<a href="#l2.1665"></a><span id="l2.1665">     m_nextState = NNTP_FIGURE_NEXT_CHUNK;</span>
<a href="#l2.1666"></a><span id="l2.1666" class="difflineminus">-    return 0;</span>
<a href="#l2.1667"></a><span id="l2.1667" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.1668"></a><span id="l2.1668">   }</span>
<a href="#l2.1669"></a><span id="l2.1669">   </span>
<a href="#l2.1670"></a><span id="l2.1670">   char outputBuffer[OUTPUT_BUFFER_SIZE];</span>
<a href="#l2.1671"></a><span id="l2.1671">   PR_snprintf(outputBuffer, OUTPUT_BUFFER_SIZE, &quot;XHDR %s %d-%d&quot; CRLF,</span>
<a href="#l2.1672"></a><span id="l2.1672">               header.get(), m_firstArticle, m_lastArticle);</span>
<a href="#l2.1673"></a><span id="l2.1673"> </span>
<a href="#l2.1674"></a><span id="l2.1674">   m_nextState = NNTP_RESPONSE;</span>
<a href="#l2.1675"></a><span id="l2.1675">   m_nextStateAfterResponse = NNTP_XHDR_RESPONSE;</span>
<a href="#l2.1676"></a><span id="l2.1676">   SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.1677"></a><span id="l2.1677"> </span>
<a href="#l2.1678"></a><span id="l2.1678">   return SendData(outputBuffer);</span>
<a href="#l2.1679"></a><span id="l2.1679"> }</span>
<a href="#l2.1680"></a><span id="l2.1680"> </span>
<a href="#l2.1681"></a><span id="l2.1681" class="difflineminus">-int32_t nsNNTPProtocol::XhdrResponse(nsIInputStream *inputStream)</span>
<a href="#l2.1682"></a><span id="l2.1682" class="difflineplus">+nsresult nsNNTPProtocol::XhdrResponse(nsIInputStream *inputStream)</span>
<a href="#l2.1683"></a><span id="l2.1683"> {</span>
<a href="#l2.1684"></a><span id="l2.1684">   if (m_responseCode != MK_NNTP_RESPONSE_XHDR_OK)</span>
<a href="#l2.1685"></a><span id="l2.1685">   {</span>
<a href="#l2.1686"></a><span id="l2.1686">     m_nextState = NNTP_READ_GROUP;</span>
<a href="#l2.1687"></a><span id="l2.1687">     // The reasoning behind setting this flag and not an XHDR flag is that we</span>
<a href="#l2.1688"></a><span id="l2.1688">     // are going to have to use HEAD instead. At that point, using XOVER as</span>
<a href="#l2.1689"></a><span id="l2.1689">     // well is just wasting bandwidth.</span>
<a href="#l2.1690"></a><span id="l2.1690">     SetFlag(NNTP_NO_XOVER_SUPPORT);</span>
<a href="#l2.1691"></a><span id="l2.1691" class="difflineminus">-    return 0;</span>
<a href="#l2.1692"></a><span id="l2.1692" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.1693"></a><span id="l2.1693">   }</span>
<a href="#l2.1694"></a><span id="l2.1694">   </span>
<a href="#l2.1695"></a><span id="l2.1695">   char *line, *lineToFree;</span>
<a href="#l2.1696"></a><span id="l2.1696">   nsresult rv;</span>
<a href="#l2.1697"></a><span id="l2.1697">   uint32_t status = 1;</span>
<a href="#l2.1698"></a><span id="l2.1698"> </span>
<a href="#l2.1699"></a><span id="l2.1699">   bool pauseForMoreData = false;</span>
<a href="#l2.1700"></a><span id="l2.1700" class="difflineminus">-  line = lineToFree = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData);</span>
<a href="#l2.1701"></a><span id="l2.1701" class="difflineplus">+  line = lineToFree = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData, &amp;rv);</span>
<a href="#l2.1702"></a><span id="l2.1702"> </span>
<a href="#l2.1703"></a><span id="l2.1703">   if (pauseForMoreData)</span>
<a href="#l2.1704"></a><span id="l2.1704">   {</span>
<a href="#l2.1705"></a><span id="l2.1705">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.1706"></a><span id="l2.1706" class="difflineminus">-    return 0;</span>
<a href="#l2.1707"></a><span id="l2.1707" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.1708"></a><span id="l2.1708">   }</span>
<a href="#l2.1709"></a><span id="l2.1709"> </span>
<a href="#l2.1710"></a><span id="l2.1710">   if (!line)</span>
<a href="#l2.1711"></a><span id="l2.1711" class="difflineminus">-    return status;  /* no line yet or TCP error */</span>
<a href="#l2.1712"></a><span id="l2.1712" class="difflineplus">+    return rv;  /* no line yet or TCP error */</span>
<a href="#l2.1713"></a><span id="l2.1713"> </span>
<a href="#l2.1714"></a><span id="l2.1714">   if (line[0] == '.' &amp;&amp; line[1] == '\0')</span>
<a href="#l2.1715"></a><span id="l2.1715">   {</span>
<a href="#l2.1716"></a><span id="l2.1716">     m_nextState = NNTP_XHDR_SEND;</span>
<a href="#l2.1717"></a><span id="l2.1717">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.1718"></a><span id="l2.1718">     PR_Free(lineToFree);</span>
<a href="#l2.1719"></a><span id="l2.1719" class="difflineminus">-    return(0);</span>
<a href="#l2.1720"></a><span id="l2.1720" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.1721"></a><span id="l2.1721">   }</span>
<a href="#l2.1722"></a><span id="l2.1722"> </span>
<a href="#l2.1723"></a><span id="l2.1723">   if (status &gt; 1)</span>
<a href="#l2.1724"></a><span id="l2.1724">   {</span>
<a href="#l2.1725"></a><span id="l2.1725">     mBytesReceived += status;</span>
<a href="#l2.1726"></a><span id="l2.1726">     mBytesReceivedSinceLastStatusUpdate += status;</span>
<a href="#l2.1727"></a><span id="l2.1727">   }</span>
<a href="#l2.1728"></a><span id="l2.1728"> </span>
<a href="#l2.1729"></a><span id="l2.1729">   rv = m_newsgroupList-&gt;ProcessXHDRLine(nsDependentCString(line));</span>
<a href="#l2.1730"></a><span id="l2.1730">   NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to process the XHDRLINE&quot;);</span>
<a href="#l2.1731"></a><span id="l2.1731"> </span>
<a href="#l2.1732"></a><span id="l2.1732">   m_numArticlesLoaded++;</span>
<a href="#l2.1733"></a><span id="l2.1733">   PR_Free(lineToFree);</span>
<a href="#l2.1734"></a><span id="l2.1734" class="difflineminus">-  return NS_SUCCEEDED(rv) ? (int32_t)status : -1; /* keep going if no error */</span>
<a href="#l2.1735"></a><span id="l2.1735" class="difflineplus">+  return rv;</span>
<a href="#l2.1736"></a><span id="l2.1736"> }</span>
<a href="#l2.1737"></a><span id="l2.1737"> </span>
<a href="#l2.1738"></a><span id="l2.1738" class="difflineminus">-int32_t nsNNTPProtocol::ReadHeaders()</span>
<a href="#l2.1739"></a><span id="l2.1739" class="difflineplus">+nsresult nsNNTPProtocol::ReadHeaders()</span>
<a href="#l2.1740"></a><span id="l2.1740"> {</span>
<a href="#l2.1741"></a><span id="l2.1741">   if(m_articleNumber &gt; m_lastArticle)</span>
<a href="#l2.1742"></a><span id="l2.1742">   {  /* end of groups */</span>
<a href="#l2.1743"></a><span id="l2.1743"> </span>
<a href="#l2.1744"></a><span id="l2.1744">     m_newsgroupList-&gt;InitHEAD(-1);</span>
<a href="#l2.1745"></a><span id="l2.1745">     m_nextState = NNTP_FIGURE_NEXT_CHUNK;</span>
<a href="#l2.1746"></a><span id="l2.1746">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.1747"></a><span id="l2.1747" class="difflineminus">-    return(0);</span>
<a href="#l2.1748"></a><span id="l2.1748" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.1749"></a><span id="l2.1749">   }</span>
<a href="#l2.1750"></a><span id="l2.1750">   else</span>
<a href="#l2.1751"></a><span id="l2.1751">   {</span>
<a href="#l2.1752"></a><span id="l2.1752">     m_newsgroupList-&gt;InitHEAD(m_articleNumber);</span>
<a href="#l2.1753"></a><span id="l2.1753"> </span>
<a href="#l2.1754"></a><span id="l2.1754">     char outputBuffer[OUTPUT_BUFFER_SIZE];</span>
<a href="#l2.1755"></a><span id="l2.1755">     PR_snprintf(outputBuffer,</span>
<a href="#l2.1756"></a><span id="l2.1756">       OUTPUT_BUFFER_SIZE,</span>
<a href="#l2.1757"></a><span id="l2.1757" class="difflineat">@@ -3328,72 +3309,71 @@ int32_t nsNNTPProtocol::ReadHeaders()</span>
<a href="#l2.1758"></a><span id="l2.1758">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.1759"></a><span id="l2.1759">     return SendData(outputBuffer);</span>
<a href="#l2.1760"></a><span id="l2.1760">   }</span>
<a href="#l2.1761"></a><span id="l2.1761"> }</span>
<a href="#l2.1762"></a><span id="l2.1762"> </span>
<a href="#l2.1763"></a><span id="l2.1763"> /* See if the &quot;HEAD&quot; command was successful</span>
<a href="#l2.1764"></a><span id="l2.1764"> */</span>
<a href="#l2.1765"></a><span id="l2.1765"> </span>
<a href="#l2.1766"></a><span id="l2.1766" class="difflineminus">-int32_t nsNNTPProtocol::ReadNewsgroupResponse()</span>
<a href="#l2.1767"></a><span id="l2.1767" class="difflineplus">+nsresult nsNNTPProtocol::ReadNewsgroupResponse()</span>
<a href="#l2.1768"></a><span id="l2.1768"> {</span>
<a href="#l2.1769"></a><span id="l2.1769">   if (m_responseCode == MK_NNTP_RESPONSE_ARTICLE_HEAD)</span>
<a href="#l2.1770"></a><span id="l2.1770">   {     /* Head follows - parse it:*/</span>
<a href="#l2.1771"></a><span id="l2.1771">     m_nextState = NNTP_READ_GROUP_BODY;</span>
<a href="#l2.1772"></a><span id="l2.1772"> </span>
<a href="#l2.1773"></a><span id="l2.1773" class="difflineminus">-    return 0;</span>
<a href="#l2.1774"></a><span id="l2.1774" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.1775"></a><span id="l2.1775">   }</span>
<a href="#l2.1776"></a><span id="l2.1776">   else</span>
<a href="#l2.1777"></a><span id="l2.1777">   {</span>
<a href="#l2.1778"></a><span id="l2.1778">     m_newsgroupList-&gt;HEADFailed(m_articleNumber);</span>
<a href="#l2.1779"></a><span id="l2.1779">     m_nextState = NNTP_READ_GROUP;</span>
<a href="#l2.1780"></a><span id="l2.1780" class="difflineminus">-    return(0);</span>
<a href="#l2.1781"></a><span id="l2.1781" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.1782"></a><span id="l2.1782">   }</span>
<a href="#l2.1783"></a><span id="l2.1783"> }</span>
<a href="#l2.1784"></a><span id="l2.1784"> </span>
<a href="#l2.1785"></a><span id="l2.1785"> /* read the body of the &quot;HEAD&quot; command</span>
<a href="#l2.1786"></a><span id="l2.1786"> */</span>
<a href="#l2.1787"></a><span id="l2.1787" class="difflineminus">-int32_t nsNNTPProtocol::ReadNewsgroupBody(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l2.1788"></a><span id="l2.1788" class="difflineplus">+nsresult nsNNTPProtocol::ReadNewsgroupBody(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l2.1789"></a><span id="l2.1789"> {</span>
<a href="#l2.1790"></a><span id="l2.1790">   char *line, *lineToFree;</span>
<a href="#l2.1791"></a><span id="l2.1791">   nsresult rv;</span>
<a href="#l2.1792"></a><span id="l2.1792">   uint32_t status = 1;</span>
<a href="#l2.1793"></a><span id="l2.1793"> </span>
<a href="#l2.1794"></a><span id="l2.1794">   bool pauseForMoreData = false;</span>
<a href="#l2.1795"></a><span id="l2.1795" class="difflineminus">-  line = lineToFree = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData);</span>
<a href="#l2.1796"></a><span id="l2.1796" class="difflineplus">+  line = lineToFree = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData, &amp;rv);</span>
<a href="#l2.1797"></a><span id="l2.1797"> </span>
<a href="#l2.1798"></a><span id="l2.1798">   if(pauseForMoreData)</span>
<a href="#l2.1799"></a><span id="l2.1799">   {</span>
<a href="#l2.1800"></a><span id="l2.1800">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.1801"></a><span id="l2.1801" class="difflineminus">-    return 0;</span>
<a href="#l2.1802"></a><span id="l2.1802" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.1803"></a><span id="l2.1803">   }</span>
<a href="#l2.1804"></a><span id="l2.1804"> </span>
<a href="#l2.1805"></a><span id="l2.1805">   /* if TCP error of if there is not a full line yet return</span>
<a href="#l2.1806"></a><span id="l2.1806">   */</span>
<a href="#l2.1807"></a><span id="l2.1807">   if(!line)</span>
<a href="#l2.1808"></a><span id="l2.1808" class="difflineminus">-    return status;</span>
<a href="#l2.1809"></a><span id="l2.1809" class="difflineplus">+    return rv;</span>
<a href="#l2.1810"></a><span id="l2.1810"> </span>
<a href="#l2.1811"></a><span id="l2.1811">   PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;(%p) read_group_body: got line: %s|&quot;,this,line));</span>
<a href="#l2.1812"></a><span id="l2.1812"> </span>
<a href="#l2.1813"></a><span id="l2.1813">   /* End of body? */</span>
<a href="#l2.1814"></a><span id="l2.1814">   if (line[0]=='.' &amp;&amp; line[1]=='\0')</span>
<a href="#l2.1815"></a><span id="l2.1815">   {</span>
<a href="#l2.1816"></a><span id="l2.1816">     m_nextState = NNTP_READ_GROUP;</span>
<a href="#l2.1817"></a><span id="l2.1817">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.1818"></a><span id="l2.1818" class="difflineminus">-    return 0;</span>
<a href="#l2.1819"></a><span id="l2.1819" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.1820"></a><span id="l2.1820">   }</span>
<a href="#l2.1821"></a><span id="l2.1821">   else if (line [0] == '.' &amp;&amp; line [1] == '.')</span>
<a href="#l2.1822"></a><span id="l2.1822">     /* The NNTP server quotes all lines beginning with &quot;.&quot; by doubling it. */</span>
<a href="#l2.1823"></a><span id="l2.1823">     line++;</span>
<a href="#l2.1824"></a><span id="l2.1824"> </span>
<a href="#l2.1825"></a><span id="l2.1825">   nsCString safe_line(line);</span>
<a href="#l2.1826"></a><span id="l2.1826">   rv = m_newsgroupList-&gt;ProcessHEADLine(safe_line);</span>
<a href="#l2.1827"></a><span id="l2.1827">   PR_Free(lineToFree);</span>
<a href="#l2.1828"></a><span id="l2.1828" class="difflineminus">-  /* convert nsresult-&gt;status */</span>
<a href="#l2.1829"></a><span id="l2.1829" class="difflineminus">-  return NS_FAILED(rv);</span>
<a href="#l2.1830"></a><span id="l2.1830" class="difflineplus">+  return rv;</span>
<a href="#l2.1831"></a><span id="l2.1831"> }</span>
<a href="#l2.1832"></a><span id="l2.1832"> </span>
<a href="#l2.1833"></a><span id="l2.1833"> </span>
<a href="#l2.1834"></a><span id="l2.1834"> nsresult nsNNTPProtocol::GetNewsStringByID(int32_t stringID, PRUnichar **aString)</span>
<a href="#l2.1835"></a><span id="l2.1835"> {</span>
<a href="#l2.1836"></a><span id="l2.1836">   nsresult rv;</span>
<a href="#l2.1837"></a><span id="l2.1837">   nsAutoString resultString(NS_LITERAL_STRING(&quot;???&quot;));</span>
<a href="#l2.1838"></a><span id="l2.1838"> </span>
<a href="#l2.1839"></a><span id="l2.1839" class="difflineat">@@ -3466,17 +3446,17 @@ nsresult nsNNTPProtocol::GetNewsStringBy</span>
<a href="#l2.1840"></a><span id="l2.1840">   {</span>
<a href="#l2.1841"></a><span id="l2.1841">     rv = NS_OK;</span>
<a href="#l2.1842"></a><span id="l2.1842">     *aString = ToNewUnicode(resultString);</span>
<a href="#l2.1843"></a><span id="l2.1843">   }</span>
<a href="#l2.1844"></a><span id="l2.1844">   return rv;</span>
<a href="#l2.1845"></a><span id="l2.1845"> }</span>
<a href="#l2.1846"></a><span id="l2.1846"> </span>
<a href="#l2.1847"></a><span id="l2.1847"> // sspitzer:  PostMessageInFile is derived from nsSmtpProtocol::SendMessageInFile()</span>
<a href="#l2.1848"></a><span id="l2.1848" class="difflineminus">-int32_t nsNNTPProtocol::PostMessageInFile(nsIFile *postMessageFile)</span>
<a href="#l2.1849"></a><span id="l2.1849" class="difflineplus">+nsresult nsNNTPProtocol::PostMessageInFile(nsIFile *postMessageFile)</span>
<a href="#l2.1850"></a><span id="l2.1850"> {</span>
<a href="#l2.1851"></a><span id="l2.1851">     nsCOMPtr&lt;nsIURI&gt; url = do_QueryInterface(m_runningURL);</span>
<a href="#l2.1852"></a><span id="l2.1852">     if (url &amp;&amp; postMessageFile)</span>
<a href="#l2.1853"></a><span id="l2.1853">         nsMsgProtocol::PostMessage(url, postMessageFile);</span>
<a href="#l2.1854"></a><span id="l2.1854"> </span>
<a href="#l2.1855"></a><span id="l2.1855">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.1856"></a><span id="l2.1856"> </span>
<a href="#l2.1857"></a><span id="l2.1857">     // for now, we are always done at this point..we aren't making multiple</span>
<a href="#l2.1858"></a><span id="l2.1858" class="difflineat">@@ -3486,20 +3466,20 @@ int32_t nsNNTPProtocol::PostMessageInFil</span>
<a href="#l2.1859"></a><span id="l2.1859">     PL_strcpy(m_dataBuf, &quot;.&quot; CRLF);</span>
<a href="#l2.1860"></a><span id="l2.1860">     SendData(m_dataBuf);</span>
<a href="#l2.1861"></a><span id="l2.1861"> #ifdef UNREADY_CODE</span>
<a href="#l2.1862"></a><span id="l2.1862">     NET_Progress(CE_WINDOW_ID,</span>
<a href="#l2.1863"></a><span id="l2.1863">                  XP_GetString(XP_MESSAGE_SENT_WAITING_MAIL_REPLY));</span>
<a href="#l2.1864"></a><span id="l2.1864"> #endif /* UNREADY_CODE */</span>
<a href="#l2.1865"></a><span id="l2.1865">     m_nextState = NNTP_RESPONSE;</span>
<a href="#l2.1866"></a><span id="l2.1866">     m_nextStateAfterResponse = NNTP_SEND_POST_DATA_RESPONSE;</span>
<a href="#l2.1867"></a><span id="l2.1867" class="difflineminus">-    return(0);</span>
<a href="#l2.1868"></a><span id="l2.1868" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.1869"></a><span id="l2.1869"> }</span>
<a href="#l2.1870"></a><span id="l2.1870"> </span>
<a href="#l2.1871"></a><span id="l2.1871" class="difflineminus">-int32_t nsNNTPProtocol::PostData()</span>
<a href="#l2.1872"></a><span id="l2.1872" class="difflineplus">+nsresult nsNNTPProtocol::PostData()</span>
<a href="#l2.1873"></a><span id="l2.1873"> {</span>
<a href="#l2.1874"></a><span id="l2.1874">     /* returns 0 on done and negative on error</span>
<a href="#l2.1875"></a><span id="l2.1875">      * positive if it needs to continue.</span>
<a href="#l2.1876"></a><span id="l2.1876">      */</span>
<a href="#l2.1877"></a><span id="l2.1877">     NNTP_LOG_NOTE(&quot;nsNNTPProtocol::PostData()&quot;);</span>
<a href="#l2.1878"></a><span id="l2.1878">     nsresult rv = NS_OK;</span>
<a href="#l2.1879"></a><span id="l2.1879"> </span>
<a href="#l2.1880"></a><span id="l2.1880">     nsCOMPtr &lt;nsINNTPNewsgroupPost&gt; message;</span>
<a href="#l2.1881"></a><span id="l2.1881" class="difflineat">@@ -3507,61 +3487,60 @@ int32_t nsNNTPProtocol::PostData()</span>
<a href="#l2.1882"></a><span id="l2.1882">     if (NS_SUCCEEDED(rv))</span>
<a href="#l2.1883"></a><span id="l2.1883">     {</span>
<a href="#l2.1884"></a><span id="l2.1884">         nsCOMPtr&lt;nsIFile&gt; filePath;</span>
<a href="#l2.1885"></a><span id="l2.1885">         rv = message-&gt;GetPostMessageFile(getter_AddRefs(filePath));</span>
<a href="#l2.1886"></a><span id="l2.1886">         if (NS_SUCCEEDED(rv))</span>
<a href="#l2.1887"></a><span id="l2.1887">             PostMessageInFile(filePath);</span>
<a href="#l2.1888"></a><span id="l2.1888">      }</span>
<a href="#l2.1889"></a><span id="l2.1889"> </span>
<a href="#l2.1890"></a><span id="l2.1890" class="difflineminus">-    return 0;</span>
<a href="#l2.1891"></a><span id="l2.1891" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.1892"></a><span id="l2.1892"> }</span>
<a href="#l2.1893"></a><span id="l2.1893"> </span>
<a href="#l2.1894"></a><span id="l2.1894"> </span>
<a href="#l2.1895"></a><span id="l2.1895"> /* interpret the response code from the server</span>
<a href="#l2.1896"></a><span id="l2.1896">  * after the post is done</span>
<a href="#l2.1897"></a><span id="l2.1897">  */</span>
<a href="#l2.1898"></a><span id="l2.1898" class="difflineminus">-int32_t nsNNTPProtocol::PostDataResponse()</span>
<a href="#l2.1899"></a><span id="l2.1899" class="difflineplus">+nsresult nsNNTPProtocol::PostDataResponse()</span>
<a href="#l2.1900"></a><span id="l2.1900"> {</span>
<a href="#l2.1901"></a><span id="l2.1901">   if (m_responseCode != MK_NNTP_RESPONSE_POST_OK)</span>
<a href="#l2.1902"></a><span id="l2.1902">   {</span>
<a href="#l2.1903"></a><span id="l2.1903">     AlertError(MK_NNTP_ERROR_MESSAGE,m_responseText);</span>
<a href="#l2.1904"></a><span id="l2.1904">     m_nextState = NEWS_ERROR;</span>
<a href="#l2.1905"></a><span id="l2.1905" class="difflineminus">-    return(MK_NNTP_ERROR_MESSAGE);</span>
<a href="#l2.1906"></a><span id="l2.1906" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l2.1907"></a><span id="l2.1907">   }</span>
<a href="#l2.1908"></a><span id="l2.1908">     m_nextState = NEWS_POST_DONE;</span>
<a href="#l2.1909"></a><span id="l2.1909">   ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.1910"></a><span id="l2.1910" class="difflineminus">-    return(MK_DATA_LOADED);</span>
<a href="#l2.1911"></a><span id="l2.1911" class="difflineplus">+  return NS_OK;</span>
<a href="#l2.1912"></a><span id="l2.1912"> }</span>
<a href="#l2.1913"></a><span id="l2.1913"> </span>
<a href="#l2.1914"></a><span id="l2.1914" class="difflineminus">-int32_t nsNNTPProtocol::CheckForArticle()</span>
<a href="#l2.1915"></a><span id="l2.1915" class="difflineplus">+nsresult nsNNTPProtocol::CheckForArticle()</span>
<a href="#l2.1916"></a><span id="l2.1916"> {</span>
<a href="#l2.1917"></a><span id="l2.1917">   m_nextState = NEWS_ERROR;</span>
<a href="#l2.1918"></a><span id="l2.1918">   if (m_responseCode &gt;= 220 &amp;&amp; m_responseCode &lt;= 223) {</span>
<a href="#l2.1919"></a><span id="l2.1919" class="difflineminus">-  /* Yes, this article is already there, we're all done. */</span>
<a href="#l2.1920"></a><span id="l2.1920" class="difflineminus">-  return MK_DATA_LOADED;</span>
<a href="#l2.1921"></a><span id="l2.1921" class="difflineplus">+    /* Yes, this article is already there, we're all done. */</span>
<a href="#l2.1922"></a><span id="l2.1922" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.1923"></a><span id="l2.1923">   }</span>
<a href="#l2.1924"></a><span id="l2.1924">   else</span>
<a href="#l2.1925"></a><span id="l2.1925">   {</span>
<a href="#l2.1926"></a><span id="l2.1926">   /* The article isn't there, so the failure we had earlier wasn't due to</span>
<a href="#l2.1927"></a><span id="l2.1927">      a duplicate message-id.  Return the error from that previous</span>
<a href="#l2.1928"></a><span id="l2.1928">      posting attempt (which is already in ce-&gt;URL_s-&gt;error_msg). */</span>
<a href="#l2.1929"></a><span id="l2.1929" class="difflineminus">-  return MK_NNTP_ERROR_MESSAGE;</span>
<a href="#l2.1930"></a><span id="l2.1930" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l2.1931"></a><span id="l2.1931">   }</span>
<a href="#l2.1932"></a><span id="l2.1932"> }</span>
<a href="#l2.1933"></a><span id="l2.1933"> </span>
<a href="#l2.1934"></a><span id="l2.1934" class="difflineminus">-int32_t nsNNTPProtocol::StartCancel()</span>
<a href="#l2.1935"></a><span id="l2.1935" class="difflineplus">+nsresult nsNNTPProtocol::StartCancel()</span>
<a href="#l2.1936"></a><span id="l2.1936"> {</span>
<a href="#l2.1937"></a><span id="l2.1937" class="difflineminus">-  int32_t status = 0;</span>
<a href="#l2.1938"></a><span id="l2.1938" class="difflineminus">-  status = SendData(NNTP_CMD_POST);</span>
<a href="#l2.1939"></a><span id="l2.1939" class="difflineplus">+  nsresult rv = SendData(NNTP_CMD_POST);</span>
<a href="#l2.1940"></a><span id="l2.1940"> </span>
<a href="#l2.1941"></a><span id="l2.1941">   m_nextState = NNTP_RESPONSE;</span>
<a href="#l2.1942"></a><span id="l2.1942">   m_nextStateAfterResponse = NEWS_DO_CANCEL;</span>
<a href="#l2.1943"></a><span id="l2.1943">   SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.1944"></a><span id="l2.1944" class="difflineminus">-  return (status);</span>
<a href="#l2.1945"></a><span id="l2.1945" class="difflineplus">+  return rv;</span>
<a href="#l2.1946"></a><span id="l2.1946"> }</span>
<a href="#l2.1947"></a><span id="l2.1947"> </span>
<a href="#l2.1948"></a><span id="l2.1948"> bool nsNNTPProtocol::CheckIfAuthor(nsISupports *aElement, void *data)</span>
<a href="#l2.1949"></a><span id="l2.1949"> {</span>
<a href="#l2.1950"></a><span id="l2.1950">     nsresult rv;</span>
<a href="#l2.1951"></a><span id="l2.1951"> </span>
<a href="#l2.1952"></a><span id="l2.1952">     cancelInfoEntry *cancelInfo = (cancelInfoEntry*) data;</span>
<a href="#l2.1953"></a><span id="l2.1953"> </span>
<a href="#l2.1954"></a><span id="l2.1954" class="difflineat">@@ -3603,17 +3582,17 @@ bool nsNNTPProtocol::CheckIfAuthor(nsISu</span>
<a href="#l2.1955"></a><span id="l2.1955">         return true;</span>
<a href="#l2.1956"></a><span id="l2.1956">     }</span>
<a href="#l2.1957"></a><span id="l2.1957">     else {</span>
<a href="#l2.1958"></a><span id="l2.1958">       // we have a match, stop.</span>
<a href="#l2.1959"></a><span id="l2.1959">         return false;</span>
<a href="#l2.1960"></a><span id="l2.1960">     }</span>
<a href="#l2.1961"></a><span id="l2.1961"> }</span>
<a href="#l2.1962"></a><span id="l2.1962"> </span>
<a href="#l2.1963"></a><span id="l2.1963" class="difflineminus">-int32_t nsNNTPProtocol::DoCancel()</span>
<a href="#l2.1964"></a><span id="l2.1964" class="difflineplus">+nsresult nsNNTPProtocol::DoCancel()</span>
<a href="#l2.1965"></a><span id="l2.1965"> {</span>
<a href="#l2.1966"></a><span id="l2.1966">     int32_t status = 0;</span>
<a href="#l2.1967"></a><span id="l2.1967">     bool failure = false;</span>
<a href="#l2.1968"></a><span id="l2.1968">     nsresult rv = NS_OK;</span>
<a href="#l2.1969"></a><span id="l2.1969">     char *id = nullptr;</span>
<a href="#l2.1970"></a><span id="l2.1970">     char *subject = nullptr;</span>
<a href="#l2.1971"></a><span id="l2.1971">     char *newsgroups = nullptr;</span>
<a href="#l2.1972"></a><span id="l2.1972">     char *distribution = nullptr;</span>
<a href="#l2.1973"></a><span id="l2.1973" class="difflineat">@@ -3666,17 +3645,17 @@ int32_t nsNNTPProtocol::DoCancel()</span>
<a href="#l2.1974"></a><span id="l2.1974">   if (m_runningURL)</span>
<a href="#l2.1975"></a><span id="l2.1975">   {</span>
<a href="#l2.1976"></a><span id="l2.1976">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgUrl (do_QueryInterface(m_runningURL));</span>
<a href="#l2.1977"></a><span id="l2.1977">     rv = GetPromptDialogFromUrl(msgUrl, getter_AddRefs(dialog));</span>
<a href="#l2.1978"></a><span id="l2.1978">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.1979"></a><span id="l2.1979">   }</span>
<a href="#l2.1980"></a><span id="l2.1980"> </span>
<a href="#l2.1981"></a><span id="l2.1981">   NS_ASSERTION (id &amp;&amp; newsgroups, &quot;null ptr&quot;);</span>
<a href="#l2.1982"></a><span id="l2.1982" class="difflineminus">-  if (!id || !newsgroups) return -1; /* &quot;unknown error&quot;... */</span>
<a href="#l2.1983"></a><span id="l2.1983" class="difflineplus">+  if (!id || !newsgroups) return NS_ERROR_FAILURE;</span>
<a href="#l2.1984"></a><span id="l2.1984"> </span>
<a href="#l2.1985"></a><span id="l2.1985">   m_cancelNewsgroups = nullptr;</span>
<a href="#l2.1986"></a><span id="l2.1986">   m_cancelDistribution = nullptr;</span>
<a href="#l2.1987"></a><span id="l2.1987">   m_cancelFromHdr = nullptr;</span>
<a href="#l2.1988"></a><span id="l2.1988">   m_cancelID = nullptr;</span>
<a href="#l2.1989"></a><span id="l2.1989"> </span>
<a href="#l2.1990"></a><span id="l2.1990">   L = PL_strlen (id);</span>
<a href="#l2.1991"></a><span id="l2.1991"> </span>
<a href="#l2.1992"></a><span id="l2.1992" class="difflineat">@@ -3703,17 +3682,17 @@ int32_t nsNNTPProtocol::DoCancel()</span>
<a href="#l2.1993"></a><span id="l2.1993">     NNTP_LOG_NOTE(&quot;CANCELCHK not supported&quot;);</span>
<a href="#l2.1994"></a><span id="l2.1994"> </span>
<a href="#l2.1995"></a><span id="l2.1995">       // get the current identity from the news session....</span>
<a href="#l2.1996"></a><span id="l2.1996">       nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l2.1997"></a><span id="l2.1997">                do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l2.1998"></a><span id="l2.1998">       if (NS_SUCCEEDED(rv) &amp;&amp; accountManager) {</span>
<a href="#l2.1999"></a><span id="l2.1999">           nsCOMPtr&lt;nsISupportsArray&gt; identities;</span>
<a href="#l2.2000"></a><span id="l2.2000">           rv = accountManager-&gt;GetAllIdentities(getter_AddRefs(identities));</span>
<a href="#l2.2001"></a><span id="l2.2001" class="difflineminus">-          if (NS_FAILED(rv)) return -1;</span>
<a href="#l2.2002"></a><span id="l2.2002" class="difflineplus">+          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.2003"></a><span id="l2.2003"> </span>
<a href="#l2.2004"></a><span id="l2.2004">           // CheckIfAuthor will set cancelInfo.from if a match is found</span>
<a href="#l2.2005"></a><span id="l2.2005">           identities-&gt;EnumerateForwards(CheckIfAuthor, (void *)&amp;cancelInfo);</span>
<a href="#l2.2006"></a><span id="l2.2006">       }</span>
<a href="#l2.2007"></a><span id="l2.2007"> </span>
<a href="#l2.2008"></a><span id="l2.2008">       if (cancelInfo.from.IsEmpty()) {</span>
<a href="#l2.2009"></a><span id="l2.2009">           GetNewsStringByName(&quot;cancelDisallowed&quot;, getter_Copies(alertText));</span>
<a href="#l2.2010"></a><span id="l2.2010">           rv = dialog-&gt;Alert(nullptr, alertText.get());</span>
<a href="#l2.2011"></a><span id="l2.2011" class="difflineat">@@ -3792,19 +3771,19 @@ reported here */</span>
<a href="#l2.2012"></a><span id="l2.2012">                        &quot;References: %s&quot; CRLF</span>
<a href="#l2.2013"></a><span id="l2.2013">                        &quot;%s&quot; /* otherHeaders, already with CRLF */</span>
<a href="#l2.2014"></a><span id="l2.2014">                        CRLF /* body separator */</span>
<a href="#l2.2015"></a><span id="l2.2015">                        &quot;%s&quot; /* body, already with CRLF */</span>
<a href="#l2.2016"></a><span id="l2.2016">                        &quot;.&quot; CRLF, /* trailing message terminator &quot;.&quot; */</span>
<a href="#l2.2017"></a><span id="l2.2017">                        cancelInfo.from.get(), newsgroups, subject, id,</span>
<a href="#l2.2018"></a><span id="l2.2018">                        otherHeaders.get(), body);</span>
<a href="#l2.2019"></a><span id="l2.2019"> </span>
<a href="#l2.2020"></a><span id="l2.2020" class="difflineminus">-    status = SendData(data);</span>
<a href="#l2.2021"></a><span id="l2.2021" class="difflineplus">+    rv = SendData(data);</span>
<a href="#l2.2022"></a><span id="l2.2022">     PR_Free (data);</span>
<a href="#l2.2023"></a><span id="l2.2023" class="difflineminus">-    if (status &lt; 0) {</span>
<a href="#l2.2024"></a><span id="l2.2024" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l2.2025"></a><span id="l2.2025">       nsAutoCString errorText;</span>
<a href="#l2.2026"></a><span id="l2.2026">       errorText.AppendInt(status);</span>
<a href="#l2.2027"></a><span id="l2.2027">       AlertError(MK_TCP_WRITE_ERROR, errorText.get());</span>
<a href="#l2.2028"></a><span id="l2.2028">       failure = true;</span>
<a href="#l2.2029"></a><span id="l2.2029">       goto FAIL;</span>
<a href="#l2.2030"></a><span id="l2.2030">     }</span>
<a href="#l2.2031"></a><span id="l2.2031"> </span>
<a href="#l2.2032"></a><span id="l2.2032">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.2033"></a><span id="l2.2033" class="difflineat">@@ -3814,17 +3793,17 @@ reported here */</span>
<a href="#l2.2034"></a><span id="l2.2034">     // QA needs to be able to turn this alert off, for the automate tests.  see bug #31057</span>
<a href="#l2.2035"></a><span id="l2.2035">     rv = prefBranch-&gt;GetBoolPref(PREF_NEWS_CANCEL_ALERT_ON_SUCCESS, &amp;showAlertAfterCancel);</span>
<a href="#l2.2036"></a><span id="l2.2036">     if (NS_FAILED(rv) || showAlertAfterCancel) {</span>
<a href="#l2.2037"></a><span id="l2.2037">       GetNewsStringByName(&quot;messageCancelled&quot;, getter_Copies(alertText));</span>
<a href="#l2.2038"></a><span id="l2.2038">       rv = dialog-&gt;Alert(nullptr, alertText.get());</span>
<a href="#l2.2039"></a><span id="l2.2039">       // XXX:  todo, check rv?</span>
<a href="#l2.2040"></a><span id="l2.2040">     }</span>
<a href="#l2.2041"></a><span id="l2.2041"> </span>
<a href="#l2.2042"></a><span id="l2.2042" class="difflineminus">-    if (!m_runningURL) return -1;</span>
<a href="#l2.2043"></a><span id="l2.2043" class="difflineplus">+    if (!m_runningURL) return NS_ERROR_FAILURE;</span>
<a href="#l2.2044"></a><span id="l2.2044"> </span>
<a href="#l2.2045"></a><span id="l2.2045">     // delete the message from the db here.</span>
<a href="#l2.2046"></a><span id="l2.2046">     NS_ASSERTION(NS_SUCCEEDED(rv) &amp;&amp; m_newsFolder &amp;&amp; (m_key != nsMsgKey_None), &quot;need more to remove this message from the db&quot;);</span>
<a href="#l2.2047"></a><span id="l2.2047">     if ((m_key != nsMsgKey_None) &amp;&amp; (m_newsFolder))</span>
<a href="#l2.2048"></a><span id="l2.2048">        rv = m_newsFolder-&gt;RemoveMessage(m_key);</span>
<a href="#l2.2049"></a><span id="l2.2049"> </span>
<a href="#l2.2050"></a><span id="l2.2050">   }</span>
<a href="#l2.2051"></a><span id="l2.2051"> </span>
<a href="#l2.2052"></a><span id="l2.2052" class="difflineat">@@ -3835,22 +3814,22 @@ FAIL:</span>
<a href="#l2.2053"></a><span id="l2.2053">                      : m_newsFolder-&gt;CancelComplete();</span>
<a href="#l2.2054"></a><span id="l2.2054"> </span>
<a href="#l2.2055"></a><span id="l2.2055">   PR_Free (id);</span>
<a href="#l2.2056"></a><span id="l2.2056">   PR_Free (subject);</span>
<a href="#l2.2057"></a><span id="l2.2057">   PR_Free (newsgroups);</span>
<a href="#l2.2058"></a><span id="l2.2058">   PR_Free (distribution);</span>
<a href="#l2.2059"></a><span id="l2.2059">   PR_Free (body);</span>
<a href="#l2.2060"></a><span id="l2.2060"> </span>
<a href="#l2.2061"></a><span id="l2.2061" class="difflineminus">-  return status;</span>
<a href="#l2.2062"></a><span id="l2.2062" class="difflineplus">+  return rv;</span>
<a href="#l2.2063"></a><span id="l2.2063"> }</span>
<a href="#l2.2064"></a><span id="l2.2064"> </span>
<a href="#l2.2065"></a><span id="l2.2065" class="difflineminus">-int32_t nsNNTPProtocol::XPATSend()</span>
<a href="#l2.2066"></a><span id="l2.2066" class="difflineplus">+nsresult nsNNTPProtocol::XPATSend()</span>
<a href="#l2.2067"></a><span id="l2.2067"> {</span>
<a href="#l2.2068"></a><span id="l2.2068" class="difflineminus">-  int status = 0;</span>
<a href="#l2.2069"></a><span id="l2.2069" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l2.2070"></a><span id="l2.2070">   int32_t slash = m_searchData.FindChar('/');</span>
<a href="#l2.2071"></a><span id="l2.2071"> </span>
<a href="#l2.2072"></a><span id="l2.2072">   if (slash &gt;= 0)</span>
<a href="#l2.2073"></a><span id="l2.2073">   {</span>
<a href="#l2.2074"></a><span id="l2.2074">     /* extract the XPAT encoding for one query term */</span>
<a href="#l2.2075"></a><span id="l2.2075">     /* char *next_search = NULL; */</span>
<a href="#l2.2076"></a><span id="l2.2076">     char *command = NULL;</span>
<a href="#l2.2077"></a><span id="l2.2077">     char *unescapedCommand = NULL;</span>
<a href="#l2.2078"></a><span id="l2.2078" class="difflineat">@@ -3859,54 +3838,54 @@ int32_t nsNNTPProtocol::XPATSend()</span>
<a href="#l2.2079"></a><span id="l2.2079">     endOfTerm = PL_strchr(command, '/');</span>
<a href="#l2.2080"></a><span id="l2.2080">     if (endOfTerm)</span>
<a href="#l2.2081"></a><span id="l2.2081">       *endOfTerm = '\0';</span>
<a href="#l2.2082"></a><span id="l2.2082">     NS_MsgSACat(&amp;command, CRLF);</span>
<a href="#l2.2083"></a><span id="l2.2083"> </span>
<a href="#l2.2084"></a><span id="l2.2084">     unescapedCommand = MSG_UnEscapeSearchUrl(command);</span>
<a href="#l2.2085"></a><span id="l2.2085"> </span>
<a href="#l2.2086"></a><span id="l2.2086">     /* send one term off to the server */</span>
<a href="#l2.2087"></a><span id="l2.2087" class="difflineminus">-    status = SendData(unescapedCommand);</span>
<a href="#l2.2088"></a><span id="l2.2088" class="difflineplus">+    rv = SendData(unescapedCommand);</span>
<a href="#l2.2089"></a><span id="l2.2089"> </span>
<a href="#l2.2090"></a><span id="l2.2090">     m_nextState = NNTP_RESPONSE;</span>
<a href="#l2.2091"></a><span id="l2.2091">     m_nextStateAfterResponse = NNTP_XPAT_RESPONSE;</span>
<a href="#l2.2092"></a><span id="l2.2092">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.2093"></a><span id="l2.2093"> </span>
<a href="#l2.2094"></a><span id="l2.2094">     PR_Free(command);</span>
<a href="#l2.2095"></a><span id="l2.2095">     PR_Free(unescapedCommand);</span>
<a href="#l2.2096"></a><span id="l2.2096">   }</span>
<a href="#l2.2097"></a><span id="l2.2097">   else</span>
<a href="#l2.2098"></a><span id="l2.2098">   {</span>
<a href="#l2.2099"></a><span id="l2.2099">     m_nextState = NEWS_DONE;</span>
<a href="#l2.2100"></a><span id="l2.2100" class="difflineminus">-    status = MK_DATA_LOADED;</span>
<a href="#l2.2101"></a><span id="l2.2101">   }</span>
<a href="#l2.2102"></a><span id="l2.2102" class="difflineminus">-  return status;</span>
<a href="#l2.2103"></a><span id="l2.2103" class="difflineplus">+  return rv;</span>
<a href="#l2.2104"></a><span id="l2.2104"> }</span>
<a href="#l2.2105"></a><span id="l2.2105"> </span>
<a href="#l2.2106"></a><span id="l2.2106" class="difflineminus">-int32_t nsNNTPProtocol::XPATResponse(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l2.2107"></a><span id="l2.2107" class="difflineplus">+nsresult nsNNTPProtocol::XPATResponse(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l2.2108"></a><span id="l2.2108"> {</span>
<a href="#l2.2109"></a><span id="l2.2109">   uint32_t status = 1;</span>
<a href="#l2.2110"></a><span id="l2.2110" class="difflineplus">+  nsresult rv;</span>
<a href="#l2.2111"></a><span id="l2.2111"> </span>
<a href="#l2.2112"></a><span id="l2.2112">   if (m_responseCode != MK_NNTP_RESPONSE_XPAT_OK)</span>
<a href="#l2.2113"></a><span id="l2.2113">   {</span>
<a href="#l2.2114"></a><span id="l2.2114">     AlertError(MK_NNTP_ERROR_MESSAGE,m_responseText);</span>
<a href="#l2.2115"></a><span id="l2.2115">     m_nextState = NNTP_ERROR;</span>
<a href="#l2.2116"></a><span id="l2.2116">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.2117"></a><span id="l2.2117" class="difflineminus">-    return MK_NNTP_SERVER_ERROR;</span>
<a href="#l2.2118"></a><span id="l2.2118" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l2.2119"></a><span id="l2.2119">   }</span>
<a href="#l2.2120"></a><span id="l2.2120"> </span>
<a href="#l2.2121"></a><span id="l2.2121">   bool pauseForMoreData = false;</span>
<a href="#l2.2122"></a><span id="l2.2122" class="difflineminus">-  char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData);</span>
<a href="#l2.2123"></a><span id="l2.2123" class="difflineplus">+  char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData, &amp;rv);</span>
<a href="#l2.2124"></a><span id="l2.2124"> </span>
<a href="#l2.2125"></a><span id="l2.2125">   NNTP_LOG_READ(line);</span>
<a href="#l2.2126"></a><span id="l2.2126"> </span>
<a href="#l2.2127"></a><span id="l2.2127">   if(pauseForMoreData)</span>
<a href="#l2.2128"></a><span id="l2.2128">   {</span>
<a href="#l2.2129"></a><span id="l2.2129">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.2130"></a><span id="l2.2130" class="difflineminus">-    return 0;</span>
<a href="#l2.2131"></a><span id="l2.2131" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.2132"></a><span id="l2.2132">   }</span>
<a href="#l2.2133"></a><span id="l2.2133"> </span>
<a href="#l2.2134"></a><span id="l2.2134">   if (line)</span>
<a href="#l2.2135"></a><span id="l2.2135">   {</span>
<a href="#l2.2136"></a><span id="l2.2136">     if (line[0] != '.')</span>
<a href="#l2.2137"></a><span id="l2.2137">     {</span>
<a href="#l2.2138"></a><span id="l2.2138">       long articleNumber;</span>
<a href="#l2.2139"></a><span id="l2.2139">       PR_sscanf(line, &quot;%ld&quot;, &amp;articleNumber);</span>
<a href="#l2.2140"></a><span id="l2.2140" class="difflineat">@@ -3932,65 +3911,64 @@ int32_t nsNNTPProtocol::XPATResponse(nsI</span>
<a href="#l2.2141"></a><span id="l2.2141">       if (slash &gt;= 0)</span>
<a href="#l2.2142"></a><span id="l2.2142">         m_searchData.Cut(0, slash + 1);</span>
<a href="#l2.2143"></a><span id="l2.2143">       else</span>
<a href="#l2.2144"></a><span id="l2.2144">         m_searchData.Truncate();</span>
<a href="#l2.2145"></a><span id="l2.2145"> </span>
<a href="#l2.2146"></a><span id="l2.2146">       m_nextState = NNTP_XPAT_SEND;</span>
<a href="#l2.2147"></a><span id="l2.2147">       ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.2148"></a><span id="l2.2148">       PR_FREEIF(line);</span>
<a href="#l2.2149"></a><span id="l2.2149" class="difflineminus">-      return 0;</span>
<a href="#l2.2150"></a><span id="l2.2150" class="difflineplus">+      return NS_OK;</span>
<a href="#l2.2151"></a><span id="l2.2151">     }</span>
<a href="#l2.2152"></a><span id="l2.2152">   }</span>
<a href="#l2.2153"></a><span id="l2.2153">   PR_FREEIF(line);</span>
<a href="#l2.2154"></a><span id="l2.2154" class="difflineminus">-  return 0;</span>
<a href="#l2.2155"></a><span id="l2.2155" class="difflineplus">+  return NS_OK;</span>
<a href="#l2.2156"></a><span id="l2.2156"> }</span>
<a href="#l2.2157"></a><span id="l2.2157"> </span>
<a href="#l2.2158"></a><span id="l2.2158" class="difflineminus">-int32_t nsNNTPProtocol::ListPrettyNames()</span>
<a href="#l2.2159"></a><span id="l2.2159" class="difflineplus">+nsresult nsNNTPProtocol::ListPrettyNames()</span>
<a href="#l2.2160"></a><span id="l2.2160"> {</span>
<a href="#l2.2161"></a><span id="l2.2161"> </span>
<a href="#l2.2162"></a><span id="l2.2162">   nsCString group_name;</span>
<a href="#l2.2163"></a><span id="l2.2163">   char outputBuffer[OUTPUT_BUFFER_SIZE];</span>
<a href="#l2.2164"></a><span id="l2.2164" class="difflineminus">-  int32_t status = 0;</span>
<a href="#l2.2165"></a><span id="l2.2165"> </span>
<a href="#l2.2166"></a><span id="l2.2166">   m_newsFolder-&gt;GetRawName(group_name);</span>
<a href="#l2.2167"></a><span id="l2.2167">   PR_snprintf(outputBuffer,</span>
<a href="#l2.2168"></a><span id="l2.2168">     OUTPUT_BUFFER_SIZE,</span>
<a href="#l2.2169"></a><span id="l2.2169">     &quot;LIST PRETTYNAMES %.512s&quot; CRLF,</span>
<a href="#l2.2170"></a><span id="l2.2170">     group_name.get());</span>
<a href="#l2.2171"></a><span id="l2.2171"> </span>
<a href="#l2.2172"></a><span id="l2.2172" class="difflineminus">-  status = SendData(outputBuffer);</span>
<a href="#l2.2173"></a><span id="l2.2173" class="difflineplus">+  nsresult rv = SendData(outputBuffer);</span>
<a href="#l2.2174"></a><span id="l2.2174">   NNTP_LOG_NOTE(outputBuffer);</span>
<a href="#l2.2175"></a><span id="l2.2175">   m_nextState = NNTP_RESPONSE;</span>
<a href="#l2.2176"></a><span id="l2.2176">   m_nextStateAfterResponse = NNTP_LIST_PRETTY_NAMES_RESPONSE;</span>
<a href="#l2.2177"></a><span id="l2.2177"> </span>
<a href="#l2.2178"></a><span id="l2.2178" class="difflineminus">-  return status;</span>
<a href="#l2.2179"></a><span id="l2.2179" class="difflineplus">+  return rv;</span>
<a href="#l2.2180"></a><span id="l2.2180"> }</span>
<a href="#l2.2181"></a><span id="l2.2181"> </span>
<a href="#l2.2182"></a><span id="l2.2182" class="difflineminus">-int32_t nsNNTPProtocol::ListPrettyNamesResponse(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l2.2183"></a><span id="l2.2183" class="difflineplus">+nsresult nsNNTPProtocol::ListPrettyNamesResponse(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l2.2184"></a><span id="l2.2184"> {</span>
<a href="#l2.2185"></a><span id="l2.2185">   uint32_t status = 0;</span>
<a href="#l2.2186"></a><span id="l2.2186"> </span>
<a href="#l2.2187"></a><span id="l2.2187">   if (m_responseCode != MK_NNTP_RESPONSE_LIST_OK)</span>
<a href="#l2.2188"></a><span id="l2.2188">   {</span>
<a href="#l2.2189"></a><span id="l2.2189">     m_nextState = DISPLAY_NEWSGROUPS;</span>
<a href="#l2.2190"></a><span id="l2.2190">     /*    m_nextState = NEWS_DONE; */</span>
<a href="#l2.2191"></a><span id="l2.2191">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.2192"></a><span id="l2.2192" class="difflineminus">-    return 0;</span>
<a href="#l2.2193"></a><span id="l2.2193" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.2194"></a><span id="l2.2194">   }</span>
<a href="#l2.2195"></a><span id="l2.2195"> </span>
<a href="#l2.2196"></a><span id="l2.2196">   bool pauseForMoreData = false;</span>
<a href="#l2.2197"></a><span id="l2.2197">   char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData);</span>
<a href="#l2.2198"></a><span id="l2.2198"> </span>
<a href="#l2.2199"></a><span id="l2.2199">   NNTP_LOG_READ(line);</span>
<a href="#l2.2200"></a><span id="l2.2200"> </span>
<a href="#l2.2201"></a><span id="l2.2201">   if(pauseForMoreData)</span>
<a href="#l2.2202"></a><span id="l2.2202">   {</span>
<a href="#l2.2203"></a><span id="l2.2203">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.2204"></a><span id="l2.2204" class="difflineminus">-    return 0;</span>
<a href="#l2.2205"></a><span id="l2.2205" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.2206"></a><span id="l2.2206">   }</span>
<a href="#l2.2207"></a><span id="l2.2207"> </span>
<a href="#l2.2208"></a><span id="l2.2208">   if (line)</span>
<a href="#l2.2209"></a><span id="l2.2209">   {</span>
<a href="#l2.2210"></a><span id="l2.2210">     if (line[0] != '.')</span>
<a href="#l2.2211"></a><span id="l2.2211">     {</span>
<a href="#l2.2212"></a><span id="l2.2212"> #if 0 // SetPrettyName is not yet implemented. No reason to bother</span>
<a href="#l2.2213"></a><span id="l2.2213">       int i;</span>
<a href="#l2.2214"></a><span id="l2.2214" class="difflineat">@@ -4022,69 +4000,68 @@ int32_t nsNNTPProtocol::ListPrettyNamesR</span>
<a href="#l2.2215"></a><span id="l2.2215"> #endif</span>
<a href="#l2.2216"></a><span id="l2.2216">     }</span>
<a href="#l2.2217"></a><span id="l2.2217">     else</span>
<a href="#l2.2218"></a><span id="l2.2218">     {</span>
<a href="#l2.2219"></a><span id="l2.2219">       m_nextState = DISPLAY_NEWSGROUPS;  /* this assumes we were doing a list */</span>
<a href="#l2.2220"></a><span id="l2.2220">       /*      m_nextState = NEWS_DONE;   */ /* ### dmb - don't really know */</span>
<a href="#l2.2221"></a><span id="l2.2221">       ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.2222"></a><span id="l2.2222">       PR_FREEIF(line);</span>
<a href="#l2.2223"></a><span id="l2.2223" class="difflineminus">-      return 0;</span>
<a href="#l2.2224"></a><span id="l2.2224" class="difflineplus">+      return NS_OK;</span>
<a href="#l2.2225"></a><span id="l2.2225">     }</span>
<a href="#l2.2226"></a><span id="l2.2226">   }</span>
<a href="#l2.2227"></a><span id="l2.2227">   PR_FREEIF(line);</span>
<a href="#l2.2228"></a><span id="l2.2228" class="difflineminus">-  return 0;</span>
<a href="#l2.2229"></a><span id="l2.2229" class="difflineplus">+  return NS_OK;</span>
<a href="#l2.2230"></a><span id="l2.2230"> }</span>
<a href="#l2.2231"></a><span id="l2.2231"> </span>
<a href="#l2.2232"></a><span id="l2.2232" class="difflineminus">-int32_t nsNNTPProtocol::ListXActive()</span>
<a href="#l2.2233"></a><span id="l2.2233" class="difflineplus">+nsresult nsNNTPProtocol::ListXActive()</span>
<a href="#l2.2234"></a><span id="l2.2234"> {</span>
<a href="#l2.2235"></a><span id="l2.2235">   nsCString group_name;</span>
<a href="#l2.2236"></a><span id="l2.2236">   nsresult rv;</span>
<a href="#l2.2237"></a><span id="l2.2237">   rv = m_newsFolder-&gt;GetRawName(group_name);</span>
<a href="#l2.2238"></a><span id="l2.2238" class="difflineminus">-  if (NS_FAILED(rv)) return -1;</span>
<a href="#l2.2239"></a><span id="l2.2239" class="difflineminus">-</span>
<a href="#l2.2240"></a><span id="l2.2240" class="difflineminus">-  int32_t status = 0;</span>
<a href="#l2.2241"></a><span id="l2.2241" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.2242"></a><span id="l2.2242" class="difflineplus">+</span>
<a href="#l2.2243"></a><span id="l2.2243">   char outputBuffer[OUTPUT_BUFFER_SIZE];</span>
<a href="#l2.2244"></a><span id="l2.2244"> </span>
<a href="#l2.2245"></a><span id="l2.2245">   PR_snprintf(outputBuffer,</span>
<a href="#l2.2246"></a><span id="l2.2246">     OUTPUT_BUFFER_SIZE,</span>
<a href="#l2.2247"></a><span id="l2.2247">     &quot;LIST XACTIVE %.512s&quot; CRLF,</span>
<a href="#l2.2248"></a><span id="l2.2248">     group_name.get());</span>
<a href="#l2.2249"></a><span id="l2.2249"> </span>
<a href="#l2.2250"></a><span id="l2.2250" class="difflineminus">-  status = SendData(outputBuffer);</span>
<a href="#l2.2251"></a><span id="l2.2251" class="difflineplus">+  rv = SendData(outputBuffer);</span>
<a href="#l2.2252"></a><span id="l2.2252"> </span>
<a href="#l2.2253"></a><span id="l2.2253">   m_nextState = NNTP_RESPONSE;</span>
<a href="#l2.2254"></a><span id="l2.2254">   m_nextStateAfterResponse = NNTP_LIST_XACTIVE_RESPONSE;</span>
<a href="#l2.2255"></a><span id="l2.2255"> </span>
<a href="#l2.2256"></a><span id="l2.2256" class="difflineminus">-  return status;</span>
<a href="#l2.2257"></a><span id="l2.2257" class="difflineplus">+  return rv;</span>
<a href="#l2.2258"></a><span id="l2.2258"> }</span>
<a href="#l2.2259"></a><span id="l2.2259"> </span>
<a href="#l2.2260"></a><span id="l2.2260" class="difflineminus">-int32_t nsNNTPProtocol::ListXActiveResponse(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l2.2261"></a><span id="l2.2261" class="difflineplus">+nsresult nsNNTPProtocol::ListXActiveResponse(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l2.2262"></a><span id="l2.2262"> {</span>
<a href="#l2.2263"></a><span id="l2.2263">   uint32_t status = 0;</span>
<a href="#l2.2264"></a><span id="l2.2264">   nsresult rv;</span>
<a href="#l2.2265"></a><span id="l2.2265"> </span>
<a href="#l2.2266"></a><span id="l2.2266">   NS_ASSERTION(m_responseCode == MK_NNTP_RESPONSE_LIST_OK, &quot;code != LIST_OK&quot;);</span>
<a href="#l2.2267"></a><span id="l2.2267">   if (m_responseCode != MK_NNTP_RESPONSE_LIST_OK)</span>
<a href="#l2.2268"></a><span id="l2.2268">   {</span>
<a href="#l2.2269"></a><span id="l2.2269">     m_nextState = DISPLAY_NEWSGROUPS;</span>
<a href="#l2.2270"></a><span id="l2.2270">     /*    m_nextState = NEWS_DONE; */</span>
<a href="#l2.2271"></a><span id="l2.2271">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.2272"></a><span id="l2.2272" class="difflineminus">-    return MK_DATA_LOADED;</span>
<a href="#l2.2273"></a><span id="l2.2273" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.2274"></a><span id="l2.2274">   }</span>
<a href="#l2.2275"></a><span id="l2.2275"> </span>
<a href="#l2.2276"></a><span id="l2.2276">   bool pauseForMoreData = false;</span>
<a href="#l2.2277"></a><span id="l2.2277">   char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData);</span>
<a href="#l2.2278"></a><span id="l2.2278"> </span>
<a href="#l2.2279"></a><span id="l2.2279">   NNTP_LOG_READ(line);</span>
<a href="#l2.2280"></a><span id="l2.2280"> </span>
<a href="#l2.2281"></a><span id="l2.2281">   if(pauseForMoreData)</span>
<a href="#l2.2282"></a><span id="l2.2282">   {</span>
<a href="#l2.2283"></a><span id="l2.2283">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.2284"></a><span id="l2.2284" class="difflineminus">-    return 0;</span>
<a href="#l2.2285"></a><span id="l2.2285" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.2286"></a><span id="l2.2286">   }</span>
<a href="#l2.2287"></a><span id="l2.2287"> </span>
<a href="#l2.2288"></a><span id="l2.2288">    /* almost correct */</span>
<a href="#l2.2289"></a><span id="l2.2289">   if(status &gt; 1)</span>
<a href="#l2.2290"></a><span id="l2.2290">   {</span>
<a href="#l2.2291"></a><span id="l2.2291"> #ifdef UNREADY_CODE</span>
<a href="#l2.2292"></a><span id="l2.2292">     ce-&gt;bytes_received += status;</span>
<a href="#l2.2293"></a><span id="l2.2293">     FE_GraphProgress(ce-&gt;window_id, ce-&gt;URL_s, ce-&gt;bytes_received, status, ce-&gt;URL_s-&gt;content_length);</span>
<a href="#l2.2294"></a><span id="l2.2294" class="difflineat">@@ -4138,105 +4115,104 @@ int32_t nsNNTPProtocol::ListXActiveRespo</span>
<a href="#l2.2295"></a><span id="l2.2295">       if (m_typeWanted == NEW_GROUPS &amp;&amp;</span>
<a href="#l2.2296"></a><span id="l2.2296">         NS_SUCCEEDED(rv) &amp;&amp; xactive)</span>
<a href="#l2.2297"></a><span id="l2.2297">       {</span>
<a href="#l2.2298"></a><span id="l2.2298">         nsCOMPtr &lt;nsIMsgNewsFolder&gt; old_newsFolder;</span>
<a href="#l2.2299"></a><span id="l2.2299">         old_newsFolder = m_newsFolder;</span>
<a href="#l2.2300"></a><span id="l2.2300">         nsCString groupName;</span>
<a href="#l2.2301"></a><span id="l2.2301"> </span>
<a href="#l2.2302"></a><span id="l2.2302">         rv = m_nntpServer-&gt;GetFirstGroupNeedingExtraInfo(groupName);</span>
<a href="#l2.2303"></a><span id="l2.2303" class="difflineminus">-        if (NS_FAILED(rv)) return -1;</span>
<a href="#l2.2304"></a><span id="l2.2304" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.2305"></a><span id="l2.2305">         rv = m_nntpServer-&gt;FindGroup(groupName,</span>
<a href="#l2.2306"></a><span id="l2.2306">                                      getter_AddRefs(m_newsFolder));</span>
<a href="#l2.2307"></a><span id="l2.2307" class="difflineminus">-        if (NS_FAILED(rv)) return -1;</span>
<a href="#l2.2308"></a><span id="l2.2308" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.2309"></a><span id="l2.2309"> </span>
<a href="#l2.2310"></a><span id="l2.2310">         // see if we got a different group</span>
<a href="#l2.2311"></a><span id="l2.2311">         if (old_newsFolder &amp;&amp; m_newsFolder &amp;&amp;</span>
<a href="#l2.2312"></a><span id="l2.2312">           (old_newsFolder.get() != m_newsFolder.get()))</span>
<a href="#l2.2313"></a><span id="l2.2313">           /* make sure we're not stuck on the same group */</span>
<a href="#l2.2314"></a><span id="l2.2314">         {</span>
<a href="#l2.2315"></a><span id="l2.2315">           PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;(%p) listing xactive for %s&quot;, this, groupName.get()));</span>
<a href="#l2.2316"></a><span id="l2.2316">           m_nextState = NNTP_LIST_XACTIVE;</span>
<a href="#l2.2317"></a><span id="l2.2317">           ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.2318"></a><span id="l2.2318">           PR_FREEIF(line);</span>
<a href="#l2.2319"></a><span id="l2.2319" class="difflineminus">-          return 0;</span>
<a href="#l2.2320"></a><span id="l2.2320" class="difflineplus">+          return NS_OK;</span>
<a href="#l2.2321"></a><span id="l2.2321">         }</span>
<a href="#l2.2322"></a><span id="l2.2322">         else</span>
<a href="#l2.2323"></a><span id="l2.2323">         {</span>
<a href="#l2.2324"></a><span id="l2.2324">           m_newsFolder = nullptr;</span>
<a href="#l2.2325"></a><span id="l2.2325">         }</span>
<a href="#l2.2326"></a><span id="l2.2326">       }</span>
<a href="#l2.2327"></a><span id="l2.2327">       bool listpname;</span>
<a href="#l2.2328"></a><span id="l2.2328">       rv = m_nntpServer-&gt;QueryExtension(&quot;LISTPNAME&quot;,&amp;listpname);</span>
<a href="#l2.2329"></a><span id="l2.2329">       if (NS_SUCCEEDED(rv) &amp;&amp; listpname)</span>
<a href="#l2.2330"></a><span id="l2.2330">         m_nextState = NNTP_LIST_PRETTY_NAMES;</span>
<a href="#l2.2331"></a><span id="l2.2331">       else</span>
<a href="#l2.2332"></a><span id="l2.2332">         m_nextState = DISPLAY_NEWSGROUPS;  /* this assumes we were doing a list - who knows? */</span>
<a href="#l2.2333"></a><span id="l2.2333">       /*      m_nextState = NEWS_DONE;   */ /* ### dmb - don't really know */</span>
<a href="#l2.2334"></a><span id="l2.2334">       ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.2335"></a><span id="l2.2335">       PR_FREEIF(line);</span>
<a href="#l2.2336"></a><span id="l2.2336" class="difflineminus">-      return 0;</span>
<a href="#l2.2337"></a><span id="l2.2337" class="difflineplus">+      return NS_OK;</span>
<a href="#l2.2338"></a><span id="l2.2338">     }</span>
<a href="#l2.2339"></a><span id="l2.2339">   }</span>
<a href="#l2.2340"></a><span id="l2.2340">   PR_FREEIF(line);</span>
<a href="#l2.2341"></a><span id="l2.2341" class="difflineminus">-  return 0;</span>
<a href="#l2.2342"></a><span id="l2.2342" class="difflineplus">+  return NS_OK;</span>
<a href="#l2.2343"></a><span id="l2.2343"> }</span>
<a href="#l2.2344"></a><span id="l2.2344"> </span>
<a href="#l2.2345"></a><span id="l2.2345" class="difflineminus">-int32_t nsNNTPProtocol::SendListGroup()</span>
<a href="#l2.2346"></a><span id="l2.2346" class="difflineplus">+nsresult nsNNTPProtocol::SendListGroup()</span>
<a href="#l2.2347"></a><span id="l2.2347"> {</span>
<a href="#l2.2348"></a><span id="l2.2348">   nsresult rv;</span>
<a href="#l2.2349"></a><span id="l2.2349">   char outputBuffer[OUTPUT_BUFFER_SIZE];</span>
<a href="#l2.2350"></a><span id="l2.2350" class="difflineminus">-  int32_t status = 0;</span>
<a href="#l2.2351"></a><span id="l2.2351"> </span>
<a href="#l2.2352"></a><span id="l2.2352">   NS_ASSERTION(m_newsFolder,&quot;no newsFolder&quot;);</span>
<a href="#l2.2353"></a><span id="l2.2353" class="difflineminus">-  if (!m_newsFolder) return -1;</span>
<a href="#l2.2354"></a><span id="l2.2354" class="difflineplus">+  if (!m_newsFolder) return NS_ERROR_FAILURE;</span>
<a href="#l2.2355"></a><span id="l2.2355">   nsCString newsgroupName;</span>
<a href="#l2.2356"></a><span id="l2.2356"> </span>
<a href="#l2.2357"></a><span id="l2.2357">   rv = m_newsFolder-&gt;GetRawName(newsgroupName);</span>
<a href="#l2.2358"></a><span id="l2.2358">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l2.2359"></a><span id="l2.2359"> </span>
<a href="#l2.2360"></a><span id="l2.2360">   PR_snprintf(outputBuffer,</span>
<a href="#l2.2361"></a><span id="l2.2361">     OUTPUT_BUFFER_SIZE,</span>
<a href="#l2.2362"></a><span id="l2.2362">     &quot;listgroup %.512s&quot; CRLF,</span>
<a href="#l2.2363"></a><span id="l2.2363">     newsgroupName.get());</span>
<a href="#l2.2364"></a><span id="l2.2364"> </span>
<a href="#l2.2365"></a><span id="l2.2365">   m_articleList = do_CreateInstance(NS_NNTPARTICLELIST_CONTRACTID, &amp;rv);</span>
<a href="#l2.2366"></a><span id="l2.2366">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l2.2367"></a><span id="l2.2367"> </span>
<a href="#l2.2368"></a><span id="l2.2368">   rv = m_articleList-&gt;Initialize(m_newsFolder);</span>
<a href="#l2.2369"></a><span id="l2.2369">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l2.2370"></a><span id="l2.2370"> </span>
<a href="#l2.2371"></a><span id="l2.2371" class="difflineminus">-  status = SendData(outputBuffer);</span>
<a href="#l2.2372"></a><span id="l2.2372" class="difflineplus">+  rv = SendData(outputBuffer);</span>
<a href="#l2.2373"></a><span id="l2.2373"> </span>
<a href="#l2.2374"></a><span id="l2.2374">   m_nextState = NNTP_RESPONSE;</span>
<a href="#l2.2375"></a><span id="l2.2375">   m_nextStateAfterResponse = NNTP_LIST_GROUP_RESPONSE;</span>
<a href="#l2.2376"></a><span id="l2.2376">   SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.2377"></a><span id="l2.2377"> </span>
<a href="#l2.2378"></a><span id="l2.2378" class="difflineminus">-  return status;</span>
<a href="#l2.2379"></a><span id="l2.2379" class="difflineplus">+  return rv;</span>
<a href="#l2.2380"></a><span id="l2.2380"> }</span>
<a href="#l2.2381"></a><span id="l2.2381"> </span>
<a href="#l2.2382"></a><span id="l2.2382" class="difflineminus">-int32_t nsNNTPProtocol::SendListGroupResponse(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l2.2383"></a><span id="l2.2383" class="difflineplus">+nsresult nsNNTPProtocol::SendListGroupResponse(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l2.2384"></a><span id="l2.2384"> {</span>
<a href="#l2.2385"></a><span id="l2.2385">   uint32_t status = 0;</span>
<a href="#l2.2386"></a><span id="l2.2386"> </span>
<a href="#l2.2387"></a><span id="l2.2387">   NS_ASSERTION(m_responseCode == MK_NNTP_RESPONSE_GROUP_SELECTED, &quot;code != GROUP_SELECTED&quot;);</span>
<a href="#l2.2388"></a><span id="l2.2388">   if (m_responseCode != MK_NNTP_RESPONSE_GROUP_SELECTED)</span>
<a href="#l2.2389"></a><span id="l2.2389">   {</span>
<a href="#l2.2390"></a><span id="l2.2390">     m_nextState = NEWS_DONE;</span>
<a href="#l2.2391"></a><span id="l2.2391">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.2392"></a><span id="l2.2392" class="difflineminus">-    return MK_DATA_LOADED;</span>
<a href="#l2.2393"></a><span id="l2.2393" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.2394"></a><span id="l2.2394">   }</span>
<a href="#l2.2395"></a><span id="l2.2395"> </span>
<a href="#l2.2396"></a><span id="l2.2396">   bool pauseForMoreData = false;</span>
<a href="#l2.2397"></a><span id="l2.2397">   char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData);</span>
<a href="#l2.2398"></a><span id="l2.2398"> </span>
<a href="#l2.2399"></a><span id="l2.2399">   if(pauseForMoreData)</span>
<a href="#l2.2400"></a><span id="l2.2400">   {</span>
<a href="#l2.2401"></a><span id="l2.2401">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.2402"></a><span id="l2.2402" class="difflineminus">-    return 0;</span>
<a href="#l2.2403"></a><span id="l2.2403" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.2404"></a><span id="l2.2404">   }</span>
<a href="#l2.2405"></a><span id="l2.2405"> </span>
<a href="#l2.2406"></a><span id="l2.2406">   if (line)</span>
<a href="#l2.2407"></a><span id="l2.2407">   {</span>
<a href="#l2.2408"></a><span id="l2.2408">     nsresult rv;</span>
<a href="#l2.2409"></a><span id="l2.2409">     if (line[0] != '.')</span>
<a href="#l2.2410"></a><span id="l2.2410">     {</span>
<a href="#l2.2411"></a><span id="l2.2411">       nsMsgKey found_id = nsMsgKey_None;</span>
<a href="#l2.2412"></a><span id="l2.2412" class="difflineat">@@ -4247,73 +4223,74 @@ int32_t nsNNTPProtocol::SendListGroupRes</span>
<a href="#l2.2413"></a><span id="l2.2413">     else</span>
<a href="#l2.2414"></a><span id="l2.2414">     {</span>
<a href="#l2.2415"></a><span id="l2.2415">       rv = m_articleList-&gt;FinishAddingArticleKeys();</span>
<a href="#l2.2416"></a><span id="l2.2416">       NS_ASSERTION(NS_SUCCEEDED(rv), &quot;finish adding article key failed&quot;);</span>
<a href="#l2.2417"></a><span id="l2.2417">       m_articleList = nullptr;</span>
<a href="#l2.2418"></a><span id="l2.2418">       m_nextState = NEWS_DONE;   /* ### dmb - don't really know */</span>
<a href="#l2.2419"></a><span id="l2.2419">       ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.2420"></a><span id="l2.2420">       PR_FREEIF(line);</span>
<a href="#l2.2421"></a><span id="l2.2421" class="difflineminus">-      return 0;</span>
<a href="#l2.2422"></a><span id="l2.2422" class="difflineplus">+      return NS_OK;</span>
<a href="#l2.2423"></a><span id="l2.2423">     }</span>
<a href="#l2.2424"></a><span id="l2.2424">   }</span>
<a href="#l2.2425"></a><span id="l2.2425">   PR_FREEIF(line);</span>
<a href="#l2.2426"></a><span id="l2.2426" class="difflineminus">-  return 0;</span>
<a href="#l2.2427"></a><span id="l2.2427" class="difflineplus">+  return NS_OK;</span>
<a href="#l2.2428"></a><span id="l2.2428"> }</span>
<a href="#l2.2429"></a><span id="l2.2429"> </span>
<a href="#l2.2430"></a><span id="l2.2430"> </span>
<a href="#l2.2431"></a><span id="l2.2431" class="difflineminus">-int32_t nsNNTPProtocol::Search()</span>
<a href="#l2.2432"></a><span id="l2.2432" class="difflineplus">+nsresult nsNNTPProtocol::Search()</span>
<a href="#l2.2433"></a><span id="l2.2433"> {</span>
<a href="#l2.2434"></a><span id="l2.2434">   NS_ERROR(&quot;Search not implemented&quot;);</span>
<a href="#l2.2435"></a><span id="l2.2435" class="difflineminus">-  return 0;</span>
<a href="#l2.2436"></a><span id="l2.2436" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l2.2437"></a><span id="l2.2437"> }</span>
<a href="#l2.2438"></a><span id="l2.2438"> </span>
<a href="#l2.2439"></a><span id="l2.2439" class="difflineminus">-int32_t nsNNTPProtocol::SearchResponse()</span>
<a href="#l2.2440"></a><span id="l2.2440" class="difflineplus">+nsresult nsNNTPProtocol::SearchResponse()</span>
<a href="#l2.2441"></a><span id="l2.2441"> {</span>
<a href="#l2.2442"></a><span id="l2.2442">   if (MK_NNTP_RESPONSE_TYPE(m_responseCode) == MK_NNTP_RESPONSE_TYPE_OK)</span>
<a href="#l2.2443"></a><span id="l2.2443">     m_nextState = NNTP_SEARCH_RESULTS;</span>
<a href="#l2.2444"></a><span id="l2.2444">   else</span>
<a href="#l2.2445"></a><span id="l2.2445">     m_nextState = NEWS_DONE;</span>
<a href="#l2.2446"></a><span id="l2.2446">   ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.2447"></a><span id="l2.2447" class="difflineminus">-  return 0;</span>
<a href="#l2.2448"></a><span id="l2.2448" class="difflineplus">+  return NS_OK;</span>
<a href="#l2.2449"></a><span id="l2.2449"> }</span>
<a href="#l2.2450"></a><span id="l2.2450"> </span>
<a href="#l2.2451"></a><span id="l2.2451" class="difflineminus">-int32_t nsNNTPProtocol::SearchResults(nsIInputStream *inputStream, uint32_t length)</span>
<a href="#l2.2452"></a><span id="l2.2452" class="difflineplus">+nsresult nsNNTPProtocol::SearchResults(nsIInputStream *inputStream, uint32_t length)</span>
<a href="#l2.2453"></a><span id="l2.2453"> {</span>
<a href="#l2.2454"></a><span id="l2.2454">   uint32_t status = 1;</span>
<a href="#l2.2455"></a><span id="l2.2455" class="difflineplus">+  nsresult rv;</span>
<a href="#l2.2456"></a><span id="l2.2456"> </span>
<a href="#l2.2457"></a><span id="l2.2457">   bool pauseForMoreData = false;</span>
<a href="#l2.2458"></a><span id="l2.2458" class="difflineminus">-  char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData);</span>
<a href="#l2.2459"></a><span id="l2.2459" class="difflineplus">+  char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData, &amp;rv);</span>
<a href="#l2.2460"></a><span id="l2.2460"> </span>
<a href="#l2.2461"></a><span id="l2.2461">   if(pauseForMoreData)</span>
<a href="#l2.2462"></a><span id="l2.2462">   {</span>
<a href="#l2.2463"></a><span id="l2.2463">     SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.2464"></a><span id="l2.2464" class="difflineminus">-    return 0;</span>
<a href="#l2.2465"></a><span id="l2.2465" class="difflineplus">+    return NS_OK;</span>
<a href="#l2.2466"></a><span id="l2.2466">   }</span>
<a href="#l2.2467"></a><span id="l2.2467">   if (!line)</span>
<a href="#l2.2468"></a><span id="l2.2468" class="difflineminus">-    return status;  /* no line yet */</span>
<a href="#l2.2469"></a><span id="l2.2469" class="difflineplus">+    return rv;  /* no line yet */</span>
<a href="#l2.2470"></a><span id="l2.2470"> </span>
<a href="#l2.2471"></a><span id="l2.2471">   if ('.' != line[0])</span>
<a href="#l2.2472"></a><span id="l2.2472">   {</span>
<a href="#l2.2473"></a><span id="l2.2473"> #ifdef UNREADY_CODE</span>
<a href="#l2.2474"></a><span id="l2.2474">     MSG_AddNewsSearchHit (ce-&gt;window_id, line);</span>
<a href="#l2.2475"></a><span id="l2.2475"> #endif</span>
<a href="#l2.2476"></a><span id="l2.2476">   }</span>
<a href="#l2.2477"></a><span id="l2.2477">   else</span>
<a href="#l2.2478"></a><span id="l2.2478">   {</span>
<a href="#l2.2479"></a><span id="l2.2479">     /* all overview lines received */</span>
<a href="#l2.2480"></a><span id="l2.2480">     m_nextState = NEWS_DONE;</span>
<a href="#l2.2481"></a><span id="l2.2481">     ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.2482"></a><span id="l2.2482">   }</span>
<a href="#l2.2483"></a><span id="l2.2483">   PR_FREEIF(line);</span>
<a href="#l2.2484"></a><span id="l2.2484" class="difflineminus">-  return status;</span>
<a href="#l2.2485"></a><span id="l2.2485" class="difflineplus">+  return rv;</span>
<a href="#l2.2486"></a><span id="l2.2486"> }</span>
<a href="#l2.2487"></a><span id="l2.2487"> </span>
<a href="#l2.2488"></a><span id="l2.2488"> /* Sets state for the transfer. This used to be known as net_setup_news_stream */</span>
<a href="#l2.2489"></a><span id="l2.2489" class="difflineminus">-int32_t nsNNTPProtocol::SetupForTransfer()</span>
<a href="#l2.2490"></a><span id="l2.2490" class="difflineplus">+nsresult nsNNTPProtocol::SetupForTransfer()</span>
<a href="#l2.2491"></a><span id="l2.2491"> {</span>
<a href="#l2.2492"></a><span id="l2.2492">   if (m_typeWanted == NEWS_POST)</span>
<a href="#l2.2493"></a><span id="l2.2493">   {</span>
<a href="#l2.2494"></a><span id="l2.2494">     m_nextState = NNTP_SEND_POST_DATA;</span>
<a href="#l2.2495"></a><span id="l2.2495"> #ifdef UNREADY_CODE</span>
<a href="#l2.2496"></a><span id="l2.2496">     NET_Progress(ce-&gt;window_id, XP_GetString(MK_MSG_DELIV_NEWS));</span>
<a href="#l2.2497"></a><span id="l2.2497"> #endif</span>
<a href="#l2.2498"></a><span id="l2.2498">   }</span>
<a href="#l2.2499"></a><span id="l2.2499" class="difflineat">@@ -4331,31 +4308,31 @@ int32_t nsNNTPProtocol::SetupForTransfer</span>
<a href="#l2.2500"></a><span id="l2.2500">   else if(m_typeWanted == ARTICLE_WANTED ||</span>
<a href="#l2.2501"></a><span id="l2.2501">     m_typeWanted== CANCEL_WANTED)</span>
<a href="#l2.2502"></a><span id="l2.2502">     m_nextState = NNTP_BEGIN_ARTICLE;</span>
<a href="#l2.2503"></a><span id="l2.2503">   else if (m_typeWanted== SEARCH_WANTED)</span>
<a href="#l2.2504"></a><span id="l2.2504">     m_nextState = NNTP_XPAT_SEND;</span>
<a href="#l2.2505"></a><span id="l2.2505">   else</span>
<a href="#l2.2506"></a><span id="l2.2506">   {</span>
<a href="#l2.2507"></a><span id="l2.2507">     NS_ERROR(&quot;unexpected&quot;);</span>
<a href="#l2.2508"></a><span id="l2.2508" class="difflineminus">-    return -1;</span>
<a href="#l2.2509"></a><span id="l2.2509" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l2.2510"></a><span id="l2.2510">   }</span>
<a href="#l2.2511"></a><span id="l2.2511"> </span>
<a href="#l2.2512"></a><span id="l2.2512" class="difflineminus">-  return(0); /* good */</span>
<a href="#l2.2513"></a><span id="l2.2513" class="difflineplus">+  return NS_OK;</span>
<a href="#l2.2514"></a><span id="l2.2514"> }</span>
<a href="#l2.2515"></a><span id="l2.2515"> </span>
<a href="#l2.2516"></a><span id="l2.2516"> /////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l2.2517"></a><span id="l2.2517"> // The following method is used for processing the news state machine.</span>
<a href="#l2.2518"></a><span id="l2.2518"> // It returns a negative number (mscott: we'll change this to be an enumerated type which we'll coordinate</span>
<a href="#l2.2519"></a><span id="l2.2519"> // with the netlib folks?) when we are done processing.</span>
<a href="#l2.2520"></a><span id="l2.2520"> //////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l2.2521"></a><span id="l2.2521"> nsresult nsNNTPProtocol::ProcessProtocolState(nsIURI * url, nsIInputStream * inputStream,</span>
<a href="#l2.2522"></a><span id="l2.2522">                                               uint64_t sourceOffset, uint32_t length)</span>
<a href="#l2.2523"></a><span id="l2.2523"> {</span>
<a href="#l2.2524"></a><span id="l2.2524" class="difflineminus">-  int32_t status = 0;</span>
<a href="#l2.2525"></a><span id="l2.2525" class="difflineplus">+  nsresult status = NS_OK;</span>
<a href="#l2.2526"></a><span id="l2.2526">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(m_runningURL);</span>
<a href="#l2.2527"></a><span id="l2.2527">   if (inputStream &amp;&amp; (!mailnewsurl || !m_nntpServer))</span>
<a href="#l2.2528"></a><span id="l2.2528">   {</span>
<a href="#l2.2529"></a><span id="l2.2529">     // In these cases, we are going to return since our data is effectively</span>
<a href="#l2.2530"></a><span id="l2.2530">     // invalid. However, nsInputStream would really rather that we at least read</span>
<a href="#l2.2531"></a><span id="l2.2531">     // some of our input data (even if not all of it). Therefore, we'll read a</span>
<a href="#l2.2532"></a><span id="l2.2532">     // little bit.</span>
<a href="#l2.2533"></a><span id="l2.2533">     char buffer[128];</span>
<a href="#l2.2534"></a><span id="l2.2534" class="difflineat">@@ -4698,18 +4675,18 @@ nsresult nsNNTPProtocol::ProcessProtocol</span>
<a href="#l2.2535"></a><span id="l2.2535">       return NS_OK;</span>
<a href="#l2.2536"></a><span id="l2.2536">       break;</span>
<a href="#l2.2537"></a><span id="l2.2537">     default:</span>
<a href="#l2.2538"></a><span id="l2.2538">       /* big error */</span>
<a href="#l2.2539"></a><span id="l2.2539">       return NS_ERROR_FAILURE;</span>
<a href="#l2.2540"></a><span id="l2.2540"> </span>
<a href="#l2.2541"></a><span id="l2.2541">     } // end switch</span>
<a href="#l2.2542"></a><span id="l2.2542"> </span>
<a href="#l2.2543"></a><span id="l2.2543" class="difflineminus">-    if(status &lt; 0 &amp;&amp; m_nextState != NEWS_ERROR &amp;&amp;</span>
<a href="#l2.2544"></a><span id="l2.2544" class="difflineminus">-      m_nextState != NNTP_ERROR &amp;&amp; m_nextState != NEWS_FREE)</span>
<a href="#l2.2545"></a><span id="l2.2545" class="difflineplus">+    if (NS_FAILED(status) &amp;&amp; m_nextState != NEWS_ERROR &amp;&amp;</span>
<a href="#l2.2546"></a><span id="l2.2546" class="difflineplus">+        m_nextState != NNTP_ERROR &amp;&amp; m_nextState != NEWS_FREE)</span>
<a href="#l2.2547"></a><span id="l2.2547">     {</span>
<a href="#l2.2548"></a><span id="l2.2548">       m_nextState = NNTP_ERROR;</span>
<a href="#l2.2549"></a><span id="l2.2549">       ClearFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l2.2550"></a><span id="l2.2550">     }</span>
<a href="#l2.2551"></a><span id="l2.2551"> </span>
<a href="#l2.2552"></a><span id="l2.2552">   } /* end big while */</span>
<a href="#l2.2553"></a><span id="l2.2553"> </span>
<a href="#l2.2554"></a><span id="l2.2554">   return NS_OK; /* keep going */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/news/src/nsNNTPProtocol.h</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/news/src/nsNNTPProtocol.h</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -249,233 +249,233 @@ private:</span>
<a href="#l3.4"></a><span id="l3.4"> </span>
<a href="#l3.5"></a><span id="l3.5">   nsCOMPtr&lt;nsIStringBundle&gt; m_stringBundle;</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7">   nsCOMPtr&lt;nsINntpIncomingServer&gt; m_nntpServer;</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9">   nsresult GetNewsStringByName(const char *aName, PRUnichar **aString);</span>
<a href="#l3.10"></a><span id="l3.10">   nsresult GetNewsStringByID(int32_t stringID, PRUnichar **aString);</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  int32_t PostMessageInFile(nsIFile * filePath);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+  nsresult PostMessageInFile(nsIFile * filePath);</span>
<a href="#l3.14"></a><span id="l3.14"> </span>
<a href="#l3.15"></a><span id="l3.15">   //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l3.16"></a><span id="l3.16">   // Communication methods --&gt; Reading and writing protocol</span>
<a href="#l3.17"></a><span id="l3.17">   //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l3.18"></a><span id="l3.18"> </span>
<a href="#l3.19"></a><span id="l3.19">   int32_t ReadLine(nsIInputStream * inputStream, uint32_t length, char ** line);</span>
<a href="#l3.20"></a><span id="l3.20"> </span>
<a href="#l3.21"></a><span id="l3.21">   //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l3.22"></a><span id="l3.22">   // Protocol Methods --&gt; This protocol is state driven so each protocol method</span>
<a href="#l3.23"></a><span id="l3.23">   //            is designed to re-act to the current &quot;state&quot;. I've attempted to</span>
<a href="#l3.24"></a><span id="l3.24">   //            group them together based on functionality.</span>
<a href="#l3.25"></a><span id="l3.25">   //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l3.26"></a><span id="l3.26"> </span>
<a href="#l3.27"></a><span id="l3.27">   // gets the response code from the nntp server and the response line. Returns the TCP return code</span>
<a href="#l3.28"></a><span id="l3.28">   // from the read.</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-  int32_t NewsResponse(nsIInputStream * inputStream, uint32_t length);</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+  nsresult NewsResponse(nsIInputStream *inputStream, uint32_t length);</span>
<a href="#l3.31"></a><span id="l3.31"> </span>
<a href="#l3.32"></a><span id="l3.32">   // Interpret the server response after the connect.</span>
<a href="#l3.33"></a><span id="l3.33">   // Returns negative if the server responds unexpectedly</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-  int32_t LoginResponse();</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-  int32_t SendModeReader();</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-  int32_t SendModeReaderResponse();</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+  nsresult LoginResponse();</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+  nsresult SendModeReader();</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+  nsresult SendModeReaderResponse();</span>
<a href="#l3.40"></a><span id="l3.40"> </span>
<a href="#l3.41"></a><span id="l3.41" class="difflineminus">-  int32_t SendListExtensions();</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-  int32_t SendListExtensionsResponse(nsIInputStream * inputStream, uint32_t length);</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+  nsresult SendListExtensions();</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+  nsresult SendListExtensionsResponse(nsIInputStream *inputStream, uint32_t length);</span>
<a href="#l3.45"></a><span id="l3.45"> </span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-  int32_t SendListSearches();</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineminus">-  int32_t SendListSearchesResponse(nsIInputStream * inputStream, uint32_t length);</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+  nsresult SendListSearches();</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+  nsresult SendListSearchesResponse(nsIInputStream *inputStream, uint32_t length);</span>
<a href="#l3.50"></a><span id="l3.50"> </span>
<a href="#l3.51"></a><span id="l3.51" class="difflineminus">-  int32_t SendListSearchHeaders();</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-  int32_t SendListSearchHeadersResponse(nsIInputStream * inputStream, uint32_t length);</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+  nsresult SendListSearchHeaders();</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+  nsresult SendListSearchHeadersResponse(nsIInputStream *inputStream, uint32_t length);</span>
<a href="#l3.55"></a><span id="l3.55"> </span>
<a href="#l3.56"></a><span id="l3.56" class="difflineminus">-  int32_t GetProperties();</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">-  int32_t GetPropertiesResponse(nsIInputStream * inputStream, uint32_t length);</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+  nsresult GetProperties();</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+  nsresult GetPropertiesResponse(nsIInputStream *inputStream, uint32_t length);</span>
<a href="#l3.60"></a><span id="l3.60"> </span>
<a href="#l3.61"></a><span id="l3.61" class="difflineminus">-  int32_t SendListSubscriptions();</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineminus">-  int32_t SendListSubscriptionsResponse(nsIInputStream * inputStream, uint32_t length);</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+  nsresult SendListSubscriptions();</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+  nsresult SendListSubscriptionsResponse(nsIInputStream *inputStream, uint32_t length);</span>
<a href="#l3.65"></a><span id="l3.65"> </span>
<a href="#l3.66"></a><span id="l3.66">   // Figure out what the first command is and send it.</span>
<a href="#l3.67"></a><span id="l3.67">   // Returns the status from the NETWrite.</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineminus">-  int32_t SendFirstNNTPCommand(nsIURI * url);</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+  nsresult SendFirstNNTPCommand(nsIURI *url);</span>
<a href="#l3.70"></a><span id="l3.70"> </span>
<a href="#l3.71"></a><span id="l3.71">   // Interprets the server response from the first command sent.</span>
<a href="#l3.72"></a><span id="l3.72">   // returns negative if the server responds unexpectedly.</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineminus">-  int32_t SendFirstNNTPCommandResponse();</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+  nsresult SendFirstNNTPCommandResponse();</span>
<a href="#l3.75"></a><span id="l3.75"> </span>
<a href="#l3.76"></a><span id="l3.76" class="difflineminus">-  int32_t SetupForTransfer();</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+  nsresult SetupForTransfer();</span>
<a href="#l3.78"></a><span id="l3.78"> </span>
<a href="#l3.79"></a><span id="l3.79" class="difflineminus">-  int32_t SendGroupForArticle();</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineminus">-  int32_t SendGroupForArticleResponse();</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+  nsresult SendGroupForArticle();</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+  nsresult SendGroupForArticleResponse();</span>
<a href="#l3.83"></a><span id="l3.83"> </span>
<a href="#l3.84"></a><span id="l3.84" class="difflineminus">-  int32_t SendArticleNumber();</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineminus">-  int32_t BeginArticle();</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineminus">-  int32_t ReadArticle(nsIInputStream * inputStream, uint32_t length);</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineminus">-  int32_t DisplayArticle(nsIInputStream * inputStream, uint32_t length);</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+  nsresult SendArticleNumber();</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+  nsresult BeginArticle();</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+  nsresult ReadArticle(nsIInputStream *inputStream, uint32_t length);</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+  nsresult DisplayArticle(nsIInputStream *inputStream, uint32_t length);</span>
<a href="#l3.92"></a><span id="l3.92"> </span>
<a href="#l3.93"></a><span id="l3.93">   //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l3.94"></a><span id="l3.94">   // News authentication code</span>
<a href="#l3.95"></a><span id="l3.95">   //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l3.96"></a><span id="l3.96"> </span>
<a href="#l3.97"></a><span id="l3.97">   /**</span>
<a href="#l3.98"></a><span id="l3.98">    * Sends the username via AUTHINFO USER, NNTP_BEGIN_AUTHORIZE.</span>
<a href="#l3.99"></a><span id="l3.99">    * This also handles the step of getting authentication credentials; if this</span>
<a href="#l3.100"></a><span id="l3.100">    * requires a prompt to run, the connection will be suspended and we will</span>
<a href="#l3.101"></a><span id="l3.101">    * come back to this point.</span>
<a href="#l3.102"></a><span id="l3.102">    * Followed by: NNTP_AUTHORIZE_RESPONSE if the username was sent</span>
<a href="#l3.103"></a><span id="l3.103">    *              NNTP_SUSPENDED          if we need to wait for the password</span>
<a href="#l3.104"></a><span id="l3.104">    */</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineminus">-  int32_t BeginAuthorization();</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineplus">+  nsresult BeginAuthorization();</span>
<a href="#l3.107"></a><span id="l3.107">   /**</span>
<a href="#l3.108"></a><span id="l3.108">    * Sends the password if necessary, the state NNTP_AUTHORIZE_RESPONSE.</span>
<a href="#l3.109"></a><span id="l3.109">    * This also reads the result of the username.</span>
<a href="#l3.110"></a><span id="l3.110">    * Followed by: NNTP_PASSWORD_RESPONSE  if a password is sent</span>
<a href="#l3.111"></a><span id="l3.111">    *              NNTP_SEND_MODE_READER   if MODE READER needed auth</span>
<a href="#l3.112"></a><span id="l3.112">    *              SEND_FIRST_NNTP_COMMAND if any other command needed auth</span>
<a href="#l3.113"></a><span id="l3.113">    *              NNTP_ERROR              if the username was rejected</span>
<a href="#l3.114"></a><span id="l3.114">    */</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineminus">-  int32_t AuthorizationResponse();</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+  nsresult AuthorizationResponse();</span>
<a href="#l3.117"></a><span id="l3.117">   /**</span>
<a href="#l3.118"></a><span id="l3.118">    * This state, NNTP_PASSWORD_RESPONSE, reads the password.</span>
<a href="#l3.119"></a><span id="l3.119">    * Followed by: NNTP_SEND_MODE_READER   if MODE READER needed auth</span>
<a href="#l3.120"></a><span id="l3.120">    *              SEND_FIRST_NNTP_COMMAND if any other command needed auth</span>
<a href="#l3.121"></a><span id="l3.121">    *              NNTP_ERROR              if the password was rejected</span>
<a href="#l3.122"></a><span id="l3.122">    */</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineminus">-  int32_t PasswordResponse();</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineplus">+  nsresult PasswordResponse();</span>
<a href="#l3.125"></a><span id="l3.125"> </span>
<a href="#l3.126"></a><span id="l3.126" class="difflineminus">-  int32_t BeginReadNewsList();</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineminus">-  int32_t ReadNewsList(nsIInputStream * inputStream, uint32_t length);</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineplus">+  nsresult BeginReadNewsList();</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineplus">+  nsresult ReadNewsList(nsIInputStream *inputStream, uint32_t length);</span>
<a href="#l3.130"></a><span id="l3.130"> </span>
<a href="#l3.131"></a><span id="l3.131">   // Newsgroup specific protocol handlers</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineminus">-  int32_t DisplayNewsgroups();</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineminus">-  int32_t BeginNewsgroups();</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineminus">-  int32_t ProcessNewsgroups(nsIInputStream * inputStream, uint32_t length);</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineplus">+  nsresult DisplayNewsgroups();</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineplus">+  nsresult BeginNewsgroups();</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineplus">+  nsresult ProcessNewsgroups(nsIInputStream *inputStream, uint32_t length);</span>
<a href="#l3.138"></a><span id="l3.138"> </span>
<a href="#l3.139"></a><span id="l3.139">   // Protocol handlers used for posting data</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineminus">-  int32_t PostData();</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineminus">-  int32_t PostDataResponse();</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineplus">+  nsresult PostData();</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineplus">+  nsresult PostDataResponse();</span>
<a href="#l3.144"></a><span id="l3.144"> </span>
<a href="#l3.145"></a><span id="l3.145" class="difflineminus">-  int32_t CheckForArticle();</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineplus">+  nsresult CheckForArticle();</span>
<a href="#l3.147"></a><span id="l3.147"> </span>
<a href="#l3.148"></a><span id="l3.148">   /////////////////////////////////////////////////////////////////////////////</span>
<a href="#l3.149"></a><span id="l3.149">   // XHDR, XOVER, HEAD filtering process handlers</span>
<a href="#l3.150"></a><span id="l3.150">   // These are ordered by the rough order of usage</span>
<a href="#l3.151"></a><span id="l3.151">   /////////////////////////////////////////////////////////////////////////////</span>
<a href="#l3.152"></a><span id="l3.152">  </span>
<a href="#l3.153"></a><span id="l3.153">   /**</span>
<a href="#l3.154"></a><span id="l3.154">    * The first step in the filtering process, the state NNTP_XOVER_BEGIN.</span>
<a href="#l3.155"></a><span id="l3.155">    * This method sets up m_newsgroupList.</span>
<a href="#l3.156"></a><span id="l3.156">    * Followed by: NNTP_FIGURE_NEXT_CHUNK</span>
<a href="#l3.157"></a><span id="l3.157">    */</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineminus">-  int32_t BeginReadXover();</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineplus">+  nsresult BeginReadXover();</span>
<a href="#l3.160"></a><span id="l3.160">   /**</span>
<a href="#l3.161"></a><span id="l3.161">    * The loop control for filtering, the state NNTP_FIGURE_NEXT_CHUNK.</span>
<a href="#l3.162"></a><span id="l3.162">    * This method contacts the newsgroupList to figure out which articles to</span>
<a href="#l3.163"></a><span id="l3.163">    * download and then prepares it for XOVER support.</span>
<a href="#l3.164"></a><span id="l3.164">    * Followed by: NEWS_PROCESS_XOVER       if everything is finished</span>
<a href="#l3.165"></a><span id="l3.165">    *              NNTP_READ_GROUP          if XOVER doesn't work</span>
<a href="#l3.166"></a><span id="l3.166">    *              NNTP_XOVER_SEND          if XOVER does work</span>
<a href="#l3.167"></a><span id="l3.167">    */</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineminus">-  int32_t FigureNextChunk();</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineplus">+  nsresult FigureNextChunk();</span>
<a href="#l3.170"></a><span id="l3.170"> </span>
<a href="#l3.171"></a><span id="l3.171">   // The XOVER process core</span>
<a href="#l3.172"></a><span id="l3.172">   /**</span>
<a href="#l3.173"></a><span id="l3.173">    * The state NNTP_XOVER_SEND, which actually sends the message.</span>
<a href="#l3.174"></a><span id="l3.174">    * Followed by: NNTP_XOVER_RESPONSE</span>
<a href="#l3.175"></a><span id="l3.175">    */</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineminus">-  int32_t XoverSend();</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineplus">+  nsresult XoverSend();</span>
<a href="#l3.178"></a><span id="l3.178">   /**</span>
<a href="#l3.179"></a><span id="l3.179">    * This state, NNTP_XOVER_RESPONSE, actually checks the XOVER capabiliity.</span>
<a href="#l3.180"></a><span id="l3.180">    * Followed by: NNTP_XOVER               if XOVER is supported</span>
<a href="#l3.181"></a><span id="l3.181">    *              NNTP_READ_GROUP          if it isn't</span>
<a href="#l3.182"></a><span id="l3.182">    */</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineminus">-  int32_t ReadXoverResponse();</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineplus">+  nsresult ReadXoverResponse();</span>
<a href="#l3.185"></a><span id="l3.185">   /**</span>
<a href="#l3.186"></a><span id="l3.186">    * This state, NNTP_XOVER, processes the results from the XOVER command.</span>
<a href="#l3.187"></a><span id="l3.187">    * It asks nsNNTPNewsgroupList to process the line using ProcessXOVERLINE.</span>
<a href="#l3.188"></a><span id="l3.188">    * Followed by: NNTP_XHDR_SEND</span>
<a href="#l3.189"></a><span id="l3.189">    */</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineminus">-  int32_t ReadXover(nsIInputStream * inputStream, uint32_t length);</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineplus">+  nsresult ReadXover(nsIInputStream *inputStream, uint32_t length);</span>
<a href="#l3.192"></a><span id="l3.192"> </span>
<a href="#l3.193"></a><span id="l3.193">   // The XHDR process core</span>
<a href="#l3.194"></a><span id="l3.194">   /**</span>
<a href="#l3.195"></a><span id="l3.195">    * This state, NNTP_XHDR_SEND, sends the XHDR command.</span>
<a href="#l3.196"></a><span id="l3.196">    * The headers are all managed by nsNNTPNewsgroupList, and this picks them up</span>
<a href="#l3.197"></a><span id="l3.197">    * one by one as they are needed.</span>
<a href="#l3.198"></a><span id="l3.198">    * Followed by: NNTP_XHDR_RESPONSE       if there is a header to be sent</span>
<a href="#l3.199"></a><span id="l3.199">    *              NNTP_FIGURE_NEXT_CHUNK   if all headers have been sent</span>
<a href="#l3.200"></a><span id="l3.200">    */</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineminus">-  int32_t XhdrSend();</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineplus">+  nsresult XhdrSend();</span>
<a href="#l3.203"></a><span id="l3.203">   /**</span>
<a href="#l3.204"></a><span id="l3.204">    * This state, NNTP_XHDR_RESPONSE, processes the XHDR response.</span>
<a href="#l3.205"></a><span id="l3.205">    * It mostly passes the information off to nsNNTPNewsgroupList, and only does</span>
<a href="#l3.206"></a><span id="l3.206">    * response code checking and a bit of preprocessing. Note that if XHDR</span>
<a href="#l3.207"></a><span id="l3.207">    * doesn't work properly, HEAD fallback is switched on and all subsequent</span>
<a href="#l3.208"></a><span id="l3.208">    * chunks will NOT use XOVER.</span>
<a href="#l3.209"></a><span id="l3.209">    * Followed by: NNTP_READ_GROUP          if XHDR doesn't work properly</span>
<a href="#l3.210"></a><span id="l3.210">    *              NNTP_XHDR_SEND           when finished processing XHR.</span>
<a href="#l3.211"></a><span id="l3.211">    */</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineminus">-  int32_t XhdrResponse(nsIInputStream *inputStream);</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineplus">+  nsresult XhdrResponse(nsIInputStream *inputStream);</span>
<a href="#l3.214"></a><span id="l3.214"> </span>
<a href="#l3.215"></a><span id="l3.215">   // HEAD processing core</span>
<a href="#l3.216"></a><span id="l3.216">   /**</span>
<a href="#l3.217"></a><span id="l3.217">    * This state, NNTP_READ_GROUP, is the control for the HEAD processor.</span>
<a href="#l3.218"></a><span id="l3.218">    * It sends the HEAD command and increments the article number until it is</span>
<a href="#l3.219"></a><span id="l3.219">    * finished. WARNING: HEAD is REALLY SLOW.</span>
<a href="#l3.220"></a><span id="l3.220">    * Followed by: NNTP_FIGURE_NEXT_CHUNK   when it is finished </span>
<a href="#l3.221"></a><span id="l3.221">    *              NNTP_READ_GROUP_RESPONSE when it is not</span>
<a href="#l3.222"></a><span id="l3.222">    */</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineminus">-  int32_t ReadHeaders();</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineplus">+  nsresult ReadHeaders();</span>
<a href="#l3.225"></a><span id="l3.225">   /**</span>
<a href="#l3.226"></a><span id="l3.226">    * This state, NNTP_READ_GROUP_RESPONSE, checks if the article exists.</span>
<a href="#l3.227"></a><span id="l3.227">    * Because it is required by NNTP, if it doesn't work, the only problem would</span>
<a href="#l3.228"></a><span id="l3.228">    * be that the article doesn't exist. Passes off article number data to </span>
<a href="#l3.229"></a><span id="l3.229">    * nsNNTPNewsgroupList.</span>
<a href="#l3.230"></a><span id="l3.230">    * Followed by: NNTP_READ_GROUP_BODY     if the article exists</span>
<a href="#l3.231"></a><span id="l3.231">    *              NNTP_READ_GROUP          if it doesn't.</span>
<a href="#l3.232"></a><span id="l3.232">    */</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineminus">-  int32_t ReadNewsgroupResponse();</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineplus">+  nsresult ReadNewsgroupResponse();</span>
<a href="#l3.235"></a><span id="l3.235">   /**</span>
<a href="#l3.236"></a><span id="l3.236">    * This state, NNTP_READ_GROUP_BODY, reads the body of the HEAD command.</span>
<a href="#l3.237"></a><span id="l3.237">    * Once again, it passes information off to nsNNTPNewsgroupList.</span>
<a href="#l3.238"></a><span id="l3.238">    * Followed by: NNTP_READ_GROUP</span>
<a href="#l3.239"></a><span id="l3.239">    */</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineminus">-  int32_t ReadNewsgroupBody(nsIInputStream * inputStream, uint32_t length);</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineplus">+  nsresult ReadNewsgroupBody(nsIInputStream *inputStream, uint32_t length);</span>
<a href="#l3.242"></a><span id="l3.242"> </span>
<a href="#l3.243"></a><span id="l3.243">   /**</span>
<a href="#l3.244"></a><span id="l3.244">    * This state, NNTP_PROCESS_XOVER, is the final step of the filter-processing</span>
<a href="#l3.245"></a><span id="l3.245">    * code. Currently, all it does is cleans up the unread count and calls the</span>
<a href="#l3.246"></a><span id="l3.246">    * filters, both via nsNNTPNewsgroupList.</span>
<a href="#l3.247"></a><span id="l3.247">    * Followed by: NEWS_DONE</span>
<a href="#l3.248"></a><span id="l3.248">    */</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineminus">-  int32_t ProcessXover();</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineplus">+  nsresult ProcessXover();</span>
<a href="#l3.251"></a><span id="l3.251"> </span>
<a href="#l3.252"></a><span id="l3.252"> </span>
<a href="#l3.253"></a><span id="l3.253"> </span>
<a href="#l3.254"></a><span id="l3.254">   // Canceling</span>
<a href="#l3.255"></a><span id="l3.255" class="difflineminus">-  int32_t StartCancel();</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineminus">-  int32_t DoCancel();</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineplus">+  nsresult StartCancel();</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineplus">+  nsresult DoCancel();</span>
<a href="#l3.259"></a><span id="l3.259"> </span>
<a href="#l3.260"></a><span id="l3.260">   // XPAT</span>
<a href="#l3.261"></a><span id="l3.261" class="difflineminus">-  int32_t XPATSend();</span>
<a href="#l3.262"></a><span id="l3.262" class="difflineminus">-  int32_t XPATResponse(nsIInputStream * inputStream, uint32_t length);</span>
<a href="#l3.263"></a><span id="l3.263" class="difflineminus">-  int32_t ListPrettyNames();</span>
<a href="#l3.264"></a><span id="l3.264" class="difflineminus">-  int32_t ListPrettyNamesResponse(nsIInputStream * inputStream, uint32_t length);</span>
<a href="#l3.265"></a><span id="l3.265" class="difflineplus">+  nsresult XPATSend();</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineplus">+  nsresult XPATResponse(nsIInputStream *inputStream, uint32_t length);</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineplus">+  nsresult ListPrettyNames();</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineplus">+  nsresult ListPrettyNamesResponse(nsIInputStream *inputStream, uint32_t length);</span>
<a href="#l3.269"></a><span id="l3.269"> </span>
<a href="#l3.270"></a><span id="l3.270" class="difflineminus">-  int32_t ListXActive();</span>
<a href="#l3.271"></a><span id="l3.271" class="difflineminus">-  int32_t ListXActiveResponse(nsIInputStream * inputStream, uint32_t length);</span>
<a href="#l3.272"></a><span id="l3.272" class="difflineplus">+  nsresult ListXActive();</span>
<a href="#l3.273"></a><span id="l3.273" class="difflineplus">+  nsresult ListXActiveResponse(nsIInputStream *inputStream, uint32_t length);</span>
<a href="#l3.274"></a><span id="l3.274"> </span>
<a href="#l3.275"></a><span id="l3.275">   // for &quot;?list-ids&quot;</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineminus">-  int32_t SendListGroup();</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineminus">-  int32_t SendListGroupResponse(nsIInputStream * inputStream, uint32_t length);</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineplus">+  nsresult SendListGroup();</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineplus">+  nsresult SendListGroupResponse(nsIInputStream *inputStream, uint32_t length);</span>
<a href="#l3.280"></a><span id="l3.280"> </span>
<a href="#l3.281"></a><span id="l3.281">   // Searching Protocol....</span>
<a href="#l3.282"></a><span id="l3.282" class="difflineminus">-  int32_t Search();</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineminus">-  int32_t SearchResponse();</span>
<a href="#l3.284"></a><span id="l3.284" class="difflineminus">-  int32_t SearchResults(nsIInputStream *inputStream, uint32_t length);</span>
<a href="#l3.285"></a><span id="l3.285" class="difflineplus">+  nsresult Search();</span>
<a href="#l3.286"></a><span id="l3.286" class="difflineplus">+  nsresult SearchResponse();</span>
<a href="#l3.287"></a><span id="l3.287" class="difflineplus">+  nsresult SearchResults(nsIInputStream *inputStream, uint32_t length);</span>
<a href="#l3.288"></a><span id="l3.288"> </span>
<a href="#l3.289"></a><span id="l3.289">   //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l3.290"></a><span id="l3.290">   // End of Protocol Methods</span>
<a href="#l3.291"></a><span id="l3.291">   //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l3.292"></a><span id="l3.292"> </span>
<a href="#l3.293"></a><span id="l3.293">   nsresult ParseURL(nsIURI *aURL, nsCString &amp;aGroup, nsCString &amp;aMessageID);</span>
<a href="#l3.294"></a><span id="l3.294"> </span>
<a href="#l3.295"></a><span id="l3.295">   void SetProgressBarPercent(uint32_t aProgress, uint32_t aProgressMax);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

