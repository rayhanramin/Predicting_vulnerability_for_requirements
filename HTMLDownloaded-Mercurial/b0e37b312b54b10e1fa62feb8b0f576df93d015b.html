<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 2825:b0e37b312b54b10e1fa62feb8b0f576df93d015b</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ b0e37b312b54b10e1fa62feb8b0f576df93d015b" />
<meta property="og:url" content="/comm-central/rev/b0e37b312b54b10e1fa62feb8b0f576df93d015b" />
<meta property="og:description" content="Bug 474701 - gloda global search on toolbar, folder display refactoring mega-bug.  folder display layer v11.  r/sr=bienvenu." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / b0e37b312b54b10e1fa62feb8b0f576df93d015b 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/b0e37b312b54b10e1fa62feb8b0f576df93d015b">shortlog</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/b0e37b312b54b10e1fa62feb8b0f576df93d015b">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b">files</a> |
changeset |
<a href="/comm-central/raw-rev/b0e37b312b54b10e1fa62feb8b0f576df93d015b">raw</a>  | <a href="/comm-central/archive/b0e37b312b54b10e1fa62feb8b0f576df93d015b.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=474701">Bug 474701</a> - gloda global search on toolbar, folder display refactoring mega-bug.  folder display layer v11.  r/sr=bienvenu.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#110;&#100;&#114;&#101;&#119;&#32;&#83;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#32;&#60;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#64;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 12 Jun 2009 14:50:52 -0700</td></tr>

<tr>
 <td>changeset 2825</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/b0e37b312b54b10e1fa62feb8b0f576df93d015b">b0e37b312b54b10e1fa62feb8b0f576df93d015b</a></td>
</tr>



<tr>
<td>parent 2824</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/f6e6df3e2f7de2ccd277207a97696e626907879c">f6e6df3e2f7de2ccd277207a97696e626907879c</a>
</td>
</tr>

<tr>
<td>child 2826</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/ecdca1bb4d6eca3a6480e22eeecf91aa26617101">ecdca1bb4d6eca3a6480e22eeecf91aa26617101</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=b0e37b312b54b10e1fa62feb8b0f576df93d015b">2291</a></td></tr>
<tr><td>push user</td><td>bugmail@asutherland.org</td></tr>
<tr><td>push date</td><td class="date age">Fri, 12 Jun 2009 21:51:31 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@b0e37b312b54 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b0e37b312b54b10e1fa62feb8b0f576df93d015b">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b0e37b312b54b10e1fa62feb8b0f576df93d015b&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b0e37b312b54b10e1fa62feb8b0f576df93d015b&newProject=comm-central&newRevision=b0e37b312b54b10e1fa62feb8b0f576df93d015b&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b0e37b312b54b10e1fa62feb8b0f576df93d015b&newProject=comm-central&newRevision=b0e37b312b54b10e1fa62feb8b0f576df93d015b&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b0e37b312b54b10e1fa62feb8b0f576df93d015b&newProject=comm-central&newRevision=b0e37b312b54b10e1fa62feb8b0f576df93d015b&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>

<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=474701">474701</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=474701">Bug 474701</a> - gloda global search on toolbar, folder display refactoring mega-bug.  folder display layer v11.  r/sr=bienvenu.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/SearchDialog.js">mail/base/content/SearchDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/SearchDialog.js">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/SearchDialog.js">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/SearchDialog.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/SearchDialog.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/SearchDialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/SearchDialog.xul">mail/base/content/SearchDialog.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/SearchDialog.xul">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/SearchDialog.xul">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/SearchDialog.xul">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/SearchDialog.xul">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/SearchDialog.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/commandglue.js">mail/base/content/commandglue.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/commandglue.js">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/commandglue.js">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/commandglue.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/commandglue.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/commandglue.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/extraCustomizeItems.xul">mail/base/content/extraCustomizeItems.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/extraCustomizeItems.xul">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/extraCustomizeItems.xul">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/extraCustomizeItems.xul">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/extraCustomizeItems.xul">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/extraCustomizeItems.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/folderDisplay.js">mail/base/content/folderDisplay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/folderDisplay.js">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/folderDisplay.js">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/folderDisplay.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/folderDisplay.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/folderDisplay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/folderPane.js">mail/base/content/folderPane.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/folderPane.js">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/folderPane.js">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/folderPane.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/folderPane.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/folderPane.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/mail-offline.js">mail/base/content/mail-offline.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/mail-offline.js">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/mail-offline.js">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/mail-offline.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/mail-offline.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/mail-offline.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/mail3PaneWindowCommands.js">mail/base/content/mail3PaneWindowCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/mail3PaneWindowCommands.js">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/mail3PaneWindowCommands.js">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/mail3PaneWindowCommands.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/mail3PaneWindowCommands.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/mail3PaneWindowCommands.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/mailContextMenus.js">mail/base/content/mailContextMenus.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/mailContextMenus.js">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/mailContextMenus.js">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/mailContextMenus.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/mailContextMenus.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/mailContextMenus.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/mailWindow.js">mail/base/content/mailWindow.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/mailWindow.js">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/mailWindow.js">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/mailWindow.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/mailWindow.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/mailWindow.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/mailWindowOverlay.js">mail/base/content/mailWindowOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/mailWindowOverlay.js">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/mailWindowOverlay.js">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/mailWindowOverlay.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/mailWindowOverlay.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/mailWindowOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/mailWindowOverlay.xul">mail/base/content/mailWindowOverlay.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/mailWindowOverlay.xul">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/mailWindowOverlay.xul">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/mailWindowOverlay.xul">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/mailWindowOverlay.xul">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/mailWindowOverlay.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/messageDisplay.js">mail/base/content/messageDisplay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/messageDisplay.js">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/messageDisplay.js">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/messageDisplay.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/messageDisplay.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/messageDisplay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/messageWindow.js">mail/base/content/messageWindow.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/messageWindow.js">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/messageWindow.js">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/messageWindow.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/messageWindow.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/messageWindow.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/messageWindow.xul">mail/base/content/messageWindow.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/messageWindow.xul">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/messageWindow.xul">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/messageWindow.xul">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/messageWindow.xul">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/messageWindow.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/messenger.xul">mail/base/content/messenger.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/messenger.xul">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/messenger.xul">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/messenger.xul">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/messenger.xul">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/messenger.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/msgHdrViewOverlay.js">mail/base/content/msgHdrViewOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/msgHdrViewOverlay.js">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/msgHdrViewOverlay.js">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/msgHdrViewOverlay.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/msgHdrViewOverlay.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/msgHdrViewOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/msgHdrViewOverlay.xul">mail/base/content/msgHdrViewOverlay.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/msgHdrViewOverlay.xul">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/msgHdrViewOverlay.xul">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/msgHdrViewOverlay.xul">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/msgHdrViewOverlay.xul">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/msgHdrViewOverlay.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/msgMail3PaneWindow.js">mail/base/content/msgMail3PaneWindow.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/msgMail3PaneWindow.js">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/msgMail3PaneWindow.js">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/msgMail3PaneWindow.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/msgMail3PaneWindow.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/msgMail3PaneWindow.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/msgViewNavigation.js">mail/base/content/msgViewNavigation.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/msgViewNavigation.js">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/msgViewNavigation.js">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/msgViewNavigation.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/msgViewNavigation.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/msgViewNavigation.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/phishingDetector.js">mail/base/content/phishingDetector.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/phishingDetector.js">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/phishingDetector.js">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/phishingDetector.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/phishingDetector.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/phishingDetector.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/search.xml">mail/base/content/search.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/search.xml">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/search.xml">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/search.xml">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/search.xml">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/search.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/searchBar.js">mail/base/content/searchBar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/searchBar.js">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/searchBar.js">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/searchBar.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/searchBar.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/searchBar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/selectionsummaries.js">mail/base/content/selectionsummaries.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/selectionsummaries.js">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/selectionsummaries.js">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/selectionsummaries.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/selectionsummaries.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/selectionsummaries.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/tabmail.xml">mail/base/content/tabmail.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/tabmail.xml">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/tabmail.xml">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/tabmail.xml">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/tabmail.xml">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/tabmail.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/threadPane.js">mail/base/content/threadPane.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/threadPane.js">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/threadPane.js">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/threadPane.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/threadPane.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/threadPane.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/widgetglue.js">mail/base/content/widgetglue.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/widgetglue.js">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/widgetglue.js">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/widgetglue.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/widgetglue.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/content/widgetglue.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/jar.mn">mail/base/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/jar.mn">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/jar.mn">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/jar.mn">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/jar.mn">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/base/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/components/compose/content/MsgComposeCommands.js">mail/components/compose/content/MsgComposeCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/components/compose/content/MsgComposeCommands.js">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/components/compose/content/MsgComposeCommands.js">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/components/compose/content/MsgComposeCommands.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/components/compose/content/MsgComposeCommands.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/components/compose/content/MsgComposeCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/components/compose/jar.mn">mail/components/compose/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/components/compose/jar.mn">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/components/compose/jar.mn">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/components/compose/jar.mn">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/components/compose/jar.mn">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/components/compose/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/extensions/mailviews/content/msgViewPickerOverlay.js">mail/extensions/mailviews/content/msgViewPickerOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/extensions/mailviews/content/msgViewPickerOverlay.js">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/extensions/mailviews/content/msgViewPickerOverlay.js">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/extensions/mailviews/content/msgViewPickerOverlay.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/extensions/mailviews/content/msgViewPickerOverlay.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/extensions/mailviews/content/msgViewPickerOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/folder-display/test-deletion-with-multiple-displays.js">mail/test/mozmill/folder-display/test-deletion-with-multiple-displays.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/folder-display/test-deletion-with-multiple-displays.js">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/folder-display/test-deletion-with-multiple-displays.js">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/folder-display/test-deletion-with-multiple-displays.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/folder-display/test-deletion-with-multiple-displays.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/folder-display/test-deletion-with-multiple-displays.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/folder-display/test-mail-views.js">mail/test/mozmill/folder-display/test-mail-views.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/folder-display/test-mail-views.js">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/folder-display/test-mail-views.js">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/folder-display/test-mail-views.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/folder-display/test-mail-views.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/folder-display/test-mail-views.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/folder-display/test-message-window.js">mail/test/mozmill/folder-display/test-message-window.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/folder-display/test-message-window.js">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/folder-display/test-message-window.js">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/folder-display/test-message-window.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/folder-display/test-message-window.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/folder-display/test-message-window.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/folder-display/test-right-click-middle-click.js">mail/test/mozmill/folder-display/test-right-click-middle-click.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/folder-display/test-right-click-middle-click.js">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/folder-display/test-right-click-middle-click.js">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/folder-display/test-right-click-middle-click.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/folder-display/test-right-click-middle-click.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/folder-display/test-right-click-middle-click.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/folder-display/test-selection.js">mail/test/mozmill/folder-display/test-selection.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/folder-display/test-selection.js">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/folder-display/test-selection.js">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/folder-display/test-selection.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/folder-display/test-selection.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/folder-display/test-selection.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/folder-display/test-summarization.js">mail/test/mozmill/folder-display/test-summarization.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/folder-display/test-summarization.js">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/folder-display/test-summarization.js">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/folder-display/test-summarization.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/folder-display/test-summarization.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/folder-display/test-summarization.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/folder-display/test-tabs-simple.js">mail/test/mozmill/folder-display/test-tabs-simple.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/folder-display/test-tabs-simple.js">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/folder-display/test-tabs-simple.js">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/folder-display/test-tabs-simple.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/folder-display/test-tabs-simple.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/folder-display/test-tabs-simple.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/runtest.py">mail/test/mozmill/runtest.py</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/runtest.py">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/runtest.py">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/runtest.py">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/runtest.py">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/runtest.py">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/search-window/test-search-window.js">mail/test/mozmill/search-window/test-search-window.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/search-window/test-search-window.js">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/search-window/test-search-window.js">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/search-window/test-search-window.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/search-window/test-search-window.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/search-window/test-search-window.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">mail/test/mozmill/shared-modules/test-folder-display-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/shared-modules/test-window-helpers.js">mail/test/mozmill/shared-modules/test-window-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/shared-modules/test-window-helpers.js">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/shared-modules/test-window-helpers.js">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/shared-modules/test-window-helpers.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/shared-modules/test-window-helpers.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/test/mozmill/shared-modules/test-window-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/themes/gnomestripe/mail/messenger.css">mail/themes/gnomestripe/mail/messenger.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/themes/gnomestripe/mail/messenger.css">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/themes/gnomestripe/mail/messenger.css">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/themes/gnomestripe/mail/messenger.css">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/themes/gnomestripe/mail/messenger.css">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/themes/gnomestripe/mail/messenger.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/themes/gnomestripe/mail/tabmail.css">mail/themes/gnomestripe/mail/tabmail.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/themes/gnomestripe/mail/tabmail.css">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/themes/gnomestripe/mail/tabmail.css">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/themes/gnomestripe/mail/tabmail.css">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/themes/gnomestripe/mail/tabmail.css">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/themes/gnomestripe/mail/tabmail.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/themes/pinstripe/mail/tabmail.css">mail/themes/pinstripe/mail/tabmail.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/themes/pinstripe/mail/tabmail.css">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/themes/pinstripe/mail/tabmail.css">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/themes/pinstripe/mail/tabmail.css">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/themes/pinstripe/mail/tabmail.css">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/themes/pinstripe/mail/tabmail.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/themes/qute/mail/tabmail.css">mail/themes/qute/mail/tabmail.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/themes/qute/mail/tabmail.css">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/themes/qute/mail/tabmail.css">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/themes/qute/mail/tabmail.css">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/themes/qute/mail/tabmail.css">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mail/themes/qute/mail/tabmail.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/public/nsIMsgDBView.idl">mailnews/base/public/nsIMsgDBView.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/public/nsIMsgDBView.idl">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/public/nsIMsgDBView.idl">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/public/nsIMsgDBView.idl">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/public/nsIMsgDBView.idl">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/public/nsIMsgDBView.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/resources/content/msgViewNavigation.js">mailnews/base/resources/content/msgViewNavigation.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/resources/content/msgViewNavigation.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/resources/content/msgViewNavigation.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/resources/content/msgViewNavigation.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/resources/content/virtualFolderProperties.js">mailnews/base/resources/content/virtualFolderProperties.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/resources/content/virtualFolderProperties.js">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/resources/content/virtualFolderProperties.js">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/resources/content/virtualFolderProperties.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/resources/content/virtualFolderProperties.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/resources/content/virtualFolderProperties.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/resources/content/virtualFolderProperties.xul">mailnews/base/resources/content/virtualFolderProperties.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/resources/content/virtualFolderProperties.xul">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/resources/content/virtualFolderProperties.xul">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/resources/content/virtualFolderProperties.xul">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/resources/content/virtualFolderProperties.xul">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/resources/content/virtualFolderProperties.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/search/src/nsMsgSearchAdapter.cpp">mailnews/base/search/src/nsMsgSearchAdapter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/search/src/nsMsgSearchAdapter.cpp">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/search/src/nsMsgSearchAdapter.cpp">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/search/src/nsMsgSearchAdapter.cpp">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/search/src/nsMsgSearchAdapter.cpp">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/search/src/nsMsgSearchAdapter.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/dbViewWrapper.js">mailnews/base/src/dbViewWrapper.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/dbViewWrapper.js">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/dbViewWrapper.js">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/dbViewWrapper.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/dbViewWrapper.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/dbViewWrapper.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/nsMsgDBView.cpp">mailnews/base/src/nsMsgDBView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/nsMsgDBView.cpp">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/nsMsgDBView.cpp">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/nsMsgDBView.cpp">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/nsMsgDBView.cpp">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/nsMsgDBView.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/nsMsgSearchDBView.cpp">mailnews/base/src/nsMsgSearchDBView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/nsMsgSearchDBView.cpp">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/nsMsgSearchDBView.cpp">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/nsMsgSearchDBView.cpp">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/nsMsgSearchDBView.cpp">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/nsMsgSearchDBView.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/nsMsgSearchDBView.h">mailnews/base/src/nsMsgSearchDBView.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/nsMsgSearchDBView.h">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/nsMsgSearchDBView.h">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/nsMsgSearchDBView.h">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/nsMsgSearchDBView.h">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/nsMsgSearchDBView.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp">mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/nsMsgXFVirtualFolderDBView.h">mailnews/base/src/nsMsgXFVirtualFolderDBView.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/nsMsgXFVirtualFolderDBView.h">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/nsMsgXFVirtualFolderDBView.h">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/nsMsgXFVirtualFolderDBView.h">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/nsMsgXFVirtualFolderDBView.h">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/nsMsgXFVirtualFolderDBView.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/quickSearchManager.js">mailnews/base/src/quickSearchManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/quickSearchManager.js">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/quickSearchManager.js">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/quickSearchManager.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/quickSearchManager.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/quickSearchManager.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/searchSpec.js">mailnews/base/src/searchSpec.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/searchSpec.js">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/searchSpec.js">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/searchSpec.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/searchSpec.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/searchSpec.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/virtualFolderWrapper.js">mailnews/base/src/virtualFolderWrapper.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/virtualFolderWrapper.js">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/virtualFolderWrapper.js">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/virtualFolderWrapper.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/virtualFolderWrapper.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/src/virtualFolderWrapper.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/test/unit/test_jsTreeSelection.js">mailnews/base/test/unit/test_jsTreeSelection.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/test/unit/test_jsTreeSelection.js">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/test/unit/test_jsTreeSelection.js">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/test/unit/test_jsTreeSelection.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/test/unit/test_jsTreeSelection.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/test/unit/test_jsTreeSelection.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/test/unit/test_viewWrapper_logic.js">mailnews/base/test/unit/test_viewWrapper_logic.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/test/unit/test_viewWrapper_logic.js">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/test/unit/test_viewWrapper_logic.js">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/test/unit/test_viewWrapper_logic.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/test/unit/test_viewWrapper_logic.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/test/unit/test_viewWrapper_logic.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/test/unit/test_viewWrapper_realFolder.js">mailnews/base/test/unit/test_viewWrapper_realFolder.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/test/unit/test_viewWrapper_realFolder.js">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/test/unit/test_viewWrapper_realFolder.js">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/test/unit/test_viewWrapper_realFolder.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/test/unit/test_viewWrapper_realFolder.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/test/unit/test_viewWrapper_realFolder.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/test/unit/test_viewWrapper_virtualFolder.js">mailnews/base/test/unit/test_viewWrapper_virtualFolder.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/test/unit/test_viewWrapper_virtualFolder.js">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/test/unit/test_viewWrapper_virtualFolder.js">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/test/unit/test_viewWrapper_virtualFolder.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/test/unit/test_viewWrapper_virtualFolder.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/test/unit/test_viewWrapper_virtualFolder.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/util/Makefile.in">mailnews/base/util/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/util/Makefile.in">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/util/Makefile.in">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/util/Makefile.in">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/util/Makefile.in">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/util/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/util/jsTreeSelection.js">mailnews/base/util/jsTreeSelection.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/util/jsTreeSelection.js">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/util/jsTreeSelection.js">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/util/jsTreeSelection.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/util/jsTreeSelection.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/util/jsTreeSelection.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/util/traceHelper.js">mailnews/base/util/traceHelper.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/util/traceHelper.js">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/util/traceHelper.js">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/util/traceHelper.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/util/traceHelper.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/base/util/traceHelper.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/jar.mn">mailnews/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/jar.mn">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/jar.mn">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/jar.mn">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/jar.mn">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/test/resources/viewWrapperTestUtils.js">mailnews/test/resources/viewWrapperTestUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/test/resources/viewWrapperTestUtils.js">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/test/resources/viewWrapperTestUtils.js">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/test/resources/viewWrapperTestUtils.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/test/resources/viewWrapperTestUtils.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/mailnews/test/resources/viewWrapperTestUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/suite/mailnews/jar.mn">suite/mailnews/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/suite/mailnews/jar.mn">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/suite/mailnews/jar.mn">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/suite/mailnews/jar.mn">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/suite/mailnews/jar.mn">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/suite/mailnews/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/suite/mailnews/msgViewNavigation.js">suite/mailnews/msgViewNavigation.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0e37b312b54b10e1fa62feb8b0f576df93d015b/suite/mailnews/msgViewNavigation.js">file</a> |
<a href="/comm-central/annotate/b0e37b312b54b10e1fa62feb8b0f576df93d015b/suite/mailnews/msgViewNavigation.js">annotate</a> |
<a href="/comm-central/diff/b0e37b312b54b10e1fa62feb8b0f576df93d015b/suite/mailnews/msgViewNavigation.js">diff</a> |
<a href="/comm-central/comparison/b0e37b312b54b10e1fa62feb8b0f576df93d015b/suite/mailnews/msgViewNavigation.js">comparison</a> |
<a href="/comm-central/log/b0e37b312b54b10e1fa62feb8b0f576df93d015b/suite/mailnews/msgViewNavigation.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/SearchDialog.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/SearchDialog.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1,10 +1,9 @@</span>
<a href="#l1.4"></a><span id="l1.4" class="difflineminus">-/* -*- Mode: Java; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l1.5"></a><span id="l1.5" class="difflineminus">- * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l1.6"></a><span id="l1.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l1.7"></a><span id="l1.7">  * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l1.8"></a><span id="l1.8">  *</span>
<a href="#l1.9"></a><span id="l1.9">  * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l1.10"></a><span id="l1.10">  * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l1.11"></a><span id="l1.11">  * the License. You may obtain a copy of the License at</span>
<a href="#l1.12"></a><span id="l1.12">  * http://www.mozilla.org/MPL/</span>
<a href="#l1.13"></a><span id="l1.13">  *</span>
<a href="#l1.14"></a><span id="l1.14">  * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineat">@@ -17,49 +16,47 @@</span>
<a href="#l1.16"></a><span id="l1.16">  *</span>
<a href="#l1.17"></a><span id="l1.17">  * The Initial Developer of the Original Code is</span>
<a href="#l1.18"></a><span id="l1.18">  * Netscape Communications Corporation.</span>
<a href="#l1.19"></a><span id="l1.19">  * Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l1.20"></a><span id="l1.20">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l1.21"></a><span id="l1.21">  *</span>
<a href="#l1.22"></a><span id="l1.22">  * Contributor(s):</span>
<a href="#l1.23"></a><span id="l1.23">  *   Hkan Waara &lt;hwaara@chello.se&gt;</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l1.25"></a><span id="l1.25">  *</span>
<a href="#l1.26"></a><span id="l1.26">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l1.27"></a><span id="l1.27">  * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l1.28"></a><span id="l1.28">  * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l1.29"></a><span id="l1.29">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l1.30"></a><span id="l1.30">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l1.31"></a><span id="l1.31">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l1.32"></a><span id="l1.32">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l1.33"></a><span id="l1.33">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l1.34"></a><span id="l1.34">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l1.35"></a><span id="l1.35">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l1.36"></a><span id="l1.36">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l1.37"></a><span id="l1.37">  *</span>
<a href="#l1.38"></a><span id="l1.38">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l1.39"></a><span id="l1.39"> </span>
<a href="#l1.40"></a><span id="l1.40" class="difflineminus">-var searchSessionContractID = &quot;@mozilla.org/messenger/searchSession;1&quot;;</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineminus">-var gSearchView;</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-var gSearchSession;</span>
<a href="#l1.43"></a><span id="l1.43"> var gCurrentFolder;</span>
<a href="#l1.44"></a><span id="l1.44"> </span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">-var nsIMsgFolder = Components.interfaces.nsIMsgFolder;</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+var gFolderDisplay;</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+// Although we don't display messages, we have a message display object to</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+//  simplify our code.  It's just always disabled.</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+var gMessageDisplay;</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+</span>
<a href="#l1.51"></a><span id="l1.51"> var nsIMsgWindow = Components.interfaces.nsIMsgWindow;</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-var nsIMsgRDFDataSource = Components.interfaces.nsIMsgRDFDataSource;</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-var nsMsgSearchScope = Components.interfaces.nsMsgSearchScope;</span>
<a href="#l1.54"></a><span id="l1.54"> </span>
<a href="#l1.55"></a><span id="l1.55" class="difflineminus">-var gFolderDatasource;</span>
<a href="#l1.56"></a><span id="l1.56"> var gFolderPicker;</span>
<a href="#l1.57"></a><span id="l1.57"> var gStatusFeedback;</span>
<a href="#l1.58"></a><span id="l1.58"> var gTimelineEnabled = false;</span>
<a href="#l1.59"></a><span id="l1.59"> var gMessengerBundle = null;</span>
<a href="#l1.60"></a><span id="l1.60"> var RDF;</span>
<a href="#l1.61"></a><span id="l1.61"> var gSearchBundle;</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineminus">-var gNextMessageViewIndexAfterDelete = -2;</span>
<a href="#l1.63"></a><span id="l1.63"> </span>
<a href="#l1.64"></a><span id="l1.64"> // Datasource search listener -- made global as it has to be registered</span>
<a href="#l1.65"></a><span id="l1.65"> // and unregistered in different functions.</span>
<a href="#l1.66"></a><span id="l1.66"> var gDataSourceSearchListener;</span>
<a href="#l1.67"></a><span id="l1.67"> var gViewSearchListener;</span>
<a href="#l1.68"></a><span id="l1.68"> </span>
<a href="#l1.69"></a><span id="l1.69"> var gSearchStopButton;</span>
<a href="#l1.70"></a><span id="l1.70"> </span>
<a href="#l1.71"></a><span id="l1.71" class="difflineat">@@ -84,34 +81,35 @@ var nsSearchResultsController =</span>
<a href="#l1.72"></a><span id="l1.72">     },</span>
<a href="#l1.73"></a><span id="l1.73"> </span>
<a href="#l1.74"></a><span id="l1.74">     // this controller only handles commands</span>
<a href="#l1.75"></a><span id="l1.75">     // that rely on items being selected in</span>
<a href="#l1.76"></a><span id="l1.76">     // the search results pane.</span>
<a href="#l1.77"></a><span id="l1.77">     isCommandEnabled: function(command)</span>
<a href="#l1.78"></a><span id="l1.78">     {</span>
<a href="#l1.79"></a><span id="l1.79">         var enabled = true;</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineminus">-        </span>
<a href="#l1.81"></a><span id="l1.81" class="difflineminus">-        switch (command) { </span>
<a href="#l1.82"></a><span id="l1.82" class="difflineplus">+</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineplus">+        switch (command) {</span>
<a href="#l1.84"></a><span id="l1.84">           case &quot;goto_folder_button&quot;:</span>
<a href="#l1.85"></a><span id="l1.85">             if (GetNumSelectedMessages() != 1)</span>
<a href="#l1.86"></a><span id="l1.86">               enabled = false;</span>
<a href="#l1.87"></a><span id="l1.87">             break;</span>
<a href="#l1.88"></a><span id="l1.88">           case &quot;cmd_delete&quot;:</span>
<a href="#l1.89"></a><span id="l1.89">           case &quot;cmd_shiftDelete&quot;:</span>
<a href="#l1.90"></a><span id="l1.90">           case &quot;button_delete&quot;:</span>
<a href="#l1.91"></a><span id="l1.91">             // this assumes that advanced searches don't cross accounts</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineminus">-            if (GetNumSelectedMessages() &lt;= 0 || isNewsURI(gSearchView.getURIForViewIndex(0)))</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineplus">+            if (GetNumSelectedMessages() &lt;= 0 ||</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineplus">+                isNewsURI(gFolderDisplay.view.dbView.getURIForViewIndex(0)))</span>
<a href="#l1.95"></a><span id="l1.95">               enabled = false;</span>
<a href="#l1.96"></a><span id="l1.96">             break;</span>
<a href="#l1.97"></a><span id="l1.97">           case &quot;saveas_vf_button&quot;:</span>
<a href="#l1.98"></a><span id="l1.98">               // need someway to see if there are any search criteria...</span>
<a href="#l1.99"></a><span id="l1.99">               return true;</span>
<a href="#l1.100"></a><span id="l1.100">           case &quot;cmd_selectAll&quot;:</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineminus">-            return GetDBView() != null;              </span>
<a href="#l1.102"></a><span id="l1.102" class="difflineplus">+            return true;</span>
<a href="#l1.103"></a><span id="l1.103">           default:</span>
<a href="#l1.104"></a><span id="l1.104">             if (GetNumSelectedMessages() &lt;= 0)</span>
<a href="#l1.105"></a><span id="l1.105">               enabled = false;</span>
<a href="#l1.106"></a><span id="l1.106">             break;</span>
<a href="#l1.107"></a><span id="l1.107">         }</span>
<a href="#l1.108"></a><span id="l1.108"> </span>
<a href="#l1.109"></a><span id="l1.109">         return enabled;</span>
<a href="#l1.110"></a><span id="l1.110">     },</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineat">@@ -137,230 +135,218 @@ var nsSearchResultsController =</span>
<a href="#l1.112"></a><span id="l1.112"> </span>
<a href="#l1.113"></a><span id="l1.113">         case &quot;saveas_vf_button&quot;:</span>
<a href="#l1.114"></a><span id="l1.114">             saveAsVirtualFolder();</span>
<a href="#l1.115"></a><span id="l1.115">             return true;</span>
<a href="#l1.116"></a><span id="l1.116"> </span>
<a href="#l1.117"></a><span id="l1.117">         case &quot;cmd_selectAll&quot;:</span>
<a href="#l1.118"></a><span id="l1.118">             // move the focus to the search results pane</span>
<a href="#l1.119"></a><span id="l1.119">             GetThreadTree().focus();</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineminus">-            GetDBView().doCommand(nsMsgViewCommandType.selectAll)</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineplus">+            gFolderDisplay.doCommand(nsMsgViewCommandType.selectAll);</span>
<a href="#l1.122"></a><span id="l1.122">             return true;</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineminus">-                            </span>
<a href="#l1.124"></a><span id="l1.124" class="difflineplus">+</span>
<a href="#l1.125"></a><span id="l1.125">         default:</span>
<a href="#l1.126"></a><span id="l1.126">             return false;</span>
<a href="#l1.127"></a><span id="l1.127">         }</span>
<a href="#l1.128"></a><span id="l1.128"> </span>
<a href="#l1.129"></a><span id="l1.129">     },</span>
<a href="#l1.130"></a><span id="l1.130"> </span>
<a href="#l1.131"></a><span id="l1.131">     onEvent: function(event)</span>
<a href="#l1.132"></a><span id="l1.132">     {</span>
<a href="#l1.133"></a><span id="l1.133">     }</span>
<a href="#l1.134"></a><span id="l1.134"> }</span>
<a href="#l1.135"></a><span id="l1.135"> </span>
<a href="#l1.136"></a><span id="l1.136"> function UpdateMailSearch(caller)</span>
<a href="#l1.137"></a><span id="l1.137"> {</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineminus">-  //dump(&quot;XXX update mail-search &quot; + caller + &quot;\n&quot;);</span>
<a href="#l1.139"></a><span id="l1.139">   document.commandDispatcher.updateCommands('mail-search');</span>
<a href="#l1.140"></a><span id="l1.140"> }</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineplus">+/**</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineplus">+ * FolderDisplayWidget currently calls this function when the command updater</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineplus">+ *  notification for updateCommandStatus is called.  We don't have a toolbar,</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineplus">+ *  but our 'mail-search' command set serves the same purpose.</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineplus">+ */</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineplus">+var UpdateMailToolbar = UpdateMailSearch;</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineplus">+</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineplus">+/**</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineplus">+ * No-op clear message pane function for FolderDisplayWidget.</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineplus">+ */</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineplus">+function ClearMessagePane() {</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineplus">+}</span>
<a href="#l1.153"></a><span id="l1.153"> </span>
<a href="#l1.154"></a><span id="l1.154"> function SetAdvancedSearchStatusText(aNumHits)</span>
<a href="#l1.155"></a><span id="l1.155"> {</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineminus">-  var statusMsg;</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineminus">-  // if there are no hits, it means no matches were found in the search.</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineminus">-  if (aNumHits == 0)</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineminus">-    statusMsg = gSearchBundle.getString(&quot;searchFailureMessage&quot;);</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineminus">-  else </span>
<a href="#l1.161"></a><span id="l1.161" class="difflineminus">-  {</span>
<a href="#l1.162"></a><span id="l1.162" class="difflineminus">-    if (aNumHits == 1) </span>
<a href="#l1.163"></a><span id="l1.163" class="difflineminus">-      statusMsg = gSearchBundle.getString(&quot;searchSuccessMessage&quot;);</span>
<a href="#l1.164"></a><span id="l1.164" class="difflineminus">-    else</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineminus">-      statusMsg = gSearchBundle.getFormattedString(&quot;searchSuccessMessages&quot;, [aNumHits]);</span>
<a href="#l1.166"></a><span id="l1.166" class="difflineminus">-  }</span>
<a href="#l1.167"></a><span id="l1.167" class="difflineminus">-</span>
<a href="#l1.168"></a><span id="l1.168" class="difflineminus">-  gStatusFeedback.showStatusString(statusMsg);</span>
<a href="#l1.169"></a><span id="l1.169"> }</span>
<a href="#l1.170"></a><span id="l1.170"> </span>
<a href="#l1.171"></a><span id="l1.171" class="difflineminus">-// nsIMsgSearchNotify object</span>
<a href="#l1.172"></a><span id="l1.172" class="difflineminus">-var gSearchNotificationListener =</span>
<a href="#l1.173"></a><span id="l1.173" class="difflineminus">-{</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineminus">-    onSearchHit: function(header, folder)</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineminus">-    {</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineminus">-        // XXX TODO</span>
<a href="#l1.177"></a><span id="l1.177" class="difflineminus">-        // update status text?</span>
<a href="#l1.178"></a><span id="l1.178" class="difflineminus">-    },</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineminus">-</span>
<a href="#l1.180"></a><span id="l1.180" class="difflineminus">-    onSearchDone: function(status)</span>
<a href="#l1.181"></a><span id="l1.181" class="difflineminus">-    {</span>
<a href="#l1.182"></a><span id="l1.182" class="difflineminus">-        gSearchStopButton.setAttribute(&quot;label&quot;, gSearchBundle.getString(&quot;labelForSearchButton&quot;));</span>
<a href="#l1.183"></a><span id="l1.183" class="difflineminus">-        gSearchStopButton.setAttribute(&quot;accesskey&quot;, gSearchBundle.getString(&quot;labelForSearchButton.accesskey&quot;));</span>
<a href="#l1.184"></a><span id="l1.184" class="difflineminus">-        gStatusFeedback._stopMeteors();</span>
<a href="#l1.185"></a><span id="l1.185" class="difflineminus">-        SetAdvancedSearchStatusText(gSearchView.QueryInterface(Components.interfaces.nsITreeView).rowCount);</span>
<a href="#l1.186"></a><span id="l1.186" class="difflineminus">-    },</span>
<a href="#l1.187"></a><span id="l1.187" class="difflineminus">-</span>
<a href="#l1.188"></a><span id="l1.188" class="difflineminus">-    onNewSearch: function()</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineminus">-    {</span>
<a href="#l1.190"></a><span id="l1.190" class="difflineminus">-      gSearchStopButton.setAttribute(&quot;label&quot;, gSearchBundle.getString(&quot;labelForStopButton&quot;));</span>
<a href="#l1.191"></a><span id="l1.191" class="difflineminus">-      gSearchStopButton.setAttribute(&quot;accesskey&quot;, gSearchBundle.getString(&quot;labelForStopButton.accesskey&quot;));</span>
<a href="#l1.192"></a><span id="l1.192" class="difflineminus">-      UpdateMailSearch(&quot;new-search&quot;);	</span>
<a href="#l1.193"></a><span id="l1.193" class="difflineminus">-      gStatusFeedback._startMeteors();</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineminus">-      gStatusFeedback.showStatusString(gSearchBundle.getString(&quot;searchingMessage&quot;));</span>
<a href="#l1.195"></a><span id="l1.195" class="difflineminus">-    }</span>
<a href="#l1.196"></a><span id="l1.196" class="difflineplus">+/**</span>
<a href="#l1.197"></a><span id="l1.197" class="difflineplus">+ * Subclass the FolderDisplayWidget to deal with UI specific to the search</span>
<a href="#l1.198"></a><span id="l1.198" class="difflineplus">+ *  window.</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineplus">+ */</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineplus">+function SearchFolderDisplayWidget(aMessageDisplay) {</span>
<a href="#l1.201"></a><span id="l1.201" class="difflineplus">+  FolderDisplayWidget.call(this, /* no tab info */ null, aMessageDisplay);</span>
<a href="#l1.202"></a><span id="l1.202"> }</span>
<a href="#l1.203"></a><span id="l1.203"> </span>
<a href="#l1.204"></a><span id="l1.204" class="difflineminus">-// the folderListener object</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineminus">-var gFolderListener = {</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineminus">-    OnItemAdded: function(parentItem, item) {},</span>
<a href="#l1.207"></a><span id="l1.207" class="difflineplus">+SearchFolderDisplayWidget.prototype = {</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineplus">+  __proto__: FolderDisplayWidget.prototype,</span>
<a href="#l1.209"></a><span id="l1.209" class="difflineplus">+</span>
<a href="#l1.210"></a><span id="l1.210" class="difflineplus">+  /// folder display will want to show the thread pane; we need do nothing</span>
<a href="#l1.211"></a><span id="l1.211" class="difflineplus">+  _showThreadPane: function () {},</span>
<a href="#l1.212"></a><span id="l1.212"> </span>
<a href="#l1.213"></a><span id="l1.213" class="difflineminus">-    OnItemRemoved: function(parentItem, item){},</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineplus">+  onSearching: function SearchFolderDisplayWidget_onSearch(aIsSearching) {</span>
<a href="#l1.215"></a><span id="l1.215" class="difflineplus">+    if (aIsSearching) {</span>
<a href="#l1.216"></a><span id="l1.216" class="difflineplus">+      // Search button becomes the &quot;stop&quot; button</span>
<a href="#l1.217"></a><span id="l1.217" class="difflineplus">+      gSearchStopButton.setAttribute(</span>
<a href="#l1.218"></a><span id="l1.218" class="difflineplus">+        &quot;label&quot;, gSearchBundle.getString(&quot;labelForStopButton&quot;));</span>
<a href="#l1.219"></a><span id="l1.219" class="difflineplus">+      gSearchStopButton.setAttribute(</span>
<a href="#l1.220"></a><span id="l1.220" class="difflineplus">+        &quot;accesskey&quot;, gSearchBundle.getString(&quot;labelForStopButton.accesskey&quot;));</span>
<a href="#l1.221"></a><span id="l1.221"> </span>
<a href="#l1.222"></a><span id="l1.222" class="difflineminus">-    OnItemPropertyChanged: function(item, property, oldValue, newValue) {},</span>
<a href="#l1.223"></a><span id="l1.223" class="difflineminus">-</span>
<a href="#l1.224"></a><span id="l1.224" class="difflineminus">-    OnItemIntPropertyChanged: function(item, property, oldValue, newValue) {},</span>
<a href="#l1.225"></a><span id="l1.225" class="difflineminus">-</span>
<a href="#l1.226"></a><span id="l1.226" class="difflineminus">-    OnItemBoolPropertyChanged: function(item, property, oldValue, newValue) {},</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineminus">-</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineminus">-    OnItemUnicharPropertyChanged: function(item, property, oldValue, newValue){},</span>
<a href="#l1.229"></a><span id="l1.229" class="difflineminus">-    OnItemPropertyFlagChanged: function(item, property, oldFlag, newFlag) {},</span>
<a href="#l1.230"></a><span id="l1.230" class="difflineplus">+      // update our toolbar equivalent</span>
<a href="#l1.231"></a><span id="l1.231" class="difflineplus">+      UpdateMailSearch(&quot;new-search&quot;);</span>
<a href="#l1.232"></a><span id="l1.232" class="difflineplus">+      // spin the meteors</span>
<a href="#l1.233"></a><span id="l1.233" class="difflineplus">+      gStatusFeedback._startMeteors();</span>
<a href="#l1.234"></a><span id="l1.234" class="difflineplus">+      // tell the user that we're searching</span>
<a href="#l1.235"></a><span id="l1.235" class="difflineplus">+      gStatusFeedback.showStatusString(</span>
<a href="#l1.236"></a><span id="l1.236" class="difflineplus">+        gSearchBundle.getString(&quot;searchingMessage&quot;));</span>
<a href="#l1.237"></a><span id="l1.237" class="difflineplus">+    }</span>
<a href="#l1.238"></a><span id="l1.238" class="difflineplus">+    else {</span>
<a href="#l1.239"></a><span id="l1.239" class="difflineplus">+      // Stop button resumes being the &quot;search&quot; button</span>
<a href="#l1.240"></a><span id="l1.240" class="difflineplus">+      gSearchStopButton.setAttribute(</span>
<a href="#l1.241"></a><span id="l1.241" class="difflineplus">+        &quot;label&quot;, gSearchBundle.getString(&quot;labelForSearchButton&quot;));</span>
<a href="#l1.242"></a><span id="l1.242" class="difflineplus">+      gSearchStopButton.setAttribute(</span>
<a href="#l1.243"></a><span id="l1.243" class="difflineplus">+        &quot;accesskey&quot;, gSearchBundle.getString(&quot;labelForSearchButton.accesskey&quot;));</span>
<a href="#l1.244"></a><span id="l1.244"> </span>
<a href="#l1.245"></a><span id="l1.245" class="difflineminus">-    OnItemEvent: function(folder, event) {</span>
<a href="#l1.246"></a><span id="l1.246" class="difflineminus">-        var eventType = event.toString();</span>
<a href="#l1.247"></a><span id="l1.247" class="difflineminus">-        </span>
<a href="#l1.248"></a><span id="l1.248" class="difflineminus">-        if (eventType == &quot;DeleteOrMoveMsgCompleted&quot;) {</span>
<a href="#l1.249"></a><span id="l1.249" class="difflineminus">-            HandleDeleteOrMoveMessageCompleted(folder);</span>
<a href="#l1.250"></a><span id="l1.250" class="difflineminus">-        }     </span>
<a href="#l1.251"></a><span id="l1.251" class="difflineminus">-        else if (eventType == &quot;DeleteOrMoveMsgFailed&quot;) {</span>
<a href="#l1.252"></a><span id="l1.252" class="difflineminus">-            HandleDeleteOrMoveMessageFailed(folder);</span>
<a href="#l1.253"></a><span id="l1.253" class="difflineminus">-        }</span>
<a href="#l1.254"></a><span id="l1.254" class="difflineplus">+      // update our toolbar equivalent</span>
<a href="#l1.255"></a><span id="l1.255" class="difflineplus">+      UpdateMailSearch(&quot;done-search&quot;);</span>
<a href="#l1.256"></a><span id="l1.256" class="difflineplus">+      // stop spining the meteors</span>
<a href="#l1.257"></a><span id="l1.257" class="difflineplus">+      gStatusFeedback._stopMeteors();</span>
<a href="#l1.258"></a><span id="l1.258" class="difflineplus">+      // set the result test</span>
<a href="#l1.259"></a><span id="l1.259" class="difflineplus">+      this.updateStatusResultText();</span>
<a href="#l1.260"></a><span id="l1.260">     }</span>
<a href="#l1.261"></a><span id="l1.261" class="difflineminus">-}</span>
<a href="#l1.262"></a><span id="l1.262" class="difflineplus">+  },</span>
<a href="#l1.263"></a><span id="l1.263"> </span>
<a href="#l1.264"></a><span id="l1.264" class="difflineminus">-function HideSearchColumn(id)</span>
<a href="#l1.265"></a><span id="l1.265" class="difflineminus">-{</span>
<a href="#l1.266"></a><span id="l1.266" class="difflineminus">-  var col = document.getElementById(id);</span>
<a href="#l1.267"></a><span id="l1.267" class="difflineminus">-  if (col) {</span>
<a href="#l1.268"></a><span id="l1.268" class="difflineminus">-    col.setAttribute(&quot;hidden&quot;,&quot;true&quot;);</span>
<a href="#l1.269"></a><span id="l1.269" class="difflineminus">-    col.setAttribute(&quot;ignoreincolumnpicker&quot;,&quot;true&quot;);</span>
<a href="#l1.270"></a><span id="l1.270" class="difflineminus">-  }</span>
<a href="#l1.271"></a><span id="l1.271" class="difflineminus">-}</span>
<a href="#l1.272"></a><span id="l1.272" class="difflineplus">+  /**</span>
<a href="#l1.273"></a><span id="l1.273" class="difflineplus">+   * If messages were removed, we might have lost some search results and so</span>
<a href="#l1.274"></a><span id="l1.274" class="difflineplus">+   *  should update our search result text.  Also, defer to our super-class.</span>
<a href="#l1.275"></a><span id="l1.275" class="difflineplus">+   */</span>
<a href="#l1.276"></a><span id="l1.276" class="difflineplus">+  onMessagesRemoved: function SearchFolderDisplayWidget_onMessagesRemoved() {</span>
<a href="#l1.277"></a><span id="l1.277" class="difflineplus">+    // result text is only for when we are not searching</span>
<a href="#l1.278"></a><span id="l1.278" class="difflineplus">+    if (!this.view.searching)</span>
<a href="#l1.279"></a><span id="l1.279" class="difflineplus">+      this.updateStatusResultText();</span>
<a href="#l1.280"></a><span id="l1.280" class="difflineplus">+    this.__proto__.__proto__.onMessagesRemoved.call(this);</span>
<a href="#l1.281"></a><span id="l1.281" class="difflineplus">+  },</span>
<a href="#l1.282"></a><span id="l1.282"> </span>
<a href="#l1.283"></a><span id="l1.283" class="difflineminus">-function ShowSearchColumn(id)</span>
<a href="#l1.284"></a><span id="l1.284" class="difflineminus">-{</span>
<a href="#l1.285"></a><span id="l1.285" class="difflineminus">-  var col = document.getElementById(id);</span>
<a href="#l1.286"></a><span id="l1.286" class="difflineminus">-  if (col) {</span>
<a href="#l1.287"></a><span id="l1.287" class="difflineminus">-    col.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l1.288"></a><span id="l1.288" class="difflineminus">-    col.removeAttribute(&quot;ignoreincolumnpicker&quot;);</span>
<a href="#l1.289"></a><span id="l1.289" class="difflineminus">-  }</span>
<a href="#l1.290"></a><span id="l1.290" class="difflineminus">-}</span>
<a href="#l1.291"></a><span id="l1.291" class="difflineplus">+  updateStatusResultText: function() {</span>
<a href="#l1.292"></a><span id="l1.292" class="difflineplus">+    let statusMsg, rowCount = this.view.dbView.rowCount;</span>
<a href="#l1.293"></a><span id="l1.293" class="difflineplus">+    // if there are no hits, it means no matches were found in the search.</span>
<a href="#l1.294"></a><span id="l1.294" class="difflineplus">+    if (rowCount == 0)</span>
<a href="#l1.295"></a><span id="l1.295" class="difflineplus">+      statusMsg = gSearchBundle.getString(&quot;searchFailureMessage&quot;);</span>
<a href="#l1.296"></a><span id="l1.296" class="difflineplus">+    else if (rowCount == 1)</span>
<a href="#l1.297"></a><span id="l1.297" class="difflineplus">+      statusMsg = gSearchBundle.getString(&quot;searchSuccessMessage&quot;);</span>
<a href="#l1.298"></a><span id="l1.298" class="difflineplus">+    else</span>
<a href="#l1.299"></a><span id="l1.299" class="difflineplus">+      statusMsg = gSearchBundle.getFormattedString(&quot;searchSuccessMessages&quot;,</span>
<a href="#l1.300"></a><span id="l1.300" class="difflineplus">+                                                   [rowCount]);</span>
<a href="#l1.301"></a><span id="l1.301" class="difflineplus">+</span>
<a href="#l1.302"></a><span id="l1.302" class="difflineplus">+    gStatusFeedback.showStatusString(statusMsg);</span>
<a href="#l1.303"></a><span id="l1.303" class="difflineplus">+  },</span>
<a href="#l1.304"></a><span id="l1.304" class="difflineplus">+};</span>
<a href="#l1.305"></a><span id="l1.305" class="difflineplus">+</span>
<a href="#l1.306"></a><span id="l1.306"> </span>
<a href="#l1.307"></a><span id="l1.307"> function searchOnLoad()</span>
<a href="#l1.308"></a><span id="l1.308"> {</span>
<a href="#l1.309"></a><span id="l1.309">   initializeSearchWidgets();</span>
<a href="#l1.310"></a><span id="l1.310">   initializeSearchWindowWidgets();</span>
<a href="#l1.311"></a><span id="l1.311">   messenger = Components.classes[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l1.312"></a><span id="l1.312">                         .createInstance(Components.interfaces.nsIMessenger);</span>
<a href="#l1.313"></a><span id="l1.313"> </span>
<a href="#l1.314"></a><span id="l1.314">   gSearchBundle = document.getElementById(&quot;bundle_search&quot;);</span>
<a href="#l1.315"></a><span id="l1.315">   gSearchStopButton.setAttribute(&quot;label&quot;, gSearchBundle.getString(&quot;labelForSearchButton&quot;));</span>
<a href="#l1.316"></a><span id="l1.316">   gSearchStopButton.setAttribute(&quot;accesskey&quot;, gSearchBundle.getString(&quot;labelForSearchButton.accesskey&quot;));</span>
<a href="#l1.317"></a><span id="l1.317">   gMessengerBundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l1.318"></a><span id="l1.318" class="difflineminus">-  setupDatasource();</span>
<a href="#l1.319"></a><span id="l1.319" class="difflineminus">-  setupSearchListener();</span>
<a href="#l1.320"></a><span id="l1.320" class="difflineplus">+</span>
<a href="#l1.321"></a><span id="l1.321" class="difflineplus">+  gMessageDisplay = new NeverVisisbleMessageDisplayWidget();</span>
<a href="#l1.322"></a><span id="l1.322" class="difflineplus">+  gFolderDisplay = new SearchFolderDisplayWidget(gMessageDisplay);</span>
<a href="#l1.323"></a><span id="l1.323" class="difflineplus">+  gFolderDisplay.messenger = messenger;</span>
<a href="#l1.324"></a><span id="l1.324" class="difflineplus">+  gFolderDisplay.msgWindow = msgWindow;</span>
<a href="#l1.325"></a><span id="l1.325" class="difflineplus">+  gFolderDisplay.tree = document.getElementById(&quot;threadTree&quot;);</span>
<a href="#l1.326"></a><span id="l1.326" class="difflineplus">+  gFolderDisplay.treeBox = gFolderDisplay.tree.boxObject.QueryInterface(</span>
<a href="#l1.327"></a><span id="l1.327" class="difflineplus">+                             Components.interfaces.nsITreeBoxObject);</span>
<a href="#l1.328"></a><span id="l1.328" class="difflineplus">+  gFolderDisplay.view.openSearchView();</span>
<a href="#l1.329"></a><span id="l1.329" class="difflineplus">+  gFolderDisplay.makeActive();</span>
<a href="#l1.330"></a><span id="l1.330" class="difflineplus">+</span>
<a href="#l1.331"></a><span id="l1.331" class="difflineplus">+  gFolderDisplay.setVisibleColumns({subjectCol: true,</span>
<a href="#l1.332"></a><span id="l1.332" class="difflineplus">+                                    senderCol: true,</span>
<a href="#l1.333"></a><span id="l1.333" class="difflineplus">+                                    dateCol: true,</span>
<a href="#l1.334"></a><span id="l1.334" class="difflineplus">+                                    locationCol: true,</span>
<a href="#l1.335"></a><span id="l1.335" class="difflineplus">+                                    });</span>
<a href="#l1.336"></a><span id="l1.336"> </span>
<a href="#l1.337"></a><span id="l1.337">   if (window.arguments &amp;&amp; window.arguments[0])</span>
<a href="#l1.338"></a><span id="l1.338">       selectFolder(window.arguments[0].folder);</span>
<a href="#l1.339"></a><span id="l1.339"> </span>
<a href="#l1.340"></a><span id="l1.340" class="difflineplus">+  // trigger searchTermOverlay.js to create the first criterion</span>
<a href="#l1.341"></a><span id="l1.341">   onMore(null);</span>
<a href="#l1.342"></a><span id="l1.342" class="difflineplus">+  // make sure all the buttons are configured</span>
<a href="#l1.343"></a><span id="l1.343">   UpdateMailSearch(&quot;onload&quot;);</span>
<a href="#l1.344"></a><span id="l1.344" class="difflineminus">-  </span>
<a href="#l1.345"></a><span id="l1.345" class="difflineminus">-  // hide and remove these columns from the column picker.  you can't thread search results</span>
<a href="#l1.346"></a><span id="l1.346" class="difflineminus">-  HideSearchColumn(&quot;threadCol&quot;); // since you can't thread search results</span>
<a href="#l1.347"></a><span id="l1.347" class="difflineminus">-  HideSearchColumn(&quot;totalCol&quot;); // since you can't thread search results</span>
<a href="#l1.348"></a><span id="l1.348" class="difflineminus">-  HideSearchColumn(&quot;unreadCol&quot;); // since you can't thread search results</span>
<a href="#l1.349"></a><span id="l1.349" class="difflineminus">-  HideSearchColumn(&quot;unreadButtonColHeader&quot;);</span>
<a href="#l1.350"></a><span id="l1.350" class="difflineminus">-  HideSearchColumn(&quot;statusCol&quot;);</span>
<a href="#l1.351"></a><span id="l1.351" class="difflineminus">-  HideSearchColumn(&quot;flaggedCol&quot;);</span>
<a href="#l1.352"></a><span id="l1.352" class="difflineminus">-  HideSearchColumn(&quot;idCol&quot;);</span>
<a href="#l1.353"></a><span id="l1.353" class="difflineminus">-  HideSearchColumn(&quot;junkStatusCol&quot;);</span>
<a href="#l1.354"></a><span id="l1.354" class="difflineminus">-  HideSearchColumn(&quot;accountCol&quot;);</span>
<a href="#l1.355"></a><span id="l1.355" class="difflineminus">-  </span>
<a href="#l1.356"></a><span id="l1.356" class="difflineminus">-  // we want to show the location column for search</span>
<a href="#l1.357"></a><span id="l1.357" class="difflineminus">-  ShowSearchColumn(&quot;locationCol&quot;);</span>
<a href="#l1.358"></a><span id="l1.358"> }</span>
<a href="#l1.359"></a><span id="l1.359"> </span>
<a href="#l1.360"></a><span id="l1.360"> function searchOnUnload()</span>
<a href="#l1.361"></a><span id="l1.361"> {</span>
<a href="#l1.362"></a><span id="l1.362" class="difflineminus">-    // unregister listeners</span>
<a href="#l1.363"></a><span id="l1.363" class="difflineminus">-    gSearchSession.unregisterListener(gViewSearchListener);</span>
<a href="#l1.364"></a><span id="l1.364" class="difflineminus">-    gSearchSession.unregisterListener(gSearchNotificationListener);</span>
<a href="#l1.365"></a><span id="l1.365" class="difflineplus">+  gFolderDisplay.close();</span>
<a href="#l1.366"></a><span id="l1.366" class="difflineplus">+  top.controllers.removeController(nsSearchResultsController);</span>
<a href="#l1.367"></a><span id="l1.367"> </span>
<a href="#l1.368"></a><span id="l1.368" class="difflineminus">-    Components.classes[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l1.369"></a><span id="l1.369" class="difflineminus">-              .getService(Components.interfaces.nsIMsgMailSession)</span>
<a href="#l1.370"></a><span id="l1.370" class="difflineminus">-              .RemoveFolderListener(gFolderListener);</span>
<a href="#l1.371"></a><span id="l1.371" class="difflineminus">-	</span>
<a href="#l1.372"></a><span id="l1.372" class="difflineminus">-    if (gSearchView) {</span>
<a href="#l1.373"></a><span id="l1.373" class="difflineminus">-	gSearchView.close();</span>
<a href="#l1.374"></a><span id="l1.374" class="difflineminus">-	gSearchView = null;</span>
<a href="#l1.375"></a><span id="l1.375" class="difflineminus">-    }</span>
<a href="#l1.376"></a><span id="l1.376" class="difflineminus">-</span>
<a href="#l1.377"></a><span id="l1.377" class="difflineminus">-    top.controllers.removeController(nsSearchResultsController);</span>
<a href="#l1.378"></a><span id="l1.378" class="difflineminus">-</span>
<a href="#l1.379"></a><span id="l1.379" class="difflineminus">-    // release this early because msgWindow holds a weak reference</span>
<a href="#l1.380"></a><span id="l1.380" class="difflineminus">-    msgWindow.rootDocShell = null;</span>
<a href="#l1.381"></a><span id="l1.381" class="difflineplus">+  // release this early because msgWindow holds a weak reference</span>
<a href="#l1.382"></a><span id="l1.382" class="difflineplus">+  msgWindow.rootDocShell = null;</span>
<a href="#l1.383"></a><span id="l1.383"> }</span>
<a href="#l1.384"></a><span id="l1.384"> </span>
<a href="#l1.385"></a><span id="l1.385"> function initializeSearchWindowWidgets()</span>
<a href="#l1.386"></a><span id="l1.386"> {</span>
<a href="#l1.387"></a><span id="l1.387">     gFolderPicker = document.getElementById(&quot;searchableFolders&quot;);</span>
<a href="#l1.388"></a><span id="l1.388">     gSearchStopButton = document.getElementById(&quot;search-button&quot;);</span>
<a href="#l1.389"></a><span id="l1.389">     hideMatchAllItem();</span>
<a href="#l1.390"></a><span id="l1.390" class="difflineminus">-    </span>
<a href="#l1.391"></a><span id="l1.391" class="difflineplus">+</span>
<a href="#l1.392"></a><span id="l1.392">     msgWindow = Components.classes[&quot;@mozilla.org/messenger/msgwindow;1&quot;]</span>
<a href="#l1.393"></a><span id="l1.393">                           .createInstance(nsIMsgWindow);</span>
<a href="#l1.394"></a><span id="l1.394">     msgWindow.domWindow = window;</span>
<a href="#l1.395"></a><span id="l1.395">     msgWindow.rootDocShell.appType = Components.interfaces.nsIDocShell.APP_TYPE_MAIL;</span>
<a href="#l1.396"></a><span id="l1.396"> </span>
<a href="#l1.397"></a><span id="l1.397">     gStatusFeedback = new nsMsgStatusFeedback();</span>
<a href="#l1.398"></a><span id="l1.398">     msgWindow.statusFeedback = gStatusFeedback;</span>
<a href="#l1.399"></a><span id="l1.399"> </span>
<a href="#l1.400"></a><span id="l1.400">     // functionality to enable/disable buttons using nsSearchResultsController</span>
<a href="#l1.401"></a><span id="l1.401">     // depending of whether items are selected in the search results thread pane.</span>
<a href="#l1.402"></a><span id="l1.402">     top.controllers.insertControllerAt(0, nsSearchResultsController);</span>
<a href="#l1.403"></a><span id="l1.403"> }</span>
<a href="#l1.404"></a><span id="l1.404"> </span>
<a href="#l1.405"></a><span id="l1.405"> </span>
<a href="#l1.406"></a><span id="l1.406"> function onSearchStop() {</span>
<a href="#l1.407"></a><span id="l1.407" class="difflineminus">-    gSearchSession.interruptSearch();</span>
<a href="#l1.408"></a><span id="l1.408" class="difflineplus">+  gFolderDisplay.view.search.session.interruptSearch();</span>
<a href="#l1.409"></a><span id="l1.409"> }</span>
<a href="#l1.410"></a><span id="l1.410"> </span>
<a href="#l1.411"></a><span id="l1.411"> function onResetSearch(event) {</span>
<a href="#l1.412"></a><span id="l1.412" class="difflineminus">-    onReset(event);</span>
<a href="#l1.413"></a><span id="l1.413" class="difflineminus">-    </span>
<a href="#l1.414"></a><span id="l1.414" class="difflineminus">-    var tree = GetThreadTree();</span>
<a href="#l1.415"></a><span id="l1.415" class="difflineminus">-    tree.treeBoxObject.view = null;</span>
<a href="#l1.416"></a><span id="l1.416" class="difflineminus">-    gStatusFeedback.showStatusString(&quot;&quot;);</span>
<a href="#l1.417"></a><span id="l1.417" class="difflineplus">+  onReset(event);</span>
<a href="#l1.418"></a><span id="l1.418" class="difflineplus">+  gFolderDisplay.view.search.clear();</span>
<a href="#l1.419"></a><span id="l1.419" class="difflineplus">+</span>
<a href="#l1.420"></a><span id="l1.420" class="difflineplus">+  gStatusFeedback.showStatusString(&quot;&quot;);</span>
<a href="#l1.421"></a><span id="l1.421"> }</span>
<a href="#l1.422"></a><span id="l1.422"> </span>
<a href="#l1.423"></a><span id="l1.423" class="difflineminus">-function selectFolder(folder) </span>
<a href="#l1.424"></a><span id="l1.424" class="difflineplus">+function selectFolder(folder)</span>
<a href="#l1.425"></a><span id="l1.425"> {</span>
<a href="#l1.426"></a><span id="l1.426">     var folderURI;</span>
<a href="#l1.427"></a><span id="l1.427"> </span>
<a href="#l1.428"></a><span id="l1.428">     // if we can't search messages on this folder, just select the first one</span>
<a href="#l1.429"></a><span id="l1.429">     if (!folder || !folder.server.canSearchMessages ||</span>
<a href="#l1.430"></a><span id="l1.430">         (folder.flags &amp; Components.interfaces.nsMsgFolderFlags.Virtual)) {</span>
<a href="#l1.431"></a><span id="l1.431">         // find first item in our folder picker menu list</span>
<a href="#l1.432"></a><span id="l1.432">         folderURI = gFolderPicker.firstChild.tree.builderView.getResourceAtIndex(0).Value;</span>
<a href="#l1.433"></a><span id="l1.433">     } else {</span>
<a href="#l1.434"></a><span id="l1.434">         folderURI = folder.URI;</span>
<a href="#l1.435"></a><span id="l1.435">     }</span>
<a href="#l1.436"></a><span id="l1.436">     updateSearchFolderPicker(folderURI);</span>
<a href="#l1.437"></a><span id="l1.437"> }</span>
<a href="#l1.438"></a><span id="l1.438"> </span>
<a href="#l1.439"></a><span id="l1.439" class="difflineminus">-function updateSearchFolderPicker(folderURI) </span>
<a href="#l1.440"></a><span id="l1.440" class="difflineminus">-{ </span>
<a href="#l1.441"></a><span id="l1.441" class="difflineplus">+function updateSearchFolderPicker(folderURI)</span>
<a href="#l1.442"></a><span id="l1.442" class="difflineplus">+{</span>
<a href="#l1.443"></a><span id="l1.443">     SetFolderPicker(folderURI, gFolderPicker.id);</span>
<a href="#l1.444"></a><span id="l1.444"> </span>
<a href="#l1.445"></a><span id="l1.445">     // use the URI to get the real folder</span>
<a href="#l1.446"></a><span id="l1.446">     gCurrentFolder = GetMsgFolderFromUri(folderURI);</span>
<a href="#l1.447"></a><span id="l1.447"> </span>
<a href="#l1.448"></a><span id="l1.448">     var searchLocalSystem = document.getElementById(&quot;checkSearchLocalSystem&quot;);</span>
<a href="#l1.449"></a><span id="l1.449">     if (searchLocalSystem)</span>
<a href="#l1.450"></a><span id="l1.450">         searchLocalSystem.disabled = gCurrentFolder.server.searchScope == nsMsgSearchScope.offlineMail;</span>
<a href="#l1.451"></a><span id="l1.451" class="difflineat">@@ -384,80 +370,96 @@ function onChooseFolder(event) {</span>
<a href="#l1.452"></a><span id="l1.452">     }</span>
<a href="#l1.453"></a><span id="l1.453"> }</span>
<a href="#l1.454"></a><span id="l1.454"> </span>
<a href="#l1.455"></a><span id="l1.455"> function onEnterInSearchTerm()</span>
<a href="#l1.456"></a><span id="l1.456"> {</span>
<a href="#l1.457"></a><span id="l1.457">   // on enter</span>
<a href="#l1.458"></a><span id="l1.458">   // if not searching, start the search</span>
<a href="#l1.459"></a><span id="l1.459">   // if searching, stop and then start again</span>
<a href="#l1.460"></a><span id="l1.460" class="difflineminus">-  if (gSearchStopButton.getAttribute(&quot;label&quot;) == gSearchBundle.getString(&quot;labelForSearchButton&quot;)) { </span>
<a href="#l1.461"></a><span id="l1.461" class="difflineminus">-     onSearch(); </span>
<a href="#l1.462"></a><span id="l1.462" class="difflineplus">+  if (gSearchStopButton.getAttribute(&quot;label&quot;) == gSearchBundle.getString(&quot;labelForSearchButton&quot;)) {</span>
<a href="#l1.463"></a><span id="l1.463" class="difflineplus">+     onSearch();</span>
<a href="#l1.464"></a><span id="l1.464">   }</span>
<a href="#l1.465"></a><span id="l1.465">   else {</span>
<a href="#l1.466"></a><span id="l1.466">      onSearchStop();</span>
<a href="#l1.467"></a><span id="l1.467">      onSearch();</span>
<a href="#l1.468"></a><span id="l1.468">   }</span>
<a href="#l1.469"></a><span id="l1.469"> }</span>
<a href="#l1.470"></a><span id="l1.470"> </span>
<a href="#l1.471"></a><span id="l1.471"> function onSearch()</span>
<a href="#l1.472"></a><span id="l1.472"> {</span>
<a href="#l1.473"></a><span id="l1.473" class="difflineminus">-    // set the view.  do this on every search, to</span>
<a href="#l1.474"></a><span id="l1.474" class="difflineminus">-    // allow the tree to reset itself</span>
<a href="#l1.475"></a><span id="l1.475" class="difflineminus">-    var treeView = gSearchView.QueryInterface(Components.interfaces.nsITreeView);</span>
<a href="#l1.476"></a><span id="l1.476" class="difflineminus">-    if (treeView)</span>
<a href="#l1.477"></a><span id="l1.477" class="difflineminus">-    {</span>
<a href="#l1.478"></a><span id="l1.478" class="difflineminus">-      var tree = GetThreadTree();</span>
<a href="#l1.479"></a><span id="l1.479" class="difflineminus">-      tree.treeBoxObject.view = treeView;</span>
<a href="#l1.480"></a><span id="l1.480" class="difflineminus">-    }</span>
<a href="#l1.481"></a><span id="l1.481" class="difflineminus">-</span>
<a href="#l1.482"></a><span id="l1.482" class="difflineminus">-    gSearchSession.clearScopes();</span>
<a href="#l1.483"></a><span id="l1.483" class="difflineminus">-    // tell the search session what the new scope is</span>
<a href="#l1.484"></a><span id="l1.484" class="difflineminus">-    if (!gCurrentFolder.isServer &amp;&amp; !gCurrentFolder.noSelect)</span>
<a href="#l1.485"></a><span id="l1.485" class="difflineminus">-        gSearchSession.addScopeTerm(GetScopeForFolder(gCurrentFolder),</span>
<a href="#l1.486"></a><span id="l1.486" class="difflineminus">-                                    gCurrentFolder);</span>
<a href="#l1.487"></a><span id="l1.487" class="difflineplus">+  let viewWrapper = gFolderDisplay.view;</span>
<a href="#l1.488"></a><span id="l1.488" class="difflineplus">+  let searchTerms = getSearchTerms();</span>
<a href="#l1.489"></a><span id="l1.489"> </span>
<a href="#l1.490"></a><span id="l1.490" class="difflineminus">-    var searchSubfolders = document.getElementById(&quot;checkSearchSubFolders&quot;).checked;</span>
<a href="#l1.491"></a><span id="l1.491" class="difflineminus">-    if (gCurrentFolder &amp;&amp; (searchSubfolders || gCurrentFolder.isServer || gCurrentFolder.noSelect))</span>
<a href="#l1.492"></a><span id="l1.492" class="difflineminus">-    {</span>
<a href="#l1.493"></a><span id="l1.493" class="difflineminus">-        AddSubFolders(gCurrentFolder);</span>
<a href="#l1.494"></a><span id="l1.494" class="difflineminus">-    }</span>
<a href="#l1.495"></a><span id="l1.495" class="difflineminus">-    // reflect the search widgets back into the search session</span>
<a href="#l1.496"></a><span id="l1.496" class="difflineminus">-    saveSearchTerms(gSearchSession.searchTerms, gSearchSession);</span>
<a href="#l1.497"></a><span id="l1.497" class="difflineminus">-</span>
<a href="#l1.498"></a><span id="l1.498" class="difflineminus">-    try</span>
<a href="#l1.499"></a><span id="l1.499" class="difflineminus">-    {</span>
<a href="#l1.500"></a><span id="l1.500" class="difflineminus">-      gSearchSession.search(msgWindow);</span>
<a href="#l1.501"></a><span id="l1.501" class="difflineminus">-    }</span>
<a href="#l1.502"></a><span id="l1.502" class="difflineminus">-    catch(ex)</span>
<a href="#l1.503"></a><span id="l1.503" class="difflineminus">-    {</span>
<a href="#l1.504"></a><span id="l1.504" class="difflineminus">-       dump(&quot;Search Exception\n&quot;);</span>
<a href="#l1.505"></a><span id="l1.505" class="difflineminus">-    }</span>
<a href="#l1.506"></a><span id="l1.506" class="difflineminus">-    // refresh the tree after the search starts, because initiating the</span>
<a href="#l1.507"></a><span id="l1.507" class="difflineminus">-    // search will cause the datasource to clear itself</span>
<a href="#l1.508"></a><span id="l1.508" class="difflineplus">+  viewWrapper.beginViewUpdate();</span>
<a href="#l1.509"></a><span id="l1.509" class="difflineplus">+  viewWrapper.search.userTerms = searchTerms.length ? searchTerms : null;</span>
<a href="#l1.510"></a><span id="l1.510" class="difflineplus">+  viewWrapper.searchFolders = getSearchFolders();</span>
<a href="#l1.511"></a><span id="l1.511" class="difflineplus">+  viewWrapper.endViewUpdate();</span>
<a href="#l1.512"></a><span id="l1.512"> }</span>
<a href="#l1.513"></a><span id="l1.513"> </span>
<a href="#l1.514"></a><span id="l1.514" class="difflineminus">-function AddSubFolders(folder) {</span>
<a href="#l1.515"></a><span id="l1.515" class="difflineplus">+/**</span>
<a href="#l1.516"></a><span id="l1.516" class="difflineplus">+ * Get the current set of search terms, returning them as a list.  We filter out</span>
<a href="#l1.517"></a><span id="l1.517" class="difflineplus">+ *  dangerous and insane predicates.</span>
<a href="#l1.518"></a><span id="l1.518" class="difflineplus">+ */</span>
<a href="#l1.519"></a><span id="l1.519" class="difflineplus">+function getSearchTerms() {</span>
<a href="#l1.520"></a><span id="l1.520" class="difflineplus">+  let termCreator = gFolderDisplay.view.search.session;</span>
<a href="#l1.521"></a><span id="l1.521" class="difflineplus">+</span>
<a href="#l1.522"></a><span id="l1.522" class="difflineplus">+  let searchTerms = [];</span>
<a href="#l1.523"></a><span id="l1.523" class="difflineplus">+  // searchTermOverlay stores wrapper objects in its gSearchTerms array.  Pluck</span>
<a href="#l1.524"></a><span id="l1.524" class="difflineplus">+  //  them.</span>
<a href="#l1.525"></a><span id="l1.525" class="difflineplus">+  for (let iTerm = 0; iTerm &lt; gSearchTerms.length; iTerm++) {</span>
<a href="#l1.526"></a><span id="l1.526" class="difflineplus">+    let termWrapper = gSearchTerms[iTerm].obj;</span>
<a href="#l1.527"></a><span id="l1.527" class="difflineplus">+    let realTerm = termCreator.createTerm();</span>
<a href="#l1.528"></a><span id="l1.528" class="difflineplus">+    termWrapper.saveTo(realTerm);</span>
<a href="#l1.529"></a><span id="l1.529" class="difflineplus">+    // A header search of &quot;&quot; is illegal for IMAP and will cause us to</span>
<a href="#l1.530"></a><span id="l1.530" class="difflineplus">+    //  explode.  You don't want that and I don't want that.  So let's check</span>
<a href="#l1.531"></a><span id="l1.531" class="difflineplus">+    //  if the bloody term is a subject search on a blank string, and if it</span>
<a href="#l1.532"></a><span id="l1.532" class="difflineplus">+    //  is, let's secretly not add the term.  Everyone wins!</span>
<a href="#l1.533"></a><span id="l1.533" class="difflineplus">+    if ((realTerm.attrib != Components.interfaces.nsMsgSearchAttrib.Subject) ||</span>
<a href="#l1.534"></a><span id="l1.534" class="difflineplus">+        (realTerm.value.str != &quot;&quot;))</span>
<a href="#l1.535"></a><span id="l1.535" class="difflineplus">+      searchTerms.push(realTerm);</span>
<a href="#l1.536"></a><span id="l1.536" class="difflineplus">+  }</span>
<a href="#l1.537"></a><span id="l1.537" class="difflineplus">+</span>
<a href="#l1.538"></a><span id="l1.538" class="difflineplus">+  return searchTerms;</span>
<a href="#l1.539"></a><span id="l1.539" class="difflineplus">+}</span>
<a href="#l1.540"></a><span id="l1.540" class="difflineplus">+</span>
<a href="#l1.541"></a><span id="l1.541" class="difflineplus">+/**</span>
<a href="#l1.542"></a><span id="l1.542" class="difflineplus">+ * @return the list of folders the search should cover.</span>
<a href="#l1.543"></a><span id="l1.543" class="difflineplus">+ */</span>
<a href="#l1.544"></a><span id="l1.544" class="difflineplus">+function getSearchFolders() {</span>
<a href="#l1.545"></a><span id="l1.545" class="difflineplus">+  let searchFolders = [];</span>
<a href="#l1.546"></a><span id="l1.546" class="difflineplus">+</span>
<a href="#l1.547"></a><span id="l1.547" class="difflineplus">+  if (!gCurrentFolder.isServer &amp;&amp; !gCurrentFolder.noSelect)</span>
<a href="#l1.548"></a><span id="l1.548" class="difflineplus">+    searchFolders.push(gCurrentFolder);</span>
<a href="#l1.549"></a><span id="l1.549" class="difflineplus">+</span>
<a href="#l1.550"></a><span id="l1.550" class="difflineplus">+  var searchSubfolders =</span>
<a href="#l1.551"></a><span id="l1.551" class="difflineplus">+    document.getElementById(&quot;checkSearchSubFolders&quot;).checked;</span>
<a href="#l1.552"></a><span id="l1.552" class="difflineplus">+  if (gCurrentFolder &amp;&amp;</span>
<a href="#l1.553"></a><span id="l1.553" class="difflineplus">+      (searchSubfolders || gCurrentFolder.isServer || gCurrentFolder.noSelect))</span>
<a href="#l1.554"></a><span id="l1.554" class="difflineplus">+    AddSubFolders(gCurrentFolder, searchFolders);</span>
<a href="#l1.555"></a><span id="l1.555" class="difflineplus">+</span>
<a href="#l1.556"></a><span id="l1.556" class="difflineplus">+  return searchFolders;</span>
<a href="#l1.557"></a><span id="l1.557" class="difflineplus">+}</span>
<a href="#l1.558"></a><span id="l1.558" class="difflineplus">+</span>
<a href="#l1.559"></a><span id="l1.559" class="difflineplus">+function AddSubFolders(folder, outFolders) {</span>
<a href="#l1.560"></a><span id="l1.560">   var subFolders = folder.subFolders;</span>
<a href="#l1.561"></a><span id="l1.561" class="difflineminus">-  while (subFolders.hasMoreElements())</span>
<a href="#l1.562"></a><span id="l1.562" class="difflineminus">-  {</span>
<a href="#l1.563"></a><span id="l1.563" class="difflineplus">+  while (subFolders.hasMoreElements()) {</span>
<a href="#l1.564"></a><span id="l1.564">     var nextFolder =</span>
<a href="#l1.565"></a><span id="l1.565">       subFolders.getNext().QueryInterface(Components.interfaces.nsIMsgFolder);</span>
<a href="#l1.566"></a><span id="l1.566"> </span>
<a href="#l1.567"></a><span id="l1.567" class="difflineminus">-    if (!(nextFolder.flags &amp; Components.interfaces.nsMsgFolderFlags.Virtual))</span>
<a href="#l1.568"></a><span id="l1.568" class="difflineminus">-    {</span>
<a href="#l1.569"></a><span id="l1.569" class="difflineplus">+    if (!(nextFolder.flags &amp; Components.interfaces.nsMsgFolderFlags.Virtual)) {</span>
<a href="#l1.570"></a><span id="l1.570">       if (!nextFolder.noSelect)</span>
<a href="#l1.571"></a><span id="l1.571" class="difflineminus">-        gSearchSession.addScopeTerm(GetScopeForFolder(nextFolder), nextFolder);</span>
<a href="#l1.572"></a><span id="l1.572" class="difflineplus">+        outFolders.push(nextFolder);</span>
<a href="#l1.573"></a><span id="l1.573"> </span>
<a href="#l1.574"></a><span id="l1.574" class="difflineminus">-      AddSubFolders(nextFolder);</span>
<a href="#l1.575"></a><span id="l1.575" class="difflineplus">+      AddSubFolders(nextFolder, outFolders);</span>
<a href="#l1.576"></a><span id="l1.576">     }</span>
<a href="#l1.577"></a><span id="l1.577">   }</span>
<a href="#l1.578"></a><span id="l1.578"> }</span>
<a href="#l1.579"></a><span id="l1.579"> </span>
<a href="#l1.580"></a><span id="l1.580" class="difflineminus">-function AddSubFoldersToURI(folder) </span>
<a href="#l1.581"></a><span id="l1.581" class="difflineplus">+function AddSubFoldersToURI(folder)</span>
<a href="#l1.582"></a><span id="l1.582"> {</span>
<a href="#l1.583"></a><span id="l1.583">   var returnString = &quot;&quot;;</span>
<a href="#l1.584"></a><span id="l1.584"> </span>
<a href="#l1.585"></a><span id="l1.585">   var subFolders = folder.subFolders;</span>
<a href="#l1.586"></a><span id="l1.586"> </span>
<a href="#l1.587"></a><span id="l1.587">   while (subFolders.hasMoreElements())</span>
<a href="#l1.588"></a><span id="l1.588">   {</span>
<a href="#l1.589"></a><span id="l1.589">     var nextFolder =</span>
<a href="#l1.590"></a><span id="l1.590" class="difflineat">@@ -479,17 +481,17 @@ function AddSubFoldersToURI(folder)</span>
<a href="#l1.591"></a><span id="l1.591">         returnString += subFoldersString;</span>
<a href="#l1.592"></a><span id="l1.592">       }</span>
<a href="#l1.593"></a><span id="l1.593">     }</span>
<a href="#l1.594"></a><span id="l1.594">   }</span>
<a href="#l1.595"></a><span id="l1.595">   return returnString;</span>
<a href="#l1.596"></a><span id="l1.596"> }</span>
<a href="#l1.597"></a><span id="l1.597"> </span>
<a href="#l1.598"></a><span id="l1.598"> </span>
<a href="#l1.599"></a><span id="l1.599" class="difflineminus">-function GetScopeForFolder(folder) </span>
<a href="#l1.600"></a><span id="l1.600" class="difflineplus">+function GetScopeForFolder(folder)</span>
<a href="#l1.601"></a><span id="l1.601"> {</span>
<a href="#l1.602"></a><span id="l1.602">   var searchLocalSystem = document.getElementById(&quot;checkSearchLocalSystem&quot;);</span>
<a href="#l1.603"></a><span id="l1.603">   return searchLocalSystem &amp;&amp; searchLocalSystem.checked ? nsMsgSearchScope.offlineMail : folder.server.searchScope;</span>
<a href="#l1.604"></a><span id="l1.604"> }</span>
<a href="#l1.605"></a><span id="l1.605"> </span>
<a href="#l1.606"></a><span id="l1.606"> var nsMsgViewSortType = Components.interfaces.nsMsgViewSortType;</span>
<a href="#l1.607"></a><span id="l1.607"> var nsMsgViewSortOrder = Components.interfaces.nsMsgViewSortOrder;</span>
<a href="#l1.608"></a><span id="l1.608"> var nsMsgViewFlagsType = Components.interfaces.nsMsgViewFlagsType;</span>
<a href="#l1.609"></a><span id="l1.609" class="difflineat">@@ -502,287 +504,89 @@ function goUpdateSearchItems(commandset)</span>
<a href="#l1.610"></a><span id="l1.610">     var commandID = commandset.childNodes[i].getAttribute(&quot;id&quot;);</span>
<a href="#l1.611"></a><span id="l1.611">     if (commandID)</span>
<a href="#l1.612"></a><span id="l1.612">     {</span>
<a href="#l1.613"></a><span id="l1.613">       goUpdateCommand(commandID);</span>
<a href="#l1.614"></a><span id="l1.614">     }</span>
<a href="#l1.615"></a><span id="l1.615">   }</span>
<a href="#l1.616"></a><span id="l1.616"> }</span>
<a href="#l1.617"></a><span id="l1.617"> </span>
<a href="#l1.618"></a><span id="l1.618" class="difflineminus">-function nsMsgSearchCommandUpdater()</span>
<a href="#l1.619"></a><span id="l1.619" class="difflineminus">-{}</span>
<a href="#l1.620"></a><span id="l1.620" class="difflineminus">-</span>
<a href="#l1.621"></a><span id="l1.621" class="difflineminus">-nsMsgSearchCommandUpdater.prototype =</span>
<a href="#l1.622"></a><span id="l1.622" class="difflineminus">-{</span>
<a href="#l1.623"></a><span id="l1.623" class="difflineminus">-  updateCommandStatus : function()</span>
<a href="#l1.624"></a><span id="l1.624" class="difflineminus">-  {</span>
<a href="#l1.625"></a><span id="l1.625" class="difflineminus">-    // the back end is smart and is only telling us to update command status</span>
<a href="#l1.626"></a><span id="l1.626" class="difflineminus">-    // when the # of items in the selection has actually changed.</span>
<a href="#l1.627"></a><span id="l1.627" class="difflineminus">-    document.commandDispatcher.updateCommands('mail-search');</span>
<a href="#l1.628"></a><span id="l1.628" class="difflineminus">-  },</span>
<a href="#l1.629"></a><span id="l1.629" class="difflineminus">-  displayMessageChanged : function(aFolder, aSubject, aKeywords)</span>
<a href="#l1.630"></a><span id="l1.630" class="difflineminus">-  {</span>
<a href="#l1.631"></a><span id="l1.631" class="difflineminus">-  },</span>
<a href="#l1.632"></a><span id="l1.632" class="difflineminus">-</span>
<a href="#l1.633"></a><span id="l1.633" class="difflineminus">-  updateNextMessageAfterDelete : function()</span>
<a href="#l1.634"></a><span id="l1.634" class="difflineminus">-  {</span>
<a href="#l1.635"></a><span id="l1.635" class="difflineminus">-    SetNextMessageAfterDelete();</span>
<a href="#l1.636"></a><span id="l1.636" class="difflineminus">-  },</span>
<a href="#l1.637"></a><span id="l1.637" class="difflineminus">-</span>
<a href="#l1.638"></a><span id="l1.638" class="difflineminus">-  summarizeSelection : function() {return false},</span>
<a href="#l1.639"></a><span id="l1.639" class="difflineminus">-</span>
<a href="#l1.640"></a><span id="l1.640" class="difflineminus">-  QueryInterface : function(iid)</span>
<a href="#l1.641"></a><span id="l1.641" class="difflineminus">-  {</span>
<a href="#l1.642"></a><span id="l1.642" class="difflineminus">-    if (iid.equals(Components.interfaces.nsIMsgDBViewCommandUpdater) ||</span>
<a href="#l1.643"></a><span id="l1.643" class="difflineminus">-        iid.equals(Components.interfaces.nsISupports))</span>
<a href="#l1.644"></a><span id="l1.644" class="difflineminus">-      return this;</span>
<a href="#l1.645"></a><span id="l1.645" class="difflineminus">-</span>
<a href="#l1.646"></a><span id="l1.646" class="difflineminus">-    throw Components.results.NS_NOINTERFACE;</span>
<a href="#l1.647"></a><span id="l1.647" class="difflineminus">-  }</span>
<a href="#l1.648"></a><span id="l1.648" class="difflineminus">-}</span>
<a href="#l1.649"></a><span id="l1.649" class="difflineminus">-</span>
<a href="#l1.650"></a><span id="l1.650" class="difflineminus">-function setupDatasource() {</span>
<a href="#l1.651"></a><span id="l1.651" class="difflineminus">-    gSearchView = Components.classes[&quot;@mozilla.org/messenger/msgdbview;1?type=search&quot;].createInstance(Components.interfaces.nsIMsgDBView);</span>
<a href="#l1.652"></a><span id="l1.652" class="difflineminus">-    var count = new Object;</span>
<a href="#l1.653"></a><span id="l1.653" class="difflineminus">-    var cmdupdator = new nsMsgSearchCommandUpdater();</span>
<a href="#l1.654"></a><span id="l1.654" class="difflineminus">-</span>
<a href="#l1.655"></a><span id="l1.655" class="difflineminus">-    gSearchView.init(messenger, msgWindow, cmdupdator);</span>
<a href="#l1.656"></a><span id="l1.656" class="difflineminus">-    gSearchView.open(null, nsMsgViewSortType.byId, nsMsgViewSortOrder.ascending, nsMsgViewFlagsType.kNone, count);</span>
<a href="#l1.657"></a><span id="l1.657" class="difflineminus">-</span>
<a href="#l1.658"></a><span id="l1.658" class="difflineminus">-    // the thread pane needs to use the search datasource (to get the</span>
<a href="#l1.659"></a><span id="l1.659" class="difflineminus">-    // actual list of messages) and the message datasource (to get any</span>
<a href="#l1.660"></a><span id="l1.660" class="difflineminus">-    // attributes about each message)</span>
<a href="#l1.661"></a><span id="l1.661" class="difflineminus">-    gSearchSession = Components.classes[searchSessionContractID].createInstance(Components.interfaces.nsIMsgSearchSession);</span>
<a href="#l1.662"></a><span id="l1.662" class="difflineminus">-</span>
<a href="#l1.663"></a><span id="l1.663" class="difflineminus">-    var nsIFolderListener = Components.interfaces.nsIFolderListener;</span>
<a href="#l1.664"></a><span id="l1.664" class="difflineminus">-    var notifyFlags = nsIFolderListener.event;</span>
<a href="#l1.665"></a><span id="l1.665" class="difflineminus">-    Components.classes[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l1.666"></a><span id="l1.666" class="difflineminus">-              .getService(Components.interfaces.nsIMsgMailSession)</span>
<a href="#l1.667"></a><span id="l1.667" class="difflineminus">-              .AddFolderListener(gFolderListener, notifyFlags);</span>
<a href="#l1.668"></a><span id="l1.668" class="difflineminus">-</span>
<a href="#l1.669"></a><span id="l1.669" class="difflineminus">-    // the datasource is a listener on the search results</span>
<a href="#l1.670"></a><span id="l1.670" class="difflineminus">-    gViewSearchListener = gSearchView.QueryInterface(Components.interfaces.nsIMsgSearchNotify);</span>
<a href="#l1.671"></a><span id="l1.671" class="difflineminus">-    gSearchSession.registerListener(gViewSearchListener);</span>
<a href="#l1.672"></a><span id="l1.672" class="difflineminus">-}</span>
<a href="#l1.673"></a><span id="l1.673" class="difflineminus">-</span>
<a href="#l1.674"></a><span id="l1.674" class="difflineminus">-</span>
<a href="#l1.675"></a><span id="l1.675" class="difflineminus">-function setupSearchListener()</span>
<a href="#l1.676"></a><span id="l1.676" class="difflineminus">-{</span>
<a href="#l1.677"></a><span id="l1.677" class="difflineminus">-    // Setup the javascript object as a listener on the search results</span>
<a href="#l1.678"></a><span id="l1.678" class="difflineminus">-    gSearchSession.registerListener(gSearchNotificationListener);</span>
<a href="#l1.679"></a><span id="l1.679" class="difflineminus">-}</span>
<a href="#l1.680"></a><span id="l1.680" class="difflineminus">-</span>
<a href="#l1.681"></a><span id="l1.681" class="difflineminus">-// stuff after this is implemented to make the thread pane work</span>
<a href="#l1.682"></a><span id="l1.682" class="difflineminus">-function GetFolderDatasource()</span>
<a href="#l1.683"></a><span id="l1.683" class="difflineminus">-{</span>
<a href="#l1.684"></a><span id="l1.684" class="difflineminus">-    if (!gFolderDatasource)</span>
<a href="#l1.685"></a><span id="l1.685" class="difflineminus">-        gFolderDatasource = Components.classes[&quot;@mozilla.org/rdf/datasource;1?name=mailnewsfolders&quot;]</span>
<a href="#l1.686"></a><span id="l1.686" class="difflineminus">-                                      .getService(Components.interfaces.nsIRDFDataSource);</span>
<a href="#l1.687"></a><span id="l1.687" class="difflineminus">-    return gFolderDatasource;</span>
<a href="#l1.688"></a><span id="l1.688" class="difflineminus">-}</span>
<a href="#l1.689"></a><span id="l1.689" class="difflineminus">-</span>
<a href="#l1.690"></a><span id="l1.690" class="difflineminus">-// used to determine if we should try to load a message</span>
<a href="#l1.691"></a><span id="l1.691" class="difflineminus">-function IsThreadAndMessagePaneSplitterCollapsed()</span>
<a href="#l1.692"></a><span id="l1.692" class="difflineminus">-{</span>
<a href="#l1.693"></a><span id="l1.693" class="difflineminus">-    return true;</span>
<a href="#l1.694"></a><span id="l1.694" class="difflineminus">-}</span>
<a href="#l1.695"></a><span id="l1.695" class="difflineminus">-</span>
<a href="#l1.696"></a><span id="l1.696"> // used to toggle functionality for Search/Stop button.</span>
<a href="#l1.697"></a><span id="l1.697"> function onSearchButton(event)</span>
<a href="#l1.698"></a><span id="l1.698"> {</span>
<a href="#l1.699"></a><span id="l1.699">     if (event.target.label == gSearchBundle.getString(&quot;labelForSearchButton&quot;))</span>
<a href="#l1.700"></a><span id="l1.700">         onSearch();</span>
<a href="#l1.701"></a><span id="l1.701">     else</span>
<a href="#l1.702"></a><span id="l1.702">         onSearchStop();</span>
<a href="#l1.703"></a><span id="l1.703"> }</span>
<a href="#l1.704"></a><span id="l1.704"> </span>
<a href="#l1.705"></a><span id="l1.705"> // threadPane.js will be needing this, too</span>
<a href="#l1.706"></a><span id="l1.706"> function GetNumSelectedMessages()</span>
<a href="#l1.707"></a><span id="l1.707"> {</span>
<a href="#l1.708"></a><span id="l1.708" class="difflineminus">-   try {</span>
<a href="#l1.709"></a><span id="l1.709" class="difflineminus">-       return gSearchView.numSelected;</span>
<a href="#l1.710"></a><span id="l1.710" class="difflineminus">-   }</span>
<a href="#l1.711"></a><span id="l1.711" class="difflineminus">-   catch (ex) {</span>
<a href="#l1.712"></a><span id="l1.712" class="difflineminus">-       return 0;</span>
<a href="#l1.713"></a><span id="l1.713" class="difflineminus">-   }</span>
<a href="#l1.714"></a><span id="l1.714" class="difflineminus">-}</span>
<a href="#l1.715"></a><span id="l1.715" class="difflineminus">-</span>
<a href="#l1.716"></a><span id="l1.716" class="difflineminus">-function GetDBView()</span>
<a href="#l1.717"></a><span id="l1.717" class="difflineminus">-{</span>
<a href="#l1.718"></a><span id="l1.718" class="difflineminus">-    return gSearchView;</span>
<a href="#l1.719"></a><span id="l1.719" class="difflineplus">+  return gFolderDisplay.treeSelection.count;</span>
<a href="#l1.720"></a><span id="l1.720"> }</span>
<a href="#l1.721"></a><span id="l1.721"> </span>
<a href="#l1.722"></a><span id="l1.722"> function MsgDeleteSelectedMessages(aCommandType)</span>
<a href="#l1.723"></a><span id="l1.723"> {</span>
<a href="#l1.724"></a><span id="l1.724">     // we don't delete news messages, we just return in that case</span>
<a href="#l1.725"></a><span id="l1.725" class="difflineminus">-    if (isNewsURI(gSearchView.getURIForViewIndex(0))) </span>
<a href="#l1.726"></a><span id="l1.726" class="difflineplus">+    if (gFolderDisplay.selectedMessageIsNews)</span>
<a href="#l1.727"></a><span id="l1.727">         return;</span>
<a href="#l1.728"></a><span id="l1.728"> </span>
<a href="#l1.729"></a><span id="l1.729">     // if mail messages delete</span>
<a href="#l1.730"></a><span id="l1.730" class="difflineminus">-    SetNextMessageAfterDelete();</span>
<a href="#l1.731"></a><span id="l1.731" class="difflineminus">-    gSearchView.doCommand(aCommandType);</span>
<a href="#l1.732"></a><span id="l1.732" class="difflineminus">-}</span>
<a href="#l1.733"></a><span id="l1.733" class="difflineminus">-</span>
<a href="#l1.734"></a><span id="l1.734" class="difflineminus">-function SetNextMessageAfterDelete()</span>
<a href="#l1.735"></a><span id="l1.735" class="difflineminus">-{</span>
<a href="#l1.736"></a><span id="l1.736" class="difflineminus">-  gNextMessageViewIndexAfterDelete = gSearchView.msgToSelectAfterDelete;</span>
<a href="#l1.737"></a><span id="l1.737" class="difflineminus">-}</span>
<a href="#l1.738"></a><span id="l1.738" class="difflineminus">-</span>
<a href="#l1.739"></a><span id="l1.739" class="difflineminus">-function HandleDeleteOrMoveMessageFailed(folder)</span>
<a href="#l1.740"></a><span id="l1.740" class="difflineminus">-{</span>
<a href="#l1.741"></a><span id="l1.741" class="difflineminus">-  gNextMessageViewIndexAfterDelete = -2;</span>
<a href="#l1.742"></a><span id="l1.742" class="difflineminus">-}</span>
<a href="#l1.743"></a><span id="l1.743" class="difflineminus">-</span>
<a href="#l1.744"></a><span id="l1.744" class="difflineminus">-function HandleDeleteOrMoveMessageCompleted(folder)</span>
<a href="#l1.745"></a><span id="l1.745" class="difflineminus">-{</span>
<a href="#l1.746"></a><span id="l1.746" class="difflineminus">-  var treeView = gSearchView.QueryInterface(Components.interfaces.nsITreeView);</span>
<a href="#l1.747"></a><span id="l1.747" class="difflineminus">-  var treeSelection = treeView.selection;</span>
<a href="#l1.748"></a><span id="l1.748" class="difflineminus">-  var viewSize = treeView.rowCount;</span>
<a href="#l1.749"></a><span id="l1.749" class="difflineminus">-</span>
<a href="#l1.750"></a><span id="l1.750" class="difflineminus">-  if (gNextMessageViewIndexAfterDelete == -2) {</span>
<a href="#l1.751"></a><span id="l1.751" class="difflineminus">-    // a move or delete can cause our selection can change underneath us.</span>
<a href="#l1.752"></a><span id="l1.752" class="difflineminus">-    // this can happen when the user</span>
<a href="#l1.753"></a><span id="l1.753" class="difflineminus">-    // deletes message from the stand alone msg window</span>
<a href="#l1.754"></a><span id="l1.754" class="difflineminus">-    // or the three pane</span>
<a href="#l1.755"></a><span id="l1.755" class="difflineminus">-    if (!treeSelection) {</span>
<a href="#l1.756"></a><span id="l1.756" class="difflineminus">-      // this can happen if you open the search window</span>
<a href="#l1.757"></a><span id="l1.757" class="difflineminus">-      // and before you do any searches</span>
<a href="#l1.758"></a><span id="l1.758" class="difflineminus">-      // and you do delete from another mail window</span>
<a href="#l1.759"></a><span id="l1.759" class="difflineminus">-      return;</span>
<a href="#l1.760"></a><span id="l1.760" class="difflineminus">-    }</span>
<a href="#l1.761"></a><span id="l1.761" class="difflineminus">-    else if (treeSelection.count == 0) {</span>
<a href="#l1.762"></a><span id="l1.762" class="difflineminus">-      // this can happen if you double clicked a message</span>
<a href="#l1.763"></a><span id="l1.763" class="difflineminus">-      // in the thread pane, and deleted it from the stand alone msg window</span>
<a href="#l1.764"></a><span id="l1.764" class="difflineminus">-      // see bug #185147</span>
<a href="#l1.765"></a><span id="l1.765" class="difflineminus">-      treeSelection.clearSelection();</span>
<a href="#l1.766"></a><span id="l1.766" class="difflineminus">-</span>
<a href="#l1.767"></a><span id="l1.767" class="difflineminus">-      UpdateMailSearch(&quot;delete from another view, 0 rows now selected&quot;);</span>
<a href="#l1.768"></a><span id="l1.768" class="difflineminus">-    }</span>
<a href="#l1.769"></a><span id="l1.769" class="difflineminus">-    else if (treeSelection.count == 1) {</span>
<a href="#l1.770"></a><span id="l1.770" class="difflineminus">-      // this can happen if you had two messages selected</span>
<a href="#l1.771"></a><span id="l1.771" class="difflineminus">-      // in the search results pane, and you deleted one of them from another view</span>
<a href="#l1.772"></a><span id="l1.772" class="difflineminus">-      // (like the view in the stand alone msg window or the three pane)</span>
<a href="#l1.773"></a><span id="l1.773" class="difflineminus">-      // since one item is selected, we should load it.</span>
<a href="#l1.774"></a><span id="l1.774" class="difflineminus">-      var startIndex = {};</span>
<a href="#l1.775"></a><span id="l1.775" class="difflineminus">-      var endIndex = {};</span>
<a href="#l1.776"></a><span id="l1.776" class="difflineminus">-      treeSelection.getRangeAt(0, startIndex, endIndex);</span>
<a href="#l1.777"></a><span id="l1.777" class="difflineminus">-        </span>
<a href="#l1.778"></a><span id="l1.778" class="difflineminus">-      // select the selected item, so we'll load it</span>
<a href="#l1.779"></a><span id="l1.779" class="difflineminus">-      treeSelection.select(startIndex.value); </span>
<a href="#l1.780"></a><span id="l1.780" class="difflineminus">-      treeView.selectionChanged();</span>
<a href="#l1.781"></a><span id="l1.781" class="difflineminus">-</span>
<a href="#l1.782"></a><span id="l1.782" class="difflineminus">-      EnsureRowInThreadTreeIsVisible(startIndex.value); </span>
<a href="#l1.783"></a><span id="l1.783" class="difflineminus">-      UpdateMailSearch(&quot;delete from another view, 1 row now selected&quot;);</span>
<a href="#l1.784"></a><span id="l1.784" class="difflineminus">-    }</span>
<a href="#l1.785"></a><span id="l1.785" class="difflineminus">-    else {</span>
<a href="#l1.786"></a><span id="l1.786" class="difflineminus">-      // this can happen if you have more than 2 messages selected</span>
<a href="#l1.787"></a><span id="l1.787" class="difflineminus">-      // in the search results pane, and you deleted one of them from another view</span>
<a href="#l1.788"></a><span id="l1.788" class="difflineminus">-      // (like the view in the stand alone msg window or the three pane)</span>
<a href="#l1.789"></a><span id="l1.789" class="difflineminus">-      // since multiple messages are still selected, do nothing.</span>
<a href="#l1.790"></a><span id="l1.790" class="difflineminus">-    }</span>
<a href="#l1.791"></a><span id="l1.791" class="difflineminus">-  }</span>
<a href="#l1.792"></a><span id="l1.792" class="difflineminus">-  else {</span>
<a href="#l1.793"></a><span id="l1.793" class="difflineminus">-    if (gNextMessageViewIndexAfterDelete != nsMsgViewIndex_None &amp;&amp; gNextMessageViewIndexAfterDelete &gt;= viewSize) </span>
<a href="#l1.794"></a><span id="l1.794" class="difflineminus">-    {</span>
<a href="#l1.795"></a><span id="l1.795" class="difflineminus">-      if (viewSize &gt; 0)</span>
<a href="#l1.796"></a><span id="l1.796" class="difflineminus">-        gNextMessageViewIndexAfterDelete = viewSize - 1;</span>
<a href="#l1.797"></a><span id="l1.797" class="difflineminus">-      else</span>
<a href="#l1.798"></a><span id="l1.798" class="difflineminus">-      {           </span>
<a href="#l1.799"></a><span id="l1.799" class="difflineminus">-        gNextMessageViewIndexAfterDelete = nsMsgViewIndex_None;</span>
<a href="#l1.800"></a><span id="l1.800" class="difflineminus">-</span>
<a href="#l1.801"></a><span id="l1.801" class="difflineminus">-        // there is nothing to select since viewSize is 0</span>
<a href="#l1.802"></a><span id="l1.802" class="difflineminus">-        treeSelection.clearSelection();</span>
<a href="#l1.803"></a><span id="l1.803" class="difflineminus">-</span>
<a href="#l1.804"></a><span id="l1.804" class="difflineminus">-        UpdateMailSearch(&quot;delete from current view, 0 rows left&quot;);</span>
<a href="#l1.805"></a><span id="l1.805" class="difflineminus">-      }</span>
<a href="#l1.806"></a><span id="l1.806" class="difflineminus">-    }</span>
<a href="#l1.807"></a><span id="l1.807" class="difflineminus">-</span>
<a href="#l1.808"></a><span id="l1.808" class="difflineminus">-    // if we are about to set the selection with a new element then DON'T clear</span>
<a href="#l1.809"></a><span id="l1.809" class="difflineminus">-    // the selection then add the next message to select. This just generates</span>
<a href="#l1.810"></a><span id="l1.810" class="difflineminus">-    // an extra round of command updating notifications that we are trying to</span>
<a href="#l1.811"></a><span id="l1.811" class="difflineminus">-    // optimize away.</span>
<a href="#l1.812"></a><span id="l1.812" class="difflineminus">-    if (gNextMessageViewIndexAfterDelete != nsMsgViewIndex_None) </span>
<a href="#l1.813"></a><span id="l1.813" class="difflineminus">-    {</span>
<a href="#l1.814"></a><span id="l1.814" class="difflineminus">-      treeSelection.select(gNextMessageViewIndexAfterDelete);</span>
<a href="#l1.815"></a><span id="l1.815" class="difflineminus">-      // since gNextMessageViewIndexAfterDelete probably has the same value</span>
<a href="#l1.816"></a><span id="l1.816" class="difflineminus">-      // as the last index we had selected, the tree isn't generating a new</span>
<a href="#l1.817"></a><span id="l1.817" class="difflineminus">-      // selectionChanged notification for the tree view. So we aren't loading the </span>
<a href="#l1.818"></a><span id="l1.818" class="difflineminus">-      // next message. to fix this, force the selection changed update.</span>
<a href="#l1.819"></a><span id="l1.819" class="difflineminus">-      if (treeView)</span>
<a href="#l1.820"></a><span id="l1.820" class="difflineminus">-        treeView.selectionChanged();</span>
<a href="#l1.821"></a><span id="l1.821" class="difflineminus">-</span>
<a href="#l1.822"></a><span id="l1.822" class="difflineminus">-      EnsureRowInThreadTreeIsVisible(gNextMessageViewIndexAfterDelete); </span>
<a href="#l1.823"></a><span id="l1.823" class="difflineminus">-</span>
<a href="#l1.824"></a><span id="l1.824" class="difflineminus">-      // XXX TODO</span>
<a href="#l1.825"></a><span id="l1.825" class="difflineminus">-      // I think there is a bug in the suppression code above.</span>
<a href="#l1.826"></a><span id="l1.826" class="difflineminus">-      // what if I have two rows selected, and I hit delete, </span>
<a href="#l1.827"></a><span id="l1.827" class="difflineminus">-      // and so we load the next row.</span>
<a href="#l1.828"></a><span id="l1.828" class="difflineminus">-      // what if I have commands that only enable where </span>
<a href="#l1.829"></a><span id="l1.829" class="difflineminus">-      // exactly one row is selected?</span>
<a href="#l1.830"></a><span id="l1.830" class="difflineminus">-      UpdateMailSearch(&quot;delete from current view, at least one row selected&quot;);</span>
<a href="#l1.831"></a><span id="l1.831" class="difflineminus">-    }</span>
<a href="#l1.832"></a><span id="l1.832" class="difflineminus">-  }</span>
<a href="#l1.833"></a><span id="l1.833" class="difflineminus">-</span>
<a href="#l1.834"></a><span id="l1.834" class="difflineminus">-  // default value after delete/move/copy is over</span>
<a href="#l1.835"></a><span id="l1.835" class="difflineminus">-  gNextMessageViewIndexAfterDelete = -2;</span>
<a href="#l1.836"></a><span id="l1.836" class="difflineminus">-</span>
<a href="#l1.837"></a><span id="l1.837" class="difflineminus">-  // something might have been deleted, so update the status text</span>
<a href="#l1.838"></a><span id="l1.838" class="difflineminus">-  SetAdvancedSearchStatusText(viewSize);</span>
<a href="#l1.839"></a><span id="l1.839" class="difflineplus">+    gFolderDisplay.hintAboutToDeleteMessages();</span>
<a href="#l1.840"></a><span id="l1.840" class="difflineplus">+    gFolderDisplay.doCommand(aCommandType);</span>
<a href="#l1.841"></a><span id="l1.841"> }</span>
<a href="#l1.842"></a><span id="l1.842"> </span>
<a href="#l1.843"></a><span id="l1.843"> function MoveMessageInSearch(destFolder)</span>
<a href="#l1.844"></a><span id="l1.844"> {</span>
<a href="#l1.845"></a><span id="l1.845" class="difflineminus">-    try {</span>
<a href="#l1.846"></a><span id="l1.846" class="difflineminus">-        // get the msg folder we're moving messages into</span>
<a href="#l1.847"></a><span id="l1.847" class="difflineminus">-        // if the id (uri) is not set, use file-uri which is set for</span>
<a href="#l1.848"></a><span id="l1.848" class="difflineminus">-        // &quot;File Here&quot;</span>
<a href="#l1.849"></a><span id="l1.849" class="difflineminus">-        var destUri = destFolder.getAttribute('id');</span>
<a href="#l1.850"></a><span id="l1.850" class="difflineminus">-        if (destUri.length == 0) { </span>
<a href="#l1.851"></a><span id="l1.851" class="difflineminus">-          destUri = destFolder.getAttribute('file-uri')</span>
<a href="#l1.852"></a><span id="l1.852" class="difflineminus">-        }</span>
<a href="#l1.853"></a><span id="l1.853" class="difflineplus">+  // Get the msg folder we're moving messages into.</span>
<a href="#l1.854"></a><span id="l1.854" class="difflineplus">+  // If the id (uri) is not set, use file-uri which is set for</span>
<a href="#l1.855"></a><span id="l1.855" class="difflineplus">+  // &quot;File Here&quot;.</span>
<a href="#l1.856"></a><span id="l1.856" class="difflineplus">+  let destUri = destFolder.getAttribute('id');</span>
<a href="#l1.857"></a><span id="l1.857" class="difflineplus">+  if (destUri.length == 0)</span>
<a href="#l1.858"></a><span id="l1.858" class="difflineplus">+    destUri = destFolder.getAttribute('file-uri');</span>
<a href="#l1.859"></a><span id="l1.859"> </span>
<a href="#l1.860"></a><span id="l1.860" class="difflineminus">-        var destMsgFolder = GetMsgFolderFromUri(destUri).QueryInterface(Components.interfaces.nsIMsgFolder);</span>
<a href="#l1.861"></a><span id="l1.861" class="difflineplus">+  let destMsgFolder = GetMsgFolderFromUri(destUri).QueryInterface(</span>
<a href="#l1.862"></a><span id="l1.862" class="difflineplus">+                        Components.interfaces.nsIMsgFolder);</span>
<a href="#l1.863"></a><span id="l1.863"> </span>
<a href="#l1.864"></a><span id="l1.864" class="difflineminus">-        // we don't move news messages, we copy them</span>
<a href="#l1.865"></a><span id="l1.865" class="difflineminus">-        if (isNewsURI(gSearchView.getURIForViewIndex(0))) {</span>
<a href="#l1.866"></a><span id="l1.866" class="difflineminus">-          gSearchView.doCommandWithFolder(nsMsgViewCommandType.copyMessages, destMsgFolder);</span>
<a href="#l1.867"></a><span id="l1.867" class="difflineminus">-        }</span>
<a href="#l1.868"></a><span id="l1.868" class="difflineminus">-        else {</span>
<a href="#l1.869"></a><span id="l1.869" class="difflineminus">-            SetNextMessageAfterDelete();</span>
<a href="#l1.870"></a><span id="l1.870" class="difflineminus">-            gSearchView.doCommandWithFolder(nsMsgViewCommandType.moveMessages, destMsgFolder);</span>
<a href="#l1.871"></a><span id="l1.871" class="difflineminus">-        } </span>
<a href="#l1.872"></a><span id="l1.872" class="difflineminus">-    }</span>
<a href="#l1.873"></a><span id="l1.873" class="difflineminus">-    catch (ex) {</span>
<a href="#l1.874"></a><span id="l1.874" class="difflineminus">-        dump(&quot;MsgMoveMessage failed: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l1.875"></a><span id="l1.875" class="difflineminus">-    }   </span>
<a href="#l1.876"></a><span id="l1.876" class="difflineplus">+  // we don't move news messages, we copy them</span>
<a href="#l1.877"></a><span id="l1.877" class="difflineplus">+  if (gFolderDisplay.selectedMessageIsNews) {</span>
<a href="#l1.878"></a><span id="l1.878" class="difflineplus">+    gFolderDisplay.doCommandWithFolder(nsMsgViewCommandType.copyMessages,</span>
<a href="#l1.879"></a><span id="l1.879" class="difflineplus">+                                       destMsgFolder);</span>
<a href="#l1.880"></a><span id="l1.880" class="difflineplus">+  }</span>
<a href="#l1.881"></a><span id="l1.881" class="difflineplus">+  else {</span>
<a href="#l1.882"></a><span id="l1.882" class="difflineplus">+    gFolderDisplay.hintAboutToDeleteMessages();</span>
<a href="#l1.883"></a><span id="l1.883" class="difflineplus">+    gFolderDisplay.doCommandWithFolder(nsMsgViewCommandType.moveMessages,</span>
<a href="#l1.884"></a><span id="l1.884" class="difflineplus">+                                       destMsgFolder);</span>
<a href="#l1.885"></a><span id="l1.885" class="difflineplus">+  }</span>
<a href="#l1.886"></a><span id="l1.886"> }</span>
<a href="#l1.887"></a><span id="l1.887"> </span>
<a href="#l1.888"></a><span id="l1.888"> function GoToFolder()</span>
<a href="#l1.889"></a><span id="l1.889"> {</span>
<a href="#l1.890"></a><span id="l1.890" class="difflineminus">-  var hdr = gSearchView.hdrForFirstSelectedMessage;</span>
<a href="#l1.891"></a><span id="l1.891" class="difflineminus">-  MsgOpenNewWindowForFolder(hdr.folder.URI, hdr.messageKey);</span>
<a href="#l1.892"></a><span id="l1.892" class="difflineplus">+  MsgOpenNewWindowForFolder(gFolderDisplay.selectedMessage);</span>
<a href="#l1.893"></a><span id="l1.893"> }</span>
<a href="#l1.894"></a><span id="l1.894"> </span>
<a href="#l1.895"></a><span id="l1.895"> function BeginDragThreadPane(event)</span>
<a href="#l1.896"></a><span id="l1.896"> {</span>
<a href="#l1.897"></a><span id="l1.897">     // no search pane dnd yet</span>
<a href="#l1.898"></a><span id="l1.898">     return false;</span>
<a href="#l1.899"></a><span id="l1.899"> }</span>
<a href="#l1.900"></a><span id="l1.900"> </span>
<a href="#l1.901"></a><span id="l1.901"> function saveAsVirtualFolder()</span>
<a href="#l1.902"></a><span id="l1.902"> {</span>
<a href="#l1.903"></a><span id="l1.903" class="difflineminus">-  searchFolderURIs = window.arguments[0].folder.URI;</span>
<a href="#l1.904"></a><span id="l1.904" class="difflineplus">+  var searchFolderURIs = window.arguments[0].folder.URI;</span>
<a href="#l1.905"></a><span id="l1.905"> </span>
<a href="#l1.906"></a><span id="l1.906">   var searchSubfolders = document.getElementById(&quot;checkSearchSubFolders&quot;).checked;</span>
<a href="#l1.907"></a><span id="l1.907">   if (gCurrentFolder &amp;&amp; (searchSubfolders || gCurrentFolder.isServer || gCurrentFolder.noSelect))</span>
<a href="#l1.908"></a><span id="l1.908">   {</span>
<a href="#l1.909"></a><span id="l1.909">     var subFolderURIs = AddSubFoldersToURI(gCurrentFolder);</span>
<a href="#l1.910"></a><span id="l1.910">     if (subFolderURIs.length &gt; 0)</span>
<a href="#l1.911"></a><span id="l1.911">       searchFolderURIs += '|' + subFolderURIs;</span>
<a href="#l1.912"></a><span id="l1.912">   }</span>
<a href="#l1.913"></a><span id="l1.913"> </span>
<a href="#l1.914"></a><span id="l1.914">   var dialog = window.openDialog(&quot;chrome://messenger/content/virtualFolderProperties.xul&quot;, &quot;&quot;,</span>
<a href="#l1.915"></a><span id="l1.915">                                  &quot;chrome,titlebar,modal,centerscreen&quot;,</span>
<a href="#l1.916"></a><span id="l1.916" class="difflineminus">-                                 {folder:window.arguments[0].folder,</span>
<a href="#l1.917"></a><span id="l1.917" class="difflineminus">-                                  searchTerms:gSearchSession.searchTerms,</span>
<a href="#l1.918"></a><span id="l1.918" class="difflineplus">+                                 {folder: window.arguments[0].folder,</span>
<a href="#l1.919"></a><span id="l1.919" class="difflineplus">+                                  searchTerms: toXPCOMArray(getSearchTerms(),</span>
<a href="#l1.920"></a><span id="l1.920" class="difflineplus">+                                                            Components.interfaces.nsISupportsArray),</span>
<a href="#l1.921"></a><span id="l1.921">                                   searchFolderURIs: searchFolderURIs});</span>
<a href="#l1.922"></a><span id="l1.922"> }</span>
<a href="#l1.923"></a><span id="l1.923"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/content/SearchDialog.xul</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/content/SearchDialog.xul</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -53,16 +53,18 @@</span>
<a href="#l2.4"></a><span id="l2.4">         style=&quot;width: 52em; height: 34em;&quot;</span>
<a href="#l2.5"></a><span id="l2.5">         persist=&quot;screenX screenY width height sizemode&quot;&gt;</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7">   &lt;stringbundle id=&quot;bundle_search&quot; src=&quot;chrome://messenger/locale/search.properties&quot;/&gt;</span>
<a href="#l2.8"></a><span id="l2.8">   &lt;stringbundle id=&quot;bundle_messenger&quot; src=&quot;chrome://messenger/locale/messenger.properties&quot;/&gt;</span>
<a href="#l2.9"></a><span id="l2.9">   &lt;stringbundle id=&quot;bundle_brand&quot; src=&quot;chrome://branding/locale/brand.properties&quot;/&gt;</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/mailWindow.js&quot;/&gt;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+  &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/folderDisplay.js&quot;/&gt;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+  &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/messageDisplay.js&quot;/&gt;</span>
<a href="#l2.14"></a><span id="l2.14">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/threadPane.js&quot;/&gt;</span>
<a href="#l2.15"></a><span id="l2.15">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/msgMail3PaneWindow.js&quot;/&gt;</span>
<a href="#l2.16"></a><span id="l2.16">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://global/content/globalOverlay.js&quot;/&gt;</span>
<a href="#l2.17"></a><span id="l2.17">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/mailCommands.js&quot;/&gt;</span>
<a href="#l2.18"></a><span id="l2.18">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/mailWindowOverlay.js&quot;/&gt;</span>
<a href="#l2.19"></a><span id="l2.19">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/commandglue.js&quot;/&gt;</span>
<a href="#l2.20"></a><span id="l2.20">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/SearchDialog.js&quot;/&gt;</span>
<a href="#l2.21"></a><span id="l2.21">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/messengerdnd.js&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/base/content/commandglue.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/base/content/commandglue.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,485 +1,111 @@</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineminus">-# -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineminus">-# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineminus">-# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineminus">-#</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineminus">-# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineminus">-# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineminus">-# the License. You may obtain a copy of the License at</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineminus">-# http://www.mozilla.org/MPL/</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-#</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-# for the specific language governing rights and limitations under the</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-# License.</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-#</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-# The Original Code is Mozilla Communicator client code, released</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-# March 31, 1998.</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-#</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-# The Initial Developer of the Original Code is</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-# Netscape Communications Corporation.</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-# Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineminus">-# the Initial Developer. All Rights Reserved.</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineminus">-#</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-# Contributor(s):</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-#   Jan Varga &lt;varga@nixcorp.com&gt;</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-#   Hkan Waara (hwaara@chello.se)</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-#   David Bienvenu (bienvenu@nventure.com)</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-#   Jeremy Morton (bugzilla@game-point.net)</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-#</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-# either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-# the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineminus">-# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineminus">-# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">-# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineminus">-# the provisions above, a recipient may use your version of this file under</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">-#</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineminus">-# ***** END LICENSE BLOCK *****</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+ *</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+ *</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+ * License.</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+ *</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+ * The Original Code is Mozilla Communicator client code, released</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+ * March 31, 1998.</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+ *</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+ * Netscape Communications Corporation.</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+ *</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+ * Contributor(s):</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+ *   Jan Varga &lt;varga@nixcorp.com&gt;</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+ *   Hkan Waara (hwaara@chello.se)</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+ *   David Bienvenu (bienvenu@nventure.com)</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+ *   Jeremy Morton (bugzilla@game-point.net)</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+ *</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+ *</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+</span>
<a href="#l3.87"></a><span id="l3.87"> /*</span>
<a href="#l3.88"></a><span id="l3.88">  * Command-specific code. This stuff should be called by the widgets</span>
<a href="#l3.89"></a><span id="l3.89">  */</span>
<a href="#l3.90"></a><span id="l3.90"> </span>
<a href="#l3.91"></a><span id="l3.91"> Components.utils.import(&quot;resource://gre/modules/iteratorUtils.jsm&quot;);</span>
<a href="#l3.92"></a><span id="l3.92"> </span>
<a href="#l3.93"></a><span id="l3.93"> //NOTE: gMessengerBundle and gBrandBundle must be defined and set</span>
<a href="#l3.94"></a><span id="l3.94"> //      for this Overlay to work properly</span>
<a href="#l3.95"></a><span id="l3.95"> </span>
<a href="#l3.96"></a><span id="l3.96" class="difflineminus">-var gFolderJustSwitched = false;</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineminus">-var gVirtualFolderTerms;</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineminus">-var gXFVirtualFolderTerms;</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineminus">-var gCurrentVirtualFolderUri;</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineminus">-var gPrevFolderFlags;</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineminus">-var gPrevSelectedFolder;</span>
<a href="#l3.102"></a><span id="l3.102"> var gMsgFolderSelected;</span>
<a href="#l3.103"></a><span id="l3.103"> </span>
<a href="#l3.104"></a><span id="l3.104" class="difflineminus">-function setTitleFromFolder(msgfolder, subject)</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineminus">-{</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineminus">-    var wintype = document.documentElement.getAttribute('windowtype');</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineminus">-    var title; </span>
<a href="#l3.108"></a><span id="l3.108" class="difflineminus">-</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineminus">-    // If we are showing the mail:3pane. Never include the subject of the selected</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineminus">-    // message in the title. (&quot;Inbox - My Mail - Mozilla Thunderbird&quot;)</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineminus">-    // If we are a stand alone message window, we should show the Subject</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineminus">-    // and the product but not the account name: &quot;Re: New window Title - Mozilla Thunderbird&quot;</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineminus">-</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineminus">-    if (wintype == &quot;mail:messageWindow&quot;)  </span>
<a href="#l3.115"></a><span id="l3.115" class="difflineminus">-      title = subject ? subject : &quot;&quot;;</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineminus">-    else if (msgfolder)</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineminus">-    {</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineminus">-      title = msgfolder.prettyName;</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineminus">-</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineminus">-      if (!msgfolder.isServer)</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineminus">-      {</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineminus">-        var server = msgfolder.server;</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineminus">-        var middle;</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineminus">-        var end;</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineminus">-        if (server.type == &quot;nntp&quot;) {</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineminus">-            // &lt;folder&gt; on &lt;hostname&gt;</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineminus">-            middle = gMessengerBundle.getString(&quot;titleNewsPreHost&quot;);</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineminus">-            end = server.hostName;</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineminus">-        }</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineminus">-        else {</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineminus">-          // &lt;folder&gt; - &lt;server.prettyName&gt;</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineminus">-          middle = &quot;-&quot;;</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineminus">-          end = server.prettyName;</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineminus">-        }</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineminus">-        if (middle) title += &quot; &quot; + middle;</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineminus">-        if (end) title += &quot; &quot; + end;</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineminus">-      }</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineminus">-    }</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineminus">-</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineminus">-#ifndef XP_MACOSX</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineminus">-    title += &quot; - &quot; + gBrandBundle.getString(&quot;brandFullName&quot;);</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineminus">-#endif</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineminus">-    document.title = title;</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineminus">-}</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineminus">-</span>
<a href="#l3.146"></a><span id="l3.146"> function UpdateMailToolbar(caller)</span>
<a href="#l3.147"></a><span id="l3.147"> {</span>
<a href="#l3.148"></a><span id="l3.148">   //dump(&quot;XXX update mail-toolbar &quot; + caller + &quot;\n&quot;);</span>
<a href="#l3.149"></a><span id="l3.149">   document.commandDispatcher.updateCommands('mail-toolbar');</span>
<a href="#l3.150"></a><span id="l3.150"> </span>
<a href="#l3.151"></a><span id="l3.151">   // hook for extra toolbar items</span>
<a href="#l3.152"></a><span id="l3.152">   var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;].getService(Components.interfaces.nsIObserverService);</span>
<a href="#l3.153"></a><span id="l3.153">   observerService.notifyObservers(window, &quot;mail:updateToolbarItems&quot;, null);</span>
<a href="#l3.154"></a><span id="l3.154"> }</span>
<a href="#l3.155"></a><span id="l3.155"> </span>
<a href="#l3.156"></a><span id="l3.156" class="difflineminus">-/**</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineminus">- * @param   folder                - If viewFolder is a single folder saved</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineminus">-                                  - search, this folder is the scope of the</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineminus">-                                  - saved search, the real, underlying folder.</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineminus">-                                  - Otherwise, it's the same as the viewFolder.</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineminus">- * @param   viewFolder            - nsIMsgFolder selected in the folder pane.</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineminus">-                                  - Will be the same as folder, except if</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineminus">-                                  - it's a single folder saved search.</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineminus">- * @param   viewType              - nsMsgViewType (see nsIMsgDBView.idl)</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineminus">- * @param   viewFlags             - nsMsgViewFlagsType (see nsIMsgDBView.idl)</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineminus">- * @param   sortType              - nsMsgViewSortType (see nsIMsgDBView.idl)</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineminus">- * @param   sortOrder             - nsMsgViewSortOrder (see nsIMsgDBView.idl)</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineminus">- **/</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineminus">-function ChangeFolder(folder, viewFolder, viewType, viewFlags, sortType, sortOrder)</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineminus">-{</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineminus">-  if (folder.URI == gCurrentLoadingFolderURI)</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineminus">-    return;</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineminus">-</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineminus">-  // hook for extra toolbar items</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineminus">-  var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;].getService(Components.interfaces.nsIObserverService);</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineminus">-  observerService.notifyObservers(window, &quot;mail:setupToolbarItems&quot;, folder.URI);</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineminus">-</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineminus">-  try {</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineminus">-      setTitleFromFolder(viewFolder, null);</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineminus">-  } catch (ex) {</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineminus">-      dump(&quot;error setting title: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineminus">-  }</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineminus">-</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineminus">-  //if it's a server, clear the threadpane and don't bother trying to load.</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineminus">-  if(folder.isServer)</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineminus">-  {</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineminus">-    msgWindow.openFolder = null;</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineminus">-    ClearThreadPane();</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineminus">-    UpdateStatusQuota(null);</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineminus">-    // Load AccountCentral page here.</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineminus">-    ShowAccountCentral();</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineminus">-    return;</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineminus">-  }</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineminus">-  else</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineminus">-  {</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineminus">-    if (folder.server.displayStartupPage)</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineminus">-    {</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineminus">-      gDisplayStartupPage = true;</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineminus">-      folder.server.displayStartupPage = false;</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineminus">-    }</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineminus">-  }</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineminus">-</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineminus">-  // If the user clicks on msgfolder, time to display thread pane and message pane.</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineminus">-  ShowThreadPane();</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineminus">-</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineminus">-  gCurrentLoadingFolderURI = folder.URI;</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineminus">-  gNextMessageAfterDelete = null; // forget what message to select, if any</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineminus">-</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineminus">-  gCurrentFolderToReroot = folder.URI;</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineminus">-  gCurrentLoadingFolderViewFlags = viewFlags;</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineminus">-  gCurrentLoadingFolderViewType = viewType;</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineminus">-  gCurrentLoadingFolderSortType = sortType;</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineminus">-  gCurrentLoadingFolderSortOrder = sortOrder;</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineminus">-</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineminus">-  var showMessagesAfterLoading;</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineminus">-  try {</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineminus">-    var server = folder.server;</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineminus">-    if (gPrefBranch.getBoolPref(&quot;mail.password_protect_local_cache&quot;))</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineminus">-    {</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineminus">-      showMessagesAfterLoading = server.passwordPromptRequired;</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineminus">-      // servers w/o passwords (like local mail) will always be non-authenticated.</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineminus">-      // So we need to use the account manager for that case.</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineminus">-    }</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineminus">-    else</span>
<a href="#l3.225"></a><span id="l3.225" class="difflineminus">-      showMessagesAfterLoading = false;</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineminus">-  }</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineminus">-  catch (ex) {</span>
<a href="#l3.228"></a><span id="l3.228" class="difflineminus">-    showMessagesAfterLoading = false;</span>
<a href="#l3.229"></a><span id="l3.229" class="difflineminus">-  }</span>
<a href="#l3.230"></a><span id="l3.230" class="difflineminus">-</span>
<a href="#l3.231"></a><span id="l3.231" class="difflineminus">-  if (viewType != nsMsgViewType.eShowVirtualFolderResults &amp;&amp; (folder.manyHeadersToDownload || showMessagesAfterLoading))</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineminus">-  {</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineminus">-    gRerootOnFolderLoad = true;</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineminus">-    try</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineminus">-    {</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineminus">-      ClearThreadPane();</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineminus">-      SetBusyCursor(window, true);</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineminus">-      folder.startFolderLoading();</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineminus">-      folder.updateFolder(msgWindow);</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineminus">-    }</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineminus">-    catch(ex)</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineminus">-    {</span>
<a href="#l3.243"></a><span id="l3.243" class="difflineminus">-      SetBusyCursor(window, false);</span>
<a href="#l3.244"></a><span id="l3.244" class="difflineminus">-      dump(&quot;Error loading with many headers to download: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l3.245"></a><span id="l3.245" class="difflineminus">-    }</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineminus">-  }</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineminus">-  else</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineminus">-  {</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineminus">-    if (viewType != nsMsgViewType.eShowVirtualFolderResults)</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineminus">-      SetBusyCursor(window, true);</span>
<a href="#l3.251"></a><span id="l3.251" class="difflineminus">-    RerootFolder(folder.URI, folder, viewType, viewFlags, sortType, sortOrder);</span>
<a href="#l3.252"></a><span id="l3.252" class="difflineminus">-    gRerootOnFolderLoad = false;</span>
<a href="#l3.253"></a><span id="l3.253" class="difflineminus">-    folder.startFolderLoading();</span>
<a href="#l3.254"></a><span id="l3.254" class="difflineminus">-</span>
<a href="#l3.255"></a><span id="l3.255" class="difflineminus">-    //Need to do this after rerooting folder.  Otherwise possibility of receiving folder loaded</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineminus">-    //notification before folder has actually changed.</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineminus">-    if (viewType != nsMsgViewType.eShowVirtualFolderResults)</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineminus">-      folder.updateFolder(msgWindow);</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineminus">-  }</span>
<a href="#l3.260"></a><span id="l3.260" class="difflineminus">-}</span>
<a href="#l3.261"></a><span id="l3.261" class="difflineminus">-</span>
<a href="#l3.262"></a><span id="l3.262"> function isNewsURI(uri)</span>
<a href="#l3.263"></a><span id="l3.263"> {</span>
<a href="#l3.264"></a><span id="l3.264">     if (!uri || uri[0] != 'n') {</span>
<a href="#l3.265"></a><span id="l3.265">         return false;</span>
<a href="#l3.266"></a><span id="l3.266">     }</span>
<a href="#l3.267"></a><span id="l3.267">     else {</span>
<a href="#l3.268"></a><span id="l3.268">         return ((uri.substring(0,6) == &quot;news:/&quot;) || (uri.substring(0,14) == &quot;news-message:/&quot;));</span>
<a href="#l3.269"></a><span id="l3.269">     }</span>
<a href="#l3.270"></a><span id="l3.270"> }</span>
<a href="#l3.271"></a><span id="l3.271"> </span>
<a href="#l3.272"></a><span id="l3.272" class="difflineminus">-function UpdateColumnsForView(folder, viewType)</span>
<a href="#l3.273"></a><span id="l3.273" class="difflineminus">-{</span>
<a href="#l3.274"></a><span id="l3.274" class="difflineminus">-  const nsMsgFolderFlags = Components.interfaces.nsMsgFolderFlags;</span>
<a href="#l3.275"></a><span id="l3.275" class="difflineminus">-  // if this is the drafts, sent, or send later folder,</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineminus">-  // we show &quot;Recipient&quot; instead of &quot;Author&quot;</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineminus">-  SetSentFolderColumns(IsSpecialFolder(folder, nsMsgFolderFlags.SentMail | nsMsgFolderFlags.Drafts | nsMsgFolderFlags.Queue, true));</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineminus">-  ShowLocationColumn(viewType == nsMsgViewType.eShowVirtualFolderResults);</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineminus">-  // Only show 'Received' column for e-mails.  For newsgroup messages, the 'Date' header is as reliable as an e-mail's</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineminus">-  // 'Received' header, as it is replaced with the news server's (more reliable) date.</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineminus">-  UpdateReceivedColumn(folder);</span>
<a href="#l3.282"></a><span id="l3.282" class="difflineminus">-}</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineminus">-</span>
<a href="#l3.284"></a><span id="l3.284" class="difflineminus">-function RerootFolder(uri, newFolder, viewType, viewFlags, sortType, sortOrder)</span>
<a href="#l3.285"></a><span id="l3.285" class="difflineminus">-{</span>
<a href="#l3.286"></a><span id="l3.286" class="difflineminus">-  viewDebug(&quot;In reroot folder, sortType = &quot; +  sortType + &quot;viewType = &quot; + viewType + &quot;\n&quot;);</span>
<a href="#l3.287"></a><span id="l3.287" class="difflineminus">-</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineminus">-  if (sortType == 0)</span>
<a href="#l3.289"></a><span id="l3.289" class="difflineminus">-  {</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineminus">-    try</span>
<a href="#l3.291"></a><span id="l3.291" class="difflineminus">-    {</span>
<a href="#l3.292"></a><span id="l3.292" class="difflineminus">-      var dbFolderInfo = newFolder.msgDatabase.dBFolderInfo;</span>
<a href="#l3.293"></a><span id="l3.293" class="difflineminus">-      sortType = dbFolderInfo.sortType;</span>
<a href="#l3.294"></a><span id="l3.294" class="difflineminus">-      sortOrder = dbFolderInfo.sortOrder;</span>
<a href="#l3.295"></a><span id="l3.295" class="difflineminus">-      viewFlags = dbFolderInfo.viewFlags;</span>
<a href="#l3.296"></a><span id="l3.296" class="difflineminus">-      viewType = dbFolderInfo.viewType;</span>
<a href="#l3.297"></a><span id="l3.297" class="difflineminus">-      dbFolderInfo = null;</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineminus">-    }</span>
<a href="#l3.299"></a><span id="l3.299" class="difflineminus">-    catch(ex)</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineminus">-    {</span>
<a href="#l3.301"></a><span id="l3.301" class="difflineminus">-      dump(&quot;invalid db in RerootFolder: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l3.302"></a><span id="l3.302" class="difflineminus">-    }</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineminus">-  }</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineminus">-</span>
<a href="#l3.305"></a><span id="l3.305" class="difflineminus">-  // workaround for #39655</span>
<a href="#l3.306"></a><span id="l3.306" class="difflineminus">-  gFolderJustSwitched = true;</span>
<a href="#l3.307"></a><span id="l3.307" class="difflineminus">-</span>
<a href="#l3.308"></a><span id="l3.308" class="difflineminus">-  ClearThreadPaneSelection();</span>
<a href="#l3.309"></a><span id="l3.309" class="difflineminus">-</span>
<a href="#l3.310"></a><span id="l3.310" class="difflineminus">-  //Clear the new messages of the old folder</span>
<a href="#l3.311"></a><span id="l3.311" class="difflineminus">-  var oldFolder = gPrevSelectedFolder;</span>
<a href="#l3.312"></a><span id="l3.312" class="difflineminus">-  if (oldFolder) {</span>
<a href="#l3.313"></a><span id="l3.313" class="difflineminus">-    oldFolder.clearNewMessages();</span>
<a href="#l3.314"></a><span id="l3.314" class="difflineminus">-    oldFolder.hasNewMessages = false;</span>
<a href="#l3.315"></a><span id="l3.315" class="difflineminus">-  }</span>
<a href="#l3.316"></a><span id="l3.316" class="difflineminus">-</span>
<a href="#l3.317"></a><span id="l3.317" class="difflineminus">-  //Set the window's new open folder.</span>
<a href="#l3.318"></a><span id="l3.318" class="difflineminus">-  msgWindow.openFolder = newFolder;</span>
<a href="#l3.319"></a><span id="l3.319" class="difflineminus">-</span>
<a href="#l3.320"></a><span id="l3.320" class="difflineminus">-  //the new folder being selected should have its biff state get cleared.</span>
<a href="#l3.321"></a><span id="l3.321" class="difflineminus">-  if(newFolder)</span>
<a href="#l3.322"></a><span id="l3.322" class="difflineminus">-  {</span>
<a href="#l3.323"></a><span id="l3.323" class="difflineminus">-    newFolder.biffState =</span>
<a href="#l3.324"></a><span id="l3.324" class="difflineminus">-          Components.interfaces.nsIMsgFolder.nsMsgBiffState_NoMail;</span>
<a href="#l3.325"></a><span id="l3.325" class="difflineminus">-  }</span>
<a href="#l3.326"></a><span id="l3.326" class="difflineminus">-</span>
<a href="#l3.327"></a><span id="l3.327" class="difflineminus">-  //Clear out the thread pane so that we can sort it with the new sort id without taking any time.</span>
<a href="#l3.328"></a><span id="l3.328" class="difflineminus">-  // folder.setAttribute('ref', &quot;&quot;);</span>
<a href="#l3.329"></a><span id="l3.329" class="difflineminus">-</span>
<a href="#l3.330"></a><span id="l3.330" class="difflineminus">-  // null this out, so we don't try sort.</span>
<a href="#l3.331"></a><span id="l3.331" class="difflineminus">-  if (gDBView) {</span>
<a href="#l3.332"></a><span id="l3.332" class="difflineminus">-    gDBView.close();</span>
<a href="#l3.333"></a><span id="l3.333" class="difflineminus">-    gDBView = null;</span>
<a href="#l3.334"></a><span id="l3.334" class="difflineminus">-  }</span>
<a href="#l3.335"></a><span id="l3.335" class="difflineminus">-</span>
<a href="#l3.336"></a><span id="l3.336" class="difflineminus">-  // cancel the pending mark as read timer</span>
<a href="#l3.337"></a><span id="l3.337" class="difflineminus">-  ClearPendingReadTimer();</span>
<a href="#l3.338"></a><span id="l3.338" class="difflineminus">-</span>
<a href="#l3.339"></a><span id="l3.339" class="difflineminus">-  UpdateColumnsForView(newFolder, viewType);</span>
<a href="#l3.340"></a><span id="l3.340" class="difflineminus">-  // now create the db view, which will sort it.</span>
<a href="#l3.341"></a><span id="l3.341" class="difflineminus">-  CreateDBView(newFolder, viewType, viewFlags, sortType, sortOrder);</span>
<a href="#l3.342"></a><span id="l3.342" class="difflineminus">-</span>
<a href="#l3.343"></a><span id="l3.343" class="difflineminus">-  if (oldFolder)</span>
<a href="#l3.344"></a><span id="l3.344" class="difflineminus">-  {</span>
<a href="#l3.345"></a><span id="l3.345" class="difflineminus">-    /* we don't null out the db reference for inbox because inbox is like the &quot;main&quot; folder</span>
<a href="#l3.346"></a><span id="l3.346" class="difflineminus">-               and performance outweighs footprint*/</span>
<a href="#l3.347"></a><span id="l3.347" class="difflineminus">-    if (!IsSpecialFolder(oldFolder, Components.interfaces.nsMsgFolderFlags.Inbox, false))</span>
<a href="#l3.348"></a><span id="l3.348" class="difflineminus">-    {</span>
<a href="#l3.349"></a><span id="l3.349" class="difflineminus">-      if (oldFolder.URI != newFolder.URI)</span>
<a href="#l3.350"></a><span id="l3.350" class="difflineminus">-        oldFolder.msgDatabase = null;</span>
<a href="#l3.351"></a><span id="l3.351" class="difflineminus">-    }</span>
<a href="#l3.352"></a><span id="l3.352" class="difflineminus">-  }</span>
<a href="#l3.353"></a><span id="l3.353" class="difflineminus">-  // that should have initialized gDBView, now re-root the thread pane</span>
<a href="#l3.354"></a><span id="l3.354" class="difflineminus">-  RerootThreadPane();</span>
<a href="#l3.355"></a><span id="l3.355" class="difflineminus">-  SetUpToolbarButtons(uri);</span>
<a href="#l3.356"></a><span id="l3.356" class="difflineminus">-  UpdateStatusMessageCounts(gMsgFolderSelected);</span>
<a href="#l3.357"></a><span id="l3.357" class="difflineminus">-  </span>
<a href="#l3.358"></a><span id="l3.358" class="difflineminus">-  // hook for extra toolbar items</span>
<a href="#l3.359"></a><span id="l3.359" class="difflineminus">-  var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;].getService(Components.interfaces.nsIObserverService);</span>
<a href="#l3.360"></a><span id="l3.360" class="difflineminus">-  observerService.notifyObservers(window, &quot;mail:updateToolbarItems&quot;, null);</span>
<a href="#l3.361"></a><span id="l3.361" class="difflineminus">-  // this is to kick off cross-folder searches for virtual folders.</span>
<a href="#l3.362"></a><span id="l3.362" class="difflineminus">-  if (gSearchSession &amp;&amp; !gVirtualFolderTerms) // another var might be better...</span>
<a href="#l3.363"></a><span id="l3.363" class="difflineminus">-  {</span>
<a href="#l3.364"></a><span id="l3.364" class="difflineminus">-    viewDebug(&quot;doing a xf folder search in rerootFolder\n&quot;);</span>
<a href="#l3.365"></a><span id="l3.365" class="difflineminus">-    gCurrentLoadingFolderURI = &quot;&quot;</span>
<a href="#l3.366"></a><span id="l3.366" class="difflineminus">-    ViewChangeByFolder(newFolder);</span>
<a href="#l3.367"></a><span id="l3.367" class="difflineminus">-    gPreQuickSearchView = null; // don't remember the cross folder search</span>
<a href="#l3.368"></a><span id="l3.368" class="difflineminus">-    ScrollToMessageAfterFolderLoad(newFolder);</span>
<a href="#l3.369"></a><span id="l3.369" class="difflineminus">-  }</span>
<a href="#l3.370"></a><span id="l3.370" class="difflineminus">-}</span>
<a href="#l3.371"></a><span id="l3.371" class="difflineminus">-</span>
<a href="#l3.372"></a><span id="l3.372"> function SwitchView(command)</span>
<a href="#l3.373"></a><span id="l3.373"> {</span>
<a href="#l3.374"></a><span id="l3.374">   // when switching thread views, we might be coming out of quick search</span>
<a href="#l3.375"></a><span id="l3.375">   // or a message view.</span>
<a href="#l3.376"></a><span id="l3.376">   // first set view picker to all</span>
<a href="#l3.377"></a><span id="l3.377" class="difflineminus">-  if (gCurrentViewValue != kViewItemAll)</span>
<a href="#l3.378"></a><span id="l3.378" class="difflineminus">-    ViewChangeByValue(kViewItemAll);</span>
<a href="#l3.379"></a><span id="l3.379" class="difflineplus">+  if (gFolderDisplay.view.mailViewIndex != kViewItemAll)</span>
<a href="#l3.380"></a><span id="l3.380" class="difflineplus">+    gFolderDisplay.view.setMailView(kViewItemAll);</span>
<a href="#l3.381"></a><span id="l3.381"> </span>
<a href="#l3.382"></a><span id="l3.382" class="difflineminus">-  // clear the QS text, if we need to</span>
<a href="#l3.383"></a><span id="l3.383" class="difflineminus">-  ClearQSIfNecessary();</span>
<a href="#l3.384"></a><span id="l3.384" class="difflineminus">-  </span>
<a href="#l3.385"></a><span id="l3.385" class="difflineminus">-  var oldSortType, oldSortOrder, viewFlags, viewType, db;</span>
<a href="#l3.386"></a><span id="l3.386" class="difflineminus">-  // now switch views</span>
<a href="#l3.387"></a><span id="l3.387" class="difflineminus">-  if (gDBView) </span>
<a href="#l3.388"></a><span id="l3.388" class="difflineminus">-  {</span>
<a href="#l3.389"></a><span id="l3.389" class="difflineminus">-    oldSortType = gDBView.sortType;</span>
<a href="#l3.390"></a><span id="l3.390" class="difflineminus">-    oldSortOrder = gDBView.sortOrder;</span>
<a href="#l3.391"></a><span id="l3.391" class="difflineminus">-    viewFlags = gDBView.viewFlags;</span>
<a href="#l3.392"></a><span id="l3.392" class="difflineminus">-    viewType = gDBView.viewType;</span>
<a href="#l3.393"></a><span id="l3.393" class="difflineminus">-    db = gDBView.db;</span>
<a href="#l3.394"></a><span id="l3.394" class="difflineminus">-    gDBView.close();</span>
<a href="#l3.395"></a><span id="l3.395" class="difflineminus">-    gDBView = null; </span>
<a href="#l3.396"></a><span id="l3.396" class="difflineminus">-  }</span>
<a href="#l3.397"></a><span id="l3.397" class="difflineminus">-  else</span>
<a href="#l3.398"></a><span id="l3.398" class="difflineminus">-  {</span>
<a href="#l3.399"></a><span id="l3.399" class="difflineminus">-    oldSortType = nsMsgViewSortType.byThread;</span>
<a href="#l3.400"></a><span id="l3.400" class="difflineminus">-    oldSortOrder = nsMsgViewSortOrder.ascending;</span>
<a href="#l3.401"></a><span id="l3.401" class="difflineminus">-    viewFlags = gCurViewFlags;</span>
<a href="#l3.402"></a><span id="l3.402" class="difflineminus">-    viewType = nsMsgViewType.eShowAllThreads;</span>
<a href="#l3.403"></a><span id="l3.403" class="difflineminus">-    db = null;</span>
<a href="#l3.404"></a><span id="l3.404" class="difflineminus">-  }</span>
<a href="#l3.405"></a><span id="l3.405">   switch(command)</span>
<a href="#l3.406"></a><span id="l3.406">   {</span>
<a href="#l3.407"></a><span id="l3.407">     // &quot;All&quot; threads and &quot;Unread&quot; threads don't change threading state</span>
<a href="#l3.408"></a><span id="l3.408">     case &quot;cmd_viewAllMsgs&quot;:</span>
<a href="#l3.409"></a><span id="l3.409" class="difflineminus">-      viewType = nsMsgViewType.eShowAllThreads;</span>
<a href="#l3.410"></a><span id="l3.410" class="difflineminus">-      viewFlags = viewFlags &amp; ~nsMsgViewFlagsType.kUnreadOnly;</span>
<a href="#l3.411"></a><span id="l3.411" class="difflineplus">+      gFolderDisplay.view.showUnreadOnly = false;</span>
<a href="#l3.412"></a><span id="l3.412">       break;</span>
<a href="#l3.413"></a><span id="l3.413">     case &quot;cmd_viewUnreadMsgs&quot;:</span>
<a href="#l3.414"></a><span id="l3.414" class="difflineminus">-      viewType = nsMsgViewType.eShowAllThreads;</span>
<a href="#l3.415"></a><span id="l3.415" class="difflineminus">-      viewFlags = viewFlags | nsMsgViewFlagsType.kUnreadOnly;</span>
<a href="#l3.416"></a><span id="l3.416" class="difflineplus">+      gFolderDisplay.view.showUnreadOnly = true;</span>
<a href="#l3.417"></a><span id="l3.417">       break;</span>
<a href="#l3.418"></a><span id="l3.418">     // &quot;Threads with Unread&quot; and &quot;Watched Threads with Unread&quot; force threading</span>
<a href="#l3.419"></a><span id="l3.419">     case &quot;cmd_viewWatchedThreadsWithUnread&quot;:</span>
<a href="#l3.420"></a><span id="l3.420" class="difflineminus">-      viewType = nsMsgViewType.eShowWatchedThreadsWithUnread;</span>
<a href="#l3.421"></a><span id="l3.421" class="difflineminus">-      viewFlags |= nsMsgViewFlagsType.kThreadedDisplay;</span>
<a href="#l3.422"></a><span id="l3.422" class="difflineplus">+      gFolderDisplay.view.specialViewWatchedThreadsWithUnread = true;</span>
<a href="#l3.423"></a><span id="l3.423">       break;</span>
<a href="#l3.424"></a><span id="l3.424">     case &quot;cmd_viewThreadsWithUnread&quot;:</span>
<a href="#l3.425"></a><span id="l3.425" class="difflineminus">-      viewType = nsMsgViewType.eShowThreadsWithUnread;</span>
<a href="#l3.426"></a><span id="l3.426" class="difflineminus">-      viewFlags |= nsMsgViewFlagsType.kThreadedDisplay;</span>
<a href="#l3.427"></a><span id="l3.427" class="difflineplus">+      gFolderDisplay.view.specialViewThreadsWithUnread = true;</span>
<a href="#l3.428"></a><span id="l3.428">       break;</span>
<a href="#l3.429"></a><span id="l3.429">     // &quot;Ignored Threads&quot; toggles 'ignored' inclusion --</span>
<a href="#l3.430"></a><span id="l3.430">     //   but it also resets 'With Unread' views to 'All'</span>
<a href="#l3.431"></a><span id="l3.431">     case &quot;cmd_viewIgnoredThreads&quot;:</span>
<a href="#l3.432"></a><span id="l3.432" class="difflineminus">-      viewType = nsMsgViewType.eShowAllThreads;</span>
<a href="#l3.433"></a><span id="l3.433" class="difflineminus">-      if (viewFlags &amp; nsMsgViewFlagsType.kShowIgnored)</span>
<a href="#l3.434"></a><span id="l3.434" class="difflineminus">-        viewFlags = viewFlags &amp; ~nsMsgViewFlagsType.kShowIgnored;</span>
<a href="#l3.435"></a><span id="l3.435" class="difflineminus">-      else</span>
<a href="#l3.436"></a><span id="l3.436" class="difflineminus">-        viewFlags = viewFlags | nsMsgViewFlagsType.kShowIgnored;</span>
<a href="#l3.437"></a><span id="l3.437" class="difflineplus">+      gFolderDisplay.view.showIgnored = !gFolderDisplay.view.showIgnored;</span>
<a href="#l3.438"></a><span id="l3.438">       break;</span>
<a href="#l3.439"></a><span id="l3.439">   }</span>
<a href="#l3.440"></a><span id="l3.440" class="difflineminus">-</span>
<a href="#l3.441"></a><span id="l3.441" class="difflineminus">-  if (db &amp;&amp; viewType == nsMsgViewType.eShowVirtualFolderResults)</span>
<a href="#l3.442"></a><span id="l3.442" class="difflineminus">-  {</span>
<a href="#l3.443"></a><span id="l3.443" class="difflineminus">-      db.dBFolderInfo.viewFlags = viewFlags;</span>
<a href="#l3.444"></a><span id="l3.444" class="difflineminus">-      gMsgFolderSelected = null;</span>
<a href="#l3.445"></a><span id="l3.445" class="difflineminus">-      msgWindow.openFolder = null;</span>
<a href="#l3.446"></a><span id="l3.446" class="difflineminus">-      FolderPaneSelectionChange();</span>
<a href="#l3.447"></a><span id="l3.447" class="difflineminus">-      LoadCurrentlyDisplayedMessage();</span>
<a href="#l3.448"></a><span id="l3.448" class="difflineminus">-  }</span>
<a href="#l3.449"></a><span id="l3.449" class="difflineminus">-  else</span>
<a href="#l3.450"></a><span id="l3.450" class="difflineminus">-  {</span>
<a href="#l3.451"></a><span id="l3.451" class="difflineminus">-    CreateDBView(msgWindow.openFolder, viewType, viewFlags, oldSortType,</span>
<a href="#l3.452"></a><span id="l3.452" class="difflineminus">-                 oldSortOrder);</span>
<a href="#l3.453"></a><span id="l3.453" class="difflineminus">-  RerootThreadPane();</span>
<a href="#l3.454"></a><span id="l3.454" class="difflineminus">-  }</span>
<a href="#l3.455"></a><span id="l3.455" class="difflineminus">-}</span>
<a href="#l3.456"></a><span id="l3.456" class="difflineminus">-</span>
<a href="#l3.457"></a><span id="l3.457" class="difflineminus">-function SetSentFolderColumns(isSentFolder)</span>
<a href="#l3.458"></a><span id="l3.458" class="difflineminus">-{</span>
<a href="#l3.459"></a><span id="l3.459" class="difflineminus">-  var tree = GetThreadTree();</span>
<a href="#l3.460"></a><span id="l3.460" class="difflineminus">-</span>
<a href="#l3.461"></a><span id="l3.461" class="difflineminus">-  var lastFolderSent = tree.getAttribute(&quot;lastfoldersent&quot;) == &quot;true&quot;;</span>
<a href="#l3.462"></a><span id="l3.462" class="difflineminus">-  if (isSentFolder != lastFolderSent)</span>
<a href="#l3.463"></a><span id="l3.463" class="difflineminus">-  {</span>
<a href="#l3.464"></a><span id="l3.464" class="difflineminus">-    var senderColumn = document.getElementById(&quot;senderCol&quot;);</span>
<a href="#l3.465"></a><span id="l3.465" class="difflineminus">-    var recipientColumn = document.getElementById(&quot;recipientCol&quot;);</span>
<a href="#l3.466"></a><span id="l3.466" class="difflineminus">-    </span>
<a href="#l3.467"></a><span id="l3.467" class="difflineminus">-    var saveHidden = senderColumn.getAttribute(&quot;hidden&quot;);</span>
<a href="#l3.468"></a><span id="l3.468" class="difflineminus">-    senderColumn.setAttribute(&quot;hidden&quot;, senderColumn.getAttribute(&quot;swappedhidden&quot;));</span>
<a href="#l3.469"></a><span id="l3.469" class="difflineminus">-    senderColumn.setAttribute(&quot;swappedhidden&quot;, saveHidden);</span>
<a href="#l3.470"></a><span id="l3.470" class="difflineminus">-</span>
<a href="#l3.471"></a><span id="l3.471" class="difflineminus">-    saveHidden = recipientColumn.getAttribute(&quot;hidden&quot;);</span>
<a href="#l3.472"></a><span id="l3.472" class="difflineminus">-    recipientColumn.setAttribute(&quot;hidden&quot;, recipientColumn.getAttribute(&quot;swappedhidden&quot;));</span>
<a href="#l3.473"></a><span id="l3.473" class="difflineminus">-    recipientColumn.setAttribute(&quot;swappedhidden&quot;, saveHidden);</span>
<a href="#l3.474"></a><span id="l3.474" class="difflineminus">-  }</span>
<a href="#l3.475"></a><span id="l3.475" class="difflineminus">-</span>
<a href="#l3.476"></a><span id="l3.476" class="difflineminus">-  if(isSentFolder)</span>
<a href="#l3.477"></a><span id="l3.477" class="difflineminus">-    tree.setAttribute(&quot;lastfoldersent&quot;, &quot;true&quot;);</span>
<a href="#l3.478"></a><span id="l3.478" class="difflineminus">-  else</span>
<a href="#l3.479"></a><span id="l3.479" class="difflineminus">-    tree.setAttribute(&quot;lastfoldersent&quot;, &quot;false&quot;);</span>
<a href="#l3.480"></a><span id="l3.480" class="difflineminus">-}</span>
<a href="#l3.481"></a><span id="l3.481" class="difflineminus">-</span>
<a href="#l3.482"></a><span id="l3.482" class="difflineminus">-function ShowLocationColumn(show)</span>
<a href="#l3.483"></a><span id="l3.483" class="difflineminus">-{</span>
<a href="#l3.484"></a><span id="l3.484" class="difflineminus">-  var col = document.getElementById(&quot;locationCol&quot;);</span>
<a href="#l3.485"></a><span id="l3.485" class="difflineminus">-  if (col) {</span>
<a href="#l3.486"></a><span id="l3.486" class="difflineminus">-    if (show) {</span>
<a href="#l3.487"></a><span id="l3.487" class="difflineminus">-      col.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l3.488"></a><span id="l3.488" class="difflineminus">-      col.removeAttribute(&quot;ignoreincolumnpicker&quot;);</span>
<a href="#l3.489"></a><span id="l3.489" class="difflineminus">-    }</span>
<a href="#l3.490"></a><span id="l3.490" class="difflineminus">-    else {</span>
<a href="#l3.491"></a><span id="l3.491" class="difflineminus">-      col.setAttribute(&quot;hidden&quot;,&quot;true&quot;);</span>
<a href="#l3.492"></a><span id="l3.492" class="difflineminus">-      col.setAttribute(&quot;ignoreincolumnpicker&quot;,&quot;true&quot;);</span>
<a href="#l3.493"></a><span id="l3.493" class="difflineminus">-    }</span>
<a href="#l3.494"></a><span id="l3.494" class="difflineminus">-  }</span>
<a href="#l3.495"></a><span id="l3.495" class="difflineminus">-}</span>
<a href="#l3.496"></a><span id="l3.496" class="difflineminus">-</span>
<a href="#l3.497"></a><span id="l3.497" class="difflineminus">-function UpdateReceivedColumn(newFolder)</span>
<a href="#l3.498"></a><span id="l3.498" class="difflineminus">-{</span>
<a href="#l3.499"></a><span id="l3.499" class="difflineminus">-  // Only show 'Received' column for e-mails.  For newsgroup messages, the 'Date' header is as reliable as an e-mail's</span>
<a href="#l3.500"></a><span id="l3.500" class="difflineminus">-  // 'Received' header, as it is replaced with the news server's (more reliable) date.</span>
<a href="#l3.501"></a><span id="l3.501" class="difflineminus">-  var receivedColumn = document.getElementById(&quot;receivedCol&quot;);</span>
<a href="#l3.502"></a><span id="l3.502" class="difflineminus">-</span>
<a href="#l3.503"></a><span id="l3.503" class="difflineminus">-  const nsMsgFolderFlags = Components.interfaces.nsMsgFolderFlags;</span>
<a href="#l3.504"></a><span id="l3.504" class="difflineminus">-  var newFolderShowsRcvd = (newFolder.flags &amp; nsMsgFolderFlags.Mail) &amp;&amp;</span>
<a href="#l3.505"></a><span id="l3.505" class="difflineminus">-    !(newFolder.flags &amp; (nsMsgFolderFlags.Queue | nsMsgFolderFlags.Drafts |</span>
<a href="#l3.506"></a><span id="l3.506" class="difflineminus">-                         nsMsgFolderFlags.Templates |</span>
<a href="#l3.507"></a><span id="l3.507" class="difflineminus">-                         nsMsgFolderFlags.SentMail));</span>
<a href="#l3.508"></a><span id="l3.508" class="difflineminus">-    </span>
<a href="#l3.509"></a><span id="l3.509" class="difflineminus">-  var tempHidden = receivedColumn.getAttribute(&quot;temphidden&quot;) == &quot;true&quot;;</span>
<a href="#l3.510"></a><span id="l3.510" class="difflineminus">-  var isHidden = receivedColumn.getAttribute(&quot;hidden&quot;) == &quot;true&quot;;</span>
<a href="#l3.511"></a><span id="l3.511" class="difflineminus">-  </span>
<a href="#l3.512"></a><span id="l3.512" class="difflineminus">-  if (!newFolderShowsRcvd &amp;&amp; !isHidden)</span>
<a href="#l3.513"></a><span id="l3.513" class="difflineminus">-  {</span>
<a href="#l3.514"></a><span id="l3.514" class="difflineminus">-    // Record state &amp; hide</span>
<a href="#l3.515"></a><span id="l3.515" class="difflineminus">-    receivedColumn.setAttribute(&quot;temphidden&quot;, &quot;true&quot;);</span>
<a href="#l3.516"></a><span id="l3.516" class="difflineminus">-    receivedColumn.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l3.517"></a><span id="l3.517" class="difflineminus">-  }</span>
<a href="#l3.518"></a><span id="l3.518" class="difflineminus">-  else if (newFolderShowsRcvd &amp;&amp; tempHidden &amp;&amp; isHidden)</span>
<a href="#l3.519"></a><span id="l3.519" class="difflineminus">-  {</span>
<a href="#l3.520"></a><span id="l3.520" class="difflineminus">-    receivedColumn.setAttribute(&quot;hidden&quot;, &quot;false&quot;);</span>
<a href="#l3.521"></a><span id="l3.521" class="difflineminus">-  }</span>
<a href="#l3.522"></a><span id="l3.522" class="difflineminus">-  </span>
<a href="#l3.523"></a><span id="l3.523" class="difflineminus">-  if (newFolderShowsRcvd)</span>
<a href="#l3.524"></a><span id="l3.524" class="difflineminus">-  {</span>
<a href="#l3.525"></a><span id="l3.525" class="difflineminus">-    receivedColumn.removeAttribute(&quot;ignoreincolumnpicker&quot;);</span>
<a href="#l3.526"></a><span id="l3.526" class="difflineminus">-    receivedColumn.removeAttribute(&quot;temphidden&quot;);</span>
<a href="#l3.527"></a><span id="l3.527" class="difflineminus">-  }</span>
<a href="#l3.528"></a><span id="l3.528" class="difflineminus">-  else</span>
<a href="#l3.529"></a><span id="l3.529" class="difflineminus">-    receivedColumn.setAttribute(&quot;ignoreincolumnpicker&quot;, &quot;true&quot;);</span>
<a href="#l3.530"></a><span id="l3.530"> }</span>
<a href="#l3.531"></a><span id="l3.531"> </span>
<a href="#l3.532"></a><span id="l3.532"> function SetNewsFolderColumns()</span>
<a href="#l3.533"></a><span id="l3.533"> {</span>
<a href="#l3.534"></a><span id="l3.534">   var sizeColumn = document.getElementById(&quot;sizeCol&quot;);</span>
<a href="#l3.535"></a><span id="l3.535"> </span>
<a href="#l3.536"></a><span id="l3.536">   if (gDBView.usingLines) {</span>
<a href="#l3.537"></a><span id="l3.537">      sizeColumn.setAttribute(&quot;label&quot;,gMessengerBundle.getString(&quot;linesColumnHeader&quot;));</span>
<a href="#l3.538"></a><span id="l3.538" class="difflineat">@@ -494,17 +120,17 @@ function UpdateStatusMessageCounts(folde</span>
<a href="#l3.539"></a><span id="l3.539">   var unreadElement = GetUnreadCountElement();</span>
<a href="#l3.540"></a><span id="l3.540">   var totalElement = GetTotalCountElement();</span>
<a href="#l3.541"></a><span id="l3.541">   if(folder &amp;&amp; unreadElement &amp;&amp; totalElement)</span>
<a href="#l3.542"></a><span id="l3.542">   {</span>
<a href="#l3.543"></a><span id="l3.543">     var numSelected = GetNumSelectedMessages();</span>
<a href="#l3.544"></a><span id="l3.544"> </span>
<a href="#l3.545"></a><span id="l3.545">     var numUnread = (numSelected &gt; 1) ?</span>
<a href="#l3.546"></a><span id="l3.546">             gMessengerBundle.getFormattedString(&quot;selectedMsgStatus&quot;,</span>
<a href="#l3.547"></a><span id="l3.547" class="difflineminus">-                                                [numSelected]) :    </span>
<a href="#l3.548"></a><span id="l3.548" class="difflineplus">+                                                [numSelected]) :</span>
<a href="#l3.549"></a><span id="l3.549">             gMessengerBundle.getFormattedString(&quot;unreadMsgStatus&quot;,</span>
<a href="#l3.550"></a><span id="l3.550">                                                 [ folder.getNumUnread(false)]);</span>
<a href="#l3.551"></a><span id="l3.551">     var numTotal =</span>
<a href="#l3.552"></a><span id="l3.552">             gMessengerBundle.getFormattedString(&quot;totalMsgStatus&quot;,</span>
<a href="#l3.553"></a><span id="l3.553">                                                 [folder.getTotalMessages(false)]);</span>
<a href="#l3.554"></a><span id="l3.554"> </span>
<a href="#l3.555"></a><span id="l3.555">     unreadElement.setAttribute(&quot;label&quot;, numUnread);</span>
<a href="#l3.556"></a><span id="l3.556">     totalElement.setAttribute(&quot;label&quot;, numTotal);</span>
<a href="#l3.557"></a><span id="l3.557" class="difflineat">@@ -637,19 +263,18 @@ function ConvertSortTypeToColumnID(sortK</span>
<a href="#l3.558"></a><span id="l3.558">     case nsMsgViewSortType.byAttachments:</span>
<a href="#l3.559"></a><span id="l3.559">       columnID = &quot;attachmentCol&quot;;</span>
<a href="#l3.560"></a><span id="l3.560">       break;</span>
<a href="#l3.561"></a><span id="l3.561">     case nsMsgViewSortType.byCustom:</span>
<a href="#l3.562"></a><span id="l3.562"> </span>
<a href="#l3.563"></a><span id="l3.563">       //TODO: either change try() catch to if (property exists) or restore the getColumnHandler() check</span>
<a href="#l3.564"></a><span id="l3.564">       try //getColumnHandler throws an errror when the ID is not handled</span>
<a href="#l3.565"></a><span id="l3.565">       {</span>
<a href="#l3.566"></a><span id="l3.566" class="difflineminus">-        columnID = gDBView.db.dBFolderInfo.getProperty('customSortCol');</span>
<a href="#l3.567"></a><span id="l3.567" class="difflineplus">+        columnID = gDBView.curCustomColumn;</span>
<a href="#l3.568"></a><span id="l3.568">       }</span>
<a href="#l3.569"></a><span id="l3.569" class="difflineminus">-</span>
<a href="#l3.570"></a><span id="l3.570">       catch (err) { //error - means no handler</span>
<a href="#l3.571"></a><span id="l3.571">         dump(&quot;ConvertSortTypeToColumnID: custom sort key but no handler for column '&quot; + columnID + &quot;'\n&quot;);</span>
<a href="#l3.572"></a><span id="l3.572">         columnID = &quot;dateCol&quot;;</span>
<a href="#l3.573"></a><span id="l3.573">       }</span>
<a href="#l3.574"></a><span id="l3.574"> </span>
<a href="#l3.575"></a><span id="l3.575">       break;</span>
<a href="#l3.576"></a><span id="l3.576">     default:</span>
<a href="#l3.577"></a><span id="l3.577">       dump(&quot;unsupported sort key: &quot; + sortKey + &quot;\n&quot;);</span>
<a href="#l3.578"></a><span id="l3.578" class="difflineat">@@ -665,314 +290,86 @@ var nsMsgViewFlagsType = Components.inte</span>
<a href="#l3.579"></a><span id="l3.579"> var nsMsgViewCommandType = Components.interfaces.nsMsgViewCommandType;</span>
<a href="#l3.580"></a><span id="l3.580"> var nsMsgViewType = Components.interfaces.nsMsgViewType;</span>
<a href="#l3.581"></a><span id="l3.581"> var nsMsgNavigationType = Components.interfaces.nsMsgNavigationType;</span>
<a href="#l3.582"></a><span id="l3.582"> </span>
<a href="#l3.583"></a><span id="l3.583"> var gDBView = null;</span>
<a href="#l3.584"></a><span id="l3.584"> var gCurViewFlags;</span>
<a href="#l3.585"></a><span id="l3.585"> var gCurSortType;</span>
<a href="#l3.586"></a><span id="l3.586"> </span>
<a href="#l3.587"></a><span id="l3.587" class="difflineminus">-// CreateDBView is called when we have a thread pane. CreateBareDBView is called when there is no</span>
<a href="#l3.588"></a><span id="l3.588" class="difflineminus">-// tree associated with the view. CreateDBView will call into CreateBareDBView...</span>
<a href="#l3.589"></a><span id="l3.589" class="difflineminus">-</span>
<a href="#l3.590"></a><span id="l3.590" class="difflineminus">-function CreateBareDBView(originalView, msgFolder, viewType, viewFlags, sortType, sortOrder)</span>
<a href="#l3.591"></a><span id="l3.591" class="difflineminus">-{</span>
<a href="#l3.592"></a><span id="l3.592" class="difflineminus">-  var dbviewContractId = &quot;@mozilla.org/messenger/msgdbview;1?type=&quot;;</span>
<a href="#l3.593"></a><span id="l3.593" class="difflineminus">-  // hack to turn this into an integer, if it was a string</span>
<a href="#l3.594"></a><span id="l3.594" class="difflineminus">-  // it would be a string if it came from localStore.rdf</span>
<a href="#l3.595"></a><span id="l3.595" class="difflineminus">-  viewType = viewType - 0;</span>
<a href="#l3.596"></a><span id="l3.596" class="difflineminus">-</span>
<a href="#l3.597"></a><span id="l3.597" class="difflineminus">-  switch (viewType) {</span>
<a href="#l3.598"></a><span id="l3.598" class="difflineminus">-      case nsMsgViewType.eShowQuickSearchResults:</span>
<a href="#l3.599"></a><span id="l3.599" class="difflineminus">-          dbviewContractId += &quot;quicksearch&quot;;</span>
<a href="#l3.600"></a><span id="l3.600" class="difflineminus">-          break;</span>
<a href="#l3.601"></a><span id="l3.601" class="difflineminus">-      case nsMsgViewType.eShowThreadsWithUnread:</span>
<a href="#l3.602"></a><span id="l3.602" class="difflineminus">-          dbviewContractId += &quot;threadswithunread&quot;;</span>
<a href="#l3.603"></a><span id="l3.603" class="difflineminus">-          break;</span>
<a href="#l3.604"></a><span id="l3.604" class="difflineminus">-      case nsMsgViewType.eShowWatchedThreadsWithUnread:</span>
<a href="#l3.605"></a><span id="l3.605" class="difflineminus">-          dbviewContractId += &quot;watchedthreadswithunread&quot;;</span>
<a href="#l3.606"></a><span id="l3.606" class="difflineminus">-          break;</span>
<a href="#l3.607"></a><span id="l3.607" class="difflineminus">-      case nsMsgViewType.eShowVirtualFolderResults:</span>
<a href="#l3.608"></a><span id="l3.608" class="difflineminus">-          dbviewContractId += &quot;xfvf&quot;;</span>
<a href="#l3.609"></a><span id="l3.609" class="difflineminus">-          break;</span>
<a href="#l3.610"></a><span id="l3.610" class="difflineminus">-      case nsMsgViewType.eShowSearch:</span>
<a href="#l3.611"></a><span id="l3.611" class="difflineminus">-          dbviewContractId += &quot;search&quot;;</span>
<a href="#l3.612"></a><span id="l3.612" class="difflineminus">-          break;</span>
<a href="#l3.613"></a><span id="l3.613" class="difflineminus">-      case nsMsgViewType.eShowAllThreads:</span>
<a href="#l3.614"></a><span id="l3.614" class="difflineminus">-      default:</span>
<a href="#l3.615"></a><span id="l3.615" class="difflineminus">-          if (sortType == nsMsgViewSortType.byThread || sortType == nsMsgViewSortType.byId</span>
<a href="#l3.616"></a><span id="l3.616" class="difflineminus">-            || sortType == nsMsgViewSortType.byNone)</span>
<a href="#l3.617"></a><span id="l3.617" class="difflineminus">-            viewFlags &amp;= ~nsMsgViewFlagsType.kGroupBySort;</span>
<a href="#l3.618"></a><span id="l3.618" class="difflineminus">-</span>
<a href="#l3.619"></a><span id="l3.619" class="difflineminus">-          if (viewFlags &amp; nsMsgViewFlagsType.kGroupBySort)</span>
<a href="#l3.620"></a><span id="l3.620" class="difflineminus">-            dbviewContractId += &quot;group&quot;;</span>
<a href="#l3.621"></a><span id="l3.621" class="difflineminus">-          else</span>
<a href="#l3.622"></a><span id="l3.622" class="difflineminus">-            dbviewContractId += &quot;threaded&quot;;</span>
<a href="#l3.623"></a><span id="l3.623" class="difflineminus">-          break;</span>
<a href="#l3.624"></a><span id="l3.624" class="difflineminus">-  }</span>
<a href="#l3.625"></a><span id="l3.625" class="difflineminus">-</span>
<a href="#l3.626"></a><span id="l3.626" class="difflineminus">-  //  dump (&quot;contract id = &quot; + dbviewContractId + &quot;original view = &quot; + originalView + &quot;\n&quot;);</span>
<a href="#l3.627"></a><span id="l3.627" class="difflineminus">-  if (!originalView)</span>
<a href="#l3.628"></a><span id="l3.628" class="difflineminus">-    gDBView = Components.classes[dbviewContractId].createInstance(Components.interfaces.nsIMsgDBView);</span>
<a href="#l3.629"></a><span id="l3.629" class="difflineminus">-</span>
<a href="#l3.630"></a><span id="l3.630" class="difflineminus">-  gCurViewFlags = viewFlags;</span>
<a href="#l3.631"></a><span id="l3.631" class="difflineminus">-  var count = new Object;</span>
<a href="#l3.632"></a><span id="l3.632" class="difflineminus">-  if (!gThreadPaneCommandUpdater)</span>
<a href="#l3.633"></a><span id="l3.633" class="difflineminus">-    gThreadPaneCommandUpdater = new nsMsgDBViewCommandUpdater();</span>
<a href="#l3.634"></a><span id="l3.634" class="difflineminus">-</span>
<a href="#l3.635"></a><span id="l3.635" class="difflineminus">-  gCurSortType = sortType;</span>
<a href="#l3.636"></a><span id="l3.636" class="difflineminus">-</span>
<a href="#l3.637"></a><span id="l3.637" class="difflineminus">-  if (!originalView) {</span>
<a href="#l3.638"></a><span id="l3.638" class="difflineminus">-    gDBView.init(messenger, msgWindow, gThreadPaneCommandUpdater);</span>
<a href="#l3.639"></a><span id="l3.639" class="difflineminus">-    gDBView.open(msgFolder, gCurSortType, sortOrder, viewFlags, count);</span>
<a href="#l3.640"></a><span id="l3.640" class="difflineminus">-    if (viewType == nsMsgViewType.eShowVirtualFolderResults)</span>
<a href="#l3.641"></a><span id="l3.641" class="difflineminus">-    {</span>
<a href="#l3.642"></a><span id="l3.642" class="difflineminus">-      // the view is a listener on the search results</span>
<a href="#l3.643"></a><span id="l3.643" class="difflineminus">-      gViewSearchListener = gDBView.QueryInterface(Components.interfaces.nsIMsgSearchNotify);</span>
<a href="#l3.644"></a><span id="l3.644" class="difflineminus">-      gSearchSession.registerListener(gViewSearchListener);</span>
<a href="#l3.645"></a><span id="l3.645" class="difflineminus">-    }</span>
<a href="#l3.646"></a><span id="l3.646" class="difflineminus">-  } </span>
<a href="#l3.647"></a><span id="l3.647" class="difflineminus">-  else {</span>
<a href="#l3.648"></a><span id="l3.648" class="difflineminus">-    gDBView = originalView.cloneDBView(messenger, msgWindow, gThreadPaneCommandUpdater);</span>
<a href="#l3.649"></a><span id="l3.649" class="difflineminus">-  }</span>
<a href="#l3.650"></a><span id="l3.650" class="difflineminus">-}</span>
<a href="#l3.651"></a><span id="l3.651" class="difflineminus">-</span>
<a href="#l3.652"></a><span id="l3.652" class="difflineminus">-function CreateDBView(msgFolder, viewType, viewFlags, sortType, sortOrder)</span>
<a href="#l3.653"></a><span id="l3.653" class="difflineminus">-{</span>
<a href="#l3.654"></a><span id="l3.654" class="difflineminus">-  // call the inner create method</span>
<a href="#l3.655"></a><span id="l3.655" class="difflineminus">-  CreateBareDBView(null, msgFolder, viewType, viewFlags, sortType, sortOrder);</span>
<a href="#l3.656"></a><span id="l3.656" class="difflineminus">-</span>
<a href="#l3.657"></a><span id="l3.657" class="difflineminus">-  // now do tree specific work</span>
<a href="#l3.658"></a><span id="l3.658" class="difflineminus">-</span>
<a href="#l3.659"></a><span id="l3.659" class="difflineminus">-  // based on the collapsed state of the thread pane/message pane splitter,</span>
<a href="#l3.660"></a><span id="l3.660" class="difflineminus">-  // suppress message display if appropriate.</span>
<a href="#l3.661"></a><span id="l3.661" class="difflineminus">-  gDBView.suppressMsgDisplay = IsMessagePaneCollapsed();</span>
<a href="#l3.662"></a><span id="l3.662" class="difflineminus">-</span>
<a href="#l3.663"></a><span id="l3.663" class="difflineminus">-  UpdateSortIndicators(gCurSortType, sortOrder);</span>
<a href="#l3.664"></a><span id="l3.664" class="difflineminus">-  var ObserverService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;].getService(Components.interfaces.nsIObserverService);</span>
<a href="#l3.665"></a><span id="l3.665" class="difflineminus">-  ObserverService.notifyObservers(msgFolder, &quot;MsgCreateDBView&quot;, viewType + &quot;:&quot; + viewFlags);</span>
<a href="#l3.666"></a><span id="l3.666" class="difflineminus">-}</span>
<a href="#l3.667"></a><span id="l3.667"> </span>
<a href="#l3.668"></a><span id="l3.668"> function ChangeMessagePaneVisibility(now_hidden)</span>
<a href="#l3.669"></a><span id="l3.669"> {</span>
<a href="#l3.670"></a><span id="l3.670">   // we also have to hide the File/Attachments menuitem</span>
<a href="#l3.671"></a><span id="l3.671">   var node = document.getElementById(&quot;fileAttachmentMenu&quot;);</span>
<a href="#l3.672"></a><span id="l3.672">   if (node)</span>
<a href="#l3.673"></a><span id="l3.673">     node.hidden = now_hidden;</span>
<a href="#l3.674"></a><span id="l3.674"> </span>
<a href="#l3.675"></a><span id="l3.675" class="difflineminus">-  if (gDBView) {</span>
<a href="#l3.676"></a><span id="l3.676" class="difflineminus">-    // the collapsed state is the state after we released the mouse </span>
<a href="#l3.677"></a><span id="l3.677" class="difflineminus">-    // so we take it as it is</span>
<a href="#l3.678"></a><span id="l3.678" class="difflineminus">-    gDBView.suppressMsgDisplay = now_hidden;</span>
<a href="#l3.679"></a><span id="l3.679" class="difflineminus">-  }</span>
<a href="#l3.680"></a><span id="l3.680" class="difflineplus">+  gMessageDisplay.visible = !now_hidden;</span>
<a href="#l3.681"></a><span id="l3.681" class="difflineplus">+</span>
<a href="#l3.682"></a><span id="l3.682">   var event = document.createEvent('Events');</span>
<a href="#l3.683"></a><span id="l3.683">   if (now_hidden) {</span>
<a href="#l3.684"></a><span id="l3.684">     event.initEvent('messagepane-hide', false, true);</span>
<a href="#l3.685"></a><span id="l3.685">   }</span>
<a href="#l3.686"></a><span id="l3.686">   else {</span>
<a href="#l3.687"></a><span id="l3.687">     event.initEvent('messagepane-unhide', false, true);</span>
<a href="#l3.688"></a><span id="l3.688">   }</span>
<a href="#l3.689"></a><span id="l3.689">   document.getElementById(&quot;messengerWindow&quot;).dispatchEvent(event);</span>
<a href="#l3.690"></a><span id="l3.690"> }</span>
<a href="#l3.691"></a><span id="l3.691"> </span>
<a href="#l3.692"></a><span id="l3.692"> function OnMouseUpThreadAndMessagePaneSplitter()</span>
<a href="#l3.693"></a><span id="l3.693"> {</span>
<a href="#l3.694"></a><span id="l3.694" class="difflineminus">-  // the collapsed state is the state after we released the mouse </span>
<a href="#l3.695"></a><span id="l3.695" class="difflineminus">-  // so we take it as it is</span>
<a href="#l3.696"></a><span id="l3.696" class="difflineplus">+  // The collapsed state is the state after we released the mouse,</span>
<a href="#l3.697"></a><span id="l3.697" class="difflineplus">+  // so we take it as it is.</span>
<a href="#l3.698"></a><span id="l3.698">   ChangeMessagePaneVisibility(IsMessagePaneCollapsed());</span>
<a href="#l3.699"></a><span id="l3.699"> }</span>
<a href="#l3.700"></a><span id="l3.700"> </span>
<a href="#l3.701"></a><span id="l3.701" class="difflineplus">+/**</span>
<a href="#l3.702"></a><span id="l3.702" class="difflineplus">+ * Our multiplexed tabbing model ends up sending synthetic folder pane</span>
<a href="#l3.703"></a><span id="l3.703" class="difflineplus">+ *  selection change notifications.  We want to ignore these because the</span>
<a href="#l3.704"></a><span id="l3.704" class="difflineplus">+ *  user may explicitly re-select a folder intentionally, and we want to</span>
<a href="#l3.705"></a><span id="l3.705" class="difflineplus">+ *  be able to know that.  So we filter out the synthetics here.</span>
<a href="#l3.706"></a><span id="l3.706" class="difflineplus">+ * The tabbing logic sets this global to help us out.</span>
<a href="#l3.707"></a><span id="l3.707" class="difflineplus">+ */</span>
<a href="#l3.708"></a><span id="l3.708" class="difflineplus">+var gIgnoreSyntheticFolderPaneSelectionChange = false;</span>
<a href="#l3.709"></a><span id="l3.709"> function FolderPaneSelectionChange()</span>
<a href="#l3.710"></a><span id="l3.710"> {</span>
<a href="#l3.711"></a><span id="l3.711" class="difflineminus">-    var folderSelection = gFolderTreeView.selection;</span>
<a href="#l3.712"></a><span id="l3.712" class="difflineminus">-</span>
<a href="#l3.713"></a><span id="l3.713" class="difflineminus">-    // This prevents a folder from being loaded in the case that the user</span>
<a href="#l3.714"></a><span id="l3.714" class="difflineminus">-    // has right-clicked on a folder different from the one that was</span>
<a href="#l3.715"></a><span id="l3.715" class="difflineminus">-    // originally highlighted.  On a right-click, the highlight (selection)</span>
<a href="#l3.716"></a><span id="l3.716" class="difflineminus">-    // of a row will be different from the value of currentIndex, thus if</span>
<a href="#l3.717"></a><span id="l3.717" class="difflineminus">-    // the currentIndex is not selected, it means the user right-clicked</span>
<a href="#l3.718"></a><span id="l3.718" class="difflineminus">-    // and we don't want to load the contents of the folder.</span>
<a href="#l3.719"></a><span id="l3.719" class="difflineminus">-    if (!folderSelection.isSelected(folderSelection.currentIndex))</span>
<a href="#l3.720"></a><span id="l3.720" class="difflineminus">-      return;</span>
<a href="#l3.721"></a><span id="l3.721" class="difflineminus">-</span>
<a href="#l3.722"></a><span id="l3.722" class="difflineminus">-    gVirtualFolderTerms = null;</span>
<a href="#l3.723"></a><span id="l3.723" class="difflineminus">-    gXFVirtualFolderTerms = null;</span>
<a href="#l3.724"></a><span id="l3.724" class="difflineminus">-</span>
<a href="#l3.725"></a><span id="l3.725" class="difflineminus">-    var folders = GetSelectedMsgFolders();</span>
<a href="#l3.726"></a><span id="l3.726" class="difflineminus">-    if (folders.length == 1)</span>
<a href="#l3.727"></a><span id="l3.727" class="difflineminus">-    {</span>
<a href="#l3.728"></a><span id="l3.728" class="difflineminus">-        var msgFolder = folders[0];</span>
<a href="#l3.729"></a><span id="l3.729" class="difflineminus">-        var uriToLoad = msgFolder.URI;</span>
<a href="#l3.730"></a><span id="l3.730" class="difflineplus">+  if (gIgnoreSyntheticFolderPaneSelectionChange) {</span>
<a href="#l3.731"></a><span id="l3.731" class="difflineplus">+    gIgnoreSyntheticFolderPaneSelectionChange = false;</span>
<a href="#l3.732"></a><span id="l3.732" class="difflineplus">+    return;</span>
<a href="#l3.733"></a><span id="l3.733" class="difflineplus">+  }</span>
<a href="#l3.734"></a><span id="l3.734"> </span>
<a href="#l3.735"></a><span id="l3.735" class="difflineminus">-        if (msgFolder == gMsgFolderSelected)</span>
<a href="#l3.736"></a><span id="l3.736" class="difflineminus">-           return;</span>
<a href="#l3.737"></a><span id="l3.737" class="difflineminus">-        // If msgFolder turns out to be a single folder saved search, a virtual folder,</span>
<a href="#l3.738"></a><span id="l3.738" class="difflineminus">-        // realFolder will get set to the underlying folder the</span>
<a href="#l3.739"></a><span id="l3.739" class="difflineminus">-        // saved search is based on.</span>
<a href="#l3.740"></a><span id="l3.740" class="difflineminus">-        var realFolder = msgFolder;</span>
<a href="#l3.741"></a><span id="l3.741" class="difflineminus">-        gPrevSelectedFolder = gMsgFolderSelected;</span>
<a href="#l3.742"></a><span id="l3.742" class="difflineminus">-        gMsgFolderSelected = msgFolder;</span>
<a href="#l3.743"></a><span id="l3.743" class="difflineminus">-        var folderFlags = msgFolder.flags;</span>
<a href="#l3.744"></a><span id="l3.744" class="difflineminus">-        // If this is same folder, and we're not showing a virtual folder</span>
<a href="#l3.745"></a><span id="l3.745" class="difflineminus">-        // then do nothing.</span>
<a href="#l3.746"></a><span id="l3.746" class="difflineminus">-        const nsMsgFolderFlags = Components.interfaces.nsMsgFolderFlags;</span>
<a href="#l3.747"></a><span id="l3.747" class="difflineminus">-        if (msgFolder == msgWindow.openFolder &amp;&amp;</span>
<a href="#l3.748"></a><span id="l3.748" class="difflineminus">-            !(folderFlags &amp; nsMsgFolderFlags.Virtual) &amp;&amp;</span>
<a href="#l3.749"></a><span id="l3.749" class="difflineminus">-            !(gPrevFolderFlags &amp; nsMsgFolderFlags.Virtual))</span>
<a href="#l3.750"></a><span id="l3.750" class="difflineminus">-        {</span>
<a href="#l3.751"></a><span id="l3.751" class="difflineminus">-            return;</span>
<a href="#l3.752"></a><span id="l3.752" class="difflineminus">-        }</span>
<a href="#l3.753"></a><span id="l3.753" class="difflineminus">-        else</span>
<a href="#l3.754"></a><span id="l3.754" class="difflineminus">-        {</span>
<a href="#l3.755"></a><span id="l3.755" class="difflineminus">-            const outFolderFlagMask = nsMsgFolderFlags.SentMail |</span>
<a href="#l3.756"></a><span id="l3.756" class="difflineminus">-              nsMsgFolderFlags.Drafts | nsMsgFolderFlags.Queue |</span>
<a href="#l3.757"></a><span id="l3.757" class="difflineminus">-              nsMsgFolderFlags.Templates;</span>
<a href="#l3.758"></a><span id="l3.758" class="difflineminus">-            if (IsSpecialFolder(gMsgFolderSelected, outFolderFlagMask, true))</span>
<a href="#l3.759"></a><span id="l3.759" class="difflineminus">-            {</span>
<a href="#l3.760"></a><span id="l3.760" class="difflineminus">-              if (!gPrevSelectedFolder ||</span>
<a href="#l3.761"></a><span id="l3.761" class="difflineminus">-                  !IsSpecialFolder(gPrevSelectedFolder, outFolderFlagMask, true))</span>
<a href="#l3.762"></a><span id="l3.762" class="difflineminus">-                onSearchFolderTypeChanged(true);</span>
<a href="#l3.763"></a><span id="l3.763" class="difflineminus">-            }</span>
<a href="#l3.764"></a><span id="l3.764" class="difflineminus">-            else</span>
<a href="#l3.765"></a><span id="l3.765" class="difflineminus">-            {</span>
<a href="#l3.766"></a><span id="l3.766" class="difflineminus">-              if (!gPrevSelectedFolder ||</span>
<a href="#l3.767"></a><span id="l3.767" class="difflineminus">-                  IsSpecialFolder(gPrevSelectedFolder, outFolderFlagMask, true))</span>
<a href="#l3.768"></a><span id="l3.768" class="difflineminus">-                onSearchFolderTypeChanged(false);</span>
<a href="#l3.769"></a><span id="l3.769" class="difflineminus">-            }</span>
<a href="#l3.770"></a><span id="l3.770" class="difflineplus">+  let folderSelection = gFolderTreeView.selection;</span>
<a href="#l3.771"></a><span id="l3.771"> </span>
<a href="#l3.772"></a><span id="l3.772" class="difflineminus">-            OnLeavingFolder(gPrevSelectedFolder);  // mark all read in last folder</span>
<a href="#l3.773"></a><span id="l3.773" class="difflineminus">-            var sortType = 0;</span>
<a href="#l3.774"></a><span id="l3.774" class="difflineminus">-            var sortOrder = 0;</span>
<a href="#l3.775"></a><span id="l3.775" class="difflineminus">-            var viewFlags = 0;</span>
<a href="#l3.776"></a><span id="l3.776" class="difflineminus">-            var viewType = 0;</span>
<a href="#l3.777"></a><span id="l3.777" class="difflineminus">-            gDefaultSearchViewTerms = null;</span>
<a href="#l3.778"></a><span id="l3.778" class="difflineminus">-            gVirtualFolderTerms = null;</span>
<a href="#l3.779"></a><span id="l3.779" class="difflineminus">-            gXFVirtualFolderTerms = null;</span>
<a href="#l3.780"></a><span id="l3.780" class="difflineminus">-            gPrevFolderFlags = folderFlags;</span>
<a href="#l3.781"></a><span id="l3.781" class="difflineminus">-            gCurrentVirtualFolderUri = null;</span>
<a href="#l3.782"></a><span id="l3.782" class="difflineminus">-            // don't get the db if this folder is a server</span>
<a href="#l3.783"></a><span id="l3.783" class="difflineminus">-            // we're going to be display account central</span>
<a href="#l3.784"></a><span id="l3.784" class="difflineminus">-            if (!(msgFolder.isServer)) </span>
<a href="#l3.785"></a><span id="l3.785" class="difflineminus">-            {</span>
<a href="#l3.786"></a><span id="l3.786" class="difflineminus">-              try </span>
<a href="#l3.787"></a><span id="l3.787" class="difflineminus">-              {</span>
<a href="#l3.788"></a><span id="l3.788" class="difflineminus">-                var msgDatabase = msgFolder.msgDatabase;</span>
<a href="#l3.789"></a><span id="l3.789" class="difflineminus">-                if (msgDatabase)</span>
<a href="#l3.790"></a><span id="l3.790" class="difflineminus">-                {</span>
<a href="#l3.791"></a><span id="l3.791" class="difflineminus">-                  var dbFolderInfo = msgDatabase.dBFolderInfo;</span>
<a href="#l3.792"></a><span id="l3.792" class="difflineminus">-                  sortType = dbFolderInfo.sortType;</span>
<a href="#l3.793"></a><span id="l3.793" class="difflineminus">-                  sortOrder = dbFolderInfo.sortOrder;</span>
<a href="#l3.794"></a><span id="l3.794" class="difflineminus">-                  viewFlags = dbFolderInfo.viewFlags;</span>
<a href="#l3.795"></a><span id="l3.795" class="difflineminus">-                  if (folderFlags &amp; Components.interfaces.nsMsgFolderFlags.Virtual)</span>
<a href="#l3.796"></a><span id="l3.796" class="difflineminus">-                  {</span>
<a href="#l3.797"></a><span id="l3.797" class="difflineminus">-                    viewType = nsMsgViewType.eShowQuickSearchResults;</span>
<a href="#l3.798"></a><span id="l3.798" class="difflineminus">-                    var searchTermString = dbFolderInfo.getCharProperty(&quot;searchStr&quot;);</span>
<a href="#l3.799"></a><span id="l3.799" class="difflineminus">-                    var searchOnline = dbFolderInfo.getBooleanProperty(&quot;searchOnline&quot;, false);</span>
<a href="#l3.800"></a><span id="l3.800" class="difflineminus">-                    // trick the view code into updating the real folder...</span>
<a href="#l3.801"></a><span id="l3.801" class="difflineminus">-                    gCurrentVirtualFolderUri = uriToLoad;</span>
<a href="#l3.802"></a><span id="l3.802" class="difflineminus">-                    viewDebug(&quot;uriToLoad = &quot; + uriToLoad + &quot;\n&quot;);</span>
<a href="#l3.803"></a><span id="l3.803" class="difflineminus">-                    var srchFolderUri = dbFolderInfo.getCharProperty(&quot;searchFolderUri&quot;);</span>
<a href="#l3.804"></a><span id="l3.804" class="difflineminus">-                    var srchFolderUriArray = srchFolderUri.split('|');</span>
<a href="#l3.805"></a><span id="l3.805" class="difflineminus">-                    // cross folder search</span>
<a href="#l3.806"></a><span id="l3.806" class="difflineminus">-                    var filterService = Components.classes[&quot;@mozilla.org/messenger/services/filters;1&quot;].getService(Components.interfaces.nsIMsgFilterService);</span>
<a href="#l3.807"></a><span id="l3.807" class="difflineminus">-                    var filterList = filterService.getTempFilterList(msgFolder);</span>
<a href="#l3.808"></a><span id="l3.808" class="difflineminus">-                    var tempFilter = filterList.createFilter(&quot;temp&quot;);</span>
<a href="#l3.809"></a><span id="l3.809" class="difflineminus">-                    filterList.parseCondition(tempFilter, searchTermString);</span>
<a href="#l3.810"></a><span id="l3.810" class="difflineminus">-                    if (srchFolderUriArray.length &gt; 1)</span>
<a href="#l3.811"></a><span id="l3.811" class="difflineminus">-                    {</span>
<a href="#l3.812"></a><span id="l3.812" class="difflineminus">-                      viewType = nsMsgViewType.eShowVirtualFolderResults;</span>
<a href="#l3.813"></a><span id="l3.813" class="difflineminus">-                      gXFVirtualFolderTerms = CreateGroupedSearchTerms(tempFilter.searchTerms);</span>
<a href="#l3.814"></a><span id="l3.814" class="difflineminus">-                      setupXFVirtualFolderSearch(srchFolderUriArray, gXFVirtualFolderTerms, searchOnline);</span>
<a href="#l3.815"></a><span id="l3.815" class="difflineminus">-                      // need to set things up so that reroot folder issues the search</span>
<a href="#l3.816"></a><span id="l3.816" class="difflineminus">-                    }</span>
<a href="#l3.817"></a><span id="l3.817" class="difflineminus">-                    else</span>
<a href="#l3.818"></a><span id="l3.818" class="difflineminus">-                    {</span>
<a href="#l3.819"></a><span id="l3.819" class="difflineminus">-                      gSearchSession = null;</span>
<a href="#l3.820"></a><span id="l3.820" class="difflineminus">-                      uriToLoad = srchFolderUri;</span>
<a href="#l3.821"></a><span id="l3.821" class="difflineminus">-                      // we need to load the db for the actual folder so that many hdrs to download</span>
<a href="#l3.822"></a><span id="l3.822" class="difflineminus">-                      // will return false...</span>
<a href="#l3.823"></a><span id="l3.823" class="difflineminus">-                      realFolder = GetMsgFolderFromUri(uriToLoad);</span>
<a href="#l3.824"></a><span id="l3.824" class="difflineminus">-                      msgDatabase = realFolder.msgDatabase;</span>
<a href="#l3.825"></a><span id="l3.825" class="difflineminus">-                      gVirtualFolderTerms = CreateGroupedSearchTerms(tempFilter.searchTerms);</span>
<a href="#l3.826"></a><span id="l3.826" class="difflineminus">-                    }</span>
<a href="#l3.827"></a><span id="l3.827" class="difflineminus">-                  }</span>
<a href="#l3.828"></a><span id="l3.828" class="difflineminus">-                  else</span>
<a href="#l3.829"></a><span id="l3.829" class="difflineminus">-                  {</span>
<a href="#l3.830"></a><span id="l3.830" class="difflineminus">-                    gSearchSession = null;</span>
<a href="#l3.831"></a><span id="l3.831" class="difflineminus">-                    viewFlags = dbFolderInfo.viewFlags;</span>
<a href="#l3.832"></a><span id="l3.832" class="difflineminus">-                    viewType = dbFolderInfo.viewType;</span>
<a href="#l3.833"></a><span id="l3.833" class="difflineminus">-                  }</span>
<a href="#l3.834"></a><span id="l3.834" class="difflineminus">-                  msgDatabase = null;</span>
<a href="#l3.835"></a><span id="l3.835" class="difflineminus">-                  dbFolderInfo = null;</span>
<a href="#l3.836"></a><span id="l3.836" class="difflineminus">-                }</span>
<a href="#l3.837"></a><span id="l3.837" class="difflineminus">-              }</span>
<a href="#l3.838"></a><span id="l3.838" class="difflineminus">-              catch (ex)</span>
<a href="#l3.839"></a><span id="l3.839" class="difflineminus">-              {</span>
<a href="#l3.840"></a><span id="l3.840" class="difflineminus">-                dump(&quot;failed to get view &amp; sort values.  ex = &quot; + ex +&quot;\n&quot;);</span>
<a href="#l3.841"></a><span id="l3.841" class="difflineminus">-              }</span>
<a href="#l3.842"></a><span id="l3.842" class="difflineminus">-            }</span>
<a href="#l3.843"></a><span id="l3.843" class="difflineminus">-            if (gDBView &amp;&amp; gDBView.viewType == nsMsgViewType.eShowQuickSearchResults)</span>
<a href="#l3.844"></a><span id="l3.844" class="difflineminus">-            {</span>
<a href="#l3.845"></a><span id="l3.845" class="difflineminus">-              if (gPreQuickSearchView) //close cached view before quick search</span>
<a href="#l3.846"></a><span id="l3.846" class="difflineminus">-              {</span>
<a href="#l3.847"></a><span id="l3.847" class="difflineminus">-                gPreQuickSearchView.close();</span>
<a href="#l3.848"></a><span id="l3.848" class="difflineminus">-                gPreQuickSearchView = null;  </span>
<a href="#l3.849"></a><span id="l3.849" class="difflineminus">-              }</span>
<a href="#l3.850"></a><span id="l3.850" class="difflineminus">-              ClearQSIfNecessary();</span>
<a href="#l3.851"></a><span id="l3.851" class="difflineminus">-            }</span>
<a href="#l3.852"></a><span id="l3.852" class="difflineminus">-            ClearMessagePane();</span>
<a href="#l3.853"></a><span id="l3.853" class="difflineplus">+  // This prevents a folder from being loaded in the case that the user</span>
<a href="#l3.854"></a><span id="l3.854" class="difflineplus">+  // has right-clicked on a folder different from the one that was</span>
<a href="#l3.855"></a><span id="l3.855" class="difflineplus">+  // originally highlighted.  On a right-click, the highlight (selection)</span>
<a href="#l3.856"></a><span id="l3.856" class="difflineplus">+  // of a row will be different from the value of currentIndex, thus if</span>
<a href="#l3.857"></a><span id="l3.857" class="difflineplus">+  // the currentIndex is not selected, it means the user right-clicked</span>
<a href="#l3.858"></a><span id="l3.858" class="difflineplus">+  // and we don't want to load the contents of the folder.</span>
<a href="#l3.859"></a><span id="l3.859" class="difflineplus">+  if (!folderSelection.isSelected(folderSelection.currentIndex))</span>
<a href="#l3.860"></a><span id="l3.860" class="difflineplus">+    return;</span>
<a href="#l3.861"></a><span id="l3.861"> </span>
<a href="#l3.862"></a><span id="l3.862" class="difflineminus">-            if (gXFVirtualFolderTerms)</span>
<a href="#l3.863"></a><span id="l3.863" class="difflineminus">-              viewType = nsMsgViewType.eShowVirtualFolderResults;</span>
<a href="#l3.864"></a><span id="l3.864" class="difflineminus">-            else if (gSearchEmailAddress || gVirtualFolderTerms)</span>
<a href="#l3.865"></a><span id="l3.865" class="difflineminus">-              viewType = nsMsgViewType.eShowQuickSearchResults;</span>
<a href="#l3.866"></a><span id="l3.866" class="difflineminus">-            else if (viewType == nsMsgViewType.eShowQuickSearchResults)</span>
<a href="#l3.867"></a><span id="l3.867" class="difflineminus">-              viewType = nsMsgViewType.eShowAllThreads;  //override viewType - we don't want to start w/ quick search</span>
<a href="#l3.868"></a><span id="l3.868" class="difflineminus">-            ChangeFolder(realFolder, msgFolder, viewType, viewFlags, sortType, sortOrder);</span>
<a href="#l3.869"></a><span id="l3.869" class="difflineminus">-            if (gVirtualFolderTerms)</span>
<a href="#l3.870"></a><span id="l3.870" class="difflineminus">-              gDBView.viewFolder = msgFolder;</span>
<a href="#l3.871"></a><span id="l3.871" class="difflineminus">-        }</span>
<a href="#l3.872"></a><span id="l3.872" class="difflineminus">-        document.getElementById('tabmail').setTabTitle(null);</span>
<a href="#l3.873"></a><span id="l3.873" class="difflineminus">-    }</span>
<a href="#l3.874"></a><span id="l3.874" class="difflineminus">-    else</span>
<a href="#l3.875"></a><span id="l3.875" class="difflineminus">-    {</span>
<a href="#l3.876"></a><span id="l3.876" class="difflineminus">-      msgWindow.openFolder = null;</span>
<a href="#l3.877"></a><span id="l3.877" class="difflineminus">-      ClearThreadPane();</span>
<a href="#l3.878"></a><span id="l3.878" class="difflineminus">-    }</span>
<a href="#l3.879"></a><span id="l3.879" class="difflineminus">-</span>
<a href="#l3.880"></a><span id="l3.880" class="difflineminus">-    var startpageenabled = gPrefBranch.getBoolPref(&quot;mailnews.start_page.enabled&quot;);</span>
<a href="#l3.881"></a><span id="l3.881" class="difflineminus">-    if (gDisplayStartupPage &amp;&amp; startpageenabled)</span>
<a href="#l3.882"></a><span id="l3.882" class="difflineminus">-    {</span>
<a href="#l3.883"></a><span id="l3.883" class="difflineminus">-      loadStartPage();</span>
<a href="#l3.884"></a><span id="l3.884" class="difflineminus">-      gDisplayStartupPage = false;</span>
<a href="#l3.885"></a><span id="l3.885" class="difflineminus">-    }</span>
<a href="#l3.886"></a><span id="l3.886" class="difflineminus">-    UpdateMailToolbar(&quot;FolderPaneSelectionChange&quot;);</span>
<a href="#l3.887"></a><span id="l3.887" class="difflineminus">-}</span>
<a href="#l3.888"></a><span id="l3.888" class="difflineminus">-</span>
<a href="#l3.889"></a><span id="l3.889" class="difflineminus">-function ClearThreadPane()</span>
<a href="#l3.890"></a><span id="l3.890" class="difflineminus">-{</span>
<a href="#l3.891"></a><span id="l3.891" class="difflineminus">-  if (gDBView) {</span>
<a href="#l3.892"></a><span id="l3.892" class="difflineminus">-    gDBView.close();</span>
<a href="#l3.893"></a><span id="l3.893" class="difflineminus">-    gDBView = null; </span>
<a href="#l3.894"></a><span id="l3.894" class="difflineminus">-  }</span>
<a href="#l3.895"></a><span id="l3.895" class="difflineplus">+  let folders = GetSelectedMsgFolders();</span>
<a href="#l3.896"></a><span id="l3.896" class="difflineplus">+  gFolderDisplay.show(folders.length ? folders[0] : null);</span>
<a href="#l3.897"></a><span id="l3.897"> }</span>
<a href="#l3.898"></a><span id="l3.898"> </span>
<a href="#l3.899"></a><span id="l3.899"> function IsSpecialFolder(msgFolder, flags, checkAncestors)</span>
<a href="#l3.900"></a><span id="l3.900"> {</span>
<a href="#l3.901"></a><span id="l3.901" class="difflineminus">-    if (!msgFolder) </span>
<a href="#l3.902"></a><span id="l3.902" class="difflineplus">+    if (!msgFolder)</span>
<a href="#l3.903"></a><span id="l3.903">         return false;</span>
<a href="#l3.904"></a><span id="l3.904">     else if ((msgFolder.flags &amp; flags) == 0)</span>
<a href="#l3.905"></a><span id="l3.905">     {</span>
<a href="#l3.906"></a><span id="l3.906">       var parentMsgFolder = msgFolder.parentMsgFolder;</span>
<a href="#l3.907"></a><span id="l3.907"> </span>
<a href="#l3.908"></a><span id="l3.908">       return (parentMsgFolder &amp;&amp; checkAncestors) ? IsSpecialFolder(parentMsgFolder, flags, true) : false;</span>
<a href="#l3.909"></a><span id="l3.909">     }</span>
<a href="#l3.910"></a><span id="l3.910">     else {</span>
<a href="#l3.911"></a><span id="l3.911">         // the user can set their INBOX to be their SENT folder.</span>
<a href="#l3.912"></a><span id="l3.912" class="difflineminus">-        // in that case, we want this folder to act like an INBOX, </span>
<a href="#l3.913"></a><span id="l3.913" class="difflineplus">+        // in that case, we want this folder to act like an INBOX,</span>
<a href="#l3.914"></a><span id="l3.914">         // and not a SENT folder</span>
<a href="#l3.915"></a><span id="l3.915">         const nsMsgFolderFlags = Components.interfaces.nsMsgFolderFlags;</span>
<a href="#l3.916"></a><span id="l3.916">         return !((flags &amp; nsMsgFolderFlags.SentMail) &amp;&amp;</span>
<a href="#l3.917"></a><span id="l3.917">                  (msgFolder.flags &amp; nsMsgFolderFlags.Inbox));</span>
<a href="#l3.918"></a><span id="l3.918">     }</span>
<a href="#l3.919"></a><span id="l3.919"> }</span>
<a href="#l3.920"></a><span id="l3.920"> </span>
<a href="#l3.921"></a><span id="l3.921"> function Undo()</span>
<a href="#l3.922"></a><span id="l3.922" class="difflineat">@@ -980,166 +377,10 @@ function Undo()</span>
<a href="#l3.923"></a><span id="l3.923">     messenger.undo(msgWindow);</span>
<a href="#l3.924"></a><span id="l3.924"> }</span>
<a href="#l3.925"></a><span id="l3.925"> </span>
<a href="#l3.926"></a><span id="l3.926"> function Redo()</span>
<a href="#l3.927"></a><span id="l3.927"> {</span>
<a href="#l3.928"></a><span id="l3.928">     messenger.redo(msgWindow);</span>
<a href="#l3.929"></a><span id="l3.929"> }</span>
<a href="#l3.930"></a><span id="l3.930"> </span>
<a href="#l3.931"></a><span id="l3.931" class="difflineminus">-function getSearchTermString(searchTerms)</span>
<a href="#l3.932"></a><span id="l3.932" class="difflineminus">-{</span>
<a href="#l3.933"></a><span id="l3.933" class="difflineminus">-  var searchIndex;</span>
<a href="#l3.934"></a><span id="l3.934" class="difflineminus">-  var condition = &quot;&quot;;</span>
<a href="#l3.935"></a><span id="l3.935" class="difflineminus">-  var count = searchTerms.Count();</span>
<a href="#l3.936"></a><span id="l3.936" class="difflineminus">-  for (searchIndex = 0; searchIndex &lt; count; )</span>
<a href="#l3.937"></a><span id="l3.937" class="difflineminus">-  {</span>
<a href="#l3.938"></a><span id="l3.938" class="difflineminus">-    var term = searchTerms.QueryElementAt(searchIndex++, Components.interfaces.nsIMsgSearchTerm);</span>
<a href="#l3.939"></a><span id="l3.939" class="difflineminus">-    </span>
<a href="#l3.940"></a><span id="l3.940" class="difflineminus">-    if (condition.length &gt; 1)</span>
<a href="#l3.941"></a><span id="l3.941" class="difflineminus">-      condition += ' ';</span>
<a href="#l3.942"></a><span id="l3.942" class="difflineminus">-    </span>
<a href="#l3.943"></a><span id="l3.943" class="difflineminus">-    if (term.matchAll)</span>
<a href="#l3.944"></a><span id="l3.944" class="difflineminus">-    {</span>
<a href="#l3.945"></a><span id="l3.945" class="difflineminus">-        condition = &quot;ALL&quot;;</span>
<a href="#l3.946"></a><span id="l3.946" class="difflineminus">-        break;</span>
<a href="#l3.947"></a><span id="l3.947" class="difflineminus">-    }</span>
<a href="#l3.948"></a><span id="l3.948" class="difflineminus">-    condition += (term.booleanAnd) ? &quot;AND (&quot; : &quot;OR (&quot;;</span>
<a href="#l3.949"></a><span id="l3.949" class="difflineminus">-    condition += term.termAsString + ')';</span>
<a href="#l3.950"></a><span id="l3.950" class="difflineminus">-  }</span>
<a href="#l3.951"></a><span id="l3.951" class="difflineminus">-  return condition;</span>
<a href="#l3.952"></a><span id="l3.952" class="difflineminus">-}</span>
<a href="#l3.953"></a><span id="l3.953" class="difflineminus">-</span>
<a href="#l3.954"></a><span id="l3.954" class="difflineminus">-function  CreateVirtualFolder(newName, parentFolder, searchFolderURIs, searchTerms, searchOnline)</span>
<a href="#l3.955"></a><span id="l3.955" class="difflineminus">-{</span>
<a href="#l3.956"></a><span id="l3.956" class="difflineminus">-  // ### need to make sure view/folder doesn't exist.</span>
<a href="#l3.957"></a><span id="l3.957" class="difflineminus">-  if (searchFolderURIs &amp;&amp; (searchFolderURIs != &quot;&quot;) &amp;&amp; newName &amp;&amp; (newName != &quot;&quot;)) </span>
<a href="#l3.958"></a><span id="l3.958" class="difflineminus">-  {</span>
<a href="#l3.959"></a><span id="l3.959" class="difflineminus">-    try</span>
<a href="#l3.960"></a><span id="l3.960" class="difflineminus">-    {</span>
<a href="#l3.961"></a><span id="l3.961" class="difflineminus">-      var newFolder = parentFolder.addSubfolder(newName);</span>
<a href="#l3.962"></a><span id="l3.962" class="difflineminus">-      newFolder.prettyName = newName;</span>
<a href="#l3.963"></a><span id="l3.963" class="difflineminus">-      newFolder.setFlag(Components.interfaces.nsMsgFolderFlags.Virtual);</span>
<a href="#l3.964"></a><span id="l3.964" class="difflineminus">-      var vfdb = newFolder.msgDatabase;</span>
<a href="#l3.965"></a><span id="l3.965" class="difflineminus">-      var searchTermString = getSearchTermString(searchTerms);</span>
<a href="#l3.966"></a><span id="l3.966" class="difflineminus">-      var dbFolderInfo = vfdb.dBFolderInfo;</span>
<a href="#l3.967"></a><span id="l3.967" class="difflineminus">-      // set the view string as a property of the db folder info</span>
<a href="#l3.968"></a><span id="l3.968" class="difflineminus">-      // set the original folder name as well.</span>
<a href="#l3.969"></a><span id="l3.969" class="difflineminus">-      dbFolderInfo.setCharProperty(&quot;searchStr&quot;, searchTermString);</span>
<a href="#l3.970"></a><span id="l3.970" class="difflineminus">-      dbFolderInfo.setCharProperty(&quot;searchFolderUri&quot;, searchFolderURIs);</span>
<a href="#l3.971"></a><span id="l3.971" class="difflineminus">-      dbFolderInfo.setBooleanProperty(&quot;searchOnline&quot;, searchOnline);</span>
<a href="#l3.972"></a><span id="l3.972" class="difflineminus">-</span>
<a href="#l3.973"></a><span id="l3.973" class="difflineminus">-      vfdb.summaryValid = true;</span>
<a href="#l3.974"></a><span id="l3.974" class="difflineminus">-      vfdb.Close(true);</span>
<a href="#l3.975"></a><span id="l3.975" class="difflineminus">-      parentFolder.NotifyItemAdded(newFolder);</span>
<a href="#l3.976"></a><span id="l3.976" class="difflineminus">-      var accountManager = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;].getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l3.977"></a><span id="l3.977" class="difflineminus">-      accountManager.saveVirtualFolders();</span>
<a href="#l3.978"></a><span id="l3.978" class="difflineminus">-    }</span>
<a href="#l3.979"></a><span id="l3.979" class="difflineminus">-    catch(e)</span>
<a href="#l3.980"></a><span id="l3.980" class="difflineminus">-    {</span>
<a href="#l3.981"></a><span id="l3.981" class="difflineminus">-      throw(e); // so that the dialog does not automatically close</span>
<a href="#l3.982"></a><span id="l3.982" class="difflineminus">-      dump (&quot;Exception : creating virtual folder \n&quot;);</span>
<a href="#l3.983"></a><span id="l3.983" class="difflineminus">-    }</span>
<a href="#l3.984"></a><span id="l3.984" class="difflineminus">-  }</span>
<a href="#l3.985"></a><span id="l3.985" class="difflineminus">-  else </span>
<a href="#l3.986"></a><span id="l3.986" class="difflineminus">-  {</span>
<a href="#l3.987"></a><span id="l3.987" class="difflineminus">-    dump(&quot;no name or nothing selected\n&quot;);</span>
<a href="#l3.988"></a><span id="l3.988" class="difflineminus">-  }   </span>
<a href="#l3.989"></a><span id="l3.989" class="difflineminus">-}</span>
<a href="#l3.990"></a><span id="l3.990" class="difflineminus">-</span>
<a href="#l3.991"></a><span id="l3.991" class="difflineminus">-var gSearchSession;</span>
<a href="#l3.992"></a><span id="l3.992" class="difflineminus">-</span>
<a href="#l3.993"></a><span id="l3.993" class="difflineminus">-var nsMsgSearchScope = Components.interfaces.nsMsgSearchScope;</span>
<a href="#l3.994"></a><span id="l3.994" class="difflineminus">-</span>
<a href="#l3.995"></a><span id="l3.995"> var gMessengerBundle = null;</span>
<a href="#l3.996"></a><span id="l3.996"> </span>
<a href="#l3.997"></a><span id="l3.997" class="difflineminus">-// Datasource search listener -- made global as it has to be registered</span>
<a href="#l3.998"></a><span id="l3.998" class="difflineminus">-// and unregistered in different functions.</span>
<a href="#l3.999"></a><span id="l3.999" class="difflineminus">-var gViewSearchListener;</span>
<a href="#l3.1000"></a><span id="l3.1000" class="difflineminus">-</span>
<a href="#l3.1001"></a><span id="l3.1001" class="difflineminus">-function GetScopeForFolder(folder) </span>
<a href="#l3.1002"></a><span id="l3.1002" class="difflineminus">-{</span>
<a href="#l3.1003"></a><span id="l3.1003" class="difflineminus">-  return folder.server.searchScope;</span>
<a href="#l3.1004"></a><span id="l3.1004" class="difflineminus">-}</span>
<a href="#l3.1005"></a><span id="l3.1005" class="difflineminus">-</span>
<a href="#l3.1006"></a><span id="l3.1006" class="difflineminus">-function setupXFVirtualFolderSearch(folderUrisToSearch, searchTerms, searchOnline)</span>
<a href="#l3.1007"></a><span id="l3.1007" class="difflineminus">-{</span>
<a href="#l3.1008"></a><span id="l3.1008" class="difflineminus">-  const Ci = Components.interfaces;</span>
<a href="#l3.1009"></a><span id="l3.1009" class="difflineminus">-  var count = new Object;</span>
<a href="#l3.1010"></a><span id="l3.1010" class="difflineminus">-  var i;</span>
<a href="#l3.1011"></a><span id="l3.1011" class="difflineminus">-</span>
<a href="#l3.1012"></a><span id="l3.1012" class="difflineminus">-  gSearchSession = Components.classes[&quot;@mozilla.org/messenger/searchSession;1&quot;]</span>
<a href="#l3.1013"></a><span id="l3.1013" class="difflineminus">-                             .createInstance(Ci.nsIMsgSearchSession);</span>
<a href="#l3.1014"></a><span id="l3.1014" class="difflineminus">-</span>
<a href="#l3.1015"></a><span id="l3.1015" class="difflineminus">-  for (i in folderUrisToSearch)</span>
<a href="#l3.1016"></a><span id="l3.1016" class="difflineminus">-    {</span>
<a href="#l3.1017"></a><span id="l3.1017" class="difflineminus">-      var realFolder = GetMsgFolderFromUri(folderUrisToSearch[i]);</span>
<a href="#l3.1018"></a><span id="l3.1018" class="difflineminus">-      if (!realFolder.isServer)</span>
<a href="#l3.1019"></a><span id="l3.1019" class="difflineminus">-        gSearchSession.addScopeTerm(!searchOnline ? nsMsgSearchScope.offlineMail : GetScopeForFolder(realFolder), realFolder);</span>
<a href="#l3.1020"></a><span id="l3.1020" class="difflineminus">-    }</span>
<a href="#l3.1021"></a><span id="l3.1021" class="difflineminus">-</span>
<a href="#l3.1022"></a><span id="l3.1022" class="difflineminus">-    var termsArray = searchTerms.QueryInterface(Components.interfaces.nsISupportsArray);</span>
<a href="#l3.1023"></a><span id="l3.1023" class="difflineminus">-    const nsIMsgSearchTerm = Components.interfaces.nsIMsgSearchTerm;</span>
<a href="#l3.1024"></a><span id="l3.1024" class="difflineminus">-    for each (var term in fixIterator(termsArray, nsIMsgSearchTerm)) {</span>
<a href="#l3.1025"></a><span id="l3.1025" class="difflineminus">-      gSearchSession.appendTerm(term);</span>
<a href="#l3.1026"></a><span id="l3.1026" class="difflineminus">-    }</span>
<a href="#l3.1027"></a><span id="l3.1027" class="difflineminus">-}</span>
<a href="#l3.1028"></a><span id="l3.1028" class="difflineminus">-</span>
<a href="#l3.1029"></a><span id="l3.1029" class="difflineminus">-function CreateGroupedSearchTerms(searchTermsArray)</span>
<a href="#l3.1030"></a><span id="l3.1030" class="difflineminus">-{</span>
<a href="#l3.1031"></a><span id="l3.1031" class="difflineminus">-  const Ci = Components.interfaces;</span>
<a href="#l3.1032"></a><span id="l3.1032" class="difflineminus">-  var searchSession = gSearchSession;</span>
<a href="#l3.1033"></a><span id="l3.1033" class="difflineminus">-  if (!searchSession) {</span>
<a href="#l3.1034"></a><span id="l3.1034" class="difflineminus">-    searchSession = Components.classes[&quot;@mozilla.org/messenger/searchSession;1&quot;]</span>
<a href="#l3.1035"></a><span id="l3.1035" class="difflineminus">-                              .createInstance(Ci.nsIMsgSearchSession);</span>
<a href="#l3.1036"></a><span id="l3.1036" class="difflineminus">-  }</span>
<a href="#l3.1037"></a><span id="l3.1037" class="difflineminus">-</span>
<a href="#l3.1038"></a><span id="l3.1038" class="difflineminus">-  // create a temporary isupports array to store our search terms</span>
<a href="#l3.1039"></a><span id="l3.1039" class="difflineminus">-  // since we will be modifying the terms so they work with quick search</span>
<a href="#l3.1040"></a><span id="l3.1040" class="difflineminus">-  var searchTermsArrayForQS = Components.classes[&quot;@mozilla.org/supports-array;1&quot;].createInstance(Components.interfaces.nsISupportsArray);</span>
<a href="#l3.1041"></a><span id="l3.1041" class="difflineminus">-  </span>
<a href="#l3.1042"></a><span id="l3.1042" class="difflineminus">-  var numEntries = searchTermsArray.Count();</span>
<a href="#l3.1043"></a><span id="l3.1043" class="difflineminus">-  for (var i = 0; i &lt; numEntries; i++) {</span>
<a href="#l3.1044"></a><span id="l3.1044" class="difflineminus">-    var searchTerm = searchTermsArray.GetElementAt(i).QueryInterface(Components.interfaces.nsIMsgSearchTerm); </span>
<a href="#l3.1045"></a><span id="l3.1045" class="difflineminus">-</span>
<a href="#l3.1046"></a><span id="l3.1046" class="difflineminus">-    // clone the term, since we might be modifying it</span>
<a href="#l3.1047"></a><span id="l3.1047" class="difflineminus">-    var searchTermForQS = searchSession.createTerm();</span>
<a href="#l3.1048"></a><span id="l3.1048" class="difflineminus">-    searchTermForQS.value = searchTerm.value;</span>
<a href="#l3.1049"></a><span id="l3.1049" class="difflineminus">-    searchTermForQS.attrib = searchTerm.attrib;</span>
<a href="#l3.1050"></a><span id="l3.1050" class="difflineminus">-    searchTermForQS.arbitraryHeader = searchTerm.arbitraryHeader</span>
<a href="#l3.1051"></a><span id="l3.1051" class="difflineminus">-    searchTermForQS.op = searchTerm.op;</span>
<a href="#l3.1052"></a><span id="l3.1052" class="difflineminus">-</span>
<a href="#l3.1053"></a><span id="l3.1053" class="difflineminus">-    // mark the first node as a group</span>
<a href="#l3.1054"></a><span id="l3.1054" class="difflineminus">-    if (i == 0)</span>
<a href="#l3.1055"></a><span id="l3.1055" class="difflineminus">-      searchTermForQS.beginsGrouping = true;</span>
<a href="#l3.1056"></a><span id="l3.1056" class="difflineminus">-    else if (i == numEntries - 1)</span>
<a href="#l3.1057"></a><span id="l3.1057" class="difflineminus">-      searchTermForQS.endsGrouping = true;</span>
<a href="#l3.1058"></a><span id="l3.1058" class="difflineminus">-</span>
<a href="#l3.1059"></a><span id="l3.1059" class="difflineminus">-    // turn the first term to true to work with quick search...</span>
<a href="#l3.1060"></a><span id="l3.1060" class="difflineminus">-    searchTermForQS.booleanAnd = i ? searchTerm.booleanAnd : true; </span>
<a href="#l3.1061"></a><span id="l3.1061" class="difflineminus">-    </span>
<a href="#l3.1062"></a><span id="l3.1062" class="difflineminus">-    searchTermsArrayForQS.AppendElement(searchTermForQS);</span>
<a href="#l3.1063"></a><span id="l3.1063" class="difflineminus">-  }</span>
<a href="#l3.1064"></a><span id="l3.1064" class="difflineminus">-  return searchTermsArrayForQS;</span>
<a href="#l3.1065"></a><span id="l3.1065" class="difflineminus">-}</span>
<a href="#l3.1066"></a><span id="l3.1066" class="difflineminus">-</span>
<a href="#l3.1067"></a><span id="l3.1067" class="difflineminus">-function OnLeavingFolder(aFolder)</span>
<a href="#l3.1068"></a><span id="l3.1068" class="difflineminus">-{</span>
<a href="#l3.1069"></a><span id="l3.1069" class="difflineminus">-  try</span>
<a href="#l3.1070"></a><span id="l3.1070" class="difflineminus">-  {</span>
<a href="#l3.1071"></a><span id="l3.1071" class="difflineminus">-    // Mark all messages of aFolder as read:</span>
<a href="#l3.1072"></a><span id="l3.1072" class="difflineminus">-    // We can't use the command controller, because it is already tuned in to the</span>
<a href="#l3.1073"></a><span id="l3.1073" class="difflineminus">-    // new folder, so we just mimic its behaviour wrt goDoCommand('cmd_markAllRead').</span>
<a href="#l3.1074"></a><span id="l3.1074" class="difflineminus">-    if (gDBView &amp;&amp; gPrefBranch.getBoolPref(&quot;mailnews.mark_message_read.&quot; + aFolder.server.type))</span>
<a href="#l3.1075"></a><span id="l3.1075" class="difflineminus">-    {</span>
<a href="#l3.1076"></a><span id="l3.1076" class="difflineminus">-      gDBView.doCommand(nsMsgViewCommandType.markAllRead);</span>
<a href="#l3.1077"></a><span id="l3.1077" class="difflineminus">-    }</span>
<a href="#l3.1078"></a><span id="l3.1078" class="difflineminus">-  }</span>
<a href="#l3.1079"></a><span id="l3.1079" class="difflineminus">-  catch(e){/* ignore */}</span>
<a href="#l3.1080"></a><span id="l3.1080" class="difflineminus">-}</span>
<a href="#l3.1081"></a><span id="l3.1081" class="difflineminus">-</span>
<a href="#l3.1082"></a><span id="l3.1082" class="difflineminus">-var gViewDebug = false;</span>
<a href="#l3.1083"></a><span id="l3.1083" class="difflineminus">-</span>
<a href="#l3.1084"></a><span id="l3.1084" class="difflineminus">-function viewDebug(str)</span>
<a href="#l3.1085"></a><span id="l3.1085" class="difflineminus">-{</span>
<a href="#l3.1086"></a><span id="l3.1086" class="difflineminus">-  if (gViewDebug)</span>
<a href="#l3.1087"></a><span id="l3.1087" class="difflineminus">-    dump(str);</span>
<a href="#l3.1088"></a><span id="l3.1088" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/base/content/extraCustomizeItems.xul</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/base/content/extraCustomizeItems.xul</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1,46 +1,48 @@</span>
<a href="#l4.4"></a><span id="l4.4"> &lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineminus">-# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineminus">-# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineminus">-#</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineminus">-# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineminus">-# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineminus">-# the License. You may obtain a copy of the License at</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineminus">-# http://www.mozilla.org/MPL/</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-#</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-# for the specific language governing rights and limitations under the</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineminus">-# License.</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineminus">-#</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">-# The Original Code is Mozilla Communicator client code, released</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-# March 31, 1998.</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineminus">-#</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineminus">-# The Initial Developer of the Original Code is</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineminus">-# Netscape Communications Corporation.</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineminus">-# Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineminus">-# the Initial Developer. All Rights Reserved.</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineminus">-#</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineminus">-# Contributor(s):</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-#   Karsten Dsterloh &lt;mnyromyr@tprac.de&gt;</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineminus">-#   Simon Paquet &lt;bugzilla@babylonsounds.com&gt;</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineminus">-#</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-# either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-# the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineminus">-# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineminus">-# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineminus">-# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-# the provisions above, a recipient may use your version of this file under</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineminus">-# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineminus">-#</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">-# ***** END LICENSE BLOCK *****</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+&lt;!--</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+ - ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+ - Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+ -</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+ - The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+ - 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+ - the License. You may obtain a copy of the License at</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+ - http://www.mozilla.org/MPL/</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+ -</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+ - Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+ - WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+ - for the specific language governing rights and limitations under the</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+ - License.</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+ -</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+ - The Original Code is Mozilla Communicator client code, released</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+ - March 31, 1998.</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+ -</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+ - The Initial Developer of the Original Code is</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+ - Netscape Communications Corporation.</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+ - Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+ - the Initial Developer. All Rights Reserved.</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+ -</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+ - Contributor(s):</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+ -   Karsten Dsterloh &lt;mnyromyr@tprac.de&gt;</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+ -   Simon Paquet &lt;bugzilla@babylonsounds.com&gt;</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+ -</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+ - Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+ - either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+ - the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+ - in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+ - of those above. If you wish to allow use of your version of this file only</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+ - under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+ - use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+ - and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+ - the provisions above, a recipient may use your version of this file under</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+ - the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+ -</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+ - ***** END LICENSE BLOCK *****</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+ --&gt;</span>
<a href="#l4.81"></a><span id="l4.81"> </span>
<a href="#l4.82"></a><span id="l4.82"> &lt;!DOCTYPE overlay [</span>
<a href="#l4.83"></a><span id="l4.83">   &lt;!ENTITY % globalDTD SYSTEM &quot;chrome://global/locale/global.dtd&quot;&gt;</span>
<a href="#l4.84"></a><span id="l4.84">   %globalDTD;</span>
<a href="#l4.85"></a><span id="l4.85">   &lt;!ENTITY % messengerDTD SYSTEM &quot;chrome://messenger/locale/messenger.dtd&quot;&gt;</span>
<a href="#l4.86"></a><span id="l4.86">   %messengerDTD;</span>
<a href="#l4.87"></a><span id="l4.87">   &lt;!ENTITY % msgViewPickerDTD SYSTEM &quot;chrome://messenger/locale/msgViewPickerOverlay.dtd&quot; &gt;</span>
<a href="#l4.88"></a><span id="l4.88">   %msgViewPickerDTD;</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineat">@@ -152,20 +154,26 @@</span>
<a href="#l4.90"></a><span id="l4.90">                  title=&quot;&amp;mailViewsToolbarItem.title;&quot;</span>
<a href="#l4.91"></a><span id="l4.91">                  align=&quot;center&quot;</span>
<a href="#l4.92"></a><span id="l4.92">                  class=&quot;chromeclass-toolbar-additional&quot;&gt;</span>
<a href="#l4.93"></a><span id="l4.93">       &lt;label id=&quot;viewPickerLabel&quot;</span>
<a href="#l4.94"></a><span id="l4.94">              value=&quot;&amp;viewPicker.label;&quot;</span>
<a href="#l4.95"></a><span id="l4.95">              control=&quot;viewPicker&quot;</span>
<a href="#l4.96"></a><span id="l4.96">              accesskey=&quot;&amp;viewPicker.accesskey;&quot;/&gt;</span>
<a href="#l4.97"></a><span id="l4.97">       &lt;menulist id=&quot;viewPicker&quot; oncommand=&quot;ViewChangeByMenuitem(event.target);&quot;&gt;</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineminus">-        &lt;menupopup id=&quot;viewPickerPopup&quot; onpopupshowing=&quot;RefreshViewPopup(this, false);&quot;&gt;</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineminus">-          &lt;menuitem id=&quot;viewPickerAll&quot; value=&quot;0&quot; label=&quot;&amp;viewAll.label;&quot;/&gt;</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineminus">-          &lt;menuitem id=&quot;viewPickerUnread&quot; value=&quot;1&quot; label=&quot;&amp;viewUnread.label;&quot;/&gt;</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineminus">-          &lt;menuitem id=&quot;viewPickerNotDeleted&quot; value=&quot;3&quot; label=&quot;&amp;viewNotDeleted.label;&quot;/&gt;</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+        &lt;menupopup id=&quot;viewPickerPopup&quot; onpopupshowing=&quot;RefreshViewPopup(this);&quot;&gt;</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+          &lt;menuitem id=&quot;viewPickerAll&quot; value=&quot;0&quot;</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+                    label=&quot;&amp;viewAll.label;&quot;</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+                    type=&quot;radio&quot;/&gt;</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+          &lt;menuitem id=&quot;viewPickerUnread&quot; value=&quot;1&quot;</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+                    label=&quot;&amp;viewUnread.label;&quot;</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+                    type=&quot;radio&quot;/&gt;</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+          &lt;menuitem id=&quot;viewPickerNotDeleted&quot; value=&quot;3&quot;</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+                    label=&quot;&amp;viewNotDeleted.label;&quot;</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineplus">+                    type=&quot;radio&quot;/&gt;</span>
<a href="#l4.112"></a><span id="l4.112">           &lt;menuseparator id=&quot;afterViewPickerUnreadSeparator&quot;/&gt;</span>
<a href="#l4.113"></a><span id="l4.113">           &lt;menu id=&quot;viewPickerTags&quot; label=&quot;&amp;viewTags.label;&quot;&gt;</span>
<a href="#l4.114"></a><span id="l4.114">             &lt;menupopup id=&quot;viewPickerTagsPopup&quot;</span>
<a href="#l4.115"></a><span id="l4.115">                        class=&quot;menulist-menupopup&quot;</span>
<a href="#l4.116"></a><span id="l4.116">                        onpopupshowing=&quot;RefreshTagsPopup(this, true);&quot;/&gt;</span>
<a href="#l4.117"></a><span id="l4.117">           &lt;/menu&gt;</span>
<a href="#l4.118"></a><span id="l4.118">           &lt;menu id=&quot;viewPickerCustomViews&quot; label=&quot;&amp;viewCustomViews.label;&quot;&gt;</span>
<a href="#l4.119"></a><span id="l4.119">             &lt;menupopup id=&quot;viewPickerCustomViewsPopup&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">new file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- /dev/null</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ b/mail/base/content/folderDisplay.js</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -0,0 +1,2073 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineplus">+ *</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+ *</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+ * License.</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+ *</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+ *</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+ *</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+ *   David Bienvenu &lt;bienvenu@nventure.com&gt;</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+ *   Siddharth Agarwal &lt;sid.bugzilla@gmail.com&gt;</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+ *</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+ *</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/dbViewWrapper.js&quot;);</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+var gFolderDisplay = null;</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+var gMessageDisplay = null;</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+var nsMsgFolderFlags = Components.interfaces.nsMsgFolderFlags;</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+/**</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+ * Abstraction for a widget that (roughly speaking) displays the contents of</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+ *  folders.  The widget belongs to a tab and has a lifetime as long as the tab</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+ *  that contains it.  This class is strictly concerned with the UI aspects of</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+ *  this; the DBViewWrapper class handles the view details (and is exposed on</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+ *  the 'view' attribute.)</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+ *</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+ * The search window subclasses this into the SearchFolderDisplayWidget rather</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+ *  than us attempting to generalize everything excessively.  This is because</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+ *  we hate the search window and don't want to clutter up this code for it.</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+ * The standalone message display window also subclasses us; we do not hate it,</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+ *  but it's not invited to our birthday party either.</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+ * For reasons of simplicity and the original order of implementation, this</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+ *  class does alter its behavior slightly for the benefit of the standalone</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+ *  message window.  If no tab info is provided, we avoid touching tabmail</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+ *  (which is good, because it won't exist!)  And now we guard against treeBox</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+ *  manipulations...</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+ */</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+function FolderDisplayWidget(aTabInfo, aMessageDisplayWidget) {</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineplus">+  this._tabInfo = aTabInfo;</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineplus">+  /// If the folder does not get handled by the DBViewWrapper, stash it here.</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineplus">+  ///  ex: when isServer is true.</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineplus">+  this._nonViewFolder = null;</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+  this.view = new DBViewWrapper(this);</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineplus">+  this.messageDisplay = aMessageDisplayWidget;</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineplus">+  this.messageDisplay.folderDisplay = this;</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineplus">+  /**</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+   * The XUL tree node, as retrieved by getDocumentElementById.  The caller is</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineplus">+   *  responsible for setting this.</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+   */</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+  this.tree = null;</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+  /**</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+   * The nsITreeBoxObject on the XUL tree node, accessible from this.tree as</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+   *  this.tree.boxObject and QueryInterfaced as such.  The caller is</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineplus">+   *  responsible for setting this.</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+   */</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineplus">+  this.treeBox = null;</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineplus">+</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineplus">+  /**</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+   * The nsIMsgWindow corresponding to the window that holds us.  There is only</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineplus">+   *  one of these per tab.  The caller is responsible for setting this.</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineplus">+   */</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineplus">+  this.msgWindow = null;</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineplus">+  /**</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineplus">+   * The nsIMessenger instance that corresponds to our tab/window.  We do not</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineplus">+   *  use this ourselves, but are responsible for using it to update the</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineplus">+   *  global |messenger| object so that our tab maintains its own undo and</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineplus">+   *  navigation history.  At some point we might touch it for those reasons.</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineplus">+   */</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineplus">+  this.messenger = null;</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineplus">+  this.threadPaneCommandUpdater = this;</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineplus">+</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineplus">+  /**</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineplus">+   * Flag to expose whether all messages are loaded or not.  Set by</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineplus">+   *  onAllMessagesLoaded.</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineplus">+   */</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineplus">+  this._allMessagesLoaded = false;</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineplus">+</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineplus">+  /**</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineplus">+   * Save the top row displayed when we go inactive, restore when we go active,</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineplus">+   *  nuke it when we destroy the view.</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineplus">+   */</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineplus">+  this._savedFirstVisibleRow = null;</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineplus">+  /** the next view index to select once the delete completes */</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineplus">+  this._nextViewIndexAfterDelete = null;</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineplus">+  /**</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineplus">+   * Track when a mass move is in effect (we get told by hintMassMoveStarting,</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineplus">+   *  and hintMassMoveCompleted) so that we can avoid deletion-triggered</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineplus">+   *  moving to _nextViewIndexAfterDelete until the mass move completes.</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineplus">+   */</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineplus">+  this._massMoveActive = false;</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineplus">+</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineplus">+  /**</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineplus">+   * Used by pushNavigation to queue a navigation request for when we enter the</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineplus">+   *  next folder; onAllMessagesLoaded is the one that processes it.</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineplus">+   */</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineplus">+  this._pendingNavigation = null;</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineplus">+</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineplus">+  this._active = false;</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineplus">+  /**</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineplus">+   * A list of methods to call on 'this' object when we are next made active.</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineplus">+   *  This list is populated by calls to |_notifyWhenActive| when we are</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineplus">+   *  not active at the moment.</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineplus">+   */</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineplus">+  this._notificationsPendingActivation = [];</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineplus">+</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineplus">+  let dummyDOMNode = document.getElementById('mail-toolbox');</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineplus">+  /**</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineplus">+   * Create a fake tree box object for if/when this folder is in the background.</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineplus">+   * We need to give it a bogus DOM object to send events to, so we choose the</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineplus">+   *  mail-toolbox, who is hopefully unlikely to take offense.</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineplus">+   */</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineplus">+  this._fakeTreeBox = dummyDOMNode ?</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineplus">+                        new FakeTreeBoxObject(dummyDOMNode.boxObject) : null;</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineplus">+</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineplus">+  this._mostRecentSelectionCounts = [];</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineplus">+  this._mostRecentCurrentIndices = [];</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineplus">+}</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineplus">+FolderDisplayWidget.prototype = {</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineplus">+  /**</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineplus">+   * @return the currently displayed folder.  This is just proxied from the</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineplus">+   *     view wrapper.</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineplus">+   */</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineplus">+  get displayedFolder() {</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineplus">+    return this._nonViewFolder || this.view.displayedFolder;</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineplus">+  },</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineplus">+</span>
<a href="#l5.161"></a><span id="l5.161" class="difflineplus">+  /**</span>
<a href="#l5.162"></a><span id="l5.162" class="difflineplus">+   * @return the nsITreeSelection object for our tree view if there is one,</span>
<a href="#l5.163"></a><span id="l5.163" class="difflineplus">+   *     null otherwise.</span>
<a href="#l5.164"></a><span id="l5.164" class="difflineplus">+   */</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineplus">+  get treeSelection() {</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineplus">+    if (this.view.dbView)</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineplus">+      return this.view.dbView.selection;</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineplus">+    else</span>
<a href="#l5.169"></a><span id="l5.169" class="difflineplus">+      return null;</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineplus">+  },</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineplus">+</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineplus">+  /**</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineplus">+   * Number of headers to tell the message database to cache when we enter a</span>
<a href="#l5.174"></a><span id="l5.174" class="difflineplus">+   *  folder.  This value is being propagated from legacy code which provided</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineplus">+   *  no explanation for its choice.</span>
<a href="#l5.176"></a><span id="l5.176" class="difflineplus">+   *</span>
<a href="#l5.177"></a><span id="l5.177" class="difflineplus">+   * We definitely want the header cache size to be larger than the number of</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineplus">+   *  rows that can be displayed on screen simultaneously.</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineplus">+   */</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineplus">+  PERF_HEADER_CACHE_SIZE: 100,</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineplus">+</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineplus">+  /**</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineplus">+   * An optional list where each item is an object with the following</span>
<a href="#l5.184"></a><span id="l5.184" class="difflineplus">+   *  attributes sufficient to re-establish the selected items even in the face</span>
<a href="#l5.185"></a><span id="l5.185" class="difflineplus">+   *  of folder renaming.</span>
<a href="#l5.186"></a><span id="l5.186" class="difflineplus">+   * - messageId: The value of the message's message-id header.</span>
<a href="#l5.187"></a><span id="l5.187" class="difflineplus">+   *</span>
<a href="#l5.188"></a><span id="l5.188" class="difflineplus">+   * That's right, we only save the message-id header value.  This is arguably</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineplus">+   *  overkill and ambiguous in the face of duplicate messages, but it's the</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineplus">+   *  most persistent/reliable thing we have without gloda.</span>
<a href="#l5.191"></a><span id="l5.191" class="difflineplus">+   * Using the view index was ruled out because it is hardly stable.  Using the</span>
<a href="#l5.192"></a><span id="l5.192" class="difflineplus">+   *  message key alone is insufficient for cross-folder searches.  Using a</span>
<a href="#l5.193"></a><span id="l5.193" class="difflineplus">+   *  folder identifier and message key is insufficent for local folders in the</span>
<a href="#l5.194"></a><span id="l5.194" class="difflineplus">+   *  face of compaction, let alone complexities where the folder name may</span>
<a href="#l5.195"></a><span id="l5.195" class="difflineplus">+   *  change due to renaming/moving.  Which means we eventually need to fall</span>
<a href="#l5.196"></a><span id="l5.196" class="difflineplus">+   *  back to message-id anyways.  Feel free to add in lots of complexity if</span>
<a href="#l5.197"></a><span id="l5.197" class="difflineplus">+   *  you actually write unit tests for all the many possible cases.</span>
<a href="#l5.198"></a><span id="l5.198" class="difflineplus">+   * Additional justification is that selection saving/restoration should not</span>
<a href="#l5.199"></a><span id="l5.199" class="difflineplus">+   *  happen all that frequently.  A nice freebie is that message-id is</span>
<a href="#l5.200"></a><span id="l5.200" class="difflineplus">+   *  definitely persistable.</span>
<a href="#l5.201"></a><span id="l5.201" class="difflineplus">+   */</span>
<a href="#l5.202"></a><span id="l5.202" class="difflineplus">+  _savedSelection: null,</span>
<a href="#l5.203"></a><span id="l5.203" class="difflineplus">+</span>
<a href="#l5.204"></a><span id="l5.204" class="difflineplus">+  /**</span>
<a href="#l5.205"></a><span id="l5.205" class="difflineplus">+   * Save the current view selection for when we the view is getting destroyed</span>
<a href="#l5.206"></a><span id="l5.206" class="difflineplus">+   *  or otherwise re-ordered in such a way that the nsITreeSelection will lose</span>
<a href="#l5.207"></a><span id="l5.207" class="difflineplus">+   *  track of things (because it just has a naive view-index 'view' of the</span>
<a href="#l5.208"></a><span id="l5.208" class="difflineplus">+   *  world.)  We just save each message's message-id header.  This is overkill</span>
<a href="#l5.209"></a><span id="l5.209" class="difflineplus">+   *  and ambiguous in the face of duplicate messages (and expensive to</span>
<a href="#l5.210"></a><span id="l5.210" class="difflineplus">+   *  restore), but is also the most reliable option for this use case.</span>
<a href="#l5.211"></a><span id="l5.211" class="difflineplus">+   */</span>
<a href="#l5.212"></a><span id="l5.212" class="difflineplus">+  _saveSelection: function FolderDisplayWidget_saveSelection() {</span>
<a href="#l5.213"></a><span id="l5.213" class="difflineplus">+    this._savedSelection = [{messageId: msgHdr.messageId} for each</span>
<a href="#l5.214"></a><span id="l5.214" class="difflineplus">+                              ([, msgHdr] in Iterator(this.selectedMessages))];</span>
<a href="#l5.215"></a><span id="l5.215" class="difflineplus">+  },</span>
<a href="#l5.216"></a><span id="l5.216" class="difflineplus">+</span>
<a href="#l5.217"></a><span id="l5.217" class="difflineplus">+  /**</span>
<a href="#l5.218"></a><span id="l5.218" class="difflineplus">+   * Clear the saved selection.</span>
<a href="#l5.219"></a><span id="l5.219" class="difflineplus">+   */</span>
<a href="#l5.220"></a><span id="l5.220" class="difflineplus">+  _clearSavedSelection: function FolderDisplayWidget_clearSavedSelection() {</span>
<a href="#l5.221"></a><span id="l5.221" class="difflineplus">+    this._savedSelection = null;</span>
<a href="#l5.222"></a><span id="l5.222" class="difflineplus">+  },</span>
<a href="#l5.223"></a><span id="l5.223" class="difflineplus">+</span>
<a href="#l5.224"></a><span id="l5.224" class="difflineplus">+  /**</span>
<a href="#l5.225"></a><span id="l5.225" class="difflineplus">+   * Restore the view selection if we have a saved selection.  We must be</span>
<a href="#l5.226"></a><span id="l5.226" class="difflineplus">+   *  active!</span>
<a href="#l5.227"></a><span id="l5.227" class="difflineplus">+   *</span>
<a href="#l5.228"></a><span id="l5.228" class="difflineplus">+   * @return true if we were able to restore the selection and there was</span>
<a href="#l5.229"></a><span id="l5.229" class="difflineplus">+   *     a selection, false if there was no selection (anymore).</span>
<a href="#l5.230"></a><span id="l5.230" class="difflineplus">+   */</span>
<a href="#l5.231"></a><span id="l5.231" class="difflineplus">+  _restoreSelection: function FolderDisplayWidget_restoreSelection() {</span>
<a href="#l5.232"></a><span id="l5.232" class="difflineplus">+    if (!this._savedSelection || !this._active)</span>
<a href="#l5.233"></a><span id="l5.233" class="difflineplus">+      return false;</span>
<a href="#l5.234"></a><span id="l5.234" class="difflineplus">+</span>
<a href="#l5.235"></a><span id="l5.235" class="difflineplus">+    // translate message IDs back to messages.  this is O(s(m+n)) where:</span>
<a href="#l5.236"></a><span id="l5.236" class="difflineplus">+    // - s is the number of messages saved in the selection</span>
<a href="#l5.237"></a><span id="l5.237" class="difflineplus">+    // - m is the number of messages in the view (from findIndexOfMsgHdr)</span>
<a href="#l5.238"></a><span id="l5.238" class="difflineplus">+    // - n is the number of messages in the underlying folders (from</span>
<a href="#l5.239"></a><span id="l5.239" class="difflineplus">+    //   DBViewWrapper.getMsgHdrForMessageID).</span>
<a href="#l5.240"></a><span id="l5.240" class="difflineplus">+    // which ends up being O(sn)</span>
<a href="#l5.241"></a><span id="l5.241" class="difflineplus">+    var msgHdr;</span>
<a href="#l5.242"></a><span id="l5.242" class="difflineplus">+    let messages =</span>
<a href="#l5.243"></a><span id="l5.243" class="difflineplus">+      [msgHdr for each</span>
<a href="#l5.244"></a><span id="l5.244" class="difflineplus">+        ([, savedInfo] in Iterator(this._savedSelection)) if</span>
<a href="#l5.245"></a><span id="l5.245" class="difflineplus">+        ((msgHdr = this.view.getMsgHdrForMessageID(savedInfo.messageId)))];</span>
<a href="#l5.246"></a><span id="l5.246" class="difflineplus">+</span>
<a href="#l5.247"></a><span id="l5.247" class="difflineplus">+    this.selectMessages(messages, true);</span>
<a href="#l5.248"></a><span id="l5.248" class="difflineplus">+    this._savedSelection = null;</span>
<a href="#l5.249"></a><span id="l5.249" class="difflineplus">+</span>
<a href="#l5.250"></a><span id="l5.250" class="difflineplus">+    return this.selectedCount != 0;</span>
<a href="#l5.251"></a><span id="l5.251" class="difflineplus">+  },</span>
<a href="#l5.252"></a><span id="l5.252" class="difflineplus">+</span>
<a href="#l5.253"></a><span id="l5.253" class="difflineplus">+  /**</span>
<a href="#l5.254"></a><span id="l5.254" class="difflineplus">+   * Maps column ids to functions that test whether the column is legal for</span>
<a href="#l5.255"></a><span id="l5.255" class="difflineplus">+   *  display for the folder.  Each function should expect a DBViewWrapper</span>
<a href="#l5.256"></a><span id="l5.256" class="difflineplus">+   *  instance as its argument.  The intent is that the various helper</span>
<a href="#l5.257"></a><span id="l5.257" class="difflineplus">+   *  properties like isMailFolder/isIncomingFolder/isOutgoingFolder allow the</span>
<a href="#l5.258"></a><span id="l5.258" class="difflineplus">+   *  constraint to be expressed concisely.  If a helper does not exist, add</span>
<a href="#l5.259"></a><span id="l5.259" class="difflineplus">+   *  one! (If doing so is out of reach, than access viewWrapper.displayedFolder</span>
<a href="#l5.260"></a><span id="l5.260" class="difflineplus">+   *  to get at the nsIMsgFolder.)</span>
<a href="#l5.261"></a><span id="l5.261" class="difflineplus">+   * If a column does not have a function, it is assumed to be legal for display</span>
<a href="#l5.262"></a><span id="l5.262" class="difflineplus">+   *  in all cases.</span>
<a href="#l5.263"></a><span id="l5.263" class="difflineplus">+   */</span>
<a href="#l5.264"></a><span id="l5.264" class="difflineplus">+  COLUMN_LEGALITY_TESTERS: {</span>
<a href="#l5.265"></a><span id="l5.265" class="difflineplus">+    // Only show 'Received' column for e-mails.  For newsgroup messages, the</span>
<a href="#l5.266"></a><span id="l5.266" class="difflineplus">+    // 'Date' header is as reliable as an e-mail's 'Received' header, as it is</span>
<a href="#l5.267"></a><span id="l5.267" class="difflineplus">+    // replaced with the news server's (more reliable) date.</span>
<a href="#l5.268"></a><span id="l5.268" class="difflineplus">+    receivedCol: function (viewWrapper) {</span>
<a href="#l5.269"></a><span id="l5.269" class="difflineplus">+      return viewWrapper.isMailFolder &amp;&amp; !viewWrapper.isOutgoingFolder;</span>
<a href="#l5.270"></a><span id="l5.270" class="difflineplus">+    },</span>
<a href="#l5.271"></a><span id="l5.271" class="difflineplus">+    // senderCol = From.  You only care in incoming folders.</span>
<a href="#l5.272"></a><span id="l5.272" class="difflineplus">+    senderCol: function (viewWrapper) {</span>
<a href="#l5.273"></a><span id="l5.273" class="difflineplus">+      return viewWrapper.isIncomingFolder;</span>
<a href="#l5.274"></a><span id="l5.274" class="difflineplus">+    },</span>
<a href="#l5.275"></a><span id="l5.275" class="difflineplus">+    // recipient = To. You only care in outgoing folders.</span>
<a href="#l5.276"></a><span id="l5.276" class="difflineplus">+    recipientCol: function (viewWrapper) {</span>
<a href="#l5.277"></a><span id="l5.277" class="difflineplus">+      return viewWrapper.isOutgoingFolder;</span>
<a href="#l5.278"></a><span id="l5.278" class="difflineplus">+    },</span>
<a href="#l5.279"></a><span id="l5.279" class="difflineplus">+    // Only show the location column for non-single-folder results</span>
<a href="#l5.280"></a><span id="l5.280" class="difflineplus">+    locationCol: function(viewWrapper) {</span>
<a href="#l5.281"></a><span id="l5.281" class="difflineplus">+      return !viewWrapper.isSingleFolder;</span>
<a href="#l5.282"></a><span id="l5.282" class="difflineplus">+    },</span>
<a href="#l5.283"></a><span id="l5.283" class="difflineplus">+  },</span>
<a href="#l5.284"></a><span id="l5.284" class="difflineplus">+</span>
<a href="#l5.285"></a><span id="l5.285" class="difflineplus">+  /**</span>
<a href="#l5.286"></a><span id="l5.286" class="difflineplus">+   * If we determine that a column is illegal but was displayed, use this</span>
<a href="#l5.287"></a><span id="l5.287" class="difflineplus">+   *  mapping to find suggested legal alternatives.  This basically exists</span>
<a href="#l5.288"></a><span id="l5.288" class="difflineplus">+   *  just to flip-flop between senderCol and recipientCol.</span>
<a href="#l5.289"></a><span id="l5.289" class="difflineplus">+   */</span>
<a href="#l5.290"></a><span id="l5.290" class="difflineplus">+  COLUMN_LEGAL_ALTERNATIVES: {</span>
<a href="#l5.291"></a><span id="l5.291" class="difflineplus">+    // swap between sender and recipient</span>
<a href="#l5.292"></a><span id="l5.292" class="difflineplus">+    senderCol: [&quot;recipientCol&quot;],</span>
<a href="#l5.293"></a><span id="l5.293" class="difflineplus">+    recipientCol: [&quot;senderCol&quot;],</span>
<a href="#l5.294"></a><span id="l5.294" class="difflineplus">+    // if we nuke received, put back date...</span>
<a href="#l5.295"></a><span id="l5.295" class="difflineplus">+    receivedCol: [&quot;dateCol&quot;],</span>
<a href="#l5.296"></a><span id="l5.296" class="difflineplus">+  },</span>
<a href="#l5.297"></a><span id="l5.297" class="difflineplus">+</span>
<a href="#l5.298"></a><span id="l5.298" class="difflineplus">+  /**</span>
<a href="#l5.299"></a><span id="l5.299" class="difflineplus">+   * Columns to display whenever we can.  This is currently a bit of a hack to</span>
<a href="#l5.300"></a><span id="l5.300" class="difflineplus">+   *  always show the location column when relevant.  Arguably, it would be</span>
<a href="#l5.301"></a><span id="l5.301" class="difflineplus">+   *  better to use this as a default for a folder you've never been in and</span>
<a href="#l5.302"></a><span id="l5.302" class="difflineplus">+   *  the rest of the time we restore the last column set for that folder from</span>
<a href="#l5.303"></a><span id="l5.303" class="difflineplus">+   *  properties.</span>
<a href="#l5.304"></a><span id="l5.304" class="difflineplus">+   */</span>
<a href="#l5.305"></a><span id="l5.305" class="difflineplus">+  COLUMNS_DISPLAY_WHEN_POSSIBLE: [&quot;locationCol&quot;],</span>
<a href="#l5.306"></a><span id="l5.306" class="difflineplus">+</span>
<a href="#l5.307"></a><span id="l5.307" class="difflineplus">+  /**</span>
<a href="#l5.308"></a><span id="l5.308" class="difflineplus">+   * Update the displayed columns so that:</span>
<a href="#l5.309"></a><span id="l5.309" class="difflineplus">+   * - Only legal columns (per COLUMN_LEGALITY_TESTERS) are displayed.</span>
<a href="#l5.310"></a><span id="l5.310" class="difflineplus">+   * - Alternatives to now-illegal columns may be displayed.</span>
<a href="#l5.311"></a><span id="l5.311" class="difflineplus">+   */</span>
<a href="#l5.312"></a><span id="l5.312" class="difflineplus">+  updateColumns: function() {</span>
<a href="#l5.313"></a><span id="l5.313" class="difflineplus">+    // Keep a list of columns we might want to make show up if they are not</span>
<a href="#l5.314"></a><span id="l5.314" class="difflineplus">+    //  illegal.</span>
<a href="#l5.315"></a><span id="l5.315" class="difflineplus">+    let legalize = this.COLUMNS_DISPLAY_WHEN_POSSIBLE.concat();</span>
<a href="#l5.316"></a><span id="l5.316" class="difflineplus">+</span>
<a href="#l5.317"></a><span id="l5.317" class="difflineplus">+    // figure out who is illegal and make them go away</span>
<a href="#l5.318"></a><span id="l5.318" class="difflineplus">+    for (let [colId, legalityFunc] in Iterator(this.COLUMN_LEGALITY_TESTERS)) {</span>
<a href="#l5.319"></a><span id="l5.319" class="difflineplus">+      let column = document.getElementById(colId);</span>
<a href="#l5.320"></a><span id="l5.320" class="difflineplus">+      // The search window does not have all the columns we know about, bail in</span>
<a href="#l5.321"></a><span id="l5.321" class="difflineplus">+      //  such cases.</span>
<a href="#l5.322"></a><span id="l5.322" class="difflineplus">+      if (!column)</span>
<a href="#l5.323"></a><span id="l5.323" class="difflineplus">+        continue;</span>
<a href="#l5.324"></a><span id="l5.324" class="difflineplus">+      let legal = legalityFunc(this.view);</span>
<a href="#l5.325"></a><span id="l5.325" class="difflineplus">+</span>
<a href="#l5.326"></a><span id="l5.326" class="difflineplus">+      if (!legal) {</span>
<a href="#l5.327"></a><span id="l5.327" class="difflineplus">+        let isHidden = column.getAttribute(&quot;hidden&quot;) == &quot;true&quot;;</span>
<a href="#l5.328"></a><span id="l5.328" class="difflineplus">+        // If it wasn't hidden, consider making its alternatives visible in the</span>
<a href="#l5.329"></a><span id="l5.329" class="difflineplus">+        //  next pass.</span>
<a href="#l5.330"></a><span id="l5.330" class="difflineplus">+        if (!isHidden &amp;&amp; (colId in this.COLUMN_LEGAL_ALTERNATIVES))</span>
<a href="#l5.331"></a><span id="l5.331" class="difflineplus">+          legalize = legalize.concat(this.COLUMN_LEGAL_ALTERNATIVES[colId]);</span>
<a href="#l5.332"></a><span id="l5.332" class="difflineplus">+        // but definitely hide the heck out of it right now</span>
<a href="#l5.333"></a><span id="l5.333" class="difflineplus">+        column.setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l5.334"></a><span id="l5.334" class="difflineplus">+        column.setAttribute(&quot;ignoreincolumnpicker&quot;, true);</span>
<a href="#l5.335"></a><span id="l5.335" class="difflineplus">+      }</span>
<a href="#l5.336"></a><span id="l5.336" class="difflineplus">+      else {</span>
<a href="#l5.337"></a><span id="l5.337" class="difflineplus">+        column.removeAttribute(&quot;ignoreincolumnpicker&quot;);</span>
<a href="#l5.338"></a><span id="l5.338" class="difflineplus">+      }</span>
<a href="#l5.339"></a><span id="l5.339" class="difflineplus">+    }</span>
<a href="#l5.340"></a><span id="l5.340" class="difflineplus">+    // If we have any columns we should consider making visible because they are</span>
<a href="#l5.341"></a><span id="l5.341" class="difflineplus">+    //  alternatives to columns that became illegal, uh, do that.</span>
<a href="#l5.342"></a><span id="l5.342" class="difflineplus">+    for each (let [, colId] in Iterator(legalize)) {</span>
<a href="#l5.343"></a><span id="l5.343" class="difflineplus">+      let column = document.getElementById(colId);</span>
<a href="#l5.344"></a><span id="l5.344" class="difflineplus">+      let isLegal = column.getAttribute(&quot;ignoreincolumnpicker&quot;) != &quot;true&quot;;</span>
<a href="#l5.345"></a><span id="l5.345" class="difflineplus">+      let isHidden = column.getAttribute(&quot;hidden&quot;) == &quot;true&quot;;</span>
<a href="#l5.346"></a><span id="l5.346" class="difflineplus">+      if (isLegal &amp;&amp; isHidden)</span>
<a href="#l5.347"></a><span id="l5.347" class="difflineplus">+        column.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l5.348"></a><span id="l5.348" class="difflineplus">+    }</span>
<a href="#l5.349"></a><span id="l5.349" class="difflineplus">+  },</span>
<a href="#l5.350"></a><span id="l5.350" class="difflineplus">+</span>
<a href="#l5.351"></a><span id="l5.351" class="difflineplus">+  /**</span>
<a href="#l5.352"></a><span id="l5.352" class="difflineplus">+   * @param aColumnMap an object where the attribute names are column ids and</span>
<a href="#l5.353"></a><span id="l5.353" class="difflineplus">+   *     the values are a boolean indicating whether the column should be</span>
<a href="#l5.354"></a><span id="l5.354" class="difflineplus">+   *     visible or not.  If a column is not in the map, it is assumed that it</span>
<a href="#l5.355"></a><span id="l5.355" class="difflineplus">+   *     should be hidden.</span>
<a href="#l5.356"></a><span id="l5.356" class="difflineplus">+   */</span>
<a href="#l5.357"></a><span id="l5.357" class="difflineplus">+  setVisibleColumns: function(aColumnMap) {</span>
<a href="#l5.358"></a><span id="l5.358" class="difflineplus">+    let cols = document.getElementById(&quot;threadCols&quot;);</span>
<a href="#l5.359"></a><span id="l5.359" class="difflineplus">+    let colChildren = cols.children;</span>
<a href="#l5.360"></a><span id="l5.360" class="difflineplus">+</span>
<a href="#l5.361"></a><span id="l5.361" class="difflineplus">+    // because the splitter correspondence can be confusing and tricky, let's</span>
<a href="#l5.362"></a><span id="l5.362" class="difflineplus">+    //  build a list of the nodes ordered by their ordinal</span>
<a href="#l5.363"></a><span id="l5.363" class="difflineplus">+    let ordinalOrdered = [], iKid;</span>
<a href="#l5.364"></a><span id="l5.364" class="difflineplus">+    for (iKid = 0; iKid &lt; colChildren.length; iKid++)</span>
<a href="#l5.365"></a><span id="l5.365" class="difflineplus">+      ordinalOrdered.push(null);</span>
<a href="#l5.366"></a><span id="l5.366" class="difflineplus">+</span>
<a href="#l5.367"></a><span id="l5.367" class="difflineplus">+    for (iKid = 0; iKid &lt; colChildren.length; iKid++) {</span>
<a href="#l5.368"></a><span id="l5.368" class="difflineplus">+      let colChild = colChildren[iKid];</span>
<a href="#l5.369"></a><span id="l5.369" class="difflineplus">+      let ordinal = colChild.getAttribute(&quot;ordinal&quot;) - 1;</span>
<a href="#l5.370"></a><span id="l5.370" class="difflineplus">+      ordinalOrdered[ordinal] = colChild;</span>
<a href="#l5.371"></a><span id="l5.371" class="difflineplus">+    }</span>
<a href="#l5.372"></a><span id="l5.372" class="difflineplus">+</span>
<a href="#l5.373"></a><span id="l5.373" class="difflineplus">+    function twiddleAround(index, makeHidden) {</span>
<a href="#l5.374"></a><span id="l5.374" class="difflineplus">+      if (index + 1 &lt; ordinalOrdered.length) {</span>
<a href="#l5.375"></a><span id="l5.375" class="difflineplus">+        let nexty = ordinalOrdered[index+1];</span>
<a href="#l5.376"></a><span id="l5.376" class="difflineplus">+        if (nexty) {</span>
<a href="#l5.377"></a><span id="l5.377" class="difflineplus">+          let isHidden = nexty.getAttribute(&quot;hidden&quot;) == &quot;true&quot;;</span>
<a href="#l5.378"></a><span id="l5.378" class="difflineplus">+          if (isHidden != makeHidden) {</span>
<a href="#l5.379"></a><span id="l5.379" class="difflineplus">+            nexty.setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l5.380"></a><span id="l5.380" class="difflineplus">+            return;</span>
<a href="#l5.381"></a><span id="l5.381" class="difflineplus">+          }</span>
<a href="#l5.382"></a><span id="l5.382" class="difflineplus">+        }</span>
<a href="#l5.383"></a><span id="l5.383" class="difflineplus">+      }</span>
<a href="#l5.384"></a><span id="l5.384" class="difflineplus">+      if (index - 1 &gt; 0) {</span>
<a href="#l5.385"></a><span id="l5.385" class="difflineplus">+        let prevy = ordinalOrdered[index-1];</span>
<a href="#l5.386"></a><span id="l5.386" class="difflineplus">+        if (prevy) {</span>
<a href="#l5.387"></a><span id="l5.387" class="difflineplus">+          let isHidden = prevy.getAttribute(&quot;hidden&quot;) == &quot;true&quot;;</span>
<a href="#l5.388"></a><span id="l5.388" class="difflineplus">+          if (isHidden != makeHidden) {</span>
<a href="#l5.389"></a><span id="l5.389" class="difflineplus">+            prevy.setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l5.390"></a><span id="l5.390" class="difflineplus">+            return;</span>
<a href="#l5.391"></a><span id="l5.391" class="difflineplus">+          }</span>
<a href="#l5.392"></a><span id="l5.392" class="difflineplus">+        }</span>
<a href="#l5.393"></a><span id="l5.393" class="difflineplus">+      }</span>
<a href="#l5.394"></a><span id="l5.394" class="difflineplus">+    }</span>
<a href="#l5.395"></a><span id="l5.395" class="difflineplus">+</span>
<a href="#l5.396"></a><span id="l5.396" class="difflineplus">+    for (iKid = 0; iKid &lt; ordinalOrdered.length; iKid++) {</span>
<a href="#l5.397"></a><span id="l5.397" class="difflineplus">+      let colChild = ordinalOrdered[iKid];</span>
<a href="#l5.398"></a><span id="l5.398" class="difflineplus">+      if (colChild == null)</span>
<a href="#l5.399"></a><span id="l5.399" class="difflineplus">+        continue;</span>
<a href="#l5.400"></a><span id="l5.400" class="difflineplus">+</span>
<a href="#l5.401"></a><span id="l5.401" class="difflineplus">+      if (colChild.tagName == &quot;treecol&quot;) {</span>
<a href="#l5.402"></a><span id="l5.402" class="difflineplus">+        if (colChild.id in aColumnMap) {</span>
<a href="#l5.403"></a><span id="l5.403" class="difflineplus">+          // only need to do something if currently hidden</span>
<a href="#l5.404"></a><span id="l5.404" class="difflineplus">+          if (colChild.getAttribute(&quot;hidden&quot;) == &quot;true&quot;) {</span>
<a href="#l5.405"></a><span id="l5.405" class="difflineplus">+            colChild.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l5.406"></a><span id="l5.406" class="difflineplus">+            twiddleAround(iKid, false);</span>
<a href="#l5.407"></a><span id="l5.407" class="difflineplus">+          }</span>
<a href="#l5.408"></a><span id="l5.408" class="difflineplus">+        }</span>
<a href="#l5.409"></a><span id="l5.409" class="difflineplus">+        else {</span>
<a href="#l5.410"></a><span id="l5.410" class="difflineplus">+          // only need to do something if currently visible</span>
<a href="#l5.411"></a><span id="l5.411" class="difflineplus">+          if (colChild.getAttribute(&quot;hidden&quot;) != &quot;true&quot;) {</span>
<a href="#l5.412"></a><span id="l5.412" class="difflineplus">+            colChild.setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l5.413"></a><span id="l5.413" class="difflineplus">+            twiddleAround(iKid, true);</span>
<a href="#l5.414"></a><span id="l5.414" class="difflineplus">+          }</span>
<a href="#l5.415"></a><span id="l5.415" class="difflineplus">+        }</span>
<a href="#l5.416"></a><span id="l5.416" class="difflineplus">+      }</span>
<a href="#l5.417"></a><span id="l5.417" class="difflineplus">+    }</span>
<a href="#l5.418"></a><span id="l5.418" class="difflineplus">+  },</span>
<a href="#l5.419"></a><span id="l5.419" class="difflineplus">+</span>
<a href="#l5.420"></a><span id="l5.420" class="difflineplus">+  _savedColumnStates: null,</span>
<a href="#l5.421"></a><span id="l5.421" class="difflineplus">+</span>
<a href="#l5.422"></a><span id="l5.422" class="difflineplus">+  /**</span>
<a href="#l5.423"></a><span id="l5.423" class="difflineplus">+   * For now, just save the visible columns into a dictionary for use in a</span>
<a href="#l5.424"></a><span id="l5.424" class="difflineplus">+   *  subsequent call to setVisibleColumns.  This does not do anything about</span>
<a href="#l5.425"></a><span id="l5.425" class="difflineplus">+   *  re-arranging columns.</span>
<a href="#l5.426"></a><span id="l5.426" class="difflineplus">+   */</span>
<a href="#l5.427"></a><span id="l5.427" class="difflineplus">+  saveColumnStates: function() {</span>
<a href="#l5.428"></a><span id="l5.428" class="difflineplus">+    // In the actual nsITreeColumn, the index property indicates the column</span>
<a href="#l5.429"></a><span id="l5.429" class="difflineplus">+    //  number.  This column number is a 0-based index with no gaps; it only</span>
<a href="#l5.430"></a><span id="l5.430" class="difflineplus">+    //  increments the number each time it sees a column.</span>
<a href="#l5.431"></a><span id="l5.431" class="difflineplus">+    // However, this is subservient to the 'ordinal' property which</span>
<a href="#l5.432"></a><span id="l5.432" class="difflineplus">+    //  defines the _apparent content sequence_ provided by GetNextSibling.</span>
<a href="#l5.433"></a><span id="l5.433" class="difflineplus">+    //  The underlying content ordering is still the same, which is how</span>
<a href="#l5.434"></a><span id="l5.434" class="difflineplus">+    //  restoreNaturalOrder can reset things to their XUL definition sequence.</span>
<a href="#l5.435"></a><span id="l5.435" class="difflineplus">+    //  The 'ordinal' stuff works because nsBoxFrame::RelayoutChildAtOrdinal</span>
<a href="#l5.436"></a><span id="l5.436" class="difflineplus">+    //  messes with the sibling relationship.</span>
<a href="#l5.437"></a><span id="l5.437" class="difflineplus">+    // Ordinals are 1-based.  restoreNaturalOrder apparently is dumb and does</span>
<a href="#l5.438"></a><span id="l5.438" class="difflineplus">+    //  not know this, although the ordering is relative so it doesn't actually</span>
<a href="#l5.439"></a><span id="l5.439" class="difflineplus">+    //  matter.  The annoying splitters do have ordinals, and live between</span>
<a href="#l5.440"></a><span id="l5.440" class="difflineplus">+    //  tree columns.  The splitters adjacent to a tree column do not need to</span>
<a href="#l5.441"></a><span id="l5.441" class="difflineplus">+    //  have any 'ordinal' relationship, although it would appear user activity</span>
<a href="#l5.442"></a><span id="l5.442" class="difflineplus">+    //  tends to move them around in a predictable fashion with oddness involved</span>
<a href="#l5.443"></a><span id="l5.443" class="difflineplus">+    //  at the edges.</span>
<a href="#l5.444"></a><span id="l5.444" class="difflineplus">+    // Changes to the ordinal attribute should take immediate effect in terms of</span>
<a href="#l5.445"></a><span id="l5.445" class="difflineplus">+    //  sibling relationship, but will merely invalidate the columns rather than</span>
<a href="#l5.446"></a><span id="l5.446" class="difflineplus">+    //  cause a re-computaiton of column relationships every time.</span>
<a href="#l5.447"></a><span id="l5.447" class="difflineplus">+    // restoreNaturalOrder invalidates the tree when it is done re-ordering; I'm</span>
<a href="#l5.448"></a><span id="l5.448" class="difflineplus">+    //  not sure that's entirely necessary...</span>
<a href="#l5.449"></a><span id="l5.449" class="difflineplus">+</span>
<a href="#l5.450"></a><span id="l5.450" class="difflineplus">+    let visibleMap = {};</span>
<a href="#l5.451"></a><span id="l5.451" class="difflineplus">+</span>
<a href="#l5.452"></a><span id="l5.452" class="difflineplus">+    let cols = document.getElementById(&quot;threadCols&quot;);</span>
<a href="#l5.453"></a><span id="l5.453" class="difflineplus">+    let colChildren = cols.children;</span>
<a href="#l5.454"></a><span id="l5.454" class="difflineplus">+    for (let iKid = 0; iKid &lt; colChildren.length; iKid++) {</span>
<a href="#l5.455"></a><span id="l5.455" class="difflineplus">+      let colChild = colChildren[iKid];</span>
<a href="#l5.456"></a><span id="l5.456" class="difflineplus">+      if (colChild.getAttribute(&quot;hidden&quot;) != &quot;true&quot;)</span>
<a href="#l5.457"></a><span id="l5.457" class="difflineplus">+        visibleMap[colChild.id] = true;</span>
<a href="#l5.458"></a><span id="l5.458" class="difflineplus">+    }</span>
<a href="#l5.459"></a><span id="l5.459" class="difflineplus">+</span>
<a href="#l5.460"></a><span id="l5.460" class="difflineplus">+    this._savedColumnStates = visibleMap;</span>
<a href="#l5.461"></a><span id="l5.461" class="difflineplus">+  },</span>
<a href="#l5.462"></a><span id="l5.462" class="difflineplus">+</span>
<a href="#l5.463"></a><span id="l5.463" class="difflineplus">+  /**</span>
<a href="#l5.464"></a><span id="l5.464" class="difflineplus">+   * Restores the visible columns saved by saveColumnStates.  Some day, in the</span>
<a href="#l5.465"></a><span id="l5.465" class="difflineplus">+   *  future we might do something about positions and the like.  But we don't</span>
<a href="#l5.466"></a><span id="l5.466" class="difflineplus">+   *  currently.</span>
<a href="#l5.467"></a><span id="l5.467" class="difflineplus">+   */</span>
<a href="#l5.468"></a><span id="l5.468" class="difflineplus">+  restoreColumnStates: function () {</span>
<a href="#l5.469"></a><span id="l5.469" class="difflineplus">+    if (this._savedColumnStates) {</span>
<a href="#l5.470"></a><span id="l5.470" class="difflineplus">+      this.setVisibleColumns(this._savedColumnStates);</span>
<a href="#l5.471"></a><span id="l5.471" class="difflineplus">+      this._savedColumnStates = null;</span>
<a href="#l5.472"></a><span id="l5.472" class="difflineplus">+    }</span>
<a href="#l5.473"></a><span id="l5.473" class="difflineplus">+  },</span>
<a href="#l5.474"></a><span id="l5.474" class="difflineplus">+</span>
<a href="#l5.475"></a><span id="l5.475" class="difflineplus">+  showFolderUri: function FolderDisplayWidget_showFolderUri(aFolderURI) {</span>
<a href="#l5.476"></a><span id="l5.476" class="difflineplus">+    return this.show(GetMsgFolderFromUri(aFolderURI));</span>
<a href="#l5.477"></a><span id="l5.477" class="difflineplus">+  },</span>
<a href="#l5.478"></a><span id="l5.478" class="difflineplus">+</span>
<a href="#l5.479"></a><span id="l5.479" class="difflineplus">+  /**</span>
<a href="#l5.480"></a><span id="l5.480" class="difflineplus">+   * Invoked by showFolder when it turns out the folder is in fact a server.</span>
<a href="#l5.481"></a><span id="l5.481" class="difflineplus">+   */</span>
<a href="#l5.482"></a><span id="l5.482" class="difflineplus">+  _showServer: function FolderDisplayWidget__showServer() {</span>
<a href="#l5.483"></a><span id="l5.483" class="difflineplus">+    // currently nothing to do.  makeActive handles everything for us (because</span>
<a href="#l5.484"></a><span id="l5.484" class="difflineplus">+    //  what is displayed needs to be re-asserted each time we are activated</span>
<a href="#l5.485"></a><span id="l5.485" class="difflineplus">+    //  too.)</span>
<a href="#l5.486"></a><span id="l5.486" class="difflineplus">+  },</span>
<a href="#l5.487"></a><span id="l5.487" class="difflineplus">+</span>
<a href="#l5.488"></a><span id="l5.488" class="difflineplus">+  /**</span>
<a href="#l5.489"></a><span id="l5.489" class="difflineplus">+   * Select a folder for display.</span>
<a href="#l5.490"></a><span id="l5.490" class="difflineplus">+   *</span>
<a href="#l5.491"></a><span id="l5.491" class="difflineplus">+   * @param aFolder The nsIMsgDBFolder to display.</span>
<a href="#l5.492"></a><span id="l5.492" class="difflineplus">+   */</span>
<a href="#l5.493"></a><span id="l5.493" class="difflineplus">+  show: function FolderDisplayWidget_show(aFolder) {</span>
<a href="#l5.494"></a><span id="l5.494" class="difflineplus">+    if (aFolder == null) {</span>
<a href="#l5.495"></a><span id="l5.495" class="difflineplus">+      this._nonViewFolder = null;</span>
<a href="#l5.496"></a><span id="l5.496" class="difflineplus">+      this.view.close();</span>
<a href="#l5.497"></a><span id="l5.497" class="difflineplus">+    }</span>
<a href="#l5.498"></a><span id="l5.498" class="difflineplus">+    else if (aFolder instanceof Components.interfaces.nsIMsgFolder) {</span>
<a href="#l5.499"></a><span id="l5.499" class="difflineplus">+      if (aFolder.isServer) {</span>
<a href="#l5.500"></a><span id="l5.500" class="difflineplus">+        this._nonViewFolder = aFolder;</span>
<a href="#l5.501"></a><span id="l5.501" class="difflineplus">+        this._showServer();</span>
<a href="#l5.502"></a><span id="l5.502" class="difflineplus">+        this.view.close();</span>
<a href="#l5.503"></a><span id="l5.503" class="difflineplus">+        // A server is fully loaded immediately, for now.  (When we have the</span>
<a href="#l5.504"></a><span id="l5.504" class="difflineplus">+        //  account summary, we might want to change this to wait for the page</span>
<a href="#l5.505"></a><span id="l5.505" class="difflineplus">+        //  load to complete.)</span>
<a href="#l5.506"></a><span id="l5.506" class="difflineplus">+        this._allMessagesLoaded = true;</span>
<a href="#l5.507"></a><span id="l5.507" class="difflineplus">+      }</span>
<a href="#l5.508"></a><span id="l5.508" class="difflineplus">+      else {</span>
<a href="#l5.509"></a><span id="l5.509" class="difflineplus">+        this._nonViewFolder = null;</span>
<a href="#l5.510"></a><span id="l5.510" class="difflineplus">+        this.view.open(aFolder);</span>
<a href="#l5.511"></a><span id="l5.511" class="difflineplus">+      }</span>
<a href="#l5.512"></a><span id="l5.512" class="difflineplus">+    }</span>
<a href="#l5.513"></a><span id="l5.513" class="difflineplus">+    // it must be a synthetic view</span>
<a href="#l5.514"></a><span id="l5.514" class="difflineplus">+    else {</span>
<a href="#l5.515"></a><span id="l5.515" class="difflineplus">+      this.view.openSynthetic(aFolder);</span>
<a href="#l5.516"></a><span id="l5.516" class="difflineplus">+    }</span>
<a href="#l5.517"></a><span id="l5.517" class="difflineplus">+    if (this._active)</span>
<a href="#l5.518"></a><span id="l5.518" class="difflineplus">+      this.makeActive();</span>
<a href="#l5.519"></a><span id="l5.519" class="difflineplus">+</span>
<a href="#l5.520"></a><span id="l5.520" class="difflineplus">+    if (this._tabInfo)</span>
<a href="#l5.521"></a><span id="l5.521" class="difflineplus">+      document.getElementById('tabmail').setTabTitle(this._tabInfo);</span>
<a href="#l5.522"></a><span id="l5.522" class="difflineplus">+  },</span>
<a href="#l5.523"></a><span id="l5.523" class="difflineplus">+</span>
<a href="#l5.524"></a><span id="l5.524" class="difflineplus">+  /**</span>
<a href="#l5.525"></a><span id="l5.525" class="difflineplus">+   * Clone an existing view wrapper as the basis for our display.</span>
<a href="#l5.526"></a><span id="l5.526" class="difflineplus">+   */</span>
<a href="#l5.527"></a><span id="l5.527" class="difflineplus">+  cloneView: function FolderDisplayWidget_cloneView(aViewWrapper) {</span>
<a href="#l5.528"></a><span id="l5.528" class="difflineplus">+    this.view = aViewWrapper.clone(this);</span>
<a href="#l5.529"></a><span id="l5.529" class="difflineplus">+    // generate a view created notification; this will cause us to do the right</span>
<a href="#l5.530"></a><span id="l5.530" class="difflineplus">+    //  thing in terms of associating the view with the tree and such.</span>
<a href="#l5.531"></a><span id="l5.531" class="difflineplus">+    this.onCreatedView();</span>
<a href="#l5.532"></a><span id="l5.532" class="difflineplus">+    if (this._active)</span>
<a href="#l5.533"></a><span id="l5.533" class="difflineplus">+      this.makeActive();</span>
<a href="#l5.534"></a><span id="l5.534" class="difflineplus">+  },</span>
<a href="#l5.535"></a><span id="l5.535" class="difflineplus">+</span>
<a href="#l5.536"></a><span id="l5.536" class="difflineplus">+  /**</span>
<a href="#l5.537"></a><span id="l5.537" class="difflineplus">+   * Close resources associated with the currently displayed folder because you</span>
<a href="#l5.538"></a><span id="l5.538" class="difflineplus">+   *  no longer care about this FolderDisplayWidget.</span>
<a href="#l5.539"></a><span id="l5.539" class="difflineplus">+   */</span>
<a href="#l5.540"></a><span id="l5.540" class="difflineplus">+  close: function FolderDisplayWidget_close() {</span>
<a href="#l5.541"></a><span id="l5.541" class="difflineplus">+    // Mark ourselves as inactive without doing any of the hard work of becoming</span>
<a href="#l5.542"></a><span id="l5.542" class="difflineplus">+    //  inactive.  This saves us from trying to update things as they go away.</span>
<a href="#l5.543"></a><span id="l5.543" class="difflineplus">+    this._active = false;</span>
<a href="#l5.544"></a><span id="l5.544" class="difflineplus">+    // Tell the message display to close itself too.  We do this before we do</span>
<a href="#l5.545"></a><span id="l5.545" class="difflineplus">+    //  anything else because closing the view could theoretically propagate</span>
<a href="#l5.546"></a><span id="l5.546" class="difflineplus">+    //  down to the message display and we don't want it doing anything it</span>
<a href="#l5.547"></a><span id="l5.547" class="difflineplus">+    //  doesn't have to do.</span>
<a href="#l5.548"></a><span id="l5.548" class="difflineplus">+    this.messageDisplay._close();</span>
<a href="#l5.549"></a><span id="l5.549" class="difflineplus">+</span>
<a href="#l5.550"></a><span id="l5.550" class="difflineplus">+    this.view.close();</span>
<a href="#l5.551"></a><span id="l5.551" class="difflineplus">+    this.messenger.setWindow(null, null);</span>
<a href="#l5.552"></a><span id="l5.552" class="difflineplus">+    this.messenger = null;</span>
<a href="#l5.553"></a><span id="l5.553" class="difflineplus">+    this._fakeTreeBox = null;</span>
<a href="#l5.554"></a><span id="l5.554" class="difflineplus">+  },</span>
<a href="#l5.555"></a><span id="l5.555" class="difflineplus">+</span>
<a href="#l5.556"></a><span id="l5.556" class="difflineplus">+  /*   ===============================   */</span>
<a href="#l5.557"></a><span id="l5.557" class="difflineplus">+  /* ===== IDBViewWrapper Listener ===== */</span>
<a href="#l5.558"></a><span id="l5.558" class="difflineplus">+  /*   ===============================   */</span>
<a href="#l5.559"></a><span id="l5.559" class="difflineplus">+</span>
<a href="#l5.560"></a><span id="l5.560" class="difflineplus">+  /**</span>
<a href="#l5.561"></a><span id="l5.561" class="difflineplus">+   * @return true if the mail view picker is visible.  This affects whether the</span>
<a href="#l5.562"></a><span id="l5.562" class="difflineplus">+   *     DBViewWrapper will actually use the persisted mail view or not.</span>
<a href="#l5.563"></a><span id="l5.563" class="difflineplus">+   */</span>
<a href="#l5.564"></a><span id="l5.564" class="difflineplus">+  get shouldUseMailViews() {</span>
<a href="#l5.565"></a><span id="l5.565" class="difflineplus">+    return ViewPickerBinding.isVisible;</span>
<a href="#l5.566"></a><span id="l5.566" class="difflineplus">+  },</span>
<a href="#l5.567"></a><span id="l5.567" class="difflineplus">+</span>
<a href="#l5.568"></a><span id="l5.568" class="difflineplus">+  /**</span>
<a href="#l5.569"></a><span id="l5.569" class="difflineplus">+   * Let the viewWrapper know if we should defer message display because we</span>
<a href="#l5.570"></a><span id="l5.570" class="difflineplus">+   *  want the user to connect to the server first so password authentication</span>
<a href="#l5.571"></a><span id="l5.571" class="difflineplus">+   *  can occur.</span>
<a href="#l5.572"></a><span id="l5.572" class="difflineplus">+   *</span>
<a href="#l5.573"></a><span id="l5.573" class="difflineplus">+   * @return true if the folder should be shown immediately, false if we should</span>
<a href="#l5.574"></a><span id="l5.574" class="difflineplus">+   *     wait for updateFolder to complete.</span>
<a href="#l5.575"></a><span id="l5.575" class="difflineplus">+   */</span>
<a href="#l5.576"></a><span id="l5.576" class="difflineplus">+  get shouldDeferMessageDisplayUntilAfterServerConnect() {</span>
<a href="#l5.577"></a><span id="l5.577" class="difflineplus">+    let passwordPromptRequired = false;</span>
<a href="#l5.578"></a><span id="l5.578" class="difflineplus">+</span>
<a href="#l5.579"></a><span id="l5.579" class="difflineplus">+    if (gPrefBranch.getBoolPref(&quot;mail.password_protect_local_cache&quot;))</span>
<a href="#l5.580"></a><span id="l5.580" class="difflineplus">+      passwordPromptRequired =</span>
<a href="#l5.581"></a><span id="l5.581" class="difflineplus">+        this.view.displayedFolder.server.passwordPromptRequired;</span>
<a href="#l5.582"></a><span id="l5.582" class="difflineplus">+</span>
<a href="#l5.583"></a><span id="l5.583" class="difflineplus">+    return passwordPromptRequired;</span>
<a href="#l5.584"></a><span id="l5.584" class="difflineplus">+  },</span>
<a href="#l5.585"></a><span id="l5.585" class="difflineplus">+</span>
<a href="#l5.586"></a><span id="l5.586" class="difflineplus">+  /**</span>
<a href="#l5.587"></a><span id="l5.587" class="difflineplus">+   * Let the viewWrapper know if it should mark the messages read when leaving</span>
<a href="#l5.588"></a><span id="l5.588" class="difflineplus">+   *  the provided folder.</span>
<a href="#l5.589"></a><span id="l5.589" class="difflineplus">+   *</span>
<a href="#l5.590"></a><span id="l5.590" class="difflineplus">+   * @return true if the preference is set for the folder's server type.</span>
<a href="#l5.591"></a><span id="l5.591" class="difflineplus">+   */</span>
<a href="#l5.592"></a><span id="l5.592" class="difflineplus">+  shouldMarkMessagesReadOnLeavingFolder:</span>
<a href="#l5.593"></a><span id="l5.593" class="difflineplus">+    function FolderDisplayWidget_crazyMarkOnReadChecker (aMsgFolder) {</span>
<a href="#l5.594"></a><span id="l5.594" class="difflineplus">+      return gPrefBranch.getBoolPref(&quot;mailnews.mark_message_read.&quot; +</span>
<a href="#l5.595"></a><span id="l5.595" class="difflineplus">+                                     aMsgFolder.server.type);</span>
<a href="#l5.596"></a><span id="l5.596" class="difflineplus">+  },</span>
<a href="#l5.597"></a><span id="l5.597" class="difflineplus">+</span>
<a href="#l5.598"></a><span id="l5.598" class="difflineplus">+  /**</span>
<a href="#l5.599"></a><span id="l5.599" class="difflineplus">+   * The view wrapper tells us when it starts loading a folder, and we set the</span>
<a href="#l5.600"></a><span id="l5.600" class="difflineplus">+   *  cursor busy.  Setting the cursor busy on a per-tab basis is us being</span>
<a href="#l5.601"></a><span id="l5.601" class="difflineplus">+   *  nice to the future. Loading a folder is a blocking operation that is going</span>
<a href="#l5.602"></a><span id="l5.602" class="difflineplus">+   *  to make us unresponsive and accordingly make it very hard for the user to</span>
<a href="#l5.603"></a><span id="l5.603" class="difflineplus">+   *  change tabs.</span>
<a href="#l5.604"></a><span id="l5.604" class="difflineplus">+   */</span>
<a href="#l5.605"></a><span id="l5.605" class="difflineplus">+  onFolderLoading: function(aFolderLoading) {</span>
<a href="#l5.606"></a><span id="l5.606" class="difflineplus">+    if (this._tabInfo)</span>
<a href="#l5.607"></a><span id="l5.607" class="difflineplus">+      document.getElementById(&quot;tabmail&quot;).setTabBusy(this._tabInfo,</span>
<a href="#l5.608"></a><span id="l5.608" class="difflineplus">+                                                    aFolderLoading);</span>
<a href="#l5.609"></a><span id="l5.609" class="difflineplus">+  },</span>
<a href="#l5.610"></a><span id="l5.610" class="difflineplus">+</span>
<a href="#l5.611"></a><span id="l5.611" class="difflineplus">+  /**</span>
<a href="#l5.612"></a><span id="l5.612" class="difflineplus">+   * The view wrapper tells us when a search is active, and we mark the tab as</span>
<a href="#l5.613"></a><span id="l5.613" class="difflineplus">+   *  thinking so the user knows something is happening.  'Searching' in this</span>
<a href="#l5.614"></a><span id="l5.614" class="difflineplus">+   *  case is more than just a user-initiated search.  Virtual folders / saved</span>
<a href="#l5.615"></a><span id="l5.615" class="difflineplus">+   *  searches, mail views, plus the more obvious quick search are all based off</span>
<a href="#l5.616"></a><span id="l5.616" class="difflineplus">+   *  of searches and we will receive a notification for them.</span>
<a href="#l5.617"></a><span id="l5.617" class="difflineplus">+   */</span>
<a href="#l5.618"></a><span id="l5.618" class="difflineplus">+  onSearching: function(aIsSearching) {</span>
<a href="#l5.619"></a><span id="l5.619" class="difflineplus">+    // getDocumentElements() sets gSearchBundle</span>
<a href="#l5.620"></a><span id="l5.620" class="difflineplus">+    getDocumentElements();</span>
<a href="#l5.621"></a><span id="l5.621" class="difflineplus">+    if (this._tabInfo)</span>
<a href="#l5.622"></a><span id="l5.622" class="difflineplus">+      document.getElementById(&quot;tabmail&quot;).setTabThinking(</span>
<a href="#l5.623"></a><span id="l5.623" class="difflineplus">+        this._tabInfo,</span>
<a href="#l5.624"></a><span id="l5.624" class="difflineplus">+        aIsSearching &amp;&amp; gSearchBundle.getString(&quot;searchingMessage&quot;));</span>
<a href="#l5.625"></a><span id="l5.625" class="difflineplus">+  },</span>
<a href="#l5.626"></a><span id="l5.626" class="difflineplus">+</span>
<a href="#l5.627"></a><span id="l5.627" class="difflineplus">+  /**</span>
<a href="#l5.628"></a><span id="l5.628" class="difflineplus">+   * Things we do on creating a view:</span>
<a href="#l5.629"></a><span id="l5.629" class="difflineplus">+   * - notify the observer service so that custom column handler providers can</span>
<a href="#l5.630"></a><span id="l5.630" class="difflineplus">+   *   add their custom columns to our view.</span>
<a href="#l5.631"></a><span id="l5.631" class="difflineplus">+   */</span>
<a href="#l5.632"></a><span id="l5.632" class="difflineplus">+  onCreatedView: function FolderDisplayWidget_onCreatedView() {</span>
<a href="#l5.633"></a><span id="l5.633" class="difflineplus">+    // All of our messages are not displayed if the view was just created.  We</span>
<a href="#l5.634"></a><span id="l5.634" class="difflineplus">+    //  will get an onAllMessagesLoaded nearly immediately if this is a local</span>
<a href="#l5.635"></a><span id="l5.635" class="difflineplus">+    //  folder where view creation is synonymous with having all messages.</span>
<a href="#l5.636"></a><span id="l5.636" class="difflineplus">+    this._allMessagesLoaded = false;</span>
<a href="#l5.637"></a><span id="l5.637" class="difflineplus">+    this.messageDisplay.onCreatedView();</span>
<a href="#l5.638"></a><span id="l5.638" class="difflineplus">+    this._notifyWhenActive(this._activeCreatedView);</span>
<a href="#l5.639"></a><span id="l5.639" class="difflineplus">+  },</span>
<a href="#l5.640"></a><span id="l5.640" class="difflineplus">+  _activeCreatedView: function() {</span>
<a href="#l5.641"></a><span id="l5.641" class="difflineplus">+    gDBView = this.view.dbView;</span>
<a href="#l5.642"></a><span id="l5.642" class="difflineplus">+</span>
<a href="#l5.643"></a><span id="l5.643" class="difflineplus">+    // A change in view may result in changes to sorts, the view menu, etc.</span>
<a href="#l5.644"></a><span id="l5.644" class="difflineplus">+    // Do this before we 'reroot' the dbview.</span>
<a href="#l5.645"></a><span id="l5.645" class="difflineplus">+    this._updateThreadDisplay();</span>
<a href="#l5.646"></a><span id="l5.646" class="difflineplus">+</span>
<a href="#l5.647"></a><span id="l5.647" class="difflineplus">+    // this creates a new selection object for the view.</span>
<a href="#l5.648"></a><span id="l5.648" class="difflineplus">+    if (this.treeBox)</span>
<a href="#l5.649"></a><span id="l5.649" class="difflineplus">+      this.treeBox.view = this.view.dbView;</span>
<a href="#l5.650"></a><span id="l5.650" class="difflineplus">+</span>
<a href="#l5.651"></a><span id="l5.651" class="difflineplus">+    let ObserverService =</span>
<a href="#l5.652"></a><span id="l5.652" class="difflineplus">+      Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l5.653"></a><span id="l5.653" class="difflineplus">+                .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l5.654"></a><span id="l5.654" class="difflineplus">+    // The data payload used to be viewType + &quot;:&quot; + viewFlags.  We no longer</span>
<a href="#l5.655"></a><span id="l5.655" class="difflineplus">+    //  do this because we already have the implied contract that gDBView is</span>
<a href="#l5.656"></a><span id="l5.656" class="difflineplus">+    //  valid at the time we generate the notification.  In such a case, you</span>
<a href="#l5.657"></a><span id="l5.657" class="difflineplus">+    //  can easily get that information from the gDBView.  (The documentation</span>
<a href="#l5.658"></a><span id="l5.658" class="difflineplus">+    //  on creating a custom column assumes gDBView.)</span>
<a href="#l5.659"></a><span id="l5.659" class="difflineplus">+    ObserverService.notifyObservers(this.displayedFolder,</span>
<a href="#l5.660"></a><span id="l5.660" class="difflineplus">+                                    &quot;MsgCreateDBView&quot;, &quot;&quot;);</span>
<a href="#l5.661"></a><span id="l5.661" class="difflineplus">+  },</span>
<a href="#l5.662"></a><span id="l5.662" class="difflineplus">+</span>
<a href="#l5.663"></a><span id="l5.663" class="difflineplus">+  /**</span>
<a href="#l5.664"></a><span id="l5.664" class="difflineplus">+   * If our view is being destroyed and it is coming back, we want to save the</span>
<a href="#l5.665"></a><span id="l5.665" class="difflineplus">+   *  current selection so we can restore it when the view comes back.</span>
<a href="#l5.666"></a><span id="l5.666" class="difflineplus">+   */</span>
<a href="#l5.667"></a><span id="l5.667" class="difflineplus">+  onDestroyingView: function FolderDisplayWidget_onDestroyingView(</span>
<a href="#l5.668"></a><span id="l5.668" class="difflineplus">+      aFolderIsComingBack) {</span>
<a href="#l5.669"></a><span id="l5.669" class="difflineplus">+    // try and persist the selection's content if we can</span>
<a href="#l5.670"></a><span id="l5.670" class="difflineplus">+    if (this._active) {</span>
<a href="#l5.671"></a><span id="l5.671" class="difflineplus">+      if (aFolderIsComingBack)</span>
<a href="#l5.672"></a><span id="l5.672" class="difflineplus">+        this._saveSelection();</span>
<a href="#l5.673"></a><span id="l5.673" class="difflineplus">+      else</span>
<a href="#l5.674"></a><span id="l5.674" class="difflineplus">+        this._clearSavedSelection();</span>
<a href="#l5.675"></a><span id="l5.675" class="difflineplus">+      gDBView = null;</span>
<a href="#l5.676"></a><span id="l5.676" class="difflineplus">+    }</span>
<a href="#l5.677"></a><span id="l5.677" class="difflineplus">+</span>
<a href="#l5.678"></a><span id="l5.678" class="difflineplus">+    // if we have no view, no messages could be loaded.</span>
<a href="#l5.679"></a><span id="l5.679" class="difflineplus">+    this._allMessagesLoaded = false;</span>
<a href="#l5.680"></a><span id="l5.680" class="difflineplus">+</span>
<a href="#l5.681"></a><span id="l5.681" class="difflineplus">+    // but the actual tree view selection (based on view indicies) is a goner no</span>
<a href="#l5.682"></a><span id="l5.682" class="difflineplus">+    //  matter what, make everyone forget.</span>
<a href="#l5.683"></a><span id="l5.683" class="difflineplus">+    this.view.dbView.selection = null;</span>
<a href="#l5.684"></a><span id="l5.684" class="difflineplus">+    this._savedFirstVisibleRow = null;</span>
<a href="#l5.685"></a><span id="l5.685" class="difflineplus">+    this._nextViewIndexAfterDelete = null;</span>
<a href="#l5.686"></a><span id="l5.686" class="difflineplus">+    // although the move may still be active, its relation to the view is moot.</span>
<a href="#l5.687"></a><span id="l5.687" class="difflineplus">+    this._massMoveActive = false;</span>
<a href="#l5.688"></a><span id="l5.688" class="difflineplus">+</span>
<a href="#l5.689"></a><span id="l5.689" class="difflineplus">+    // Anything pending needs to get cleared out; the new view and its related</span>
<a href="#l5.690"></a><span id="l5.690" class="difflineplus">+    //  events will re-schedule anything required or simply run it when it</span>
<a href="#l5.691"></a><span id="l5.691" class="difflineplus">+    //  has its initial call to makeActive compelled.</span>
<a href="#l5.692"></a><span id="l5.692" class="difflineplus">+    this._notificationsPendingActivation = [];</span>
<a href="#l5.693"></a><span id="l5.693" class="difflineplus">+</span>
<a href="#l5.694"></a><span id="l5.694" class="difflineplus">+    // and the message display needs to forget</span>
<a href="#l5.695"></a><span id="l5.695" class="difflineplus">+    this.messageDisplay.onDestroyingView(aFolderIsComingBack);</span>
<a href="#l5.696"></a><span id="l5.696" class="difflineplus">+  },</span>
<a href="#l5.697"></a><span id="l5.697" class="difflineplus">+  /**</span>
<a href="#l5.698"></a><span id="l5.698" class="difflineplus">+   * We are entering the folder for display, set the header cache size.</span>
<a href="#l5.699"></a><span id="l5.699" class="difflineplus">+   */</span>
<a href="#l5.700"></a><span id="l5.700" class="difflineplus">+  onDisplayingFolder: function FolderDisplayWidget_onDisplayingFolder() {</span>
<a href="#l5.701"></a><span id="l5.701" class="difflineplus">+    let msgDatabase = this.view.displayedFolder.msgDatabase;</span>
<a href="#l5.702"></a><span id="l5.702" class="difflineplus">+    if (msgDatabase) {</span>
<a href="#l5.703"></a><span id="l5.703" class="difflineplus">+      msgDatabase.resetHdrCacheSize(this.PERF_HEADER_CACHE_SIZE);</span>
<a href="#l5.704"></a><span id="l5.704" class="difflineplus">+    }</span>
<a href="#l5.705"></a><span id="l5.705" class="difflineplus">+</span>
<a href="#l5.706"></a><span id="l5.706" class="difflineplus">+    // the quick-search gets nuked when we show a new folder</span>
<a href="#l5.707"></a><span id="l5.707" class="difflineplus">+    ClearQSIfNecessary();</span>
<a href="#l5.708"></a><span id="l5.708" class="difflineplus">+    // update the quick-search relative to whether it's incoming/outgoing</span>
<a href="#l5.709"></a><span id="l5.709" class="difflineplus">+    onSearchFolderTypeChanged(this.view.isOutgoingFolder);</span>
<a href="#l5.710"></a><span id="l5.710" class="difflineplus">+</span>
<a href="#l5.711"></a><span id="l5.711" class="difflineplus">+    if (this.active)</span>
<a href="#l5.712"></a><span id="l5.712" class="difflineplus">+      this.makeActive();</span>
<a href="#l5.713"></a><span id="l5.713" class="difflineplus">+  },</span>
<a href="#l5.714"></a><span id="l5.714" class="difflineplus">+</span>
<a href="#l5.715"></a><span id="l5.715" class="difflineplus">+  /**</span>
<a href="#l5.716"></a><span id="l5.716" class="difflineplus">+   * Notification from DBViewWrapper that it is closing the folder.  This can</span>
<a href="#l5.717"></a><span id="l5.717" class="difflineplus">+   *  happen for reasons other than our own 'close' method closing the view.</span>
<a href="#l5.718"></a><span id="l5.718" class="difflineplus">+   *  For example, user deletion of the folder or underlying folder closes it.</span>
<a href="#l5.719"></a><span id="l5.719" class="difflineplus">+   */</span>
<a href="#l5.720"></a><span id="l5.720" class="difflineplus">+  onLeavingFolder: function FolderDisplayWidget_onLeavingFolder() {</span>
<a href="#l5.721"></a><span id="l5.721" class="difflineplus">+    // Keep the msgWindow's openFolder up-to-date; it powers nsMessenger's</span>
<a href="#l5.722"></a><span id="l5.722" class="difflineplus">+    //  concept of history so that it can bring you back to the actual folder</span>
<a href="#l5.723"></a><span id="l5.723" class="difflineplus">+    //  you were looking at, rather than just the underlying folder.</span>
<a href="#l5.724"></a><span id="l5.724" class="difflineplus">+    if (this._active)</span>
<a href="#l5.725"></a><span id="l5.725" class="difflineplus">+      msgWindow.openFolder = null;</span>
<a href="#l5.726"></a><span id="l5.726" class="difflineplus">+  },</span>
<a href="#l5.727"></a><span id="l5.727" class="difflineplus">+</span>
<a href="#l5.728"></a><span id="l5.728" class="difflineplus">+  /**</span>
<a href="#l5.729"></a><span id="l5.729" class="difflineplus">+   * Indictes whether we are done loading the messages that should be in this</span>
<a href="#l5.730"></a><span id="l5.730" class="difflineplus">+   *  folder.  This is being surfaced for testing purposes, but could be useful</span>
<a href="#l5.731"></a><span id="l5.731" class="difflineplus">+   *  to other code as well.  But don't poll this property; ask for an event</span>
<a href="#l5.732"></a><span id="l5.732" class="difflineplus">+   *  that you can hook.</span>
<a href="#l5.733"></a><span id="l5.733" class="difflineplus">+   */</span>
<a href="#l5.734"></a><span id="l5.734" class="difflineplus">+  get allMessagesLoaded FolderDisplayWidget_get_allMessagesLoaded() {</span>
<a href="#l5.735"></a><span id="l5.735" class="difflineplus">+    return this._allMessagesLoaded;</span>
<a href="#l5.736"></a><span id="l5.736" class="difflineplus">+  },</span>
<a href="#l5.737"></a><span id="l5.737" class="difflineplus">+</span>
<a href="#l5.738"></a><span id="l5.738" class="difflineplus">+  /**</span>
<a href="#l5.739"></a><span id="l5.739" class="difflineplus">+   * Things to do once all the messages that should show up in a folder have</span>
<a href="#l5.740"></a><span id="l5.740" class="difflineplus">+   *  shown up.  For a real folder, this happens when the folder is entered.</span>
<a href="#l5.741"></a><span id="l5.741" class="difflineplus">+   *  For a virtual folder, this happens when the search completes.</span>
<a href="#l5.742"></a><span id="l5.742" class="difflineplus">+   *</span>
<a href="#l5.743"></a><span id="l5.743" class="difflineplus">+   * What we do:</span>
<a href="#l5.744"></a><span id="l5.744" class="difflineplus">+   * - Any scrolling required!</span>
<a href="#l5.745"></a><span id="l5.745" class="difflineplus">+   */</span>
<a href="#l5.746"></a><span id="l5.746" class="difflineplus">+  onAllMessagesLoaded: function() {</span>
<a href="#l5.747"></a><span id="l5.747" class="difflineplus">+    this._allMessagesLoaded = true;</span>
<a href="#l5.748"></a><span id="l5.748" class="difflineplus">+    this._notifyWhenActive(this._activeAllMessagesLoaded);</span>
<a href="#l5.749"></a><span id="l5.749" class="difflineplus">+  },</span>
<a href="#l5.750"></a><span id="l5.750" class="difflineplus">+  _activeAllMessagesLoaded: function() {</span>
<a href="#l5.751"></a><span id="l5.751" class="difflineplus">+    // - restore selection</span>
<a href="#l5.752"></a><span id="l5.752" class="difflineplus">+    // Attempt to restore the selection (if we saved it because the view was</span>
<a href="#l5.753"></a><span id="l5.753" class="difflineplus">+    //  being destroyed or otherwise manipulated in a fashion that the normal</span>
<a href="#l5.754"></a><span id="l5.754" class="difflineplus">+    //  nsTreeSelection would be unable to handle.)</span>
<a href="#l5.755"></a><span id="l5.755" class="difflineplus">+    if (this._restoreSelection()) {</span>
<a href="#l5.756"></a><span id="l5.756" class="difflineplus">+      this.ensureRowIsVisible(this.view.dbView.viewIndexForFirstSelectedMsg);</span>
<a href="#l5.757"></a><span id="l5.757" class="difflineplus">+      return;</span>
<a href="#l5.758"></a><span id="l5.758" class="difflineplus">+    }</span>
<a href="#l5.759"></a><span id="l5.759" class="difflineplus">+</span>
<a href="#l5.760"></a><span id="l5.760" class="difflineplus">+    // - pending navigation from pushNavigation (probably spacebar triggered)</span>
<a href="#l5.761"></a><span id="l5.761" class="difflineplus">+    if (this._pendingNavigation) {</span>
<a href="#l5.762"></a><span id="l5.762" class="difflineplus">+      // Move it to a local and clear the state in case something bad happens.</span>
<a href="#l5.763"></a><span id="l5.763" class="difflineplus">+      //  (We don't want to swallow the exception.)</span>
<a href="#l5.764"></a><span id="l5.764" class="difflineplus">+      let pendingNavigation = this._pendingNavigation;</span>
<a href="#l5.765"></a><span id="l5.765" class="difflineplus">+      this._pendingNavigation = null;</span>
<a href="#l5.766"></a><span id="l5.766" class="difflineplus">+      this.navigate.apply(this, pendingNavigation);</span>
<a href="#l5.767"></a><span id="l5.767" class="difflineplus">+      return;</span>
<a href="#l5.768"></a><span id="l5.768" class="difflineplus">+    }</span>
<a href="#l5.769"></a><span id="l5.769" class="difflineplus">+</span>
<a href="#l5.770"></a><span id="l5.770" class="difflineplus">+    // - new messages</span>
<a href="#l5.771"></a><span id="l5.771" class="difflineplus">+    // if configured to scroll to new messages, try that</span>
<a href="#l5.772"></a><span id="l5.772" class="difflineplus">+    if (gPrefBranch.getBoolPref(&quot;mailnews.scroll_to_new_message&quot;) &amp;&amp;</span>
<a href="#l5.773"></a><span id="l5.773" class="difflineplus">+        this.navigate(nsMsgNavigationType.firstNew, /* select */ false))</span>
<a href="#l5.774"></a><span id="l5.774" class="difflineplus">+      return;</span>
<a href="#l5.775"></a><span id="l5.775" class="difflineplus">+</span>
<a href="#l5.776"></a><span id="l5.776" class="difflineplus">+    // - last selected message</span>
<a href="#l5.777"></a><span id="l5.777" class="difflineplus">+    // if configured to load the last selected message (this is currently more</span>
<a href="#l5.778"></a><span id="l5.778" class="difflineplus">+    //  persistent than our saveSelection/restoreSelection stuff), and the view</span>
<a href="#l5.779"></a><span id="l5.779" class="difflineplus">+    //  is backed by a single underlying folder (the only way having just a</span>
<a href="#l5.780"></a><span id="l5.780" class="difflineplus">+    //  message key works out), try that</span>
<a href="#l5.781"></a><span id="l5.781" class="difflineplus">+    if (gPrefBranch.getBoolPref(&quot;mailnews.remember_selected_message&quot;) &amp;&amp;</span>
<a href="#l5.782"></a><span id="l5.782" class="difflineplus">+        this.view.isSingleFolder) {</span>
<a href="#l5.783"></a><span id="l5.783" class="difflineplus">+      // use the displayed folder; nsMsgDBView goes to the effort to save the</span>
<a href="#l5.784"></a><span id="l5.784" class="difflineplus">+      //  state to the viewFolder, so this is the correct course of action.</span>
<a href="#l5.785"></a><span id="l5.785" class="difflineplus">+      let lastLoadedMessageKey = this.view.displayedFolder.lastMessageLoaded;</span>
<a href="#l5.786"></a><span id="l5.786" class="difflineplus">+      if (lastLoadedMessageKey != nsMsgKey_None) {</span>
<a href="#l5.787"></a><span id="l5.787" class="difflineplus">+        this.view.dbView.selectMsgByKey(lastLoadedMessageKey);</span>
<a href="#l5.788"></a><span id="l5.788" class="difflineplus">+        // The message key may not be present in the view for a variety of</span>
<a href="#l5.789"></a><span id="l5.789" class="difflineplus">+        //  reasons.  Beyond message deletion, it simply may not match the</span>
<a href="#l5.790"></a><span id="l5.790" class="difflineplus">+        //  active mail view or quick search, for example.</span>
<a href="#l5.791"></a><span id="l5.791" class="difflineplus">+        if (this.view.dbView.numSelected) {</span>
<a href="#l5.792"></a><span id="l5.792" class="difflineplus">+          this.ensureRowIsVisible(</span>
<a href="#l5.793"></a><span id="l5.793" class="difflineplus">+            this.view.dbView.viewIndexForFirstSelectedMsg);</span>
<a href="#l5.794"></a><span id="l5.794" class="difflineplus">+          return;</span>
<a href="#l5.795"></a><span id="l5.795" class="difflineplus">+        }</span>
<a href="#l5.796"></a><span id="l5.796" class="difflineplus">+      }</span>
<a href="#l5.797"></a><span id="l5.797" class="difflineplus">+    }</span>
<a href="#l5.798"></a><span id="l5.798" class="difflineplus">+</span>
<a href="#l5.799"></a><span id="l5.799" class="difflineplus">+    // - towards the newest messages, but don't select</span>
<a href="#l5.800"></a><span id="l5.800" class="difflineplus">+    if (this.view.isSortedAscending &amp;&amp; this.view.sortImpliesTemporalOrdering &amp;&amp;</span>
<a href="#l5.801"></a><span id="l5.801" class="difflineplus">+      this.navigate(nsMsgNavigationType.lastMessage, /* select */ false))</span>
<a href="#l5.802"></a><span id="l5.802" class="difflineplus">+      return;</span>
<a href="#l5.803"></a><span id="l5.803" class="difflineplus">+</span>
<a href="#l5.804"></a><span id="l5.804" class="difflineplus">+    // - to the top, the coliseum</span>
<a href="#l5.805"></a><span id="l5.805" class="difflineplus">+    this.ensureRowIsVisible(0);</span>
<a href="#l5.806"></a><span id="l5.806" class="difflineplus">+  },</span>
<a href="#l5.807"></a><span id="l5.807" class="difflineplus">+</span>
<a href="#l5.808"></a><span id="l5.808" class="difflineplus">+  /**</span>
<a href="#l5.809"></a><span id="l5.809" class="difflineplus">+   * The DBViewWrapper tells us when someone (possibly the wrapper itself)</span>
<a href="#l5.810"></a><span id="l5.810" class="difflineplus">+   *  changes the active mail view so that we can kick the UI to update.</span>
<a href="#l5.811"></a><span id="l5.811" class="difflineplus">+   */</span>
<a href="#l5.812"></a><span id="l5.812" class="difflineplus">+  onMailViewChanged: function FolderDisplayWidget_onMailViewChanged() {</span>
<a href="#l5.813"></a><span id="l5.813" class="difflineplus">+    // only do this if we're currently active.  no need to queue it because we</span>
<a href="#l5.814"></a><span id="l5.814" class="difflineplus">+    //  always update the mail view whenever we are made active.</span>
<a href="#l5.815"></a><span id="l5.815" class="difflineplus">+    if (this.active) {</span>
<a href="#l5.816"></a><span id="l5.816" class="difflineplus">+      let event = document.createEvent(&quot;datacontainerevents&quot;);</span>
<a href="#l5.817"></a><span id="l5.817" class="difflineplus">+      // you cannot cancel a view change!</span>
<a href="#l5.818"></a><span id="l5.818" class="difflineplus">+      event.initEvent(&quot;MailViewChanged&quot;, false, false);</span>
<a href="#l5.819"></a><span id="l5.819" class="difflineplus">+      //event.setData(&quot;folderDisplay&quot;, this);</span>
<a href="#l5.820"></a><span id="l5.820" class="difflineplus">+      window.dispatchEvent(event);</span>
<a href="#l5.821"></a><span id="l5.821" class="difflineplus">+    }</span>
<a href="#l5.822"></a><span id="l5.822" class="difflineplus">+  },</span>
<a href="#l5.823"></a><span id="l5.823" class="difflineplus">+</span>
<a href="#l5.824"></a><span id="l5.824" class="difflineplus">+  /**</span>
<a href="#l5.825"></a><span id="l5.825" class="difflineplus">+   * Just the sort or threading was changed, without changing other things.  We</span>
<a href="#l5.826"></a><span id="l5.826" class="difflineplus">+   *  will not get this notification if the view was re-created, for example.</span>
<a href="#l5.827"></a><span id="l5.827" class="difflineplus">+   */</span>
<a href="#l5.828"></a><span id="l5.828" class="difflineplus">+  onSortChanged: function FolderDisplayWidget_onSortChanged() {</span>
<a href="#l5.829"></a><span id="l5.829" class="difflineplus">+    if (this.active)</span>
<a href="#l5.830"></a><span id="l5.830" class="difflineplus">+      UpdateSortIndicators(this.view.primarySortType,</span>
<a href="#l5.831"></a><span id="l5.831" class="difflineplus">+                           this.view.primarySortOrder);</span>
<a href="#l5.832"></a><span id="l5.832" class="difflineplus">+  },</span>
<a href="#l5.833"></a><span id="l5.833" class="difflineplus">+</span>
<a href="#l5.834"></a><span id="l5.834" class="difflineplus">+  /**</span>
<a href="#l5.835"></a><span id="l5.835" class="difflineplus">+   * Messages (that may have been displayed) have been removed; this may impact</span>
<a href="#l5.836"></a><span id="l5.836" class="difflineplus">+   *  our message selection.  If we saw this coming, then</span>
<a href="#l5.837"></a><span id="l5.837" class="difflineplus">+   *  this._nextViewIndexAfterDelete should know what view index we should</span>
<a href="#l5.838"></a><span id="l5.838" class="difflineplus">+   *  select next.  If we didn't see this coming, the cause is likely an</span>
<a href="#l5.839"></a><span id="l5.839" class="difflineplus">+   *  explicit deletion in another tab/window.</span>
<a href="#l5.840"></a><span id="l5.840" class="difflineplus">+   * Because the nsMsgDBView is on top of things, it will already have called</span>
<a href="#l5.841"></a><span id="l5.841" class="difflineplus">+   *  summarizeSelection as a result of the changes to the message display.</span>
<a href="#l5.842"></a><span id="l5.842" class="difflineplus">+   *  So our job here is really just to try and potentially improve on the</span>
<a href="#l5.843"></a><span id="l5.843" class="difflineplus">+   *  default selection logic.</span>
<a href="#l5.844"></a><span id="l5.844" class="difflineplus">+   */</span>
<a href="#l5.845"></a><span id="l5.845" class="difflineplus">+  onMessagesRemoved: function FolderDisplayWidget_onMessagesRemoved() {</span>
<a href="#l5.846"></a><span id="l5.846" class="difflineplus">+    // - we saw this coming</span>
<a href="#l5.847"></a><span id="l5.847" class="difflineplus">+    let rowCount = this.view.dbView.rowCount;</span>
<a href="#l5.848"></a><span id="l5.848" class="difflineplus">+    if (!this._massMoveActive &amp;&amp; (this._nextViewIndexAfterDelete != null)) {</span>
<a href="#l5.849"></a><span id="l5.849" class="difflineplus">+      // adjust the index if it is after the last row...</span>
<a href="#l5.850"></a><span id="l5.850" class="difflineplus">+      // (this can happen if the &quot;mail.delete_matches_sort_order&quot; pref is not</span>
<a href="#l5.851"></a><span id="l5.851" class="difflineplus">+      //  set and the message is the last message in the view.)</span>
<a href="#l5.852"></a><span id="l5.852" class="difflineplus">+      if (this._nextViewIndexAfterDelete &gt;= rowCount)</span>
<a href="#l5.853"></a><span id="l5.853" class="difflineplus">+        this._nextViewIndexAfterDelete = rowCount - 1;</span>
<a href="#l5.854"></a><span id="l5.854" class="difflineplus">+      // just select the index and get on with our lives</span>
<a href="#l5.855"></a><span id="l5.855" class="difflineplus">+      this.selectViewIndex(this._nextViewIndexAfterDelete);</span>
<a href="#l5.856"></a><span id="l5.856" class="difflineplus">+      this._nextViewIndexAfterDelete = null;</span>
<a href="#l5.857"></a><span id="l5.857" class="difflineplus">+      return;</span>
<a href="#l5.858"></a><span id="l5.858" class="difflineplus">+    }</span>
<a href="#l5.859"></a><span id="l5.859" class="difflineplus">+</span>
<a href="#l5.860"></a><span id="l5.860" class="difflineplus">+    // - surprise!</span>
<a href="#l5.861"></a><span id="l5.861" class="difflineplus">+    // A deletion happened to our folder.</span>
<a href="#l5.862"></a><span id="l5.862" class="difflineplus">+    let treeSelection = this.treeSelection;</span>
<a href="#l5.863"></a><span id="l5.863" class="difflineplus">+    // we can't fix the selection if we have no selection</span>
<a href="#l5.864"></a><span id="l5.864" class="difflineplus">+    if (!treeSelection)</span>
<a href="#l5.865"></a><span id="l5.865" class="difflineplus">+      return;</span>
<a href="#l5.866"></a><span id="l5.866" class="difflineplus">+</span>
<a href="#l5.867"></a><span id="l5.867" class="difflineplus">+    // For reasons unknown (but theoretically knowable), sometimes the selection</span>
<a href="#l5.868"></a><span id="l5.868" class="difflineplus">+    //  object will be invalid.  At least, I've reliably seen a selection of</span>
<a href="#l5.869"></a><span id="l5.869" class="difflineplus">+    //  [0, 0] with 0 rows.  If that happens, we need to fix up the selection</span>
<a href="#l5.870"></a><span id="l5.870" class="difflineplus">+    //  here.</span>
<a href="#l5.871"></a><span id="l5.871" class="difflineplus">+    if (rowCount == 0 &amp;&amp; treeSelection.count)</span>
<a href="#l5.872"></a><span id="l5.872" class="difflineplus">+      // nsTreeSelection does't generate an event if we use clearRange, so use</span>
<a href="#l5.873"></a><span id="l5.873" class="difflineplus">+      //  that to avoid spurious events, given that we are going to definitely</span>
<a href="#l5.874"></a><span id="l5.874" class="difflineplus">+      //  trigger a change notification below.</span>
<a href="#l5.875"></a><span id="l5.875" class="difflineplus">+      treeSelection.clearRange(0, 0);</span>
<a href="#l5.876"></a><span id="l5.876" class="difflineplus">+</span>
<a href="#l5.877"></a><span id="l5.877" class="difflineplus">+    // Check if we now no longer have a selection, but we had exactly one</span>
<a href="#l5.878"></a><span id="l5.878" class="difflineplus">+    //  message selected previously.  If we did, then try and do some</span>
<a href="#l5.879"></a><span id="l5.879" class="difflineplus">+    //  'persistence of having a thing selected'.</span>
<a href="#l5.880"></a><span id="l5.880" class="difflineplus">+    if (treeSelection.count == 0 &amp;&amp;</span>
<a href="#l5.881"></a><span id="l5.881" class="difflineplus">+        this._mostRecentSelectionCounts.length &gt; 1 &amp;&amp;</span>
<a href="#l5.882"></a><span id="l5.882" class="difflineplus">+        this._mostRecentSelectionCounts[1] == 1 &amp;&amp;</span>
<a href="#l5.883"></a><span id="l5.883" class="difflineplus">+        this._mostRecentCurrentIndices[1] != -1) {</span>
<a href="#l5.884"></a><span id="l5.884" class="difflineplus">+      let targetIndex = this._mostRecentCurrentIndices[1];</span>
<a href="#l5.885"></a><span id="l5.885" class="difflineplus">+      if (targetIndex &gt;= rowCount)</span>
<a href="#l5.886"></a><span id="l5.886" class="difflineplus">+        targetIndex = rowCount - 1;</span>
<a href="#l5.887"></a><span id="l5.887" class="difflineplus">+      this.selectViewIndex(targetIndex);</span>
<a href="#l5.888"></a><span id="l5.888" class="difflineplus">+      return;</span>
<a href="#l5.889"></a><span id="l5.889" class="difflineplus">+    }</span>
<a href="#l5.890"></a><span id="l5.890" class="difflineplus">+</span>
<a href="#l5.891"></a><span id="l5.891" class="difflineplus">+    // Otherwise, just tell the view that things have changed so it can update</span>
<a href="#l5.892"></a><span id="l5.892" class="difflineplus">+    //  itself to the new state of things.</span>
<a href="#l5.893"></a><span id="l5.893" class="difflineplus">+    // tell the view that things have changed so it can update itself suitably.</span>
<a href="#l5.894"></a><span id="l5.894" class="difflineplus">+    if (this.view.dbView)</span>
<a href="#l5.895"></a><span id="l5.895" class="difflineplus">+      this.view.dbView.selectionChanged();</span>
<a href="#l5.896"></a><span id="l5.896" class="difflineplus">+  },</span>
<a href="#l5.897"></a><span id="l5.897" class="difflineplus">+</span>
<a href="#l5.898"></a><span id="l5.898" class="difflineplus">+  /**</span>
<a href="#l5.899"></a><span id="l5.899" class="difflineplus">+   * Messages were not actually removed, but we were expecting that they would</span>
<a href="#l5.900"></a><span id="l5.900" class="difflineplus">+   *  be.  Clean-up what onMessagesRemoved would have cleaned up, namely the</span>
<a href="#l5.901"></a><span id="l5.901" class="difflineplus">+   *  next view index to select.</span>
<a href="#l5.902"></a><span id="l5.902" class="difflineplus">+   */</span>
<a href="#l5.903"></a><span id="l5.903" class="difflineplus">+  onMessageRemovalFailed:</span>
<a href="#l5.904"></a><span id="l5.904" class="difflineplus">+      function FolderDisplayWidget_onMessageRemovalFailed() {</span>
<a href="#l5.905"></a><span id="l5.905" class="difflineplus">+    this._nextViewIndexAfterDelete = null;</span>
<a href="#l5.906"></a><span id="l5.906" class="difflineplus">+  },</span>
<a href="#l5.907"></a><span id="l5.907" class="difflineplus">+</span>
<a href="#l5.908"></a><span id="l5.908" class="difflineplus">+  /**</span>
<a href="#l5.909"></a><span id="l5.909" class="difflineplus">+   * Update the status bar to reflect our exciting message counts.</span>
<a href="#l5.910"></a><span id="l5.910" class="difflineplus">+   */</span>
<a href="#l5.911"></a><span id="l5.911" class="difflineplus">+  onMessageCountsChanged: function FolderDisplayWidget_onMessageCountsChaned() {</span>
<a href="#l5.912"></a><span id="l5.912" class="difflineplus">+    if (this.active)</span>
<a href="#l5.913"></a><span id="l5.913" class="difflineplus">+      UpdateStatusMessageCounts(this.displayedFolder);</span>
<a href="#l5.914"></a><span id="l5.914" class="difflineplus">+  },</span>
<a href="#l5.915"></a><span id="l5.915" class="difflineplus">+</span>
<a href="#l5.916"></a><span id="l5.916" class="difflineplus">+  /* ===== End IDBViewWrapperListener ===== */</span>
<a href="#l5.917"></a><span id="l5.917" class="difflineplus">+</span>
<a href="#l5.918"></a><span id="l5.918" class="difflineplus">+  /*   ==================================   */</span>
<a href="#l5.919"></a><span id="l5.919" class="difflineplus">+  /* ===== nsIMsgDBViewCommandUpdater ===== */</span>
<a href="#l5.920"></a><span id="l5.920" class="difflineplus">+  /*   ==================================   */</span>
<a href="#l5.921"></a><span id="l5.921" class="difflineplus">+</span>
<a href="#l5.922"></a><span id="l5.922" class="difflineplus">+  /**</span>
<a href="#l5.923"></a><span id="l5.923" class="difflineplus">+   * This gets called when the selection changes AND !suppressCommandUpdating</span>
<a href="#l5.924"></a><span id="l5.924" class="difflineplus">+   *  AND (we're not removing a row OR we are now out of rows).</span>
<a href="#l5.925"></a><span id="l5.925" class="difflineplus">+   * In response, we update the toolbar.</span>
<a href="#l5.926"></a><span id="l5.926" class="difflineplus">+   */</span>
<a href="#l5.927"></a><span id="l5.927" class="difflineplus">+  updateCommandStatus: function FolderDisplayWidget_updateCommandStatus() {</span>
<a href="#l5.928"></a><span id="l5.928" class="difflineplus">+    UpdateMailToolbar(&quot;FolderDisplayWidget command updater notification&quot;);</span>
<a href="#l5.929"></a><span id="l5.929" class="difflineplus">+  },</span>
<a href="#l5.930"></a><span id="l5.930" class="difflineplus">+</span>
<a href="#l5.931"></a><span id="l5.931" class="difflineplus">+  /**</span>
<a href="#l5.932"></a><span id="l5.932" class="difflineplus">+   * This gets called by nsMsgDBView::UpdateDisplayMessage following a call</span>
<a href="#l5.933"></a><span id="l5.933" class="difflineplus">+   *  to nsIMessenger.OpenURL to kick off message display OR (UDM gets called)</span>
<a href="#l5.934"></a><span id="l5.934" class="difflineplus">+   *  by nsMsgDBView::SelectionChanged in lieu of loading the message because</span>
<a href="#l5.935"></a><span id="l5.935" class="difflineplus">+   *  mSupressMsgDisplay.</span>
<a href="#l5.936"></a><span id="l5.936" class="difflineplus">+   * In other words, we get notified immediately after the process of displaying</span>
<a href="#l5.937"></a><span id="l5.937" class="difflineplus">+   *  a message triggered by the nsMsgDBView happens.  We get some arguments</span>
<a href="#l5.938"></a><span id="l5.938" class="difflineplus">+   *  that are display optimizations for historical reasons (as usual).</span>
<a href="#l5.939"></a><span id="l5.939" class="difflineplus">+   *</span>
<a href="#l5.940"></a><span id="l5.940" class="difflineplus">+   * Things this makes us want to do:</span>
<a href="#l5.941"></a><span id="l5.941" class="difflineplus">+   * - Set the tab title, perhaps.  (If we are a message display.)</span>
<a href="#l5.942"></a><span id="l5.942" class="difflineplus">+   * - Update message counts, because things might have changed, why not.</span>
<a href="#l5.943"></a><span id="l5.943" class="difflineplus">+   * - Update some toolbar buttons, why not.</span>
<a href="#l5.944"></a><span id="l5.944" class="difflineplus">+   *</span>
<a href="#l5.945"></a><span id="l5.945" class="difflineplus">+   * @param aFolder The display/view folder, as opposed to the backing folder.</span>
<a href="#l5.946"></a><span id="l5.946" class="difflineplus">+   * @param aSubject The subject with &quot;Re: &quot; if it's got one, which makes it</span>
<a href="#l5.947"></a><span id="l5.947" class="difflineplus">+   *     notably different from just directly accessing the message header's</span>
<a href="#l5.948"></a><span id="l5.948" class="difflineplus">+   *     subject.</span>
<a href="#l5.949"></a><span id="l5.949" class="difflineplus">+   * @param aKeywords The keywords, which roughly translates to message tags.</span>
<a href="#l5.950"></a><span id="l5.950" class="difflineplus">+   */</span>
<a href="#l5.951"></a><span id="l5.951" class="difflineplus">+  displayMessageChanged: function FolderDisplayWidget_displayMessageChanged(</span>
<a href="#l5.952"></a><span id="l5.952" class="difflineplus">+      aFolder, aSubject, aKeywords) {</span>
<a href="#l5.953"></a><span id="l5.953" class="difflineplus">+    UpdateMailToolbar(&quot;FolderDisplayWidget displayed message changed&quot;);</span>
<a href="#l5.954"></a><span id="l5.954" class="difflineplus">+    let viewIndex = this.view.dbView.currentlyDisplayedMessage;</span>
<a href="#l5.955"></a><span id="l5.955" class="difflineplus">+    let msgHdr = (viewIndex != nsMsgViewIndex_None) ?</span>
<a href="#l5.956"></a><span id="l5.956" class="difflineplus">+                   this.view.dbView.getMsgHdrAt(viewIndex) : null;</span>
<a href="#l5.957"></a><span id="l5.957" class="difflineplus">+    this.messageDisplay.onDisplayingMessage(msgHdr);</span>
<a href="#l5.958"></a><span id="l5.958" class="difflineplus">+</span>
<a href="#l5.959"></a><span id="l5.959" class="difflineplus">+    // Although deletes should now be so fast that the user has no time to do</span>
<a href="#l5.960"></a><span id="l5.960" class="difflineplus">+    //  anything, treat the user explicitly choosing to display a different</span>
<a href="#l5.961"></a><span id="l5.961" class="difflineplus">+    //  message as invalidating the choice we automatically made for them when</span>
<a href="#l5.962"></a><span id="l5.962" class="difflineplus">+    //  they initiated the message delete / move. (bug 243532)</span>
<a href="#l5.963"></a><span id="l5.963" class="difflineplus">+    // Note: legacy code used to check whether the message being displayed was</span>
<a href="#l5.964"></a><span id="l5.964" class="difflineplus">+    //  the one being deleted, so it didn't erroneously clear the next message</span>
<a href="#l5.965"></a><span id="l5.965" class="difflineplus">+    //  to display (bug 183394).  This is not a problem for us because we hook</span>
<a href="#l5.966"></a><span id="l5.966" class="difflineplus">+    //  our notification when the message load is initiated, rather than when</span>
<a href="#l5.967"></a><span id="l5.967" class="difflineplus">+    //  the message completes loading.</span>
<a href="#l5.968"></a><span id="l5.968" class="difflineplus">+    this._nextViewIndexAfterDelete = null;</span>
<a href="#l5.969"></a><span id="l5.969" class="difflineplus">+  },</span>
<a href="#l5.970"></a><span id="l5.970" class="difflineplus">+</span>
<a href="#l5.971"></a><span id="l5.971" class="difflineplus">+  /**</span>
<a href="#l5.972"></a><span id="l5.972" class="difflineplus">+   * This gets called as a hint that the currently selected message is junk and</span>
<a href="#l5.973"></a><span id="l5.973" class="difflineplus">+   *  said junked message is going to be moved out of the current folder.  The</span>
<a href="#l5.974"></a><span id="l5.974" class="difflineplus">+   *  legacy behaviour is to retrieve the msgToSelectAfterDelete attribute off</span>
<a href="#l5.975"></a><span id="l5.975" class="difflineplus">+   *  the db view, stashing it for benefit of the code that gets called when a</span>
<a href="#l5.976"></a><span id="l5.976" class="difflineplus">+   *  message move/deletion is completed so that we can trigger its display.</span>
<a href="#l5.977"></a><span id="l5.977" class="difflineplus">+   */</span>
<a href="#l5.978"></a><span id="l5.978" class="difflineplus">+  updateNextMessageAfterDelete:</span>
<a href="#l5.979"></a><span id="l5.979" class="difflineplus">+      function FolderDisplayWidget_updateNextMessageAfterDelete() {</span>
<a href="#l5.980"></a><span id="l5.980" class="difflineplus">+    this.hintAboutToDeleteMessages();</span>
<a href="#l5.981"></a><span id="l5.981" class="difflineplus">+  },</span>
<a href="#l5.982"></a><span id="l5.982" class="difflineplus">+</span>
<a href="#l5.983"></a><span id="l5.983" class="difflineplus">+  /**</span>
<a href="#l5.984"></a><span id="l5.984" class="difflineplus">+   * The most recent currentIndexes on the selection (from the last time</span>
<a href="#l5.985"></a><span id="l5.985" class="difflineplus">+   *  summarizeSelection got called).  We use this in onMessagesRemoved if</span>
<a href="#l5.986"></a><span id="l5.986" class="difflineplus">+   *  we get an unexpected notification.</span>
<a href="#l5.987"></a><span id="l5.987" class="difflineplus">+   * We keep a maximum of 2 entries in this list.</span>
<a href="#l5.988"></a><span id="l5.988" class="difflineplus">+   */</span>
<a href="#l5.989"></a><span id="l5.989" class="difflineplus">+  _mostRecentCurrentIndices: undefined, // initialized in constructor</span>
<a href="#l5.990"></a><span id="l5.990" class="difflineplus">+  /**</span>
<a href="#l5.991"></a><span id="l5.991" class="difflineplus">+   * The most recent counts on the selection (from the last time</span>
<a href="#l5.992"></a><span id="l5.992" class="difflineplus">+   *  summarizeSelection got called).  We use this in onMessagesRemoved if</span>
<a href="#l5.993"></a><span id="l5.993" class="difflineplus">+   *  we get an unexpected notification.</span>
<a href="#l5.994"></a><span id="l5.994" class="difflineplus">+   * We keep a maximum of 2 entries in this list.</span>
<a href="#l5.995"></a><span id="l5.995" class="difflineplus">+   */</span>
<a href="#l5.996"></a><span id="l5.996" class="difflineplus">+  _mostRecentSelectionCounts: undefined, // initialized in constructor</span>
<a href="#l5.997"></a><span id="l5.997" class="difflineplus">+</span>
<a href="#l5.998"></a><span id="l5.998" class="difflineplus">+  /**</span>
<a href="#l5.999"></a><span id="l5.999" class="difflineplus">+   * Always called by the db view when the selection changes in</span>
<a href="#l5.1000"></a><span id="l5.1000" class="difflineplus">+   *  SelectionChanged.  This event will come after the notification to</span>
<a href="#l5.1001"></a><span id="l5.1001" class="difflineplus">+   *  displayMessageChanged (if one happens), and before the notification to</span>
<a href="#l5.1002"></a><span id="l5.1002" class="difflineplus">+   *  updateCommandStatus (if one happens).</span>
<a href="#l5.1003"></a><span id="l5.1003" class="difflineplus">+   */</span>
<a href="#l5.1004"></a><span id="l5.1004" class="difflineplus">+  summarizeSelection: function FolderDisplayWidget_summarizeSelection() {</span>
<a href="#l5.1005"></a><span id="l5.1005" class="difflineplus">+    // save the current index off in case the selection gets deleted out from</span>
<a href="#l5.1006"></a><span id="l5.1006" class="difflineplus">+    //  under us and we want to have persistence of actually-having-something</span>
<a href="#l5.1007"></a><span id="l5.1007" class="difflineplus">+    //  selected.</span>
<a href="#l5.1008"></a><span id="l5.1008" class="difflineplus">+    let treeSelection = this.treeSelection;</span>
<a href="#l5.1009"></a><span id="l5.1009" class="difflineplus">+    if (treeSelection) {</span>
<a href="#l5.1010"></a><span id="l5.1010" class="difflineplus">+      this._mostRecentCurrentIndices.unshift(treeSelection.currentIndex);</span>
<a href="#l5.1011"></a><span id="l5.1011" class="difflineplus">+      this._mostRecentCurrentIndices.splice(2);</span>
<a href="#l5.1012"></a><span id="l5.1012" class="difflineplus">+      this._mostRecentSelectionCounts.unshift(treeSelection.count);</span>
<a href="#l5.1013"></a><span id="l5.1013" class="difflineplus">+      this._mostRecentSelectionCounts.splice(2);</span>
<a href="#l5.1014"></a><span id="l5.1014" class="difflineplus">+    }</span>
<a href="#l5.1015"></a><span id="l5.1015" class="difflineplus">+    return this.messageDisplay.onSelectedMessagesChanged();</span>
<a href="#l5.1016"></a><span id="l5.1016" class="difflineplus">+  },</span>
<a href="#l5.1017"></a><span id="l5.1017" class="difflineplus">+</span>
<a href="#l5.1018"></a><span id="l5.1018" class="difflineplus">+  /* ===== End nsIMsgDBViewCommandUpdater ===== */</span>
<a href="#l5.1019"></a><span id="l5.1019" class="difflineplus">+</span>
<a href="#l5.1020"></a><span id="l5.1020" class="difflineplus">+  /* ===== Hints from the command infrastructure ===== */</span>
<a href="#l5.1021"></a><span id="l5.1021" class="difflineplus">+</span>
<a href="#l5.1022"></a><span id="l5.1022" class="difflineplus">+  /**</span>
<a href="#l5.1023"></a><span id="l5.1023" class="difflineplus">+   * doCommand helps us out by telling us when it is telling the view to delete</span>
<a href="#l5.1024"></a><span id="l5.1024" class="difflineplus">+   *  some messages.  Ideally it should go through us / the DB View Wrapper to</span>
<a href="#l5.1025"></a><span id="l5.1025" class="difflineplus">+   *  kick off the delete in the first place, but that's a thread I don't want</span>
<a href="#l5.1026"></a><span id="l5.1026" class="difflineplus">+   *  to pull on right now.</span>
<a href="#l5.1027"></a><span id="l5.1027" class="difflineplus">+   * We use this hint to figure out the next message to display once the</span>
<a href="#l5.1028"></a><span id="l5.1028" class="difflineplus">+   *  deletion completes.  We do this before the deletion happens because the</span>
<a href="#l5.1029"></a><span id="l5.1029" class="difflineplus">+   *  selection is probably going away (except in the IMAP delete model), and it</span>
<a href="#l5.1030"></a><span id="l5.1030" class="difflineplus">+   *  might be too late to figure this out after the deletion happens.</span>
<a href="#l5.1031"></a><span id="l5.1031" class="difflineplus">+   * Our automated complement (that calls us) is updateNextMessageAfterDelete.</span>
<a href="#l5.1032"></a><span id="l5.1032" class="difflineplus">+   */</span>
<a href="#l5.1033"></a><span id="l5.1033" class="difflineplus">+  hintAboutToDeleteMessages:</span>
<a href="#l5.1034"></a><span id="l5.1034" class="difflineplus">+      function FolderDisplayWidget_hintAboutToDeleteMessages() {</span>
<a href="#l5.1035"></a><span id="l5.1035" class="difflineplus">+    // If there is a right click going on, then the possibilities are:</span>
<a href="#l5.1036"></a><span id="l5.1036" class="difflineplus">+    // 1) The user right-clicked in the selection.  In this case, the selection</span>
<a href="#l5.1037"></a><span id="l5.1037" class="difflineplus">+    //    is maintained.  This holds true for one or multiple messages.</span>
<a href="#l5.1038"></a><span id="l5.1038" class="difflineplus">+    // 2) The user right-clicked outside the selection.  In this case, the</span>
<a href="#l5.1039"></a><span id="l5.1039" class="difflineplus">+    //    selection, but not the current index, reflects the single message</span>
<a href="#l5.1040"></a><span id="l5.1040" class="difflineplus">+    //    the user right-clicked on.</span>
<a href="#l5.1041"></a><span id="l5.1041" class="difflineplus">+    // We want to treat case #1 as if a right-click was not involved and we</span>
<a href="#l5.1042"></a><span id="l5.1042" class="difflineplus">+    //  want to ignore case #2 by bailing because our existing selection (or</span>
<a href="#l5.1043"></a><span id="l5.1043" class="difflineplus">+    //  lack thereof) we want maintained.</span>
<a href="#l5.1044"></a><span id="l5.1044" class="difflineplus">+//    if (gRightMouseButtonDown &amp;&amp; gRightMouseButtonChangedSelection)</span>
<a href="#l5.1045"></a><span id="l5.1045" class="difflineplus">+//      return;</span>
<a href="#l5.1046"></a><span id="l5.1046" class="difflineplus">+</span>
<a href="#l5.1047"></a><span id="l5.1047" class="difflineplus">+    // save the value, even if it is nsMsgViewIndex_None.</span>
<a href="#l5.1048"></a><span id="l5.1048" class="difflineplus">+    this._nextViewIndexAfterDelete = this.view.dbView.msgToSelectAfterDelete;</span>
<a href="#l5.1049"></a><span id="l5.1049" class="difflineplus">+  },</span>
<a href="#l5.1050"></a><span id="l5.1050" class="difflineplus">+</span>
<a href="#l5.1051"></a><span id="l5.1051" class="difflineplus">+  /**</span>
<a href="#l5.1052"></a><span id="l5.1052" class="difflineplus">+   * The archive code tells us when it is starting to archive messages.  This</span>
<a href="#l5.1053"></a><span id="l5.1053" class="difflineplus">+   *  is different from hinting about deletion because it will also tell us</span>
<a href="#l5.1054"></a><span id="l5.1054" class="difflineplus">+   *  when it has completed its mass move.</span>
<a href="#l5.1055"></a><span id="l5.1055" class="difflineplus">+   * The UI goal is that we do not immediately jump beyond the selected messages</span>
<a href="#l5.1056"></a><span id="l5.1056" class="difflineplus">+   *  to the next message until all of the selected messages have been</span>
<a href="#l5.1057"></a><span id="l5.1057" class="difflineplus">+   *  processed (moved).  Ideally we would also do this when deleting messages</span>
<a href="#l5.1058"></a><span id="l5.1058" class="difflineplus">+   *  from a multiple-folder backed message view, but we don't know when the</span>
<a href="#l5.1059"></a><span id="l5.1059" class="difflineplus">+   *  last job completes in that case (whereas in this case we do because of the</span>
<a href="#l5.1060"></a><span id="l5.1060" class="difflineplus">+   *  call to hintMassMoveCompleted.)</span>
<a href="#l5.1061"></a><span id="l5.1061" class="difflineplus">+   */</span>
<a href="#l5.1062"></a><span id="l5.1062" class="difflineplus">+  hintMassMoveStarting:</span>
<a href="#l5.1063"></a><span id="l5.1063" class="difflineplus">+      function FolderDisplayWidget_hintMassMoveStarting() {</span>
<a href="#l5.1064"></a><span id="l5.1064" class="difflineplus">+    this.hintAboutToDeleteMessages();</span>
<a href="#l5.1065"></a><span id="l5.1065" class="difflineplus">+    this._massMoveActive = true;</span>
<a href="#l5.1066"></a><span id="l5.1066" class="difflineplus">+  },</span>
<a href="#l5.1067"></a><span id="l5.1067" class="difflineplus">+</span>
<a href="#l5.1068"></a><span id="l5.1068" class="difflineplus">+  /**</span>
<a href="#l5.1069"></a><span id="l5.1069" class="difflineplus">+   * The archival has completed, we can finally let onMessagseRemoved run to</span>
<a href="#l5.1070"></a><span id="l5.1070" class="difflineplus">+   *  completion.</span>
<a href="#l5.1071"></a><span id="l5.1071" class="difflineplus">+   */</span>
<a href="#l5.1072"></a><span id="l5.1072" class="difflineplus">+  hintMassMoveCompleted:</span>
<a href="#l5.1073"></a><span id="l5.1073" class="difflineplus">+      function FolderDisplayWidget_hintMassMoveCompleted() {</span>
<a href="#l5.1074"></a><span id="l5.1074" class="difflineplus">+    this._massMoveActive = false;</span>
<a href="#l5.1075"></a><span id="l5.1075" class="difflineplus">+    this.onMessagesRemoved();</span>
<a href="#l5.1076"></a><span id="l5.1076" class="difflineplus">+  },</span>
<a href="#l5.1077"></a><span id="l5.1077" class="difflineplus">+</span>
<a href="#l5.1078"></a><span id="l5.1078" class="difflineplus">+  /**</span>
<a href="#l5.1079"></a><span id="l5.1079" class="difflineplus">+   * When a right-click on the thread pane is going to alter our selection, we</span>
<a href="#l5.1080"></a><span id="l5.1080" class="difflineplus">+   *  get this notification (currently from |ChangeSelectionWithoutContentLoad|</span>
<a href="#l5.1081"></a><span id="l5.1081" class="difflineplus">+   *  in msgMail3PaneWindow.js), which lets us save our state.</span>
<a href="#l5.1082"></a><span id="l5.1082" class="difflineplus">+   * This ends one of two ways: we get made inactive because a new tab popped up</span>
<a href="#l5.1083"></a><span id="l5.1083" class="difflineplus">+   *  or we get a call to |hintRightClickSelectionPerturbationDone|.</span>
<a href="#l5.1084"></a><span id="l5.1084" class="difflineplus">+   *</span>
<a href="#l5.1085"></a><span id="l5.1085" class="difflineplus">+   * Ideally, we could just save off our current nsITreeSelection and restore it</span>
<a href="#l5.1086"></a><span id="l5.1086" class="difflineplus">+   *  when this is all over.  This assumption would rely on the underlying view</span>
<a href="#l5.1087"></a><span id="l5.1087" class="difflineplus">+   *  not having any changes to its rows before we restore the selection.  I am</span>
<a href="#l5.1088"></a><span id="l5.1088" class="difflineplus">+   *  not confident we can rule out background processes making changes, plus</span>
<a href="#l5.1089"></a><span id="l5.1089" class="difflineplus">+   *  the right-click itself may mutate the view (although we could try and get</span>
<a href="#l5.1090"></a><span id="l5.1090" class="difflineplus">+   *  it to restore the selection before it gets to the mutation part).  Our</span>
<a href="#l5.1091"></a><span id="l5.1091" class="difflineplus">+   *  only way to resolve this would be to create a 'tee' like fake selection</span>
<a href="#l5.1092"></a><span id="l5.1092" class="difflineplus">+   *  that would proxy view change notifications to both sets of selections.</span>
<a href="#l5.1093"></a><span id="l5.1093" class="difflineplus">+   *  That is hard.</span>
<a href="#l5.1094"></a><span id="l5.1094" class="difflineplus">+   * So we just use the existing _saveSelection/_restoreSelection mechanism</span>
<a href="#l5.1095"></a><span id="l5.1095" class="difflineplus">+   *  which is potentially very costly.</span>
<a href="#l5.1096"></a><span id="l5.1096" class="difflineplus">+   */</span>
<a href="#l5.1097"></a><span id="l5.1097" class="difflineplus">+  hintRightClickPerturbingSelection:</span>
<a href="#l5.1098"></a><span id="l5.1098" class="difflineplus">+      function FolderDisplayWidget_hintRightClickPerturbingSelect() {</span>
<a href="#l5.1099"></a><span id="l5.1099" class="difflineplus">+    this._saveSelection();</span>
<a href="#l5.1100"></a><span id="l5.1100" class="difflineplus">+  },</span>
<a href="#l5.1101"></a><span id="l5.1101" class="difflineplus">+</span>
<a href="#l5.1102"></a><span id="l5.1102" class="difflineplus">+  /**</span>
<a href="#l5.1103"></a><span id="l5.1103" class="difflineplus">+   * When a right-click on the thread pane altered our selection (which we</span>
<a href="#l5.1104"></a><span id="l5.1104" class="difflineplus">+   *  should have received a call to |hintRightClickPerturbingSelection| for),</span>
<a href="#l5.1105"></a><span id="l5.1105" class="difflineplus">+   *  we should receive this notification from</span>
<a href="#l5.1106"></a><span id="l5.1106" class="difflineplus">+   *  |RestoreSelectionWithoutContentLoad| when it wants to put things back.</span>
<a href="#l5.1107"></a><span id="l5.1107" class="difflineplus">+   */</span>
<a href="#l5.1108"></a><span id="l5.1108" class="difflineplus">+  hintRightClickSelectionPerturbationDone:</span>
<a href="#l5.1109"></a><span id="l5.1109" class="difflineplus">+      function FolderDisplayWidget_hintRightClickSelectionPerturbationDone() {</span>
<a href="#l5.1110"></a><span id="l5.1110" class="difflineplus">+    this._restoreSelection();</span>
<a href="#l5.1111"></a><span id="l5.1111" class="difflineplus">+  },</span>
<a href="#l5.1112"></a><span id="l5.1112" class="difflineplus">+</span>
<a href="#l5.1113"></a><span id="l5.1113" class="difflineplus">+  /* ===== End hints from the command infrastructure ==== */</span>
<a href="#l5.1114"></a><span id="l5.1114" class="difflineplus">+</span>
<a href="#l5.1115"></a><span id="l5.1115" class="difflineplus">+  _updateThreadDisplay: function FolderDisplayWidget__updateThreadDisplay() {</span>
<a href="#l5.1116"></a><span id="l5.1116" class="difflineplus">+    if (this.active) {</span>
<a href="#l5.1117"></a><span id="l5.1117" class="difflineplus">+      if (this.view.dbView) {</span>
<a href="#l5.1118"></a><span id="l5.1118" class="difflineplus">+        this.updateColumns();</span>
<a href="#l5.1119"></a><span id="l5.1119" class="difflineplus">+        UpdateSortIndicators(this.view.dbView.sortType,</span>
<a href="#l5.1120"></a><span id="l5.1120" class="difflineplus">+                             this.view.dbView.sortOrder);</span>
<a href="#l5.1121"></a><span id="l5.1121" class="difflineplus">+        SetNewsFolderColumns();</span>
<a href="#l5.1122"></a><span id="l5.1122" class="difflineplus">+      }</span>
<a href="#l5.1123"></a><span id="l5.1123" class="difflineplus">+    }</span>
<a href="#l5.1124"></a><span id="l5.1124" class="difflineplus">+  },</span>
<a href="#l5.1125"></a><span id="l5.1125" class="difflineplus">+</span>
<a href="#l5.1126"></a><span id="l5.1126" class="difflineplus">+  /**</span>
<a href="#l5.1127"></a><span id="l5.1127" class="difflineplus">+   * Update the UI display apart from the thread tree because the folder being</span>
<a href="#l5.1128"></a><span id="l5.1128" class="difflineplus">+   *  displayed has changed.  This can be the result of changing the folder in</span>
<a href="#l5.1129"></a><span id="l5.1129" class="difflineplus">+   *  this FolderDisplayWidget, or because this FolderDisplayWidget is being</span>
<a href="#l5.1130"></a><span id="l5.1130" class="difflineplus">+   *  made active.  _updateThreadDisplay handles the parts of the thread tree</span>
<a href="#l5.1131"></a><span id="l5.1131" class="difflineplus">+   *  that need updating.</span>
<a href="#l5.1132"></a><span id="l5.1132" class="difflineplus">+   */</span>
<a href="#l5.1133"></a><span id="l5.1133" class="difflineplus">+  _updateContextDisplay: function FolderDisplayWidget__updateContextDisplay() {</span>
<a href="#l5.1134"></a><span id="l5.1134" class="difflineplus">+    if (this.active) {</span>
<a href="#l5.1135"></a><span id="l5.1135" class="difflineplus">+      UpdateMailToolbar(&quot;FolderDisplayWidget updating context&quot;);</span>
<a href="#l5.1136"></a><span id="l5.1136" class="difflineplus">+      UpdateStatusQuota(this.displayedFolder);</span>
<a href="#l5.1137"></a><span id="l5.1137" class="difflineplus">+      UpdateStatusMessageCounts(this.displayedFolder);</span>
<a href="#l5.1138"></a><span id="l5.1138" class="difflineplus">+</span>
<a href="#l5.1139"></a><span id="l5.1139" class="difflineplus">+      // - mail view combo-box.</span>
<a href="#l5.1140"></a><span id="l5.1140" class="difflineplus">+      this.onMailViewChanged();</span>
<a href="#l5.1141"></a><span id="l5.1141" class="difflineplus">+    }</span>
<a href="#l5.1142"></a><span id="l5.1142" class="difflineplus">+  },</span>
<a href="#l5.1143"></a><span id="l5.1143" class="difflineplus">+</span>
<a href="#l5.1144"></a><span id="l5.1144" class="difflineplus">+  /**</span>
<a href="#l5.1145"></a><span id="l5.1145" class="difflineplus">+   * Run the provided notification function right now if we are 'active' (the</span>
<a href="#l5.1146"></a><span id="l5.1146" class="difflineplus">+   *  currently displayed tab), otherwise queue it to be run when we become</span>
<a href="#l5.1147"></a><span id="l5.1147" class="difflineplus">+   *  active.  We do this because our tabbing model uses multiplexed (reused)</span>
<a href="#l5.1148"></a><span id="l5.1148" class="difflineplus">+   *  widgets, and extensions likewise depend on these global/singleton things.</span>
<a href="#l5.1149"></a><span id="l5.1149" class="difflineplus">+   * If the requested notification function is already queued, it will not be</span>
<a href="#l5.1150"></a><span id="l5.1150" class="difflineplus">+   *  added a second time, and the original call ordering will be maintained.</span>
<a href="#l5.1151"></a><span id="l5.1151" class="difflineplus">+   *  If a new call ordering is required, the list of notifications should</span>
<a href="#l5.1152"></a><span id="l5.1152" class="difflineplus">+   *  probably be reset by the 'big bang' event (new view creation?).</span>
<a href="#l5.1153"></a><span id="l5.1153" class="difflineplus">+   */</span>
<a href="#l5.1154"></a><span id="l5.1154" class="difflineplus">+  _notifyWhenActive: function (aNotificationFunc) {</span>
<a href="#l5.1155"></a><span id="l5.1155" class="difflineplus">+    if (this._active) {</span>
<a href="#l5.1156"></a><span id="l5.1156" class="difflineplus">+      aNotificationFunc.call(this);</span>
<a href="#l5.1157"></a><span id="l5.1157" class="difflineplus">+    }</span>
<a href="#l5.1158"></a><span id="l5.1158" class="difflineplus">+    else {</span>
<a href="#l5.1159"></a><span id="l5.1159" class="difflineplus">+      if (this._notificationsPendingActivation.indexOf(aNotificationFunc) == -1)</span>
<a href="#l5.1160"></a><span id="l5.1160" class="difflineplus">+        this._notificationsPendingActivation.push(aNotificationFunc);</span>
<a href="#l5.1161"></a><span id="l5.1161" class="difflineplus">+    }</span>
<a href="#l5.1162"></a><span id="l5.1162" class="difflineplus">+  },</span>
<a href="#l5.1163"></a><span id="l5.1163" class="difflineplus">+</span>
<a href="#l5.1164"></a><span id="l5.1164" class="difflineplus">+  /**</span>
<a href="#l5.1165"></a><span id="l5.1165" class="difflineplus">+   * Some notifications cannot run while the FolderDisplayWidget is inactive</span>
<a href="#l5.1166"></a><span id="l5.1166" class="difflineplus">+   *  (presumbly because it is in a background tab).  We accumulate those in</span>
<a href="#l5.1167"></a><span id="l5.1167" class="difflineplus">+   *  _notificationsPendingActivation and then this method runs them when we</span>
<a href="#l5.1168"></a><span id="l5.1168" class="difflineplus">+   *  become active again.</span>
<a href="#l5.1169"></a><span id="l5.1169" class="difflineplus">+   */</span>
<a href="#l5.1170"></a><span id="l5.1170" class="difflineplus">+  _runNotificationsPendingActivation:</span>
<a href="#l5.1171"></a><span id="l5.1171" class="difflineplus">+      function FolderDisplayWidget__runNotificationsPendingActivation() {</span>
<a href="#l5.1172"></a><span id="l5.1172" class="difflineplus">+    if (!this._notificationsPendingActivation.length)</span>
<a href="#l5.1173"></a><span id="l5.1173" class="difflineplus">+      return;</span>
<a href="#l5.1174"></a><span id="l5.1174" class="difflineplus">+</span>
<a href="#l5.1175"></a><span id="l5.1175" class="difflineplus">+    let pendingNotifications = this._notificationsPendingActivation;</span>
<a href="#l5.1176"></a><span id="l5.1176" class="difflineplus">+    this._notificationsPendingActivation = [];</span>
<a href="#l5.1177"></a><span id="l5.1177" class="difflineplus">+    for each (let [, notif] in Iterator(pendingNotifications)) {</span>
<a href="#l5.1178"></a><span id="l5.1178" class="difflineplus">+      notif.call(this);</span>
<a href="#l5.1179"></a><span id="l5.1179" class="difflineplus">+    }</span>
<a href="#l5.1180"></a><span id="l5.1180" class="difflineplus">+  },</span>
<a href="#l5.1181"></a><span id="l5.1181" class="difflineplus">+</span>
<a href="#l5.1182"></a><span id="l5.1182" class="difflineplus">+  get active() {</span>
<a href="#l5.1183"></a><span id="l5.1183" class="difflineplus">+    return this._active;</span>
<a href="#l5.1184"></a><span id="l5.1184" class="difflineplus">+  },</span>
<a href="#l5.1185"></a><span id="l5.1185" class="difflineplus">+</span>
<a href="#l5.1186"></a><span id="l5.1186" class="difflineplus">+  /**</span>
<a href="#l5.1187"></a><span id="l5.1187" class="difflineplus">+   * Make this FolderDisplayWidget the 'active' widget by updating globals and</span>
<a href="#l5.1188"></a><span id="l5.1188" class="difflineplus">+   *  linking us up to the UI widgets.  This is intended for use by the tabbing</span>
<a href="#l5.1189"></a><span id="l5.1189" class="difflineplus">+   *  logic.</span>
<a href="#l5.1190"></a><span id="l5.1190" class="difflineplus">+   */</span>
<a href="#l5.1191"></a><span id="l5.1191" class="difflineplus">+  makeActive: function FolderDisplayWidget_makeActive(aWasInactive) {</span>
<a href="#l5.1192"></a><span id="l5.1192" class="difflineplus">+    let wasInactive = !this._active;</span>
<a href="#l5.1193"></a><span id="l5.1193" class="difflineplus">+</span>
<a href="#l5.1194"></a><span id="l5.1194" class="difflineplus">+    // -- globals</span>
<a href="#l5.1195"></a><span id="l5.1195" class="difflineplus">+    // update per-tab globals that we own</span>
<a href="#l5.1196"></a><span id="l5.1196" class="difflineplus">+    gFolderDisplay = this;</span>
<a href="#l5.1197"></a><span id="l5.1197" class="difflineplus">+    gMessageDisplay = this.messageDisplay;</span>
<a href="#l5.1198"></a><span id="l5.1198" class="difflineplus">+    gDBView = this.view.dbView;</span>
<a href="#l5.1199"></a><span id="l5.1199" class="difflineplus">+    messenger = this.messenger;</span>
<a href="#l5.1200"></a><span id="l5.1200" class="difflineplus">+</span>
<a href="#l5.1201"></a><span id="l5.1201" class="difflineplus">+    // update singleton globals' state</span>
<a href="#l5.1202"></a><span id="l5.1202" class="difflineplus">+    msgWindow.openFolder = this.view.displayedFolder;</span>
<a href="#l5.1203"></a><span id="l5.1203" class="difflineplus">+</span>
<a href="#l5.1204"></a><span id="l5.1204" class="difflineplus">+    this._active = true;</span>
<a href="#l5.1205"></a><span id="l5.1205" class="difflineplus">+    this._runNotificationsPendingActivation();</span>
<a href="#l5.1206"></a><span id="l5.1206" class="difflineplus">+</span>
<a href="#l5.1207"></a><span id="l5.1207" class="difflineplus">+    // -- UI</span>
<a href="#l5.1208"></a><span id="l5.1208" class="difflineplus">+</span>
<a href="#l5.1209"></a><span id="l5.1209" class="difflineplus">+    // thread pane if we have a db view</span>
<a href="#l5.1210"></a><span id="l5.1210" class="difflineplus">+    if (this.view.dbView) {</span>
<a href="#l5.1211"></a><span id="l5.1211" class="difflineplus">+      // Make sure said thread pane is visible.  If we do this after we re-root</span>
<a href="#l5.1212"></a><span id="l5.1212" class="difflineplus">+      //  the tree, the thread pane may not actually replace the account central</span>
<a href="#l5.1213"></a><span id="l5.1213" class="difflineplus">+      //  pane.  Concerning...</span>
<a href="#l5.1214"></a><span id="l5.1214" class="difflineplus">+      this._showThreadPane();</span>
<a href="#l5.1215"></a><span id="l5.1215" class="difflineplus">+</span>
<a href="#l5.1216"></a><span id="l5.1216" class="difflineplus">+      // some things only need to happen if we are transitioning from inactive</span>
<a href="#l5.1217"></a><span id="l5.1217" class="difflineplus">+      //  to active</span>
<a href="#l5.1218"></a><span id="l5.1218" class="difflineplus">+      if (wasInactive) {</span>
<a href="#l5.1219"></a><span id="l5.1219" class="difflineplus">+        // Setting the 'view' attribute on treeBox results in the following</span>
<a href="#l5.1220"></a><span id="l5.1220" class="difflineplus">+        //  effective calls, noting that in makeInactive we made sure to null</span>
<a href="#l5.1221"></a><span id="l5.1221" class="difflineplus">+        //  out its view so that it won't try and clean up any views or their</span>
<a href="#l5.1222"></a><span id="l5.1222" class="difflineplus">+        //  selections.  (The actual actions happen in nsTreeBodyFrame::SetView)</span>
<a href="#l5.1223"></a><span id="l5.1223" class="difflineplus">+        // - this.view.dbView.selection.tree = this.treeBox</span>
<a href="#l5.1224"></a><span id="l5.1224" class="difflineplus">+        // - this.view.dbView.setTree(this.treeBox)</span>
<a href="#l5.1225"></a><span id="l5.1225" class="difflineplus">+        // - this.treeBox.view = this.view.dbView (in nsTreeBodyObject::SetView)</span>
<a href="#l5.1226"></a><span id="l5.1226" class="difflineplus">+        if (this.treeBox) {</span>
<a href="#l5.1227"></a><span id="l5.1227" class="difflineplus">+          this.treeBox.view = this.view.dbView;</span>
<a href="#l5.1228"></a><span id="l5.1228" class="difflineplus">+          if (this._savedFirstVisibleRow != null)</span>
<a href="#l5.1229"></a><span id="l5.1229" class="difflineplus">+            this.treeBox.scrollToRow(this._savedFirstVisibleRow);</span>
<a href="#l5.1230"></a><span id="l5.1230" class="difflineplus">+</span>
<a href="#l5.1231"></a><span id="l5.1231" class="difflineplus">+          this.restoreColumnStates();</span>
<a href="#l5.1232"></a><span id="l5.1232" class="difflineplus">+        }</span>
<a href="#l5.1233"></a><span id="l5.1233" class="difflineplus">+</span>
<a href="#l5.1234"></a><span id="l5.1234" class="difflineplus">+        // restore the quick search widget</span>
<a href="#l5.1235"></a><span id="l5.1235" class="difflineplus">+        let searchInput = document.getElementById(&quot;searchInput&quot;);</span>
<a href="#l5.1236"></a><span id="l5.1236" class="difflineplus">+        if (searchInput &amp;&amp; this._savedQuickSearch) {</span>
<a href="#l5.1237"></a><span id="l5.1237" class="difflineplus">+          searchInput.searchMode = this._savedQuickSearch.searchMode;</span>
<a href="#l5.1238"></a><span id="l5.1238" class="difflineplus">+          if (this._savedQuickSearch.text) {</span>
<a href="#l5.1239"></a><span id="l5.1239" class="difflineplus">+            searchInput.value = this._savedQuickSearch.text;</span>
<a href="#l5.1240"></a><span id="l5.1240" class="difflineplus">+            searchInput.showingSearchCriteria = false;</span>
<a href="#l5.1241"></a><span id="l5.1241" class="difflineplus">+            searchInput.clearButtonHidden = false;</span>
<a href="#l5.1242"></a><span id="l5.1242" class="difflineplus">+          }</span>
<a href="#l5.1243"></a><span id="l5.1243" class="difflineplus">+          else {</span>
<a href="#l5.1244"></a><span id="l5.1244" class="difflineplus">+            searchInput.setSearchCriteriaText();</span>
<a href="#l5.1245"></a><span id="l5.1245" class="difflineplus">+          }</span>
<a href="#l5.1246"></a><span id="l5.1246" class="difflineplus">+        }</span>
<a href="#l5.1247"></a><span id="l5.1247" class="difflineplus">+      }</span>
<a href="#l5.1248"></a><span id="l5.1248" class="difflineplus">+</span>
<a href="#l5.1249"></a><span id="l5.1249" class="difflineplus">+      // the tab mode knows whether we are folder or message display, which</span>
<a href="#l5.1250"></a><span id="l5.1250" class="difflineplus">+      //  impacts the legal modes</span>
<a href="#l5.1251"></a><span id="l5.1251" class="difflineplus">+      if (this._tabInfo)</span>
<a href="#l5.1252"></a><span id="l5.1252" class="difflineplus">+        mailTabType._setPaneStates(this._tabInfo.mode.legalPanes,</span>
<a href="#l5.1253"></a><span id="l5.1253" class="difflineplus">+          {folder: !this._tabInfo.folderPaneCollapsed,</span>
<a href="#l5.1254"></a><span id="l5.1254" class="difflineplus">+           message: !this._tabInfo.messagePaneCollapsed});</span>
<a href="#l5.1255"></a><span id="l5.1255" class="difflineplus">+</span>
<a href="#l5.1256"></a><span id="l5.1256" class="difflineplus">+      // update the columns and such that live inside the thread pane</span>
<a href="#l5.1257"></a><span id="l5.1257" class="difflineplus">+      this._updateThreadDisplay();</span>
<a href="#l5.1258"></a><span id="l5.1258" class="difflineplus">+</span>
<a href="#l5.1259"></a><span id="l5.1259" class="difflineplus">+      this.messageDisplay.makeActive();</span>
<a href="#l5.1260"></a><span id="l5.1260" class="difflineplus">+    }</span>
<a href="#l5.1261"></a><span id="l5.1261" class="difflineplus">+    // account central stuff when we don't have a dbview</span>
<a href="#l5.1262"></a><span id="l5.1262" class="difflineplus">+    else {</span>
<a href="#l5.1263"></a><span id="l5.1263" class="difflineplus">+      this._showAccountCentral();</span>
<a href="#l5.1264"></a><span id="l5.1264" class="difflineplus">+      if (this._tabInfo)</span>
<a href="#l5.1265"></a><span id="l5.1265" class="difflineplus">+        mailTabType._setPaneStates(this._tabInfo.mode.legalPanes,</span>
<a href="#l5.1266"></a><span id="l5.1266" class="difflineplus">+                                   {folder: !this._tabInfo.folderPaneCollapsed,</span>
<a href="#l5.1267"></a><span id="l5.1267" class="difflineplus">+                                    message: false});</span>
<a href="#l5.1268"></a><span id="l5.1268" class="difflineplus">+    }</span>
<a href="#l5.1269"></a><span id="l5.1269" class="difflineplus">+</span>
<a href="#l5.1270"></a><span id="l5.1270" class="difflineplus">+    this._updateContextDisplay();</span>
<a href="#l5.1271"></a><span id="l5.1271" class="difflineplus">+  },</span>
<a href="#l5.1272"></a><span id="l5.1272" class="difflineplus">+</span>
<a href="#l5.1273"></a><span id="l5.1273" class="difflineplus">+  /**</span>
<a href="#l5.1274"></a><span id="l5.1274" class="difflineplus">+   * Cause the displayDeck to display the thread pane.</span>
<a href="#l5.1275"></a><span id="l5.1275" class="difflineplus">+   */</span>
<a href="#l5.1276"></a><span id="l5.1276" class="difflineplus">+  _showThreadPane: function FolderDisplayWidget__showThreadPane() {</span>
<a href="#l5.1277"></a><span id="l5.1277" class="difflineplus">+    document.getElementById(&quot;displayDeck&quot;).selectedPanel =</span>
<a href="#l5.1278"></a><span id="l5.1278" class="difflineplus">+      document.getElementById(&quot;threadPaneBox&quot;);</span>
<a href="#l5.1279"></a><span id="l5.1279" class="difflineplus">+  },</span>
<a href="#l5.1280"></a><span id="l5.1280" class="difflineplus">+</span>
<a href="#l5.1281"></a><span id="l5.1281" class="difflineplus">+  /**</span>
<a href="#l5.1282"></a><span id="l5.1282" class="difflineplus">+   * Cause the displayDeck to display the (preference configurable) account</span>
<a href="#l5.1283"></a><span id="l5.1283" class="difflineplus">+   *  central page.</span>
<a href="#l5.1284"></a><span id="l5.1284" class="difflineplus">+   */</span>
<a href="#l5.1285"></a><span id="l5.1285" class="difflineplus">+  _showAccountCentral: function FolderDisplayWidget__showAccountCentral() {</span>
<a href="#l5.1286"></a><span id="l5.1286" class="difflineplus">+    var accountBox = document.getElementById(&quot;accountCentralBox&quot;);</span>
<a href="#l5.1287"></a><span id="l5.1287" class="difflineplus">+    document.getElementById(&quot;displayDeck&quot;).selectedPanel = accountBox;</span>
<a href="#l5.1288"></a><span id="l5.1288" class="difflineplus">+    var prefName = &quot;mailnews.account_central_page.url&quot;;</span>
<a href="#l5.1289"></a><span id="l5.1289" class="difflineplus">+    // oh yeah, 'pref' is a global all right.</span>
<a href="#l5.1290"></a><span id="l5.1290" class="difflineplus">+    var acctCentralPage =</span>
<a href="#l5.1291"></a><span id="l5.1291" class="difflineplus">+      pref.getComplexValue(prefName,</span>
<a href="#l5.1292"></a><span id="l5.1292" class="difflineplus">+                           Components.interfaces.nsIPrefLocalizedString).data;</span>
<a href="#l5.1293"></a><span id="l5.1293" class="difflineplus">+    window.frames[&quot;accountCentralPane&quot;].location.href = acctCentralPage;</span>
<a href="#l5.1294"></a><span id="l5.1294" class="difflineplus">+  },</span>
<a href="#l5.1295"></a><span id="l5.1295" class="difflineplus">+</span>
<a href="#l5.1296"></a><span id="l5.1296" class="difflineplus">+  /**</span>
<a href="#l5.1297"></a><span id="l5.1297" class="difflineplus">+   * Call this when the tab using us is being hidden.</span>
<a href="#l5.1298"></a><span id="l5.1298" class="difflineplus">+   */</span>
<a href="#l5.1299"></a><span id="l5.1299" class="difflineplus">+  makeInactive: function FolderDisplayWidget_makeInactive() {</span>
<a href="#l5.1300"></a><span id="l5.1300" class="difflineplus">+    this._active = false;</span>
<a href="#l5.1301"></a><span id="l5.1301" class="difflineplus">+    // save the folder pane's state always</span>
<a href="#l5.1302"></a><span id="l5.1302" class="difflineplus">+    this.folderPaneCollapsed =</span>
<a href="#l5.1303"></a><span id="l5.1303" class="difflineplus">+      document.getElementById(&quot;folderPaneBox&quot;).collapsed;</span>
<a href="#l5.1304"></a><span id="l5.1304" class="difflineplus">+</span>
<a href="#l5.1305"></a><span id="l5.1305" class="difflineplus">+    if (this.view.dbView) {</span>
<a href="#l5.1306"></a><span id="l5.1306" class="difflineplus">+      if (this.treeBox)</span>
<a href="#l5.1307"></a><span id="l5.1307" class="difflineplus">+        this._savedFirstVisibleRow = this.treeBox.getFirstVisibleRow();</span>
<a href="#l5.1308"></a><span id="l5.1308" class="difflineplus">+</span>
<a href="#l5.1309"></a><span id="l5.1309" class="difflineplus">+      // save column states</span>
<a href="#l5.1310"></a><span id="l5.1310" class="difflineplus">+      this.saveColumnStates();</span>
<a href="#l5.1311"></a><span id="l5.1311" class="difflineplus">+</span>
<a href="#l5.1312"></a><span id="l5.1312" class="difflineplus">+      // save the message pane's state only when it is potentially visible</span>
<a href="#l5.1313"></a><span id="l5.1313" class="difflineplus">+      this.messagePaneCollapsed =</span>
<a href="#l5.1314"></a><span id="l5.1314" class="difflineplus">+        document.getElementById(&quot;messagepanebox&quot;).collapsed;</span>
<a href="#l5.1315"></a><span id="l5.1315" class="difflineplus">+</span>
<a href="#l5.1316"></a><span id="l5.1316" class="difflineplus">+      // save the actual quick-search query text</span>
<a href="#l5.1317"></a><span id="l5.1317" class="difflineplus">+      let searchInput = document.getElementById(&quot;searchInput&quot;);</span>
<a href="#l5.1318"></a><span id="l5.1318" class="difflineplus">+      if (searchInput) {</span>
<a href="#l5.1319"></a><span id="l5.1319" class="difflineplus">+        this._savedQuickSearch = {</span>
<a href="#l5.1320"></a><span id="l5.1320" class="difflineplus">+          text: searchInput.showingSearchCriteria ? null : searchInput.value,</span>
<a href="#l5.1321"></a><span id="l5.1321" class="difflineplus">+          searchMode: searchInput.searchMode</span>
<a href="#l5.1322"></a><span id="l5.1322" class="difflineplus">+        };</span>
<a href="#l5.1323"></a><span id="l5.1323" class="difflineplus">+      }</span>
<a href="#l5.1324"></a><span id="l5.1324" class="difflineplus">+</span>
<a href="#l5.1325"></a><span id="l5.1325" class="difflineplus">+      // save off the tree selection object.  the nsTreeBodyFrame will make the</span>
<a href="#l5.1326"></a><span id="l5.1326" class="difflineplus">+      //  view forget about it when our view is removed, so it's up to us to</span>
<a href="#l5.1327"></a><span id="l5.1327" class="difflineplus">+      //  save it.</span>
<a href="#l5.1328"></a><span id="l5.1328" class="difflineplus">+      let treeViewSelection = this.view.dbView.selection;</span>
<a href="#l5.1329"></a><span id="l5.1329" class="difflineplus">+      // make the tree forget about the view right now so we can tell the db</span>
<a href="#l5.1330"></a><span id="l5.1330" class="difflineplus">+      //  view about its selection object so it can try and keep it up-to-date</span>
<a href="#l5.1331"></a><span id="l5.1331" class="difflineplus">+      //  even while hidden in the background</span>
<a href="#l5.1332"></a><span id="l5.1332" class="difflineplus">+      if (this.treeBox)</span>
<a href="#l5.1333"></a><span id="l5.1333" class="difflineplus">+        this.treeBox.view = null;</span>
<a href="#l5.1334"></a><span id="l5.1334" class="difflineplus">+      // (and tell the db view about its selection again...)</span>
<a href="#l5.1335"></a><span id="l5.1335" class="difflineplus">+      this.view.dbView.selection = treeViewSelection;</span>
<a href="#l5.1336"></a><span id="l5.1336" class="difflineplus">+</span>
<a href="#l5.1337"></a><span id="l5.1337" class="difflineplus">+      // hook the dbview up to the fake tree box</span>
<a href="#l5.1338"></a><span id="l5.1338" class="difflineplus">+      this._fakeTreeBox.view = this.view.dbView;</span>
<a href="#l5.1339"></a><span id="l5.1339" class="difflineplus">+      this.view.dbView.setTree(this._fakeTreeBox);</span>
<a href="#l5.1340"></a><span id="l5.1340" class="difflineplus">+      treeViewSelection.tree = this._fakeTreeBox;</span>
<a href="#l5.1341"></a><span id="l5.1341" class="difflineplus">+    }</span>
<a href="#l5.1342"></a><span id="l5.1342" class="difflineplus">+</span>
<a href="#l5.1343"></a><span id="l5.1343" class="difflineplus">+    this.messageDisplay.makeInactive();</span>
<a href="#l5.1344"></a><span id="l5.1344" class="difflineplus">+  },</span>
<a href="#l5.1345"></a><span id="l5.1345" class="difflineplus">+</span>
<a href="#l5.1346"></a><span id="l5.1346" class="difflineplus">+  /**</span>
<a href="#l5.1347"></a><span id="l5.1347" class="difflineplus">+   * @return true if there is a db view and the command is enabled on the view.</span>
<a href="#l5.1348"></a><span id="l5.1348" class="difflineplus">+   *  This function hides some of the XPCOM-odditities of the getCommandStatus</span>
<a href="#l5.1349"></a><span id="l5.1349" class="difflineplus">+   *  call.</span>
<a href="#l5.1350"></a><span id="l5.1350" class="difflineplus">+   */</span>
<a href="#l5.1351"></a><span id="l5.1351" class="difflineplus">+  getCommandStatus: function FolderDisplayWidget_getCommandStatus(</span>
<a href="#l5.1352"></a><span id="l5.1352" class="difflineplus">+      aCommandType, aEnabledObj, aCheckStatusObj) {</span>
<a href="#l5.1353"></a><span id="l5.1353" class="difflineplus">+    // no view means not enabled</span>
<a href="#l5.1354"></a><span id="l5.1354" class="difflineplus">+    if (!this.view.dbView)</span>
<a href="#l5.1355"></a><span id="l5.1355" class="difflineplus">+      return false;</span>
<a href="#l5.1356"></a><span id="l5.1356" class="difflineplus">+    let enabledObj = {}, checkStatusObj = {};</span>
<a href="#l5.1357"></a><span id="l5.1357" class="difflineplus">+    this.view.dbView.getCommandStatus(aCommandType, enabledObj, checkStatusObj);</span>
<a href="#l5.1358"></a><span id="l5.1358" class="difflineplus">+    return enabledObj.value;</span>
<a href="#l5.1359"></a><span id="l5.1359" class="difflineplus">+  },</span>
<a href="#l5.1360"></a><span id="l5.1360" class="difflineplus">+</span>
<a href="#l5.1361"></a><span id="l5.1361" class="difflineplus">+  /**</span>
<a href="#l5.1362"></a><span id="l5.1362" class="difflineplus">+   * Make code cleaner by allowing peoples to call doCommand on us rather than</span>
<a href="#l5.1363"></a><span id="l5.1363" class="difflineplus">+   *  having to do folderDisplayWidget.view.dbView.doCommand.</span>
<a href="#l5.1364"></a><span id="l5.1364" class="difflineplus">+   *</span>
<a href="#l5.1365"></a><span id="l5.1365" class="difflineplus">+   * @param aCommandName The command name to invoke.</span>
<a href="#l5.1366"></a><span id="l5.1366" class="difflineplus">+   */</span>
<a href="#l5.1367"></a><span id="l5.1367" class="difflineplus">+  doCommand: function FolderDisplayWidget_doCommand(aCommandName) {</span>
<a href="#l5.1368"></a><span id="l5.1368" class="difflineplus">+    return this.view.dbView &amp;&amp; this.view.dbView.doCommand(aCommandName);</span>
<a href="#l5.1369"></a><span id="l5.1369" class="difflineplus">+  },</span>
<a href="#l5.1370"></a><span id="l5.1370" class="difflineplus">+</span>
<a href="#l5.1371"></a><span id="l5.1371" class="difflineplus">+  /**</span>
<a href="#l5.1372"></a><span id="l5.1372" class="difflineplus">+   * Make code cleaner by allowing peoples to call doCommandWithFolder on us</span>
<a href="#l5.1373"></a><span id="l5.1373" class="difflineplus">+   *  rather than having to do:</span>
<a href="#l5.1374"></a><span id="l5.1374" class="difflineplus">+   *  folderDisplayWidget.view.dbView.doCommandWithFolder.</span>
<a href="#l5.1375"></a><span id="l5.1375" class="difflineplus">+   *</span>
<a href="#l5.1376"></a><span id="l5.1376" class="difflineplus">+   * @param aCommandName The command name to invoke.</span>
<a href="#l5.1377"></a><span id="l5.1377" class="difflineplus">+   * @param aFolder The folder context for the command.</span>
<a href="#l5.1378"></a><span id="l5.1378" class="difflineplus">+   */</span>
<a href="#l5.1379"></a><span id="l5.1379" class="difflineplus">+  doCommandWithFolder: function FolderDisplayWidget_doCommandWithFolder(</span>
<a href="#l5.1380"></a><span id="l5.1380" class="difflineplus">+      aCommandName, aFolder) {</span>
<a href="#l5.1381"></a><span id="l5.1381" class="difflineplus">+    return this.view.dbView &amp;&amp;</span>
<a href="#l5.1382"></a><span id="l5.1382" class="difflineplus">+           this.view.dbView.doCommandWithFolder(aCommandName, aFolder);</span>
<a href="#l5.1383"></a><span id="l5.1383" class="difflineplus">+  },</span>
<a href="#l5.1384"></a><span id="l5.1384" class="difflineplus">+</span>
<a href="#l5.1385"></a><span id="l5.1385" class="difflineplus">+</span>
<a href="#l5.1386"></a><span id="l5.1386" class="difflineplus">+</span>
<a href="#l5.1387"></a><span id="l5.1387" class="difflineplus">+  /**</span>
<a href="#l5.1388"></a><span id="l5.1388" class="difflineplus">+   * Navigate using nsMsgNavigationType rules and ensuring the resulting row is</span>
<a href="#l5.1389"></a><span id="l5.1389" class="difflineplus">+   *  visible.  This is trickier than it used to be because we now support</span>
<a href="#l5.1390"></a><span id="l5.1390" class="difflineplus">+   *  treating collapsed threads as the set of all the messages in the collapsed</span>
<a href="#l5.1391"></a><span id="l5.1391" class="difflineplus">+   *  thread rather than just the root message in that thread.</span>
<a href="#l5.1392"></a><span id="l5.1392" class="difflineplus">+   *</span>
<a href="#l5.1393"></a><span id="l5.1393" class="difflineplus">+   * @param aNavType {nsMsgNavigationType} navigation command.</span>
<a href="#l5.1394"></a><span id="l5.1394" class="difflineplus">+   * @param aSelect {Boolean} should we select the message if we find one?</span>
<a href="#l5.1395"></a><span id="l5.1395" class="difflineplus">+   *     Defaults to true if omitted.</span>
<a href="#l5.1396"></a><span id="l5.1396" class="difflineplus">+   *</span>
<a href="#l5.1397"></a><span id="l5.1397" class="difflineplus">+   * @return true if the navigation constraint matched anything, false if not.</span>
<a href="#l5.1398"></a><span id="l5.1398" class="difflineplus">+   *     We will have navigated if true, we will have done nothing if false.</span>
<a href="#l5.1399"></a><span id="l5.1399" class="difflineplus">+   */</span>
<a href="#l5.1400"></a><span id="l5.1400" class="difflineplus">+  navigate: function FolderDisplayWidget_navigate(aNavType, aSelect) {</span>
<a href="#l5.1401"></a><span id="l5.1401" class="difflineplus">+    if (aSelect === undefined)</span>
<a href="#l5.1402"></a><span id="l5.1402" class="difflineplus">+      aSelect = true;</span>
<a href="#l5.1403"></a><span id="l5.1403" class="difflineplus">+    let resultKeyObj = {}, resultIndexObj = {}, threadIndexObj = {};</span>
<a href="#l5.1404"></a><span id="l5.1404" class="difflineplus">+</span>
<a href="#l5.1405"></a><span id="l5.1405" class="difflineplus">+    let summarizeSelection =</span>
<a href="#l5.1406"></a><span id="l5.1406" class="difflineplus">+      gPrefBranch.getBoolPref(&quot;mail.operate_on_msgs_in_collapsed_threads&quot;);</span>
<a href="#l5.1407"></a><span id="l5.1407" class="difflineplus">+</span>
<a href="#l5.1408"></a><span id="l5.1408" class="difflineplus">+    let treeSelection = this.treeSelection; // potentially magic getter</span>
<a href="#l5.1409"></a><span id="l5.1409" class="difflineplus">+    let currentIndex = treeSelection ? treeSelection.currentIndex : 0;</span>
<a href="#l5.1410"></a><span id="l5.1410" class="difflineplus">+</span>
<a href="#l5.1411"></a><span id="l5.1411" class="difflineplus">+    let viewIndex;</span>
<a href="#l5.1412"></a><span id="l5.1412" class="difflineplus">+    // if we're doing next unread, and a collapsed thread is selected, and</span>
<a href="#l5.1413"></a><span id="l5.1413" class="difflineplus">+    // the top level message is unread, just set the result manually to</span>
<a href="#l5.1414"></a><span id="l5.1414" class="difflineplus">+    // the top level message, without using viewNavigate.</span>
<a href="#l5.1415"></a><span id="l5.1415" class="difflineplus">+    if (summarizeSelection &amp;&amp;</span>
<a href="#l5.1416"></a><span id="l5.1416" class="difflineplus">+        aNavType == nsMsgNavigationType.nextUnreadMessage &amp;&amp;</span>
<a href="#l5.1417"></a><span id="l5.1417" class="difflineplus">+        currentIndex != -1 &amp;&amp;</span>
<a href="#l5.1418"></a><span id="l5.1418" class="difflineplus">+        this.view.isCollapsedThreadAtIndex(currentIndex) &amp;&amp;</span>
<a href="#l5.1419"></a><span id="l5.1419" class="difflineplus">+        !(this.view.dbView.getFlagsAt(currentIndex) &amp;</span>
<a href="#l5.1420"></a><span id="l5.1420" class="difflineplus">+          nsMsgMessageFlags.Read)) {</span>
<a href="#l5.1421"></a><span id="l5.1421" class="difflineplus">+      viewIndex = currentIndex;</span>
<a href="#l5.1422"></a><span id="l5.1422" class="difflineplus">+    }</span>
<a href="#l5.1423"></a><span id="l5.1423" class="difflineplus">+    else {</span>
<a href="#l5.1424"></a><span id="l5.1424" class="difflineplus">+      // always 'wrap' because the start index is relative to the selection.</span>
<a href="#l5.1425"></a><span id="l5.1425" class="difflineplus">+      // (keep in mind that many forms of navigation do not care about the</span>
<a href="#l5.1426"></a><span id="l5.1426" class="difflineplus">+      //  starting position or 'wrap' at all; for example, firstNew just finds</span>
<a href="#l5.1427"></a><span id="l5.1427" class="difflineplus">+      //  the first new message.)</span>
<a href="#l5.1428"></a><span id="l5.1428" class="difflineplus">+      // allegedly this does tree-expansion for us.</span>
<a href="#l5.1429"></a><span id="l5.1429" class="difflineplus">+      this.view.dbView.viewNavigate(aNavType, resultKeyObj, resultIndexObj,</span>
<a href="#l5.1430"></a><span id="l5.1430" class="difflineplus">+                                    threadIndexObj, true);</span>
<a href="#l5.1431"></a><span id="l5.1431" class="difflineplus">+      viewIndex = resultIndexObj.value;</span>
<a href="#l5.1432"></a><span id="l5.1432" class="difflineplus">+    }</span>
<a href="#l5.1433"></a><span id="l5.1433" class="difflineplus">+</span>
<a href="#l5.1434"></a><span id="l5.1434" class="difflineplus">+    if (viewIndex == nsMsgViewIndex_None)</span>
<a href="#l5.1435"></a><span id="l5.1435" class="difflineplus">+      return false;</span>
<a href="#l5.1436"></a><span id="l5.1436" class="difflineplus">+</span>
<a href="#l5.1437"></a><span id="l5.1437" class="difflineplus">+    // - Expand if required.</span>
<a href="#l5.1438"></a><span id="l5.1438" class="difflineplus">+    // (The nsMsgDBView isn't really aware of the varying semantics of</span>
<a href="#l5.1439"></a><span id="l5.1439" class="difflineplus">+    //  collapsed threads, so viewNavigate might tell us about the root message</span>
<a href="#l5.1440"></a><span id="l5.1440" class="difflineplus">+    //  and leave it collapsed, not realizing that it needs to be expanded.)</span>
<a href="#l5.1441"></a><span id="l5.1441" class="difflineplus">+    if (summarizeSelection &amp;&amp;</span>
<a href="#l5.1442"></a><span id="l5.1442" class="difflineplus">+        this.view.isCollapsedThreadAtIndex(viewIndex))</span>
<a href="#l5.1443"></a><span id="l5.1443" class="difflineplus">+      this.view.dbView.toggleOpenState(viewIndex);</span>
<a href="#l5.1444"></a><span id="l5.1444" class="difflineplus">+</span>
<a href="#l5.1445"></a><span id="l5.1445" class="difflineplus">+    if (aSelect)</span>
<a href="#l5.1446"></a><span id="l5.1446" class="difflineplus">+      this.selectViewIndex(viewIndex);</span>
<a href="#l5.1447"></a><span id="l5.1447" class="difflineplus">+    else</span>
<a href="#l5.1448"></a><span id="l5.1448" class="difflineplus">+      this.ensureRowIsVisible(viewIndex);</span>
<a href="#l5.1449"></a><span id="l5.1449" class="difflineplus">+    return true;</span>
<a href="#l5.1450"></a><span id="l5.1450" class="difflineplus">+  },</span>
<a href="#l5.1451"></a><span id="l5.1451" class="difflineplus">+</span>
<a href="#l5.1452"></a><span id="l5.1452" class="difflineplus">+  /**</span>
<a href="#l5.1453"></a><span id="l5.1453" class="difflineplus">+   * Push a call to |navigate| to be what we do once we successfully open the</span>
<a href="#l5.1454"></a><span id="l5.1454" class="difflineplus">+   *  next folder.  This is intended to be used by cross-folder navigation</span>
<a href="#l5.1455"></a><span id="l5.1455" class="difflineplus">+   *  code.  It should call this method before triggering the folder change.</span>
<a href="#l5.1456"></a><span id="l5.1456" class="difflineplus">+   */</span>
<a href="#l5.1457"></a><span id="l5.1457" class="difflineplus">+  pushNavigation: function FolderDisplayWidget_navigate(aNavType, aSelect) {</span>
<a href="#l5.1458"></a><span id="l5.1458" class="difflineplus">+    this._pendingNavigation = [aNavType, aSelect];</span>
<a href="#l5.1459"></a><span id="l5.1459" class="difflineplus">+  },</span>
<a href="#l5.1460"></a><span id="l5.1460" class="difflineplus">+</span>
<a href="#l5.1461"></a><span id="l5.1461" class="difflineplus">+  /**</span>
<a href="#l5.1462"></a><span id="l5.1462" class="difflineplus">+   * @return true if we are able to navigate using the given navigation type at</span>
<a href="#l5.1463"></a><span id="l5.1463" class="difflineplus">+   *  this time.</span>
<a href="#l5.1464"></a><span id="l5.1464" class="difflineplus">+   */</span>
<a href="#l5.1465"></a><span id="l5.1465" class="difflineplus">+  navigateStatus: function FolderDisplayWidget_navigateStatus(aNavType) {</span>
<a href="#l5.1466"></a><span id="l5.1466" class="difflineplus">+    if (!this.view.dbView)</span>
<a href="#l5.1467"></a><span id="l5.1467" class="difflineplus">+      return false;</span>
<a href="#l5.1468"></a><span id="l5.1468" class="difflineplus">+    return this.view.dbView.navigateStatus(aNavType);</span>
<a href="#l5.1469"></a><span id="l5.1469" class="difflineplus">+  },</span>
<a href="#l5.1470"></a><span id="l5.1470" class="difflineplus">+</span>
<a href="#l5.1471"></a><span id="l5.1471" class="difflineplus">+  /**</span>
<a href="#l5.1472"></a><span id="l5.1472" class="difflineplus">+   * @returns the message header for the first selected message, or null if</span>
<a href="#l5.1473"></a><span id="l5.1473" class="difflineplus">+   *  there is no selected message.</span>
<a href="#l5.1474"></a><span id="l5.1474" class="difflineplus">+   *</span>
<a href="#l5.1475"></a><span id="l5.1475" class="difflineplus">+   * If the user has right-clicked on a message, this method will return that</span>
<a href="#l5.1476"></a><span id="l5.1476" class="difflineplus">+   *  message and not the 'current index' (the dude with the dotted selection</span>
<a href="#l5.1477"></a><span id="l5.1477" class="difflineplus">+   *  rectangle around him.)  If you instead always want the currently</span>
<a href="#l5.1478"></a><span id="l5.1478" class="difflineplus">+   *  displayed message (which is not impacted by right-clicking), then you</span>
<a href="#l5.1479"></a><span id="l5.1479" class="difflineplus">+   *  would want to access the displayedMessage property on the</span>
<a href="#l5.1480"></a><span id="l5.1480" class="difflineplus">+   *  MessageDisplayWidget.  You can get to that via the messageDisplay</span>
<a href="#l5.1481"></a><span id="l5.1481" class="difflineplus">+   *  attribute on this object or (potentially) via the gMessageDisplay object.</span>
<a href="#l5.1482"></a><span id="l5.1482" class="difflineplus">+   */</span>
<a href="#l5.1483"></a><span id="l5.1483" class="difflineplus">+  get selectedMessage FolderDisplayWidget_get_selectedMessage() {</span>
<a href="#l5.1484"></a><span id="l5.1484" class="difflineplus">+    // there are inconsistencies in hdrForFirstSelectedMessage between</span>
<a href="#l5.1485"></a><span id="l5.1485" class="difflineplus">+    //  nsMsgDBView and nsMsgSearchDBView in whether they use currentIndex,</span>
<a href="#l5.1486"></a><span id="l5.1486" class="difflineplus">+    //  do it ourselves.  (nsMsgDBView does not use currentIndex, search does.)</span>
<a href="#l5.1487"></a><span id="l5.1487" class="difflineplus">+    let treeSelection = this.treeSelection;</span>
<a href="#l5.1488"></a><span id="l5.1488" class="difflineplus">+    if (!treeSelection || !treeSelection.count)</span>
<a href="#l5.1489"></a><span id="l5.1489" class="difflineplus">+      return null;</span>
<a href="#l5.1490"></a><span id="l5.1490" class="difflineplus">+    let minObj = {}, maxObj = {};</span>
<a href="#l5.1491"></a><span id="l5.1491" class="difflineplus">+    treeSelection.getRangeAt(0, minObj, maxObj);</span>
<a href="#l5.1492"></a><span id="l5.1492" class="difflineplus">+    return this.view.dbView.getMsgHdrAt(minObj.value);</span>
<a href="#l5.1493"></a><span id="l5.1493" class="difflineplus">+  },</span>
<a href="#l5.1494"></a><span id="l5.1494" class="difflineplus">+</span>
<a href="#l5.1495"></a><span id="l5.1495" class="difflineplus">+  /**</span>
<a href="#l5.1496"></a><span id="l5.1496" class="difflineplus">+   * @return true if there is a selected message and it's an RSS feed message.</span>
<a href="#l5.1497"></a><span id="l5.1497" class="difflineplus">+   */</span>
<a href="#l5.1498"></a><span id="l5.1498" class="difflineplus">+  get selectedMessageIsFeed FolderDisplayWidget_get_selectedMessageIsFeed() {</span>
<a href="#l5.1499"></a><span id="l5.1499" class="difflineplus">+    let message = this.selectedMessage;</span>
<a href="#l5.1500"></a><span id="l5.1500" class="difflineplus">+    return Boolean(message &amp;&amp; message.folder &amp;&amp;</span>
<a href="#l5.1501"></a><span id="l5.1501" class="difflineplus">+                   message.folder.server.type == 'rss');</span>
<a href="#l5.1502"></a><span id="l5.1502" class="difflineplus">+  },</span>
<a href="#l5.1503"></a><span id="l5.1503" class="difflineplus">+</span>
<a href="#l5.1504"></a><span id="l5.1504" class="difflineplus">+  /**</span>
<a href="#l5.1505"></a><span id="l5.1505" class="difflineplus">+   * @return true if there is a selected message and it's an IMAP message.</span>
<a href="#l5.1506"></a><span id="l5.1506" class="difflineplus">+   */</span>
<a href="#l5.1507"></a><span id="l5.1507" class="difflineplus">+  get selectedMessageIsImap FolderDisplayWidget_get_selectedMessageIsImap() {</span>
<a href="#l5.1508"></a><span id="l5.1508" class="difflineplus">+    let message = this.selectedMessage;</span>
<a href="#l5.1509"></a><span id="l5.1509" class="difflineplus">+    return Boolean(message &amp;&amp; message.folder &amp;&amp;</span>
<a href="#l5.1510"></a><span id="l5.1510" class="difflineplus">+                   message.folder.flags &amp; nsMsgFolderFlags.ImapBox);</span>
<a href="#l5.1511"></a><span id="l5.1511" class="difflineplus">+  },</span>
<a href="#l5.1512"></a><span id="l5.1512" class="difflineplus">+</span>
<a href="#l5.1513"></a><span id="l5.1513" class="difflineplus">+  /**</span>
<a href="#l5.1514"></a><span id="l5.1514" class="difflineplus">+   * @return true if there is a selected message and it's a news message.  It</span>
<a href="#l5.1515"></a><span id="l5.1515" class="difflineplus">+   *  would be great if messages knew this about themselves, but they don't.</span>
<a href="#l5.1516"></a><span id="l5.1516" class="difflineplus">+   */</span>
<a href="#l5.1517"></a><span id="l5.1517" class="difflineplus">+  get selectedMessageIsNews FolderDisplayWidget_get_selectedMessageIsNews() {</span>
<a href="#l5.1518"></a><span id="l5.1518" class="difflineplus">+    let message = this.selectedMessage;</span>
<a href="#l5.1519"></a><span id="l5.1519" class="difflineplus">+    return Boolean(message &amp;&amp; message.folder &amp;&amp;</span>
<a href="#l5.1520"></a><span id="l5.1520" class="difflineplus">+                   (message.folder.flags &amp; nsMsgFolderFlags.Newsgroup));</span>
<a href="#l5.1521"></a><span id="l5.1521" class="difflineplus">+  },</span>
<a href="#l5.1522"></a><span id="l5.1522" class="difflineplus">+</span>
<a href="#l5.1523"></a><span id="l5.1523" class="difflineplus">+  /**</span>
<a href="#l5.1524"></a><span id="l5.1524" class="difflineplus">+   * @return true if there is a selected message and it's an external message,</span>
<a href="#l5.1525"></a><span id="l5.1525" class="difflineplus">+   *  meaning it is loaded from an .eml file on disk or is an rfc822 attachment</span>
<a href="#l5.1526"></a><span id="l5.1526" class="difflineplus">+   *  on a message.</span>
<a href="#l5.1527"></a><span id="l5.1527" class="difflineplus">+   */</span>
<a href="#l5.1528"></a><span id="l5.1528" class="difflineplus">+  get selectedMessageIsExternal</span>
<a href="#l5.1529"></a><span id="l5.1529" class="difflineplus">+      FolderDisplayWidget_get_selectedMessageIsExternal() {</span>
<a href="#l5.1530"></a><span id="l5.1530" class="difflineplus">+    let message = this.selectedMessage;</span>
<a href="#l5.1531"></a><span id="l5.1531" class="difflineplus">+    // Dummy messages currently lack a folder.  This is not a great heuristic.</span>
<a href="#l5.1532"></a><span id="l5.1532" class="difflineplus">+    // I have annotated msgHdrViewOverlay.js which provides the dummy header to</span>
<a href="#l5.1533"></a><span id="l5.1533" class="difflineplus">+    //  express this implementation dependency.</span>
<a href="#l5.1534"></a><span id="l5.1534" class="difflineplus">+    // (Currently, since external mails can only be opened in standalone windows</span>
<a href="#l5.1535"></a><span id="l5.1535" class="difflineplus">+    //  which subclass us, we could always return false, and have the subclass</span>
<a href="#l5.1536"></a><span id="l5.1536" class="difflineplus">+    //  return true using its own heuristics.  But since we are moving to a tab</span>
<a href="#l5.1537"></a><span id="l5.1537" class="difflineplus">+    //  model more heavily, at some point the 3-pane will need this.)</span>
<a href="#l5.1538"></a><span id="l5.1538" class="difflineplus">+    return Boolean(message &amp;&amp; !message.folder);</span>
<a href="#l5.1539"></a><span id="l5.1539" class="difflineplus">+  },</span>
<a href="#l5.1540"></a><span id="l5.1540" class="difflineplus">+</span>
<a href="#l5.1541"></a><span id="l5.1541" class="difflineplus">+  /**</span>
<a href="#l5.1542"></a><span id="l5.1542" class="difflineplus">+   * @return the number of selected messages.  If the</span>
<a href="#l5.1543"></a><span id="l5.1543" class="difflineplus">+   *  &quot;mail.operate_on_msgs_in_collapsed_threads&quot; preference is enabled, then</span>
<a href="#l5.1544"></a><span id="l5.1544" class="difflineplus">+   *  any collapsed thread roots that are selected will also conceptually have</span>
<a href="#l5.1545"></a><span id="l5.1545" class="difflineplus">+   *  all of the messages in that thread selected.</span>
<a href="#l5.1546"></a><span id="l5.1546" class="difflineplus">+   */</span>
<a href="#l5.1547"></a><span id="l5.1547" class="difflineplus">+  get selectedCount FolderDisplayWidget_get_selectedCount() {</span>
<a href="#l5.1548"></a><span id="l5.1548" class="difflineplus">+    if (!this.view.dbView)</span>
<a href="#l5.1549"></a><span id="l5.1549" class="difflineplus">+      return 0;</span>
<a href="#l5.1550"></a><span id="l5.1550" class="difflineplus">+    return this.view.dbView.numSelected;</span>
<a href="#l5.1551"></a><span id="l5.1551" class="difflineplus">+  },</span>
<a href="#l5.1552"></a><span id="l5.1552" class="difflineplus">+</span>
<a href="#l5.1553"></a><span id="l5.1553" class="difflineplus">+  /**</span>
<a href="#l5.1554"></a><span id="l5.1554" class="difflineplus">+   * Provides a list of the view indices that are selected which is *not* the</span>
<a href="#l5.1555"></a><span id="l5.1555" class="difflineplus">+   *  same as the rows of the selected messages.  When the</span>
<a href="#l5.1556"></a><span id="l5.1556" class="difflineplus">+   *  &quot;mail.operate_on_msgs_in_collapsed_threads&quot; preference is enabled,</span>
<a href="#l5.1557"></a><span id="l5.1557" class="difflineplus">+   *  messages may be selected but not visible (because the thread root is</span>
<a href="#l5.1558"></a><span id="l5.1558" class="difflineplus">+   *  selected.)</span>
<a href="#l5.1559"></a><span id="l5.1559" class="difflineplus">+   * You probably want to use the |selectedMessages| attribute instead of this</span>
<a href="#l5.1560"></a><span id="l5.1560" class="difflineplus">+   *  one.  (Or selectedMessageUris in some rare cases.)</span>
<a href="#l5.1561"></a><span id="l5.1561" class="difflineplus">+   *</span>
<a href="#l5.1562"></a><span id="l5.1562" class="difflineplus">+   * If the user has right-clicked on a message, this will return that message</span>
<a href="#l5.1563"></a><span id="l5.1563" class="difflineplus">+   *  and not the selection prior to the right-click.</span>
<a href="#l5.1564"></a><span id="l5.1564" class="difflineplus">+   *</span>
<a href="#l5.1565"></a><span id="l5.1565" class="difflineplus">+   * @return a list of the view indices that are currently selected</span>
<a href="#l5.1566"></a><span id="l5.1566" class="difflineplus">+   */</span>
<a href="#l5.1567"></a><span id="l5.1567" class="difflineplus">+  get selectedIndices FolderDisplayWidget_get_selectedIndices() {</span>
<a href="#l5.1568"></a><span id="l5.1568" class="difflineplus">+    if (!this.view.dbView)</span>
<a href="#l5.1569"></a><span id="l5.1569" class="difflineplus">+      return [];</span>
<a href="#l5.1570"></a><span id="l5.1570" class="difflineplus">+</span>
<a href="#l5.1571"></a><span id="l5.1571" class="difflineplus">+    return this.view.dbView.getIndicesForSelection({});</span>
<a href="#l5.1572"></a><span id="l5.1572" class="difflineplus">+  },</span>
<a href="#l5.1573"></a><span id="l5.1573" class="difflineplus">+</span>
<a href="#l5.1574"></a><span id="l5.1574" class="difflineplus">+  /**</span>
<a href="#l5.1575"></a><span id="l5.1575" class="difflineplus">+   * Provides a list of the message headers for the currently selected messages.</span>
<a href="#l5.1576"></a><span id="l5.1576" class="difflineplus">+   *  If the &quot;mail.operate_on_msgs_in_collapsed_threads&quot; preference is enabled,</span>
<a href="#l5.1577"></a><span id="l5.1577" class="difflineplus">+   *  then any collapsed thread roots that are selected will also (conceptually)</span>
<a href="#l5.1578"></a><span id="l5.1578" class="difflineplus">+   *  have all of the messages in that thread selected and they will be included</span>
<a href="#l5.1579"></a><span id="l5.1579" class="difflineplus">+   *  in the returned list.</span>
<a href="#l5.1580"></a><span id="l5.1580" class="difflineplus">+   *</span>
<a href="#l5.1581"></a><span id="l5.1581" class="difflineplus">+   * If the user has right-clicked on a message, this will return that message</span>
<a href="#l5.1582"></a><span id="l5.1582" class="difflineplus">+   *  (and any collapsed children if so enabled) and not the selection prior to</span>
<a href="#l5.1583"></a><span id="l5.1583" class="difflineplus">+   *  the right-click.</span>
<a href="#l5.1584"></a><span id="l5.1584" class="difflineplus">+   *</span>
<a href="#l5.1585"></a><span id="l5.1585" class="difflineplus">+   * @return a list of the message headers for the currently selected messages.</span>
<a href="#l5.1586"></a><span id="l5.1586" class="difflineplus">+   *     If there are no selected messages, the result is an empty list.</span>
<a href="#l5.1587"></a><span id="l5.1587" class="difflineplus">+   */</span>
<a href="#l5.1588"></a><span id="l5.1588" class="difflineplus">+  get selectedMessages FolderDisplayWidget_get_selectedMessages() {</span>
<a href="#l5.1589"></a><span id="l5.1589" class="difflineplus">+    if (!this.view.dbView)</span>
<a href="#l5.1590"></a><span id="l5.1590" class="difflineplus">+      return [];</span>
<a href="#l5.1591"></a><span id="l5.1591" class="difflineplus">+    // getMsgHdrsForSelection returns an nsIMutableArray.  We want our callers</span>
<a href="#l5.1592"></a><span id="l5.1592" class="difflineplus">+    //  to have a user-friendly JS array and not have to worry about</span>
<a href="#l5.1593"></a><span id="l5.1593" class="difflineplus">+    //  QueryInterfacing the values (or needing to know to use fixIterator).</span>
<a href="#l5.1594"></a><span id="l5.1594" class="difflineplus">+    return [msgHdr for each</span>
<a href="#l5.1595"></a><span id="l5.1595" class="difflineplus">+              (msgHdr in fixIterator(</span>
<a href="#l5.1596"></a><span id="l5.1596" class="difflineplus">+                          this.view.dbView.getMsgHdrsForSelection().enumerate(),</span>
<a href="#l5.1597"></a><span id="l5.1597" class="difflineplus">+                          Components.interfaces.nsIMsgDBHdr))];</span>
<a href="#l5.1598"></a><span id="l5.1598" class="difflineplus">+  },</span>
<a href="#l5.1599"></a><span id="l5.1599" class="difflineplus">+</span>
<a href="#l5.1600"></a><span id="l5.1600" class="difflineplus">+  /**</span>
<a href="#l5.1601"></a><span id="l5.1601" class="difflineplus">+   * @return a list of the URIs for the currently selected messages or null</span>
<a href="#l5.1602"></a><span id="l5.1602" class="difflineplus">+   *     (instead of a list) if there are no selected messages.  Do not</span>
<a href="#l5.1603"></a><span id="l5.1603" class="difflineplus">+   *     pass around URIs unless you have a good reason.  Legacy code is an</span>
<a href="#l5.1604"></a><span id="l5.1604" class="difflineplus">+   *     ok reason.</span>
<a href="#l5.1605"></a><span id="l5.1605" class="difflineplus">+   *</span>
<a href="#l5.1606"></a><span id="l5.1606" class="difflineplus">+   * If the user has right-clicked on a message, this will return that message's</span>
<a href="#l5.1607"></a><span id="l5.1607" class="difflineplus">+   *  URI and not the selection prior to the right-click.</span>
<a href="#l5.1608"></a><span id="l5.1608" class="difflineplus">+   */</span>
<a href="#l5.1609"></a><span id="l5.1609" class="difflineplus">+  get selectedMessageUris FolderDisplayWidget_get_selectedMessageUris() {</span>
<a href="#l5.1610"></a><span id="l5.1610" class="difflineplus">+    if (!this.view.dbView)</span>
<a href="#l5.1611"></a><span id="l5.1611" class="difflineplus">+      return null;</span>
<a href="#l5.1612"></a><span id="l5.1612" class="difflineplus">+</span>
<a href="#l5.1613"></a><span id="l5.1613" class="difflineplus">+    let messageArray = this.view.dbView.getURIsForSelection({});</span>
<a href="#l5.1614"></a><span id="l5.1614" class="difflineplus">+    return messageArray.length ? messageArray : null;</span>
<a href="#l5.1615"></a><span id="l5.1615" class="difflineplus">+  },</span>
<a href="#l5.1616"></a><span id="l5.1616" class="difflineplus">+</span>
<a href="#l5.1617"></a><span id="l5.1617" class="difflineplus">+  /**</span>
<a href="#l5.1618"></a><span id="l5.1618" class="difflineplus">+   * Clear the tree selection, making sure the message pane is cleared and</span>
<a href="#l5.1619"></a><span id="l5.1619" class="difflineplus">+   *  the context display (toolbars, etc.) are updated.</span>
<a href="#l5.1620"></a><span id="l5.1620" class="difflineplus">+   */</span>
<a href="#l5.1621"></a><span id="l5.1621" class="difflineplus">+  clearSelection: function FolderDisplayWidget_clearSelection() {</span>
<a href="#l5.1622"></a><span id="l5.1622" class="difflineplus">+    let treeSelection = this.treeSelection; // potentially magic getter</span>
<a href="#l5.1623"></a><span id="l5.1623" class="difflineplus">+    if (!treeSelection)</span>
<a href="#l5.1624"></a><span id="l5.1624" class="difflineplus">+      return;</span>
<a href="#l5.1625"></a><span id="l5.1625" class="difflineplus">+    treeSelection.clearSelection();</span>
<a href="#l5.1626"></a><span id="l5.1626" class="difflineplus">+    this.messageDisplay.clearDisplay();</span>
<a href="#l5.1627"></a><span id="l5.1627" class="difflineplus">+    this._updateContextDisplay();</span>
<a href="#l5.1628"></a><span id="l5.1628" class="difflineplus">+  },</span>
<a href="#l5.1629"></a><span id="l5.1629" class="difflineplus">+</span>
<a href="#l5.1630"></a><span id="l5.1630" class="difflineplus">+  /**</span>
<a href="#l5.1631"></a><span id="l5.1631" class="difflineplus">+   * Select a message for display by header.  If the view is active, attempt</span>
<a href="#l5.1632"></a><span id="l5.1632" class="difflineplus">+   *  to select the message right now.  If the view is not active or we were</span>
<a href="#l5.1633"></a><span id="l5.1633" class="difflineplus">+   *  unable to find it, update our saved selection to want to display the</span>
<a href="#l5.1634"></a><span id="l5.1634" class="difflineplus">+   *  message.  Threads are expanded to find the header.</span>
<a href="#l5.1635"></a><span id="l5.1635" class="difflineplus">+   *</span>
<a href="#l5.1636"></a><span id="l5.1636" class="difflineplus">+   * @param aMsgHdr The message header to select for display.</span>
<a href="#l5.1637"></a><span id="l5.1637" class="difflineplus">+   */</span>
<a href="#l5.1638"></a><span id="l5.1638" class="difflineplus">+  selectMessage: function FolderDisplayWidget_selectMessage(aMsgHdr,</span>
<a href="#l5.1639"></a><span id="l5.1639" class="difflineplus">+      aForceNotification) {</span>
<a href="#l5.1640"></a><span id="l5.1640" class="difflineplus">+    if (this.active) {</span>
<a href="#l5.1641"></a><span id="l5.1641" class="difflineplus">+      let viewIndex = this.view.dbView.findIndexOfMsgHdr(aMsgHdr, true);</span>
<a href="#l5.1642"></a><span id="l5.1642" class="difflineplus">+      if (viewIndex != nsMsgViewIndex_None) {</span>
<a href="#l5.1643"></a><span id="l5.1643" class="difflineplus">+        this.selectViewIndex(viewIndex);</span>
<a href="#l5.1644"></a><span id="l5.1644" class="difflineplus">+        return;</span>
<a href="#l5.1645"></a><span id="l5.1645" class="difflineplus">+      }</span>
<a href="#l5.1646"></a><span id="l5.1646" class="difflineplus">+    }</span>
<a href="#l5.1647"></a><span id="l5.1647" class="difflineplus">+    this._savedSelection = [{messageId: aMsgHdr.messageId}];</span>
<a href="#l5.1648"></a><span id="l5.1648" class="difflineplus">+    // queue the selection to be restored once we become active if we are not</span>
<a href="#l5.1649"></a><span id="l5.1649" class="difflineplus">+    //  active.</span>
<a href="#l5.1650"></a><span id="l5.1650" class="difflineplus">+    if (!this.active)</span>
<a href="#l5.1651"></a><span id="l5.1651" class="difflineplus">+      this._notifyWhenActive(this._restoreSelection);</span>
<a href="#l5.1652"></a><span id="l5.1652" class="difflineplus">+  },</span>
<a href="#l5.1653"></a><span id="l5.1653" class="difflineplus">+</span>
<a href="#l5.1654"></a><span id="l5.1654" class="difflineplus">+  /**</span>
<a href="#l5.1655"></a><span id="l5.1655" class="difflineplus">+   * Select all of the provided nsIMsgDBHdrs in the aMessages array, expanding</span>
<a href="#l5.1656"></a><span id="l5.1656" class="difflineplus">+   *  threads as required.  If the view is not active, or we were not able to</span>
<a href="#l5.1657"></a><span id="l5.1657" class="difflineplus">+   *  find all of the messages, update our saved selection to want to display</span>
<a href="#l5.1658"></a><span id="l5.1658" class="difflineplus">+   *  the messages.  The messages will then be selected when we are made active</span>
<a href="#l5.1659"></a><span id="l5.1659" class="difflineplus">+   *  or all messages in the folder complete loading.  This is to accomodate the</span>
<a href="#l5.1660"></a><span id="l5.1660" class="difflineplus">+   *  use-case where we are backed by an in-progress search and no</span>
<a href="#l5.1661"></a><span id="l5.1661" class="difflineplus">+   *</span>
<a href="#l5.1662"></a><span id="l5.1662" class="difflineplus">+   * @param aMessages An array of nsIMsgDBHdr instances.</span>
<a href="#l5.1663"></a><span id="l5.1663" class="difflineplus">+   * @param aDoNotNeedToFindAll If true (can be omitted and left undefined), we</span>
<a href="#l5.1664"></a><span id="l5.1664" class="difflineplus">+   *     do not attempt to save the selection for future use.  This is intended</span>
<a href="#l5.1665"></a><span id="l5.1665" class="difflineplus">+   *     for use by the _restoreSelection call which is the end-of-the-line for</span>
<a href="#l5.1666"></a><span id="l5.1666" class="difflineplus">+   *     restoring the selection.  (Once it gets called all of our messages</span>
<a href="#l5.1667"></a><span id="l5.1667" class="difflineplus">+   *     should have already been loaded.)</span>
<a href="#l5.1668"></a><span id="l5.1668" class="difflineplus">+   */</span>
<a href="#l5.1669"></a><span id="l5.1669" class="difflineplus">+  selectMessages: function FolderDisplayWidget_selectMessages(</span>
<a href="#l5.1670"></a><span id="l5.1670" class="difflineplus">+    aMessages, aDoNotNeedToFindAll) {</span>
<a href="#l5.1671"></a><span id="l5.1671" class="difflineplus">+    if (this.active &amp;&amp; this.treeSelection) {</span>
<a href="#l5.1672"></a><span id="l5.1672" class="difflineplus">+      let foundAll = true;</span>
<a href="#l5.1673"></a><span id="l5.1673" class="difflineplus">+      let treeSelection = this.treeSelection;</span>
<a href="#l5.1674"></a><span id="l5.1674" class="difflineplus">+      let dbView = this.view.dbView;</span>
<a href="#l5.1675"></a><span id="l5.1675" class="difflineplus">+      let minRow = null, maxRow = null;</span>
<a href="#l5.1676"></a><span id="l5.1676" class="difflineplus">+</span>
<a href="#l5.1677"></a><span id="l5.1677" class="difflineplus">+      treeSelection.selectEventsSuppressed = true;</span>
<a href="#l5.1678"></a><span id="l5.1678" class="difflineplus">+      treeSelection.clearSelection();</span>
<a href="#l5.1679"></a><span id="l5.1679" class="difflineplus">+</span>
<a href="#l5.1680"></a><span id="l5.1680" class="difflineplus">+      for each (let [, msgHdr] in Iterator(aMessages)) {</span>
<a href="#l5.1681"></a><span id="l5.1681" class="difflineplus">+        let viewIndex = dbView.findIndexOfMsgHdr(msgHdr, true);</span>
<a href="#l5.1682"></a><span id="l5.1682" class="difflineplus">+        if (viewIndex != nsMsgViewIndex_None) {</span>
<a href="#l5.1683"></a><span id="l5.1683" class="difflineplus">+          if (minRow == null || viewIndex &lt; minRow)</span>
<a href="#l5.1684"></a><span id="l5.1684" class="difflineplus">+            minRow = viewIndex;</span>
<a href="#l5.1685"></a><span id="l5.1685" class="difflineplus">+          if (maxRow == null || viewIndex &gt; maxRow )</span>
<a href="#l5.1686"></a><span id="l5.1686" class="difflineplus">+            maxRow = viewIndex;</span>
<a href="#l5.1687"></a><span id="l5.1687" class="difflineplus">+          // nsTreeSelection is actually very clever about doing this</span>
<a href="#l5.1688"></a><span id="l5.1688" class="difflineplus">+          //  efficiently.</span>
<a href="#l5.1689"></a><span id="l5.1689" class="difflineplus">+          treeSelection.rangedSelect(viewIndex, viewIndex, true);</span>
<a href="#l5.1690"></a><span id="l5.1690" class="difflineplus">+        }</span>
<a href="#l5.1691"></a><span id="l5.1691" class="difflineplus">+        else {</span>
<a href="#l5.1692"></a><span id="l5.1692" class="difflineplus">+          foundAll = false;</span>
<a href="#l5.1693"></a><span id="l5.1693" class="difflineplus">+        }</span>
<a href="#l5.1694"></a><span id="l5.1694" class="difflineplus">+</span>
<a href="#l5.1695"></a><span id="l5.1695" class="difflineplus">+        // make sure the selection is as visible as possible</span>
<a href="#l5.1696"></a><span id="l5.1696" class="difflineplus">+        if (minRow != null)</span>
<a href="#l5.1697"></a><span id="l5.1697" class="difflineplus">+          this.ensureRowRangeIsVisible(minRow, maxRow);</span>
<a href="#l5.1698"></a><span id="l5.1698" class="difflineplus">+      }</span>
<a href="#l5.1699"></a><span id="l5.1699" class="difflineplus">+</span>
<a href="#l5.1700"></a><span id="l5.1700" class="difflineplus">+      treeSelection.selectEventsSuppressed = false;</span>
<a href="#l5.1701"></a><span id="l5.1701" class="difflineplus">+</span>
<a href="#l5.1702"></a><span id="l5.1702" class="difflineplus">+      if (!aDoNotNeedToFindAll || foundAll)</span>
<a href="#l5.1703"></a><span id="l5.1703" class="difflineplus">+        return;</span>
<a href="#l5.1704"></a><span id="l5.1704" class="difflineplus">+    }</span>
<a href="#l5.1705"></a><span id="l5.1705" class="difflineplus">+    this._savedSelection = [{messageId: msgHdr.messageId} for each</span>
<a href="#l5.1706"></a><span id="l5.1706" class="difflineplus">+                            ([, msgHdr] in Iterator(aMessages))];</span>
<a href="#l5.1707"></a><span id="l5.1707" class="difflineplus">+    if (!this.active)</span>
<a href="#l5.1708"></a><span id="l5.1708" class="difflineplus">+      this._notifyWhenActive(this._restoreSelection);</span>
<a href="#l5.1709"></a><span id="l5.1709" class="difflineplus">+  },</span>
<a href="#l5.1710"></a><span id="l5.1710" class="difflineplus">+</span>
<a href="#l5.1711"></a><span id="l5.1711" class="difflineplus">+  /**</span>
<a href="#l5.1712"></a><span id="l5.1712" class="difflineplus">+   * Select the message at view index.</span>
<a href="#l5.1713"></a><span id="l5.1713" class="difflineplus">+   *</span>
<a href="#l5.1714"></a><span id="l5.1714" class="difflineplus">+   * @param aViewIndex The view index to select.  This will be bounds-checked</span>
<a href="#l5.1715"></a><span id="l5.1715" class="difflineplus">+   *     and if it is outside the bounds, we will clear the selection and</span>
<a href="#l5.1716"></a><span id="l5.1716" class="difflineplus">+   *     bail.</span>
<a href="#l5.1717"></a><span id="l5.1717" class="difflineplus">+   */</span>
<a href="#l5.1718"></a><span id="l5.1718" class="difflineplus">+  selectViewIndex: function FolderDisplayWidget_selectViewIndex(aViewIndex) {</span>
<a href="#l5.1719"></a><span id="l5.1719" class="difflineplus">+    let treeSelection = this.treeSelection;</span>
<a href="#l5.1720"></a><span id="l5.1720" class="difflineplus">+    // if we have no selection, we can't select something</span>
<a href="#l5.1721"></a><span id="l5.1721" class="difflineplus">+    if (!treeSelection)</span>
<a href="#l5.1722"></a><span id="l5.1722" class="difflineplus">+      return;</span>
<a href="#l5.1723"></a><span id="l5.1723" class="difflineplus">+    let rowCount = this.view.dbView.rowCount;</span>
<a href="#l5.1724"></a><span id="l5.1724" class="difflineplus">+    if ((aViewIndex == nsMsgViewIndex_None) ||</span>
<a href="#l5.1725"></a><span id="l5.1725" class="difflineplus">+        (aViewIndex &lt; 0) || (aViewIndex &gt;= rowCount)) {</span>
<a href="#l5.1726"></a><span id="l5.1726" class="difflineplus">+      this.clearSelection();</span>
<a href="#l5.1727"></a><span id="l5.1727" class="difflineplus">+      return;</span>
<a href="#l5.1728"></a><span id="l5.1728" class="difflineplus">+    }</span>
<a href="#l5.1729"></a><span id="l5.1729" class="difflineplus">+</span>
<a href="#l5.1730"></a><span id="l5.1730" class="difflineplus">+    // Check whether the index is already selected/current.  This can be the</span>
<a href="#l5.1731"></a><span id="l5.1731" class="difflineplus">+    //  case when we are here as the result of a deletion.  Assuming</span>
<a href="#l5.1732"></a><span id="l5.1732" class="difflineplus">+    //  nsMsgDBView::NoteChange ran and was not suppressing change</span>
<a href="#l5.1733"></a><span id="l5.1733" class="difflineplus">+    //  notifications, then it's very possible the selection is already where</span>
<a href="#l5.1734"></a><span id="l5.1734" class="difflineplus">+    //  we want it to go.  However, in that case, nsMsgDBView::SelectionChanged</span>
<a href="#l5.1735"></a><span id="l5.1735" class="difflineplus">+    //  bailed without doing anything because m_deletingRows...</span>
<a href="#l5.1736"></a><span id="l5.1736" class="difflineplus">+    // So we want to generate a change notification if that is the case. (And</span>
<a href="#l5.1737"></a><span id="l5.1737" class="difflineplus">+    //  we still want to call ensureRowIsVisible, as there may be padding</span>
<a href="#l5.1738"></a><span id="l5.1738" class="difflineplus">+    //  required.)</span>
<a href="#l5.1739"></a><span id="l5.1739" class="difflineplus">+    if ((treeSelection.count == 1) &amp;&amp;</span>
<a href="#l5.1740"></a><span id="l5.1740" class="difflineplus">+        ((treeSelection.currentIndex == aViewIndex) ||</span>
<a href="#l5.1741"></a><span id="l5.1741" class="difflineplus">+         treeSelection.isSelected(aViewIndex))) {</span>
<a href="#l5.1742"></a><span id="l5.1742" class="difflineplus">+      // Make sure the index we just selected is also the current index.</span>
<a href="#l5.1743"></a><span id="l5.1743" class="difflineplus">+      //  This can happen when the tree selection adjusts itself as a result of</span>
<a href="#l5.1744"></a><span id="l5.1744" class="difflineplus">+      //  changes to the tree as a result of deletion.  This will not trigger</span>
<a href="#l5.1745"></a><span id="l5.1745" class="difflineplus">+      //  a notification.</span>
<a href="#l5.1746"></a><span id="l5.1746" class="difflineplus">+      treeSelection.select(aViewIndex);</span>
<a href="#l5.1747"></a><span id="l5.1747" class="difflineplus">+      this.view.dbView.selectionChanged();</span>
<a href="#l5.1748"></a><span id="l5.1748" class="difflineplus">+    }</span>
<a href="#l5.1749"></a><span id="l5.1749" class="difflineplus">+    // Previous code was concerned about avoiding updating commands on the</span>
<a href="#l5.1750"></a><span id="l5.1750" class="difflineplus">+    //  assumption that only the selection count mattered.  We no longer</span>
<a href="#l5.1751"></a><span id="l5.1751" class="difflineplus">+    //  make this assumption.</span>
<a href="#l5.1752"></a><span id="l5.1752" class="difflineplus">+    // Things that may surprise you about the call to treeSelection.select:</span>
<a href="#l5.1753"></a><span id="l5.1753" class="difflineplus">+    // 1) This ends up calling the onselect method defined on the XUL 'tree'</span>
<a href="#l5.1754"></a><span id="l5.1754" class="difflineplus">+    //    tag.  For the 3pane this is the ThreadPaneSelectionChanged method in</span>
<a href="#l5.1755"></a><span id="l5.1755" class="difflineplus">+    //    threadPane.js.  That code checks a global to see if it is dealing</span>
<a href="#l5.1756"></a><span id="l5.1756" class="difflineplus">+    //    with a right-click, and ignores it if so.</span>
<a href="#l5.1757"></a><span id="l5.1757" class="difflineplus">+    else {</span>
<a href="#l5.1758"></a><span id="l5.1758" class="difflineplus">+      treeSelection.select(aViewIndex);</span>
<a href="#l5.1759"></a><span id="l5.1759" class="difflineplus">+    }</span>
<a href="#l5.1760"></a><span id="l5.1760" class="difflineplus">+</span>
<a href="#l5.1761"></a><span id="l5.1761" class="difflineplus">+    this.ensureRowIsVisible(aViewIndex);</span>
<a href="#l5.1762"></a><span id="l5.1762" class="difflineplus">+  },</span>
<a href="#l5.1763"></a><span id="l5.1763" class="difflineplus">+</span>
<a href="#l5.1764"></a><span id="l5.1764" class="difflineplus">+  /**</span>
<a href="#l5.1765"></a><span id="l5.1765" class="difflineplus">+   * For every selected message in the display that is part of a (displayed)</span>
<a href="#l5.1766"></a><span id="l5.1766" class="difflineplus">+   *  thread and is not the root message, de-select it and ensure that the</span>
<a href="#l5.1767"></a><span id="l5.1767" class="difflineplus">+   *  root message of the thread is selected.</span>
<a href="#l5.1768"></a><span id="l5.1768" class="difflineplus">+   * This is primarily intended to be used when collapsing visible threads.</span>
<a href="#l5.1769"></a><span id="l5.1769" class="difflineplus">+   *</span>
<a href="#l5.1770"></a><span id="l5.1770" class="difflineplus">+   * We do nothing if we are not in a threaded display mode.</span>
<a href="#l5.1771"></a><span id="l5.1771" class="difflineplus">+   */</span>
<a href="#l5.1772"></a><span id="l5.1772" class="difflineplus">+  selectSelectedThreadRoots:</span>
<a href="#l5.1773"></a><span id="l5.1773" class="difflineplus">+      function FolderDisplayWidget_selectSelectedThreadRoots() {</span>
<a href="#l5.1774"></a><span id="l5.1774" class="difflineplus">+    if (!this.view.showThreaded)</span>
<a href="#l5.1775"></a><span id="l5.1775" class="difflineplus">+      return;</span>
<a href="#l5.1776"></a><span id="l5.1776" class="difflineplus">+</span>
<a href="#l5.1777"></a><span id="l5.1777" class="difflineplus">+    // There are basically two implementation strategies available to us:</span>
<a href="#l5.1778"></a><span id="l5.1778" class="difflineplus">+    // 1) For each selected view index with a level &gt; 0, keep walking 'up'</span>
<a href="#l5.1779"></a><span id="l5.1779" class="difflineplus">+    //    (numerically smaller) until we find a message with level 0.</span>
<a href="#l5.1780"></a><span id="l5.1780" class="difflineplus">+    //    The inefficiency here is the potentially large number of JS calls</span>
<a href="#l5.1781"></a><span id="l5.1781" class="difflineplus">+    //    into XPCOM space that will be required.</span>
<a href="#l5.1782"></a><span id="l5.1782" class="difflineplus">+    // 2) Ask for the thread that each view index belongs to, use that to</span>
<a href="#l5.1783"></a><span id="l5.1783" class="difflineplus">+    //    efficiently retrieve the thread root, then find the root using</span>
<a href="#l5.1784"></a><span id="l5.1784" class="difflineplus">+    //    the message header.  The inefficiency here is that the view</span>
<a href="#l5.1785"></a><span id="l5.1785" class="difflineplus">+    //    currently does a linear scan, albeit a relatively efficient one.</span>
<a href="#l5.1786"></a><span id="l5.1786" class="difflineplus">+    // And the winner is... option 2, because the code is simpler because we</span>
<a href="#l5.1787"></a><span id="l5.1787" class="difflineplus">+    //  can reuse selectMessages to do most of the work.</span>
<a href="#l5.1788"></a><span id="l5.1788" class="difflineplus">+    let selectedIndices = this.selectedIndices;</span>
<a href="#l5.1789"></a><span id="l5.1789" class="difflineplus">+    let newSelectedMessages = [];</span>
<a href="#l5.1790"></a><span id="l5.1790" class="difflineplus">+    let dbView = this.view.dbView;</span>
<a href="#l5.1791"></a><span id="l5.1791" class="difflineplus">+    for each (let [, index] in Iterator(selectedIndices)) {</span>
<a href="#l5.1792"></a><span id="l5.1792" class="difflineplus">+      let thread = dbView.getThreadContainingIndex(index);</span>
<a href="#l5.1793"></a><span id="l5.1793" class="difflineplus">+      // We use getChildHdrAt instead of getRootHdr because getRootHdr has</span>
<a href="#l5.1794"></a><span id="l5.1794" class="difflineplus">+      //  a useless out-param and just calls getChildHdrAt anyways.</span>
<a href="#l5.1795"></a><span id="l5.1795" class="difflineplus">+      newSelectedMessages.push(thread.getChildHdrAt(0));</span>
<a href="#l5.1796"></a><span id="l5.1796" class="difflineplus">+    }</span>
<a href="#l5.1797"></a><span id="l5.1797" class="difflineplus">+    this.selectMessages(newSelectedMessages);</span>
<a href="#l5.1798"></a><span id="l5.1798" class="difflineplus">+  },</span>
<a href="#l5.1799"></a><span id="l5.1799" class="difflineplus">+</span>
<a href="#l5.1800"></a><span id="l5.1800" class="difflineplus">+  /**</span>
<a href="#l5.1801"></a><span id="l5.1801" class="difflineplus">+   * Number of padding messages before the 'focused' message when it is at the</span>
<a href="#l5.1802"></a><span id="l5.1802" class="difflineplus">+   *  top of the thread pane.</span>
<a href="#l5.1803"></a><span id="l5.1803" class="difflineplus">+   */</span>
<a href="#l5.1804"></a><span id="l5.1804" class="difflineplus">+  TOP_VIEW_PADDING: 1,</span>
<a href="#l5.1805"></a><span id="l5.1805" class="difflineplus">+  /**</span>
<a href="#l5.1806"></a><span id="l5.1806" class="difflineplus">+   * Number of padding messages after the 'focused' message when it is at the</span>
<a href="#l5.1807"></a><span id="l5.1807" class="difflineplus">+   *  bottom of the thread pane and lip padding does not apply.</span>
<a href="#l5.1808"></a><span id="l5.1808" class="difflineplus">+   */</span>
<a href="#l5.1809"></a><span id="l5.1809" class="difflineplus">+  BOTTOM_VIEW_PADDING: 1,</span>
<a href="#l5.1810"></a><span id="l5.1810" class="difflineplus">+</span>
<a href="#l5.1811"></a><span id="l5.1811" class="difflineplus">+  /**</span>
<a href="#l5.1812"></a><span id="l5.1812" class="difflineplus">+   * Ensure the given view index is visible, preferably with some padding.</span>
<a href="#l5.1813"></a><span id="l5.1813" class="difflineplus">+   * By padding, we mean that the index will not be the first or last message</span>
<a href="#l5.1814"></a><span id="l5.1814" class="difflineplus">+   *  displayed, but rather have messages on either side.</span>
<a href="#l5.1815"></a><span id="l5.1815" class="difflineplus">+   * If we get near the end of the list of messages, we 'snap' to the last page</span>
<a href="#l5.1816"></a><span id="l5.1816" class="difflineplus">+   *  of messages.  The intent is that we later implement a</span>
<a href="#l5.1817"></a><span id="l5.1817" class="difflineplus">+   * We have the concept of a 'lip' when we are at the end of the message</span>
<a href="#l5.1818"></a><span id="l5.1818" class="difflineplus">+   *  display.  If we are near the end of the display, we want to show an</span>
<a href="#l5.1819"></a><span id="l5.1819" class="difflineplus">+   *  empty row (at the bottom) so the user knows they are at the end.  Also,</span>
<a href="#l5.1820"></a><span id="l5.1820" class="difflineplus">+   *  if a message shows up that is new and things are sorted ascending, this</span>
<a href="#l5.1821"></a><span id="l5.1821" class="difflineplus">+   *  turns out to be useful.</span>
<a href="#l5.1822"></a><span id="l5.1822" class="difflineplus">+   */</span>
<a href="#l5.1823"></a><span id="l5.1823" class="difflineplus">+  ensureRowIsVisible: function FolderDisplayWidget_ensureRowIsVisible(</span>
<a href="#l5.1824"></a><span id="l5.1824" class="difflineplus">+      aViewIndex, aBounced) {</span>
<a href="#l5.1825"></a><span id="l5.1825" class="difflineplus">+    // Dealing with the tree view layout is a nightmare, let's just always make</span>
<a href="#l5.1826"></a><span id="l5.1826" class="difflineplus">+    //  sure we re-schedule ourselves.  The most particular rationale here is</span>
<a href="#l5.1827"></a><span id="l5.1827" class="difflineplus">+    //  that the message pane may be toggling its state and it's much simpler</span>
<a href="#l5.1828"></a><span id="l5.1828" class="difflineplus">+    //  and reliable if we ensure that all of FolderDisplayWidget's state</span>
<a href="#l5.1829"></a><span id="l5.1829" class="difflineplus">+    //  change logic gets to run to completion before we run ourselves.</span>
<a href="#l5.1830"></a><span id="l5.1830" class="difflineplus">+    if (!aBounced) {</span>
<a href="#l5.1831"></a><span id="l5.1831" class="difflineplus">+      let dis = this;</span>
<a href="#l5.1832"></a><span id="l5.1832" class="difflineplus">+      window.setTimeout(function() {</span>
<a href="#l5.1833"></a><span id="l5.1833" class="difflineplus">+          dis.ensureRowIsVisible(aViewIndex, true);</span>
<a href="#l5.1834"></a><span id="l5.1834" class="difflineplus">+        }, 0);</span>
<a href="#l5.1835"></a><span id="l5.1835" class="difflineplus">+    }</span>
<a href="#l5.1836"></a><span id="l5.1836" class="difflineplus">+</span>
<a href="#l5.1837"></a><span id="l5.1837" class="difflineplus">+    let treeBox = this.treeBox;</span>
<a href="#l5.1838"></a><span id="l5.1838" class="difflineplus">+    if (!treeBox)</span>
<a href="#l5.1839"></a><span id="l5.1839" class="difflineplus">+      return;</span>
<a href="#l5.1840"></a><span id="l5.1840" class="difflineplus">+</span>
<a href="#l5.1841"></a><span id="l5.1841" class="difflineplus">+    // try and trigger a reflow...</span>
<a href="#l5.1842"></a><span id="l5.1842" class="difflineplus">+    treeBox.height;</span>
<a href="#l5.1843"></a><span id="l5.1843" class="difflineplus">+</span>
<a href="#l5.1844"></a><span id="l5.1844" class="difflineplus">+    let maxIndex = this.view.dbView.rowCount - 1;</span>
<a href="#l5.1845"></a><span id="l5.1845" class="difflineplus">+</span>
<a href="#l5.1846"></a><span id="l5.1846" class="difflineplus">+    let first = treeBox.getFirstVisibleRow();</span>
<a href="#l5.1847"></a><span id="l5.1847" class="difflineplus">+    // Assume the bottom row is half-visible and should generally be ignored.</span>
<a href="#l5.1848"></a><span id="l5.1848" class="difflineplus">+    // (We could actually do the legwork to see if there is a partial one...)</span>
<a href="#l5.1849"></a><span id="l5.1849" class="difflineplus">+    const halfVisible = 1;</span>
<a href="#l5.1850"></a><span id="l5.1850" class="difflineplus">+    let last  = treeBox.getLastVisibleRow() - halfVisible;</span>
<a href="#l5.1851"></a><span id="l5.1851" class="difflineplus">+    let span = treeBox.getPageLength() - halfVisible;</span>
<a href="#l5.1852"></a><span id="l5.1852" class="difflineplus">+</span>
<a href="#l5.1853"></a><span id="l5.1853" class="difflineplus">+    let target;</span>
<a href="#l5.1854"></a><span id="l5.1854" class="difflineplus">+    // If the index is near the end, try and latch on to the bottom.</span>
<a href="#l5.1855"></a><span id="l5.1855" class="difflineplus">+    if (aViewIndex + span - this.TOP_VIEW_PADDING &gt; maxIndex)</span>
<a href="#l5.1856"></a><span id="l5.1856" class="difflineplus">+      target = maxIndex - span;</span>
<a href="#l5.1857"></a><span id="l5.1857" class="difflineplus">+    // If the index is after the last visible guy (with padding), move down</span>
<a href="#l5.1858"></a><span id="l5.1858" class="difflineplus">+    //  so that the target index is padded in 1 from the bottom.</span>
<a href="#l5.1859"></a><span id="l5.1859" class="difflineplus">+    else if (aViewIndex &gt;= last - this.BOTTOM_VIEW_PADDING)</span>
<a href="#l5.1860"></a><span id="l5.1860" class="difflineplus">+      target = Math.min(maxIndex, aViewIndex + this.BOTTOM_VIEW_PADDING) -</span>
<a href="#l5.1861"></a><span id="l5.1861" class="difflineplus">+                 span;</span>
<a href="#l5.1862"></a><span id="l5.1862" class="difflineplus">+    // If the index is before the first visible guy (with padding), move up</span>
<a href="#l5.1863"></a><span id="l5.1863" class="difflineplus">+    else if (aViewIndex &lt;= first + this.TOP_VIEW_PADDING)  // move up</span>
<a href="#l5.1864"></a><span id="l5.1864" class="difflineplus">+      target = Math.max(0, aViewIndex - this.TOP_VIEW_PADDING);</span>
<a href="#l5.1865"></a><span id="l5.1865" class="difflineplus">+    else // it is already visible</span>
<a href="#l5.1866"></a><span id="l5.1866" class="difflineplus">+      return;</span>
<a href="#l5.1867"></a><span id="l5.1867" class="difflineplus">+</span>
<a href="#l5.1868"></a><span id="l5.1868" class="difflineplus">+    // this sets the first visible row</span>
<a href="#l5.1869"></a><span id="l5.1869" class="difflineplus">+    treeBox.scrollToRow(target);</span>
<a href="#l5.1870"></a><span id="l5.1870" class="difflineplus">+  },</span>
<a href="#l5.1871"></a><span id="l5.1871" class="difflineplus">+</span>
<a href="#l5.1872"></a><span id="l5.1872" class="difflineplus">+  /**</span>
<a href="#l5.1873"></a><span id="l5.1873" class="difflineplus">+   * Ensure that the given range of rows is visible maximally visible in the</span>
<a href="#l5.1874"></a><span id="l5.1874" class="difflineplus">+   *  thread pane.  If the range is larger than the number of rows that can be</span>
<a href="#l5.1875"></a><span id="l5.1875" class="difflineplus">+   *  displayed in the thread pane, we bias towards showing the min row (with</span>
<a href="#l5.1876"></a><span id="l5.1876" class="difflineplus">+   *  padding).</span>
<a href="#l5.1877"></a><span id="l5.1877" class="difflineplus">+   *</span>
<a href="#l5.1878"></a><span id="l5.1878" class="difflineplus">+   * @param aMinRow The numerically smallest row index defining the start of</span>
<a href="#l5.1879"></a><span id="l5.1879" class="difflineplus">+   *     the inclusive range.</span>
<a href="#l5.1880"></a><span id="l5.1880" class="difflineplus">+   * @param aMaxRow The numberically largest row index defining the end of the</span>
<a href="#l5.1881"></a><span id="l5.1881" class="difflineplus">+   *     inclusive range.</span>
<a href="#l5.1882"></a><span id="l5.1882" class="difflineplus">+   */</span>
<a href="#l5.1883"></a><span id="l5.1883" class="difflineplus">+  ensureRowRangeIsVisible:</span>
<a href="#l5.1884"></a><span id="l5.1884" class="difflineplus">+      function FolderDisplayWidget_ensureRowRangeIsVisible(aMinRow, aMaxRow,</span>
<a href="#l5.1885"></a><span id="l5.1885" class="difflineplus">+                                                           aBounced) {</span>
<a href="#l5.1886"></a><span id="l5.1886" class="difflineplus">+    // Dealing with the tree view layout is a nightmare, let's just always make</span>
<a href="#l5.1887"></a><span id="l5.1887" class="difflineplus">+    //  sure we re-schedule ourselves.  The most particular rationale here is</span>
<a href="#l5.1888"></a><span id="l5.1888" class="difflineplus">+    //  that the message pane may be toggling its state and it's much simpler</span>
<a href="#l5.1889"></a><span id="l5.1889" class="difflineplus">+    //  and reliable if we ensure that all of FolderDisplayWidget's state</span>
<a href="#l5.1890"></a><span id="l5.1890" class="difflineplus">+    //  change logic gets to run to completion before we run ourselves.</span>
<a href="#l5.1891"></a><span id="l5.1891" class="difflineplus">+    if (!aBounced) {</span>
<a href="#l5.1892"></a><span id="l5.1892" class="difflineplus">+      let dis = this;</span>
<a href="#l5.1893"></a><span id="l5.1893" class="difflineplus">+      window.setTimeout(function() {</span>
<a href="#l5.1894"></a><span id="l5.1894" class="difflineplus">+          dis.ensureRowRangeIsVisible(aMinRow, aMaxRow, true);</span>
<a href="#l5.1895"></a><span id="l5.1895" class="difflineplus">+        }, 0);</span>
<a href="#l5.1896"></a><span id="l5.1896" class="difflineplus">+    }</span>
<a href="#l5.1897"></a><span id="l5.1897" class="difflineplus">+</span>
<a href="#l5.1898"></a><span id="l5.1898" class="difflineplus">+    let treeBox = this.treeBox;</span>
<a href="#l5.1899"></a><span id="l5.1899" class="difflineplus">+    if (!treeBox)</span>
<a href="#l5.1900"></a><span id="l5.1900" class="difflineplus">+      return;</span>
<a href="#l5.1901"></a><span id="l5.1901" class="difflineplus">+    let first = treeBox.getFirstVisibleRow();</span>
<a href="#l5.1902"></a><span id="l5.1902" class="difflineplus">+    const halfVisible = 1;</span>
<a href="#l5.1903"></a><span id="l5.1903" class="difflineplus">+    let last  = treeBox.getLastVisibleRow() - halfVisible;</span>
<a href="#l5.1904"></a><span id="l5.1904" class="difflineplus">+    let span = treeBox.getPageLength() - halfVisible;</span>
<a href="#l5.1905"></a><span id="l5.1905" class="difflineplus">+</span>
<a href="#l5.1906"></a><span id="l5.1906" class="difflineplus">+    // bail if the range is already visible with padding constraints handled</span>
<a href="#l5.1907"></a><span id="l5.1907" class="difflineplus">+    if ((first + this.TOP_VIEW_PADDING &lt;= aMinRow) &amp;&amp;</span>
<a href="#l5.1908"></a><span id="l5.1908" class="difflineplus">+        (last - this.BOTTOM_VIEW_PADDING &gt;= aMaxRow))</span>
<a href="#l5.1909"></a><span id="l5.1909" class="difflineplus">+      return;</span>
<a href="#l5.1910"></a><span id="l5.1910" class="difflineplus">+</span>
<a href="#l5.1911"></a><span id="l5.1911" class="difflineplus">+    let target;</span>
<a href="#l5.1912"></a><span id="l5.1912" class="difflineplus">+    // if the range is bigger than we can fit, optimize position for the min row</span>
<a href="#l5.1913"></a><span id="l5.1913" class="difflineplus">+    //  with padding to make it obvious the range doesn't extend above the row.</span>
<a href="#l5.1914"></a><span id="l5.1914" class="difflineplus">+    if (aMaxRow - aMinRow &gt; span)</span>
<a href="#l5.1915"></a><span id="l5.1915" class="difflineplus">+      target = Math.max(0, aMinRow - this.TOP_VIEW_PADDING);</span>
<a href="#l5.1916"></a><span id="l5.1916" class="difflineplus">+    // So the range must fit, and it's a question of how we want to position it.</span>
<a href="#l5.1917"></a><span id="l5.1917" class="difflineplus">+    // For now, the answer is we try and center it, why not.</span>
<a href="#l5.1918"></a><span id="l5.1918" class="difflineplus">+    else {</span>
<a href="#l5.1919"></a><span id="l5.1919" class="difflineplus">+      let rowSpan = aMaxRow - aMinRow + 1;</span>
<a href="#l5.1920"></a><span id="l5.1920" class="difflineplus">+      let halfSpare = parseInt((span - rowSpan - this.TOP_VIEW_PADDING -</span>
<a href="#l5.1921"></a><span id="l5.1921" class="difflineplus">+                                this.BOTTOM_VIEW_PADDING) / 2);</span>
<a href="#l5.1922"></a><span id="l5.1922" class="difflineplus">+      target = aMinRow - halfSpare - this.TOP_VIEW_PADDING;</span>
<a href="#l5.1923"></a><span id="l5.1923" class="difflineplus">+    }</span>
<a href="#l5.1924"></a><span id="l5.1924" class="difflineplus">+    treeBox.scrollToRow(target);</span>
<a href="#l5.1925"></a><span id="l5.1925" class="difflineplus">+  },</span>
<a href="#l5.1926"></a><span id="l5.1926" class="difflineplus">+</span>
<a href="#l5.1927"></a><span id="l5.1927" class="difflineplus">+  /**</span>
<a href="#l5.1928"></a><span id="l5.1928" class="difflineplus">+   * Ensure that the selection is visible to the extent possible.</span>
<a href="#l5.1929"></a><span id="l5.1929" class="difflineplus">+   */</span>
<a href="#l5.1930"></a><span id="l5.1930" class="difflineplus">+  ensureSelectionIsVisible:</span>
<a href="#l5.1931"></a><span id="l5.1931" class="difflineplus">+      function FolderDisplayWidget_ensureSelectionIsVisible() {</span>
<a href="#l5.1932"></a><span id="l5.1932" class="difflineplus">+    let treeSelection = this.treeSelection; // potentially magic getter</span>
<a href="#l5.1933"></a><span id="l5.1933" class="difflineplus">+    if (!treeSelection || !treeSelection.count)</span>
<a href="#l5.1934"></a><span id="l5.1934" class="difflineplus">+      return;</span>
<a href="#l5.1935"></a><span id="l5.1935" class="difflineplus">+</span>
<a href="#l5.1936"></a><span id="l5.1936" class="difflineplus">+    let minRow = null, maxRow = null;</span>
<a href="#l5.1937"></a><span id="l5.1937" class="difflineplus">+</span>
<a href="#l5.1938"></a><span id="l5.1938" class="difflineplus">+    let rangeCount = treeSelection.getRangeCount();</span>
<a href="#l5.1939"></a><span id="l5.1939" class="difflineplus">+    for (let iRange = 0; iRange &lt; rangeCount; iRange++) {</span>
<a href="#l5.1940"></a><span id="l5.1940" class="difflineplus">+      let rangeMinObj = {}, rangeMaxObj = {};</span>
<a href="#l5.1941"></a><span id="l5.1941" class="difflineplus">+      treeSelection.getRangeAt(iRange, rangeMinObj, rangeMaxObj);</span>
<a href="#l5.1942"></a><span id="l5.1942" class="difflineplus">+      let rangeMin = rangeMinObj.value, rangeMax = rangeMaxObj.value;</span>
<a href="#l5.1943"></a><span id="l5.1943" class="difflineplus">+      if (minRow == null || rangeMin &lt; minRow)</span>
<a href="#l5.1944"></a><span id="l5.1944" class="difflineplus">+        minRow = rangeMin;</span>
<a href="#l5.1945"></a><span id="l5.1945" class="difflineplus">+      if (maxRow == null || rangeMax &gt; maxRow )</span>
<a href="#l5.1946"></a><span id="l5.1946" class="difflineplus">+        maxRow = rangeMax;</span>
<a href="#l5.1947"></a><span id="l5.1947" class="difflineplus">+    }</span>
<a href="#l5.1948"></a><span id="l5.1948" class="difflineplus">+</span>
<a href="#l5.1949"></a><span id="l5.1949" class="difflineplus">+    this.ensureRowRangeIsVisible(minRow, maxRow);</span>
<a href="#l5.1950"></a><span id="l5.1950" class="difflineplus">+  }</span>
<a href="#l5.1951"></a><span id="l5.1951" class="difflineplus">+};</span>
<a href="#l5.1952"></a><span id="l5.1952" class="difflineplus">+</span>
<a href="#l5.1953"></a><span id="l5.1953" class="difflineplus">+/**</span>
<a href="#l5.1954"></a><span id="l5.1954" class="difflineplus">+ * Implement a fake nsITreeBoxObject so that we can keep the view</span>
<a href="#l5.1955"></a><span id="l5.1955" class="difflineplus">+ *  nsITreeSelection selections 'live' when they are in the background.  We need</span>
<a href="#l5.1956"></a><span id="l5.1956" class="difflineplus">+ *  to do this because nsTreeSelection changes its behaviour (and gets ornery)</span>
<a href="#l5.1957"></a><span id="l5.1957" class="difflineplus">+ *  if it does not have a box object.</span>
<a href="#l5.1958"></a><span id="l5.1958" class="difflineplus">+ * This does not need to exist once we abandon multiplexed tabbing.</span>
<a href="#l5.1959"></a><span id="l5.1959" class="difflineplus">+ *</span>
<a href="#l5.1960"></a><span id="l5.1960" class="difflineplus">+ * Sometimes, nsTreeSelection tries to turn us into an nsIBoxObject and then in</span>
<a href="#l5.1961"></a><span id="l5.1961" class="difflineplus">+ *  turn get the associated element, and then create DOM events on that.  We</span>
<a href="#l5.1962"></a><span id="l5.1962" class="difflineplus">+ *  can't really stop that, but we can use misdirection to tell it about a box</span>
<a href="#l5.1963"></a><span id="l5.1963" class="difflineplus">+ *  object that we don't care about.  That way it gets the bogus events,</span>
<a href="#l5.1964"></a><span id="l5.1964" class="difflineplus">+ *  effectively blackholing them.</span>
<a href="#l5.1965"></a><span id="l5.1965" class="difflineplus">+ */</span>
<a href="#l5.1966"></a><span id="l5.1966" class="difflineplus">+function FakeTreeBoxObject(aDummyBoxObject) {</span>
<a href="#l5.1967"></a><span id="l5.1967" class="difflineplus">+  this.dummyBoxObject = aDummyBoxObject.QueryInterface(</span>
<a href="#l5.1968"></a><span id="l5.1968" class="difflineplus">+                          Components.interfaces.nsIBoxObject);</span>
<a href="#l5.1969"></a><span id="l5.1969" class="difflineplus">+  this.view = null;</span>
<a href="#l5.1970"></a><span id="l5.1970" class="difflineplus">+}</span>
<a href="#l5.1971"></a><span id="l5.1971" class="difflineplus">+FakeTreeBoxObject.prototype = {</span>
<a href="#l5.1972"></a><span id="l5.1972" class="difflineplus">+  view: null,</span>
<a href="#l5.1973"></a><span id="l5.1973" class="difflineplus">+  /**</span>
<a href="#l5.1974"></a><span id="l5.1974" class="difflineplus">+   * No need to actually invalidate, as when we re-root the view this will</span>
<a href="#l5.1975"></a><span id="l5.1975" class="difflineplus">+   *  happen.</span>
<a href="#l5.1976"></a><span id="l5.1976" class="difflineplus">+   */</span>
<a href="#l5.1977"></a><span id="l5.1977" class="difflineplus">+  invalidate: function FakeTreeBoxObject_invalidate() {</span>
<a href="#l5.1978"></a><span id="l5.1978" class="difflineplus">+    // NOP</span>
<a href="#l5.1979"></a><span id="l5.1979" class="difflineplus">+  },</span>
<a href="#l5.1980"></a><span id="l5.1980" class="difflineplus">+  invalidateRange: function FakeTreeBoxObject_invalidateRange() {</span>
<a href="#l5.1981"></a><span id="l5.1981" class="difflineplus">+    // NOP</span>
<a href="#l5.1982"></a><span id="l5.1982" class="difflineplus">+  },</span>
<a href="#l5.1983"></a><span id="l5.1983" class="difflineplus">+  invalidateRow: function FakeTreeBoxObject_invalidateRow() {</span>
<a href="#l5.1984"></a><span id="l5.1984" class="difflineplus">+    // NOP</span>
<a href="#l5.1985"></a><span id="l5.1985" class="difflineplus">+  },</span>
<a href="#l5.1986"></a><span id="l5.1986" class="difflineplus">+  beginUpdateBatch: function FakeTreeBoxObject_beginUpdateBatch() {</span>
<a href="#l5.1987"></a><span id="l5.1987" class="difflineplus">+</span>
<a href="#l5.1988"></a><span id="l5.1988" class="difflineplus">+  },</span>
<a href="#l5.1989"></a><span id="l5.1989" class="difflineplus">+  endUpdateBatch: function FakeTreeBoxObject_endUpdateBatch() {</span>
<a href="#l5.1990"></a><span id="l5.1990" class="difflineplus">+</span>
<a href="#l5.1991"></a><span id="l5.1991" class="difflineplus">+  },</span>
<a href="#l5.1992"></a><span id="l5.1992" class="difflineplus">+  rowCountChanged: function FakeTreeBoxObject_rowCountChanged() {</span>
<a href="#l5.1993"></a><span id="l5.1993" class="difflineplus">+</span>
<a href="#l5.1994"></a><span id="l5.1994" class="difflineplus">+  },</span>
<a href="#l5.1995"></a><span id="l5.1995" class="difflineplus">+  /**</span>
<a href="#l5.1996"></a><span id="l5.1996" class="difflineplus">+   * Sleight of hand!  If someone asks us about an nsIBoxObject, we tell them</span>
<a href="#l5.1997"></a><span id="l5.1997" class="difflineplus">+   *  about a real box object that is just a dummy and is never used for</span>
<a href="#l5.1998"></a><span id="l5.1998" class="difflineplus">+   *  anything.</span>
<a href="#l5.1999"></a><span id="l5.1999" class="difflineplus">+   */</span>
<a href="#l5.2000"></a><span id="l5.2000" class="difflineplus">+  QueryInterface: function FakeTreeBoxObject_QueryInterface(aIID) {</span>
<a href="#l5.2001"></a><span id="l5.2001" class="difflineplus">+    if (aIID.equals(Components.interfaces.nsIBoxObject))</span>
<a href="#l5.2002"></a><span id="l5.2002" class="difflineplus">+      return this.dummyBoxObject;</span>
<a href="#l5.2003"></a><span id="l5.2003" class="difflineplus">+    if (!aIID.equals(Components.interfaces.nsISupports) &amp;&amp;</span>
<a href="#l5.2004"></a><span id="l5.2004" class="difflineplus">+        !aIID.equals(Components.interfaces.nsITreeBoxObject))</span>
<a href="#l5.2005"></a><span id="l5.2005" class="difflineplus">+      throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l5.2006"></a><span id="l5.2006" class="difflineplus">+    return this;</span>
<a href="#l5.2007"></a><span id="l5.2007" class="difflineplus">+  }</span>
<a href="#l5.2008"></a><span id="l5.2008" class="difflineplus">+};</span>
<a href="#l5.2009"></a><span id="l5.2009" class="difflineplus">+/*</span>
<a href="#l5.2010"></a><span id="l5.2010" class="difflineplus">+ * Provide attribute and function implementations that complain very loudly if</span>
<a href="#l5.2011"></a><span id="l5.2011" class="difflineplus">+ *  they are used.  Now, XPConnect will return an error to callers if we don't</span>
<a href="#l5.2012"></a><span id="l5.2012" class="difflineplus">+ *  implement part of the interface signature, but this is unlikely to provide</span>
<a href="#l5.2013"></a><span id="l5.2013" class="difflineplus">+ *  the visibility we desire.  In fact, since it is a simple nsresult error,</span>
<a href="#l5.2014"></a><span id="l5.2014" class="difflineplus">+ *  it may make things completely crazy.  So this way we can yell via dump,</span>
<a href="#l5.2015"></a><span id="l5.2015" class="difflineplus">+ *  throw an exception, etc.</span>
<a href="#l5.2016"></a><span id="l5.2016" class="difflineplus">+ */</span>
<a href="#l5.2017"></a><span id="l5.2017" class="difflineplus">+function FTBO_stubOutAttributes(aObj, aAttribNames) {</span>
<a href="#l5.2018"></a><span id="l5.2018" class="difflineplus">+  for (let [, attrName] in Iterator(aAttribNames)) {</span>
<a href="#l5.2019"></a><span id="l5.2019" class="difflineplus">+    let myAttrName = attrName;</span>
<a href="#l5.2020"></a><span id="l5.2020" class="difflineplus">+    aObj.__defineGetter__(attrName,</span>
<a href="#l5.2021"></a><span id="l5.2021" class="difflineplus">+      function() {</span>
<a href="#l5.2022"></a><span id="l5.2022" class="difflineplus">+        let msg = &quot;Read access to stubbed attribute &quot; + myAttrName;</span>
<a href="#l5.2023"></a><span id="l5.2023" class="difflineplus">+        dump(msg + &quot;\n&quot;);</span>
<a href="#l5.2024"></a><span id="l5.2024" class="difflineplus">+        debugger;</span>
<a href="#l5.2025"></a><span id="l5.2025" class="difflineplus">+        throw new Error(msg);</span>
<a href="#l5.2026"></a><span id="l5.2026" class="difflineplus">+      });</span>
<a href="#l5.2027"></a><span id="l5.2027" class="difflineplus">+    aObj.__defineSetter__(attrName,</span>
<a href="#l5.2028"></a><span id="l5.2028" class="difflineplus">+      function() {</span>
<a href="#l5.2029"></a><span id="l5.2029" class="difflineplus">+        let msg = &quot;Write access to stubbed attribute &quot; + myAttrName;</span>
<a href="#l5.2030"></a><span id="l5.2030" class="difflineplus">+        dump(msg + &quot;\n&quot;);</span>
<a href="#l5.2031"></a><span id="l5.2031" class="difflineplus">+        debugger;</span>
<a href="#l5.2032"></a><span id="l5.2032" class="difflineplus">+        throw new Error(msg);</span>
<a href="#l5.2033"></a><span id="l5.2033" class="difflineplus">+      });</span>
<a href="#l5.2034"></a><span id="l5.2034" class="difflineplus">+  }</span>
<a href="#l5.2035"></a><span id="l5.2035" class="difflineplus">+}</span>
<a href="#l5.2036"></a><span id="l5.2036" class="difflineplus">+function FTBO_stubOutMethods(aObj, aMethodNames) {</span>
<a href="#l5.2037"></a><span id="l5.2037" class="difflineplus">+  for (let [, methodName] in Iterator(aMethodNames)) {</span>
<a href="#l5.2038"></a><span id="l5.2038" class="difflineplus">+    let myMethodName = methodName;</span>
<a href="#l5.2039"></a><span id="l5.2039" class="difflineplus">+    aObj[myMethodName] = function() {</span>
<a href="#l5.2040"></a><span id="l5.2040" class="difflineplus">+      let msg = &quot;Call to stubbed method &quot; + myMethodName;</span>
<a href="#l5.2041"></a><span id="l5.2041" class="difflineplus">+      dump(msg + &quot;\n&quot;);</span>
<a href="#l5.2042"></a><span id="l5.2042" class="difflineplus">+      debugger;</span>
<a href="#l5.2043"></a><span id="l5.2043" class="difflineplus">+      throw new Error(msg);</span>
<a href="#l5.2044"></a><span id="l5.2044" class="difflineplus">+    };</span>
<a href="#l5.2045"></a><span id="l5.2045" class="difflineplus">+  }</span>
<a href="#l5.2046"></a><span id="l5.2046" class="difflineplus">+}</span>
<a href="#l5.2047"></a><span id="l5.2047" class="difflineplus">+FTBO_stubOutAttributes(FakeTreeBoxObject.prototype, [</span>
<a href="#l5.2048"></a><span id="l5.2048" class="difflineplus">+  &quot;columns&quot;,</span>
<a href="#l5.2049"></a><span id="l5.2049" class="difflineplus">+  &quot;focused&quot;,</span>
<a href="#l5.2050"></a><span id="l5.2050" class="difflineplus">+  &quot;treeBody&quot;,</span>
<a href="#l5.2051"></a><span id="l5.2051" class="difflineplus">+  &quot;rowHeight&quot;,</span>
<a href="#l5.2052"></a><span id="l5.2052" class="difflineplus">+  &quot;rowWidth&quot;,</span>
<a href="#l5.2053"></a><span id="l5.2053" class="difflineplus">+  &quot;horizontalPosition&quot;,</span>
<a href="#l5.2054"></a><span id="l5.2054" class="difflineplus">+  &quot;selectionRegion&quot;,</span>
<a href="#l5.2055"></a><span id="l5.2055" class="difflineplus">+  ]);</span>
<a href="#l5.2056"></a><span id="l5.2056" class="difflineplus">+FTBO_stubOutMethods(FakeTreeBoxObject.prototype, [</span>
<a href="#l5.2057"></a><span id="l5.2057" class="difflineplus">+  &quot;getFirstVisibleRow&quot;,</span>
<a href="#l5.2058"></a><span id="l5.2058" class="difflineplus">+  &quot;getLastVisibleRow&quot;,</span>
<a href="#l5.2059"></a><span id="l5.2059" class="difflineplus">+  &quot;getPageLength&quot;,</span>
<a href="#l5.2060"></a><span id="l5.2060" class="difflineplus">+  &quot;ensureRowIsVisible&quot;,</span>
<a href="#l5.2061"></a><span id="l5.2061" class="difflineplus">+  &quot;ensureCellIsVisible&quot;,</span>
<a href="#l5.2062"></a><span id="l5.2062" class="difflineplus">+  &quot;scrollToRow&quot;,</span>
<a href="#l5.2063"></a><span id="l5.2063" class="difflineplus">+  &quot;scrollByLines&quot;,</span>
<a href="#l5.2064"></a><span id="l5.2064" class="difflineplus">+  &quot;scrollByPages&quot;,</span>
<a href="#l5.2065"></a><span id="l5.2065" class="difflineplus">+  &quot;scrollToCell&quot;,</span>
<a href="#l5.2066"></a><span id="l5.2066" class="difflineplus">+  &quot;scrollToColumn&quot;,</span>
<a href="#l5.2067"></a><span id="l5.2067" class="difflineplus">+  &quot;scrollToHorizontalPosition&quot;,</span>
<a href="#l5.2068"></a><span id="l5.2068" class="difflineplus">+  &quot;invalidateColumn&quot;,</span>
<a href="#l5.2069"></a><span id="l5.2069" class="difflineplus">+  &quot;invalidateRow&quot;,</span>
<a href="#l5.2070"></a><span id="l5.2070" class="difflineplus">+  &quot;invalidateCell&quot;,</span>
<a href="#l5.2071"></a><span id="l5.2071" class="difflineplus">+  &quot;invalidateColumnRange&quot;,</span>
<a href="#l5.2072"></a><span id="l5.2072" class="difflineplus">+  &quot;getRowAt&quot;,</span>
<a href="#l5.2073"></a><span id="l5.2073" class="difflineplus">+  &quot;getCellAt&quot;,</span>
<a href="#l5.2074"></a><span id="l5.2074" class="difflineplus">+  &quot;getCoordsForCellItem&quot;,</span>
<a href="#l5.2075"></a><span id="l5.2075" class="difflineplus">+  &quot;isCellCropped&quot;,</span>
<a href="#l5.2076"></a><span id="l5.2076" class="difflineplus">+  &quot;clearStyleAndImageCaches&quot;,</span>
<a href="#l5.2077"></a><span id="l5.2077" class="difflineplus">+  ]);</span>
<a href="#l5.2078"></a><span id="l5.2078">\ No newline at end of file</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/base/content/folderPane.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/base/content/folderPane.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -58,17 +58,17 @@ let gFolderTreeView = {</span>
<a href="#l6.4"></a><span id="l6.4">   load: function ftv_load(aTree, aJSONFile) {</span>
<a href="#l6.5"></a><span id="l6.5">     const Cc = Components.classes;</span>
<a href="#l6.6"></a><span id="l6.6">     const Ci = Components.interfaces;</span>
<a href="#l6.7"></a><span id="l6.7">     this._treeElement = aTree;</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9">     let smartName = document.getElementById(&quot;bundle_messenger&quot;)</span>
<a href="#l6.10"></a><span id="l6.10">                             .getString(&quot;folderPaneHeader_smart&quot;);</span>
<a href="#l6.11"></a><span id="l6.11">     this.registerMode(&quot;smart&quot;, this._smartFoldersGenerator, smartName);</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-    // the folder pane can be used for other trees which may not have these elements. </span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+    // the folder pane can be used for other trees which may not have these elements.</span>
<a href="#l6.14"></a><span id="l6.14">     if (document.getElementById(&quot;folderpane_splitter&quot;))</span>
<a href="#l6.15"></a><span id="l6.15">       document.getElementById(&quot;folderpane_splitter&quot;).collapsed = false;</span>
<a href="#l6.16"></a><span id="l6.16">     if (document.getElementById(&quot;folderPaneBox&quot;))</span>
<a href="#l6.17"></a><span id="l6.17">       document.getElementById(&quot;folderPaneBox&quot;).collapsed = false;</span>
<a href="#l6.18"></a><span id="l6.18"> </span>
<a href="#l6.19"></a><span id="l6.19">     try {</span>
<a href="#l6.20"></a><span id="l6.20">       // Normally our tree takes care of keeping the last selected by itself.</span>
<a href="#l6.21"></a><span id="l6.21">       // However older versions of TB stored this in a preference, which we need</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineat">@@ -105,17 +105,17 @@ let gFolderTreeView = {</span>
<a href="#l6.23"></a><span id="l6.23">                          .createInstance(Ci.nsIFileInputStream);</span>
<a href="#l6.24"></a><span id="l6.24">         let sstream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;]</span>
<a href="#l6.25"></a><span id="l6.25">                          .createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l6.26"></a><span id="l6.26">         fstream.init(file, -1, 0, 0);</span>
<a href="#l6.27"></a><span id="l6.27">         sstream.init(fstream);</span>
<a href="#l6.28"></a><span id="l6.28"> </span>
<a href="#l6.29"></a><span id="l6.29">         while (sstream.available())</span>
<a href="#l6.30"></a><span id="l6.30">           data += sstream.read(4096);</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-        </span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+</span>
<a href="#l6.33"></a><span id="l6.33">         sstream.close();</span>
<a href="#l6.34"></a><span id="l6.34">         fstream.close();</span>
<a href="#l6.35"></a><span id="l6.35">         let JSON = Cc[&quot;@mozilla.org/dom/json;1&quot;].createInstance(Ci.nsIJSON);</span>
<a href="#l6.36"></a><span id="l6.36">         this._persistOpenMap = JSON.decode(data);</span>
<a href="#l6.37"></a><span id="l6.37">       }</span>
<a href="#l6.38"></a><span id="l6.38">     }</span>
<a href="#l6.39"></a><span id="l6.39"> </span>
<a href="#l6.40"></a><span id="l6.40">     // Load our data</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineat">@@ -211,17 +211,17 @@ let gFolderTreeView = {</span>
<a href="#l6.42"></a><span id="l6.42">         aEvent.button != 0 || aEvent.originalTarget.localName == &quot;twisty&quot; ||</span>
<a href="#l6.43"></a><span id="l6.43">         aEvent.originalTarget.localName == &quot;slider&quot; ||</span>
<a href="#l6.44"></a><span id="l6.44">         aEvent.originalTarget.localName == &quot;scrollbarbutton&quot;)</span>
<a href="#l6.45"></a><span id="l6.45">       return;</span>
<a href="#l6.46"></a><span id="l6.46"> </span>
<a href="#l6.47"></a><span id="l6.47">     let row = gFolderTreeView._treeElement.treeBoxObject.getRowAt(aEvent.clientX,</span>
<a href="#l6.48"></a><span id="l6.48">                                                                   aEvent.clientY);</span>
<a href="#l6.49"></a><span id="l6.49">     let folderItem = gFolderTreeView._rowMap[row];</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineminus">-    if (folderItem)                                                   </span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+    if (folderItem)</span>
<a href="#l6.52"></a><span id="l6.52">       folderItem.command();</span>
<a href="#l6.53"></a><span id="l6.53"> </span>
<a href="#l6.54"></a><span id="l6.54">     // Don't let the double-click toggle the open state of the folder here</span>
<a href="#l6.55"></a><span id="l6.55">     aEvent.stopPropagation();</span>
<a href="#l6.56"></a><span id="l6.56">   },</span>
<a href="#l6.57"></a><span id="l6.57"> </span>
<a href="#l6.58"></a><span id="l6.58">   getFolderAtCoords: function ftv_getFolderAtCoords(aX, aY) {</span>
<a href="#l6.59"></a><span id="l6.59">     let row = gFolderTreeView._treeElement.treeBoxObject.getRowAt(aX, aY);</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineat">@@ -265,17 +265,17 @@ let gFolderTreeView = {</span>
<a href="#l6.61"></a><span id="l6.61">    * that the folder is actually being displayed (that is, that none of its</span>
<a href="#l6.62"></a><span id="l6.62">    * ancestors are collapsed.</span>
<a href="#l6.63"></a><span id="l6.63">    *</span>
<a href="#l6.64"></a><span id="l6.64">    * @param aFolder  the nsIMsgFolder to select</span>
<a href="#l6.65"></a><span id="l6.65">    */</span>
<a href="#l6.66"></a><span id="l6.66">   selectFolder: function ftv_selectFolder(aFolder) {</span>
<a href="#l6.67"></a><span id="l6.67">     // &quot;this&quot; inside the nested function refers to the function...</span>
<a href="#l6.68"></a><span id="l6.68">     // Also note that openIfNot is recursive.</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineminus">-    let tree = this; </span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+    let tree = this;</span>
<a href="#l6.71"></a><span id="l6.71">     function openIfNot(aFolderToOpen) {</span>
<a href="#l6.72"></a><span id="l6.72">       let index = tree.getIndexOfFolder(aFolderToOpen);</span>
<a href="#l6.73"></a><span id="l6.73">       if (index) {</span>
<a href="#l6.74"></a><span id="l6.74">         if (!tree._rowMap[index].open)</span>
<a href="#l6.75"></a><span id="l6.75">           tree._toggleRow(index, false);</span>
<a href="#l6.76"></a><span id="l6.76">         return;</span>
<a href="#l6.77"></a><span id="l6.77">       }</span>
<a href="#l6.78"></a><span id="l6.78"> </span>
<a href="#l6.79"></a><span id="l6.79" class="difflineat">@@ -444,17 +444,17 @@ let gFolderTreeView = {</span>
<a href="#l6.80"></a><span id="l6.80">         let folders = new Array;</span>
<a href="#l6.81"></a><span id="l6.81">         folders.push(dt.mozGetDataAt(&quot;text/x-moz-folder&quot;, i)</span>
<a href="#l6.82"></a><span id="l6.82">                        .QueryInterface(Ci.nsIMsgFolder));</span>
<a href="#l6.83"></a><span id="l6.83">         let array = toXPCOMArray(folders, Ci.nsIMutableArray);</span>
<a href="#l6.84"></a><span id="l6.84">         cs.CopyFolders(array, targetFolder,</span>
<a href="#l6.85"></a><span id="l6.85">                       (folders[0].server == targetFolder.server), null,</span>
<a href="#l6.86"></a><span id="l6.86">                        msgWindow);</span>
<a href="#l6.87"></a><span id="l6.87">       }</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineminus">-    } </span>
<a href="#l6.89"></a><span id="l6.89" class="difflineplus">+    }</span>
<a href="#l6.90"></a><span id="l6.90">     else if (Array.indexOf(types, &quot;text/x-moz-newsfolder&quot;) != -1) {</span>
<a href="#l6.91"></a><span id="l6.91">       // Start by getting folders into order.</span>
<a href="#l6.92"></a><span id="l6.92">       let folders = new Array;</span>
<a href="#l6.93"></a><span id="l6.93">       for (let i = 0; i &lt; count; i++) {</span>
<a href="#l6.94"></a><span id="l6.94">         let folder = dt.mozGetDataAt(&quot;text/x-moz-newsfolder&quot;, i)</span>
<a href="#l6.95"></a><span id="l6.95">                        .QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l6.96"></a><span id="l6.96">         folders[this.getIndexOfFolder(folder)] = folder;</span>
<a href="#l6.97"></a><span id="l6.97">       }</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineat">@@ -1027,17 +1027,17 @@ let gFolderTreeView = {</span>
<a href="#l6.99"></a><span id="l6.99">           acct.incomingServer.rootFolder.subFolders;</span>
<a href="#l6.100"></a><span id="l6.100">         }</span>
<a href="#l6.101"></a><span id="l6.101">         catch (ex) {</span>
<a href="#l6.102"></a><span id="l6.102">           Components.classes[&quot;@mozilla.org/consoleservice;1&quot;]</span>
<a href="#l6.103"></a><span id="l6.103">                     .getService(Components.interfaces.nsIConsoleService)</span>
<a href="#l6.104"></a><span id="l6.104">                     .logStringMessage(&quot;Discovering folders for account failed with exception: &quot; + ex);</span>
<a href="#l6.105"></a><span id="l6.105">         }</span>
<a href="#l6.106"></a><span id="l6.106">       }</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineminus">-        </span>
<a href="#l6.108"></a><span id="l6.108" class="difflineplus">+</span>
<a href="#l6.109"></a><span id="l6.109">       return [new ftvItem(acct.incomingServer.rootFolder)</span>
<a href="#l6.110"></a><span id="l6.110">               for each (acct in accounts)];</span>
<a href="#l6.111"></a><span id="l6.111">     },</span>
<a href="#l6.112"></a><span id="l6.112"> </span>
<a href="#l6.113"></a><span id="l6.113">     /**</span>
<a href="#l6.114"></a><span id="l6.114">      * The unread mode returns all folders that are not root-folders and that</span>
<a href="#l6.115"></a><span id="l6.115">      * have unread items.  Also always keep the currently selected folder</span>
<a href="#l6.116"></a><span id="l6.116">      * so it doesn't disappear under the user.</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineat">@@ -1129,17 +1129,17 @@ let gFolderTreeView = {</span>
<a href="#l6.118"></a><span id="l6.118"> </span>
<a href="#l6.119"></a><span id="l6.119">       for each (let folder in ftv._enumerateFolders)</span>
<a href="#l6.120"></a><span id="l6.120">         addIfRecent(folder);</span>
<a href="#l6.121"></a><span id="l6.121"> </span>
<a href="#l6.122"></a><span id="l6.122">       recentFolders.sort(sorter);</span>
<a href="#l6.123"></a><span id="l6.123"> </span>
<a href="#l6.124"></a><span id="l6.124">       let items = [new ftvItem(f) for each (f in recentFolders)];</span>
<a href="#l6.125"></a><span id="l6.125"> </span>
<a href="#l6.126"></a><span id="l6.126" class="difflineminus">-      // There are no children in this view! </span>
<a href="#l6.127"></a><span id="l6.127" class="difflineplus">+      // There are no children in this view!</span>
<a href="#l6.128"></a><span id="l6.128">       // And we want to display the account name to distinguish folders w/</span>
<a href="#l6.129"></a><span id="l6.129">       // the same name.</span>
<a href="#l6.130"></a><span id="l6.130">       for each (let folder in items) {</span>
<a href="#l6.131"></a><span id="l6.131">         folder.__defineGetter__(&quot;children&quot;, function() []);</span>
<a href="#l6.132"></a><span id="l6.132">         folder.addServerName = true;</span>
<a href="#l6.133"></a><span id="l6.133">       }</span>
<a href="#l6.134"></a><span id="l6.134"> </span>
<a href="#l6.135"></a><span id="l6.135">       return items;</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineat">@@ -1253,17 +1253,17 @@ let gFolderTreeView = {</span>
<a href="#l6.137"></a><span id="l6.137"> </span>
<a href="#l6.138"></a><span id="l6.138">   OnItemRemoved: function ftl_remove(aRDFParentItem, aItem) {</span>
<a href="#l6.139"></a><span id="l6.139">     if (!(aItem instanceof Components.interfaces.nsIMsgFolder))</span>
<a href="#l6.140"></a><span id="l6.140">       return;</span>
<a href="#l6.141"></a><span id="l6.141"> </span>
<a href="#l6.142"></a><span id="l6.142">     let persistMapIndex = this._persistOpenMap[this.mode].indexOf(aItem.URI);</span>
<a href="#l6.143"></a><span id="l6.143">     if (persistMapIndex != -1)</span>
<a href="#l6.144"></a><span id="l6.144">       this._persistOpenMap[this.mode].splice(persistMapIndex, 1);</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineminus">-    </span>
<a href="#l6.146"></a><span id="l6.146" class="difflineplus">+</span>
<a href="#l6.147"></a><span id="l6.147">     let index = this.getIndexOfFolder(aItem);</span>
<a href="#l6.148"></a><span id="l6.148">     if (!index)</span>
<a href="#l6.149"></a><span id="l6.149">       return;</span>
<a href="#l6.150"></a><span id="l6.150">     // forget our parent's children; they'll get rebuilt</span>
<a href="#l6.151"></a><span id="l6.151">     if (aRDFParentItem)</span>
<a href="#l6.152"></a><span id="l6.152">       this._rowMap[index]._parent._children = null;</span>
<a href="#l6.153"></a><span id="l6.153">     let kidCount = 1;</span>
<a href="#l6.154"></a><span id="l6.154">     let walker = Number(index) + 1;</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineat">@@ -1465,23 +1465,16 @@ let gFolderTreeController = {</span>
<a href="#l6.156"></a><span id="l6.156">       msgDB.summaryValid = false;</span>
<a href="#l6.157"></a><span id="l6.157">       try {</span>
<a href="#l6.158"></a><span id="l6.158">         folder.closeAndBackupFolderDB(&quot;&quot;);</span>
<a href="#l6.159"></a><span id="l6.159">       }</span>
<a href="#l6.160"></a><span id="l6.160">       catch(e) {</span>
<a href="#l6.161"></a><span id="l6.161">         // In a failure, proceed anyway since we're dealing with problems</span>
<a href="#l6.162"></a><span id="l6.162">         folder.ForceDBClosed();</span>
<a href="#l6.163"></a><span id="l6.163">       }</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineminus">-      // these lines will cause the thread pane to get reloaded when the</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineminus">-      // download/reparse is finished. Only do this if the selected folder is</span>
<a href="#l6.166"></a><span id="l6.166" class="difflineminus">-      // loaded (i.e., not thru the context menu on a non-loaded folder).</span>
<a href="#l6.167"></a><span id="l6.167" class="difflineminus">-      if (folder == GetLoadedMsgFolder()) {</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineminus">-        gRerootOnFolderLoad = true;</span>
<a href="#l6.169"></a><span id="l6.169" class="difflineminus">-        gCurrentFolderToReroot = folder.URI;</span>
<a href="#l6.170"></a><span id="l6.170" class="difflineminus">-      }</span>
<a href="#l6.171"></a><span id="l6.171">       folder.updateFolder(msgWindow);</span>
<a href="#l6.172"></a><span id="l6.172">     }</span>
<a href="#l6.173"></a><span id="l6.173"> </span>
<a href="#l6.174"></a><span id="l6.174">     window.openDialog(&quot;chrome://messenger/content/folderProps.xul&quot;, &quot;&quot;,</span>
<a href="#l6.175"></a><span id="l6.175">                       &quot;chrome,centerscreen,titlebar,modal&quot;,</span>
<a href="#l6.176"></a><span id="l6.176">                       {folder: folder, serverType: folder.server.type,</span>
<a href="#l6.177"></a><span id="l6.177">                        msgWindow: msgWindow, title: title,</span>
<a href="#l6.178"></a><span id="l6.178">                        okCallback: editFolderCallback,</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineat">@@ -1500,17 +1493,16 @@ let gFolderTreeController = {</span>
<a href="#l6.180"></a><span id="l6.180">     let folder = aFolder || gFolderTreeView.getSelectedFolders()[0];</span>
<a href="#l6.181"></a><span id="l6.181"> </span>
<a href="#l6.182"></a><span id="l6.182">     //xxx no need for uri now</span>
<a href="#l6.183"></a><span id="l6.183">     let controller = this;</span>
<a href="#l6.184"></a><span id="l6.184">     function renameCallback(aName, aUri) {</span>
<a href="#l6.185"></a><span id="l6.185">       if (aUri != folder.URI)</span>
<a href="#l6.186"></a><span id="l6.186">         Components.utils.reportError(&quot;got back a different folder to rename!&quot;);</span>
<a href="#l6.187"></a><span id="l6.187"> </span>
<a href="#l6.188"></a><span id="l6.188" class="difflineminus">-      controller._resetThreadPane();</span>
<a href="#l6.189"></a><span id="l6.189">       controller._tree.view.selection.clearSelection();</span>
<a href="#l6.190"></a><span id="l6.190"> </span>
<a href="#l6.191"></a><span id="l6.191">       // Actually do the rename</span>
<a href="#l6.192"></a><span id="l6.192">       folder.rename(aName, msgWindow);</span>
<a href="#l6.193"></a><span id="l6.193">     }</span>
<a href="#l6.194"></a><span id="l6.194">     window.openDialog(&quot;chrome://messenger/content/renameFolderDialog.xul&quot;,</span>
<a href="#l6.195"></a><span id="l6.195">                       &quot;newFolder&quot;, &quot;chrome,titlebar,modal&quot;,</span>
<a href="#l6.196"></a><span id="l6.196">                       {preselectedURI: folder.URI,</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineat">@@ -1559,21 +1551,19 @@ let gFolderTreeController = {</span>
<a href="#l6.198"></a><span id="l6.198">     }</span>
<a href="#l6.199"></a><span id="l6.199"> </span>
<a href="#l6.200"></a><span id="l6.200">     if (folder.flags &amp; FLAGS.Virtual) {</span>
<a href="#l6.201"></a><span id="l6.201">       let confirmation = bundle.getString(&quot;confirmSavedSearchDeleteMessage&quot;);</span>
<a href="#l6.202"></a><span id="l6.202">       let title = bundle.getString(&quot;confirmSavedSearchTitle&quot;);</span>
<a href="#l6.203"></a><span id="l6.203">       let IPS = Components.interfaces.nsIPromptService;</span>
<a href="#l6.204"></a><span id="l6.204">       if (Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l6.205"></a><span id="l6.205">             .getService(IPS)</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineminus">-            .confirmEx(window, title, confirmation, IPS.STD_YES_NO_BUTTONS + IPS.BUTTON_POS_1_DEFAULT, </span>
<a href="#l6.207"></a><span id="l6.207" class="difflineplus">+            .confirmEx(window, title, confirmation, IPS.STD_YES_NO_BUTTONS + IPS.BUTTON_POS_1_DEFAULT,</span>
<a href="#l6.208"></a><span id="l6.208">                        &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, {}) != 0) /* the yes button is in position 0 */</span>
<a href="#l6.209"></a><span id="l6.209">         return;</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineminus">-      if (gCurrentVirtualFolderUri == folder.URI)</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineminus">-        gCurrentVirtualFolderUri = null;</span>
<a href="#l6.212"></a><span id="l6.212">     }</span>
<a href="#l6.213"></a><span id="l6.213"> </span>
<a href="#l6.214"></a><span id="l6.214">     let array = toXPCOMArray([folder], Ci.nsIMutableArray);</span>
<a href="#l6.215"></a><span id="l6.215">     folder.parent.deleteSubFolders(array, msgWindow);</span>
<a href="#l6.216"></a><span id="l6.216">   },</span>
<a href="#l6.217"></a><span id="l6.217"> </span>
<a href="#l6.218"></a><span id="l6.218">   /**</span>
<a href="#l6.219"></a><span id="l6.219">    * Prompts the user to confirm and empties the trash for the selected folder</span>
<a href="#l6.220"></a><span id="l6.220" class="difflineat">@@ -1621,20 +1611,16 @@ let gFolderTreeController = {</span>
<a href="#l6.221"></a><span id="l6.221">    */</span>
<a href="#l6.222"></a><span id="l6.222">   compactFolders: function ftc_compactFolders(aFolders) {</span>
<a href="#l6.223"></a><span id="l6.223">     let folders = aFolders || gFolderTreeView.getSelectedFolders();</span>
<a href="#l6.224"></a><span id="l6.224">     for (let i = 0; i &lt; folders.length; i++) {</span>
<a href="#l6.225"></a><span id="l6.225">       // Can't compact folders that have just been compacted.</span>
<a href="#l6.226"></a><span id="l6.226">       if (folders[i].server.type != &quot;imap&quot; &amp;&amp; !folders[i].expungedBytes)</span>
<a href="#l6.227"></a><span id="l6.227">         continue;</span>
<a href="#l6.228"></a><span id="l6.228"> </span>
<a href="#l6.229"></a><span id="l6.229" class="difflineminus">-      // Reset thread pane for non-imap folders if the folder is selected.</span>
<a href="#l6.230"></a><span id="l6.230" class="difflineminus">-      if (gDBView &amp;&amp; gDBView.msgFolder == folders[i] &amp;&amp; folders[i].server.type != &quot;imap&quot;)</span>
<a href="#l6.231"></a><span id="l6.231" class="difflineminus">-        this._resetThreadPane();</span>
<a href="#l6.232"></a><span id="l6.232" class="difflineminus">-</span>
<a href="#l6.233"></a><span id="l6.233">       folders[i].compact(null, msgWindow);</span>
<a href="#l6.234"></a><span id="l6.234">     }</span>
<a href="#l6.235"></a><span id="l6.235">   },</span>
<a href="#l6.236"></a><span id="l6.236"> </span>
<a href="#l6.237"></a><span id="l6.237">   /**</span>
<a href="#l6.238"></a><span id="l6.238">    * Compacts all folders for accounts that the given folders belong</span>
<a href="#l6.239"></a><span id="l6.239">    * to, or all folders for accounts of the currently selected folders.</span>
<a href="#l6.240"></a><span id="l6.240">    *</span>
<a href="#l6.241"></a><span id="l6.241" class="difflineat">@@ -1686,29 +1672,16 @@ let gFolderTreeController = {</span>
<a href="#l6.242"></a><span id="l6.242">     window.openDialog(&quot;chrome://messenger/content/virtualFolderProperties.xul&quot;,</span>
<a href="#l6.243"></a><span id="l6.243">                       &quot;&quot;, &quot;chrome,titlebar,modal,centerscreen&quot;,</span>
<a href="#l6.244"></a><span id="l6.244">                       {folder: folder, editExistingFolder: true,</span>
<a href="#l6.245"></a><span id="l6.245">                        onOKCallback: editVirtualCallback,</span>
<a href="#l6.246"></a><span id="l6.246">                        msgWindow: msgWindow});</span>
<a href="#l6.247"></a><span id="l6.247">   },</span>
<a href="#l6.248"></a><span id="l6.248"> </span>
<a href="#l6.249"></a><span id="l6.249">   /**</span>
<a href="#l6.250"></a><span id="l6.250" class="difflineminus">-   * For certain folder commands, the thread pane needs to be invalidated, this</span>
<a href="#l6.251"></a><span id="l6.251" class="difflineminus">-   * takes care of doing so.</span>
<a href="#l6.252"></a><span id="l6.252" class="difflineminus">-   */</span>
<a href="#l6.253"></a><span id="l6.253" class="difflineminus">-  _resetThreadPane: function ftc_resetThreadPane() {</span>
<a href="#l6.254"></a><span id="l6.254" class="difflineminus">-    if (gDBView)</span>
<a href="#l6.255"></a><span id="l6.255" class="difflineminus">-      gCurrentlyDisplayedMessage = gDBView.currentlyDisplayedMessage;</span>
<a href="#l6.256"></a><span id="l6.256" class="difflineminus">-</span>
<a href="#l6.257"></a><span id="l6.257" class="difflineminus">-    ClearThreadPaneSelection();</span>
<a href="#l6.258"></a><span id="l6.258" class="difflineminus">-    ClearThreadPane();</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineminus">-    ClearMessagePane();</span>
<a href="#l6.260"></a><span id="l6.260" class="difflineminus">-  },</span>
<a href="#l6.261"></a><span id="l6.261" class="difflineminus">-</span>
<a href="#l6.262"></a><span id="l6.262" class="difflineminus">-  /**</span>
<a href="#l6.263"></a><span id="l6.263">    * Prompts for confirmation, if the user hasn't already chosen the &quot;don't ask</span>
<a href="#l6.264"></a><span id="l6.264">    * again&quot; option.</span>
<a href="#l6.265"></a><span id="l6.265">    *</span>
<a href="#l6.266"></a><span id="l6.266">    * @param aCommand - the command to prompt for</span>
<a href="#l6.267"></a><span id="l6.267">    */</span>
<a href="#l6.268"></a><span id="l6.268">   _checkConfirmationPrompt: function ftc_confirm(aCommand) {</span>
<a href="#l6.269"></a><span id="l6.269">     const Cc = Components.classes;</span>
<a href="#l6.270"></a><span id="l6.270">     const Ci = Components.interfaces;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/base/content/mail-offline.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/base/content/mail-offline.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -259,12 +259,11 @@ var MailOfflineMgr = {</span>
<a href="#l7.4"></a><span id="l7.4">     }    </span>
<a href="#l7.5"></a><span id="l7.5">   },   </span>
<a href="#l7.6"></a><span id="l7.6"> </span>
<a href="#l7.7"></a><span id="l7.7">   /**</span>
<a href="#l7.8"></a><span id="l7.8">    * private helper method called whenever we detect a change to the offline state</span>
<a href="#l7.9"></a><span id="l7.9">    */ </span>
<a href="#l7.10"></a><span id="l7.10">   mailOfflineStateChanged: function (aGoingOffline)</span>
<a href="#l7.11"></a><span id="l7.11">   {</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-    gFolderJustSwitched = true;</span>
<a href="#l7.13"></a><span id="l7.13">     this.updateOfflineUI(aGoingOffline);</span>
<a href="#l7.14"></a><span id="l7.14">   }</span>
<a href="#l7.15"></a><span id="l7.15"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/base/content/mail3PaneWindowCommands.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/base/content/mail3PaneWindowCommands.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1,48 +1,47 @@</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineminus">-# -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineminus">-# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineminus">-# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineminus">-#</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineminus">-# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineminus">-# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineminus">-# the License. You may obtain a copy of the License at</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineminus">-# http://www.mozilla.org/MPL/</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-#</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-# for the specific language governing rights and limitations under the</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">-# License.</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">-#</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineminus">-# The Original Code is Mozilla Communicator client code, released</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineminus">-# March 31, 1998.</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineminus">-#</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineminus">-# The Initial Developer of the Original Code is</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineminus">-# Netscape Communications Corporation.</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineminus">-# Portions created by the Initial Developer are Copyright (C) 1998-2000</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineminus">-# the Initial Developer. All Rights Reserved.</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineminus">-#</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineminus">-# Contributor(s):</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineminus">-#   Jan Varga &lt;varga@nixcorp.com&gt;</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineminus">-#   Hkan Waara &lt;hwaara@gmail.com&gt;</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineminus">-#   Magnus Melin &lt;mkmelin+mozilla@iki.fi&gt;</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-#</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-# either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-# the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">-# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineminus">-# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineminus">-# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">-# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">-# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">-# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineminus">-# the provisions above, a recipient may use your version of this file under</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineminus">-# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineminus">-#</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineminus">-# ***** END LICENSE BLOCK *****</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+ *</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+ *</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+ * License.</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+ *</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+ * The Original Code is Mozilla Communicator client code, released</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+ * March 31, 1998.</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+ *</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+ * Netscape Communications Corporation.</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 1998-2000</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+ *</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+ * Contributor(s):</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+ *   Jan Varga &lt;varga@nixcorp.com&gt;</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+ *   Hkan Waara &lt;hwaara@gmail.com&gt;</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+ *   Magnus Melin &lt;mkmelin+mozilla@iki.fi&gt;</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+ *</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+ *</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l8.83"></a><span id="l8.83"> </span>
<a href="#l8.84"></a><span id="l8.84"> var gMessengerBundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l8.85"></a><span id="l8.85"> </span>
<a href="#l8.86"></a><span id="l8.86"> // Controller object for folder pane</span>
<a href="#l8.87"></a><span id="l8.87"> var FolderPaneController =</span>
<a href="#l8.88"></a><span id="l8.88"> {</span>
<a href="#l8.89"></a><span id="l8.89">   supportsCommand: function(command)</span>
<a href="#l8.90"></a><span id="l8.90">   {</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineat">@@ -103,17 +102,17 @@ var FolderPaneController =</span>
<a href="#l8.92"></a><span id="l8.92">     if (!this.isCommandEnabled(command)) return;</span>
<a href="#l8.93"></a><span id="l8.93"> </span>
<a href="#l8.94"></a><span id="l8.94">     switch ( command )</span>
<a href="#l8.95"></a><span id="l8.95">     {</span>
<a href="#l8.96"></a><span id="l8.96">       case &quot;cmd_delete&quot;:</span>
<a href="#l8.97"></a><span id="l8.97">       case &quot;cmd_shiftDelete&quot;:</span>
<a href="#l8.98"></a><span id="l8.98">       case &quot;button_delete&quot;:</span>
<a href="#l8.99"></a><span id="l8.99">       case &quot;cmd_deleteFolder&quot;:</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineminus">-        gFolderTreeController.deleteFolder(); </span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+        gFolderTreeController.deleteFolder();</span>
<a href="#l8.102"></a><span id="l8.102">         break;</span>
<a href="#l8.103"></a><span id="l8.103">     }</span>
<a href="#l8.104"></a><span id="l8.104">   },</span>
<a href="#l8.105"></a><span id="l8.105"> </span>
<a href="#l8.106"></a><span id="l8.106">   onEvent: function(event)</span>
<a href="#l8.107"></a><span id="l8.107">   {</span>
<a href="#l8.108"></a><span id="l8.108">   }</span>
<a href="#l8.109"></a><span id="l8.109"> };</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineat">@@ -237,17 +236,17 @@ var DefaultController =</span>
<a href="#l8.111"></a><span id="l8.111">       case &quot;cmd_downloadFlagged&quot;:</span>
<a href="#l8.112"></a><span id="l8.112">       case &quot;cmd_downloadSelected&quot;:</span>
<a href="#l8.113"></a><span id="l8.113">       case &quot;cmd_synchronizeOffline&quot;:</span>
<a href="#l8.114"></a><span id="l8.114">         return MailOfflineMgr.isOnline();</span>
<a href="#l8.115"></a><span id="l8.115"> </span>
<a href="#l8.116"></a><span id="l8.116">       case &quot;cmd_watchThread&quot;:</span>
<a href="#l8.117"></a><span id="l8.117">       case &quot;cmd_killThread&quot;:</span>
<a href="#l8.118"></a><span id="l8.118">       case &quot;cmd_killSubthread&quot;:</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineminus">-        return(isNewsURI(GetFirstSelectedMessage()));</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineplus">+        return(gFolderDisplay.selectedMessageIsNews);</span>
<a href="#l8.121"></a><span id="l8.121"> </span>
<a href="#l8.122"></a><span id="l8.122">       default:</span>
<a href="#l8.123"></a><span id="l8.123">         return false;</span>
<a href="#l8.124"></a><span id="l8.124">     }</span>
<a href="#l8.125"></a><span id="l8.125">   },</span>
<a href="#l8.126"></a><span id="l8.126"> </span>
<a href="#l8.127"></a><span id="l8.127">   isCommandEnabled: function(command)</span>
<a href="#l8.128"></a><span id="l8.128">   {</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineat">@@ -257,45 +256,37 @@ var DefaultController =</span>
<a href="#l8.130"></a><span id="l8.130"> </span>
<a href="#l8.131"></a><span id="l8.131">     switch ( command )</span>
<a href="#l8.132"></a><span id="l8.132">     {</span>
<a href="#l8.133"></a><span id="l8.133">       case &quot;cmd_delete&quot;:</span>
<a href="#l8.134"></a><span id="l8.134">         UpdateDeleteCommand();</span>
<a href="#l8.135"></a><span id="l8.135">         // fall through</span>
<a href="#l8.136"></a><span id="l8.136">       case &quot;button_delete&quot;:</span>
<a href="#l8.137"></a><span id="l8.137">         UpdateDeleteToolbarButton();</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineminus">-        if (gDBView)</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineminus">-          gDBView.getCommandStatus(nsMsgViewCommandType.deleteMsg, enabled, checkStatus);</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineminus">-        return enabled.value;</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineplus">+        return gFolderDisplay.getCommandStatus(nsMsgViewCommandType.deleteMsg);</span>
<a href="#l8.142"></a><span id="l8.142">       case &quot;cmd_shiftDelete&quot;:</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineminus">-        if (gDBView)</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineminus">-          gDBView.getCommandStatus(nsMsgViewCommandType.deleteNoTrash, enabled, checkStatus);</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineminus">-        return enabled.value;</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineplus">+        return gFolderDisplay.getCommandStatus(nsMsgViewCommandType.deleteNoTrash);</span>
<a href="#l8.147"></a><span id="l8.147">       case &quot;cmd_deleteFolder&quot;:</span>
<a href="#l8.148"></a><span id="l8.148">         var folders = gFolderTreeView.getSelectedFolders();</span>
<a href="#l8.149"></a><span id="l8.149">         if (folders.length == 1) {</span>
<a href="#l8.150"></a><span id="l8.150">           var folder = folders[0];</span>
<a href="#l8.151"></a><span id="l8.151">           if (folder.server.type == &quot;nntp&quot;)</span>
<a href="#l8.152"></a><span id="l8.152">             return false; // Just disable the command for news.</span>
<a href="#l8.153"></a><span id="l8.153">           else</span>
<a href="#l8.154"></a><span id="l8.154">             return CanDeleteFolder(folder);</span>
<a href="#l8.155"></a><span id="l8.155">         }</span>
<a href="#l8.156"></a><span id="l8.156">         return false;</span>
<a href="#l8.157"></a><span id="l8.157">       case &quot;button_junk&quot;:</span>
<a href="#l8.158"></a><span id="l8.158">         UpdateJunkToolbarButton();</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineminus">-        if (gDBView)</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineminus">-          gDBView.getCommandStatus(nsMsgViewCommandType.junk, enabled, checkStatus);</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineminus">-        return enabled.value;</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineplus">+        return gFolderDisplay.getCommandStatus(nsMsgViewCommandType.junk);</span>
<a href="#l8.163"></a><span id="l8.163">       case &quot;cmd_killThread&quot;:</span>
<a href="#l8.164"></a><span id="l8.164">       case &quot;cmd_killSubthread&quot;:</span>
<a href="#l8.165"></a><span id="l8.165">         return GetNumSelectedMessages() &gt; 0;</span>
<a href="#l8.166"></a><span id="l8.166">       case &quot;cmd_watchThread&quot;:</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineminus">-        if (gDBView)</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineminus">-          gDBView.getCommandStatus(nsMsgViewCommandType.toggleThreadWatched, enabled, checkStatus);</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineminus">-        return enabled.value;</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineplus">+        return gFolderDisplay.getCommandStatus(nsMsgViewCommandType.toggleThreadWatched);</span>
<a href="#l8.171"></a><span id="l8.171">       case &quot;cmd_createFilterFromPopup&quot;:</span>
<a href="#l8.172"></a><span id="l8.172">       case &quot;cmd_createFilterFromMenu&quot;:</span>
<a href="#l8.173"></a><span id="l8.173">         var loadedFolder = GetLoadedMsgFolder();</span>
<a href="#l8.174"></a><span id="l8.174">         if (!(loadedFolder &amp;&amp; loadedFolder.server.canHaveFilters))</span>
<a href="#l8.175"></a><span id="l8.175">           return false;   // else fall thru</span>
<a href="#l8.176"></a><span id="l8.176">       case &quot;cmd_saveAsFile&quot;:</span>
<a href="#l8.177"></a><span id="l8.177">       case &quot;cmd_saveAsTemplate&quot;:</span>
<a href="#l8.178"></a><span id="l8.178">         if (GetNumSelectedMessages() &gt; 1)</span>
<a href="#l8.179"></a><span id="l8.179" class="difflineat">@@ -323,30 +314,21 @@ var DefaultController =</span>
<a href="#l8.180"></a><span id="l8.180">         {</span>
<a href="#l8.181"></a><span id="l8.181">           var whichText = &quot;valueMessage&quot;;</span>
<a href="#l8.182"></a><span id="l8.182">           if (GetNumSelectedMessages() &gt; 1)</span>
<a href="#l8.183"></a><span id="l8.183">             whichText = &quot;valueSelection&quot;;</span>
<a href="#l8.184"></a><span id="l8.184">           goSetMenuValue(command, whichText);</span>
<a href="#l8.185"></a><span id="l8.185">           goSetAccessKey(command, whichText + &quot;AccessKey&quot;);</span>
<a href="#l8.186"></a><span id="l8.186">         }</span>
<a href="#l8.187"></a><span id="l8.187">         if (GetNumSelectedMessages() &gt; 0)</span>
<a href="#l8.188"></a><span id="l8.188" class="difflineminus">-        {</span>
<a href="#l8.189"></a><span id="l8.189" class="difflineminus">-          if (gDBView)</span>
<a href="#l8.190"></a><span id="l8.190" class="difflineminus">-          {</span>
<a href="#l8.191"></a><span id="l8.191" class="difflineminus">-            gDBView.getCommandStatus(nsMsgViewCommandType.cmdRequiringMsgBody, enabled, checkStatus);</span>
<a href="#l8.192"></a><span id="l8.192" class="difflineminus">-            return enabled.value;</span>
<a href="#l8.193"></a><span id="l8.193" class="difflineminus">-          }</span>
<a href="#l8.194"></a><span id="l8.194" class="difflineminus">-        }</span>
<a href="#l8.195"></a><span id="l8.195" class="difflineplus">+          return gFolderDisplay.getCommandStatus(nsMsgViewCommandType.cmdRequiringMsgBody);</span>
<a href="#l8.196"></a><span id="l8.196">         return false;</span>
<a href="#l8.197"></a><span id="l8.197">       case &quot;cmd_printpreview&quot;:</span>
<a href="#l8.198"></a><span id="l8.198" class="difflineminus">-        if ( GetNumSelectedMessages() == 1 &amp;&amp; gDBView)</span>
<a href="#l8.199"></a><span id="l8.199" class="difflineminus">-        {</span>
<a href="#l8.200"></a><span id="l8.200" class="difflineminus">-           gDBView.getCommandStatus(nsMsgViewCommandType.cmdRequiringMsgBody, enabled, checkStatus);</span>
<a href="#l8.201"></a><span id="l8.201" class="difflineminus">-           return enabled.value;</span>
<a href="#l8.202"></a><span id="l8.202" class="difflineminus">-        }</span>
<a href="#l8.203"></a><span id="l8.203" class="difflineplus">+        if (GetNumSelectedMessages() == 1)</span>
<a href="#l8.204"></a><span id="l8.204" class="difflineplus">+          return gFolderDisplay.getCommandStatus(nsMsgViewCommandType.cmdRequiringMsgBody);</span>
<a href="#l8.205"></a><span id="l8.205">         return false;</span>
<a href="#l8.206"></a><span id="l8.206">       case &quot;cmd_printSetup&quot;:</span>
<a href="#l8.207"></a><span id="l8.207">         return true;</span>
<a href="#l8.208"></a><span id="l8.208">       case &quot;cmd_markAsFlagged&quot;:</span>
<a href="#l8.209"></a><span id="l8.209">       case &quot;button_file&quot;:</span>
<a href="#l8.210"></a><span id="l8.210">       case &quot;cmd_file&quot;:</span>
<a href="#l8.211"></a><span id="l8.211">       case &quot;cmd_archive&quot;:</span>
<a href="#l8.212"></a><span id="l8.212">         return (GetNumSelectedMessages() &gt; 0 );</span>
<a href="#l8.213"></a><span id="l8.213" class="difflineat">@@ -355,33 +337,27 @@ var DefaultController =</span>
<a href="#l8.214"></a><span id="l8.214">         let folder = GetLoadedMsgFolder();</span>
<a href="#l8.215"></a><span id="l8.215">         return GetNumSelectedMessages() &gt; 0 &amp;&amp; folder &amp;&amp;</span>
<a href="#l8.216"></a><span id="l8.216">           !(IsSpecialFolder(folder, Components.interfaces.nsMsgFolderFlags.Archive,</span>
<a href="#l8.217"></a><span id="l8.217">                             true));</span>
<a href="#l8.218"></a><span id="l8.218">       }</span>
<a href="#l8.219"></a><span id="l8.219">       case &quot;cmd_markAsJunk&quot;:</span>
<a href="#l8.220"></a><span id="l8.220">       case &quot;cmd_markAsNotJunk&quot;:</span>
<a href="#l8.221"></a><span id="l8.221">         // can't do news on junk yet.</span>
<a href="#l8.222"></a><span id="l8.222" class="difflineminus">-        return (GetNumSelectedMessages() &gt; 0 &amp;&amp; !isNewsURI(GetFirstSelectedMessage()));</span>
<a href="#l8.223"></a><span id="l8.223" class="difflineplus">+        return (GetNumSelectedMessages() &gt; 0 &amp;&amp; !gFolderDisplay.selectedMessageIsNews);</span>
<a href="#l8.224"></a><span id="l8.224">       case &quot;cmd_recalculateJunkScore&quot;:</span>
<a href="#l8.225"></a><span id="l8.225">         if (GetNumSelectedMessages() &gt; 0)</span>
<a href="#l8.226"></a><span id="l8.226" class="difflineminus">-          gDBView.getCommandStatus(nsMsgViewCommandType.runJunkControls, enabled, checkStatus);</span>
<a href="#l8.227"></a><span id="l8.227" class="difflineminus">-        return enabled.value;</span>
<a href="#l8.228"></a><span id="l8.228" class="difflineplus">+          return gFolderDisplay.getCommandStatus(nsMsgViewCommandType.runJunkControls);</span>
<a href="#l8.229"></a><span id="l8.229" class="difflineplus">+        return false;</span>
<a href="#l8.230"></a><span id="l8.230">       case &quot;cmd_applyFilters&quot;:</span>
<a href="#l8.231"></a><span id="l8.231" class="difflineminus">-        if (gDBView)</span>
<a href="#l8.232"></a><span id="l8.232" class="difflineminus">-          gDBView.getCommandStatus(nsMsgViewCommandType.applyFilters, enabled, checkStatus);</span>
<a href="#l8.233"></a><span id="l8.233" class="difflineminus">-        return enabled.value;</span>
<a href="#l8.234"></a><span id="l8.234" class="difflineplus">+        return gFolderDisplay.getCommandStatus(nsMsgViewCommandType.applyFilters);</span>
<a href="#l8.235"></a><span id="l8.235">       case &quot;cmd_runJunkControls&quot;:</span>
<a href="#l8.236"></a><span id="l8.236" class="difflineminus">-        if (gDBView)</span>
<a href="#l8.237"></a><span id="l8.237" class="difflineminus">-          gDBView.getCommandStatus(nsMsgViewCommandType.runJunkControls, enabled, checkStatus);</span>
<a href="#l8.238"></a><span id="l8.238" class="difflineminus">-        return enabled.value;</span>
<a href="#l8.239"></a><span id="l8.239" class="difflineplus">+        return gFolderDisplay.getCommandStatus(nsMsgViewCommandType.runJunkControls);</span>
<a href="#l8.240"></a><span id="l8.240">       case &quot;cmd_deleteJunk&quot;:</span>
<a href="#l8.241"></a><span id="l8.241" class="difflineminus">-        if (gDBView)</span>
<a href="#l8.242"></a><span id="l8.242" class="difflineminus">-          gDBView.getCommandStatus(nsMsgViewCommandType.deleteJunk, enabled, checkStatus);</span>
<a href="#l8.243"></a><span id="l8.243" class="difflineminus">-        return enabled.value;</span>
<a href="#l8.244"></a><span id="l8.244" class="difflineplus">+        return gFolderDisplay.getCommandStatus(nsMsgViewCommandType.deleteJunk);</span>
<a href="#l8.245"></a><span id="l8.245">       case &quot;button_mark&quot;:</span>
<a href="#l8.246"></a><span id="l8.246">       case &quot;cmd_tag&quot;:</span>
<a href="#l8.247"></a><span id="l8.247">       case &quot;cmd_markAsRead&quot;:</span>
<a href="#l8.248"></a><span id="l8.248">       case &quot;cmd_markThreadAsRead&quot;:</span>
<a href="#l8.249"></a><span id="l8.249">         return GetNumSelectedMessages() &gt; 0;</span>
<a href="#l8.250"></a><span id="l8.250">       case &quot;button_previous&quot;:</span>
<a href="#l8.251"></a><span id="l8.251">       case &quot;button_next&quot;:</span>
<a href="#l8.252"></a><span id="l8.252">         return IsViewNavigationItemEnabled();</span>
<a href="#l8.253"></a><span id="l8.253" class="difflineat">@@ -413,28 +389,27 @@ var DefaultController =</span>
<a href="#l8.254"></a><span id="l8.254">       case &quot;cmd_selectAll&quot;:</span>
<a href="#l8.255"></a><span id="l8.255">       case &quot;cmd_selectFlagged&quot;:</span>
<a href="#l8.256"></a><span id="l8.256">         return gDBView != null;</span>
<a href="#l8.257"></a><span id="l8.257">       // these are enabled on when we are in threaded mode</span>
<a href="#l8.258"></a><span id="l8.258">       case &quot;cmd_selectThread&quot;:</span>
<a href="#l8.259"></a><span id="l8.259">         if (GetNumSelectedMessages() &lt;= 0) return false;</span>
<a href="#l8.260"></a><span id="l8.260">       case &quot;cmd_expandAllThreads&quot;:</span>
<a href="#l8.261"></a><span id="l8.261">       case &quot;cmd_collapseAllThreads&quot;:</span>
<a href="#l8.262"></a><span id="l8.262" class="difflineminus">-        return gDBView &amp;&amp; (gDBView.viewFlags &amp; nsMsgViewFlagsType.kThreadedDisplay);</span>
<a href="#l8.263"></a><span id="l8.263" class="difflineplus">+        return gFolderDisplay.view.showThreaded;</span>
<a href="#l8.264"></a><span id="l8.264">       case &quot;cmd_nextFlaggedMsg&quot;:</span>
<a href="#l8.265"></a><span id="l8.265">       case &quot;cmd_previousFlaggedMsg&quot;:</span>
<a href="#l8.266"></a><span id="l8.266">         return IsViewNavigationItemEnabled();</span>
<a href="#l8.267"></a><span id="l8.267">       case &quot;cmd_viewAllMsgs&quot;:</span>
<a href="#l8.268"></a><span id="l8.268">       case &quot;cmd_viewUnreadMsgs&quot;:</span>
<a href="#l8.269"></a><span id="l8.269">       case &quot;cmd_viewIgnoredThreads&quot;:</span>
<a href="#l8.270"></a><span id="l8.270">         return gDBView;</span>
<a href="#l8.271"></a><span id="l8.271">       case &quot;cmd_viewThreadsWithUnread&quot;:</span>
<a href="#l8.272"></a><span id="l8.272">       case &quot;cmd_viewWatchedThreadsWithUnread&quot;:</span>
<a href="#l8.273"></a><span id="l8.273" class="difflineminus">-        return gDBView &amp;&amp; !(GetSelectedMsgFolders()[0].flags &amp; </span>
<a href="#l8.274"></a><span id="l8.274" class="difflineminus">-                            Components.interfaces.nsMsgFolderFlags.Virtual);</span>
<a href="#l8.275"></a><span id="l8.275" class="difflineplus">+        return !gFolderDisplay.view.isVirtual;</span>
<a href="#l8.276"></a><span id="l8.276">       case &quot;cmd_stop&quot;:</span>
<a href="#l8.277"></a><span id="l8.277">         return true;</span>
<a href="#l8.278"></a><span id="l8.278">       case &quot;cmd_undo&quot;:</span>
<a href="#l8.279"></a><span id="l8.279">       case &quot;cmd_redo&quot;:</span>
<a href="#l8.280"></a><span id="l8.280">           return SetupUndoRedoCommand(command);</span>
<a href="#l8.281"></a><span id="l8.281">       case &quot;cmd_renameFolder&quot;:</span>
<a href="#l8.282"></a><span id="l8.282">       {</span>
<a href="#l8.283"></a><span id="l8.283">         let folders = gFolderTreeView.getSelectedFolders();</span>
<a href="#l8.284"></a><span id="l8.284" class="difflineat">@@ -564,36 +539,41 @@ var DefaultController =</span>
<a href="#l8.285"></a><span id="l8.285">         break;</span>
<a href="#l8.286"></a><span id="l8.286">       case &quot;cmd_createFilterFromPopup&quot;:</span>
<a href="#l8.287"></a><span id="l8.287">         break;// This does nothing because the createfilter is invoked from the popupnode oncommand.</span>
<a href="#l8.288"></a><span id="l8.288">       case &quot;button_delete&quot;:</span>
<a href="#l8.289"></a><span id="l8.289">       case &quot;cmd_delete&quot;:</span>
<a href="#l8.290"></a><span id="l8.290">          // if the user deletes a message before its mark as read timer goes off, we should mark it as read</span>
<a href="#l8.291"></a><span id="l8.291">          // this ensures that we clear the biff indicator from the system tray when the user deletes the new message</span>
<a href="#l8.292"></a><span id="l8.292">         MarkSelectedMessagesRead(true);</span>
<a href="#l8.293"></a><span id="l8.293" class="difflineminus">-        SetNextMessageAfterDelete();</span>
<a href="#l8.294"></a><span id="l8.294" class="difflineminus">-        gDBView.doCommand(nsMsgViewCommandType.deleteMsg);</span>
<a href="#l8.295"></a><span id="l8.295" class="difflineplus">+        // If this is a right-click triggered delete, then do not hint about</span>
<a href="#l8.296"></a><span id="l8.296" class="difflineplus">+        //  the deletion.  Note: The code that swaps the selection back in will</span>
<a href="#l8.297"></a><span id="l8.297" class="difflineplus">+        //  take care of ensuring that this deletion does not make the saved</span>
<a href="#l8.298"></a><span id="l8.298" class="difflineplus">+        //  selection incorrect.</span>
<a href="#l8.299"></a><span id="l8.299" class="difflineplus">+        if (!gRightMouseButtonSavedSelection)</span>
<a href="#l8.300"></a><span id="l8.300" class="difflineplus">+          gFolderDisplay.hintAboutToDeleteMessages();</span>
<a href="#l8.301"></a><span id="l8.301" class="difflineplus">+        gFolderDisplay.doCommand(nsMsgViewCommandType.deleteMsg);</span>
<a href="#l8.302"></a><span id="l8.302">         break;</span>
<a href="#l8.303"></a><span id="l8.303">       case &quot;cmd_shiftDelete&quot;:</span>
<a href="#l8.304"></a><span id="l8.304">         MarkSelectedMessagesRead(true);</span>
<a href="#l8.305"></a><span id="l8.305" class="difflineminus">-        SetNextMessageAfterDelete();</span>
<a href="#l8.306"></a><span id="l8.306" class="difflineminus">-        gDBView.doCommand(nsMsgViewCommandType.deleteNoTrash);</span>
<a href="#l8.307"></a><span id="l8.307" class="difflineplus">+        gFolderDisplay.hintAboutToDeleteMessages();</span>
<a href="#l8.308"></a><span id="l8.308" class="difflineplus">+        gFolderDisplay.doCommand(nsMsgViewCommandType.deleteNoTrash);</span>
<a href="#l8.309"></a><span id="l8.309">         break;</span>
<a href="#l8.310"></a><span id="l8.310">       case &quot;cmd_deleteFolder&quot;:</span>
<a href="#l8.311"></a><span id="l8.311">         gFolderTreeController.deleteFolder();</span>
<a href="#l8.312"></a><span id="l8.312">         break;</span>
<a href="#l8.313"></a><span id="l8.313">       case &quot;cmd_killThread&quot;:</span>
<a href="#l8.314"></a><span id="l8.314">         /* kill thread kills the thread and then does a next unread */</span>
<a href="#l8.315"></a><span id="l8.315">         GoNextMessage(nsMsgNavigationType.toggleThreadKilled, true);</span>
<a href="#l8.316"></a><span id="l8.316">         break;</span>
<a href="#l8.317"></a><span id="l8.317">       case &quot;cmd_killSubthread&quot;:</span>
<a href="#l8.318"></a><span id="l8.318">         GoNextMessage(nsMsgNavigationType.toggleSubthreadKilled, true);</span>
<a href="#l8.319"></a><span id="l8.319">         break;</span>
<a href="#l8.320"></a><span id="l8.320">       case &quot;cmd_watchThread&quot;:</span>
<a href="#l8.321"></a><span id="l8.321" class="difflineminus">-        gDBView.doCommand(nsMsgViewCommandType.toggleThreadWatched);</span>
<a href="#l8.322"></a><span id="l8.322" class="difflineplus">+        gFolderDisplay.doCommand(nsMsgViewCommandType.toggleThreadWatched);</span>
<a href="#l8.323"></a><span id="l8.323">         break;</span>
<a href="#l8.324"></a><span id="l8.324">       case &quot;button_next&quot;:</span>
<a href="#l8.325"></a><span id="l8.325">       case &quot;cmd_nextUnreadMsg&quot;:</span>
<a href="#l8.326"></a><span id="l8.326">         GoNextMessage(nsMsgNavigationType.nextUnreadMessage, true);</span>
<a href="#l8.327"></a><span id="l8.327">         break;</span>
<a href="#l8.328"></a><span id="l8.328">       case &quot;cmd_nextUnreadThread&quot;:</span>
<a href="#l8.329"></a><span id="l8.329">         GoNextMessage(nsMsgNavigationType.nextUnreadThread, true);</span>
<a href="#l8.330"></a><span id="l8.330">         break;</span>
<a href="#l8.331"></a><span id="l8.331" class="difflineat">@@ -634,20 +614,23 @@ var DefaultController =</span>
<a href="#l8.332"></a><span id="l8.332">         break;</span>
<a href="#l8.333"></a><span id="l8.333">       case &quot;cmd_undo&quot;:</span>
<a href="#l8.334"></a><span id="l8.334">         messenger.undo(msgWindow);</span>
<a href="#l8.335"></a><span id="l8.335">         break;</span>
<a href="#l8.336"></a><span id="l8.336">       case &quot;cmd_redo&quot;:</span>
<a href="#l8.337"></a><span id="l8.337">         messenger.redo(msgWindow);</span>
<a href="#l8.338"></a><span id="l8.338">         break;</span>
<a href="#l8.339"></a><span id="l8.339">       case &quot;cmd_expandAllThreads&quot;:</span>
<a href="#l8.340"></a><span id="l8.340" class="difflineminus">-        gDBView.doCommand(nsMsgViewCommandType.expandAll);</span>
<a href="#l8.341"></a><span id="l8.341" class="difflineplus">+        gFolderDisplay.doCommand(nsMsgViewCommandType.expandAll);</span>
<a href="#l8.342"></a><span id="l8.342" class="difflineplus">+        gFolderDisplay.ensureSelectionIsVisible();</span>
<a href="#l8.343"></a><span id="l8.343">         break;</span>
<a href="#l8.344"></a><span id="l8.344">       case &quot;cmd_collapseAllThreads&quot;:</span>
<a href="#l8.345"></a><span id="l8.345" class="difflineminus">-        gDBView.doCommand(nsMsgViewCommandType.collapseAll);</span>
<a href="#l8.346"></a><span id="l8.346" class="difflineplus">+        gFolderDisplay.selectSelectedThreadRoots();</span>
<a href="#l8.347"></a><span id="l8.347" class="difflineplus">+        gFolderDisplay.doCommand(nsMsgViewCommandType.collapseAll);</span>
<a href="#l8.348"></a><span id="l8.348" class="difflineplus">+        gFolderDisplay.ensureSelectionIsVisible();</span>
<a href="#l8.349"></a><span id="l8.349">         break;</span>
<a href="#l8.350"></a><span id="l8.350">       case &quot;cmd_renameFolder&quot;:</span>
<a href="#l8.351"></a><span id="l8.351">         gFolderTreeController.renameFolder();</span>
<a href="#l8.352"></a><span id="l8.352">         return;</span>
<a href="#l8.353"></a><span id="l8.353">       case &quot;cmd_sendUnsentMsgs&quot;:</span>
<a href="#l8.354"></a><span id="l8.354">         // if offline, prompt for sendUnsentMessages</span>
<a href="#l8.355"></a><span id="l8.355">         if (MailOfflineMgr.isOnline())</span>
<a href="#l8.356"></a><span id="l8.356">           SendUnsentMessages();</span>
<a href="#l8.357"></a><span id="l8.357" class="difflineat">@@ -668,17 +651,17 @@ var DefaultController =</span>
<a href="#l8.358"></a><span id="l8.358">         return;</span>
<a href="#l8.359"></a><span id="l8.359">       case &quot;cmd_saveAsFile&quot;:</span>
<a href="#l8.360"></a><span id="l8.360">         MsgSaveAsFile();</span>
<a href="#l8.361"></a><span id="l8.361">         return;</span>
<a href="#l8.362"></a><span id="l8.362">       case &quot;cmd_saveAsTemplate&quot;:</span>
<a href="#l8.363"></a><span id="l8.363">         MsgSaveAsTemplate();</span>
<a href="#l8.364"></a><span id="l8.364">         return;</span>
<a href="#l8.365"></a><span id="l8.365">       case &quot;cmd_viewPageSource&quot;:</span>
<a href="#l8.366"></a><span id="l8.366" class="difflineminus">-        ViewPageSource(GetSelectedMessages());</span>
<a href="#l8.367"></a><span id="l8.367" class="difflineplus">+        ViewPageSource(gFolderDisplay.selectedMessageUris);</span>
<a href="#l8.368"></a><span id="l8.368">         return;</span>
<a href="#l8.369"></a><span id="l8.369">       case &quot;cmd_setFolderCharset&quot;:</span>
<a href="#l8.370"></a><span id="l8.370">         gFolderTreeController.editFolder();</span>
<a href="#l8.371"></a><span id="l8.371">         return;</span>
<a href="#l8.372"></a><span id="l8.372">       case &quot;cmd_reload&quot;:</span>
<a href="#l8.373"></a><span id="l8.373">         ReloadMessage();</span>
<a href="#l8.374"></a><span id="l8.374">         return;</span>
<a href="#l8.375"></a><span id="l8.375">       case &quot;cmd_find&quot;:</span>
<a href="#l8.376"></a><span id="l8.376" class="difflineat">@@ -709,20 +692,20 @@ var DefaultController =</span>
<a href="#l8.377"></a><span id="l8.377">         MsgSearchMessages();</span>
<a href="#l8.378"></a><span id="l8.378">         return;</span>
<a href="#l8.379"></a><span id="l8.379">       case &quot;button_mark&quot;:</span>
<a href="#l8.380"></a><span id="l8.380">       case &quot;cmd_markAsRead&quot;:</span>
<a href="#l8.381"></a><span id="l8.381">         MsgMarkMsgAsRead();</span>
<a href="#l8.382"></a><span id="l8.382">         return;</span>
<a href="#l8.383"></a><span id="l8.383">       case &quot;cmd_markThreadAsRead&quot;:</span>
<a href="#l8.384"></a><span id="l8.384">         ClearPendingReadTimer();</span>
<a href="#l8.385"></a><span id="l8.385" class="difflineminus">-        gDBView.doCommand(nsMsgViewCommandType.markThreadRead);</span>
<a href="#l8.386"></a><span id="l8.386" class="difflineplus">+        gFolderDisplay.doCommand(nsMsgViewCommandType.markThreadRead);</span>
<a href="#l8.387"></a><span id="l8.387">         return;</span>
<a href="#l8.388"></a><span id="l8.388">       case &quot;cmd_markAllRead&quot;:</span>
<a href="#l8.389"></a><span id="l8.389" class="difflineminus">-        gDBView.doCommand(nsMsgViewCommandType.markAllRead);</span>
<a href="#l8.390"></a><span id="l8.390" class="difflineplus">+        gFolderDisplay.doCommand(nsMsgViewCommandType.markAllRead);</span>
<a href="#l8.391"></a><span id="l8.391">         return;</span>
<a href="#l8.392"></a><span id="l8.392">       case &quot;button_junk&quot;:</span>
<a href="#l8.393"></a><span id="l8.393">         MsgJunk();</span>
<a href="#l8.394"></a><span id="l8.394">         return;</span>
<a href="#l8.395"></a><span id="l8.395">       case &quot;cmd_stop&quot;:</span>
<a href="#l8.396"></a><span id="l8.396">         msgWindow.StopUrls();</span>
<a href="#l8.397"></a><span id="l8.397">         return;</span>
<a href="#l8.398"></a><span id="l8.398">       case &quot;cmd_markAsFlagged&quot;:</span>
<a href="#l8.399"></a><span id="l8.399" class="difflineat">@@ -754,20 +737,20 @@ var DefaultController =</span>
<a href="#l8.400"></a><span id="l8.400">         return;</span>
<a href="#l8.401"></a><span id="l8.401">       case &quot;cmd_compactFolder&quot;:</span>
<a href="#l8.402"></a><span id="l8.402">         gFolderTreeController.compactAllFoldersForAccount();</span>
<a href="#l8.403"></a><span id="l8.403">         return;</span>
<a href="#l8.404"></a><span id="l8.404">       case &quot;button_compact&quot;:</span>
<a href="#l8.405"></a><span id="l8.405">         gFolderTreeController.compactFolders();</span>
<a href="#l8.406"></a><span id="l8.406">         return;</span>
<a href="#l8.407"></a><span id="l8.407">       case &quot;cmd_downloadFlagged&quot;:</span>
<a href="#l8.408"></a><span id="l8.408" class="difflineminus">-          gDBView.doCommand(nsMsgViewCommandType.downloadFlaggedForOffline);</span>
<a href="#l8.409"></a><span id="l8.409" class="difflineplus">+          gFolderDisplay.doCommand(nsMsgViewCommandType.downloadFlaggedForOffline);</span>
<a href="#l8.410"></a><span id="l8.410">           break;</span>
<a href="#l8.411"></a><span id="l8.411">       case &quot;cmd_downloadSelected&quot;:</span>
<a href="#l8.412"></a><span id="l8.412" class="difflineminus">-          gDBView.doCommand(nsMsgViewCommandType.downloadSelectedForOffline);</span>
<a href="#l8.413"></a><span id="l8.413" class="difflineplus">+          gFolderDisplay.doCommand(nsMsgViewCommandType.downloadSelectedForOffline);</span>
<a href="#l8.414"></a><span id="l8.414">           break;</span>
<a href="#l8.415"></a><span id="l8.415">       case &quot;cmd_synchronizeOffline&quot;:</span>
<a href="#l8.416"></a><span id="l8.416">           MsgSynchronizeOffline();</span>
<a href="#l8.417"></a><span id="l8.417">           break;</span>
<a href="#l8.418"></a><span id="l8.418">       case &quot;cmd_settingsOffline&quot;:</span>
<a href="#l8.419"></a><span id="l8.419">           MailOfflineMgr.openOfflineAccountSettings();</span>
<a href="#l8.420"></a><span id="l8.420">           break;</span>
<a href="#l8.421"></a><span id="l8.421">       case &quot;cmd_moveToFolderAgain&quot;:</span>
<a href="#l8.422"></a><span id="l8.422" class="difflineat">@@ -776,27 +759,23 @@ var DefaultController =</span>
<a href="#l8.423"></a><span id="l8.423">             MsgMoveMessage(GetMsgFolderFromUri(folderId));</span>
<a href="#l8.424"></a><span id="l8.424">           else</span>
<a href="#l8.425"></a><span id="l8.425">             MsgCopyMessage(GetMsgFolderFromUri(folderId));</span>
<a href="#l8.426"></a><span id="l8.426">           break;</span>
<a href="#l8.427"></a><span id="l8.427">       case &quot;cmd_selectAll&quot;:</span>
<a href="#l8.428"></a><span id="l8.428">           // move the focus so the user can delete the newly selected messages, not the folder</span>
<a href="#l8.429"></a><span id="l8.429">           SetFocusThreadPane();</span>
<a href="#l8.430"></a><span id="l8.430">           // if in threaded mode, the view will expand all before selecting all</span>
<a href="#l8.431"></a><span id="l8.431" class="difflineminus">-          gDBView.doCommand(nsMsgViewCommandType.selectAll)</span>
<a href="#l8.432"></a><span id="l8.432" class="difflineminus">-          if (gDBView.numSelected != 1) {</span>
<a href="#l8.433"></a><span id="l8.433" class="difflineminus">-              setTitleFromFolder(gDBView.msgFolder,null);</span>
<a href="#l8.434"></a><span id="l8.434" class="difflineminus">-              ClearMessagePane();</span>
<a href="#l8.435"></a><span id="l8.435" class="difflineminus">-          }</span>
<a href="#l8.436"></a><span id="l8.436" class="difflineplus">+          gFolderDisplay.doCommand(nsMsgViewCommandType.selectAll);</span>
<a href="#l8.437"></a><span id="l8.437">           break;</span>
<a href="#l8.438"></a><span id="l8.438">       case &quot;cmd_selectThread&quot;:</span>
<a href="#l8.439"></a><span id="l8.439" class="difflineminus">-          gDBView.doCommand(nsMsgViewCommandType.selectThread);</span>
<a href="#l8.440"></a><span id="l8.440" class="difflineplus">+          gFolderDisplay.doCommand(nsMsgViewCommandType.selectThread);</span>
<a href="#l8.441"></a><span id="l8.441">           break;</span>
<a href="#l8.442"></a><span id="l8.442">       case &quot;cmd_selectFlagged&quot;:</span>
<a href="#l8.443"></a><span id="l8.443" class="difflineminus">-        gDBView.doCommand(nsMsgViewCommandType.selectFlagged);</span>
<a href="#l8.444"></a><span id="l8.444" class="difflineplus">+        gFolderDisplay.doCommand(nsMsgViewCommandType.selectFlagged);</span>
<a href="#l8.445"></a><span id="l8.445">         break;</span>
<a href="#l8.446"></a><span id="l8.446">       case &quot;cmd_fullZoomReduce&quot;:</span>
<a href="#l8.447"></a><span id="l8.447">         ZoomManager.reduce();</span>
<a href="#l8.448"></a><span id="l8.448">         break;</span>
<a href="#l8.449"></a><span id="l8.449">       case &quot;cmd_fullZoomEnlarge&quot;:</span>
<a href="#l8.450"></a><span id="l8.450">         ZoomManager.enlarge();</span>
<a href="#l8.451"></a><span id="l8.451">         break;</span>
<a href="#l8.452"></a><span id="l8.452">       case &quot;cmd_fullZoomReset&quot;:</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/base/content/mailContextMenus.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/base/content/mailContextMenus.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1,113 +1,77 @@</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineminus">-# -*- Mode: C; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineminus">-#</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineminus">-# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineminus">-# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineminus">-#</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineminus">-# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineminus">-# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineminus">-# the License. You may obtain a copy of the License at</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-# http://www.mozilla.org/MPL/</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-#</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineminus">-# for the specific language governing rights and limitations under the</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineminus">-# License.</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">-#</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineminus">-# The Original Code is Mozilla Communicator client code, released</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineminus">-# March 31, 1998.</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">-#</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">-# The Initial Developer of the Original Code is</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineminus">-# Netscape Communications Corporation.</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineminus">-# Portions created by the Initial Developer are Copyright (C) 2000</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineminus">-# the Initial Developer. All Rights Reserved.</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineminus">-#</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">-# Contributor(s):</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">-#   Jan Varga &lt;varga@nixcorp.com&gt;</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">-#   Hakan Waara &lt;hwaara@chello.se&gt;</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-#   Markus Hossner &lt;markushossner@gmx.de&gt;</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-#   Magnus Melin &lt;mkmelin+mozilla@iki.fi&gt;</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineminus">-#</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineminus">-# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineminus">-# either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">-# the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">-# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineminus">-# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">-# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineminus">-# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineminus">-# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineminus">-# the provisions above, a recipient may use your version of this file under</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineminus">-# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineminus">-#</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineminus">-# ***** END LICENSE BLOCK *****</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+ *</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+ *</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+ * License.</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+ *</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+ * The Original Code is Mozilla Communicator client code, released</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineplus">+ * March 31, 1998.</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+ *</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineplus">+ * Netscape Communications Corporation.</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2000</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineplus">+ *</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineplus">+ * Contributor(s):</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineplus">+ *   Jan Varga &lt;varga@nixcorp.com&gt;</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineplus">+ *   Hakan Waara &lt;hwaara@chello.se&gt;</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineplus">+ *   Markus Hossner &lt;markushossner@gmx.de&gt;</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineplus">+ *   Magnus Melin &lt;mkmelin+mozilla@iki.fi&gt;</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineplus">+ *</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineplus">+ *</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l9.86"></a><span id="l9.86"> </span>
<a href="#l9.87"></a><span id="l9.87"> //NOTE: gMessengerBundle must be defined and set or this Overlay won't work</span>
<a href="#l9.88"></a><span id="l9.88"> </span>
<a href="#l9.89"></a><span id="l9.89"> Components.utils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l9.90"></a><span id="l9.90"> </span>
<a href="#l9.91"></a><span id="l9.91"> const mailtolength = 7;</span>
<a href="#l9.92"></a><span id="l9.92"> </span>
<a href="#l9.93"></a><span id="l9.93"> /**</span>
<a href="#l9.94"></a><span id="l9.94">  * Function to change the highlighted row back to the row that is currently</span>
<a href="#l9.95"></a><span id="l9.95">  * outline/dotted without loading the contents of either rows. This is</span>
<a href="#l9.96"></a><span id="l9.96">  * triggered when the context menu for a given row is hidden/closed</span>
<a href="#l9.97"></a><span id="l9.97">  * (onpopuphiding).</span>
<a href="#l9.98"></a><span id="l9.98">  * @param tree the tree element to restore selection for</span>
<a href="#l9.99"></a><span id="l9.99">  */</span>
<a href="#l9.100"></a><span id="l9.100"> function RestoreSelectionWithoutContentLoad(tree)</span>
<a href="#l9.101"></a><span id="l9.101"> {</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineminus">-    if (!tree)</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineminus">-      return;</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineminus">-</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineminus">-    // If a delete or move command had been issued, then we should</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineminus">-    // reset gRightMouseButtonDown and gThreadPaneDeleteOrMoveOccurred</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineminus">-    // and return (see bug 142065).</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineminus">-    if(gThreadPaneDeleteOrMoveOccurred)</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineminus">-    {</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineminus">-      gRightMouseButtonDown = false;</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineminus">-      gThreadPaneDeleteOrMoveOccurred = false;</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineminus">-      return;</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineminus">-    }</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineminus">-</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineminus">-    var treeSelection = tree.view.selection;</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineminus">-</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineminus">-    // make sure that currentIndex is valid so that we don't try to restore</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineminus">-    // a selection of an invalid row.</span>
<a href="#l9.119"></a><span id="l9.119" class="difflineminus">-    if((!treeSelection.isSelected(treeSelection.currentIndex)) &amp;&amp;</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineminus">-       (treeSelection.currentIndex &gt;= 0))</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineminus">-    {</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineminus">-        treeSelection.selectEventsSuppressed = true;</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineminus">-        treeSelection.select(treeSelection.currentIndex);</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineminus">-        treeSelection.selectEventsSuppressed = false;</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineplus">+  if (gRightMouseButtonSavedSelection) {</span>
<a href="#l9.126"></a><span id="l9.126" class="difflineplus">+    let view = gRightMouseButtonSavedSelection.view;</span>
<a href="#l9.127"></a><span id="l9.127" class="difflineplus">+    // restore the selection</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineplus">+    let transientSelection = gRightMouseButtonSavedSelection.transientSelection;</span>
<a href="#l9.129"></a><span id="l9.129" class="difflineplus">+    let realSelection = gRightMouseButtonSavedSelection.realSelection;</span>
<a href="#l9.130"></a><span id="l9.130" class="difflineplus">+    view.selection = realSelection;</span>
<a href="#l9.131"></a><span id="l9.131" class="difflineplus">+    // replay any calls to adjustSelection, this handles suppression.</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineplus">+    transientSelection.replayAdjustSelectionLog(realSelection);</span>
<a href="#l9.133"></a><span id="l9.133" class="difflineplus">+    gRightMouseButtonSavedSelection = null;</span>
<a href="#l9.134"></a><span id="l9.134"> </span>
<a href="#l9.135"></a><span id="l9.135" class="difflineminus">-        // Keep track of which row in the thread pane is currently selected.</span>
<a href="#l9.136"></a><span id="l9.136" class="difflineminus">-        // This is currently only needed when deleting messages.  See</span>
<a href="#l9.137"></a><span id="l9.137" class="difflineminus">-        // declaration of var in msgMail3PaneWindow.js.</span>
<a href="#l9.138"></a><span id="l9.138" class="difflineminus">-        if(tree.id == &quot;threadTree&quot;)</span>
<a href="#l9.139"></a><span id="l9.139" class="difflineminus">-          gThreadPaneCurrentSelectedIndex = treeSelection.currentIndex;</span>
<a href="#l9.140"></a><span id="l9.140" class="difflineminus">-    }</span>
<a href="#l9.141"></a><span id="l9.141" class="difflineminus">-    else if(treeSelection.currentIndex &lt; 0)</span>
<a href="#l9.142"></a><span id="l9.142" class="difflineminus">-        // Clear the selection in the case of when a folder has just been</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineminus">-        // loaded where the message pane does not have a message loaded yet.</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineminus">-        // When right-clicking a message in this case and dismissing the</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineminus">-        // popup menu (by either executing a menu command or clicking</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineminus">-        // somewhere else),  the selection needs to be cleared.</span>
<a href="#l9.147"></a><span id="l9.147" class="difflineminus">-        // However, if the 'Delete Message' or 'Move To' menu item has been</span>
<a href="#l9.148"></a><span id="l9.148" class="difflineminus">-        // selected, DO NOT clear the selection, else it will prevent the</span>
<a href="#l9.149"></a><span id="l9.149" class="difflineminus">-        // tree view from refreshing.</span>
<a href="#l9.150"></a><span id="l9.150" class="difflineminus">-        treeSelection.clearSelection();</span>
<a href="#l9.151"></a><span id="l9.151" class="difflineminus">-</span>
<a href="#l9.152"></a><span id="l9.152" class="difflineminus">-    // Need to reset gRightMouseButtonDown to false here because</span>
<a href="#l9.153"></a><span id="l9.153" class="difflineminus">-    // TreeOnMouseDown() is only called on a mousedown, not on a key down.</span>
<a href="#l9.154"></a><span id="l9.154" class="difflineminus">-    // So resetting it here allows the loading of messages in the messagepane</span>
<a href="#l9.155"></a><span id="l9.155" class="difflineminus">-    // when navigating via the keyboard or the toolbar buttons *after*</span>
<a href="#l9.156"></a><span id="l9.156" class="difflineminus">-    // the context menu has been dismissed.</span>
<a href="#l9.157"></a><span id="l9.157" class="difflineminus">-    gRightMouseButtonDown = false;</span>
<a href="#l9.158"></a><span id="l9.158" class="difflineplus">+    if (tree)</span>
<a href="#l9.159"></a><span id="l9.159" class="difflineplus">+      tree.treeBoxObject.invalidate();</span>
<a href="#l9.160"></a><span id="l9.160" class="difflineplus">+  }</span>
<a href="#l9.161"></a><span id="l9.161"> }</span>
<a href="#l9.162"></a><span id="l9.162"> </span>
<a href="#l9.163"></a><span id="l9.163"> /**</span>
<a href="#l9.164"></a><span id="l9.164">  * Function to clear out the global nsContextMenu, and in the case when we</span>
<a href="#l9.165"></a><span id="l9.165">  * were a threadpane context menu, restore the selection so that a right-click</span>
<a href="#l9.166"></a><span id="l9.166">  * on a non-selected row doesn't move the selection.</span>
<a href="#l9.167"></a><span id="l9.167">  * @param event the onpopuphiding event</span>
<a href="#l9.168"></a><span id="l9.168">  */</span>
<a href="#l9.169"></a><span id="l9.169" class="difflineat">@@ -149,18 +113,18 @@ function fillMailContextMenu(event)</span>
<a href="#l9.170"></a><span id="l9.170"> </span>
<a href="#l9.171"></a><span id="l9.171">   var numSelected = GetNumSelectedMessages();</span>
<a href="#l9.172"></a><span id="l9.172">   if (numSelected == 0)</span>
<a href="#l9.173"></a><span id="l9.173">     return false; // Don't show the context menu if no items are selected.</span>
<a href="#l9.174"></a><span id="l9.174"> </span>
<a href="#l9.175"></a><span id="l9.175">   var inThreadPane = popupNodeIsInThreadPane();</span>
<a href="#l9.176"></a><span id="l9.176">   gContextMenu = new nsContextMenu(event.target);</span>
<a href="#l9.177"></a><span id="l9.177"> </span>
<a href="#l9.178"></a><span id="l9.178" class="difflineminus">-  var selectedMessage = GetFirstSelectedMessage();</span>
<a href="#l9.179"></a><span id="l9.179" class="difflineminus">-  var isNewsgroup = IsNewsMessage(selectedMessage);</span>
<a href="#l9.180"></a><span id="l9.180" class="difflineplus">+  var selectedMessage = gFolderDisplay.selectedMessage;</span>
<a href="#l9.181"></a><span id="l9.181" class="difflineplus">+  var isNewsgroup = gFolderDisplay.selectedMessageIsNews;</span>
<a href="#l9.182"></a><span id="l9.182"> </span>
<a href="#l9.183"></a><span id="l9.183">   // Clear the global var used to keep track if a 'Delete Message' or 'Move</span>
<a href="#l9.184"></a><span id="l9.184">   // To' command has been triggered via the thread pane context menu.</span>
<a href="#l9.185"></a><span id="l9.185">   gThreadPaneDeleteOrMoveOccurred = false;</span>
<a href="#l9.186"></a><span id="l9.186"> </span>
<a href="#l9.187"></a><span id="l9.187">   // Don't show mail items for links/images, just show related items.</span>
<a href="#l9.188"></a><span id="l9.188">   var hideMailItems = !inThreadPane &amp;&amp;</span>
<a href="#l9.189"></a><span id="l9.189">                       (gContextMenu.onImage || gContextMenu.onLink);</span>
<a href="#l9.190"></a><span id="l9.190" class="difflineat">@@ -227,21 +191,20 @@ function fillMailContextMenu(event)</span>
<a href="#l9.191"></a><span id="l9.191"> </span>
<a href="#l9.192"></a><span id="l9.192">   ShowMenuItem(&quot;paneContext-afterMove&quot;, !inThreadPane);</span>
<a href="#l9.193"></a><span id="l9.193"> </span>
<a href="#l9.194"></a><span id="l9.194">   ShowMenuItem(&quot;mailContext-tags&quot;, !hideMailItems &amp;&amp; msgFolder);</span>
<a href="#l9.195"></a><span id="l9.195"> </span>
<a href="#l9.196"></a><span id="l9.196">   ShowMenuItem(&quot;mailContext-mark&quot;, !hideMailItems &amp;&amp; msgFolder);</span>
<a href="#l9.197"></a><span id="l9.197"> </span>
<a href="#l9.198"></a><span id="l9.198">   setSingleSelection(&quot;mailContext-saveAs&quot;);</span>
<a href="#l9.199"></a><span id="l9.199" class="difflineminus">-#ifdef XP_MACOSX</span>
<a href="#l9.200"></a><span id="l9.200" class="difflineminus">-  ShowMenuItem(&quot;mailContext-printpreview&quot;, false);</span>
<a href="#l9.201"></a><span id="l9.201" class="difflineminus">-#else</span>
<a href="#l9.202"></a><span id="l9.202" class="difflineminus">-  setSingleSelection(&quot;mailContext-printpreview&quot;);</span>
<a href="#l9.203"></a><span id="l9.203" class="difflineminus">-#endif</span>
<a href="#l9.204"></a><span id="l9.204" class="difflineplus">+  if (gPlatformOSX)</span>
<a href="#l9.205"></a><span id="l9.205" class="difflineplus">+    ShowMenuItem(&quot;mailContext-printpreview&quot;, false);</span>
<a href="#l9.206"></a><span id="l9.206" class="difflineplus">+  else</span>
<a href="#l9.207"></a><span id="l9.207" class="difflineplus">+    setSingleSelection(&quot;mailContext-printpreview&quot;);</span>
<a href="#l9.208"></a><span id="l9.208"> </span>
<a href="#l9.209"></a><span id="l9.209">   ShowMenuItem(&quot;mailContext-print&quot;, !hideMailItems);</span>
<a href="#l9.210"></a><span id="l9.210"> </span>
<a href="#l9.211"></a><span id="l9.211">   ShowMenuItem(&quot;mailContext-delete&quot;, !hideMailItems &amp;&amp; (isNewsgroup || canMove));</span>
<a href="#l9.212"></a><span id="l9.212">   // This function is needed for the case where a folder is just loaded (while</span>
<a href="#l9.213"></a><span id="l9.213">   // there isn't a message loaded in the message pane), a right-click is done</span>
<a href="#l9.214"></a><span id="l9.214">   // in the thread pane.  This function will disable enable the 'Delete</span>
<a href="#l9.215"></a><span id="l9.215">   // Message' menu item.</span>
<a href="#l9.216"></a><span id="l9.216" class="difflineat">@@ -390,21 +353,19 @@ function OpenMessageForMessageId(message</span>
<a href="#l9.217"></a><span id="l9.217"> </span>
<a href="#l9.218"></a><span id="l9.218"> function OpenMessageByHeader(messageHeader, openInNewWindow)</span>
<a href="#l9.219"></a><span id="l9.219"> {</span>
<a href="#l9.220"></a><span id="l9.220">   var folder    = messageHeader.folder;</span>
<a href="#l9.221"></a><span id="l9.221">   var folderURI = folder.URI;</span>
<a href="#l9.222"></a><span id="l9.222"> </span>
<a href="#l9.223"></a><span id="l9.223">   if (openInNewWindow)</span>
<a href="#l9.224"></a><span id="l9.224">   {</span>
<a href="#l9.225"></a><span id="l9.225" class="difflineminus">-    var messageURI = folder.getUriForMsg(messageHeader);</span>
<a href="#l9.226"></a><span id="l9.226" class="difflineminus">-</span>
<a href="#l9.227"></a><span id="l9.227">     window.openDialog(&quot;chrome://messenger/content/messageWindow.xul&quot;,</span>
<a href="#l9.228"></a><span id="l9.228">                       &quot;_blank&quot;, &quot;all,chrome,dialog=no,status,toolbar&quot;,</span>
<a href="#l9.229"></a><span id="l9.229" class="difflineminus">-                      messageURI, folderURI, null);</span>
<a href="#l9.230"></a><span id="l9.230" class="difflineplus">+                      messageHeader);</span>
<a href="#l9.231"></a><span id="l9.231">   }</span>
<a href="#l9.232"></a><span id="l9.232">   else</span>
<a href="#l9.233"></a><span id="l9.233">   {</span>
<a href="#l9.234"></a><span id="l9.234">     if (msgWindow.openFolder != folderURI)</span>
<a href="#l9.235"></a><span id="l9.235">       gFolderTreeView.selectFolder(folder);</span>
<a href="#l9.236"></a><span id="l9.236"> </span>
<a href="#l9.237"></a><span id="l9.237">     var tree = null;</span>
<a href="#l9.238"></a><span id="l9.238">     var wintype = document.documentElement.getAttribute('windowtype');</span>
<a href="#l9.239"></a><span id="l9.239" class="difflineat">@@ -728,17 +689,17 @@ function SetMenuItemLabel(id, label)</span>
<a href="#l9.240"></a><span id="l9.240"> }</span>
<a href="#l9.241"></a><span id="l9.241"> </span>
<a href="#l9.242"></a><span id="l9.242"> // helper function used by shouldShowSeparator</span>
<a href="#l9.243"></a><span id="l9.243"> function hasAVisibleNextSibling(aNode)</span>
<a href="#l9.244"></a><span id="l9.244"> {</span>
<a href="#l9.245"></a><span id="l9.245">   var sibling = aNode.nextSibling;</span>
<a href="#l9.246"></a><span id="l9.246">   while (sibling)</span>
<a href="#l9.247"></a><span id="l9.247">   {</span>
<a href="#l9.248"></a><span id="l9.248" class="difflineminus">-    if (sibling.getAttribute(&quot;hidden&quot;) != &quot;true&quot; </span>
<a href="#l9.249"></a><span id="l9.249" class="difflineplus">+    if (sibling.getAttribute(&quot;hidden&quot;) != &quot;true&quot;</span>
<a href="#l9.250"></a><span id="l9.250">         &amp;&amp; sibling.localName != &quot;menuseparator&quot;)</span>
<a href="#l9.251"></a><span id="l9.251">       return true;</span>
<a href="#l9.252"></a><span id="l9.252">     sibling = sibling.nextSibling;</span>
<a href="#l9.253"></a><span id="l9.253">   }</span>
<a href="#l9.254"></a><span id="l9.254">   return false;</span>
<a href="#l9.255"></a><span id="l9.255"> }</span>
<a href="#l9.256"></a><span id="l9.256"> </span>
<a href="#l9.257"></a><span id="l9.257"> function IsMenuItemShowing(menuID)</span>
<a href="#l9.258"></a><span id="l9.258" class="difflineat">@@ -770,24 +731,24 @@ function composeEmailTo ()</span>
<a href="#l9.259"></a><span id="l9.259">   params.type = Components.interfaces.nsIMsgCompType.New;</span>
<a href="#l9.260"></a><span id="l9.260">   params.format = Components.interfaces.nsIMsgCompFormat.Default;</span>
<a href="#l9.261"></a><span id="l9.261">   params.identity = accountManager.getFirstIdentityForServer(GetLoadedMsgFolder().server);</span>
<a href="#l9.262"></a><span id="l9.262">   params.composeFields = fields;</span>
<a href="#l9.263"></a><span id="l9.263">   msgComposeService.OpenComposeWindowWithParams(null, params);</span>
<a href="#l9.264"></a><span id="l9.264"> }</span>
<a href="#l9.265"></a><span id="l9.265"> </span>
<a href="#l9.266"></a><span id="l9.266"> // Extracts email address from url string</span>
<a href="#l9.267"></a><span id="l9.267" class="difflineminus">-function getEmail (url) </span>
<a href="#l9.268"></a><span id="l9.268" class="difflineplus">+function getEmail (url)</span>
<a href="#l9.269"></a><span id="l9.269"> {</span>
<a href="#l9.270"></a><span id="l9.270">   var qmark = url.indexOf( &quot;?&quot; );</span>
<a href="#l9.271"></a><span id="l9.271">   var addresses;</span>
<a href="#l9.272"></a><span id="l9.272"> </span>
<a href="#l9.273"></a><span id="l9.273" class="difflineminus">-  if ( qmark &gt; mailtolength ) </span>
<a href="#l9.274"></a><span id="l9.274" class="difflineplus">+  if ( qmark &gt; mailtolength )</span>
<a href="#l9.275"></a><span id="l9.275">       addresses = url.substring( mailtolength, qmark );</span>
<a href="#l9.276"></a><span id="l9.276" class="difflineminus">-  else </span>
<a href="#l9.277"></a><span id="l9.277" class="difflineplus">+  else</span>
<a href="#l9.278"></a><span id="l9.278">      addresses = url.substr( mailtolength );</span>
<a href="#l9.279"></a><span id="l9.279">   // Let's try to unescape it using a character set</span>
<a href="#l9.280"></a><span id="l9.280">   try {</span>
<a href="#l9.281"></a><span id="l9.281">     var characterSet = gContextMenu.target.ownerDocument.characterSet;</span>
<a href="#l9.282"></a><span id="l9.282">     const textToSubURI = Components.classes[&quot;@mozilla.org/intl/texttosuburi;1&quot;]</span>
<a href="#l9.283"></a><span id="l9.283">                                  .getService(Components.interfaces.nsITextToSubURI);</span>
<a href="#l9.284"></a><span id="l9.284">     addresses = textToSubURI.unEscapeURIForUI(characterSet, addresses);</span>
<a href="#l9.285"></a><span id="l9.285">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/base/content/mailWindow.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/base/content/mailWindow.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -1,47 +1,46 @@</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineminus">-# -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineminus">-# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineminus">-# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l10.7"></a><span id="l10.7" class="difflineminus">-#</span>
<a href="#l10.8"></a><span id="l10.8" class="difflineminus">-# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineminus">-# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineminus">-# the License. You may obtain a copy of the License at</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineminus">-# http://www.mozilla.org/MPL/</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-#</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-# for the specific language governing rights and limitations under the</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">-# License.</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineminus">-#</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineminus">-# The Original Code is Mozilla Communicator client code, released</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">-# March 31, 1998.</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineminus">-#</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">-# The Initial Developer of the Original Code is</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineminus">-# Netscape Communications Corporation.</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineminus">-# Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineminus">-# the Initial Developer. All Rights Reserved.</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineminus">-#</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineminus">-# Contributor(s):</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineminus">-#   Jan Varga &lt;varga@nixcorp.com&gt;</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineminus">-#   Hkan Waara &lt;hwaara@gmail.com&gt;</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineminus">-#</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">-# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-# either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-# the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineminus">-# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineminus">-# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineminus">-# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineminus">-# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineminus">-# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineminus">-# the provisions above, a recipient may use your version of this file under</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineminus">-# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineminus">-#</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineminus">-# ***** END LICENSE BLOCK *****</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+/** ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+ *</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+ *</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineplus">+ * License.</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+ *</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineplus">+ * The Original Code is Mozilla Communicator client code, released</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineplus">+ * March 31, 1998.</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineplus">+ *</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineplus">+ * Netscape Communications Corporation.</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineplus">+ *</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineplus">+ * Contributor(s):</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineplus">+ *   Jan Varga &lt;varga@nixcorp.com&gt;</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineplus">+ *   Hkan Waara &lt;hwaara@gmail.com&gt;</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineplus">+ *</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineplus">+ *</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l10.81"></a><span id="l10.81"> </span>
<a href="#l10.82"></a><span id="l10.82"> Components.utils.import(&quot;resource://app/modules/appIdleManager.js&quot;);</span>
<a href="#l10.83"></a><span id="l10.83"> </span>
<a href="#l10.84"></a><span id="l10.84"> //This file stores variables common to mail windows</span>
<a href="#l10.85"></a><span id="l10.85"> var messenger;</span>
<a href="#l10.86"></a><span id="l10.86"> var pref;</span>
<a href="#l10.87"></a><span id="l10.87"> var statusFeedback;</span>
<a href="#l10.88"></a><span id="l10.88"> var msgWindow;</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineat">@@ -54,40 +53,45 @@ var gBrandBundle;</span>
<a href="#l10.90"></a><span id="l10.90"> </span>
<a href="#l10.91"></a><span id="l10.91"> Components.utils.import(&quot;resource://app/modules/gloda/log4moz.js&quot;);</span>
<a href="#l10.92"></a><span id="l10.92"> </span>
<a href="#l10.93"></a><span id="l10.93"> var gContextMenu;</span>
<a href="#l10.94"></a><span id="l10.94"> var gMailWindowLog = Log4Moz.getConfiguredLogger(&quot;mailWindow&quot;, Log4Moz.Level.Debug, Log4Moz.Level.Debug, Log4Moz.Level.Debug);</span>
<a href="#l10.95"></a><span id="l10.95"> var gAccountCentralLoaded = true;</span>
<a href="#l10.96"></a><span id="l10.96"> </span>
<a href="#l10.97"></a><span id="l10.97"> </span>
<a href="#l10.98"></a><span id="l10.98" class="difflineplus">+/**</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineplus">+ * Indicate whether we are running on Mac OS X.  Our code is currently littered</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineplus">+ *  with #ifdef/#ifndef XP_MACOSX's that do not need to exist in js code.  Use</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineplus">+ *  of preprocessing makes error line numbers misleading, complicates</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineplus">+ *  development because preprocessed files can't be symlinked when using</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineplus">+ *  --enable-chrome-format=symlink, etc.</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineplus">+ */</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineplus">+var gPlatformOSX =</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineplus">+  (window.navigator.oscpu.substring(0, 3).toLowerCase() == &quot;mac&quot;);</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineplus">+</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineplus">+/**</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineplus">+ * Called by messageWindow.xul:onunload,  the 'single message display window'.</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineplus">+ *</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineplus">+ * Also called by messenger.xul:onunload's (the 3-pane window inside of tabs</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineplus">+ *  window) unload function, OnUnloadMessenger.</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineplus">+ */</span>
<a href="#l10.114"></a><span id="l10.114"> function OnMailWindowUnload()</span>
<a href="#l10.115"></a><span id="l10.115"> {</span>
<a href="#l10.116"></a><span id="l10.116">   MailOfflineMgr.uninit();</span>
<a href="#l10.117"></a><span id="l10.117">   ClearPendingReadTimer();</span>
<a href="#l10.118"></a><span id="l10.118"> </span>
<a href="#l10.119"></a><span id="l10.119" class="difflineminus">-  var searchSession = GetSearchSession();</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineminus">-  if (searchSession)</span>
<a href="#l10.121"></a><span id="l10.121" class="difflineminus">-  {</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineminus">-    removeGlobalListeners();</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineminus">-    if (gPreQuickSearchView)     //close the cached pre quick search view</span>
<a href="#l10.124"></a><span id="l10.124" class="difflineminus">-      gPreQuickSearchView.close();</span>
<a href="#l10.125"></a><span id="l10.125" class="difflineminus">-  }</span>
<a href="#l10.126"></a><span id="l10.126" class="difflineminus">-</span>
<a href="#l10.127"></a><span id="l10.127" class="difflineminus">-  var dbview = GetDBView();</span>
<a href="#l10.128"></a><span id="l10.128" class="difflineminus">-  if (dbview) {</span>
<a href="#l10.129"></a><span id="l10.129" class="difflineminus">-    dbview.close();</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineminus">-  }</span>
<a href="#l10.131"></a><span id="l10.131" class="difflineplus">+  // all dbview closing is handled by OnUnloadMessenger for the 3-pane (it closes</span>
<a href="#l10.132"></a><span id="l10.132" class="difflineplus">+  //  the tabs which close their views) and OnUnloadMessageWindow for the</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineplus">+  //  standalone message window.</span>
<a href="#l10.134"></a><span id="l10.134"> </span>
<a href="#l10.135"></a><span id="l10.135">   var mailSession = Components.classes[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l10.136"></a><span id="l10.136">                               .getService(Components.interfaces.nsIMsgMailSession);</span>
<a href="#l10.137"></a><span id="l10.137" class="difflineminus">-  mailSession.RemoveFolderListener(folderListener);</span>
<a href="#l10.138"></a><span id="l10.138" class="difflineminus">-</span>
<a href="#l10.139"></a><span id="l10.139">   mailSession.RemoveMsgWindow(msgWindow);</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineminus">-  messenger.setWindow(null, null);</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineplus">+  // the tabs have the FolderDisplayWidget close their 'messenger' instances for us</span>
<a href="#l10.142"></a><span id="l10.142"> </span>
<a href="#l10.143"></a><span id="l10.143">   msgWindow.closeWindow();</span>
<a href="#l10.144"></a><span id="l10.144"> </span>
<a href="#l10.145"></a><span id="l10.145">   window.MsgStatusFeedback.unload();</span>
<a href="#l10.146"></a><span id="l10.146">   Components.classes[&quot;@mozilla.org/activity-manager;1&quot;]</span>
<a href="#l10.147"></a><span id="l10.147">             .getService(Components.interfaces.nsIActivityManager)</span>
<a href="#l10.148"></a><span id="l10.148">             .removeListener(window.MsgStatusFeedback);</span>
<a href="#l10.149"></a><span id="l10.149"> }</span>
<a href="#l10.150"></a><span id="l10.150" class="difflineat">@@ -98,17 +102,17 @@ function CreateMailWindowGlobals()</span>
<a href="#l10.151"></a><span id="l10.151">   messenger = Components.classes[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l10.152"></a><span id="l10.152">                         .createInstance(Components.interfaces.nsIMessenger);</span>
<a href="#l10.153"></a><span id="l10.153"> </span>
<a href="#l10.154"></a><span id="l10.154">   pref = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l10.155"></a><span id="l10.155">           .getService(Components.interfaces.nsIPrefBranch2);</span>
<a href="#l10.156"></a><span id="l10.156"> </span>
<a href="#l10.157"></a><span id="l10.157">   window.addEventListener(&quot;blur&quot;, appIdleManager.onBlur, false);</span>
<a href="#l10.158"></a><span id="l10.158">   window.addEventListener(&quot;focus&quot;, appIdleManager.onFocus, false);</span>
<a href="#l10.159"></a><span id="l10.159" class="difflineminus">-  </span>
<a href="#l10.160"></a><span id="l10.160" class="difflineplus">+</span>
<a href="#l10.161"></a><span id="l10.161">   //Create windows status feedback</span>
<a href="#l10.162"></a><span id="l10.162">   // set the JS implementation of status feedback before creating the c++ one..</span>
<a href="#l10.163"></a><span id="l10.163">   window.MsgStatusFeedback = new nsMsgStatusFeedback();</span>
<a href="#l10.164"></a><span id="l10.164">   // double register the status feedback object as the xul browser window implementation</span>
<a href="#l10.165"></a><span id="l10.165">   window.QueryInterface(Components.interfaces.nsIInterfaceRequestor)</span>
<a href="#l10.166"></a><span id="l10.166">         .getInterface(Components.interfaces.nsIWebNavigation)</span>
<a href="#l10.167"></a><span id="l10.167">         .QueryInterface(Components.interfaces.nsIDocShellTreeItem).treeOwner</span>
<a href="#l10.168"></a><span id="l10.168">         .QueryInterface(Components.interfaces.nsIInterfaceRequestor)</span>
<a href="#l10.169"></a><span id="l10.169" class="difflineat">@@ -156,17 +160,17 @@ function InitMsgWindow()</span>
<a href="#l10.170"></a><span id="l10.170"> }</span>
<a href="#l10.171"></a><span id="l10.171"> </span>
<a href="#l10.172"></a><span id="l10.172"> // We're going to implement our status feedback for the mail window in JS now.</span>
<a href="#l10.173"></a><span id="l10.173"> // the following contains the implementation of our status feedback object</span>
<a href="#l10.174"></a><span id="l10.174"> </span>
<a href="#l10.175"></a><span id="l10.175"> function nsMsgStatusFeedback()</span>
<a href="#l10.176"></a><span id="l10.176"> {</span>
<a href="#l10.177"></a><span id="l10.177">   this._statusText = document.getElementById(&quot;statusText&quot;);</span>
<a href="#l10.178"></a><span id="l10.178" class="difflineminus">-  this._progressBar = document.getElementById(&quot;statusbar-icon&quot;); </span>
<a href="#l10.179"></a><span id="l10.179" class="difflineplus">+  this._progressBar = document.getElementById(&quot;statusbar-icon&quot;);</span>
<a href="#l10.180"></a><span id="l10.180">   this._progressBarContainer = document.getElementById(&quot;statusbar-progresspanel&quot;);</span>
<a href="#l10.181"></a><span id="l10.181">   this._throbber = document.getElementById(&quot;navigator-throbber&quot;);</span>
<a href="#l10.182"></a><span id="l10.182">   this._stopCmd = document.getElementById(&quot;cmd_stop&quot;);</span>
<a href="#l10.183"></a><span id="l10.183">   this._activeProcesses = new Array();</span>
<a href="#l10.184"></a><span id="l10.184"> }</span>
<a href="#l10.185"></a><span id="l10.185"> </span>
<a href="#l10.186"></a><span id="l10.186"> nsMsgStatusFeedback.prototype =</span>
<a href="#l10.187"></a><span id="l10.187"> {</span>
<a href="#l10.188"></a><span id="l10.188" class="difflineat">@@ -351,17 +355,17 @@ nsMsgStatusFeedback.prototype =</span>
<a href="#l10.189"></a><span id="l10.189">         this._progressBarContainer.removeAttribute('collapsed');</span>
<a href="#l10.190"></a><span id="l10.190">         this._progressBarVisible = true;</span>
<a href="#l10.191"></a><span id="l10.191">       }</span>
<a href="#l10.192"></a><span id="l10.192">     }</span>
<a href="#l10.193"></a><span id="l10.193">     else {</span>
<a href="#l10.194"></a><span id="l10.194">       // Stop the bar spinning as we're not doing anything now.</span>
<a href="#l10.195"></a><span id="l10.195">       this._progressBar.setAttribute(&quot;mode&quot;, &quot;determined&quot;);</span>
<a href="#l10.196"></a><span id="l10.196">       this._progressBar.value = 0;</span>
<a href="#l10.197"></a><span id="l10.197" class="difflineminus">-      this._progressBar.label = &quot;&quot;; </span>
<a href="#l10.198"></a><span id="l10.198" class="difflineplus">+      this._progressBar.label = &quot;&quot;;</span>
<a href="#l10.199"></a><span id="l10.199"> </span>
<a href="#l10.200"></a><span id="l10.200">       if (this._progressBarVisible) {</span>
<a href="#l10.201"></a><span id="l10.201">         this._progressBarContainer.collapsed = true;</span>
<a href="#l10.202"></a><span id="l10.202">         this._progressBarVisible = false;</span>
<a href="#l10.203"></a><span id="l10.203">       }</span>
<a href="#l10.204"></a><span id="l10.204">     }</span>
<a href="#l10.205"></a><span id="l10.205">   },</span>
<a href="#l10.206"></a><span id="l10.206"> </span>
<a href="#l10.207"></a><span id="l10.207" class="difflineat">@@ -437,25 +441,26 @@ nsMsgWindowCommands.prototype =</span>
<a href="#l10.208"></a><span id="l10.208"> </span>
<a href="#l10.209"></a><span id="l10.209">   selectFolder: function(folderUri)</span>
<a href="#l10.210"></a><span id="l10.210">   {</span>
<a href="#l10.211"></a><span id="l10.211">     gFolderTreeView.selectFolder(GetMsgFolderFromUri(folderUri));</span>
<a href="#l10.212"></a><span id="l10.212">   },</span>
<a href="#l10.213"></a><span id="l10.213"> </span>
<a href="#l10.214"></a><span id="l10.214">   selectMessage: function(messageUri)</span>
<a href="#l10.215"></a><span id="l10.215">   {</span>
<a href="#l10.216"></a><span id="l10.216" class="difflineminus">-    SelectMessage(messageUri);</span>
<a href="#l10.217"></a><span id="l10.217" class="difflineplus">+    let msgHdr = messenger.msgHdrFromURI(messageUri);</span>
<a href="#l10.218"></a><span id="l10.218" class="difflineplus">+    gFolderDisplay.selectMessage(msgHdr);</span>
<a href="#l10.219"></a><span id="l10.219">   },</span>
<a href="#l10.220"></a><span id="l10.220"> </span>
<a href="#l10.221"></a><span id="l10.221">   clearMsgPane: function()</span>
<a href="#l10.222"></a><span id="l10.222">   {</span>
<a href="#l10.223"></a><span id="l10.223" class="difflineminus">-    if (gDBView)</span>
<a href="#l10.224"></a><span id="l10.224" class="difflineminus">-      setTitleFromFolder(gDBView.msgFolder,null);</span>
<a href="#l10.225"></a><span id="l10.225" class="difflineminus">-    else</span>
<a href="#l10.226"></a><span id="l10.226" class="difflineminus">-      setTitleFromFolder(null,null);</span>
<a href="#l10.227"></a><span id="l10.227" class="difflineplus">+    // This call happens as part of a display decision made by the nsMsgDBView</span>
<a href="#l10.228"></a><span id="l10.228" class="difflineplus">+    //  instance.  Strictly speaking, we don't want this.  I think davida's</span>
<a href="#l10.229"></a><span id="l10.229" class="difflineplus">+    //  patch will change this, so we can figure it out after that lands if</span>
<a href="#l10.230"></a><span id="l10.230" class="difflineplus">+    //  there are issues.</span>
<a href="#l10.231"></a><span id="l10.231">     ClearMessagePane();</span>
<a href="#l10.232"></a><span id="l10.232">   }</span>
<a href="#l10.233"></a><span id="l10.233"> }</span>
<a href="#l10.234"></a><span id="l10.234"> </span>
<a href="#l10.235"></a><span id="l10.235"> /**</span>
<a href="#l10.236"></a><span id="l10.236">  * @returns the pref name to use for fetching the start page url. Every time the application version changes,</span>
<a href="#l10.237"></a><span id="l10.237">  * return &quot;mailnews.start_page.override_url&quot;. If this is the first time the application has been</span>
<a href="#l10.238"></a><span id="l10.238">  * launched, return &quot;mailnews.start_page.welcome_url&quot;. Otherwise return &quot;mailnews.start_page.url&quot;.</span>
<a href="#l10.239"></a><span id="l10.239" class="difflineat">@@ -475,17 +480,16 @@ function startPageUrlPref()</span>
<a href="#l10.240"></a><span id="l10.240"> }</span>
<a href="#l10.241"></a><span id="l10.241"> </span>
<a href="#l10.242"></a><span id="l10.242"> /**</span>
<a href="#l10.243"></a><span id="l10.243">  * Loads the mail start page.</span>
<a href="#l10.244"></a><span id="l10.244">  */</span>
<a href="#l10.245"></a><span id="l10.245"> function loadStartPage()</span>
<a href="#l10.246"></a><span id="l10.246"> {</span>
<a href="#l10.247"></a><span id="l10.247">   gMessageNotificationBar.clearMsgNotifications();</span>
<a href="#l10.248"></a><span id="l10.248" class="difflineminus">-  ClearThreadPaneSelection();</span>
<a href="#l10.249"></a><span id="l10.249">   let startpage = Components.classes[&quot;@mozilla.org/toolkit/URLFormatterService;1&quot;]</span>
<a href="#l10.250"></a><span id="l10.250">                             .getService(Components.interfaces.nsIURLFormatter)</span>
<a href="#l10.251"></a><span id="l10.251">                             .formatURLPref(startPageUrlPref());</span>
<a href="#l10.252"></a><span id="l10.252">   if (startpage)</span>
<a href="#l10.253"></a><span id="l10.253">   {</span>
<a href="#l10.254"></a><span id="l10.254">     try {</span>
<a href="#l10.255"></a><span id="l10.255">       let urifixup = Components.classes[&quot;@mozilla.org/docshell/urifixup;1&quot;]</span>
<a href="#l10.256"></a><span id="l10.256">                                .getService(Components.interfaces.nsIURIFixup);</span>
<a href="#l10.257"></a><span id="l10.257" class="difflineat">@@ -498,67 +502,50 @@ function loadStartPage()</span>
<a href="#l10.258"></a><span id="l10.258">     }</span>
<a href="#l10.259"></a><span id="l10.259">   }</span>
<a href="#l10.260"></a><span id="l10.260">   else</span>
<a href="#l10.261"></a><span id="l10.261">   {</span>
<a href="#l10.262"></a><span id="l10.262">     GetMessagePaneFrame().location.href = &quot;about:blank&quot;;</span>
<a href="#l10.263"></a><span id="l10.263">   }</span>
<a href="#l10.264"></a><span id="l10.264"> }</span>
<a href="#l10.265"></a><span id="l10.265"> </span>
<a href="#l10.266"></a><span id="l10.266" class="difflineminus">-// When the ThreadPane is hidden via the displayDeck, we should collapse the</span>
<a href="#l10.267"></a><span id="l10.267" class="difflineminus">-// elements that are only meaningful to the thread pane. When AccountCentral is</span>
<a href="#l10.268"></a><span id="l10.268" class="difflineminus">-// shown via the displayDeck, we need to switch the displayDeck to show the</span>
<a href="#l10.269"></a><span id="l10.269" class="difflineminus">-// accountCentralBox, and load the iframe in the AccountCentral box with</span>
<a href="#l10.270"></a><span id="l10.270" class="difflineminus">-// corresponding page.</span>
<a href="#l10.271"></a><span id="l10.271" class="difflineminus">-function ShowAccountCentral()</span>
<a href="#l10.272"></a><span id="l10.272" class="difflineminus">-{</span>
<a href="#l10.273"></a><span id="l10.273" class="difflineminus">-  var accountBox = document.getElementById(&quot;accountCentralBox&quot;);</span>
<a href="#l10.274"></a><span id="l10.274" class="difflineminus">-  document.getElementById(&quot;displayDeck&quot;).selectedPanel = accountBox;</span>
<a href="#l10.275"></a><span id="l10.275" class="difflineminus">-  var prefName = &quot;mailnews.account_central_page.url&quot;;</span>
<a href="#l10.276"></a><span id="l10.276" class="difflineminus">-  var acctCentralPage = pref.getComplexValue(prefName,</span>
<a href="#l10.277"></a><span id="l10.277" class="difflineminus">-                                             Components.interfaces.nsIPrefLocalizedString).data;</span>
<a href="#l10.278"></a><span id="l10.278" class="difflineminus">-  window.frames[&quot;accountCentralPane&quot;].location.href = acctCentralPage;</span>
<a href="#l10.279"></a><span id="l10.279" class="difflineminus">-}</span>
<a href="#l10.280"></a><span id="l10.280" class="difflineminus">-</span>
<a href="#l10.281"></a><span id="l10.281" class="difflineminus">-function ShowThreadPane()</span>
<a href="#l10.282"></a><span id="l10.282" class="difflineminus">-{</span>
<a href="#l10.283"></a><span id="l10.283" class="difflineminus">-  document.getElementById(&quot;displayDeck&quot;).selectedPanel =</span>
<a href="#l10.284"></a><span id="l10.284" class="difflineminus">-    document.getElementById(&quot;threadPaneBox&quot;);</span>
<a href="#l10.285"></a><span id="l10.285" class="difflineminus">-}</span>
<a href="#l10.286"></a><span id="l10.286" class="difflineminus">-</span>
<a href="#l10.287"></a><span id="l10.287"> function ShowingThreadPane()</span>
<a href="#l10.288"></a><span id="l10.288"> {</span>
<a href="#l10.289"></a><span id="l10.289">   var threadPaneSplitter = document.getElementById(&quot;threadpane-splitter&quot;);</span>
<a href="#l10.290"></a><span id="l10.290">   threadPaneSplitter.collapsed = false;</span>
<a href="#l10.291"></a><span id="l10.291">   GetMessagePane().collapsed = (threadPaneSplitter.getAttribute(&quot;state&quot;) == &quot;collapsed&quot;);</span>
<a href="#l10.292"></a><span id="l10.292">   // XXX We need to force the tree to refresh its new height</span>
<a href="#l10.293"></a><span id="l10.293">   // so that it will correctly scroll to the newest message</span>
<a href="#l10.294"></a><span id="l10.294">   GetThreadTree().boxObject.height;</span>
<a href="#l10.295"></a><span id="l10.295">   document.getElementById(&quot;key_toggleMessagePane&quot;).removeAttribute(&quot;disabled&quot;);</span>
<a href="#l10.296"></a><span id="l10.296"> }</span>
<a href="#l10.297"></a><span id="l10.297"> </span>
<a href="#l10.298"></a><span id="l10.298"> function HidingThreadPane()</span>
<a href="#l10.299"></a><span id="l10.299"> {</span>
<a href="#l10.300"></a><span id="l10.300" class="difflineminus">-  ClearThreadPane();</span>
<a href="#l10.301"></a><span id="l10.301">   GetUnreadCountElement().hidden = true;</span>
<a href="#l10.302"></a><span id="l10.302">   GetTotalCountElement().hidden = true;</span>
<a href="#l10.303"></a><span id="l10.303">   GetMessagePane().collapsed = true;</span>
<a href="#l10.304"></a><span id="l10.304">   document.getElementById(&quot;threadpane-splitter&quot;).collapsed = true;</span>
<a href="#l10.305"></a><span id="l10.305">   document.getElementById(&quot;key_toggleMessagePane&quot;).setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l10.306"></a><span id="l10.306"> }</span>
<a href="#l10.307"></a><span id="l10.307"> </span>
<a href="#l10.308"></a><span id="l10.308"> // The zoom manager, view source and possibly some other functions still rely</span>
<a href="#l10.309"></a><span id="l10.309"> // on the getBrowser function.</span>
<a href="#l10.310"></a><span id="l10.310"> function getBrowser()</span>
<a href="#l10.311"></a><span id="l10.311"> {</span>
<a href="#l10.312"></a><span id="l10.312">   let tabmail = document.getElementById('tabmail');</span>
<a href="#l10.313"></a><span id="l10.313">   return tabmail ? tabmail.getBrowserForSelectedTab() :</span>
<a href="#l10.314"></a><span id="l10.314">                    document.getElementById(&quot;messagepane&quot;);</span>
<a href="#l10.315"></a><span id="l10.315"> }</span>
<a href="#l10.316"></a><span id="l10.316"> </span>
<a href="#l10.317"></a><span id="l10.317" class="difflineplus">+// When the ThreadPane is hidden via the displayDeck, we should collapse the</span>
<a href="#l10.318"></a><span id="l10.318" class="difflineplus">+// elements that are only meaningful to the thread pane. When AccountCentral is</span>
<a href="#l10.319"></a><span id="l10.319" class="difflineplus">+// shown via the displayDeck, we need to switch the displayDeck to show the</span>
<a href="#l10.320"></a><span id="l10.320" class="difflineplus">+// accountCentralBox, and load the iframe in the AccountCentral box with</span>
<a href="#l10.321"></a><span id="l10.321" class="difflineplus">+// corresponding page.</span>
<a href="#l10.322"></a><span id="l10.322"> var gCurrentDisplayDeckId = &quot;&quot;;</span>
<a href="#l10.323"></a><span id="l10.323"> function ObserveDisplayDeckChange(event)</span>
<a href="#l10.324"></a><span id="l10.324"> {</span>
<a href="#l10.325"></a><span id="l10.325">   var selectedPanel = document.getElementById(&quot;displayDeck&quot;).selectedPanel;</span>
<a href="#l10.326"></a><span id="l10.326">   var nowSelected = selectedPanel ? selectedPanel.id : null;</span>
<a href="#l10.327"></a><span id="l10.327">   // onselect fires for every mouse click inside the deck, so ObserveDisplayDeckChange is getting called every time we click</span>
<a href="#l10.328"></a><span id="l10.328">   // on a message in the thread pane. Only show / Hide elements if the selected deck is actually changing.</span>
<a href="#l10.329"></a><span id="l10.329">   if (nowSelected != gCurrentDisplayDeckId)</span>
<a href="#l10.330"></a><span id="l10.330" class="difflineat">@@ -579,33 +566,24 @@ function ObserveDisplayDeckChange(event)</span>
<a href="#l10.331"></a><span id="l10.331">   }</span>
<a href="#l10.332"></a><span id="l10.332"> }</span>
<a href="#l10.333"></a><span id="l10.333"> </span>
<a href="#l10.334"></a><span id="l10.334"> // Given the server, open the twisty and the set the selection</span>
<a href="#l10.335"></a><span id="l10.335"> // on inbox of that server.</span>
<a href="#l10.336"></a><span id="l10.336"> // prompt if offline.</span>
<a href="#l10.337"></a><span id="l10.337"> function OpenInboxForServer(server)</span>
<a href="#l10.338"></a><span id="l10.338"> {</span>
<a href="#l10.339"></a><span id="l10.339" class="difflineminus">-  ShowThreadPane();</span>
<a href="#l10.340"></a><span id="l10.340">   gFolderTreeView.selectFolder(GetInboxFolder(server));</span>
<a href="#l10.341"></a><span id="l10.341"> </span>
<a href="#l10.342"></a><span id="l10.342">   if (MailOfflineMgr.isOnline() || MailOfflineMgr.getNewMail()) {</span>
<a href="#l10.343"></a><span id="l10.343">     if (server.type != &quot;imap&quot;)</span>
<a href="#l10.344"></a><span id="l10.344">       GetMessagesForInboxOnServer(server);</span>
<a href="#l10.345"></a><span id="l10.345">   }</span>
<a href="#l10.346"></a><span id="l10.346"> }</span>
<a href="#l10.347"></a><span id="l10.347"> </span>
<a href="#l10.348"></a><span id="l10.348" class="difflineminus">-function GetSearchSession()</span>
<a href="#l10.349"></a><span id="l10.349" class="difflineminus">-{</span>
<a href="#l10.350"></a><span id="l10.350" class="difflineminus">-  if ((&quot;gSearchSession&quot; in top) &amp;&amp; gSearchSession)</span>
<a href="#l10.351"></a><span id="l10.351" class="difflineminus">-    return gSearchSession;</span>
<a href="#l10.352"></a><span id="l10.352" class="difflineminus">-  else</span>
<a href="#l10.353"></a><span id="l10.353" class="difflineminus">-    return null;</span>
<a href="#l10.354"></a><span id="l10.354" class="difflineminus">-}</span>
<a href="#l10.355"></a><span id="l10.355" class="difflineminus">-</span>
<a href="#l10.356"></a><span id="l10.356"> /** Update state of zoom type (text vs. full) menu item. */</span>
<a href="#l10.357"></a><span id="l10.357"> function UpdateFullZoomMenu() {</span>
<a href="#l10.358"></a><span id="l10.358">   var menuItem = document.getElementById(&quot;menu_fullZoomToggle&quot;);</span>
<a href="#l10.359"></a><span id="l10.359">   menuItem.setAttribute(&quot;checked&quot;, !ZoomManager.useFullZoom);</span>
<a href="#l10.360"></a><span id="l10.360"> }</span>
<a href="#l10.361"></a><span id="l10.361"> </span>
<a href="#l10.362"></a><span id="l10.362"> /**</span>
<a href="#l10.363"></a><span id="l10.363">  * This class implements nsIBadCertListener2.  Its job is to prevent &quot;bad cert&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/base/content/mailWindowOverlay.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/base/content/mailWindowOverlay.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -1,55 +1,54 @@</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineminus">-# -*- Mode: javascript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineminus">-# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineminus">-# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineminus">-#</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineminus">-# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineminus">-# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineminus">-# the License. You may obtain a copy of the License at</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineminus">-# http://www.mozilla.org/MPL/</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-#</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-# for the specific language governing rights and limitations under the</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">-# License.</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineminus">-#</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineminus">-# The Original Code is Mozilla Communicator client code, released</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineminus">-# March 31, 1998.</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineminus">-#</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-# The Initial Developer of the Original Code is</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineminus">-# Netscape Communications Corporation.</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-# Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineminus">-# the Initial Developer. All Rights Reserved.</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineminus">-#</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineminus">-# Contributor(s):</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineminus">-#   timeless</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">-#   slucy@objectivesw.co.uk</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineminus">-#   Hkan Waara &lt;hwaara@chello.se&gt;</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-#   Jan Varga &lt;varga@nixcorp.com&gt;</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-#   Seth Spitzer &lt;sspitzer@netscape.com&gt;</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-#   David Bienvenu &lt;bienvenu@nventure.com&gt;</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-#   Karsten Dsterloh &lt;mnyromyr@tprac.de&gt;</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-#   Christopher Thomas &lt;cst@yecc.com&gt;</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineminus">-#   Jeremy Morton &lt;bugzilla@game-point.net&gt;</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineminus">-#   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineminus">-#</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineminus">-# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-# either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineminus">-# the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineminus">-# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineminus">-# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineminus">-# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineminus">-# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineminus">-# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineminus">-# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineminus">-# the provisions above, a recipient may use your version of this file under</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineminus">-# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineminus">-#</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineminus">-# ***** END LICENSE BLOCK *****</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+ *</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineplus">+ *</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineplus">+ * License.</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineplus">+ *</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineplus">+ * The Original Code is Mozilla Communicator client code, released</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineplus">+ * March 31, 1998.</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+ *</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineplus">+ * Netscape Communications Corporation.</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+ *</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+ * Contributor(s):</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineplus">+ *   timeless</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineplus">+ *   slucy@objectivesw.co.uk</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineplus">+ *   Hkan Waara &lt;hwaara@chello.se&gt;</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineplus">+ *   Jan Varga &lt;varga@nixcorp.com&gt;</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineplus">+ *   Seth Spitzer &lt;sspitzer@netscape.com&gt;</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineplus">+ *   David Bienvenu &lt;bienvenu@nventure.com&gt;</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineplus">+ *   Karsten Dsterloh &lt;mnyromyr@tprac.de&gt;</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineplus">+ *   Christopher Thomas &lt;cst@yecc.com&gt;</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineplus">+ *   Jeremy Morton &lt;bugzilla@game-point.net&gt;</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineplus">+ *</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineplus">+ *</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l11.97"></a><span id="l11.97"> </span>
<a href="#l11.98"></a><span id="l11.98"> const ADDR_DB_LARGE_COMMIT       = 1;</span>
<a href="#l11.99"></a><span id="l11.99"> </span>
<a href="#l11.100"></a><span id="l11.100"> const kClassicMailLayout = 0;</span>
<a href="#l11.101"></a><span id="l11.101"> const kWideMailLayout = 1;</span>
<a href="#l11.102"></a><span id="l11.102"> const kVerticalMailLayout = 2;</span>
<a href="#l11.103"></a><span id="l11.103"> </span>
<a href="#l11.104"></a><span id="l11.104"> // Per message header flags to keep track of whether the user is allowing remote</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineat">@@ -153,17 +152,17 @@ function InitEditMessagesMenu()</span>
<a href="#l11.106"></a><span id="l11.106"> </span>
<a href="#l11.107"></a><span id="l11.107"> function InitGoMessagesMenu()</span>
<a href="#l11.108"></a><span id="l11.108"> {</span>
<a href="#l11.109"></a><span id="l11.109">   document.commandDispatcher.updateCommands('create-menu-go');</span>
<a href="#l11.110"></a><span id="l11.110"> }</span>
<a href="#l11.111"></a><span id="l11.111"> </span>
<a href="#l11.112"></a><span id="l11.112"> function view_init()</span>
<a href="#l11.113"></a><span id="l11.113"> {</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineminus">-  var isFeed = IsFeedItem();</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineplus">+  var isFeed = gFolderDisplay.selectedMessageIsFeed;</span>
<a href="#l11.116"></a><span id="l11.116"> </span>
<a href="#l11.117"></a><span id="l11.117">   if (!gMessengerBundle)</span>
<a href="#l11.118"></a><span id="l11.118">     gMessengerBundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l11.119"></a><span id="l11.119"> </span>
<a href="#l11.120"></a><span id="l11.120">   var messagePaneMenuItem = document.getElementById(&quot;menu_showMessage&quot;);</span>
<a href="#l11.121"></a><span id="l11.121">   if (!messagePaneMenuItem.hidden) { // Hidden in the standalone msg window.</span>
<a href="#l11.122"></a><span id="l11.122">     messagePaneMenuItem.setAttribute(&quot;checked&quot;, !IsMessagePaneCollapsed());</span>
<a href="#l11.123"></a><span id="l11.123">     messagePaneMenuItem.disabled = gAccountCentralLoaded;</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineat">@@ -232,105 +231,106 @@ function InitViewFolderViewsMenu(event)</span>
<a href="#l11.125"></a><span id="l11.125"> </span>
<a href="#l11.126"></a><span id="l11.126"> function setSortByMenuItemCheckState(id, value)</span>
<a href="#l11.127"></a><span id="l11.127"> {</span>
<a href="#l11.128"></a><span id="l11.128">   var menuitem = document.getElementById(id);</span>
<a href="#l11.129"></a><span id="l11.129">   if (menuitem)</span>
<a href="#l11.130"></a><span id="l11.130">     menuitem.setAttribute(&quot;checked&quot;, value);</span>
<a href="#l11.131"></a><span id="l11.131"> }</span>
<a href="#l11.132"></a><span id="l11.132"> </span>
<a href="#l11.133"></a><span id="l11.133" class="difflineplus">+/**</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineplus">+ * Called when showing the menu_viewSortPopup menupopup, so it should always</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineplus">+ * be up-to-date.</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineplus">+ */</span>
<a href="#l11.137"></a><span id="l11.137"> function InitViewSortByMenu()</span>
<a href="#l11.138"></a><span id="l11.138"> {</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineminus">-  var sortType = gDBView.sortType;</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineplus">+  var sortType = gFolderDisplay.view.primarySortType;</span>
<a href="#l11.141"></a><span id="l11.141"> </span>
<a href="#l11.142"></a><span id="l11.142">   setSortByMenuItemCheckState(&quot;sortByDateMenuitem&quot;, (sortType == nsMsgViewSortType.byDate));</span>
<a href="#l11.143"></a><span id="l11.143">   setSortByMenuItemCheckState(&quot;sortByReceivedMenuitem&quot;, (sortType == nsMsgViewSortType.byReceived));</span>
<a href="#l11.144"></a><span id="l11.144">   setSortByMenuItemCheckState(&quot;sortByFlagMenuitem&quot;, (sortType == nsMsgViewSortType.byFlagged));</span>
<a href="#l11.145"></a><span id="l11.145">   setSortByMenuItemCheckState(&quot;sortByOrderReceivedMenuitem&quot;, (sortType == nsMsgViewSortType.byId));</span>
<a href="#l11.146"></a><span id="l11.146">   setSortByMenuItemCheckState(&quot;sortByPriorityMenuitem&quot;, (sortType == nsMsgViewSortType.byPriority));</span>
<a href="#l11.147"></a><span id="l11.147">   setSortByMenuItemCheckState(&quot;sortBySizeMenuitem&quot;, (sortType == nsMsgViewSortType.bySize));</span>
<a href="#l11.148"></a><span id="l11.148">   setSortByMenuItemCheckState(&quot;sortByStatusMenuitem&quot;, (sortType == nsMsgViewSortType.byStatus));</span>
<a href="#l11.149"></a><span id="l11.149">   setSortByMenuItemCheckState(&quot;sortBySubjectMenuitem&quot;, (sortType == nsMsgViewSortType.bySubject));</span>
<a href="#l11.150"></a><span id="l11.150">   setSortByMenuItemCheckState(&quot;sortByUnreadMenuitem&quot;, (sortType == nsMsgViewSortType.byUnread));</span>
<a href="#l11.151"></a><span id="l11.151">   setSortByMenuItemCheckState(&quot;sortByTagsMenuitem&quot;, (sortType == nsMsgViewSortType.byTags));</span>
<a href="#l11.152"></a><span id="l11.152">   setSortByMenuItemCheckState(&quot;sortByJunkStatusMenuitem&quot;, (sortType == nsMsgViewSortType.byJunkStatus));</span>
<a href="#l11.153"></a><span id="l11.153">   setSortByMenuItemCheckState(&quot;sortByFromMenuitem&quot;, (sortType == nsMsgViewSortType.byAuthor));</span>
<a href="#l11.154"></a><span id="l11.154">   setSortByMenuItemCheckState(&quot;sortByRecipientMenuitem&quot;, (sortType == nsMsgViewSortType.byRecipient));</span>
<a href="#l11.155"></a><span id="l11.155">   setSortByMenuItemCheckState(&quot;sortByAttachmentsMenuitem&quot;, (sortType == nsMsgViewSortType.byAttachments));</span>
<a href="#l11.156"></a><span id="l11.156"> </span>
<a href="#l11.157"></a><span id="l11.157" class="difflineminus">-  var sortOrder = gDBView.sortOrder;</span>
<a href="#l11.158"></a><span id="l11.158" class="difflineplus">+  var sortOrder = gFolderDisplay.view.primarySortOrder;</span>
<a href="#l11.159"></a><span id="l11.159">   var sortTypeSupportsGrouping = (sortType == nsMsgViewSortType.byAuthor ||</span>
<a href="#l11.160"></a><span id="l11.160">       sortType == nsMsgViewSortType.byDate || sortType == nsMsgViewSortType.byReceived ||</span>
<a href="#l11.161"></a><span id="l11.161">       sortType == nsMsgViewSortType.byPriority ||</span>
<a href="#l11.162"></a><span id="l11.162">       sortType == nsMsgViewSortType.bySubject || sortType == nsMsgViewSortType.byTags ||</span>
<a href="#l11.163"></a><span id="l11.163">       sortType == nsMsgViewSortType.byRecipient || sortType == nsMsgViewSortType.byAccount ||</span>
<a href="#l11.164"></a><span id="l11.164">       sortType == nsMsgViewSortType.byStatus || sortType == nsMsgViewSortType.byFlagged ||</span>
<a href="#l11.165"></a><span id="l11.165">       sortType == nsMsgViewSortType.byAttachments);</span>
<a href="#l11.166"></a><span id="l11.166"> </span>
<a href="#l11.167"></a><span id="l11.167">   setSortByMenuItemCheckState(&quot;sortAscending&quot;, (sortOrder == nsMsgViewSortOrder.ascending));</span>
<a href="#l11.168"></a><span id="l11.168">   setSortByMenuItemCheckState(&quot;sortDescending&quot;, (sortOrder == nsMsgViewSortOrder.descending));</span>
<a href="#l11.169"></a><span id="l11.169"> </span>
<a href="#l11.170"></a><span id="l11.170" class="difflineminus">-  var grouped = ((gDBView.viewFlags &amp; nsMsgViewFlagsType.kGroupBySort) != 0);</span>
<a href="#l11.171"></a><span id="l11.171" class="difflineminus">-  var threaded = ((gDBView.viewFlags &amp; nsMsgViewFlagsType.kThreadedDisplay) != 0 &amp;&amp; !grouped);</span>
<a href="#l11.172"></a><span id="l11.172" class="difflineplus">+  var grouped = gFolderDisplay.view.showGroupedBySort;</span>
<a href="#l11.173"></a><span id="l11.173" class="difflineplus">+  var threaded = gFolderDisplay.view.showThreaded;</span>
<a href="#l11.174"></a><span id="l11.174">   var sortThreadedMenuItem = document.getElementById(&quot;sortThreaded&quot;);</span>
<a href="#l11.175"></a><span id="l11.175">   var sortUnthreadedMenuItem = document.getElementById(&quot;sortUnthreaded&quot;);</span>
<a href="#l11.176"></a><span id="l11.176"> </span>
<a href="#l11.177"></a><span id="l11.177">   sortThreadedMenuItem.setAttribute(&quot;checked&quot;, threaded);</span>
<a href="#l11.178"></a><span id="l11.178">   sortUnthreadedMenuItem.setAttribute(&quot;checked&quot;, !threaded &amp;&amp; !grouped);</span>
<a href="#l11.179"></a><span id="l11.179"> </span>
<a href="#l11.180"></a><span id="l11.180">   var groupBySortOrderMenuItem = document.getElementById(&quot;groupBySort&quot;);</span>
<a href="#l11.181"></a><span id="l11.181"> </span>
<a href="#l11.182"></a><span id="l11.182">   groupBySortOrderMenuItem.setAttribute(&quot;disabled&quot;, !sortTypeSupportsGrouping);</span>
<a href="#l11.183"></a><span id="l11.183">   groupBySortOrderMenuItem.setAttribute(&quot;checked&quot;, grouped);</span>
<a href="#l11.184"></a><span id="l11.184"> }</span>
<a href="#l11.185"></a><span id="l11.185"> </span>
<a href="#l11.186"></a><span id="l11.186"> function InitViewMessagesMenu()</span>
<a href="#l11.187"></a><span id="l11.187"> {</span>
<a href="#l11.188"></a><span id="l11.188" class="difflineminus">-  var viewFlags = (gDBView) ? gDBView.viewFlags : 0;</span>
<a href="#l11.189"></a><span id="l11.189" class="difflineminus">-  var viewType = (gDBView) ? gDBView.viewType : 0;</span>
<a href="#l11.190"></a><span id="l11.190" class="difflineminus">-</span>
<a href="#l11.191"></a><span id="l11.191">   document.getElementById(&quot;viewAllMessagesMenuItem&quot;).setAttribute(&quot;checked&quot;,</span>
<a href="#l11.192"></a><span id="l11.192" class="difflineminus">-    (viewFlags &amp; nsMsgViewFlagsType.kUnreadOnly) == 0 &amp;&amp;</span>
<a href="#l11.193"></a><span id="l11.193" class="difflineminus">-    (viewType == nsMsgViewType.eShowAllThreads));</span>
<a href="#l11.194"></a><span id="l11.194" class="difflineplus">+    !gFolderDisplay.view.showUnreadOnly &amp;&amp;</span>
<a href="#l11.195"></a><span id="l11.195" class="difflineplus">+    !gFolderDisplay.view.specialView);</span>
<a href="#l11.196"></a><span id="l11.196"> </span>
<a href="#l11.197"></a><span id="l11.197">   document.getElementById(&quot;viewUnreadMessagesMenuItem&quot;).setAttribute(&quot;checked&quot;,</span>
<a href="#l11.198"></a><span id="l11.198" class="difflineminus">-    (viewFlags &amp; nsMsgViewFlagsType.kUnreadOnly) != 0);</span>
<a href="#l11.199"></a><span id="l11.199" class="difflineplus">+    gFolderDisplay.view.showUnreadOnly);</span>
<a href="#l11.200"></a><span id="l11.200"> </span>
<a href="#l11.201"></a><span id="l11.201">   document.getElementById(&quot;viewThreadsWithUnreadMenuItem&quot;).setAttribute(&quot;checked&quot;,</span>
<a href="#l11.202"></a><span id="l11.202" class="difflineminus">-    viewType == nsMsgViewType.eShowThreadsWithUnread);</span>
<a href="#l11.203"></a><span id="l11.203" class="difflineplus">+    gFolderDisplay.view.specialViewThreadsWithUnread);</span>
<a href="#l11.204"></a><span id="l11.204"> </span>
<a href="#l11.205"></a><span id="l11.205">   document.getElementById(&quot;viewWatchedThreadsWithUnreadMenuItem&quot;).setAttribute(&quot;checked&quot;,</span>
<a href="#l11.206"></a><span id="l11.206" class="difflineminus">-    viewType == nsMsgViewType.eShowWatchedThreadsWithUnread);</span>
<a href="#l11.207"></a><span id="l11.207" class="difflineplus">+    gFolderDisplay.view.specialViewWatchedThreadsWithUnread);</span>
<a href="#l11.208"></a><span id="l11.208"> </span>
<a href="#l11.209"></a><span id="l11.209">   document.getElementById(&quot;viewIgnoredThreadsMenuItem&quot;).setAttribute(&quot;checked&quot;,</span>
<a href="#l11.210"></a><span id="l11.210" class="difflineminus">-    (viewFlags &amp; nsMsgViewFlagsType.kShowIgnored) != 0);</span>
<a href="#l11.211"></a><span id="l11.211" class="difflineplus">+    gFolderDisplay.view.showIgnored);</span>
<a href="#l11.212"></a><span id="l11.212"> }</span>
<a href="#l11.213"></a><span id="l11.213"> </span>
<a href="#l11.214"></a><span id="l11.214"> function InitMessageMenu()</span>
<a href="#l11.215"></a><span id="l11.215"> {</span>
<a href="#l11.216"></a><span id="l11.216" class="difflineminus">-  var selectedMsg = GetFirstSelectedMessage();</span>
<a href="#l11.217"></a><span id="l11.217" class="difflineminus">-  var isNews = IsNewsMessage(selectedMsg);</span>
<a href="#l11.218"></a><span id="l11.218" class="difflineminus">-  var isFeed = IsFeedItem();</span>
<a href="#l11.219"></a><span id="l11.219" class="difflineplus">+  var selectedMsg = gFolderDisplay.selectedMessage;</span>
<a href="#l11.220"></a><span id="l11.220" class="difflineplus">+  var isNews = gFolderDisplay.selectedMessageIsNews;</span>
<a href="#l11.221"></a><span id="l11.221" class="difflineplus">+  var isFeed = gFolderDisplay.selectedMessageIsFeed;</span>
<a href="#l11.222"></a><span id="l11.222"> </span>
<a href="#l11.223"></a><span id="l11.223">   // We show reply to Newsgroups only for news messages.</span>
<a href="#l11.224"></a><span id="l11.224">   document.getElementById(&quot;replyNewsgroupMainMenu&quot;).hidden = !isNews;</span>
<a href="#l11.225"></a><span id="l11.225"> </span>
<a href="#l11.226"></a><span id="l11.226">   // For mail messages we say reply. For news we say ReplyToSender.</span>
<a href="#l11.227"></a><span id="l11.227">   document.getElementById(&quot;replyMainMenu&quot;).hidden = isNews;</span>
<a href="#l11.228"></a><span id="l11.228">   document.getElementById(&quot;replySenderMainMenu&quot;).hidden = !isNews;</span>
<a href="#l11.229"></a><span id="l11.229"> </span>
<a href="#l11.230"></a><span id="l11.230">   // We only kill and watch threads for news.</span>
<a href="#l11.231"></a><span id="l11.231">   document.getElementById(&quot;threadItemsSeparator&quot;).hidden = !isNews;</span>
<a href="#l11.232"></a><span id="l11.232">   document.getElementById(&quot;killThread&quot;).hidden = !isNews;</span>
<a href="#l11.233"></a><span id="l11.233">   document.getElementById(&quot;killSubthread&quot;).hidden = !isNews;</span>
<a href="#l11.234"></a><span id="l11.234">   document.getElementById(&quot;watchThread&quot;).hidden = !isNews;</span>
<a href="#l11.235"></a><span id="l11.235"> </span>
<a href="#l11.236"></a><span id="l11.236">   // Disable the move and copy menus if there are no messages selected.</span>
<a href="#l11.237"></a><span id="l11.237">   // Disable the move menu if we can't delete msgs from the folder.</span>
<a href="#l11.238"></a><span id="l11.238" class="difflineminus">-  var msgFolder = GetLoadedMsgFolder();</span>
<a href="#l11.239"></a><span id="l11.239" class="difflineplus">+  var msgFolder = gFolderDisplay.displayedFolder;</span>
<a href="#l11.240"></a><span id="l11.240">   var enableMenuItem = selectedMsg &amp;&amp; msgFolder &amp;&amp; msgFolder.canDeleteMessages;</span>
<a href="#l11.241"></a><span id="l11.241">   document.getElementById(&quot;moveMenu&quot;).disabled = !enableMenuItem;</span>
<a href="#l11.242"></a><span id="l11.242"> </span>
<a href="#l11.243"></a><span id="l11.243">   // Also disable copy when no folder is loaded (like for .eml files).</span>
<a href="#l11.244"></a><span id="l11.244">   document.getElementById(&quot;copyMenu&quot;).disabled = !(selectedMsg &amp;&amp; msgFolder);</span>
<a href="#l11.245"></a><span id="l11.245"> </span>
<a href="#l11.246"></a><span id="l11.246">   initMoveToFolderAgainMenu(document.getElementById(&quot;moveToFolderAgain&quot;));</span>
<a href="#l11.247"></a><span id="l11.247"> </span>
<a href="#l11.248"></a><span id="l11.248" class="difflineat">@@ -411,17 +411,17 @@ function InitViewHeadersMenu()</span>
<a href="#l11.249"></a><span id="l11.249">     menuitem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l11.250"></a><span id="l11.250"> }</span>
<a href="#l11.251"></a><span id="l11.251"> </span>
<a href="#l11.252"></a><span id="l11.252"> function InitViewBodyMenu()</span>
<a href="#l11.253"></a><span id="l11.253"> {</span>
<a href="#l11.254"></a><span id="l11.254">   var html_as = 0;</span>
<a href="#l11.255"></a><span id="l11.255">   var prefer_plaintext = false;</span>
<a href="#l11.256"></a><span id="l11.256">   var disallow_classes = 0;</span>
<a href="#l11.257"></a><span id="l11.257" class="difflineminus">-  var isFeed = IsFeedItem();</span>
<a href="#l11.258"></a><span id="l11.258" class="difflineplus">+  var isFeed = gFolderDisplay.selectedMessageIsFeed;</span>
<a href="#l11.259"></a><span id="l11.259">   const defaultIDs = [&quot;bodyAllowHTML&quot;,</span>
<a href="#l11.260"></a><span id="l11.260">                       &quot;bodySanitized&quot;,</span>
<a href="#l11.261"></a><span id="l11.261">                       &quot;bodyAsPlaintext&quot;];</span>
<a href="#l11.262"></a><span id="l11.262">   const rssIDs = [&quot;bodyFeedSummaryAllowHTML&quot;,</span>
<a href="#l11.263"></a><span id="l11.263">                   &quot;bodyFeedSummarySanitized&quot;,</span>
<a href="#l11.264"></a><span id="l11.264">                   &quot;bodyFeedSummaryAsPlaintext&quot;];</span>
<a href="#l11.265"></a><span id="l11.265">   var menuIDs = isFeed ? rssIDs : defaultIDs;</span>
<a href="#l11.266"></a><span id="l11.266">   try</span>
<a href="#l11.267"></a><span id="l11.267" class="difflineat">@@ -465,45 +465,27 @@ function InitViewBodyMenu()</span>
<a href="#l11.268"></a><span id="l11.268">   if (isFeed) {</span>
<a href="#l11.269"></a><span id="l11.269">     AllowHTML_menuitem.hidden = !gShowFeedSummary;</span>
<a href="#l11.270"></a><span id="l11.270">     Sanitized_menuitem.hidden = !gShowFeedSummary;</span>
<a href="#l11.271"></a><span id="l11.271">     AsPlaintext_menuitem.hidden = !gShowFeedSummary;</span>
<a href="#l11.272"></a><span id="l11.272">     document.getElementById(&quot;viewFeedSummarySeparator&quot;).hidden = !gShowFeedSummary;</span>
<a href="#l11.273"></a><span id="l11.273">   }</span>
<a href="#l11.274"></a><span id="l11.274"> }</span>
<a href="#l11.275"></a><span id="l11.275"> </span>
<a href="#l11.276"></a><span id="l11.276" class="difflineminus">-function IsNewsMessage(messageUri)</span>
<a href="#l11.277"></a><span id="l11.277" class="difflineminus">-{</span>
<a href="#l11.278"></a><span id="l11.278" class="difflineminus">-  return (/^news-message:/.test(messageUri));</span>
<a href="#l11.279"></a><span id="l11.279" class="difflineminus">-}</span>
<a href="#l11.280"></a><span id="l11.280" class="difflineminus">-</span>
<a href="#l11.281"></a><span id="l11.281" class="difflineminus">-function IsImapMessage(messageUri)</span>
<a href="#l11.282"></a><span id="l11.282" class="difflineminus">-{</span>
<a href="#l11.283"></a><span id="l11.283" class="difflineminus">-  return (/^imap-message:/.test(messageUri));</span>
<a href="#l11.284"></a><span id="l11.284" class="difflineminus">-}</span>
<a href="#l11.285"></a><span id="l11.285" class="difflineminus">-</span>
<a href="#l11.286"></a><span id="l11.286" class="difflineminus">-function IsFeedItem()</span>
<a href="#l11.287"></a><span id="l11.287" class="difflineminus">-{</span>
<a href="#l11.288"></a><span id="l11.288" class="difflineminus">-  return (GetFirstSelectedMessage() &amp;&amp;</span>
<a href="#l11.289"></a><span id="l11.289" class="difflineminus">-          ((gMsgFolderSelected &amp;&amp;</span>
<a href="#l11.290"></a><span id="l11.290" class="difflineminus">-            gMsgFolderSelected.server.type == 'rss') ||</span>
<a href="#l11.291"></a><span id="l11.291" class="difflineminus">-           'content-base' in currentHeaderData));</span>
<a href="#l11.292"></a><span id="l11.292" class="difflineminus">-}</span>
<a href="#l11.293"></a><span id="l11.293" class="difflineminus">-</span>
<a href="#l11.294"></a><span id="l11.294"> function SetMenuItemLabel(menuItemId, customLabel)</span>
<a href="#l11.295"></a><span id="l11.295"> {</span>
<a href="#l11.296"></a><span id="l11.296">   var menuItem = document.getElementById(menuItemId);</span>
<a href="#l11.297"></a><span id="l11.297">   if (menuItem)</span>
<a href="#l11.298"></a><span id="l11.298">     menuItem.setAttribute('label', customLabel);</span>
<a href="#l11.299"></a><span id="l11.299"> }</span>
<a href="#l11.300"></a><span id="l11.300"> </span>
<a href="#l11.301"></a><span id="l11.301"> function RemoveAllMessageTags()</span>
<a href="#l11.302"></a><span id="l11.302"> {</span>
<a href="#l11.303"></a><span id="l11.303" class="difflineminus">-  var selectedMsgUris = GetSelectedMessages();</span>
<a href="#l11.304"></a><span id="l11.304" class="difflineminus">-  if (!selectedMsgUris.length)</span>
<a href="#l11.305"></a><span id="l11.305" class="difflineplus">+  var selectedMessages = gFolderDisplay.selectedMessages;</span>
<a href="#l11.306"></a><span id="l11.306" class="difflineplus">+  if (!selectedMessages.length)</span>
<a href="#l11.307"></a><span id="l11.307">     return;</span>
<a href="#l11.308"></a><span id="l11.308"> </span>
<a href="#l11.309"></a><span id="l11.309">   var messages = Components.classes[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l11.310"></a><span id="l11.310">                            .createInstance(Components.interfaces.nsIMutableArray);</span>
<a href="#l11.311"></a><span id="l11.311">   var tagService = Components.classes[&quot;@mozilla.org/messenger/tagservice;1&quot;]</span>
<a href="#l11.312"></a><span id="l11.312">                              .getService(Components.interfaces.nsIMsgTagService);</span>
<a href="#l11.313"></a><span id="l11.313">   var tagArray = tagService.getAllTags({});</span>
<a href="#l11.314"></a><span id="l11.314"> </span>
<a href="#l11.315"></a><span id="l11.315" class="difflineat">@@ -518,19 +500,19 @@ function RemoveAllMessageTags()</span>
<a href="#l11.316"></a><span id="l11.316">   var prevHdrFolder = null;</span>
<a href="#l11.317"></a><span id="l11.317">   // this crudely handles cross-folder virtual folders with selected messages</span>
<a href="#l11.318"></a><span id="l11.318">   // that spans folders, by coalescing consecutive messages in the selection</span>
<a href="#l11.319"></a><span id="l11.319">   // that happen to be in the same folder. nsMsgSearchDBView does this better,</span>
<a href="#l11.320"></a><span id="l11.320">   // but nsIMsgDBView doesn't handle commands with arguments, and untag takes a</span>
<a href="#l11.321"></a><span id="l11.321">   // key argument. Furthermore, we only delete legacy labels and known tags,</span>
<a href="#l11.322"></a><span id="l11.322">   // keeping other keywords like (non)junk intact.</span>
<a href="#l11.323"></a><span id="l11.323"> </span>
<a href="#l11.324"></a><span id="l11.324" class="difflineminus">-  for (var i = 0; i &lt; selectedMsgUris.length; ++i)</span>
<a href="#l11.325"></a><span id="l11.325" class="difflineplus">+  for (var i = 0; i &lt; selectedMessages.length; ++i)</span>
<a href="#l11.326"></a><span id="l11.326">   {</span>
<a href="#l11.327"></a><span id="l11.327" class="difflineminus">-    var msgHdr = messenger.msgHdrFromURI(selectedMsgUris[i]);</span>
<a href="#l11.328"></a><span id="l11.328" class="difflineplus">+    var msgHdr = selectedMessages[i];</span>
<a href="#l11.329"></a><span id="l11.329">     msgHdr.label = 0; // remove legacy label</span>
<a href="#l11.330"></a><span id="l11.330">     if (prevHdrFolder != msgHdr.folder)</span>
<a href="#l11.331"></a><span id="l11.331">     {</span>
<a href="#l11.332"></a><span id="l11.332">       if (prevHdrFolder)</span>
<a href="#l11.333"></a><span id="l11.333">         prevHdrFolder.removeKeywordsFromMessages(messages, allKeys);</span>
<a href="#l11.334"></a><span id="l11.334">       messages.clear();</span>
<a href="#l11.335"></a><span id="l11.335">       prevHdrFolder = msgHdr.folder;</span>
<a href="#l11.336"></a><span id="l11.336">     }</span>
<a href="#l11.337"></a><span id="l11.337" class="difflineat">@@ -542,17 +524,17 @@ function RemoveAllMessageTags()</span>
<a href="#l11.338"></a><span id="l11.338"> }</span>
<a href="#l11.339"></a><span id="l11.339"> </span>
<a href="#l11.340"></a><span id="l11.340"> function ToggleMessageTagKey(index)</span>
<a href="#l11.341"></a><span id="l11.341"> {</span>
<a href="#l11.342"></a><span id="l11.342">   if (GetNumSelectedMessages() &lt; 1)</span>
<a href="#l11.343"></a><span id="l11.343">     return;</span>
<a href="#l11.344"></a><span id="l11.344">   // set the tag state based upon that of the first selected message,</span>
<a href="#l11.345"></a><span id="l11.345">   // just like we do for markAsRead etc.</span>
<a href="#l11.346"></a><span id="l11.346" class="difflineminus">-  var msgHdr = gDBView.hdrForFirstSelectedMessage;</span>
<a href="#l11.347"></a><span id="l11.347" class="difflineplus">+  var msgHdr = gFolderDisplay.selectedMessage;</span>
<a href="#l11.348"></a><span id="l11.348">   var tagService = Components.classes[&quot;@mozilla.org/messenger/tagservice;1&quot;]</span>
<a href="#l11.349"></a><span id="l11.349">                              .getService(Components.interfaces.nsIMsgTagService);</span>
<a href="#l11.350"></a><span id="l11.350">   var tagArray = tagService.getAllTags({});</span>
<a href="#l11.351"></a><span id="l11.351">   for (var i = 0; i &lt; tagArray.length; ++i)</span>
<a href="#l11.352"></a><span id="l11.352">   {</span>
<a href="#l11.353"></a><span id="l11.353">     var key = tagArray[i].key;</span>
<a href="#l11.354"></a><span id="l11.354">     if (!--index)</span>
<a href="#l11.355"></a><span id="l11.355">     {</span>
<a href="#l11.356"></a><span id="l11.356" class="difflineat">@@ -575,27 +557,27 @@ function ToggleMessageTagMenu(target)</span>
<a href="#l11.357"></a><span id="l11.357"> }</span>
<a href="#l11.358"></a><span id="l11.358"> </span>
<a href="#l11.359"></a><span id="l11.359"> function ToggleMessageTag(key, addKey)</span>
<a href="#l11.360"></a><span id="l11.360"> {</span>
<a href="#l11.361"></a><span id="l11.361">   var messages = Components.classes[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l11.362"></a><span id="l11.362">                            .createInstance(Components.interfaces.nsIMutableArray);</span>
<a href="#l11.363"></a><span id="l11.363">   var msg = Components.classes[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l11.364"></a><span id="l11.364">                       .createInstance(Components.interfaces.nsIMutableArray);</span>
<a href="#l11.365"></a><span id="l11.365" class="difflineminus">-  var selectedMsgUris = GetSelectedMessages();</span>
<a href="#l11.366"></a><span id="l11.366" class="difflineplus">+  var selectedMessages = gFolderDisplay.selectedMessages;</span>
<a href="#l11.367"></a><span id="l11.367">   var toggler = addKey ? &quot;addKeywordsToMessages&quot; : &quot;removeKeywordsFromMessages&quot;;</span>
<a href="#l11.368"></a><span id="l11.368">   var prevHdrFolder = null;</span>
<a href="#l11.369"></a><span id="l11.369">   // this crudely handles cross-folder virtual folders with selected messages</span>
<a href="#l11.370"></a><span id="l11.370">   // that spans folders, by coalescing consecutive msgs in the selection</span>
<a href="#l11.371"></a><span id="l11.371">   // that happen to be in the same folder. nsMsgSearchDBView does this</span>
<a href="#l11.372"></a><span id="l11.372">   // better, but nsIMsgDBView doesn't handle commands with arguments,</span>
<a href="#l11.373"></a><span id="l11.373">   // and (un)tag takes a key argument.</span>
<a href="#l11.374"></a><span id="l11.374" class="difflineminus">-  for (var i = 0; i &lt; selectedMsgUris.length; ++i)</span>
<a href="#l11.375"></a><span id="l11.375" class="difflineplus">+  for (var i = 0; i &lt; selectedMessages.length; ++i)</span>
<a href="#l11.376"></a><span id="l11.376">   {</span>
<a href="#l11.377"></a><span id="l11.377" class="difflineminus">-    var msgHdr = messenger.msgHdrFromURI(selectedMsgUris[i]);</span>
<a href="#l11.378"></a><span id="l11.378" class="difflineplus">+    var msgHdr = selectedMessages[i];</span>
<a href="#l11.379"></a><span id="l11.379">     if (msgHdr.label)</span>
<a href="#l11.380"></a><span id="l11.380">     {</span>
<a href="#l11.381"></a><span id="l11.381">       // Since we touch all these messages anyway, migrate the label now.</span>
<a href="#l11.382"></a><span id="l11.382">       // If we don't, the thread tree won't always show the correct tag state,</span>
<a href="#l11.383"></a><span id="l11.383">       // because resetting a label doesn't update the tree anymore...</span>
<a href="#l11.384"></a><span id="l11.384">       msg.clear();</span>
<a href="#l11.385"></a><span id="l11.385">       msg.appendElement(msgHdr, false);</span>
<a href="#l11.386"></a><span id="l11.386">       msgHdr.folder.addKeywordsToMessages(msg, &quot;$label&quot; + msgHdr.label);</span>
<a href="#l11.387"></a><span id="l11.387" class="difflineat">@@ -643,17 +625,17 @@ function AddTagCallback(name, color)</span>
<a href="#l11.388"></a><span id="l11.388"> function SetMessageTagLabel(menuitem, index, name)</span>
<a href="#l11.389"></a><span id="l11.389"> {</span>
<a href="#l11.390"></a><span id="l11.390">   // if a &lt;key&gt; is defined for this tag, use its key as the accesskey</span>
<a href="#l11.391"></a><span id="l11.391">   // (the key for the tag at index n needs to have the id key_tag&lt;n&gt;)</span>
<a href="#l11.392"></a><span id="l11.392">   var shortcutkey = document.getElementById(&quot;key_tag&quot; + index);</span>
<a href="#l11.393"></a><span id="l11.393">   var accesskey = shortcutkey ? shortcutkey.getAttribute(&quot;key&quot;) : &quot;&quot;;</span>
<a href="#l11.394"></a><span id="l11.394">   if (accesskey)</span>
<a href="#l11.395"></a><span id="l11.395">     menuitem.setAttribute(&quot;accesskey&quot;, accesskey);</span>
<a href="#l11.396"></a><span id="l11.396" class="difflineminus">-  var label = gMessengerBundle.getFormattedString(&quot;mailnews.tags.format&quot;, </span>
<a href="#l11.397"></a><span id="l11.397" class="difflineplus">+  var label = gMessengerBundle.getFormattedString(&quot;mailnews.tags.format&quot;,</span>
<a href="#l11.398"></a><span id="l11.398">                                                   [accesskey, name]);</span>
<a href="#l11.399"></a><span id="l11.399">   menuitem.setAttribute(&quot;label&quot;, label);</span>
<a href="#l11.400"></a><span id="l11.400"> }</span>
<a href="#l11.401"></a><span id="l11.401"> </span>
<a href="#l11.402"></a><span id="l11.402"> function InitMessageTags(menuPopup)</span>
<a href="#l11.403"></a><span id="l11.403"> {</span>
<a href="#l11.404"></a><span id="l11.404">   var tagService = Components.classes[&quot;@mozilla.org/messenger/tagservice;1&quot;]</span>
<a href="#l11.405"></a><span id="l11.405">                              .getService(Components.interfaces.nsIMsgTagService);</span>
<a href="#l11.406"></a><span id="l11.406" class="difflineat">@@ -668,17 +650,17 @@ function InitMessageTags(menuPopup)</span>
<a href="#l11.407"></a><span id="l11.407">   // hide double menuseparator</span>
<a href="#l11.408"></a><span id="l11.408">   menuseparator.previousSibling.hidden = !tagCount;</span>
<a href="#l11.409"></a><span id="l11.409"> </span>
<a href="#l11.410"></a><span id="l11.410">   // create label and accesskey for the static remove item</span>
<a href="#l11.411"></a><span id="l11.411">   var tagRemoveLabel = gMessengerBundle.getString(&quot;mailnews.tags.remove&quot;);</span>
<a href="#l11.412"></a><span id="l11.412">   SetMessageTagLabel(menuPopup.firstChild, 0, tagRemoveLabel);</span>
<a href="#l11.413"></a><span id="l11.413"> </span>
<a href="#l11.414"></a><span id="l11.414">   // now rebuild the list</span>
<a href="#l11.415"></a><span id="l11.415" class="difflineminus">-  var msgHdr = gDBView.hdrForFirstSelectedMessage;</span>
<a href="#l11.416"></a><span id="l11.416" class="difflineplus">+  var msgHdr = gFolderDisplay.selectedMessage;</span>
<a href="#l11.417"></a><span id="l11.417">   var curKeys = msgHdr.getStringProperty(&quot;keywords&quot;);</span>
<a href="#l11.418"></a><span id="l11.418">   if (msgHdr.label)</span>
<a href="#l11.419"></a><span id="l11.419">     curKeys += &quot; $label&quot; + msgHdr.label;</span>
<a href="#l11.420"></a><span id="l11.420"> </span>
<a href="#l11.421"></a><span id="l11.421">   for (var i = 0; i &lt; tagCount; ++i)</span>
<a href="#l11.422"></a><span id="l11.422">   {</span>
<a href="#l11.423"></a><span id="l11.423">     var taginfo = tagArray[i];</span>
<a href="#l11.424"></a><span id="l11.424">     // TODO we want to either remove or &quot;check&quot; the tags that already exist</span>
<a href="#l11.425"></a><span id="l11.425" class="difflineat">@@ -686,17 +668,17 @@ function InitMessageTags(menuPopup)</span>
<a href="#l11.426"></a><span id="l11.426">     SetMessageTagLabel(newMenuItem, i + 1, taginfo.tag);</span>
<a href="#l11.427"></a><span id="l11.427">     newMenuItem.setAttribute(&quot;value&quot;, taginfo.key);</span>
<a href="#l11.428"></a><span id="l11.428">     newMenuItem.setAttribute(&quot;type&quot;, &quot;checkbox&quot;);</span>
<a href="#l11.429"></a><span id="l11.429">     var removeKey = (&quot; &quot; + curKeys + &quot; &quot;).indexOf(&quot; &quot; + taginfo.key + &quot; &quot;) &gt; -1;</span>
<a href="#l11.430"></a><span id="l11.430">     newMenuItem.setAttribute('checked', removeKey);</span>
<a href="#l11.431"></a><span id="l11.431">     newMenuItem.setAttribute('oncommand', 'ToggleMessageTagMenu(event.target);');</span>
<a href="#l11.432"></a><span id="l11.432">     var color = taginfo.color;</span>
<a href="#l11.433"></a><span id="l11.433">     if (color)</span>
<a href="#l11.434"></a><span id="l11.434" class="difflineminus">-      newMenuItem.setAttribute(&quot;class&quot;, &quot;lc-&quot; + color.substr(1));    </span>
<a href="#l11.435"></a><span id="l11.435" class="difflineplus">+      newMenuItem.setAttribute(&quot;class&quot;, &quot;lc-&quot; + color.substr(1));</span>
<a href="#l11.436"></a><span id="l11.436">     menuPopup.insertBefore(newMenuItem, menuseparator);</span>
<a href="#l11.437"></a><span id="l11.437">   }</span>
<a href="#l11.438"></a><span id="l11.438"> }</span>
<a href="#l11.439"></a><span id="l11.439"> </span>
<a href="#l11.440"></a><span id="l11.440"> function backToolbarMenu_init(menuPopup)</span>
<a href="#l11.441"></a><span id="l11.441"> {</span>
<a href="#l11.442"></a><span id="l11.442">   populateHistoryMenu(menuPopup, true);</span>
<a href="#l11.443"></a><span id="l11.443"> }</span>
<a href="#l11.444"></a><span id="l11.444" class="difflineat">@@ -722,38 +704,43 @@ function populateHistoryMenu(menuPopup, </span>
<a href="#l11.445"></a><span id="l11.445">   var numEntries = new Object;</span>
<a href="#l11.446"></a><span id="l11.446">   var historyEntries = new Object;</span>
<a href="#l11.447"></a><span id="l11.447">   messenger.getNavigateHistory(curPos, numEntries, historyEntries);</span>
<a href="#l11.448"></a><span id="l11.448">   curPos.value = curPos.value * 2;</span>
<a href="#l11.449"></a><span id="l11.449">   navDebug(&quot;curPos = &quot; + curPos.value + &quot; numEntries = &quot; + numEntries.value + &quot;\n&quot;);</span>
<a href="#l11.450"></a><span id="l11.450">   var historyArray = historyEntries.value;</span>
<a href="#l11.451"></a><span id="l11.451">   var folder;</span>
<a href="#l11.452"></a><span id="l11.452">   var newMenuItem;</span>
<a href="#l11.453"></a><span id="l11.453" class="difflineminus">-  if (GetLoadedMessage())</span>
<a href="#l11.454"></a><span id="l11.454" class="difflineplus">+  if (gFolderDisplay.selectedMessage)</span>
<a href="#l11.455"></a><span id="l11.455">   {</span>
<a href="#l11.456"></a><span id="l11.456">     if (!isBackMenu)</span>
<a href="#l11.457"></a><span id="l11.457">       curPos.value += 2;</span>
<a href="#l11.458"></a><span id="l11.458">     else</span>
<a href="#l11.459"></a><span id="l11.459">       curPos.value -= 2;</span>
<a href="#l11.460"></a><span id="l11.460">   }</span>
<a href="#l11.461"></a><span id="l11.461">   // For populating the back menu, we want the most recently visited</span>
<a href="#l11.462"></a><span id="l11.462">   // messages first in the menu. So we go backward from curPos to 0.</span>
<a href="#l11.463"></a><span id="l11.463">   // For the forward menu, we want to go forward from curPos to the end.</span>
<a href="#l11.464"></a><span id="l11.464">   var relPos = 0;</span>
<a href="#l11.465"></a><span id="l11.465">   for (var i = curPos.value; (isBackMenu) ? i &gt;= 0 : i &lt; historyArray.length; i += ((isBackMenu) ? -2 : 2))</span>
<a href="#l11.466"></a><span id="l11.466">   {</span>
<a href="#l11.467"></a><span id="l11.467">     navDebug(&quot;history[&quot; + i + &quot;] = &quot; + historyArray[i] + &quot;\n&quot;);</span>
<a href="#l11.468"></a><span id="l11.468">     navDebug(&quot;history[&quot; + i + &quot;] = &quot; + historyArray[i + 1] + &quot;\n&quot;);</span>
<a href="#l11.469"></a><span id="l11.469" class="difflineminus">-    folder = GetMsgFolderFromUri(historyArray[i + 1])</span>
<a href="#l11.470"></a><span id="l11.470" class="difflineplus">+    folder = GetMsgFolderFromUri(historyArray[i + 1]);</span>
<a href="#l11.471"></a><span id="l11.471">     navDebug(&quot;folder URI = &quot; + folder.URI + &quot;pretty name &quot; + folder.prettyName + &quot;\n&quot;);</span>
<a href="#l11.472"></a><span id="l11.472">     var menuText = &quot;&quot;;</span>
<a href="#l11.473"></a><span id="l11.473"> </span>
<a href="#l11.474"></a><span id="l11.474" class="difflineplus">+    // If the message was not being displayed via the current folder, prepend</span>
<a href="#l11.475"></a><span id="l11.475" class="difflineplus">+    //  the folder name.  We do not need to check underlying folders for</span>
<a href="#l11.476"></a><span id="l11.476" class="difflineplus">+    //  virtual folders because 'folder' is the display folder, not the</span>
<a href="#l11.477"></a><span id="l11.477" class="difflineplus">+    //  underlying one.</span>
<a href="#l11.478"></a><span id="l11.478" class="difflineplus">+    if (folder != gFolderDisplay.displayedFolder)</span>
<a href="#l11.479"></a><span id="l11.479" class="difflineplus">+      menuText = folder.prettyName + &quot; - &quot;;</span>
<a href="#l11.480"></a><span id="l11.480" class="difflineplus">+</span>
<a href="#l11.481"></a><span id="l11.481">     var msgHdr = messenger.msgHdrFromURI(historyArray[i]);</span>
<a href="#l11.482"></a><span id="l11.482" class="difflineminus">-    if (!IsCurrentLoadedFolder(folder))</span>
<a href="#l11.483"></a><span id="l11.483" class="difflineminus">-      menuText = folder.prettyName + &quot; - &quot;;</span>
<a href="#l11.484"></a><span id="l11.484"> </span>
<a href="#l11.485"></a><span id="l11.485">     var subject = &quot;&quot;;</span>
<a href="#l11.486"></a><span id="l11.486">     if (msgHdr.flags &amp; Components.interfaces.nsMsgMessageFlags.HasRe)</span>
<a href="#l11.487"></a><span id="l11.487">       subject = &quot;Re: &quot;;</span>
<a href="#l11.488"></a><span id="l11.488">     if (msgHdr.mime2DecodedSubject)</span>
<a href="#l11.489"></a><span id="l11.489">       subject += msgHdr.mime2DecodedSubject;</span>
<a href="#l11.490"></a><span id="l11.490">     if (subject)</span>
<a href="#l11.491"></a><span id="l11.491">       menuText += subject + &quot; - &quot;;</span>
<a href="#l11.492"></a><span id="l11.492" class="difflineat">@@ -766,27 +753,38 @@ function populateHistoryMenu(menuPopup, </span>
<a href="#l11.493"></a><span id="l11.493">     newMenuItem.folder = folder;</span>
<a href="#l11.494"></a><span id="l11.494">     newMenuItem.setAttribute('oncommand', 'NavigateToUri(event.target); event.stopPropagation();');</span>
<a href="#l11.495"></a><span id="l11.495">     menuPopup.appendChild(newMenuItem);</span>
<a href="#l11.496"></a><span id="l11.496">     if (! (relPos % 20))</span>
<a href="#l11.497"></a><span id="l11.497">       break;</span>
<a href="#l11.498"></a><span id="l11.498">   }</span>
<a href="#l11.499"></a><span id="l11.499"> }</span>
<a href="#l11.500"></a><span id="l11.500"> </span>
<a href="#l11.501"></a><span id="l11.501" class="difflineplus">+/**</span>
<a href="#l11.502"></a><span id="l11.502" class="difflineplus">+ * This is triggered by the history navigation menu options, as created by</span>
<a href="#l11.503"></a><span id="l11.503" class="difflineplus">+ *  populateHistoryMenu above.</span>
<a href="#l11.504"></a><span id="l11.504" class="difflineplus">+ */</span>
<a href="#l11.505"></a><span id="l11.505"> function NavigateToUri(target)</span>
<a href="#l11.506"></a><span id="l11.506"> {</span>
<a href="#l11.507"></a><span id="l11.507">   var historyIndex = target.getAttribute('value');</span>
<a href="#l11.508"></a><span id="l11.508">   var msgUri = messenger.getMsgUriAtNavigatePos(historyIndex);</span>
<a href="#l11.509"></a><span id="l11.509">   var folder = target.folder;</span>
<a href="#l11.510"></a><span id="l11.510">   var msgHdr = messenger.msgHdrFromURI(msgUri);</span>
<a href="#l11.511"></a><span id="l11.511">   navDebug(&quot;navigating from &quot; + messenger.navigatePos + &quot; by &quot; + historyIndex + &quot; to &quot; + msgUri + &quot;\n&quot;);</span>
<a href="#l11.512"></a><span id="l11.512"> </span>
<a href="#l11.513"></a><span id="l11.513">   // this &quot;- 0&quot; seems to ensure that historyIndex is treated as an int, not a string.</span>
<a href="#l11.514"></a><span id="l11.514">   messenger.navigatePos += (historyIndex - 0);</span>
<a href="#l11.515"></a><span id="l11.515" class="difflineminus">-  LoadNavigatedToMessage(msgHdr, folder, folder.URI);</span>
<a href="#l11.516"></a><span id="l11.516" class="difflineplus">+</span>
<a href="#l11.517"></a><span id="l11.517" class="difflineplus">+  if (gFolderDisplay.displayedFolder != folder) {</span>
<a href="#l11.518"></a><span id="l11.518" class="difflineplus">+    if (gFolderTreeView)</span>
<a href="#l11.519"></a><span id="l11.519" class="difflineplus">+      gFolderTreeView.selectFolder(folder);</span>
<a href="#l11.520"></a><span id="l11.520" class="difflineplus">+    else</span>
<a href="#l11.521"></a><span id="l11.521" class="difflineplus">+      gFolderDisplay.show(folder);</span>
<a href="#l11.522"></a><span id="l11.522" class="difflineplus">+  }</span>
<a href="#l11.523"></a><span id="l11.523" class="difflineplus">+  gFolderDisplay.selectMessage(msgHdr);</span>
<a href="#l11.524"></a><span id="l11.524"> }</span>
<a href="#l11.525"></a><span id="l11.525"> </span>
<a href="#l11.526"></a><span id="l11.526"> function forwardToolbarMenu_init(menuPopup)</span>
<a href="#l11.527"></a><span id="l11.527"> {</span>
<a href="#l11.528"></a><span id="l11.528">   populateHistoryMenu(menuPopup, false);</span>
<a href="#l11.529"></a><span id="l11.529"> }</span>
<a href="#l11.530"></a><span id="l11.530"> </span>
<a href="#l11.531"></a><span id="l11.531"> function InitMessageMark()</span>
<a href="#l11.532"></a><span id="l11.532" class="difflineat">@@ -804,33 +802,33 @@ function UpdateJunkToolbarButton()</span>
<a href="#l11.533"></a><span id="l11.533"> {</span>
<a href="#l11.534"></a><span id="l11.534">   var junkButtonDeck = document.getElementById(&quot;junk-deck&quot;);</span>
<a href="#l11.535"></a><span id="l11.535">   if (junkButtonDeck)</span>
<a href="#l11.536"></a><span id="l11.536">     junkButtonDeck.selectedIndex = SelectedMessagesAreJunk() ? 1 : 0;</span>
<a href="#l11.537"></a><span id="l11.537"> }</span>
<a href="#l11.538"></a><span id="l11.538"> </span>
<a href="#l11.539"></a><span id="l11.539"> function UpdateReplyButtons()</span>
<a href="#l11.540"></a><span id="l11.540"> {</span>
<a href="#l11.541"></a><span id="l11.541" class="difflineminus">-  let msgHdr = messenger.msgHdrFromURI(GetLoadedMessage());</span>
<a href="#l11.542"></a><span id="l11.542" class="difflineplus">+  let msgHdr = gFolderDisplay.selectedMessage;</span>
<a href="#l11.543"></a><span id="l11.543"> </span>
<a href="#l11.544"></a><span id="l11.544">   let myEmail = getIdentityForHeader(msgHdr).email;</span>
<a href="#l11.545"></a><span id="l11.545">   let recipients = msgHdr.recipients + &quot;,&quot; + msgHdr.ccList;</span>
<a href="#l11.546"></a><span id="l11.546"> </span>
<a href="#l11.547"></a><span id="l11.547">   // If my email address isn't in the to or cc list, then I've been bcc-ed.</span>
<a href="#l11.548"></a><span id="l11.548">   let imBcced = recipients.indexOf(myEmail) == -1;</span>
<a href="#l11.549"></a><span id="l11.549"> </span>
<a href="#l11.550"></a><span id="l11.550">   // Now, let's get the number of unique recipients</span>
<a href="#l11.551"></a><span id="l11.551">   let hdrParser = Components.classes[&quot;@mozilla.org/messenger/headerparser;1&quot;]</span>
<a href="#l11.552"></a><span id="l11.552">                             .getService(Components.interfaces.nsIMsgHeaderParser);</span>
<a href="#l11.553"></a><span id="l11.553">   let uniqueRecipients = hdrParser.removeDuplicateAddresses(recipients, {});</span>
<a href="#l11.554"></a><span id="l11.554">   let numAddresses = hdrParser.parseHeadersWithArray(uniqueRecipients, {}, {}, {});</span>
<a href="#l11.555"></a><span id="l11.555"> </span>
<a href="#l11.556"></a><span id="l11.556">   // If I've been bcc-ed, then add 1 to the number of addresses to compensate.</span>
<a href="#l11.557"></a><span id="l11.557">   if (imBcced)</span>
<a href="#l11.558"></a><span id="l11.558" class="difflineminus">-    numAddresses++</span>
<a href="#l11.559"></a><span id="l11.559" class="difflineplus">+    numAddresses++;</span>
<a href="#l11.560"></a><span id="l11.560"> </span>
<a href="#l11.561"></a><span id="l11.561">   // By default, ReplyAll if there is more than 1 person to reply to.</span>
<a href="#l11.562"></a><span id="l11.562">   let showReplyAll = numAddresses &gt; 1;</span>
<a href="#l11.563"></a><span id="l11.563"> </span>
<a href="#l11.564"></a><span id="l11.564">   // And ReplyToList if there is a List-Post header.</span>
<a href="#l11.565"></a><span id="l11.565">   let showReplyList = currentHeaderData[&quot;list-post&quot;];</span>
<a href="#l11.566"></a><span id="l11.566"> </span>
<a href="#l11.567"></a><span id="l11.567">   // Get the server type.</span>
<a href="#l11.568"></a><span id="l11.568" class="difflineat">@@ -913,57 +911,57 @@ function UpdateDeleteToolbarButton()</span>
<a href="#l11.569"></a><span id="l11.569">       GetNumSelectedMessages() == 0)</span>
<a href="#l11.570"></a><span id="l11.570">     deleteButtonDeck.selectedIndex = 0;</span>
<a href="#l11.571"></a><span id="l11.571">   else</span>
<a href="#l11.572"></a><span id="l11.572">     deleteButtonDeck.selectedIndex = SelectedMessagesAreDeleted() ? 1 : 0;</span>
<a href="#l11.573"></a><span id="l11.573"> }</span>
<a href="#l11.574"></a><span id="l11.574"> function UpdateDeleteCommand()</span>
<a href="#l11.575"></a><span id="l11.575"> {</span>
<a href="#l11.576"></a><span id="l11.576">   var value = &quot;value&quot;;</span>
<a href="#l11.577"></a><span id="l11.577" class="difflineminus">-  var uri = GetFirstSelectedMessage();</span>
<a href="#l11.578"></a><span id="l11.578" class="difflineminus">-  if (IsNewsMessage(uri))</span>
<a href="#l11.579"></a><span id="l11.579" class="difflineplus">+  if (gFolderDisplay.selectedMessageIsNews)</span>
<a href="#l11.580"></a><span id="l11.580">     value += &quot;News&quot;;</span>
<a href="#l11.581"></a><span id="l11.581">   else if (SelectedMessagesAreDeleted())</span>
<a href="#l11.582"></a><span id="l11.582">     value += &quot;IMAPDeleted&quot;;</span>
<a href="#l11.583"></a><span id="l11.583">   if (GetNumSelectedMessages() &lt; 2)</span>
<a href="#l11.584"></a><span id="l11.584">     value += &quot;Message&quot;;</span>
<a href="#l11.585"></a><span id="l11.585">   else</span>
<a href="#l11.586"></a><span id="l11.586">     value += &quot;Messages&quot;;</span>
<a href="#l11.587"></a><span id="l11.587">   goSetMenuValue(&quot;cmd_delete&quot;, value);</span>
<a href="#l11.588"></a><span id="l11.588">   goSetAccessKey(&quot;cmd_delete&quot;, value + &quot;AccessKey&quot;);</span>
<a href="#l11.589"></a><span id="l11.589"> }</span>
<a href="#l11.590"></a><span id="l11.590"> </span>
<a href="#l11.591"></a><span id="l11.591"> function SelectedMessagesAreDeleted()</span>
<a href="#l11.592"></a><span id="l11.592"> {</span>
<a href="#l11.593"></a><span id="l11.593" class="difflineminus">-  return gDBView &amp;&amp; gDBView.numSelected &amp;&amp;</span>
<a href="#l11.594"></a><span id="l11.594" class="difflineminus">-         (gDBView.hdrForFirstSelectedMessage.flags &amp;</span>
<a href="#l11.595"></a><span id="l11.595" class="difflineplus">+  let firstSelectedMessage = gFolderDisplay.selectedMessage;</span>
<a href="#l11.596"></a><span id="l11.596" class="difflineplus">+  return firstSelectedMessage &amp;&amp;</span>
<a href="#l11.597"></a><span id="l11.597" class="difflineplus">+         (firstSelectedMessage.flags &amp;</span>
<a href="#l11.598"></a><span id="l11.598">           Components.interfaces.nsMsgMessageFlags.IMAPDeleted);</span>
<a href="#l11.599"></a><span id="l11.599"> }</span>
<a href="#l11.600"></a><span id="l11.600"> </span>
<a href="#l11.601"></a><span id="l11.601"> function SelectedMessagesAreJunk()</span>
<a href="#l11.602"></a><span id="l11.602"> {</span>
<a href="#l11.603"></a><span id="l11.603">   try {</span>
<a href="#l11.604"></a><span id="l11.604" class="difflineminus">-    var junkScore = gDBView.hdrForFirstSelectedMessage.getStringProperty(&quot;junkscore&quot;);</span>
<a href="#l11.605"></a><span id="l11.605" class="difflineplus">+    var junkScore = gFolderDisplay.selectedMessage.getStringProperty(&quot;junkscore&quot;);</span>
<a href="#l11.606"></a><span id="l11.606">     return (junkScore != &quot;&quot;) &amp;&amp; (junkScore != &quot;0&quot;);</span>
<a href="#l11.607"></a><span id="l11.607">   }</span>
<a href="#l11.608"></a><span id="l11.608">   catch (ex) {</span>
<a href="#l11.609"></a><span id="l11.609">     return false;</span>
<a href="#l11.610"></a><span id="l11.610">   }</span>
<a href="#l11.611"></a><span id="l11.611"> }</span>
<a href="#l11.612"></a><span id="l11.612"> </span>
<a href="#l11.613"></a><span id="l11.613"> function SelectedMessagesAreRead()</span>
<a href="#l11.614"></a><span id="l11.614"> {</span>
<a href="#l11.615"></a><span id="l11.615" class="difflineminus">-  return gDBView &amp;&amp; gDBView.numSelected &amp;&amp;</span>
<a href="#l11.616"></a><span id="l11.616" class="difflineminus">-         gDBView.hdrForFirstSelectedMessage.isRead;</span>
<a href="#l11.617"></a><span id="l11.617" class="difflineplus">+  let firstSelectedMessage = gFolderDisplay.selectedMessage;</span>
<a href="#l11.618"></a><span id="l11.618" class="difflineplus">+  return firstSelectedMessage &amp;&amp; firstSelectedMessage.isRead;</span>
<a href="#l11.619"></a><span id="l11.619"> }</span>
<a href="#l11.620"></a><span id="l11.620"> </span>
<a href="#l11.621"></a><span id="l11.621"> function SelectedMessagesAreFlagged()</span>
<a href="#l11.622"></a><span id="l11.622"> {</span>
<a href="#l11.623"></a><span id="l11.623" class="difflineminus">-  return gDBView &amp;&amp; gDBView.numSelected &amp;&amp;</span>
<a href="#l11.624"></a><span id="l11.624" class="difflineminus">-         gDBView.hdrForFirstSelectedMessage.isFlagged;</span>
<a href="#l11.625"></a><span id="l11.625" class="difflineplus">+  let firstSelectedMessage = gFolderDisplay.selectedMessage;</span>
<a href="#l11.626"></a><span id="l11.626" class="difflineplus">+  return firstSelectedMessage &amp;&amp; firstSelectedMessage.isFlagged;</span>
<a href="#l11.627"></a><span id="l11.627"> }</span>
<a href="#l11.628"></a><span id="l11.628"> </span>
<a href="#l11.629"></a><span id="l11.629"> function GetFirstSelectedMsgFolder()</span>
<a href="#l11.630"></a><span id="l11.630"> {</span>
<a href="#l11.631"></a><span id="l11.631">   var selectedFolders = GetSelectedMsgFolders();</span>
<a href="#l11.632"></a><span id="l11.632">   return (selectedFolders.length &gt; 0) ? selectedFolders[0] : null;</span>
<a href="#l11.633"></a><span id="l11.633"> }</span>
<a href="#l11.634"></a><span id="l11.634"> </span>
<a href="#l11.635"></a><span id="l11.635" class="difflineat">@@ -1092,20 +1090,20 @@ function MsgGetNextNMessages()</span>
<a href="#l11.636"></a><span id="l11.636">   if (MailOfflineMgr.isOnline() || MailOfflineMgr.getNewMail())</span>
<a href="#l11.637"></a><span id="l11.637">     GetNextNMessages(GetFirstSelectedMsgFolder());</span>
<a href="#l11.638"></a><span id="l11.638"> }</span>
<a href="#l11.639"></a><span id="l11.639"> </span>
<a href="#l11.640"></a><span id="l11.640"> function MsgDeleteMessage(reallyDelete, fromToolbar)</span>
<a href="#l11.641"></a><span id="l11.641"> {</span>
<a href="#l11.642"></a><span id="l11.642">   // If from the toolbar, return right away if this is a news message</span>
<a href="#l11.643"></a><span id="l11.643">   // only allow cancel from the menu:  &quot;Edit | Cancel / Delete Message&quot;.</span>
<a href="#l11.644"></a><span id="l11.644" class="difflineminus">-  if (fromToolbar &amp;&amp; isNewsURI(GetLoadedMsgFolder().URI))</span>
<a href="#l11.645"></a><span id="l11.645" class="difflineplus">+  if (fromToolbar &amp;&amp; gFolderDisplay.view.isNewsFolder)</span>
<a href="#l11.646"></a><span id="l11.646">     return;</span>
<a href="#l11.647"></a><span id="l11.647"> </span>
<a href="#l11.648"></a><span id="l11.648" class="difflineminus">-  SetNextMessageAfterDelete();</span>
<a href="#l11.649"></a><span id="l11.649" class="difflineplus">+  gFolderDisplay.hintAboutToDeleteMessages();</span>
<a href="#l11.650"></a><span id="l11.650">   if (reallyDelete)</span>
<a href="#l11.651"></a><span id="l11.651">     gDBView.doCommand(nsMsgViewCommandType.deleteNoTrash);</span>
<a href="#l11.652"></a><span id="l11.652">   else</span>
<a href="#l11.653"></a><span id="l11.653">     gDBView.doCommand(nsMsgViewCommandType.deleteMsg);</span>
<a href="#l11.654"></a><span id="l11.654"> }</span>
<a href="#l11.655"></a><span id="l11.655"> </span>
<a href="#l11.656"></a><span id="l11.656"> /**</span>
<a href="#l11.657"></a><span id="l11.657">  * Copies the selected messages to the destination folder</span>
<a href="#l11.658"></a><span id="l11.658" class="difflineat">@@ -1124,17 +1122,17 @@ function MsgCopyMessage(aDestFolder)</span>
<a href="#l11.659"></a><span id="l11.659">  */</span>
<a href="#l11.660"></a><span id="l11.660"> function MsgMoveMessage(aDestFolder)</span>
<a href="#l11.661"></a><span id="l11.661"> {</span>
<a href="#l11.662"></a><span id="l11.662">   // We don't move news messages, we copy them.</span>
<a href="#l11.663"></a><span id="l11.663">   if (isNewsURI(gDBView.msgFolder.URI))</span>
<a href="#l11.664"></a><span id="l11.664">     gDBView.doCommandWithFolder(nsMsgViewCommandType.copyMessages, aDestFolder);</span>
<a href="#l11.665"></a><span id="l11.665">   else</span>
<a href="#l11.666"></a><span id="l11.666">   {</span>
<a href="#l11.667"></a><span id="l11.667" class="difflineminus">-    SetNextMessageAfterDelete();</span>
<a href="#l11.668"></a><span id="l11.668" class="difflineplus">+    gFolderDisplay.hintAboutToDeleteMessages();</span>
<a href="#l11.669"></a><span id="l11.669">     gDBView.doCommandWithFolder(nsMsgViewCommandType.moveMessages, aDestFolder);</span>
<a href="#l11.670"></a><span id="l11.670">   }</span>
<a href="#l11.671"></a><span id="l11.671">   pref.setCharPref(&quot;mail.last_msg_movecopy_target_uri&quot;, aDestFolder.URI);</span>
<a href="#l11.672"></a><span id="l11.672">   pref.setBoolPref(&quot;mail.last_msg_movecopy_was_move&quot;, true);</span>
<a href="#l11.673"></a><span id="l11.673"> }</span>
<a href="#l11.674"></a><span id="l11.674"> </span>
<a href="#l11.675"></a><span id="l11.675"> /**</span>
<a href="#l11.676"></a><span id="l11.676">  * Calls the ComposeMessage function with the desired type, and proper default</span>
<a href="#l11.677"></a><span id="l11.677" class="difflineat">@@ -1142,32 +1140,34 @@ function MsgMoveMessage(aDestFolder)</span>
<a href="#l11.678"></a><span id="l11.678">  *</span>
<a href="#l11.679"></a><span id="l11.679">  * @param aCompType  the nsIMsgCompType to pass to the function</span>
<a href="#l11.680"></a><span id="l11.680">  * @param aEvent (optional) the event that triggered the call</span>
<a href="#l11.681"></a><span id="l11.681">  */</span>
<a href="#l11.682"></a><span id="l11.682"> function composeMsgByType(aCompType, aEvent) {</span>
<a href="#l11.683"></a><span id="l11.683">   if (aEvent &amp;&amp; aEvent.shiftKey) {</span>
<a href="#l11.684"></a><span id="l11.684">     ComposeMessage(aCompType,</span>
<a href="#l11.685"></a><span id="l11.685">                    Components.interfaces.nsIMsgCompFormat.OppositeOfDefault,</span>
<a href="#l11.686"></a><span id="l11.686" class="difflineminus">-                   GetFirstSelectedMsgFolder(), GetSelectedMessages());</span>
<a href="#l11.687"></a><span id="l11.687" class="difflineplus">+                   GetFirstSelectedMsgFolder(),</span>
<a href="#l11.688"></a><span id="l11.688" class="difflineplus">+                   gFolderDisplay.selectedMessageUris);</span>
<a href="#l11.689"></a><span id="l11.689">   }</span>
<a href="#l11.690"></a><span id="l11.690">   else {</span>
<a href="#l11.691"></a><span id="l11.691">     ComposeMessage(aCompType, Components.interfaces.nsIMsgCompFormat.Default,</span>
<a href="#l11.692"></a><span id="l11.692" class="difflineminus">-                   GetFirstSelectedMsgFolder(), GetSelectedMessages());</span>
<a href="#l11.693"></a><span id="l11.693" class="difflineplus">+                   GetFirstSelectedMsgFolder(),</span>
<a href="#l11.694"></a><span id="l11.694" class="difflineplus">+                   gFolderDisplay.selectedMessageUris);</span>
<a href="#l11.695"></a><span id="l11.695">   }</span>
<a href="#l11.696"></a><span id="l11.696"> }</span>
<a href="#l11.697"></a><span id="l11.697"> </span>
<a href="#l11.698"></a><span id="l11.698"> function MsgNewMessage(event)</span>
<a href="#l11.699"></a><span id="l11.699"> {</span>
<a href="#l11.700"></a><span id="l11.700">   composeMsgByType(Components.interfaces.nsIMsgCompType.New, event);</span>
<a href="#l11.701"></a><span id="l11.701"> }</span>
<a href="#l11.702"></a><span id="l11.702"> </span>
<a href="#l11.703"></a><span id="l11.703"> function MsgReplyMessage(event)</span>
<a href="#l11.704"></a><span id="l11.704"> {</span>
<a href="#l11.705"></a><span id="l11.705" class="difflineminus">-  var loadedFolder = GetLoadedMsgFolder();</span>
<a href="#l11.706"></a><span id="l11.706" class="difflineplus">+  var loadedFolder = gFolderDisplay.displayedFolder;</span>
<a href="#l11.707"></a><span id="l11.707">   if (loadedFolder)</span>
<a href="#l11.708"></a><span id="l11.708">   {</span>
<a href="#l11.709"></a><span id="l11.709">     var server = loadedFolder.server;</span>
<a href="#l11.710"></a><span id="l11.710">     if(server &amp;&amp; server.type == &quot;nntp&quot;)</span>
<a href="#l11.711"></a><span id="l11.711">     {</span>
<a href="#l11.712"></a><span id="l11.712">       MsgReplyGroup(event);</span>
<a href="#l11.713"></a><span id="l11.713">       return;</span>
<a href="#l11.714"></a><span id="l11.714">     }</span>
<a href="#l11.715"></a><span id="l11.715" class="difflineat">@@ -1202,50 +1202,47 @@ function BatchMessageMover()</span>
<a href="#l11.716"></a><span id="l11.716">   this._batches = {};</span>
<a href="#l11.717"></a><span id="l11.717">   this._currentKey = null;</span>
<a href="#l11.718"></a><span id="l11.718"> }</span>
<a href="#l11.719"></a><span id="l11.719"> </span>
<a href="#l11.720"></a><span id="l11.720"> BatchMessageMover.prototype = {</span>
<a href="#l11.721"></a><span id="l11.721"> </span>
<a href="#l11.722"></a><span id="l11.722">   archiveSelectedMessages: function()</span>
<a href="#l11.723"></a><span id="l11.723">   {</span>
<a href="#l11.724"></a><span id="l11.724" class="difflineminus">-    // subtle:</span>
<a href="#l11.725"></a><span id="l11.725" class="difflineminus">-    SetNextMessageAfterDelete(); // we're just pretending</span>
<a href="#l11.726"></a><span id="l11.726" class="difflineminus">-    this.messageToSelectAfterWereDone = gNextMessageViewIndexAfterDelete;</span>
<a href="#l11.727"></a><span id="l11.727" class="difflineminus">-    gNextMessageViewIndexAfterDelete = -2;</span>
<a href="#l11.728"></a><span id="l11.728" class="difflineminus">-</span>
<a href="#l11.729"></a><span id="l11.729" class="difflineminus">-    let selectedMsgUris = GetSelectedMessages();</span>
<a href="#l11.730"></a><span id="l11.730" class="difflineminus">-    if (!selectedMsgUris.length)</span>
<a href="#l11.731"></a><span id="l11.731" class="difflineplus">+    gFolderDisplay.hintMassMoveStarting();</span>
<a href="#l11.732"></a><span id="l11.732" class="difflineplus">+</span>
<a href="#l11.733"></a><span id="l11.733" class="difflineplus">+    let selectedMessages = gFolderDisplay.selectedMessages;</span>
<a href="#l11.734"></a><span id="l11.734" class="difflineplus">+    if (!selectedMessages.length)</span>
<a href="#l11.735"></a><span id="l11.735">       return;</span>
<a href="#l11.736"></a><span id="l11.736" class="difflineminus">-    </span>
<a href="#l11.737"></a><span id="l11.737" class="difflineplus">+</span>
<a href="#l11.738"></a><span id="l11.738">     let messages = Components.classes[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l11.739"></a><span id="l11.739">                              .createInstance(Components.interfaces.nsIMutableArray);</span>
<a href="#l11.740"></a><span id="l11.740" class="difflineminus">-    </span>
<a href="#l11.741"></a><span id="l11.741" class="difflineminus">-    for (let i = 0; i &lt; selectedMsgUris.length; ++i)</span>
<a href="#l11.742"></a><span id="l11.742" class="difflineplus">+</span>
<a href="#l11.743"></a><span id="l11.743" class="difflineplus">+    for (let i = 0; i &lt; selectedMessages.length; ++i)</span>
<a href="#l11.744"></a><span id="l11.744">     {</span>
<a href="#l11.745"></a><span id="l11.745" class="difflineminus">-      let msgHdr = messenger.msgHdrFromURI(selectedMsgUris[i]);</span>
<a href="#l11.746"></a><span id="l11.746" class="difflineminus">-  </span>
<a href="#l11.747"></a><span id="l11.747" class="difflineplus">+      let msgHdr = selectedMessages[i];</span>
<a href="#l11.748"></a><span id="l11.748" class="difflineplus">+</span>
<a href="#l11.749"></a><span id="l11.749">       let rootFolder = msgHdr.folder.server.rootFolder;</span>
<a href="#l11.750"></a><span id="l11.750" class="difflineminus">-  </span>
<a href="#l11.751"></a><span id="l11.751" class="difflineplus">+</span>
<a href="#l11.752"></a><span id="l11.752">       let msgDate = new Date(msgHdr.date / 1000);  // convert date to JS date object</span>
<a href="#l11.753"></a><span id="l11.753">       let msgYear = msgDate.getFullYear().toString();</span>
<a href="#l11.754"></a><span id="l11.754">       let monthFolderName = msgDate.toLocaleFormat(&quot;%Y-%m&quot;)</span>
<a href="#l11.755"></a><span id="l11.755">       let dstFolderName = monthFolderName;</span>
<a href="#l11.756"></a><span id="l11.756"> </span>
<a href="#l11.757"></a><span id="l11.757">       let copyBatchKey = msgHdr.folder.URI + '\000' + dstFolderName;</span>
<a href="#l11.758"></a><span id="l11.758">       if (! (copyBatchKey in this._batches)) {</span>
<a href="#l11.759"></a><span id="l11.759">         this._batches[copyBatchKey] = [msgHdr.folder, msgYear, dstFolderName];</span>
<a href="#l11.760"></a><span id="l11.760">       }</span>
<a href="#l11.761"></a><span id="l11.761">       this._batches[copyBatchKey].push(msgHdr);</span>
<a href="#l11.762"></a><span id="l11.762">     }</span>
<a href="#l11.763"></a><span id="l11.763">     // Now we launch the code that will iterate over all of the message copies</span>
<a href="#l11.764"></a><span id="l11.764">     // one in turn</span>
<a href="#l11.765"></a><span id="l11.765">     this.processNextBatch();</span>
<a href="#l11.766"></a><span id="l11.766">   },</span>
<a href="#l11.767"></a><span id="l11.767" class="difflineminus">-  </span>
<a href="#l11.768"></a><span id="l11.768" class="difflineplus">+</span>
<a href="#l11.769"></a><span id="l11.769">   processNextBatch: function()</span>
<a href="#l11.770"></a><span id="l11.770">   {</span>
<a href="#l11.771"></a><span id="l11.771">     for (let key in this._batches)</span>
<a href="#l11.772"></a><span id="l11.772">     {</span>
<a href="#l11.773"></a><span id="l11.773">       this._currentKey = key;</span>
<a href="#l11.774"></a><span id="l11.774">       let batch = this._batches[key];</span>
<a href="#l11.775"></a><span id="l11.775">       let srcFolder = batch[0];</span>
<a href="#l11.776"></a><span id="l11.776">       let msgYear = batch[1];</span>
<a href="#l11.777"></a><span id="l11.777" class="difflineat">@@ -1256,18 +1253,18 @@ BatchMessageMover.prototype = {</span>
<a href="#l11.778"></a><span id="l11.778">       // rss servers don't have an identity so we special case the archives URI</span>
<a href="#l11.779"></a><span id="l11.779">       let archiveFolderUri = (srcFolder.server.type == 'rss')</span>
<a href="#l11.780"></a><span id="l11.780">         ? srcFolder.server.serverURI + &quot;/Archives&quot;</span>
<a href="#l11.781"></a><span id="l11.781">         : getIdentityForHeader(msgs[0], Ci.nsIMsgCompType</span>
<a href="#l11.782"></a><span id="l11.782">                                         .ReplyAll).archiveFolder;</span>
<a href="#l11.783"></a><span id="l11.783"> </span>
<a href="#l11.784"></a><span id="l11.784">       let archiveFolder = GetMsgFolderFromUri(archiveFolderUri, false);</span>
<a href="#l11.785"></a><span id="l11.785">       let granularity = archiveFolder.server.archiveGranularity;</span>
<a href="#l11.786"></a><span id="l11.786" class="difflineminus">-      // for imap folders, we need to create the sub-folders asynchronously, </span>
<a href="#l11.787"></a><span id="l11.787" class="difflineminus">-      // so we chain the urls using the listener called back from </span>
<a href="#l11.788"></a><span id="l11.788" class="difflineplus">+      // for imap folders, we need to create the sub-folders asynchronously,</span>
<a href="#l11.789"></a><span id="l11.789" class="difflineplus">+      // so we chain the urls using the listener called back from</span>
<a href="#l11.790"></a><span id="l11.790">       // createStorageIfMissing. For local, creatStorageIfMissing is</span>
<a href="#l11.791"></a><span id="l11.791">       // synchronous.</span>
<a href="#l11.792"></a><span id="l11.792">       let isImap = archiveFolder.server.type == &quot;imap&quot;;</span>
<a href="#l11.793"></a><span id="l11.793">       if (!archiveFolder.parent) {</span>
<a href="#l11.794"></a><span id="l11.794">         archiveFolder.createStorageIfMissing(this);</span>
<a href="#l11.795"></a><span id="l11.795">         if (isImap)</span>
<a href="#l11.796"></a><span id="l11.796">           return;</span>
<a href="#l11.797"></a><span id="l11.797">       }</span>
<a href="#l11.798"></a><span id="l11.798" class="difflineat">@@ -1349,28 +1346,20 @@ BatchMessageMover.prototype = {</span>
<a href="#l11.799"></a><span id="l11.799">       this._currentKey = null;</span>
<a href="#l11.800"></a><span id="l11.800"> </span>
<a href="#l11.801"></a><span id="l11.801">       // is there a safe way to test whether this._batches is empty?</span>
<a href="#l11.802"></a><span id="l11.802">       let empty = true;</span>
<a href="#l11.803"></a><span id="l11.803">       for (let key in this._batches) {</span>
<a href="#l11.804"></a><span id="l11.804">         empty = false;</span>
<a href="#l11.805"></a><span id="l11.805">       }</span>
<a href="#l11.806"></a><span id="l11.806"> </span>
<a href="#l11.807"></a><span id="l11.807" class="difflineminus">-      if (empty)</span>
<a href="#l11.808"></a><span id="l11.808" class="difflineminus">-      {</span>
<a href="#l11.809"></a><span id="l11.809" class="difflineminus">-        // we're just going to select the message now</span>
<a href="#l11.810"></a><span id="l11.810" class="difflineminus">-        var treeView = gDBView.QueryInterface(Components.interfaces.nsITreeView);</span>
<a href="#l11.811"></a><span id="l11.811" class="difflineminus">-        var treeSelection = treeView.selection;</span>
<a href="#l11.812"></a><span id="l11.812" class="difflineminus">-        treeSelection.select(this.messageToSelectAfterWereDone);</span>
<a href="#l11.813"></a><span id="l11.813" class="difflineminus">-        treeView.selectionChanged();</span>
<a href="#l11.814"></a><span id="l11.814" class="difflineminus">-      }</span>
<a href="#l11.815"></a><span id="l11.815" class="difflineminus">-      else</span>
<a href="#l11.816"></a><span id="l11.816" class="difflineminus">-      {</span>
<a href="#l11.817"></a><span id="l11.817" class="difflineplus">+      if (!empty)</span>
<a href="#l11.818"></a><span id="l11.818">         this.processNextBatch();</span>
<a href="#l11.819"></a><span id="l11.819" class="difflineminus">-      }</span>
<a href="#l11.820"></a><span id="l11.820" class="difflineplus">+      else // this will select the appropriate next message</span>
<a href="#l11.821"></a><span id="l11.821" class="difflineplus">+        gFolderDisplay.hintMassMoveCompleted();</span>
<a href="#l11.822"></a><span id="l11.822">     }</span>
<a href="#l11.823"></a><span id="l11.823">   },</span>
<a href="#l11.824"></a><span id="l11.824">   QueryInterface: function(iid) {</span>
<a href="#l11.825"></a><span id="l11.825">     if (!iid.equals(Components.interfaces.nsIUrlListener) &amp;&amp;</span>
<a href="#l11.826"></a><span id="l11.826">       !iid.equals(Components.interfaces.nsIMsgCopyServiceListener) &amp;&amp;</span>
<a href="#l11.827"></a><span id="l11.827">       !iid.equals(Components.interfaces.nsISupports))</span>
<a href="#l11.828"></a><span id="l11.828">       throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l11.829"></a><span id="l11.829">     return this;</span>
<a href="#l11.830"></a><span id="l11.830" class="difflineat">@@ -1415,28 +1404,26 @@ function MsgForwardAsInline(event)</span>
<a href="#l11.831"></a><span id="l11.831"> </span>
<a href="#l11.832"></a><span id="l11.832"> function MsgEditMessageAsNew()</span>
<a href="#l11.833"></a><span id="l11.833"> {</span>
<a href="#l11.834"></a><span id="l11.834">   composeMsgByType(Components.interfaces.nsIMsgCompType.Template);</span>
<a href="#l11.835"></a><span id="l11.835"> }</span>
<a href="#l11.836"></a><span id="l11.836"> </span>
<a href="#l11.837"></a><span id="l11.837"> function MsgComposeDraftMessage()</span>
<a href="#l11.838"></a><span id="l11.838"> {</span>
<a href="#l11.839"></a><span id="l11.839" class="difflineminus">-  var loadedFolder = GetLoadedMsgFolder();</span>
<a href="#l11.840"></a><span id="l11.840" class="difflineminus">-  var messageArray = GetSelectedMessages();</span>
<a href="#l11.841"></a><span id="l11.841" class="difflineminus">-</span>
<a href="#l11.842"></a><span id="l11.842">   ComposeMessage(Components.interfaces.nsIMsgCompType.Draft,</span>
<a href="#l11.843"></a><span id="l11.843">                  Components.interfaces.nsIMsgCompFormat.Default,</span>
<a href="#l11.844"></a><span id="l11.844" class="difflineminus">-                 loadedFolder, messageArray);</span>
<a href="#l11.845"></a><span id="l11.845" class="difflineplus">+                 gFolderDisplay.displayedFolder,</span>
<a href="#l11.846"></a><span id="l11.846" class="difflineplus">+                 gFolderDisplay.selectedMessageUris);</span>
<a href="#l11.847"></a><span id="l11.847"> }</span>
<a href="#l11.848"></a><span id="l11.848"> </span>
<a href="#l11.849"></a><span id="l11.849"> function MsgCreateFilter()</span>
<a href="#l11.850"></a><span id="l11.850"> {</span>
<a href="#l11.851"></a><span id="l11.851">   // retrieve Sender direct from selected message's headers</span>
<a href="#l11.852"></a><span id="l11.852" class="difflineminus">-  var msgHdr = gDBView.hdrForFirstSelectedMessage;</span>
<a href="#l11.853"></a><span id="l11.853" class="difflineplus">+  var msgHdr = gFolderDisplay.selectedMessage;</span>
<a href="#l11.854"></a><span id="l11.854">   var headerParser = Components.classes[&quot;@mozilla.org/messenger/headerparser;1&quot;]</span>
<a href="#l11.855"></a><span id="l11.855">                                .getService(Components.interfaces.nsIMsgHeaderParser);</span>
<a href="#l11.856"></a><span id="l11.856">   var emailAddress = headerParser.extractHeaderAddressMailboxes(msgHdr.author);</span>
<a href="#l11.857"></a><span id="l11.857">   if (emailAddress)</span>
<a href="#l11.858"></a><span id="l11.858">     top.MsgFilters(emailAddress, null);</span>
<a href="#l11.859"></a><span id="l11.859"> }</span>
<a href="#l11.860"></a><span id="l11.860"> </span>
<a href="#l11.861"></a><span id="l11.861"> function MsgNewFolder(callBackFunctionName)</span>
<a href="#l11.862"></a><span id="l11.862" class="difflineat">@@ -1552,24 +1539,24 @@ function ToggleFavoriteFolderFlag()</span>
<a href="#l11.863"></a><span id="l11.863"> {</span>
<a href="#l11.864"></a><span id="l11.864">   var folder = GetFirstSelectedMsgFolder();</span>
<a href="#l11.865"></a><span id="l11.865">   folder.toggleFlag(Components.interfaces.nsMsgFolderFlags.Favorite);</span>
<a href="#l11.866"></a><span id="l11.866"> }</span>
<a href="#l11.867"></a><span id="l11.867"> </span>
<a href="#l11.868"></a><span id="l11.868"> function MsgSaveAsFile()</span>
<a href="#l11.869"></a><span id="l11.869"> {</span>
<a href="#l11.870"></a><span id="l11.870">   if (GetNumSelectedMessages() == 1)</span>
<a href="#l11.871"></a><span id="l11.871" class="difflineminus">-    SaveAsFile(GetFirstSelectedMessage());</span>
<a href="#l11.872"></a><span id="l11.872" class="difflineplus">+    SaveAsFile(gFolderDisplay.selectedMessageUris[0]);</span>
<a href="#l11.873"></a><span id="l11.873"> }</span>
<a href="#l11.874"></a><span id="l11.874"> </span>
<a href="#l11.875"></a><span id="l11.875"> function MsgSaveAsTemplate()</span>
<a href="#l11.876"></a><span id="l11.876"> {</span>
<a href="#l11.877"></a><span id="l11.877" class="difflineminus">-  var folder = GetLoadedMsgFolder();</span>
<a href="#l11.878"></a><span id="l11.878">   if (GetNumSelectedMessages() == 1)</span>
<a href="#l11.879"></a><span id="l11.879" class="difflineminus">-    SaveAsTemplate(GetFirstSelectedMessage(), folder);</span>
<a href="#l11.880"></a><span id="l11.880" class="difflineplus">+    SaveAsTemplate(gFolderDisplay.selectedMessageUris[0],</span>
<a href="#l11.881"></a><span id="l11.881" class="difflineplus">+                   gFolderDisplay.displayedFolder);</span>
<a href="#l11.882"></a><span id="l11.882"> }</span>
<a href="#l11.883"></a><span id="l11.883"> </span>
<a href="#l11.884"></a><span id="l11.884"> function CreateToolbarTooltip(document, event)</span>
<a href="#l11.885"></a><span id="l11.885"> {</span>
<a href="#l11.886"></a><span id="l11.886">   event.stopPropagation();</span>
<a href="#l11.887"></a><span id="l11.887">   var tn = document.tooltipNode;</span>
<a href="#l11.888"></a><span id="l11.888">   if (tn.localName != &quot;tab&quot;)</span>
<a href="#l11.889"></a><span id="l11.889">     return false; // Not a tab, so cancel the tooltip.</span>
<a href="#l11.890"></a><span id="l11.890" class="difflineat">@@ -1580,315 +1567,337 @@ function CreateToolbarTooltip(document, </span>
<a href="#l11.891"></a><span id="l11.891">   if (tn.hasAttribute(&quot;label&quot;)) {</span>
<a href="#l11.892"></a><span id="l11.892">     event.target.setAttribute(&quot;label&quot;, tn.getAttribute(&quot;label&quot;));</span>
<a href="#l11.893"></a><span id="l11.893">     return true;</span>
<a href="#l11.894"></a><span id="l11.894">   }</span>
<a href="#l11.895"></a><span id="l11.895">   return false;</span>
<a href="#l11.896"></a><span id="l11.896"> }</span>
<a href="#l11.897"></a><span id="l11.897"> </span>
<a href="#l11.898"></a><span id="l11.898"> /**</span>
<a href="#l11.899"></a><span id="l11.899" class="difflineminus">- * mailTabType provides both &quot;folder&quot; and &quot;message&quot; tab modes. Under the</span>
<a href="#l11.900"></a><span id="l11.900" class="difflineminus">- * previous TabOwner framework, their logic was separated into two 'classes'</span>
<a href="#l11.901"></a><span id="l11.901" class="difflineminus">- * which called common helper methods and had similar boilerplate logic.</span>
<a href="#l11.902"></a><span id="l11.902" class="difflineplus">+ * Displays message &quot;folder&quot;s, mail &quot;message&quot;s, and &quot;glodaSearch&quot; results.  The</span>
<a href="#l11.903"></a><span id="l11.903" class="difflineplus">+ *  commonality is that they all use the &quot;mailContent&quot; panel's folder tree,</span>
<a href="#l11.904"></a><span id="l11.904" class="difflineplus">+ *  thread tree, and message pane objects.  This happens for historical reasons,</span>
<a href="#l11.905"></a><span id="l11.905" class="difflineplus">+ *  likely involving the fact that prior to the introduction of this</span>
<a href="#l11.906"></a><span id="l11.906" class="difflineplus">+ *  abstraction, everything was always stored in global objects.  For the 3.0</span>
<a href="#l11.907"></a><span id="l11.907" class="difflineplus">+ *  release cycle we considered avoiding this 'multiplexed' style of operation</span>
<a href="#l11.908"></a><span id="l11.908" class="difflineplus">+ *  but decided against moving to making each tab be indepdendent because of</span>
<a href="#l11.909"></a><span id="l11.909" class="difflineplus">+ *  presumed complexity.</span>
<a href="#l11.910"></a><span id="l11.910" class="difflineplus">+ *</span>
<a href="#l11.911"></a><span id="l11.911" class="difflineplus">+ * The tab info objects (as tabmail's currentTabInfo/tabInfo fields contain)</span>
<a href="#l11.912"></a><span id="l11.912" class="difflineplus">+ *  have the following attributes specific to our implementation:</span>
<a href="#l11.913"></a><span id="l11.913" class="difflineplus">+ *</span>
<a href="#l11.914"></a><span id="l11.914" class="difflineplus">+ *</span>
<a href="#l11.915"></a><span id="l11.915" class="difflineplus">+ * @property {string} uriToOpen</span>
<a href="#l11.916"></a><span id="l11.916" class="difflineplus">+ * @property {nsIMsgFolder} msgSelectedFolder Preserves gMsgFolderSelected</span>
<a href="#l11.917"></a><span id="l11.917" class="difflineplus">+ *     global.</span>
<a href="#l11.918"></a><span id="l11.918" class="difflineplus">+ * @property {nsIMsgDBView} dbView The database view to use with the thread tree</span>
<a href="#l11.919"></a><span id="l11.919" class="difflineplus">+ *     when this tab is displayed.  The value will be assigned to the global</span>
<a href="#l11.920"></a><span id="l11.920" class="difflineplus">+ *     gDBView in the process.</span>
<a href="#l11.921"></a><span id="l11.921" class="difflineplus">+ * @property {nsIMessenger} messenger Used to preserve &quot;messenger&quot; global value.</span>
<a href="#l11.922"></a><span id="l11.922" class="difflineplus">+ *     The messenger object is the keeper of the 'undo' state and navigation</span>
<a href="#l11.923"></a><span id="l11.923" class="difflineplus">+ *     history, which is why we do this.</span>
<a href="#l11.924"></a><span id="l11.924" class="difflineplus">+ *</span>
<a href="#l11.925"></a><span id="l11.925" class="difflineplus">+ * @property {boolean} folderPaneCollapsed In &quot;folder&quot; mode, has the user</span>
<a href="#l11.926"></a><span id="l11.926" class="difflineplus">+ *     intentionally collapsed the folder pane.</span>
<a href="#l11.927"></a><span id="l11.927" class="difflineplus">+ * @property {boolean} messagePaneCollapsed In &quot;folder&quot; or &quot;glodaSearch&quot; mode,</span>
<a href="#l11.928"></a><span id="l11.928" class="difflineplus">+ *     has the user intentionally collapsed the message pane.</span>
<a href="#l11.929"></a><span id="l11.929" class="difflineplus">+ *</span>
<a href="#l11.930"></a><span id="l11.930" class="difflineplus">+ * @property {nsIMsgDBHdr} hdr In &quot;message&quot; mode, the header of the message</span>
<a href="#l11.931"></a><span id="l11.931" class="difflineplus">+ *     being displayed.</span>
<a href="#l11.932"></a><span id="l11.932" class="difflineplus">+ * @property {nsIMsgSearchSession} searchSession Used to preserve gSearchSession</span>
<a href="#l11.933"></a><span id="l11.933" class="difflineplus">+ *     global value.</span>
<a href="#l11.934"></a><span id="l11.934" class="difflineplus">+ *</span>
<a href="#l11.935"></a><span id="l11.935">  */</span>
<a href="#l11.936"></a><span id="l11.936"> let mailTabType = {</span>
<a href="#l11.937"></a><span id="l11.937">   name: &quot;mail&quot;,</span>
<a href="#l11.938"></a><span id="l11.938">   panelId: &quot;mailContent&quot;,</span>
<a href="#l11.939"></a><span id="l11.939">   modes: {</span>
<a href="#l11.940"></a><span id="l11.940" class="difflineplus">+    /**</span>
<a href="#l11.941"></a><span id="l11.941" class="difflineplus">+     * The folder view displays the contents of an nsIMsgDBFolder, with the</span>
<a href="#l11.942"></a><span id="l11.942" class="difflineplus">+     *  folder pane (potentially), thread pane (always), and message pane</span>
<a href="#l11.943"></a><span id="l11.943" class="difflineplus">+     *  (potentially) displayed.</span>
<a href="#l11.944"></a><span id="l11.944" class="difflineplus">+     *</span>
<a href="#l11.945"></a><span id="l11.945" class="difflineplus">+     * The actual nsMsgDBView can be any of the following types of things:</span>
<a href="#l11.946"></a><span id="l11.946" class="difflineplus">+     *  - A single folder.</span>
<a href="#l11.947"></a><span id="l11.947" class="difflineplus">+     *    - A quicksearch on a single folder.</span>
<a href="#l11.948"></a><span id="l11.948" class="difflineplus">+     *  - A virtual folder potentially containing messages from multiple</span>
<a href="#l11.949"></a><span id="l11.949" class="difflineplus">+     *    folders. (eShowVirtualFolderResults)</span>
<a href="#l11.950"></a><span id="l11.950" class="difflineplus">+     */</span>
<a href="#l11.951"></a><span id="l11.951">     folder: {</span>
<a href="#l11.952"></a><span id="l11.952">       isDefault: true,</span>
<a href="#l11.953"></a><span id="l11.953">       type: &quot;folder&quot;,</span>
<a href="#l11.954"></a><span id="l11.954" class="difflineminus">-      openTab: function(aTab, aFolderUri) {</span>
<a href="#l11.955"></a><span id="l11.955" class="difflineminus">-        aTab.uriToOpen = aFolderUri;</span>
<a href="#l11.956"></a><span id="l11.956" class="difflineminus">-</span>
<a href="#l11.957"></a><span id="l11.957" class="difflineminus">-        this.openTab(aTab); // call superclass logic</span>
<a href="#l11.958"></a><span id="l11.958" class="difflineplus">+      /// The set of panes that are legal to be displayed in this mode</span>
<a href="#l11.959"></a><span id="l11.959" class="difflineplus">+      legalPanes: {</span>
<a href="#l11.960"></a><span id="l11.960" class="difflineplus">+        folder: true,</span>
<a href="#l11.961"></a><span id="l11.961" class="difflineplus">+        thread: true,</span>
<a href="#l11.962"></a><span id="l11.962" class="difflineplus">+        message: true</span>
<a href="#l11.963"></a><span id="l11.963" class="difflineplus">+      },</span>
<a href="#l11.964"></a><span id="l11.964" class="difflineplus">+      openFirstTab: function(aTab) {</span>
<a href="#l11.965"></a><span id="l11.965" class="difflineplus">+        this.openTab(aTab, true, new MessagePaneDisplayWidget());</span>
<a href="#l11.966"></a><span id="l11.966" class="difflineplus">+        aTab.folderDisplay.makeActive();</span>
<a href="#l11.967"></a><span id="l11.967">       },</span>
<a href="#l11.968"></a><span id="l11.968" class="difflineminus">-      showTab: function(aTab) {</span>
<a href="#l11.969"></a><span id="l11.969" class="difflineminus">-        this.folderAndThreadPaneVisible = true;</span>
<a href="#l11.970"></a><span id="l11.970" class="difflineminus">-        ClearMessagePane();</span>
<a href="#l11.971"></a><span id="l11.971" class="difflineminus">-</span>
<a href="#l11.972"></a><span id="l11.972" class="difflineminus">-        this.showTab(aTab);</span>
<a href="#l11.973"></a><span id="l11.973" class="difflineplus">+      /**</span>
<a href="#l11.974"></a><span id="l11.974" class="difflineplus">+       * @param aFolder The nsIMsgFolder to display.</span>
<a href="#l11.975"></a><span id="l11.975" class="difflineplus">+       * @param aMsgHdr Optional message header to display.</span>
<a href="#l11.976"></a><span id="l11.976" class="difflineplus">+       */</span>
<a href="#l11.977"></a><span id="l11.977" class="difflineplus">+      openTab: function(aTab, aFolder, aMsgHdr) {</span>
<a href="#l11.978"></a><span id="l11.978" class="difflineplus">+        // Get a tab that we can initialize our user preferences from.</span>
<a href="#l11.979"></a><span id="l11.979" class="difflineplus">+        // (We don't want to assume that our immediate predecessor was a</span>
<a href="#l11.980"></a><span id="l11.980" class="difflineplus">+        //  &quot;folder&quot; tab.)</span>
<a href="#l11.981"></a><span id="l11.981" class="difflineplus">+        let modelTab = document.getElementById(&quot;tabmail&quot;)</span>
<a href="#l11.982"></a><span id="l11.982" class="difflineplus">+                         .getTabInfoForCurrentOrFirstModeInstance(aTab.mode);</span>
<a href="#l11.983"></a><span id="l11.983" class="difflineplus">+        // copy its state</span>
<a href="#l11.984"></a><span id="l11.984" class="difflineplus">+        aTab.folderPaneCollapsed = modelTab.folderPaneCollapsed;</span>
<a href="#l11.985"></a><span id="l11.985" class="difflineplus">+        aTab.messagePaneCollapsed = modelTab.messagePaneCollapsed;</span>
<a href="#l11.986"></a><span id="l11.986" class="difflineplus">+</span>
<a href="#l11.987"></a><span id="l11.987" class="difflineplus">+        this.openTab(aTab, false,  new MessagePaneDisplayWidget());</span>
<a href="#l11.988"></a><span id="l11.988" class="difflineplus">+</span>
<a href="#l11.989"></a><span id="l11.989" class="difflineplus">+        // Clear selection, because context clicking on a folder and opening in a</span>
<a href="#l11.990"></a><span id="l11.990" class="difflineplus">+        // new tab needs to have SelectFolder think the selection has changed.</span>
<a href="#l11.991"></a><span id="l11.991" class="difflineplus">+        // We also need to clear these globals to subvert the code that prevents</span>
<a href="#l11.992"></a><span id="l11.992" class="difflineplus">+        // folder loads when things haven't changed.</span>
<a href="#l11.993"></a><span id="l11.993" class="difflineplus">+        var folderTree = document.getElementById(&quot;folderTree&quot;);</span>
<a href="#l11.994"></a><span id="l11.994" class="difflineplus">+        folderTree.view.selection.clearSelection();</span>
<a href="#l11.995"></a><span id="l11.995" class="difflineplus">+        folderTree.view.selection.currentIndex = -1;</span>
<a href="#l11.996"></a><span id="l11.996" class="difflineplus">+</span>
<a href="#l11.997"></a><span id="l11.997" class="difflineplus">+        aTab.folderDisplay.makeActive();</span>
<a href="#l11.998"></a><span id="l11.998" class="difflineplus">+</span>
<a href="#l11.999"></a><span id="l11.999" class="difflineplus">+        // selecting the folder effectively calls</span>
<a href="#l11.1000"></a><span id="l11.1000" class="difflineplus">+        //  aTab.folderDisplay.show(aFolder)</span>
<a href="#l11.1001"></a><span id="l11.1001" class="difflineplus">+        gFolderTreeView.selectFolder(aFolder);</span>
<a href="#l11.1002"></a><span id="l11.1002" class="difflineplus">+        if(aMsgHdr)</span>
<a href="#l11.1003"></a><span id="l11.1003" class="difflineplus">+          aTab.folderDisplay.selectMessage(aMsgHdr);</span>
<a href="#l11.1004"></a><span id="l11.1004">       },</span>
<a href="#l11.1005"></a><span id="l11.1005">       onTitleChanged: function(aTab, aTabNode) {</span>
<a href="#l11.1006"></a><span id="l11.1006" class="difflineminus">-        if (!gMsgFolderSelected) {</span>
<a href="#l11.1007"></a><span id="l11.1007" class="difflineplus">+        if (!aTab.folderDisplay || !aTab.folderDisplay.displayedFolder) {</span>
<a href="#l11.1008"></a><span id="l11.1008">           // Don't show &quot;undefined&quot; as title when there is no account.</span>
<a href="#l11.1009"></a><span id="l11.1009">           aTab.title = &quot; &quot;;</span>
<a href="#l11.1010"></a><span id="l11.1010">           return;</span>
<a href="#l11.1011"></a><span id="l11.1011">         }</span>
<a href="#l11.1012"></a><span id="l11.1012" class="difflineminus">-        aTab.title = gMsgFolderSelected.prettyName;</span>
<a href="#l11.1013"></a><span id="l11.1013" class="difflineminus">-        if (!gMsgFolderSelected.isServer &amp;&amp; this._getNumberOfRealAccounts() &gt; 1)</span>
<a href="#l11.1014"></a><span id="l11.1014" class="difflineminus">-          aTab.title += &quot; - &quot; + gMsgFolderSelected.server.prettyName;</span>
<a href="#l11.1015"></a><span id="l11.1015" class="difflineminus">-</span>
<a href="#l11.1016"></a><span id="l11.1016" class="difflineminus">-        // The user may have changed folders, triggering our onTitleChanged callback.</span>
<a href="#l11.1017"></a><span id="l11.1017" class="difflineplus">+        // The user may have changed folders, triggering our onTitleChanged</span>
<a href="#l11.1018"></a><span id="l11.1018" class="difflineplus">+        // callback.</span>
<a href="#l11.1019"></a><span id="l11.1019" class="difflineplus">+        let folder = aTab.folderDisplay.displayedFolder;</span>
<a href="#l11.1020"></a><span id="l11.1020" class="difflineplus">+        aTab.title = folder.prettyName;</span>
<a href="#l11.1021"></a><span id="l11.1021" class="difflineplus">+        if (!folder.isServer &amp;&amp; this._getNumberOfRealAccounts() &gt; 1)</span>
<a href="#l11.1022"></a><span id="l11.1022" class="difflineplus">+          aTab.title += &quot; - &quot; + folder.server.prettyName;</span>
<a href="#l11.1023"></a><span id="l11.1023" class="difflineplus">+</span>
<a href="#l11.1024"></a><span id="l11.1024">         // Update the appropriate attributes on the tab.</span>
<a href="#l11.1025"></a><span id="l11.1025" class="difflineminus">-        aTabNode.setAttribute('SpecialFolder', getSpecialFolderString(gMsgFolderSelected));</span>
<a href="#l11.1026"></a><span id="l11.1026" class="difflineminus">-        aTabNode.setAttribute('ServerType', gMsgFolderSelected.server.type);</span>
<a href="#l11.1027"></a><span id="l11.1027" class="difflineminus">-        aTabNode.setAttribute('IsServer', gMsgFolderSelected.isServer);</span>
<a href="#l11.1028"></a><span id="l11.1028" class="difflineminus">-        aTabNode.setAttribute('IsSecure', gMsgFolderSelected.server.isSecure);</span>
<a href="#l11.1029"></a><span id="l11.1029" class="difflineplus">+        aTabNode.setAttribute('SpecialFolder',</span>
<a href="#l11.1030"></a><span id="l11.1030" class="difflineplus">+                              getSpecialFolderString(folder));</span>
<a href="#l11.1031"></a><span id="l11.1031" class="difflineplus">+        aTabNode.setAttribute('ServerType', folder.server.type);</span>
<a href="#l11.1032"></a><span id="l11.1032" class="difflineplus">+        aTabNode.setAttribute('IsServer', folder.isServer);</span>
<a href="#l11.1033"></a><span id="l11.1033" class="difflineplus">+        aTabNode.setAttribute('IsSecure', folder.server.isSecure);</span>
<a href="#l11.1034"></a><span id="l11.1034">       }</span>
<a href="#l11.1035"></a><span id="l11.1035">     },</span>
<a href="#l11.1036"></a><span id="l11.1036" class="difflineplus">+    /**</span>
<a href="#l11.1037"></a><span id="l11.1037" class="difflineplus">+     * The message view displays a single message.  In this view, the folder</span>
<a href="#l11.1038"></a><span id="l11.1038" class="difflineplus">+     *  pane and thread pane are forced hidden and only the message pane is</span>
<a href="#l11.1039"></a><span id="l11.1039" class="difflineplus">+     *  displayed.</span>
<a href="#l11.1040"></a><span id="l11.1040" class="difflineplus">+     */</span>
<a href="#l11.1041"></a><span id="l11.1041">     message: {</span>
<a href="#l11.1042"></a><span id="l11.1042">       type: &quot;message&quot;,</span>
<a href="#l11.1043"></a><span id="l11.1043" class="difflineminus">-      openTab: function(aTab, aFolderUri, aMsgHdr) {</span>
<a href="#l11.1044"></a><span id="l11.1044" class="difflineminus">-        aTab.uriToOpen = aFolderUri;</span>
<a href="#l11.1045"></a><span id="l11.1045" class="difflineminus">-        aTab.hdr = aMsgHdr;</span>
<a href="#l11.1046"></a><span id="l11.1046" class="difflineminus">-</span>
<a href="#l11.1047"></a><span id="l11.1047" class="difflineplus">+      /// The set of panes that are legal to be displayed in this mode</span>
<a href="#l11.1048"></a><span id="l11.1048" class="difflineplus">+      legalPanes: {</span>
<a href="#l11.1049"></a><span id="l11.1049" class="difflineplus">+        folder: false,</span>
<a href="#l11.1050"></a><span id="l11.1050" class="difflineplus">+        thread: false,</span>
<a href="#l11.1051"></a><span id="l11.1051" class="difflineplus">+        message: true</span>
<a href="#l11.1052"></a><span id="l11.1052" class="difflineplus">+      },</span>
<a href="#l11.1053"></a><span id="l11.1053" class="difflineplus">+      openTab: function(aTab, aMsgHdr, aViewWrapperToClone) {</span>
<a href="#l11.1054"></a><span id="l11.1054" class="difflineplus">+        aTab.mode.onTitleChanged.call(this, aTab, null, aMsgHdr);</span>
<a href="#l11.1055"></a><span id="l11.1055" class="difflineplus">+</span>
<a href="#l11.1056"></a><span id="l11.1056" class="difflineplus">+        this.openTab(aTab, false, new MessageTabDisplayWidget());</span>
<a href="#l11.1057"></a><span id="l11.1057" class="difflineplus">+</span>
<a href="#l11.1058"></a><span id="l11.1058" class="difflineplus">+        if (aViewWrapperToClone)</span>
<a href="#l11.1059"></a><span id="l11.1059" class="difflineplus">+          aTab.folderDisplay.cloneView(aViewWrapperToClone);</span>
<a href="#l11.1060"></a><span id="l11.1060" class="difflineplus">+        else</span>
<a href="#l11.1061"></a><span id="l11.1061" class="difflineplus">+          aTab.folderDisplay.show(aMsgHdr.folder);</span>
<a href="#l11.1062"></a><span id="l11.1062" class="difflineplus">+</span>
<a href="#l11.1063"></a><span id="l11.1063" class="difflineplus">+        aTab.folderDisplay.selectMessage(aMsgHdr);</span>
<a href="#l11.1064"></a><span id="l11.1064" class="difflineplus">+</span>
<a href="#l11.1065"></a><span id="l11.1065" class="difflineplus">+        // we only want to make it active after setting up the view and the message</span>
<a href="#l11.1066"></a><span id="l11.1066" class="difflineplus">+        //  to avoid generating bogus summarization events.</span>
<a href="#l11.1067"></a><span id="l11.1067" class="difflineplus">+        aTab.folderDisplay.makeActive();</span>
<a href="#l11.1068"></a><span id="l11.1068" class="difflineplus">+      },</span>
<a href="#l11.1069"></a><span id="l11.1069" class="difflineplus">+      onTitleChanged: function(aTab, aTabNode, aMsgHdr) {</span>
<a href="#l11.1070"></a><span id="l11.1070" class="difflineplus">+        if (aMsgHdr == null)</span>
<a href="#l11.1071"></a><span id="l11.1071" class="difflineplus">+          aMsgHdr = aTab.folderDisplay.selectedMessage;</span>
<a href="#l11.1072"></a><span id="l11.1072">         aTab.title = &quot;&quot;;</span>
<a href="#l11.1073"></a><span id="l11.1073" class="difflineminus">-        if (aTab.hdr.flags &amp; Components.interfaces.nsMsgMessageFlags.HasRe)</span>
<a href="#l11.1074"></a><span id="l11.1074" class="difflineplus">+        if (aMsgHdr.flags &amp; Components.interfaces.nsMsgMessageFlags.HasRe)</span>
<a href="#l11.1075"></a><span id="l11.1075">           aTab.title = &quot;Re: &quot;;</span>
<a href="#l11.1076"></a><span id="l11.1076" class="difflineminus">-        if (aTab.hdr.mime2DecodedSubject)</span>
<a href="#l11.1077"></a><span id="l11.1077" class="difflineminus">-          aTab.title += aTab.hdr.mime2DecodedSubject;</span>
<a href="#l11.1078"></a><span id="l11.1078" class="difflineminus">-</span>
<a href="#l11.1079"></a><span id="l11.1079" class="difflineminus">-        aTab.title += &quot; - &quot; + aTab.hdr.folder.prettyName;</span>
<a href="#l11.1080"></a><span id="l11.1080" class="difflineplus">+        if (aMsgHdr.mime2DecodedSubject)</span>
<a href="#l11.1081"></a><span id="l11.1081" class="difflineplus">+          aTab.title += aMsgHdr.mime2DecodedSubject;</span>
<a href="#l11.1082"></a><span id="l11.1082" class="difflineplus">+</span>
<a href="#l11.1083"></a><span id="l11.1083" class="difflineplus">+        aTab.title += &quot; - &quot; + aMsgHdr.folder.prettyName;</span>
<a href="#l11.1084"></a><span id="l11.1084">         if (this._getNumberOfRealAccounts() &gt; 1)</span>
<a href="#l11.1085"></a><span id="l11.1085" class="difflineminus">-          aTab.title += &quot; - &quot; + aTab.hdr.folder.server.prettyName;</span>
<a href="#l11.1086"></a><span id="l11.1086" class="difflineminus">-</span>
<a href="#l11.1087"></a><span id="l11.1087" class="difflineminus">-        // let's try hiding the thread pane and folder pane</span>
<a href="#l11.1088"></a><span id="l11.1088" class="difflineminus">-        this.folderAndThreadPaneVisible = false;</span>
<a href="#l11.1089"></a><span id="l11.1089" class="difflineminus">-</span>
<a href="#l11.1090"></a><span id="l11.1090" class="difflineminus">-        this.openTab(aTab); // call superclass logic</span>
<a href="#l11.1091"></a><span id="l11.1091" class="difflineminus">-</span>
<a href="#l11.1092"></a><span id="l11.1092" class="difflineminus">-        gCurrentlyDisplayedMessage = nsMsgViewIndex_None;</span>
<a href="#l11.1093"></a><span id="l11.1093" class="difflineminus">-        ClearThreadPaneSelection();</span>
<a href="#l11.1094"></a><span id="l11.1094" class="difflineminus">-        setTimeout(gDBView.selectFolderMsgByKey, 0, aTab.hdr.folder,</span>
<a href="#l11.1095"></a><span id="l11.1095" class="difflineminus">-                   aTab.hdr.messageKey);</span>
<a href="#l11.1096"></a><span id="l11.1096" class="difflineminus">-      },</span>
<a href="#l11.1097"></a><span id="l11.1097" class="difflineminus">-      showTab: function(aTab) {</span>
<a href="#l11.1098"></a><span id="l11.1098" class="difflineminus">-        this.folderAndThreadPaneVisible = false;</span>
<a href="#l11.1099"></a><span id="l11.1099" class="difflineminus">-        this.showTab(aTab);</span>
<a href="#l11.1100"></a><span id="l11.1100" class="difflineplus">+          aTab.title += &quot; - &quot; + aMsgHdr.folder.server.prettyName;</span>
<a href="#l11.1101"></a><span id="l11.1101">       }</span>
<a href="#l11.1102"></a><span id="l11.1102">     }</span>
<a href="#l11.1103"></a><span id="l11.1103">   },</span>
<a href="#l11.1104"></a><span id="l11.1104"> </span>
<a href="#l11.1105"></a><span id="l11.1105">   _getNumberOfRealAccounts : function() {</span>
<a href="#l11.1106"></a><span id="l11.1106">     let mgr = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l11.1107"></a><span id="l11.1107">                         .getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l11.1108"></a><span id="l11.1108">     let accountCount = mgr.accounts.Count();</span>
<a href="#l11.1109"></a><span id="l11.1109">     // If we have an account, we also always have a &quot;Local Folders&quot; account.</span>
<a href="#l11.1110"></a><span id="l11.1110">     return accountCount &gt; 0 ? (accountCount - 1) : 0;</span>
<a href="#l11.1111"></a><span id="l11.1111">   },</span>
<a href="#l11.1112"></a><span id="l11.1112"> </span>
<a href="#l11.1113"></a><span id="l11.1113">   /**</span>
<a href="#l11.1114"></a><span id="l11.1114" class="difflineminus">-   * Create the new tab's state, which engenders some side effects.  Part of our</span>
<a href="#l11.1115"></a><span id="l11.1115" class="difflineminus">-   *  contract is that we leave the tab in the selected state.</span>
<a href="#l11.1116"></a><span id="l11.1116" class="difflineplus">+   * Common tab opening code shared by the various tab modes.</span>
<a href="#l11.1117"></a><span id="l11.1117">    */</span>
<a href="#l11.1118"></a><span id="l11.1118" class="difflineminus">-  openTab: function(aTab) {</span>
<a href="#l11.1119"></a><span id="l11.1119" class="difflineplus">+  openTab: function(aTab, aIsFirstTab, aMessageDisplay) {</span>
<a href="#l11.1120"></a><span id="l11.1120">     // Set the messagepane as the primary browser for content.</span>
<a href="#l11.1121"></a><span id="l11.1121">     document.getElementById(&quot;messagepane&quot;).setAttribute(&quot;type&quot;,</span>
<a href="#l11.1122"></a><span id="l11.1122">                                                         &quot;content-primary&quot;);</span>
<a href="#l11.1123"></a><span id="l11.1123"> </span>
<a href="#l11.1124"></a><span id="l11.1124" class="difflineminus">-    ClearThreadPaneSelection();</span>
<a href="#l11.1125"></a><span id="l11.1125" class="difflineminus">-</span>
<a href="#l11.1126"></a><span id="l11.1126" class="difflineminus">-    // Each tab gets its own messenger instance; I assume this is so each one</span>
<a href="#l11.1127"></a><span id="l11.1127" class="difflineminus">-    // gets its own undo/redo stack?</span>
<a href="#l11.1128"></a><span id="l11.1128" class="difflineminus">-    messenger = Components.classes[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l11.1129"></a><span id="l11.1129" class="difflineminus">-                          .createInstance(Components.interfaces.nsIMessenger);</span>
<a href="#l11.1130"></a><span id="l11.1130" class="difflineminus">-    messenger.setWindow(window, msgWindow);</span>
<a href="#l11.1131"></a><span id="l11.1131" class="difflineminus">-    aTab.messenger = messenger;</span>
<a href="#l11.1132"></a><span id="l11.1132" class="difflineminus">-</span>
<a href="#l11.1133"></a><span id="l11.1133" class="difflineminus">-    aTab.msgSelectedFolder = gMsgFolderSelected;</span>
<a href="#l11.1134"></a><span id="l11.1134" class="difflineminus">-</span>
<a href="#l11.1135"></a><span id="l11.1135" class="difflineminus">-    // Clear selection, because context clicking on a folder and opening in a</span>
<a href="#l11.1136"></a><span id="l11.1136" class="difflineminus">-    // new tab needs to have SelectFolder think the selection has changed.</span>
<a href="#l11.1137"></a><span id="l11.1137" class="difflineminus">-    // We also need to clear these globals to subvert the code that prevents</span>
<a href="#l11.1138"></a><span id="l11.1138" class="difflineminus">-    // folder loads when things haven't changed.</span>
<a href="#l11.1139"></a><span id="l11.1139" class="difflineminus">-    var folderTree = document.getElementById(&quot;folderTree&quot;);</span>
<a href="#l11.1140"></a><span id="l11.1140" class="difflineminus">-    folderTree.view.selection.clearSelection();</span>
<a href="#l11.1141"></a><span id="l11.1141" class="difflineminus">-    folderTree.view.selection.currentIndex = -1;</span>
<a href="#l11.1142"></a><span id="l11.1142" class="difflineminus">-    gMsgFolderSelected = null;</span>
<a href="#l11.1143"></a><span id="l11.1143" class="difflineminus">-    msgWindow.openFolder = null;</span>
<a href="#l11.1144"></a><span id="l11.1144" class="difflineminus">-</span>
<a href="#l11.1145"></a><span id="l11.1145" class="difflineminus">-    // Clear thread pane selection - otherwise, the tree tries to impose the</span>
<a href="#l11.1146"></a><span id="l11.1146" class="difflineminus">-    // the current selection on the new view.</span>
<a href="#l11.1147"></a><span id="l11.1147" class="difflineminus">-    gDBView = null; // clear gDBView so we won't try to close it.</span>
<a href="#l11.1148"></a><span id="l11.1148" class="difflineminus">-    gFolderTreeView.selectFolder(GetMsgFolderFromUri(aTab.uriToOpen));</span>
<a href="#l11.1149"></a><span id="l11.1149" class="difflineminus">-    aTab.dbView = gDBView;</span>
<a href="#l11.1150"></a><span id="l11.1150" class="difflineplus">+    aTab.messageDisplay = aMessageDisplay;</span>
<a href="#l11.1151"></a><span id="l11.1151" class="difflineplus">+    aTab.folderDisplay = new FolderDisplayWidget(aTab, aTab.messageDisplay);</span>
<a href="#l11.1152"></a><span id="l11.1152" class="difflineplus">+    aTab.folderDisplay.msgWindow = msgWindow;</span>
<a href="#l11.1153"></a><span id="l11.1153" class="difflineplus">+    aTab.folderDisplay.tree = document.getElementById(&quot;threadTree&quot;);</span>
<a href="#l11.1154"></a><span id="l11.1154" class="difflineplus">+    aTab.folderDisplay.treeBox = aTab.folderDisplay.tree.boxObject.QueryInterface(</span>
<a href="#l11.1155"></a><span id="l11.1155" class="difflineplus">+                                   Components.interfaces.nsITreeBoxObject);</span>
<a href="#l11.1156"></a><span id="l11.1156" class="difflineplus">+</span>
<a href="#l11.1157"></a><span id="l11.1157" class="difflineplus">+    if (aIsFirstTab) {</span>
<a href="#l11.1158"></a><span id="l11.1158" class="difflineplus">+      aTab.folderDisplay.messenger = messenger;</span>
<a href="#l11.1159"></a><span id="l11.1159" class="difflineplus">+    }</span>
<a href="#l11.1160"></a><span id="l11.1160" class="difflineplus">+    else {</span>
<a href="#l11.1161"></a><span id="l11.1161" class="difflineplus">+      // Each tab gets its own messenger instance; this provides each tab with</span>
<a href="#l11.1162"></a><span id="l11.1162" class="difflineplus">+      // its own undo/redo stack and back/forward navigation history.</span>
<a href="#l11.1163"></a><span id="l11.1163" class="difflineplus">+      messenger = Components.classes[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l11.1164"></a><span id="l11.1164" class="difflineplus">+                            .createInstance(Components.interfaces.nsIMessenger);</span>
<a href="#l11.1165"></a><span id="l11.1165" class="difflineplus">+      messenger.setWindow(window, msgWindow);</span>
<a href="#l11.1166"></a><span id="l11.1166" class="difflineplus">+      aTab.folderDisplay.messenger = messenger;</span>
<a href="#l11.1167"></a><span id="l11.1167" class="difflineplus">+    }</span>
<a href="#l11.1168"></a><span id="l11.1168">   },</span>
<a href="#l11.1169"></a><span id="l11.1169"> </span>
<a href="#l11.1170"></a><span id="l11.1170">   closeTab: function(aTab) {</span>
<a href="#l11.1171"></a><span id="l11.1171" class="difflineminus">-    if (aTab.dbView)</span>
<a href="#l11.1172"></a><span id="l11.1172" class="difflineminus">-      aTab.dbView.close();</span>
<a href="#l11.1173"></a><span id="l11.1173" class="difflineminus">-    if (aTab.messenger)</span>
<a href="#l11.1174"></a><span id="l11.1174" class="difflineminus">-      aTab.messenger.setWindow(null, null);</span>
<a href="#l11.1175"></a><span id="l11.1175" class="difflineplus">+    aTab.folderDisplay.close();</span>
<a href="#l11.1176"></a><span id="l11.1176">   },</span>
<a href="#l11.1177"></a><span id="l11.1177"> </span>
<a href="#l11.1178"></a><span id="l11.1178">   saveTabState: function(aTab) {</span>
<a href="#l11.1179"></a><span id="l11.1179" class="difflineminus">-    aTab.messenger = messenger;</span>
<a href="#l11.1180"></a><span id="l11.1180" class="difflineminus">-    aTab.dbView = gDBView;</span>
<a href="#l11.1181"></a><span id="l11.1181" class="difflineminus">-    aTab.searchSession = gSearchSession;</span>
<a href="#l11.1182"></a><span id="l11.1182" class="difflineminus">-    aTab.msgSelectedFolder = gMsgFolderSelected;</span>
<a href="#l11.1183"></a><span id="l11.1183" class="difflineminus">-    if (!gDBView)</span>
<a href="#l11.1184"></a><span id="l11.1184" class="difflineminus">-      return;</span>
<a href="#l11.1185"></a><span id="l11.1185" class="difflineminus">-</span>
<a href="#l11.1186"></a><span id="l11.1186" class="difflineminus">-    aTab.firstVisibleRow = document.getElementById(&quot;threadTree&quot;).treeBoxObject.getFirstVisibleRow();</span>
<a href="#l11.1187"></a><span id="l11.1187" class="difflineminus">-</span>
<a href="#l11.1188"></a><span id="l11.1188" class="difflineminus">-    if (gDBView.currentlyDisplayedMessage != nsMsgViewIndex_None)</span>
<a href="#l11.1189"></a><span id="l11.1189" class="difflineminus">-    {</span>
<a href="#l11.1190"></a><span id="l11.1190" class="difflineminus">-      try // there may not be a selected message.</span>
<a href="#l11.1191"></a><span id="l11.1191" class="difflineminus">-      {</span>
<a href="#l11.1192"></a><span id="l11.1192" class="difflineminus">-        var curMsgHdr = gDBView.hdrForFirstSelectedMessage;</span>
<a href="#l11.1193"></a><span id="l11.1193" class="difflineminus">-        aTab.selectedMsgId = curMsgHdr.messageId;</span>
<a href="#l11.1194"></a><span id="l11.1194" class="difflineminus">-      }</span>
<a href="#l11.1195"></a><span id="l11.1195" class="difflineminus">-      catch (ex) {}</span>
<a href="#l11.1196"></a><span id="l11.1196" class="difflineminus">-    }</span>
<a href="#l11.1197"></a><span id="l11.1197" class="difflineminus">-    else</span>
<a href="#l11.1198"></a><span id="l11.1198" class="difflineminus">-    {</span>
<a href="#l11.1199"></a><span id="l11.1199" class="difflineminus">-      aTab.selectedMsgId = null;</span>
<a href="#l11.1200"></a><span id="l11.1200" class="difflineminus">-      aTab.msgSelectedFolder = gDBView.msgFolder;</span>
<a href="#l11.1201"></a><span id="l11.1201" class="difflineminus">-    }</span>
<a href="#l11.1202"></a><span id="l11.1202" class="difflineminus">-    if (aTab.msgSelectedFolder)</span>
<a href="#l11.1203"></a><span id="l11.1203" class="difflineminus">-      aTab.mailView = GetMailViewForFolder(aTab.msgSelectedFolder);</span>
<a href="#l11.1204"></a><span id="l11.1204" class="difflineminus">-</span>
<a href="#l11.1205"></a><span id="l11.1205">     // Now let other tabs have a primary browser if they want.</span>
<a href="#l11.1206"></a><span id="l11.1206">     document.getElementById(&quot;messagepane&quot;).setAttribute(&quot;type&quot;,</span>
<a href="#l11.1207"></a><span id="l11.1207">                                                         &quot;content-targetable&quot;);</span>
<a href="#l11.1208"></a><span id="l11.1208" class="difflineplus">+</span>
<a href="#l11.1209"></a><span id="l11.1209" class="difflineplus">+    aTab.folderDisplay.makeInactive();</span>
<a href="#l11.1210"></a><span id="l11.1210">   },</span>
<a href="#l11.1211"></a><span id="l11.1211"> </span>
<a href="#l11.1212"></a><span id="l11.1212" class="difflineminus">-  _displayFolderAndThreadPane: function(show) {</span>
<a href="#l11.1213"></a><span id="l11.1213" class="difflineminus">-    let collapse = !show;</span>
<a href="#l11.1214"></a><span id="l11.1214" class="difflineplus">+  /**</span>
<a href="#l11.1215"></a><span id="l11.1215" class="difflineplus">+   * Some panes simply are illegal in certain views, and some panes are legal</span>
<a href="#l11.1216"></a><span id="l11.1216" class="difflineplus">+   *  but the user may have collapsed/hidden them.  If that was not enough, we</span>
<a href="#l11.1217"></a><span id="l11.1217" class="difflineplus">+   *  have three different layouts that are possible, each of which requires a</span>
<a href="#l11.1218"></a><span id="l11.1218" class="difflineplus">+   *  slightly different DOM configuration, and accordingly for us to poke at</span>
<a href="#l11.1219"></a><span id="l11.1219" class="difflineplus">+   *  different DOM nodes.  Things are made somewhat simpler by our decision</span>
<a href="#l11.1220"></a><span id="l11.1220" class="difflineplus">+   *  that all tabs share the same layout.</span>
<a href="#l11.1221"></a><span id="l11.1221" class="difflineplus">+   * This method takes the legal states and current display states and attempts</span>
<a href="#l11.1222"></a><span id="l11.1222" class="difflineplus">+   *  to apply the appropriate logic to make it all work out.  This method is</span>
<a href="#l11.1223"></a><span id="l11.1223" class="difflineplus">+   *  not in charge of figuring out or preserving display states.</span>
<a href="#l11.1224"></a><span id="l11.1224" class="difflineplus">+   *</span>
<a href="#l11.1225"></a><span id="l11.1225" class="difflineplus">+   * We take a dictionary of desired visibility booleans as our argument because</span>
<a href="#l11.1226"></a><span id="l11.1226" class="difflineplus">+   * it is both readable and scalable.</span>
<a href="#l11.1227"></a><span id="l11.1227" class="difflineplus">+   *</span>
<a href="#l11.1228"></a><span id="l11.1228" class="difflineplus">+   * @param aLegalStates A dictionary where each key and value indicates whether</span>
<a href="#l11.1229"></a><span id="l11.1229" class="difflineplus">+   *     the pane in question (key) is legal to be displayed in this mode.  If</span>
<a href="#l11.1230"></a><span id="l11.1230" class="difflineplus">+   *     the value is true, then the pane is legal.  Omitted pane keys imply</span>
<a href="#l11.1231"></a><span id="l11.1231" class="difflineplus">+   *     that the pane is illegal.  Keys are:</span>
<a href="#l11.1232"></a><span id="l11.1232" class="difflineplus">+   *     - folder: The folder (tree) pane.</span>
<a href="#l11.1233"></a><span id="l11.1233" class="difflineplus">+   *     - thread: The thread pane.</span>
<a href="#l11.1234"></a><span id="l11.1234" class="difflineplus">+   *     - message: The message pane.  Required/assumed to be true for now.</span>
<a href="#l11.1235"></a><span id="l11.1235" class="difflineplus">+   *     - glodaFacets: The gloda search facets pane.</span>
<a href="#l11.1236"></a><span id="l11.1236" class="difflineplus">+   * @param aVisibleStates A dictionary where each value indicates whether the</span>
<a href="#l11.1237"></a><span id="l11.1237" class="difflineplus">+   *     pane should be 'visible' (not collapsed).  Only panes that are governed</span>
<a href="#l11.1238"></a><span id="l11.1238" class="difflineplus">+   *     by splitters are options here.  Keys are:</span>
<a href="#l11.1239"></a><span id="l11.1239" class="difflineplus">+   *     - folder: The folder (tree) pane.</span>
<a href="#l11.1240"></a><span id="l11.1240" class="difflineplus">+   *     - message: The message pane.</span>
<a href="#l11.1241"></a><span id="l11.1241" class="difflineplus">+   */</span>
<a href="#l11.1242"></a><span id="l11.1242" class="difflineplus">+  _setPaneStates: function mailTabType_setPaneStates(aLegalStates,</span>
<a href="#l11.1243"></a><span id="l11.1243" class="difflineplus">+                                                     aVisibleStates) {</span>
<a href="#l11.1244"></a><span id="l11.1244">     let layout = pref.getIntPref(&quot;mail.pane_config.dynamic&quot;);</span>
<a href="#l11.1245"></a><span id="l11.1245">     if (layout == kWidePaneConfig)</span>
<a href="#l11.1246"></a><span id="l11.1246">     {</span>
<a href="#l11.1247"></a><span id="l11.1247" class="difflineminus">-      document.getElementById(&quot;messengerBox&quot;).collapsed = collapse;</span>
<a href="#l11.1248"></a><span id="l11.1248" class="difflineminus">-      // If opening a standalone message, need to give the messagepanebox flex.</span>
<a href="#l11.1249"></a><span id="l11.1249" class="difflineminus">-      if (collapse)</span>
<a href="#l11.1250"></a><span id="l11.1250" class="difflineplus">+      // in the &quot;wide&quot; configuration, the #messengerBox is left holding the</span>
<a href="#l11.1251"></a><span id="l11.1251" class="difflineplus">+      //  folder pane and thread pane, and the message pane has migrated to be</span>
<a href="#l11.1252"></a><span id="l11.1252" class="difflineplus">+      //  its sibling (under #mailContent).</span>
<a href="#l11.1253"></a><span id="l11.1253" class="difflineplus">+      // Accordingly, if both the folder and thread panes are illegal, we</span>
<a href="#l11.1254"></a><span id="l11.1254" class="difflineplus">+      //  want to collapse the #messengerBox and make sure the #messagepanebox</span>
<a href="#l11.1255"></a><span id="l11.1255" class="difflineplus">+      //  fills up the screen.  (For example, when in &quot;message&quot; mode.)</span>
<a href="#l11.1256"></a><span id="l11.1256" class="difflineplus">+      let collapseMessengerBox = !aLegalStates.folder &amp;&amp; !aLegalStates.thread;</span>
<a href="#l11.1257"></a><span id="l11.1257" class="difflineplus">+      document.getElementById(&quot;messengerBox&quot;).collapsed = collapseMessengerBox;</span>
<a href="#l11.1258"></a><span id="l11.1258" class="difflineplus">+      if (collapseMessengerBox)</span>
<a href="#l11.1259"></a><span id="l11.1259">         document.getElementById(&quot;messagepanebox&quot;).flex = 1;</span>
<a href="#l11.1260"></a><span id="l11.1260">     }</span>
<a href="#l11.1261"></a><span id="l11.1261"> </span>
<a href="#l11.1262"></a><span id="l11.1262" class="difflineminus">-    if (layout == kVerticalPaneConfig)</span>
<a href="#l11.1263"></a><span id="l11.1263" class="difflineminus">-      document.getElementById(&quot;threadTree&quot;).collapsed = collapse;</span>
<a href="#l11.1264"></a><span id="l11.1264" class="difflineminus">-    else</span>
<a href="#l11.1265"></a><span id="l11.1265" class="difflineminus">-      document.getElementById(&quot;displayDeck&quot;).collapsed = collapse;</span>
<a href="#l11.1266"></a><span id="l11.1266" class="difflineminus">-</span>
<a href="#l11.1267"></a><span id="l11.1267" class="difflineminus">-    let fpSplitter = document.getElementById(&quot;folderpane_splitter&quot;);</span>
<a href="#l11.1268"></a><span id="l11.1268" class="difflineminus">-    if (show &amp;&amp; fpSplitter.getAttribute(&quot;state&quot;) == &quot;collapsed&quot;)</span>
<a href="#l11.1269"></a><span id="l11.1269" class="difflineminus">-    {</span>
<a href="#l11.1270"></a><span id="l11.1270" class="difflineminus">-      // If we're showing everything but the folder pane splitter was</span>
<a href="#l11.1271"></a><span id="l11.1271" class="difflineminus">-      // previously collapsed, then keep it collapsed.</span>
<a href="#l11.1272"></a><span id="l11.1272" class="difflineminus">-      // However, in the case of it being collapsed from showing a</span>
<a href="#l11.1273"></a><span id="l11.1273" class="difflineminus">-      // a full message in a tab, then uncollapse just the splitter.</span>
<a href="#l11.1274"></a><span id="l11.1274" class="difflineminus">-      if (fpSplitter.getAttribute(&quot;substate&quot;))</span>
<a href="#l11.1275"></a><span id="l11.1275" class="difflineminus">-        fpSplitter.collapsed = false;</span>
<a href="#l11.1276"></a><span id="l11.1276" class="difflineminus">-    }</span>
<a href="#l11.1277"></a><span id="l11.1277" class="difflineplus">+    // -- folder pane</span>
<a href="#l11.1278"></a><span id="l11.1278" class="difflineplus">+    // collapse the splitter when not legal</span>
<a href="#l11.1279"></a><span id="l11.1279" class="difflineplus">+    document.getElementById(&quot;folderpane_splitter&quot;).collapsed =</span>
<a href="#l11.1280"></a><span id="l11.1280" class="difflineplus">+      !aLegalStates.folder;</span>
<a href="#l11.1281"></a><span id="l11.1281" class="difflineplus">+    // collapse the folder pane when not visible</span>
<a href="#l11.1282"></a><span id="l11.1282" class="difflineplus">+    document.getElementById(&quot;folderPaneBox&quot;).collapsed =</span>
<a href="#l11.1283"></a><span id="l11.1283" class="difflineplus">+      !aLegalStates.folder || !aVisibleStates.folder;</span>
<a href="#l11.1284"></a><span id="l11.1284" class="difflineplus">+</span>
<a href="#l11.1285"></a><span id="l11.1285" class="difflineplus">+    // -- thread pane</span>
<a href="#l11.1286"></a><span id="l11.1286" class="difflineplus">+    // in a vertical view, the threadContentArea sits in the #threadPaneBox</span>
<a href="#l11.1287"></a><span id="l11.1287" class="difflineplus">+    //  next to the message pane and its splitter.</span>
<a href="#l11.1288"></a><span id="l11.1288" class="difflineplus">+    if (layout == kVerticalMailLayout)</span>
<a href="#l11.1289"></a><span id="l11.1289" class="difflineplus">+      document.getElementById(&quot;threadContentArea&quot;).collapsed =</span>
<a href="#l11.1290"></a><span id="l11.1290" class="difflineplus">+        !aLegalStates.thread;</span>
<a href="#l11.1291"></a><span id="l11.1291" class="difflineplus">+    // whereas in the default view, the displayDeck is the one next to the</span>
<a href="#l11.1292"></a><span id="l11.1292" class="difflineplus">+    //  message pane and its splitter</span>
<a href="#l11.1293"></a><span id="l11.1293">     else</span>
<a href="#l11.1294"></a><span id="l11.1294" class="difflineminus">-    {</span>
<a href="#l11.1295"></a><span id="l11.1295" class="difflineminus">-      fpSplitter.collapsed = collapse;</span>
<a href="#l11.1296"></a><span id="l11.1296" class="difflineminus">-      document.getElementById(&quot;folderPaneBox&quot;).collapsed = collapse;</span>
<a href="#l11.1297"></a><span id="l11.1297" class="difflineminus">-    }</span>
<a href="#l11.1298"></a><span id="l11.1298" class="difflineminus">-</span>
<a href="#l11.1299"></a><span id="l11.1299" class="difflineminus">-    let tpSplitter = document.getElementById(&quot;threadpane-splitter&quot;);</span>
<a href="#l11.1300"></a><span id="l11.1300" class="difflineminus">-    if (show &amp;&amp; tpSplitter.getAttribute(&quot;state&quot;) == &quot;collapsed&quot;)</span>
<a href="#l11.1301"></a><span id="l11.1301" class="difflineminus">-    {</span>
<a href="#l11.1302"></a><span id="l11.1302" class="difflineminus">-      // If we're showing everything but the thread pane splitter was</span>
<a href="#l11.1303"></a><span id="l11.1303" class="difflineminus">-      // previously collapsed, then keep it collapsed.</span>
<a href="#l11.1304"></a><span id="l11.1304" class="difflineminus">-      // However, in the case of it being collapsed from showing a</span>
<a href="#l11.1305"></a><span id="l11.1305" class="difflineminus">-      // a full message in a tab, then uncollapse just the splitter.</span>
<a href="#l11.1306"></a><span id="l11.1306" class="difflineminus">-      tpSplitter.collapsed = tpSplitter.getAttribute(&quot;substate&quot;) ? false : true;</span>
<a href="#l11.1307"></a><span id="l11.1307" class="difflineminus">-      document.getElementById(&quot;messagepanebox&quot;).collapsed = true;</span>
<a href="#l11.1308"></a><span id="l11.1308" class="difflineminus">-    }</span>
<a href="#l11.1309"></a><span id="l11.1309" class="difflineminus">-    else</span>
<a href="#l11.1310"></a><span id="l11.1310" class="difflineminus">-    {</span>
<a href="#l11.1311"></a><span id="l11.1311" class="difflineminus">-      tpSplitter.collapsed = collapse;</span>
<a href="#l11.1312"></a><span id="l11.1312" class="difflineminus">-      document.getElementById(&quot;messagepanebox&quot;).collapsed = false;</span>
<a href="#l11.1313"></a><span id="l11.1313" class="difflineminus">-    }</span>
<a href="#l11.1314"></a><span id="l11.1314" class="difflineminus">-    // Need to call ChangeMessagePaneVisibility() a little later after the</span>
<a href="#l11.1315"></a><span id="l11.1315" class="difflineminus">-    // message was selected so that the tab state data gets the message key</span>
<a href="#l11.1316"></a><span id="l11.1316" class="difflineminus">-    // saved off, which happens below in showTab().</span>
<a href="#l11.1317"></a><span id="l11.1317" class="difflineminus">-    setTimeout(ChangeMessagePaneVisibility, 0, IsMessagePaneCollapsed());</span>
<a href="#l11.1318"></a><span id="l11.1318" class="difflineminus">-</span>
<a href="#l11.1319"></a><span id="l11.1319" class="difflineplus">+      document.getElementById(&quot;displayDeck&quot;).collapsed =</span>
<a href="#l11.1320"></a><span id="l11.1320" class="difflineplus">+        !aLegalStates.thread;</span>
<a href="#l11.1321"></a><span id="l11.1321" class="difflineplus">+</span>
<a href="#l11.1322"></a><span id="l11.1322" class="difflineplus">+    // the threadpane-splitter collapses the message pane (arguably a misnomer),</span>
<a href="#l11.1323"></a><span id="l11.1323" class="difflineplus">+    //  but it only needs to exist when the thread-pane is legal</span>
<a href="#l11.1324"></a><span id="l11.1324" class="difflineplus">+    document.getElementById(&quot;threadpane-splitter&quot;).collapsed =</span>
<a href="#l11.1325"></a><span id="l11.1325" class="difflineplus">+      !aLegalStates.thread;</span>
<a href="#l11.1326"></a><span id="l11.1326" class="difflineplus">+</span>
<a href="#l11.1327"></a><span id="l11.1327" class="difflineplus">+    // Some things do not make sense if the thread pane is not legal.</span>
<a href="#l11.1328"></a><span id="l11.1328" class="difflineplus">+    // (This is likely an example of something that should be using the command</span>
<a href="#l11.1329"></a><span id="l11.1329" class="difflineplus">+    //  mechanism to update the UI elements as to the state of what the user</span>
<a href="#l11.1330"></a><span id="l11.1330" class="difflineplus">+    //  is looking at, rather than home-brewing it in here.)</span>
<a href="#l11.1331"></a><span id="l11.1331">     try {</span>
<a href="#l11.1332"></a><span id="l11.1332" class="difflineminus">-      document.getElementById(&quot;search-container&quot;).collapsed = collapse;</span>
<a href="#l11.1333"></a><span id="l11.1333" class="difflineplus">+      // you can't quick-search if you don't have a collection of messages</span>
<a href="#l11.1334"></a><span id="l11.1334" class="difflineplus">+      document.getElementById(&quot;search-container&quot;).collapsed =</span>
<a href="#l11.1335"></a><span id="l11.1335" class="difflineplus">+        !aLegalStates.thread;</span>
<a href="#l11.1336"></a><span id="l11.1336">     } catch (ex) {}</span>
<a href="#l11.1337"></a><span id="l11.1337">     try {</span>
<a href="#l11.1338"></a><span id="l11.1338" class="difflineminus">-      document.getElementById(&quot;mailviews-container&quot;).collapsed = collapse;</span>
<a href="#l11.1339"></a><span id="l11.1339" class="difflineplus">+      // views only work on the thread pane; no thread pane, no views</span>
<a href="#l11.1340"></a><span id="l11.1340" class="difflineplus">+      document.getElementById(&quot;mailviews-container&quot;).collapsed =</span>
<a href="#l11.1341"></a><span id="l11.1341" class="difflineplus">+        !aLegalStates.thread;</span>
<a href="#l11.1342"></a><span id="l11.1342">     } catch (ex) {}</span>
<a href="#l11.1343"></a><span id="l11.1343" class="difflineminus">-  },</span>
<a href="#l11.1344"></a><span id="l11.1344" class="difflineminus">-</span>
<a href="#l11.1345"></a><span id="l11.1345" class="difflineminus">-  _folderAndThreadPaneVisible: true,</span>
<a href="#l11.1346"></a><span id="l11.1346" class="difflineminus">-  get folderAndThreadPaneVisible() { return this._folderAndThreadPaneVisible; },</span>
<a href="#l11.1347"></a><span id="l11.1347" class="difflineminus">-  set folderAndThreadPaneVisible(aDesiredVisible) {</span>
<a href="#l11.1348"></a><span id="l11.1348" class="difflineminus">-    if (aDesiredVisible != this._folderAndThreadPaneVisible) {</span>
<a href="#l11.1349"></a><span id="l11.1349" class="difflineminus">-      this._displayFolderAndThreadPane(aDesiredVisible);</span>
<a href="#l11.1350"></a><span id="l11.1350" class="difflineminus">-      this._folderAndThreadPaneVisible = aDesiredVisible;</span>
<a href="#l11.1351"></a><span id="l11.1351" class="difflineminus">-    }</span>
<a href="#l11.1352"></a><span id="l11.1352" class="difflineplus">+</span>
<a href="#l11.1353"></a><span id="l11.1353" class="difflineplus">+    // -- message pane</span>
<a href="#l11.1354"></a><span id="l11.1354" class="difflineplus">+    // the message pane can only be collapsed when the thread pane is legal</span>
<a href="#l11.1355"></a><span id="l11.1355" class="difflineplus">+    document.getElementById(&quot;messagepanebox&quot;).collapsed =</span>
<a href="#l11.1356"></a><span id="l11.1356" class="difflineplus">+      aLegalStates.thread &amp;&amp; !aVisibleStates.message;</span>
<a href="#l11.1357"></a><span id="l11.1357" class="difflineplus">+</span>
<a href="#l11.1358"></a><span id="l11.1358" class="difflineplus">+    // -- gloda facets</span>
<a href="#l11.1359"></a><span id="l11.1359" class="difflineplus">+    //document.getElementById(&quot;glodaSearchFacets&quot;).hidden =</span>
<a href="#l11.1360"></a><span id="l11.1360" class="difflineplus">+    //  !aLegalStates.glodaFacets;</span>
<a href="#l11.1361"></a><span id="l11.1361">   },</span>
<a href="#l11.1362"></a><span id="l11.1362"> </span>
<a href="#l11.1363"></a><span id="l11.1363">   showTab: function(aTab) {</span>
<a href="#l11.1364"></a><span id="l11.1364">     // Set the messagepane as the primary browser for content.</span>
<a href="#l11.1365"></a><span id="l11.1365">     document.getElementById(&quot;messagepane&quot;).setAttribute(&quot;type&quot;,</span>
<a href="#l11.1366"></a><span id="l11.1366">                                                         &quot;content-primary&quot;);</span>
<a href="#l11.1367"></a><span id="l11.1367"> </span>
<a href="#l11.1368"></a><span id="l11.1368" class="difflineminus">-    // restore globals</span>
<a href="#l11.1369"></a><span id="l11.1369" class="difflineminus">-    messenger = aTab.messenger;</span>
<a href="#l11.1370"></a><span id="l11.1370" class="difflineminus">-    gDBView = aTab.dbView;</span>
<a href="#l11.1371"></a><span id="l11.1371" class="difflineminus">-    gSearchSession = aTab.searchSession;</span>
<a href="#l11.1372"></a><span id="l11.1372" class="difflineminus">-</span>
<a href="#l11.1373"></a><span id="l11.1373" class="difflineminus">-    // restore selection in folder pane;</span>
<a href="#l11.1374"></a><span id="l11.1374" class="difflineminus">-    let folderToSelect = gDBView ? gDBView.msgFolder : aTab.msgSelectedFolder;</span>
<a href="#l11.1375"></a><span id="l11.1375" class="difflineminus">-    // restore view state if we had one</span>
<a href="#l11.1376"></a><span id="l11.1376" class="difflineminus">-    var row = gFolderTreeView.getIndexOfFolder(folderToSelect);</span>
<a href="#l11.1377"></a><span id="l11.1377" class="difflineminus">-</span>
<a href="#l11.1378"></a><span id="l11.1378" class="difflineminus">-    var treeBoxObj = document.getElementById(&quot;folderTree&quot;).treeBoxObject;</span>
<a href="#l11.1379"></a><span id="l11.1379" class="difflineminus">-    var folderTreeSelection = treeBoxObj.view.selection;</span>
<a href="#l11.1380"></a><span id="l11.1380" class="difflineminus">-    // make sure that row.value is valid so that it doesn't mess up</span>
<a href="#l11.1381"></a><span id="l11.1381" class="difflineminus">-    // the call to ensureRowIsVisible().</span>
<a href="#l11.1382"></a><span id="l11.1382" class="difflineminus">-    if ((row &gt;= 0) &amp;&amp; !folderTreeSelection.isSelected(row))</span>
<a href="#l11.1383"></a><span id="l11.1383" class="difflineminus">-    {</span>
<a href="#l11.1384"></a><span id="l11.1384" class="difflineminus">-      gMsgFolderSelected = folderToSelect;</span>
<a href="#l11.1385"></a><span id="l11.1385" class="difflineminus">-      folderTreeSelection.selectEventsSuppressed = true;</span>
<a href="#l11.1386"></a><span id="l11.1386" class="difflineminus">-      folderTreeSelection.select(row);</span>
<a href="#l11.1387"></a><span id="l11.1387" class="difflineminus">-      treeBoxObj.ensureRowIsVisible(row);</span>
<a href="#l11.1388"></a><span id="l11.1388" class="difflineminus">-      folderTreeSelection.selectEventsSuppressed = false;</span>
<a href="#l11.1389"></a><span id="l11.1389" class="difflineminus">-    }</span>
<a href="#l11.1390"></a><span id="l11.1390" class="difflineminus">-    if (gDBView)</span>
<a href="#l11.1391"></a><span id="l11.1391" class="difflineminus">-    {</span>
<a href="#l11.1392"></a><span id="l11.1392" class="difflineminus">-      UpdateColumnsForView(gMsgFolderSelected, gDBView.viewType);</span>
<a href="#l11.1393"></a><span id="l11.1393" class="difflineminus">-      UpdateSortIndicators(gDBView.sortType, gDBView.sortOrder);</span>
<a href="#l11.1394"></a><span id="l11.1394" class="difflineminus">-      // This sets the thread pane tree's view to the gDBView view.</span>
<a href="#l11.1395"></a><span id="l11.1395" class="difflineminus">-      RerootThreadPane();</span>
<a href="#l11.1396"></a><span id="l11.1396" class="difflineminus">-      // Only refresh the view picker if the views toolbar is visible.</span>
<a href="#l11.1397"></a><span id="l11.1397" class="difflineminus">-      if (document.getElementById(&quot;mailviews-container&quot;)) </span>
<a href="#l11.1398"></a><span id="l11.1398" class="difflineminus">-        UpdateViewPickerByValue(aTab.mailView);</span>
<a href="#l11.1399"></a><span id="l11.1399" class="difflineminus">-</span>
<a href="#l11.1400"></a><span id="l11.1400" class="difflineminus">-      // We need to restore the selection to what it was when we switched away</span>
<a href="#l11.1401"></a><span id="l11.1401" class="difflineminus">-      // from this tab. We need to remember the selected keys, instead of the</span>
<a href="#l11.1402"></a><span id="l11.1402" class="difflineminus">-      // selected indices, since the view might have changed. But maybe the</span>
<a href="#l11.1403"></a><span id="l11.1403" class="difflineminus">-      // selectedIndices adjust as items are added/removed from the (hidden)</span>
<a href="#l11.1404"></a><span id="l11.1404" class="difflineminus">-      // view.</span>
<a href="#l11.1405"></a><span id="l11.1405" class="difflineminus">-      try</span>
<a href="#l11.1406"></a><span id="l11.1406" class="difflineminus">-      {</span>
<a href="#l11.1407"></a><span id="l11.1407" class="difflineminus">-        if (aTab.selectedMsgId &amp;&amp; aTab.msgSelectedFolder)</span>
<a href="#l11.1408"></a><span id="l11.1408" class="difflineminus">-        {</span>
<a href="#l11.1409"></a><span id="l11.1409" class="difflineminus">-          // We clear the selection in order to generate an event when we</span>
<a href="#l11.1410"></a><span id="l11.1410" class="difflineminus">-          // re-select our message.</span>
<a href="#l11.1411"></a><span id="l11.1411" class="difflineminus">-          ClearThreadPaneSelection();</span>
<a href="#l11.1412"></a><span id="l11.1412" class="difflineminus">-</span>
<a href="#l11.1413"></a><span id="l11.1413" class="difflineminus">-          var msgDB = aTab.msgSelectedFolder.msgDatabase;</span>
<a href="#l11.1414"></a><span id="l11.1414" class="difflineminus">-          var msgHdr = msgDB.getMsgHdrForMessageID(aTab.selectedMsgId);</span>
<a href="#l11.1415"></a><span id="l11.1415" class="difflineminus">-          setTimeout(gDBView.selectFolderMsgByKey, 0, aTab.msgSelectedFolder,</span>
<a href="#l11.1416"></a><span id="l11.1416" class="difflineminus">-                     msgHdr.messageKey);</span>
<a href="#l11.1417"></a><span id="l11.1417" class="difflineminus">-        }</span>
<a href="#l11.1418"></a><span id="l11.1418" class="difflineminus">-        // We do not clear the selection if there was more than one message</span>
<a href="#l11.1419"></a><span id="l11.1419" class="difflineminus">-        // displayed.  this leaves our selection intact. there was originally</span>
<a href="#l11.1420"></a><span id="l11.1420" class="difflineminus">-        // some claim that the selection might lose synchronization with the</span>
<a href="#l11.1421"></a><span id="l11.1421" class="difflineminus">-        // view, but this is unsubstantiated.  said comment came from the</span>
<a href="#l11.1422"></a><span id="l11.1422" class="difflineminus">-        // original code that stored information on the selected rows, but</span>
<a href="#l11.1423"></a><span id="l11.1423" class="difflineminus">-        // then failed to do anything with it, probably because there is no</span>
<a href="#l11.1424"></a><span id="l11.1424" class="difflineminus">-        // existing API call that accomplishes it.</span>
<a href="#l11.1425"></a><span id="l11.1425" class="difflineplus">+    aTab.folderDisplay.makeActive();</span>
<a href="#l11.1426"></a><span id="l11.1426" class="difflineplus">+</span>
<a href="#l11.1427"></a><span id="l11.1427" class="difflineplus">+    // - restore folder pane/tree selection</span>
<a href="#l11.1428"></a><span id="l11.1428" class="difflineplus">+    if (aTab.folderDisplay.displayedFolder) {</span>
<a href="#l11.1429"></a><span id="l11.1429" class="difflineplus">+      // but don't generate any events while doing so!</span>
<a href="#l11.1430"></a><span id="l11.1430" class="difflineplus">+      gFolderTreeView.selection.selectEventsSuppressed = true;</span>
<a href="#l11.1431"></a><span id="l11.1431" class="difflineplus">+      try {</span>
<a href="#l11.1432"></a><span id="l11.1432" class="difflineplus">+        gFolderTreeView.selectFolder(aTab.folderDisplay.displayedFolder);</span>
<a href="#l11.1433"></a><span id="l11.1433">       }</span>
<a href="#l11.1434"></a><span id="l11.1434" class="difflineminus">-      catch (ex) {dump(ex);}</span>
<a href="#l11.1435"></a><span id="l11.1435" class="difflineminus">-</span>
<a href="#l11.1436"></a><span id="l11.1436" class="difflineminus">-      document.getElementById(&quot;threadTree&quot;).treeBoxObject.scrollToRow(aTab.firstVisibleRow);</span>
<a href="#l11.1437"></a><span id="l11.1437" class="difflineminus">-      ShowThreadPane();</span>
<a href="#l11.1438"></a><span id="l11.1438" class="difflineminus">-    }</span>
<a href="#l11.1439"></a><span id="l11.1439" class="difflineminus">-    else if (gMsgFolderSelected.isServer)</span>
<a href="#l11.1440"></a><span id="l11.1440" class="difflineminus">-    {</span>
<a href="#l11.1441"></a><span id="l11.1441" class="difflineminus">-      UpdateStatusQuota(null);</span>
<a href="#l11.1442"></a><span id="l11.1442" class="difflineminus">-      // Load AccountCentral page here.</span>
<a href="#l11.1443"></a><span id="l11.1443" class="difflineminus">-      ShowAccountCentral();</span>
<a href="#l11.1444"></a><span id="l11.1444" class="difflineplus">+      finally {</span>
<a href="#l11.1445"></a><span id="l11.1445" class="difflineplus">+        gIgnoreSyntheticFolderPaneSelectionChange = true;</span>
<a href="#l11.1446"></a><span id="l11.1446" class="difflineplus">+        gFolderTreeView.selection.selectEventsSuppressed = false;</span>
<a href="#l11.1447"></a><span id="l11.1447" class="difflineplus">+      }</span>
<a href="#l11.1448"></a><span id="l11.1448">     }</span>
<a href="#l11.1449"></a><span id="l11.1449">   },</span>
<a href="#l11.1450"></a><span id="l11.1450"> </span>
<a href="#l11.1451"></a><span id="l11.1451">   supportsCommand: function(aTab, aCommand) {</span>
<a href="#l11.1452"></a><span id="l11.1452">     return DefaultController.supportsCommand(aCommand);</span>
<a href="#l11.1453"></a><span id="l11.1453">   },</span>
<a href="#l11.1454"></a><span id="l11.1454"> </span>
<a href="#l11.1455"></a><span id="l11.1455">   isCommandEnabled: function(aTab, aCommand) {</span>
<a href="#l11.1456"></a><span id="l11.1456" class="difflineat">@@ -1912,90 +1921,64 @@ let mailTabType = {</span>
<a href="#l11.1457"></a><span id="l11.1457"> function MsgOpenNewWindowForFolder(folderURI, msgKeyToSelect)</span>
<a href="#l11.1458"></a><span id="l11.1458"> {</span>
<a href="#l11.1459"></a><span id="l11.1459">   if (folderURI) {</span>
<a href="#l11.1460"></a><span id="l11.1460">     window.openDialog(&quot;chrome://messenger/content/&quot;, &quot;_blank&quot;,</span>
<a href="#l11.1461"></a><span id="l11.1461">                       &quot;chrome,all,dialog=no&quot;, folderURI, msgKeyToSelect);</span>
<a href="#l11.1462"></a><span id="l11.1462">     return;</span>
<a href="#l11.1463"></a><span id="l11.1463">   }</span>
<a href="#l11.1464"></a><span id="l11.1464"> </span>
<a href="#l11.1465"></a><span id="l11.1465" class="difflineminus">-  // Use gFolderTreeView.getSelectedFolders() to find out which folder to open</span>
<a href="#l11.1466"></a><span id="l11.1466" class="difflineminus">-  // instead of GetLoadedMsgFolder().URI. This is required because on a</span>
<a href="#l11.1467"></a><span id="l11.1467" class="difflineminus">-  // right-click, the currentIndex value will be different from the actual row</span>
<a href="#l11.1468"></a><span id="l11.1468" class="difflineminus">-  // that is highlighted. gFolderTreeView.getSelectedFolders() will return the</span>
<a href="#l11.1469"></a><span id="l11.1469" class="difflineminus">-  // folder that is highlighted.</span>
<a href="#l11.1470"></a><span id="l11.1470" class="difflineplus">+  // If there is a right-click happening, gFolderTreeView.getSelectedFolders()</span>
<a href="#l11.1471"></a><span id="l11.1471" class="difflineplus">+  // will tell us about it (while the selection's currentIndex would reflect</span>
<a href="#l11.1472"></a><span id="l11.1472" class="difflineplus">+  // the node that was selected/displayed before the right-click.)</span>
<a href="#l11.1473"></a><span id="l11.1473">   let selectedFolders = gFolderTreeView.getSelectedFolders();</span>
<a href="#l11.1474"></a><span id="l11.1474">   for (let i = 0; i &lt; selectedFolders.length; i++) {</span>
<a href="#l11.1475"></a><span id="l11.1475">     window.openDialog(&quot;chrome://messenger/content/&quot;, &quot;_blank&quot;,</span>
<a href="#l11.1476"></a><span id="l11.1476">                       &quot;chrome,all,dialog=no&quot;,</span>
<a href="#l11.1477"></a><span id="l11.1477">                       selectedFolders[i].URI, msgKeyToSelect);</span>
<a href="#l11.1478"></a><span id="l11.1478">   }</span>
<a href="#l11.1479"></a><span id="l11.1479"> }</span>
<a href="#l11.1480"></a><span id="l11.1480"> </span>
<a href="#l11.1481"></a><span id="l11.1481" class="difflineminus">-function MsgOpenNewTabForFolder(folderURI, msgKeyToSelect)</span>
<a href="#l11.1482"></a><span id="l11.1482" class="difflineplus">+/**</span>
<a href="#l11.1483"></a><span id="l11.1483" class="difflineplus">+ * UI-triggered command to open the currently selected folder(s) in new tabs.</span>
<a href="#l11.1484"></a><span id="l11.1484" class="difflineplus">+ */</span>
<a href="#l11.1485"></a><span id="l11.1485" class="difflineplus">+function MsgOpenNewTabForFolder()</span>
<a href="#l11.1486"></a><span id="l11.1486"> {</span>
<a href="#l11.1487"></a><span id="l11.1487" class="difflineminus">-  // XXX implement the usage of msgKeyToSelect...</span>
<a href="#l11.1488"></a><span id="l11.1488" class="difflineminus">-  if (folderURI) {</span>
<a href="#l11.1489"></a><span id="l11.1489" class="difflineminus">-    document.getElementById(&quot;tabmail&quot;).openTab(&quot;folder&quot;, folderURI);</span>
<a href="#l11.1490"></a><span id="l11.1490" class="difflineminus">-    return;</span>
<a href="#l11.1491"></a><span id="l11.1491" class="difflineminus">-  }</span>
<a href="#l11.1492"></a><span id="l11.1492" class="difflineminus">-</span>
<a href="#l11.1493"></a><span id="l11.1493" class="difflineminus">-  // Use gFolderTreeView.getSelectedFolders() to find out which folder to open</span>
<a href="#l11.1494"></a><span id="l11.1494" class="difflineminus">-  // instead of GetLoadedMsgFolder().URI. This is required because on a</span>
<a href="#l11.1495"></a><span id="l11.1495" class="difflineminus">-  // right-click, the currentIndex value will be different from the actual row</span>
<a href="#l11.1496"></a><span id="l11.1496" class="difflineminus">-  // that is highlighted. gFolderTreeView.getSelectedFolders() will return the</span>
<a href="#l11.1497"></a><span id="l11.1497" class="difflineminus">-  // folder that is highlighted.</span>
<a href="#l11.1498"></a><span id="l11.1498" class="difflineplus">+  // If there is a right-click happening, gFolderTreeView.getSelectedFolders()</span>
<a href="#l11.1499"></a><span id="l11.1499" class="difflineplus">+  // will tell us about it (while the selection's currentIndex would reflect</span>
<a href="#l11.1500"></a><span id="l11.1500" class="difflineplus">+  // the node that was selected/displayed before the right-click.)</span>
<a href="#l11.1501"></a><span id="l11.1501">   let selectedFolders = gFolderTreeView.getSelectedFolders();</span>
<a href="#l11.1502"></a><span id="l11.1502">   for (let i = 0; i &lt; selectedFolders.length; i++) {</span>
<a href="#l11.1503"></a><span id="l11.1503" class="difflineminus">-    // Set up the first tab, which was previously invisible.</span>
<a href="#l11.1504"></a><span id="l11.1504" class="difflineminus">-    // This assumes the first tab is always a 3-pane ui, which</span>
<a href="#l11.1505"></a><span id="l11.1505" class="difflineminus">-    // may not be right, especially if we have the ability</span>
<a href="#l11.1506"></a><span id="l11.1506" class="difflineminus">-    // to persist your tab setup.</span>
<a href="#l11.1507"></a><span id="l11.1507" class="difflineminus">-    document.getElementById(&quot;tabmail&quot;).openTab(&quot;folder&quot;, selectedFolders[i].URI);</span>
<a href="#l11.1508"></a><span id="l11.1508" class="difflineplus">+    document.getElementById(&quot;tabmail&quot;).openTab(&quot;folder&quot;, selectedFolders[i]);</span>
<a href="#l11.1509"></a><span id="l11.1509">   }</span>
<a href="#l11.1510"></a><span id="l11.1510"> }</span>
<a href="#l11.1511"></a><span id="l11.1511"> </span>
<a href="#l11.1512"></a><span id="l11.1512" class="difflineminus">-function MsgOpenNewTabForMessage(messageKey, folderUri)</span>
<a href="#l11.1513"></a><span id="l11.1513" class="difflineplus">+/**</span>
<a href="#l11.1514"></a><span id="l11.1514" class="difflineplus">+ * UI-triggered command to open the currently selected message in a new tab.</span>
<a href="#l11.1515"></a><span id="l11.1515" class="difflineplus">+ */</span>
<a href="#l11.1516"></a><span id="l11.1516" class="difflineplus">+function MsgOpenNewTabForMessage()</span>
<a href="#l11.1517"></a><span id="l11.1517"> {</span>
<a href="#l11.1518"></a><span id="l11.1518" class="difflineminus">-  var hdr;</span>
<a href="#l11.1519"></a><span id="l11.1519" class="difflineminus">-</span>
<a href="#l11.1520"></a><span id="l11.1520" class="difflineminus">-  // messageKey can be 0 for an actual message (first message in the folder)  </span>
<a href="#l11.1521"></a><span id="l11.1521" class="difflineminus">-  if (folderUri)</span>
<a href="#l11.1522"></a><span id="l11.1522" class="difflineminus">-  {</span>
<a href="#l11.1523"></a><span id="l11.1523" class="difflineminus">-    hdr = GetMsgFolderFromUri(folderUri).GetMessageHeader(messageKey);</span>
<a href="#l11.1524"></a><span id="l11.1524" class="difflineminus">-  }</span>
<a href="#l11.1525"></a><span id="l11.1525" class="difflineminus">-  else</span>
<a href="#l11.1526"></a><span id="l11.1526" class="difflineminus">-  {</span>
<a href="#l11.1527"></a><span id="l11.1527" class="difflineminus">-    hdr = gDBView.hdrForFirstSelectedMessage;</span>
<a href="#l11.1528"></a><span id="l11.1528" class="difflineminus">-    // Use the header's folder - this will open a msg in a virtual folder view</span>
<a href="#l11.1529"></a><span id="l11.1529" class="difflineminus">-    // in its real folder, which is needed if the msg wouldn't be in a new</span>
<a href="#l11.1530"></a><span id="l11.1530" class="difflineminus">-    // view with the same terms - e.g., it's read and the view is unread only.</span>
<a href="#l11.1531"></a><span id="l11.1531" class="difflineminus">-    // If we cloned the view, we wouldn't have to do this.</span>
<a href="#l11.1532"></a><span id="l11.1532" class="difflineminus">-    folderUri = hdr.folder.URI;</span>
<a href="#l11.1533"></a><span id="l11.1533" class="difflineminus">-  }</span>
<a href="#l11.1534"></a><span id="l11.1534" class="difflineminus">-  </span>
<a href="#l11.1535"></a><span id="l11.1535" class="difflineminus">-  // Fix it so we won't try to load the previously loaded message.</span>
<a href="#l11.1536"></a><span id="l11.1536" class="difflineminus">-  hdr.folder.lastMessageLoaded = nsMsgKey_None;</span>
<a href="#l11.1537"></a><span id="l11.1537" class="difflineminus">-</span>
<a href="#l11.1538"></a><span id="l11.1538" class="difflineminus">-  document.getElementById('tabmail').openTab(&quot;message&quot;, folderUri, hdr);</span>
<a href="#l11.1539"></a><span id="l11.1539" class="difflineplus">+  if (!gFolderDisplay.selectedMessage)</span>
<a href="#l11.1540"></a><span id="l11.1540" class="difflineplus">+    return;</span>
<a href="#l11.1541"></a><span id="l11.1541" class="difflineplus">+  document.getElementById('tabmail').openTab(&quot;message&quot;,</span>
<a href="#l11.1542"></a><span id="l11.1542" class="difflineplus">+                                             gFolderDisplay.selectedMessage,</span>
<a href="#l11.1543"></a><span id="l11.1543" class="difflineplus">+                                             gFolderDisplay.view);</span>
<a href="#l11.1544"></a><span id="l11.1544"> }</span>
<a href="#l11.1545"></a><span id="l11.1545"> </span>
<a href="#l11.1546"></a><span id="l11.1546"> function MsgOpenSelectedMessages()</span>
<a href="#l11.1547"></a><span id="l11.1547"> {</span>
<a href="#l11.1548"></a><span id="l11.1548">   // Toggle message body (rss summary) and content-base url in message</span>
<a href="#l11.1549"></a><span id="l11.1549">   // pane per pref, otherwise open summary or web page in new window.</span>
<a href="#l11.1550"></a><span id="l11.1550" class="difflineminus">-  if (IsFeedItem() &amp;&amp; GetFeedOpenHandler() == 2) {</span>
<a href="#l11.1551"></a><span id="l11.1551" class="difflineplus">+  if (gFolderDisplay.selectedMessageIsFeed &amp;&amp; GetFeedOpenHandler() == 2) {</span>
<a href="#l11.1552"></a><span id="l11.1552">     FeedSetContentViewToggle();</span>
<a href="#l11.1553"></a><span id="l11.1553">     return;</span>
<a href="#l11.1554"></a><span id="l11.1554">   }</span>
<a href="#l11.1555"></a><span id="l11.1555"> </span>
<a href="#l11.1556"></a><span id="l11.1556" class="difflineminus">-  var dbView = GetDBView();</span>
<a href="#l11.1557"></a><span id="l11.1557" class="difflineminus">-</span>
<a href="#l11.1558"></a><span id="l11.1558" class="difflineminus">-  var indices = GetSelectedIndices(dbView);</span>
<a href="#l11.1559"></a><span id="l11.1559" class="difflineminus">-  var numMessages = indices.length;</span>
<a href="#l11.1560"></a><span id="l11.1560" class="difflineplus">+  let selectedMessages = gFolderDisplay.selectedMessages;</span>
<a href="#l11.1561"></a><span id="l11.1561" class="difflineplus">+  var numMessages = selectedMessages.length;</span>
<a href="#l11.1562"></a><span id="l11.1562"> </span>
<a href="#l11.1563"></a><span id="l11.1563">   var windowReuse = gPrefBranch.getBoolPref(&quot;mailnews.reuse_message_window&quot;);</span>
<a href="#l11.1564"></a><span id="l11.1564">   // This is a radio type button pref, currently with only 2 buttons.</span>
<a href="#l11.1565"></a><span id="l11.1565">   // We need to keep the pref type as 'bool' for backwards compatibility</span>
<a href="#l11.1566"></a><span id="l11.1566">   // with 4.x migrated prefs.  For future radio button(s), please use another</span>
<a href="#l11.1567"></a><span id="l11.1567">   // pref (either 'bool' or 'int' type) to describe it.</span>
<a href="#l11.1568"></a><span id="l11.1568">   //</span>
<a href="#l11.1569"></a><span id="l11.1569">   // windowReuse values: false, true</span>
<a href="#l11.1570"></a><span id="l11.1570" class="difflineat">@@ -2013,55 +1996,37 @@ function MsgOpenSelectedMessages()</span>
<a href="#l11.1571"></a><span id="l11.1571">     var text = gMessengerBundle.getFormattedString(&quot;openWindowWarningText&quot;, [numMessages]);</span>
<a href="#l11.1572"></a><span id="l11.1572">     var promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l11.1573"></a><span id="l11.1573">                                   .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l11.1574"></a><span id="l11.1574">     if (!promptService.confirm(window, title, text))</span>
<a href="#l11.1575"></a><span id="l11.1575">       return;</span>
<a href="#l11.1576"></a><span id="l11.1576">   }</span>
<a href="#l11.1577"></a><span id="l11.1577"> </span>
<a href="#l11.1578"></a><span id="l11.1578">   for (var i = 0; i &lt; numMessages; i++) {</span>
<a href="#l11.1579"></a><span id="l11.1579" class="difflineminus">-    MsgOpenNewWindowForMessage(dbView.getURIForViewIndex(indices[i]),</span>
<a href="#l11.1580"></a><span id="l11.1580" class="difflineminus">-                               dbView.getFolderForViewIndex(indices[i]).URI);</span>
<a href="#l11.1581"></a><span id="l11.1581" class="difflineplus">+    MsgOpenNewWindowForMessage(selectedMessages[i]);</span>
<a href="#l11.1582"></a><span id="l11.1582">   }</span>
<a href="#l11.1583"></a><span id="l11.1583"> }</span>
<a href="#l11.1584"></a><span id="l11.1584"> </span>
<a href="#l11.1585"></a><span id="l11.1585"> function MsgOpenSelectedMessageInExistingWindow()</span>
<a href="#l11.1586"></a><span id="l11.1586"> {</span>
<a href="#l11.1587"></a><span id="l11.1587">   var windowID = GetWindowByWindowType(&quot;mail:messageWindow&quot;);</span>
<a href="#l11.1588"></a><span id="l11.1588">   if (!windowID)</span>
<a href="#l11.1589"></a><span id="l11.1589">     return false;</span>
<a href="#l11.1590"></a><span id="l11.1590"> </span>
<a href="#l11.1591"></a><span id="l11.1591" class="difflineminus">-  try {</span>
<a href="#l11.1592"></a><span id="l11.1592" class="difflineminus">-    var messageURI = gDBView.URIForFirstSelectedMessage;</span>
<a href="#l11.1593"></a><span id="l11.1593" class="difflineminus">-    var msgHdr = gDBView.hdrForFirstSelectedMessage;</span>
<a href="#l11.1594"></a><span id="l11.1594" class="difflineminus">-</span>
<a href="#l11.1595"></a><span id="l11.1595" class="difflineminus">-    // Reset the window's message uri and folder uri vars, and</span>
<a href="#l11.1596"></a><span id="l11.1596" class="difflineminus">-    // update the command handlers to what's going to be used.</span>
<a href="#l11.1597"></a><span id="l11.1597" class="difflineminus">-    // This has to be done before the call to CreateView().</span>
<a href="#l11.1598"></a><span id="l11.1598" class="difflineminus">-    windowID.gCurrentMessageUri = messageURI;</span>
<a href="#l11.1599"></a><span id="l11.1599" class="difflineminus">-    windowID.gCurrentFolderUri = msgHdr.folder.URI;</span>
<a href="#l11.1600"></a><span id="l11.1600" class="difflineminus">-    windowID.UpdateMailToolbar('MsgOpenExistingWindowForMessage');</span>
<a href="#l11.1601"></a><span id="l11.1601" class="difflineminus">-</span>
<a href="#l11.1602"></a><span id="l11.1602" class="difflineminus">-    // Even if the folder uri's match, we can't use the existing view</span>
<a href="#l11.1603"></a><span id="l11.1603" class="difflineminus">-    // (msgHdr.folder.URI == windowID.gCurrentFolderUri)</span>
<a href="#l11.1604"></a><span id="l11.1604" class="difflineminus">-    // - the reason is quick search and mail views. See bug #187673.</span>
<a href="#l11.1605"></a><span id="l11.1605" class="difflineminus">-    //</span>
<a href="#l11.1606"></a><span id="l11.1606" class="difflineminus">-    // For the sake of simplicity, let's always call CreateView(gDBView);</span>
<a href="#l11.1607"></a><span id="l11.1607" class="difflineminus">-    // which will clone gDBView.</span>
<a href="#l11.1608"></a><span id="l11.1608" class="difflineminus">-    windowID.CreateView(gDBView);</span>
<a href="#l11.1609"></a><span id="l11.1609" class="difflineminus">-    windowID.LoadMessageByMsgKey(msgHdr.messageKey);</span>
<a href="#l11.1610"></a><span id="l11.1610" class="difflineminus">-</span>
<a href="#l11.1611"></a><span id="l11.1611" class="difflineminus">-    // bring existing window to front</span>
<a href="#l11.1612"></a><span id="l11.1612" class="difflineminus">-    windowID.focus();</span>
<a href="#l11.1613"></a><span id="l11.1613" class="difflineminus">-    return true;</span>
<a href="#l11.1614"></a><span id="l11.1614" class="difflineminus">-  }</span>
<a href="#l11.1615"></a><span id="l11.1615" class="difflineminus">-  catch (ex) {</span>
<a href="#l11.1616"></a><span id="l11.1616" class="difflineminus">-    dump(&quot;reusing existing standalone message window failed: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l11.1617"></a><span id="l11.1617" class="difflineminus">-  }</span>
<a href="#l11.1618"></a><span id="l11.1618" class="difflineminus">-  return false;</span>
<a href="#l11.1619"></a><span id="l11.1619" class="difflineplus">+  var msgHdr = gFolderDisplay.selectedMessage;</span>
<a href="#l11.1620"></a><span id="l11.1620" class="difflineplus">+</span>
<a href="#l11.1621"></a><span id="l11.1621" class="difflineplus">+  // (future work: perhaps make the window have a method we can call to do this)</span>
<a href="#l11.1622"></a><span id="l11.1622" class="difflineplus">+  // make the window's folder clone our view</span>
<a href="#l11.1623"></a><span id="l11.1623" class="difflineplus">+  windowID.gFolderDisplay.cloneView(gFolderDisplay.view);</span>
<a href="#l11.1624"></a><span id="l11.1624" class="difflineplus">+  // boss the window into showing our message</span>
<a href="#l11.1625"></a><span id="l11.1625" class="difflineplus">+  windowID.gFolderDisplay.selectMessage(msgHdr);</span>
<a href="#l11.1626"></a><span id="l11.1626" class="difflineplus">+</span>
<a href="#l11.1627"></a><span id="l11.1627" class="difflineplus">+  // bring existing window to front</span>
<a href="#l11.1628"></a><span id="l11.1628" class="difflineplus">+  windowID.focus();</span>
<a href="#l11.1629"></a><span id="l11.1629" class="difflineplus">+  return true;</span>
<a href="#l11.1630"></a><span id="l11.1630"> }</span>
<a href="#l11.1631"></a><span id="l11.1631"> </span>
<a href="#l11.1632"></a><span id="l11.1632"> function MsgOpenFromFile()</span>
<a href="#l11.1633"></a><span id="l11.1633"> {</span>
<a href="#l11.1634"></a><span id="l11.1634">   const nsIFilePicker = Components.interfaces.nsIFilePicker;</span>
<a href="#l11.1635"></a><span id="l11.1635">   var fp = Components.classes[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l11.1636"></a><span id="l11.1636">                      .createInstance(nsIFilePicker);</span>
<a href="#l11.1637"></a><span id="l11.1637"> </span>
<a href="#l11.1638"></a><span id="l11.1638" class="difflineat">@@ -2086,62 +2051,53 @@ function MsgOpenFromFile()</span>
<a href="#l11.1639"></a><span id="l11.1639">     dump(&quot;filePicker.chooseInputFile threw an exception\n&quot;);</span>
<a href="#l11.1640"></a><span id="l11.1640">     return;</span>
<a href="#l11.1641"></a><span id="l11.1641">   }</span>
<a href="#l11.1642"></a><span id="l11.1642"> </span>
<a href="#l11.1643"></a><span id="l11.1643">   var uri = fp.fileURL.QueryInterface(Components.interfaces.nsIURL);</span>
<a href="#l11.1644"></a><span id="l11.1644">   uri.query = &quot;type=application/x-message-display&quot;;</span>
<a href="#l11.1645"></a><span id="l11.1645"> </span>
<a href="#l11.1646"></a><span id="l11.1646">   window.openDialog(&quot;chrome://messenger/content/messageWindow.xul&quot;, &quot;_blank&quot;,</span>
<a href="#l11.1647"></a><span id="l11.1647" class="difflineminus">-                    &quot;all,chrome,dialog=no,status,toolbar&quot;, uri, null, null);</span>
<a href="#l11.1648"></a><span id="l11.1648" class="difflineplus">+                    &quot;all,chrome,dialog=no,status,toolbar&quot;, uri);</span>
<a href="#l11.1649"></a><span id="l11.1649"> }</span>
<a href="#l11.1650"></a><span id="l11.1650"> </span>
<a href="#l11.1651"></a><span id="l11.1651" class="difflineminus">-function MsgOpenNewWindowForMessage(messageUri, folderUri)</span>
<a href="#l11.1652"></a><span id="l11.1652" class="difflineplus">+function MsgOpenNewWindowForMessage(aMsgHdr)</span>
<a href="#l11.1653"></a><span id="l11.1653"> {</span>
<a href="#l11.1654"></a><span id="l11.1654" class="difflineminus">-  if (!messageUri)</span>
<a href="#l11.1655"></a><span id="l11.1655" class="difflineminus">-    // Use GetFirstSelectedMessage() to find out which message to open</span>
<a href="#l11.1656"></a><span id="l11.1656" class="difflineminus">-    // instead of gDBView.getURIForViewIndex(currentIndex). This is</span>
<a href="#l11.1657"></a><span id="l11.1657" class="difflineminus">-    // required because on a right-click, the currentIndex value will be</span>
<a href="#l11.1658"></a><span id="l11.1658" class="difflineminus">-    // different from the actual row that is highlighted.</span>
<a href="#l11.1659"></a><span id="l11.1659" class="difflineminus">-    // GetFirstSelectedMessage() will return the message that is</span>
<a href="#l11.1660"></a><span id="l11.1660" class="difflineminus">-    // highlighted.</span>
<a href="#l11.1661"></a><span id="l11.1661" class="difflineminus">-    messageUri = GetFirstSelectedMessage();</span>
<a href="#l11.1662"></a><span id="l11.1662" class="difflineminus">-</span>
<a href="#l11.1663"></a><span id="l11.1663" class="difflineminus">-    if (!folderUri)</span>
<a href="#l11.1664"></a><span id="l11.1664" class="difflineminus">-      // Use GetSelectedMsgFolders() to find out which message to open</span>
<a href="#l11.1665"></a><span id="l11.1665" class="difflineminus">-      // instead of gDBView.getURIForViewIndex(currentIndex).  This is</span>
<a href="#l11.1666"></a><span id="l11.1666" class="difflineminus">-      // required because on a right-click, the currentIndex value will be</span>
<a href="#l11.1667"></a><span id="l11.1667" class="difflineminus">-      // different from the actual row that is highlighted.</span>
<a href="#l11.1668"></a><span id="l11.1668" class="difflineminus">-      // GetSelectedMsgFolders() will return the message that is</span>
<a href="#l11.1669"></a><span id="l11.1669" class="difflineminus">-      // highlighted.</span>
<a href="#l11.1670"></a><span id="l11.1670" class="difflineminus">-      folderUri = GetSelectedMsgFolders()[0].URI;</span>
<a href="#l11.1671"></a><span id="l11.1671" class="difflineminus">-</span>
<a href="#l11.1672"></a><span id="l11.1672" class="difflineminus">-  // be sure to pass in the current view....</span>
<a href="#l11.1673"></a><span id="l11.1673" class="difflineminus">-  if (messageUri &amp;&amp; folderUri) {</span>
<a href="#l11.1674"></a><span id="l11.1674" class="difflineplus">+  // no message header provided?  get the selected message (this will give us</span>
<a href="#l11.1675"></a><span id="l11.1675" class="difflineplus">+  //  the right-click selected message if that's what is going down.)</span>
<a href="#l11.1676"></a><span id="l11.1676" class="difflineplus">+  if (!aMsgHdr)</span>
<a href="#l11.1677"></a><span id="l11.1677" class="difflineplus">+    aMsgHdr = gFolderDisplay.selectedMessage;</span>
<a href="#l11.1678"></a><span id="l11.1678" class="difflineplus">+</span>
<a href="#l11.1679"></a><span id="l11.1679" class="difflineplus">+  // (there might not have been a selected message, so check...)</span>
<a href="#l11.1680"></a><span id="l11.1680" class="difflineplus">+  if (aMsgHdr)</span>
<a href="#l11.1681"></a><span id="l11.1681" class="difflineplus">+    // we also need to tell the window about our current view so that it can</span>
<a href="#l11.1682"></a><span id="l11.1682" class="difflineplus">+    //  clone it.  This enables advancing through the messages, etc.</span>
<a href="#l11.1683"></a><span id="l11.1683">     window.openDialog(&quot;chrome://messenger/content/messageWindow.xul&quot;, &quot;_blank&quot;,</span>
<a href="#l11.1684"></a><span id="l11.1684">                       &quot;all,chrome,dialog=no,status,toolbar&quot;,</span>
<a href="#l11.1685"></a><span id="l11.1685" class="difflineminus">-                      messageUri, folderUri, gDBView);</span>
<a href="#l11.1686"></a><span id="l11.1686" class="difflineminus">-  }</span>
<a href="#l11.1687"></a><span id="l11.1687" class="difflineplus">+                      aMsgHdr, gFolderDisplay.view);</span>
<a href="#l11.1688"></a><span id="l11.1688"> }</span>
<a href="#l11.1689"></a><span id="l11.1689"> </span>
<a href="#l11.1690"></a><span id="l11.1690"> function MsgJunk()</span>
<a href="#l11.1691"></a><span id="l11.1691"> {</span>
<a href="#l11.1692"></a><span id="l11.1692">   MsgJunkMailInfo(true);</span>
<a href="#l11.1693"></a><span id="l11.1693">   JunkSelectedMessages(!SelectedMessagesAreJunk());</span>
<a href="#l11.1694"></a><span id="l11.1694"> }</span>
<a href="#l11.1695"></a><span id="l11.1695"> </span>
<a href="#l11.1696"></a><span id="l11.1696"> </span>
<a href="#l11.1697"></a><span id="l11.1697"> function UpdateJunkButton()</span>
<a href="#l11.1698"></a><span id="l11.1698"> {</span>
<a href="#l11.1699"></a><span id="l11.1699" class="difflineminus">-  let hdr = msgHdrForCurrentMessage();</span>
<a href="#l11.1700"></a><span id="l11.1700" class="difflineminus">-  if (!hdr) // .eml file</span>
<a href="#l11.1701"></a><span id="l11.1701" class="difflineplus">+  // The junk message should slave off the selected message, as the preview pane</span>
<a href="#l11.1702"></a><span id="l11.1702" class="difflineplus">+  //  may not be visible</span>
<a href="#l11.1703"></a><span id="l11.1703" class="difflineplus">+  let hdr = gFolderDisplay.selectedMessage;</span>
<a href="#l11.1704"></a><span id="l11.1704" class="difflineplus">+  // But only the message display knows if we are dealing with a dummy.</span>
<a href="#l11.1705"></a><span id="l11.1705" class="difflineplus">+  if (gMessageDisplay.isDummy) // .eml file</span>
<a href="#l11.1706"></a><span id="l11.1706">     return;</span>
<a href="#l11.1707"></a><span id="l11.1707">   let junkScore = hdr.getStringProperty(&quot;junkscore&quot;);</span>
<a href="#l11.1708"></a><span id="l11.1708">   let hideJunk = (junkScore != &quot;&quot;) &amp;&amp; (junkScore != &quot;0&quot;);</span>
<a href="#l11.1709"></a><span id="l11.1709" class="difflineminus">-  if (isNewsURI(hdr.folder.URI))</span>
<a href="#l11.1710"></a><span id="l11.1710" class="difflineplus">+  if (gFolderDisplay.selectedMessageIsNews)</span>
<a href="#l11.1711"></a><span id="l11.1711">     hideJunk = true;</span>
<a href="#l11.1712"></a><span id="l11.1712">   // which DOM node is the current junk button in the</span>
<a href="#l11.1713"></a><span id="l11.1713">   // message reader depends on whether it's the collapsed or</span>
<a href="#l11.1714"></a><span id="l11.1714">   // expanded header</span>
<a href="#l11.1715"></a><span id="l11.1715">   let buttonBox = document.getElementById(gCollapsedHeaderViewMode ?</span>
<a href="#l11.1716"></a><span id="l11.1716">                      &quot;collapsedButtonBox&quot; : &quot;expandedButtonBox&quot;);</span>
<a href="#l11.1717"></a><span id="l11.1717">   buttonBox.getButton('hdrJunkButton').disabled = hideJunk;</span>
<a href="#l11.1718"></a><span id="l11.1718"> }</span>
<a href="#l11.1719"></a><span id="l11.1719" class="difflineat">@@ -2155,17 +2111,17 @@ function MsgMarkAsFlagged()</span>
<a href="#l11.1720"></a><span id="l11.1720"> {</span>
<a href="#l11.1721"></a><span id="l11.1721">   MarkSelectedMessagesFlagged(!SelectedMessagesAreFlagged());</span>
<a href="#l11.1722"></a><span id="l11.1722"> }</span>
<a href="#l11.1723"></a><span id="l11.1723"> </span>
<a href="#l11.1724"></a><span id="l11.1724"> function MsgMarkReadByDate()</span>
<a href="#l11.1725"></a><span id="l11.1725"> {</span>
<a href="#l11.1726"></a><span id="l11.1726">   window.openDialog(&quot;chrome://messenger/content/markByDate.xul&quot;,&quot;&quot;,</span>
<a href="#l11.1727"></a><span id="l11.1727">                     &quot;chrome,modal,titlebar,centerscreen&quot;,</span>
<a href="#l11.1728"></a><span id="l11.1728" class="difflineminus">-                    GetLoadedMsgFolder());</span>
<a href="#l11.1729"></a><span id="l11.1729" class="difflineplus">+                    gFolderDisplay.displayedFolder);</span>
<a href="#l11.1730"></a><span id="l11.1730"> }</span>
<a href="#l11.1731"></a><span id="l11.1731"> </span>
<a href="#l11.1732"></a><span id="l11.1732"> function MsgMarkAllRead()</span>
<a href="#l11.1733"></a><span id="l11.1733"> {</span>
<a href="#l11.1734"></a><span id="l11.1734">   var folder = GetSelectedMsgFolders()[0];</span>
<a href="#l11.1735"></a><span id="l11.1735"> </span>
<a href="#l11.1736"></a><span id="l11.1736">   if (folder)</span>
<a href="#l11.1737"></a><span id="l11.1737">     folder.markAllMessagesRead(msgWindow);</span>
<a href="#l11.1738"></a><span id="l11.1738" class="difflineat">@@ -2175,17 +2131,17 @@ function MsgFilters(emailAddress, folder</span>
<a href="#l11.1739"></a><span id="l11.1739"> {</span>
<a href="#l11.1740"></a><span id="l11.1740">   if (!folder)</span>
<a href="#l11.1741"></a><span id="l11.1741">   {</span>
<a href="#l11.1742"></a><span id="l11.1742">     // Try to determine the folder from the selected message.</span>
<a href="#l11.1743"></a><span id="l11.1743">     if (gDBView)</span>
<a href="#l11.1744"></a><span id="l11.1744">     {</span>
<a href="#l11.1745"></a><span id="l11.1745">       try</span>
<a href="#l11.1746"></a><span id="l11.1746">       {</span>
<a href="#l11.1747"></a><span id="l11.1747" class="difflineminus">-        var msgHdr = gDBView.hdrForFirstSelectedMessage;</span>
<a href="#l11.1748"></a><span id="l11.1748" class="difflineplus">+        var msgHdr = gFolderDisplay.selectedMessage;</span>
<a href="#l11.1749"></a><span id="l11.1749">         var accountKey = msgHdr.accountKey;</span>
<a href="#l11.1750"></a><span id="l11.1750">         if (accountKey.length &gt; 0)</span>
<a href="#l11.1751"></a><span id="l11.1751">         {</span>
<a href="#l11.1752"></a><span id="l11.1752">           var account = accountManager.getAccount(accountKey);</span>
<a href="#l11.1753"></a><span id="l11.1753">           if (account)</span>
<a href="#l11.1754"></a><span id="l11.1754">           {</span>
<a href="#l11.1755"></a><span id="l11.1755">             var server = account.incomingServer;</span>
<a href="#l11.1756"></a><span id="l11.1756">             if (server)</span>
<a href="#l11.1757"></a><span id="l11.1757" class="difflineat">@@ -2267,43 +2223,30 @@ function MsgApplyFilters()</span>
<a href="#l11.1758"></a><span id="l11.1758">       newFilterIndex++;</span>
<a href="#l11.1759"></a><span id="l11.1759">     }</span>
<a href="#l11.1760"></a><span id="l11.1760">   }</span>
<a href="#l11.1761"></a><span id="l11.1761">   filterService.applyFiltersToFolders(tempFilterList, selectedFolders, msgWindow);</span>
<a href="#l11.1762"></a><span id="l11.1762"> }</span>
<a href="#l11.1763"></a><span id="l11.1763"> </span>
<a href="#l11.1764"></a><span id="l11.1764"> function MsgApplyFiltersToSelection()</span>
<a href="#l11.1765"></a><span id="l11.1765"> {</span>
<a href="#l11.1766"></a><span id="l11.1766" class="difflineminus">-  var filterService = Components.classes[&quot;@mozilla.org/messenger/services/filters;1&quot;]</span>
<a href="#l11.1767"></a><span id="l11.1767" class="difflineminus">-                                .getService(Components.interfaces.nsIMsgFilterService);</span>
<a href="#l11.1768"></a><span id="l11.1768" class="difflineminus">-</span>
<a href="#l11.1769"></a><span id="l11.1769" class="difflineminus">-  var folder = gDBView.msgFolder;</span>
<a href="#l11.1770"></a><span id="l11.1770" class="difflineminus">-  var indices = GetSelectedIndices(gDBView);</span>
<a href="#l11.1771"></a><span id="l11.1771" class="difflineminus">-  if (indices &amp;&amp; indices.length)</span>
<a href="#l11.1772"></a><span id="l11.1772" class="difflineminus">-  {</span>
<a href="#l11.1773"></a><span id="l11.1773" class="difflineminus">-    var selectedMsgs = Components.classes[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l11.1774"></a><span id="l11.1774" class="difflineminus">-                                 .createInstance(Components.interfaces.nsIMutableArray);</span>
<a href="#l11.1775"></a><span id="l11.1775" class="difflineminus">-    for (var i = 0; i &lt; indices.length; i++)</span>
<a href="#l11.1776"></a><span id="l11.1776" class="difflineminus">-    {</span>
<a href="#l11.1777"></a><span id="l11.1777" class="difflineminus">-      try</span>
<a href="#l11.1778"></a><span id="l11.1778" class="difflineminus">-      {</span>
<a href="#l11.1779"></a><span id="l11.1779" class="difflineminus">-        // Getting the URI will tell us if the item is real or a dummy header</span>
<a href="#l11.1780"></a><span id="l11.1780" class="difflineminus">-        var uri = gDBView.getURIForViewIndex(indices[i]);</span>
<a href="#l11.1781"></a><span id="l11.1781" class="difflineminus">-        if (uri)</span>
<a href="#l11.1782"></a><span id="l11.1782" class="difflineminus">-        {</span>
<a href="#l11.1783"></a><span id="l11.1783" class="difflineminus">-          var msgHdr = folder.GetMessageHeader(gDBView.getKeyAt(indices[i]));</span>
<a href="#l11.1784"></a><span id="l11.1784" class="difflineminus">-          if (msgHdr)</span>
<a href="#l11.1785"></a><span id="l11.1785" class="difflineminus">-            selectedMsgs.appendElement(msgHdr, false);</span>
<a href="#l11.1786"></a><span id="l11.1786" class="difflineminus">-        }</span>
<a href="#l11.1787"></a><span id="l11.1787" class="difflineminus">-      } catch (ex) {}</span>
<a href="#l11.1788"></a><span id="l11.1788" class="difflineminus">-    }</span>
<a href="#l11.1789"></a><span id="l11.1789" class="difflineplus">+  // bail if we're dealing with a dummy header</span>
<a href="#l11.1790"></a><span id="l11.1790" class="difflineplus">+  if (gMessageDisplay.isDummy)</span>
<a href="#l11.1791"></a><span id="l11.1791" class="difflineplus">+    return;</span>
<a href="#l11.1792"></a><span id="l11.1792" class="difflineplus">+</span>
<a href="#l11.1793"></a><span id="l11.1793" class="difflineplus">+  var selectedMessages = gFolderDisplay.selectedMessages;</span>
<a href="#l11.1794"></a><span id="l11.1794" class="difflineplus">+  if (selectedMessages.length) {</span>
<a href="#l11.1795"></a><span id="l11.1795" class="difflineplus">+    var filterService =</span>
<a href="#l11.1796"></a><span id="l11.1796" class="difflineplus">+      Components.classes[&quot;@mozilla.org/messenger/services/filters;1&quot;]</span>
<a href="#l11.1797"></a><span id="l11.1797" class="difflineplus">+                .getService(Components.interfaces.nsIMsgFilterService);</span>
<a href="#l11.1798"></a><span id="l11.1798"> </span>
<a href="#l11.1799"></a><span id="l11.1799">     filterService.applyFilters(Components.interfaces.nsMsgFilterType.Manual,</span>
<a href="#l11.1800"></a><span id="l11.1800" class="difflineminus">-                               selectedMsgs,</span>
<a href="#l11.1801"></a><span id="l11.1801" class="difflineminus">-                               folder,</span>
<a href="#l11.1802"></a><span id="l11.1802" class="difflineplus">+                               toXPCOMArray(selectedMessages,</span>
<a href="#l11.1803"></a><span id="l11.1803" class="difflineplus">+                                            Components.interfaces.nsIMutableArray),</span>
<a href="#l11.1804"></a><span id="l11.1804" class="difflineplus">+                               gFolderDisplay.displayedFolder,</span>
<a href="#l11.1805"></a><span id="l11.1805">                                msgWindow);</span>
<a href="#l11.1806"></a><span id="l11.1806">   }</span>
<a href="#l11.1807"></a><span id="l11.1807"> }</span>
<a href="#l11.1808"></a><span id="l11.1808"> </span>
<a href="#l11.1809"></a><span id="l11.1809"> function ChangeMailLayout(newLayout)</span>
<a href="#l11.1810"></a><span id="l11.1810"> {</span>
<a href="#l11.1811"></a><span id="l11.1811">   gPrefBranch.setIntPref(&quot;mail.pane_config.dynamic&quot;, newLayout);</span>
<a href="#l11.1812"></a><span id="l11.1812"> }</span>
<a href="#l11.1813"></a><span id="l11.1813" class="difflineat">@@ -2381,18 +2324,18 @@ function ToggleInlineAttachment(target)</span>
<a href="#l11.1814"></a><span id="l11.1814">   var viewAttachmentInline = !pref.getBoolPref(&quot;mail.inline_attachments&quot;);</span>
<a href="#l11.1815"></a><span id="l11.1815">   pref.setBoolPref(&quot;mail.inline_attachments&quot;, viewAttachmentInline)</span>
<a href="#l11.1816"></a><span id="l11.1816">   target.setAttribute(&quot;checked&quot;, viewAttachmentInline ? &quot;true&quot; : &quot;false&quot;);</span>
<a href="#l11.1817"></a><span id="l11.1817">   ReloadMessage();</span>
<a href="#l11.1818"></a><span id="l11.1818"> }</span>
<a href="#l11.1819"></a><span id="l11.1819"> </span>
<a href="#l11.1820"></a><span id="l11.1820"> function PrintEnginePrintInternal(doPrintPreview, msgType)</span>
<a href="#l11.1821"></a><span id="l11.1821"> {</span>
<a href="#l11.1822"></a><span id="l11.1822" class="difflineminus">-  var messageList = GetSelectedMessages();</span>
<a href="#l11.1823"></a><span id="l11.1823" class="difflineminus">-  if (messageList.length == 0) {</span>
<a href="#l11.1824"></a><span id="l11.1824" class="difflineplus">+  var messageList = gFolderDisplay.selectedMessageUris;</span>
<a href="#l11.1825"></a><span id="l11.1825" class="difflineplus">+  if (!messageList) {</span>
<a href="#l11.1826"></a><span id="l11.1826">     dump(&quot;PrintEnginePrintInternal(): No messages selected.\n&quot;);</span>
<a href="#l11.1827"></a><span id="l11.1827">     return;</span>
<a href="#l11.1828"></a><span id="l11.1828">   }</span>
<a href="#l11.1829"></a><span id="l11.1829"> </span>
<a href="#l11.1830"></a><span id="l11.1830">   window.openDialog(&quot;chrome://messenger/content/msgPrintEngine.xul&quot;, &quot;&quot;,</span>
<a href="#l11.1831"></a><span id="l11.1831">                     &quot;chrome,dialog=no,all,centerscreen&quot;,</span>
<a href="#l11.1832"></a><span id="l11.1832">                     messageList.length, messageList, statusFeedback,</span>
<a href="#l11.1833"></a><span id="l11.1833">                     doPrintPreview, msgType, window);</span>
<a href="#l11.1834"></a><span id="l11.1834" class="difflineat">@@ -2670,17 +2613,17 @@ function CommandUpdate_UndoRedo()</span>
<a href="#l11.1835"></a><span id="l11.1835">   EnableMenuItem(&quot;menu_undo&quot;, SetupUndoRedoCommand(&quot;cmd_undo&quot;));</span>
<a href="#l11.1836"></a><span id="l11.1836">   EnableMenuItem(&quot;menu_redo&quot;, SetupUndoRedoCommand(&quot;cmd_redo&quot;));</span>
<a href="#l11.1837"></a><span id="l11.1837"> }</span>
<a href="#l11.1838"></a><span id="l11.1838"> </span>
<a href="#l11.1839"></a><span id="l11.1839"> function SetupUndoRedoCommand(command)</span>
<a href="#l11.1840"></a><span id="l11.1840"> {</span>
<a href="#l11.1841"></a><span id="l11.1841">   // If we have selected a server, and are viewing account central</span>
<a href="#l11.1842"></a><span id="l11.1842">   // there is no loaded folder.</span>
<a href="#l11.1843"></a><span id="l11.1843" class="difflineminus">-  var loadedFolder = GetLoadedMsgFolder();</span>
<a href="#l11.1844"></a><span id="l11.1844" class="difflineplus">+  var loadedFolder = gFolderDisplay.displayedFolder;</span>
<a href="#l11.1845"></a><span id="l11.1845">   if (!loadedFolder || !loadedFolder.server.canUndoDeleteOnServer)</span>
<a href="#l11.1846"></a><span id="l11.1846">     return false;</span>
<a href="#l11.1847"></a><span id="l11.1847"> </span>
<a href="#l11.1848"></a><span id="l11.1848">   var canUndoOrRedo;</span>
<a href="#l11.1849"></a><span id="l11.1849">   var txnType;</span>
<a href="#l11.1850"></a><span id="l11.1850">   if (command == &quot;cmd_undo&quot;)</span>
<a href="#l11.1851"></a><span id="l11.1851">   {</span>
<a href="#l11.1852"></a><span id="l11.1852">     canUndoOrRedo = messenger.canUndo();</span>
<a href="#l11.1853"></a><span id="l11.1853" class="difflineat">@@ -2689,41 +2632,57 @@ function SetupUndoRedoCommand(command)</span>
<a href="#l11.1854"></a><span id="l11.1854">   else</span>
<a href="#l11.1855"></a><span id="l11.1855">   {</span>
<a href="#l11.1856"></a><span id="l11.1856">     canUndoOrRedo = messenger.canRedo();</span>
<a href="#l11.1857"></a><span id="l11.1857">     txnType = messenger.getRedoTransactionType();</span>
<a href="#l11.1858"></a><span id="l11.1858">   }</span>
<a href="#l11.1859"></a><span id="l11.1859"> </span>
<a href="#l11.1860"></a><span id="l11.1860">   if (canUndoOrRedo)</span>
<a href="#l11.1861"></a><span id="l11.1861">   {</span>
<a href="#l11.1862"></a><span id="l11.1862" class="difflineminus">-    var commands = </span>
<a href="#l11.1863"></a><span id="l11.1863" class="difflineplus">+    var commands =</span>
<a href="#l11.1864"></a><span id="l11.1864">       ['valueDefault', 'valueDeleteMsg', 'valueMoveMsg', 'valueCopyMsg', 'valueUnmarkAllMsgs'];</span>
<a href="#l11.1865"></a><span id="l11.1865">     goSetMenuValue(command, commands[txnType]);</span>
<a href="#l11.1866"></a><span id="l11.1866">   }</span>
<a href="#l11.1867"></a><span id="l11.1867">   else</span>
<a href="#l11.1868"></a><span id="l11.1868">   {</span>
<a href="#l11.1869"></a><span id="l11.1869">     goSetMenuValue(command, 'valueDefault');</span>
<a href="#l11.1870"></a><span id="l11.1870">   }</span>
<a href="#l11.1871"></a><span id="l11.1871">   return canUndoOrRedo;</span>
<a href="#l11.1872"></a><span id="l11.1872"> }</span>
<a href="#l11.1873"></a><span id="l11.1873"> </span>
<a href="#l11.1874"></a><span id="l11.1874" class="difflineplus">+/**</span>
<a href="#l11.1875"></a><span id="l11.1875" class="difflineplus">+ * Triggered by the global JunkStatusChanged notification, we handle updating</span>
<a href="#l11.1876"></a><span id="l11.1876" class="difflineplus">+ *  the message display if our displayed message might have had its junk status</span>
<a href="#l11.1877"></a><span id="l11.1877" class="difflineplus">+ *  change.  This primarily entails updating the notification bar (that thing</span>
<a href="#l11.1878"></a><span id="l11.1878" class="difflineplus">+ *  that appears above the message and says &quot;this message might be junk&quot;) and</span>
<a href="#l11.1879"></a><span id="l11.1879" class="difflineplus">+ *  (potentially) reloading the message because junk status affects the form of</span>
<a href="#l11.1880"></a><span id="l11.1880" class="difflineplus">+ *  HTML display used (sanitized vs not).</span>
<a href="#l11.1881"></a><span id="l11.1881" class="difflineplus">+ * When our tab implementation is no longer multiplexed (reusing the same</span>
<a href="#l11.1882"></a><span id="l11.1882" class="difflineplus">+ *  display widget), this must be moved into the MessageDisplayWidget or</span>
<a href="#l11.1883"></a><span id="l11.1883" class="difflineplus">+ *  otherwise be scoped to the tab.</span>
<a href="#l11.1884"></a><span id="l11.1884" class="difflineplus">+ */</span>
<a href="#l11.1885"></a><span id="l11.1885"> function HandleJunkStatusChanged(folder)</span>
<a href="#l11.1886"></a><span id="l11.1886"> {</span>
<a href="#l11.1887"></a><span id="l11.1887" class="difflineplus">+  // We have nothing to do (and should bail) if:</span>
<a href="#l11.1888"></a><span id="l11.1888" class="difflineplus">+  // - There is no currently displayed message.</span>
<a href="#l11.1889"></a><span id="l11.1889" class="difflineplus">+  // - The displayed message is an .eml file from disk or an attachment.</span>
<a href="#l11.1890"></a><span id="l11.1890" class="difflineplus">+  // - The folder that has had a junk change is not backing the display folder.</span>
<a href="#l11.1891"></a><span id="l11.1891" class="difflineplus">+</span>
<a href="#l11.1892"></a><span id="l11.1892">   // This might be the stand alone window, open to a message that was</span>
<a href="#l11.1893"></a><span id="l11.1893">   // and attachment (or on disk), in which case, we want to ignore it.</span>
<a href="#l11.1894"></a><span id="l11.1894" class="difflineminus">-  var loadedMessage = GetLoadedMessage();</span>
<a href="#l11.1895"></a><span id="l11.1895" class="difflineminus">-  if (!loadedMessage || (/type=application\/x-message-display/.test(loadedMessage)) ||</span>
<a href="#l11.1896"></a><span id="l11.1896" class="difflineminus">-      !IsCurrentLoadedFolder(folder))</span>
<a href="#l11.1897"></a><span id="l11.1897" class="difflineplus">+  if (!gMessageDisplay.displayedMessage ||</span>
<a href="#l11.1898"></a><span id="l11.1898" class="difflineplus">+      gMessageDisplay.isDummy ||</span>
<a href="#l11.1899"></a><span id="l11.1899" class="difflineplus">+      gFolderDisplay.displayedFolder != folder)</span>
<a href="#l11.1900"></a><span id="l11.1900">     return;</span>
<a href="#l11.1901"></a><span id="l11.1901"> </span>
<a href="#l11.1902"></a><span id="l11.1902">   // If multiple message are selected and we change the junk status</span>
<a href="#l11.1903"></a><span id="l11.1903">   // we don't want to show the junk bar (since the message pane is blank).</span>
<a href="#l11.1904"></a><span id="l11.1904">   var msgHdr = null;</span>
<a href="#l11.1905"></a><span id="l11.1905">   if (GetNumSelectedMessages() == 1)</span>
<a href="#l11.1906"></a><span id="l11.1906" class="difflineminus">-    msgHdr = messenger.msgHdrFromURI(loadedMessage);</span>
<a href="#l11.1907"></a><span id="l11.1907" class="difflineplus">+    msgHdr = gMessageDisplay.displayedMessage;</span>
<a href="#l11.1908"></a><span id="l11.1908">   var junkBarWasDisplayed = gMessageNotificationBar.isFlagSet(kMsgNotificationJunkBar);</span>
<a href="#l11.1909"></a><span id="l11.1909">   gMessageNotificationBar.setJunkMsg(msgHdr);</span>
<a href="#l11.1910"></a><span id="l11.1910"> </span>
<a href="#l11.1911"></a><span id="l11.1911">   // Only reload message if junk bar display state has changed.</span>
<a href="#l11.1912"></a><span id="l11.1912">   if (msgHdr &amp;&amp; junkBarWasDisplayed != gMessageNotificationBar.isFlagSet(kMsgNotificationJunkBar))</span>
<a href="#l11.1913"></a><span id="l11.1913">   {</span>
<a href="#l11.1914"></a><span id="l11.1914">     // We may be forcing junk mail to be rendered with sanitized html.</span>
<a href="#l11.1915"></a><span id="l11.1915">     // In that scenario, we want to reload the message if the status has just</span>
<a href="#l11.1916"></a><span id="l11.1916" class="difflineat">@@ -2764,17 +2723,17 @@ var gMessageNotificationBar =</span>
<a href="#l11.1917"></a><span id="l11.1917">   mMsgNotificationBar: document.getElementById('msgNotificationBar'),</span>
<a href="#l11.1918"></a><span id="l11.1918"> </span>
<a href="#l11.1919"></a><span id="l11.1919">   setJunkMsg: function(aMsgHdr)</span>
<a href="#l11.1920"></a><span id="l11.1920">   {</span>
<a href="#l11.1921"></a><span id="l11.1921">     var isJunk = false;</span>
<a href="#l11.1922"></a><span id="l11.1922"> </span>
<a href="#l11.1923"></a><span id="l11.1923">     if (aMsgHdr)</span>
<a href="#l11.1924"></a><span id="l11.1924">     {</span>
<a href="#l11.1925"></a><span id="l11.1925" class="difflineminus">-      var junkScore = aMsgHdr.getStringProperty(&quot;junkscore&quot;); </span>
<a href="#l11.1926"></a><span id="l11.1926" class="difflineplus">+      var junkScore = aMsgHdr.getStringProperty(&quot;junkscore&quot;);</span>
<a href="#l11.1927"></a><span id="l11.1927">       isJunk = ((junkScore != &quot;&quot;) &amp;&amp; (junkScore != &quot;0&quot;));</span>
<a href="#l11.1928"></a><span id="l11.1928">     }</span>
<a href="#l11.1929"></a><span id="l11.1929"> </span>
<a href="#l11.1930"></a><span id="l11.1930">     this.updateMsgNotificationBar(kMsgNotificationJunkBar, isJunk);</span>
<a href="#l11.1931"></a><span id="l11.1931"> </span>
<a href="#l11.1932"></a><span id="l11.1932">     goUpdateCommand('button_junk');</span>
<a href="#l11.1933"></a><span id="l11.1933">   },</span>
<a href="#l11.1934"></a><span id="l11.1934"> </span>
<a href="#l11.1935"></a><span id="l11.1935" class="difflineat">@@ -2834,34 +2793,25 @@ function LoadMsgWithRemoteContent()</span>
<a href="#l11.1936"></a><span id="l11.1936">   // we want to get the msg hdr for the currently selected message</span>
<a href="#l11.1937"></a><span id="l11.1937">   // change the &quot;remoteContentBar&quot; property on it</span>
<a href="#l11.1938"></a><span id="l11.1938">   // then reload the message</span>
<a href="#l11.1939"></a><span id="l11.1939"> </span>
<a href="#l11.1940"></a><span id="l11.1940">   setMsgHdrPropertyAndReload(&quot;remoteContentPolicy&quot;, kAllowRemoteContent);</span>
<a href="#l11.1941"></a><span id="l11.1941"> }</span>
<a href="#l11.1942"></a><span id="l11.1942"> </span>
<a href="#l11.1943"></a><span id="l11.1943"> /**</span>
<a href="#l11.1944"></a><span id="l11.1944" class="difflineminus">- * Returns the msg hdr associated with the current loaded message.</span>
<a href="#l11.1945"></a><span id="l11.1945" class="difflineminus">- */</span>
<a href="#l11.1946"></a><span id="l11.1946" class="difflineminus">-function msgHdrForCurrentMessage()</span>
<a href="#l11.1947"></a><span id="l11.1947" class="difflineminus">-{</span>
<a href="#l11.1948"></a><span id="l11.1948" class="difflineminus">-  var msgURI = GetLoadedMessage();</span>
<a href="#l11.1949"></a><span id="l11.1949" class="difflineminus">-  return (msgURI &amp;&amp; !(/type=application\/x-message-display/.test(msgURI))) ? messenger.msgHdrFromURI(msgURI) : null;</span>
<a href="#l11.1950"></a><span id="l11.1950" class="difflineminus">-}</span>
<a href="#l11.1951"></a><span id="l11.1951" class="difflineminus">-</span>
<a href="#l11.1952"></a><span id="l11.1952" class="difflineminus">-/**</span>
<a href="#l11.1953"></a><span id="l11.1953">  *  Reloads the message after adjusting the remote content policy for the sender.</span>
<a href="#l11.1954"></a><span id="l11.1954" class="difflineminus">- *  Iterate through the local address books looking for a card with the same e-mail address as the </span>
<a href="#l11.1955"></a><span id="l11.1955" class="difflineplus">+ *  Iterate through the local address books looking for a card with the same e-mail address as the</span>
<a href="#l11.1956"></a><span id="l11.1956">  *  sender of the current loaded message. If we find a card, update the allow remote content field.</span>
<a href="#l11.1957"></a><span id="l11.1957">  *  If we can't find a card, prompt the user with a new AB card dialog, pre-selecting the remote content field.</span>
<a href="#l11.1958"></a><span id="l11.1958">  */</span>
<a href="#l11.1959"></a><span id="l11.1959"> function allowRemoteContentForSender()</span>
<a href="#l11.1960"></a><span id="l11.1960"> {</span>
<a href="#l11.1961"></a><span id="l11.1961">   // get the sender of the msg hdr</span>
<a href="#l11.1962"></a><span id="l11.1962" class="difflineminus">-  var msgHdr = msgHdrForCurrentMessage();</span>
<a href="#l11.1963"></a><span id="l11.1963" class="difflineplus">+  var msgHdr = gMessageDisplay.displayedMessage;</span>
<a href="#l11.1964"></a><span id="l11.1964">   if (!msgHdr)</span>
<a href="#l11.1965"></a><span id="l11.1965">     return;</span>
<a href="#l11.1966"></a><span id="l11.1966"> </span>
<a href="#l11.1967"></a><span id="l11.1967">   var headerParser = Components.classes[&quot;@mozilla.org/messenger/headerparser;1&quot;]</span>
<a href="#l11.1968"></a><span id="l11.1968">                                .getService(Components.interfaces.nsIMsgHeaderParser);</span>
<a href="#l11.1969"></a><span id="l11.1969">   var names = {};</span>
<a href="#l11.1970"></a><span id="l11.1970">   var addresses = {};</span>
<a href="#l11.1971"></a><span id="l11.1971">   var fullNames = {};</span>
<a href="#l11.1972"></a><span id="l11.1972" class="difflineat">@@ -2925,17 +2875,17 @@ function IgnorePhishingWarning()</span>
<a href="#l11.1973"></a><span id="l11.1973">   // This property is used to supress the phishing bar for the message.</span>
<a href="#l11.1974"></a><span id="l11.1974">   setMsgHdrPropertyAndReload(&quot;notAPhishMessage&quot;, 1);</span>
<a href="#l11.1975"></a><span id="l11.1975"> }</span>
<a href="#l11.1976"></a><span id="l11.1976"> </span>
<a href="#l11.1977"></a><span id="l11.1977"> function setMsgHdrPropertyAndReload(aProperty, aValue)</span>
<a href="#l11.1978"></a><span id="l11.1978"> {</span>
<a href="#l11.1979"></a><span id="l11.1979">   // we want to get the msg hdr for the currently selected message</span>
<a href="#l11.1980"></a><span id="l11.1980">   // change the appropiate property on it then reload the message</span>
<a href="#l11.1981"></a><span id="l11.1981" class="difflineminus">-  var msgHdr = msgHdrForCurrentMessage();</span>
<a href="#l11.1982"></a><span id="l11.1982" class="difflineplus">+  var msgHdr = gMessageDisplay.displayedMessage;</span>
<a href="#l11.1983"></a><span id="l11.1983">   if (msgHdr)</span>
<a href="#l11.1984"></a><span id="l11.1984">   {</span>
<a href="#l11.1985"></a><span id="l11.1985">     msgHdr.setUint32Property(aProperty, aValue);</span>
<a href="#l11.1986"></a><span id="l11.1986">     ReloadMessage();</span>
<a href="#l11.1987"></a><span id="l11.1987">   }</span>
<a href="#l11.1988"></a><span id="l11.1988"> }</span>
<a href="#l11.1989"></a><span id="l11.1989"> </span>
<a href="#l11.1990"></a><span id="l11.1990"> /**</span>
<a href="#l11.1991"></a><span id="l11.1991" class="difflineat">@@ -2955,40 +2905,40 @@ function ClearPendingReadTimer()</span>
<a href="#l11.1992"></a><span id="l11.1992"> {</span>
<a href="#l11.1993"></a><span id="l11.1993">   if (gMarkViewedMessageAsReadTimer)</span>
<a href="#l11.1994"></a><span id="l11.1994">   {</span>
<a href="#l11.1995"></a><span id="l11.1995">     clearTimeout(gMarkViewedMessageAsReadTimer);</span>
<a href="#l11.1996"></a><span id="l11.1996">     gMarkViewedMessageAsReadTimer = null;</span>
<a href="#l11.1997"></a><span id="l11.1997">   }</span>
<a href="#l11.1998"></a><span id="l11.1998"> }</span>
<a href="#l11.1999"></a><span id="l11.1999"> </span>
<a href="#l11.2000"></a><span id="l11.2000" class="difflineminus">-// this is called when layout is actually finished rendering a </span>
<a href="#l11.2001"></a><span id="l11.2001" class="difflineplus">+// this is called when layout is actually finished rendering a</span>
<a href="#l11.2002"></a><span id="l11.2002"> // mail message. OnMsgLoaded is called when libmime is done parsing the message</span>
<a href="#l11.2003"></a><span id="l11.2003"> function OnMsgParsed(aUrl)</span>
<a href="#l11.2004"></a><span id="l11.2004"> {</span>
<a href="#l11.2005"></a><span id="l11.2005">   // If rss feed (has 'content-base' header), show summary or load web</span>
<a href="#l11.2006"></a><span id="l11.2006">   // page per pref; earliest we have content DOM is here (onMsgParsed).</span>
<a href="#l11.2007"></a><span id="l11.2007">   FeedSetContentView();</span>
<a href="#l11.2008"></a><span id="l11.2008"> </span>
<a href="#l11.2009"></a><span id="l11.2009">   // browser doesn't do this, but I thought it could be a useful thing to test out...</span>
<a href="#l11.2010"></a><span id="l11.2010" class="difflineminus">-  // If the find bar is visible and we just loaded a new message, re-run </span>
<a href="#l11.2011"></a><span id="l11.2011" class="difflineplus">+  // If the find bar is visible and we just loaded a new message, re-run</span>
<a href="#l11.2012"></a><span id="l11.2012">   // the find command. This means the new message will get highlighted and</span>
<a href="#l11.2013"></a><span id="l11.2013">   // we'll scroll to the first word in the message that matches the find text.</span>
<a href="#l11.2014"></a><span id="l11.2014">   var findBar = document.getElementById(&quot;FindToolbar&quot;);</span>
<a href="#l11.2015"></a><span id="l11.2015">   if (!findBar.hidden)</span>
<a href="#l11.2016"></a><span id="l11.2016">     findBar.onFindAgainCommand(false);</span>
<a href="#l11.2017"></a><span id="l11.2017"> </span>
<a href="#l11.2018"></a><span id="l11.2018">   // Run the phishing detector on the message if it hasn't been marked as not</span>
<a href="#l11.2019"></a><span id="l11.2019">   // a scam already.</span>
<a href="#l11.2020"></a><span id="l11.2020" class="difflineminus">-  var msgHdr = msgHdrForCurrentMessage();</span>
<a href="#l11.2021"></a><span id="l11.2021" class="difflineplus">+  var msgHdr = gMessageDisplay.displayedMessage;</span>
<a href="#l11.2022"></a><span id="l11.2022">   if (msgHdr &amp;&amp; !msgHdr.getUint32Property(&quot;notAPhishMessage&quot;))</span>
<a href="#l11.2023"></a><span id="l11.2023">     gPhishingDetector.analyzeMsgForPhishingURLs(aUrl);</span>
<a href="#l11.2024"></a><span id="l11.2024"> </span>
<a href="#l11.2025"></a><span id="l11.2025">   // notify anyone (e.g., extensions) who's interested in when a message is loaded.</span>
<a href="#l11.2026"></a><span id="l11.2026" class="difflineminus">-  var msgURI = GetLoadedMessage();</span>
<a href="#l11.2027"></a><span id="l11.2027" class="difflineplus">+  var msgURI = gFolderDisplay.selectedMessageUris[0];</span>
<a href="#l11.2028"></a><span id="l11.2028">   var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l11.2029"></a><span id="l11.2029">                                   .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l11.2030"></a><span id="l11.2030">   observerService.notifyObservers(msgWindow.msgHeaderSink, &quot;MsgMsgDisplayed&quot;, msgURI);</span>
<a href="#l11.2031"></a><span id="l11.2031"> </span>
<a href="#l11.2032"></a><span id="l11.2032">   // scale any overflowing images</span>
<a href="#l11.2033"></a><span id="l11.2033">   var doc = document.getElementById(&quot;messagepane&quot;).contentDocument;</span>
<a href="#l11.2034"></a><span id="l11.2034">   var imgs = doc.getElementsByTagName(&quot;img&quot;);</span>
<a href="#l11.2035"></a><span id="l11.2035">   for each (var img in imgs)</span>
<a href="#l11.2036"></a><span id="l11.2036" class="difflineat">@@ -3010,33 +2960,25 @@ function OnMsgLoaded(aUrl)</span>
<a href="#l11.2037"></a><span id="l11.2037"> </span>
<a href="#l11.2038"></a><span id="l11.2038">   // nsIMsgMailNewsUrl.folder throws an error when opening .eml files.</span>
<a href="#l11.2039"></a><span id="l11.2039">   var folder;</span>
<a href="#l11.2040"></a><span id="l11.2040">   try {</span>
<a href="#l11.2041"></a><span id="l11.2041">     folder = aUrl.folder;</span>
<a href="#l11.2042"></a><span id="l11.2042">   }</span>
<a href="#l11.2043"></a><span id="l11.2043">   catch (ex) {}</span>
<a href="#l11.2044"></a><span id="l11.2044"> </span>
<a href="#l11.2045"></a><span id="l11.2045" class="difflineminus">-  var msgURI = GetLoadedMessage();</span>
<a href="#l11.2046"></a><span id="l11.2046" class="difflineminus">-</span>
<a href="#l11.2047"></a><span id="l11.2047" class="difflineminus">-  if (!folder || !msgURI)</span>
<a href="#l11.2048"></a><span id="l11.2048" class="difflineplus">+  var msgHdr = gMessageDisplay.displayedMessage;</span>
<a href="#l11.2049"></a><span id="l11.2049" class="difflineplus">+  gMessageDisplay.messageLoading = false;</span>
<a href="#l11.2050"></a><span id="l11.2050" class="difflineplus">+  gMessageDisplay.messageLoaded = true;</span>
<a href="#l11.2051"></a><span id="l11.2051" class="difflineplus">+</span>
<a href="#l11.2052"></a><span id="l11.2052" class="difflineplus">+  if (!folder || !msgHdr)</span>
<a href="#l11.2053"></a><span id="l11.2053">     return;</span>
<a href="#l11.2054"></a><span id="l11.2054"> </span>
<a href="#l11.2055"></a><span id="l11.2055" class="difflineminus">-  // If we are in the middle of a delete or move operation, make sure that</span>
<a href="#l11.2056"></a><span id="l11.2056" class="difflineminus">-  // if the user clicks on another message then that message stays selected</span>
<a href="#l11.2057"></a><span id="l11.2057" class="difflineminus">-  // and the selection does not &quot;snap back&quot; to the message chosen by</span>
<a href="#l11.2058"></a><span id="l11.2058" class="difflineminus">-  // SetNextMessageAfterDelete() when the operation completes (bug 243532).</span>
<a href="#l11.2059"></a><span id="l11.2059" class="difflineminus">-  // But the just loaded message might be getting deleted, if the user</span>
<a href="#l11.2060"></a><span id="l11.2060" class="difflineminus">-  // deletes it before the message is loaded (bug 183394).</span>
<a href="#l11.2061"></a><span id="l11.2061">   var wintype = document.documentElement.getAttribute('windowtype');</span>
<a href="#l11.2062"></a><span id="l11.2062" class="difflineminus">-  if (wintype == &quot;mail:messageWindow&quot; ||</span>
<a href="#l11.2063"></a><span id="l11.2063" class="difflineminus">-      GetThreadTree().view.selection.currentIndex != gSelectedIndexWhenDeleting)</span>
<a href="#l11.2064"></a><span id="l11.2064" class="difflineminus">-    gNextMessageViewIndexAfterDelete = -2;</span>
<a href="#l11.2065"></a><span id="l11.2065" class="difflineminus">-</span>
<a href="#l11.2066"></a><span id="l11.2066" class="difflineminus">-  var msgHdr = msgHdrForCurrentMessage();</span>
<a href="#l11.2067"></a><span id="l11.2067" class="difflineplus">+</span>
<a href="#l11.2068"></a><span id="l11.2068">   gMessageNotificationBar.setJunkMsg(msgHdr);</span>
<a href="#l11.2069"></a><span id="l11.2069"> </span>
<a href="#l11.2070"></a><span id="l11.2070">   goUpdateCommand('button_delete');</span>
<a href="#l11.2071"></a><span id="l11.2071"> </span>
<a href="#l11.2072"></a><span id="l11.2072">   var markReadAutoMode = gPrefBranch.getBoolPref(&quot;mailnews.mark_message_read.auto&quot;);</span>
<a href="#l11.2073"></a><span id="l11.2073"> </span>
<a href="#l11.2074"></a><span id="l11.2074">   // We just finished loading a message. If messages are to be marked as read</span>
<a href="#l11.2075"></a><span id="l11.2075">   // automatically, set a timer to mark the message is read after n seconds</span>
<a href="#l11.2076"></a><span id="l11.2076" class="difflineat">@@ -3062,17 +3004,17 @@ function OnMsgLoaded(aUrl)</span>
<a href="#l11.2077"></a><span id="l11.2077">     {</span>
<a href="#l11.2078"></a><span id="l11.2078">       MarkMessageAsRead(msgHdr);</span>
<a href="#l11.2079"></a><span id="l11.2079">     }</span>
<a href="#l11.2080"></a><span id="l11.2080">   }</span>
<a href="#l11.2081"></a><span id="l11.2081"> </span>
<a href="#l11.2082"></a><span id="l11.2082">   // See if MDN was requested but has not been sent.</span>
<a href="#l11.2083"></a><span id="l11.2083">   HandleMDNResponse(aUrl);</span>
<a href="#l11.2084"></a><span id="l11.2084"> </span>
<a href="#l11.2085"></a><span id="l11.2085" class="difflineminus">-  if (!IsImapMessage(msgURI))</span>
<a href="#l11.2086"></a><span id="l11.2086" class="difflineplus">+  if (!gFolderDisplay.selectedMessageIsImap)</span>
<a href="#l11.2087"></a><span id="l11.2087">     return;</span>
<a href="#l11.2088"></a><span id="l11.2088"> </span>
<a href="#l11.2089"></a><span id="l11.2089">   var imapServer = folder.server.QueryInterface(Components.interfaces.nsIImapIncomingServer);</span>
<a href="#l11.2090"></a><span id="l11.2090">   if (imapServer.storeReadMailInPFC)</span>
<a href="#l11.2091"></a><span id="l11.2091">   {</span>
<a href="#l11.2092"></a><span id="l11.2092">     // Look in read mail PFC for msg with same msg id - if we find one,</span>
<a href="#l11.2093"></a><span id="l11.2093">     // don't put this message in the read mail pfc.</span>
<a href="#l11.2094"></a><span id="l11.2094">     var outputPFC = imapServer.GetReadMailPFC(true);</span>
<a href="#l11.2095"></a><span id="l11.2095" class="difflineat">@@ -3100,26 +3042,25 @@ function OnMsgLoaded(aUrl)</span>
<a href="#l11.2096"></a><span id="l11.2096">  * no need to check it either.</span>
<a href="#l11.2097"></a><span id="l11.2097">  */</span>
<a href="#l11.2098"></a><span id="l11.2098"> function HandleMDNResponse(aUrl)</span>
<a href="#l11.2099"></a><span id="l11.2099"> {</span>
<a href="#l11.2100"></a><span id="l11.2100">   if (!aUrl)</span>
<a href="#l11.2101"></a><span id="l11.2101">     return;</span>
<a href="#l11.2102"></a><span id="l11.2102"> </span>
<a href="#l11.2103"></a><span id="l11.2103">   var msgFolder = aUrl.folder;</span>
<a href="#l11.2104"></a><span id="l11.2104" class="difflineminus">-  var msgURI = GetLoadedMessage();</span>
<a href="#l11.2105"></a><span id="l11.2105" class="difflineminus">-  if (!msgFolder || !msgURI || IsNewsMessage(msgURI))</span>
<a href="#l11.2106"></a><span id="l11.2106" class="difflineplus">+  var msgHdr = gFolderDisplay.selectedMessage;</span>
<a href="#l11.2107"></a><span id="l11.2107" class="difflineplus">+  if (!msgFolder || !msgHdr || gFolderDisplay.selectedMessageIsNews)</span>
<a href="#l11.2108"></a><span id="l11.2108">     return;</span>
<a href="#l11.2109"></a><span id="l11.2109"> </span>
<a href="#l11.2110"></a><span id="l11.2110">   // if the message is marked as junk, do NOT attempt to process a return receipt</span>
<a href="#l11.2111"></a><span id="l11.2111">   // in order to better protect the user</span>
<a href="#l11.2112"></a><span id="l11.2112">   if (SelectedMessagesAreJunk())</span>
<a href="#l11.2113"></a><span id="l11.2113">     return;</span>
<a href="#l11.2114"></a><span id="l11.2114"> </span>
<a href="#l11.2115"></a><span id="l11.2115" class="difflineminus">-  var msgHdr = messenger.msgHdrFromURI(msgURI);</span>
<a href="#l11.2116"></a><span id="l11.2116">   var mimeHdr;</span>
<a href="#l11.2117"></a><span id="l11.2117"> </span>
<a href="#l11.2118"></a><span id="l11.2118">   try {</span>
<a href="#l11.2119"></a><span id="l11.2119">     mimeHdr = aUrl.mimeHeaders;</span>
<a href="#l11.2120"></a><span id="l11.2120">   } catch (ex) {</span>
<a href="#l11.2121"></a><span id="l11.2121">     return;</span>
<a href="#l11.2122"></a><span id="l11.2122">   }</span>
<a href="#l11.2123"></a><span id="l11.2123"> </span>
<a href="#l11.2124"></a><span id="l11.2124" class="difflineat">@@ -3159,30 +3100,26 @@ function HandleMDNResponse(aUrl)</span>
<a href="#l11.2125"></a><span id="l11.2125">   msgHdr.OrFlags(Components.interfaces.nsMsgMessageFlags.MDNReportSent);</span>
<a href="#l11.2126"></a><span id="l11.2126"> </span>
<a href="#l11.2127"></a><span id="l11.2127">   // Commit db changes.</span>
<a href="#l11.2128"></a><span id="l11.2128">   var msgdb = msgFolder.msgDatabase;</span>
<a href="#l11.2129"></a><span id="l11.2129">   if (msgdb)</span>
<a href="#l11.2130"></a><span id="l11.2130">     msgdb.Commit(ADDR_DB_LARGE_COMMIT);</span>
<a href="#l11.2131"></a><span id="l11.2131"> }</span>
<a href="#l11.2132"></a><span id="l11.2132"> </span>
<a href="#l11.2133"></a><span id="l11.2133" class="difflineminus">-function QuickSearchFocus() </span>
<a href="#l11.2134"></a><span id="l11.2134" class="difflineplus">+function QuickSearchFocus()</span>
<a href="#l11.2135"></a><span id="l11.2135"> {</span>
<a href="#l11.2136"></a><span id="l11.2136">   var quickSearchTextBox = document.getElementById('searchInput');</span>
<a href="#l11.2137"></a><span id="l11.2137">   if (quickSearchTextBox)</span>
<a href="#l11.2138"></a><span id="l11.2138">     quickSearchTextBox.focus();</span>
<a href="#l11.2139"></a><span id="l11.2139"> }</span>
<a href="#l11.2140"></a><span id="l11.2140"> </span>
<a href="#l11.2141"></a><span id="l11.2141"> function MsgSearchMessages()</span>
<a href="#l11.2142"></a><span id="l11.2142"> {</span>
<a href="#l11.2143"></a><span id="l11.2143" class="difflineminus">-  var preselectedFolder = null;</span>
<a href="#l11.2144"></a><span id="l11.2144" class="difflineminus">-  if (&quot;GetFirstSelectedMsgFolder&quot; in window)</span>
<a href="#l11.2145"></a><span id="l11.2145" class="difflineminus">-    preselectedFolder = GetFirstSelectedMsgFolder();</span>
<a href="#l11.2146"></a><span id="l11.2146" class="difflineminus">-</span>
<a href="#l11.2147"></a><span id="l11.2147" class="difflineminus">-  var args = { folder: preselectedFolder };</span>
<a href="#l11.2148"></a><span id="l11.2148" class="difflineplus">+  var args = { folder: gFolderDisplay.displayedFolder };</span>
<a href="#l11.2149"></a><span id="l11.2149">   OpenOrFocusWindow(args, &quot;mailnews:search&quot;, &quot;chrome://messenger/content/SearchDialog.xul&quot;);</span>
<a href="#l11.2150"></a><span id="l11.2150"> }</span>
<a href="#l11.2151"></a><span id="l11.2151"> </span>
<a href="#l11.2152"></a><span id="l11.2152"> function MsgJunkMailInfo(aCheckFirstUse)</span>
<a href="#l11.2153"></a><span id="l11.2153"> {</span>
<a href="#l11.2154"></a><span id="l11.2154">   if (aCheckFirstUse) {</span>
<a href="#l11.2155"></a><span id="l11.2155">     if (!pref.getBoolPref(&quot;mailnews.ui.junk.firstuse&quot;))</span>
<a href="#l11.2156"></a><span id="l11.2156">       return;</span>
<a href="#l11.2157"></a><span id="l11.2157" class="difflineat">@@ -3206,17 +3143,17 @@ function MsgJunkMailInfo(aCheckFirstUse)</span>
<a href="#l11.2158"></a><span id="l11.2158">                       &quot;centerscreen,resizeable=no,titlebar,chrome,modal&quot;, null);</span>
<a href="#l11.2159"></a><span id="l11.2159"> }</span>
<a href="#l11.2160"></a><span id="l11.2160"> </span>
<a href="#l11.2161"></a><span id="l11.2161"> function MsgSearchAddresses()</span>
<a href="#l11.2162"></a><span id="l11.2162"> {</span>
<a href="#l11.2163"></a><span id="l11.2163">   var args = { directory: null };</span>
<a href="#l11.2164"></a><span id="l11.2164">   OpenOrFocusWindow(args, &quot;mailnews:absearch&quot;, &quot;chrome://messenger/content/ABSearchDialog.xul&quot;);</span>
<a href="#l11.2165"></a><span id="l11.2165"> }</span>
<a href="#l11.2166"></a><span id="l11.2166" class="difflineminus">- </span>
<a href="#l11.2167"></a><span id="l11.2167" class="difflineplus">+</span>
<a href="#l11.2168"></a><span id="l11.2168"> function MsgFilterList(args)</span>
<a href="#l11.2169"></a><span id="l11.2169"> {</span>
<a href="#l11.2170"></a><span id="l11.2170">   OpenOrFocusWindow(args, &quot;mailnews:filterlist&quot;, &quot;chrome://messenger/content/FilterListDialog.xul&quot;);</span>
<a href="#l11.2171"></a><span id="l11.2171"> }</span>
<a href="#l11.2172"></a><span id="l11.2172"> </span>
<a href="#l11.2173"></a><span id="l11.2173"> function GetWindowByWindowType(windowType)</span>
<a href="#l11.2174"></a><span id="l11.2174"> {</span>
<a href="#l11.2175"></a><span id="l11.2175">   var windowManager = Components.classes['@mozilla.org/appshell/window-mediator;1']</span>
<a href="#l11.2176"></a><span id="l11.2176" class="difflineat">@@ -3244,17 +3181,17 @@ function FeedSetContentViewToggle()</span>
<a href="#l11.2177"></a><span id="l11.2177">   gShowFeedSummaryToggle = true;</span>
<a href="#l11.2178"></a><span id="l11.2178">   FeedSetContentView(gShowFeedSummary ? 0 : 1);</span>
<a href="#l11.2179"></a><span id="l11.2179"> }</span>
<a href="#l11.2180"></a><span id="l11.2180"> </span>
<a href="#l11.2181"></a><span id="l11.2181"> // Check message format</span>
<a href="#l11.2182"></a><span id="l11.2182"> function FeedCheckContentFormat()</span>
<a href="#l11.2183"></a><span id="l11.2183"> {</span>
<a href="#l11.2184"></a><span id="l11.2184">   // Not an rss message</span>
<a href="#l11.2185"></a><span id="l11.2185" class="difflineminus">-  if (!IsFeedItem())</span>
<a href="#l11.2186"></a><span id="l11.2186" class="difflineplus">+  if (!gFolderDisplay.selectedMessageIsFeed)</span>
<a href="#l11.2187"></a><span id="l11.2187">     return false;</span>
<a href="#l11.2188"></a><span id="l11.2188"> </span>
<a href="#l11.2189"></a><span id="l11.2189">   var contentWindowDoc = window.top.content.document;</span>
<a href="#l11.2190"></a><span id="l11.2190"> </span>
<a href="#l11.2191"></a><span id="l11.2191">   // Thunderbird 2 rss messages with 'Show article summary' not selected,</span>
<a href="#l11.2192"></a><span id="l11.2192">   // ie message body constructed to show web page in an iframe, can't show</span>
<a href="#l11.2193"></a><span id="l11.2193">   // a summary - notify user.</span>
<a href="#l11.2194"></a><span id="l11.2194">   var rssIframe = contentWindowDoc.getElementById('_mailrssiframe');</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/base/content/mailWindowOverlay.xul</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/base/content/mailWindowOverlay.xul</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -57,16 +57,18 @@</span>
<a href="#l12.4"></a><span id="l12.4">   %brandDTD;</span>
<a href="#l12.5"></a><span id="l12.5"> ]&gt;</span>
<a href="#l12.6"></a><span id="l12.6"> </span>
<a href="#l12.7"></a><span id="l12.7"> &lt;overlay xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l12.8"></a><span id="l12.8"> </span>
<a href="#l12.9"></a><span id="l12.9"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/mailCommands.js&quot;/&gt;</span>
<a href="#l12.10"></a><span id="l12.10"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/junkCommands.js&quot;/&gt;</span>
<a href="#l12.11"></a><span id="l12.11"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/mailWindowOverlay.js&quot;/&gt;</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+&lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/messageDisplay.js&quot;/&gt;</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+&lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/folderDisplay.js&quot;/&gt;</span>
<a href="#l12.14"></a><span id="l12.14"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger-newsblog/content/newsblogOverlay.js&quot;/&gt;</span>
<a href="#l12.15"></a><span id="l12.15"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/mail-offline.js&quot;/&gt;</span>
<a href="#l12.16"></a><span id="l12.16"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://global/content/printUtils.js&quot;/&gt;</span>
<a href="#l12.17"></a><span id="l12.17"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/msgViewPickerOverlay.js&quot;/&gt;</span>
<a href="#l12.18"></a><span id="l12.18"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://global/content/viewZoomOverlay.js&quot;/&gt;</span>
<a href="#l12.19"></a><span id="l12.19"> </span>
<a href="#l12.20"></a><span id="l12.20"> &lt;stringbundleset id=&quot;stringbundleset&quot;&gt;</span>
<a href="#l12.21"></a><span id="l12.21">   &lt;stringbundle id=&quot;bundle_messenger&quot; src=&quot;chrome://messenger/locale/messenger.properties&quot;/&gt;</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineat">@@ -722,17 +724,17 @@</span>
<a href="#l12.23"></a><span id="l12.23">               oncommand=&quot;MsgGetMessage();&quot;/&gt;</span>
<a href="#l12.24"></a><span id="l12.24">     &lt;menuitem id=&quot;folderPaneContext-openNewWindow&quot;</span>
<a href="#l12.25"></a><span id="l12.25">               label=&quot;&amp;folderContextOpenNewWindow.label;&quot;</span>
<a href="#l12.26"></a><span id="l12.26">               accesskey=&quot;&amp;folderContextOpenNewWindow.accesskey;&quot;</span>
<a href="#l12.27"></a><span id="l12.27">               oncommand=&quot;MsgOpenNewWindowForFolder(null,-1);&quot;/&gt;</span>
<a href="#l12.28"></a><span id="l12.28">     &lt;menuitem id=&quot;folderPaneContext-openNewTab&quot;</span>
<a href="#l12.29"></a><span id="l12.29">               label=&quot;&amp;folderContextOpenNewTab.label;&quot;</span>
<a href="#l12.30"></a><span id="l12.30">               accesskey=&quot;&amp;folderContextOpenNewTab.accesskey;&quot;</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">-              oncommand=&quot;MsgOpenNewTabForFolder(null,-1);&quot;/&gt;</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+              oncommand=&quot;MsgOpenNewTabForFolder();&quot;/&gt;</span>
<a href="#l12.33"></a><span id="l12.33">     &lt;menuitem id=&quot;folderPaneContext-searchMessages&quot;</span>
<a href="#l12.34"></a><span id="l12.34">               label=&quot;&amp;folderContextSearchMessages.label;&quot;</span>
<a href="#l12.35"></a><span id="l12.35">               accesskey=&quot;&amp;folderContextSearchMessages.accesskey;&quot;</span>
<a href="#l12.36"></a><span id="l12.36">               command=&quot;cmd_search&quot;/&gt;</span>
<a href="#l12.37"></a><span id="l12.37">     &lt;menuitem id=&quot;folderPaneContext-subscribe&quot;</span>
<a href="#l12.38"></a><span id="l12.38">               label=&quot;&amp;folderContextSubscribe.label;&quot;</span>
<a href="#l12.39"></a><span id="l12.39">               accesskey=&quot;&amp;folderContextSubscribe.accesskey;&quot;</span>
<a href="#l12.40"></a><span id="l12.40">               oncommand=&quot;MsgSubscribe();&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">new file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- /dev/null</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ b/mail/base/content/messageDisplay.js</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -0,0 +1,460 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineplus">+ *</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+ *</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+ * License.</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+ *</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineplus">+ *</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+ *</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineplus">+ *   David Bienvenu &lt;bienvenu@nventure.com&gt;</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+ *   Siddharth Agarwal &lt;sid.bugzilla@gmail.com&gt;</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineplus">+ *</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineplus">+ *</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+/**</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineplus">+ * Base abstraction for message display along the line of FolderDisplayWidget,</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+ *  but for message display.  This really only exists to keep</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+ *  FolderDisplayWidget manageable and free from taking on responsibility for</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+ *  the (different) horrors of message display.  The reality of the situation</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+ *  is that FolderDisplayWidget still has a lot to do with message display,</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+ *  and so we are just where helper logic gets to live, but the FDW still</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+ *  may deal with some things internally.</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+ * You should not use this class directly, but rather its friendly subclasses</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+ *  that live later in this file.</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+ */</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+function MessageDisplayWidget() {</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineplus">+}</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineplus">+MessageDisplayWidget.prototype = {</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineplus">+  _active: false,</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineplus">+  get active MessageDisplayWidget_get_active() {</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+    return this._active;</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineplus">+  },</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineplus">+</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineplus">+  /**</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineplus">+   * Track whether the single message display pane is desired to be displayed</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineplus">+   *  (it is actually displayed when active, does't matter when not), or</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineplus">+   *  otherwise the multiple message display pane is desired to be displayed.</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineplus">+   */</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineplus">+  _singleMessageDisplay: null,</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineplus">+  get singleMessageDisplay MessageDisplayWidget_get_singleMessageDisplay() {</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineplus">+    // when null, assume single message display</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineplus">+    return this._singleMessageDisplay != false;</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineplus">+  },</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineplus">+  set singleMessageDisplay MessageDisplayWidget_set_singleMessageDisplay(</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineplus">+      aSingleDisplay) {</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineplus">+    if (this._singleMessageDisplay != aSingleDisplay) {</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineplus">+      this._singleMessageDisplay = aSingleDisplay;</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineplus">+      if (this._active)</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineplus">+        this._updateActiveMessagePane();</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineplus">+    }</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineplus">+  },</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineplus">+</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineplus">+  /**</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineplus">+   * Set pane visibility based on this.singleMessageDisplay.</span>
<a href="#l13.84"></a><span id="l13.84" class="difflineplus">+   */</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineplus">+  _updateActiveMessagePane: function MessageDisplayWidget_updateMessagePane() {</span>
<a href="#l13.86"></a><span id="l13.86" class="difflineplus">+    // _singleMessageDisplay can be null, so use the property (getter)</span>
<a href="#l13.87"></a><span id="l13.87" class="difflineplus">+    document.getElementById(&quot;singlemessage&quot;).hidden =</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineplus">+      !this.singleMessageDisplay;</span>
<a href="#l13.89"></a><span id="l13.89" class="difflineplus">+    document.getElementById(&quot;multimessage&quot;).hidden =</span>
<a href="#l13.90"></a><span id="l13.90" class="difflineplus">+      this.singleMessageDisplay;</span>
<a href="#l13.91"></a><span id="l13.91" class="difflineplus">+  },</span>
<a href="#l13.92"></a><span id="l13.92" class="difflineplus">+</span>
<a href="#l13.93"></a><span id="l13.93" class="difflineplus">+  /**</span>
<a href="#l13.94"></a><span id="l13.94" class="difflineplus">+   * Cleanup the MessageDisplayWidget in preparation for going away.  Called by</span>
<a href="#l13.95"></a><span id="l13.95" class="difflineplus">+   *  FolderDisplayWidget's close method.</span>
<a href="#l13.96"></a><span id="l13.96" class="difflineplus">+   */</span>
<a href="#l13.97"></a><span id="l13.97" class="difflineplus">+  _close: function MessageDisplayWidget_close() {</span>
<a href="#l13.98"></a><span id="l13.98" class="difflineplus">+    // mark ourselves inactive without doing any work.</span>
<a href="#l13.99"></a><span id="l13.99" class="difflineplus">+    this._active = false;</span>
<a href="#l13.100"></a><span id="l13.100" class="difflineplus">+  },</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineplus">+</span>
<a href="#l13.102"></a><span id="l13.102" class="difflineplus">+  /**</span>
<a href="#l13.103"></a><span id="l13.103" class="difflineplus">+   * The FolderDisplayWidget that owns us.</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineplus">+   */</span>
<a href="#l13.105"></a><span id="l13.105" class="difflineplus">+  folderDisplay: null,</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineplus">+  /**</span>
<a href="#l13.107"></a><span id="l13.107" class="difflineplus">+   * The currently displayed message's nsIMsgDBHdr.  null if there's no message.</span>
<a href="#l13.108"></a><span id="l13.108" class="difflineplus">+   */</span>
<a href="#l13.109"></a><span id="l13.109" class="difflineplus">+  displayedMessage: null,</span>
<a href="#l13.110"></a><span id="l13.110" class="difflineplus">+</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineplus">+  clearDisplay: function MessageDisplayWidget_clearDisplay() {</span>
<a href="#l13.112"></a><span id="l13.112" class="difflineplus">+    this.displayedMessage = null;</span>
<a href="#l13.113"></a><span id="l13.113" class="difflineplus">+    this.messageLoading = false;</span>
<a href="#l13.114"></a><span id="l13.114" class="difflineplus">+    this.messageLoaded = false;</span>
<a href="#l13.115"></a><span id="l13.115" class="difflineplus">+    ClearPendingReadTimer();</span>
<a href="#l13.116"></a><span id="l13.116" class="difflineplus">+    ClearMessagePane();</span>
<a href="#l13.117"></a><span id="l13.117" class="difflineplus">+  },</span>
<a href="#l13.118"></a><span id="l13.118" class="difflineplus">+</span>
<a href="#l13.119"></a><span id="l13.119" class="difflineplus">+  onCreatedView: function MessageDisplayWidget_onCreatedView() {</span>
<a href="#l13.120"></a><span id="l13.120" class="difflineplus">+    // we need to compel setting this because nsMsgSearchDBView defaults it on</span>
<a href="#l13.121"></a><span id="l13.121" class="difflineplus">+    this.folderDisplay.view.dbView.suppressMsgDisplay = !this.visible;</span>
<a href="#l13.122"></a><span id="l13.122" class="difflineplus">+  },</span>
<a href="#l13.123"></a><span id="l13.123" class="difflineplus">+</span>
<a href="#l13.124"></a><span id="l13.124" class="difflineplus">+  /**</span>
<a href="#l13.125"></a><span id="l13.125" class="difflineplus">+   * FolderDisplayWidget tells us when it is killing the view, which means our</span>
<a href="#l13.126"></a><span id="l13.126" class="difflineplus">+   *  displayed message is no longer valid.</span>
<a href="#l13.127"></a><span id="l13.127" class="difflineplus">+   */</span>
<a href="#l13.128"></a><span id="l13.128" class="difflineplus">+  onDestroyingView: function MessageDisplayWidget_onDestroyingView(</span>
<a href="#l13.129"></a><span id="l13.129" class="difflineplus">+      aFolderIsComingBack) {</span>
<a href="#l13.130"></a><span id="l13.130" class="difflineplus">+    this.displayedMessage = null;</span>
<a href="#l13.131"></a><span id="l13.131" class="difflineplus">+    // The only time we want to do anything is when the folder is not coming</span>
<a href="#l13.132"></a><span id="l13.132" class="difflineplus">+    //  back.  If it is coming back, we can handle things when it shows up.</span>
<a href="#l13.133"></a><span id="l13.133" class="difflineplus">+    if (!aFolderIsComingBack &amp;&amp; this._active) {</span>
<a href="#l13.134"></a><span id="l13.134" class="difflineplus">+      // and in this case, we just want to clear things.</span>
<a href="#l13.135"></a><span id="l13.135" class="difflineplus">+      this.clearDisplay();</span>
<a href="#l13.136"></a><span id="l13.136" class="difflineplus">+      this.singleMessageDisplay = true;</span>
<a href="#l13.137"></a><span id="l13.137" class="difflineplus">+    }</span>
<a href="#l13.138"></a><span id="l13.138" class="difflineplus">+  },</span>
<a href="#l13.139"></a><span id="l13.139" class="difflineplus">+</span>
<a href="#l13.140"></a><span id="l13.140" class="difflineplus">+  /**</span>
<a href="#l13.141"></a><span id="l13.141" class="difflineplus">+   * FolderDisplayWidget tells us when a message is being displayed.</span>
<a href="#l13.142"></a><span id="l13.142" class="difflineplus">+   */</span>
<a href="#l13.143"></a><span id="l13.143" class="difflineplus">+  onDisplayingMessage: function MessageDisplayWidget_onDisplayingMessage(</span>
<a href="#l13.144"></a><span id="l13.144" class="difflineplus">+      aMsgHdr) {</span>
<a href="#l13.145"></a><span id="l13.145" class="difflineplus">+    this.displayedMessage = aMsgHdr;</span>
<a href="#l13.146"></a><span id="l13.146" class="difflineplus">+    this.messageLoading = true;</span>
<a href="#l13.147"></a><span id="l13.147" class="difflineplus">+    this.messageLoaded = false;</span>
<a href="#l13.148"></a><span id="l13.148" class="difflineplus">+  },</span>
<a href="#l13.149"></a><span id="l13.149" class="difflineplus">+</span>
<a href="#l13.150"></a><span id="l13.150" class="difflineplus">+  /**</span>
<a href="#l13.151"></a><span id="l13.151" class="difflineplus">+   * The maximum number of messages to summarize at any given time.  If there</span>
<a href="#l13.152"></a><span id="l13.152" class="difflineplus">+   *  are more messages than this, we don't summarize, and instead give a blank</span>
<a href="#l13.153"></a><span id="l13.153" class="difflineplus">+   *  window pane.  Arguably something that says &quot;there are two many messages&quot;</span>
<a href="#l13.154"></a><span id="l13.154" class="difflineplus">+   *  would be a better idea.</span>
<a href="#l13.155"></a><span id="l13.155" class="difflineplus">+   */</span>
<a href="#l13.156"></a><span id="l13.156" class="difflineplus">+  MAX_MESSAGES_TO_SUMMARIZE: 100,</span>
<a href="#l13.157"></a><span id="l13.157" class="difflineplus">+</span>
<a href="#l13.158"></a><span id="l13.158" class="difflineplus">+  /**</span>
<a href="#l13.159"></a><span id="l13.159" class="difflineplus">+   * FolderDisplayWidget tells us when the set of selected messages has changed.</span>
<a href="#l13.160"></a><span id="l13.160" class="difflineplus">+   *  FDW is doing this because an nsMsgDBView/subclass called</span>
<a href="#l13.161"></a><span id="l13.161" class="difflineplus">+   *  summarizeSelection.  Although the call is purely an outgrowth of the</span>
<a href="#l13.162"></a><span id="l13.162" class="difflineplus">+   *  introduction of folder summaries, it also provides a means for us to</span>
<a href="#l13.163"></a><span id="l13.163" class="difflineplus">+   *  completely replace the nsMsgDBView logic.  Namely, we get first bat at</span>
<a href="#l13.164"></a><span id="l13.164" class="difflineplus">+   *  taking an action as a result of the selection change, and we can cause the</span>
<a href="#l13.165"></a><span id="l13.165" class="difflineplus">+   *  nsMsgDBView to not do anything (by returning true).</span>
<a href="#l13.166"></a><span id="l13.166" class="difflineplus">+   * This notification will come prior to an onDisplayingMessage notification,</span>
<a href="#l13.167"></a><span id="l13.167" class="difflineplus">+   *  and we will only get that notification if we return false and the</span>
<a href="#l13.168"></a><span id="l13.168" class="difflineplus">+   *  nsMsgDBView logic wanted to display a message (read: there is exactly</span>
<a href="#l13.169"></a><span id="l13.169" class="difflineplus">+   *  one message displayed and it wasn't already displayed.)</span>
<a href="#l13.170"></a><span id="l13.170" class="difflineplus">+   *</span>
<a href="#l13.171"></a><span id="l13.171" class="difflineplus">+   * The prime responsibilities of this function are:</span>
<a href="#l13.172"></a><span id="l13.172" class="difflineplus">+   * - To make sure the right message pane (single or multi) is displayed.</span>
<a href="#l13.173"></a><span id="l13.173" class="difflineplus">+   * - To kick off a multi-message or thread summarization if multiple messages</span>
<a href="#l13.174"></a><span id="l13.174" class="difflineplus">+   *   are selected.</span>
<a href="#l13.175"></a><span id="l13.175" class="difflineplus">+   * - To throttle the rate at which we perform summarizations in case the</span>
<a href="#l13.176"></a><span id="l13.176" class="difflineplus">+   *   selection is being updated frequently.  This could be as a result of the</span>
<a href="#l13.177"></a><span id="l13.177" class="difflineplus">+   *   user holding down shift and using their keyboard to expand the selection,</span>
<a href="#l13.178"></a><span id="l13.178" class="difflineplus">+   *   use of the archive mechanism, or other.</span>
<a href="#l13.179"></a><span id="l13.179" class="difflineplus">+   * - To clear the message pane if no messages are selected.  This used to be</span>
<a href="#l13.180"></a><span id="l13.180" class="difflineplus">+   *   triggered by nsMsgDBView::SelectionChanged but is now our responsibility.</span>
<a href="#l13.181"></a><span id="l13.181" class="difflineplus">+   *</span>
<a href="#l13.182"></a><span id="l13.182" class="difflineplus">+   * In the event that the controlling preference for message summarization is</span>
<a href="#l13.183"></a><span id="l13.183" class="difflineplus">+   *  not enabled (mail.operate_on_msgs_in_collapsed_threads), and there is a</span>
<a href="#l13.184"></a><span id="l13.184" class="difflineplus">+   *  multi-selection, we just clear the display.</span>
<a href="#l13.185"></a><span id="l13.185" class="difflineplus">+   *</span>
<a href="#l13.186"></a><span id="l13.186" class="difflineplus">+   * @return true if we handled the selection notification and the nsMsgDBView</span>
<a href="#l13.187"></a><span id="l13.187" class="difflineplus">+   *  should do nothing, false if we did not and the nsMsgDBView should use its</span>
<a href="#l13.188"></a><span id="l13.188" class="difflineplus">+   *  logic to display a message.</span>
<a href="#l13.189"></a><span id="l13.189" class="difflineplus">+   */</span>
<a href="#l13.190"></a><span id="l13.190" class="difflineplus">+  onSelectedMessagesChanged:</span>
<a href="#l13.191"></a><span id="l13.191" class="difflineplus">+      function MessageDisplayWidget_onSelectedMessagesChanged() {</span>
<a href="#l13.192"></a><span id="l13.192" class="difflineplus">+    // If we are not active, we should not be touching things.  pretend we are</span>
<a href="#l13.193"></a><span id="l13.193" class="difflineplus">+    //  handling whatever is happening so the nsMsgDBView doesn't try and do</span>
<a href="#l13.194"></a><span id="l13.194" class="difflineplus">+    //  anything.  makeActive will trigger a fake SelectionChanged notification</span>
<a href="#l13.195"></a><span id="l13.195" class="difflineplus">+    //  when we switch, which should put everything in its right place.</span>
<a href="#l13.196"></a><span id="l13.196" class="difflineplus">+    if (!this.active)</span>
<a href="#l13.197"></a><span id="l13.197" class="difflineplus">+      return true;</span>
<a href="#l13.198"></a><span id="l13.198" class="difflineplus">+</span>
<a href="#l13.199"></a><span id="l13.199" class="difflineplus">+    let selectedCount = this.folderDisplay.selectedCount;</span>
<a href="#l13.200"></a><span id="l13.200" class="difflineplus">+</span>
<a href="#l13.201"></a><span id="l13.201" class="difflineplus">+    if (selectedCount == 0) {</span>
<a href="#l13.202"></a><span id="l13.202" class="difflineplus">+      // davida, put your folder summary stuff here.</span>
<a href="#l13.203"></a><span id="l13.203" class="difflineplus">+      this.clearDisplay();</span>
<a href="#l13.204"></a><span id="l13.204" class="difflineplus">+      this.singleMessageDisplay = true;</span>
<a href="#l13.205"></a><span id="l13.205" class="difflineplus">+    }</span>
<a href="#l13.206"></a><span id="l13.206" class="difflineplus">+    else if (selectedCount == 1) {</span>
<a href="#l13.207"></a><span id="l13.207" class="difflineplus">+      // the display of the message is happening without us</span>
<a href="#l13.208"></a><span id="l13.208" class="difflineplus">+      this.singleMessageDisplay = true;</span>
<a href="#l13.209"></a><span id="l13.209" class="difflineplus">+</span>
<a href="#l13.210"></a><span id="l13.210" class="difflineplus">+      // This is the only case we don't handle and want the nsMsgDBView to</span>
<a href="#l13.211"></a><span id="l13.211" class="difflineplus">+      //  take care of.</span>
<a href="#l13.212"></a><span id="l13.212" class="difflineplus">+      return false;</span>
<a href="#l13.213"></a><span id="l13.213" class="difflineplus">+    }</span>
<a href="#l13.214"></a><span id="l13.214" class="difflineplus">+    // we have a limit on the number of messages and if the pref is enabled</span>
<a href="#l13.215"></a><span id="l13.215" class="difflineplus">+    else if ((selectedCount &lt; this.MAX_MESSAGES_TO_SUMMARIZE) &amp;&amp;</span>
<a href="#l13.216"></a><span id="l13.216" class="difflineplus">+        gPrefBranch.getBoolPref(&quot;mail.operate_on_msgs_in_collapsed_threads&quot;)) {</span>
<a href="#l13.217"></a><span id="l13.217" class="difflineplus">+      // _showSummary is responsible for handling the &quot;don't resummarize too</span>
<a href="#l13.218"></a><span id="l13.218" class="difflineplus">+      //  often&quot; logic, as well as updating singleMessageDisplay.</span>
<a href="#l13.219"></a><span id="l13.219" class="difflineplus">+      this._showSummary();</span>
<a href="#l13.220"></a><span id="l13.220" class="difflineplus">+    }</span>
<a href="#l13.221"></a><span id="l13.221" class="difflineplus">+    // and so we clear things</span>
<a href="#l13.222"></a><span id="l13.222" class="difflineplus">+    else {</span>
<a href="#l13.223"></a><span id="l13.223" class="difflineplus">+      this.clearDisplay();</span>
<a href="#l13.224"></a><span id="l13.224" class="difflineplus">+      this.singleMessageDisplay = true;</span>
<a href="#l13.225"></a><span id="l13.225" class="difflineplus">+    }</span>
<a href="#l13.226"></a><span id="l13.226" class="difflineplus">+</span>
<a href="#l13.227"></a><span id="l13.227" class="difflineplus">+    return true;</span>
<a href="#l13.228"></a><span id="l13.228" class="difflineplus">+  },</span>
<a href="#l13.229"></a><span id="l13.229" class="difflineplus">+</span>
<a href="#l13.230"></a><span id="l13.230" class="difflineplus">+  /**</span>
<a href="#l13.231"></a><span id="l13.231" class="difflineplus">+   * If we are already summarized and we get a new request to summarize, require</span>
<a href="#l13.232"></a><span id="l13.232" class="difflineplus">+   *  that the selection has been stable for at least this many milliseconds</span>
<a href="#l13.233"></a><span id="l13.233" class="difflineplus">+   *  before resummarizing.</span>
<a href="#l13.234"></a><span id="l13.234" class="difflineplus">+   * Unit tests know about this variable and poke at it, so don't change the name</span>
<a href="#l13.235"></a><span id="l13.235" class="difflineplus">+   *  without making sure you update the unit tests.  (Not that you would commit</span>
<a href="#l13.236"></a><span id="l13.236" class="difflineplus">+   *  code without first running all tests yourself...)</span>
<a href="#l13.237"></a><span id="l13.237" class="difflineplus">+   */</span>
<a href="#l13.238"></a><span id="l13.238" class="difflineplus">+  SUMMARIZATION_SELECTION_STABILITY_INTERVAL_MS: 100,</span>
<a href="#l13.239"></a><span id="l13.239" class="difflineplus">+  /**</span>
<a href="#l13.240"></a><span id="l13.240" class="difflineplus">+   * The timeout ID resulting from the call to window.setTimeout that we are</span>
<a href="#l13.241"></a><span id="l13.241" class="difflineplus">+   *  using to require the selection be 'stabilized' before re-summarizing.</span>
<a href="#l13.242"></a><span id="l13.242" class="difflineplus">+   */</span>
<a href="#l13.243"></a><span id="l13.243" class="difflineplus">+  _summaryStabilityTimeout: null,</span>
<a href="#l13.244"></a><span id="l13.244" class="difflineplus">+</span>
<a href="#l13.245"></a><span id="l13.245" class="difflineplus">+  /**</span>
<a href="#l13.246"></a><span id="l13.246" class="difflineplus">+   * Updates message summaries with care to throttle the summarization when the</span>
<a href="#l13.247"></a><span id="l13.247" class="difflineplus">+   *  selection is rapidly changing.  We require that either we have not</span>
<a href="#l13.248"></a><span id="l13.248" class="difflineplus">+   *  summarized anything 'recently', or that the selection has been stable for</span>
<a href="#l13.249"></a><span id="l13.249" class="difflineplus">+   *  SUMMARIZATION_SELECTION_STABILITY_INTERVAL_MS ms before we update the</span>
<a href="#l13.250"></a><span id="l13.250" class="difflineplus">+   *  summary.  'Recently' for our purposes means that it has been at least</span>
<a href="#l13.251"></a><span id="l13.251" class="difflineplus">+   *  SUMMARIZATION_SELECTION_STABILITY_INTERVAL_MS ms since our last summary.</span>
<a href="#l13.252"></a><span id="l13.252" class="difflineplus">+   *</span>
<a href="#l13.253"></a><span id="l13.253" class="difflineplus">+   * Example event sequences (assuming a 100ms stability interval):</span>
<a href="#l13.254"></a><span id="l13.254" class="difflineplus">+   * - User selects a collapsed thread =&gt; we summarize the selection and set a</span>
<a href="#l13.255"></a><span id="l13.255" class="difflineplus">+   *    100ms timer set to call _clearSummaryTimer.</span>
<a href="#l13.256"></a><span id="l13.256" class="difflineplus">+   * - User extends the selection 50ms later =&gt; the timer has not elapsed so we</span>
<a href="#l13.257"></a><span id="l13.257" class="difflineplus">+   *    reset it to 100ms to call _showSummary.</span>
<a href="#l13.258"></a><span id="l13.258" class="difflineplus">+   * - User extends the selection yet again 50ms later =&gt; timer has not elapsed</span>
<a href="#l13.259"></a><span id="l13.259" class="difflineplus">+   *    so we reset it to 100ms to call _showSummary.</span>
<a href="#l13.260"></a><span id="l13.260" class="difflineplus">+   * - 100ms later, the timer elapses =&gt; we call _showSummary which updates the</span>
<a href="#l13.261"></a><span id="l13.261" class="difflineplus">+   *    summary.</span>
<a href="#l13.262"></a><span id="l13.262" class="difflineplus">+   * - 2 seconds later, the user selects some other messages =&gt; we summarize the</span>
<a href="#l13.263"></a><span id="l13.263" class="difflineplus">+   *    select and set a 100ms timer set to call _clearSummaryTimer.</span>
<a href="#l13.264"></a><span id="l13.264" class="difflineplus">+   * - 100ms later, _clearSummaryTimer clears _summaryStabilityTimeout so that</span>
<a href="#l13.265"></a><span id="l13.265" class="difflineplus">+   *    the next selection change will immediately summarize.</span>
<a href="#l13.266"></a><span id="l13.266" class="difflineplus">+   *</span>
<a href="#l13.267"></a><span id="l13.267" class="difflineplus">+   * @param aIsCallback Is this a callback to ourselves?  Callers should not set</span>
<a href="#l13.268"></a><span id="l13.268" class="difflineplus">+   *     this, leaving it undefined.</span>
<a href="#l13.269"></a><span id="l13.269" class="difflineplus">+   */</span>
<a href="#l13.270"></a><span id="l13.270" class="difflineplus">+  _showSummary: function MessageDisplayWidget_showSummary(aIsCallback) {</span>
<a href="#l13.271"></a><span id="l13.271" class="difflineplus">+    // note: if we are in this function, we already know that summaries are</span>
<a href="#l13.272"></a><span id="l13.272" class="difflineplus">+    //  enabled.</span>
<a href="#l13.273"></a><span id="l13.273" class="difflineplus">+</span>
<a href="#l13.274"></a><span id="l13.274" class="difflineplus">+    // If this is not a callback from the timeout and we currently have a</span>
<a href="#l13.275"></a><span id="l13.275" class="difflineplus">+    //  timeout, that means that we need to wait for the selection to stabilize.</span>
<a href="#l13.276"></a><span id="l13.276" class="difflineplus">+    //  The fact that we are getting called means the selection has just changed</span>
<a href="#l13.277"></a><span id="l13.277" class="difflineplus">+    //  yet again and is not stable, so reset the timer for the full duration.</span>
<a href="#l13.278"></a><span id="l13.278" class="difflineplus">+    if (!aIsCallback &amp;&amp; this._summaryStabilityTimeout != null) {</span>
<a href="#l13.279"></a><span id="l13.279" class="difflineplus">+      clearTimeout(this._summaryStabilityTimeout);</span>
<a href="#l13.280"></a><span id="l13.280" class="difflineplus">+      this._summaryStabilityTimeout =</span>
<a href="#l13.281"></a><span id="l13.281" class="difflineplus">+        setTimeout(this._wrapShowSummary,</span>
<a href="#l13.282"></a><span id="l13.282" class="difflineplus">+                   this.SUMMARIZATION_SELECTION_STABILITY_INTERVAL_MS,</span>
<a href="#l13.283"></a><span id="l13.283" class="difflineplus">+                   this);</span>
<a href="#l13.284"></a><span id="l13.284" class="difflineplus">+      return;</span>
<a href="#l13.285"></a><span id="l13.285" class="difflineplus">+    }</span>
<a href="#l13.286"></a><span id="l13.286" class="difflineplus">+</span>
<a href="#l13.287"></a><span id="l13.287" class="difflineplus">+    // Bail if our selection count has stabilized outside an acceptable range.</span>
<a href="#l13.288"></a><span id="l13.288" class="difflineplus">+    let selectedCount = this.folderDisplay.selectedCount;</span>
<a href="#l13.289"></a><span id="l13.289" class="difflineplus">+    if (selectedCount &lt; 2 || selectedCount &gt; this.MAX_MESSAGES_TO_SUMMARIZE)</span>
<a href="#l13.290"></a><span id="l13.290" class="difflineplus">+      return;</span>
<a href="#l13.291"></a><span id="l13.291" class="difflineplus">+</span>
<a href="#l13.292"></a><span id="l13.292" class="difflineplus">+    // Setup a timeout call to _clearSummaryTimer so that we don't try and</span>
<a href="#l13.293"></a><span id="l13.293" class="difflineplus">+    //  summarize again within 100ms of now.  Do this before calling</span>
<a href="#l13.294"></a><span id="l13.294" class="difflineplus">+    //  the summarization logic in case it throws an exception.</span>
<a href="#l13.295"></a><span id="l13.295" class="difflineplus">+    this._summaryStabilityTimeout =</span>
<a href="#l13.296"></a><span id="l13.296" class="difflineplus">+      setTimeout(this._clearSummaryTimer,</span>
<a href="#l13.297"></a><span id="l13.297" class="difflineplus">+                 this.SUMMARIZATION_SELECTION_STABILITY_INTERVAL_MS,</span>
<a href="#l13.298"></a><span id="l13.298" class="difflineplus">+                 this);</span>
<a href="#l13.299"></a><span id="l13.299" class="difflineplus">+</span>
<a href="#l13.300"></a><span id="l13.300" class="difflineplus">+    // figure out if we're looking at one thread or more than one thread</span>
<a href="#l13.301"></a><span id="l13.301" class="difflineplus">+    let selectedMessages = this.folderDisplay.selectedMessages;</span>
<a href="#l13.302"></a><span id="l13.302" class="difflineplus">+    if (selectedMessages[0].threadId != selectedMessages[1].threadId)</span>
<a href="#l13.303"></a><span id="l13.303" class="difflineplus">+      summarizeMultipleSelection(selectedMessages);</span>
<a href="#l13.304"></a><span id="l13.304" class="difflineplus">+    else</span>
<a href="#l13.305"></a><span id="l13.305" class="difflineplus">+      summarizeThread(selectedMessages);</span>
<a href="#l13.306"></a><span id="l13.306" class="difflineplus">+    this.singleMessageDisplay = false;</span>
<a href="#l13.307"></a><span id="l13.307" class="difflineplus">+  },</span>
<a href="#l13.308"></a><span id="l13.308" class="difflineplus">+  _wrapShowSummary: function MessageDisplayWidget__wrapShowSummary(aThis) {</span>
<a href="#l13.309"></a><span id="l13.309" class="difflineplus">+    aThis._showSummary(true);</span>
<a href="#l13.310"></a><span id="l13.310" class="difflineplus">+  },</span>
<a href="#l13.311"></a><span id="l13.311" class="difflineplus">+  /**</span>
<a href="#l13.312"></a><span id="l13.312" class="difflineplus">+   * Just clears the _summaryStabilityTimeout attribute so we can use it as a</span>
<a href="#l13.313"></a><span id="l13.313" class="difflineplus">+   *  means of checking if we are allowed to display the summary immediately.</span>
<a href="#l13.314"></a><span id="l13.314" class="difflineplus">+   */</span>
<a href="#l13.315"></a><span id="l13.315" class="difflineplus">+  _clearSummaryTimer: function MessageDisplayWidget__clearSummaryTimer(aThis) {</span>
<a href="#l13.316"></a><span id="l13.316" class="difflineplus">+    aThis._summaryStabilityTimeout = null;</span>
<a href="#l13.317"></a><span id="l13.317" class="difflineplus">+  },</span>
<a href="#l13.318"></a><span id="l13.318" class="difflineplus">+</span>
<a href="#l13.319"></a><span id="l13.319" class="difflineplus">+  /**</span>
<a href="#l13.320"></a><span id="l13.320" class="difflineplus">+   * Called by the FolderDisplayWidget when it is being made active again and</span>
<a href="#l13.321"></a><span id="l13.321" class="difflineplus">+   *  it's time for us to step up and re-display or clear the message as</span>
<a href="#l13.322"></a><span id="l13.322" class="difflineplus">+   *  demanded by our multiplexed tab implementation.</span>
<a href="#l13.323"></a><span id="l13.323" class="difflineplus">+   */</span>
<a href="#l13.324"></a><span id="l13.324" class="difflineplus">+  makeActive: function MessageDisplayWidget_makeActive() {</span>
<a href="#l13.325"></a><span id="l13.325" class="difflineplus">+    let wasInactive = !this._active;</span>
<a href="#l13.326"></a><span id="l13.326" class="difflineplus">+    this._active = true;</span>
<a href="#l13.327"></a><span id="l13.327" class="difflineplus">+</span>
<a href="#l13.328"></a><span id="l13.328" class="difflineplus">+    if (wasInactive) {</span>
<a href="#l13.329"></a><span id="l13.329" class="difflineplus">+      // (see our usage below)</span>
<a href="#l13.330"></a><span id="l13.330" class="difflineplus">+      let preDisplayedMessage = this.displayedMessage;</span>
<a href="#l13.331"></a><span id="l13.331" class="difflineplus">+      // Force a synthetic selection changed event.  This will propagate through</span>
<a href="#l13.332"></a><span id="l13.332" class="difflineplus">+      //  to a call to onSelectedMessagesChanged who will handle making sure the</span>
<a href="#l13.333"></a><span id="l13.333" class="difflineplus">+      //  right message pane is in use, etc.</span>
<a href="#l13.334"></a><span id="l13.334" class="difflineplus">+      this.folderDisplay.view.dbView.selectionChanged();</span>
<a href="#l13.335"></a><span id="l13.335" class="difflineplus">+      // The one potential problem is that the message view only triggers message</span>
<a href="#l13.336"></a><span id="l13.336" class="difflineplus">+      //  streaming if it doesn't think the message is already displayed.  In that</span>
<a href="#l13.337"></a><span id="l13.337" class="difflineplus">+      //  case we need to force a re-display by calling reloadMessage.  We can</span>
<a href="#l13.338"></a><span id="l13.338" class="difflineplus">+      //  detect that case by seeing if our displayedMessage value changes its</span>
<a href="#l13.339"></a><span id="l13.339" class="difflineplus">+      //  value during this call (because we will receive a onDisplayingMessage</span>
<a href="#l13.340"></a><span id="l13.340" class="difflineplus">+      //  notification).  If we should be displaying a single message but the</span>
<a href="#l13.341"></a><span id="l13.341" class="difflineplus">+      //  value does not change, we need to force a re-display.</span>
<a href="#l13.342"></a><span id="l13.342" class="difflineplus">+      if (this.singleMessageDisplay &amp;&amp; this.displayedMessage &amp;&amp;</span>
<a href="#l13.343"></a><span id="l13.343" class="difflineplus">+          (this.displayedMessage == preDisplayedMessage))</span>
<a href="#l13.344"></a><span id="l13.344" class="difflineplus">+        this.folderDisplay.view.dbView.reloadMessage();</span>
<a href="#l13.345"></a><span id="l13.345" class="difflineplus">+    }</span>
<a href="#l13.346"></a><span id="l13.346" class="difflineplus">+</span>
<a href="#l13.347"></a><span id="l13.347" class="difflineplus">+    this._updateActiveMessagePane();</span>
<a href="#l13.348"></a><span id="l13.348" class="difflineplus">+  },</span>
<a href="#l13.349"></a><span id="l13.349" class="difflineplus">+</span>
<a href="#l13.350"></a><span id="l13.350" class="difflineplus">+  /**</span>
<a href="#l13.351"></a><span id="l13.351" class="difflineplus">+   * Called by the FolderDisplayWidget when it is being made inactive or no</span>
<a href="#l13.352"></a><span id="l13.352" class="difflineplus">+   *  longer requires messages to be displayed.</span>
<a href="#l13.353"></a><span id="l13.353" class="difflineplus">+   */</span>
<a href="#l13.354"></a><span id="l13.354" class="difflineplus">+  makeInactive: function MessageDisplayWidget_makeInactive() {</span>
<a href="#l13.355"></a><span id="l13.355" class="difflineplus">+    this._active = false;</span>
<a href="#l13.356"></a><span id="l13.356" class="difflineplus">+  }</span>
<a href="#l13.357"></a><span id="l13.357" class="difflineplus">+};</span>
<a href="#l13.358"></a><span id="l13.358" class="difflineplus">+</span>
<a href="#l13.359"></a><span id="l13.359" class="difflineplus">+/**</span>
<a href="#l13.360"></a><span id="l13.360" class="difflineplus">+ * Display widget abstraction for the 3-pane message view's preview pane/message</span>
<a href="#l13.361"></a><span id="l13.361" class="difflineplus">+ *  pane. Like the DisplayWidget, it is multiplexed.</span>
<a href="#l13.362"></a><span id="l13.362" class="difflineplus">+ */</span>
<a href="#l13.363"></a><span id="l13.363" class="difflineplus">+function MessagePaneDisplayWidget() {</span>
<a href="#l13.364"></a><span id="l13.364" class="difflineplus">+  MessageDisplayWidget.call(this);</span>
<a href="#l13.365"></a><span id="l13.365" class="difflineplus">+  this._visible = true;</span>
<a href="#l13.366"></a><span id="l13.366" class="difflineplus">+}</span>
<a href="#l13.367"></a><span id="l13.367" class="difflineplus">+MessagePaneDisplayWidget.prototype = {</span>
<a href="#l13.368"></a><span id="l13.368" class="difflineplus">+  __proto__: MessageDisplayWidget.prototype,</span>
<a href="#l13.369"></a><span id="l13.369" class="difflineplus">+</span>
<a href="#l13.370"></a><span id="l13.370" class="difflineplus">+  get visible MessageDisplayWidget_get_visible() {</span>
<a href="#l13.371"></a><span id="l13.371" class="difflineplus">+    return this._visible;</span>
<a href="#l13.372"></a><span id="l13.372" class="difflineplus">+  },</span>
<a href="#l13.373"></a><span id="l13.373" class="difflineplus">+  /**</span>
<a href="#l13.374"></a><span id="l13.374" class="difflineplus">+   * Tell us whether the message pane is visible or not; this should reflect</span>
<a href="#l13.375"></a><span id="l13.375" class="difflineplus">+   *  reality and does not define reality.  (Setting this to false does not</span>
<a href="#l13.376"></a><span id="l13.376" class="difflineplus">+   *  hide the message pane, it merely makes us think it is hidden.)</span>
<a href="#l13.377"></a><span id="l13.377" class="difflineplus">+   */</span>
<a href="#l13.378"></a><span id="l13.378" class="difflineplus">+  set visible MessageDisplayWidget_set_visible(aVisible) {</span>
<a href="#l13.379"></a><span id="l13.379" class="difflineplus">+    // Ignore this if we are inactive.  We don't want to get faked out by things</span>
<a href="#l13.380"></a><span id="l13.380" class="difflineplus">+    //  happening after our tab has closed up shop.</span>
<a href="#l13.381"></a><span id="l13.381" class="difflineplus">+    if (!this._active)</span>
<a href="#l13.382"></a><span id="l13.382" class="difflineplus">+      return;</span>
<a href="#l13.383"></a><span id="l13.383" class="difflineplus">+</span>
<a href="#l13.384"></a><span id="l13.384" class="difflineplus">+    // no-op if it's the same</span>
<a href="#l13.385"></a><span id="l13.385" class="difflineplus">+    if (aVisible == this._visible)</span>
<a href="#l13.386"></a><span id="l13.386" class="difflineplus">+      return;</span>
<a href="#l13.387"></a><span id="l13.387" class="difflineplus">+</span>
<a href="#l13.388"></a><span id="l13.388" class="difflineplus">+    this._visible = aVisible;</span>
<a href="#l13.389"></a><span id="l13.389" class="difflineplus">+    // Update suppression.  If we were not visible and now are visible, the db</span>
<a href="#l13.390"></a><span id="l13.390" class="difflineplus">+    //  view itself will handle triggering the message display for us if the</span>
<a href="#l13.391"></a><span id="l13.391" class="difflineplus">+    //  message was not currently being displayed...</span>
<a href="#l13.392"></a><span id="l13.392" class="difflineplus">+    let dbView = this.folderDisplay.view.dbView;</span>
<a href="#l13.393"></a><span id="l13.393" class="difflineplus">+    if (dbView) {</span>
<a href="#l13.394"></a><span id="l13.394" class="difflineplus">+      let treeSelection = this.folderDisplay.treeSelection;</span>
<a href="#l13.395"></a><span id="l13.395" class="difflineplus">+      // flag if we need to force the redisplay manually...</span>
<a href="#l13.396"></a><span id="l13.396" class="difflineplus">+      let needToReloadMessage = treeSelection.count &amp;&amp;</span>
<a href="#l13.397"></a><span id="l13.397" class="difflineplus">+        dbView.currentlyDisplayedMessage == treeSelection.currentIndex;</span>
<a href="#l13.398"></a><span id="l13.398" class="difflineplus">+      dbView.suppressMsgDisplay = !this._visible;</span>
<a href="#l13.399"></a><span id="l13.399" class="difflineplus">+      if (needToReloadMessage)</span>
<a href="#l13.400"></a><span id="l13.400" class="difflineplus">+        dbView.reloadMessage();</span>
<a href="#l13.401"></a><span id="l13.401" class="difflineplus">+    }</span>
<a href="#l13.402"></a><span id="l13.402" class="difflineplus">+    // But if we are no longer visible, it's on us to clear the display.</span>
<a href="#l13.403"></a><span id="l13.403" class="difflineplus">+    if (!aVisible)</span>
<a href="#l13.404"></a><span id="l13.404" class="difflineplus">+      this.clearDisplay();</span>
<a href="#l13.405"></a><span id="l13.405" class="difflineplus">+  },</span>
<a href="#l13.406"></a><span id="l13.406" class="difflineplus">+};</span>
<a href="#l13.407"></a><span id="l13.407" class="difflineplus">+</span>
<a href="#l13.408"></a><span id="l13.408" class="difflineplus">+/**</span>
<a href="#l13.409"></a><span id="l13.409" class="difflineplus">+ * Message display widget for the &quot;message&quot; tab that is the tab-based equivalent</span>
<a href="#l13.410"></a><span id="l13.410" class="difflineplus">+ *  of the standalone message window.</span>
<a href="#l13.411"></a><span id="l13.411" class="difflineplus">+ */</span>
<a href="#l13.412"></a><span id="l13.412" class="difflineplus">+function MessageTabDisplayWidget() {</span>
<a href="#l13.413"></a><span id="l13.413" class="difflineplus">+  MessageDisplayWidget.call(this);</span>
<a href="#l13.414"></a><span id="l13.414" class="difflineplus">+}</span>
<a href="#l13.415"></a><span id="l13.415" class="difflineplus">+MessageTabDisplayWidget.prototype = {</span>
<a href="#l13.416"></a><span id="l13.416" class="difflineplus">+  __proto__: MessageDisplayWidget.prototype,</span>
<a href="#l13.417"></a><span id="l13.417" class="difflineplus">+</span>
<a href="#l13.418"></a><span id="l13.418" class="difflineplus">+  /**</span>
<a href="#l13.419"></a><span id="l13.419" class="difflineplus">+   * The message tab always has a visible message pane.</span>
<a href="#l13.420"></a><span id="l13.420" class="difflineplus">+   */</span>
<a href="#l13.421"></a><span id="l13.421" class="difflineplus">+  get visible() {</span>
<a href="#l13.422"></a><span id="l13.422" class="difflineplus">+    return true;</span>
<a href="#l13.423"></a><span id="l13.423" class="difflineplus">+  },</span>
<a href="#l13.424"></a><span id="l13.424" class="difflineplus">+  set visible(aIgnored) {</span>
<a href="#l13.425"></a><span id="l13.425" class="difflineplus">+  },</span>
<a href="#l13.426"></a><span id="l13.426" class="difflineplus">+</span>
<a href="#l13.427"></a><span id="l13.427" class="difflineplus">+  onSelectedMessagesChanged:</span>
<a href="#l13.428"></a><span id="l13.428" class="difflineplus">+      function MessageTabDisplayWidget_onSelectedMessagesChanged() {</span>
<a href="#l13.429"></a><span id="l13.429" class="difflineplus">+    this.__proto__.__proto__.onSelectedMessagesChanged.apply(this, arguments);</span>
<a href="#l13.430"></a><span id="l13.430" class="difflineplus">+    if (!this.closing)</span>
<a href="#l13.431"></a><span id="l13.431" class="difflineplus">+      document.getElementById('tabmail').setTabTitle(this.folderDisplay._tabInfo);</span>
<a href="#l13.432"></a><span id="l13.432" class="difflineplus">+  },</span>
<a href="#l13.433"></a><span id="l13.433" class="difflineplus">+</span>
<a href="#l13.434"></a><span id="l13.434" class="difflineplus">+  /**</span>
<a href="#l13.435"></a><span id="l13.435" class="difflineplus">+   * A message tab should never ever be blank.  Close the tab if we become</span>
<a href="#l13.436"></a><span id="l13.436" class="difflineplus">+   *  blank.</span>
<a href="#l13.437"></a><span id="l13.437" class="difflineplus">+   */</span>
<a href="#l13.438"></a><span id="l13.438" class="difflineplus">+  clearDisplay: function MessageTabDisplayWidget_clearDisplay() {</span>
<a href="#l13.439"></a><span id="l13.439" class="difflineplus">+    if (!this.closing) {</span>
<a href="#l13.440"></a><span id="l13.440" class="difflineplus">+      this.closing = true;</span>
<a href="#l13.441"></a><span id="l13.441" class="difflineplus">+      document.getElementById('tabmail').closeTab(this.folderDisplay._tabInfo);</span>
<a href="#l13.442"></a><span id="l13.442" class="difflineplus">+    }</span>
<a href="#l13.443"></a><span id="l13.443" class="difflineplus">+  }</span>
<a href="#l13.444"></a><span id="l13.444" class="difflineplus">+};</span>
<a href="#l13.445"></a><span id="l13.445" class="difflineplus">+</span>
<a href="#l13.446"></a><span id="l13.446" class="difflineplus">+/**</span>
<a href="#l13.447"></a><span id="l13.447" class="difflineplus">+ * The search dialog has no message preview pane, and so wants a message</span>
<a href="#l13.448"></a><span id="l13.448" class="difflineplus">+ *  display widget that is never visible.  No one other than the search</span>
<a href="#l13.449"></a><span id="l13.449" class="difflineplus">+ *  dialog should use this because the search dialog is bad UI.</span>
<a href="#l13.450"></a><span id="l13.450" class="difflineplus">+ */</span>
<a href="#l13.451"></a><span id="l13.451" class="difflineplus">+function NeverVisisbleMessageDisplayWidget() {</span>
<a href="#l13.452"></a><span id="l13.452" class="difflineplus">+  MessageDisplayWidget.call(this);</span>
<a href="#l13.453"></a><span id="l13.453" class="difflineplus">+}</span>
<a href="#l13.454"></a><span id="l13.454" class="difflineplus">+NeverVisisbleMessageDisplayWidget.prototype = {</span>
<a href="#l13.455"></a><span id="l13.455" class="difflineplus">+  __proto__: MessageDisplayWidget.prototype,</span>
<a href="#l13.456"></a><span id="l13.456" class="difflineplus">+  get visible() {</span>
<a href="#l13.457"></a><span id="l13.457" class="difflineplus">+    return false;</span>
<a href="#l13.458"></a><span id="l13.458" class="difflineplus">+  },</span>
<a href="#l13.459"></a><span id="l13.459" class="difflineplus">+  onSelectedMessagesChanged: function() {</span>
<a href="#l13.460"></a><span id="l13.460" class="difflineplus">+    return false;</span>
<a href="#l13.461"></a><span id="l13.461" class="difflineplus">+  },</span>
<a href="#l13.462"></a><span id="l13.462" class="difflineplus">+  _updateActiveMessagePane: function() {</span>
<a href="#l13.463"></a><span id="l13.463" class="difflineplus">+  },</span>
<a href="#l13.464"></a><span id="l13.464" class="difflineplus">+};</span>
<a href="#l13.465"></a><span id="l13.465">\ No newline at end of file</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mail/base/content/messageWindow.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mail/base/content/messageWindow.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -1,129 +1,242 @@</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineminus">-# -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineminus">-# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineminus">-# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l14.7"></a><span id="l14.7" class="difflineminus">-#</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineminus">-# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l14.9"></a><span id="l14.9" class="difflineminus">-# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineminus">-# the License. You may obtain a copy of the License at</span>
<a href="#l14.11"></a><span id="l14.11" class="difflineminus">-# http://www.mozilla.org/MPL/</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-#</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineminus">-# for the specific language governing rights and limitations under the</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineminus">-# License.</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineminus">-#</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineminus">-# The Original Code is Mozilla Communicator client code, released</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineminus">-# March 31, 1998.</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineminus">-#</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineminus">-# The Initial Developer of the Original Code is</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineminus">-# Netscape Communications Corporation.</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineminus">-# Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineminus">-# the Initial Developer. All Rights Reserved.</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineminus">-#</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineminus">-# Contributor(s):</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineminus">-#</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineminus">-# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineminus">-# either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineminus">-# the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">-# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineminus">-# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineminus">-# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineminus">-# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineminus">-# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineminus">-# the provisions above, a recipient may use your version of this file under</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineminus">-# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineminus">-#</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineminus">-# ***** END LICENSE BLOCK *****</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+/** ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineplus">+ *</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+ *</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+ * License.</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+ *</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+ * The Original Code is Mozilla Communicator client code, released</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineplus">+ * March 31, 1998.</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineplus">+ *</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineplus">+ * Netscape Communications Corporation.</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineplus">+ *</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineplus">+ * Contributor(s):</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineplus">+ *</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineplus">+ *</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l14.77"></a><span id="l14.77"> </span>
<a href="#l14.78"></a><span id="l14.78"> /* This is where functions related to the standalone message window are kept */</span>
<a href="#l14.79"></a><span id="l14.79"> </span>
<a href="#l14.80"></a><span id="l14.80" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/jsTreeSelection.js&quot;);</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineplus">+</span>
<a href="#l14.83"></a><span id="l14.83"> // from MailNewsTypes.h</span>
<a href="#l14.84"></a><span id="l14.84"> const nsMsgKey_None = 0xFFFFFFFF;</span>
<a href="#l14.85"></a><span id="l14.85"> const nsMsgViewIndex_None = 0xFFFFFFFF;</span>
<a href="#l14.86"></a><span id="l14.86"> </span>
<a href="#l14.87"></a><span id="l14.87"> /* globals for a particular window */</span>
<a href="#l14.88"></a><span id="l14.88"> </span>
<a href="#l14.89"></a><span id="l14.89" class="difflineminus">-var gCurrentMessageUri;</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineminus">-var gCurrentFolderUri;</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineminus">-var gThreadPaneCommandUpdater = null;</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineminus">-var gNextMessageViewIndexAfterDelete = -2;</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineminus">-var gCurrentFolderToRerootForStandAlone;</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineminus">-var gRerootOnFolderLoadForStandAlone = false;</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineminus">-var gNextMessageAfterLoad = null;</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineminus">-var gMessageToLoad = nsMsgKey_None;</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineplus">+/// we have no tree view; let people know that.</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineplus">+var gFolderTreeView = null;</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineplus">+</span>
<a href="#l14.100"></a><span id="l14.100" class="difflineplus">+var gFolderDisplay;</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineplus">+var gMessageDisplay;</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineplus">+</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineplus">+/**</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineplus">+ * We subclass FolderDisplayWidget:</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineplus">+ * - Because it assumes some thread-pane things that do not apply to us and we</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineplus">+ *    want to no-op those things out.</span>
<a href="#l14.107"></a><span id="l14.107" class="difflineplus">+ * - To intercept queries about the selected message so that we can do the</span>
<a href="#l14.108"></a><span id="l14.108" class="difflineplus">+ *    .eml file thing.  We were originally trying to avoid involving the</span>
<a href="#l14.109"></a><span id="l14.109" class="difflineplus">+ *    nsMsgDBView, but that might not be important anymore. (future work)</span>
<a href="#l14.110"></a><span id="l14.110" class="difflineplus">+ */</span>
<a href="#l14.111"></a><span id="l14.111" class="difflineplus">+function StandaloneFolderDisplayWidget(aMessageDisplayWidget) {</span>
<a href="#l14.112"></a><span id="l14.112" class="difflineplus">+  FolderDisplayWidget.call(this, null, aMessageDisplayWidget);</span>
<a href="#l14.113"></a><span id="l14.113" class="difflineplus">+  // do not set the actual treeBox variable or our superclass might try and do</span>
<a href="#l14.114"></a><span id="l14.114" class="difflineplus">+  //  weird rooting things we don't want to have to think about right now.</span>
<a href="#l14.115"></a><span id="l14.115" class="difflineplus">+  this._magicTreeSelection = new JSTreeSelection(this.treeBox);</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineplus">+}</span>
<a href="#l14.117"></a><span id="l14.117" class="difflineplus">+StandaloneFolderDisplayWidget.prototype = {</span>
<a href="#l14.118"></a><span id="l14.118" class="difflineplus">+  __proto__: FolderDisplayWidget.prototype,</span>
<a href="#l14.119"></a><span id="l14.119" class="difflineplus">+</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineplus">+  /**</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineplus">+   * If we have a displayed message, then we've got 1 message, otherwise 0.</span>
<a href="#l14.122"></a><span id="l14.122" class="difflineplus">+   */</span>
<a href="#l14.123"></a><span id="l14.123" class="difflineplus">+  get selectedCount() {</span>
<a href="#l14.124"></a><span id="l14.124" class="difflineplus">+    return this.messageDisplay.displayedMessage ? 1 : 0;</span>
<a href="#l14.125"></a><span id="l14.125" class="difflineplus">+  },</span>
<a href="#l14.126"></a><span id="l14.126" class="difflineplus">+</span>
<a href="#l14.127"></a><span id="l14.127" class="difflineplus">+  /**</span>
<a href="#l14.128"></a><span id="l14.128" class="difflineplus">+   * If we have a selected message, it's the one displayed!  This is more</span>
<a href="#l14.129"></a><span id="l14.129" class="difflineplus">+   *  straight-forward than having you trace through the tree selection and</span>
<a href="#l14.130"></a><span id="l14.130" class="difflineplus">+   *  db view logic.</span>
<a href="#l14.131"></a><span id="l14.131" class="difflineplus">+   */</span>
<a href="#l14.132"></a><span id="l14.132" class="difflineplus">+  get selectedMessage() {</span>
<a href="#l14.133"></a><span id="l14.133" class="difflineplus">+    return this.messageDisplay.displayedMessage;</span>
<a href="#l14.134"></a><span id="l14.134" class="difflineplus">+  },</span>
<a href="#l14.135"></a><span id="l14.135"> </span>
<a href="#l14.136"></a><span id="l14.136" class="difflineminus">-// the folderListener object</span>
<a href="#l14.137"></a><span id="l14.137" class="difflineminus">-var folderListener = {</span>
<a href="#l14.138"></a><span id="l14.138" class="difflineminus">-  OnItemAdded: function(parentItem, item) {},</span>
<a href="#l14.139"></a><span id="l14.139" class="difflineplus">+  /**</span>
<a href="#l14.140"></a><span id="l14.140" class="difflineplus">+   * If we have a selected message, it's the one displayed!  This is more</span>
<a href="#l14.141"></a><span id="l14.141" class="difflineplus">+   *  straight-forward than having you trace through the tree selection and</span>
<a href="#l14.142"></a><span id="l14.142" class="difflineplus">+   *  db view logic.</span>
<a href="#l14.143"></a><span id="l14.143" class="difflineplus">+   */</span>
<a href="#l14.144"></a><span id="l14.144" class="difflineplus">+  get selectedMessages() {</span>
<a href="#l14.145"></a><span id="l14.145" class="difflineplus">+    return this.messageDisplay.displayedMessage ?</span>
<a href="#l14.146"></a><span id="l14.146" class="difflineplus">+             [this.messageDisplay.displayedMessage] : [];</span>
<a href="#l14.147"></a><span id="l14.147" class="difflineplus">+  },</span>
<a href="#l14.148"></a><span id="l14.148"> </span>
<a href="#l14.149"></a><span id="l14.149" class="difflineminus">-  OnItemRemoved: function(parentItem, item) {},</span>
<a href="#l14.150"></a><span id="l14.150" class="difflineminus">-  OnItemPropertyChanged: function(item, property, oldValue, newValue) {},</span>
<a href="#l14.151"></a><span id="l14.151" class="difflineminus">-  OnItemIntPropertyChanged: function(item, property, oldValue, newValue) {</span>
<a href="#l14.152"></a><span id="l14.152" class="difflineminus">-    if (item.URI == gCurrentFolderUri) {</span>
<a href="#l14.153"></a><span id="l14.153" class="difflineminus">-      if (property.toString() == &quot;TotalMessages&quot; || property.toString() == &quot;TotalUnreadMessages&quot;) {</span>
<a href="#l14.154"></a><span id="l14.154" class="difflineminus">-        UpdateStandAloneMessageCounts();</span>
<a href="#l14.155"></a><span id="l14.155" class="difflineminus">-      }</span>
<a href="#l14.156"></a><span id="l14.156" class="difflineplus">+  /**</span>
<a href="#l14.157"></a><span id="l14.157" class="difflineplus">+   * We never have a real treeview, so we always want to tell the view about</span>
<a href="#l14.158"></a><span id="l14.158" class="difflineplus">+   *  the fake tree box so it will actually do something in NoteChange.</span>
<a href="#l14.159"></a><span id="l14.159" class="difflineplus">+   */</span>
<a href="#l14.160"></a><span id="l14.160" class="difflineplus">+  onCreatedView:</span>
<a href="#l14.161"></a><span id="l14.161" class="difflineplus">+      function StandaloneMessageDisplayWidget_onCreatedView() {</span>
<a href="#l14.162"></a><span id="l14.162" class="difflineplus">+    this._fakeTreeBox.view = this.view.dbView;</span>
<a href="#l14.163"></a><span id="l14.163" class="difflineplus">+    // only if we're not dealing with a dummy message (from .eml file /</span>
<a href="#l14.164"></a><span id="l14.164" class="difflineplus">+    //  attachment should we try and hook up the selection object.)  Otherwise</span>
<a href="#l14.165"></a><span id="l14.165" class="difflineplus">+    //  the view will not operate in stand alone message mode.</span>
<a href="#l14.166"></a><span id="l14.166" class="difflineplus">+    // XXX the sequencing here may break re-using a message window that is</span>
<a href="#l14.167"></a><span id="l14.167" class="difflineplus">+    //  showing an .eml file to go to a real message, at least in terms of</span>
<a href="#l14.168"></a><span id="l14.168" class="difflineplus">+    //  having the selection object properly associated with the tree.</span>
<a href="#l14.169"></a><span id="l14.169" class="difflineplus">+    if (!this.messageDisplay.isDummy) {</span>
<a href="#l14.170"></a><span id="l14.170" class="difflineplus">+      this.view.dbView.setTree(this._fakeTreeBox);</span>
<a href="#l14.171"></a><span id="l14.171" class="difflineplus">+      this.view.dbView.selection = this._magicTreeSelection;</span>
<a href="#l14.172"></a><span id="l14.172">     }</span>
<a href="#l14.173"></a><span id="l14.173" class="difflineplus">+    this.__proto__.__proto__.onCreatedView.call(this);</span>
<a href="#l14.174"></a><span id="l14.174" class="difflineplus">+  },</span>
<a href="#l14.175"></a><span id="l14.175" class="difflineplus">+</span>
<a href="#l14.176"></a><span id="l14.176" class="difflineplus">+  _superSelectedMessageUrisGetter:</span>
<a href="#l14.177"></a><span id="l14.177" class="difflineplus">+    FolderDisplayWidget.prototype.__lookupGetter__('selectedMessageUris'),</span>
<a href="#l14.178"></a><span id="l14.178" class="difflineplus">+  /**</span>
<a href="#l14.179"></a><span id="l14.179" class="difflineplus">+   * Check with the message display widget to see if it has a dummy; if so, just</span>
<a href="#l14.180"></a><span id="l14.180" class="difflineplus">+   *  return the dummy's URI, as the nsMsgDBView logic that our superclass uses</span>
<a href="#l14.181"></a><span id="l14.181" class="difflineplus">+   *  falls down in that case.</span>
<a href="#l14.182"></a><span id="l14.182" class="difflineplus">+   */</span>
<a href="#l14.183"></a><span id="l14.183" class="difflineplus">+  get selectedMessageUris() {</span>
<a href="#l14.184"></a><span id="l14.184" class="difflineplus">+    if (this.messageDisplay.displayedUri)</span>
<a href="#l14.185"></a><span id="l14.185" class="difflineplus">+      return [this.messageDisplay.displayedUri];</span>
<a href="#l14.186"></a><span id="l14.186" class="difflineplus">+    return this._superSelectedMessageUrisGetter.call(this);</span>
<a href="#l14.187"></a><span id="l14.187">   },</span>
<a href="#l14.188"></a><span id="l14.188" class="difflineminus">-  OnItemBoolPropertyChanged: function(item, property, oldValue, newValue) {},</span>
<a href="#l14.189"></a><span id="l14.189" class="difflineminus">-  OnItemUnicharPropertyChanged: function(item, property, oldValue, newValue){},</span>
<a href="#l14.190"></a><span id="l14.190" class="difflineminus">-  OnItemPropertyFlagChanged: function(item, property, oldFlag, newFlag) {},</span>
<a href="#l14.191"></a><span id="l14.191" class="difflineplus">+</span>
<a href="#l14.192"></a><span id="l14.192" class="difflineplus">+  /// folder display will want to show the thread pane; we need do nothing</span>
<a href="#l14.193"></a><span id="l14.193" class="difflineplus">+  _showThreadPane: function () {},</span>
<a href="#l14.194"></a><span id="l14.194" class="difflineplus">+  _showAccountCentral: function () {},</span>
<a href="#l14.195"></a><span id="l14.195" class="difflineplus">+</span>
<a href="#l14.196"></a><span id="l14.196" class="difflineplus">+  _updateThreadDisplay: function () {},</span>
<a href="#l14.197"></a><span id="l14.197" class="difflineplus">+</span>
<a href="#l14.198"></a><span id="l14.198" class="difflineplus">+  onMessageCountsChanged:</span>
<a href="#l14.199"></a><span id="l14.199" class="difflineplus">+      function StandaloneFolderDisplayWidget_onMessageCountsChaned() {</span>
<a href="#l14.200"></a><span id="l14.200" class="difflineplus">+    UpdateStatusMessageCounts();</span>
<a href="#l14.201"></a><span id="l14.201" class="difflineplus">+  },</span>
<a href="#l14.202"></a><span id="l14.202" class="difflineplus">+};</span>
<a href="#l14.203"></a><span id="l14.203" class="difflineplus">+</span>
<a href="#l14.204"></a><span id="l14.204"> </span>
<a href="#l14.205"></a><span id="l14.205" class="difflineminus">-  OnItemEvent: function(folder, event) {</span>
<a href="#l14.206"></a><span id="l14.206" class="difflineminus">-    var eventType = event.toString();</span>
<a href="#l14.207"></a><span id="l14.207" class="difflineplus">+/**</span>
<a href="#l14.208"></a><span id="l14.208" class="difflineplus">+ * Display widget abstraction for a standalone message display.  Right now</span>
<a href="#l14.209"></a><span id="l14.209" class="difflineplus">+ *  I think this means the standalone message window, and not the 'message in a</span>
<a href="#l14.210"></a><span id="l14.210" class="difflineplus">+ *  tab' thing, which is really just a perverted configuration of the 3-pane</span>
<a href="#l14.211"></a><span id="l14.211" class="difflineplus">+ *  format.</span>
<a href="#l14.212"></a><span id="l14.212" class="difflineplus">+ */</span>
<a href="#l14.213"></a><span id="l14.213" class="difflineplus">+function StandaloneMessageDisplayWidget() {</span>
<a href="#l14.214"></a><span id="l14.214" class="difflineplus">+  MessageDisplayWidget.call(this);</span>
<a href="#l14.215"></a><span id="l14.215" class="difflineplus">+  /**</span>
<a href="#l14.216"></a><span id="l14.216" class="difflineplus">+   * Indicate whether the message being displayed is a 'dummy' because it is</span>
<a href="#l14.217"></a><span id="l14.217" class="difflineplus">+   *  backed not by an nsIMsgDBHdr but instead by a file on disk or an</span>
<a href="#l14.218"></a><span id="l14.218" class="difflineplus">+   *  attachment on some mail message.</span>
<a href="#l14.219"></a><span id="l14.219" class="difflineplus">+   */</span>
<a href="#l14.220"></a><span id="l14.220" class="difflineplus">+  this.isDummy = false;</span>
<a href="#l14.221"></a><span id="l14.221" class="difflineplus">+  /**</span>
<a href="#l14.222"></a><span id="l14.222" class="difflineplus">+   * When displaying a dummy message, this is the URI of the message that we are</span>
<a href="#l14.223"></a><span id="l14.223" class="difflineplus">+   *  displaying.  If we are not displaying a dummy message, this is null.</span>
<a href="#l14.224"></a><span id="l14.224" class="difflineplus">+   */</span>
<a href="#l14.225"></a><span id="l14.225" class="difflineplus">+  this.displayedUri = null;</span>
<a href="#l14.226"></a><span id="l14.226" class="difflineplus">+}</span>
<a href="#l14.227"></a><span id="l14.227" class="difflineplus">+StandaloneMessageDisplayWidget.prototype = {</span>
<a href="#l14.228"></a><span id="l14.228" class="difflineplus">+  __proto__: MessageDisplayWidget.prototype,</span>
<a href="#l14.229"></a><span id="l14.229"> </span>
<a href="#l14.230"></a><span id="l14.230" class="difflineminus">-    if (eventType == &quot;DeleteOrMoveMsgCompleted&quot;)</span>
<a href="#l14.231"></a><span id="l14.231" class="difflineminus">-      HandleDeleteOrMoveMsgCompleted(folder);</span>
<a href="#l14.232"></a><span id="l14.232" class="difflineminus">-    else if (eventType == &quot;DeleteOrMoveMsgFailed&quot;)</span>
<a href="#l14.233"></a><span id="l14.233" class="difflineminus">-      HandleDeleteOrMoveMsgFailed(folder);</span>
<a href="#l14.234"></a><span id="l14.234" class="difflineminus">-    else if (eventType == &quot;FolderLoaded&quot;) {</span>
<a href="#l14.235"></a><span id="l14.235" class="difflineminus">-      if (folder) {</span>
<a href="#l14.236"></a><span id="l14.236" class="difflineminus">-        var uri = folder.URI;</span>
<a href="#l14.237"></a><span id="l14.237" class="difflineminus">-        if (uri == gCurrentFolderToRerootForStandAlone) {</span>
<a href="#l14.238"></a><span id="l14.238" class="difflineminus">-          gCurrentFolderToRerootForStandAlone = null;</span>
<a href="#l14.239"></a><span id="l14.239" class="difflineminus">-          folder.endFolderLoading();</span>
<a href="#l14.240"></a><span id="l14.240" class="difflineminus">-          if (gRerootOnFolderLoadForStandAlone) {</span>
<a href="#l14.241"></a><span id="l14.241" class="difflineminus">-            RerootFolderForStandAlone(uri);</span>
<a href="#l14.242"></a><span id="l14.242" class="difflineminus">-          }</span>
<a href="#l14.243"></a><span id="l14.243" class="difflineminus">-        }</span>
<a href="#l14.244"></a><span id="l14.244" class="difflineminus">-      }</span>
<a href="#l14.245"></a><span id="l14.245" class="difflineplus">+  /**</span>
<a href="#l14.246"></a><span id="l14.246" class="difflineplus">+   * The message pane is a standalone display widget is always visible.</span>
<a href="#l14.247"></a><span id="l14.247" class="difflineplus">+   */</span>
<a href="#l14.248"></a><span id="l14.248" class="difflineplus">+  get visible() {</span>
<a href="#l14.249"></a><span id="l14.249" class="difflineplus">+    return true;</span>
<a href="#l14.250"></a><span id="l14.250" class="difflineplus">+  },</span>
<a href="#l14.251"></a><span id="l14.251" class="difflineplus">+  set visible(aIgnored) {</span>
<a href="#l14.252"></a><span id="l14.252" class="difflineplus">+  },</span>
<a href="#l14.253"></a><span id="l14.253" class="difflineplus">+</span>
<a href="#l14.254"></a><span id="l14.254" class="difflineplus">+  /**</span>
<a href="#l14.255"></a><span id="l14.255" class="difflineplus">+   * Display the external message (from disk or attachment) named by the URI.</span>
<a href="#l14.256"></a><span id="l14.256" class="difflineplus">+   */</span>
<a href="#l14.257"></a><span id="l14.257" class="difflineplus">+  displayExternalMessage:</span>
<a href="#l14.258"></a><span id="l14.258" class="difflineplus">+      function StandaloneMessageDisplayWidget_displayExternalMessage(aUri) {</span>
<a href="#l14.259"></a><span id="l14.259" class="difflineplus">+    this.isDummy = true;</span>
<a href="#l14.260"></a><span id="l14.260" class="difflineplus">+    this.displayedUri = aUri;</span>
<a href="#l14.261"></a><span id="l14.261" class="difflineplus">+    this.onDisplayingMessage(messageHeaderSink.dummyMsgHeader);</span>
<a href="#l14.262"></a><span id="l14.262" class="difflineplus">+    UpdateMailToolbar(&quot;external message display&quot;);</span>
<a href="#l14.263"></a><span id="l14.263" class="difflineplus">+    // null out the selection on the view so it operates in stand alone mode</span>
<a href="#l14.264"></a><span id="l14.264" class="difflineplus">+    this.folderDisplay.view.dbView.selection = null;</span>
<a href="#l14.265"></a><span id="l14.265" class="difflineplus">+    this.folderDisplay.view.dbView.loadMessageByUrl(aUri);</span>
<a href="#l14.266"></a><span id="l14.266" class="difflineplus">+  },</span>
<a href="#l14.267"></a><span id="l14.267" class="difflineplus">+</span>
<a href="#l14.268"></a><span id="l14.268" class="difflineplus">+  clearDisplay: function () {</span>
<a href="#l14.269"></a><span id="l14.269" class="difflineplus">+    window.close();</span>
<a href="#l14.270"></a><span id="l14.270" class="difflineplus">+  },</span>
<a href="#l14.271"></a><span id="l14.271" class="difflineplus">+  _updateActiveMessagePane: function() {</span>
<a href="#l14.272"></a><span id="l14.272" class="difflineplus">+    // no-op.  the message pane is always visible.</span>
<a href="#l14.273"></a><span id="l14.273" class="difflineplus">+  },</span>
<a href="#l14.274"></a><span id="l14.274" class="difflineplus">+</span>
<a href="#l14.275"></a><span id="l14.275" class="difflineplus">+  onDisplayingMessage:</span>
<a href="#l14.276"></a><span id="l14.276" class="difflineplus">+      function StandaloneMessageDisplayWidget_onDisplayingMessage(aMsgHdr) {</span>
<a href="#l14.277"></a><span id="l14.277" class="difflineplus">+    this.__proto__.__proto__.onDisplayingMessage.call(this, aMsgHdr);</span>
<a href="#l14.278"></a><span id="l14.278" class="difflineplus">+</span>
<a href="#l14.279"></a><span id="l14.279" class="difflineplus">+    // - set the window title to the message subject (and maybe the app name)</span>
<a href="#l14.280"></a><span id="l14.280" class="difflineplus">+    let title = aMsgHdr.mime2DecodedSubject;</span>
<a href="#l14.281"></a><span id="l14.281" class="difflineplus">+    if (!gPlatformOSX)</span>
<a href="#l14.282"></a><span id="l14.282" class="difflineplus">+      title += &quot; - &quot; + gBrandBundle.getString(&quot;brandFullName&quot;);</span>
<a href="#l14.283"></a><span id="l14.283" class="difflineplus">+    document.title = title;</span>
<a href="#l14.284"></a><span id="l14.284" class="difflineplus">+</span>
<a href="#l14.285"></a><span id="l14.285" class="difflineplus">+    this.isDummy = aMsgHdr.folder == null;</span>
<a href="#l14.286"></a><span id="l14.286" class="difflineplus">+    if (!this.isDummy)</span>
<a href="#l14.287"></a><span id="l14.287" class="difflineplus">+      this.displayedUri = null;</span>
<a href="#l14.288"></a><span id="l14.288" class="difflineplus">+  },</span>
<a href="#l14.289"></a><span id="l14.289" class="difflineplus">+</span>
<a href="#l14.290"></a><span id="l14.290" class="difflineplus">+  onSelectedMessagesChanged: function () {</span>
<a href="#l14.291"></a><span id="l14.291" class="difflineplus">+    if (this.folderDisplay.treeSelection.count == 0) {</span>
<a href="#l14.292"></a><span id="l14.292" class="difflineplus">+      window.close();</span>
<a href="#l14.293"></a><span id="l14.293" class="difflineplus">+      return true;</span>
<a href="#l14.294"></a><span id="l14.294">     }</span>
<a href="#l14.295"></a><span id="l14.295" class="difflineminus">-    else if (eventType == &quot;JunkStatusChanged&quot;) {</span>
<a href="#l14.296"></a><span id="l14.296" class="difflineminus">-      HandleJunkStatusChanged(folder);</span>
<a href="#l14.297"></a><span id="l14.297" class="difflineminus">-    }</span>
<a href="#l14.298"></a><span id="l14.298" class="difflineminus">-  }</span>
<a href="#l14.299"></a><span id="l14.299" class="difflineminus">-}</span>
<a href="#l14.300"></a><span id="l14.300" class="difflineplus">+    return false;</span>
<a href="#l14.301"></a><span id="l14.301" class="difflineplus">+  },</span>
<a href="#l14.302"></a><span id="l14.302" class="difflineplus">+};</span>
<a href="#l14.303"></a><span id="l14.303"> </span>
<a href="#l14.304"></a><span id="l14.304"> var messagepaneObserver = {</span>
<a href="#l14.305"></a><span id="l14.305"> </span>
<a href="#l14.306"></a><span id="l14.306">   canHandleMultipleItems: false,</span>
<a href="#l14.307"></a><span id="l14.307"> </span>
<a href="#l14.308"></a><span id="l14.308">   onDrop: function (aEvent, aData, aDragSession)</span>
<a href="#l14.309"></a><span id="l14.309">   {</span>
<a href="#l14.310"></a><span id="l14.310">     var sourceUri = aData.data;</span>
<a href="#l14.311"></a><span id="l14.311" class="difflineminus">-    if (sourceUri != gCurrentMessageUri)</span>
<a href="#l14.312"></a><span id="l14.312" class="difflineplus">+    if (!gFolderDisplay.selectedMessaage ||</span>
<a href="#l14.313"></a><span id="l14.313" class="difflineplus">+        sourceUri != gFolderDisplay.selectedMessageUris[0])</span>
<a href="#l14.314"></a><span id="l14.314">     {</span>
<a href="#l14.315"></a><span id="l14.315" class="difflineminus">-      var msgHdr = GetMsgHdrFromUri(sourceUri);</span>
<a href="#l14.316"></a><span id="l14.316" class="difflineminus">-</span>
<a href="#l14.317"></a><span id="l14.317" class="difflineminus">-      // Reset the window's message uri and folder uri vars, and</span>
<a href="#l14.318"></a><span id="l14.318" class="difflineminus">-      // update the command handlers to what's going to be used.</span>
<a href="#l14.319"></a><span id="l14.319" class="difflineminus">-      // This has to be done before the call to CreateView().</span>
<a href="#l14.320"></a><span id="l14.320" class="difflineminus">-      gCurrentMessageUri = sourceUri;</span>
<a href="#l14.321"></a><span id="l14.321" class="difflineminus">-      gCurrentFolderUri = msgHdr.folder.URI;</span>
<a href="#l14.322"></a><span id="l14.322" class="difflineminus">-      UpdateMailToolbar('onDrop');</span>
<a href="#l14.323"></a><span id="l14.323" class="difflineminus">-</span>
<a href="#l14.324"></a><span id="l14.324" class="difflineminus">-      // even if the folder uri's match, we can't use the existing view</span>
<a href="#l14.325"></a><span id="l14.325" class="difflineminus">-      // (msgHdr.folder.URI == windowID.gCurrentFolderUri)</span>
<a href="#l14.326"></a><span id="l14.326" class="difflineminus">-      // the reason is quick search and mail views.</span>
<a href="#l14.327"></a><span id="l14.327" class="difflineminus">-      // see bug #187673</span>
<a href="#l14.328"></a><span id="l14.328" class="difflineminus">-      CreateView(aDragSession.sourceNode.ownerDocument.defaultView.gDBView);</span>
<a href="#l14.329"></a><span id="l14.329" class="difflineminus">-      LoadMessageByMsgKey(msgHdr.messageKey);</span>
<a href="#l14.330"></a><span id="l14.330" class="difflineplus">+      var msgHdr = messenger.msgHdrFromURI(sourceUri);</span>
<a href="#l14.331"></a><span id="l14.331" class="difflineplus">+      let originGlobal = aDragSession.sourceNode.ownerDocument.defaultValue;</span>
<a href="#l14.332"></a><span id="l14.332" class="difflineplus">+      gFolderDisplay.cloneView(originGlobal.gFolderDisplay.view);</span>
<a href="#l14.333"></a><span id="l14.333" class="difflineplus">+      gFolderDisplay.selectMessage(msgHdr);</span>
<a href="#l14.334"></a><span id="l14.334">     }</span>
<a href="#l14.335"></a><span id="l14.335">   },</span>
<a href="#l14.336"></a><span id="l14.336"> </span>
<a href="#l14.337"></a><span id="l14.337">   onDragOver: function (aEvent, aFlavour, aDragSession)</span>
<a href="#l14.338"></a><span id="l14.338">   {</span>
<a href="#l14.339"></a><span id="l14.339">     var messagepanebox = document.getElementById(&quot;messagepanebox&quot;);</span>
<a href="#l14.340"></a><span id="l14.340">     messagepanebox.setAttribute(&quot;dragover&quot;, &quot;true&quot;);</span>
<a href="#l14.341"></a><span id="l14.341">   },</span>
<a href="#l14.342"></a><span id="l14.342" class="difflineat">@@ -144,295 +257,144 @@ var messagepaneObserver = {</span>
<a href="#l14.343"></a><span id="l14.343">   getSupportedFlavours: function ()</span>
<a href="#l14.344"></a><span id="l14.344">   {</span>
<a href="#l14.345"></a><span id="l14.345">     var flavourSet = new FlavourSet();</span>
<a href="#l14.346"></a><span id="l14.346">     flavourSet.appendFlavour(&quot;text/x-moz-message&quot;);</span>
<a href="#l14.347"></a><span id="l14.347">     return flavourSet;</span>
<a href="#l14.348"></a><span id="l14.348">   }</span>
<a href="#l14.349"></a><span id="l14.349"> };</span>
<a href="#l14.350"></a><span id="l14.350"> </span>
<a href="#l14.351"></a><span id="l14.351" class="difflineminus">-function nsMsgDBViewCommandUpdater()</span>
<a href="#l14.352"></a><span id="l14.352" class="difflineminus">-{}</span>
<a href="#l14.353"></a><span id="l14.353" class="difflineminus">-</span>
<a href="#l14.354"></a><span id="l14.354" class="difflineminus">-function UpdateStandAloneMessageCounts()</span>
<a href="#l14.355"></a><span id="l14.355" class="difflineplus">+function UpdateStatusMessageCounts()</span>
<a href="#l14.356"></a><span id="l14.356"> {</span>
<a href="#l14.357"></a><span id="l14.357">   // hook for extra toolbar items</span>
<a href="#l14.358"></a><span id="l14.358">   var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;].getService(Components.interfaces.nsIObserverService);</span>
<a href="#l14.359"></a><span id="l14.359">   observerService.notifyObservers(window, &quot;mail:updateStandAloneMessageCounts&quot;, &quot;&quot;);</span>
<a href="#l14.360"></a><span id="l14.360"> }</span>
<a href="#l14.361"></a><span id="l14.361"> </span>
<a href="#l14.362"></a><span id="l14.362" class="difflineminus">-nsMsgDBViewCommandUpdater.prototype =</span>
<a href="#l14.363"></a><span id="l14.363" class="difflineminus">-{</span>
<a href="#l14.364"></a><span id="l14.364" class="difflineminus">-  updateCommandStatus : function()</span>
<a href="#l14.365"></a><span id="l14.365" class="difflineminus">-    {</span>
<a href="#l14.366"></a><span id="l14.366" class="difflineminus">-      // the back end is smart and is only telling us to update command status</span>
<a href="#l14.367"></a><span id="l14.367" class="difflineminus">-      // when the # of items in the selection has actually changed.</span>
<a href="#l14.368"></a><span id="l14.368" class="difflineminus">-      UpdateMailToolbar(&quot;dbview, std alone window&quot;);</span>
<a href="#l14.369"></a><span id="l14.369" class="difflineminus">-    },</span>
<a href="#l14.370"></a><span id="l14.370" class="difflineminus">-</span>
<a href="#l14.371"></a><span id="l14.371" class="difflineminus">-  displayMessageChanged : function(aFolder, aSubject, aKeywords)</span>
<a href="#l14.372"></a><span id="l14.372" class="difflineminus">-  {</span>
<a href="#l14.373"></a><span id="l14.373" class="difflineminus">-    setTitleFromFolder(aFolder, aSubject);</span>
<a href="#l14.374"></a><span id="l14.374" class="difflineminus">-    ClearPendingReadTimer(); // we are loading / selecting a new message so kill the mark as read timer for the currently viewed message</span>
<a href="#l14.375"></a><span id="l14.375" class="difflineminus">-    gCurrentMessageUri = gDBView.URIForFirstSelectedMessage;</span>
<a href="#l14.376"></a><span id="l14.376" class="difflineminus">-    UpdateStandAloneMessageCounts();</span>
<a href="#l14.377"></a><span id="l14.377" class="difflineminus">-    goUpdateCommand(&quot;button_delete&quot;);</span>
<a href="#l14.378"></a><span id="l14.378" class="difflineminus">-    goUpdateCommand(&quot;button_junk&quot;);</span>
<a href="#l14.379"></a><span id="l14.379" class="difflineminus">-    goUpdateCommand(&quot;button_goBack&quot;);</span>
<a href="#l14.380"></a><span id="l14.380" class="difflineminus">-    goUpdateCommand(&quot;button_goForward&quot;);</span>
<a href="#l14.381"></a><span id="l14.381" class="difflineminus">-    goUpdateCommand(&quot;button_reply&quot;);</span>
<a href="#l14.382"></a><span id="l14.382" class="difflineminus">-    goUpdateCommand(&quot;button_replyall&quot;);</span>
<a href="#l14.383"></a><span id="l14.383" class="difflineminus">-    goUpdateCommand(&quot;button_replylist&quot;);</span>
<a href="#l14.384"></a><span id="l14.384" class="difflineminus">-  },</span>
<a href="#l14.385"></a><span id="l14.385" class="difflineminus">-</span>
<a href="#l14.386"></a><span id="l14.386" class="difflineminus">-  updateNextMessageAfterDelete : function()</span>
<a href="#l14.387"></a><span id="l14.387" class="difflineminus">-  {</span>
<a href="#l14.388"></a><span id="l14.388" class="difflineminus">-    SetNextMessageAfterDelete();</span>
<a href="#l14.389"></a><span id="l14.389" class="difflineminus">-  },</span>
<a href="#l14.390"></a><span id="l14.390" class="difflineminus">-</span>
<a href="#l14.391"></a><span id="l14.391" class="difflineminus">-  summarizeSelection : function() {return false},</span>
<a href="#l14.392"></a><span id="l14.392" class="difflineminus">-</span>
<a href="#l14.393"></a><span id="l14.393" class="difflineminus">-  QueryInterface : function(iid)</span>
<a href="#l14.394"></a><span id="l14.394" class="difflineminus">-  {</span>
<a href="#l14.395"></a><span id="l14.395" class="difflineminus">-    if (iid.equals(Components.interfaces.nsIMsgDBViewCommandUpdater) ||</span>
<a href="#l14.396"></a><span id="l14.396" class="difflineminus">-        iid.equals(Components.interfaces.nsISupports))</span>
<a href="#l14.397"></a><span id="l14.397" class="difflineminus">-      return this;</span>
<a href="#l14.398"></a><span id="l14.398" class="difflineminus">-</span>
<a href="#l14.399"></a><span id="l14.399" class="difflineminus">-    throw Components.results.NS_NOINTERFACE;</span>
<a href="#l14.400"></a><span id="l14.400" class="difflineminus">-  }</span>
<a href="#l14.401"></a><span id="l14.401" class="difflineminus">-}</span>
<a href="#l14.402"></a><span id="l14.402" class="difflineminus">-</span>
<a href="#l14.403"></a><span id="l14.403" class="difflineminus">-function HandleDeleteOrMoveMsgCompleted(folder)</span>
<a href="#l14.404"></a><span id="l14.404" class="difflineminus">-{</span>
<a href="#l14.405"></a><span id="l14.405" class="difflineminus">-  if ((folder.URI == gCurrentFolderUri))</span>
<a href="#l14.406"></a><span id="l14.406" class="difflineminus">-  {</span>
<a href="#l14.407"></a><span id="l14.407" class="difflineminus">-    gDBView.onDeleteCompleted(true);</span>
<a href="#l14.408"></a><span id="l14.408" class="difflineminus">-    if (gNextMessageViewIndexAfterDelete != nsMsgViewIndex_None)</span>
<a href="#l14.409"></a><span id="l14.409" class="difflineminus">-    {</span>
<a href="#l14.410"></a><span id="l14.410" class="difflineminus">-      var nextMstKey = gDBView.getKeyAt(gNextMessageViewIndexAfterDelete);</span>
<a href="#l14.411"></a><span id="l14.411" class="difflineminus">-</span>
<a href="#l14.412"></a><span id="l14.412" class="difflineminus">-      if (pref.getBoolPref(&quot;mail.close_message_window.on_delete&quot;)) {</span>
<a href="#l14.413"></a><span id="l14.413" class="difflineminus">-        // Tell the main window to select the next message since we</span>
<a href="#l14.414"></a><span id="l14.414" class="difflineminus">-        // won't be viewing it automatically in the standalone window.</span>
<a href="#l14.415"></a><span id="l14.415" class="difflineminus">-        var treeView = window.opener.document.getElementById(&quot;threadTree&quot;).view;</span>
<a href="#l14.416"></a><span id="l14.416" class="difflineminus">-        if (gDBView.removeRowOnMoveOrDelete &amp;&amp; gNextMessageViewIndexAfterDelete &gt;= 0) {</span>
<a href="#l14.417"></a><span id="l14.417" class="difflineminus">-          gDBView.suppressCommandUpdating = true;</span>
<a href="#l14.418"></a><span id="l14.418" class="difflineminus">-          treeView.selection.select(gNextMessageViewIndexAfterDelete);</span>
<a href="#l14.419"></a><span id="l14.419" class="difflineminus">-          treeView.selectionChanged();</span>
<a href="#l14.420"></a><span id="l14.420" class="difflineminus">-</span>
<a href="#l14.421"></a><span id="l14.421" class="difflineminus">-          window.opener.EnsureRowInThreadTreeIsVisible(gNextMessageViewIndexAfterDelete);</span>
<a href="#l14.422"></a><span id="l14.422" class="difflineminus">-          gDBView.suppressCommandUpdating = false;</span>
<a href="#l14.423"></a><span id="l14.423" class="difflineminus">-        }</span>
<a href="#l14.424"></a><span id="l14.424" class="difflineminus">-</span>
<a href="#l14.425"></a><span id="l14.425" class="difflineminus">-        window.close();</span>
<a href="#l14.426"></a><span id="l14.426" class="difflineminus">-      }</span>
<a href="#l14.427"></a><span id="l14.427" class="difflineminus">-      else if (nextMstKey != nsMsgKey_None) {</span>
<a href="#l14.428"></a><span id="l14.428" class="difflineminus">-        LoadMessageByViewIndex(gNextMessageViewIndexAfterDelete);</span>
<a href="#l14.429"></a><span id="l14.429" class="difflineminus">-      }</span>
<a href="#l14.430"></a><span id="l14.430" class="difflineminus">-      else {</span>
<a href="#l14.431"></a><span id="l14.431" class="difflineminus">-        window.close();</span>
<a href="#l14.432"></a><span id="l14.432" class="difflineminus">-      }</span>
<a href="#l14.433"></a><span id="l14.433" class="difflineminus">-    }</span>
<a href="#l14.434"></a><span id="l14.434" class="difflineminus">-    else</span>
<a href="#l14.435"></a><span id="l14.435" class="difflineminus">-    {</span>
<a href="#l14.436"></a><span id="l14.436" class="difflineminus">-      // close the stand alone window because there are no more messages in the folder</span>
<a href="#l14.437"></a><span id="l14.437" class="difflineminus">-      window.close();</span>
<a href="#l14.438"></a><span id="l14.438" class="difflineminus">-    }</span>
<a href="#l14.439"></a><span id="l14.439" class="difflineminus">-  }</span>
<a href="#l14.440"></a><span id="l14.440" class="difflineminus">-}</span>
<a href="#l14.441"></a><span id="l14.441" class="difflineminus">-</span>
<a href="#l14.442"></a><span id="l14.442" class="difflineminus">-function HandleDeleteOrMoveMsgFailed(folder)</span>
<a href="#l14.443"></a><span id="l14.443" class="difflineminus">-{</span>
<a href="#l14.444"></a><span id="l14.444" class="difflineminus">-  gDBView.onDeleteCompleted(false);</span>
<a href="#l14.445"></a><span id="l14.445" class="difflineminus">-}</span>
<a href="#l14.446"></a><span id="l14.446" class="difflineminus">-</span>
<a href="#l14.447"></a><span id="l14.447" class="difflineminus">-function IsCurrentLoadedFolder(folder)</span>
<a href="#l14.448"></a><span id="l14.448" class="difflineminus">-{</span>
<a href="#l14.449"></a><span id="l14.449" class="difflineminus">-  return (folder.URI == gCurrentFolderUri);</span>
<a href="#l14.450"></a><span id="l14.450" class="difflineminus">-}</span>
<a href="#l14.451"></a><span id="l14.451" class="difflineminus">-</span>
<a href="#l14.452"></a><span id="l14.452" class="difflineminus">-</span>
<a href="#l14.453"></a><span id="l14.453"> // we won't show the window until the onload() handler is finished</span>
<a href="#l14.454"></a><span id="l14.454"> // so we do this trick (suggested by hyatt / blaker)</span>
<a href="#l14.455"></a><span id="l14.455"> function OnLoadMessageWindow()</span>
<a href="#l14.456"></a><span id="l14.456"> {</span>
<a href="#l14.457"></a><span id="l14.457">   setTimeout(delayedOnLoadMessageWindow, 0); // when debugging, set this to 5000, so you can see what happens after the window comes up.</span>
<a href="#l14.458"></a><span id="l14.458"> }</span>
<a href="#l14.459"></a><span id="l14.459"> </span>
<a href="#l14.460"></a><span id="l14.460"> function delayedOnLoadMessageWindow()</span>
<a href="#l14.461"></a><span id="l14.461"> {</span>
<a href="#l14.462"></a><span id="l14.462">   HideMenus();</span>
<a href="#l14.463"></a><span id="l14.463">   ShowMenus();</span>
<a href="#l14.464"></a><span id="l14.464">   MailOfflineMgr.init();</span>
<a href="#l14.465"></a><span id="l14.465">   CreateMailWindowGlobals();</span>
<a href="#l14.466"></a><span id="l14.466">   verifyAccounts(null);</span>
<a href="#l14.467"></a><span id="l14.467"> </span>
<a href="#l14.468"></a><span id="l14.468" class="difflineplus">+  /**</span>
<a href="#l14.469"></a><span id="l14.469" class="difflineplus">+   * Create a message listener so that we can update the title once the message</span>
<a href="#l14.470"></a><span id="l14.470" class="difflineplus">+   *  finishes streaming when it's a dummy.</span>
<a href="#l14.471"></a><span id="l14.471" class="difflineplus">+   */</span>
<a href="#l14.472"></a><span id="l14.472" class="difflineplus">+  gMessageListeners.push({</span>
<a href="#l14.473"></a><span id="l14.473" class="difflineplus">+    onStartHeaders: function () {},</span>
<a href="#l14.474"></a><span id="l14.474" class="difflineplus">+    onEndHeaders: function() {</span>
<a href="#l14.475"></a><span id="l14.475" class="difflineplus">+      if (gMessageDisplay.isDummy)</span>
<a href="#l14.476"></a><span id="l14.476" class="difflineplus">+        gMessageDisplay.onDisplayingMessage(messageHeaderSink.dummyMsgHeader);</span>
<a href="#l14.477"></a><span id="l14.477" class="difflineplus">+      UpdateMailToolbar(&quot;.eml/message from attachment finished loading&quot;);</span>
<a href="#l14.478"></a><span id="l14.478" class="difflineplus">+    },</span>
<a href="#l14.479"></a><span id="l14.479" class="difflineplus">+    onEndAttachments: function () {},</span>
<a href="#l14.480"></a><span id="l14.480" class="difflineplus">+  });</span>
<a href="#l14.481"></a><span id="l14.481" class="difflineplus">+</span>
<a href="#l14.482"></a><span id="l14.482">   InitMsgWindow();</span>
<a href="#l14.483"></a><span id="l14.483"> </span>
<a href="#l14.484"></a><span id="l14.484">   messenger.setWindow(window, msgWindow);</span>
<a href="#l14.485"></a><span id="l14.485">   // FIX ME - later we will be able to use onload from the overlay</span>
<a href="#l14.486"></a><span id="l14.486">   OnLoadMsgHeaderPane();</span>
<a href="#l14.487"></a><span id="l14.487"> </span>
<a href="#l14.488"></a><span id="l14.488" class="difflineminus">-  var nsIFolderListener = Components.interfaces.nsIFolderListener;</span>
<a href="#l14.489"></a><span id="l14.489" class="difflineminus">-  var notifyFlags = nsIFolderListener.removed | nsIFolderListener.event | nsIFolderListener.intPropertyChanged;</span>
<a href="#l14.490"></a><span id="l14.490" class="difflineminus">-  Components.classes[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l14.491"></a><span id="l14.491" class="difflineminus">-            .getService(Components.interfaces.nsIMsgMailSession)</span>
<a href="#l14.492"></a><span id="l14.492" class="difflineminus">-            .AddFolderListener(folderListener, notifyFlags);</span>
<a href="#l14.493"></a><span id="l14.493" class="difflineminus">-</span>
<a href="#l14.494"></a><span id="l14.494" class="difflineminus">-  var originalView = null;</span>
<a href="#l14.495"></a><span id="l14.495" class="difflineminus">-  var folder = null;</span>
<a href="#l14.496"></a><span id="l14.496" class="difflineminus">-  var messageUri;</span>
<a href="#l14.497"></a><span id="l14.497" class="difflineminus">-  var loadCustomMessage = false;       //set to true when either loading a message/rfc822 attachment or a .eml file</span>
<a href="#l14.498"></a><span id="l14.498" class="difflineminus">-  if (window.arguments)</span>
<a href="#l14.499"></a><span id="l14.499" class="difflineminus">-  {</span>
<a href="#l14.500"></a><span id="l14.500" class="difflineminus">-    if (window.arguments[0])</span>
<a href="#l14.501"></a><span id="l14.501" class="difflineminus">-    {</span>
<a href="#l14.502"></a><span id="l14.502" class="difflineminus">-      try</span>
<a href="#l14.503"></a><span id="l14.503" class="difflineminus">-      {</span>
<a href="#l14.504"></a><span id="l14.504" class="difflineminus">-        messageUri = window.arguments[0];</span>
<a href="#l14.505"></a><span id="l14.505" class="difflineminus">-        if (messageUri instanceof Components.interfaces.nsIURI)</span>
<a href="#l14.506"></a><span id="l14.506" class="difflineminus">-        {</span>
<a href="#l14.507"></a><span id="l14.507" class="difflineminus">-          loadCustomMessage = /type=application\/x-message-display/.test(messageUri.spec);</span>
<a href="#l14.508"></a><span id="l14.508" class="difflineminus">-          gCurrentMessageUri = messageUri.spec;</span>
<a href="#l14.509"></a><span id="l14.509" class="difflineminus">-          if (messageUri.folder &amp;&amp; messageUri instanceof Components.interfaces.nsIMsgMailNewsUrl)</span>
<a href="#l14.510"></a><span id="l14.510" class="difflineminus">-            folder = messageUri.folder;</span>
<a href="#l14.511"></a><span id="l14.511" class="difflineminus">-        }</span>
<a href="#l14.512"></a><span id="l14.512" class="difflineminus">-      }</span>
<a href="#l14.513"></a><span id="l14.513" class="difflineminus">-      catch(ex)</span>
<a href="#l14.514"></a><span id="l14.514" class="difflineminus">-      {</span>
<a href="#l14.515"></a><span id="l14.515" class="difflineminus">-        folder = null;</span>
<a href="#l14.516"></a><span id="l14.516" class="difflineminus">-        dump(&quot;## ex=&quot; + ex + &quot;\n&quot;);</span>
<a href="#l14.517"></a><span id="l14.517" class="difflineminus">-      }</span>
<a href="#l14.518"></a><span id="l14.518" class="difflineminus">-</span>
<a href="#l14.519"></a><span id="l14.519" class="difflineminus">-      if (!gCurrentMessageUri)</span>
<a href="#l14.520"></a><span id="l14.520" class="difflineminus">-        gCurrentMessageUri = window.arguments[0];</span>
<a href="#l14.521"></a><span id="l14.521" class="difflineminus">-    }</span>
<a href="#l14.522"></a><span id="l14.522" class="difflineminus">-    else</span>
<a href="#l14.523"></a><span id="l14.523" class="difflineminus">-      gCurrentMessageUri = null;</span>
<a href="#l14.524"></a><span id="l14.524" class="difflineminus">-</span>
<a href="#l14.525"></a><span id="l14.525" class="difflineminus">-    if (window.arguments[1])</span>
<a href="#l14.526"></a><span id="l14.526" class="difflineminus">-      gCurrentFolderUri = window.arguments[1];</span>
<a href="#l14.527"></a><span id="l14.527" class="difflineminus">-    else</span>
<a href="#l14.528"></a><span id="l14.528" class="difflineminus">-      gCurrentFolderUri = folder ? folder.URI : null;</span>
<a href="#l14.529"></a><span id="l14.529" class="difflineminus">-</span>
<a href="#l14.530"></a><span id="l14.530" class="difflineminus">-    if (window.arguments[2])</span>
<a href="#l14.531"></a><span id="l14.531" class="difflineminus">-      originalView = window.arguments[2];</span>
<a href="#l14.532"></a><span id="l14.532" class="difflineminus">-</span>
<a href="#l14.533"></a><span id="l14.533" class="difflineminus">-  }</span>
<a href="#l14.534"></a><span id="l14.534" class="difflineminus">-</span>
<a href="#l14.535"></a><span id="l14.535" class="difflineminus">-  CreateView(originalView);</span>
<a href="#l14.536"></a><span id="l14.536" class="difflineminus">-</span>
<a href="#l14.537"></a><span id="l14.537">   gPhishingDetector.init();</span>
<a href="#l14.538"></a><span id="l14.538"> </span>
<a href="#l14.539"></a><span id="l14.539">   // initialize the customizeDone method on the customizeable toolbar</span>
<a href="#l14.540"></a><span id="l14.540">   var toolbox = document.getElementById(&quot;mail-toolbox&quot;);</span>
<a href="#l14.541"></a><span id="l14.541">   toolbox.customizeDone = function(aEvent) { MailToolboxCustomizeDone(aEvent, &quot;CustomizeMailToolbar&quot;); };</span>
<a href="#l14.542"></a><span id="l14.542"> </span>
<a href="#l14.543"></a><span id="l14.543">   var toolbarset = document.getElementById('customToolbars');</span>
<a href="#l14.544"></a><span id="l14.544">   toolbox.toolbarset = toolbarset;</span>
<a href="#l14.545"></a><span id="l14.545"> </span>
<a href="#l14.546"></a><span id="l14.546" class="difflineminus">-  setTimeout(OnLoadMessageWindowDelayed, 0, loadCustomMessage);</span>
<a href="#l14.547"></a><span id="l14.547" class="difflineplus">+  SetupCommandUpdateHandlers();</span>
<a href="#l14.548"></a><span id="l14.548"> </span>
<a href="#l14.549"></a><span id="l14.549" class="difflineminus">-  SetupCommandUpdateHandlers();</span>
<a href="#l14.550"></a><span id="l14.550" class="difflineplus">+  gMessageDisplay = new StandaloneMessageDisplayWidget();</span>
<a href="#l14.551"></a><span id="l14.551" class="difflineplus">+  gFolderDisplay = new StandaloneFolderDisplayWidget(gMessageDisplay);</span>
<a href="#l14.552"></a><span id="l14.552" class="difflineplus">+  gFolderDisplay.msgWindow = msgWindow;</span>
<a href="#l14.553"></a><span id="l14.553" class="difflineplus">+  gFolderDisplay.messenger = messenger;</span>
<a href="#l14.554"></a><span id="l14.554" class="difflineplus">+</span>
<a href="#l14.555"></a><span id="l14.555" class="difflineplus">+  setTimeout(actuallyLoadMessage, 0);</span>
<a href="#l14.556"></a><span id="l14.556"> }</span>
<a href="#l14.557"></a><span id="l14.557"> </span>
<a href="#l14.558"></a><span id="l14.558" class="difflineminus">-function OnLoadMessageWindowDelayed(loadCustomMessage)</span>
<a href="#l14.559"></a><span id="l14.559" class="difflineminus">-{</span>
<a href="#l14.560"></a><span id="l14.560" class="difflineminus">-  if (loadCustomMessage)</span>
<a href="#l14.561"></a><span id="l14.561" class="difflineminus">-  {</span>
<a href="#l14.562"></a><span id="l14.562" class="difflineminus">-    gDBView.suppressMsgDisplay = false;</span>
<a href="#l14.563"></a><span id="l14.563" class="difflineminus">-    gDBView.loadMessageByUrl(gCurrentMessageUri);</span>
<a href="#l14.564"></a><span id="l14.564" class="difflineminus">-  }</span>
<a href="#l14.565"></a><span id="l14.565" class="difflineminus">-  else</span>
<a href="#l14.566"></a><span id="l14.566" class="difflineplus">+function actuallyLoadMessage() {</span>
<a href="#l14.567"></a><span id="l14.567" class="difflineplus">+  /*</span>
<a href="#l14.568"></a><span id="l14.568" class="difflineplus">+   * Our actual use cases that drive the arguments we take are:</span>
<a href="#l14.569"></a><span id="l14.569" class="difflineplus">+   * 1) Displaying a message from disk or that was an attachment on a message.</span>
<a href="#l14.570"></a><span id="l14.570" class="difflineplus">+   *    Such messages have no (real) message header and must come in the form of</span>
<a href="#l14.571"></a><span id="l14.571" class="difflineplus">+   *    a URI.  (The message display code creates a 'dummy' header.)</span>
<a href="#l14.572"></a><span id="l14.572" class="difflineplus">+   * 2) Displaying a message that has a header available, either as a result of</span>
<a href="#l14.573"></a><span id="l14.573" class="difflineplus">+   *    the user selecting a message in another window to spawn us or through</span>
<a href="#l14.574"></a><span id="l14.574" class="difflineplus">+   *    some indirection like displaying a message by message-id.  (The</span>
<a href="#l14.575"></a><span id="l14.575" class="difflineplus">+   *    newsgroup UI exposes this, as well as the spotlight/vista indexers.)</span>
<a href="#l14.576"></a><span id="l14.576" class="difflineplus">+   *</span>
<a href="#l14.577"></a><span id="l14.577" class="difflineplus">+   * We clone views when possible for:</span>
<a href="#l14.578"></a><span id="l14.578" class="difflineplus">+   * - Consistency of navigation within the message display.  Users would find</span>
<a href="#l14.579"></a><span id="l14.579" class="difflineplus">+   *   it odd if they showed a message from a cross-folder view but ended up</span>
<a href="#l14.580"></a><span id="l14.580" class="difflineplus">+   *   navigating around the message's actual folder.</span>
<a href="#l14.581"></a><span id="l14.581" class="difflineplus">+   * - Efficiency.  It's faster to clone a view than open a new one.</span>
<a href="#l14.582"></a><span id="l14.582" class="difflineplus">+   *</span>
<a href="#l14.583"></a><span id="l14.583" class="difflineplus">+   * Our argument idioms for the use cases are thus:</span>
<a href="#l14.584"></a><span id="l14.584" class="difflineplus">+   * 1) [A Message URI] where the URI is an nsIURL corresponding to a message</span>
<a href="#l14.585"></a><span id="l14.585" class="difflineplus">+   *     on disk or that is an attachment part on another message.</span>
<a href="#l14.586"></a><span id="l14.586" class="difflineplus">+   * 2) [A Message header, (optional) the origin DBViewWraper]</span>
<a href="#l14.587"></a><span id="l14.587" class="difflineplus">+   *</span>
<a href="#l14.588"></a><span id="l14.588" class="difflineplus">+   * Our original set of arguments, in case these get passed in and you're</span>
<a href="#l14.589"></a><span id="l14.589" class="difflineplus">+   *  wondering why we explode, was:</span>
<a href="#l14.590"></a><span id="l14.590" class="difflineplus">+   *   0: A message URI, string or nsIURI.</span>
<a href="#l14.591"></a><span id="l14.591" class="difflineplus">+   *   1: A folder URI.  If arg 0 was an nsIURI, it may have had a folder attribute.</span>
<a href="#l14.592"></a><span id="l14.592" class="difflineplus">+   *   2: The nsIMsgDBView used to open us.</span>
<a href="#l14.593"></a><span id="l14.593" class="difflineplus">+   */</span>
<a href="#l14.594"></a><span id="l14.594" class="difflineplus">+  if (window.arguments &amp;&amp; window.arguments.length)</span>
<a href="#l14.595"></a><span id="l14.595">   {</span>
<a href="#l14.596"></a><span id="l14.596" class="difflineminus">-    var msgKey = extractMsgKeyFromURI(gCurrentMessageUri);</span>
<a href="#l14.597"></a><span id="l14.597" class="difflineminus">-    var viewIndex = gDBView.findIndexFromKey(msgKey, true);</span>
<a href="#l14.598"></a><span id="l14.598" class="difflineminus">-    // the message may not appear in the view if loaded from a search dialog</span>
<a href="#l14.599"></a><span id="l14.599" class="difflineminus">-    if (viewIndex != nsMsgViewIndex_None)</span>
<a href="#l14.600"></a><span id="l14.600" class="difflineminus">-      LoadMessageByViewIndex(viewIndex);</span>
<a href="#l14.601"></a><span id="l14.601" class="difflineminus">-    else</span>
<a href="#l14.602"></a><span id="l14.602" class="difflineminus">-      messenger.openURL(gCurrentMessageUri);</span>
<a href="#l14.603"></a><span id="l14.603" class="difflineplus">+    // message header?</span>
<a href="#l14.604"></a><span id="l14.604" class="difflineplus">+    if (window.arguments[0] instanceof Components.interfaces.nsIMsgDBHdr) {</span>
<a href="#l14.605"></a><span id="l14.605" class="difflineplus">+      let msgHdr = window.arguments[0];</span>
<a href="#l14.606"></a><span id="l14.606" class="difflineplus">+      let originViewWrapper = window.arguments.length &gt; 1 ?</span>
<a href="#l14.607"></a><span id="l14.607" class="difflineplus">+        window.arguments[1] : null;</span>
<a href="#l14.608"></a><span id="l14.608" class="difflineplus">+      if (originViewWrapper)</span>
<a href="#l14.609"></a><span id="l14.609" class="difflineplus">+        gFolderDisplay.cloneView(originViewWrapper);</span>
<a href="#l14.610"></a><span id="l14.610" class="difflineplus">+      else</span>
<a href="#l14.611"></a><span id="l14.611" class="difflineplus">+        gFolderDisplay.show(msgHdr.folder);</span>
<a href="#l14.612"></a><span id="l14.612" class="difflineplus">+      gFolderDisplay.selectMessage(msgHdr);</span>
<a href="#l14.613"></a><span id="l14.613" class="difflineplus">+    }</span>
<a href="#l14.614"></a><span id="l14.614" class="difflineplus">+    // it must be a URI for a message lacking a backing header</span>
<a href="#l14.615"></a><span id="l14.615" class="difflineplus">+    else {</span>
<a href="#l14.616"></a><span id="l14.616" class="difflineplus">+      // Here's how this goes.  nsMessenger::LoadURL checks out the URL we</span>
<a href="#l14.617"></a><span id="l14.617" class="difflineplus">+      //  pass it, and if it sees that the URI starts with &quot;file:&quot; or contains</span>
<a href="#l14.618"></a><span id="l14.618" class="difflineplus">+      //  &quot;type=application/x-message-display&quot; then it knows it needs to</span>
<a href="#l14.619"></a><span id="l14.619" class="difflineplus">+      //  create a dummy header.  It gets the 'dummyMsgHeader' property from</span>
<a href="#l14.620"></a><span id="l14.620" class="difflineplus">+      //  the js message header sink.</span>
<a href="#l14.621"></a><span id="l14.621" class="difflineplus">+      // Additionally, nsMessenger::MsgHdrFromURI checks the URI we pass it</span>
<a href="#l14.622"></a><span id="l14.622" class="difflineplus">+      //  and if it meets either of those same constraints (assuming it has a</span>
<a href="#l14.623"></a><span id="l14.623" class="difflineplus">+      //  msgWindow), it will retrieve the header sink off the msgWindow, get</span>
<a href="#l14.624"></a><span id="l14.624" class="difflineplus">+      //  the dummy header, and return that.</span>
<a href="#l14.625"></a><span id="l14.625" class="difflineplus">+      // so...</span>
<a href="#l14.626"></a><span id="l14.626" class="difflineplus">+      // - create a search view for the standalone dude</span>
<a href="#l14.627"></a><span id="l14.627" class="difflineplus">+      gFolderDisplay.view.openSearchView();</span>
<a href="#l14.628"></a><span id="l14.628" class="difflineplus">+      // - load the message</span>
<a href="#l14.629"></a><span id="l14.629" class="difflineplus">+      let messageURI = window.arguments[0];</span>
<a href="#l14.630"></a><span id="l14.630" class="difflineplus">+      if (messageURI instanceof Components.interfaces.nsIURI)</span>
<a href="#l14.631"></a><span id="l14.631" class="difflineplus">+        messageURI = messageURI.spec;</span>
<a href="#l14.632"></a><span id="l14.632" class="difflineplus">+      gMessageDisplay.displayExternalMessage(messageURI);</span>
<a href="#l14.633"></a><span id="l14.633" class="difflineplus">+    }</span>
<a href="#l14.634"></a><span id="l14.634">   }</span>
<a href="#l14.635"></a><span id="l14.635" class="difflineminus">-  gNextMessageViewIndexAfterDelete = gDBView.msgToSelectAfterDelete;</span>
<a href="#l14.636"></a><span id="l14.636" class="difflineminus">-  UpdateStandAloneMessageCounts();</span>
<a href="#l14.637"></a><span id="l14.637" class="difflineplus">+</span>
<a href="#l14.638"></a><span id="l14.638" class="difflineplus">+  gFolderDisplay.makeActive();</span>
<a href="#l14.639"></a><span id="l14.639"> </span>
<a href="#l14.640"></a><span id="l14.640">   // set focus to the message pane</span>
<a href="#l14.641"></a><span id="l14.641">   window.content.focus();</span>
<a href="#l14.642"></a><span id="l14.642" class="difflineminus">-</span>
<a href="#l14.643"></a><span id="l14.643" class="difflineminus">-  // since we just changed the pane with focus we need to update the toolbar to reflect this</span>
<a href="#l14.644"></a><span id="l14.644" class="difflineminus">-  // XXX TODO</span>
<a href="#l14.645"></a><span id="l14.645" class="difflineminus">-  // can we optimize</span>
<a href="#l14.646"></a><span id="l14.646" class="difflineminus">-  // and just update cmd_delete and button_delete?</span>
<a href="#l14.647"></a><span id="l14.647" class="difflineminus">-  UpdateMailToolbar(&quot;focus&quot;);</span>
<a href="#l14.648"></a><span id="l14.648" class="difflineminus">-}</span>
<a href="#l14.649"></a><span id="l14.649" class="difflineminus">-</span>
<a href="#l14.650"></a><span id="l14.650" class="difflineminus">-function CreateView(originalView)</span>
<a href="#l14.651"></a><span id="l14.651" class="difflineminus">-{</span>
<a href="#l14.652"></a><span id="l14.652" class="difflineminus">-  var msgFolder = GetLoadedMsgFolder();</span>
<a href="#l14.653"></a><span id="l14.653" class="difflineminus">-</span>
<a href="#l14.654"></a><span id="l14.654" class="difflineminus">-  // extract the sort type, the sort order,</span>
<a href="#l14.655"></a><span id="l14.655" class="difflineminus">-  var sortType;</span>
<a href="#l14.656"></a><span id="l14.656" class="difflineminus">-  var sortOrder;</span>
<a href="#l14.657"></a><span id="l14.657" class="difflineminus">-  var viewFlags;</span>
<a href="#l14.658"></a><span id="l14.658" class="difflineminus">-  var viewType;</span>
<a href="#l14.659"></a><span id="l14.659" class="difflineminus">-</span>
<a href="#l14.660"></a><span id="l14.660" class="difflineminus">-  if (originalView)</span>
<a href="#l14.661"></a><span id="l14.661" class="difflineminus">-  {</span>
<a href="#l14.662"></a><span id="l14.662" class="difflineminus">-    viewType = originalView.viewType;</span>
<a href="#l14.663"></a><span id="l14.663" class="difflineminus">-    viewFlags = originalView.viewFlags;</span>
<a href="#l14.664"></a><span id="l14.664" class="difflineminus">-    sortType = originalView.sortType;</span>
<a href="#l14.665"></a><span id="l14.665" class="difflineminus">-    sortOrder = originalView.sortOrder;</span>
<a href="#l14.666"></a><span id="l14.666" class="difflineminus">-  }</span>
<a href="#l14.667"></a><span id="l14.667" class="difflineminus">-  else if (msgFolder)</span>
<a href="#l14.668"></a><span id="l14.668" class="difflineminus">-  {</span>
<a href="#l14.669"></a><span id="l14.669" class="difflineminus">-    var msgDatabase = msgFolder.msgDatabase;</span>
<a href="#l14.670"></a><span id="l14.670" class="difflineminus">-    if (msgDatabase)</span>
<a href="#l14.671"></a><span id="l14.671" class="difflineminus">-    {</span>
<a href="#l14.672"></a><span id="l14.672" class="difflineminus">-      var dbFolderInfo = msgDatabase.dBFolderInfo;</span>
<a href="#l14.673"></a><span id="l14.673" class="difflineminus">-      sortType = dbFolderInfo.sortType;</span>
<a href="#l14.674"></a><span id="l14.674" class="difflineminus">-      sortOrder = dbFolderInfo.sortOrder;</span>
<a href="#l14.675"></a><span id="l14.675" class="difflineminus">-      viewFlags = dbFolderInfo.viewFlags;</span>
<a href="#l14.676"></a><span id="l14.676" class="difflineminus">-      viewType = dbFolderInfo.viewType;</span>
<a href="#l14.677"></a><span id="l14.677" class="difflineminus">-      msgDatabase = null;</span>
<a href="#l14.678"></a><span id="l14.678" class="difflineminus">-      dbFolderInfo = null;</span>
<a href="#l14.679"></a><span id="l14.679" class="difflineminus">-   }</span>
<a href="#l14.680"></a><span id="l14.680" class="difflineminus">-  }</span>
<a href="#l14.681"></a><span id="l14.681" class="difflineminus">-  else</span>
<a href="#l14.682"></a><span id="l14.682" class="difflineminus">-  {</span>
<a href="#l14.683"></a><span id="l14.683" class="difflineminus">-    // this is a hack to make opening a stand-alone msg window on a</span>
<a href="#l14.684"></a><span id="l14.684" class="difflineminus">-    // .eml file work. We use a search view since its much more tolerant</span>
<a href="#l14.685"></a><span id="l14.685" class="difflineminus">-    // of not having a folder.</span>
<a href="#l14.686"></a><span id="l14.686" class="difflineminus">-    viewType = nsMsgViewType.eShowSearch;</span>
<a href="#l14.687"></a><span id="l14.687" class="difflineminus">-  }</span>
<a href="#l14.688"></a><span id="l14.688" class="difflineminus">-</span>
<a href="#l14.689"></a><span id="l14.689" class="difflineminus">-  // create a db view</span>
<a href="#l14.690"></a><span id="l14.690" class="difflineminus">-  CreateBareDBView(originalView, msgFolder, viewType, viewFlags, sortType, sortOrder);</span>
<a href="#l14.691"></a><span id="l14.691" class="difflineminus">-</span>
<a href="#l14.692"></a><span id="l14.692" class="difflineminus">-  var uri;</span>
<a href="#l14.693"></a><span id="l14.693" class="difflineminus">-  if (gCurrentMessageUri)</span>
<a href="#l14.694"></a><span id="l14.694" class="difflineminus">-    uri = gCurrentMessageUri;</span>
<a href="#l14.695"></a><span id="l14.695" class="difflineminus">-  else if (gCurrentFolderUri)</span>
<a href="#l14.696"></a><span id="l14.696" class="difflineminus">-    uri = gCurrentFolderUri;</span>
<a href="#l14.697"></a><span id="l14.697" class="difflineminus">-  else</span>
<a href="#l14.698"></a><span id="l14.698" class="difflineminus">-    uri = null;</span>
<a href="#l14.699"></a><span id="l14.699" class="difflineminus">-</span>
<a href="#l14.700"></a><span id="l14.700" class="difflineminus">-  SetUpToolbarButtons(uri);</span>
<a href="#l14.701"></a><span id="l14.701" class="difflineminus">-</span>
<a href="#l14.702"></a><span id="l14.702" class="difflineminus">-  // hook for extra toolbar items</span>
<a href="#l14.703"></a><span id="l14.703" class="difflineminus">-  var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;].getService(Components.interfaces.nsIObserverService);</span>
<a href="#l14.704"></a><span id="l14.704" class="difflineminus">-  observerService.notifyObservers(window, &quot;mail:setupToolbarItems&quot;, uri);</span>
<a href="#l14.705"></a><span id="l14.705" class="difflineminus">-}</span>
<a href="#l14.706"></a><span id="l14.706" class="difflineminus">-</span>
<a href="#l14.707"></a><span id="l14.707" class="difflineminus">-function extractMsgKeyFromURI()</span>
<a href="#l14.708"></a><span id="l14.708" class="difflineminus">-{</span>
<a href="#l14.709"></a><span id="l14.709" class="difflineminus">-  var msgKey = -1;</span>
<a href="#l14.710"></a><span id="l14.710" class="difflineminus">-  var msgHdr =   messenger.msgHdrFromURI(gCurrentMessageUri);</span>
<a href="#l14.711"></a><span id="l14.711" class="difflineminus">-  if (msgHdr)</span>
<a href="#l14.712"></a><span id="l14.712" class="difflineminus">-    msgKey = msgHdr.messageKey;</span>
<a href="#l14.713"></a><span id="l14.713" class="difflineminus">-  return msgKey;</span>
<a href="#l14.714"></a><span id="l14.714"> }</span>
<a href="#l14.715"></a><span id="l14.715"> </span>
<a href="#l14.716"></a><span id="l14.716"> function ShowMenus()</span>
<a href="#l14.717"></a><span id="l14.717"> {</span>
<a href="#l14.718"></a><span id="l14.718">   var openMail3Pane_menuitem = document.getElementById('tasksMenuMail');</span>
<a href="#l14.719"></a><span id="l14.719">   if (openMail3Pane_menuitem)</span>
<a href="#l14.720"></a><span id="l14.720">     openMail3Pane_menuitem.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l14.721"></a><span id="l14.721"> }</span>
<a href="#l14.722"></a><span id="l14.722" class="difflineat">@@ -529,256 +491,108 @@ function HideMenus()</span>
<a href="#l14.723"></a><span id="l14.723">   var menuFileClose = document.getElementById('menu_close');</span>
<a href="#l14.724"></a><span id="l14.724">   var menuFileQuit = document.getElementById('menu_FileQuitItem');</span>
<a href="#l14.725"></a><span id="l14.725">   if (menuFileClose &amp;&amp; menuFileQuit)</span>
<a href="#l14.726"></a><span id="l14.726">     menuFileQuit.parentNode.replaceChild(menuFileClose, menuFileQuit);</span>
<a href="#l14.727"></a><span id="l14.727"> }</span>
<a href="#l14.728"></a><span id="l14.728"> </span>
<a href="#l14.729"></a><span id="l14.729"> function OnUnloadMessageWindow()</span>
<a href="#l14.730"></a><span id="l14.730"> {</span>
<a href="#l14.731"></a><span id="l14.731" class="difflineplus">+  gFolderDisplay.close();</span>
<a href="#l14.732"></a><span id="l14.732">   UnloadCommandUpdateHandlers();</span>
<a href="#l14.733"></a><span id="l14.733">   // FIX ME - later we will be able to use onunload from the overlay</span>
<a href="#l14.734"></a><span id="l14.734">   OnUnloadMsgHeaderPane();</span>
<a href="#l14.735"></a><span id="l14.735">   gPhishingDetector.shutdown();</span>
<a href="#l14.736"></a><span id="l14.736">   OnMailWindowUnload();</span>
<a href="#l14.737"></a><span id="l14.737"> }</span>
<a href="#l14.738"></a><span id="l14.738"> </span>
<a href="#l14.739"></a><span id="l14.739"> function GetSelectedMsgFolders()</span>
<a href="#l14.740"></a><span id="l14.740"> {</span>
<a href="#l14.741"></a><span id="l14.741" class="difflineminus">-  var folderArray = [];</span>
<a href="#l14.742"></a><span id="l14.742" class="difflineminus">-  var msgFolder = GetLoadedMsgFolder();</span>
<a href="#l14.743"></a><span id="l14.743" class="difflineminus">-  if (msgFolder)</span>
<a href="#l14.744"></a><span id="l14.744" class="difflineminus">-    folderArray[0] = msgFolder;</span>
<a href="#l14.745"></a><span id="l14.745" class="difflineminus">-</span>
<a href="#l14.746"></a><span id="l14.746" class="difflineminus">-  return folderArray;</span>
<a href="#l14.747"></a><span id="l14.747" class="difflineminus">-}</span>
<a href="#l14.748"></a><span id="l14.748" class="difflineminus">-</span>
<a href="#l14.749"></a><span id="l14.749" class="difflineminus">-function GetFirstSelectedMessage()</span>
<a href="#l14.750"></a><span id="l14.750" class="difflineminus">-{</span>
<a href="#l14.751"></a><span id="l14.751" class="difflineminus">-  return GetLoadedMessage();</span>
<a href="#l14.752"></a><span id="l14.752" class="difflineplus">+  if (gFolderDisplay.displayedFolder)</span>
<a href="#l14.753"></a><span id="l14.753" class="difflineplus">+    return [gFolderDisplay.displayedFolder];</span>
<a href="#l14.754"></a><span id="l14.754" class="difflineplus">+  return [];</span>
<a href="#l14.755"></a><span id="l14.755"> }</span>
<a href="#l14.756"></a><span id="l14.756"> </span>
<a href="#l14.757"></a><span id="l14.757"> function GetNumSelectedMessages()</span>
<a href="#l14.758"></a><span id="l14.758"> {</span>
<a href="#l14.759"></a><span id="l14.759" class="difflineminus">-  if (gCurrentMessageUri)</span>
<a href="#l14.760"></a><span id="l14.760" class="difflineminus">-    return 1;</span>
<a href="#l14.761"></a><span id="l14.761" class="difflineminus">-  else</span>
<a href="#l14.762"></a><span id="l14.762" class="difflineminus">-    return 0;</span>
<a href="#l14.763"></a><span id="l14.763" class="difflineminus">-}</span>
<a href="#l14.764"></a><span id="l14.764" class="difflineminus">-</span>
<a href="#l14.765"></a><span id="l14.765" class="difflineminus">-function GetSelectedMessages()</span>
<a href="#l14.766"></a><span id="l14.766" class="difflineminus">-{</span>
<a href="#l14.767"></a><span id="l14.767" class="difflineminus">-  var messageArray = new Array(1);</span>
<a href="#l14.768"></a><span id="l14.768" class="difflineminus">-  var message = GetLoadedMessage();</span>
<a href="#l14.769"></a><span id="l14.769" class="difflineminus">-  if (message)</span>
<a href="#l14.770"></a><span id="l14.770" class="difflineminus">-    messageArray[0] = message;</span>
<a href="#l14.771"></a><span id="l14.771" class="difflineminus">-</span>
<a href="#l14.772"></a><span id="l14.772" class="difflineminus">-  return messageArray;</span>
<a href="#l14.773"></a><span id="l14.773" class="difflineminus">-}</span>
<a href="#l14.774"></a><span id="l14.774" class="difflineminus">-</span>
<a href="#l14.775"></a><span id="l14.775" class="difflineminus">-function GetSelectedIndices(dbView)</span>
<a href="#l14.776"></a><span id="l14.776" class="difflineminus">-{</span>
<a href="#l14.777"></a><span id="l14.777" class="difflineminus">-  try {</span>
<a href="#l14.778"></a><span id="l14.778" class="difflineminus">-    return dbView.getIndicesForSelection({});</span>
<a href="#l14.779"></a><span id="l14.779" class="difflineminus">-  }</span>
<a href="#l14.780"></a><span id="l14.780" class="difflineminus">-  catch (ex) {</span>
<a href="#l14.781"></a><span id="l14.781" class="difflineminus">-    dump(&quot;ex = &quot; + ex + &quot;\n&quot;);</span>
<a href="#l14.782"></a><span id="l14.782" class="difflineminus">-    return null;</span>
<a href="#l14.783"></a><span id="l14.783" class="difflineminus">-  }</span>
<a href="#l14.784"></a><span id="l14.784" class="difflineminus">-}</span>
<a href="#l14.785"></a><span id="l14.785" class="difflineminus">-</span>
<a href="#l14.786"></a><span id="l14.786" class="difflineminus">-function GetLoadedMsgFolder()</span>
<a href="#l14.787"></a><span id="l14.787" class="difflineminus">-{</span>
<a href="#l14.788"></a><span id="l14.788" class="difflineminus">-  return (gCurrentFolderUri) ? GetMsgFolderFromUri(gCurrentFolderUri) : null;</span>
<a href="#l14.789"></a><span id="l14.789" class="difflineminus">-}</span>
<a href="#l14.790"></a><span id="l14.790" class="difflineminus">-</span>
<a href="#l14.791"></a><span id="l14.791" class="difflineminus">-function GetSelectedFolderURI()</span>
<a href="#l14.792"></a><span id="l14.792" class="difflineminus">-{</span>
<a href="#l14.793"></a><span id="l14.793" class="difflineminus">-  return gCurrentFolderUri;</span>
<a href="#l14.794"></a><span id="l14.794" class="difflineminus">-}</span>
<a href="#l14.795"></a><span id="l14.795" class="difflineminus">-</span>
<a href="#l14.796"></a><span id="l14.796" class="difflineminus">-function GetLoadedMessage()</span>
<a href="#l14.797"></a><span id="l14.797" class="difflineminus">-{</span>
<a href="#l14.798"></a><span id="l14.798" class="difflineminus">-  return gCurrentMessageUri;</span>
<a href="#l14.799"></a><span id="l14.799" class="difflineminus">-}</span>
<a href="#l14.800"></a><span id="l14.800" class="difflineminus">-</span>
<a href="#l14.801"></a><span id="l14.801" class="difflineminus">-//Clear everything related to the current message. called after load start page.</span>
<a href="#l14.802"></a><span id="l14.802" class="difflineminus">-function ClearMessageSelection()</span>
<a href="#l14.803"></a><span id="l14.803" class="difflineminus">-{</span>
<a href="#l14.804"></a><span id="l14.804" class="difflineminus">-  gCurrentMessageUri = null;</span>
<a href="#l14.805"></a><span id="l14.805" class="difflineminus">-  gCurrentFolderUri = null;</span>
<a href="#l14.806"></a><span id="l14.806" class="difflineminus">-  UpdateMailToolbar(&quot;clear msg, std alone window&quot;);</span>
<a href="#l14.807"></a><span id="l14.807" class="difflineminus">-}</span>
<a href="#l14.808"></a><span id="l14.808" class="difflineminus">-</span>
<a href="#l14.809"></a><span id="l14.809" class="difflineminus">-function SetNextMessageAfterDelete()</span>
<a href="#l14.810"></a><span id="l14.810" class="difflineminus">-{</span>
<a href="#l14.811"></a><span id="l14.811" class="difflineminus">-  gNextMessageViewIndexAfterDelete = gDBView.msgToSelectAfterDelete;</span>
<a href="#l14.812"></a><span id="l14.812" class="difflineminus">-}</span>
<a href="#l14.813"></a><span id="l14.813" class="difflineminus">-</span>
<a href="#l14.814"></a><span id="l14.814" class="difflineminus">-function SelectFolder(folderUri)</span>
<a href="#l14.815"></a><span id="l14.815" class="difflineminus">-{</span>
<a href="#l14.816"></a><span id="l14.816" class="difflineminus">-  if (folderUri == gCurrentFolderUri)</span>
<a href="#l14.817"></a><span id="l14.817" class="difflineminus">-    return;</span>
<a href="#l14.818"></a><span id="l14.818" class="difflineminus">-</span>
<a href="#l14.819"></a><span id="l14.819" class="difflineminus">-  var msgfolder = GetMsgFolderFromUri(folderUri)</span>
<a href="#l14.820"></a><span id="l14.820" class="difflineminus">-  if (!msgfolder || msgfolder.isServer)</span>
<a href="#l14.821"></a><span id="l14.821" class="difflineminus">-    return;</span>
<a href="#l14.822"></a><span id="l14.822" class="difflineminus">-</span>
<a href="#l14.823"></a><span id="l14.823" class="difflineminus">-  // close old folder view</span>
<a href="#l14.824"></a><span id="l14.824" class="difflineminus">-  var dbview = GetDBView();</span>
<a href="#l14.825"></a><span id="l14.825" class="difflineminus">-  if (dbview)</span>
<a href="#l14.826"></a><span id="l14.826" class="difflineminus">-    dbview.close();</span>
<a href="#l14.827"></a><span id="l14.827" class="difflineminus">-</span>
<a href="#l14.828"></a><span id="l14.828" class="difflineminus">-  gCurrentFolderToRerootForStandAlone = folderUri;</span>
<a href="#l14.829"></a><span id="l14.829" class="difflineminus">-  msgWindow.openFolder = msgfolder;</span>
<a href="#l14.830"></a><span id="l14.830" class="difflineminus">-</span>
<a href="#l14.831"></a><span id="l14.831" class="difflineminus">-  if (msgfolder.manyHeadersToDownload)</span>
<a href="#l14.832"></a><span id="l14.832" class="difflineminus">-  {</span>
<a href="#l14.833"></a><span id="l14.833" class="difflineminus">-    gRerootOnFolderLoadForStandAlone = true;</span>
<a href="#l14.834"></a><span id="l14.834" class="difflineminus">-    try</span>
<a href="#l14.835"></a><span id="l14.835" class="difflineminus">-    {</span>
<a href="#l14.836"></a><span id="l14.836" class="difflineminus">-      // accessing the db causes the folder loaded notification to get sent</span>
<a href="#l14.837"></a><span id="l14.837" class="difflineminus">-      // for local folders.</span>
<a href="#l14.838"></a><span id="l14.838" class="difflineminus">-      var db = msgfolder.msgDatabase;</span>
<a href="#l14.839"></a><span id="l14.839" class="difflineminus">-      msgfolder.startFolderLoading();</span>
<a href="#l14.840"></a><span id="l14.840" class="difflineminus">-      msgfolder.updateFolder(msgWindow);</span>
<a href="#l14.841"></a><span id="l14.841" class="difflineminus">-    }</span>
<a href="#l14.842"></a><span id="l14.842" class="difflineminus">-    catch(ex)</span>
<a href="#l14.843"></a><span id="l14.843" class="difflineminus">-    {</span>
<a href="#l14.844"></a><span id="l14.844" class="difflineminus">-      dump(&quot;Error loading with many headers to download: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l14.845"></a><span id="l14.845" class="difflineminus">-    }</span>
<a href="#l14.846"></a><span id="l14.846" class="difflineminus">-  }</span>
<a href="#l14.847"></a><span id="l14.847" class="difflineminus">-  else</span>
<a href="#l14.848"></a><span id="l14.848" class="difflineminus">-  {</span>
<a href="#l14.849"></a><span id="l14.849" class="difflineminus">-    RerootFolderForStandAlone(folderUri);</span>
<a href="#l14.850"></a><span id="l14.850" class="difflineminus">-    gRerootOnFolderLoadForStandAlone = false;</span>
<a href="#l14.851"></a><span id="l14.851" class="difflineminus">-    msgfolder.startFolderLoading();</span>
<a href="#l14.852"></a><span id="l14.852" class="difflineminus">-</span>
<a href="#l14.853"></a><span id="l14.853" class="difflineminus">-    //Need to do this after rerooting folder.  Otherwise possibility of receiving folder loaded</span>
<a href="#l14.854"></a><span id="l14.854" class="difflineminus">-    //notification before folder has actually changed.</span>
<a href="#l14.855"></a><span id="l14.855" class="difflineminus">-    msgfolder.updateFolder(msgWindow);</span>
<a href="#l14.856"></a><span id="l14.856" class="difflineminus">-  }</span>
<a href="#l14.857"></a><span id="l14.857" class="difflineminus">-}</span>
<a href="#l14.858"></a><span id="l14.858" class="difflineminus">-</span>
<a href="#l14.859"></a><span id="l14.859" class="difflineminus">-function RerootFolderForStandAlone(uri)</span>
<a href="#l14.860"></a><span id="l14.860" class="difflineminus">-{</span>
<a href="#l14.861"></a><span id="l14.861" class="difflineminus">-  gCurrentFolderUri = uri;</span>
<a href="#l14.862"></a><span id="l14.862" class="difflineminus">-</span>
<a href="#l14.863"></a><span id="l14.863" class="difflineminus">-  // create new folder view</span>
<a href="#l14.864"></a><span id="l14.864" class="difflineminus">-  CreateView(null);</span>
<a href="#l14.865"></a><span id="l14.865" class="difflineminus">-</span>
<a href="#l14.866"></a><span id="l14.866" class="difflineminus">-  if (gMessageToLoad != nsMsgKey_None)</span>
<a href="#l14.867"></a><span id="l14.867" class="difflineminus">-  {</span>
<a href="#l14.868"></a><span id="l14.868" class="difflineminus">-    LoadMessageByMsgKey(gMessageToLoad);</span>
<a href="#l14.869"></a><span id="l14.869" class="difflineminus">-    gMessageToLoad = nsMsgKey_None;</span>
<a href="#l14.870"></a><span id="l14.870" class="difflineminus">-  }</span>
<a href="#l14.871"></a><span id="l14.871" class="difflineminus">-  // now do the work to load the appropriate message</span>
<a href="#l14.872"></a><span id="l14.872" class="difflineminus">-  else if (gNextMessageAfterLoad) {</span>
<a href="#l14.873"></a><span id="l14.873" class="difflineminus">-    var type = gNextMessageAfterLoad;</span>
<a href="#l14.874"></a><span id="l14.874" class="difflineminus">-    gNextMessageAfterLoad = null;</span>
<a href="#l14.875"></a><span id="l14.875" class="difflineminus">-    LoadMessageByNavigationType(type);</span>
<a href="#l14.876"></a><span id="l14.876" class="difflineminus">-  }</span>
<a href="#l14.877"></a><span id="l14.877" class="difflineminus">-</span>
<a href="#l14.878"></a><span id="l14.878" class="difflineminus">-  SetUpToolbarButtons(gCurrentFolderUri);</span>
<a href="#l14.879"></a><span id="l14.879" class="difflineminus">-</span>
<a href="#l14.880"></a><span id="l14.880" class="difflineminus">-  UpdateMailToolbar(&quot;reroot folder in stand alone window&quot;);</span>
<a href="#l14.881"></a><span id="l14.881" class="difflineminus">-</span>
<a href="#l14.882"></a><span id="l14.882" class="difflineminus">-  // hook for extra toolbar items</span>
<a href="#l14.883"></a><span id="l14.883" class="difflineminus">-  var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;].getService(Components.interfaces.nsIObserverService);</span>
<a href="#l14.884"></a><span id="l14.884" class="difflineminus">-  observerService.notifyObservers(window, &quot;mail:setupToolbarItems&quot;, uri);</span>
<a href="#l14.885"></a><span id="l14.885" class="difflineminus">-}</span>
<a href="#l14.886"></a><span id="l14.886" class="difflineminus">-</span>
<a href="#l14.887"></a><span id="l14.887" class="difflineminus">-function GetMsgHdrFromUri(messageUri)</span>
<a href="#l14.888"></a><span id="l14.888" class="difflineminus">-{</span>
<a href="#l14.889"></a><span id="l14.889" class="difflineminus">-  return messenger.msgHdrFromURI(messageUri);</span>
<a href="#l14.890"></a><span id="l14.890" class="difflineminus">-}</span>
<a href="#l14.891"></a><span id="l14.891" class="difflineminus">-</span>
<a href="#l14.892"></a><span id="l14.892" class="difflineminus">-function SelectMessage(messageUri)</span>
<a href="#l14.893"></a><span id="l14.893" class="difflineminus">-{</span>
<a href="#l14.894"></a><span id="l14.894" class="difflineminus">-  var msgHdr = GetMsgHdrFromUri(messageUri);</span>
<a href="#l14.895"></a><span id="l14.895" class="difflineminus">-  LoadMessageByMsgKey(msgHdr.messageKey);</span>
<a href="#l14.896"></a><span id="l14.896" class="difflineplus">+  return gFolderDisplay.treeSelection.count;</span>
<a href="#l14.897"></a><span id="l14.897"> }</span>
<a href="#l14.898"></a><span id="l14.898"> </span>
<a href="#l14.899"></a><span id="l14.899"> function ReloadMessage()</span>
<a href="#l14.900"></a><span id="l14.900"> {</span>
<a href="#l14.901"></a><span id="l14.901" class="difflineminus">-  gDBView.reloadMessage();</span>
<a href="#l14.902"></a><span id="l14.902" class="difflineplus">+  gFolderDisplay.view.dbView.reloadMessage();</span>
<a href="#l14.903"></a><span id="l14.903"> }</span>
<a href="#l14.904"></a><span id="l14.904"> </span>
<a href="#l14.905"></a><span id="l14.905"> function MsgDeleteMessageFromMessageWindow(reallyDelete, fromToolbar)</span>
<a href="#l14.906"></a><span id="l14.906"> {</span>
<a href="#l14.907"></a><span id="l14.907">   // if from the toolbar, return right away if this is a news message</span>
<a href="#l14.908"></a><span id="l14.908">   // only allow cancel from the menu:  &quot;Edit | Cancel / Delete Message&quot;</span>
<a href="#l14.909"></a><span id="l14.909" class="difflineminus">-  if (fromToolbar)</span>
<a href="#l14.910"></a><span id="l14.910" class="difflineminus">-  {</span>
<a href="#l14.911"></a><span id="l14.911" class="difflineminus">-    if (isNewsURI(gCurrentFolderUri))</span>
<a href="#l14.912"></a><span id="l14.912" class="difflineminus">-    {</span>
<a href="#l14.913"></a><span id="l14.913" class="difflineminus">-        // if news, don't delete</span>
<a href="#l14.914"></a><span id="l14.914" class="difflineminus">-        return;</span>
<a href="#l14.915"></a><span id="l14.915" class="difflineminus">-    }</span>
<a href="#l14.916"></a><span id="l14.916" class="difflineminus">-  }</span>
<a href="#l14.917"></a><span id="l14.917" class="difflineplus">+  if (fromToolbar &amp;&amp; gDisplayFolder.view.isNewsFolder)</span>
<a href="#l14.918"></a><span id="l14.918" class="difflineplus">+      return;</span>
<a href="#l14.919"></a><span id="l14.919"> </span>
<a href="#l14.920"></a><span id="l14.920" class="difflineminus">-  // before we delete</span>
<a href="#l14.921"></a><span id="l14.921" class="difflineminus">-  SetNextMessageAfterDelete();</span>
<a href="#l14.922"></a><span id="l14.922" class="difflineplus">+  gFolderDisplay.hintAboutToDeleteMessages();</span>
<a href="#l14.923"></a><span id="l14.923"> </span>
<a href="#l14.924"></a><span id="l14.924">   if (reallyDelete)</span>
<a href="#l14.925"></a><span id="l14.925" class="difflineminus">-      gDBView.doCommand(nsMsgViewCommandType.deleteNoTrash);</span>
<a href="#l14.926"></a><span id="l14.926" class="difflineplus">+    gFolderDisplay.doCommand(nsMsgViewCommandType.deleteNoTrash);</span>
<a href="#l14.927"></a><span id="l14.927">   else</span>
<a href="#l14.928"></a><span id="l14.928" class="difflineminus">-      gDBView.doCommand(nsMsgViewCommandType.deleteMsg);</span>
<a href="#l14.929"></a><span id="l14.929" class="difflineplus">+    gFolderDisplay.doCommand(nsMsgViewCommandType.deleteMsg);</span>
<a href="#l14.930"></a><span id="l14.930"> }</span>
<a href="#l14.931"></a><span id="l14.931"> </span>
<a href="#l14.932"></a><span id="l14.932"> // MessageWindowController object (handles commands when one of the trees does not have focus)</span>
<a href="#l14.933"></a><span id="l14.933"> var MessageWindowController =</span>
<a href="#l14.934"></a><span id="l14.934"> {</span>
<a href="#l14.935"></a><span id="l14.935">    supportsCommand: function(command)</span>
<a href="#l14.936"></a><span id="l14.936">   {</span>
<a href="#l14.937"></a><span id="l14.937">     switch ( command )</span>
<a href="#l14.938"></a><span id="l14.938">     {</span>
<a href="#l14.939"></a><span id="l14.939" class="difflineplus">+      // external messages cannot be deleted, mutated, or subjected to filtering</span>
<a href="#l14.940"></a><span id="l14.940">       case &quot;cmd_delete&quot;:</span>
<a href="#l14.941"></a><span id="l14.941" class="difflineminus">-      case &quot;cmd_undo&quot;:</span>
<a href="#l14.942"></a><span id="l14.942" class="difflineminus">-      case &quot;cmd_redo&quot;:</span>
<a href="#l14.943"></a><span id="l14.943">       case &quot;cmd_killThread&quot;:</span>
<a href="#l14.944"></a><span id="l14.944">       case &quot;cmd_killSubthread&quot;:</span>
<a href="#l14.945"></a><span id="l14.945">       case &quot;cmd_watchThread&quot;:</span>
<a href="#l14.946"></a><span id="l14.946">       case &quot;button_delete&quot;:</span>
<a href="#l14.947"></a><span id="l14.947">       case &quot;button_junk&quot;:</span>
<a href="#l14.948"></a><span id="l14.948">       case &quot;cmd_shiftDelete&quot;:</span>
<a href="#l14.949"></a><span id="l14.949" class="difflineminus">-      case &quot;cmd_saveAsFile&quot;:</span>
<a href="#l14.950"></a><span id="l14.950" class="difflineminus">-      case &quot;cmd_saveAsTemplate&quot;:</span>
<a href="#l14.951"></a><span id="l14.951" class="difflineminus">-      case &quot;cmd_viewPageSource&quot;:</span>
<a href="#l14.952"></a><span id="l14.952" class="difflineminus">-      case &quot;cmd_getMsgsForAuthAccounts&quot;:</span>
<a href="#l14.953"></a><span id="l14.953">       case &quot;cmd_tag&quot;:</span>
<a href="#l14.954"></a><span id="l14.954">       case &quot;button_mark&quot;:</span>
<a href="#l14.955"></a><span id="l14.955">       case &quot;cmd_markAsRead&quot;:</span>
<a href="#l14.956"></a><span id="l14.956">       case &quot;cmd_markAllRead&quot;:</span>
<a href="#l14.957"></a><span id="l14.957">       case &quot;cmd_markThreadAsRead&quot;:</span>
<a href="#l14.958"></a><span id="l14.958">       case &quot;cmd_markReadByDate&quot;:</span>
<a href="#l14.959"></a><span id="l14.959">       case &quot;cmd_markAsFlagged&quot;:</span>
<a href="#l14.960"></a><span id="l14.960" class="difflineminus">-      case &quot;button_file&quot;:</span>
<a href="#l14.961"></a><span id="l14.961" class="difflineminus">-      case &quot;cmd_file&quot;:</span>
<a href="#l14.962"></a><span id="l14.962">       case &quot;cmd_markAsJunk&quot;:</span>
<a href="#l14.963"></a><span id="l14.963">       case &quot;cmd_markAsNotJunk&quot;:</span>
<a href="#l14.964"></a><span id="l14.964">       case &quot;cmd_recalculateJunkScore&quot;:</span>
<a href="#l14.965"></a><span id="l14.965">       case &quot;cmd_applyFiltersToSelection&quot;:</span>
<a href="#l14.966"></a><span id="l14.966">       case &quot;cmd_applyFilters&quot;:</span>
<a href="#l14.967"></a><span id="l14.967">       case &quot;cmd_runJunkControls&quot;:</span>
<a href="#l14.968"></a><span id="l14.968">       case &quot;cmd_deleteJunk&quot;:</span>
<a href="#l14.969"></a><span id="l14.969" class="difflineplus">+        return !gMessageDisplay.isDummy;</span>
<a href="#l14.970"></a><span id="l14.970" class="difflineplus">+      case &quot;cmd_undo&quot;:</span>
<a href="#l14.971"></a><span id="l14.971" class="difflineplus">+      case &quot;cmd_redo&quot;:</span>
<a href="#l14.972"></a><span id="l14.972" class="difflineplus">+      case &quot;cmd_saveAsFile&quot;:</span>
<a href="#l14.973"></a><span id="l14.973" class="difflineplus">+      case &quot;cmd_saveAsTemplate&quot;:</span>
<a href="#l14.974"></a><span id="l14.974" class="difflineplus">+      case &quot;cmd_viewPageSource&quot;:</span>
<a href="#l14.975"></a><span id="l14.975" class="difflineplus">+      case &quot;cmd_getMsgsForAuthAccounts&quot;:</span>
<a href="#l14.976"></a><span id="l14.976" class="difflineplus">+      case &quot;button_file&quot;:</span>
<a href="#l14.977"></a><span id="l14.977" class="difflineplus">+      case &quot;cmd_file&quot;:</span>
<a href="#l14.978"></a><span id="l14.978">       case &quot;cmd_nextMsg&quot;:</span>
<a href="#l14.979"></a><span id="l14.979">       case &quot;button_next&quot;:</span>
<a href="#l14.980"></a><span id="l14.980">       case &quot;button_previous&quot;:</span>
<a href="#l14.981"></a><span id="l14.981">       case &quot;cmd_nextUnreadMsg&quot;:</span>
<a href="#l14.982"></a><span id="l14.982">       case &quot;cmd_nextFlaggedMsg&quot;:</span>
<a href="#l14.983"></a><span id="l14.983">       case &quot;cmd_nextUnreadThread&quot;:</span>
<a href="#l14.984"></a><span id="l14.984">       case &quot;cmd_previousMsg&quot;:</span>
<a href="#l14.985"></a><span id="l14.985">       case &quot;cmd_previousUnreadMsg&quot;:</span>
<a href="#l14.986"></a><span id="l14.986">       case &quot;cmd_previousFlaggedMsg&quot;:</span>
<a href="#l14.987"></a><span id="l14.987">       case &quot;cmd_goForward&quot;:</span>
<a href="#l14.988"></a><span id="l14.988">       case &quot;cmd_goBack&quot;:</span>
<a href="#l14.989"></a><span id="l14.989">       case &quot;button_goForward&quot;:</span>
<a href="#l14.990"></a><span id="l14.990">       case &quot;button_goBack&quot;:</span>
<a href="#l14.991"></a><span id="l14.991" class="difflineminus">-        return !(gDBView.keyForFirstSelectedMessage == nsMsgKey_None);</span>
<a href="#l14.992"></a><span id="l14.992" class="difflineplus">+        return gFolderDisplay.selectedMessage != null;</span>
<a href="#l14.993"></a><span id="l14.993"> </span>
<a href="#l14.994"></a><span id="l14.994">       case &quot;cmd_reply&quot;:</span>
<a href="#l14.995"></a><span id="l14.995">       case &quot;button_reply&quot;:</span>
<a href="#l14.996"></a><span id="l14.996">       case &quot;cmd_replySender&quot;:</span>
<a href="#l14.997"></a><span id="l14.997">       case &quot;cmd_replyGroup&quot;:</span>
<a href="#l14.998"></a><span id="l14.998">       case &quot;cmd_replyall&quot;:</span>
<a href="#l14.999"></a><span id="l14.999">       case &quot;button_replyall&quot;:</span>
<a href="#l14.1000"></a><span id="l14.1000">       case &quot;cmd_replylist&quot;:</span>
<a href="#l14.1001"></a><span id="l14.1001" class="difflineat">@@ -817,42 +631,45 @@ var MessageWindowController =</span>
<a href="#l14.1002"></a><span id="l14.1002">         return MailOfflineMgr.isOnline();</span>
<a href="#l14.1003"></a><span id="l14.1003">       default:</span>
<a href="#l14.1004"></a><span id="l14.1004">         return false;</span>
<a href="#l14.1005"></a><span id="l14.1005">     }</span>
<a href="#l14.1006"></a><span id="l14.1006">   },</span>
<a href="#l14.1007"></a><span id="l14.1007"> </span>
<a href="#l14.1008"></a><span id="l14.1008">   isCommandEnabled: function(command)</span>
<a href="#l14.1009"></a><span id="l14.1009">   {</span>
<a href="#l14.1010"></a><span id="l14.1010" class="difflineplus">+    let loadedFolder;</span>
<a href="#l14.1011"></a><span id="l14.1011">     switch ( command )</span>
<a href="#l14.1012"></a><span id="l14.1012">     {</span>
<a href="#l14.1013"></a><span id="l14.1013">       case &quot;cmd_createFilterFromPopup&quot;:</span>
<a href="#l14.1014"></a><span id="l14.1014">       case &quot;cmd_createFilterFromMenu&quot;:</span>
<a href="#l14.1015"></a><span id="l14.1015" class="difflineminus">-        var loadedFolder = GetLoadedMsgFolder();</span>
<a href="#l14.1016"></a><span id="l14.1016" class="difflineplus">+        loadedFolder = gFolderDisplay.displayedFolder;</span>
<a href="#l14.1017"></a><span id="l14.1017">         if (!(loadedFolder &amp;&amp; loadedFolder.server.canHaveFilters))</span>
<a href="#l14.1018"></a><span id="l14.1018">           return false;</span>
<a href="#l14.1019"></a><span id="l14.1019">       case &quot;cmd_delete&quot;:</span>
<a href="#l14.1020"></a><span id="l14.1020">         UpdateDeleteCommand();</span>
<a href="#l14.1021"></a><span id="l14.1021">         // fall through</span>
<a href="#l14.1022"></a><span id="l14.1022">       case &quot;button_delete&quot;:</span>
<a href="#l14.1023"></a><span id="l14.1023">         UpdateDeleteToolbarButton();</span>
<a href="#l14.1024"></a><span id="l14.1024">         // fall through</span>
<a href="#l14.1025"></a><span id="l14.1025">       case &quot;cmd_shiftDelete&quot;:</span>
<a href="#l14.1026"></a><span id="l14.1026" class="difflineminus">-        var loadedFolder = GetLoadedMsgFolder();</span>
<a href="#l14.1027"></a><span id="l14.1027" class="difflineminus">-        return gCurrentMessageUri &amp;&amp; loadedFolder &amp;&amp; (loadedFolder.canDeleteMessages || isNewsURI(gCurrentFolderUri));</span>
<a href="#l14.1028"></a><span id="l14.1028" class="difflineplus">+        return gFolderDisplay.selectedMessage &amp;&amp;</span>
<a href="#l14.1029"></a><span id="l14.1029" class="difflineplus">+               gFolderDisplay.displayedFolder &amp;&amp;</span>
<a href="#l14.1030"></a><span id="l14.1030" class="difflineplus">+               (gFolderDisplay.displayedFolder.canDeleteMessages ||</span>
<a href="#l14.1031"></a><span id="l14.1031" class="difflineplus">+                gFolderDisplay.view.isNewsFolder);</span>
<a href="#l14.1032"></a><span id="l14.1032">       case &quot;button_junk&quot;:</span>
<a href="#l14.1033"></a><span id="l14.1033">         UpdateJunkToolbarButton();</span>
<a href="#l14.1034"></a><span id="l14.1034">         // fall through</span>
<a href="#l14.1035"></a><span id="l14.1035">       case &quot;cmd_markAsJunk&quot;:</span>
<a href="#l14.1036"></a><span id="l14.1036">       case &quot;cmd_markAsNotJunk&quot;:</span>
<a href="#l14.1037"></a><span id="l14.1037">       case &quot;cmd_recalculateJunkScore&quot;:</span>
<a href="#l14.1038"></a><span id="l14.1038">         // can't do junk on news yet</span>
<a href="#l14.1039"></a><span id="l14.1039" class="difflineminus">-        return (!isNewsURI(gCurrentFolderUri));</span>
<a href="#l14.1040"></a><span id="l14.1040" class="difflineplus">+        return (!gFolderDisplay.view.isNewsFolder);</span>
<a href="#l14.1041"></a><span id="l14.1041">       case &quot;button_archive&quot;:</span>
<a href="#l14.1042"></a><span id="l14.1042" class="difflineminus">-        var folder = GetLoadedMsgFolder();</span>
<a href="#l14.1043"></a><span id="l14.1043" class="difflineplus">+        var folder = gFolderDisplay.displayedFolder;</span>
<a href="#l14.1044"></a><span id="l14.1044">         return folder &amp;&amp;</span>
<a href="#l14.1045"></a><span id="l14.1045">           !(IsSpecialFolder(folder, Components.interfaces.nsMsgFolderFlags.Archive,</span>
<a href="#l14.1046"></a><span id="l14.1046">                             true));</span>
<a href="#l14.1047"></a><span id="l14.1047">       case &quot;cmd_archive&quot;:</span>
<a href="#l14.1048"></a><span id="l14.1048">       case &quot;cmd_reply&quot;:</span>
<a href="#l14.1049"></a><span id="l14.1049">       case &quot;button_reply&quot;:</span>
<a href="#l14.1050"></a><span id="l14.1050">       case &quot;cmd_replySender&quot;:</span>
<a href="#l14.1051"></a><span id="l14.1051">       case &quot;cmd_replyGroup&quot;:</span>
<a href="#l14.1052"></a><span id="l14.1052" class="difflineat">@@ -878,17 +695,17 @@ var MessageWindowController =</span>
<a href="#l14.1053"></a><span id="l14.1053">       case &quot;cmd_markAsRead&quot;:</span>
<a href="#l14.1054"></a><span id="l14.1054">       case &quot;cmd_markAllRead&quot;:</span>
<a href="#l14.1055"></a><span id="l14.1055">       case &quot;cmd_markThreadAsRead&quot;:</span>
<a href="#l14.1056"></a><span id="l14.1056">       case &quot;cmd_markReadByDate&quot;:</span>
<a href="#l14.1057"></a><span id="l14.1057">         return(true);</span>
<a href="#l14.1058"></a><span id="l14.1058">       case &quot;cmd_markAsFlagged&quot;:</span>
<a href="#l14.1059"></a><span id="l14.1059">       case &quot;button_file&quot;:</span>
<a href="#l14.1060"></a><span id="l14.1060">       case &quot;cmd_file&quot;:</span>
<a href="#l14.1061"></a><span id="l14.1061" class="difflineminus">-        return ( gCurrentMessageUri != null);</span>
<a href="#l14.1062"></a><span id="l14.1062" class="difflineplus">+        return ( gFolderDisplay.selectedMessage != null);</span>
<a href="#l14.1063"></a><span id="l14.1063">       case &quot;cmd_printSetup&quot;:</span>
<a href="#l14.1064"></a><span id="l14.1064">         return true;</span>
<a href="#l14.1065"></a><span id="l14.1065">       case &quot;cmd_getNewMessages&quot;:</span>
<a href="#l14.1066"></a><span id="l14.1066">       case &quot;button_getNewMessages&quot;:</span>
<a href="#l14.1067"></a><span id="l14.1067">       case &quot;cmd_getMsgsForAuthAccounts&quot;:</span>
<a href="#l14.1068"></a><span id="l14.1068">         // GetMsgs should always be enabled, see bugs 89404 and 111102.</span>
<a href="#l14.1069"></a><span id="l14.1069">         return true;</span>
<a href="#l14.1070"></a><span id="l14.1070">       case &quot;cmd_getNextNMessages&quot;:</span>
<a href="#l14.1071"></a><span id="l14.1071" class="difflineat">@@ -917,30 +734,29 @@ var MessageWindowController =</span>
<a href="#l14.1072"></a><span id="l14.1072">       case &quot;cmd_fullZoomEnlarge&quot;:</span>
<a href="#l14.1073"></a><span id="l14.1073">       case &quot;cmd_fullZoomReset&quot;:</span>
<a href="#l14.1074"></a><span id="l14.1074">       case &quot;cmd_fullZoomToggle&quot;:</span>
<a href="#l14.1075"></a><span id="l14.1075">         return true;</span>
<a href="#l14.1076"></a><span id="l14.1076">       case &quot;button_goForward&quot;:</span>
<a href="#l14.1077"></a><span id="l14.1077">       case &quot;button_goBack&quot;:</span>
<a href="#l14.1078"></a><span id="l14.1078">       case &quot;cmd_goForward&quot;:</span>
<a href="#l14.1079"></a><span id="l14.1079">       case &quot;cmd_goBack&quot;:</span>
<a href="#l14.1080"></a><span id="l14.1080" class="difflineminus">-        return gDBView &amp;&amp;</span>
<a href="#l14.1081"></a><span id="l14.1081" class="difflineminus">-            gDBView.navigateStatus((command == &quot;cmd_goBack&quot; ||</span>
<a href="#l14.1082"></a><span id="l14.1082" class="difflineminus">-                                    command == &quot;button_goBack&quot;)</span>
<a href="#l14.1083"></a><span id="l14.1083" class="difflineminus">-                                    ? nsMsgNavigationType.back : nsMsgNavigationType.forward);</span>
<a href="#l14.1084"></a><span id="l14.1084" class="difflineplus">+        return gFolderDisplay.navigateStatus(</span>
<a href="#l14.1085"></a><span id="l14.1085" class="difflineplus">+          (command == &quot;cmd_goBack&quot; || command == &quot;button_goBack&quot;) ?</span>
<a href="#l14.1086"></a><span id="l14.1086" class="difflineplus">+            nsMsgNavigationType.back : nsMsgNavigationType.forward);</span>
<a href="#l14.1087"></a><span id="l14.1087">       case &quot;cmd_search&quot;:</span>
<a href="#l14.1088"></a><span id="l14.1088" class="difflineminus">-        var loadedFolder = GetLoadedMsgFolder();</span>
<a href="#l14.1089"></a><span id="l14.1089" class="difflineplus">+        loadedFolder = gFolderDisplay.displayedFolder;</span>
<a href="#l14.1090"></a><span id="l14.1090">         if (!loadedFolder)</span>
<a href="#l14.1091"></a><span id="l14.1091">           return false;</span>
<a href="#l14.1092"></a><span id="l14.1092">         return loadedFolder.server.canSearchMessages;</span>
<a href="#l14.1093"></a><span id="l14.1093">       case &quot;cmd_undo&quot;:</span>
<a href="#l14.1094"></a><span id="l14.1094">       case &quot;cmd_redo&quot;:</span>
<a href="#l14.1095"></a><span id="l14.1095">         return SetupUndoRedoCommand(command);</span>
<a href="#l14.1096"></a><span id="l14.1096">       case &quot;cmd_moveToFolderAgain&quot;:</span>
<a href="#l14.1097"></a><span id="l14.1097" class="difflineminus">-        var loadedFolder = GetLoadedMsgFolder();</span>
<a href="#l14.1098"></a><span id="l14.1098" class="difflineplus">+        loadedFolder = gFolderDisplay.displayedFolder;</span>
<a href="#l14.1099"></a><span id="l14.1099">         if (!loadedFolder || (pref.getBoolPref(&quot;mail.last_msg_movecopy_was_move&quot;) &amp;&amp;</span>
<a href="#l14.1100"></a><span id="l14.1100">             !loadedFolder.canDeleteMessages))</span>
<a href="#l14.1101"></a><span id="l14.1101">           return false;</span>
<a href="#l14.1102"></a><span id="l14.1102">         return pref.getCharPref(&quot;mail.last_msg_movecopy_target_uri&quot;);</span>
<a href="#l14.1103"></a><span id="l14.1103">       case &quot;cmd_applyFilters&quot;:</span>
<a href="#l14.1104"></a><span id="l14.1104">       case &quot;cmd_runJunkControls&quot;:</span>
<a href="#l14.1105"></a><span id="l14.1105">       case &quot;cmd_deleteJunk&quot;:</span>
<a href="#l14.1106"></a><span id="l14.1106">         return false;</span>
<a href="#l14.1107"></a><span id="l14.1107" class="difflineat">@@ -1039,17 +855,17 @@ var MessageWindowController =</span>
<a href="#l14.1108"></a><span id="l14.1108">         break;</span>
<a href="#l14.1109"></a><span id="l14.1109">       case &quot;cmd_saveAsFile&quot;:</span>
<a href="#l14.1110"></a><span id="l14.1110">         MsgSaveAsFile();</span>
<a href="#l14.1111"></a><span id="l14.1111">         break;</span>
<a href="#l14.1112"></a><span id="l14.1112">       case &quot;cmd_saveAsTemplate&quot;:</span>
<a href="#l14.1113"></a><span id="l14.1113">         MsgSaveAsTemplate();</span>
<a href="#l14.1114"></a><span id="l14.1114">         break;</span>
<a href="#l14.1115"></a><span id="l14.1115">       case &quot;cmd_viewPageSource&quot;:</span>
<a href="#l14.1116"></a><span id="l14.1116" class="difflineminus">-        ViewPageSource(GetSelectedMessages());</span>
<a href="#l14.1117"></a><span id="l14.1117" class="difflineplus">+        ViewPageSource(gFolderDisplay.selectedMessageUris);</span>
<a href="#l14.1118"></a><span id="l14.1118">         break;</span>
<a href="#l14.1119"></a><span id="l14.1119">       case &quot;cmd_reload&quot;:</span>
<a href="#l14.1120"></a><span id="l14.1120">         ReloadMessage();</span>
<a href="#l14.1121"></a><span id="l14.1121">         break;</span>
<a href="#l14.1122"></a><span id="l14.1122">       case &quot;cmd_find&quot;:</span>
<a href="#l14.1123"></a><span id="l14.1123">         document.getElementById(&quot;FindToolbar&quot;).onFindCommand();</span>
<a href="#l14.1124"></a><span id="l14.1124">         break;</span>
<a href="#l14.1125"></a><span id="l14.1125">       case &quot;cmd_findAgain&quot;:</span>
<a href="#l14.1126"></a><span id="l14.1126" class="difflineat">@@ -1062,17 +878,17 @@ var MessageWindowController =</span>
<a href="#l14.1127"></a><span id="l14.1127">         MsgSearchMessages();</span>
<a href="#l14.1128"></a><span id="l14.1128">         break;</span>
<a href="#l14.1129"></a><span id="l14.1129">       case &quot;button_mark&quot;:</span>
<a href="#l14.1130"></a><span id="l14.1130">       case &quot;cmd_markAsRead&quot;:</span>
<a href="#l14.1131"></a><span id="l14.1131">         MsgMarkMsgAsRead();</span>
<a href="#l14.1132"></a><span id="l14.1132">         return;</span>
<a href="#l14.1133"></a><span id="l14.1133">       case &quot;cmd_markThreadAsRead&quot;:</span>
<a href="#l14.1134"></a><span id="l14.1134">         ClearPendingReadTimer();</span>
<a href="#l14.1135"></a><span id="l14.1135" class="difflineminus">-        gDBView.doCommand(nsMsgViewCommandType.markThreadRead);</span>
<a href="#l14.1136"></a><span id="l14.1136" class="difflineplus">+        gFolderDisplay.doCommand(nsMsgViewCommandType.markThreadRead);</span>
<a href="#l14.1137"></a><span id="l14.1137">         return;</span>
<a href="#l14.1138"></a><span id="l14.1138">       case &quot;cmd_markAllRead&quot;:</span>
<a href="#l14.1139"></a><span id="l14.1139">         MsgMarkAllRead();</span>
<a href="#l14.1140"></a><span id="l14.1140">         return;</span>
<a href="#l14.1141"></a><span id="l14.1141">       case &quot;cmd_markReadByDate&quot;:</span>
<a href="#l14.1142"></a><span id="l14.1142">         MsgMarkReadByDate();</span>
<a href="#l14.1143"></a><span id="l14.1143">         return;</span>
<a href="#l14.1144"></a><span id="l14.1144">       case &quot;cmd_markAsFlagged&quot;:</span>
<a href="#l14.1145"></a><span id="l14.1145" class="difflineat">@@ -1083,20 +899,22 @@ var MessageWindowController =</span>
<a href="#l14.1146"></a><span id="l14.1146">         return;</span>
<a href="#l14.1147"></a><span id="l14.1147">       case &quot;cmd_markAsNotJunk&quot;:</span>
<a href="#l14.1148"></a><span id="l14.1148">         JunkSelectedMessages(false);</span>
<a href="#l14.1149"></a><span id="l14.1149">         return;</span>
<a href="#l14.1150"></a><span id="l14.1150">       case &quot;cmd_recalculateJunkScore&quot;:</span>
<a href="#l14.1151"></a><span id="l14.1151">         analyzeMessagesForJunk();</span>
<a href="#l14.1152"></a><span id="l14.1152">         return;</span>
<a href="#l14.1153"></a><span id="l14.1153">       case &quot;cmd_downloadFlagged&quot;:</span>
<a href="#l14.1154"></a><span id="l14.1154" class="difflineminus">-        gDBView.doCommand(nsMsgViewCommandType.downloadFlaggedForOffline);</span>
<a href="#l14.1155"></a><span id="l14.1155" class="difflineplus">+        gFolderDisplay.doCommand(</span>
<a href="#l14.1156"></a><span id="l14.1156" class="difflineplus">+          nsMsgViewCommandType.downloadFlaggedForOffline);</span>
<a href="#l14.1157"></a><span id="l14.1157">         return;</span>
<a href="#l14.1158"></a><span id="l14.1158">       case &quot;cmd_downloadSelected&quot;:</span>
<a href="#l14.1159"></a><span id="l14.1159" class="difflineminus">-        gDBView.doCommand(nsMsgViewCommandType.downloadSelectedForOffline);</span>
<a href="#l14.1160"></a><span id="l14.1160" class="difflineplus">+        gFolderDisplay.doCommand(</span>
<a href="#l14.1161"></a><span id="l14.1161" class="difflineplus">+          nsMsgViewCommandType.downloadSelectedForOffline);</span>
<a href="#l14.1162"></a><span id="l14.1162">         return;</span>
<a href="#l14.1163"></a><span id="l14.1163">       case &quot;cmd_synchronizeOffline&quot;:</span>
<a href="#l14.1164"></a><span id="l14.1164">         MsgSynchronizeOffline();</span>
<a href="#l14.1165"></a><span id="l14.1165">         return;</span>
<a href="#l14.1166"></a><span id="l14.1166">       case &quot;cmd_settingsOffline&quot;:</span>
<a href="#l14.1167"></a><span id="l14.1167">         MailOfflineMgr.openOfflineAccountSettings();</span>
<a href="#l14.1168"></a><span id="l14.1168">         return;</span>
<a href="#l14.1169"></a><span id="l14.1169">       case &quot;cmd_nextUnreadMsg&quot;:</span>
<a href="#l14.1170"></a><span id="l14.1170" class="difflineat">@@ -1146,91 +964,36 @@ var MessageWindowController =</span>
<a href="#l14.1171"></a><span id="l14.1171">       }</span>
<a href="#l14.1172"></a><span id="l14.1172">   },</span>
<a href="#l14.1173"></a><span id="l14.1173"> </span>
<a href="#l14.1174"></a><span id="l14.1174">   onEvent: function(event)</span>
<a href="#l14.1175"></a><span id="l14.1175">   {</span>
<a href="#l14.1176"></a><span id="l14.1176">   }</span>
<a href="#l14.1177"></a><span id="l14.1177"> };</span>
<a href="#l14.1178"></a><span id="l14.1178"> </span>
<a href="#l14.1179"></a><span id="l14.1179" class="difflineminus">-function LoadMessageByNavigationType(type)</span>
<a href="#l14.1180"></a><span id="l14.1180" class="difflineminus">-{</span>
<a href="#l14.1181"></a><span id="l14.1181" class="difflineminus">-  var resultId = new Object;</span>
<a href="#l14.1182"></a><span id="l14.1182" class="difflineminus">-  var resultIndex = new Object;</span>
<a href="#l14.1183"></a><span id="l14.1183" class="difflineminus">-  var threadIndex = new Object;</span>
<a href="#l14.1184"></a><span id="l14.1184" class="difflineminus">-</span>
<a href="#l14.1185"></a><span id="l14.1185" class="difflineminus">-  gDBView.viewNavigate(type, resultId, resultIndex, threadIndex, true /* wrap */);</span>
<a href="#l14.1186"></a><span id="l14.1186" class="difflineminus">-</span>
<a href="#l14.1187"></a><span id="l14.1187" class="difflineminus">-  // if we found something....display it.</span>
<a href="#l14.1188"></a><span id="l14.1188" class="difflineminus">-  if ((resultId.value != nsMsgKey_None) &amp;&amp; (resultIndex.value != nsMsgKey_None))</span>
<a href="#l14.1189"></a><span id="l14.1189" class="difflineminus">-  {</span>
<a href="#l14.1190"></a><span id="l14.1190" class="difflineminus">-    // load the message key</span>
<a href="#l14.1191"></a><span id="l14.1191" class="difflineminus">-    LoadMessageByMsgKey(resultId.value);</span>
<a href="#l14.1192"></a><span id="l14.1192" class="difflineminus">-    // if we changed folders, the message counts changed.</span>
<a href="#l14.1193"></a><span id="l14.1193" class="difflineminus">-    UpdateStandAloneMessageCounts();</span>
<a href="#l14.1194"></a><span id="l14.1194" class="difflineminus">-</span>
<a href="#l14.1195"></a><span id="l14.1195" class="difflineminus">-    // new message has been loaded</span>
<a href="#l14.1196"></a><span id="l14.1196" class="difflineminus">-    return true;</span>
<a href="#l14.1197"></a><span id="l14.1197" class="difflineminus">-  }</span>
<a href="#l14.1198"></a><span id="l14.1198" class="difflineminus">-</span>
<a href="#l14.1199"></a><span id="l14.1199" class="difflineminus">-  // no message found to load</span>
<a href="#l14.1200"></a><span id="l14.1200" class="difflineminus">-  return false;</span>
<a href="#l14.1201"></a><span id="l14.1201" class="difflineminus">-}</span>
<a href="#l14.1202"></a><span id="l14.1202" class="difflineminus">-</span>
<a href="#l14.1203"></a><span id="l14.1203"> function performNavigation(type)</span>
<a href="#l14.1204"></a><span id="l14.1204"> {</span>
<a href="#l14.1205"></a><span id="l14.1205">   // Try to load a message by navigation type if we can find</span>
<a href="#l14.1206"></a><span id="l14.1206">   // the message in the same folder.</span>
<a href="#l14.1207"></a><span id="l14.1207" class="difflineminus">-  if (LoadMessageByNavigationType(type))</span>
<a href="#l14.1208"></a><span id="l14.1208" class="difflineplus">+  if (gFolderDisplay.navigate(type))</span>
<a href="#l14.1209"></a><span id="l14.1209">     return;</span>
<a href="#l14.1210"></a><span id="l14.1210"> </span>
<a href="#l14.1211"></a><span id="l14.1211">   CrossFolderNavigation(type);</span>
<a href="#l14.1212"></a><span id="l14.1212"> }</span>
<a href="#l14.1213"></a><span id="l14.1213"> </span>
<a href="#l14.1214"></a><span id="l14.1214"> function SetupCommandUpdateHandlers()</span>
<a href="#l14.1215"></a><span id="l14.1215"> {</span>
<a href="#l14.1216"></a><span id="l14.1216">   top.controllers.insertControllerAt(0, MessageWindowController);</span>
<a href="#l14.1217"></a><span id="l14.1217"> }</span>
<a href="#l14.1218"></a><span id="l14.1218"> </span>
<a href="#l14.1219"></a><span id="l14.1219"> function UnloadCommandUpdateHandlers()</span>
<a href="#l14.1220"></a><span id="l14.1220"> {</span>
<a href="#l14.1221"></a><span id="l14.1221">   top.controllers.removeController(MessageWindowController);</span>
<a href="#l14.1222"></a><span id="l14.1222"> }</span>
<a href="#l14.1223"></a><span id="l14.1223"> </span>
<a href="#l14.1224"></a><span id="l14.1224" class="difflineminus">-function GetDBView()</span>
<a href="#l14.1225"></a><span id="l14.1225" class="difflineminus">-{</span>
<a href="#l14.1226"></a><span id="l14.1226" class="difflineminus">-  return gDBView;</span>
<a href="#l14.1227"></a><span id="l14.1227" class="difflineminus">-}</span>
<a href="#l14.1228"></a><span id="l14.1228" class="difflineminus">-</span>
<a href="#l14.1229"></a><span id="l14.1229" class="difflineminus">-function LoadMessageByMsgKey(messageKey)</span>
<a href="#l14.1230"></a><span id="l14.1230" class="difflineminus">-{</span>
<a href="#l14.1231"></a><span id="l14.1231" class="difflineminus">-  LoadMessageByViewIndex(gDBView.findIndexFromKey(messageKey, true));</span>
<a href="#l14.1232"></a><span id="l14.1232" class="difflineminus">-}</span>
<a href="#l14.1233"></a><span id="l14.1233" class="difflineminus">-</span>
<a href="#l14.1234"></a><span id="l14.1234" class="difflineminus">-function LoadMessageByViewIndex(viewIndex)</span>
<a href="#l14.1235"></a><span id="l14.1235" class="difflineminus">-{</span>
<a href="#l14.1236"></a><span id="l14.1236" class="difflineminus">-  gDBView.loadMessageByViewIndex(viewIndex);</span>
<a href="#l14.1237"></a><span id="l14.1237" class="difflineminus">-  // we only want to update the toolbar if there was no previous selected message.</span>
<a href="#l14.1238"></a><span id="l14.1238" class="difflineminus">-  if (nsMsgKey_None == gDBView.keyForFirstSelectedMessage)</span>
<a href="#l14.1239"></a><span id="l14.1239" class="difflineminus">-    UpdateMailToolbar(&quot;update toolbar for message Window&quot;);</span>
<a href="#l14.1240"></a><span id="l14.1240" class="difflineminus">-}</span>
<a href="#l14.1241"></a><span id="l14.1241" class="difflineminus">-</span>
<a href="#l14.1242"></a><span id="l14.1242" class="difflineminus">-function LoadNavigatedToMessage(msgHdr, folder, folderUri)</span>
<a href="#l14.1243"></a><span id="l14.1243" class="difflineminus">-{</span>
<a href="#l14.1244"></a><span id="l14.1244" class="difflineminus">-  if (IsCurrentLoadedFolder(folder))</span>
<a href="#l14.1245"></a><span id="l14.1245" class="difflineminus">-  {</span>
<a href="#l14.1246"></a><span id="l14.1246" class="difflineminus">-    LoadMessageByMsgKey(msgHdr.messageKey);</span>
<a href="#l14.1247"></a><span id="l14.1247" class="difflineminus">-  }</span>
<a href="#l14.1248"></a><span id="l14.1248" class="difflineminus">-  else</span>
<a href="#l14.1249"></a><span id="l14.1249" class="difflineminus">-  {</span>
<a href="#l14.1250"></a><span id="l14.1250" class="difflineminus">-    gMessageToLoad = msgHdr.messageKey;</span>
<a href="#l14.1251"></a><span id="l14.1251" class="difflineminus">-    SelectFolder(folderUri);</span>
<a href="#l14.1252"></a><span id="l14.1252" class="difflineminus">-  }</span>
<a href="#l14.1253"></a><span id="l14.1253" class="difflineminus">-}</span>
<a href="#l14.1254"></a><span id="l14.1254" class="difflineminus">-</span>
<a href="#l14.1255"></a><span id="l14.1255"> function getMailToolbox ()</span>
<a href="#l14.1256"></a><span id="l14.1256"> {</span>
<a href="#l14.1257"></a><span id="l14.1257">   return document.getElementById(&quot;mail-toolbox&quot;);</span>
<a href="#l14.1258"></a><span id="l14.1258"> }</span>
<a href="#l14.1259"></a><span id="l14.1259"> </span>
<a href="#l14.1260"></a><span id="l14.1260"> function RestoreFocusAfterHdrButton()</span>
<a href="#l14.1261"></a><span id="l14.1261"> {</span>
<a href="#l14.1262"></a><span id="l14.1262">   // set focus to the message pane</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mail/base/content/messageWindow.xul</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mail/base/content/messageWindow.xul</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -53,16 +53,19 @@</span>
<a href="#l15.4"></a><span id="l15.4"> &lt;!ENTITY % customizeToolbarDTD SYSTEM &quot;chrome://global/locale/customizeToolbar.dtd&quot;&gt;</span>
<a href="#l15.5"></a><span id="l15.5"> %customizeToolbarDTD;</span>
<a href="#l15.6"></a><span id="l15.6"> #ifdef MOZILLA_1_9_1_BRANCH</span>
<a href="#l15.7"></a><span id="l15.7"> &lt;!ENTITY % globalDTD SYSTEM &quot;chrome://global/locale/global.dtd&quot;&gt;</span>
<a href="#l15.8"></a><span id="l15.8"> %globalDTD;</span>
<a href="#l15.9"></a><span id="l15.9"> #endif</span>
<a href="#l15.10"></a><span id="l15.10"> ]&gt;</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+&lt;!--</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+  - This window displays a single message.</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+  --&gt;</span>
<a href="#l15.15"></a><span id="l15.15"> &lt;window id=&quot;messengerWindow&quot;</span>
<a href="#l15.16"></a><span id="l15.16">         xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l15.17"></a><span id="l15.17">         title=&quot;&amp;titledefault.label;&quot;</span>
<a href="#l15.18"></a><span id="l15.18">         titlemodifier=&quot;&amp;titledefault.label;&quot;</span>
<a href="#l15.19"></a><span id="l15.19">         titlemenuseparator=&quot;&amp;titleSeparator.label;&quot;</span>
<a href="#l15.20"></a><span id="l15.20">         onload=&quot;OnLoadMessageWindow()&quot;</span>
<a href="#l15.21"></a><span id="l15.21">         onunload=&quot;OnUnloadMessageWindow()&quot;</span>
<a href="#l15.22"></a><span id="l15.22">         width=&quot;750&quot;</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineat">@@ -73,16 +76,18 @@</span>
<a href="#l15.24"></a><span id="l15.24">   &lt;stringbundleset id=&quot;stringbundleset&quot;&gt;</span>
<a href="#l15.25"></a><span id="l15.25">     &lt;stringbundle id=&quot;bundle_brand&quot; src=&quot;chrome://branding/locale/brand.properties&quot;/&gt;</span>
<a href="#l15.26"></a><span id="l15.26">     &lt;stringbundle id=&quot;bundle_offlinePrompts&quot; src=&quot;chrome://messenger/locale/offline.properties&quot;/&gt;</span>
<a href="#l15.27"></a><span id="l15.27">   &lt;/stringbundleset&gt;</span>
<a href="#l15.28"></a><span id="l15.28"> </span>
<a href="#l15.29"></a><span id="l15.29">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://global/content/globalOverlay.js&quot;/&gt;</span>
<a href="#l15.30"></a><span id="l15.30">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/shareglue.js&quot;/&gt;</span>
<a href="#l15.31"></a><span id="l15.31">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/commandglue.js&quot;/&gt;</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+  &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/folderDisplay.js&quot;/&gt;</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+  &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/messageDisplay.js&quot;/&gt;</span>
<a href="#l15.34"></a><span id="l15.34">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/mailWindow.js&quot;/&gt;</span>
<a href="#l15.35"></a><span id="l15.35">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/messageWindow.js&quot;/&gt;</span>
<a href="#l15.36"></a><span id="l15.36">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/accountUtils.js&quot;/&gt;</span>
<a href="#l15.37"></a><span id="l15.37">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://global/content/contentAreaUtils.js&quot;/&gt;</span>
<a href="#l15.38"></a><span id="l15.38">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://communicator/content/nsContextMenu.js&quot;/&gt;</span>
<a href="#l15.39"></a><span id="l15.39">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/mailContextMenus.js&quot;/&gt;</span>
<a href="#l15.40"></a><span id="l15.40">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/phishingDetector.js&quot;/&gt;</span>
<a href="#l15.41"></a><span id="l15.41">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://communicator/content/contentAreaClick.js&quot;/&gt;</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineat">@@ -172,22 +177,16 @@</span>
<a href="#l15.43"></a><span id="l15.43">     &lt;deck id=&quot;msgNotificationBar&quot;/&gt;</span>
<a href="#l15.44"></a><span id="l15.44"> </span>
<a href="#l15.45"></a><span id="l15.45">     &lt;!-- message view --&gt;</span>
<a href="#l15.46"></a><span id="l15.46">     &lt;browser id=&quot;messagepane&quot; context=&quot;mailContext&quot; tooltip=&quot;aHTMLTooltip&quot;</span>
<a href="#l15.47"></a><span id="l15.47">              style=&quot;height: 0px; min-height: 1px&quot; flex=&quot;1&quot; name=&quot;messagepane&quot;</span>
<a href="#l15.48"></a><span id="l15.48">              disablesecurity=&quot;true&quot; disablehistory=&quot;true&quot; type=&quot;content-primary&quot;</span>
<a href="#l15.49"></a><span id="l15.49">              onresize=&quot;return messagePaneOnResize(event);&quot; autofind=&quot;false&quot;</span>
<a href="#l15.50"></a><span id="l15.50">              src=&quot;about:blank&quot; onclick=&quot;return contentAreaClick(event);&quot; /&gt;</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineminus">-    &lt;iframe id=&quot;htmlpane&quot;</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineminus">-             style=&quot;height: 0px; min-height: 1px&quot; flex=&quot;1&quot; name=&quot;htmlpane&quot;</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineminus">-             hidden=&quot;true&quot;</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineminus">-             disablesecurity=&quot;true&quot; disablehistory=&quot;true&quot;</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineminus">-             onresize=&quot;return htmlPaneOnResize(event);&quot; autofind=&quot;false&quot;</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineminus">-             src=&quot;about:blank&quot;/&gt;</span>
<a href="#l15.57"></a><span id="l15.57">     &lt;splitter id=&quot;attachment-splitter&quot; collapse=&quot;after&quot; resizebefore=&quot;closest&quot; resizeafter=&quot;closest&quot; collapsed=&quot;true&quot;/&gt;</span>
<a href="#l15.58"></a><span id="l15.58">     &lt;hbox id=&quot;attachmentView&quot;/&gt;</span>
<a href="#l15.59"></a><span id="l15.59">     &lt;findbar id=&quot;FindToolbar&quot; browserid=&quot;messagepane&quot;/&gt;</span>
<a href="#l15.60"></a><span id="l15.60">   &lt;/vbox&gt;</span>
<a href="#l15.61"></a><span id="l15.61">   &lt;panel id=&quot;customizeToolbarSheetPopup&quot; noautohide=&quot;true&quot;&gt;</span>
<a href="#l15.62"></a><span id="l15.62">     &lt;iframe id=&quot;customizeToolbarSheetIFrame&quot;</span>
<a href="#l15.63"></a><span id="l15.63">             style=&quot;&amp;dialog.style;&quot;</span>
<a href="#l15.64"></a><span id="l15.64"> #ifdef MOZILLA_1_9_1_BRANCH</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mail/base/content/messenger.xul</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mail/base/content/messenger.xul</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -237,29 +237,34 @@</span>
<a href="#l16.4"></a><span id="l16.4">                       minheight=&quot;100&quot; height=&quot;100&quot; persist=&quot;height&quot;</span>
<a href="#l16.5"></a><span id="l16.5">                       onselect=&quot;ObserveDisplayDeckChange(event)&quot;&gt;</span>
<a href="#l16.6"></a><span id="l16.6">                   &lt;!-- first panel in displayDeck is Account Central --&gt;</span>
<a href="#l16.7"></a><span id="l16.7">                   &lt;vbox id=&quot;accountCentralBox&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l16.8"></a><span id="l16.8">                     &lt;iframe name=&quot;accountCentralPane&quot; width=&quot;150&quot; flex=&quot;1&quot; src=&quot;about:blank&quot;/&gt;</span>
<a href="#l16.9"></a><span id="l16.9">                   &lt;/vbox&gt;</span>
<a href="#l16.10"></a><span id="l16.10">                   &lt;!-- second panel is the threadPane --&gt;</span>
<a href="#l16.11"></a><span id="l16.11">                   &lt;hbox id=&quot;threadPaneBox&quot;&gt;</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+                   &lt;!-- The threadContentArea was specially created to be a place for</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+                        things that want to be above/below the thread pane, regardless</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+                        of where the message reader (&quot;messagepane&quot;) gets off to. --&gt;</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+                   &lt;vbox id=&quot;threadContentArea&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l16.16"></a><span id="l16.16">                     &lt;tree id=&quot;threadTree&quot;</span>
<a href="#l16.17"></a><span id="l16.17">                           persist=&quot;lastfoldersent width&quot;</span>
<a href="#l16.18"></a><span id="l16.18">                           treelines=&quot;true&quot;</span>
<a href="#l16.19"></a><span id="l16.19">                           flex=&quot;2&quot;</span>
<a href="#l16.20"></a><span id="l16.20">                           enableColumnDrag=&quot;true&quot;</span>
<a href="#l16.21"></a><span id="l16.21">                           _selectDelay=&quot;250&quot;</span>
<a href="#l16.22"></a><span id="l16.22">                           class=&quot;plain focusring&quot;</span>
<a href="#l16.23"></a><span id="l16.23">                           lastfoldersent=&quot;false&quot;</span>
<a href="#l16.24"></a><span id="l16.24">                           keepcurrentinview=&quot;true&quot;</span>
<a href="#l16.25"></a><span id="l16.25">                           disableKeyNavigation=&quot;true&quot;</span>
<a href="#l16.26"></a><span id="l16.26">                           context=&quot;mailContext&quot;</span>
<a href="#l16.27"></a><span id="l16.27">                           onkeypress=&quot;ThreadPaneKeyPress(event);&quot;</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineminus">-                          onselect=&quot;ThreadPaneSelectionChanged();&quot;&gt;</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineplus">+                          onselect=&quot;ThreadPaneSelectionChanged();&quot;</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineplus">+                          &gt;</span>
<a href="#l16.31"></a><span id="l16.31">                       &lt;treecols id=&quot;threadCols&quot; pickertooltiptext=&quot;&amp;columnChooser.tooltip;&quot;&gt;</span>
<a href="#l16.32"></a><span id="l16.32">                         &lt;treecol id=&quot;threadCol&quot; persist=&quot;hidden ordinal&quot; fixed=&quot;true&quot; cycler=&quot;true&quot;</span>
<a href="#l16.33"></a><span id="l16.33">                                  class=&quot;treecol-image threadColumnHeader&quot; currentView=&quot;unthreaded&quot;</span>
<a href="#l16.34"></a><span id="l16.34">                                  label=&quot;&amp;threadColumn.label;&quot; tooltiptext=&quot;&amp;threadColumn.tooltip;&quot;/&gt;</span>
<a href="#l16.35"></a><span id="l16.35">                         &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l16.36"></a><span id="l16.36">                         &lt;treecol id=&quot;attachmentCol&quot; persist=&quot;hidden ordinal&quot; fixed=&quot;true&quot;</span>
<a href="#l16.37"></a><span id="l16.37">                                  class=&quot;treecol-image attachmentColumnHeader&quot;</span>
<a href="#l16.38"></a><span id="l16.38">                                  label=&quot;&amp;attachmentColumn.label;&quot; tooltiptext=&quot;&amp;attachmentColumn.tooltip;&quot;/&gt;</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineat">@@ -317,17 +322,18 @@</span>
<a href="#l16.40"></a><span id="l16.40">                         &lt;treecol id=&quot;locationCol&quot; persist=&quot;width&quot; flex=&quot;1&quot; hidden=&quot;true&quot; ignoreincolumnpicker=&quot;true&quot;</span>
<a href="#l16.41"></a><span id="l16.41">                                  label=&quot;&amp;locationColumn.label;&quot; tooltiptext=&quot;&amp;locationColumn.tooltip;&quot;/&gt;</span>
<a href="#l16.42"></a><span id="l16.42">                         &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l16.43"></a><span id="l16.43">                         &lt;treecol id=&quot;idCol&quot; persist=&quot;hidden ordinal width&quot; flex=&quot;1&quot; hidden=&quot;true&quot;</span>
<a href="#l16.44"></a><span id="l16.44">                                  label=&quot;&amp;idColumn.label;&quot; tooltiptext=&quot;&amp;idColumn.tooltip;&quot;/&gt;</span>
<a href="#l16.45"></a><span id="l16.45">                       &lt;/treecols&gt;</span>
<a href="#l16.46"></a><span id="l16.46">                     &lt;treechildren ondraggesture=&quot;threadPaneOnDragStart(event);&quot;/&gt;</span>
<a href="#l16.47"></a><span id="l16.47">                   &lt;/tree&gt;</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineminus">-                  &lt;/hbox&gt;</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineplus">+                 &lt;/vbox&gt;</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineplus">+                &lt;/hbox&gt;</span>
<a href="#l16.51"></a><span id="l16.51">                 &lt;!-- extensions may overlay in additional panels; don't assume that there are only 2! --&gt;</span>
<a href="#l16.52"></a><span id="l16.52">                 &lt;/deck&gt; &lt;!-- displayDeck --&gt;</span>
<a href="#l16.53"></a><span id="l16.53"> </span>
<a href="#l16.54"></a><span id="l16.54">                 &lt;!-- if you change this id, please change GetThreadAndMessagePaneSplitter() and MsgToggleMessagePane() --&gt;</span>
<a href="#l16.55"></a><span id="l16.55">                 &lt;splitter id=&quot;threadpane-splitter&quot; collapse=&quot;after&quot; persist=&quot;state&quot; collapsed=&quot;true&quot;</span>
<a href="#l16.56"></a><span id="l16.56">                           onmouseup=&quot;OnMouseUpThreadAndMessagePaneSplitter()&quot;/&gt;</span>
<a href="#l16.57"></a><span id="l16.57"> </span>
<a href="#l16.58"></a><span id="l16.58">                 &lt;vbox id=&quot;messagepanebox&quot; flex=&quot;2&quot; minheight=&quot;100&quot; height=&quot;200&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mail/base/content/msgHdrViewOverlay.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mail/base/content/msgHdrViewOverlay.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -1,48 +1,47 @@</span>
<a href="#l17.4"></a><span id="l17.4" class="difflineminus">-# -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l17.5"></a><span id="l17.5" class="difflineminus">-# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l17.6"></a><span id="l17.6" class="difflineminus">-# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l17.7"></a><span id="l17.7" class="difflineminus">-#</span>
<a href="#l17.8"></a><span id="l17.8" class="difflineminus">-# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l17.9"></a><span id="l17.9" class="difflineminus">-# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l17.10"></a><span id="l17.10" class="difflineminus">-# the License. You may obtain a copy of the License at</span>
<a href="#l17.11"></a><span id="l17.11" class="difflineminus">-# http://www.mozilla.org/MPL/</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-#</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineminus">-# for the specific language governing rights and limitations under the</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineminus">-# License.</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineminus">-#</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineminus">-# The Original Code is Mozilla Communicator client code, released</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineminus">-# March 31, 1998.</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineminus">-#</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineminus">-# The Initial Developer of the Original Code is</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineminus">-# Netscape Communications Corporation.</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineminus">-# Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineminus">-# the Initial Developer. All Rights Reserved.</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineminus">-#</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineminus">-# Contributor(s):</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineminus">-#   Markus Hossner &lt;markushossner@gmx.de&gt;</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineminus">-#   Mark Banner &lt;bugzilla@standard8.plus.com&gt;</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineminus">-#   David Ascher &lt;dascher@mozillamessaging.com&gt;</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineminus">-#</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineminus">-# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineminus">-# either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineminus">-# the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineminus">-# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineminus">-# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineminus">-# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineminus">-# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineminus">-# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineminus">-# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineminus">-# the provisions above, a recipient may use your version of this file under</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineminus">-# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineminus">-#</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineminus">-# ***** END LICENSE BLOCK *****</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l17.45"></a><span id="l17.45" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineplus">+ *</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineplus">+ *</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineplus">+ * License.</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineplus">+ *</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineplus">+ * The Original Code is Mozilla Communicator client code, released</span>
<a href="#l17.58"></a><span id="l17.58" class="difflineplus">+ * March 31, 1998.</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineplus">+ *</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l17.61"></a><span id="l17.61" class="difflineplus">+ * Netscape Communications Corporation.</span>
<a href="#l17.62"></a><span id="l17.62" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l17.63"></a><span id="l17.63" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l17.64"></a><span id="l17.64" class="difflineplus">+ *</span>
<a href="#l17.65"></a><span id="l17.65" class="difflineplus">+ * Contributor(s):</span>
<a href="#l17.66"></a><span id="l17.66" class="difflineplus">+ *   Markus Hossner &lt;markushossner@gmx.de&gt;</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineplus">+ *   Mark Banner &lt;bugzilla@standard8.plus.com&gt;</span>
<a href="#l17.68"></a><span id="l17.68" class="difflineplus">+ *   David Ascher &lt;dascher@mozillamessaging.com&gt;</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineplus">+ *</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l17.75"></a><span id="l17.75" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l17.76"></a><span id="l17.76" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l17.77"></a><span id="l17.77" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l17.78"></a><span id="l17.78" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l17.79"></a><span id="l17.79" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l17.80"></a><span id="l17.80" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l17.81"></a><span id="l17.81" class="difflineplus">+ *</span>
<a href="#l17.82"></a><span id="l17.82" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l17.83"></a><span id="l17.83"> </span>
<a href="#l17.84"></a><span id="l17.84"> </span>
<a href="#l17.85"></a><span id="l17.85"> /* This is where functions related to displaying the headers for a selected message in the</span>
<a href="#l17.86"></a><span id="l17.86">    message pane live. */</span>
<a href="#l17.87"></a><span id="l17.87"> </span>
<a href="#l17.88"></a><span id="l17.88"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l17.89"></a><span id="l17.89"> // Warning: if you go to modify any of these JS routines please get a code review from</span>
<a href="#l17.90"></a><span id="l17.90"> // scott@scott-macgregor.org. It's critical that the code in here for displaying</span>
<a href="#l17.91"></a><span id="l17.91" class="difflineat">@@ -498,22 +497,18 @@ var messageHeaderSink = {</span>
<a href="#l17.92"></a><span id="l17.92">       this.onEndHeaders();</span>
<a href="#l17.93"></a><span id="l17.93">     },</span>
<a href="#l17.94"></a><span id="l17.94"> </span>
<a href="#l17.95"></a><span id="l17.95">     handleAttachment: function(contentType, url, displayName, uri, isExternalAttachment)</span>
<a href="#l17.96"></a><span id="l17.96">     {</span>
<a href="#l17.97"></a><span id="l17.97">       // presentation level change....don't show vcards as external attachments in the UI.</span>
<a href="#l17.98"></a><span id="l17.98">       // libmime already renders them inline.</span>
<a href="#l17.99"></a><span id="l17.99"> </span>
<a href="#l17.100"></a><span id="l17.100" class="difflineminus">-      try</span>
<a href="#l17.101"></a><span id="l17.101" class="difflineminus">-      {</span>
<a href="#l17.102"></a><span id="l17.102" class="difflineminus">-        if (!this.mSaveHdr)</span>
<a href="#l17.103"></a><span id="l17.103" class="difflineminus">-          this.mSaveHdr = messenger.messageServiceFromURI(uri).messageURIToMsgHdr(uri);</span>
<a href="#l17.104"></a><span id="l17.104" class="difflineminus">-      }</span>
<a href="#l17.105"></a><span id="l17.105" class="difflineminus">-      catch (ex) {}</span>
<a href="#l17.106"></a><span id="l17.106" class="difflineplus">+      if (!this.mSaveHdr)</span>
<a href="#l17.107"></a><span id="l17.107" class="difflineplus">+        this.mSaveHdr = messenger.messageServiceFromURI(uri).messageURIToMsgHdr(uri);</span>
<a href="#l17.108"></a><span id="l17.108">       if (contentType == &quot;text/x-vcard&quot;)</span>
<a href="#l17.109"></a><span id="l17.109">       {</span>
<a href="#l17.110"></a><span id="l17.110">         var inlineAttachments = pref.getBoolPref(&quot;mail.inline_attachments&quot;);</span>
<a href="#l17.111"></a><span id="l17.111">         var displayHtmlAs = pref.getIntPref(&quot;mailnews.display.html_as&quot;);</span>
<a href="#l17.112"></a><span id="l17.112">         if (inlineAttachments &amp;&amp; !displayHtmlAs)</span>
<a href="#l17.113"></a><span id="l17.113">         {</span>
<a href="#l17.114"></a><span id="l17.114">           return;</span>
<a href="#l17.115"></a><span id="l17.115">         }</span>
<a href="#l17.116"></a><span id="l17.116" class="difflineat">@@ -526,23 +521,18 @@ var messageHeaderSink = {</span>
<a href="#l17.117"></a><span id="l17.117">       // We only need to do this on the first attachment.</span>
<a href="#l17.118"></a><span id="l17.118">       var numAttachments = currentAttachments.length;</span>
<a href="#l17.119"></a><span id="l17.119">       if (numAttachments == 1) {</span>
<a href="#l17.120"></a><span id="l17.120">         // we also have to enable the File/Attachments menuitem</span>
<a href="#l17.121"></a><span id="l17.121">         var node = document.getElementById(&quot;fileAttachmentMenu&quot;);</span>
<a href="#l17.122"></a><span id="l17.122">         if (node)</span>
<a href="#l17.123"></a><span id="l17.123">           node.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l17.124"></a><span id="l17.124"> </span>
<a href="#l17.125"></a><span id="l17.125" class="difflineminus">-        try {</span>
<a href="#l17.126"></a><span id="l17.126" class="difflineminus">-          // convert the uri into a hdr</span>
<a href="#l17.127"></a><span id="l17.127" class="difflineminus">-          this.mSaveHdr.markHasAttachments(true);</span>
<a href="#l17.128"></a><span id="l17.128" class="difflineminus">-        }</span>
<a href="#l17.129"></a><span id="l17.129" class="difflineminus">-        catch (ex) {</span>
<a href="#l17.130"></a><span id="l17.130" class="difflineminus">-          dump(&quot;ex = &quot; + ex + &quot;\n&quot;);</span>
<a href="#l17.131"></a><span id="l17.131" class="difflineminus">-        }</span>
<a href="#l17.132"></a><span id="l17.132" class="difflineplus">+        // convert the uri into a hdr</span>
<a href="#l17.133"></a><span id="l17.133" class="difflineplus">+        this.mSaveHdr.markHasAttachments(true);</span>
<a href="#l17.134"></a><span id="l17.134">       }</span>
<a href="#l17.135"></a><span id="l17.135">     },</span>
<a href="#l17.136"></a><span id="l17.136"> </span>
<a href="#l17.137"></a><span id="l17.137">     onEndAllAttachments: function()</span>
<a href="#l17.138"></a><span id="l17.138">     {</span>
<a href="#l17.139"></a><span id="l17.139">       displayAttachmentsForExpandedView();</span>
<a href="#l17.140"></a><span id="l17.140"> </span>
<a href="#l17.141"></a><span id="l17.141">       for (index in gMessageListeners) {</span>
<a href="#l17.142"></a><span id="l17.142" class="difflineat">@@ -552,22 +542,17 @@ var messageHeaderSink = {</span>
<a href="#l17.143"></a><span id="l17.143">     },</span>
<a href="#l17.144"></a><span id="l17.144"> </span>
<a href="#l17.145"></a><span id="l17.145">     onEndMsgDownload: function(url)</span>
<a href="#l17.146"></a><span id="l17.146">     {</span>
<a href="#l17.147"></a><span id="l17.147">       // if we don't have any attachments, turn off the attachments flag</span>
<a href="#l17.148"></a><span id="l17.148">       if (!this.mSaveHdr)</span>
<a href="#l17.149"></a><span id="l17.149">       {</span>
<a href="#l17.150"></a><span id="l17.150">         var messageUrl = url.QueryInterface(Components.interfaces.nsIMsgMessageUrl);</span>
<a href="#l17.151"></a><span id="l17.151" class="difflineminus">-        try</span>
<a href="#l17.152"></a><span id="l17.152" class="difflineminus">-        {</span>
<a href="#l17.153"></a><span id="l17.153" class="difflineminus">-          this.mSaveHdr = messenger.msgHdrFromURI(messageUrl.uri);</span>
<a href="#l17.154"></a><span id="l17.154" class="difflineminus">-        }</span>
<a href="#l17.155"></a><span id="l17.155" class="difflineminus">-        catch (ex) {}</span>
<a href="#l17.156"></a><span id="l17.156" class="difflineminus">-</span>
<a href="#l17.157"></a><span id="l17.157" class="difflineplus">+        this.mSaveHdr = messenger.msgHdrFromURI(messageUrl.uri);</span>
<a href="#l17.158"></a><span id="l17.158">       }</span>
<a href="#l17.159"></a><span id="l17.159">       if (!currentAttachments.length &amp;&amp; this.mSaveHdr)</span>
<a href="#l17.160"></a><span id="l17.160">         this.mSaveHdr.markHasAttachments(false);</span>
<a href="#l17.161"></a><span id="l17.161">       OnMsgParsed(url);</span>
<a href="#l17.162"></a><span id="l17.162">     },</span>
<a href="#l17.163"></a><span id="l17.163"> </span>
<a href="#l17.164"></a><span id="l17.164">     onEndMsgHeaders: function(url)</span>
<a href="#l17.165"></a><span id="l17.165">     {</span>
<a href="#l17.166"></a><span id="l17.166" class="difflineat">@@ -591,40 +576,39 @@ var messageHeaderSink = {</span>
<a href="#l17.167"></a><span id="l17.167">     },</span>
<a href="#l17.168"></a><span id="l17.168"> </span>
<a href="#l17.169"></a><span id="l17.169">     mDummyMsgHeader: null,</span>
<a href="#l17.170"></a><span id="l17.170"> </span>
<a href="#l17.171"></a><span id="l17.171">     get dummyMsgHeader()</span>
<a href="#l17.172"></a><span id="l17.172">     {</span>
<a href="#l17.173"></a><span id="l17.173">       if (!this.mDummyMsgHeader)</span>
<a href="#l17.174"></a><span id="l17.174">         this.mDummyMsgHeader = new nsDummyMsgHeader();</span>
<a href="#l17.175"></a><span id="l17.175" class="difflineplus">+      // The URI resolution will never work on the dummy header;</span>
<a href="#l17.176"></a><span id="l17.176" class="difflineplus">+      // save it now... we know it will be needed eventually.</span>
<a href="#l17.177"></a><span id="l17.177" class="difflineplus">+      // (And save it every time we come through here, not just when</span>
<a href="#l17.178"></a><span id="l17.178" class="difflineplus">+      // we create it; the onStartHeaders might come after creation!)</span>
<a href="#l17.179"></a><span id="l17.179" class="difflineplus">+      this.mSaveHdr = this.mDummyMsgHeader;</span>
<a href="#l17.180"></a><span id="l17.180">       return this.mDummyMsgHeader;</span>
<a href="#l17.181"></a><span id="l17.181">     },</span>
<a href="#l17.182"></a><span id="l17.182">     mProperties: null,</span>
<a href="#l17.183"></a><span id="l17.183">     get properties()</span>
<a href="#l17.184"></a><span id="l17.184">     {</span>
<a href="#l17.185"></a><span id="l17.185">       if (!this.mProperties)</span>
<a href="#l17.186"></a><span id="l17.186">         this.mProperties = Components.classes[&quot;@mozilla.org/hash-property-bag;1&quot;].</span>
<a href="#l17.187"></a><span id="l17.187">           createInstance(Components.interfaces.nsIWritablePropertyBag2);</span>
<a href="#l17.188"></a><span id="l17.188">       return this.mProperties;</span>
<a href="#l17.189"></a><span id="l17.189">     }</span>
<a href="#l17.190"></a><span id="l17.190"> };</span>
<a href="#l17.191"></a><span id="l17.191"> </span>
<a href="#l17.192"></a><span id="l17.192"> function SetTagHeader()</span>
<a href="#l17.193"></a><span id="l17.193"> {</span>
<a href="#l17.194"></a><span id="l17.194">   // it would be nice if we passed in the msgHdr from the back end</span>
<a href="#l17.195"></a><span id="l17.195" class="difflineminus">-  var msgHdr;</span>
<a href="#l17.196"></a><span id="l17.196" class="difflineminus">-  try</span>
<a href="#l17.197"></a><span id="l17.197" class="difflineminus">-  {</span>
<a href="#l17.198"></a><span id="l17.198" class="difflineminus">-    msgHdr = gDBView.hdrForFirstSelectedMessage;</span>
<a href="#l17.199"></a><span id="l17.199" class="difflineminus">-  }</span>
<a href="#l17.200"></a><span id="l17.200" class="difflineminus">-  catch (ex)</span>
<a href="#l17.201"></a><span id="l17.201" class="difflineminus">-  {</span>
<a href="#l17.202"></a><span id="l17.202" class="difflineplus">+  var msgHdr = gFolderDisplay.selectedMessage;</span>
<a href="#l17.203"></a><span id="l17.203" class="difflineplus">+  if (!msgHdr)</span>
<a href="#l17.204"></a><span id="l17.204">     return; // no msgHdr to add our tags to</span>
<a href="#l17.205"></a><span id="l17.205" class="difflineminus">-  }</span>
<a href="#l17.206"></a><span id="l17.206"> </span>
<a href="#l17.207"></a><span id="l17.207">   // get the list of known tags</span>
<a href="#l17.208"></a><span id="l17.208">   var tagService = Components.classes[&quot;@mozilla.org/messenger/tagservice;1&quot;]</span>
<a href="#l17.209"></a><span id="l17.209">                    .getService(Components.interfaces.nsIMsgTagService);</span>
<a href="#l17.210"></a><span id="l17.210">   var tagArray = tagService.getAllTags({});</span>
<a href="#l17.211"></a><span id="l17.211">   var tagKeys = {};</span>
<a href="#l17.212"></a><span id="l17.212">   for each (var tagInfo in tagArray)</span>
<a href="#l17.213"></a><span id="l17.213">     if (tagInfo.tag)</span>
<a href="#l17.214"></a><span id="l17.214" class="difflineat">@@ -872,29 +856,16 @@ function UpdateMessageHeaders()</span>
<a href="#l17.215"></a><span id="l17.215">   // attachment-splitter causes if it's moved high enough to affect the header box:</span>
<a href="#l17.216"></a><span id="l17.216">   document.getElementById('msgHeaderView').removeAttribute('height');</span>
<a href="#l17.217"></a><span id="l17.217"> </span>
<a href="#l17.218"></a><span id="l17.218">   for (headerName in currentHeaderData)</span>
<a href="#l17.219"></a><span id="l17.219">   {</span>
<a href="#l17.220"></a><span id="l17.220">     var headerField = currentHeaderData[headerName];</span>
<a href="#l17.221"></a><span id="l17.221">     var headerEntry = null;</span>
<a href="#l17.222"></a><span id="l17.222"> </span>
<a href="#l17.223"></a><span id="l17.223" class="difflineminus">-    if (headerName == &quot;subject&quot;)</span>
<a href="#l17.224"></a><span id="l17.224" class="difflineminus">-    {</span>
<a href="#l17.225"></a><span id="l17.225" class="difflineminus">-      try {</span>
<a href="#l17.226"></a><span id="l17.226" class="difflineminus">-        if (gDBView.keyForFirstSelectedMessage == nsMsgKey_None)</span>
<a href="#l17.227"></a><span id="l17.227" class="difflineminus">-        {</span>
<a href="#l17.228"></a><span id="l17.228" class="difflineminus">-          var folder = null;</span>
<a href="#l17.229"></a><span id="l17.229" class="difflineminus">-          if (gCurrentFolderUri)</span>
<a href="#l17.230"></a><span id="l17.230" class="difflineminus">-            folder = GetMsgFolderFromUri(gCurrentFolderUri);</span>
<a href="#l17.231"></a><span id="l17.231" class="difflineminus">-          setTitleFromFolder(folder, headerField.headerValue);</span>
<a href="#l17.232"></a><span id="l17.232" class="difflineminus">-        }</span>
<a href="#l17.233"></a><span id="l17.233" class="difflineminus">-      } catch (ex) {}</span>
<a href="#l17.234"></a><span id="l17.234" class="difflineminus">-    }</span>
<a href="#l17.235"></a><span id="l17.235" class="difflineminus">-</span>
<a href="#l17.236"></a><span id="l17.236">     if (gCollapsedHeaderViewMode &amp;&amp; !gBuiltCollapsedView)</span>
<a href="#l17.237"></a><span id="l17.237">     {</span>
<a href="#l17.238"></a><span id="l17.238">       if (headerName == &quot;cc&quot; || headerName == &quot;to&quot; || headerName == &quot;bcc&quot;)</span>
<a href="#l17.239"></a><span id="l17.239">         headerEntry = gCollapsedHeaderView[&quot;toCcBcc&quot;];</span>
<a href="#l17.240"></a><span id="l17.240">       else if (headerName in gCollapsedHeaderView)</span>
<a href="#l17.241"></a><span id="l17.241">         headerEntry = gCollapsedHeaderView[headerName];</span>
<a href="#l17.242"></a><span id="l17.242">     }</span>
<a href="#l17.243"></a><span id="l17.243">     else if (!gCollapsedHeaderViewMode &amp;&amp; !gBuiltExpandedView)</span>
<a href="#l17.244"></a><span id="l17.244" class="difflineat">@@ -921,17 +892,17 @@ function UpdateMessageHeaders()</span>
<a href="#l17.245"></a><span id="l17.245">         headerEntry = gExpandedHeaderView[headerName];</span>
<a href="#l17.246"></a><span id="l17.246">       }</span>
<a href="#l17.247"></a><span id="l17.247">     } // if we are in expanded view....</span>
<a href="#l17.248"></a><span id="l17.248"> </span>
<a href="#l17.249"></a><span id="l17.249">     if (headerEntry)</span>
<a href="#l17.250"></a><span id="l17.250">     {</span>
<a href="#l17.251"></a><span id="l17.251">       if (headerName == &quot;references&quot; &amp;&amp;</span>
<a href="#l17.252"></a><span id="l17.252">           !(gViewAllHeaders || gHeadersShowReferences ||</span>
<a href="#l17.253"></a><span id="l17.253" class="difflineminus">-            (gDBView.msgFolder &amp;&amp; gDBView.msgFolder.server.type == &quot;nntp&quot;)))</span>
<a href="#l17.254"></a><span id="l17.254" class="difflineplus">+            gFolderDisplay.view.isNewsFolder))</span>
<a href="#l17.255"></a><span id="l17.255">       {</span>
<a href="#l17.256"></a><span id="l17.256">         // hide references header if view all headers mode isn't selected, the pref show references is</span>
<a href="#l17.257"></a><span id="l17.257">         // deactivated and the currently displayed message isn't a newsgroup posting</span>
<a href="#l17.258"></a><span id="l17.258">         headerEntry.valid = false;</span>
<a href="#l17.259"></a><span id="l17.259">       }</span>
<a href="#l17.260"></a><span id="l17.260">       else</span>
<a href="#l17.261"></a><span id="l17.261">       {</span>
<a href="#l17.262"></a><span id="l17.262">         headerEntry.outputFunction(headerEntry, headerField.headerValue);</span>
<a href="#l17.263"></a><span id="l17.263" class="difflineat">@@ -954,23 +925,28 @@ function ClearCurrentHeaders()</span>
<a href="#l17.264"></a><span id="l17.264">   currentHeaderData = {};</span>
<a href="#l17.265"></a><span id="l17.265">   currentAttachments = new Array();</span>
<a href="#l17.266"></a><span id="l17.266"> }</span>
<a href="#l17.267"></a><span id="l17.267"> </span>
<a href="#l17.268"></a><span id="l17.268"> function ShowMessageHeaderPane()</span>
<a href="#l17.269"></a><span id="l17.269"> {</span>
<a href="#l17.270"></a><span id="l17.270">   document.getElementById('msgHeaderView').collapsed = false;</span>
<a href="#l17.271"></a><span id="l17.271"> </span>
<a href="#l17.272"></a><span id="l17.272" class="difflineminus">-  /* workaround for 39655 */</span>
<a href="#l17.273"></a><span id="l17.273" class="difflineminus">-  if (gFolderJustSwitched)</span>
<a href="#l17.274"></a><span id="l17.274" class="difflineminus">-  {</span>
<a href="#l17.275"></a><span id="l17.275" class="difflineminus">-    var el = document.getElementById(&quot;msgHeaderView&quot;);</span>
<a href="#l17.276"></a><span id="l17.276" class="difflineminus">-    el.setAttribute(&quot;style&quot;, el.getAttribute(&quot;style&quot;));</span>
<a href="#l17.277"></a><span id="l17.277" class="difflineminus">-    gFolderJustSwitched = false;</span>
<a href="#l17.278"></a><span id="l17.278" class="difflineminus">-  }</span>
<a href="#l17.279"></a><span id="l17.279" class="difflineplus">+  // We used to do this as a work-around for long-ago bug 39655</span>
<a href="#l17.280"></a><span id="l17.280" class="difflineplus">+  // there apparently was a layout bug where the message pane</span>
<a href="#l17.281"></a><span id="l17.281" class="difflineplus">+  // 'toolbar' was being hidden as a result of the folder change,</span>
<a href="#l17.282"></a><span id="l17.282" class="difflineplus">+  // then re-shown, but the layout would glitch and not show it.</span>
<a href="#l17.283"></a><span id="l17.283" class="difflineplus">+  // As much as I love cargo-culting, I am commenting this out</span>
<a href="#l17.284"></a><span id="l17.284" class="difflineplus">+  // because I have great respect for our layout ninjas and little</span>
<a href="#l17.285"></a><span id="l17.285" class="difflineplus">+  // respect for random global variables such as the one that</span>
<a href="#l17.286"></a><span id="l17.286" class="difflineplus">+  // controlled this.</span>
<a href="#l17.287"></a><span id="l17.287" class="difflineplus">+  //</span>
<a href="#l17.288"></a><span id="l17.288" class="difflineplus">+  //var el = document.getElementById(&quot;msgHeaderView&quot;);</span>
<a href="#l17.289"></a><span id="l17.289" class="difflineplus">+  //el.setAttribute(&quot;style&quot;, el.getAttribute(&quot;style&quot;));</span>
<a href="#l17.290"></a><span id="l17.290" class="difflineplus">+  //</span>
<a href="#l17.291"></a><span id="l17.291"> }</span>
<a href="#l17.292"></a><span id="l17.292"> </span>
<a href="#l17.293"></a><span id="l17.293"> function HideMessageHeaderPane()</span>
<a href="#l17.294"></a><span id="l17.294"> {</span>
<a href="#l17.295"></a><span id="l17.295">   document.getElementById('msgHeaderView').collapsed = true;</span>
<a href="#l17.296"></a><span id="l17.296"> </span>
<a href="#l17.297"></a><span id="l17.297">   // disable the File/Attachments menuitem</span>
<a href="#l17.298"></a><span id="l17.298">   document.getElementById(&quot;fileAttachmentMenu&quot;).setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l17.299"></a><span id="l17.299" class="difflineat">@@ -1412,18 +1388,18 @@ function detachAttachment(aAttachment, a</span>
<a href="#l17.300"></a><span id="l17.300"> }</span>
<a href="#l17.301"></a><span id="l17.301"> </span>
<a href="#l17.302"></a><span id="l17.302"> /**</span>
<a href="#l17.303"></a><span id="l17.303">  * Return true if possible attachments in the currently loaded message can be</span>
<a href="#l17.304"></a><span id="l17.304">  * deleted/detached.</span>
<a href="#l17.305"></a><span id="l17.305">  */</span>
<a href="#l17.306"></a><span id="l17.306"> function CanDetachAttachments()</span>
<a href="#l17.307"></a><span id="l17.307"> {</span>
<a href="#l17.308"></a><span id="l17.308" class="difflineminus">-  var uri = GetLoadedMessage();</span>
<a href="#l17.309"></a><span id="l17.309" class="difflineminus">-  var canDetach = !IsNewsMessage(uri) &amp;&amp; (!IsImapMessage(uri) || MailOfflineMgr.isOnline());</span>
<a href="#l17.310"></a><span id="l17.310" class="difflineplus">+  var canDetach = !gFolderDisplay.selectedMessageIsNews &amp;&amp;</span>
<a href="#l17.311"></a><span id="l17.311" class="difflineplus">+                  (!gFolderDisplay.selectedMessageIsImap || MailOfflineMgr.isOnline());</span>
<a href="#l17.312"></a><span id="l17.312">   if (canDetach &amp;&amp; (&quot;content-type&quot; in currentHeaderData))</span>
<a href="#l17.313"></a><span id="l17.313">     canDetach = !ContentTypeIsSMIME(currentHeaderData[&quot;content-type&quot;].headerValue);</span>
<a href="#l17.314"></a><span id="l17.314">   return canDetach;</span>
<a href="#l17.315"></a><span id="l17.315"> }</span>
<a href="#l17.316"></a><span id="l17.316"> </span>
<a href="#l17.317"></a><span id="l17.317"> /** Return true if the content type is an S/MIME one. */</span>
<a href="#l17.318"></a><span id="l17.318"> function ContentTypeIsSMIME(contentType)</span>
<a href="#l17.319"></a><span id="l17.319"> {</span>
<a href="#l17.320"></a><span id="l17.320" class="difflineat">@@ -1860,25 +1836,19 @@ function ClearAttachmentList()</span>
<a href="#l17.321"></a><span id="l17.321"> </span>
<a href="#l17.322"></a><span id="l17.322">   while (list.hasChildNodes())</span>
<a href="#l17.323"></a><span id="l17.323">     list.removeChild(list.lastChild);</span>
<a href="#l17.324"></a><span id="l17.324"> }</span>
<a href="#l17.325"></a><span id="l17.325"> </span>
<a href="#l17.326"></a><span id="l17.326"> function ShowEditMessageBox()</span>
<a href="#l17.327"></a><span id="l17.327"> {</span>
<a href="#l17.328"></a><span id="l17.328">   // it would be nice if we passed in the msgHdr from the back end</span>
<a href="#l17.329"></a><span id="l17.329" class="difflineminus">-  var msgHdr;</span>
<a href="#l17.330"></a><span id="l17.330" class="difflineminus">-  try</span>
<a href="#l17.331"></a><span id="l17.331" class="difflineminus">-  {</span>
<a href="#l17.332"></a><span id="l17.332" class="difflineminus">-    msgHdr = gDBView.hdrForFirstSelectedMessage;</span>
<a href="#l17.333"></a><span id="l17.333" class="difflineminus">-  }</span>
<a href="#l17.334"></a><span id="l17.334" class="difflineminus">-  catch (ex)</span>
<a href="#l17.335"></a><span id="l17.335" class="difflineminus">-  {</span>
<a href="#l17.336"></a><span id="l17.336" class="difflineplus">+  var msgHdr = gFolderDisplay.selectedMessage;</span>
<a href="#l17.337"></a><span id="l17.337" class="difflineplus">+  if (!msgHdr &amp;&amp; !msgHdr.folder)</span>
<a href="#l17.338"></a><span id="l17.338">     return;</span>
<a href="#l17.339"></a><span id="l17.339" class="difflineminus">-  }</span>
<a href="#l17.340"></a><span id="l17.340">   const nsMsgFolderFlags = Components.interfaces.nsMsgFolderFlags;</span>
<a href="#l17.341"></a><span id="l17.341">   if (IsSpecialFolder(msgHdr.folder, nsMsgFolderFlags.Drafts, true))</span>
<a href="#l17.342"></a><span id="l17.342">     document.getElementById(&quot;editMessageBox&quot;).collapsed = false;</span>
<a href="#l17.343"></a><span id="l17.343"> }</span>
<a href="#l17.344"></a><span id="l17.344"> </span>
<a href="#l17.345"></a><span id="l17.345"> function ClearEditMessageBox()</span>
<a href="#l17.346"></a><span id="l17.346"> {</span>
<a href="#l17.347"></a><span id="l17.347">   var editBox = document.getElementById(&quot;editMessageBox&quot;);</span>
<a href="#l17.348"></a><span id="l17.348" class="difflineat">@@ -1987,22 +1957,39 @@ nsFlavorDataProvider.prototype =</span>
<a href="#l17.349"></a><span id="l17.349"> </span>
<a href="#l17.350"></a><span id="l17.350"> function nsDummyMsgHeader()</span>
<a href="#l17.351"></a><span id="l17.351"> {</span>
<a href="#l17.352"></a><span id="l17.352"> }</span>
<a href="#l17.353"></a><span id="l17.353"> </span>
<a href="#l17.354"></a><span id="l17.354"> nsDummyMsgHeader.prototype =</span>
<a href="#l17.355"></a><span id="l17.355"> {</span>
<a href="#l17.356"></a><span id="l17.356">   mProperties : new Array,</span>
<a href="#l17.357"></a><span id="l17.357" class="difflineminus">-  getStringProperty : function(property) {return this.mProperties[property];},</span>
<a href="#l17.358"></a><span id="l17.358" class="difflineminus">-  setStringProperty : function(property, val) {this.mProperties[property] = val;},</span>
<a href="#l17.359"></a><span id="l17.359" class="difflineplus">+  getStringProperty : function(aProperty) {</span>
<a href="#l17.360"></a><span id="l17.360" class="difflineplus">+    if (aProperty in this.mProperties)</span>
<a href="#l17.361"></a><span id="l17.361" class="difflineplus">+      return this.mProperties[property];</span>
<a href="#l17.362"></a><span id="l17.362" class="difflineplus">+    return &quot;&quot;;</span>
<a href="#l17.363"></a><span id="l17.363" class="difflineplus">+  },</span>
<a href="#l17.364"></a><span id="l17.364" class="difflineplus">+  setStringProperty : function(aProperty, aVal) {</span>
<a href="#l17.365"></a><span id="l17.365" class="difflineplus">+    this.mProperties[aProperty] = aVal;</span>
<a href="#l17.366"></a><span id="l17.366" class="difflineplus">+  },</span>
<a href="#l17.367"></a><span id="l17.367" class="difflineplus">+  getUint32Property : function(aProperty) {</span>
<a href="#l17.368"></a><span id="l17.368" class="difflineplus">+    if (aProperty in this.mProperties)</span>
<a href="#l17.369"></a><span id="l17.369" class="difflineplus">+      return parseInt(this.mProperties[aProperty]);</span>
<a href="#l17.370"></a><span id="l17.370" class="difflineplus">+    return 0;</span>
<a href="#l17.371"></a><span id="l17.371" class="difflineplus">+  },</span>
<a href="#l17.372"></a><span id="l17.372" class="difflineplus">+  setUint32Property: function(aProperty, aVal) {</span>
<a href="#l17.373"></a><span id="l17.373" class="difflineplus">+    this.mProperties[aProperty] = aVal.toString();</span>
<a href="#l17.374"></a><span id="l17.374" class="difflineplus">+  },</span>
<a href="#l17.375"></a><span id="l17.375">   markHasAttachments : function(hasAttachments) {},</span>
<a href="#l17.376"></a><span id="l17.376">   messageSize : 0,</span>
<a href="#l17.377"></a><span id="l17.377">   recipients : null,</span>
<a href="#l17.378"></a><span id="l17.378">   from : null,</span>
<a href="#l17.379"></a><span id="l17.379">   subject : null,</span>
<a href="#l17.380"></a><span id="l17.380" class="difflineplus">+  get mime2DecodedSubject() { return this.subject; },</span>
<a href="#l17.381"></a><span id="l17.381">   ccList : null,</span>
<a href="#l17.382"></a><span id="l17.382">   listPost : null,</span>
<a href="#l17.383"></a><span id="l17.383">   messageId : null,</span>
<a href="#l17.384"></a><span id="l17.384">   accountKey : &quot;&quot;,</span>
<a href="#l17.385"></a><span id="l17.385" class="difflineplus">+  // if you change us to return a fake folder, please update</span>
<a href="#l17.386"></a><span id="l17.386" class="difflineplus">+  // folderDisplay.js's FolderDisplayWidget's selectedMessageIsExternal getter.</span>
<a href="#l17.387"></a><span id="l17.387">   folder : null</span>
<a href="#l17.388"></a><span id="l17.388"> };</span>
<a href="#l17.389"></a><span id="l17.389"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mail/base/content/msgHdrViewOverlay.xul</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mail/base/content/msgHdrViewOverlay.xul</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -224,17 +224,17 @@</span>
<a href="#l18.4"></a><span id="l18.4">                     class=&quot;msgHeaderView-button msgHeaderView-flat-button&quot;/&gt;</span>
<a href="#l18.5"></a><span id="l18.5">             &lt;button type=&quot;menu&quot; id=&quot;otherActionsButton&quot;</span>
<a href="#l18.6"></a><span id="l18.6">                     label=&quot;&amp;otherActionsButton.label;&quot;</span>
<a href="#l18.7"></a><span id="l18.7">                     class=&quot;msgHeaderView-button msgHeaderView-flat-button&quot;&gt;</span>
<a href="#l18.8"></a><span id="l18.8">               &lt;menupopup id=&quot;otherActionsPopup&quot;&gt;</span>
<a href="#l18.9"></a><span id="l18.9">                 &lt;menuitem id=&quot;viewSourceMenuItem&quot;</span>
<a href="#l18.10"></a><span id="l18.10">                           label=&quot;&amp;viewSourceMenuItem.label;&quot;</span>
<a href="#l18.11"></a><span id="l18.11">                           accesskey=&quot;&amp;viewSourceMenuItem.accesskey;&quot;</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-                          oncommand=&quot;ViewPageSource(GetSelectedMessages());&quot; /&gt;</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+                          oncommand=&quot;ViewPageSource(gFolderDisplay.selectedMessageUris);&quot; /&gt;</span>
<a href="#l18.14"></a><span id="l18.14">                 &lt;menuitem id=&quot;saveAsMenuItem&quot; label=&quot;&amp;saveAsMenuItem.label;&quot;</span>
<a href="#l18.15"></a><span id="l18.15">                           accesskey=&quot;&amp;saveAsMenuItem.accesskey;&quot;</span>
<a href="#l18.16"></a><span id="l18.16">                           oncommand=&quot;MsgSaveAsFile();&quot; /&gt;</span>
<a href="#l18.17"></a><span id="l18.17">               &lt;/menupopup&gt;</span>
<a href="#l18.18"></a><span id="l18.18">             &lt;/button&gt;</span>
<a href="#l18.19"></a><span id="l18.19">           &lt;/vbox&gt;</span>
<a href="#l18.20"></a><span id="l18.20">         &lt;/hbox&gt;</span>
<a href="#l18.21"></a><span id="l18.21">       &lt;/vbox&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -1,167 +1,102 @@</span>
<a href="#l19.4"></a><span id="l19.4" class="difflineminus">-# -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l19.5"></a><span id="l19.5" class="difflineminus">-# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l19.6"></a><span id="l19.6" class="difflineminus">-# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l19.7"></a><span id="l19.7" class="difflineminus">-#</span>
<a href="#l19.8"></a><span id="l19.8" class="difflineminus">-# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l19.9"></a><span id="l19.9" class="difflineminus">-# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l19.10"></a><span id="l19.10" class="difflineminus">-# the License. You may obtain a copy of the License at</span>
<a href="#l19.11"></a><span id="l19.11" class="difflineminus">-# http://www.mozilla.org/MPL/</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-#</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineminus">-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineminus">-# for the specific language governing rights and limitations under the</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineminus">-# License.</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineminus">-#</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineminus">-# The Original Code is Mozilla Communicator client code, released</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineminus">-# March 31, 1998.</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineminus">-#</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineminus">-# The Initial Developer of the Original Code is</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineminus">-# Netscape Communications Corporation.</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineminus">-# Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineminus">-# the Initial Developer. All Rights Reserved.</span>
<a href="#l19.25"></a><span id="l19.25" class="difflineminus">-#</span>
<a href="#l19.26"></a><span id="l19.26" class="difflineminus">-# Contributor(s):</span>
<a href="#l19.27"></a><span id="l19.27" class="difflineminus">-#   Jan Varga (varga@nixcorp.com)</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineminus">-#   Hkan Waara (hwaara@chello.se)</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineminus">-#   Neil Rashbrook (neil@parkwaycc.co.uk)</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineminus">-#   Seth Spitzer &lt;sspitzer@netscape.com&gt;</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineminus">-#   David Bienvenu &lt;bienvenu@nventure.com&gt;</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineminus">-#   Jeremy Morton &lt;bugzilla@game-point.net&gt;</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineminus">-#   Steffen Wilberg &lt;steffen.wilberg@web.de&gt;</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineminus">-#</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineminus">-# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineminus">-# either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineminus">-# the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineminus">-# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineminus">-# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineminus">-# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineminus">-# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineminus">-# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineminus">-# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineminus">-# the provisions above, a recipient may use your version of this file under</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineminus">-# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineminus">-#</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineminus">-# ***** END LICENSE BLOCK *****</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineplus">+/** ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l19.49"></a><span id="l19.49" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineplus">+ *</span>
<a href="#l19.51"></a><span id="l19.51" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l19.52"></a><span id="l19.52" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l19.53"></a><span id="l19.53" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l19.54"></a><span id="l19.54" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l19.55"></a><span id="l19.55" class="difflineplus">+ *</span>
<a href="#l19.56"></a><span id="l19.56" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l19.57"></a><span id="l19.57" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l19.58"></a><span id="l19.58" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l19.59"></a><span id="l19.59" class="difflineplus">+ * License.</span>
<a href="#l19.60"></a><span id="l19.60" class="difflineplus">+ *</span>
<a href="#l19.61"></a><span id="l19.61" class="difflineplus">+ * The Original Code is Mozilla Communicator client code, released</span>
<a href="#l19.62"></a><span id="l19.62" class="difflineplus">+ * March 31, 1998.</span>
<a href="#l19.63"></a><span id="l19.63" class="difflineplus">+ *</span>
<a href="#l19.64"></a><span id="l19.64" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l19.65"></a><span id="l19.65" class="difflineplus">+ * Netscape Communications Corporation.</span>
<a href="#l19.66"></a><span id="l19.66" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l19.67"></a><span id="l19.67" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineplus">+ *</span>
<a href="#l19.69"></a><span id="l19.69" class="difflineplus">+ * Contributor(s):</span>
<a href="#l19.70"></a><span id="l19.70" class="difflineplus">+ *   Jan Varga (varga@nixcorp.com)</span>
<a href="#l19.71"></a><span id="l19.71" class="difflineplus">+ *   Hkan Waara (hwaara@chello.se)</span>
<a href="#l19.72"></a><span id="l19.72" class="difflineplus">+ *   Neil Rashbrook (neil@parkwaycc.co.uk)</span>
<a href="#l19.73"></a><span id="l19.73" class="difflineplus">+ *   Seth Spitzer &lt;sspitzer@netscape.com&gt;</span>
<a href="#l19.74"></a><span id="l19.74" class="difflineplus">+ *   David Bienvenu &lt;bienvenu@nventure.com&gt;</span>
<a href="#l19.75"></a><span id="l19.75" class="difflineplus">+ *   Jeremy Morton &lt;bugzilla@game-point.net&gt;</span>
<a href="#l19.76"></a><span id="l19.76" class="difflineplus">+ *   Steffen Wilberg &lt;steffen.wilberg@web.de&gt;</span>
<a href="#l19.77"></a><span id="l19.77" class="difflineplus">+ *</span>
<a href="#l19.78"></a><span id="l19.78" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l19.79"></a><span id="l19.79" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l19.80"></a><span id="l19.80" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l19.81"></a><span id="l19.81" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l19.82"></a><span id="l19.82" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l19.83"></a><span id="l19.83" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l19.84"></a><span id="l19.84" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l19.85"></a><span id="l19.85" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l19.86"></a><span id="l19.86" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l19.87"></a><span id="l19.87" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l19.88"></a><span id="l19.88" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l19.89"></a><span id="l19.89" class="difflineplus">+ *</span>
<a href="#l19.90"></a><span id="l19.90" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l19.91"></a><span id="l19.91"> </span>
<a href="#l19.92"></a><span id="l19.92"> Components.utils.import(&quot;resource://gre/modules/folderUtils.jsm&quot;);</span>
<a href="#l19.93"></a><span id="l19.93"> Components.utils.import(&quot;resource://app/modules/activity/activityModules.js&quot;);</span>
<a href="#l19.94"></a><span id="l19.94" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/jsTreeSelection.js&quot;);</span>
<a href="#l19.95"></a><span id="l19.95"> </span>
<a href="#l19.96"></a><span id="l19.96"> /* This is where functions related to the 3 pane window are kept */</span>
<a href="#l19.97"></a><span id="l19.97"> </span>
<a href="#l19.98"></a><span id="l19.98"> // from MailNewsTypes.h</span>
<a href="#l19.99"></a><span id="l19.99"> const nsMsgKey_None = 0xFFFFFFFF;</span>
<a href="#l19.100"></a><span id="l19.100"> const nsMsgViewIndex_None = 0xFFFFFFFF;</span>
<a href="#l19.101"></a><span id="l19.101"> const kMailCheckOncePrefName = &quot;mail.startup.enabledMailCheckOnce&quot;;</span>
<a href="#l19.102"></a><span id="l19.102"> </span>
<a href="#l19.103"></a><span id="l19.103"> const kStandardPaneConfig = 0;</span>
<a href="#l19.104"></a><span id="l19.104"> const kWidePaneConfig = 1;</span>
<a href="#l19.105"></a><span id="l19.105"> const kVerticalPaneConfig = 2;</span>
<a href="#l19.106"></a><span id="l19.106"> </span>
<a href="#l19.107"></a><span id="l19.107"> const kNumFolderViews = 4; // total number of folder views</span>
<a href="#l19.108"></a><span id="l19.108"> </span>
<a href="#l19.109"></a><span id="l19.109" class="difflineplus">+/** widget with id=messagepanebox, initialized by GetMessagePane() */</span>
<a href="#l19.110"></a><span id="l19.110"> var gMessagePane;</span>
<a href="#l19.111"></a><span id="l19.111" class="difflineplus">+/** widget with id=searchInput, initialized by GetSearchInput() */</span>
<a href="#l19.112"></a><span id="l19.112"> var gSearchInput;</span>
<a href="#l19.113"></a><span id="l19.113"> </span>
<a href="#l19.114"></a><span id="l19.114"> var gThreadAndMessagePaneSplitter = null;</span>
<a href="#l19.115"></a><span id="l19.115" class="difflineplus">+/** widget with id=unreadMessageCount, initialized by GetUnreadCountElement() */</span>
<a href="#l19.116"></a><span id="l19.116"> var gUnreadCount = null;</span>
<a href="#l19.117"></a><span id="l19.117" class="difflineplus">+/** widget with id=totalMessageCount, initialized by GetTotalCountElement() */</span>
<a href="#l19.118"></a><span id="l19.118"> var gTotalCount = null;</span>
<a href="#l19.119"></a><span id="l19.119"> var gCurrentFolderView;</span>
<a href="#l19.120"></a><span id="l19.120" class="difflineminus">-var gCurrentLoadingFolderURI;</span>
<a href="#l19.121"></a><span id="l19.121" class="difflineminus">-var gCurrentFolderToReroot;</span>
<a href="#l19.122"></a><span id="l19.122" class="difflineminus">-var gCurrentLoadingFolderSortType = 0;</span>
<a href="#l19.123"></a><span id="l19.123" class="difflineminus">-var gCurrentLoadingFolderSortOrder = 0;</span>
<a href="#l19.124"></a><span id="l19.124" class="difflineminus">-var gCurrentLoadingFolderViewType = 0;</span>
<a href="#l19.125"></a><span id="l19.125" class="difflineminus">-var gCurrentLoadingFolderViewFlags = 0;</span>
<a href="#l19.126"></a><span id="l19.126" class="difflineminus">-var gRerootOnFolderLoad = false;</span>
<a href="#l19.127"></a><span id="l19.127" class="difflineminus">-var gNextMessageAfterDelete = null;</span>
<a href="#l19.128"></a><span id="l19.128" class="difflineminus">-var gNextMessageAfterLoad = null;</span>
<a href="#l19.129"></a><span id="l19.129" class="difflineminus">-var gNextMessageViewIndexAfterDelete = -2;</span>
<a href="#l19.130"></a><span id="l19.130" class="difflineminus">-var gSelectedIndexWhenDeleting = -1;</span>
<a href="#l19.131"></a><span id="l19.131" class="difflineminus">-var gCurrentlyDisplayedMessage=nsMsgViewIndex_None;</span>
<a href="#l19.132"></a><span id="l19.132"> var gStartFolderUri = null;</span>
<a href="#l19.133"></a><span id="l19.133" class="difflineminus">-var gStartMsgKey = nsMsgKey_None;</span>
<a href="#l19.134"></a><span id="l19.134" class="difflineminus">-var gSearchEmailAddress = null;</span>
<a href="#l19.135"></a><span id="l19.135" class="difflineminus">-var gRightMouseButtonDown = false;</span>
<a href="#l19.136"></a><span id="l19.136" class="difflineminus">-// Global var to keep track of which row in the thread pane has been selected</span>
<a href="#l19.137"></a><span id="l19.137" class="difflineminus">-// This is used to make sure that the row with the currentIndex has the selection</span>
<a href="#l19.138"></a><span id="l19.138" class="difflineminus">-// after a Delete or Move of a message that has a row index less than currentIndex.</span>
<a href="#l19.139"></a><span id="l19.139" class="difflineminus">-var gThreadPaneCurrentSelectedIndex = -1;</span>
<a href="#l19.140"></a><span id="l19.140" class="difflineplus">+/**</span>
<a href="#l19.141"></a><span id="l19.141" class="difflineplus">+ * Tracks whether the right mouse button changed the selection or not.  If the</span>
<a href="#l19.142"></a><span id="l19.142" class="difflineplus">+ * user right clicks on the selection, it stays the same.  If they click outside</span>
<a href="#l19.143"></a><span id="l19.143" class="difflineplus">+ * of it, we alter the selection (but not the current index) to be the row they</span>
<a href="#l19.144"></a><span id="l19.144" class="difflineplus">+ * clicked on.</span>
<a href="#l19.145"></a><span id="l19.145" class="difflineplus">+ *</span>
<a href="#l19.146"></a><span id="l19.146" class="difflineplus">+ * The value of this variable is an object with &quot;view&quot; and &quot;selection&quot; keys</span>
<a href="#l19.147"></a><span id="l19.147" class="difflineplus">+ * and values.  The view value is the view whose selection we saved off, and</span>
<a href="#l19.148"></a><span id="l19.148" class="difflineplus">+ * the selection value is the selection object we saved off.</span>
<a href="#l19.149"></a><span id="l19.149" class="difflineplus">+ */</span>
<a href="#l19.150"></a><span id="l19.150" class="difflineplus">+var gRightMouseButtonSavedSelection = null;</span>
<a href="#l19.151"></a><span id="l19.151"> var gLoadStartFolder = true;</span>
<a href="#l19.152"></a><span id="l19.152"> var gNewAccountToLoad = null;</span>
<a href="#l19.153"></a><span id="l19.153"> </span>
<a href="#l19.154"></a><span id="l19.154"> // Global var to keep track of if the 'Delete Message' or 'Move To' thread pane</span>
<a href="#l19.155"></a><span id="l19.155"> // context menu item was triggered.  This helps prevent the tree view from</span>
<a href="#l19.156"></a><span id="l19.156"> // not updating on one of those menu item commands.</span>
<a href="#l19.157"></a><span id="l19.157"> var gThreadPaneDeleteOrMoveOccurred = false;</span>
<a href="#l19.158"></a><span id="l19.158"> </span>
<a href="#l19.159"></a><span id="l19.159" class="difflineminus">-//If we've loaded a message, set to true.  Helps us keep the start page around.</span>
<a href="#l19.160"></a><span id="l19.160" class="difflineminus">-var gHaveLoadedMessage;</span>
<a href="#l19.161"></a><span id="l19.161" class="difflineminus">-</span>
<a href="#l19.162"></a><span id="l19.162"> var gDisplayStartupPage = false;</span>
<a href="#l19.163"></a><span id="l19.163"> </span>
<a href="#l19.164"></a><span id="l19.164" class="difflineminus">-function SelectAndScrollToKey(aMsgKey)</span>
<a href="#l19.165"></a><span id="l19.165" class="difflineminus">-{</span>
<a href="#l19.166"></a><span id="l19.166" class="difflineminus">-  // select the desired message</span>
<a href="#l19.167"></a><span id="l19.167" class="difflineminus">-  // if the key isn't found, we won't select anything</span>
<a href="#l19.168"></a><span id="l19.168" class="difflineminus">-  gDBView.selectMsgByKey(aMsgKey);</span>
<a href="#l19.169"></a><span id="l19.169" class="difflineminus">-</span>
<a href="#l19.170"></a><span id="l19.170" class="difflineminus">-  // is there a selection?</span>
<a href="#l19.171"></a><span id="l19.171" class="difflineminus">-  // if not, bail out.</span>
<a href="#l19.172"></a><span id="l19.172" class="difflineminus">-  var indicies = GetSelectedIndices(gDBView);</span>
<a href="#l19.173"></a><span id="l19.173" class="difflineminus">-  if (!indicies || !indicies.length)</span>
<a href="#l19.174"></a><span id="l19.174" class="difflineminus">-    return false;</span>
<a href="#l19.175"></a><span id="l19.175" class="difflineminus">-</span>
<a href="#l19.176"></a><span id="l19.176" class="difflineminus">-  // now scroll to it</span>
<a href="#l19.177"></a><span id="l19.177" class="difflineminus">-  EnsureRowInThreadTreeIsVisible(indicies[0]);</span>
<a href="#l19.178"></a><span id="l19.178" class="difflineminus">-  return true;</span>
<a href="#l19.179"></a><span id="l19.179" class="difflineminus">-}</span>
<a href="#l19.180"></a><span id="l19.180" class="difflineminus">-</span>
<a href="#l19.181"></a><span id="l19.181" class="difflineminus">-// A helper routine called after a folder is loaded to make sure</span>
<a href="#l19.182"></a><span id="l19.182" class="difflineminus">-// we select and scroll to the correct message (could be the first new message,</span>
<a href="#l19.183"></a><span id="l19.183" class="difflineminus">-// could be the last displayed message, etc.)</span>
<a href="#l19.184"></a><span id="l19.184" class="difflineminus">-function ScrollToMessageAfterFolderLoad(folder)</span>
<a href="#l19.185"></a><span id="l19.185" class="difflineminus">-{</span>
<a href="#l19.186"></a><span id="l19.186" class="difflineminus">-  var scrolled = gPrefBranch.getBoolPref(&quot;mailnews.scroll_to_new_message&quot;) &amp;&amp;</span>
<a href="#l19.187"></a><span id="l19.187" class="difflineminus">-      ScrollToMessage(nsMsgNavigationType.firstNew, true, false /* selectMessage */);</span>
<a href="#l19.188"></a><span id="l19.188" class="difflineminus">-  if (!scrolled &amp;&amp; folder &amp;&amp; gPrefBranch.getBoolPref(&quot;mailnews.remember_selected_message&quot;))</span>
<a href="#l19.189"></a><span id="l19.189" class="difflineminus">-  {</span>
<a href="#l19.190"></a><span id="l19.190" class="difflineminus">-    // If we failed to scroll to a new message,</span>
<a href="#l19.191"></a><span id="l19.191" class="difflineminus">-    // reselect the last selected message</span>
<a href="#l19.192"></a><span id="l19.192" class="difflineminus">-    var lastMessageLoaded = folder.lastMessageLoaded;</span>
<a href="#l19.193"></a><span id="l19.193" class="difflineminus">-    if (lastMessageLoaded != nsMsgKey_None)</span>
<a href="#l19.194"></a><span id="l19.194" class="difflineminus">-      scrolled = SelectAndScrollToKey(lastMessageLoaded);</span>
<a href="#l19.195"></a><span id="l19.195" class="difflineminus">-  }</span>
<a href="#l19.196"></a><span id="l19.196" class="difflineminus">-</span>
<a href="#l19.197"></a><span id="l19.197" class="difflineminus">-  if (!scrolled)</span>
<a href="#l19.198"></a><span id="l19.198" class="difflineminus">-  {</span>
<a href="#l19.199"></a><span id="l19.199" class="difflineminus">-    // if we still haven't scrolled,</span>
<a href="#l19.200"></a><span id="l19.200" class="difflineminus">-    // scroll to the newest, which might be the top or the bottom</span>
<a href="#l19.201"></a><span id="l19.201" class="difflineminus">-    // depending on our sort order and sort type</span>
<a href="#l19.202"></a><span id="l19.202" class="difflineminus">-    if (gDBView.sortOrder == nsMsgViewSortOrder.ascending)</span>
<a href="#l19.203"></a><span id="l19.203" class="difflineminus">-    {</span>
<a href="#l19.204"></a><span id="l19.204" class="difflineminus">-      switch (gDBView.sortType)</span>
<a href="#l19.205"></a><span id="l19.205" class="difflineminus">-      {</span>
<a href="#l19.206"></a><span id="l19.206" class="difflineminus">-        case nsMsgViewSortType.byDate:</span>
<a href="#l19.207"></a><span id="l19.207" class="difflineminus">-        case nsMsgViewSortType.byReceived:</span>
<a href="#l19.208"></a><span id="l19.208" class="difflineminus">-        case nsMsgViewSortType.byId:</span>
<a href="#l19.209"></a><span id="l19.209" class="difflineminus">-        case nsMsgViewSortType.byThread:</span>
<a href="#l19.210"></a><span id="l19.210" class="difflineminus">-         scrolled = ScrollToMessage(nsMsgNavigationType.lastMessage, true, false /* selectMessage */);</span>
<a href="#l19.211"></a><span id="l19.211" class="difflineminus">-         break;</span>
<a href="#l19.212"></a><span id="l19.212" class="difflineminus">-      }</span>
<a href="#l19.213"></a><span id="l19.213" class="difflineminus">-    }</span>
<a href="#l19.214"></a><span id="l19.214" class="difflineminus">-</span>
<a href="#l19.215"></a><span id="l19.215" class="difflineminus">-    // if still we haven't scrolled,</span>
<a href="#l19.216"></a><span id="l19.216" class="difflineminus">-    // scroll to the top.</span>
<a href="#l19.217"></a><span id="l19.217" class="difflineminus">-    if (!scrolled)</span>
<a href="#l19.218"></a><span id="l19.218" class="difflineminus">-      EnsureRowInThreadTreeIsVisible(0);</span>
<a href="#l19.219"></a><span id="l19.219" class="difflineminus">-  }</span>
<a href="#l19.220"></a><span id="l19.220" class="difflineminus">-}</span>
<a href="#l19.221"></a><span id="l19.221" class="difflineminus">-</span>
<a href="#l19.222"></a><span id="l19.222"> // the folderListener object</span>
<a href="#l19.223"></a><span id="l19.223"> var folderListener = {</span>
<a href="#l19.224"></a><span id="l19.224">     OnItemAdded: function(parentItem, item) { },</span>
<a href="#l19.225"></a><span id="l19.225"> </span>
<a href="#l19.226"></a><span id="l19.226">     OnItemRemoved: function(parentItem, item) { },</span>
<a href="#l19.227"></a><span id="l19.227"> </span>
<a href="#l19.228"></a><span id="l19.228">     OnItemPropertyChanged: function(item, property, oldValue, newValue) { },</span>
<a href="#l19.229"></a><span id="l19.229"> </span>
<a href="#l19.230"></a><span id="l19.230" class="difflineat">@@ -175,131 +110,17 @@ var folderListener = {</span>
<a href="#l19.231"></a><span id="l19.231"> </span>
<a href="#l19.232"></a><span id="l19.232">     OnItemBoolPropertyChanged: function(item, property, oldValue, newValue) { },</span>
<a href="#l19.233"></a><span id="l19.233"> </span>
<a href="#l19.234"></a><span id="l19.234">     OnItemUnicharPropertyChanged: function(item, property, oldValue, newValue) { },</span>
<a href="#l19.235"></a><span id="l19.235">     OnItemPropertyFlagChanged: function(item, property, oldFlag, newFlag) { },</span>
<a href="#l19.236"></a><span id="l19.236"> </span>
<a href="#l19.237"></a><span id="l19.237">     OnItemEvent: function(folder, event) {</span>
<a href="#l19.238"></a><span id="l19.238">       var eventType = event.toString();</span>
<a href="#l19.239"></a><span id="l19.239" class="difflineminus">-      if (eventType == &quot;FolderLoaded&quot;) {</span>
<a href="#l19.240"></a><span id="l19.240" class="difflineminus">-        if (folder) {</span>
<a href="#l19.241"></a><span id="l19.241" class="difflineminus">-          var scrolled = false;</span>
<a href="#l19.242"></a><span id="l19.242" class="difflineminus">-          var msgFolder = folder.QueryInterface(Components.interfaces.nsIMsgFolder);</span>
<a href="#l19.243"></a><span id="l19.243" class="difflineminus">-          var uri = folder.URI;</span>
<a href="#l19.244"></a><span id="l19.244" class="difflineminus">-          var rerootingFolder = (uri == gCurrentFolderToReroot);</span>
<a href="#l19.245"></a><span id="l19.245" class="difflineminus">-          if (rerootingFolder) {</span>
<a href="#l19.246"></a><span id="l19.246" class="difflineminus">-            viewDebug(&quot;uri = gCurrentFolderToReroot, setting gQSViewIsDirty\n&quot;);</span>
<a href="#l19.247"></a><span id="l19.247" class="difflineminus">-            gQSViewIsDirty = true;</span>
<a href="#l19.248"></a><span id="l19.248" class="difflineminus">-            gCurrentFolderToReroot = null;</span>
<a href="#l19.249"></a><span id="l19.249" class="difflineminus">-            if (msgFolder) {</span>
<a href="#l19.250"></a><span id="l19.250" class="difflineminus">-              msgFolder.endFolderLoading();</span>
<a href="#l19.251"></a><span id="l19.251" class="difflineminus">-              UpdateStatusQuota(msgFolder);</span>
<a href="#l19.252"></a><span id="l19.252" class="difflineminus">-              // Suppress command updating when rerooting the folder.</span>
<a href="#l19.253"></a><span id="l19.253" class="difflineminus">-              // When rerooting, we'll be clearing the selection</span>
<a href="#l19.254"></a><span id="l19.254" class="difflineminus">-              // which will cause us to update commands.</span>
<a href="#l19.255"></a><span id="l19.255" class="difflineminus">-              if (gDBView) {</span>
<a href="#l19.256"></a><span id="l19.256" class="difflineminus">-                gDBView.suppressCommandUpdating = true;</span>
<a href="#l19.257"></a><span id="l19.257" class="difflineminus">-                // If the db's view isn't set, something went wrong and we</span>
<a href="#l19.258"></a><span id="l19.258" class="difflineminus">-                // should reroot the folder, which will re-open the view.</span>
<a href="#l19.259"></a><span id="l19.259" class="difflineminus">-                if (!gDBView.db)</span>
<a href="#l19.260"></a><span id="l19.260" class="difflineminus">-                  gRerootOnFolderLoad = true;</span>
<a href="#l19.261"></a><span id="l19.261" class="difflineminus">-              }</span>
<a href="#l19.262"></a><span id="l19.262" class="difflineminus">-              if (gRerootOnFolderLoad)</span>
<a href="#l19.263"></a><span id="l19.263" class="difflineminus">-                RerootFolder(uri, msgFolder, gCurrentLoadingFolderViewType, gCurrentLoadingFolderViewFlags, gCurrentLoadingFolderSortType, gCurrentLoadingFolderSortOrder);</span>
<a href="#l19.264"></a><span id="l19.264" class="difflineminus">-</span>
<a href="#l19.265"></a><span id="l19.265" class="difflineminus">-              var db = msgFolder.msgDatabase;</span>
<a href="#l19.266"></a><span id="l19.266" class="difflineminus">-              if (db)</span>
<a href="#l19.267"></a><span id="l19.267" class="difflineminus">-                db.resetHdrCacheSize(100);</span>
<a href="#l19.268"></a><span id="l19.268" class="difflineminus">-</span>
<a href="#l19.269"></a><span id="l19.269" class="difflineminus">-              if (gDBView) {</span>
<a href="#l19.270"></a><span id="l19.270" class="difflineminus">-                gDBView.suppressCommandUpdating = false;</span>
<a href="#l19.271"></a><span id="l19.271" class="difflineminus">-              }</span>
<a href="#l19.272"></a><span id="l19.272" class="difflineminus">-</span>
<a href="#l19.273"></a><span id="l19.273" class="difflineminus">-              gCurrentLoadingFolderSortType = 0;</span>
<a href="#l19.274"></a><span id="l19.274" class="difflineminus">-              gCurrentLoadingFolderSortOrder = 0;</span>
<a href="#l19.275"></a><span id="l19.275" class="difflineminus">-              gCurrentLoadingFolderViewType = 0;</span>
<a href="#l19.276"></a><span id="l19.276" class="difflineminus">-              gCurrentLoadingFolderViewFlags = 0;</span>
<a href="#l19.277"></a><span id="l19.277" class="difflineminus">-</span>
<a href="#l19.278"></a><span id="l19.278" class="difflineminus">-              // Used for rename folder msg loading after folder is loaded.</span>
<a href="#l19.279"></a><span id="l19.279" class="difflineminus">-              scrolled = LoadCurrentlyDisplayedMessage();</span>
<a href="#l19.280"></a><span id="l19.280" class="difflineminus">-</span>
<a href="#l19.281"></a><span id="l19.281" class="difflineminus">-              if (gStartMsgKey != nsMsgKey_None) {</span>
<a href="#l19.282"></a><span id="l19.282" class="difflineminus">-                scrolled = SelectAndScrollToKey(gStartMsgKey);</span>
<a href="#l19.283"></a><span id="l19.283" class="difflineminus">-                gStartMsgKey = nsMsgKey_None;</span>
<a href="#l19.284"></a><span id="l19.284" class="difflineminus">-              }</span>
<a href="#l19.285"></a><span id="l19.285" class="difflineminus">-</span>
<a href="#l19.286"></a><span id="l19.286" class="difflineminus">-              if (gNextMessageAfterLoad) {</span>
<a href="#l19.287"></a><span id="l19.287" class="difflineminus">-                var type = gNextMessageAfterLoad;</span>
<a href="#l19.288"></a><span id="l19.288" class="difflineminus">-                gNextMessageAfterLoad = null;</span>
<a href="#l19.289"></a><span id="l19.289" class="difflineminus">-</span>
<a href="#l19.290"></a><span id="l19.290" class="difflineminus">-                // Scroll to and select the proper message.</span>
<a href="#l19.291"></a><span id="l19.291" class="difflineminus">-                scrolled = ScrollToMessage(type, true, true /* selectMessage */);</span>
<a href="#l19.292"></a><span id="l19.292" class="difflineminus">-              }</span>
<a href="#l19.293"></a><span id="l19.293" class="difflineminus">-            }</span>
<a href="#l19.294"></a><span id="l19.294" class="difflineminus">-          }</span>
<a href="#l19.295"></a><span id="l19.295" class="difflineminus">-          const nsMsgFolderFlags = Components.interfaces.nsMsgFolderFlags;</span>
<a href="#l19.296"></a><span id="l19.296" class="difflineminus">-          if (uri == gCurrentLoadingFolderURI) {</span>
<a href="#l19.297"></a><span id="l19.297" class="difflineminus">-            viewDebug(&quot;uri == current loading folder uri\n&quot;);</span>
<a href="#l19.298"></a><span id="l19.298" class="difflineminus">-            gCurrentLoadingFolderURI = &quot;&quot;;</span>
<a href="#l19.299"></a><span id="l19.299" class="difflineminus">-            // Scroll to message for virtual folders is done in</span>
<a href="#l19.300"></a><span id="l19.300" class="difflineminus">-            // gSearchNotificationListener.OnSearchDone (see searchBar.js).</span>
<a href="#l19.301"></a><span id="l19.301" class="difflineminus">-            if (!scrolled &amp;&amp; gMsgFolderSelected &amp;&amp;</span>
<a href="#l19.302"></a><span id="l19.302" class="difflineminus">-                !(gMsgFolderSelected.flags &amp; nsMsgFolderFlags.Virtual))</span>
<a href="#l19.303"></a><span id="l19.303" class="difflineminus">-              ScrollToMessageAfterFolderLoad(msgFolder);</span>
<a href="#l19.304"></a><span id="l19.304" class="difflineminus">-            SetBusyCursor(window, false);</span>
<a href="#l19.305"></a><span id="l19.305" class="difflineminus">-          }</span>
<a href="#l19.306"></a><span id="l19.306" class="difflineminus">-          // Folder loading is over,</span>
<a href="#l19.307"></a><span id="l19.307" class="difflineminus">-          // now issue quick search if there is an email address.</span>
<a href="#l19.308"></a><span id="l19.308" class="difflineminus">-          viewDebug(&quot;in folder loaded gVirtualFolderTerms = &quot; + gVirtualFolderTerms + &quot;\n&quot;);</span>
<a href="#l19.309"></a><span id="l19.309" class="difflineminus">-          viewDebug(&quot;in folder loaded gMsgFolderSelected = &quot; + gMsgFolderSelected.URI + &quot;\n&quot;);</span>
<a href="#l19.310"></a><span id="l19.310" class="difflineminus">-          if (rerootingFolder)</span>
<a href="#l19.311"></a><span id="l19.311" class="difflineminus">-          {</span>
<a href="#l19.312"></a><span id="l19.312" class="difflineminus">-            if (gSearchEmailAddress)</span>
<a href="#l19.313"></a><span id="l19.313" class="difflineminus">-            {</span>
<a href="#l19.314"></a><span id="l19.314" class="difflineminus">-              Search(gSearchEmailAddress);</span>
<a href="#l19.315"></a><span id="l19.315" class="difflineminus">-              gSearchEmailAddress = null;</span>
<a href="#l19.316"></a><span id="l19.316" class="difflineminus">-            }</span>
<a href="#l19.317"></a><span id="l19.317" class="difflineminus">-            else if (gVirtualFolderTerms)</span>
<a href="#l19.318"></a><span id="l19.318" class="difflineminus">-            {</span>
<a href="#l19.319"></a><span id="l19.319" class="difflineminus">-              gDefaultSearchViewTerms = null;</span>
<a href="#l19.320"></a><span id="l19.320" class="difflineminus">-              viewDebug(&quot;searching gVirtualFolderTerms\n&quot;);</span>
<a href="#l19.321"></a><span id="l19.321" class="difflineminus">-              gDBView.viewFolder = gMsgFolderSelected;</span>
<a href="#l19.322"></a><span id="l19.322" class="difflineminus">-              ViewChangeByFolder(gMsgFolderSelected);</span>
<a href="#l19.323"></a><span id="l19.323" class="difflineminus">-            }</span>
<a href="#l19.324"></a><span id="l19.324" class="difflineminus">-            else if (gMsgFolderSelected.flags &amp; nsMsgFolderFlags.Virtual)</span>
<a href="#l19.325"></a><span id="l19.325" class="difflineminus">-            {</span>
<a href="#l19.326"></a><span id="l19.326" class="difflineminus">-              viewDebug(&quot;selected folder is virtual\n&quot;);</span>
<a href="#l19.327"></a><span id="l19.327" class="difflineminus">-              gDefaultSearchViewTerms = null;</span>
<a href="#l19.328"></a><span id="l19.328" class="difflineminus">-            }</span>
<a href="#l19.329"></a><span id="l19.329" class="difflineminus">-            else</span>
<a href="#l19.330"></a><span id="l19.330" class="difflineminus">-            {</span>
<a href="#l19.331"></a><span id="l19.331" class="difflineminus">-              // Get the view value from the folder.</span>
<a href="#l19.332"></a><span id="l19.332" class="difflineminus">-              if (msgFolder)</span>
<a href="#l19.333"></a><span id="l19.333" class="difflineminus">-              {</span>
<a href="#l19.334"></a><span id="l19.334" class="difflineminus">-                // If our new view is the same as the old view and we already</span>
<a href="#l19.335"></a><span id="l19.335" class="difflineminus">-                // have the list of search terms built up for the old view,</span>
<a href="#l19.336"></a><span id="l19.336" class="difflineminus">-                // just re-use it.</span>
<a href="#l19.337"></a><span id="l19.337" class="difflineminus">-                var result = GetMailViewForFolder(msgFolder);</span>
<a href="#l19.338"></a><span id="l19.338" class="difflineminus">-                if (GetSearchInput() &amp;&amp; gCurrentViewValue == result &amp;&amp; gDefaultSearchViewTerms)</span>
<a href="#l19.339"></a><span id="l19.339" class="difflineminus">-                {</span>
<a href="#l19.340"></a><span id="l19.340" class="difflineminus">-                  viewDebug(&quot;searching gDefaultSearchViewTerms and rerootingFolder\n&quot;);</span>
<a href="#l19.341"></a><span id="l19.341" class="difflineminus">-                  Search(&quot;&quot;);</span>
<a href="#l19.342"></a><span id="l19.342" class="difflineminus">-                }</span>
<a href="#l19.343"></a><span id="l19.343" class="difflineminus">-                else if (document.getElementById(&quot;mailviews-container&quot;)) // Only load the folder view if the views toolbar is visible.</span>
<a href="#l19.344"></a><span id="l19.344" class="difflineminus">-                {</span>
<a href="#l19.345"></a><span id="l19.345" class="difflineminus">-                  viewDebug(&quot;changing view by value\n&quot;);</span>
<a href="#l19.346"></a><span id="l19.346" class="difflineminus">-                  ViewChangeByValue(result);</span>
<a href="#l19.347"></a><span id="l19.347" class="difflineminus">-                }</span>
<a href="#l19.348"></a><span id="l19.348" class="difflineminus">-              }</span>
<a href="#l19.349"></a><span id="l19.349" class="difflineminus">-            }</span>
<a href="#l19.350"></a><span id="l19.350" class="difflineminus">-          }</span>
<a href="#l19.351"></a><span id="l19.351" class="difflineminus">-        }</span>
<a href="#l19.352"></a><span id="l19.352" class="difflineminus">-      }</span>
<a href="#l19.353"></a><span id="l19.353" class="difflineminus">-      else if (eventType == &quot;ImapHdrDownloaded&quot;) {</span>
<a href="#l19.354"></a><span id="l19.354" class="difflineplus">+      if (eventType == &quot;ImapHdrDownloaded&quot;) {</span>
<a href="#l19.355"></a><span id="l19.355">         if (folder) {</span>
<a href="#l19.356"></a><span id="l19.356">           var imapFolder = folder.QueryInterface(Components.interfaces.nsIMsgImapMailFolder);</span>
<a href="#l19.357"></a><span id="l19.357">           if (imapFolder) {</span>
<a href="#l19.358"></a><span id="l19.358">             var hdrParser = imapFolder.hdrParser;</span>
<a href="#l19.359"></a><span id="l19.359">             if (hdrParser) {</span>
<a href="#l19.360"></a><span id="l19.360">               var msgHdr = hdrParser.GetNewMsgHdr();</span>
<a href="#l19.361"></a><span id="l19.361">               if (msgHdr)</span>
<a href="#l19.362"></a><span id="l19.362">               {</span>
<a href="#l19.363"></a><span id="l19.363" class="difflineat">@@ -311,232 +132,22 @@ var folderListener = {</span>
<a href="#l19.364"></a><span id="l19.364">                 if (hdrs &amp;&amp; hdrs.indexOf(&quot;X-image-size:&quot;) &gt; 0) {</span>
<a href="#l19.365"></a><span id="l19.365">                   msgHdr.setStringProperty(&quot;imageSize&quot;, &quot;1&quot;);</span>
<a href="#l19.366"></a><span id="l19.366">                 }</span>
<a href="#l19.367"></a><span id="l19.367">               }</span>
<a href="#l19.368"></a><span id="l19.368">             }</span>
<a href="#l19.369"></a><span id="l19.369">           }</span>
<a href="#l19.370"></a><span id="l19.370">         }</span>
<a href="#l19.371"></a><span id="l19.371">       }</span>
<a href="#l19.372"></a><span id="l19.372" class="difflineminus">-      else if (eventType == &quot;DeleteOrMoveMsgCompleted&quot;) {</span>
<a href="#l19.373"></a><span id="l19.373" class="difflineminus">-        HandleDeleteOrMoveMsgCompleted(folder);</span>
<a href="#l19.374"></a><span id="l19.374" class="difflineminus">-      }</span>
<a href="#l19.375"></a><span id="l19.375" class="difflineminus">-      else if (eventType == &quot;DeleteOrMoveMsgFailed&quot;) {</span>
<a href="#l19.376"></a><span id="l19.376" class="difflineminus">-        HandleDeleteOrMoveMsgFailed(folder);</span>
<a href="#l19.377"></a><span id="l19.377" class="difflineminus">-      }</span>
<a href="#l19.378"></a><span id="l19.378" class="difflineminus">-      else if (eventType == &quot;AboutToCompact&quot;) {</span>
<a href="#l19.379"></a><span id="l19.379" class="difflineminus">-        if (gDBView)</span>
<a href="#l19.380"></a><span id="l19.380" class="difflineminus">-          gCurrentlyDisplayedMessage = gDBView.currentlyDisplayedMessage;</span>
<a href="#l19.381"></a><span id="l19.381" class="difflineminus">-      }</span>
<a href="#l19.382"></a><span id="l19.382" class="difflineminus">-      else if (eventType == &quot;CompactCompleted&quot;) {</span>
<a href="#l19.383"></a><span id="l19.383" class="difflineminus">-        HandleCompactCompleted(folder);</span>
<a href="#l19.384"></a><span id="l19.384" class="difflineminus">-      }</span>
<a href="#l19.385"></a><span id="l19.385" class="difflineminus">-      else if (eventType == &quot;RenameCompleted&quot;) {</span>
<a href="#l19.386"></a><span id="l19.386" class="difflineminus">-        gFolderTreeView.selectFolder(folder);</span>
<a href="#l19.387"></a><span id="l19.387" class="difflineminus">-      }</span>
<a href="#l19.388"></a><span id="l19.388">       else if (eventType == &quot;JunkStatusChanged&quot;) {</span>
<a href="#l19.389"></a><span id="l19.389">         HandleJunkStatusChanged(folder);</span>
<a href="#l19.390"></a><span id="l19.390">       }</span>
<a href="#l19.391"></a><span id="l19.391">     }</span>
<a href="#l19.392"></a><span id="l19.392"> }</span>
<a href="#l19.393"></a><span id="l19.393"> </span>
<a href="#l19.394"></a><span id="l19.394" class="difflineminus">-function HandleDeleteOrMoveMsgFailed(folder)</span>
<a href="#l19.395"></a><span id="l19.395" class="difflineminus">-{</span>
<a href="#l19.396"></a><span id="l19.396" class="difflineminus">-  gDBView.onDeleteCompleted(false);</span>
<a href="#l19.397"></a><span id="l19.397" class="difflineminus">-  if(IsCurrentLoadedFolder(folder)) {</span>
<a href="#l19.398"></a><span id="l19.398" class="difflineminus">-    if(gNextMessageAfterDelete) {</span>
<a href="#l19.399"></a><span id="l19.399" class="difflineminus">-      gNextMessageAfterDelete = null;</span>
<a href="#l19.400"></a><span id="l19.400" class="difflineminus">-      gNextMessageViewIndexAfterDelete = -2;</span>
<a href="#l19.401"></a><span id="l19.401" class="difflineminus">-    }</span>
<a href="#l19.402"></a><span id="l19.402" class="difflineminus">-  }</span>
<a href="#l19.403"></a><span id="l19.403" class="difflineminus">-</span>
<a href="#l19.404"></a><span id="l19.404" class="difflineminus">-  // fix me???</span>
<a href="#l19.405"></a><span id="l19.405" class="difflineminus">-  // ThreadPaneSelectionChange(true);</span>
<a href="#l19.406"></a><span id="l19.406" class="difflineminus">-}</span>
<a href="#l19.407"></a><span id="l19.407" class="difflineminus">-</span>
<a href="#l19.408"></a><span id="l19.408" class="difflineminus">-// WARNING</span>
<a href="#l19.409"></a><span id="l19.409" class="difflineminus">-// this is a fragile and complicated function.</span>
<a href="#l19.410"></a><span id="l19.410" class="difflineminus">-// be careful when hacking on it.</span>
<a href="#l19.411"></a><span id="l19.411" class="difflineminus">-// Don't forget about things like different imap</span>
<a href="#l19.412"></a><span id="l19.412" class="difflineminus">-// delete models, multiple views (from multiple thread panes,</span>
<a href="#l19.413"></a><span id="l19.413" class="difflineminus">-// search windows, stand alone message windows)</span>
<a href="#l19.414"></a><span id="l19.414" class="difflineminus">-function HandleDeleteOrMoveMsgCompleted(folder)</span>
<a href="#l19.415"></a><span id="l19.415" class="difflineminus">-{</span>
<a href="#l19.416"></a><span id="l19.416" class="difflineminus">-  // you might not have a db view.  this can happen if</span>
<a href="#l19.417"></a><span id="l19.417" class="difflineminus">-  // biff fires when the 3 pane is set to account central.</span>
<a href="#l19.418"></a><span id="l19.418" class="difflineminus">-  if (!gDBView)</span>
<a href="#l19.419"></a><span id="l19.419" class="difflineminus">-    return;</span>
<a href="#l19.420"></a><span id="l19.420" class="difflineminus">-</span>
<a href="#l19.421"></a><span id="l19.421" class="difflineminus">-  gDBView.onDeleteCompleted(true);</span>
<a href="#l19.422"></a><span id="l19.422" class="difflineminus">-</span>
<a href="#l19.423"></a><span id="l19.423" class="difflineminus">-  if (!IsCurrentLoadedFolder(folder)) {</span>
<a href="#l19.424"></a><span id="l19.424" class="difflineminus">-    // default value after delete/move/copy is over</span>
<a href="#l19.425"></a><span id="l19.425" class="difflineminus">-    gNextMessageViewIndexAfterDelete = -2;</span>
<a href="#l19.426"></a><span id="l19.426" class="difflineminus">-    return;</span>
<a href="#l19.427"></a><span id="l19.427" class="difflineminus">-  }</span>
<a href="#l19.428"></a><span id="l19.428" class="difflineminus">-</span>
<a href="#l19.429"></a><span id="l19.429" class="difflineminus">-  var treeView = gDBView.QueryInterface(Components.interfaces.nsITreeView);</span>
<a href="#l19.430"></a><span id="l19.430" class="difflineminus">-  var treeSelection = treeView.selection;</span>
<a href="#l19.431"></a><span id="l19.431" class="difflineminus">-</span>
<a href="#l19.432"></a><span id="l19.432" class="difflineminus">-  if (gNextMessageViewIndexAfterDelete == -2) {</span>
<a href="#l19.433"></a><span id="l19.433" class="difflineminus">-    // a move or delete can cause our selection can change underneath us.</span>
<a href="#l19.434"></a><span id="l19.434" class="difflineminus">-    // this can happen when the user</span>
<a href="#l19.435"></a><span id="l19.435" class="difflineminus">-    // deletes message from the stand alone msg window</span>
<a href="#l19.436"></a><span id="l19.436" class="difflineminus">-    // or the search view, or another 3 pane</span>
<a href="#l19.437"></a><span id="l19.437" class="difflineminus">-    if (treeSelection.count == 0) {</span>
<a href="#l19.438"></a><span id="l19.438" class="difflineminus">-      // this can happen if you double clicked a message</span>
<a href="#l19.439"></a><span id="l19.439" class="difflineminus">-      // in the thread pane, and deleted it from the stand alone msg window</span>
<a href="#l19.440"></a><span id="l19.440" class="difflineminus">-      // see bug #172392</span>
<a href="#l19.441"></a><span id="l19.441" class="difflineminus">-      treeSelection.clearSelection();</span>
<a href="#l19.442"></a><span id="l19.442" class="difflineminus">-      setTitleFromFolder(folder, null);</span>
<a href="#l19.443"></a><span id="l19.443" class="difflineminus">-      ClearMessagePane();</span>
<a href="#l19.444"></a><span id="l19.444" class="difflineminus">-      UpdateMailToolbar(&quot;delete from another view, 0 rows now selected&quot;);</span>
<a href="#l19.445"></a><span id="l19.445" class="difflineminus">-    }</span>
<a href="#l19.446"></a><span id="l19.446" class="difflineminus">-    else if (treeSelection.count == 1) {</span>
<a href="#l19.447"></a><span id="l19.447" class="difflineminus">-      // this can happen if you had two messages selected</span>
<a href="#l19.448"></a><span id="l19.448" class="difflineminus">-      // in the thread pane, and you deleted one of them from another view</span>
<a href="#l19.449"></a><span id="l19.449" class="difflineminus">-      // (like the view in the stand alone msg window)</span>
<a href="#l19.450"></a><span id="l19.450" class="difflineminus">-      // since one item is selected, we should load it.</span>
<a href="#l19.451"></a><span id="l19.451" class="difflineminus">-      var startIndex = {};</span>
<a href="#l19.452"></a><span id="l19.452" class="difflineminus">-      var endIndex = {};</span>
<a href="#l19.453"></a><span id="l19.453" class="difflineminus">-      treeSelection.getRangeAt(0, startIndex, endIndex);</span>
<a href="#l19.454"></a><span id="l19.454" class="difflineminus">-</span>
<a href="#l19.455"></a><span id="l19.455" class="difflineminus">-      // select the selected item, so we'll load it</span>
<a href="#l19.456"></a><span id="l19.456" class="difflineminus">-      treeSelection.select(startIndex.value);</span>
<a href="#l19.457"></a><span id="l19.457" class="difflineminus">-      treeView.selectionChanged();</span>
<a href="#l19.458"></a><span id="l19.458" class="difflineminus">-</span>
<a href="#l19.459"></a><span id="l19.459" class="difflineminus">-      EnsureRowInThreadTreeIsVisible(startIndex.value);</span>
<a href="#l19.460"></a><span id="l19.460" class="difflineminus">-</span>
<a href="#l19.461"></a><span id="l19.461" class="difflineminus">-      UpdateMailToolbar(&quot;delete from another view, 1 row now selected&quot;);</span>
<a href="#l19.462"></a><span id="l19.462" class="difflineminus">-    }</span>
<a href="#l19.463"></a><span id="l19.463" class="difflineminus">-    else {</span>
<a href="#l19.464"></a><span id="l19.464" class="difflineminus">-      // this can happen if you have more than 2 messages selected</span>
<a href="#l19.465"></a><span id="l19.465" class="difflineminus">-      // in the thread pane, and you deleted one of them from another view</span>
<a href="#l19.466"></a><span id="l19.466" class="difflineminus">-      // (like the view in the stand alone msg window)</span>
<a href="#l19.467"></a><span id="l19.467" class="difflineminus">-      // since multiple messages are still selected, do nothing.</span>
<a href="#l19.468"></a><span id="l19.468" class="difflineminus">-    }</span>
<a href="#l19.469"></a><span id="l19.469" class="difflineminus">-  }</span>
<a href="#l19.470"></a><span id="l19.470" class="difflineminus">-  else {</span>
<a href="#l19.471"></a><span id="l19.471" class="difflineminus">-    if (gNextMessageViewIndexAfterDelete != nsMsgViewIndex_None)</span>
<a href="#l19.472"></a><span id="l19.472" class="difflineminus">-    {</span>
<a href="#l19.473"></a><span id="l19.473" class="difflineminus">-      var viewSize = treeView.rowCount;</span>
<a href="#l19.474"></a><span id="l19.474" class="difflineminus">-      if (gNextMessageViewIndexAfterDelete &gt;= viewSize)</span>
<a href="#l19.475"></a><span id="l19.475" class="difflineminus">-      {</span>
<a href="#l19.476"></a><span id="l19.476" class="difflineminus">-        if (viewSize &gt; 0)</span>
<a href="#l19.477"></a><span id="l19.477" class="difflineminus">-          gNextMessageViewIndexAfterDelete = viewSize - 1;</span>
<a href="#l19.478"></a><span id="l19.478" class="difflineminus">-        else</span>
<a href="#l19.479"></a><span id="l19.479" class="difflineminus">-        {</span>
<a href="#l19.480"></a><span id="l19.480" class="difflineminus">-          gNextMessageViewIndexAfterDelete = nsMsgViewIndex_None;</span>
<a href="#l19.481"></a><span id="l19.481" class="difflineminus">-</span>
<a href="#l19.482"></a><span id="l19.482" class="difflineminus">-          // there is nothing to select since viewSize is 0</span>
<a href="#l19.483"></a><span id="l19.483" class="difflineminus">-          treeSelection.clearSelection();</span>
<a href="#l19.484"></a><span id="l19.484" class="difflineminus">-          setTitleFromFolder(folder, null);</span>
<a href="#l19.485"></a><span id="l19.485" class="difflineminus">-          ClearMessagePane();</span>
<a href="#l19.486"></a><span id="l19.486" class="difflineminus">-          UpdateMailToolbar(&quot;delete from current view, 0 rows left&quot;);</span>
<a href="#l19.487"></a><span id="l19.487" class="difflineminus">-        }</span>
<a href="#l19.488"></a><span id="l19.488" class="difflineminus">-      }</span>
<a href="#l19.489"></a><span id="l19.489" class="difflineminus">-    }</span>
<a href="#l19.490"></a><span id="l19.490" class="difflineminus">-</span>
<a href="#l19.491"></a><span id="l19.491" class="difflineminus">-    // if we are about to set the selection with a new element then DON'T clear</span>
<a href="#l19.492"></a><span id="l19.492" class="difflineminus">-    // the selection then add the next message to select. This just generates</span>
<a href="#l19.493"></a><span id="l19.493" class="difflineminus">-    // an extra round of command updating notifications that we are trying to</span>
<a href="#l19.494"></a><span id="l19.494" class="difflineminus">-    // optimize away.</span>
<a href="#l19.495"></a><span id="l19.495" class="difflineminus">-    if (gNextMessageViewIndexAfterDelete != nsMsgViewIndex_None)</span>
<a href="#l19.496"></a><span id="l19.496" class="difflineminus">-    {</span>
<a href="#l19.497"></a><span id="l19.497" class="difflineminus">-      // When deleting a message we don't update the commands</span>
<a href="#l19.498"></a><span id="l19.498" class="difflineminus">-      // when the selection goes to 0</span>
<a href="#l19.499"></a><span id="l19.499" class="difflineminus">-      // (we have a hack in nsMsgDBView which prevents that update)</span>
<a href="#l19.500"></a><span id="l19.500" class="difflineminus">-      // so there is no need to</span>
<a href="#l19.501"></a><span id="l19.501" class="difflineminus">-      // update commands when we select the next message after the delete;</span>
<a href="#l19.502"></a><span id="l19.502" class="difflineminus">-      // the commands already</span>
<a href="#l19.503"></a><span id="l19.503" class="difflineminus">-      // have the right update state...</span>
<a href="#l19.504"></a><span id="l19.504" class="difflineminus">-      gDBView.suppressCommandUpdating = true;</span>
<a href="#l19.505"></a><span id="l19.505" class="difflineminus">-</span>
<a href="#l19.506"></a><span id="l19.506" class="difflineminus">-      // This check makes sure that the tree does not perform a</span>
<a href="#l19.507"></a><span id="l19.507" class="difflineminus">-      // selection on a non selected row (row &lt; 0), else assertions will</span>
<a href="#l19.508"></a><span id="l19.508" class="difflineminus">-      // be thrown.</span>
<a href="#l19.509"></a><span id="l19.509" class="difflineminus">-      if (gNextMessageViewIndexAfterDelete &gt;= 0)</span>
<a href="#l19.510"></a><span id="l19.510" class="difflineminus">-        treeSelection.select(gNextMessageViewIndexAfterDelete);</span>
<a href="#l19.511"></a><span id="l19.511" class="difflineminus">-</span>
<a href="#l19.512"></a><span id="l19.512" class="difflineminus">-      // If gNextMessageViewIndexAfterDelete has the same value</span>
<a href="#l19.513"></a><span id="l19.513" class="difflineminus">-      // as the last index we had selected, the tree won't generate a</span>
<a href="#l19.514"></a><span id="l19.514" class="difflineminus">-      // selectionChanged notification for the tree view. So force a manual</span>
<a href="#l19.515"></a><span id="l19.515" class="difflineminus">-      // selection changed call.</span>
<a href="#l19.516"></a><span id="l19.516" class="difflineminus">-      // (don't worry it's cheap if we end up calling it twice).</span>
<a href="#l19.517"></a><span id="l19.517" class="difflineminus">-      if (treeView)</span>
<a href="#l19.518"></a><span id="l19.518" class="difflineminus">-        treeView.selectionChanged();</span>
<a href="#l19.519"></a><span id="l19.519" class="difflineminus">-</span>
<a href="#l19.520"></a><span id="l19.520" class="difflineminus">-      EnsureRowInThreadTreeIsVisible(gNextMessageViewIndexAfterDelete);</span>
<a href="#l19.521"></a><span id="l19.521" class="difflineminus">-      gDBView.suppressCommandUpdating = false;</span>
<a href="#l19.522"></a><span id="l19.522" class="difflineminus">-</span>
<a href="#l19.523"></a><span id="l19.523" class="difflineminus">-      // hook for extra toolbar items</span>
<a href="#l19.524"></a><span id="l19.524" class="difflineminus">-      // XXX TODO</span>
<a href="#l19.525"></a><span id="l19.525" class="difflineminus">-      // I think there is a bug in the suppression code above.</span>
<a href="#l19.526"></a><span id="l19.526" class="difflineminus">-      // What if I have two rows selected, and I hit delete,</span>
<a href="#l19.527"></a><span id="l19.527" class="difflineminus">-      // and so we load the next row.</span>
<a href="#l19.528"></a><span id="l19.528" class="difflineminus">-      // What if I have commands that only enable where</span>
<a href="#l19.529"></a><span id="l19.529" class="difflineminus">-      // exactly one row is selected?</span>
<a href="#l19.530"></a><span id="l19.530" class="difflineminus">-      UpdateMailToolbar(&quot;delete from current view, at least one row selected&quot;);</span>
<a href="#l19.531"></a><span id="l19.531" class="difflineminus">-    }</span>
<a href="#l19.532"></a><span id="l19.532" class="difflineminus">-  }</span>
<a href="#l19.533"></a><span id="l19.533" class="difflineminus">-</span>
<a href="#l19.534"></a><span id="l19.534" class="difflineminus">-  // default value after delete/move/copy is over</span>
<a href="#l19.535"></a><span id="l19.535" class="difflineminus">-  gNextMessageViewIndexAfterDelete = -2;</span>
<a href="#l19.536"></a><span id="l19.536" class="difflineminus">-}</span>
<a href="#l19.537"></a><span id="l19.537" class="difflineminus">-</span>
<a href="#l19.538"></a><span id="l19.538" class="difflineminus">-function HandleCompactCompleted(folder)</span>
<a href="#l19.539"></a><span id="l19.539" class="difflineminus">-{</span>
<a href="#l19.540"></a><span id="l19.540" class="difflineminus">-  if (folder &amp;&amp; folder.server.type != &quot;imap&quot;)</span>
<a href="#l19.541"></a><span id="l19.541" class="difflineminus">-  {</span>
<a href="#l19.542"></a><span id="l19.542" class="difflineminus">-    var msgFolder = msgWindow.openFolder;</span>
<a href="#l19.543"></a><span id="l19.543" class="difflineminus">-    if (msgFolder &amp;&amp; folder.URI == msgFolder.URI)</span>
<a href="#l19.544"></a><span id="l19.544" class="difflineminus">-    {</span>
<a href="#l19.545"></a><span id="l19.545" class="difflineminus">-      // pretend the selection changed, to reselect the current folder+view.</span>
<a href="#l19.546"></a><span id="l19.546" class="difflineminus">-      gMsgFolderSelected = null;</span>
<a href="#l19.547"></a><span id="l19.547" class="difflineminus">-      msgWindow.openFolder = null;</span>
<a href="#l19.548"></a><span id="l19.548" class="difflineminus">-      FolderPaneSelectionChange();</span>
<a href="#l19.549"></a><span id="l19.549" class="difflineminus">-      LoadCurrentlyDisplayedMessage();</span>
<a href="#l19.550"></a><span id="l19.550" class="difflineminus">-    }</span>
<a href="#l19.551"></a><span id="l19.551" class="difflineminus">-  }</span>
<a href="#l19.552"></a><span id="l19.552" class="difflineminus">-}</span>
<a href="#l19.553"></a><span id="l19.553" class="difflineminus">-</span>
<a href="#l19.554"></a><span id="l19.554" class="difflineminus">-function LoadCurrentlyDisplayedMessage()</span>
<a href="#l19.555"></a><span id="l19.555" class="difflineminus">-{</span>
<a href="#l19.556"></a><span id="l19.556" class="difflineminus">-  var scrolled = (gCurrentlyDisplayedMessage != nsMsgViewIndex_None);</span>
<a href="#l19.557"></a><span id="l19.557" class="difflineminus">-  if (scrolled)</span>
<a href="#l19.558"></a><span id="l19.558" class="difflineminus">-  {</span>
<a href="#l19.559"></a><span id="l19.559" class="difflineminus">-    var treeView = gDBView.QueryInterface(Components.interfaces.nsITreeView);</span>
<a href="#l19.560"></a><span id="l19.560" class="difflineminus">-    var treeSelection = treeView.selection;</span>
<a href="#l19.561"></a><span id="l19.561" class="difflineminus">-    treeSelection.select(gCurrentlyDisplayedMessage);</span>
<a href="#l19.562"></a><span id="l19.562" class="difflineminus">-    if (treeView)</span>
<a href="#l19.563"></a><span id="l19.563" class="difflineminus">-      treeView.selectionChanged();</span>
<a href="#l19.564"></a><span id="l19.564" class="difflineminus">-    EnsureRowInThreadTreeIsVisible(gCurrentlyDisplayedMessage);</span>
<a href="#l19.565"></a><span id="l19.565" class="difflineminus">-    SetFocusThreadPane();</span>
<a href="#l19.566"></a><span id="l19.566" class="difflineminus">-    gCurrentlyDisplayedMessage = nsMsgViewIndex_None; //reset</span>
<a href="#l19.567"></a><span id="l19.567" class="difflineminus">-  }</span>
<a href="#l19.568"></a><span id="l19.568" class="difflineminus">-  return scrolled;</span>
<a href="#l19.569"></a><span id="l19.569" class="difflineminus">-}</span>
<a href="#l19.570"></a><span id="l19.570" class="difflineminus">-</span>
<a href="#l19.571"></a><span id="l19.571" class="difflineminus">-function IsCurrentLoadedFolder(folder)</span>
<a href="#l19.572"></a><span id="l19.572" class="difflineminus">-{</span>
<a href="#l19.573"></a><span id="l19.573" class="difflineminus">-  var msgfolder = folder.QueryInterface(Components.interfaces.nsIMsgFolder);</span>
<a href="#l19.574"></a><span id="l19.574" class="difflineminus">-  var currentLoadedFolder = GetThreadPaneFolder();</span>
<a href="#l19.575"></a><span id="l19.575" class="difflineminus">-  if (currentLoadedFolder.flags &amp; Components.interfaces.nsMsgFolderFlags.Virtual)</span>
<a href="#l19.576"></a><span id="l19.576" class="difflineminus">-  {</span>
<a href="#l19.577"></a><span id="l19.577" class="difflineminus">-    var dbFolderInfo = currentLoadedFolder.msgDatabase.dBFolderInfo;</span>
<a href="#l19.578"></a><span id="l19.578" class="difflineminus">-    var srchFolderUri = dbFolderInfo.getCharProperty(&quot;searchFolderUri&quot;);</span>
<a href="#l19.579"></a><span id="l19.579" class="difflineminus">-    var re = new RegExp(&quot;^&quot; + msgfolder.URI + &quot;$|^&quot; + msgfolder.URI + &quot;\||\|&quot; +</span>
<a href="#l19.580"></a><span id="l19.580" class="difflineminus">-                        msgfolder.URI + &quot;$|\|&quot; + msgfolder.URI +&quot;\|&quot;);</span>
<a href="#l19.581"></a><span id="l19.581" class="difflineminus">-</span>
<a href="#l19.582"></a><span id="l19.582" class="difflineminus">-    return currentLoadedFolder.URI.match(re);</span>
<a href="#l19.583"></a><span id="l19.583" class="difflineminus">-  }</span>
<a href="#l19.584"></a><span id="l19.584" class="difflineminus">-</span>
<a href="#l19.585"></a><span id="l19.585" class="difflineminus">-  return (currentLoadedFolder.URI == folder.URI);</span>
<a href="#l19.586"></a><span id="l19.586" class="difflineminus">-}</span>
<a href="#l19.587"></a><span id="l19.587" class="difflineminus">-</span>
<a href="#l19.588"></a><span id="l19.588"> function ServerContainsFolder(server, folder)</span>
<a href="#l19.589"></a><span id="l19.589"> {</span>
<a href="#l19.590"></a><span id="l19.590">   if (!folder || !server)</span>
<a href="#l19.591"></a><span id="l19.591">     return false;</span>
<a href="#l19.592"></a><span id="l19.592"> </span>
<a href="#l19.593"></a><span id="l19.593">   return server.equals(folder.server);</span>
<a href="#l19.594"></a><span id="l19.594"> }</span>
<a href="#l19.595"></a><span id="l19.595"> </span>
<a href="#l19.596"></a><span id="l19.596" class="difflineat">@@ -663,29 +274,37 @@ function OnLoadMessenger()</span>
<a href="#l19.597"></a><span id="l19.597">   }</span>
<a href="#l19.598"></a><span id="l19.598"> </span>
<a href="#l19.599"></a><span id="l19.599">   gPrefBranch.QueryInterface(Components.interfaces.nsIPrefBranch2);</span>
<a href="#l19.600"></a><span id="l19.600">   gPrefBranch.addObserver(&quot;mail.pane_config.dynamic&quot;, MailPrefObserver, false);</span>
<a href="#l19.601"></a><span id="l19.601"> </span>
<a href="#l19.602"></a><span id="l19.602">   MailOfflineMgr.init();</span>
<a href="#l19.603"></a><span id="l19.603">   CreateMailWindowGlobals();</span>
<a href="#l19.604"></a><span id="l19.604">   GetMessagePane().collapsed = true;</span>
<a href="#l19.605"></a><span id="l19.605" class="difflineplus">+</span>
<a href="#l19.606"></a><span id="l19.606" class="difflineplus">+  // - initialize tabmail system</span>
<a href="#l19.607"></a><span id="l19.607" class="difflineplus">+  // Do this before LoadPostAccountWizard since that code selects the first</span>
<a href="#l19.608"></a><span id="l19.608" class="difflineplus">+  //  folder for display, and we want gFolderDisplay setup and ready to handle</span>
<a href="#l19.609"></a><span id="l19.609" class="difflineplus">+  //  that event chain.</span>
<a href="#l19.610"></a><span id="l19.610" class="difflineplus">+  // Also, we definitely need to register the tab type prior to the call to</span>
<a href="#l19.611"></a><span id="l19.611" class="difflineplus">+  //  specialTabs.openSpecialTabsOnStartup below.</span>
<a href="#l19.612"></a><span id="l19.612" class="difflineplus">+  let tabmail = document.getElementById('tabmail');</span>
<a href="#l19.613"></a><span id="l19.613" class="difflineplus">+  if (tabmail)</span>
<a href="#l19.614"></a><span id="l19.614" class="difflineplus">+  {</span>
<a href="#l19.615"></a><span id="l19.615" class="difflineplus">+    tabmail.registerTabType(mailTabType);</span>
<a href="#l19.616"></a><span id="l19.616" class="difflineplus">+    tabmail.registerTabMonitor(QuickSearchTabMonitor);</span>
<a href="#l19.617"></a><span id="l19.617" class="difflineplus">+    tabmail.openFirstTab();</span>
<a href="#l19.618"></a><span id="l19.618" class="difflineplus">+  }</span>
<a href="#l19.619"></a><span id="l19.619" class="difflineplus">+</span>
<a href="#l19.620"></a><span id="l19.620">   // verifyAccounts returns true if the callback won't be called</span>
<a href="#l19.621"></a><span id="l19.621">   // We also don't want the account wizard to open if any sort of account exists</span>
<a href="#l19.622"></a><span id="l19.622">   if (verifyAccounts(LoadPostAccountWizard, false))</span>
<a href="#l19.623"></a><span id="l19.623">     LoadPostAccountWizard();</span>
<a href="#l19.624"></a><span id="l19.624"> </span>
<a href="#l19.625"></a><span id="l19.625" class="difflineminus">-  // initialize tabmail system</span>
<a href="#l19.626"></a><span id="l19.626" class="difflineminus">-  let tabmail = document.getElementById('tabmail');</span>
<a href="#l19.627"></a><span id="l19.627" class="difflineminus">-  if (tabmail)</span>
<a href="#l19.628"></a><span id="l19.628" class="difflineminus">-  {</span>
<a href="#l19.629"></a><span id="l19.629" class="difflineminus">-    tabmail.registerTabType(mailTabType);</span>
<a href="#l19.630"></a><span id="l19.630" class="difflineminus">-    tabmail.openFirstTab();</span>
<a href="#l19.631"></a><span id="l19.631" class="difflineminus">-  }</span>
<a href="#l19.632"></a><span id="l19.632" class="difflineminus">-</span>
<a href="#l19.633"></a><span id="l19.633" class="difflineplus">+  // This also registers the contentTabType (&quot;contentTab&quot;)</span>
<a href="#l19.634"></a><span id="l19.634">   specialTabs.openSpecialTabsOnStartup();</span>
<a href="#l19.635"></a><span id="l19.635"> </span>
<a href="#l19.636"></a><span id="l19.636">   window.addEventListener(&quot;AppCommand&quot;, HandleAppCommandEvent, true);</span>
<a href="#l19.637"></a><span id="l19.637"> }</span>
<a href="#l19.638"></a><span id="l19.638"> </span>
<a href="#l19.639"></a><span id="l19.639"> function LoadPostAccountWizard()</span>
<a href="#l19.640"></a><span id="l19.640"> {</span>
<a href="#l19.641"></a><span id="l19.641">   InitMsgWindow();</span>
<a href="#l19.642"></a><span id="l19.642" class="difflineat">@@ -702,89 +321,88 @@ function LoadPostAccountWizard()</span>
<a href="#l19.643"></a><span id="l19.643"> </span>
<a href="#l19.644"></a><span id="l19.644">   gPhishingDetector.init();</span>
<a href="#l19.645"></a><span id="l19.645"> </span>
<a href="#l19.646"></a><span id="l19.646">   AddToSession();</span>
<a href="#l19.647"></a><span id="l19.647"> </span>
<a href="#l19.648"></a><span id="l19.648">   //need to add to session before trying to load start folder otherwise listeners aren't</span>
<a href="#l19.649"></a><span id="l19.649">   //set up correctly.</span>
<a href="#l19.650"></a><span id="l19.650">   // argument[0] --&gt; folder uri</span>
<a href="#l19.651"></a><span id="l19.651" class="difflineminus">-  // argument[1] --&gt; optional message key</span>
<a href="#l19.652"></a><span id="l19.652" class="difflineminus">-  // argument[2] --&gt; optional email address; // Will come from aim; needs to show msgs from buddy's email address.</span>
<a href="#l19.653"></a><span id="l19.653">   if (&quot;arguments&quot; in window)</span>
<a href="#l19.654"></a><span id="l19.654">   {</span>
<a href="#l19.655"></a><span id="l19.655">     // filter our any feed urls that came in as arguments to the new window...</span>
<a href="#l19.656"></a><span id="l19.656">     if (window.arguments.length &amp;&amp; /^feed:/i.test(window.arguments[0] ))</span>
<a href="#l19.657"></a><span id="l19.657">     {</span>
<a href="#l19.658"></a><span id="l19.658">       var feedHandler = Components.classes[&quot;@mozilla.org/newsblog-feed-downloader;1&quot;].getService(Components.interfaces.nsINewsBlogFeedDownloader);</span>
<a href="#l19.659"></a><span id="l19.659">       if (feedHandler)</span>
<a href="#l19.660"></a><span id="l19.660">         feedHandler.subscribeToFeed(window.arguments[0], null, msgWindow);</span>
<a href="#l19.661"></a><span id="l19.661">       gStartFolderUri = null;</span>
<a href="#l19.662"></a><span id="l19.662">     }</span>
<a href="#l19.663"></a><span id="l19.663">     else</span>
<a href="#l19.664"></a><span id="l19.664">       gStartFolderUri = (window.arguments.length &gt; 0) ? window.arguments[0] : null;</span>
<a href="#l19.665"></a><span id="l19.665" class="difflineminus">-    gStartMsgKey = (window.arguments.length &gt; 1) ? window.arguments[1]: nsMsgKey_None;</span>
<a href="#l19.666"></a><span id="l19.666" class="difflineminus">-    gSearchEmailAddress = (window.arguments.length &gt; 2) ? window.arguments[2] : null;</span>
<a href="#l19.667"></a><span id="l19.667">   }</span>
<a href="#l19.668"></a><span id="l19.668"> </span>
<a href="#l19.669"></a><span id="l19.669">   function completeStartup() {</span>
<a href="#l19.670"></a><span id="l19.670" class="difflineminus">-#ifdef HAVE_SHELL_SERVICE</span>
<a href="#l19.671"></a><span id="l19.671">     // Check whether we need to show the default client dialog</span>
<a href="#l19.672"></a><span id="l19.672">     // First, check the shell service</span>
<a href="#l19.673"></a><span id="l19.673">     var nsIShellService = Components.interfaces.nsIShellService;</span>
<a href="#l19.674"></a><span id="l19.674" class="difflineminus">-    var shellService;</span>
<a href="#l19.675"></a><span id="l19.675" class="difflineminus">-    var defaultAccount;</span>
<a href="#l19.676"></a><span id="l19.676" class="difflineminus">-    try {</span>
<a href="#l19.677"></a><span id="l19.677" class="difflineminus">-      shellService = Components.classes[&quot;@mozilla.org/mail/shell-service;1&quot;].getService(nsIShellService);</span>
<a href="#l19.678"></a><span id="l19.678" class="difflineminus">-      defaultAccount = accountManager.defaultAccount;</span>
<a href="#l19.679"></a><span id="l19.679" class="difflineminus">-    } catch (ex) {}</span>
<a href="#l19.680"></a><span id="l19.680" class="difflineplus">+    if (nsIShellService) {</span>
<a href="#l19.681"></a><span id="l19.681" class="difflineplus">+      var shellService;</span>
<a href="#l19.682"></a><span id="l19.682" class="difflineplus">+      var defaultAccount;</span>
<a href="#l19.683"></a><span id="l19.683" class="difflineplus">+      try {</span>
<a href="#l19.684"></a><span id="l19.684" class="difflineplus">+        shellService = Components.classes[&quot;@mozilla.org/mail/shell-service;1&quot;].getService(nsIShellService);</span>
<a href="#l19.685"></a><span id="l19.685" class="difflineplus">+        defaultAccount = accountManager.defaultAccount;</span>
<a href="#l19.686"></a><span id="l19.686" class="difflineplus">+      } catch (ex) {}</span>
<a href="#l19.687"></a><span id="l19.687"> </span>
<a href="#l19.688"></a><span id="l19.688" class="difflineminus">-    // Next, try loading the search integration module</span>
<a href="#l19.689"></a><span id="l19.689" class="difflineminus">-    // We'll get a null SearchIntegration if we don't have one</span>
<a href="#l19.690"></a><span id="l19.690" class="difflineminus">-    Components.utils.import(&quot;resource://app/modules/SearchIntegration.js&quot;);</span>
<a href="#l19.691"></a><span id="l19.691" class="difflineplus">+      // Next, try loading the search integration module</span>
<a href="#l19.692"></a><span id="l19.692" class="difflineplus">+      // We'll get a null SearchIntegration if we don't have one</span>
<a href="#l19.693"></a><span id="l19.693" class="difflineplus">+      Components.utils.import(&quot;resource://app/modules/SearchIntegration.js&quot;);</span>
<a href="#l19.694"></a><span id="l19.694"> </span>
<a href="#l19.695"></a><span id="l19.695" class="difflineminus">-    // Show the default client dialog only if</span>
<a href="#l19.696"></a><span id="l19.696" class="difflineminus">-    // EITHER: we have at least one account, and we aren't already the default</span>
<a href="#l19.697"></a><span id="l19.697" class="difflineminus">-    // for mail,</span>
<a href="#l19.698"></a><span id="l19.698" class="difflineminus">-    // OR: we have the search integration module, the OS version is suitable,</span>
<a href="#l19.699"></a><span id="l19.699" class="difflineminus">-    // and the first run hasn't already been completed.</span>
<a href="#l19.700"></a><span id="l19.700" class="difflineminus">-    // Needs to be shown outside the he normal load sequence so it doesn't appear</span>
<a href="#l19.701"></a><span id="l19.701" class="difflineminus">-    // before any other displays, in the wrong place of the screen.</span>
<a href="#l19.702"></a><span id="l19.702" class="difflineminus">-    if ((shellService &amp;&amp; defaultAccount &amp;&amp; shellService.shouldCheckDefaultClient</span>
<a href="#l19.703"></a><span id="l19.703" class="difflineminus">-         &amp;&amp; !shellService.isDefaultClient(true, nsIShellService.MAIL)) ||</span>
<a href="#l19.704"></a><span id="l19.704" class="difflineplus">+      // Show the default client dialog only if</span>
<a href="#l19.705"></a><span id="l19.705" class="difflineplus">+      // EITHER: we have at least one account, and we aren't already the default</span>
<a href="#l19.706"></a><span id="l19.706" class="difflineplus">+      // for mail,</span>
<a href="#l19.707"></a><span id="l19.707" class="difflineplus">+      // OR: we have the search integration module, the OS version is suitable,</span>
<a href="#l19.708"></a><span id="l19.708" class="difflineplus">+      // and the first run hasn't already been completed.</span>
<a href="#l19.709"></a><span id="l19.709" class="difflineplus">+      // Needs to be shown outside the he normal load sequence so it doesn't appear</span>
<a href="#l19.710"></a><span id="l19.710" class="difflineplus">+      // before any other displays, in the wrong place of the screen.</span>
<a href="#l19.711"></a><span id="l19.711" class="difflineplus">+      if ((shellService &amp;&amp; defaultAccount &amp;&amp; shellService.shouldCheckDefaultClient</span>
<a href="#l19.712"></a><span id="l19.712" class="difflineplus">+           &amp;&amp; !shellService.isDefaultClient(true, nsIShellService.MAIL)) ||</span>
<a href="#l19.713"></a><span id="l19.713">         (SearchIntegration &amp;&amp; !SearchIntegration.osVersionTooLow &amp;&amp;</span>
<a href="#l19.714"></a><span id="l19.714">          !SearchIntegration.osComponentsNotRunning &amp;&amp; !SearchIntegration.firstRunDone))</span>
<a href="#l19.715"></a><span id="l19.715" class="difflineminus">-      window.openDialog(&quot;chrome://messenger/content/systemIntegrationDialog.xul&quot;,</span>
<a href="#l19.716"></a><span id="l19.716" class="difflineminus">-                        &quot;SystemIntegration&quot;, &quot;modal,centerscreen,chrome,resizable=no&quot;);</span>
<a href="#l19.717"></a><span id="l19.717" class="difflineminus">-#endif</span>
<a href="#l19.718"></a><span id="l19.718" class="difflineplus">+        window.openDialog(&quot;chrome://messenger/content/systemIntegrationDialog.xul&quot;,</span>
<a href="#l19.719"></a><span id="l19.719" class="difflineplus">+                          &quot;SystemIntegration&quot;, &quot;modal,centerscreen,chrome,resizable=no&quot;);</span>
<a href="#l19.720"></a><span id="l19.720" class="difflineplus">+    }</span>
<a href="#l19.721"></a><span id="l19.721"> </span>
<a href="#l19.722"></a><span id="l19.722">     // All core modal dialogs are done, the user can now interact with the 3-pane window</span>
<a href="#l19.723"></a><span id="l19.723">     var obs = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l19.724"></a><span id="l19.724">                         .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l19.725"></a><span id="l19.725">     obs.notifyObservers(window, &quot;mail-startup-done&quot;, null);</span>
<a href="#l19.726"></a><span id="l19.726">   }</span>
<a href="#l19.727"></a><span id="l19.727"> </span>
<a href="#l19.728"></a><span id="l19.728">   setTimeout(completeStartup, 0);</span>
<a href="#l19.729"></a><span id="l19.729"> </span>
<a href="#l19.730"></a><span id="l19.730">   // FIX ME - later we will be able to use onload from the overlay</span>
<a href="#l19.731"></a><span id="l19.731">   OnLoadMsgHeaderPane();</span>
<a href="#l19.732"></a><span id="l19.732"> </span>
<a href="#l19.733"></a><span id="l19.733" class="difflineminus">-  gHaveLoadedMessage = false;</span>
<a href="#l19.734"></a><span id="l19.734" class="difflineminus">-</span>
<a href="#l19.735"></a><span id="l19.735">   //Set focus to the Thread Pane the first time the window is opened.</span>
<a href="#l19.736"></a><span id="l19.736">   SetFocusThreadPane();</span>
<a href="#l19.737"></a><span id="l19.737"> </span>
<a href="#l19.738"></a><span id="l19.738">   // initialize the customizeDone method on the customizeable toolbar</span>
<a href="#l19.739"></a><span id="l19.739">   var toolbox = document.getElementById(&quot;mail-toolbox&quot;);</span>
<a href="#l19.740"></a><span id="l19.740">   toolbox.customizeDone = function(aEvent) { MailToolboxCustomizeDone(aEvent, &quot;CustomizeMailToolbar&quot;); };</span>
<a href="#l19.741"></a><span id="l19.741"> </span>
<a href="#l19.742"></a><span id="l19.742">   var toolbarset = document.getElementById('customToolbars');</span>
<a href="#l19.743"></a><span id="l19.743">   toolbox.toolbarset = toolbarset;</span>
<a href="#l19.744"></a><span id="l19.744"> </span>
<a href="#l19.745"></a><span id="l19.745" class="difflineminus">-  loadStartFolder(gStartFolderUri);</span>
<a href="#l19.746"></a><span id="l19.746" class="difflineplus">+  // XXX Do not select the folder until the window displays or the threadpane</span>
<a href="#l19.747"></a><span id="l19.747" class="difflineplus">+  //  will be at minimum size.  We used to have</span>
<a href="#l19.748"></a><span id="l19.748" class="difflineplus">+  //  gFolderDisplay.ensureRowIsVisible use settimeout itself to defer that</span>
<a href="#l19.749"></a><span id="l19.749" class="difflineplus">+  //  calculation, but that was ugly.  Also, in theory we will open the window</span>
<a href="#l19.750"></a><span id="l19.750" class="difflineplus">+  //  faster if we let the event loop start doing things sooner.</span>
<a href="#l19.751"></a><span id="l19.751" class="difflineplus">+  window.setTimeout(loadStartFolder, 0, gStartFolderUri);</span>
<a href="#l19.752"></a><span id="l19.752"> }</span>
<a href="#l19.753"></a><span id="l19.753"> </span>
<a href="#l19.754"></a><span id="l19.754"> function HandleAppCommandEvent(evt)</span>
<a href="#l19.755"></a><span id="l19.755"> {</span>
<a href="#l19.756"></a><span id="l19.756">   evt.stopPropagation();</span>
<a href="#l19.757"></a><span id="l19.757">   switch (evt.command) {</span>
<a href="#l19.758"></a><span id="l19.758">     case &quot;Back&quot;:</span>
<a href="#l19.759"></a><span id="l19.759">       goDoCommand('cmd_goBack');</span>
<a href="#l19.760"></a><span id="l19.760" class="difflineat">@@ -803,24 +421,31 @@ function HandleAppCommandEvent(evt)</span>
<a href="#l19.761"></a><span id="l19.761">       break;</span>
<a href="#l19.762"></a><span id="l19.762">     case &quot;Home&quot;:</span>
<a href="#l19.763"></a><span id="l19.763">     case &quot;Reload&quot;:</span>
<a href="#l19.764"></a><span id="l19.764">     default:</span>
<a href="#l19.765"></a><span id="l19.765">       break;</span>
<a href="#l19.766"></a><span id="l19.766">   }</span>
<a href="#l19.767"></a><span id="l19.767"> }</span>
<a href="#l19.768"></a><span id="l19.768"> </span>
<a href="#l19.769"></a><span id="l19.769" class="difflineplus">+/**</span>
<a href="#l19.770"></a><span id="l19.770" class="difflineplus">+ * Called by messenger.xul:onunload, the 3-pane window inside of tabs window.</span>
<a href="#l19.771"></a><span id="l19.771" class="difflineplus">+ *  It's being unloaded!  Right now!</span>
<a href="#l19.772"></a><span id="l19.772" class="difflineplus">+ */</span>
<a href="#l19.773"></a><span id="l19.773"> function OnUnloadMessenger()</span>
<a href="#l19.774"></a><span id="l19.774"> {</span>
<a href="#l19.775"></a><span id="l19.775" class="difflineminus">-  OnLeavingFolder(gMsgFolderSelected);  // mark all read in current folder</span>
<a href="#l19.776"></a><span id="l19.776">   accountManager.removeIncomingServerListener(gThreePaneIncomingServerListener);</span>
<a href="#l19.777"></a><span id="l19.777">   gPrefBranch.QueryInterface(Components.interfaces.nsIPrefBranch2);</span>
<a href="#l19.778"></a><span id="l19.778">   gPrefBranch.removeObserver(&quot;mail.pane_config.dynamic&quot;, MailPrefObserver);</span>
<a href="#l19.779"></a><span id="l19.779">   document.getElementById('tabmail').closeTabs();</span>
<a href="#l19.780"></a><span id="l19.780"> </span>
<a href="#l19.781"></a><span id="l19.781" class="difflineplus">+  var mailSession = Components.classes[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l19.782"></a><span id="l19.782" class="difflineplus">+                              .getService(Components.interfaces.nsIMsgMailSession);</span>
<a href="#l19.783"></a><span id="l19.783" class="difflineplus">+  mailSession.RemoveFolderListener(folderListener);</span>
<a href="#l19.784"></a><span id="l19.784" class="difflineplus">+</span>
<a href="#l19.785"></a><span id="l19.785">   gPhishingDetector.shutdown();</span>
<a href="#l19.786"></a><span id="l19.786"> </span>
<a href="#l19.787"></a><span id="l19.787">   // FIX ME - later we will be able to use onload from the overlay</span>
<a href="#l19.788"></a><span id="l19.788">   OnUnloadMsgHeaderPane();</span>
<a href="#l19.789"></a><span id="l19.789"> </span>
<a href="#l19.790"></a><span id="l19.790">   UnloadPanes();</span>
<a href="#l19.791"></a><span id="l19.791"> </span>
<a href="#l19.792"></a><span id="l19.792">   OnMailWindowUnload();</span>
<a href="#l19.793"></a><span id="l19.793" class="difflineat">@@ -968,17 +593,17 @@ function InitPanes()</span>
<a href="#l19.794"></a><span id="l19.794"> {</span>
<a href="#l19.795"></a><span id="l19.795">   gFolderTreeView.load(document.getElementById(&quot;folderTree&quot;),</span>
<a href="#l19.796"></a><span id="l19.796">                        &quot;folderTree.json&quot;);</span>
<a href="#l19.797"></a><span id="l19.797">   var folderTree = document.getElementById(&quot;folderTree&quot;);</span>
<a href="#l19.798"></a><span id="l19.798">   folderTree.addEventListener(&quot;click&quot;,FolderPaneOnClick,true);</span>
<a href="#l19.799"></a><span id="l19.799">   folderTree.addEventListener(&quot;mousedown&quot;,TreeOnMouseDown,true);</span>
<a href="#l19.800"></a><span id="l19.800">   var threadTree = document.getElementById(&quot;threadTree&quot;);</span>
<a href="#l19.801"></a><span id="l19.801">   threadTree.addEventListener(&quot;click&quot;,ThreadTreeOnClick,true);</span>
<a href="#l19.802"></a><span id="l19.802" class="difflineminus">-                       </span>
<a href="#l19.803"></a><span id="l19.803" class="difflineplus">+</span>
<a href="#l19.804"></a><span id="l19.804">   OnLoadThreadPane();</span>
<a href="#l19.805"></a><span id="l19.805">   SetupCommandUpdateHandlers();</span>
<a href="#l19.806"></a><span id="l19.806"> }</span>
<a href="#l19.807"></a><span id="l19.807"> </span>
<a href="#l19.808"></a><span id="l19.808"> function UnloadPanes()</span>
<a href="#l19.809"></a><span id="l19.809"> {</span>
<a href="#l19.810"></a><span id="l19.810">   var threadTree = document.getElementById(&quot;threadTree&quot;);</span>
<a href="#l19.811"></a><span id="l19.811">   threadTree.removeEventListener(&quot;click&quot;,ThreadTreeOnClick,true);</span>
<a href="#l19.812"></a><span id="l19.812" class="difflineat">@@ -1004,73 +629,73 @@ function UpgradeThreadPaneUI()</span>
<a href="#l19.813"></a><span id="l19.813">     threadPaneUIVersion = gPrefBranch.getIntPref(&quot;mailnews.ui.threadpane.version&quot;);</span>
<a href="#l19.814"></a><span id="l19.814"> </span>
<a href="#l19.815"></a><span id="l19.815">     if (threadPaneUIVersion &lt; 7)</span>
<a href="#l19.816"></a><span id="l19.816">     {</span>
<a href="#l19.817"></a><span id="l19.817">       // Mark all imap folders as offline at the very first run of TB v3</span>
<a href="#l19.818"></a><span id="l19.818">       // We use the threadpane ui version to determine TB profile version</span>
<a href="#l19.819"></a><span id="l19.819">       let servers = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l19.820"></a><span id="l19.820">                       .getService(Components.interfaces.nsIMsgAccountManager).allServers;</span>
<a href="#l19.821"></a><span id="l19.821" class="difflineminus">-      </span>
<a href="#l19.822"></a><span id="l19.822" class="difflineplus">+</span>
<a href="#l19.823"></a><span id="l19.823">       for each (let server in fixIterator(servers, Components.interfaces.nsIMsgIncomingServer))</span>
<a href="#l19.824"></a><span id="l19.824">       {</span>
<a href="#l19.825"></a><span id="l19.825">         if (server.type != &quot;imap&quot;)</span>
<a href="#l19.826"></a><span id="l19.826">           continue;</span>
<a href="#l19.827"></a><span id="l19.827" class="difflineminus">-        </span>
<a href="#l19.828"></a><span id="l19.828" class="difflineplus">+</span>
<a href="#l19.829"></a><span id="l19.829">         let allFolders = Components.classes[&quot;@mozilla.org/supports-array;1&quot;]</span>
<a href="#l19.830"></a><span id="l19.830">                           .createInstance(Components.interfaces.nsISupportsArray);</span>
<a href="#l19.831"></a><span id="l19.831">         server.rootFolder.ListDescendents(allFolders);</span>
<a href="#l19.832"></a><span id="l19.832">         for each (let folder in fixIterator(allFolders, Components.interfaces.nsIMsgFolder))</span>
<a href="#l19.833"></a><span id="l19.833">           folder.setFlag(Components.interfaces.nsMsgFolderFlags.Offline);</span>
<a href="#l19.834"></a><span id="l19.834">       }</span>
<a href="#l19.835"></a><span id="l19.835" class="difflineminus">-      </span>
<a href="#l19.836"></a><span id="l19.836" class="difflineplus">+</span>
<a href="#l19.837"></a><span id="l19.837">       // Note: threadTree._reorderColumn will throw an ERROR if the columns specified are already in the same order!</span>
<a href="#l19.838"></a><span id="l19.838">       if (threadPaneUIVersion &lt; 6)</span>
<a href="#l19.839"></a><span id="l19.839">       {</span>
<a href="#l19.840"></a><span id="l19.840">         var threadTree = document.getElementById(&quot;threadTree&quot;);</span>
<a href="#l19.841"></a><span id="l19.841">         var dateCol = document.getElementById(&quot;dateCol&quot;);</span>
<a href="#l19.842"></a><span id="l19.842">         var receivedCol = document.getElementById(&quot;receivedCol&quot;);</span>
<a href="#l19.843"></a><span id="l19.843">         var junkCol = document.getElementById(&quot;junkStatusCol&quot;);</span>
<a href="#l19.844"></a><span id="l19.844" class="difflineminus">-  </span>
<a href="#l19.845"></a><span id="l19.845" class="difflineplus">+</span>
<a href="#l19.846"></a><span id="l19.846">         if (threadPaneUIVersion &lt; 5)</span>
<a href="#l19.847"></a><span id="l19.847">         {</span>
<a href="#l19.848"></a><span id="l19.848">           if (threadPaneUIVersion &lt; 4)</span>
<a href="#l19.849"></a><span id="l19.849">           {</span>
<a href="#l19.850"></a><span id="l19.850">             if (threadPaneUIVersion &lt; 3)</span>
<a href="#l19.851"></a><span id="l19.851">             {</span>
<a href="#l19.852"></a><span id="l19.852" class="difflineminus">-  </span>
<a href="#l19.853"></a><span id="l19.853" class="difflineplus">+</span>
<a href="#l19.854"></a><span id="l19.854">               // in thunderbird, we are inserting the junk column just before the</span>
<a href="#l19.855"></a><span id="l19.855">               // date column.</span>
<a href="#l19.856"></a><span id="l19.856">               threadTree._reorderColumn(junkCol, dateCol, true);</span>
<a href="#l19.857"></a><span id="l19.857">             }</span>
<a href="#l19.858"></a><span id="l19.858" class="difflineminus">-  </span>
<a href="#l19.859"></a><span id="l19.859" class="difflineplus">+</span>
<a href="#l19.860"></a><span id="l19.860">             var senderCol = document.getElementById(&quot;senderCol&quot;);</span>
<a href="#l19.861"></a><span id="l19.861">             var recipientCol = document.getElementById(&quot;recipientCol&quot;);</span>
<a href="#l19.862"></a><span id="l19.862">             threadTree._reorderColumn(recipientCol, junkCol, true);</span>
<a href="#l19.863"></a><span id="l19.863">             threadTree._reorderColumn(senderCol, recipientCol, true);</span>
<a href="#l19.864"></a><span id="l19.864" class="difflineminus">-  </span>
<a href="#l19.865"></a><span id="l19.865" class="difflineplus">+</span>
<a href="#l19.866"></a><span id="l19.866">           } // version 4 upgrades</span>
<a href="#l19.867"></a><span id="l19.867" class="difflineminus">-  </span>
<a href="#l19.868"></a><span id="l19.868" class="difflineplus">+</span>
<a href="#l19.869"></a><span id="l19.869">           // version 5 adds a new column called attachments</span>
<a href="#l19.870"></a><span id="l19.870">           var attachmentCol = document.getElementById(&quot;attachmentCol&quot;);</span>
<a href="#l19.871"></a><span id="l19.871">           var subjectCol = document.getElementById(&quot;subjectCol&quot;);</span>
<a href="#l19.872"></a><span id="l19.872" class="difflineminus">-  </span>
<a href="#l19.873"></a><span id="l19.873" class="difflineplus">+</span>
<a href="#l19.874"></a><span id="l19.874">           threadTree._reorderColumn(attachmentCol, subjectCol, true);</span>
<a href="#l19.875"></a><span id="l19.875" class="difflineminus">-  </span>
<a href="#l19.876"></a><span id="l19.876" class="difflineplus">+</span>
<a href="#l19.877"></a><span id="l19.877">         } // version 5 upgrades</span>
<a href="#l19.878"></a><span id="l19.878" class="difflineminus">-  </span>
<a href="#l19.879"></a><span id="l19.879" class="difflineplus">+</span>
<a href="#l19.880"></a><span id="l19.880">         if (dateCol)</span>
<a href="#l19.881"></a><span id="l19.881">           threadTree._reorderColumn(receivedCol, dateCol, true);</span>
<a href="#l19.882"></a><span id="l19.882">         else</span>
<a href="#l19.883"></a><span id="l19.883">           threadTree._reorderColumn(receivedCol, junkCol, false);</span>
<a href="#l19.884"></a><span id="l19.884" class="difflineminus">-   </span>
<a href="#l19.885"></a><span id="l19.885" class="difflineplus">+</span>
<a href="#l19.886"></a><span id="l19.886">       } // version 6 upgrades</span>
<a href="#l19.887"></a><span id="l19.887" class="difflineminus">-      </span>
<a href="#l19.888"></a><span id="l19.888" class="difflineplus">+</span>
<a href="#l19.889"></a><span id="l19.889">       gPrefBranch.setIntPref(&quot;mailnews.ui.threadpane.version&quot;, 7);</span>
<a href="#l19.890"></a><span id="l19.890" class="difflineminus">- </span>
<a href="#l19.891"></a><span id="l19.891" class="difflineplus">+</span>
<a href="#l19.892"></a><span id="l19.892">     } // version 7 upgrades</span>
<a href="#l19.893"></a><span id="l19.893">   }</span>
<a href="#l19.894"></a><span id="l19.894">   catch (ex) {</span>
<a href="#l19.895"></a><span id="l19.895">     dump(&quot;UpgradeThreadPane: ex = &quot; + ex + &quot;\n&quot;);</span>
<a href="#l19.896"></a><span id="l19.896">   }</span>
<a href="#l19.897"></a><span id="l19.897"> }</span>
<a href="#l19.898"></a><span id="l19.898"> </span>
<a href="#l19.899"></a><span id="l19.899"> function OnLoadThreadPane()</span>
<a href="#l19.900"></a><span id="l19.900" class="difflineat">@@ -1145,95 +770,114 @@ function GetTotalCountElement()</span>
<a href="#l19.901"></a><span id="l19.901"> </span>
<a href="#l19.902"></a><span id="l19.902"> function IsMessagePaneCollapsed()</span>
<a href="#l19.903"></a><span id="l19.903"> {</span>
<a href="#l19.904"></a><span id="l19.904">   return GetMessagePane().collapsed;</span>
<a href="#l19.905"></a><span id="l19.905"> }</span>
<a href="#l19.906"></a><span id="l19.906"> </span>
<a href="#l19.907"></a><span id="l19.907"> function ClearThreadPaneSelection()</span>
<a href="#l19.908"></a><span id="l19.908"> {</span>
<a href="#l19.909"></a><span id="l19.909" class="difflineminus">-  try {</span>
<a href="#l19.910"></a><span id="l19.910" class="difflineminus">-    if (gDBView) {</span>
<a href="#l19.911"></a><span id="l19.911" class="difflineminus">-      var treeView = gDBView.QueryInterface(Components.interfaces.nsITreeView);</span>
<a href="#l19.912"></a><span id="l19.912" class="difflineminus">-      var treeSelection = treeView.selection;</span>
<a href="#l19.913"></a><span id="l19.913" class="difflineminus">-      if (treeSelection)</span>
<a href="#l19.914"></a><span id="l19.914" class="difflineminus">-        treeSelection.clearSelection();</span>
<a href="#l19.915"></a><span id="l19.915" class="difflineminus">-    }</span>
<a href="#l19.916"></a><span id="l19.916" class="difflineminus">-  }</span>
<a href="#l19.917"></a><span id="l19.917" class="difflineminus">-  catch (ex) {</span>
<a href="#l19.918"></a><span id="l19.918" class="difflineminus">-    dump(&quot;ClearThreadPaneSelection: ex = &quot; + ex + &quot;\n&quot;);</span>
<a href="#l19.919"></a><span id="l19.919" class="difflineminus">-  }</span>
<a href="#l19.920"></a><span id="l19.920" class="difflineplus">+  gFolderDisplay.clearSelection();</span>
<a href="#l19.921"></a><span id="l19.921"> }</span>
<a href="#l19.922"></a><span id="l19.922"> </span>
<a href="#l19.923"></a><span id="l19.923"> function ClearMessagePane()</span>
<a href="#l19.924"></a><span id="l19.924"> {</span>
<a href="#l19.925"></a><span id="l19.925" class="difflineminus">-  if(gHaveLoadedMessage)</span>
<a href="#l19.926"></a><span id="l19.926" class="difflineminus">-  {</span>
<a href="#l19.927"></a><span id="l19.927" class="difflineminus">-    gHaveLoadedMessage = false;</span>
<a href="#l19.928"></a><span id="l19.928" class="difflineminus">-    if (GetMessagePaneFrame().location.href != &quot;about:blank&quot;)</span>
<a href="#l19.929"></a><span id="l19.929" class="difflineminus">-        GetMessagePaneFrame().location.href = &quot;about:blank&quot;;</span>
<a href="#l19.930"></a><span id="l19.930" class="difflineminus">-</span>
<a href="#l19.931"></a><span id="l19.931" class="difflineminus">-    // hide the message header view AND the message pane...</span>
<a href="#l19.932"></a><span id="l19.932" class="difflineminus">-    HideMessageHeaderPane();</span>
<a href="#l19.933"></a><span id="l19.933" class="difflineminus">-    gMessageNotificationBar.clearMsgNotifications();</span>
<a href="#l19.934"></a><span id="l19.934" class="difflineminus">-    ClearPendingReadTimer();</span>
<a href="#l19.935"></a><span id="l19.935" class="difflineminus">-  }</span>
<a href="#l19.936"></a><span id="l19.936" class="difflineplus">+  // hide the message header view AND the message pane...</span>
<a href="#l19.937"></a><span id="l19.937" class="difflineplus">+  HideMessageHeaderPane();</span>
<a href="#l19.938"></a><span id="l19.938" class="difflineplus">+  gMessageNotificationBar.clearMsgNotifications();</span>
<a href="#l19.939"></a><span id="l19.939" class="difflineplus">+  ClearPendingReadTimer();</span>
<a href="#l19.940"></a><span id="l19.940" class="difflineplus">+  GetMessagePaneFrame().location.href = &quot;about:blank&quot;;</span>
<a href="#l19.941"></a><span id="l19.941"> }</span>
<a href="#l19.942"></a><span id="l19.942"> </span>
<a href="#l19.943"></a><span id="l19.943" class="difflineminus">-// Function to change the highlighted row to where the mouse was clicked</span>
<a href="#l19.944"></a><span id="l19.944" class="difflineminus">-// without loading the contents of the selected row.</span>
<a href="#l19.945"></a><span id="l19.945" class="difflineminus">-// It will also keep the outline/dotted line in the original row.</span>
<a href="#l19.946"></a><span id="l19.946" class="difflineminus">-function ChangeSelectionWithoutContentLoad(event, tree)</span>
<a href="#l19.947"></a><span id="l19.947" class="difflineplus">+/**</span>
<a href="#l19.948"></a><span id="l19.948" class="difflineplus">+ * When right-clicks happen, we do not want to corrupt the underlying</span>
<a href="#l19.949"></a><span id="l19.949" class="difflineplus">+ * selection.  The right-click is a transient selection.  So, unless the</span>
<a href="#l19.950"></a><span id="l19.950" class="difflineplus">+ * user is right-clicking on the current selection, we create a new</span>
<a href="#l19.951"></a><span id="l19.951" class="difflineplus">+ * selection object (thanks to JSTreeSelection) and set that as the</span>
<a href="#l19.952"></a><span id="l19.952" class="difflineplus">+ * current/transient selection.</span>
<a href="#l19.953"></a><span id="l19.953" class="difflineplus">+ *</span>
<a href="#l19.954"></a><span id="l19.954" class="difflineplus">+ * It is up you to call RestoreSelectionWithoutContentLoad to clean up when we</span>
<a href="#l19.955"></a><span id="l19.955" class="difflineplus">+ * are done.</span>
<a href="#l19.956"></a><span id="l19.956" class="difflineplus">+ *</span>
<a href="#l19.957"></a><span id="l19.957" class="difflineplus">+ * @param aSingleSelect Should the selection we create be a single selection?</span>
<a href="#l19.958"></a><span id="l19.958" class="difflineplus">+ *     This is relevant if the row being clicked on is already part of the</span>
<a href="#l19.959"></a><span id="l19.959" class="difflineplus">+ *     selection.  If it is part of the selection and !aSingleSelect, then we</span>
<a href="#l19.960"></a><span id="l19.960" class="difflineplus">+ *     leave the selection as is.  If it is part of the selection and</span>
<a href="#l19.961"></a><span id="l19.961" class="difflineplus">+ *     aSingleSelect then we create a transient single-row selection.</span>
<a href="#l19.962"></a><span id="l19.962" class="difflineplus">+ */</span>
<a href="#l19.963"></a><span id="l19.963" class="difflineplus">+function ChangeSelectionWithoutContentLoad(event, tree, aSingleSelect)</span>
<a href="#l19.964"></a><span id="l19.964"> {</span>
<a href="#l19.965"></a><span id="l19.965" class="difflineminus">-    var treeBoxObj = tree.treeBoxObject;</span>
<a href="#l19.966"></a><span id="l19.966" class="difflineminus">-    if (!treeBoxObj)</span>
<a href="#l19.967"></a><span id="l19.967" class="difflineminus">-    {</span>
<a href="#l19.968"></a><span id="l19.968" class="difflineminus">-      event.stopPropagation();</span>
<a href="#l19.969"></a><span id="l19.969" class="difflineminus">-      return;</span>
<a href="#l19.970"></a><span id="l19.970" class="difflineminus">-    }</span>
<a href="#l19.971"></a><span id="l19.971" class="difflineminus">-    var treeSelection = treeBoxObj.view.selection;</span>
<a href="#l19.972"></a><span id="l19.972" class="difflineplus">+  var treeBoxObj = tree.treeBoxObject;</span>
<a href="#l19.973"></a><span id="l19.973" class="difflineplus">+  if (!treeBoxObj) {</span>
<a href="#l19.974"></a><span id="l19.974" class="difflineplus">+    event.stopPropagation();</span>
<a href="#l19.975"></a><span id="l19.975" class="difflineplus">+    return;</span>
<a href="#l19.976"></a><span id="l19.976" class="difflineplus">+  }</span>
<a href="#l19.977"></a><span id="l19.977" class="difflineplus">+</span>
<a href="#l19.978"></a><span id="l19.978" class="difflineplus">+  var treeSelection = treeBoxObj.view.selection;</span>
<a href="#l19.979"></a><span id="l19.979"> </span>
<a href="#l19.980"></a><span id="l19.980" class="difflineminus">-    var row = treeBoxObj.getRowAt(event.clientX, event.clientY);</span>
<a href="#l19.981"></a><span id="l19.981" class="difflineminus">-    // make sure that row.value is valid so that it doesn't mess up</span>
<a href="#l19.982"></a><span id="l19.982" class="difflineminus">-    // the call to ensureRowIsVisible().</span>
<a href="#l19.983"></a><span id="l19.983" class="difflineminus">-    if((row &gt;= 0) &amp;&amp; !treeSelection.isSelected(row))</span>
<a href="#l19.984"></a><span id="l19.984" class="difflineminus">-    {</span>
<a href="#l19.985"></a><span id="l19.985" class="difflineminus">-        var saveCurrentIndex = treeSelection.currentIndex;</span>
<a href="#l19.986"></a><span id="l19.986" class="difflineminus">-        treeSelection.selectEventsSuppressed = true;</span>
<a href="#l19.987"></a><span id="l19.987" class="difflineminus">-        treeSelection.select(row);</span>
<a href="#l19.988"></a><span id="l19.988" class="difflineminus">-        treeSelection.currentIndex = saveCurrentIndex;</span>
<a href="#l19.989"></a><span id="l19.989" class="difflineminus">-        treeBoxObj.ensureRowIsVisible(row);</span>
<a href="#l19.990"></a><span id="l19.990" class="difflineminus">-        treeSelection.selectEventsSuppressed = false;</span>
<a href="#l19.991"></a><span id="l19.991" class="difflineplus">+  var row = treeBoxObj.getRowAt(event.clientX, event.clientY);</span>
<a href="#l19.992"></a><span id="l19.992" class="difflineplus">+  // Only do something if:</span>
<a href="#l19.993"></a><span id="l19.993" class="difflineplus">+  // - the row is valid</span>
<a href="#l19.994"></a><span id="l19.994" class="difflineplus">+  // - it's not already selected (or we want a single selection)</span>
<a href="#l19.995"></a><span id="l19.995" class="difflineplus">+  if (row &gt;= 0 &amp;&amp;</span>
<a href="#l19.996"></a><span id="l19.996" class="difflineplus">+      (aSingleSelect || !treeSelection.isSelected(row))) {</span>
<a href="#l19.997"></a><span id="l19.997" class="difflineplus">+    // Check if the row is exactly the existing selection.  In that case</span>
<a href="#l19.998"></a><span id="l19.998" class="difflineplus">+    //  there is no need to create a bogus selection.</span>
<a href="#l19.999"></a><span id="l19.999" class="difflineplus">+    if (treeSelection.count == 1) {</span>
<a href="#l19.1000"></a><span id="l19.1000" class="difflineplus">+      let minObj = {};</span>
<a href="#l19.1001"></a><span id="l19.1001" class="difflineplus">+      treeSelection.getRangeAt(0, minObj, {});</span>
<a href="#l19.1002"></a><span id="l19.1002" class="difflineplus">+      if (minObj.value == row) {</span>
<a href="#l19.1003"></a><span id="l19.1003" class="difflineplus">+        event.stopPropagation();</span>
<a href="#l19.1004"></a><span id="l19.1004" class="difflineplus">+        return;</span>
<a href="#l19.1005"></a><span id="l19.1005" class="difflineplus">+      }</span>
<a href="#l19.1006"></a><span id="l19.1006" class="difflineplus">+    }</span>
<a href="#l19.1007"></a><span id="l19.1007" class="difflineplus">+</span>
<a href="#l19.1008"></a><span id="l19.1008" class="difflineplus">+    let transientSelection = new JSTreeSelection(treeBoxObj);</span>
<a href="#l19.1009"></a><span id="l19.1009" class="difflineplus">+    transientSelection.logAdjustSelectionForReplay();</span>
<a href="#l19.1010"></a><span id="l19.1010"> </span>
<a href="#l19.1011"></a><span id="l19.1011" class="difflineminus">-        // Keep track of which row in the thread pane is currently selected.</span>
<a href="#l19.1012"></a><span id="l19.1012" class="difflineminus">-        if(tree.id == &quot;threadTree&quot;)</span>
<a href="#l19.1013"></a><span id="l19.1013" class="difflineminus">-          gThreadPaneCurrentSelectedIndex = row;</span>
<a href="#l19.1014"></a><span id="l19.1014" class="difflineminus">-    }</span>
<a href="#l19.1015"></a><span id="l19.1015" class="difflineminus">-    event.stopPropagation();</span>
<a href="#l19.1016"></a><span id="l19.1016" class="difflineplus">+    gRightMouseButtonSavedSelection = {</span>
<a href="#l19.1017"></a><span id="l19.1017" class="difflineplus">+      view: treeBoxObj.view,</span>
<a href="#l19.1018"></a><span id="l19.1018" class="difflineplus">+      realSelection: treeSelection,</span>
<a href="#l19.1019"></a><span id="l19.1019" class="difflineplus">+      transientSelection: transientSelection</span>
<a href="#l19.1020"></a><span id="l19.1020" class="difflineplus">+    };</span>
<a href="#l19.1021"></a><span id="l19.1021" class="difflineplus">+</span>
<a href="#l19.1022"></a><span id="l19.1022" class="difflineplus">+    var saveCurrentIndex = treeSelection.currentIndex;</span>
<a href="#l19.1023"></a><span id="l19.1023" class="difflineplus">+</span>
<a href="#l19.1024"></a><span id="l19.1024" class="difflineplus">+    // tell it to log calls to adjustSelection</span>
<a href="#l19.1025"></a><span id="l19.1025" class="difflineplus">+    // attach it to the view</span>
<a href="#l19.1026"></a><span id="l19.1026" class="difflineplus">+    treeBoxObj.view.selection = transientSelection;</span>
<a href="#l19.1027"></a><span id="l19.1027" class="difflineplus">+    // Don't generate any selection events! (we never set this to false, because</span>
<a href="#l19.1028"></a><span id="l19.1028" class="difflineplus">+    //  that would generate an event, and we never need one of those from this</span>
<a href="#l19.1029"></a><span id="l19.1029" class="difflineplus">+    //  selection object.</span>
<a href="#l19.1030"></a><span id="l19.1030" class="difflineplus">+    transientSelection.selectEventsSuppressed = true;</span>
<a href="#l19.1031"></a><span id="l19.1031" class="difflineplus">+    transientSelection.select(row);</span>
<a href="#l19.1032"></a><span id="l19.1032" class="difflineplus">+    transientSelection.currentIndex = saveCurrentIndex;</span>
<a href="#l19.1033"></a><span id="l19.1033" class="difflineplus">+    treeBoxObj.ensureRowIsVisible(row);</span>
<a href="#l19.1034"></a><span id="l19.1034" class="difflineplus">+  }</span>
<a href="#l19.1035"></a><span id="l19.1035" class="difflineplus">+  event.stopPropagation();</span>
<a href="#l19.1036"></a><span id="l19.1036"> }</span>
<a href="#l19.1037"></a><span id="l19.1037"> </span>
<a href="#l19.1038"></a><span id="l19.1038"> function TreeOnMouseDown(event)</span>
<a href="#l19.1039"></a><span id="l19.1039"> {</span>
<a href="#l19.1040"></a><span id="l19.1040">     // Detect right mouse click and change the highlight to the row</span>
<a href="#l19.1041"></a><span id="l19.1041">     // where the click happened without loading the message headers in</span>
<a href="#l19.1042"></a><span id="l19.1042">     // the Folder or Thread Pane.</span>
<a href="#l19.1043"></a><span id="l19.1043">     // Same for middle click, which will open the folder/message in a tab.</span>
<a href="#l19.1044"></a><span id="l19.1044">     if (event.button == 2 || event.button == 1)</span>
<a href="#l19.1045"></a><span id="l19.1045">     {</span>
<a href="#l19.1046"></a><span id="l19.1046" class="difflineminus">-      gRightMouseButtonDown = true;</span>
<a href="#l19.1047"></a><span id="l19.1047" class="difflineminus">-      ChangeSelectionWithoutContentLoad(event, event.target.parentNode);</span>
<a href="#l19.1048"></a><span id="l19.1048" class="difflineplus">+      // We want a single selection if this is a middle-click (button 1)</span>
<a href="#l19.1049"></a><span id="l19.1049" class="difflineplus">+      ChangeSelectionWithoutContentLoad(event, event.target.parentNode,</span>
<a href="#l19.1050"></a><span id="l19.1050" class="difflineplus">+                                        event.button == 1);</span>
<a href="#l19.1051"></a><span id="l19.1051">     }</span>
<a href="#l19.1052"></a><span id="l19.1052" class="difflineminus">-    else</span>
<a href="#l19.1053"></a><span id="l19.1053" class="difflineminus">-      gRightMouseButtonDown = false;</span>
<a href="#l19.1054"></a><span id="l19.1054"> }</span>
<a href="#l19.1055"></a><span id="l19.1055"> </span>
<a href="#l19.1056"></a><span id="l19.1056"> function FolderPaneOnClick(event)</span>
<a href="#l19.1057"></a><span id="l19.1057"> {</span>
<a href="#l19.1058"></a><span id="l19.1058">   var folderTree = document.getElementById(&quot;folderTree&quot;);</span>
<a href="#l19.1059"></a><span id="l19.1059" class="difflineminus">-  </span>
<a href="#l19.1060"></a><span id="l19.1060" class="difflineplus">+</span>
<a href="#l19.1061"></a><span id="l19.1061">   // Middle click on a folder opens the folder in a tab</span>
<a href="#l19.1062"></a><span id="l19.1062">   if (event.button == 1)</span>
<a href="#l19.1063"></a><span id="l19.1063">   {</span>
<a href="#l19.1064"></a><span id="l19.1064">     MsgOpenNewTabForFolder();</span>
<a href="#l19.1065"></a><span id="l19.1065">     RestoreSelectionWithoutContentLoad(folderTree);</span>
<a href="#l19.1066"></a><span id="l19.1066">   }</span>
<a href="#l19.1067"></a><span id="l19.1067">   else if (event.button == 0)</span>
<a href="#l19.1068"></a><span id="l19.1068">   {</span>
<a href="#l19.1069"></a><span id="l19.1069" class="difflineat">@@ -1253,160 +897,43 @@ function FolderPaneOnClick(event)</span>
<a href="#l19.1070"></a><span id="l19.1070">       event.stopPropagation();</span>
<a href="#l19.1071"></a><span id="l19.1071">     }</span>
<a href="#l19.1072"></a><span id="l19.1072">   }</span>
<a href="#l19.1073"></a><span id="l19.1073"> }</span>
<a href="#l19.1074"></a><span id="l19.1074"> </span>
<a href="#l19.1075"></a><span id="l19.1075"> function ThreadTreeOnClick(event)</span>
<a href="#l19.1076"></a><span id="l19.1076"> {</span>
<a href="#l19.1077"></a><span id="l19.1077">   var threadTree = document.getElementById(&quot;threadTree&quot;);</span>
<a href="#l19.1078"></a><span id="l19.1078" class="difflineminus">-  </span>
<a href="#l19.1079"></a><span id="l19.1079" class="difflineplus">+</span>
<a href="#l19.1080"></a><span id="l19.1080">   // Middle click on a message opens the message in a tab</span>
<a href="#l19.1081"></a><span id="l19.1081">   if (event.button == 1)</span>
<a href="#l19.1082"></a><span id="l19.1082">   {</span>
<a href="#l19.1083"></a><span id="l19.1083">     MsgOpenNewTabForMessage();</span>
<a href="#l19.1084"></a><span id="l19.1084">     RestoreSelectionWithoutContentLoad(threadTree);</span>
<a href="#l19.1085"></a><span id="l19.1085">   }</span>
<a href="#l19.1086"></a><span id="l19.1086"> }</span>
<a href="#l19.1087"></a><span id="l19.1087"> </span>
<a href="#l19.1088"></a><span id="l19.1088"> function GetSelectedMsgFolders()</span>
<a href="#l19.1089"></a><span id="l19.1089"> {</span>
<a href="#l19.1090"></a><span id="l19.1090">   return gFolderTreeView.getSelectedFolders();</span>
<a href="#l19.1091"></a><span id="l19.1091"> }</span>
<a href="#l19.1092"></a><span id="l19.1092"> </span>
<a href="#l19.1093"></a><span id="l19.1093" class="difflineminus">-function GetFirstSelectedMessage()</span>
<a href="#l19.1094"></a><span id="l19.1094" class="difflineminus">-{</span>
<a href="#l19.1095"></a><span id="l19.1095" class="difflineminus">-    try {</span>
<a href="#l19.1096"></a><span id="l19.1096" class="difflineminus">-        return gDBView.URIForFirstSelectedMessage;</span>
<a href="#l19.1097"></a><span id="l19.1097" class="difflineminus">-    }</span>
<a href="#l19.1098"></a><span id="l19.1098" class="difflineminus">-    catch (ex) {</span>
<a href="#l19.1099"></a><span id="l19.1099" class="difflineminus">-        return null;</span>
<a href="#l19.1100"></a><span id="l19.1100" class="difflineminus">-    }</span>
<a href="#l19.1101"></a><span id="l19.1101" class="difflineminus">-}</span>
<a href="#l19.1102"></a><span id="l19.1102" class="difflineminus">-</span>
<a href="#l19.1103"></a><span id="l19.1103" class="difflineminus">-function GetSelectedIndices(dbView)</span>
<a href="#l19.1104"></a><span id="l19.1104" class="difflineminus">-{</span>
<a href="#l19.1105"></a><span id="l19.1105" class="difflineminus">-  try {</span>
<a href="#l19.1106"></a><span id="l19.1106" class="difflineminus">-    return dbView.getIndicesForSelection({});</span>
<a href="#l19.1107"></a><span id="l19.1107" class="difflineminus">-  }</span>
<a href="#l19.1108"></a><span id="l19.1108" class="difflineminus">-  catch (ex) {</span>
<a href="#l19.1109"></a><span id="l19.1109" class="difflineminus">-    dump(&quot;ex = &quot; + ex + &quot;\n&quot;);</span>
<a href="#l19.1110"></a><span id="l19.1110" class="difflineminus">-    return null;</span>
<a href="#l19.1111"></a><span id="l19.1111" class="difflineminus">-  }</span>
<a href="#l19.1112"></a><span id="l19.1112" class="difflineminus">-}</span>
<a href="#l19.1113"></a><span id="l19.1113" class="difflineminus">-</span>
<a href="#l19.1114"></a><span id="l19.1114" class="difflineminus">-function GetSelectedMessages()</span>
<a href="#l19.1115"></a><span id="l19.1115" class="difflineminus">-{</span>
<a href="#l19.1116"></a><span id="l19.1116" class="difflineminus">-  if (!GetDBView())</span>
<a href="#l19.1117"></a><span id="l19.1117" class="difflineminus">-    return null;</span>
<a href="#l19.1118"></a><span id="l19.1118" class="difflineminus">-</span>
<a href="#l19.1119"></a><span id="l19.1119" class="difflineminus">-  var messageArray = GetDBView().getURIsForSelection({});</span>
<a href="#l19.1120"></a><span id="l19.1120" class="difflineminus">-  return messageArray.length ? messageArray : null;</span>
<a href="#l19.1121"></a><span id="l19.1121" class="difflineminus">-}</span>
<a href="#l19.1122"></a><span id="l19.1122" class="difflineminus">-</span>
<a href="#l19.1123"></a><span id="l19.1123"> function GetLoadedMsgFolder()</span>
<a href="#l19.1124"></a><span id="l19.1124"> {</span>
<a href="#l19.1125"></a><span id="l19.1125" class="difflineminus">-    if (!gDBView) return null;</span>
<a href="#l19.1126"></a><span id="l19.1126" class="difflineminus">-    return gDBView.msgFolder;</span>
<a href="#l19.1127"></a><span id="l19.1127" class="difflineminus">-}</span>
<a href="#l19.1128"></a><span id="l19.1128" class="difflineminus">-</span>
<a href="#l19.1129"></a><span id="l19.1129" class="difflineminus">-function GetLoadedMessage()</span>
<a href="#l19.1130"></a><span id="l19.1130" class="difflineminus">-{</span>
<a href="#l19.1131"></a><span id="l19.1131" class="difflineminus">-    try {</span>
<a href="#l19.1132"></a><span id="l19.1132" class="difflineminus">-        return gDBView.URIForFirstSelectedMessage;</span>
<a href="#l19.1133"></a><span id="l19.1133" class="difflineminus">-    }</span>
<a href="#l19.1134"></a><span id="l19.1134" class="difflineminus">-    catch (ex) {</span>
<a href="#l19.1135"></a><span id="l19.1135" class="difflineminus">-        return null;</span>
<a href="#l19.1136"></a><span id="l19.1136" class="difflineminus">-    }</span>
<a href="#l19.1137"></a><span id="l19.1137" class="difflineminus">-}</span>
<a href="#l19.1138"></a><span id="l19.1138" class="difflineminus">-</span>
<a href="#l19.1139"></a><span id="l19.1139" class="difflineminus">-//Clear everything related to the current message. called after load start page.</span>
<a href="#l19.1140"></a><span id="l19.1140" class="difflineminus">-function ClearMessageSelection()</span>
<a href="#l19.1141"></a><span id="l19.1141" class="difflineminus">-{</span>
<a href="#l19.1142"></a><span id="l19.1142" class="difflineminus">-  ClearThreadPaneSelection();</span>
<a href="#l19.1143"></a><span id="l19.1143" class="difflineminus">-}</span>
<a href="#l19.1144"></a><span id="l19.1144" class="difflineminus">-</span>
<a href="#l19.1145"></a><span id="l19.1145" class="difflineminus">-// Figures out how many messages are selected (hilighted - does not necessarily</span>
<a href="#l19.1146"></a><span id="l19.1146" class="difflineminus">-// have the dotted outline) above a given index row value in the thread pane.</span>
<a href="#l19.1147"></a><span id="l19.1147" class="difflineminus">-function NumberOfSelectedMessagesAboveCurrentIndex(index)</span>
<a href="#l19.1148"></a><span id="l19.1148" class="difflineminus">-{</span>
<a href="#l19.1149"></a><span id="l19.1149" class="difflineminus">-  var numberOfMessages = 0;</span>
<a href="#l19.1150"></a><span id="l19.1150" class="difflineminus">-  var indicies = GetSelectedIndices(gDBView);</span>
<a href="#l19.1151"></a><span id="l19.1151" class="difflineminus">-</span>
<a href="#l19.1152"></a><span id="l19.1152" class="difflineminus">-  if (indicies &amp;&amp; indicies.length)</span>
<a href="#l19.1153"></a><span id="l19.1153" class="difflineminus">-  {</span>
<a href="#l19.1154"></a><span id="l19.1154" class="difflineminus">-    for (var i = 0; i &lt; indicies.length; i++)</span>
<a href="#l19.1155"></a><span id="l19.1155" class="difflineminus">-    {</span>
<a href="#l19.1156"></a><span id="l19.1156" class="difflineminus">-      if (indicies[i] &lt; index)</span>
<a href="#l19.1157"></a><span id="l19.1157" class="difflineminus">-        ++numberOfMessages;</span>
<a href="#l19.1158"></a><span id="l19.1158" class="difflineminus">-      else</span>
<a href="#l19.1159"></a><span id="l19.1159" class="difflineminus">-        break;</span>
<a href="#l19.1160"></a><span id="l19.1160" class="difflineminus">-    }</span>
<a href="#l19.1161"></a><span id="l19.1161" class="difflineminus">-  }</span>
<a href="#l19.1162"></a><span id="l19.1162" class="difflineminus">-  return numberOfMessages;</span>
<a href="#l19.1163"></a><span id="l19.1163" class="difflineminus">-}</span>
<a href="#l19.1164"></a><span id="l19.1164" class="difflineminus">-</span>
<a href="#l19.1165"></a><span id="l19.1165" class="difflineminus">-function SetNextMessageAfterDelete()</span>
<a href="#l19.1166"></a><span id="l19.1166" class="difflineminus">-{</span>
<a href="#l19.1167"></a><span id="l19.1167" class="difflineminus">-  var treeSelection = GetThreadTree().view.selection;</span>
<a href="#l19.1168"></a><span id="l19.1168" class="difflineminus">-</span>
<a href="#l19.1169"></a><span id="l19.1169" class="difflineminus">-  if (treeSelection.isSelected(treeSelection.currentIndex))</span>
<a href="#l19.1170"></a><span id="l19.1170" class="difflineminus">-  {</span>
<a href="#l19.1171"></a><span id="l19.1171" class="difflineminus">-    gNextMessageViewIndexAfterDelete = gDBView.msgToSelectAfterDelete;</span>
<a href="#l19.1172"></a><span id="l19.1172" class="difflineminus">-    gSelectedIndexWhenDeleting = treeSelection.currentIndex;</span>
<a href="#l19.1173"></a><span id="l19.1173" class="difflineminus">-  }</span>
<a href="#l19.1174"></a><span id="l19.1174" class="difflineminus">-  else if(gDBView.removeRowOnMoveOrDelete)</span>
<a href="#l19.1175"></a><span id="l19.1175" class="difflineminus">-  {</span>
<a href="#l19.1176"></a><span id="l19.1176" class="difflineminus">-    // Only set gThreadPaneDeleteOrMoveOccurred to true if the message was</span>
<a href="#l19.1177"></a><span id="l19.1177" class="difflineminus">-    // truly moved to the trash or deleted, as opposed to an IMAP delete</span>
<a href="#l19.1178"></a><span id="l19.1178" class="difflineminus">-    // (where it is only &quot;marked as deleted&quot;.  This will prevent bug 142065.</span>
<a href="#l19.1179"></a><span id="l19.1179" class="difflineminus">-    //</span>
<a href="#l19.1180"></a><span id="l19.1180" class="difflineminus">-    // If it's an IMAP delete, then just set gNextMessageViewIndexAfterDelete</span>
<a href="#l19.1181"></a><span id="l19.1181" class="difflineminus">-    // to treeSelection.currentIndex (where the outline is at) because nothing</span>
<a href="#l19.1182"></a><span id="l19.1182" class="difflineminus">-    // was moved or deleted from the folder.</span>
<a href="#l19.1183"></a><span id="l19.1183" class="difflineminus">-    gThreadPaneDeleteOrMoveOccurred = true;</span>
<a href="#l19.1184"></a><span id="l19.1184" class="difflineminus">-    gNextMessageViewIndexAfterDelete = treeSelection.currentIndex - NumberOfSelectedMessagesAboveCurrentIndex(treeSelection.currentIndex);</span>
<a href="#l19.1185"></a><span id="l19.1185" class="difflineminus">-  }</span>
<a href="#l19.1186"></a><span id="l19.1186" class="difflineminus">-  else</span>
<a href="#l19.1187"></a><span id="l19.1187" class="difflineminus">-    gNextMessageViewIndexAfterDelete = treeSelection.currentIndex;</span>
<a href="#l19.1188"></a><span id="l19.1188" class="difflineplus">+  return gFolderDisplay.displayedFolder;</span>
<a href="#l19.1189"></a><span id="l19.1189"> }</span>
<a href="#l19.1190"></a><span id="l19.1190"> </span>
<a href="#l19.1191"></a><span id="l19.1191"> function SelectFolder(folderUri)</span>
<a href="#l19.1192"></a><span id="l19.1192"> {</span>
<a href="#l19.1193"></a><span id="l19.1193">   gFolderTreeView.selectFolder(GetMsgFolderFromUri(folderUri));</span>
<a href="#l19.1194"></a><span id="l19.1194"> }</span>
<a href="#l19.1195"></a><span id="l19.1195"> </span>
<a href="#l19.1196"></a><span id="l19.1196" class="difflineminus">-function SelectMessage(messageUri)</span>
<a href="#l19.1197"></a><span id="l19.1197" class="difflineminus">-{</span>
<a href="#l19.1198"></a><span id="l19.1198" class="difflineminus">-  var msgHdr = messenger.messageServiceFromURI(messageUri).messageURIToMsgHdr(messageUri);</span>
<a href="#l19.1199"></a><span id="l19.1199" class="difflineminus">-  if (msgHdr)</span>
<a href="#l19.1200"></a><span id="l19.1200" class="difflineminus">-    gDBView.selectMsgByKey(msgHdr.messageKey);</span>
<a href="#l19.1201"></a><span id="l19.1201" class="difflineminus">-}</span>
<a href="#l19.1202"></a><span id="l19.1202" class="difflineminus">-</span>
<a href="#l19.1203"></a><span id="l19.1203"> function ReloadMessage()</span>
<a href="#l19.1204"></a><span id="l19.1204"> {</span>
<a href="#l19.1205"></a><span id="l19.1205" class="difflineminus">-  gDBView.reloadMessage();</span>
<a href="#l19.1206"></a><span id="l19.1206" class="difflineminus">-}</span>
<a href="#l19.1207"></a><span id="l19.1207" class="difflineminus">-</span>
<a href="#l19.1208"></a><span id="l19.1208" class="difflineminus">-function GetDBView()</span>
<a href="#l19.1209"></a><span id="l19.1209" class="difflineminus">-{</span>
<a href="#l19.1210"></a><span id="l19.1210" class="difflineminus">-  return gDBView;</span>
<a href="#l19.1211"></a><span id="l19.1211" class="difflineminus">-}</span>
<a href="#l19.1212"></a><span id="l19.1212" class="difflineminus">-</span>
<a href="#l19.1213"></a><span id="l19.1213" class="difflineminus">-function LoadNavigatedToMessage(msgHdr, folder, folderUri)</span>
<a href="#l19.1214"></a><span id="l19.1214" class="difflineminus">-{</span>
<a href="#l19.1215"></a><span id="l19.1215" class="difflineminus">-  if (IsCurrentLoadedFolder(folder))</span>
<a href="#l19.1216"></a><span id="l19.1216" class="difflineminus">-  {</span>
<a href="#l19.1217"></a><span id="l19.1217" class="difflineminus">-    gDBView.selectMsgByKey(msgHdr.messageKey);</span>
<a href="#l19.1218"></a><span id="l19.1218" class="difflineminus">-  }</span>
<a href="#l19.1219"></a><span id="l19.1219" class="difflineminus">-  else</span>
<a href="#l19.1220"></a><span id="l19.1220" class="difflineminus">-  {</span>
<a href="#l19.1221"></a><span id="l19.1221" class="difflineminus">-    gStartMsgKey = msgHdr.messageKey;</span>
<a href="#l19.1222"></a><span id="l19.1222" class="difflineminus">-    SelectFolder(folderUri);</span>
<a href="#l19.1223"></a><span id="l19.1223" class="difflineminus">-  }</span>
<a href="#l19.1224"></a><span id="l19.1224" class="difflineplus">+  gFolderDisplay.view.dbView.reloadMessage();</span>
<a href="#l19.1225"></a><span id="l19.1225"> }</span>
<a href="#l19.1226"></a><span id="l19.1226"> </span>
<a href="#l19.1227"></a><span id="l19.1227"> // Some of the per account junk mail settings have been</span>
<a href="#l19.1228"></a><span id="l19.1228"> // converted to global prefs. Let's try to migrate some</span>
<a href="#l19.1229"></a><span id="l19.1229"> // of those settings from the default account.</span>
<a href="#l19.1230"></a><span id="l19.1230"> function MigrateJunkMailSettings()</span>
<a href="#l19.1231"></a><span id="l19.1231"> {</span>
<a href="#l19.1232"></a><span id="l19.1232">   var junkMailSettingsVersion = gPrefBranch.getIntPref(&quot;mail.spam.version&quot;);</span>
<a href="#l19.1233"></a><span id="l19.1233" class="difflineat">@@ -1479,18 +1006,18 @@ function MigrateAttachmentDownloadStore(</span>
<a href="#l19.1234"></a><span id="l19.1234">     gPrefBranch.setIntPref(&quot;mail.attachment.store.version&quot;, 1);</span>
<a href="#l19.1235"></a><span id="l19.1235">   }</span>
<a href="#l19.1236"></a><span id="l19.1236"> }</span>
<a href="#l19.1237"></a><span id="l19.1237"> </span>
<a href="#l19.1238"></a><span id="l19.1238"> function threadPaneOnDragStart(aEvent) {</span>
<a href="#l19.1239"></a><span id="l19.1239">   if (aEvent.originalTarget.localName != &quot;treechildren&quot;)</span>
<a href="#l19.1240"></a><span id="l19.1240">     return;</span>
<a href="#l19.1241"></a><span id="l19.1241"> </span>
<a href="#l19.1242"></a><span id="l19.1242" class="difflineminus">-  var messages = GetSelectedMessages();</span>
<a href="#l19.1243"></a><span id="l19.1243" class="difflineplus">+  var messages = gFolderDisplay.selectedMessageUris;</span>
<a href="#l19.1244"></a><span id="l19.1244">   if (!messages)</span>
<a href="#l19.1245"></a><span id="l19.1245">     return;</span>
<a href="#l19.1246"></a><span id="l19.1246"> </span>
<a href="#l19.1247"></a><span id="l19.1247" class="difflineminus">-  SetNextMessageAfterDelete()</span>
<a href="#l19.1248"></a><span id="l19.1248" class="difflineplus">+  gFolderDisplay.hintAboutToDeleteMessages();</span>
<a href="#l19.1249"></a><span id="l19.1249">   for (let i in messages)</span>
<a href="#l19.1250"></a><span id="l19.1250">     aEvent.dataTransfer.mozSetDataAt(&quot;text/x-moz-message&quot;, messages[i], i);</span>
<a href="#l19.1251"></a><span id="l19.1251">   aEvent.dataTransfer.effectAllowed = &quot;copyMove&quot;;</span>
<a href="#l19.1252"></a><span id="l19.1252">   aEvent.dataTransfer.addElement(aEvent.originalTarget);</span>
<a href="#l19.1253"></a><span id="l19.1253"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1">rename from mailnews/base/resources/content/msgViewNavigation.js</span>
<a href="#l20.2"></a><span id="l20.2">rename to mail/base/content/msgViewNavigation.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineminus">--- a/mailnews/base/resources/content/msgViewNavigation.js</span>
<a href="#l20.4"></a><span id="l20.4" class="difflineplus">+++ b/mail/base/content/msgViewNavigation.js</span>
<a href="#l20.5"></a><span id="l20.5" class="difflineat">@@ -224,103 +224,50 @@ function CrossFolderNavigation(type)</span>
<a href="#l20.6"></a><span id="l20.6"> </span>
<a href="#l20.7"></a><span id="l20.7">     var folder = FindNextFolder();</span>
<a href="#l20.8"></a><span id="l20.8">     if (folder &amp;&amp; (gDBView.msgFolder.URI != folder.URI)) </span>
<a href="#l20.9"></a><span id="l20.9">     {</span>
<a href="#l20.10"></a><span id="l20.10">       switch (nextMode) </span>
<a href="#l20.11"></a><span id="l20.11">       {</span>
<a href="#l20.12"></a><span id="l20.12">         case 0:</span>
<a href="#l20.13"></a><span id="l20.13">           // do this unconditionally</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineminus">-          gNextMessageAfterLoad = type;</span>
<a href="#l20.15"></a><span id="l20.15">           SelectFolder(folder.URI);</span>
<a href="#l20.16"></a><span id="l20.16">           break;</span>
<a href="#l20.17"></a><span id="l20.17">         case 1:</span>
<a href="#l20.18"></a><span id="l20.18">         default:</span>
<a href="#l20.19"></a><span id="l20.19">           var promptText = gMessengerBundle.getFormattedString(&quot;advanceNextPrompt&quot;, [ folder.name ], 1); </span>
<a href="#l20.20"></a><span id="l20.20">           var promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l20.21"></a><span id="l20.21">                                         .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l20.22"></a><span id="l20.22">           if (!promptService.confirmEx(window, null, promptText, </span>
<a href="#l20.23"></a><span id="l20.23">                                        promptService.STD_YES_NO_BUTTONS, </span>
<a href="#l20.24"></a><span id="l20.24">                                        null, null, null, null, {}))</span>
<a href="#l20.25"></a><span id="l20.25">           {</span>
<a href="#l20.26"></a><span id="l20.26" class="difflineminus">-            gNextMessageAfterLoad = type;</span>
<a href="#l20.27"></a><span id="l20.27" class="difflineplus">+            gFolderDisplay.pushNavigation(type, true);</span>
<a href="#l20.28"></a><span id="l20.28">             SelectFolder(folder.URI);</span>
<a href="#l20.29"></a><span id="l20.29">           }</span>
<a href="#l20.30"></a><span id="l20.30">           break;</span>
<a href="#l20.31"></a><span id="l20.31">       }</span>
<a href="#l20.32"></a><span id="l20.32">     }</span>
<a href="#l20.33"></a><span id="l20.33">   }</span>
<a href="#l20.34"></a><span id="l20.34">   else</span>
<a href="#l20.35"></a><span id="l20.35">   {</span>
<a href="#l20.36"></a><span id="l20.36">     // if no message is loaded, relPos should be 0, to</span>
<a href="#l20.37"></a><span id="l20.37">     // go back to the previously loaded message</span>
<a href="#l20.38"></a><span id="l20.38">     var relPos = (type == nsMsgNavigationType.forward)</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineminus">-      ? 1 : ((GetLoadedMessage()) ? -1 : 0);</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineplus">+      ? 1 : ((gMessageDisplay.displayedMessage) ? -1 : 0);</span>
<a href="#l20.41"></a><span id="l20.41">     var folderUri = messenger.getFolderUriAtNavigatePos(relPos);</span>
<a href="#l20.42"></a><span id="l20.42">     var msgHdr = messenger.msgHdrFromURI(messenger.getMsgUriAtNavigatePos(relPos));</span>
<a href="#l20.43"></a><span id="l20.43">     gStartMsgKey = msgHdr.messageKey;</span>
<a href="#l20.44"></a><span id="l20.44">     var curPos = messenger.navigatePos;</span>
<a href="#l20.45"></a><span id="l20.45">     curPos += relPos;</span>
<a href="#l20.46"></a><span id="l20.46">     messenger.navigatePos = curPos;</span>
<a href="#l20.47"></a><span id="l20.47">     SelectFolder(folderUri);</span>
<a href="#l20.48"></a><span id="l20.48">   }</span>
<a href="#l20.49"></a><span id="l20.49"> }</span>
<a href="#l20.50"></a><span id="l20.50"> </span>
<a href="#l20.51"></a><span id="l20.51" class="difflineminus">-</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineminus">-function ScrollToMessage(type, wrap, selectMessage)</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineminus">-{</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineminus">-  try {</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineminus">-    var treeView = gDBView.QueryInterface(Components.interfaces.nsITreeView);</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineminus">-    var treeSelection = treeView.selection;</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineminus">-    var currentIndex = treeSelection.currentIndex;</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineminus">-</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineminus">-    var resultId = new Object;</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineminus">-    var resultIndex = new Object;</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineminus">-    var threadIndex = new Object;</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineminus">-</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineminus">-    let elidedFlag = Components.interfaces.nsMsgMessageFlags.Elided;</span>
<a href="#l20.64"></a><span id="l20.64" class="difflineminus">-    let summarizeSelection =</span>
<a href="#l20.65"></a><span id="l20.65" class="difflineminus">-      gPrefBranch.getBoolPref(&quot;mail.operate_on_msgs_in_collapsed_threads&quot;);</span>
<a href="#l20.66"></a><span id="l20.66" class="difflineminus">-</span>
<a href="#l20.67"></a><span id="l20.67" class="difflineminus">-    // if we're doing next unread, and a collapsed thread is selected, and</span>
<a href="#l20.68"></a><span id="l20.68" class="difflineminus">-    // the top level message is unread, just set the result manually to</span>
<a href="#l20.69"></a><span id="l20.69" class="difflineminus">-    // the top level message, without using gDBView.viewNavigate.</span>
<a href="#l20.70"></a><span id="l20.70" class="difflineminus">-    if (summarizeSelection &amp;&amp; type == nsMsgNavigationType.nextUnreadMessage &amp;&amp;</span>
<a href="#l20.71"></a><span id="l20.71" class="difflineminus">-        currentIndex != -1 &amp;&amp;</span>
<a href="#l20.72"></a><span id="l20.72" class="difflineminus">-        gDBView.getFlagsAt(currentIndex) &amp; elidedFlag &amp;&amp;</span>
<a href="#l20.73"></a><span id="l20.73" class="difflineminus">-        gDBView.isContainer(currentIndex) &amp;&amp;</span>
<a href="#l20.74"></a><span id="l20.74" class="difflineminus">-        ! (gDBView.getFlagsAt(currentIndex) &amp;</span>
<a href="#l20.75"></a><span id="l20.75" class="difflineminus">-           Components.interfaces.nsMsgMessageFlags.Read)) {</span>
<a href="#l20.76"></a><span id="l20.76" class="difflineminus">-      resultIndex.value = currentIndex;</span>
<a href="#l20.77"></a><span id="l20.77" class="difflineminus">-      resultId.value = gDBView.getKeyAt(currentIndex);</span>
<a href="#l20.78"></a><span id="l20.78" class="difflineminus">-    } else {</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineminus">-      gDBView.viewNavigate(type, resultId, resultIndex, threadIndex, true /* wrap */);</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineminus">-    }</span>
<a href="#l20.81"></a><span id="l20.81" class="difflineminus">-</span>
<a href="#l20.82"></a><span id="l20.82" class="difflineminus">-    // only scroll and select if we found something</span>
<a href="#l20.83"></a><span id="l20.83" class="difflineminus">-    if ((resultId.value != nsMsgViewIndex_None) &amp;&amp; (resultIndex.value != nsMsgViewIndex_None)) {</span>
<a href="#l20.84"></a><span id="l20.84" class="difflineminus">-      if (gDBView.getFlagsAt(resultIndex.value) &amp; elidedFlag &amp;&amp;</span>
<a href="#l20.85"></a><span id="l20.85" class="difflineminus">-          summarizeSelection)</span>
<a href="#l20.86"></a><span id="l20.86" class="difflineminus">-        gDBView.toggleOpenState(resultIndex.value);</span>
<a href="#l20.87"></a><span id="l20.87" class="difflineminus">-</span>
<a href="#l20.88"></a><span id="l20.88" class="difflineminus">-        if (selectMessage){</span>
<a href="#l20.89"></a><span id="l20.89" class="difflineminus">-            treeSelection.select(resultIndex.value);</span>
<a href="#l20.90"></a><span id="l20.90" class="difflineminus">-        }</span>
<a href="#l20.91"></a><span id="l20.91" class="difflineminus">-        EnsureRowInThreadTreeIsVisible(resultIndex.value);</span>
<a href="#l20.92"></a><span id="l20.92" class="difflineminus">-        return true;</span>
<a href="#l20.93"></a><span id="l20.93" class="difflineminus">-    }</span>
<a href="#l20.94"></a><span id="l20.94" class="difflineminus">-    else {</span>
<a href="#l20.95"></a><span id="l20.95" class="difflineminus">-        return false;</span>
<a href="#l20.96"></a><span id="l20.96" class="difflineminus">-    }</span>
<a href="#l20.97"></a><span id="l20.97" class="difflineminus">-  }</span>
<a href="#l20.98"></a><span id="l20.98" class="difflineminus">-  catch (ex) {</span>
<a href="#l20.99"></a><span id="l20.99" class="difflineminus">-    return false;</span>
<a href="#l20.100"></a><span id="l20.100" class="difflineminus">-  }</span>
<a href="#l20.101"></a><span id="l20.101" class="difflineminus">-}</span>
<a href="#l20.102"></a><span id="l20.102" class="difflineminus">-</span>
<a href="#l20.103"></a><span id="l20.103"> function GoNextMessage(type, startFromBeginning)</span>
<a href="#l20.104"></a><span id="l20.104"> {</span>
<a href="#l20.105"></a><span id="l20.105" class="difflineminus">-  if (!ScrollToMessage(type, startFromBeginning, true))</span>
<a href="#l20.106"></a><span id="l20.106" class="difflineplus">+  if (!gFolderDisplay.navigate(type))</span>
<a href="#l20.107"></a><span id="l20.107">     CrossFolderNavigation(type);</span>
<a href="#l20.108"></a><span id="l20.108"> </span>
<a href="#l20.109"></a><span id="l20.109">   SetFocusThreadPaneIfNotOnMessagePane();</span>
<a href="#l20.110"></a><span id="l20.110"> }</span>
<a href="#l20.111"></a><span id="l20.111"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mail/base/content/phishingDetector.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mail/base/content/phishingDetector.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -1,45 +1,44 @@</span>
<a href="#l21.4"></a><span id="l21.4" class="difflineminus">-# -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l21.5"></a><span id="l21.5" class="difflineminus">-# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l21.6"></a><span id="l21.6" class="difflineminus">-# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l21.7"></a><span id="l21.7" class="difflineminus">-#</span>
<a href="#l21.8"></a><span id="l21.8" class="difflineminus">-# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l21.9"></a><span id="l21.9" class="difflineminus">-# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l21.10"></a><span id="l21.10" class="difflineminus">-# the License. You may obtain a copy of the License at</span>
<a href="#l21.11"></a><span id="l21.11" class="difflineminus">-# http://www.mozilla.org/MPL/</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-#</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineminus">-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineminus">-# for the specific language governing rights and limitations under the</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineminus">-# License.</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineminus">-#</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineminus">-# The Original Code is Thunderbird Phishing Dectector</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineminus">-#</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineminus">-# The Initial Developer of the Original Code is</span>
<a href="#l21.21"></a><span id="l21.21" class="difflineminus">-# The Mozilla Foundation.</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineminus">-# Portions created by the Initial Developer are Copyright (C) 2005</span>
<a href="#l21.23"></a><span id="l21.23" class="difflineminus">-# the Initial Developer. All Rights Reserved.</span>
<a href="#l21.24"></a><span id="l21.24" class="difflineminus">-#</span>
<a href="#l21.25"></a><span id="l21.25" class="difflineminus">-# Contributor(s):</span>
<a href="#l21.26"></a><span id="l21.26" class="difflineminus">-#  Scott MacGregor &lt;mscott@mozilla.org&gt;</span>
<a href="#l21.27"></a><span id="l21.27" class="difflineminus">-#</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineminus">-# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineminus">-# either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineminus">-# the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineminus">-# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineminus">-# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineminus">-# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineminus">-# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineminus">-# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l21.36"></a><span id="l21.36" class="difflineminus">-# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineminus">-# the provisions above, a recipient may use your version of this file under</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineminus">-# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l21.39"></a><span id="l21.39" class="difflineminus">-#</span>
<a href="#l21.40"></a><span id="l21.40" class="difflineminus">-# ***** END LICENSE BLOCK ******</span>
<a href="#l21.41"></a><span id="l21.41" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l21.42"></a><span id="l21.42" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l21.43"></a><span id="l21.43" class="difflineplus">+ *</span>
<a href="#l21.44"></a><span id="l21.44" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l21.45"></a><span id="l21.45" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l21.46"></a><span id="l21.46" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l21.47"></a><span id="l21.47" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l21.48"></a><span id="l21.48" class="difflineplus">+ *</span>
<a href="#l21.49"></a><span id="l21.49" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l21.50"></a><span id="l21.50" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l21.51"></a><span id="l21.51" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l21.52"></a><span id="l21.52" class="difflineplus">+ * License.</span>
<a href="#l21.53"></a><span id="l21.53" class="difflineplus">+ *</span>
<a href="#l21.54"></a><span id="l21.54" class="difflineplus">+ * The Original Code is Thunderbird Phishing Dectector</span>
<a href="#l21.55"></a><span id="l21.55" class="difflineplus">+ *</span>
<a href="#l21.56"></a><span id="l21.56" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l21.57"></a><span id="l21.57" class="difflineplus">+ * The Mozilla Foundation.</span>
<a href="#l21.58"></a><span id="l21.58" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2005</span>
<a href="#l21.59"></a><span id="l21.59" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l21.60"></a><span id="l21.60" class="difflineplus">+ *</span>
<a href="#l21.61"></a><span id="l21.61" class="difflineplus">+ * Contributor(s):</span>
<a href="#l21.62"></a><span id="l21.62" class="difflineplus">+ *  Scott MacGregor &lt;mscott@mozilla.org&gt;</span>
<a href="#l21.63"></a><span id="l21.63" class="difflineplus">+ *</span>
<a href="#l21.64"></a><span id="l21.64" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l21.65"></a><span id="l21.65" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l21.66"></a><span id="l21.66" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l21.67"></a><span id="l21.67" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l21.68"></a><span id="l21.68" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l21.69"></a><span id="l21.69" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l21.70"></a><span id="l21.70" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l21.71"></a><span id="l21.71" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l21.72"></a><span id="l21.72" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l21.73"></a><span id="l21.73" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l21.74"></a><span id="l21.74" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l21.75"></a><span id="l21.75" class="difflineplus">+ *</span>
<a href="#l21.76"></a><span id="l21.76" class="difflineplus">+ * ***** END LICENSE BLOCK ****** */</span>
<a href="#l21.77"></a><span id="l21.77"> </span>
<a href="#l21.78"></a><span id="l21.78"> // Dependencies:</span>
<a href="#l21.79"></a><span id="l21.79"> // gPrefBranch, gBrandBundle, gMessengerBundle should already be defined</span>
<a href="#l21.80"></a><span id="l21.80"> // gatherTextUnder from utilityOverlay.js</span>
<a href="#l21.81"></a><span id="l21.81"> </span>
<a href="#l21.82"></a><span id="l21.82"> const kPhishingNotSuspicious = 0;</span>
<a href="#l21.83"></a><span id="l21.83"> const kPhishingWithIPAddress = 1;</span>
<a href="#l21.84"></a><span id="l21.84"> const kPhishingWithMismatchedHosts = 2;</span>
<a href="#l21.85"></a><span id="l21.85" class="difflineat">@@ -182,36 +181,39 @@ var gPhishingDetector = {</span>
<a href="#l21.86"></a><span id="l21.86">           failsStaticTests = (aLinkText &amp;&amp;</span>
<a href="#l21.87"></a><span id="l21.87">             this.misMatchedHostWithLinkText(hrefURL, aLinkText, linkTextURL))</span>
<a href="#l21.88"></a><span id="l21.88">         }</span>
<a href="#l21.89"></a><span id="l21.89">       }</span>
<a href="#l21.90"></a><span id="l21.90"> </span>
<a href="#l21.91"></a><span id="l21.91">       // Lookup the url against our local list. We want to do this even if the url fails our static</span>
<a href="#l21.92"></a><span id="l21.92">       // test checks because the url might be in the white list.</span>
<a href="#l21.93"></a><span id="l21.93">       if (this.mPhishingWarden)</span>
<a href="#l21.94"></a><span id="l21.94" class="difflineminus">-        this.mPhishingWarden.isEvilURL(GetLoadedMessage(), failsStaticTests, aUrl, this.localListCallback);</span>
<a href="#l21.95"></a><span id="l21.95" class="difflineplus">+        this.mPhishingWarden.isEvilURL(gFolderDisplay.selectedMessage,</span>
<a href="#l21.96"></a><span id="l21.96" class="difflineplus">+                                       failsStaticTests, aUrl,</span>
<a href="#l21.97"></a><span id="l21.97" class="difflineplus">+                                       this.localListCallback);</span>
<a href="#l21.98"></a><span id="l21.98">       else</span>
<a href="#l21.99"></a><span id="l21.99" class="difflineminus">-        this.localListCallback(GetLoadedMessage(), failsStaticTests, aUrl, 2 /* not found */);</span>
<a href="#l21.100"></a><span id="l21.100" class="difflineplus">+        this.localListCallback(gFolderDisplay.selectedMessage,</span>
<a href="#l21.101"></a><span id="l21.101" class="difflineplus">+                               failsStaticTests, aUrl, 2 /* not found */);</span>
<a href="#l21.102"></a><span id="l21.102">     }</span>
<a href="#l21.103"></a><span id="l21.103">   },</span>
<a href="#l21.104"></a><span id="l21.104"> </span>
<a href="#l21.105"></a><span id="l21.105">   /**</span>
<a href="#l21.106"></a><span id="l21.106">     * </span>
<a href="#l21.107"></a><span id="l21.107" class="difflineminus">-    * @param aMsgURI the uri for the loaded message when the look up was initiated.</span>
<a href="#l21.108"></a><span id="l21.108" class="difflineplus">+    * @param aMsgHdr the header for the loaded message when the look up was initiated.</span>
<a href="#l21.109"></a><span id="l21.109">     * @param aFailsStaticTests true if our static tests think the url is a phishing scam</span>
<a href="#l21.110"></a><span id="l21.110">     * @param aUrl the url we looked up in the phishing tables</span>
<a href="#l21.111"></a><span id="l21.111">     * @param aLocalListStatus the result of the local lookup (PROT_ListWarden.IN_BLACKLIST,</span>
<a href="#l21.112"></a><span id="l21.112">     *        PROT_ListWarden.IN_WHITELIST or PROT_ListWarden.NOT_FOUND.</span>
<a href="#l21.113"></a><span id="l21.113">     */</span>
<a href="#l21.114"></a><span id="l21.114" class="difflineminus">-  localListCallback: function (aMsgURI, aFailsStaticTests, aUrl, aLocalListStatus)</span>
<a href="#l21.115"></a><span id="l21.115" class="difflineplus">+  localListCallback: function (aMsgHdr, aFailsStaticTests, aUrl, aLocalListStatus)</span>
<a href="#l21.116"></a><span id="l21.116">   {  </span>
<a href="#l21.117"></a><span id="l21.117">     // for urls in the blacklist, notify the phishing bar.</span>
<a href="#l21.118"></a><span id="l21.118">     // for urls in the whitelist, do nothing</span>
<a href="#l21.119"></a><span id="l21.119">     // for all other urls, fall back to the static tests</span>
<a href="#l21.120"></a><span id="l21.120" class="difflineminus">-    if (aMsgURI == GetLoadedMessage())</span>
<a href="#l21.121"></a><span id="l21.121" class="difflineplus">+    if (aMsgHdr == gFolderDisplay.selectedMessage)</span>
<a href="#l21.122"></a><span id="l21.122">     {</span>
<a href="#l21.123"></a><span id="l21.123">       if (aLocalListStatus == 0 /* PROT_ListWarden.IN_BLACKLIST */ ||</span>
<a href="#l21.124"></a><span id="l21.124">           (aLocalListStatus == 2 /* PROT_ListWarden.PROT_ListWarden.NOT_FOUND */ &amp;&amp; aFailsStaticTests))</span>
<a href="#l21.125"></a><span id="l21.125">         gMessageNotificationBar.setPhishingMsg();</span>
<a href="#l21.126"></a><span id="l21.126">     }</span>
<a href="#l21.127"></a><span id="l21.127">   },</span>
<a href="#l21.128"></a><span id="l21.128"> </span>
<a href="#l21.129"></a><span id="l21.129">   /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mail/base/content/search.xml</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mail/base/content/search.xml</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -69,31 +69,34 @@</span>
<a href="#l22.4"></a><span id="l22.4">       &lt;constructor&gt;</span>
<a href="#l22.5"></a><span id="l22.5">         &lt;![CDATA[</span>
<a href="#l22.6"></a><span id="l22.6">           // initialize the quick search mode based on the checked menu item</span>
<a href="#l22.7"></a><span id="l22.7">           var desiredQuickSearchMode = document.getElementById('quick-search-menupopup').getAttribute('value');             </span>
<a href="#l22.8"></a><span id="l22.8">           </span>
<a href="#l22.9"></a><span id="l22.9">           var menuItems = document.getElementById('quick-search-menupopup').getElementsByAttribute('value', '*');</span>
<a href="#l22.10"></a><span id="l22.10">           var selectedMenuItem;</span>
<a href="#l22.11"></a><span id="l22.11">           for (var index = 0; index &lt; menuItems.length; index++) </span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-            if (menuItems[index].value == desiredQuickSearchMode)</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+            if (menuItems[index].getAttribute(&quot;value&quot;) == desiredQuickSearchMode)</span>
<a href="#l22.14"></a><span id="l22.14">             {</span>
<a href="#l22.15"></a><span id="l22.15">               selectedMenuItem = menuItems[index];</span>
<a href="#l22.16"></a><span id="l22.16">               break;</span>
<a href="#l22.17"></a><span id="l22.17">             }</span>
<a href="#l22.18"></a><span id="l22.18">           </span>
<a href="#l22.19"></a><span id="l22.19">           // if we failed to find selectedMenuItemVal in our array of menuitems</span>
<a href="#l22.20"></a><span id="l22.20">           // then just use the first menu item in the array (surely we have at least one menu item!)</span>
<a href="#l22.21"></a><span id="l22.21">           // This scenario happens when we decide to obsolete/delete search modes from </span>
<a href="#l22.22"></a><span id="l22.22">           // the quick search drop down.</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineminus">-          if (!selectedMenuItem)</span>
<a href="#l22.24"></a><span id="l22.24" class="difflineplus">+          if (!selectedMenuItem &amp;&amp; menuItems.length) {</span>
<a href="#l22.25"></a><span id="l22.25">             selectedMenuItem = menuItems[0];</span>
<a href="#l22.26"></a><span id="l22.26" class="difflineminus">-            </span>
<a href="#l22.27"></a><span id="l22.27" class="difflineminus">-          selectedMenuItem.setAttribute('checked', 'true');</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineminus">-          this.mQuickSearchMode = selectedMenuItem.value; // the checked menu item                </span>
<a href="#l22.29"></a><span id="l22.29" class="difflineplus">+</span>
<a href="#l22.30"></a><span id="l22.30" class="difflineplus">+            selectedMenuItem.setAttribute('checked', 'true');</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineplus">+            this.mQuickSearchMode =</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineplus">+              selectedMenuItem.getAttribute(&quot;value&quot;);</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineplus">+          }</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineplus">+</span>
<a href="#l22.35"></a><span id="l22.35">           this.setSearchCriteriaText();</span>
<a href="#l22.36"></a><span id="l22.36">         ]]&gt;</span>
<a href="#l22.37"></a><span id="l22.37">       &lt;/constructor&gt;</span>
<a href="#l22.38"></a><span id="l22.38"> </span>
<a href="#l22.39"></a><span id="l22.39">       &lt;property name=&quot;showingSearchCriteria&quot; onget=&quot;return this.getAttribute('searchCriteria') == 'true';&quot;</span>
<a href="#l22.40"></a><span id="l22.40">                 onset=&quot;this.setAttribute('searchCriteria', val); return val;&quot;/&gt;</span>
<a href="#l22.41"></a><span id="l22.41"> </span>
<a href="#l22.42"></a><span id="l22.42">       &lt;property name=&quot;clearButtonHidden&quot; onget=&quot;return document.getElementById('quick-search-clearbutton').getAttribute('clearButtonHidden') == 'true';&quot;</span>
<a href="#l22.43"></a><span id="l22.43" class="difflineat">@@ -127,17 +130,17 @@</span>
<a href="#l22.44"></a><span id="l22.44"> </span>
<a href="#l22.45"></a><span id="l22.45">       &lt;property name=&quot;searchMode&quot; onget=&quot;return this.mQuickSearchMode;&quot;</span>
<a href="#l22.46"></a><span id="l22.46">                 onset=&quot;this.mQuickSearchMode = val; document.getElementById('quick-search-menupopup').setAttribute('value', val);&quot;/&gt;</span>
<a href="#l22.47"></a><span id="l22.47"> </span>
<a href="#l22.48"></a><span id="l22.48">       &lt;method name=&quot;setSearchCriteriaText&quot;&gt;</span>
<a href="#l22.49"></a><span id="l22.49">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l22.50"></a><span id="l22.50">           this.showingSearchCriteria = true;</span>
<a href="#l22.51"></a><span id="l22.51">          // extract the label value from the menu item</span>
<a href="#l22.52"></a><span id="l22.52" class="difflineminus">-         var menuItems = document.getElementById('quick-search-menupopup').getElementsByAttribute('value', this.searchMode);          </span>
<a href="#l22.53"></a><span id="l22.53" class="difflineplus">+         var menuItems = document.getElementById('quick-search-menupopup').getElementsByAttribute('value', this.searchMode);</span>
<a href="#l22.54"></a><span id="l22.54">          this.inputField.value = menuItems[0].getAttribute('label');</span>
<a href="#l22.55"></a><span id="l22.55">          this.clearButtonHidden = true;</span>
<a href="#l22.56"></a><span id="l22.56">         ]]&gt;&lt;/body&gt;</span>
<a href="#l22.57"></a><span id="l22.57">       &lt;/method&gt;</span>
<a href="#l22.58"></a><span id="l22.58"> </span>
<a href="#l22.59"></a><span id="l22.59">       &lt;method name=&quot;openmenupopup&quot;&gt;</span>
<a href="#l22.60"></a><span id="l22.60">         &lt;body&gt;</span>
<a href="#l22.61"></a><span id="l22.61">           &lt;![CDATA[</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mail/base/content/searchBar.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mail/base/content/searchBar.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -1,551 +1,159 @@</span>
<a href="#l23.4"></a><span id="l23.4" class="difflineminus">-# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l23.5"></a><span id="l23.5" class="difflineminus">-# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l23.6"></a><span id="l23.6" class="difflineminus">-#</span>
<a href="#l23.7"></a><span id="l23.7" class="difflineminus">-# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l23.8"></a><span id="l23.8" class="difflineminus">-# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l23.9"></a><span id="l23.9" class="difflineminus">-# the License. You may obtain a copy of the License at</span>
<a href="#l23.10"></a><span id="l23.10" class="difflineminus">-# http://www.mozilla.org/MPL/</span>
<a href="#l23.11"></a><span id="l23.11" class="difflineminus">-#</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineminus">-# for the specific language governing rights and limitations under the</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineminus">-# License.</span>
<a href="#l23.16"></a><span id="l23.16" class="difflineminus">-#</span>
<a href="#l23.17"></a><span id="l23.17" class="difflineminus">-# The Original Code is Mozilla Communicator client code, released</span>
<a href="#l23.18"></a><span id="l23.18" class="difflineminus">-# March 31, 1998.</span>
<a href="#l23.19"></a><span id="l23.19" class="difflineminus">-#</span>
<a href="#l23.20"></a><span id="l23.20" class="difflineminus">-# The Initial Developer of the Original Code is</span>
<a href="#l23.21"></a><span id="l23.21" class="difflineminus">-# Netscape Communications Corporation.</span>
<a href="#l23.22"></a><span id="l23.22" class="difflineminus">-# Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l23.23"></a><span id="l23.23" class="difflineminus">-# the Initial Developer. All Rights Reserved.</span>
<a href="#l23.24"></a><span id="l23.24" class="difflineminus">-#</span>
<a href="#l23.25"></a><span id="l23.25" class="difflineminus">-# Contributor(s):</span>
<a href="#l23.26"></a><span id="l23.26" class="difflineminus">-#   Seth Spitzer &lt;sspitzer@netscape.com&gt;</span>
<a href="#l23.27"></a><span id="l23.27" class="difflineminus">-#   Scott MacGregor &lt;mscott@mozilla.org&gt;</span>
<a href="#l23.28"></a><span id="l23.28" class="difflineminus">-#   David Bienvenu &lt;bienvenu@nventure.com&gt;</span>
<a href="#l23.29"></a><span id="l23.29" class="difflineminus">-#</span>
<a href="#l23.30"></a><span id="l23.30" class="difflineminus">-# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineminus">-# either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineminus">-# or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l23.33"></a><span id="l23.33" class="difflineminus">-# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineminus">-# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l23.35"></a><span id="l23.35" class="difflineminus">-# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l23.36"></a><span id="l23.36" class="difflineminus">-# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l23.37"></a><span id="l23.37" class="difflineminus">-# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l23.38"></a><span id="l23.38" class="difflineminus">-# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l23.39"></a><span id="l23.39" class="difflineminus">-# the provisions above, a recipient may use your version of this file under</span>
<a href="#l23.40"></a><span id="l23.40" class="difflineminus">-# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l23.41"></a><span id="l23.41" class="difflineminus">-#</span>
<a href="#l23.42"></a><span id="l23.42" class="difflineminus">-# ***** END LICENSE BLOCK ***** </span>
<a href="#l23.43"></a><span id="l23.43" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l23.44"></a><span id="l23.44" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l23.45"></a><span id="l23.45" class="difflineplus">+ *</span>
<a href="#l23.46"></a><span id="l23.46" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l23.47"></a><span id="l23.47" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l23.48"></a><span id="l23.48" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l23.49"></a><span id="l23.49" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l23.50"></a><span id="l23.50" class="difflineplus">+ *</span>
<a href="#l23.51"></a><span id="l23.51" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l23.52"></a><span id="l23.52" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l23.53"></a><span id="l23.53" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l23.54"></a><span id="l23.54" class="difflineplus">+ * License.</span>
<a href="#l23.55"></a><span id="l23.55" class="difflineplus">+ *</span>
<a href="#l23.56"></a><span id="l23.56" class="difflineplus">+ * The Original Code is Mozilla Communicator client code, released</span>
<a href="#l23.57"></a><span id="l23.57" class="difflineplus">+ * March 31, 1998.</span>
<a href="#l23.58"></a><span id="l23.58" class="difflineplus">+ *</span>
<a href="#l23.59"></a><span id="l23.59" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l23.60"></a><span id="l23.60" class="difflineplus">+ * Netscape Communications Corporation.</span>
<a href="#l23.61"></a><span id="l23.61" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l23.62"></a><span id="l23.62" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l23.63"></a><span id="l23.63" class="difflineplus">+ *</span>
<a href="#l23.64"></a><span id="l23.64" class="difflineplus">+ * Contributor(s):</span>
<a href="#l23.65"></a><span id="l23.65" class="difflineplus">+ *   Seth Spitzer &lt;sspitzer@netscape.com&gt;</span>
<a href="#l23.66"></a><span id="l23.66" class="difflineplus">+ *   Scott MacGregor &lt;mscott@mozilla.org&gt;</span>
<a href="#l23.67"></a><span id="l23.67" class="difflineplus">+ *   David Bienvenu &lt;bienvenu@nventure.com&gt;</span>
<a href="#l23.68"></a><span id="l23.68" class="difflineplus">+ *</span>
<a href="#l23.69"></a><span id="l23.69" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l23.70"></a><span id="l23.70" class="difflineplus">+ * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l23.71"></a><span id="l23.71" class="difflineplus">+ * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l23.72"></a><span id="l23.72" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l23.73"></a><span id="l23.73" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l23.74"></a><span id="l23.74" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l23.75"></a><span id="l23.75" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l23.76"></a><span id="l23.76" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l23.77"></a><span id="l23.77" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l23.78"></a><span id="l23.78" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l23.79"></a><span id="l23.79" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l23.80"></a><span id="l23.80" class="difflineplus">+ *</span>
<a href="#l23.81"></a><span id="l23.81" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l23.82"></a><span id="l23.82"> </span>
<a href="#l23.83"></a><span id="l23.83" class="difflineminus">-var gSearchSession = null;</span>
<a href="#l23.84"></a><span id="l23.84" class="difflineminus">-var gPreQuickSearchView = null;</span>
<a href="#l23.85"></a><span id="l23.85" class="difflineminus">-var gSearchTimer = null;</span>
<a href="#l23.86"></a><span id="l23.86" class="difflineminus">-var gViewSearchListener;</span>
<a href="#l23.87"></a><span id="l23.87" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/quickSearchManager.js&quot;);</span>
<a href="#l23.88"></a><span id="l23.88" class="difflineplus">+</span>
<a href="#l23.89"></a><span id="l23.89"> var gSearchBundle;</span>
<a href="#l23.90"></a><span id="l23.90"> var gStatusBar = null;</span>
<a href="#l23.91"></a><span id="l23.91" class="difflineminus">-var gSearchInProgress = false;</span>
<a href="#l23.92"></a><span id="l23.92" class="difflineminus">-var gDefaultSearchViewTerms = null;</span>
<a href="#l23.93"></a><span id="l23.93" class="difflineminus">-var gQSViewIsDirty = false;</span>
<a href="#l23.94"></a><span id="l23.94"> var gIgnoreFocus = false;</span>
<a href="#l23.95"></a><span id="l23.95"> var gIgnoreClick = false;</span>
<a href="#l23.96"></a><span id="l23.96" class="difflineminus">-var gNumTotalMessages;</span>
<a href="#l23.97"></a><span id="l23.97" class="difflineminus">-var gNumUnreadMessages;</span>
<a href="#l23.98"></a><span id="l23.98" class="difflineplus">+</span>
<a href="#l23.99"></a><span id="l23.99" class="difflineplus">+// change/add constants in QuickSearchConstants in quickSearchManager.js first</span>
<a href="#l23.100"></a><span id="l23.100" class="difflineplus">+// ideally these should go away in favor of everyone using QuickSearchConstants</span>
<a href="#l23.101"></a><span id="l23.101" class="difflineplus">+const kQuickSearchSubject = QuickSearchConstants.kQuickSearchSubject;</span>
<a href="#l23.102"></a><span id="l23.102" class="difflineplus">+const kQuickSearchFrom = QuickSearchConstants.kQuickSearchFrom;</span>
<a href="#l23.103"></a><span id="l23.103" class="difflineplus">+const kQuickSearchFromOrSubject =</span>
<a href="#l23.104"></a><span id="l23.104" class="difflineplus">+  QuickSearchConstants.kQuickSearchFromOrSubject;</span>
<a href="#l23.105"></a><span id="l23.105" class="difflineplus">+const kQuickSearchBody = QuickSearchConstants.kQuickSearchBody;</span>
<a href="#l23.106"></a><span id="l23.106" class="difflineplus">+const kQuickSearchRecipient = QuickSearchConstants.kQuickSearchRecipient;</span>
<a href="#l23.107"></a><span id="l23.107" class="difflineplus">+const kQuickSearchRecipientOrSubject =</span>
<a href="#l23.108"></a><span id="l23.108" class="difflineplus">+  QuickSearchConstants.kQuickSearchRecipientOrSubject;</span>
<a href="#l23.109"></a><span id="l23.109" class="difflineplus">+</span>
<a href="#l23.110"></a><span id="l23.110"> </span>
<a href="#l23.111"></a><span id="l23.111" class="difflineminus">-// search criteria mode values </span>
<a href="#l23.112"></a><span id="l23.112" class="difflineminus">-// Note: If you change these constants, please update the menuitem values in</span>
<a href="#l23.113"></a><span id="l23.113" class="difflineminus">-// quick-search-menupopup. Note: These values are stored in localstore.rdf so we </span>
<a href="#l23.114"></a><span id="l23.114" class="difflineminus">-// can remember the users last quick search state. If you add values here, you must add</span>
<a href="#l23.115"></a><span id="l23.115" class="difflineminus">-// them to the end of the list!</span>
<a href="#l23.116"></a><span id="l23.116" class="difflineminus">-const kQuickSearchSubject = 0;</span>
<a href="#l23.117"></a><span id="l23.117" class="difflineminus">-const kQuickSearchFrom = 1;</span>
<a href="#l23.118"></a><span id="l23.118" class="difflineminus">-const kQuickSearchFromOrSubject = 2;</span>
<a href="#l23.119"></a><span id="l23.119" class="difflineminus">-const kQuickSearchBody = 3;</span>
<a href="#l23.120"></a><span id="l23.120" class="difflineminus">-// const kQuickSearchHighlight = 4; // * We no longer support this quick search mode..*</span>
<a href="#l23.121"></a><span id="l23.121" class="difflineminus">-const kQuickSearchRecipient = 5;</span>
<a href="#l23.122"></a><span id="l23.122" class="difflineminus">-const kQuickSearchRecipientOrSubject = 6;</span>
<a href="#l23.123"></a><span id="l23.123" class="difflineplus">+/**</span>
<a href="#l23.124"></a><span id="l23.124" class="difflineplus">+ * We are exclusively concerned with disabling the quick-search box when a</span>
<a href="#l23.125"></a><span id="l23.125" class="difflineplus">+ *  tab is being displayed that lacks quick search abilities.</span>
<a href="#l23.126"></a><span id="l23.126" class="difflineplus">+ */</span>
<a href="#l23.127"></a><span id="l23.127" class="difflineplus">+var QuickSearchTabMonitor = {</span>
<a href="#l23.128"></a><span id="l23.128" class="difflineplus">+  onTabTitleChanged: function() {</span>
<a href="#l23.129"></a><span id="l23.129" class="difflineplus">+  },</span>
<a href="#l23.130"></a><span id="l23.130" class="difflineplus">+</span>
<a href="#l23.131"></a><span id="l23.131" class="difflineplus">+  onTabSwitched: function (aTab, aOldTab) {</span>
<a href="#l23.132"></a><span id="l23.132" class="difflineplus">+    let searchInput = document.getElementById(&quot;searchInput&quot;);</span>
<a href="#l23.133"></a><span id="l23.133" class="difflineplus">+</span>
<a href="#l23.134"></a><span id="l23.134" class="difflineplus">+    if (searchInput) {</span>
<a href="#l23.135"></a><span id="l23.135" class="difflineplus">+      let newTabEligible = aTab.mode.tabType == mailTabType;</span>
<a href="#l23.136"></a><span id="l23.136" class="difflineplus">+      searchInput.disabled = !newTabEligible;</span>
<a href="#l23.137"></a><span id="l23.137" class="difflineplus">+      if (!newTabEligible)</span>
<a href="#l23.138"></a><span id="l23.138" class="difflineplus">+        searchInput.value = &quot;&quot;;</span>
<a href="#l23.139"></a><span id="l23.139" class="difflineplus">+    }</span>
<a href="#l23.140"></a><span id="l23.140" class="difflineplus">+  },</span>
<a href="#l23.141"></a><span id="l23.141" class="difflineplus">+};</span>
<a href="#l23.142"></a><span id="l23.142"> </span>
<a href="#l23.143"></a><span id="l23.143"> </span>
<a href="#l23.144"></a><span id="l23.144"> function SetQSStatusText(aNumHits)</span>
<a href="#l23.145"></a><span id="l23.145"> {</span>
<a href="#l23.146"></a><span id="l23.146">   var statusMsg;</span>
<a href="#l23.147"></a><span id="l23.147">   // if there are no hits, it means no matches were found in the search.</span>
<a href="#l23.148"></a><span id="l23.148">   if (aNumHits == 0)</span>
<a href="#l23.149"></a><span id="l23.149">     statusMsg = gSearchBundle.getString(&quot;searchFailureMessage&quot;);</span>
<a href="#l23.150"></a><span id="l23.150" class="difflineminus">-  else </span>
<a href="#l23.151"></a><span id="l23.151" class="difflineplus">+  else</span>
<a href="#l23.152"></a><span id="l23.152">   {</span>
<a href="#l23.153"></a><span id="l23.153" class="difflineminus">-    if (aNumHits == 1) </span>
<a href="#l23.154"></a><span id="l23.154" class="difflineplus">+    if (aNumHits == 1)</span>
<a href="#l23.155"></a><span id="l23.155">       statusMsg = gSearchBundle.getString(&quot;searchSuccessMessage&quot;);</span>
<a href="#l23.156"></a><span id="l23.156">     else</span>
<a href="#l23.157"></a><span id="l23.157">       statusMsg = gSearchBundle.getFormattedString(&quot;searchSuccessMessages&quot;, [aNumHits]);</span>
<a href="#l23.158"></a><span id="l23.158">   }</span>
<a href="#l23.159"></a><span id="l23.159"> </span>
<a href="#l23.160"></a><span id="l23.160">   statusFeedback.showStatusString(statusMsg);</span>
<a href="#l23.161"></a><span id="l23.161"> }</span>
<a href="#l23.162"></a><span id="l23.162"> </span>
<a href="#l23.163"></a><span id="l23.163" class="difflineminus">-// nsIMsgSearchNotify object</span>
<a href="#l23.164"></a><span id="l23.164" class="difflineminus">-var gSearchNotificationListener =</span>
<a href="#l23.165"></a><span id="l23.165" class="difflineminus">-{</span>
<a href="#l23.166"></a><span id="l23.166" class="difflineminus">-    onSearchHit: function(header, folder)</span>
<a href="#l23.167"></a><span id="l23.167" class="difflineminus">-    {</span>
<a href="#l23.168"></a><span id="l23.168" class="difflineminus">-      gNumTotalMessages++;</span>
<a href="#l23.169"></a><span id="l23.169" class="difflineminus">-      if (!header.isRead)</span>
<a href="#l23.170"></a><span id="l23.170" class="difflineminus">-        gNumUnreadMessages++;</span>
<a href="#l23.171"></a><span id="l23.171" class="difflineminus">-        // XXX todo</span>
<a href="#l23.172"></a><span id="l23.172" class="difflineminus">-        // update status text?</span>
<a href="#l23.173"></a><span id="l23.173" class="difflineminus">-    },</span>
<a href="#l23.174"></a><span id="l23.174" class="difflineminus">-</span>
<a href="#l23.175"></a><span id="l23.175" class="difflineminus">-    onSearchDone: function(status)</span>
<a href="#l23.176"></a><span id="l23.176" class="difflineminus">-    {</span>
<a href="#l23.177"></a><span id="l23.177" class="difflineminus">-        SetQSStatusText(gDBView.QueryInterface(Components.interfaces.nsITreeView).rowCount)</span>
<a href="#l23.178"></a><span id="l23.178" class="difflineminus">-        statusFeedback.showProgress(0);</span>
<a href="#l23.179"></a><span id="l23.179" class="difflineminus">-        gStatusBar.setAttribute(&quot;mode&quot;,&quot;normal&quot;);</span>
<a href="#l23.180"></a><span id="l23.180" class="difflineminus">-        gSearchInProgress = false;</span>
<a href="#l23.181"></a><span id="l23.181" class="difflineminus">-</span>
<a href="#l23.182"></a><span id="l23.182" class="difflineminus">-        // ### TODO need to find out if there's quick search within a virtual folder.</span>
<a href="#l23.183"></a><span id="l23.183" class="difflineminus">-        if (gCurrentVirtualFolderUri &amp;&amp;</span>
<a href="#l23.184"></a><span id="l23.184" class="difflineminus">-         (!gSearchInput || gSearchInput.value == &quot;&quot; || gSearchInput.showingSearchCriteria))</span>
<a href="#l23.185"></a><span id="l23.185" class="difflineminus">-        {</span>
<a href="#l23.186"></a><span id="l23.186" class="difflineminus">-          var vFolder = GetMsgFolderFromUri(gCurrentVirtualFolderUri, false);</span>
<a href="#l23.187"></a><span id="l23.187" class="difflineminus">-          var dbFolderInfo = vFolder.msgDatabase.dBFolderInfo;</span>
<a href="#l23.188"></a><span id="l23.188" class="difflineminus">-          dbFolderInfo.numUnreadMessages = gNumUnreadMessages;</span>
<a href="#l23.189"></a><span id="l23.189" class="difflineminus">-          dbFolderInfo.numMessages = gNumTotalMessages;</span>
<a href="#l23.190"></a><span id="l23.190" class="difflineminus">-          vFolder.updateSummaryTotals(true); // force update from db.</span>
<a href="#l23.191"></a><span id="l23.191" class="difflineminus">-          const MSG_DB_LARGE_COMMIT = 1;</span>
<a href="#l23.192"></a><span id="l23.192" class="difflineminus">-          vFolder.msgDatabase.Commit(MSG_DB_LARGE_COMMIT);</span>
<a href="#l23.193"></a><span id="l23.193" class="difflineminus">-          // now that we have finished loading a virtual folder,</span>
<a href="#l23.194"></a><span id="l23.194" class="difflineminus">-          // scroll to the correct message if there is at least one.</span>
<a href="#l23.195"></a><span id="l23.195" class="difflineminus">-          if (vFolder.getTotalMessages(false) &gt; 0)</span>
<a href="#l23.196"></a><span id="l23.196" class="difflineminus">-            ScrollToMessageAfterFolderLoad(vFolder);</span>
<a href="#l23.197"></a><span id="l23.197" class="difflineminus">-        }</span>
<a href="#l23.198"></a><span id="l23.198" class="difflineminus">-    },</span>
<a href="#l23.199"></a><span id="l23.199" class="difflineminus">-</span>
<a href="#l23.200"></a><span id="l23.200" class="difflineminus">-    onNewSearch: function()</span>
<a href="#l23.201"></a><span id="l23.201" class="difflineminus">-    {</span>
<a href="#l23.202"></a><span id="l23.202" class="difflineminus">-      statusFeedback.showProgress(0);</span>
<a href="#l23.203"></a><span id="l23.203" class="difflineminus">-      statusFeedback.showStatusString(gSearchBundle.getString(&quot;searchingMessage&quot;));</span>
<a href="#l23.204"></a><span id="l23.204" class="difflineminus">-      gStatusBar.setAttribute(&quot;mode&quot;,&quot;undetermined&quot;);</span>
<a href="#l23.205"></a><span id="l23.205" class="difflineminus">-      gSearchInProgress = true;</span>
<a href="#l23.206"></a><span id="l23.206" class="difflineminus">-      gNumTotalMessages = 0; </span>
<a href="#l23.207"></a><span id="l23.207" class="difflineminus">-      gNumUnreadMessages = 0;</span>
<a href="#l23.208"></a><span id="l23.208" class="difflineminus">-    }</span>
<a href="#l23.209"></a><span id="l23.209" class="difflineminus">-}</span>
<a href="#l23.210"></a><span id="l23.210" class="difflineminus">-</span>
<a href="#l23.211"></a><span id="l23.211"> function getDocumentElements()</span>
<a href="#l23.212"></a><span id="l23.212"> {</span>
<a href="#l23.213"></a><span id="l23.213" class="difflineminus">-  gSearchBundle = document.getElementById(&quot;bundle_search&quot;);  </span>
<a href="#l23.214"></a><span id="l23.214" class="difflineplus">+  gSearchBundle = document.getElementById(&quot;bundle_search&quot;);</span>
<a href="#l23.215"></a><span id="l23.215">   gStatusBar = document.getElementById('statusbar-icon');</span>
<a href="#l23.216"></a><span id="l23.216">   GetSearchInput();</span>
<a href="#l23.217"></a><span id="l23.217"> }</span>
<a href="#l23.218"></a><span id="l23.218"> </span>
<a href="#l23.219"></a><span id="l23.219" class="difflineminus">-function addListeners()</span>
<a href="#l23.220"></a><span id="l23.220" class="difflineminus">-{</span>
<a href="#l23.221"></a><span id="l23.221" class="difflineminus">-  gViewSearchListener = gDBView.QueryInterface(Components.interfaces.nsIMsgSearchNotify);</span>
<a href="#l23.222"></a><span id="l23.222" class="difflineminus">-  gSearchSession.registerListener(gViewSearchListener);</span>
<a href="#l23.223"></a><span id="l23.223" class="difflineminus">-}</span>
<a href="#l23.224"></a><span id="l23.224" class="difflineminus">-</span>
<a href="#l23.225"></a><span id="l23.225" class="difflineminus">-function removeListeners()</span>
<a href="#l23.226"></a><span id="l23.226" class="difflineminus">-{</span>
<a href="#l23.227"></a><span id="l23.227" class="difflineminus">-  gSearchSession.unregisterListener(gViewSearchListener);</span>
<a href="#l23.228"></a><span id="l23.228" class="difflineminus">-}</span>
<a href="#l23.229"></a><span id="l23.229" class="difflineminus">-</span>
<a href="#l23.230"></a><span id="l23.230" class="difflineminus">-function removeGlobalListeners()</span>
<a href="#l23.231"></a><span id="l23.231" class="difflineminus">-{</span>
<a href="#l23.232"></a><span id="l23.232" class="difflineminus">-  removeListeners();</span>
<a href="#l23.233"></a><span id="l23.233" class="difflineminus">-  gSearchSession.unregisterListener(gSearchNotificationListener); </span>
<a href="#l23.234"></a><span id="l23.234" class="difflineminus">-}</span>
<a href="#l23.235"></a><span id="l23.235" class="difflineminus">-</span>
<a href="#l23.236"></a><span id="l23.236" class="difflineminus">-function initializeGlobalListeners()</span>
<a href="#l23.237"></a><span id="l23.237" class="difflineminus">-{</span>
<a href="#l23.238"></a><span id="l23.238" class="difflineminus">-  // Setup the javascript object as a listener on the search results</span>
<a href="#l23.239"></a><span id="l23.239" class="difflineminus">-  gSearchSession.registerListener(gSearchNotificationListener);</span>
<a href="#l23.240"></a><span id="l23.240" class="difflineminus">-}</span>
<a href="#l23.241"></a><span id="l23.241" class="difflineminus">-</span>
<a href="#l23.242"></a><span id="l23.242" class="difflineminus">-function createQuickSearchView()</span>
<a href="#l23.243"></a><span id="l23.243" class="difflineminus">-{</span>
<a href="#l23.244"></a><span id="l23.244" class="difflineminus">-  //if not already in quick search view </span>
<a href="#l23.245"></a><span id="l23.245" class="difflineminus">-  if (gDBView.viewType != nsMsgViewType.eShowQuickSearchResults)  </span>
<a href="#l23.246"></a><span id="l23.246" class="difflineminus">-  {</span>
<a href="#l23.247"></a><span id="l23.247" class="difflineminus">-    var treeView = gDBView.QueryInterface(Components.interfaces.nsITreeView);  //clear selection</span>
<a href="#l23.248"></a><span id="l23.248" class="difflineminus">-    if (treeView &amp;&amp; treeView.selection)</span>
<a href="#l23.249"></a><span id="l23.249" class="difflineminus">-      treeView.selection.clearSelection();</span>
<a href="#l23.250"></a><span id="l23.250" class="difflineminus">-    gPreQuickSearchView = gDBView;</span>
<a href="#l23.251"></a><span id="l23.251" class="difflineminus">-    if (gDBView.viewType == nsMsgViewType.eShowVirtualFolderResults)</span>
<a href="#l23.252"></a><span id="l23.252" class="difflineminus">-    {</span>
<a href="#l23.253"></a><span id="l23.253" class="difflineminus">-      // remove the view as a listener on the search results</span>
<a href="#l23.254"></a><span id="l23.254" class="difflineminus">-      var saveViewSearchListener = gDBView.QueryInterface(Components.interfaces.nsIMsgSearchNotify);</span>
<a href="#l23.255"></a><span id="l23.255" class="difflineminus">-      gSearchSession.unregisterListener(saveViewSearchListener);</span>
<a href="#l23.256"></a><span id="l23.256" class="difflineminus">-    }</span>
<a href="#l23.257"></a><span id="l23.257" class="difflineminus">-    var viewFlags = gDBView.viewFlags;</span>
<a href="#l23.258"></a><span id="l23.258" class="difflineminus">-    CreateDBView(gDBView.msgFolder, (gXFVirtualFolderTerms) ? nsMsgViewType.eShowVirtualFolderResults : nsMsgViewType.eShowQuickSearchResults, viewFlags, gDBView.sortType, gDBView.sortOrder);</span>
<a href="#l23.259"></a><span id="l23.259" class="difflineminus">-  }</span>
<a href="#l23.260"></a><span id="l23.260" class="difflineminus">-}</span>
<a href="#l23.261"></a><span id="l23.261" class="difflineminus">-</span>
<a href="#l23.262"></a><span id="l23.262" class="difflineminus">-function initializeSearchBar()</span>
<a href="#l23.263"></a><span id="l23.263" class="difflineminus">-{</span>
<a href="#l23.264"></a><span id="l23.264" class="difflineminus">-   createQuickSearchView();</span>
<a href="#l23.265"></a><span id="l23.265" class="difflineminus">-   if (!gSearchSession)</span>
<a href="#l23.266"></a><span id="l23.266" class="difflineminus">-   {</span>
<a href="#l23.267"></a><span id="l23.267" class="difflineminus">-     getDocumentElements();</span>
<a href="#l23.268"></a><span id="l23.268" class="difflineminus">-     var searchSessionContractID = &quot;@mozilla.org/messenger/searchSession;1&quot;;</span>
<a href="#l23.269"></a><span id="l23.269" class="difflineminus">-     gSearchSession = Components.classes[searchSessionContractID].createInstance(Components.interfaces.nsIMsgSearchSession);</span>
<a href="#l23.270"></a><span id="l23.270" class="difflineminus">-     initializeGlobalListeners();</span>
<a href="#l23.271"></a><span id="l23.271" class="difflineminus">-   }</span>
<a href="#l23.272"></a><span id="l23.272" class="difflineminus">-   else</span>
<a href="#l23.273"></a><span id="l23.273" class="difflineminus">-   {</span>
<a href="#l23.274"></a><span id="l23.274" class="difflineminus">-     if (gSearchInProgress)</span>
<a href="#l23.275"></a><span id="l23.275" class="difflineminus">-     {</span>
<a href="#l23.276"></a><span id="l23.276" class="difflineminus">-       onSearchStop();</span>
<a href="#l23.277"></a><span id="l23.277" class="difflineminus">-       gSearchInProgress = false;</span>
<a href="#l23.278"></a><span id="l23.278" class="difflineminus">-     }</span>
<a href="#l23.279"></a><span id="l23.279" class="difflineminus">-     removeListeners();</span>
<a href="#l23.280"></a><span id="l23.280" class="difflineminus">-   }</span>
<a href="#l23.281"></a><span id="l23.281" class="difflineminus">-   addListeners();</span>
<a href="#l23.282"></a><span id="l23.282" class="difflineminus">-}</span>
<a href="#l23.283"></a><span id="l23.283" class="difflineminus">-</span>
<a href="#l23.284"></a><span id="l23.284"> function onEnterInSearchBar()</span>
<a href="#l23.285"></a><span id="l23.285"> {</span>
<a href="#l23.286"></a><span id="l23.286" class="difflineminus">-   if (!gSearchInput || gSearchInput.value == &quot;&quot; || gSearchInput.showingSearchCriteria) </span>
<a href="#l23.287"></a><span id="l23.287" class="difflineminus">-   { </span>
<a href="#l23.288"></a><span id="l23.288" class="difflineminus">-     if (gDBView.viewType == nsMsgViewType.eShowQuickSearchResults </span>
<a href="#l23.289"></a><span id="l23.289" class="difflineminus">-        || gDBView.viewType == nsMsgViewType.eShowVirtualFolderResults)</span>
<a href="#l23.290"></a><span id="l23.290" class="difflineminus">-     {</span>
<a href="#l23.291"></a><span id="l23.291" class="difflineminus">-       statusFeedback.showStatusString(&quot;&quot;);</span>
<a href="#l23.292"></a><span id="l23.292" class="difflineminus">-</span>
<a href="#l23.293"></a><span id="l23.293" class="difflineminus">-       viewDebug (&quot;onEnterInSearchBar gDefaultSearchViewTerms = &quot; + gDefaultSearchViewTerms + &quot;gVirtualFolderTerms = &quot; </span>
<a href="#l23.294"></a><span id="l23.294" class="difflineminus">-        + gVirtualFolderTerms + &quot;gXFVirtualFolderTerms = &quot; + gXFVirtualFolderTerms + &quot;\n&quot;);</span>
<a href="#l23.295"></a><span id="l23.295" class="difflineminus">-       var addTerms = gDefaultSearchViewTerms || gVirtualFolderTerms || gXFVirtualFolderTerms;</span>
<a href="#l23.296"></a><span id="l23.296" class="difflineminus">-       if (addTerms)</span>
<a href="#l23.297"></a><span id="l23.297" class="difflineminus">-       {</span>
<a href="#l23.298"></a><span id="l23.298" class="difflineminus">-           viewDebug (&quot;addTerms = &quot; + addTerms + &quot; count = &quot; + addTerms.Count() + &quot;\n&quot;);</span>
<a href="#l23.299"></a><span id="l23.299" class="difflineminus">-           initializeSearchBar();</span>
<a href="#l23.300"></a><span id="l23.300" class="difflineminus">-           onSearch(addTerms);</span>
<a href="#l23.301"></a><span id="l23.301" class="difflineminus">-       }</span>
<a href="#l23.302"></a><span id="l23.302" class="difflineminus">-       else</span>
<a href="#l23.303"></a><span id="l23.303" class="difflineminus">-        restorePreSearchView();</span>
<a href="#l23.304"></a><span id="l23.304" class="difflineminus">-     }</span>
<a href="#l23.305"></a><span id="l23.305" class="difflineminus">-     else if (gPreQuickSearchView &amp;&amp; !gDefaultSearchViewTerms)// may be a quick search from a cross-folder virtual folder</span>
<a href="#l23.306"></a><span id="l23.306" class="difflineminus">-      restorePreSearchView();</span>
<a href="#l23.307"></a><span id="l23.307" class="difflineminus">-     </span>
<a href="#l23.308"></a><span id="l23.308" class="difflineminus">-     if (gSearchInput)</span>
<a href="#l23.309"></a><span id="l23.309" class="difflineminus">-       gSearchInput.showingSearchCriteria = true;</span>
<a href="#l23.310"></a><span id="l23.310" class="difflineminus">-   </span>
<a href="#l23.311"></a><span id="l23.311" class="difflineminus">-     gQSViewIsDirty = false;</span>
<a href="#l23.312"></a><span id="l23.312" class="difflineminus">-     return;</span>
<a href="#l23.313"></a><span id="l23.313" class="difflineminus">-   }</span>
<a href="#l23.314"></a><span id="l23.314" class="difflineminus">-</span>
<a href="#l23.315"></a><span id="l23.315" class="difflineminus">-   initializeSearchBar();</span>
<a href="#l23.316"></a><span id="l23.316" class="difflineminus">-</span>
<a href="#l23.317"></a><span id="l23.317" class="difflineminus">-   ClearThreadPaneSelection();</span>
<a href="#l23.318"></a><span id="l23.318" class="difflineminus">-   ClearMessagePane();</span>
<a href="#l23.319"></a><span id="l23.319" class="difflineminus">-</span>
<a href="#l23.320"></a><span id="l23.320" class="difflineminus">-   onSearch(null);</span>
<a href="#l23.321"></a><span id="l23.321" class="difflineminus">-   gQSViewIsDirty = false;</span>
<a href="#l23.322"></a><span id="l23.322" class="difflineminus">-}</span>
<a href="#l23.323"></a><span id="l23.323" class="difflineminus">-</span>
<a href="#l23.324"></a><span id="l23.324" class="difflineminus">-function restorePreSearchView()</span>
<a href="#l23.325"></a><span id="l23.325" class="difflineminus">-{</span>
<a href="#l23.326"></a><span id="l23.326" class="difflineminus">-  var selectedHdr = null;</span>
<a href="#l23.327"></a><span id="l23.327" class="difflineminus">-  //save selection</span>
<a href="#l23.328"></a><span id="l23.328" class="difflineminus">-  try </span>
<a href="#l23.329"></a><span id="l23.329" class="difflineminus">-  {</span>
<a href="#l23.330"></a><span id="l23.330" class="difflineminus">-    selectedHdr = gDBView.hdrForFirstSelectedMessage;</span>
<a href="#l23.331"></a><span id="l23.331" class="difflineminus">-  }</span>
<a href="#l23.332"></a><span id="l23.332" class="difflineminus">-  catch (ex)</span>
<a href="#l23.333"></a><span id="l23.333" class="difflineminus">-  {}</span>
<a href="#l23.334"></a><span id="l23.334" class="difflineminus">-</span>
<a href="#l23.335"></a><span id="l23.335" class="difflineminus">-  //we might have to sort the view coming out of quick search</span>
<a href="#l23.336"></a><span id="l23.336" class="difflineminus">-  var sortType = gDBView.sortType;</span>
<a href="#l23.337"></a><span id="l23.337" class="difflineminus">-  var sortOrder = gDBView.sortOrder;</span>
<a href="#l23.338"></a><span id="l23.338" class="difflineminus">-  var viewFlags = gDBView.viewFlags;</span>
<a href="#l23.339"></a><span id="l23.339" class="difflineminus">-  var folder = gDBView.msgFolder;</span>
<a href="#l23.340"></a><span id="l23.340" class="difflineminus">-</span>
<a href="#l23.341"></a><span id="l23.341" class="difflineminus">-  gDBView.close();</span>
<a href="#l23.342"></a><span id="l23.342" class="difflineminus">-  gDBView = null; </span>
<a href="#l23.343"></a><span id="l23.343" class="difflineplus">+  if (!gSearchInput)</span>
<a href="#l23.344"></a><span id="l23.344" class="difflineplus">+    return;</span>
<a href="#l23.345"></a><span id="l23.345"> </span>
<a href="#l23.346"></a><span id="l23.346" class="difflineminus">-  if (gPreQuickSearchView)</span>
<a href="#l23.347"></a><span id="l23.347" class="difflineminus">-  {</span>
<a href="#l23.348"></a><span id="l23.348" class="difflineminus">-    gDBView = gPreQuickSearchView;</span>
<a href="#l23.349"></a><span id="l23.349" class="difflineminus">-    if (gDBView.viewType == nsMsgViewType.eShowVirtualFolderResults)</span>
<a href="#l23.350"></a><span id="l23.350" class="difflineminus">-    {</span>
<a href="#l23.351"></a><span id="l23.351" class="difflineminus">-      // read the view as a listener on the search results</span>
<a href="#l23.352"></a><span id="l23.352" class="difflineminus">-      var saveViewSearchListener = gDBView.QueryInterface(Components.interfaces.nsIMsgSearchNotify);</span>
<a href="#l23.353"></a><span id="l23.353" class="difflineminus">-      if (gSearchSession)</span>
<a href="#l23.354"></a><span id="l23.354" class="difflineminus">-        gSearchSession.registerListener(saveViewSearchListener);</span>
<a href="#l23.355"></a><span id="l23.355" class="difflineminus">-    }</span>
<a href="#l23.356"></a><span id="l23.356" class="difflineminus">-//    dump (&quot;view type = &quot; + gDBView.viewType + &quot;\n&quot;);</span>
<a href="#l23.357"></a><span id="l23.357" class="difflineminus">-</span>
<a href="#l23.358"></a><span id="l23.358" class="difflineminus">-    if (sortType != gDBView.sortType || sortOrder != gDBView.sortOrder)</span>
<a href="#l23.359"></a><span id="l23.359" class="difflineminus">-    {</span>
<a href="#l23.360"></a><span id="l23.360" class="difflineminus">-      gDBView.sort(sortType, sortOrder);</span>
<a href="#l23.361"></a><span id="l23.361" class="difflineminus">-    }</span>
<a href="#l23.362"></a><span id="l23.362" class="difflineminus">-    UpdateSortIndicators(sortType, sortOrder);</span>
<a href="#l23.363"></a><span id="l23.363" class="difflineminus">-</span>
<a href="#l23.364"></a><span id="l23.364" class="difflineminus">-    gPreQuickSearchView = null;    </span>
<a href="#l23.365"></a><span id="l23.365" class="difflineminus">-  }</span>
<a href="#l23.366"></a><span id="l23.366" class="difflineminus">-  else //create default view type</span>
<a href="#l23.367"></a><span id="l23.367" class="difflineminus">-  {</span>
<a href="#l23.368"></a><span id="l23.368" class="difflineminus">-    CreateDBView(folder, nsMsgViewType.eShowAllThreads, viewFlags, sortType, sortOrder);</span>
<a href="#l23.369"></a><span id="l23.369" class="difflineminus">-  }</span>
<a href="#l23.370"></a><span id="l23.370" class="difflineplus">+  // nothing changes while showing the criteria</span>
<a href="#l23.371"></a><span id="l23.371" class="difflineplus">+  if (gSearchInput.showingSearchCriteria)</span>
<a href="#l23.372"></a><span id="l23.372" class="difflineplus">+    return;</span>
<a href="#l23.373"></a><span id="l23.373"> </span>
<a href="#l23.374"></a><span id="l23.374" class="difflineminus">-  RerootThreadPane();</span>
<a href="#l23.375"></a><span id="l23.375" class="difflineminus">-   </span>
<a href="#l23.376"></a><span id="l23.376" class="difflineminus">-  var scrolled = false;</span>
<a href="#l23.377"></a><span id="l23.377" class="difflineminus">-  </span>
<a href="#l23.378"></a><span id="l23.378" class="difflineminus">-  // now restore selection</span>
<a href="#l23.379"></a><span id="l23.379" class="difflineminus">-  if (selectedHdr)</span>
<a href="#l23.380"></a><span id="l23.380" class="difflineminus">-  {</span>
<a href="#l23.381"></a><span id="l23.381" class="difflineminus">-    gDBView.selectMsgByKey(selectedHdr.messageKey);</span>
<a href="#l23.382"></a><span id="l23.382" class="difflineminus">-    var treeView = gDBView.QueryInterface(Components.interfaces.nsITreeView);</span>
<a href="#l23.383"></a><span id="l23.383" class="difflineminus">-    var selectedIndex = treeView.selection.currentIndex;</span>
<a href="#l23.384"></a><span id="l23.384" class="difflineminus">-    if (selectedIndex &gt;= 0) </span>
<a href="#l23.385"></a><span id="l23.385" class="difflineminus">-    {</span>
<a href="#l23.386"></a><span id="l23.386" class="difflineminus">-      // scroll</span>
<a href="#l23.387"></a><span id="l23.387" class="difflineminus">-      EnsureRowInThreadTreeIsVisible(selectedIndex);</span>
<a href="#l23.388"></a><span id="l23.388" class="difflineminus">-      scrolled = true;</span>
<a href="#l23.389"></a><span id="l23.389" class="difflineminus">-    }</span>
<a href="#l23.390"></a><span id="l23.390" class="difflineminus">-    else</span>
<a href="#l23.391"></a><span id="l23.391" class="difflineminus">-      ClearMessagePane();</span>
<a href="#l23.392"></a><span id="l23.392" class="difflineminus">-  }</span>
<a href="#l23.393"></a><span id="l23.393" class="difflineminus">-</span>
<a href="#l23.394"></a><span id="l23.394" class="difflineminus">-  if (!scrolled)</span>
<a href="#l23.395"></a><span id="l23.395" class="difflineminus">-    ScrollToMessageAfterFolderLoad(null);</span>
<a href="#l23.396"></a><span id="l23.396" class="difflineminus">-}</span>
<a href="#l23.397"></a><span id="l23.397" class="difflineminus">-</span>
<a href="#l23.398"></a><span id="l23.398" class="difflineminus">-function onSearch(aSearchTerms)</span>
<a href="#l23.399"></a><span id="l23.399" class="difflineminus">-{</span>
<a href="#l23.400"></a><span id="l23.400" class="difflineminus">-    viewDebug(&quot;in OnSearch, searchTerms = &quot; + aSearchTerms + &quot;\n&quot;);</span>
<a href="#l23.401"></a><span id="l23.401" class="difflineminus">-    RerootThreadPane();</span>
<a href="#l23.402"></a><span id="l23.402" class="difflineminus">-</span>
<a href="#l23.403"></a><span id="l23.403" class="difflineminus">-    if (aSearchTerms)</span>
<a href="#l23.404"></a><span id="l23.404" class="difflineminus">-      createSearchTermsWithList(aSearchTerms);</span>
<a href="#l23.405"></a><span id="l23.405" class="difflineminus">-    else</span>
<a href="#l23.406"></a><span id="l23.406" class="difflineminus">-      createSearchTerms();</span>
<a href="#l23.407"></a><span id="l23.407" class="difflineminus">-</span>
<a href="#l23.408"></a><span id="l23.408" class="difflineminus">-    gDBView.searchSession = gSearchSession;</span>
<a href="#l23.409"></a><span id="l23.409" class="difflineminus">-    try</span>
<a href="#l23.410"></a><span id="l23.410" class="difflineminus">-    {</span>
<a href="#l23.411"></a><span id="l23.411" class="difflineminus">-      gSearchSession.search(msgWindow);</span>
<a href="#l23.412"></a><span id="l23.412" class="difflineminus">-    }</span>
<a href="#l23.413"></a><span id="l23.413" class="difflineminus">-    catch(ex)</span>
<a href="#l23.414"></a><span id="l23.414" class="difflineminus">-    {</span>
<a href="#l23.415"></a><span id="l23.415" class="difflineminus">-      dump(&quot;Search Exception\n&quot;);</span>
<a href="#l23.416"></a><span id="l23.416" class="difflineminus">-    }</span>
<a href="#l23.417"></a><span id="l23.417" class="difflineplus">+  if (!gSearchInput || gSearchInput.value == &quot;&quot;)</span>
<a href="#l23.418"></a><span id="l23.418" class="difflineplus">+     gFolderDisplay.view.search.userTerms = null;</span>
<a href="#l23.419"></a><span id="l23.419" class="difflineplus">+  else</span>
<a href="#l23.420"></a><span id="l23.420" class="difflineplus">+     gFolderDisplay.view.search.quickSearch(gSearchInput.searchMode,</span>
<a href="#l23.421"></a><span id="l23.421" class="difflineplus">+                                            gSearchInput.value);</span>
<a href="#l23.422"></a><span id="l23.422"> }</span>
<a href="#l23.423"></a><span id="l23.423"> </span>
<a href="#l23.424"></a><span id="l23.424" class="difflineminus">-function createSearchTermsWithList(aTermsArray)</span>
<a href="#l23.425"></a><span id="l23.425" class="difflineminus">-{</span>
<a href="#l23.426"></a><span id="l23.426" class="difflineminus">-  var nsMsgSearchScope = Components.interfaces.nsMsgSearchScope;</span>
<a href="#l23.427"></a><span id="l23.427" class="difflineminus">-  var nsMsgSearchAttrib = Components.interfaces.nsMsgSearchAttrib;</span>
<a href="#l23.428"></a><span id="l23.428" class="difflineminus">-  var nsMsgSearchOp = Components.interfaces.nsMsgSearchOp;</span>
<a href="#l23.429"></a><span id="l23.429" class="difflineminus">-</span>
<a href="#l23.430"></a><span id="l23.430" class="difflineminus">-  gSearchSession.clearScopes();</span>
<a href="#l23.431"></a><span id="l23.431" class="difflineminus">-  var searchTerms = gSearchSession.searchTerms;</span>
<a href="#l23.432"></a><span id="l23.432" class="difflineminus">-  var searchTermsArray = searchTerms.QueryInterface(Components.interfaces.nsISupportsArray);</span>
<a href="#l23.433"></a><span id="l23.433" class="difflineminus">-  searchTermsArray.Clear();</span>
<a href="#l23.434"></a><span id="l23.434" class="difflineminus">-</span>
<a href="#l23.435"></a><span id="l23.435" class="difflineminus">-  var i;</span>
<a href="#l23.436"></a><span id="l23.436" class="difflineminus">-  var selectedFolder = GetThreadPaneFolder();</span>
<a href="#l23.437"></a><span id="l23.437" class="difflineminus">-  var ioService = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l23.438"></a><span id="l23.438" class="difflineminus">-                  .getService(Components.interfaces.nsIIOService);</span>
<a href="#l23.439"></a><span id="l23.439" class="difflineminus">-  </span>
<a href="#l23.440"></a><span id="l23.440" class="difflineminus">-  var termsArray = aTermsArray.QueryInterface(Components.interfaces.nsISupportsArray);</span>
<a href="#l23.441"></a><span id="l23.441" class="difflineminus">-</span>
<a href="#l23.442"></a><span id="l23.442" class="difflineminus">-  if (gXFVirtualFolderTerms)</span>
<a href="#l23.443"></a><span id="l23.443" class="difflineminus">-  {</span>
<a href="#l23.444"></a><span id="l23.444" class="difflineminus">-    var msgDatabase = selectedFolder.msgDatabase;</span>
<a href="#l23.445"></a><span id="l23.445" class="difflineminus">-    if (msgDatabase)</span>
<a href="#l23.446"></a><span id="l23.446" class="difflineminus">-    {</span>
<a href="#l23.447"></a><span id="l23.447" class="difflineminus">-      var dbFolderInfo = msgDatabase.dBFolderInfo;</span>
<a href="#l23.448"></a><span id="l23.448" class="difflineminus">-      var srchFolderUri = dbFolderInfo.getCharProperty(&quot;searchFolderUri&quot;);</span>
<a href="#l23.449"></a><span id="l23.449" class="difflineminus">-      viewDebug(&quot;createSearchTermsWithList xf vf scope = &quot; + srchFolderUri + &quot;\n&quot;);</span>
<a href="#l23.450"></a><span id="l23.450" class="difflineminus">-      var srchFolderUriArray = srchFolderUri.split('|');</span>
<a href="#l23.451"></a><span id="l23.451" class="difflineminus">-      for (i in srchFolderUriArray) </span>
<a href="#l23.452"></a><span id="l23.452" class="difflineminus">-      {</span>
<a href="#l23.453"></a><span id="l23.453" class="difflineminus">-        var realFolder = GetMsgFolderFromUri(srchFolderUriArray[i]);</span>
<a href="#l23.454"></a><span id="l23.454" class="difflineminus">-        if (!realFolder.isServer)</span>
<a href="#l23.455"></a><span id="l23.455" class="difflineminus">-          gSearchSession.addScopeTerm(getScopeToUse(termsArray, realFolder, ioService.offline), realFolder);</span>
<a href="#l23.456"></a><span id="l23.456" class="difflineminus">-      }</span>
<a href="#l23.457"></a><span id="l23.457" class="difflineminus">-    }</span>
<a href="#l23.458"></a><span id="l23.458" class="difflineminus">-  }</span>
<a href="#l23.459"></a><span id="l23.459" class="difflineminus">-  else</span>
<a href="#l23.460"></a><span id="l23.460" class="difflineminus">-  {</span>
<a href="#l23.461"></a><span id="l23.461" class="difflineminus">-    viewDebug (&quot;in createSearchTermsWithList, adding scope term for selected folder\n&quot;);</span>
<a href="#l23.462"></a><span id="l23.462" class="difflineminus">-    gSearchSession.addScopeTerm(getScopeToUse(termsArray, selectedFolder, ioService.offline), selectedFolder);</span>
<a href="#l23.463"></a><span id="l23.463" class="difflineminus">-  }</span>
<a href="#l23.464"></a><span id="l23.464" class="difflineminus">-</span>
<a href="#l23.465"></a><span id="l23.465" class="difflineminus">-  // add each item in termsArray to the search session</span>
<a href="#l23.466"></a><span id="l23.466" class="difflineminus">-  for (i = 0; i &lt; termsArray.Count(); ++i)</span>
<a href="#l23.467"></a><span id="l23.467" class="difflineminus">-    gSearchSession.appendTerm(termsArray.GetElementAt(i).QueryInterface(Components.interfaces.nsIMsgSearchTerm));</span>
<a href="#l23.468"></a><span id="l23.468" class="difflineminus">-}</span>
<a href="#l23.469"></a><span id="l23.469" class="difflineminus">-</span>
<a href="#l23.470"></a><span id="l23.470" class="difflineminus">-function getScopeToUse(aTermsArray, aFolderToSearch, aIsOffline)</span>
<a href="#l23.471"></a><span id="l23.471" class="difflineminus">-{</span>
<a href="#l23.472"></a><span id="l23.472" class="difflineminus">-  if (aIsOffline || aFolderToSearch.server.type != 'imap')</span>
<a href="#l23.473"></a><span id="l23.473" class="difflineminus">-    return nsMsgSearchScope.offlineMail;</span>
<a href="#l23.474"></a><span id="l23.474" class="difflineminus">-</span>
<a href="#l23.475"></a><span id="l23.475" class="difflineminus">-  var scopeToUse = gSearchInput &amp;&amp; gSearchInput.searchMode == kQuickSearchBody &amp;&amp; !gSearchInput.showingSearchCriteria</span>
<a href="#l23.476"></a><span id="l23.476" class="difflineminus">-                   ? nsMsgSearchScope.onlineMail : nsMsgSearchScope.offlineMail;</span>
<a href="#l23.477"></a><span id="l23.477" class="difflineminus">-</span>
<a href="#l23.478"></a><span id="l23.478" class="difflineminus">-  // it's possible one of our search terms may require us to use an online mail scope (such as imap body searches)</span>
<a href="#l23.479"></a><span id="l23.479" class="difflineminus">-  for (var i = 0; scopeToUse != nsMsgSearchScope.onlineMail &amp;&amp; i &lt; aTermsArray.Count(); i++)</span>
<a href="#l23.480"></a><span id="l23.480" class="difflineminus">-    if (aTermsArray.GetElementAt(i).QueryInterface(Components.interfaces.nsIMsgSearchTerm).attrib == nsMsgSearchAttrib.Body)</span>
<a href="#l23.481"></a><span id="l23.481" class="difflineminus">-      scopeToUse = nsMsgSearchScope.onlineMail;</span>
<a href="#l23.482"></a><span id="l23.482" class="difflineminus">-  </span>
<a href="#l23.483"></a><span id="l23.483" class="difflineminus">-  return scopeToUse;</span>
<a href="#l23.484"></a><span id="l23.484" class="difflineminus">-}</span>
<a href="#l23.485"></a><span id="l23.485" class="difflineminus">-</span>
<a href="#l23.486"></a><span id="l23.486" class="difflineminus">-function createSearchTerms()</span>
<a href="#l23.487"></a><span id="l23.487" class="difflineminus">-{</span>
<a href="#l23.488"></a><span id="l23.488" class="difflineminus">-  var nsMsgSearchScope = Components.interfaces.nsMsgSearchScope;</span>
<a href="#l23.489"></a><span id="l23.489" class="difflineminus">-  var nsMsgSearchAttrib = Components.interfaces.nsMsgSearchAttrib;</span>
<a href="#l23.490"></a><span id="l23.490" class="difflineminus">-  var nsMsgSearchOp = Components.interfaces.nsMsgSearchOp;</span>
<a href="#l23.491"></a><span id="l23.491" class="difflineminus">-</span>
<a href="#l23.492"></a><span id="l23.492" class="difflineminus">-  // create an i supports array to store our search terms </span>
<a href="#l23.493"></a><span id="l23.493" class="difflineminus">-  var searchTermsArray = Components.classes[&quot;@mozilla.org/supports-array;1&quot;].createInstance(Components.interfaces.nsISupportsArray);</span>
<a href="#l23.494"></a><span id="l23.494" class="difflineminus">-  var selectedFolder = GetThreadPaneFolder();</span>
<a href="#l23.495"></a><span id="l23.495" class="difflineminus">-</span>
<a href="#l23.496"></a><span id="l23.496" class="difflineminus">-  // implement | for QS</span>
<a href="#l23.497"></a><span id="l23.497" class="difflineminus">-  // does this break if the user types &quot;foo|bar&quot; expecting to see subjects with that string?</span>
<a href="#l23.498"></a><span id="l23.498" class="difflineminus">-  // I claim no, since &quot;foo|bar&quot; will be a hit for &quot;foo&quot; || &quot;bar&quot;</span>
<a href="#l23.499"></a><span id="l23.499" class="difflineminus">-  // they just might get more false positives</span>
<a href="#l23.500"></a><span id="l23.500" class="difflineminus">-  if (!gSearchInput.showingSearchCriteria) // ignore the text box value if it's just showing the search criteria string</span>
<a href="#l23.501"></a><span id="l23.501" class="difflineminus">-  {</span>
<a href="#l23.502"></a><span id="l23.502" class="difflineminus">-    var termList = gSearchInput.value.split(&quot;|&quot;);</span>
<a href="#l23.503"></a><span id="l23.503" class="difflineminus">-    for (var i = 0; i &lt; termList.length; i ++)</span>
<a href="#l23.504"></a><span id="l23.504" class="difflineminus">-    {</span>
<a href="#l23.505"></a><span id="l23.505" class="difflineminus">-      // if the term is empty, skip it</span>
<a href="#l23.506"></a><span id="l23.506" class="difflineminus">-      if (termList[i] == &quot;&quot;)</span>
<a href="#l23.507"></a><span id="l23.507" class="difflineminus">-        continue;</span>
<a href="#l23.508"></a><span id="l23.508" class="difflineminus">-</span>
<a href="#l23.509"></a><span id="l23.509" class="difflineminus">-      // create, fill, and append the subject term</span>
<a href="#l23.510"></a><span id="l23.510" class="difflineminus">-      var term;</span>
<a href="#l23.511"></a><span id="l23.511" class="difflineminus">-      var value;</span>
<a href="#l23.512"></a><span id="l23.512" class="difflineminus">-</span>
<a href="#l23.513"></a><span id="l23.513" class="difflineminus">-      // if our search criteria is subject or subject|from then add a term for the subject</span>
<a href="#l23.514"></a><span id="l23.514" class="difflineminus">-      if (gSearchInput.searchMode == kQuickSearchSubject ||</span>
<a href="#l23.515"></a><span id="l23.515" class="difflineminus">-          gSearchInput.searchMode == kQuickSearchFromOrSubject ||</span>
<a href="#l23.516"></a><span id="l23.516" class="difflineminus">-          gSearchInput.searchMode == kQuickSearchRecipientOrSubject)</span>
<a href="#l23.517"></a><span id="l23.517" class="difflineminus">-      {</span>
<a href="#l23.518"></a><span id="l23.518" class="difflineminus">-        term = gSearchSession.createTerm();</span>
<a href="#l23.519"></a><span id="l23.519" class="difflineminus">-        value = term.value;</span>
<a href="#l23.520"></a><span id="l23.520" class="difflineminus">-        value.str = termList[i];</span>
<a href="#l23.521"></a><span id="l23.521" class="difflineminus">-        term.value = value;</span>
<a href="#l23.522"></a><span id="l23.522" class="difflineminus">-        term.attrib = nsMsgSearchAttrib.Subject;</span>
<a href="#l23.523"></a><span id="l23.523" class="difflineminus">-        term.op = nsMsgSearchOp.Contains;</span>
<a href="#l23.524"></a><span id="l23.524" class="difflineminus">-        term.booleanAnd = false;</span>
<a href="#l23.525"></a><span id="l23.525" class="difflineminus">-        searchTermsArray.AppendElement(term);</span>
<a href="#l23.526"></a><span id="l23.526" class="difflineminus">-      }</span>
<a href="#l23.527"></a><span id="l23.527" class="difflineminus">-</span>
<a href="#l23.528"></a><span id="l23.528" class="difflineminus">-      if (gSearchInput.searchMode == kQuickSearchBody)</span>
<a href="#l23.529"></a><span id="l23.529" class="difflineminus">-      {</span>
<a href="#l23.530"></a><span id="l23.530" class="difflineminus">-        // what do we do for news and imap users that aren't configured for offline use?</span>
<a href="#l23.531"></a><span id="l23.531" class="difflineminus">-        // in these cases the body search will never return any matches. Should we try to </span>
<a href="#l23.532"></a><span id="l23.532" class="difflineminus">-        // see if body is a valid search scope in this particular case before doing the search?</span>
<a href="#l23.533"></a><span id="l23.533" class="difflineminus">-        // should we switch back to a subject/from search behind the scenes?</span>
<a href="#l23.534"></a><span id="l23.534" class="difflineminus">-        term = gSearchSession.createTerm();</span>
<a href="#l23.535"></a><span id="l23.535" class="difflineminus">-        value = term.value;</span>
<a href="#l23.536"></a><span id="l23.536" class="difflineminus">-        value.str = termList[i];</span>
<a href="#l23.537"></a><span id="l23.537" class="difflineminus">-        term.value = value;</span>
<a href="#l23.538"></a><span id="l23.538" class="difflineminus">-        term.attrib = nsMsgSearchAttrib.Body;</span>
<a href="#l23.539"></a><span id="l23.539" class="difflineminus">-        term.op = nsMsgSearchOp.Contains; </span>
<a href="#l23.540"></a><span id="l23.540" class="difflineminus">-        term.booleanAnd = false;</span>
<a href="#l23.541"></a><span id="l23.541" class="difflineminus">-        searchTermsArray.AppendElement(term);       </span>
<a href="#l23.542"></a><span id="l23.542" class="difflineminus">-      }</span>
<a href="#l23.543"></a><span id="l23.543" class="difflineminus">-</span>
<a href="#l23.544"></a><span id="l23.544" class="difflineminus">-      // create, fill, and append the from (or recipient) term</span>
<a href="#l23.545"></a><span id="l23.545" class="difflineminus">-      if (gSearchInput.searchMode == kQuickSearchFrom || gSearchInput.searchMode == kQuickSearchFromOrSubject)</span>
<a href="#l23.546"></a><span id="l23.546" class="difflineminus">-      {</span>
<a href="#l23.547"></a><span id="l23.547" class="difflineminus">-        term = gSearchSession.createTerm();</span>
<a href="#l23.548"></a><span id="l23.548" class="difflineminus">-        value = term.value;</span>
<a href="#l23.549"></a><span id="l23.549" class="difflineminus">-        value.str = termList[i];</span>
<a href="#l23.550"></a><span id="l23.550" class="difflineminus">-        term.value = value;</span>
<a href="#l23.551"></a><span id="l23.551" class="difflineminus">-        term.attrib = nsMsgSearchAttrib.Sender;</span>
<a href="#l23.552"></a><span id="l23.552" class="difflineminus">-        term.op = nsMsgSearchOp.Contains; </span>
<a href="#l23.553"></a><span id="l23.553" class="difflineminus">-        term.booleanAnd = false;</span>
<a href="#l23.554"></a><span id="l23.554" class="difflineminus">-        searchTermsArray.AppendElement(term);</span>
<a href="#l23.555"></a><span id="l23.555" class="difflineminus">-      }</span>
<a href="#l23.556"></a><span id="l23.556" class="difflineminus">-</span>
<a href="#l23.557"></a><span id="l23.557" class="difflineminus">-      // create, fill, and append the recipient</span>
<a href="#l23.558"></a><span id="l23.558" class="difflineminus">-      if (gSearchInput.searchMode == kQuickSearchRecipient ||</span>
<a href="#l23.559"></a><span id="l23.559" class="difflineminus">-          gSearchInput.searchMode == kQuickSearchRecipientOrSubject)</span>
<a href="#l23.560"></a><span id="l23.560" class="difflineminus">-      {</span>
<a href="#l23.561"></a><span id="l23.561" class="difflineminus">-        term = gSearchSession.createTerm();</span>
<a href="#l23.562"></a><span id="l23.562" class="difflineminus">-        value = term.value;</span>
<a href="#l23.563"></a><span id="l23.563" class="difflineminus">-        value.str = termList[i];</span>
<a href="#l23.564"></a><span id="l23.564" class="difflineminus">-        term.value = value;</span>
<a href="#l23.565"></a><span id="l23.565" class="difflineminus">-        term.attrib = nsMsgSearchAttrib.ToOrCC;</span>
<a href="#l23.566"></a><span id="l23.566" class="difflineminus">-        term.op = nsMsgSearchOp.Contains; </span>
<a href="#l23.567"></a><span id="l23.567" class="difflineminus">-        term.booleanAnd = false;</span>
<a href="#l23.568"></a><span id="l23.568" class="difflineminus">-        searchTermsArray.AppendElement(term);</span>
<a href="#l23.569"></a><span id="l23.569" class="difflineminus">-      }</span>
<a href="#l23.570"></a><span id="l23.570" class="difflineminus">-    }</span>
<a href="#l23.571"></a><span id="l23.571" class="difflineminus">-  }</span>
<a href="#l23.572"></a><span id="l23.572" class="difflineminus">-</span>
<a href="#l23.573"></a><span id="l23.573" class="difflineminus">-  // now append the default view or virtual folder criteria to the quick search   </span>
<a href="#l23.574"></a><span id="l23.574" class="difflineminus">-  // so we don't lose any default view information</span>
<a href="#l23.575"></a><span id="l23.575" class="difflineminus">-  viewDebug(&quot;gDefaultSearchViewTerms = &quot; + gDefaultSearchViewTerms + &quot;gVirtualFolderTerms = &quot; + gVirtualFolderTerms + </span>
<a href="#l23.576"></a><span id="l23.576" class="difflineminus">-    &quot;gXFVirtualFolderTerms = &quot; + gXFVirtualFolderTerms + &quot;\n&quot;);</span>
<a href="#l23.577"></a><span id="l23.577" class="difflineminus">-  var defaultSearchTerms = (gDefaultSearchViewTerms || gVirtualFolderTerms || gXFVirtualFolderTerms);</span>
<a href="#l23.578"></a><span id="l23.578" class="difflineminus">-  if (defaultSearchTerms)</span>
<a href="#l23.579"></a><span id="l23.579" class="difflineminus">-  {</span>
<a href="#l23.580"></a><span id="l23.580" class="difflineminus">-    var isupports = null;</span>
<a href="#l23.581"></a><span id="l23.581" class="difflineminus">-    var searchTerm; </span>
<a href="#l23.582"></a><span id="l23.582" class="difflineminus">-    var termsArray = defaultSearchTerms.QueryInterface(Components.interfaces.nsISupportsArray);</span>
<a href="#l23.583"></a><span id="l23.583" class="difflineminus">-    for (i = 0; i &lt; termsArray.Count(); i++)</span>
<a href="#l23.584"></a><span id="l23.584" class="difflineminus">-    {</span>
<a href="#l23.585"></a><span id="l23.585" class="difflineminus">-      isupports = termsArray.GetElementAt(i);</span>
<a href="#l23.586"></a><span id="l23.586" class="difflineminus">-      searchTerm = isupports.QueryInterface(Components.interfaces.nsIMsgSearchTerm);</span>
<a href="#l23.587"></a><span id="l23.587" class="difflineminus">-      searchTermsArray.AppendElement(searchTerm);</span>
<a href="#l23.588"></a><span id="l23.588" class="difflineminus">-    }</span>
<a href="#l23.589"></a><span id="l23.589" class="difflineminus">-  }</span>
<a href="#l23.590"></a><span id="l23.590" class="difflineminus">-  </span>
<a href="#l23.591"></a><span id="l23.591" class="difflineminus">-  createSearchTermsWithList(searchTermsArray);</span>
<a href="#l23.592"></a><span id="l23.592" class="difflineminus">-  </span>
<a href="#l23.593"></a><span id="l23.593" class="difflineminus">-  // now that we've added the terms, clear out our input array</span>
<a href="#l23.594"></a><span id="l23.594" class="difflineminus">-  searchTermsArray.Clear();</span>
<a href="#l23.595"></a><span id="l23.595" class="difflineminus">-}</span>
<a href="#l23.596"></a><span id="l23.596" class="difflineminus">-</span>
<a href="#l23.597"></a><span id="l23.597" class="difflineminus">-function onSearchStop() </span>
<a href="#l23.598"></a><span id="l23.598" class="difflineminus">-{</span>
<a href="#l23.599"></a><span id="l23.599" class="difflineminus">-  gSearchSession.interruptSearch();</span>
<a href="#l23.600"></a><span id="l23.600" class="difflineminus">-}</span>
<a href="#l23.601"></a><span id="l23.601"> </span>
<a href="#l23.602"></a><span id="l23.602"> function onSearchKeyPress()</span>
<a href="#l23.603"></a><span id="l23.603"> {</span>
<a href="#l23.604"></a><span id="l23.604">   if (gSearchInput.showingSearchCriteria)</span>
<a href="#l23.605"></a><span id="l23.605">     gSearchInput.showingSearchCriteria = false;</span>
<a href="#l23.606"></a><span id="l23.606"> }</span>
<a href="#l23.607"></a><span id="l23.607"> </span>
<a href="#l23.608"></a><span id="l23.608"> function onSearchInputFocus(event)</span>
<a href="#l23.609"></a><span id="l23.609"> {</span>
<a href="#l23.610"></a><span id="l23.610">   GetSearchInput();</span>
<a href="#l23.611"></a><span id="l23.611">   // search bar has focus, ...clear the showing search criteria flag</span>
<a href="#l23.612"></a><span id="l23.612">   if (gSearchInput.showingSearchCriteria)</span>
<a href="#l23.613"></a><span id="l23.613">   {</span>
<a href="#l23.614"></a><span id="l23.614">     gSearchInput.value = &quot;&quot;;</span>
<a href="#l23.615"></a><span id="l23.615">     gSearchInput.showingSearchCriteria = false;</span>
<a href="#l23.616"></a><span id="l23.616">   }</span>
<a href="#l23.617"></a><span id="l23.617" class="difflineminus">-  </span>
<a href="#l23.618"></a><span id="l23.618" class="difflineplus">+</span>
<a href="#l23.619"></a><span id="l23.619">   if (gIgnoreFocus) // got focus via mouse click, don't need to anything else</span>
<a href="#l23.620"></a><span id="l23.620">     gIgnoreFocus = false;</span>
<a href="#l23.621"></a><span id="l23.621">   else</span>
<a href="#l23.622"></a><span id="l23.622">     gSearchInput.select();</span>
<a href="#l23.623"></a><span id="l23.623"> }</span>
<a href="#l23.624"></a><span id="l23.624"> </span>
<a href="#l23.625"></a><span id="l23.625"> function onSearchInputMousedown(event)</span>
<a href="#l23.626"></a><span id="l23.626"> {</span>
<a href="#l23.627"></a><span id="l23.627">   GetSearchInput();</span>
<a href="#l23.628"></a><span id="l23.628" class="difflineminus">-  if (gSearchInput.hasAttribute(&quot;focused&quot;)) </span>
<a href="#l23.629"></a><span id="l23.629" class="difflineplus">+  if (gSearchInput.hasAttribute(&quot;focused&quot;))</span>
<a href="#l23.630"></a><span id="l23.630">     // If the search input is focused already, ignore the click so that</span>
<a href="#l23.631"></a><span id="l23.631">     // onSearchInputBlur does nothing.</span>
<a href="#l23.632"></a><span id="l23.632">     gIgnoreClick = true;</span>
<a href="#l23.633"></a><span id="l23.633" class="difflineminus">-  else </span>
<a href="#l23.634"></a><span id="l23.634" class="difflineplus">+  else</span>
<a href="#l23.635"></a><span id="l23.635">   {</span>
<a href="#l23.636"></a><span id="l23.636">     gIgnoreFocus = true;</span>
<a href="#l23.637"></a><span id="l23.637">     gIgnoreClick = false;</span>
<a href="#l23.638"></a><span id="l23.638">   }</span>
<a href="#l23.639"></a><span id="l23.639"> }</span>
<a href="#l23.640"></a><span id="l23.640"> </span>
<a href="#l23.641"></a><span id="l23.641"> function onSearchInputClick(event)</span>
<a href="#l23.642"></a><span id="l23.642"> {</span>
<a href="#l23.643"></a><span id="l23.643" class="difflineat">@@ -587,67 +195,59 @@ function ClearQSIfNecessary()</span>
<a href="#l23.644"></a><span id="l23.644"> {</span>
<a href="#l23.645"></a><span id="l23.645">   if (!gSearchInput || gSearchInput.showingSearchCriteria)</span>
<a href="#l23.646"></a><span id="l23.646">     return;</span>
<a href="#l23.647"></a><span id="l23.647">   gSearchInput.setSearchCriteriaText();</span>
<a href="#l23.648"></a><span id="l23.648"> }</span>
<a href="#l23.649"></a><span id="l23.649"> </span>
<a href="#l23.650"></a><span id="l23.650"> function Search(str)</span>
<a href="#l23.651"></a><span id="l23.651"> {</span>
<a href="#l23.652"></a><span id="l23.652" class="difflineminus">-  viewDebug(&quot;in Search str = &quot; + str + &quot;gSearchInput.showingSearchCriteria = &quot; + gSearchInput.showingSearchCriteria + &quot;\n&quot;);</span>
<a href="#l23.653"></a><span id="l23.653">   if (gSearchInput.showingSearchCriteria &amp;&amp; str != &quot;&quot;)</span>
<a href="#l23.654"></a><span id="l23.654">     return;</span>
<a href="#l23.655"></a><span id="l23.655"> </span>
<a href="#l23.656"></a><span id="l23.656" class="difflineminus">-  if (str != gSearchInput.value)</span>
<a href="#l23.657"></a><span id="l23.657" class="difflineminus">-  {</span>
<a href="#l23.658"></a><span id="l23.658" class="difflineminus">-    gQSViewIsDirty = true; </span>
<a href="#l23.659"></a><span id="l23.659" class="difflineminus">-    viewDebug(&quot;in Search(), setting gQSViewIsDirty true\n&quot;);</span>
<a href="#l23.660"></a><span id="l23.660" class="difflineminus">-  }</span>
<a href="#l23.661"></a><span id="l23.661" class="difflineminus">-</span>
<a href="#l23.662"></a><span id="l23.662">   gSearchInput.value = str;  //on input does not get fired for some reason</span>
<a href="#l23.663"></a><span id="l23.663">   onEnterInSearchBar();</span>
<a href="#l23.664"></a><span id="l23.664"> }</span>
<a href="#l23.665"></a><span id="l23.665"> </span>
<a href="#l23.666"></a><span id="l23.666"> // helper methods for the quick search drop down menu</span>
<a href="#l23.667"></a><span id="l23.667"> function changeQuickSearchMode(aMenuItem)</span>
<a href="#l23.668"></a><span id="l23.668"> {</span>
<a href="#l23.669"></a><span id="l23.669" class="difflineminus">-  viewDebug(&quot;changing quick search mode\n&quot;);</span>
<a href="#l23.670"></a><span id="l23.670">   // extract the label and set the search input to match it</span>
<a href="#l23.671"></a><span id="l23.671">   var oldSearchMode = gSearchInput.searchMode;</span>
<a href="#l23.672"></a><span id="l23.672">   gSearchInput.searchMode = aMenuItem.value;</span>
<a href="#l23.673"></a><span id="l23.673"> </span>
<a href="#l23.674"></a><span id="l23.674">   if (gSearchInput.value == &quot;&quot; || gSearchInput.showingSearchCriteria)</span>
<a href="#l23.675"></a><span id="l23.675">   {</span>
<a href="#l23.676"></a><span id="l23.676">     gSearchInput.showingSearchCriteria = true;</span>
<a href="#l23.677"></a><span id="l23.677" class="difflineminus">-    if (gSearchInput.value) // </span>
<a href="#l23.678"></a><span id="l23.678" class="difflineplus">+    if (gSearchInput.value) //</span>
<a href="#l23.679"></a><span id="l23.679">       gSearchInput.setSearchCriteriaText();</span>
<a href="#l23.680"></a><span id="l23.680">   }</span>
<a href="#l23.681"></a><span id="l23.681" class="difflineminus">-  </span>
<a href="#l23.682"></a><span id="l23.682" class="difflineplus">+</span>
<a href="#l23.683"></a><span id="l23.683">   // if the search box is empty, set showing search criteria to true so it shows up when focus moves out of the box</span>
<a href="#l23.684"></a><span id="l23.684" class="difflineminus">-  if (!gSearchInput.value)   </span>
<a href="#l23.685"></a><span id="l23.685" class="difflineplus">+  if (!gSearchInput.value)</span>
<a href="#l23.686"></a><span id="l23.686">     gSearchInput.showingSearchCriteria = true;</span>
<a href="#l23.687"></a><span id="l23.687">   else if (gSearchInput.showingSearchCriteria) // if we are showing criteria text and the box isn't empty, change the criteria text</span>
<a href="#l23.688"></a><span id="l23.688" class="difflineminus">-    gSearchInput.setSearchCriteriaText();     </span>
<a href="#l23.689"></a><span id="l23.689" class="difflineplus">+    gSearchInput.setSearchCriteriaText();</span>
<a href="#l23.690"></a><span id="l23.690">   else if (oldSearchMode != gSearchInput.searchMode) // the search mode just changed so we need to redo the quick search</span>
<a href="#l23.691"></a><span id="l23.691">     onEnterInSearchBar();</span>
<a href="#l23.692"></a><span id="l23.692"> }</span>
<a href="#l23.693"></a><span id="l23.693"> </span>
<a href="#l23.694"></a><span id="l23.694"> function saveViewAsVirtualFolder()</span>
<a href="#l23.695"></a><span id="l23.695"> {</span>
<a href="#l23.696"></a><span id="l23.696">   gFolderTreeController.newVirtualFolder(gSearchInput.value,</span>
<a href="#l23.697"></a><span id="l23.697">                                          gSearchSession.searchTerms);</span>
<a href="#l23.698"></a><span id="l23.698"> }</span>
<a href="#l23.699"></a><span id="l23.699"> </span>
<a href="#l23.700"></a><span id="l23.700"> function InitQuickSearchPopup()</span>
<a href="#l23.701"></a><span id="l23.701"> {</span>
<a href="#l23.702"></a><span id="l23.702">   // disable the create virtual folder menu item if the current radio</span>
<a href="#l23.703"></a><span id="l23.703">   // value is set to Find in message since you can't really  create a VF from find</span>
<a href="#l23.704"></a><span id="l23.704">   // in message</span>
<a href="#l23.705"></a><span id="l23.705" class="difflineminus">-  </span>
<a href="#l23.706"></a><span id="l23.706" class="difflineminus">-  GetSearchInput();  </span>
<a href="#l23.707"></a><span id="l23.707" class="difflineplus">+</span>
<a href="#l23.708"></a><span id="l23.708" class="difflineplus">+  GetSearchInput();</span>
<a href="#l23.709"></a><span id="l23.709">   if (!gSearchInput ||gSearchInput.value == &quot;&quot; || gSearchInput.showingSearchCriteria)</span>
<a href="#l23.710"></a><span id="l23.710">     document.getElementById('quickSearchSaveAsVirtualFolder').setAttribute('disabled', 'true');</span>
<a href="#l23.711"></a><span id="l23.711">   else</span>
<a href="#l23.712"></a><span id="l23.712">     document.getElementById('quickSearchSaveAsVirtualFolder').removeAttribute('disabled');</span>
<a href="#l23.713"></a><span id="l23.713"> }</span>
<a href="#l23.714"></a><span id="l23.714"> </span>
<a href="#l23.715"></a><span id="l23.715"> /**</span>
<a href="#l23.716"></a><span id="l23.716">  * If switching from an &quot;incoming&quot; (Inbox, etc.) type of mail folder,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mail/base/content/selectionsummaries.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mail/base/content/selectionsummaries.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -64,37 +64,16 @@ function loadSelectionSummaryStrings() {</span>
<a href="#l24.4"></a><span id="l24.4">   strBundleService = strBundleService.QueryInterface(Components.interfaces.nsIStringBundleService);</span>
<a href="#l24.5"></a><span id="l24.5">     for (let [name, value] in Iterator(gSelectionSummaryStrings))</span>
<a href="#l24.6"></a><span id="l24.6">       gSelectionSummaryStrings[name] = typeof value == &quot;string&quot; ?</span>
<a href="#l24.7"></a><span id="l24.7">         getStr(value) : value.map(gSelectionSummaryStrings);</span>
<a href="#l24.8"></a><span id="l24.8"> }</span>
<a href="#l24.9"></a><span id="l24.9"> </span>
<a href="#l24.10"></a><span id="l24.10"> loadSelectionSummaryStrings();</span>
<a href="#l24.11"></a><span id="l24.11"> </span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-/**</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineminus">- * pickMessagePane is the toggle to figure out whether to use the standard</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineminus">- * message pane used to display message bodies (&amp; headers), or whether to</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineminus">- * display an HTML iframe used for the multiple message summaries.</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineminus">- *</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineminus">- * @param visiblePaneId</span>
<a href="#l24.18"></a><span id="l24.18" class="difflineminus">- *        the ID of the pane that we want to make be the visible one.</span>
<a href="#l24.19"></a><span id="l24.19" class="difflineminus">- * @return the DOM element corresponding to the selected pane.</span>
<a href="#l24.20"></a><span id="l24.20" class="difflineminus">- *</span>
<a href="#l24.21"></a><span id="l24.21" class="difflineminus">- */</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineminus">-function pickMessagePane(visiblePaneId) {</span>
<a href="#l24.23"></a><span id="l24.23" class="difflineminus">-  var paneIds = ['singlemessage', 'multimessage'];</span>
<a href="#l24.24"></a><span id="l24.24" class="difflineminus">-  // when we want to do folder and account summaries, we just need to add</span>
<a href="#l24.25"></a><span id="l24.25" class="difflineminus">-  // XUL elements for them, and add them to this list.</span>
<a href="#l24.26"></a><span id="l24.26" class="difflineminus">-  //               'foldersummary', 'accountsummary'];</span>
<a href="#l24.27"></a><span id="l24.27" class="difflineminus">-  for (let [,paneId] in Iterator(paneIds))</span>
<a href="#l24.28"></a><span id="l24.28" class="difflineminus">-    document.getElementById(paneId).hidden = paneId != visiblePaneId;</span>
<a href="#l24.29"></a><span id="l24.29" class="difflineminus">-</span>
<a href="#l24.30"></a><span id="l24.30" class="difflineminus">-  return document.getElementById(visiblePaneId);</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineminus">-}</span>
<a href="#l24.32"></a><span id="l24.32" class="difflineminus">-</span>
<a href="#l24.33"></a><span id="l24.33"> // Ah, wouldn't it be nice if there was platform code to do the following...</span>
<a href="#l24.34"></a><span id="l24.34"> </span>
<a href="#l24.35"></a><span id="l24.35"> /**</span>
<a href="#l24.36"></a><span id="l24.36">  * the equivalent of jQuery's addClass.  Avoids duplicates, nothing fancy.</span>
<a href="#l24.37"></a><span id="l24.37">  *</span>
<a href="#l24.38"></a><span id="l24.38">  * @param node</span>
<a href="#l24.39"></a><span id="l24.39">  *        any old DOM node</span>
<a href="#l24.40"></a><span id="l24.40">  * @param classname</span>
<a href="#l24.41"></a><span id="l24.41" class="difflineat">@@ -143,33 +122,30 @@ function _mm_removeClass(node, classname</span>
<a href="#l24.42"></a><span id="l24.42">  * It uses the same multimessage iframe as ThreadSummary, so both it</span>
<a href="#l24.43"></a><span id="l24.43">  * and ThreadSummary should be careful to clean up the other's work</span>
<a href="#l24.44"></a><span id="l24.44">  * before inserting their DOM nodes into the frame.</span>
<a href="#l24.45"></a><span id="l24.45">  *</span>
<a href="#l24.46"></a><span id="l24.46">  * There's a two phase process: build the framework based on what's available</span>
<a href="#l24.47"></a><span id="l24.47">  * from the msgHdr itself, and then spawn an aysnc Gloda query which will</span>
<a href="#l24.48"></a><span id="l24.48">  * fetch the snippets, tags, etc.</span>
<a href="#l24.49"></a><span id="l24.49">  *</span>
<a href="#l24.50"></a><span id="l24.50" class="difflineminus">- * @param msgURIs</span>
<a href="#l24.51"></a><span id="l24.51" class="difflineminus">- *        array of message URIs</span>
<a href="#l24.52"></a><span id="l24.52" class="difflineplus">+ * @param aMessages</span>
<a href="#l24.53"></a><span id="l24.53" class="difflineplus">+ *        Array of message headers.</span>
<a href="#l24.54"></a><span id="l24.54">  */</span>
<a href="#l24.55"></a><span id="l24.55"> </span>
<a href="#l24.56"></a><span id="l24.56" class="difflineminus">-function MultiMessageSummary(msgURIs) {</span>
<a href="#l24.57"></a><span id="l24.57" class="difflineminus">-  this._msgURIs = msgURIs;</span>
<a href="#l24.58"></a><span id="l24.58" class="difflineplus">+function MultiMessageSummary(aMessages) {</span>
<a href="#l24.59"></a><span id="l24.59" class="difflineplus">+  this._msgHdrs = aMessages;</span>
<a href="#l24.60"></a><span id="l24.60"> }</span>
<a href="#l24.61"></a><span id="l24.61"> </span>
<a href="#l24.62"></a><span id="l24.62"> MultiMessageSummary.prototype = {</span>
<a href="#l24.63"></a><span id="l24.63">   init: function() {</span>
<a href="#l24.64"></a><span id="l24.64">     this._msgTagService = Components.classes[&quot;@mozilla.org/messenger/tagservice;1&quot;].</span>
<a href="#l24.65"></a><span id="l24.65">                           getService(Components.interfaces.nsIMsgTagService);</span>
<a href="#l24.66"></a><span id="l24.66" class="difflineminus">-    this._msgHdrs = new Array();</span>
<a href="#l24.67"></a><span id="l24.67">     this._glodaQueries = [];</span>
<a href="#l24.68"></a><span id="l24.68">     this._msgNodes = {};</span>
<a href="#l24.69"></a><span id="l24.69" class="difflineminus">-    for (var i = 0; i &lt; this._msgURIs.length; ++i)</span>
<a href="#l24.70"></a><span id="l24.70" class="difflineminus">-      this._msgHdrs.push(messenger.msgHdrFromURI(this._msgURIs[i]));</span>
<a href="#l24.71"></a><span id="l24.71"> </span>
<a href="#l24.72"></a><span id="l24.72">     this.summarize();</span>
<a href="#l24.73"></a><span id="l24.73">   },</span>
<a href="#l24.74"></a><span id="l24.74"> </span>
<a href="#l24.75"></a><span id="l24.75">   /**</span>
<a href="#l24.76"></a><span id="l24.76">    * Given a msgHdr, return a list of tag objects. This function</span>
<a href="#l24.77"></a><span id="l24.77">    * just does the messy work of understanding how tags are</span>
<a href="#l24.78"></a><span id="l24.78">    * stored in nsIMsgDBHdrs.  It would be a good candidate for</span>
<a href="#l24.79"></a><span id="l24.79" class="difflineat">@@ -212,17 +188,17 @@ MultiMessageSummary.prototype = {</span>
<a href="#l24.80"></a><span id="l24.80">       senderName = senderName.slice(1, -1);</span>
<a href="#l24.81"></a><span id="l24.81">     return senderName;</span>
<a href="#l24.82"></a><span id="l24.82">   },</span>
<a href="#l24.83"></a><span id="l24.83"> </span>
<a href="#l24.84"></a><span id="l24.84">   /**</span>
<a href="#l24.85"></a><span id="l24.85">    * Fill in the summary pane describing the selected messages</span>
<a href="#l24.86"></a><span id="l24.86">    **/</span>
<a href="#l24.87"></a><span id="l24.87">   summarize: function() {</span>
<a href="#l24.88"></a><span id="l24.88" class="difflineminus">-    let htmlpane = pickMessagePane('multimessage');</span>
<a href="#l24.89"></a><span id="l24.89" class="difflineplus">+    let htmlpane = document.getElementById('multimessage');</span>
<a href="#l24.90"></a><span id="l24.90">     // First, we group the messages in threads.</span>
<a href="#l24.91"></a><span id="l24.91">     // count threads</span>
<a href="#l24.92"></a><span id="l24.92">     let threads = {};</span>
<a href="#l24.93"></a><span id="l24.93">     let numThreads = 0;</span>
<a href="#l24.94"></a><span id="l24.94">     let headerParser = Components.classes[&quot;@mozilla.org/messenger/headerparser;1&quot;].</span>
<a href="#l24.95"></a><span id="l24.95">                          getService(Components.interfaces.nsIMsgHeaderParser);</span>
<a href="#l24.96"></a><span id="l24.96">     for (let [,msgHdr] in Iterator(this._msgHdrs))</span>
<a href="#l24.97"></a><span id="l24.97">     {</span>
<a href="#l24.98"></a><span id="l24.98" class="difflineat">@@ -235,17 +211,17 @@ MultiMessageSummary.prototype = {</span>
<a href="#l24.99"></a><span id="l24.99">       }</span>
<a href="#l24.100"></a><span id="l24.100">     }</span>
<a href="#l24.101"></a><span id="l24.101"> </span>
<a href="#l24.102"></a><span id="l24.102">     // set the heading based on the number of messages &amp; threads</span>
<a href="#l24.103"></a><span id="l24.103">     let heading = htmlpane.contentDocument.getElementById('heading');</span>
<a href="#l24.104"></a><span id="l24.104">     _mm_addClass(heading, &quot;heading&quot;);</span>
<a href="#l24.105"></a><span id="l24.105">     _mm_addClass(heading, &quot;info&quot;);</span>
<a href="#l24.106"></a><span id="l24.106"> </span>
<a href="#l24.107"></a><span id="l24.107" class="difflineminus">-    let numMessages = this._msgURIs.length;</span>
<a href="#l24.108"></a><span id="l24.108" class="difflineplus">+    let numMessages = this._msgHdrs.length;</span>
<a href="#l24.109"></a><span id="l24.109">     let messagesTitle = PluralForm.get(numMessages, gSelectionSummaryStrings[&quot;NConversations&quot;]).replace('#1', numThreads);</span>
<a href="#l24.110"></a><span id="l24.110"> </span>
<a href="#l24.111"></a><span id="l24.111">     heading.innerHTML = messagesTitle;</span>
<a href="#l24.112"></a><span id="l24.112"> </span>
<a href="#l24.113"></a><span id="l24.113">     // clear the messages list</span>
<a href="#l24.114"></a><span id="l24.114">     let messagesElt = htmlpane.contentDocument.getElementById('messagelist');</span>
<a href="#l24.115"></a><span id="l24.115">     while (messagesElt.firstChild)</span>
<a href="#l24.116"></a><span id="l24.116">       messagesElt.removeChild(messagesElt.firstChild);</span>
<a href="#l24.117"></a><span id="l24.117" class="difflineat">@@ -259,17 +235,17 @@ MultiMessageSummary.prototype = {</span>
<a href="#l24.118"></a><span id="l24.118">       count += 1;</span>
<a href="#l24.119"></a><span id="l24.119">       if (count &gt; MAXCOUNT) {</span>
<a href="#l24.120"></a><span id="l24.120">         maxCountExceeded = true;</span>
<a href="#l24.121"></a><span id="l24.121">         break;</span>
<a href="#l24.122"></a><span id="l24.122">       }</span>
<a href="#l24.123"></a><span id="l24.123">       let countUnread = 0;</span>
<a href="#l24.124"></a><span id="l24.124">       let countStarred = 0;</span>
<a href="#l24.125"></a><span id="l24.125">       let header, countNode;</span>
<a href="#l24.126"></a><span id="l24.126" class="difflineminus">-      </span>
<a href="#l24.127"></a><span id="l24.127" class="difflineplus">+</span>
<a href="#l24.128"></a><span id="l24.128">       // we'll mark the thread unread if any messages in it are unread</span>
<a href="#l24.129"></a><span id="l24.129">       for (let [, msgHdr] in Iterator(msgs)) {</span>
<a href="#l24.130"></a><span id="l24.130">         if (! msgHdr.isRead)</span>
<a href="#l24.131"></a><span id="l24.131">           countUnread += 1;</span>
<a href="#l24.132"></a><span id="l24.132">         if (msgHdr.isFlagged)</span>
<a href="#l24.133"></a><span id="l24.133">           countStarred += 1;</span>
<a href="#l24.134"></a><span id="l24.134">       }</span>
<a href="#l24.135"></a><span id="l24.135"> </span>
<a href="#l24.136"></a><span id="l24.136" class="difflineat">@@ -324,17 +300,17 @@ MultiMessageSummary.prototype = {</span>
<a href="#l24.137"></a><span id="l24.137">         if (meta.author)</span>
<a href="#l24.138"></a><span id="l24.138">           authorNode.innerHTML = escapeXMLchars(meta.author);</span>
<a href="#l24.139"></a><span id="l24.139">       });</span>
<a href="#l24.140"></a><span id="l24.140"> </span>
<a href="#l24.141"></a><span id="l24.141">       // get the subject node.</span>
<a href="#l24.142"></a><span id="l24.142">       let subjectNode = msgNode.getElementsByClassName(&quot;subject&quot;)[0];</span>
<a href="#l24.143"></a><span id="l24.143">       subjectNode.msgs = msgs;</span>
<a href="#l24.144"></a><span id="l24.144">       subjectNode.addEventListener(&quot;click&quot;, function() {</span>
<a href="#l24.145"></a><span id="l24.145" class="difflineminus">-        selectMultipleMessagesByMsgHdr(this.msgs);</span>
<a href="#l24.146"></a><span id="l24.146" class="difflineplus">+        gFolderDisplay.selectMessages(this.msgs);</span>
<a href="#l24.147"></a><span id="l24.147">       }, true);</span>
<a href="#l24.148"></a><span id="l24.148"> </span>
<a href="#l24.149"></a><span id="l24.149">       let tagsNode = msgNode.getElementsByClassName(&quot;tags&quot;)[0];</span>
<a href="#l24.150"></a><span id="l24.150">       while (tagsNode.firstChild)</span>
<a href="#l24.151"></a><span id="l24.151">         tagsNode.removeChild(tagsNode.firstChild);</span>
<a href="#l24.152"></a><span id="l24.152">       this._addTagNodes(msgs, tagsNode);</span>
<a href="#l24.153"></a><span id="l24.153">       for each (msgHdr in msgs) {</span>
<a href="#l24.154"></a><span id="l24.154">         this._msgNodes[msgHdr.messageKey + msgHdr.folder.URI] = msgNode;</span>
<a href="#l24.155"></a><span id="l24.155" class="difflineat">@@ -388,17 +364,17 @@ MultiMessageSummary.prototype = {</span>
<a href="#l24.156"></a><span id="l24.156">     sizeText = replaceInsert(sizeText, 2, unit);</span>
<a href="#l24.157"></a><span id="l24.157">     htmlpane.contentDocument.getElementById('size').innerHTML = sizeText;</span>
<a href="#l24.158"></a><span id="l24.158">   },</span>
<a href="#l24.159"></a><span id="l24.159"> </span>
<a href="#l24.160"></a><span id="l24.160">   /** compute the size of the messages in the selection and display it</span>
<a href="#l24.161"></a><span id="l24.161">    * in the element of id &quot;size&quot;</span>
<a href="#l24.162"></a><span id="l24.162">   **/</span>
<a href="#l24.163"></a><span id="l24.163">   notifyMaxCountExceeded: function(numMessages, maxCount) {</span>
<a href="#l24.164"></a><span id="l24.164" class="difflineminus">-    let htmlpane = pickMessagePane('multimessage');</span>
<a href="#l24.165"></a><span id="l24.165" class="difflineplus">+    let htmlpane = document.getElementById('multimessage');</span>
<a href="#l24.166"></a><span id="l24.166">     let notice = htmlpane.contentDocument.getElementById('notice');</span>
<a href="#l24.167"></a><span id="l24.167">     if (numMessages &gt; maxCount)</span>
<a href="#l24.168"></a><span id="l24.168">     {</span>
<a href="#l24.169"></a><span id="l24.169">       let noticeText = gSelectionSummaryStrings.noticeText;</span>
<a href="#l24.170"></a><span id="l24.170">       noticeText = replaceInsert(noticeText, 1, numMessages);</span>
<a href="#l24.171"></a><span id="l24.171">       noticeText = replaceInsert(noticeText, 2, maxCount);</span>
<a href="#l24.172"></a><span id="l24.172">       notice.innerHTML = noticeText;</span>
<a href="#l24.173"></a><span id="l24.173">       _mm_removeClass(notice, 'hidden');</span>
<a href="#l24.174"></a><span id="l24.174" class="difflineat">@@ -436,24 +412,24 @@ MultiMessageSummary.prototype = {</span>
<a href="#l24.175"></a><span id="l24.175">       // thread (and hence DOM node), so we need to detect when we get the first</span>
<a href="#l24.176"></a><span id="l24.176">       // item for a particular DOM node, stash the preexisting status of that DOM</span>
<a href="#l24.177"></a><span id="l24.177">       // node, an only do transitions if the items warrant it.</span>
<a href="#l24.178"></a><span id="l24.178">       let headerNode = this._msgNodes[domkey];</span>
<a href="#l24.179"></a><span id="l24.179">       if (! headerNode.flags) {</span>
<a href="#l24.180"></a><span id="l24.180">         headerNode.flags = {};</span>
<a href="#l24.181"></a><span id="l24.181">         knownMessageNodes.push(headerNode);</span>
<a href="#l24.182"></a><span id="l24.182">       }</span>
<a href="#l24.183"></a><span id="l24.183" class="difflineminus">-      </span>
<a href="#l24.184"></a><span id="l24.184" class="difflineplus">+</span>
<a href="#l24.185"></a><span id="l24.185">       if (! glodaMsg.read)</span>
<a href="#l24.186"></a><span id="l24.186">         headerNode.flags['unread'] = true;</span>
<a href="#l24.187"></a><span id="l24.187">       if (glodaMsg.starred)</span>
<a href="#l24.188"></a><span id="l24.188">         headerNode.flags['starred'] = true;</span>
<a href="#l24.189"></a><span id="l24.189"> </span>
<a href="#l24.190"></a><span id="l24.190">       // for tags, there's a minor problem in that if _some_ of the items in a</span>
<a href="#l24.191"></a><span id="l24.191" class="difflineminus">-      // thread got modified </span>
<a href="#l24.192"></a><span id="l24.192" class="difflineplus">+      // thread got modified</span>
<a href="#l24.193"></a><span id="l24.193">       let key = messageKey + glodaMsg.folder.uri;</span>
<a href="#l24.194"></a><span id="l24.194">       let tagsNode = headerNode.getElementsByClassName('tags')[0];</span>
<a href="#l24.195"></a><span id="l24.195">       while (tagsNode.firstChild)</span>
<a href="#l24.196"></a><span id="l24.196">         tagsNode.removeChild(tagsNode.firstChild);</span>
<a href="#l24.197"></a><span id="l24.197">       this._addTagNodes([msg.folderMessage for each ([i,msg] in Iterator(aItems))],</span>
<a href="#l24.198"></a><span id="l24.198">                         tagsNode);</span>
<a href="#l24.199"></a><span id="l24.199">     }</span>
<a href="#l24.200"></a><span id="l24.200"> </span>
<a href="#l24.201"></a><span id="l24.201" class="difflineat">@@ -468,17 +444,17 @@ MultiMessageSummary.prototype = {</span>
<a href="#l24.202"></a><span id="l24.202">         _mm_removeClass(headerNode, &quot;starred&quot;);</span>
<a href="#l24.203"></a><span id="l24.203">       headerNode.flags = null;</span>
<a href="#l24.204"></a><span id="l24.204">     }</span>
<a href="#l24.205"></a><span id="l24.205">   },</span>
<a href="#l24.206"></a><span id="l24.206"> </span>
<a href="#l24.207"></a><span id="l24.207">   onQueryCompleted: function(aCollection) {</span>
<a href="#l24.208"></a><span id="l24.208">     /* if we need something that's just available from GlodaMessages,</span>
<a href="#l24.209"></a><span id="l24.209">       this is where we'll get it initially */</span>
<a href="#l24.210"></a><span id="l24.210" class="difflineminus">-    return; </span>
<a href="#l24.211"></a><span id="l24.211" class="difflineplus">+    return;</span>
<a href="#l24.212"></a><span id="l24.212">   }</span>
<a href="#l24.213"></a><span id="l24.213"> }</span>
<a href="#l24.214"></a><span id="l24.214"> </span>
<a href="#l24.215"></a><span id="l24.215"> </span>
<a href="#l24.216"></a><span id="l24.216"> /**</span>
<a href="#l24.217"></a><span id="l24.217">  * the ThreadSummary class is responsible for populating the message pane</span>
<a href="#l24.218"></a><span id="l24.218">  * with a reasonable summary of a set of messages that are are in a single</span>
<a href="#l24.219"></a><span id="l24.219">  * thread.</span>
<a href="#l24.220"></a><span id="l24.220" class="difflineat">@@ -486,60 +462,58 @@ MultiMessageSummary.prototype = {</span>
<a href="#l24.221"></a><span id="l24.221">  * It uses the same multimessage iframe as MultiMessageSummary, so both it</span>
<a href="#l24.222"></a><span id="l24.222">  * and MultiMessageSummary should be careful to clean up the other's work</span>
<a href="#l24.223"></a><span id="l24.223">  * before inserting their DOM nodes into the frame.</span>
<a href="#l24.224"></a><span id="l24.224">  *</span>
<a href="#l24.225"></a><span id="l24.225">  * There's a two phase process: build the framework based on what's available</span>
<a href="#l24.226"></a><span id="l24.226">  * from the msgHdr itself, and then spawn an aysnc Gloda query which will</span>
<a href="#l24.227"></a><span id="l24.227">  * fetch the snippets, tags, etc.</span>
<a href="#l24.228"></a><span id="l24.228">  *</span>
<a href="#l24.229"></a><span id="l24.229" class="difflineminus">- * @param msgURIs</span>
<a href="#l24.230"></a><span id="l24.230" class="difflineminus">- *        array of message URIs</span>
<a href="#l24.231"></a><span id="l24.231" class="difflineplus">+ * @param messages</span>
<a href="#l24.232"></a><span id="l24.232" class="difflineplus">+ *        array of message headers</span>
<a href="#l24.233"></a><span id="l24.233">  */</span>
<a href="#l24.234"></a><span id="l24.234"> </span>
<a href="#l24.235"></a><span id="l24.235" class="difflineminus">-function ThreadSummary(msgURIs)</span>
<a href="#l24.236"></a><span id="l24.236" class="difflineplus">+function ThreadSummary(messages)</span>
<a href="#l24.237"></a><span id="l24.237"> {</span>
<a href="#l24.238"></a><span id="l24.238" class="difflineminus">-  this._msgURIs = msgURIs;</span>
<a href="#l24.239"></a><span id="l24.239" class="difflineplus">+  this._msgHdrs = messages;</span>
<a href="#l24.240"></a><span id="l24.240"> }</span>
<a href="#l24.241"></a><span id="l24.241"> </span>
<a href="#l24.242"></a><span id="l24.242"> ThreadSummary.prototype = {</span>
<a href="#l24.243"></a><span id="l24.243">   __proto__: MultiMessageSummary.prototype,</span>
<a href="#l24.244"></a><span id="l24.244"> </span>
<a href="#l24.245"></a><span id="l24.245">   summarize: function() {</span>
<a href="#l24.246"></a><span id="l24.246">     this._msgNodes = {};</span>
<a href="#l24.247"></a><span id="l24.247"> </span>
<a href="#l24.248"></a><span id="l24.248" class="difflineminus">-    let htmlpane = pickMessagePane('multimessage');</span>
<a href="#l24.249"></a><span id="l24.249" class="difflineplus">+    let htmlpane = document.getElementById('multimessage');</span>
<a href="#l24.250"></a><span id="l24.250"> </span>
<a href="#l24.251"></a><span id="l24.251" class="difflineminus">-    let firstMsgHdr = messenger.msgHdrFromURI(this._msgURIs[0]);</span>
<a href="#l24.252"></a><span id="l24.252" class="difflineminus">-    let numMessages = this._msgURIs.length;</span>
<a href="#l24.253"></a><span id="l24.253" class="difflineplus">+    let firstMsgHdr = this._msgHdrs[0];</span>
<a href="#l24.254"></a><span id="l24.254" class="difflineplus">+    let numMessages = this._msgHdrs.length;</span>
<a href="#l24.255"></a><span id="l24.255">     let subject = (firstMsgHdr.mime2DecodedSubject || gSelectionSummaryStrings[&quot;noSubject&quot;])</span>
<a href="#l24.256"></a><span id="l24.256">        + &quot; &quot;</span>
<a href="#l24.257"></a><span id="l24.257">        + PluralForm.get(numMessages, gSelectionSummaryStrings[&quot;Nmessages&quot;]).replace('#1', numMessages);</span>
<a href="#l24.258"></a><span id="l24.258">     let heading = htmlpane.contentDocument.getElementById('heading');</span>
<a href="#l24.259"></a><span id="l24.259">     heading.setAttribute(&quot;class&quot;, &quot;heading&quot;);</span>
<a href="#l24.260"></a><span id="l24.260">     heading.innerHTML = escapeXMLchars(subject);</span>
<a href="#l24.261"></a><span id="l24.261"> </span>
<a href="#l24.262"></a><span id="l24.262">     let messagesElt = htmlpane.contentDocument.getElementById('messagelist');</span>
<a href="#l24.263"></a><span id="l24.263">     while (messagesElt.firstChild)</span>
<a href="#l24.264"></a><span id="l24.264">       messagesElt.removeChild(messagesElt.firstChild);</span>
<a href="#l24.265"></a><span id="l24.265"> </span>
<a href="#l24.266"></a><span id="l24.266">     let headerParser = Components.classes[&quot;@mozilla.org/messenger/headerparser;1&quot;]</span>
<a href="#l24.267"></a><span id="l24.267">                                     .getService(Components.interfaces.nsIMsgHeaderParser);</span>
<a href="#l24.268"></a><span id="l24.268" class="difflineminus">-    let msgHdrs = new Array();</span>
<a href="#l24.269"></a><span id="l24.269">     let count = 0;</span>
<a href="#l24.270"></a><span id="l24.270">     const MAXCOUNT = 100;</span>
<a href="#l24.271"></a><span id="l24.271">     let maxCountExceeded = false;</span>
<a href="#l24.272"></a><span id="l24.272" class="difflineminus">-    for (let i = 0; i &lt; this._msgURIs.length; ++i) {</span>
<a href="#l24.273"></a><span id="l24.273" class="difflineplus">+    for (let i = 0; i &lt; numMessages; ++i) {</span>
<a href="#l24.274"></a><span id="l24.274">       count += 1;</span>
<a href="#l24.275"></a><span id="l24.275">       if (count &gt; MAXCOUNT) {</span>
<a href="#l24.276"></a><span id="l24.276">         maxCountExceeded = true;</span>
<a href="#l24.277"></a><span id="l24.277">         break;</span>
<a href="#l24.278"></a><span id="l24.278">       }</span>
<a href="#l24.279"></a><span id="l24.279" class="difflineminus">-      let msgHdr = messenger.msgHdrFromURI(this._msgURIs[i]);</span>
<a href="#l24.280"></a><span id="l24.280" class="difflineminus">-      msgHdrs.push(msgHdr);</span>
<a href="#l24.281"></a><span id="l24.281" class="difflineplus">+      let msgHdr = this._msgHdrs[i];</span>
<a href="#l24.282"></a><span id="l24.282"> </span>
<a href="#l24.283"></a><span id="l24.283">       let msg_classes = &quot;message &quot;;</span>
<a href="#l24.284"></a><span id="l24.284">       if (! msgHdr.isRead)</span>
<a href="#l24.285"></a><span id="l24.285">         msg_classes += &quot; unread&quot;;</span>
<a href="#l24.286"></a><span id="l24.286">       if (msgHdr.isFlagged)</span>
<a href="#l24.287"></a><span id="l24.287">         msg_classes += &quot; starred&quot;;</span>
<a href="#l24.288"></a><span id="l24.288"> </span>
<a href="#l24.289"></a><span id="l24.289">       let senderName = headerParser.extractHeaderAddressName(msgHdr.mime2DecodedAuthor);</span>
<a href="#l24.290"></a><span id="l24.290" class="difflineat">@@ -580,17 +554,17 @@ ThreadSummary.prototype = {</span>
<a href="#l24.291"></a><span id="l24.291">       for each (let [,tag] in Iterator(tags)) {</span>
<a href="#l24.292"></a><span id="l24.292">         let tagNode = tagsNode.ownerDocument.createElement('span');</span>
<a href="#l24.293"></a><span id="l24.293">         // see tagColors.css</span>
<a href="#l24.294"></a><span id="l24.294">         let colorClass = &quot;blc-&quot; + this._msgTagService.getColorForKey(tag.key).substr(1);</span>
<a href="#l24.295"></a><span id="l24.295">         _mm_addClass(tagNode, &quot;tag &quot; + tag.tag + &quot; &quot; + colorClass);</span>
<a href="#l24.296"></a><span id="l24.296">         tagNode.innerHTML = tag.tag;</span>
<a href="#l24.297"></a><span id="l24.297">         tagsNode.appendChild(tagNode);</span>
<a href="#l24.298"></a><span id="l24.298">       }</span>
<a href="#l24.299"></a><span id="l24.299" class="difflineminus">-      </span>
<a href="#l24.300"></a><span id="l24.300" class="difflineplus">+</span>
<a href="#l24.301"></a><span id="l24.301">       let sender = msgNode.getElementsByClassName(&quot;sender&quot;)[0];</span>
<a href="#l24.302"></a><span id="l24.302">       sender.msgHdr = msgHdr;</span>
<a href="#l24.303"></a><span id="l24.303">       sender.addEventListener(&quot;click&quot;, function(e) {</span>
<a href="#l24.304"></a><span id="l24.304">         // if the msg is the first message in a collapsed thread, we need to</span>
<a href="#l24.305"></a><span id="l24.305">         // uncollapse it.</span>
<a href="#l24.306"></a><span id="l24.306">         let origRowCount = gDBView.rowCount;</span>
<a href="#l24.307"></a><span id="l24.307">         let viewIndex = gDBView.findIndexOfMsgHdr(e.target.msgHdr, true);</span>
<a href="#l24.308"></a><span id="l24.308">         gDBView.selectFolderMsgByKey(this.folder, this.msgKey);</span>
<a href="#l24.309"></a><span id="l24.309" class="difflineat">@@ -599,93 +573,64 @@ ThreadSummary.prototype = {</span>
<a href="#l24.310"></a><span id="l24.310">       }, true);</span>
<a href="#l24.311"></a><span id="l24.311">       sender.folder = msgHdr.folder;</span>
<a href="#l24.312"></a><span id="l24.312">       sender.msgKey = msgHdr.messageKey;</span>
<a href="#l24.313"></a><span id="l24.313"> </span>
<a href="#l24.314"></a><span id="l24.314">       this._msgNodes[key] = msgNode;</span>
<a href="#l24.315"></a><span id="l24.315"> </span>
<a href="#l24.316"></a><span id="l24.316">       messagesElt.appendChild(msgNode);</span>
<a href="#l24.317"></a><span id="l24.317">     }</span>
<a href="#l24.318"></a><span id="l24.318" class="difflineminus">-    </span>
<a href="#l24.319"></a><span id="l24.319" class="difflineplus">+</span>
<a href="#l24.320"></a><span id="l24.320">     // stash somewhere so it doesn't get GC'ed</span>
<a href="#l24.321"></a><span id="l24.321" class="difflineminus">-    this._glodaQueries.push(Gloda.getMessageCollectionForHeaders(msgHdrs, this));</span>
<a href="#l24.322"></a><span id="l24.322" class="difflineplus">+    this._glodaQueries.push(Gloda.getMessageCollectionForHeaders(this._msgHdrs, this));</span>
<a href="#l24.323"></a><span id="l24.323">     this.notifyMaxCountExceeded(numMessages, MAXCOUNT);</span>
<a href="#l24.324"></a><span id="l24.324"> </span>
<a href="#l24.325"></a><span id="l24.325">     this.computeSize(htmlpane);</span>
<a href="#l24.326"></a><span id="l24.326">   }</span>
<a href="#l24.327"></a><span id="l24.327" class="difflineminus">-}</span>
<a href="#l24.328"></a><span id="l24.328" class="difflineplus">+};</span>
<a href="#l24.329"></a><span id="l24.329"> </span>
<a href="#l24.330"></a><span id="l24.330"> // We use a global to prevent GC of gloda collection (and we reuse it to prevent</span>
<a href="#l24.331"></a><span id="l24.331"> // leaks).  Without a global, the GC is aggressive enough that the gloda query</span>
<a href="#l24.332"></a><span id="l24.332"> // is gone before it returns.</span>
<a href="#l24.333"></a><span id="l24.333"> var gSummary;</span>
<a href="#l24.334"></a><span id="l24.334"> </span>
<a href="#l24.335"></a><span id="l24.335"> </span>
<a href="#l24.336"></a><span id="l24.336"> /**</span>
<a href="#l24.337"></a><span id="l24.337" class="difflineminus">- * Given an array of message URIs which are all in the</span>
<a href="#l24.338"></a><span id="l24.338" class="difflineplus">+ * Given an array of messages which are all in the</span>
<a href="#l24.339"></a><span id="l24.339">  * same thread, summarize them.</span>
<a href="#l24.340"></a><span id="l24.340">  *</span>
<a href="#l24.341"></a><span id="l24.341" class="difflineminus">- * @param selectedMsgUris</span>
<a href="#l24.342"></a><span id="l24.342" class="difflineminus">- *        array of message URIs</span>
<a href="#l24.343"></a><span id="l24.343" class="difflineplus">+ * @param aSelectedMessages</span>
<a href="#l24.344"></a><span id="l24.344" class="difflineplus">+ *        array of message headers</span>
<a href="#l24.345"></a><span id="l24.345">  */</span>
<a href="#l24.346"></a><span id="l24.346" class="difflineminus">-function summarizeThread(selectedMsgUris)</span>
<a href="#l24.347"></a><span id="l24.347" class="difflineplus">+function summarizeThread(aSelectedMessages)</span>
<a href="#l24.348"></a><span id="l24.348"> {</span>
<a href="#l24.349"></a><span id="l24.349" class="difflineminus">-  if (selectedMsgUris.length == 0)</span>
<a href="#l24.350"></a><span id="l24.350" class="difflineplus">+  if (aSelectedMessages.length == 0)</span>
<a href="#l24.351"></a><span id="l24.351">     return;</span>
<a href="#l24.352"></a><span id="l24.352"> </span>
<a href="#l24.353"></a><span id="l24.353" class="difflineminus">-  gSummary = new ThreadSummary(selectedMsgUris);</span>
<a href="#l24.354"></a><span id="l24.354" class="difflineplus">+  gSummary = new ThreadSummary(aSelectedMessages);</span>
<a href="#l24.355"></a><span id="l24.355">   gSummary.init();</span>
<a href="#l24.356"></a><span id="l24.356"> }</span>
<a href="#l24.357"></a><span id="l24.357"> </span>
<a href="#l24.358"></a><span id="l24.358"> /**</span>
<a href="#l24.359"></a><span id="l24.359">  * Given an array of message URIs, cause the message pane</span>
<a href="#l24.360"></a><span id="l24.360">  * to display a summary of them.</span>
<a href="#l24.361"></a><span id="l24.361">  *</span>
<a href="#l24.362"></a><span id="l24.362" class="difflineminus">- * @param selectedMsgUris</span>
<a href="#l24.363"></a><span id="l24.363" class="difflineminus">- *        array of message URIs</span>
<a href="#l24.364"></a><span id="l24.364" class="difflineplus">+ * @param aSelectedMessages</span>
<a href="#l24.365"></a><span id="l24.365" class="difflineplus">+ *        array of message headers</span>
<a href="#l24.366"></a><span id="l24.366">  */</span>
<a href="#l24.367"></a><span id="l24.367" class="difflineminus">-function summarizeMultipleSelection(selectedMsgUris)</span>
<a href="#l24.368"></a><span id="l24.368" class="difflineplus">+function summarizeMultipleSelection(aSelectedMessages)</span>
<a href="#l24.369"></a><span id="l24.369"> {</span>
<a href="#l24.370"></a><span id="l24.370" class="difflineminus">-  if (selectedMsgUris.length == 0)</span>
<a href="#l24.371"></a><span id="l24.371" class="difflineplus">+  if (aSelectedMessages.length == 0)</span>
<a href="#l24.372"></a><span id="l24.372">     return;</span>
<a href="#l24.373"></a><span id="l24.373"> </span>
<a href="#l24.374"></a><span id="l24.374" class="difflineminus">-  gSummary = new MultiMessageSummary(selectedMsgUris);</span>
<a href="#l24.375"></a><span id="l24.375" class="difflineplus">+  gSummary = new MultiMessageSummary(aSelectedMessages);</span>
<a href="#l24.376"></a><span id="l24.376">   gSummary.init();</span>
<a href="#l24.377"></a><span id="l24.377"> }</span>
<a href="#l24.378"></a><span id="l24.378"> </span>
<a href="#l24.379"></a><span id="l24.379"> /**</span>
<a href="#l24.380"></a><span id="l24.380" class="difflineminus">- * Given an array of nsMsgHdrs, select all of them.  This will uncollapse</span>
<a href="#l24.381"></a><span id="l24.381" class="difflineminus">- * threads that are collapsed as necessary.</span>
<a href="#l24.382"></a><span id="l24.382" class="difflineminus">- *</span>
<a href="#l24.383"></a><span id="l24.383" class="difflineminus">- * @param msgHdrs</span>
<a href="#l24.384"></a><span id="l24.384" class="difflineminus">- *        array of msgHdr's</span>
<a href="#l24.385"></a><span id="l24.385" class="difflineminus">- */</span>
<a href="#l24.386"></a><span id="l24.386" class="difflineminus">-function selectMultipleMessagesByMsgHdr(msgHdrs)</span>
<a href="#l24.387"></a><span id="l24.387" class="difflineminus">-{</span>
<a href="#l24.388"></a><span id="l24.388" class="difflineminus">-  let treeView = gDBView.QueryInterface(Components.interfaces.nsITreeView);</span>
<a href="#l24.389"></a><span id="l24.389" class="difflineminus">-  if (msgHdrs.length == 1) {</span>
<a href="#l24.390"></a><span id="l24.390" class="difflineminus">-    gDBView.selectFolderMsgByKey(msgHdrs[0].folder, msgHdrs[0].messageKey);</span>
<a href="#l24.391"></a><span id="l24.391" class="difflineminus">-  } else {</span>
<a href="#l24.392"></a><span id="l24.392" class="difflineminus">-    let treeSelection = treeView.selection;</span>
<a href="#l24.393"></a><span id="l24.393" class="difflineminus">-    treeSelection.clearSelection();</span>
<a href="#l24.394"></a><span id="l24.394" class="difflineminus">-    for (let [, msgHdr] in Iterator(msgHdrs))</span>
<a href="#l24.395"></a><span id="l24.395" class="difflineminus">-    {</span>
<a href="#l24.396"></a><span id="l24.396" class="difflineminus">-      let viewIndex = gDBView.findIndexOfMsgHdr(msgHdr, false);</span>
<a href="#l24.397"></a><span id="l24.397" class="difflineminus">-      let thread = gDBView.getThreadContainingIndex(viewIndex);</span>
<a href="#l24.398"></a><span id="l24.398" class="difflineminus">-      let flags = gDBView.getFlagsAt(viewIndex);</span>
<a href="#l24.399"></a><span id="l24.399" class="difflineminus">-</span>
<a href="#l24.400"></a><span id="l24.400" class="difflineminus">-      if (flags &amp; Components.interfaces.nsMsgMessageFlags.Elided)</span>
<a href="#l24.401"></a><span id="l24.401" class="difflineminus">-        treeView.toggleOpenState(viewIndex);</span>
<a href="#l24.402"></a><span id="l24.402" class="difflineminus">-</span>
<a href="#l24.403"></a><span id="l24.403" class="difflineminus">-      treeSelection.rangedSelect(viewIndex, viewIndex, true);</span>
<a href="#l24.404"></a><span id="l24.404" class="difflineminus">-    }</span>
<a href="#l24.405"></a><span id="l24.405" class="difflineminus">-  }</span>
<a href="#l24.406"></a><span id="l24.406" class="difflineminus">-}</span>
<a href="#l24.407"></a><span id="l24.407" class="difflineminus">-</span>
<a href="#l24.408"></a><span id="l24.408" class="difflineminus">-/**</span>
<a href="#l24.409"></a><span id="l24.409">  * Helper function to generate a localized &quot;friendly&quot; representation of</span>
<a href="#l24.410"></a><span id="l24.410">  * time relative to the present.  If the time input is &quot;today&quot;, it returns</span>
<a href="#l24.411"></a><span id="l24.411">  * a string corresponding to just the time.  If it's yesterday, it returns</span>
<a href="#l24.412"></a><span id="l24.412">  * &quot;yesterday&quot; (localized).  If it's in the last week, it returns the day</span>
<a href="#l24.413"></a><span id="l24.413">  * of the week. If it's before that, it returns the date.</span>
<a href="#l24.414"></a><span id="l24.414">  *</span>
<a href="#l24.415"></a><span id="l24.415">  * @param time</span>
<a href="#l24.416"></a><span id="l24.416">  *        the time (better be in the past!)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mail/base/content/tabmail.xml</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mail/base/content/tabmail.xml</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -1,46 +1,46 @@</span>
<a href="#l25.4"></a><span id="l25.4"> &lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l25.5"></a><span id="l25.5" class="difflineminus">-# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l25.6"></a><span id="l25.6" class="difflineminus">-# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l25.7"></a><span id="l25.7" class="difflineminus">-#</span>
<a href="#l25.8"></a><span id="l25.8" class="difflineminus">-# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l25.9"></a><span id="l25.9" class="difflineminus">-# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l25.10"></a><span id="l25.10" class="difflineminus">-# the License. You may obtain a copy of the License at</span>
<a href="#l25.11"></a><span id="l25.11" class="difflineminus">-# http://www.mozilla.org/MPL/</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-#</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineminus">-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineminus">-# for the specific language governing rights and limitations under the</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineminus">-# License.</span>
<a href="#l25.17"></a><span id="l25.17" class="difflineminus">-#</span>
<a href="#l25.18"></a><span id="l25.18" class="difflineminus">-# The Original Code is tab email</span>
<a href="#l25.19"></a><span id="l25.19" class="difflineminus">-#</span>
<a href="#l25.20"></a><span id="l25.20" class="difflineminus">-# The Initial Developer of the Original Code is</span>
<a href="#l25.21"></a><span id="l25.21" class="difflineminus">-#   David Bienvenu &lt;bienvenu@nventure.com&gt;.</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineminus">-# Portions created by the Initial Developer are Copyright (C) 2007</span>
<a href="#l25.23"></a><span id="l25.23" class="difflineminus">-# the Initial Developer. All Rights Reserved.</span>
<a href="#l25.24"></a><span id="l25.24" class="difflineminus">-#</span>
<a href="#l25.25"></a><span id="l25.25" class="difflineminus">-# Contributor(s):</span>
<a href="#l25.26"></a><span id="l25.26" class="difflineminus">-#  Scott MacGregor &lt;mscott@mozilla.org&gt;</span>
<a href="#l25.27"></a><span id="l25.27" class="difflineminus">-#  Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l25.28"></a><span id="l25.28" class="difflineminus">-#</span>
<a href="#l25.29"></a><span id="l25.29" class="difflineminus">-# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l25.30"></a><span id="l25.30" class="difflineminus">-# either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineminus">-# the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineminus">-# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l25.33"></a><span id="l25.33" class="difflineminus">-# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l25.34"></a><span id="l25.34" class="difflineminus">-# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l25.35"></a><span id="l25.35" class="difflineminus">-# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l25.36"></a><span id="l25.36" class="difflineminus">-# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l25.37"></a><span id="l25.37" class="difflineminus">-# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l25.38"></a><span id="l25.38" class="difflineminus">-# the provisions above, a recipient may use your version of this file under</span>
<a href="#l25.39"></a><span id="l25.39" class="difflineminus">-# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l25.40"></a><span id="l25.40" class="difflineminus">-#</span>
<a href="#l25.41"></a><span id="l25.41" class="difflineminus">-# ***** END LICENSE BLOCK *****</span>
<a href="#l25.42"></a><span id="l25.42" class="difflineplus">+&lt;!-- ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l25.43"></a><span id="l25.43" class="difflineplus">+  - Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l25.44"></a><span id="l25.44" class="difflineplus">+  -</span>
<a href="#l25.45"></a><span id="l25.45" class="difflineplus">+  - The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l25.46"></a><span id="l25.46" class="difflineplus">+  - 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l25.47"></a><span id="l25.47" class="difflineplus">+  - the License. You may obtain a copy of the License at</span>
<a href="#l25.48"></a><span id="l25.48" class="difflineplus">+  - http://www.mozilla.org/MPL/</span>
<a href="#l25.49"></a><span id="l25.49" class="difflineplus">+  -</span>
<a href="#l25.50"></a><span id="l25.50" class="difflineplus">+  - Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l25.51"></a><span id="l25.51" class="difflineplus">+  - WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l25.52"></a><span id="l25.52" class="difflineplus">+  - for the specific language governing rights and limitations under the</span>
<a href="#l25.53"></a><span id="l25.53" class="difflineplus">+  - License.</span>
<a href="#l25.54"></a><span id="l25.54" class="difflineplus">+  -</span>
<a href="#l25.55"></a><span id="l25.55" class="difflineplus">+  - The Original Code is tab email</span>
<a href="#l25.56"></a><span id="l25.56" class="difflineplus">+  -</span>
<a href="#l25.57"></a><span id="l25.57" class="difflineplus">+  - The Initial Developer of the Original Code is</span>
<a href="#l25.58"></a><span id="l25.58" class="difflineplus">+  -   David Bienvenu &lt;bienvenu@nventure.com&gt;.</span>
<a href="#l25.59"></a><span id="l25.59" class="difflineplus">+  - Portions created by the Initial Developer are Copyright (C) 2007</span>
<a href="#l25.60"></a><span id="l25.60" class="difflineplus">+  - the Initial Developer. All Rights Reserved.</span>
<a href="#l25.61"></a><span id="l25.61" class="difflineplus">+  -</span>
<a href="#l25.62"></a><span id="l25.62" class="difflineplus">+  - Contributor(s):</span>
<a href="#l25.63"></a><span id="l25.63" class="difflineplus">+  -  Scott MacGregor &lt;mscott@mozilla.org&gt;</span>
<a href="#l25.64"></a><span id="l25.64" class="difflineplus">+  -  Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l25.65"></a><span id="l25.65" class="difflineplus">+  -</span>
<a href="#l25.66"></a><span id="l25.66" class="difflineplus">+  - Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l25.67"></a><span id="l25.67" class="difflineplus">+  - either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l25.68"></a><span id="l25.68" class="difflineplus">+  - the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l25.69"></a><span id="l25.69" class="difflineplus">+  - in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l25.70"></a><span id="l25.70" class="difflineplus">+  - of those above. If you wish to allow use of your version of this file only</span>
<a href="#l25.71"></a><span id="l25.71" class="difflineplus">+  - under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l25.72"></a><span id="l25.72" class="difflineplus">+  - use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l25.73"></a><span id="l25.73" class="difflineplus">+  - decision by deleting the provisions above and replace them with the notice</span>
<a href="#l25.74"></a><span id="l25.74" class="difflineplus">+  - and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l25.75"></a><span id="l25.75" class="difflineplus">+  - the provisions above, a recipient may use your version of this file under</span>
<a href="#l25.76"></a><span id="l25.76" class="difflineplus">+  - the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l25.77"></a><span id="l25.77" class="difflineplus">+  -</span>
<a href="#l25.78"></a><span id="l25.78" class="difflineplus">+  - ***** END LICENSE BLOCK ***** --&gt;</span>
<a href="#l25.79"></a><span id="l25.79"> </span>
<a href="#l25.80"></a><span id="l25.80"> &lt;!DOCTYPE bindings [</span>
<a href="#l25.81"></a><span id="l25.81"> &lt;!ENTITY % messengerDTD SYSTEM &quot;chrome://messenger/locale/messenger.dtd&quot; &gt;</span>
<a href="#l25.82"></a><span id="l25.82"> %messengerDTD;</span>
<a href="#l25.83"></a><span id="l25.83"> &lt;!ENTITY % tabMailDTD SYSTEM &quot;chrome://messenger/locale/tabmail.dtd&quot; &gt;</span>
<a href="#l25.84"></a><span id="l25.84">  %tabMailDTD;</span>
<a href="#l25.85"></a><span id="l25.85">  &lt;!ENTITY % globalDTD SYSTEM &quot;chrome://global/locale/global.dtd&quot;&gt;</span>
<a href="#l25.86"></a><span id="l25.86">  %globalDTD;</span>
<a href="#l25.87"></a><span id="l25.87" class="difflineat">@@ -71,28 +71,52 @@</span>
<a href="#l25.88"></a><span id="l25.88">     - 1) Code that wants to open new tabs.</span>
<a href="#l25.89"></a><span id="l25.89">     - 2) Code that wants to contribute one or more varieties of tabs.</span>
<a href="#l25.90"></a><span id="l25.90">     - 3) Code that wants to monitor to know when the active tab changes.</span>
<a href="#l25.91"></a><span id="l25.91">     -</span>
<a href="#l25.92"></a><span id="l25.92">     - Consumer code should use the following methods:</span>
<a href="#l25.93"></a><span id="l25.93">     - * openTab(aTabModeName, arguments...): Open a tab of the given &quot;mode&quot;,</span>
<a href="#l25.94"></a><span id="l25.94">     -   passing the provided arguments.  The tab type author should tell you</span>
<a href="#l25.95"></a><span id="l25.95">     -   the modes they implement and the required/optional arguments.</span>
<a href="#l25.96"></a><span id="l25.96" class="difflineplus">+    - * closeTab(aOptionalTabIndexInfoOrTabNode): If no argument is provided,</span>
<a href="#l25.97"></a><span id="l25.97" class="difflineplus">+    -   the current tab is closed.  If an argument is provided, it can be</span>
<a href="#l25.98"></a><span id="l25.98" class="difflineplus">+    -   a tab index, a tab info object, or the tabmail-tab bound element</span>
<a href="#l25.99"></a><span id="l25.99" class="difflineplus">+    -   that _is_ the tab.  Some tabs cannot be closed, in which case this</span>
<a href="#l25.100"></a><span id="l25.100" class="difflineplus">+    -   will do nothing.</span>
<a href="#l25.101"></a><span id="l25.101" class="difflineplus">+    - * switchToTab(aTabIndexInfoOrTabNode): Switch to the tab by providing</span>
<a href="#l25.102"></a><span id="l25.102" class="difflineplus">+    -   a tab index, tab info object, or tab node (tabmail-tab bound</span>
<a href="#l25.103"></a><span id="l25.103" class="difflineplus">+    -   element.)  You can also just poke at tabmail.tabContainer and its</span>
<a href="#l25.104"></a><span id="l25.104" class="difflineplus">+    -   selectedIndex and selectedItem properties.</span>
<a href="#l25.105"></a><span id="l25.105" class="difflineplus">+    - Less-friendly consumer methods:</span>
<a href="#l25.106"></a><span id="l25.106" class="difflineplus">+    - * removeCurrentTab(): Close the current tab.</span>
<a href="#l25.107"></a><span id="l25.107" class="difflineplus">+    - * removeTabByNode(aTabElement): Close the tab whose tabmail-tab bound</span>
<a href="#l25.108"></a><span id="l25.108" class="difflineplus">+    -   element is passed in.</span>
<a href="#l25.109"></a><span id="l25.109" class="difflineplus">+    - Changing the currently displayed tab is accomplished by changing</span>
<a href="#l25.110"></a><span id="l25.110" class="difflineplus">+    -  tabmail.tabContainer's selectedIndex or selectedItem property.</span>
<a href="#l25.111"></a><span id="l25.111" class="difflineplus">+    -</span>
<a href="#l25.112"></a><span id="l25.112" class="difflineplus">+    - Code that lives in a tab should use the following methods:</span>
<a href="#l25.113"></a><span id="l25.113">     - * setTabTitle([aOptionalTabInfo]): Tells us that the title of the current</span>
<a href="#l25.114"></a><span id="l25.114">     -   tab (if no argument is provided) or provided tab needs to be updated.</span>
<a href="#l25.115"></a><span id="l25.115">     -   This will result in a call to the tab mode's logic to update the title.</span>
<a href="#l25.116"></a><span id="l25.116">     -   In the event this is not for the current tab, the caller is responsible</span>
<a href="#l25.117"></a><span id="l25.117">     -   for ensuring that the underlying tab mode is capable of providing a tab</span>
<a href="#l25.118"></a><span id="l25.118">     -   title when it is in the background.  (The is currently not the case for</span>
<a href="#l25.119"></a><span id="l25.119">     -   &quot;folder&quot; and &quot;mail&quot; modes because of their implementation.)</span>
<a href="#l25.120"></a><span id="l25.120" class="difflineminus">-    - * removeCurrentTab(): Close the current tab.</span>
<a href="#l25.121"></a><span id="l25.121" class="difflineminus">-    - * removeTabByNode(aTabElement): Close the tab whose tabmail-tab bound</span>
<a href="#l25.122"></a><span id="l25.122" class="difflineminus">-    -   element is passed in.</span>
<a href="#l25.123"></a><span id="l25.123" class="difflineminus">-    - Changing the currently displayed tab is accomplished by changing</span>
<a href="#l25.124"></a><span id="l25.124" class="difflineminus">-    -  tabmail.tabContainer's selectedIndex or selectedItem property.</span>
<a href="#l25.125"></a><span id="l25.125" class="difflineplus">+    - * setTabBusy(aTabNode, aBusyState): Tells us that the tab in question</span>
<a href="#l25.126"></a><span id="l25.126" class="difflineplus">+    -   is now busy or not busy.  &quot;Busy&quot; means that it is occupied and</span>
<a href="#l25.127"></a><span id="l25.127" class="difflineplus">+    -   will not be able to respond to you until it is no longer busy.</span>
<a href="#l25.128"></a><span id="l25.128" class="difflineplus">+    -   This impacts the cursor display, as well as potentially</span>
<a href="#l25.129"></a><span id="l25.129" class="difflineplus">+    -   providing tab display hints.</span>
<a href="#l25.130"></a><span id="l25.130" class="difflineplus">+    - * setTabThinking(aTabNode, aThinkingState): Tells us that the</span>
<a href="#l25.131"></a><span id="l25.131" class="difflineplus">+    -   tab in question is now thinking or not thinking.  &quot;Thinking&quot; means</span>
<a href="#l25.132"></a><span id="l25.132" class="difflineplus">+    -   that the tab is involved in some ongoing process but you can still</span>
<a href="#l25.133"></a><span id="l25.133" class="difflineplus">+    -   interact with the tab while it is thinking.  A search would be an</span>
<a href="#l25.134"></a><span id="l25.134" class="difflineplus">+    -   example of thinking.  This impacts spinny-thing feedback as well as</span>
<a href="#l25.135"></a><span id="l25.135" class="difflineplus">+    -   potential providing tab display hints.  aThinkingState may be a</span>
<a href="#l25.136"></a><span id="l25.136" class="difflineplus">+    -   boolean or a localized string explaining what you are thinking about.</span>
<a href="#l25.137"></a><span id="l25.137">     -</span>
<a href="#l25.138"></a><span id="l25.138">     - Tab contributing code should define a tab type object and register it</span>
<a href="#l25.139"></a><span id="l25.139">     -  with us by calling registerTabType.  Each tab type can provide multiple</span>
<a href="#l25.140"></a><span id="l25.140">     -  tab modes.  The rationale behind this organization is that Thunderbird</span>
<a href="#l25.141"></a><span id="l25.141">     -  historically/currently uses a single 3-pane view to display both</span>
<a href="#l25.142"></a><span id="l25.142">     -  three-pane folder browsing and single message browsing across multiple</span>
<a href="#l25.143"></a><span id="l25.143">     -  tabs.  Each tab type has the ability to use a single tab panel for all</span>
<a href="#l25.144"></a><span id="l25.144">     -  of its display needs.  So Thunderbird's &quot;mail&quot; tab type covers both the</span>
<a href="#l25.145"></a><span id="l25.145" class="difflineat">@@ -232,16 +256,22 @@</span>
<a href="#l25.146"></a><span id="l25.146">         window.controllers.insertControllerAt(0, this);</span>
<a href="#l25.147"></a><span id="l25.147">       &lt;/constructor&gt;</span>
<a href="#l25.148"></a><span id="l25.148">       &lt;destructor&gt;</span>
<a href="#l25.149"></a><span id="l25.149">         window.controllers.removeController(this);</span>
<a href="#l25.150"></a><span id="l25.150">       &lt;/destructor&gt;</span>
<a href="#l25.151"></a><span id="l25.151">       &lt;field name=&quot;currentTabInfo&quot;&gt;</span>
<a href="#l25.152"></a><span id="l25.152">         null</span>
<a href="#l25.153"></a><span id="l25.153">       &lt;/field&gt;</span>
<a href="#l25.154"></a><span id="l25.154" class="difflineplus">+      &lt;!-- Temporary field that only has a non-null value during a call to</span>
<a href="#l25.155"></a><span id="l25.155" class="difflineplus">+           openTab, and whose value is the currentTabInfo of the tab that was</span>
<a href="#l25.156"></a><span id="l25.156" class="difflineplus">+           open when we received the call to openTab. --&gt;</span>
<a href="#l25.157"></a><span id="l25.157" class="difflineplus">+      &lt;field name=&quot;_mostRecentTabInfo&quot;&gt;</span>
<a href="#l25.158"></a><span id="l25.158" class="difflineplus">+        null</span>
<a href="#l25.159"></a><span id="l25.159" class="difflineplus">+      &lt;/field&gt;</span>
<a href="#l25.160"></a><span id="l25.160">       &lt;field name=&quot;tabTypes&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l25.161"></a><span id="l25.161">         new Object()</span>
<a href="#l25.162"></a><span id="l25.162">       &lt;/field&gt;</span>
<a href="#l25.163"></a><span id="l25.163">       &lt;field name=&quot;tabModes&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l25.164"></a><span id="l25.164">         new Object()</span>
<a href="#l25.165"></a><span id="l25.165">       &lt;/field&gt;</span>
<a href="#l25.166"></a><span id="l25.166">       &lt;field name=&quot;defaultTabMode&quot;&gt;</span>
<a href="#l25.167"></a><span id="l25.167">         null</span>
<a href="#l25.168"></a><span id="l25.168" class="difflineat">@@ -289,33 +319,76 @@</span>
<a href="#l25.169"></a><span id="l25.169">       &lt;/method&gt;</span>
<a href="#l25.170"></a><span id="l25.170">       &lt;method name=&quot;unregisterTabMonitor&quot;&gt;</span>
<a href="#l25.171"></a><span id="l25.171">         &lt;parameter name=&quot;aTabMonitor&quot;/&gt;</span>
<a href="#l25.172"></a><span id="l25.172">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l25.173"></a><span id="l25.173">           if (this.tabMonitors.indexOf(aTabMonitor) &gt;= 0)</span>
<a href="#l25.174"></a><span id="l25.174">             this.tabMonitors.splice(this.tabMonitors.indexOf(aTabMonitor), 1);</span>
<a href="#l25.175"></a><span id="l25.175">         ]]&gt;&lt;/body&gt;</span>
<a href="#l25.176"></a><span id="l25.176">       &lt;/method&gt;</span>
<a href="#l25.177"></a><span id="l25.177" class="difflineplus">+      &lt;!-- Given an index, tab node or tab info object, return a tuple of</span>
<a href="#l25.178"></a><span id="l25.178" class="difflineplus">+           [iTab, tab info dictionary, tab DOM node].  If</span>
<a href="#l25.179"></a><span id="l25.179" class="difflineplus">+           aTabIndexNodeOrInfo is not specified and aDefaultToCurrent is</span>
<a href="#l25.180"></a><span id="l25.180" class="difflineplus">+           true, the current tab will be returned.  Otherwise, an</span>
<a href="#l25.181"></a><span id="l25.181" class="difflineplus">+           exception will be thrown.</span>
<a href="#l25.182"></a><span id="l25.182" class="difflineplus">+        --&gt;</span>
<a href="#l25.183"></a><span id="l25.183" class="difflineplus">+      &lt;method name=&quot;_getTabContextForTabbyThing&quot;&gt;</span>
<a href="#l25.184"></a><span id="l25.184" class="difflineplus">+        &lt;parameter name=&quot;aTabIndexNodeOrInfo&quot;/&gt;</span>
<a href="#l25.185"></a><span id="l25.185" class="difflineplus">+        &lt;parameter name=&quot;aDefaultToCurrent&quot;/&gt;</span>
<a href="#l25.186"></a><span id="l25.186" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l25.187"></a><span id="l25.187" class="difflineplus">+          let iTab, tab, tabNode;</span>
<a href="#l25.188"></a><span id="l25.188" class="difflineplus">+          if (!aTabIndexNodeOrInfo) {</span>
<a href="#l25.189"></a><span id="l25.189" class="difflineplus">+            if (!aDefaultToCurrent)</span>
<a href="#l25.190"></a><span id="l25.190" class="difflineplus">+              throw Exception(&quot;You need to specify a tab!&quot;);</span>
<a href="#l25.191"></a><span id="l25.191" class="difflineplus">+            iTab = this.tabContainer.selectedIndex;</span>
<a href="#l25.192"></a><span id="l25.192" class="difflineplus">+            return [iTab, this.tabInfo[iTab],</span>
<a href="#l25.193"></a><span id="l25.193" class="difflineplus">+                    this.tabContainer.childNodes[iTab]];</span>
<a href="#l25.194"></a><span id="l25.194" class="difflineplus">+          }</span>
<a href="#l25.195"></a><span id="l25.195" class="difflineplus">+</span>
<a href="#l25.196"></a><span id="l25.196" class="difflineplus">+          if (typeof(aTabIndexNodeOrInfo) == &quot;number&quot;) {</span>
<a href="#l25.197"></a><span id="l25.197" class="difflineplus">+            iTab = aTabIndexNodeOrInfo;</span>
<a href="#l25.198"></a><span id="l25.198" class="difflineplus">+            tabNode = this.tabContainer.childNodes[iTab];</span>
<a href="#l25.199"></a><span id="l25.199" class="difflineplus">+            tab = this.tabInfo[iTab];</span>
<a href="#l25.200"></a><span id="l25.200" class="difflineplus">+          }</span>
<a href="#l25.201"></a><span id="l25.201" class="difflineplus">+          else if (aTabIndexNodeOrInfo.tagName == &quot;tab&quot;) {</span>
<a href="#l25.202"></a><span id="l25.202" class="difflineplus">+            tabNode = aTabIndexNodeOrInfo;</span>
<a href="#l25.203"></a><span id="l25.203" class="difflineplus">+            iTab = this.tabContainer.getIndexOfItem(tabNode);</span>
<a href="#l25.204"></a><span id="l25.204" class="difflineplus">+            tab = this.tabInfo[iTab];</span>
<a href="#l25.205"></a><span id="l25.205" class="difflineplus">+          }</span>
<a href="#l25.206"></a><span id="l25.206" class="difflineplus">+          else {</span>
<a href="#l25.207"></a><span id="l25.207" class="difflineplus">+            tab = aTabIndexNodeOrInfo;</span>
<a href="#l25.208"></a><span id="l25.208" class="difflineplus">+            iTab = this.tabInfo.indexOf(tab);</span>
<a href="#l25.209"></a><span id="l25.209" class="difflineplus">+            tabNode = (iTab &gt;= 0) ? this.tabContainer.childNodes[iTab] : null;</span>
<a href="#l25.210"></a><span id="l25.210" class="difflineplus">+          }</span>
<a href="#l25.211"></a><span id="l25.211" class="difflineplus">+</span>
<a href="#l25.212"></a><span id="l25.212" class="difflineplus">+          return [iTab, tab, tabNode];</span>
<a href="#l25.213"></a><span id="l25.213" class="difflineplus">+        ]]&gt;&lt;/body&gt;</span>
<a href="#l25.214"></a><span id="l25.214" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l25.215"></a><span id="l25.215">       &lt;method name=&quot;openFirstTab&quot;&gt;</span>
<a href="#l25.216"></a><span id="l25.216">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l25.217"></a><span id="l25.217">           // From the moment of creation, our XBL binding already has a visible</span>
<a href="#l25.218"></a><span id="l25.218">           //  tab.  We need to create a tab information structure for this tab.</span>
<a href="#l25.219"></a><span id="l25.219">           //  In the process we also generate a synthetic tab title changed</span>
<a href="#l25.220"></a><span id="l25.220">           //  event to ensure we have an accurate title.  We assume the tab</span>
<a href="#l25.221"></a><span id="l25.221">           //  contents will set themselves up correctly.</span>
<a href="#l25.222"></a><span id="l25.222">           if (this.tabInfo.length == 0) {</span>
<a href="#l25.223"></a><span id="l25.223" class="difflineminus">-            let firstTab = {mode: this.defaultTabMode, canClose: false};</span>
<a href="#l25.224"></a><span id="l25.224" class="difflineplus">+            let firstTab = {mode: this.defaultTabMode, busy: false,</span>
<a href="#l25.225"></a><span id="l25.225" class="difflineplus">+                            canClose: false};</span>
<a href="#l25.226"></a><span id="l25.226">             firstTab.mode.tabs.push(firstTab);</span>
<a href="#l25.227"></a><span id="l25.227" class="difflineminus">-           </span>
<a href="#l25.228"></a><span id="l25.228" class="difflineplus">+</span>
<a href="#l25.229"></a><span id="l25.229">             this.tabInfo[0] = this.currentTabInfo = firstTab;</span>
<a href="#l25.230"></a><span id="l25.230" class="difflineminus">-            this.setTabTitle(firstTab);</span>
<a href="#l25.231"></a><span id="l25.231" class="difflineplus">+</span>
<a href="#l25.232"></a><span id="l25.232" class="difflineplus">+            let tabOpenFirstFunc = firstTab.mode.openFirstTab ||</span>
<a href="#l25.233"></a><span id="l25.233" class="difflineplus">+                                   firstTab.mode.tabType.openFirstTab;</span>
<a href="#l25.234"></a><span id="l25.234" class="difflineplus">+            tabOpenFirstFunc.call(firstTab.mode.tabType, firstTab);</span>
<a href="#l25.235"></a><span id="l25.235" class="difflineplus">+            this.setTabTitle(null);</span>
<a href="#l25.236"></a><span id="l25.236"> </span>
<a href="#l25.237"></a><span id="l25.237">             if (this.tabMonitors.length) {</span>
<a href="#l25.238"></a><span id="l25.238">               for each (let [i, tabMonitor] in Iterator(this.tabMonitors))</span>
<a href="#l25.239"></a><span id="l25.239" class="difflineminus">-                tabMonitor.onTabSwitched(tab, null);</span>
<a href="#l25.240"></a><span id="l25.240" class="difflineplus">+                tabMonitor.onTabSwitched(firstTab, null);</span>
<a href="#l25.241"></a><span id="l25.241">             }</span>
<a href="#l25.242"></a><span id="l25.242">           }</span>
<a href="#l25.243"></a><span id="l25.243">         ]]&gt;&lt;/body&gt;</span>
<a href="#l25.244"></a><span id="l25.244">       &lt;/method&gt;</span>
<a href="#l25.245"></a><span id="l25.245">       &lt;method name=&quot;openTab&quot;&gt;</span>
<a href="#l25.246"></a><span id="l25.246">         &lt;parameter name=&quot;aTabModeName&quot;/&gt;</span>
<a href="#l25.247"></a><span id="l25.247">         &lt;body&gt;</span>
<a href="#l25.248"></a><span id="l25.248">             &lt;![CDATA[</span>
<a href="#l25.249"></a><span id="l25.249" class="difflineat">@@ -339,37 +412,36 @@</span>
<a href="#l25.250"></a><span id="l25.250">               this.selectTabByIndex(null, tabIndex);</span>
<a href="#l25.251"></a><span id="l25.251">               return;</span>
<a href="#l25.252"></a><span id="l25.252">             }</span>
<a href="#l25.253"></a><span id="l25.253">           }</span>
<a href="#l25.254"></a><span id="l25.254"> </span>
<a href="#l25.255"></a><span id="l25.255">           // we need to save the state before it gets corrupted</span>
<a href="#l25.256"></a><span id="l25.256">           this.saveCurrentTabState();</span>
<a href="#l25.257"></a><span id="l25.257"> </span>
<a href="#l25.258"></a><span id="l25.258" class="difflineminus">-          let tab = {mode: tabMode, canClose: true};</span>
<a href="#l25.259"></a><span id="l25.259" class="difflineplus">+          let tab = {mode: tabMode, busy: false, canClose: true};</span>
<a href="#l25.260"></a><span id="l25.260">           tabMode.tabs.push(tab);</span>
<a href="#l25.261"></a><span id="l25.261"> </span>
<a href="#l25.262"></a><span id="l25.262">           var t = document.createElementNS(</span>
<a href="#l25.263"></a><span id="l25.263">             &quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;,</span>
<a href="#l25.264"></a><span id="l25.264">             &quot;tab&quot;);</span>
<a href="#l25.265"></a><span id="l25.265">           t.setAttribute(&quot;crop&quot;, &quot;end&quot;);</span>
<a href="#l25.266"></a><span id="l25.266">           t.maxWidth = this.tabContainer.mTabMaxWidth;</span>
<a href="#l25.267"></a><span id="l25.267">           t.minWidth = this.tabContainer.mTabMinWidth;</span>
<a href="#l25.268"></a><span id="l25.268">           t.width = 0;</span>
<a href="#l25.269"></a><span id="l25.269">           t.setAttribute(&quot;flex&quot;, &quot;100&quot;);</span>
<a href="#l25.270"></a><span id="l25.270">           t.setAttribute(&quot;validate&quot;, &quot;never&quot;);</span>
<a href="#l25.271"></a><span id="l25.271">           t.className = &quot;tabmail-tab&quot;;</span>
<a href="#l25.272"></a><span id="l25.272">           this.tabContainer.appendChild(t);</span>
<a href="#l25.273"></a><span id="l25.273" class="difflineminus">-          this.tabContainer.appendChild(t);</span>
<a href="#l25.274"></a><span id="l25.274">           if (this.tabContainer.collapsed) {</span>
<a href="#l25.275"></a><span id="l25.275">             this.tabContainer.collapsed = false;</span>
<a href="#l25.276"></a><span id="l25.276">             this.tabContainer.adjustTabstrip();</span>
<a href="#l25.277"></a><span id="l25.277">           }</span>
<a href="#l25.278"></a><span id="l25.278"> </span>
<a href="#l25.279"></a><span id="l25.279" class="difflineminus">-          let oldTab = this.currentTabInfo;</span>
<a href="#l25.280"></a><span id="l25.280" class="difflineplus">+          let oldTab = this._mostRecentTabInfo = this.currentTabInfo;</span>
<a href="#l25.281"></a><span id="l25.281"> </span>
<a href="#l25.282"></a><span id="l25.282">           // the order of the following statements is important</span>
<a href="#l25.283"></a><span id="l25.283">           this.currentTabInfo = tab;</span>
<a href="#l25.284"></a><span id="l25.284">           this.tabInfo[this.tabContainer.childNodes.length - 1] = tab;</span>
<a href="#l25.285"></a><span id="l25.285">           // this has a side effect of calling updateCurrentTab, but our</span>
<a href="#l25.286"></a><span id="l25.286">           //  setting currentTabInfo above will cause it to take no action.</span>
<a href="#l25.287"></a><span id="l25.287">           this.tabContainer.selectedIndex =</span>
<a href="#l25.288"></a><span id="l25.288">             this.tabContainer.childNodes.length - 1;</span>
<a href="#l25.289"></a><span id="l25.289" class="difflineat">@@ -395,22 +467,25 @@</span>
<a href="#l25.290"></a><span id="l25.290">           let args = [tab].concat(Array.prototype.slice.call(arguments, 1));</span>
<a href="#l25.291"></a><span id="l25.291">           tabOpenFunc.apply(tab.mode.tabType, args);</span>
<a href="#l25.292"></a><span id="l25.292">           </span>
<a href="#l25.293"></a><span id="l25.293">           if (this.tabMonitors.length) {</span>
<a href="#l25.294"></a><span id="l25.294">             for each (let [i, tabMonitor] in Iterator(this.tabMonitors))</span>
<a href="#l25.295"></a><span id="l25.295">               tabMonitor.onTabSwitched(tab, oldTab);</span>
<a href="#l25.296"></a><span id="l25.296">           }</span>
<a href="#l25.297"></a><span id="l25.297">           </span>
<a href="#l25.298"></a><span id="l25.298" class="difflineplus">+          // clear _mostRecentTabInfo; we only needed it during the call to</span>
<a href="#l25.299"></a><span id="l25.299" class="difflineplus">+          //  openTab.</span>
<a href="#l25.300"></a><span id="l25.300" class="difflineplus">+          this._mostRecentTabInfo = null;</span>
<a href="#l25.301"></a><span id="l25.301" class="difflineplus">+          </span>
<a href="#l25.302"></a><span id="l25.302">           t.setAttribute(&quot;label&quot;, tab.title);</span>
<a href="#l25.303"></a><span id="l25.303">           </span>
<a href="#l25.304"></a><span id="l25.304">           let docTitle = tab.title;</span>
<a href="#l25.305"></a><span id="l25.305" class="difflineminus">-#ifndef XP_MACOSX</span>
<a href="#l25.306"></a><span id="l25.306" class="difflineminus">-          docTitle += &quot; - &quot; + gBrandBundle.getString(&quot;brandFullName&quot;);</span>
<a href="#l25.307"></a><span id="l25.307" class="difflineminus">-#endif</span>
<a href="#l25.308"></a><span id="l25.308" class="difflineplus">+          if (!gPlatformOSX)</span>
<a href="#l25.309"></a><span id="l25.309" class="difflineplus">+            docTitle += &quot; - &quot; + gBrandBundle.getString(&quot;brandFullName&quot;);</span>
<a href="#l25.310"></a><span id="l25.310">           document.title = docTitle;</span>
<a href="#l25.311"></a><span id="l25.311">           </span>
<a href="#l25.312"></a><span id="l25.312">           // for styling purposes, apply the type to the tab...</span>
<a href="#l25.313"></a><span id="l25.313">           t.setAttribute('type', tab.mode.type);</span>
<a href="#l25.314"></a><span id="l25.314">         ]]&gt;&lt;/body&gt;</span>
<a href="#l25.315"></a><span id="l25.315">       &lt;/method&gt;</span>
<a href="#l25.316"></a><span id="l25.316">       &lt;method name=&quot;selectTabByMode&quot;&gt;</span>
<a href="#l25.317"></a><span id="l25.317">         &lt;parameter name=&quot;aTabModeName&quot;/&gt;</span>
<a href="#l25.318"></a><span id="l25.318" class="difflineat">@@ -437,60 +512,93 @@</span>
<a href="#l25.319"></a><span id="l25.319">           }</span>
<a href="#l25.320"></a><span id="l25.320"> </span>
<a href="#l25.321"></a><span id="l25.321">           if (aEvent) {</span>
<a href="#l25.322"></a><span id="l25.322">             aEvent.preventDefault();</span>
<a href="#l25.323"></a><span id="l25.323">             aEvent.stopPropagation();</span>
<a href="#l25.324"></a><span id="l25.324">           }</span>
<a href="#l25.325"></a><span id="l25.325">         ]]&gt;&lt;/body&gt;</span>
<a href="#l25.326"></a><span id="l25.326">       &lt;/method&gt;</span>
<a href="#l25.327"></a><span id="l25.327" class="difflineplus">+      &lt;method name=&quot;getTabInfoForCurrentOrFirstModeInstance&quot;&gt;</span>
<a href="#l25.328"></a><span id="l25.328" class="difflineplus">+        &lt;parameter name=&quot;aTabMode&quot;/&gt;</span>
<a href="#l25.329"></a><span id="l25.329" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l25.330"></a><span id="l25.330" class="difflineplus">+        /**</span>
<a href="#l25.331"></a><span id="l25.331" class="difflineplus">+         * If the current/most recent tab is of mode aTabModeName, return its</span>
<a href="#l25.332"></a><span id="l25.332" class="difflineplus">+         *  tab info, otherwise return the tab info for the first tab of the</span>
<a href="#l25.333"></a><span id="l25.333" class="difflineplus">+         *  given mode.</span>
<a href="#l25.334"></a><span id="l25.334" class="difflineplus">+         * You would want to use this method when you would like to mimic the</span>
<a href="#l25.335"></a><span id="l25.335" class="difflineplus">+         *  settings of an existing instance of your mode.  In such a case,</span>
<a href="#l25.336"></a><span id="l25.336" class="difflineplus">+         *  it is reasonable to assume that if the 'current' tab was of the</span>
<a href="#l25.337"></a><span id="l25.337" class="difflineplus">+         *  same mode that its settings should be used.  Otherwise, we must</span>
<a href="#l25.338"></a><span id="l25.338" class="difflineplus">+         *  fall back to another tab.  We currently choose the first tab of</span>
<a href="#l25.339"></a><span id="l25.339" class="difflineplus">+         *  the instance, because for the &quot;folder&quot; tab, it is the canonical tab.</span>
<a href="#l25.340"></a><span id="l25.340" class="difflineplus">+         *  In other cases, having an MRU order and choosing the MRU tab might</span>
<a href="#l25.341"></a><span id="l25.341" class="difflineplus">+         *  be more appropriate.</span>
<a href="#l25.342"></a><span id="l25.342" class="difflineplus">+         *</span>
<a href="#l25.343"></a><span id="l25.343" class="difflineplus">+         * @return the tab info object for the tab meeting the above criteria,</span>
<a href="#l25.344"></a><span id="l25.344" class="difflineplus">+         *     or null if no such tab exists.</span>
<a href="#l25.345"></a><span id="l25.345" class="difflineplus">+         */</span>
<a href="#l25.346"></a><span id="l25.346" class="difflineplus">+          if (this._mostRecentTabInfo &amp;&amp;</span>
<a href="#l25.347"></a><span id="l25.347" class="difflineplus">+              this._mostRecentTabInfo.mode == aTabMode)</span>
<a href="#l25.348"></a><span id="l25.348" class="difflineplus">+            return this._mostRecentTabInfo;</span>
<a href="#l25.349"></a><span id="l25.349" class="difflineplus">+          else if (aTabMode.tabs.length)</span>
<a href="#l25.350"></a><span id="l25.350" class="difflineplus">+            return aTabMode.tabs[0];</span>
<a href="#l25.351"></a><span id="l25.351" class="difflineplus">+          else</span>
<a href="#l25.352"></a><span id="l25.352" class="difflineplus">+            return null;</span>
<a href="#l25.353"></a><span id="l25.353" class="difflineplus">+        ]]&gt;&lt;/body&gt;</span>
<a href="#l25.354"></a><span id="l25.354" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l25.355"></a><span id="l25.355" class="difflineplus">+      &lt;method name=&quot;closeTab&quot;&gt;</span>
<a href="#l25.356"></a><span id="l25.356" class="difflineplus">+        &lt;parameter name=&quot;aOptTabIndexNodeOrInfo&quot;/&gt;</span>
<a href="#l25.357"></a><span id="l25.357" class="difflineplus">+        &lt;body&gt;</span>
<a href="#l25.358"></a><span id="l25.358" class="difflineplus">+          &lt;![CDATA[</span>
<a href="#l25.359"></a><span id="l25.359" class="difflineplus">+            let [iTab, tab, tabNode] =</span>
<a href="#l25.360"></a><span id="l25.360" class="difflineplus">+              this._getTabContextForTabbyThing(aOptTabIndexNodeOrInfo, true);</span>
<a href="#l25.361"></a><span id="l25.361" class="difflineplus">+</span>
<a href="#l25.362"></a><span id="l25.362" class="difflineplus">+            if (!tab.canClose)</span>
<a href="#l25.363"></a><span id="l25.363" class="difflineplus">+              return;</span>
<a href="#l25.364"></a><span id="l25.364" class="difflineplus">+            </span>
<a href="#l25.365"></a><span id="l25.365" class="difflineplus">+            let closeFunc = tab.mode.closeTab || tab.mode.tabType.closeTab;</span>
<a href="#l25.366"></a><span id="l25.366" class="difflineplus">+            closeFunc.call(tab.mode.tabType, tab);</span>
<a href="#l25.367"></a><span id="l25.367" class="difflineplus">+             </span>
<a href="#l25.368"></a><span id="l25.368" class="difflineplus">+            this.tabInfo.splice(iTab, 1);</span>
<a href="#l25.369"></a><span id="l25.369" class="difflineplus">+            tab.mode.tabs.splice(tab.mode.tabs.indexOf(tab), 1);</span>
<a href="#l25.370"></a><span id="l25.370" class="difflineplus">+            this.tabContainer.removeChild(tabNode);</span>
<a href="#l25.371"></a><span id="l25.371" class="difflineplus">+            if (this.tabContainer.selectedIndex == -1)</span>
<a href="#l25.372"></a><span id="l25.372" class="difflineplus">+              this.tabContainer.selectedIndex =</span>
<a href="#l25.373"></a><span id="l25.373" class="difflineplus">+                (iTab == this.tabContainer.childNodes.length) ? iTab - 1 : iTab;</span>
<a href="#l25.374"></a><span id="l25.374" class="difflineplus">+            if (this.currentTabInfo == tab)</span>
<a href="#l25.375"></a><span id="l25.375" class="difflineplus">+              this.updateCurrentTab();</span>
<a href="#l25.376"></a><span id="l25.376" class="difflineplus">+              </span>
<a href="#l25.377"></a><span id="l25.377" class="difflineplus">+            if (tab.panel) {</span>
<a href="#l25.378"></a><span id="l25.378" class="difflineplus">+              this.panelContainer.removeChild(tab.panel);</span>
<a href="#l25.379"></a><span id="l25.379" class="difflineplus">+              delete tab.panel;</span>
<a href="#l25.380"></a><span id="l25.380" class="difflineplus">+            }</span>
<a href="#l25.381"></a><span id="l25.381" class="difflineplus">+            if (this.tabContainer.childNodes.length == 1 &amp;&amp;</span>
<a href="#l25.382"></a><span id="l25.382" class="difflineplus">+                this.tabContainer.mAutoHide)</span>
<a href="#l25.383"></a><span id="l25.383" class="difflineplus">+              this.tabContainer.collapsed = true;</span>
<a href="#l25.384"></a><span id="l25.384" class="difflineplus">+          ]]&gt;</span>
<a href="#l25.385"></a><span id="l25.385" class="difflineplus">+        &lt;/body&gt;</span>
<a href="#l25.386"></a><span id="l25.386" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l25.387"></a><span id="l25.387">       &lt;method name=&quot;closeTabs&quot;&gt;</span>
<a href="#l25.388"></a><span id="l25.388">         &lt;body&gt;</span>
<a href="#l25.389"></a><span id="l25.389">           &lt;![CDATA[</span>
<a href="#l25.390"></a><span id="l25.390">             for (var i = 0; i &lt; this.tabInfo.length; i++) {</span>
<a href="#l25.391"></a><span id="l25.391">               let tab = this.tabInfo[i];</span>
<a href="#l25.392"></a><span id="l25.392">               </span>
<a href="#l25.393"></a><span id="l25.393">               let tabCloseFunc = tab.mode.closeTab || tab.mode.tabType.closeTab;</span>
<a href="#l25.394"></a><span id="l25.394">               tabCloseFunc.call(tab.mode.tabType, tab);</span>
<a href="#l25.395"></a><span id="l25.395">             }</span>
<a href="#l25.396"></a><span id="l25.396">           ]]&gt;</span>
<a href="#l25.397"></a><span id="l25.397">         &lt;/body&gt;</span>
<a href="#l25.398"></a><span id="l25.398">       &lt;/method&gt;</span>
<a href="#l25.399"></a><span id="l25.399">       &lt;method name=&quot;removeTabByNode&quot;&gt;</span>
<a href="#l25.400"></a><span id="l25.400">         &lt;parameter name=&quot;aTabNode&quot;/&gt;</span>
<a href="#l25.401"></a><span id="l25.401">         &lt;body&gt;</span>
<a href="#l25.402"></a><span id="l25.402">           &lt;![CDATA[</span>
<a href="#l25.403"></a><span id="l25.403" class="difflineminus">-            // Find and locate the tab in our list.</span>
<a href="#l25.404"></a><span id="l25.404" class="difflineminus">-            let iTab, numTabs = this.tabContainer.childNodes.length;</span>
<a href="#l25.405"></a><span id="l25.405" class="difflineminus">-            for (iTab = 0; iTab &lt; numTabs; iTab++)</span>
<a href="#l25.406"></a><span id="l25.406" class="difflineminus">-              if (this.tabContainer.childNodes[iTab] == aTabNode)</span>
<a href="#l25.407"></a><span id="l25.407" class="difflineminus">-                break;</span>
<a href="#l25.408"></a><span id="l25.408" class="difflineminus">-            let tab = this.tabInfo[iTab];</span>
<a href="#l25.409"></a><span id="l25.409" class="difflineminus">-</span>
<a href="#l25.410"></a><span id="l25.410" class="difflineminus">-            if (!tab.canClose)</span>
<a href="#l25.411"></a><span id="l25.411" class="difflineminus">-              return;</span>
<a href="#l25.412"></a><span id="l25.412" class="difflineminus">-            </span>
<a href="#l25.413"></a><span id="l25.413" class="difflineminus">-            let closeFunc = tab.mode.closeTab || tab.mode.tabType.closeTab;</span>
<a href="#l25.414"></a><span id="l25.414" class="difflineminus">-            closeFunc.call(tab.mode.tabType, tab);</span>
<a href="#l25.415"></a><span id="l25.415" class="difflineminus">-             </span>
<a href="#l25.416"></a><span id="l25.416" class="difflineminus">-            this.tabInfo.splice(iTab, 1);</span>
<a href="#l25.417"></a><span id="l25.417" class="difflineminus">-            tab.mode.tabs.splice(tab.mode.tabs.indexOf(tab), 1);</span>
<a href="#l25.418"></a><span id="l25.418" class="difflineminus">-            this.tabContainer.removeChild(aTabNode);</span>
<a href="#l25.419"></a><span id="l25.419" class="difflineminus">-            if (this.tabContainer.selectedIndex == -1)</span>
<a href="#l25.420"></a><span id="l25.420" class="difflineminus">-              this.tabContainer.selectedIndex = (iTab == --numTabs) ?</span>
<a href="#l25.421"></a><span id="l25.421" class="difflineminus">-                iTab - 1 : iTab;</span>
<a href="#l25.422"></a><span id="l25.422" class="difflineminus">-            if (this.currentTabInfo == tab)</span>
<a href="#l25.423"></a><span id="l25.423" class="difflineminus">-              this.updateCurrentTab();</span>
<a href="#l25.424"></a><span id="l25.424" class="difflineminus">-              </span>
<a href="#l25.425"></a><span id="l25.425" class="difflineminus">-            if (tab.panel) {</span>
<a href="#l25.426"></a><span id="l25.426" class="difflineminus">-              this.panelContainer.removeChild(tab.panel);</span>
<a href="#l25.427"></a><span id="l25.427" class="difflineminus">-              delete tab.panel;</span>
<a href="#l25.428"></a><span id="l25.428" class="difflineminus">-            }</span>
<a href="#l25.429"></a><span id="l25.429" class="difflineminus">-            if (numTabs == 1 &amp;&amp; this.tabContainer.mAutoHide)</span>
<a href="#l25.430"></a><span id="l25.430" class="difflineminus">-              this.tabContainer.collapsed = true;</span>
<a href="#l25.431"></a><span id="l25.431" class="difflineplus">+            this.closeTab(aTabNode);</span>
<a href="#l25.432"></a><span id="l25.432">           ]]&gt;</span>
<a href="#l25.433"></a><span id="l25.433">         &lt;/body&gt;</span>
<a href="#l25.434"></a><span id="l25.434">       &lt;/method&gt;</span>
<a href="#l25.435"></a><span id="l25.435">       &lt;!-- getBrowserForSelectedTab is required as some toolkit functions</span>
<a href="#l25.436"></a><span id="l25.436">            require a getBrowser() function. --&gt;</span>
<a href="#l25.437"></a><span id="l25.437">       &lt;method name=&quot;getBrowserForSelectedTab&quot;&gt;</span>
<a href="#l25.438"></a><span id="l25.438">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l25.439"></a><span id="l25.439">           if (!this.currentTabInfo)</span>
<a href="#l25.440"></a><span id="l25.440" class="difflineat">@@ -506,16 +614,27 @@</span>
<a href="#l25.441"></a><span id="l25.441">         ]]&gt;&lt;/body&gt;</span>
<a href="#l25.442"></a><span id="l25.442">       &lt;/method&gt;</span>
<a href="#l25.443"></a><span id="l25.443">       &lt;method name=&quot;removeCurrentTab&quot;&gt;</span>
<a href="#l25.444"></a><span id="l25.444">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l25.445"></a><span id="l25.445">           this.removeTabByNode(</span>
<a href="#l25.446"></a><span id="l25.446">             this.tabContainer.childNodes[this.tabContainer.selectedIndex]);</span>
<a href="#l25.447"></a><span id="l25.447">         ]]&gt;&lt;/body&gt;</span>
<a href="#l25.448"></a><span id="l25.448">       &lt;/method&gt;</span>
<a href="#l25.449"></a><span id="l25.449" class="difflineplus">+      &lt;method name=&quot;switchToTab&quot;&gt;</span>
<a href="#l25.450"></a><span id="l25.450" class="difflineplus">+        &lt;parameter name=&quot;aTabIndexNodeOrInfo&quot;/&gt;</span>
<a href="#l25.451"></a><span id="l25.451" class="difflineplus">+        &lt;body&gt;</span>
<a href="#l25.452"></a><span id="l25.452" class="difflineplus">+          &lt;![CDATA[</span>
<a href="#l25.453"></a><span id="l25.453" class="difflineplus">+            let [iTab, tab, tabNode] =</span>
<a href="#l25.454"></a><span id="l25.454" class="difflineplus">+              this._getTabContextForTabbyThing(aTabIndexNodeOrInfo, false);</span>
<a href="#l25.455"></a><span id="l25.455" class="difflineplus">+</span>
<a href="#l25.456"></a><span id="l25.456" class="difflineplus">+            this.tabContainer.selectedIndex = iTab;</span>
<a href="#l25.457"></a><span id="l25.457" class="difflineplus">+          ]]&gt;</span>
<a href="#l25.458"></a><span id="l25.458" class="difflineplus">+        &lt;/body&gt;</span>
<a href="#l25.459"></a><span id="l25.459" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l25.460"></a><span id="l25.460">       &lt;!--  UpdateCurrentTab - called in response to changing the current tab --&gt;</span>
<a href="#l25.461"></a><span id="l25.461">       &lt;method name=&quot;updateCurrentTab&quot;&gt;</span>
<a href="#l25.462"></a><span id="l25.462">         &lt;body&gt;</span>
<a href="#l25.463"></a><span id="l25.463">           &lt;![CDATA[</span>
<a href="#l25.464"></a><span id="l25.464">             if (this.currentTabInfo != this.tabInfo[this.tabContainer.selectedIndex])</span>
<a href="#l25.465"></a><span id="l25.465">             {</span>
<a href="#l25.466"></a><span id="l25.466">               if (this.currentTabInfo)</span>
<a href="#l25.467"></a><span id="l25.467">                 this.saveCurrentTabState();</span>
<a href="#l25.468"></a><span id="l25.468" class="difflineat">@@ -530,21 +649,29 @@</span>
<a href="#l25.469"></a><span id="l25.469">               let showTabFunc = tab.mode.showTab || tab.mode.tabType.showTab;</span>
<a href="#l25.470"></a><span id="l25.470">               showTabFunc.call(tab.mode.tabType, tab);</span>
<a href="#l25.471"></a><span id="l25.471"> </span>
<a href="#l25.472"></a><span id="l25.472">               if (this.tabMonitors.length) {</span>
<a href="#l25.473"></a><span id="l25.473">                 for each (let [i, tabMonitor] in Iterator(this.tabMonitors))</span>
<a href="#l25.474"></a><span id="l25.474">                   tabMonitor.onTabSwitched(tab, oldTab);</span>
<a href="#l25.475"></a><span id="l25.475">               }</span>
<a href="#l25.476"></a><span id="l25.476"> </span>
<a href="#l25.477"></a><span id="l25.477" class="difflineplus">+              // always update the cursor status when we switch tabs</span>
<a href="#l25.478"></a><span id="l25.478" class="difflineplus">+              SetBusyCursor(window, tab.busy);</span>
<a href="#l25.479"></a><span id="l25.479" class="difflineplus">+              // active tabs should not have the wasBusy attribute</span>
<a href="#l25.480"></a><span id="l25.480" class="difflineplus">+              this.tabContainer.selectedItem.removeAttribute(&quot;wasBusy&quot;);</span>
<a href="#l25.481"></a><span id="l25.481" class="difflineplus">+</span>
<a href="#l25.482"></a><span id="l25.482" class="difflineplus">+              // update the thinking status when we switch tabs</span>
<a href="#l25.483"></a><span id="l25.483" class="difflineplus">+              this._setActiveThinkingState(tab.thinking);</span>
<a href="#l25.484"></a><span id="l25.484" class="difflineplus">+              // active tabs should not have the wasThinking attribute</span>
<a href="#l25.485"></a><span id="l25.485" class="difflineplus">+              this.tabContainer.selectedItem.removeAttribute(&quot;wasThinking&quot;);</span>
<a href="#l25.486"></a><span id="l25.486"> </span>
<a href="#l25.487"></a><span id="l25.487">               let docTitle = tab.title;</span>
<a href="#l25.488"></a><span id="l25.488" class="difflineminus">-#ifndef XP_MACOSX</span>
<a href="#l25.489"></a><span id="l25.489" class="difflineminus">-              docTitle += &quot; - &quot; + gBrandBundle.getString(&quot;brandFullName&quot;);</span>
<a href="#l25.490"></a><span id="l25.490" class="difflineminus">-#endif</span>
<a href="#l25.491"></a><span id="l25.491" class="difflineplus">+              if (!gPlatformOSX)</span>
<a href="#l25.492"></a><span id="l25.492" class="difflineplus">+                docTitle += &quot; - &quot; + gBrandBundle.getString(&quot;brandFullName&quot;);</span>
<a href="#l25.493"></a><span id="l25.493">               document.title = docTitle;</span>
<a href="#l25.494"></a><span id="l25.494"> </span>
<a href="#l25.495"></a><span id="l25.495">               // Update the toolbar status - we don't need to do menus as they</span>
<a href="#l25.496"></a><span id="l25.496">               // do themselves when we open them.</span>
<a href="#l25.497"></a><span id="l25.497">               UpdateMailToolbar(&quot;tabmail&quot;);</span>
<a href="#l25.498"></a><span id="l25.498">             }</span>
<a href="#l25.499"></a><span id="l25.499">           ]]&gt;</span>
<a href="#l25.500"></a><span id="l25.500">         &lt;/body&gt;</span>
<a href="#l25.501"></a><span id="l25.501" class="difflineat">@@ -571,64 +698,129 @@</span>
<a href="#l25.502"></a><span id="l25.502">             if (event.button != 1 || event.target.localName != 'tab')</span>
<a href="#l25.503"></a><span id="l25.503">               return;</span>
<a href="#l25.504"></a><span id="l25.504">             this.removeTabByNode(event.target);</span>
<a href="#l25.505"></a><span id="l25.505">             event.stopPropagation();</span>
<a href="#l25.506"></a><span id="l25.506">           ]]&gt;</span>
<a href="#l25.507"></a><span id="l25.507">         &lt;/body&gt;</span>
<a href="#l25.508"></a><span id="l25.508">       &lt;/method&gt;</span>
<a href="#l25.509"></a><span id="l25.509">       &lt;method name=&quot;setTabTitle&quot;&gt;</span>
<a href="#l25.510"></a><span id="l25.510" class="difflineminus">-        &lt;parameter name=&quot;aTab&quot;/&gt;</span>
<a href="#l25.511"></a><span id="l25.511" class="difflineplus">+        &lt;parameter name=&quot;aTabNodeOrInfo&quot;/&gt;</span>
<a href="#l25.512"></a><span id="l25.512">         &lt;body&gt;</span>
<a href="#l25.513"></a><span id="l25.513">           &lt;![CDATA[</span>
<a href="#l25.514"></a><span id="l25.514" class="difflineminus">-            // First find the tab and its index.</span>
<a href="#l25.515"></a><span id="l25.515" class="difflineminus">-            let tab;</span>
<a href="#l25.516"></a><span id="l25.516" class="difflineminus">-            let index;</span>
<a href="#l25.517"></a><span id="l25.517" class="difflineminus">-            if (aTab) {</span>
<a href="#l25.518"></a><span id="l25.518" class="difflineminus">-              tab = aTab;</span>
<a href="#l25.519"></a><span id="l25.519" class="difflineminus">-              for (index = 0; index &lt; this.tabInfo.length; ++index) {</span>
<a href="#l25.520"></a><span id="l25.520" class="difflineminus">-                if (tab == this.tabInfo[index])</span>
<a href="#l25.521"></a><span id="l25.521" class="difflineminus">-                  break;</span>
<a href="#l25.522"></a><span id="l25.522" class="difflineminus">-              }</span>
<a href="#l25.523"></a><span id="l25.523" class="difflineminus">-            }</span>
<a href="#l25.524"></a><span id="l25.524" class="difflineminus">-            else {</span>
<a href="#l25.525"></a><span id="l25.525" class="difflineminus">-              index = this.tabContainer.selectedIndex;</span>
<a href="#l25.526"></a><span id="l25.526" class="difflineminus">-              tab = this.tabInfo[index];</span>
<a href="#l25.527"></a><span id="l25.527" class="difflineminus">-            }</span>
<a href="#l25.528"></a><span id="l25.528" class="difflineplus">+            let [iTab, tab, tabNode] =</span>
<a href="#l25.529"></a><span id="l25.529" class="difflineplus">+              this._getTabContextForTabbyThing(aTabNodeOrInfo, true);</span>
<a href="#l25.530"></a><span id="l25.530"> </span>
<a href="#l25.531"></a><span id="l25.531" class="difflineminus">-            // on startup, we may not have a tab...</span>
<a href="#l25.532"></a><span id="l25.532">             if (tab)</span>
<a href="#l25.533"></a><span id="l25.533">             {</span>
<a href="#l25.534"></a><span id="l25.534">               let tabNode =</span>
<a href="#l25.535"></a><span id="l25.535" class="difflineminus">-                this.tabContainer.childNodes[index];</span>
<a href="#l25.536"></a><span id="l25.536" class="difflineplus">+                this.tabContainer.childNodes[iTab];</span>
<a href="#l25.537"></a><span id="l25.537"> </span>
<a href="#l25.538"></a><span id="l25.538">               let titleChangeFunc = tab.mode.onTitleChanged ||</span>
<a href="#l25.539"></a><span id="l25.539">                                     tab.mode.tabType.onTitleChanged;</span>
<a href="#l25.540"></a><span id="l25.540">               if (titleChangeFunc)</span>
<a href="#l25.541"></a><span id="l25.541">                 titleChangeFunc.call(tab.mode.tabType, tab, tabNode);</span>
<a href="#l25.542"></a><span id="l25.542"> </span>
<a href="#l25.543"></a><span id="l25.543">               if (this.tabMonitors.length) {</span>
<a href="#l25.544"></a><span id="l25.544" class="difflineminus">-                for each (let [index, tabMonitor] in Iterator(this.tabMonitors))</span>
<a href="#l25.545"></a><span id="l25.545" class="difflineplus">+                for each (let [, tabMonitor] in Iterator(this.tabMonitors))</span>
<a href="#l25.546"></a><span id="l25.546">                   tabMonitor.onTabTitleChanged(tab);</span>
<a href="#l25.547"></a><span id="l25.547">               }</span>
<a href="#l25.548"></a><span id="l25.548"> </span>
<a href="#l25.549"></a><span id="l25.549">               tabNode.setAttribute(&quot;label&quot;, tab.title);</span>
<a href="#l25.550"></a><span id="l25.550"> </span>
<a href="#l25.551"></a><span id="l25.551">               // Update the window title if we're the displayed tab.</span>
<a href="#l25.552"></a><span id="l25.552" class="difflineminus">-              if (index == this.tabContainer.selectedIndex) {</span>
<a href="#l25.553"></a><span id="l25.553" class="difflineplus">+              if (iTab == this.tabContainer.selectedIndex) {</span>
<a href="#l25.554"></a><span id="l25.554">                 let docTitle = tab.title;</span>
<a href="#l25.555"></a><span id="l25.555" class="difflineminus">-#ifndef XP_MACOSX</span>
<a href="#l25.556"></a><span id="l25.556" class="difflineminus">-                docTitle += &quot; - &quot; + gBrandBundle.getString(&quot;brandFullName&quot;);</span>
<a href="#l25.557"></a><span id="l25.557" class="difflineminus">-#endif</span>
<a href="#l25.558"></a><span id="l25.558" class="difflineplus">+                if (!gPlatformOSX)</span>
<a href="#l25.559"></a><span id="l25.559" class="difflineplus">+                  docTitle += &quot; - &quot; + gBrandBundle.getString(&quot;brandFullName&quot;);</span>
<a href="#l25.560"></a><span id="l25.560">                 document.title = docTitle;</span>
<a href="#l25.561"></a><span id="l25.561">               }</span>
<a href="#l25.562"></a><span id="l25.562">             }</span>
<a href="#l25.563"></a><span id="l25.563">           ]]&gt;</span>
<a href="#l25.564"></a><span id="l25.564">         &lt;/body&gt;</span>
<a href="#l25.565"></a><span id="l25.565">       &lt;/method&gt;</span>
<a href="#l25.566"></a><span id="l25.566" class="difflineplus">+      &lt;!--</span>
<a href="#l25.567"></a><span id="l25.567" class="difflineplus">+        - Updates the global state to reflect the active tab's thinking</span>
<a href="#l25.568"></a><span id="l25.568" class="difflineplus">+        -   state (which the caller provides).</span>
<a href="#l25.569"></a><span id="l25.569" class="difflineplus">+        --&gt;</span>
<a href="#l25.570"></a><span id="l25.570" class="difflineplus">+      &lt;method name=&quot;_setActiveThinkingState&quot;&gt;</span>
<a href="#l25.571"></a><span id="l25.571" class="difflineplus">+        &lt;parameter name=&quot;aThinkingState&quot;/&gt;</span>
<a href="#l25.572"></a><span id="l25.572" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l25.573"></a><span id="l25.573" class="difflineplus">+          if (aThinkingState) {</span>
<a href="#l25.574"></a><span id="l25.574" class="difflineplus">+            statusFeedback.showProgress(0);</span>
<a href="#l25.575"></a><span id="l25.575" class="difflineplus">+            if (typeof(aThinkingState) == &quot;string&quot;)</span>
<a href="#l25.576"></a><span id="l25.576" class="difflineplus">+              statusFeedback.showStatusString(aThinkingState);</span>
<a href="#l25.577"></a><span id="l25.577" class="difflineplus">+            gStatusBar.setAttribute(&quot;mode&quot;,&quot;undetermined&quot;);</span>
<a href="#l25.578"></a><span id="l25.578" class="difflineplus">+          }</span>
<a href="#l25.579"></a><span id="l25.579" class="difflineplus">+          else {</span>
<a href="#l25.580"></a><span id="l25.580" class="difflineplus">+            statusFeedback.showProgress(0);</span>
<a href="#l25.581"></a><span id="l25.581" class="difflineplus">+            gStatusBar.setAttribute(&quot;mode&quot;, &quot;normal&quot;);</span>
<a href="#l25.582"></a><span id="l25.582" class="difflineplus">+          }</span>
<a href="#l25.583"></a><span id="l25.583" class="difflineplus">+        ]]&gt;&lt;/body&gt;</span>
<a href="#l25.584"></a><span id="l25.584" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l25.585"></a><span id="l25.585" class="difflineplus">+      &lt;method name=&quot;setTabThinking&quot;&gt;</span>
<a href="#l25.586"></a><span id="l25.586" class="difflineplus">+        &lt;parameter name=&quot;aTabNodeOrInfo&quot;/&gt;</span>
<a href="#l25.587"></a><span id="l25.587" class="difflineplus">+        &lt;parameter name=&quot;aThinking&quot;/&gt;</span>
<a href="#l25.588"></a><span id="l25.588" class="difflineplus">+        &lt;body&gt;</span>
<a href="#l25.589"></a><span id="l25.589" class="difflineplus">+          &lt;![CDATA[</span>
<a href="#l25.590"></a><span id="l25.590" class="difflineplus">+            let [iTab, tab, tabNode] = this._getTabContextForTabbyThing(</span>
<a href="#l25.591"></a><span id="l25.591" class="difflineplus">+                                         aTabNodeOrInfo, false);</span>
<a href="#l25.592"></a><span id="l25.592" class="difflineplus">+            let isSelected = (iTab == this.tabContainer.selectedIndex);</span>
<a href="#l25.593"></a><span id="l25.593" class="difflineplus">+</span>
<a href="#l25.594"></a><span id="l25.594" class="difflineplus">+            // if we are the current tab, update the cursor</span>
<a href="#l25.595"></a><span id="l25.595" class="difflineplus">+            if (isSelected)</span>
<a href="#l25.596"></a><span id="l25.596" class="difflineplus">+              this._setActiveThinkingState(aThinking);</span>
<a href="#l25.597"></a><span id="l25.597" class="difflineplus">+</span>
<a href="#l25.598"></a><span id="l25.598" class="difflineplus">+            // if we are busy, hint our tab</span>
<a href="#l25.599"></a><span id="l25.599" class="difflineplus">+            if (aThinking) {</span>
<a href="#l25.600"></a><span id="l25.600" class="difflineplus">+              tabNode.setAttribute(&quot;thinking&quot;, &quot;true&quot;);</span>
<a href="#l25.601"></a><span id="l25.601" class="difflineplus">+            }</span>
<a href="#l25.602"></a><span id="l25.602" class="difflineplus">+            else {</span>
<a href="#l25.603"></a><span id="l25.603" class="difflineplus">+              // if we were thinking and are not selected, set the</span>
<a href="#l25.604"></a><span id="l25.604" class="difflineplus">+              //  &quot;wasThinking&quot; attribute.</span>
<a href="#l25.605"></a><span id="l25.605" class="difflineplus">+              if (tab.thinking &amp;&amp; !isSelected)</span>
<a href="#l25.606"></a><span id="l25.606" class="difflineplus">+                tabNode.setAttribute(&quot;wasThinking&quot;, &quot;true&quot;);</span>
<a href="#l25.607"></a><span id="l25.607" class="difflineplus">+              tabNode.removeAttribute(&quot;thinking&quot;);</span>
<a href="#l25.608"></a><span id="l25.608" class="difflineplus">+            }</span>
<a href="#l25.609"></a><span id="l25.609" class="difflineplus">+</span>
<a href="#l25.610"></a><span id="l25.610" class="difflineplus">+            // update the tab info to store the busy state.</span>
<a href="#l25.611"></a><span id="l25.611" class="difflineplus">+            tab.thinking = aThinking;</span>
<a href="#l25.612"></a><span id="l25.612" class="difflineplus">+          ]]&gt;</span>
<a href="#l25.613"></a><span id="l25.613" class="difflineplus">+        &lt;/body&gt;</span>
<a href="#l25.614"></a><span id="l25.614" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l25.615"></a><span id="l25.615" class="difflineplus">+      &lt;method name=&quot;setTabBusy&quot;&gt;</span>
<a href="#l25.616"></a><span id="l25.616" class="difflineplus">+        &lt;parameter name=&quot;aTabNodeOrInfo&quot;/&gt;</span>
<a href="#l25.617"></a><span id="l25.617" class="difflineplus">+        &lt;parameter name=&quot;aBusy&quot;/&gt;</span>
<a href="#l25.618"></a><span id="l25.618" class="difflineplus">+        &lt;body&gt;</span>
<a href="#l25.619"></a><span id="l25.619" class="difflineplus">+          &lt;![CDATA[</span>
<a href="#l25.620"></a><span id="l25.620" class="difflineplus">+            let [iTab, tab, tabNode] = this._getTabContextForTabbyThing(</span>
<a href="#l25.621"></a><span id="l25.621" class="difflineplus">+                                         aTabNodeOrInfo, false);</span>
<a href="#l25.622"></a><span id="l25.622" class="difflineplus">+            let isSelected = (iTab == this.tabContainer.selectedIndex);</span>
<a href="#l25.623"></a><span id="l25.623" class="difflineplus">+</span>
<a href="#l25.624"></a><span id="l25.624" class="difflineplus">+            // if we are the current tab, update the cursor</span>
<a href="#l25.625"></a><span id="l25.625" class="difflineplus">+            if (isSelected)</span>
<a href="#l25.626"></a><span id="l25.626" class="difflineplus">+              SetBusyCursor(window, aBusy);</span>
<a href="#l25.627"></a><span id="l25.627" class="difflineplus">+</span>
<a href="#l25.628"></a><span id="l25.628" class="difflineplus">+            // if we are busy, hint our tab</span>
<a href="#l25.629"></a><span id="l25.629" class="difflineplus">+            if (aBusy) {</span>
<a href="#l25.630"></a><span id="l25.630" class="difflineplus">+              tabNode.setAttribute(&quot;busy&quot;, &quot;true&quot;);</span>
<a href="#l25.631"></a><span id="l25.631" class="difflineplus">+            }</span>
<a href="#l25.632"></a><span id="l25.632" class="difflineplus">+            else {</span>
<a href="#l25.633"></a><span id="l25.633" class="difflineplus">+              // if we were busy and are not selected, set the</span>
<a href="#l25.634"></a><span id="l25.634" class="difflineplus">+              //  &quot;wasBusy&quot; attribute.</span>
<a href="#l25.635"></a><span id="l25.635" class="difflineplus">+              if (tab.busy &amp;&amp; !isSelected)</span>
<a href="#l25.636"></a><span id="l25.636" class="difflineplus">+                tabNode.setAttribute(&quot;wasBusy&quot;, &quot;true&quot;);</span>
<a href="#l25.637"></a><span id="l25.637" class="difflineplus">+              tabNode.removeAttribute(&quot;busy&quot;);</span>
<a href="#l25.638"></a><span id="l25.638" class="difflineplus">+            }</span>
<a href="#l25.639"></a><span id="l25.639" class="difflineplus">+</span>
<a href="#l25.640"></a><span id="l25.640" class="difflineplus">+            // update the tab info to store the busy state.</span>
<a href="#l25.641"></a><span id="l25.641" class="difflineplus">+            tab.busy = aBusy;</span>
<a href="#l25.642"></a><span id="l25.642" class="difflineplus">+          ]]&gt;</span>
<a href="#l25.643"></a><span id="l25.643" class="difflineplus">+        &lt;/body&gt;</span>
<a href="#l25.644"></a><span id="l25.644" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l25.645"></a><span id="l25.645">       &lt;method name=&quot;onTabContextMenuShowing&quot;&gt;</span>
<a href="#l25.646"></a><span id="l25.646">         &lt;parameter name=&quot;aTabNode&quot;/&gt;</span>
<a href="#l25.647"></a><span id="l25.647">         &lt;body&gt;</span>
<a href="#l25.648"></a><span id="l25.648">           &lt;![CDATA[</span>
<a href="#l25.649"></a><span id="l25.649">             // To determine whether the 'Close Tab' context menu should be</span>
<a href="#l25.650"></a><span id="l25.650">             // visible according to the tab node that was being clicked on.</span>
<a href="#l25.651"></a><span id="l25.651">             // If the tab node is not closable, the context menu should not</span>
<a href="#l25.652"></a><span id="l25.652">             // be shown.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mail/base/content/threadPane.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mail/base/content/threadPane.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -85,114 +85,16 @@ function ThreadPaneOnClick(event)</span>
<a href="#l26.4"></a><span id="l26.4">       else if (col.value.id == &quot;threadCol&quot; &amp;&amp; !event.shiftKey &amp;&amp;</span>
<a href="#l26.5"></a><span id="l26.5">           (event.ctrlKey || event.metaKey)) {</span>
<a href="#l26.6"></a><span id="l26.6">         gDBView.ExpandAndSelectThreadByIndex(row.value, true);</span>
<a href="#l26.7"></a><span id="l26.7">         event.stopPropagation();</span>
<a href="#l26.8"></a><span id="l26.8">       }</span>
<a href="#l26.9"></a><span id="l26.9">     }</span>
<a href="#l26.10"></a><span id="l26.10"> }</span>
<a href="#l26.11"></a><span id="l26.11"> </span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-function nsMsgDBViewCommandUpdater()</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineminus">-{</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineminus">-  _selectionSummarized: false;</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineminus">-  _selectionTimeout: null;</span>
<a href="#l26.16"></a><span id="l26.16" class="difflineminus">-}</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineminus">-</span>
<a href="#l26.18"></a><span id="l26.18" class="difflineminus">-nsMsgDBViewCommandUpdater.prototype = </span>
<a href="#l26.19"></a><span id="l26.19" class="difflineminus">-{</span>
<a href="#l26.20"></a><span id="l26.20" class="difflineminus">-  updateCommandStatus : function()</span>
<a href="#l26.21"></a><span id="l26.21" class="difflineminus">-    {</span>
<a href="#l26.22"></a><span id="l26.22" class="difflineminus">-      // the back end is smart and is only telling us to update command status</span>
<a href="#l26.23"></a><span id="l26.23" class="difflineminus">-      // when the # of items in the selection has actually changed.</span>
<a href="#l26.24"></a><span id="l26.24" class="difflineminus">-      UpdateMailToolbar(&quot;dbview driven, thread pane&quot;);</span>
<a href="#l26.25"></a><span id="l26.25" class="difflineminus">-    },</span>
<a href="#l26.26"></a><span id="l26.26" class="difflineminus">-</span>
<a href="#l26.27"></a><span id="l26.27" class="difflineminus">-  displayMessageChanged : function(aFolder, aSubject, aKeywords)</span>
<a href="#l26.28"></a><span id="l26.28" class="difflineminus">-  {</span>
<a href="#l26.29"></a><span id="l26.29" class="difflineminus">-    if (!gDBView.suppressMsgDisplay)</span>
<a href="#l26.30"></a><span id="l26.30" class="difflineminus">-      setTitleFromFolder(aFolder, aSubject);</span>
<a href="#l26.31"></a><span id="l26.31" class="difflineminus">-    ClearPendingReadTimer(); // we are loading / selecting a new message so kill the mark as read timer for the currently viewed message</span>
<a href="#l26.32"></a><span id="l26.32" class="difflineminus">-    gHaveLoadedMessage = true;</span>
<a href="#l26.33"></a><span id="l26.33" class="difflineminus">-    goUpdateCommand(&quot;button_junk&quot;);</span>
<a href="#l26.34"></a><span id="l26.34" class="difflineminus">-  },</span>
<a href="#l26.35"></a><span id="l26.35" class="difflineminus">-</span>
<a href="#l26.36"></a><span id="l26.36" class="difflineminus">-  updateNextMessageAfterDelete : function()</span>
<a href="#l26.37"></a><span id="l26.37" class="difflineminus">-  {</span>
<a href="#l26.38"></a><span id="l26.38" class="difflineminus">-    SetNextMessageAfterDelete();</span>
<a href="#l26.39"></a><span id="l26.39" class="difflineminus">-  },</span>
<a href="#l26.40"></a><span id="l26.40" class="difflineminus">-</span>
<a href="#l26.41"></a><span id="l26.41" class="difflineminus">- /**</span>
<a href="#l26.42"></a><span id="l26.42" class="difflineminus">-  * This method either handles the selection, or sets a timer to handle</span>
<a href="#l26.43"></a><span id="l26.43" class="difflineminus">-  * it once it stops changing.</span>
<a href="#l26.44"></a><span id="l26.44" class="difflineminus">-  */</span>
<a href="#l26.45"></a><span id="l26.45" class="difflineminus">-  showSummary: function(aThis, aSelCount)</span>
<a href="#l26.46"></a><span id="l26.46" class="difflineminus">-  {</span>
<a href="#l26.47"></a><span id="l26.47" class="difflineminus">-    aThis._selectionSummarized = true;</span>
<a href="#l26.48"></a><span id="l26.48" class="difflineminus">-    let selectedMsgUris = GetSelectedMessages();</span>
<a href="#l26.49"></a><span id="l26.49" class="difflineminus">-    let selCount = selectedMsgUris ? selectedMsgUris.length : 0;</span>
<a href="#l26.50"></a><span id="l26.50" class="difflineminus">-    if (selCount &lt; 2) {</span>
<a href="#l26.51"></a><span id="l26.51" class="difflineminus">-      aThis.summarizeSelection();</span>
<a href="#l26.52"></a><span id="l26.52" class="difflineminus">-      return;</span>
<a href="#l26.53"></a><span id="l26.53" class="difflineminus">-    }</span>
<a href="#l26.54"></a><span id="l26.54" class="difflineminus">-    if (selCount != aSelCount) {</span>
<a href="#l26.55"></a><span id="l26.55" class="difflineminus">-      clearTimeout(aThis._selectionTimeout);</span>
<a href="#l26.56"></a><span id="l26.56" class="difflineminus">-      aThis._selectionTimeout = setTimeout(aThis.showSummary, 100, aThis, selCount);</span>
<a href="#l26.57"></a><span id="l26.57" class="difflineminus">-      return;</span>
<a href="#l26.58"></a><span id="l26.58" class="difflineminus">-    }</span>
<a href="#l26.59"></a><span id="l26.59" class="difflineminus">-</span>
<a href="#l26.60"></a><span id="l26.60" class="difflineminus">-    let firstThreadId = messenger.msgHdrFromURI(selectedMsgUris[0]).threadId;</span>
<a href="#l26.61"></a><span id="l26.61" class="difflineminus">-    for (let i = 1; i &lt; selectedMsgUris.length; ++i)</span>
<a href="#l26.62"></a><span id="l26.62" class="difflineminus">-    {</span>
<a href="#l26.63"></a><span id="l26.63" class="difflineminus">-      let msgHdr = messenger.msgHdrFromURI(selectedMsgUris[i]);</span>
<a href="#l26.64"></a><span id="l26.64" class="difflineminus">-      if (msgHdr.threadId != firstThreadId) { // at least more than one thread</span>
<a href="#l26.65"></a><span id="l26.65" class="difflineminus">-        summarizeMultipleSelection(selectedMsgUris);</span>
<a href="#l26.66"></a><span id="l26.66" class="difflineminus">-        return;</span>
<a href="#l26.67"></a><span id="l26.67" class="difflineminus">-      }</span>
<a href="#l26.68"></a><span id="l26.68" class="difflineminus">-    }</span>
<a href="#l26.69"></a><span id="l26.69" class="difflineminus">-    // must be just one thread.</span>
<a href="#l26.70"></a><span id="l26.70" class="difflineminus">-    summarizeThread(selectedMsgUris);</span>
<a href="#l26.71"></a><span id="l26.71" class="difflineminus">-  },</span>
<a href="#l26.72"></a><span id="l26.72" class="difflineminus">-</span>
<a href="#l26.73"></a><span id="l26.73" class="difflineminus">-  summarizeSelection: function()</span>
<a href="#l26.74"></a><span id="l26.74" class="difflineminus">-  {</span>
<a href="#l26.75"></a><span id="l26.75" class="difflineminus">-    // First handle immediately the cases where we're not going to summarize.</span>
<a href="#l26.76"></a><span id="l26.76" class="difflineminus">-    let selectedMsgUris = GetSelectedMessages();</span>
<a href="#l26.77"></a><span id="l26.77" class="difflineminus">-    if (!selectedMsgUris || (selectedMsgUris.length == 1)) {</span>
<a href="#l26.78"></a><span id="l26.78" class="difflineminus">-      pickMessagePane(&quot;singlemessage&quot;);</span>
<a href="#l26.79"></a><span id="l26.79" class="difflineminus">-      this._selectionSummarized = false;</span>
<a href="#l26.80"></a><span id="l26.80" class="difflineminus">-      return false;</span>
<a href="#l26.81"></a><span id="l26.81" class="difflineminus">-    }</span>
<a href="#l26.82"></a><span id="l26.82" class="difflineminus">-</span>
<a href="#l26.83"></a><span id="l26.83" class="difflineminus">-    if (! gPrefBranch.getBoolPref(&quot;mail.operate_on_msgs_in_collapsed_threads&quot;)) {</span>
<a href="#l26.84"></a><span id="l26.84" class="difflineminus">-      ClearMessagePane();</span>
<a href="#l26.85"></a><span id="l26.85" class="difflineminus">-      this._selectionSummarized = false;</span>
<a href="#l26.86"></a><span id="l26.86" class="difflineminus">-      return false;</span>
<a href="#l26.87"></a><span id="l26.87" class="difflineminus">-    }</span>
<a href="#l26.88"></a><span id="l26.88" class="difflineminus">-</span>
<a href="#l26.89"></a><span id="l26.89" class="difflineminus">-    // If we are already summarized, let's make sure the selection count</span>
<a href="#l26.90"></a><span id="l26.90" class="difflineminus">-    // isn't changing rapidly, by checking again in 100 msec.</span>
<a href="#l26.91"></a><span id="l26.91" class="difflineminus">-    if (this._selectionSummarized) {</span>
<a href="#l26.92"></a><span id="l26.92" class="difflineminus">-      clearTimeout(this._selectionTimeout);</span>
<a href="#l26.93"></a><span id="l26.93" class="difflineminus">-      this._selectionTimeout = setTimeout(this.showSummary, 100, this, selectedMsgUris.length);</span>
<a href="#l26.94"></a><span id="l26.94" class="difflineminus">-      return true;</span>
<a href="#l26.95"></a><span id="l26.95" class="difflineminus">-    }</span>
<a href="#l26.96"></a><span id="l26.96" class="difflineminus">-    this.showSummary(this, selectedMsgUris.length);</span>
<a href="#l26.97"></a><span id="l26.97" class="difflineminus">-    return true;</span>
<a href="#l26.98"></a><span id="l26.98" class="difflineminus">-  },</span>
<a href="#l26.99"></a><span id="l26.99" class="difflineminus">-</span>
<a href="#l26.100"></a><span id="l26.100" class="difflineminus">-  QueryInterface : function(iid)</span>
<a href="#l26.101"></a><span id="l26.101" class="difflineminus">-   {</span>
<a href="#l26.102"></a><span id="l26.102" class="difflineminus">-     if (iid.equals(Components.interfaces.nsIMsgDBViewCommandUpdater) ||</span>
<a href="#l26.103"></a><span id="l26.103" class="difflineminus">-         iid.equals(Components.interfaces.nsISupports))</span>
<a href="#l26.104"></a><span id="l26.104" class="difflineminus">-       return this;</span>
<a href="#l26.105"></a><span id="l26.105" class="difflineminus">-</span>
<a href="#l26.106"></a><span id="l26.106" class="difflineminus">-     throw Components.results.NS_NOINTERFACE;</span>
<a href="#l26.107"></a><span id="l26.107" class="difflineminus">-    }</span>
<a href="#l26.108"></a><span id="l26.108" class="difflineminus">-}</span>
<a href="#l26.109"></a><span id="l26.109" class="difflineminus">-</span>
<a href="#l26.110"></a><span id="l26.110"> function HandleColumnClick(columnID)</span>
<a href="#l26.111"></a><span id="l26.111"> {</span>
<a href="#l26.112"></a><span id="l26.112">   const columnMap = {dateCol: 'byDate',</span>
<a href="#l26.113"></a><span id="l26.113">                      receivedCol: 'byReceived',</span>
<a href="#l26.114"></a><span id="l26.114">                      senderCol: 'byAuthor',</span>
<a href="#l26.115"></a><span id="l26.115">                      recipientCol: 'byRecipient',</span>
<a href="#l26.116"></a><span id="l26.116">                      subjectCol: 'bySubject',</span>
<a href="#l26.117"></a><span id="l26.117">                      locationCol: 'byLocation',</span>
<a href="#l26.118"></a><span id="l26.118" class="difflineat">@@ -213,270 +115,172 @@ function HandleColumnClick(columnID)</span>
<a href="#l26.119"></a><span id="l26.119">   if (columnID in columnMap) {</span>
<a href="#l26.120"></a><span id="l26.120">     sortType = columnMap[columnID];</span>
<a href="#l26.121"></a><span id="l26.121">   } else {</span>
<a href="#l26.122"></a><span id="l26.122">     // If the column isn't in the map, check and see if it's a custom column</span>
<a href="#l26.123"></a><span id="l26.123">     try {</span>
<a href="#l26.124"></a><span id="l26.124">       // try to grab the columnHandler (an error is thrown if it does not exist)</span>
<a href="#l26.125"></a><span id="l26.125">       columnHandler = gDBView.getColumnHandler(columnID);</span>
<a href="#l26.126"></a><span id="l26.126"> </span>
<a href="#l26.127"></a><span id="l26.127" class="difflineminus">-      // it exists - save this column ID in the customSortCol property of</span>
<a href="#l26.128"></a><span id="l26.128" class="difflineminus">-      // dbFolderInfo for later use (see nsIMsgDBView.cpp)</span>
<a href="#l26.129"></a><span id="l26.129" class="difflineminus">-      gDBView.db.dBFolderInfo.setProperty('customSortCol', columnID);</span>
<a href="#l26.130"></a><span id="l26.130" class="difflineplus">+      // it exists - set it to be the current custom column</span>
<a href="#l26.131"></a><span id="l26.131" class="difflineplus">+      gDBView.curCustomColumn = columnID;</span>
<a href="#l26.132"></a><span id="l26.132">         </span>
<a href="#l26.133"></a><span id="l26.133">       sortType = &quot;byCustom&quot;;</span>
<a href="#l26.134"></a><span id="l26.134">     } catch(err) {</span>
<a href="#l26.135"></a><span id="l26.135">         dump(&quot;unsupported sort column: &quot; + columnID + &quot; - no custom handler installed. (Error was: &quot; + err + &quot;)\n&quot;);</span>
<a href="#l26.136"></a><span id="l26.136">         return; // bail out</span>
<a href="#l26.137"></a><span id="l26.137">     }</span>
<a href="#l26.138"></a><span id="l26.138">   }</span>
<a href="#l26.139"></a><span id="l26.139"> </span>
<a href="#l26.140"></a><span id="l26.140" class="difflineminus">-  var dbview = GetDBView();</span>
<a href="#l26.141"></a><span id="l26.141" class="difflineplus">+  let viewWrapper = gFolderDisplay.view;</span>
<a href="#l26.142"></a><span id="l26.142">   var simpleColumns = false;</span>
<a href="#l26.143"></a><span id="l26.143">   try {</span>
<a href="#l26.144"></a><span id="l26.144">     simpleColumns = !pref.getBoolPref(&quot;mailnews.thread_pane_column_unthreads&quot;);</span>
<a href="#l26.145"></a><span id="l26.145">   }</span>
<a href="#l26.146"></a><span id="l26.146">   catch (ex) {</span>
<a href="#l26.147"></a><span id="l26.147">   }</span>
<a href="#l26.148"></a><span id="l26.148">   if (sortType == &quot;byThread&quot;) {</span>
<a href="#l26.149"></a><span id="l26.149">     if (simpleColumns)</span>
<a href="#l26.150"></a><span id="l26.150">       MsgToggleThreaded();</span>
<a href="#l26.151"></a><span id="l26.151" class="difflineminus">-    else if (dbview.viewFlags &amp; nsMsgViewFlagsType.kThreadedDisplay)</span>
<a href="#l26.152"></a><span id="l26.152" class="difflineplus">+    else if (viewWrapper.showThreaded)</span>
<a href="#l26.153"></a><span id="l26.153">       MsgReverseSortThreadPane();</span>
<a href="#l26.154"></a><span id="l26.154">     else</span>
<a href="#l26.155"></a><span id="l26.155">       MsgSortByThread();</span>
<a href="#l26.156"></a><span id="l26.156">   }</span>
<a href="#l26.157"></a><span id="l26.157">   else {</span>
<a href="#l26.158"></a><span id="l26.158" class="difflineminus">-    if (!simpleColumns &amp;&amp; (dbview.viewFlags &amp; nsMsgViewFlagsType.kThreadedDisplay)) {</span>
<a href="#l26.159"></a><span id="l26.159" class="difflineminus">-      dbview.viewFlags &amp;= ~nsMsgViewFlagsType.kThreadedDisplay;</span>
<a href="#l26.160"></a><span id="l26.160" class="difflineplus">+    if (!simpleColumns &amp;&amp; viewWrapper.showThreaded) {</span>
<a href="#l26.161"></a><span id="l26.161" class="difflineplus">+      viewWrapper.showUnthreaded = true;</span>
<a href="#l26.162"></a><span id="l26.162">       MsgSortThreadPane(sortType);</span>
<a href="#l26.163"></a><span id="l26.163">     }</span>
<a href="#l26.164"></a><span id="l26.164" class="difflineminus">-    else if (dbview.sortType == nsMsgViewSortType[sortType]) {</span>
<a href="#l26.165"></a><span id="l26.165" class="difflineplus">+    else if (viewWrapper.primarySortType == nsMsgViewSortType[sortType]) {</span>
<a href="#l26.166"></a><span id="l26.166">       MsgReverseSortThreadPane();</span>
<a href="#l26.167"></a><span id="l26.167">     }</span>
<a href="#l26.168"></a><span id="l26.168">     else {</span>
<a href="#l26.169"></a><span id="l26.169">       MsgSortThreadPane(sortType);</span>
<a href="#l26.170"></a><span id="l26.170">     }</span>
<a href="#l26.171"></a><span id="l26.171">   }</span>
<a href="#l26.172"></a><span id="l26.172"> }</span>
<a href="#l26.173"></a><span id="l26.173"> </span>
<a href="#l26.174"></a><span id="l26.174"> function ThreadPaneDoubleClick()</span>
<a href="#l26.175"></a><span id="l26.175"> {</span>
<a href="#l26.176"></a><span id="l26.176">   const nsMsgFolderFlags = Components.interfaces.nsMsgFolderFlags;</span>
<a href="#l26.177"></a><span id="l26.177">   if (IsSpecialFolderSelected(nsMsgFolderFlags.Drafts, true)) {</span>
<a href="#l26.178"></a><span id="l26.178">     MsgComposeDraftMessage();</span>
<a href="#l26.179"></a><span id="l26.179">   }</span>
<a href="#l26.180"></a><span id="l26.180">   else if(IsSpecialFolderSelected(nsMsgFolderFlags.Templates, true)) {</span>
<a href="#l26.181"></a><span id="l26.181" class="difflineminus">-    var loadedFolder = GetLoadedMsgFolder();</span>
<a href="#l26.182"></a><span id="l26.182" class="difflineminus">-    var messageArray = GetSelectedMessages();</span>
<a href="#l26.183"></a><span id="l26.183" class="difflineminus">-</span>
<a href="#l26.184"></a><span id="l26.184">     ComposeMessage(Components.interfaces.nsIMsgCompType.Template,</span>
<a href="#l26.185"></a><span id="l26.185">                    Components.interfaces.nsIMsgCompFormat.Default,</span>
<a href="#l26.186"></a><span id="l26.186" class="difflineminus">-                   loadedFolder, messageArray);</span>
<a href="#l26.187"></a><span id="l26.187" class="difflineplus">+                   gFolderDisplay.displayedFolder,</span>
<a href="#l26.188"></a><span id="l26.188" class="difflineplus">+                   gFolderDisplay.selectedMessageUris);</span>
<a href="#l26.189"></a><span id="l26.189">   }</span>
<a href="#l26.190"></a><span id="l26.190">   else {</span>
<a href="#l26.191"></a><span id="l26.191">     MsgOpenSelectedMessages();</span>
<a href="#l26.192"></a><span id="l26.192">   }</span>
<a href="#l26.193"></a><span id="l26.193"> }</span>
<a href="#l26.194"></a><span id="l26.194"> </span>
<a href="#l26.195"></a><span id="l26.195"> function ThreadPaneKeyPress(event)</span>
<a href="#l26.196"></a><span id="l26.196"> {</span>
<a href="#l26.197"></a><span id="l26.197">   if (event.keyCode == KeyEvent.DOM_VK_RETURN)</span>
<a href="#l26.198"></a><span id="l26.198">     ThreadPaneDoubleClick();</span>
<a href="#l26.199"></a><span id="l26.199"> }</span>
<a href="#l26.200"></a><span id="l26.200"> </span>
<a href="#l26.201"></a><span id="l26.201"> function MsgSortByThread()</span>
<a href="#l26.202"></a><span id="l26.202"> {</span>
<a href="#l26.203"></a><span id="l26.203" class="difflineminus">-  var dbview = GetDBView();</span>
<a href="#l26.204"></a><span id="l26.204" class="difflineminus">-  dbview.viewFlags |= nsMsgViewFlagsType.kThreadedDisplay;</span>
<a href="#l26.205"></a><span id="l26.205" class="difflineminus">-  dbview.viewFlags &amp;= ~nsMsgViewFlagsType.kGroupBySort;</span>
<a href="#l26.206"></a><span id="l26.206" class="difflineplus">+  gFolderDisplay.view.showThreaded = true;</span>
<a href="#l26.207"></a><span id="l26.207">   MsgSortThreadPane('byDate');</span>
<a href="#l26.208"></a><span id="l26.208"> }</span>
<a href="#l26.209"></a><span id="l26.209"> </span>
<a href="#l26.210"></a><span id="l26.210"> function MsgSortThreadPane(sortName)</span>
<a href="#l26.211"></a><span id="l26.211"> {</span>
<a href="#l26.212"></a><span id="l26.212">   var sortType = nsMsgViewSortType[sortName];</span>
<a href="#l26.213"></a><span id="l26.213" class="difflineminus">-  var dbview = GetDBView();</span>
<a href="#l26.214"></a><span id="l26.214" class="difflineminus">-</span>
<a href="#l26.215"></a><span id="l26.215" class="difflineminus">-  // turn off grouping</span>
<a href="#l26.216"></a><span id="l26.216" class="difflineminus">-  dbview.viewFlags &amp;= ~nsMsgViewFlagsType.kGroupBySort;</span>
<a href="#l26.217"></a><span id="l26.217" class="difflineminus">-</span>
<a href="#l26.218"></a><span id="l26.218" class="difflineminus">-  dbview.sort(sortType, nsMsgViewSortOrder.ascending);</span>
<a href="#l26.219"></a><span id="l26.219" class="difflineminus">-  UpdateSortIndicators(sortType, nsMsgViewSortOrder.ascending);</span>
<a href="#l26.220"></a><span id="l26.220" class="difflineplus">+  // legacy behavior dictates we un-group-by-sort if we were.  this probably</span>
<a href="#l26.221"></a><span id="l26.221" class="difflineplus">+  //  deserves a UX call...</span>
<a href="#l26.222"></a><span id="l26.222" class="difflineplus">+  gFolderDisplay.view.showGroupedBySort = false;</span>
<a href="#l26.223"></a><span id="l26.223" class="difflineplus">+  gFolderDisplay.view.sort(sortType, nsMsgViewSortOrder.ascending)</span>
<a href="#l26.224"></a><span id="l26.224"> }</span>
<a href="#l26.225"></a><span id="l26.225"> </span>
<a href="#l26.226"></a><span id="l26.226"> function MsgReverseSortThreadPane()</span>
<a href="#l26.227"></a><span id="l26.227"> {</span>
<a href="#l26.228"></a><span id="l26.228" class="difflineminus">-  var dbview = GetDBView();</span>
<a href="#l26.229"></a><span id="l26.229" class="difflineminus">-  if (dbview.sortOrder == nsMsgViewSortOrder.ascending) {</span>
<a href="#l26.230"></a><span id="l26.230" class="difflineminus">-    MsgSortDescending();</span>
<a href="#l26.231"></a><span id="l26.231" class="difflineminus">-  }</span>
<a href="#l26.232"></a><span id="l26.232" class="difflineminus">-  else {</span>
<a href="#l26.233"></a><span id="l26.233" class="difflineminus">-    MsgSortAscending();</span>
<a href="#l26.234"></a><span id="l26.234" class="difflineminus">-  }</span>
<a href="#l26.235"></a><span id="l26.235" class="difflineplus">+  if (gFolderDisplay.view.isSortedAscending)</span>
<a href="#l26.236"></a><span id="l26.236" class="difflineplus">+    gFolderDisplay.view.sortDescending();</span>
<a href="#l26.237"></a><span id="l26.237" class="difflineplus">+  else</span>
<a href="#l26.238"></a><span id="l26.238" class="difflineplus">+    gFolderDisplay.view.sortAscending();</span>
<a href="#l26.239"></a><span id="l26.239"> }</span>
<a href="#l26.240"></a><span id="l26.240"> </span>
<a href="#l26.241"></a><span id="l26.241"> function MsgToggleThreaded()</span>
<a href="#l26.242"></a><span id="l26.242"> {</span>
<a href="#l26.243"></a><span id="l26.243" class="difflineminus">-    var dbview = GetDBView();</span>
<a href="#l26.244"></a><span id="l26.244" class="difflineminus">-    var newViewFlags = dbview.viewFlags ^ nsMsgViewFlagsType.kThreadedDisplay;</span>
<a href="#l26.245"></a><span id="l26.245" class="difflineminus">-    newViewFlags &amp;= ~nsMsgViewFlagsType.kGroupBySort;</span>
<a href="#l26.246"></a><span id="l26.246" class="difflineminus">-    dbview.viewFlags = newViewFlags;</span>
<a href="#l26.247"></a><span id="l26.247" class="difflineminus">-</span>
<a href="#l26.248"></a><span id="l26.248" class="difflineminus">-    dbview.sort(dbview.sortType, dbview.sortOrder);</span>
<a href="#l26.249"></a><span id="l26.249" class="difflineminus">-    UpdateSortIndicators(dbview.sortType, dbview.sortOrder);</span>
<a href="#l26.250"></a><span id="l26.250" class="difflineplus">+  if (gFolderDisplay.view.showThreaded)</span>
<a href="#l26.251"></a><span id="l26.251" class="difflineplus">+    gFolderDisplay.view.showUnthreaded = true;</span>
<a href="#l26.252"></a><span id="l26.252" class="difflineplus">+  else</span>
<a href="#l26.253"></a><span id="l26.253" class="difflineplus">+    gFolderDisplay.view.showThreaded = true;</span>
<a href="#l26.254"></a><span id="l26.254"> }</span>
<a href="#l26.255"></a><span id="l26.255"> </span>
<a href="#l26.256"></a><span id="l26.256"> function MsgSortThreaded()</span>
<a href="#l26.257"></a><span id="l26.257"> {</span>
<a href="#l26.258"></a><span id="l26.258" class="difflineminus">-    var dbview = GetDBView();</span>
<a href="#l26.259"></a><span id="l26.259" class="difflineminus">-    var viewFlags = dbview.viewFlags;</span>
<a href="#l26.260"></a><span id="l26.260" class="difflineminus">-    let wasGrouped = viewFlags &amp; nsMsgViewFlagsType.kGroupBySort;</span>
<a href="#l26.261"></a><span id="l26.261" class="difflineminus">-    dbview.viewFlags &amp;= ~nsMsgViewFlagsType.kGroupBySort;</span>
<a href="#l26.262"></a><span id="l26.262" class="difflineminus">-    // if we were grouped, and not a saved search, just rebuild the view</span>
<a href="#l26.263"></a><span id="l26.263" class="difflineminus">-    if (wasGrouped &amp;&amp; !(gMsgFolderSelected.flags &amp; </span>
<a href="#l26.264"></a><span id="l26.264" class="difflineminus">-                       Components.interfaces.nsMsgFolderFlags.Virtual))</span>
<a href="#l26.265"></a><span id="l26.265" class="difflineminus">-      SwitchView(&quot;cmd_viewAllMsgs&quot;);</span>
<a href="#l26.266"></a><span id="l26.266" class="difflineminus">-    // Toggle if not already threaded.</span>
<a href="#l26.267"></a><span id="l26.267" class="difflineminus">-    else if ((viewFlags &amp; nsMsgViewFlagsType.kThreadedDisplay) == 0)</span>
<a href="#l26.268"></a><span id="l26.268" class="difflineminus">-        MsgToggleThreaded();</span>
<a href="#l26.269"></a><span id="l26.269" class="difflineplus">+  gFolderDisplay.view.showThreaded = true;</span>
<a href="#l26.270"></a><span id="l26.270"> }</span>
<a href="#l26.271"></a><span id="l26.271"> </span>
<a href="#l26.272"></a><span id="l26.272"> function MsgGroupBySort()</span>
<a href="#l26.273"></a><span id="l26.273"> {</span>
<a href="#l26.274"></a><span id="l26.274" class="difflineminus">-  var dbview = GetDBView();</span>
<a href="#l26.275"></a><span id="l26.275" class="difflineminus">-  var viewFlags = dbview.viewFlags;</span>
<a href="#l26.276"></a><span id="l26.276" class="difflineminus">-  var sortOrder = dbview.sortOrder;</span>
<a href="#l26.277"></a><span id="l26.277" class="difflineminus">-  var sortType = dbview.sortType;</span>
<a href="#l26.278"></a><span id="l26.278" class="difflineminus">-  var count = new Object;</span>
<a href="#l26.279"></a><span id="l26.279" class="difflineminus">-  var msgFolder = dbview.msgFolder;</span>
<a href="#l26.280"></a><span id="l26.280" class="difflineminus">-</span>
<a href="#l26.281"></a><span id="l26.281" class="difflineminus">-  var sortTypeSupportsGrouping = (sortType == nsMsgViewSortType.byAuthor </span>
<a href="#l26.282"></a><span id="l26.282" class="difflineminus">-         || sortType == nsMsgViewSortType.byDate || sortType == nsMsgViewSortType.byReceived || sortType == nsMsgViewSortType.byPriority</span>
<a href="#l26.283"></a><span id="l26.283" class="difflineminus">-         || sortType == nsMsgViewSortType.bySubject || sortType == nsMsgViewSortType.byTags</span>
<a href="#l26.284"></a><span id="l26.284" class="difflineminus">-         || sortType == nsMsgViewSortType.byStatus  || sortType == nsMsgViewSortType.byRecipient</span>
<a href="#l26.285"></a><span id="l26.285" class="difflineminus">-         || sortType == nsMsgViewSortType.byAccount || sortType == nsMsgViewSortType.byFlagged</span>
<a href="#l26.286"></a><span id="l26.286" class="difflineminus">-         || sortType == nsMsgViewSortType.byAttachments);</span>
<a href="#l26.287"></a><span id="l26.287" class="difflineminus">-</span>
<a href="#l26.288"></a><span id="l26.288" class="difflineminus">-  if (!sortTypeSupportsGrouping)</span>
<a href="#l26.289"></a><span id="l26.289" class="difflineminus">-    return; // we shouldn't be trying to group something we don't support grouping for...</span>
<a href="#l26.290"></a><span id="l26.290" class="difflineminus">-</span>
<a href="#l26.291"></a><span id="l26.291" class="difflineminus">-  viewFlags |= nsMsgViewFlagsType.kThreadedDisplay | nsMsgViewFlagsType.kGroupBySort;</span>
<a href="#l26.292"></a><span id="l26.292" class="difflineminus">-  if (gDBView &amp;&amp;</span>
<a href="#l26.293"></a><span id="l26.293" class="difflineminus">-      gMsgFolderSelected.flags &amp; Components.interfaces.nsMsgFolderFlags.Virtual)</span>
<a href="#l26.294"></a><span id="l26.294" class="difflineminus">-  {</span>
<a href="#l26.295"></a><span id="l26.295" class="difflineminus">-    gDBView.viewFlags = viewFlags;</span>
<a href="#l26.296"></a><span id="l26.296" class="difflineminus">-    UpdateSortIndicators(sortType, nsMsgViewSortOrder.ascending);</span>
<a href="#l26.297"></a><span id="l26.297" class="difflineminus">-    return;</span>
<a href="#l26.298"></a><span id="l26.298" class="difflineminus">-  }</span>
<a href="#l26.299"></a><span id="l26.299" class="difflineminus">-  // null this out, so we don't try sort.</span>
<a href="#l26.300"></a><span id="l26.300" class="difflineminus">-  if (gDBView) {</span>
<a href="#l26.301"></a><span id="l26.301" class="difflineminus">-    gDBView.close();</span>
<a href="#l26.302"></a><span id="l26.302" class="difflineminus">-    gDBView = null;</span>
<a href="#l26.303"></a><span id="l26.303" class="difflineminus">-  }</span>
<a href="#l26.304"></a><span id="l26.304" class="difflineminus">-  gDBView = Components.classes[&quot;@mozilla.org/messenger/msgdbview;1?type=group&quot;]</span>
<a href="#l26.305"></a><span id="l26.305" class="difflineminus">-                                .createInstance(Components.interfaces.nsIMsgDBView);</span>
<a href="#l26.306"></a><span id="l26.306" class="difflineminus">-</span>
<a href="#l26.307"></a><span id="l26.307" class="difflineminus">-  if (!gThreadPaneCommandUpdater)</span>
<a href="#l26.308"></a><span id="l26.308" class="difflineminus">-    gThreadPaneCommandUpdater = new nsMsgDBViewCommandUpdater();</span>
<a href="#l26.309"></a><span id="l26.309" class="difflineminus">-</span>
<a href="#l26.310"></a><span id="l26.310" class="difflineminus">-</span>
<a href="#l26.311"></a><span id="l26.311" class="difflineminus">-  gDBView.init(messenger, msgWindow, gThreadPaneCommandUpdater);</span>
<a href="#l26.312"></a><span id="l26.312" class="difflineminus">-  gDBView.open(msgFolder, sortType, sortOrder, viewFlags, count);</span>
<a href="#l26.313"></a><span id="l26.313" class="difflineminus">-  RerootThreadPane();</span>
<a href="#l26.314"></a><span id="l26.314" class="difflineminus">-  UpdateSortIndicators(sortType, nsMsgViewSortOrder.ascending);</span>
<a href="#l26.315"></a><span id="l26.315" class="difflineminus">-  Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l26.316"></a><span id="l26.316" class="difflineminus">-            .getService(Components.interfaces.nsIObserverService)</span>
<a href="#l26.317"></a><span id="l26.317" class="difflineminus">-            .notifyObservers(msgFolder, &quot;MsgCreateDBView&quot;,</span>
<a href="#l26.318"></a><span id="l26.318" class="difflineminus">-             Components.interfaces.nsMsgViewType.eShowAllThreads + &quot;:&quot; + viewFlags);</span>
<a href="#l26.319"></a><span id="l26.319" class="difflineplus">+  gFolderDisplay.view.showGroupedBySort = true;</span>
<a href="#l26.320"></a><span id="l26.320"> }</span>
<a href="#l26.321"></a><span id="l26.321"> </span>
<a href="#l26.322"></a><span id="l26.322"> function MsgSortUnthreaded()</span>
<a href="#l26.323"></a><span id="l26.323"> {</span>
<a href="#l26.324"></a><span id="l26.324" class="difflineminus">-    // Toggle if not already unthreaded.</span>
<a href="#l26.325"></a><span id="l26.325" class="difflineminus">-    if ((GetDBView().viewFlags &amp; nsMsgViewFlagsType.kThreadedDisplay) != 0)</span>
<a href="#l26.326"></a><span id="l26.326" class="difflineminus">-        MsgToggleThreaded();</span>
<a href="#l26.327"></a><span id="l26.327" class="difflineplus">+  gFolderDisplay.view.showUnthreaded = true;</span>
<a href="#l26.328"></a><span id="l26.328"> }</span>
<a href="#l26.329"></a><span id="l26.329"> </span>
<a href="#l26.330"></a><span id="l26.330"> function MsgSortAscending()</span>
<a href="#l26.331"></a><span id="l26.331"> {</span>
<a href="#l26.332"></a><span id="l26.332" class="difflineminus">-  var dbview = GetDBView();</span>
<a href="#l26.333"></a><span id="l26.333" class="difflineminus">-  dbview.sort(dbview.sortType, nsMsgViewSortOrder.ascending);</span>
<a href="#l26.334"></a><span id="l26.334" class="difflineminus">-  UpdateSortIndicators(dbview.sortType, nsMsgViewSortOrder.ascending);</span>
<a href="#l26.335"></a><span id="l26.335" class="difflineplus">+  gFolderDisplay.view.sortAscending();</span>
<a href="#l26.336"></a><span id="l26.336"> }</span>
<a href="#l26.337"></a><span id="l26.337"> </span>
<a href="#l26.338"></a><span id="l26.338"> function MsgSortDescending()</span>
<a href="#l26.339"></a><span id="l26.339"> {</span>
<a href="#l26.340"></a><span id="l26.340" class="difflineminus">-  var dbview = GetDBView();</span>
<a href="#l26.341"></a><span id="l26.341" class="difflineminus">-  dbview.sort(dbview.sortType, nsMsgViewSortOrder.descending);</span>
<a href="#l26.342"></a><span id="l26.342" class="difflineminus">-  UpdateSortIndicators(dbview.sortType, nsMsgViewSortOrder.descending);</span>
<a href="#l26.343"></a><span id="l26.343" class="difflineplus">+  gFolderDisplay.view.sortDescending();</span>
<a href="#l26.344"></a><span id="l26.344"> }</span>
<a href="#l26.345"></a><span id="l26.345"> </span>
<a href="#l26.346"></a><span id="l26.346" class="difflineminus">-function groupedBySortUsingDummyRow()</span>
<a href="#l26.347"></a><span id="l26.347" class="difflineminus">-{</span>
<a href="#l26.348"></a><span id="l26.348" class="difflineminus">-  return (gDBView.viewFlags &amp; nsMsgViewFlagsType.kGroupBySort) &amp;&amp; </span>
<a href="#l26.349"></a><span id="l26.349" class="difflineminus">-         (gDBView.sortType != nsMsgViewSortType.bySubject);</span>
<a href="#l26.350"></a><span id="l26.350" class="difflineminus">-}</span>
<a href="#l26.351"></a><span id="l26.351" class="difflineminus">-</span>
<a href="#l26.352"></a><span id="l26.352" class="difflineplus">+// XXX this should probably migrate into FolderDisplayWidget, or whatever</span>
<a href="#l26.353"></a><span id="l26.353" class="difflineplus">+//  FolderDisplayWidget ends up using if it refactors column management out.</span>
<a href="#l26.354"></a><span id="l26.354"> function UpdateSortIndicators(sortType, sortOrder)</span>
<a href="#l26.355"></a><span id="l26.355"> {</span>
<a href="#l26.356"></a><span id="l26.356">   // Remove the sort indicator from all the columns</span>
<a href="#l26.357"></a><span id="l26.357">   var treeColumns = document.getElementById('threadCols').childNodes;</span>
<a href="#l26.358"></a><span id="l26.358">   for (var i = 0; i &lt; treeColumns.length; i++)</span>
<a href="#l26.359"></a><span id="l26.359" class="difflineminus">-    treeColumns[i].removeAttribute('sortDirection');</span>
<a href="#l26.360"></a><span id="l26.360" class="difflineplus">+    treeColumns[i].removeAttribute(&quot;sortDirection&quot;);</span>
<a href="#l26.361"></a><span id="l26.361"> </span>
<a href="#l26.362"></a><span id="l26.362">   // show the twisties if the view is threaded</span>
<a href="#l26.363"></a><span id="l26.363">   var threadCol = document.getElementById(&quot;threadCol&quot;);</span>
<a href="#l26.364"></a><span id="l26.364" class="difflineplus">+  var subjectCol = document.getElementById(&quot;subjectCol&quot;);</span>
<a href="#l26.365"></a><span id="l26.365">   var sortedColumn;</span>
<a href="#l26.366"></a><span id="l26.366">   // set the sort indicator on the column we are sorted by</span>
<a href="#l26.367"></a><span id="l26.367">   var colID = ConvertSortTypeToColumnID(sortType);</span>
<a href="#l26.368"></a><span id="l26.368">   if (colID)</span>
<a href="#l26.369"></a><span id="l26.369">     sortedColumn = document.getElementById(colID);</span>
<a href="#l26.370"></a><span id="l26.370"> </span>
<a href="#l26.371"></a><span id="l26.371" class="difflineminus">-  var dbview = GetDBView();</span>
<a href="#l26.372"></a><span id="l26.372" class="difflineminus">-  var currCol = dbview.viewFlags &amp; nsMsgViewFlagsType.kGroupBySort </span>
<a href="#l26.373"></a><span id="l26.373" class="difflineminus">-    ? sortedColumn : document.getElementById(&quot;subjectCol&quot;);</span>
<a href="#l26.374"></a><span id="l26.374" class="difflineminus">-</span>
<a href="#l26.375"></a><span id="l26.375" class="difflineminus">-  if (dbview.viewFlags &amp; nsMsgViewFlagsType.kGroupBySort)</span>
<a href="#l26.376"></a><span id="l26.376" class="difflineminus">-  {</span>
<a href="#l26.377"></a><span id="l26.377" class="difflineminus">-    var threadTree = document.getElementById(&quot;threadTree&quot;);  </span>
<a href="#l26.378"></a><span id="l26.378" class="difflineminus">-    var subjectCol = document.getElementById(&quot;subjectCol&quot;);</span>
<a href="#l26.379"></a><span id="l26.379" class="difflineplus">+  var viewWrapper = gFolderDisplay.view;</span>
<a href="#l26.380"></a><span id="l26.380"> </span>
<a href="#l26.381"></a><span id="l26.381" class="difflineminus">-    if (groupedBySortUsingDummyRow())</span>
<a href="#l26.382"></a><span id="l26.382" class="difflineminus">-    {</span>
<a href="#l26.383"></a><span id="l26.383" class="difflineminus">-      currCol.removeAttribute(&quot;primary&quot;);</span>
<a href="#l26.384"></a><span id="l26.384" class="difflineminus">-      subjectCol.setAttribute(&quot;primary&quot;, &quot;true&quot;);</span>
<a href="#l26.385"></a><span id="l26.385" class="difflineminus">-    }</span>
<a href="#l26.386"></a><span id="l26.386" class="difflineminus">-</span>
<a href="#l26.387"></a><span id="l26.387" class="difflineminus">-    // hide the threaded column when in grouped view since you can't do </span>
<a href="#l26.388"></a><span id="l26.388" class="difflineminus">-    // threads inside of a group.</span>
<a href="#l26.389"></a><span id="l26.389" class="difflineminus">-    document.getElementById(&quot;threadCol&quot;).collapsed = true;</span>
<a href="#l26.390"></a><span id="l26.390" class="difflineminus">-  }</span>
<a href="#l26.391"></a><span id="l26.391" class="difflineplus">+  // the thread column is not visible when we are grouped by sort</span>
<a href="#l26.392"></a><span id="l26.392" class="difflineplus">+  document.getElementById(&quot;threadCol&quot;).collapsed = viewWrapper.showGroupedBySort;</span>
<a href="#l26.393"></a><span id="l26.393"> </span>
<a href="#l26.394"></a><span id="l26.394" class="difflineminus">-  // clear primary attribute from group column if going to a non-grouped view.</span>
<a href="#l26.395"></a><span id="l26.395" class="difflineminus">-  if (!(dbview.viewFlags &amp; nsMsgViewFlagsType.kGroupBySort))</span>
<a href="#l26.396"></a><span id="l26.396" class="difflineminus">-    document.getElementById(&quot;threadCol&quot;).collapsed = false;</span>
<a href="#l26.397"></a><span id="l26.397" class="difflineplus">+  // show twisties only when grouping or threading</span>
<a href="#l26.398"></a><span id="l26.398" class="difflineplus">+  if (viewWrapper.showGroupedBySort || viewWrapper.showThreaded)</span>
<a href="#l26.399"></a><span id="l26.399" class="difflineplus">+    subjectCol.setAttribute(&quot;primary&quot;, &quot;true&quot;);</span>
<a href="#l26.400"></a><span id="l26.400" class="difflineplus">+  else</span>
<a href="#l26.401"></a><span id="l26.401" class="difflineplus">+    subjectCol.removeAttribute(&quot;primary&quot;);</span>
<a href="#l26.402"></a><span id="l26.402"> </span>
<a href="#l26.403"></a><span id="l26.403" class="difflineminus">-  if ((dbview.viewFlags &amp; nsMsgViewFlagsType.kThreadedDisplay) &amp;&amp; !groupedBySortUsingDummyRow()) {</span>
<a href="#l26.404"></a><span id="l26.404" class="difflineplus">+  // If threading, set the sort direction on the thread column which causes it</span>
<a href="#l26.405"></a><span id="l26.405" class="difflineplus">+  //  to be able to 'light up' or otherwise indicate threading is active.</span>
<a href="#l26.406"></a><span id="l26.406" class="difflineplus">+  if (viewWrapper.showThreaded)</span>
<a href="#l26.407"></a><span id="l26.407">     threadCol.setAttribute(&quot;sortDirection&quot;, &quot;ascending&quot;);</span>
<a href="#l26.408"></a><span id="l26.408" class="difflineminus">-    currCol.setAttribute(&quot;primary&quot;, &quot;true&quot;);</span>
<a href="#l26.409"></a><span id="l26.409" class="difflineminus">-  }</span>
<a href="#l26.410"></a><span id="l26.410" class="difflineminus">-  else {</span>
<a href="#l26.411"></a><span id="l26.411" class="difflineminus">-    threadCol.removeAttribute(&quot;sortDirection&quot;);</span>
<a href="#l26.412"></a><span id="l26.412" class="difflineminus">-    currCol.removeAttribute(&quot;primary&quot;);</span>
<a href="#l26.413"></a><span id="l26.413" class="difflineminus">-  }</span>
<a href="#l26.414"></a><span id="l26.414"> </span>
<a href="#l26.415"></a><span id="l26.415" class="difflineminus">-  if (sortedColumn) {</span>
<a href="#l26.416"></a><span id="l26.416" class="difflineminus">-    if (sortOrder == nsMsgViewSortOrder.ascending) {</span>
<a href="#l26.417"></a><span id="l26.417" class="difflineminus">-      sortedColumn.setAttribute(&quot;sortDirection&quot;,&quot;ascending&quot;);</span>
<a href="#l26.418"></a><span id="l26.418" class="difflineminus">-    }</span>
<a href="#l26.419"></a><span id="l26.419" class="difflineminus">-    else {</span>
<a href="#l26.420"></a><span id="l26.420" class="difflineminus">-      sortedColumn.setAttribute(&quot;sortDirection&quot;,&quot;descending&quot;);</span>
<a href="#l26.421"></a><span id="l26.421" class="difflineminus">-    }</span>
<a href="#l26.422"></a><span id="l26.422" class="difflineminus">-  }</span>
<a href="#l26.423"></a><span id="l26.423" class="difflineplus">+  if (sortedColumn)</span>
<a href="#l26.424"></a><span id="l26.424" class="difflineplus">+    sortedColumn.setAttribute(&quot;sortDirection&quot;,</span>
<a href="#l26.425"></a><span id="l26.425" class="difflineplus">+                              sortOrder == nsMsgViewSortOrder.ascending ?</span>
<a href="#l26.426"></a><span id="l26.426" class="difflineplus">+                                &quot;ascending&quot; : &quot;descending&quot;);</span>
<a href="#l26.427"></a><span id="l26.427"> }</span>
<a href="#l26.428"></a><span id="l26.428"> </span>
<a href="#l26.429"></a><span id="l26.429"> function IsSpecialFolderSelected(flags, checkAncestors)</span>
<a href="#l26.430"></a><span id="l26.430"> {</span>
<a href="#l26.431"></a><span id="l26.431">   var selectedFolder = GetThreadPaneFolder();</span>
<a href="#l26.432"></a><span id="l26.432">   return IsSpecialFolder(selectedFolder, flags, checkAncestors);</span>
<a href="#l26.433"></a><span id="l26.433"> }</span>
<a href="#l26.434"></a><span id="l26.434"> </span>
<a href="#l26.435"></a><span id="l26.435" class="difflineat">@@ -490,37 +294,16 @@ function GetThreadPaneFolder()</span>
<a href="#l26.436"></a><span id="l26.436">   try {</span>
<a href="#l26.437"></a><span id="l26.437">     return gDBView.msgFolder;</span>
<a href="#l26.438"></a><span id="l26.438">   }</span>
<a href="#l26.439"></a><span id="l26.439">   catch (ex) {</span>
<a href="#l26.440"></a><span id="l26.440">     return null;</span>
<a href="#l26.441"></a><span id="l26.441">   }</span>
<a href="#l26.442"></a><span id="l26.442"> }</span>
<a href="#l26.443"></a><span id="l26.443"> </span>
<a href="#l26.444"></a><span id="l26.444" class="difflineminus">-function EnsureRowInThreadTreeIsVisible(index)</span>
<a href="#l26.445"></a><span id="l26.445" class="difflineminus">-{</span>
<a href="#l26.446"></a><span id="l26.446" class="difflineminus">-  if (index &lt; 0)</span>
<a href="#l26.447"></a><span id="l26.447" class="difflineminus">-    return;</span>
<a href="#l26.448"></a><span id="l26.448" class="difflineminus">-</span>
<a href="#l26.449"></a><span id="l26.449" class="difflineminus">-  var tree = GetThreadTree();</span>
<a href="#l26.450"></a><span id="l26.450" class="difflineminus">-  tree.treeBoxObject.ensureRowIsVisible(index); </span>
<a href="#l26.451"></a><span id="l26.451" class="difflineminus">-}</span>
<a href="#l26.452"></a><span id="l26.452" class="difflineminus">-</span>
<a href="#l26.453"></a><span id="l26.453" class="difflineminus">-function RerootThreadPane()</span>
<a href="#l26.454"></a><span id="l26.454" class="difflineminus">-{</span>
<a href="#l26.455"></a><span id="l26.455" class="difflineminus">-  SetNewsFolderColumns();</span>
<a href="#l26.456"></a><span id="l26.456" class="difflineminus">-</span>
<a href="#l26.457"></a><span id="l26.457" class="difflineminus">-  var treeView = gDBView.QueryInterface(Components.interfaces.nsITreeView);</span>
<a href="#l26.458"></a><span id="l26.458" class="difflineminus">-  if (treeView)</span>
<a href="#l26.459"></a><span id="l26.459" class="difflineminus">-  {</span>
<a href="#l26.460"></a><span id="l26.460" class="difflineminus">-    var tree = GetThreadTree();</span>
<a href="#l26.461"></a><span id="l26.461" class="difflineminus">-    tree.boxObject.QueryInterface(Components.interfaces.nsITreeBoxObject).view = treeView;</span>
<a href="#l26.462"></a><span id="l26.462" class="difflineminus">-  }</span>
<a href="#l26.463"></a><span id="l26.463" class="difflineminus">-}</span>
<a href="#l26.464"></a><span id="l26.464" class="difflineminus">-</span>
<a href="#l26.465"></a><span id="l26.465"> function ThreadPaneOnLoad()</span>
<a href="#l26.466"></a><span id="l26.466"> {</span>
<a href="#l26.467"></a><span id="l26.467">   var tree = GetThreadTree();</span>
<a href="#l26.468"></a><span id="l26.468">   // We won't have the tree if we're in a message window, so exit silently</span>
<a href="#l26.469"></a><span id="l26.469">   if (!tree)</span>
<a href="#l26.470"></a><span id="l26.470">     return;</span>
<a href="#l26.471"></a><span id="l26.471"> </span>
<a href="#l26.472"></a><span id="l26.472">   tree.addEventListener(&quot;click&quot;,ThreadPaneOnClick,true);</span>
<a href="#l26.473"></a><span id="l26.473" class="difflineat">@@ -533,13 +316,12 @@ function ThreadPaneOnLoad()</span>
<a href="#l26.474"></a><span id="l26.474">   tree.addEventListener(&quot;mousedown&quot;,TreeOnMouseDown,true);</span>
<a href="#l26.475"></a><span id="l26.475">   let delay = pref.getIntPref(&quot;mailnews.threadpane_select_delay&quot;);</span>
<a href="#l26.476"></a><span id="l26.476">   document.getElementById(&quot;threadTree&quot;)._selectDelay = delay;</span>
<a href="#l26.477"></a><span id="l26.477"> }</span>
<a href="#l26.478"></a><span id="l26.478"> </span>
<a href="#l26.479"></a><span id="l26.479"> function ThreadPaneSelectionChanged()</span>
<a href="#l26.480"></a><span id="l26.480"> {</span>
<a href="#l26.481"></a><span id="l26.481">   UpdateStatusMessageCounts(gMsgFolderSelected);</span>
<a href="#l26.482"></a><span id="l26.482" class="difflineminus">-  if (!gRightMouseButtonDown)</span>
<a href="#l26.483"></a><span id="l26.483" class="difflineminus">-    GetThreadTree().view.selectionChanged();</span>
<a href="#l26.484"></a><span id="l26.484" class="difflineplus">+  GetThreadTree().view.selectionChanged();</span>
<a href="#l26.485"></a><span id="l26.485"> }</span>
<a href="#l26.486"></a><span id="l26.486"> </span>
<a href="#l26.487"></a><span id="l26.487"> addEventListener(&quot;load&quot;,ThreadPaneOnLoad,true);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mail/base/content/widgetglue.js</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mail/base/content/widgetglue.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -44,16 +44,21 @@</span>
<a href="#l27.4"></a><span id="l27.4">  * and then calls a function/command in commandglue</span>
<a href="#l27.5"></a><span id="l27.5">  */</span>
<a href="#l27.6"></a><span id="l27.6"> </span>
<a href="#l27.7"></a><span id="l27.7"> //The eventual goal is for this file to go away and its contents to be brought into</span>
<a href="#l27.8"></a><span id="l27.8"> //mailWindowOverlay.js.  This is currently being done.</span>
<a href="#l27.9"></a><span id="l27.9"> </span>
<a href="#l27.10"></a><span id="l27.10"> function MsgToggleMessagePane()</span>
<a href="#l27.11"></a><span id="l27.11"> {</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineplus">+  // Bail without doing anything if we are not a folder tab.</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+  let currentTabInfo = document.getElementById(&quot;tabmail&quot;).currentTabInfo;</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineplus">+  if (currentTabInfo.mode.name != &quot;folder&quot;)</span>
<a href="#l27.15"></a><span id="l27.15" class="difflineplus">+    return;</span>
<a href="#l27.16"></a><span id="l27.16" class="difflineplus">+</span>
<a href="#l27.17"></a><span id="l27.17">   var splitter = document.getElementById(&quot;threadpane-splitter&quot;);</span>
<a href="#l27.18"></a><span id="l27.18">   var state = splitter.getAttribute(&quot;state&quot;);</span>
<a href="#l27.19"></a><span id="l27.19">   if (state == &quot;collapsed&quot;)</span>
<a href="#l27.20"></a><span id="l27.20">     splitter.setAttribute(&quot;state&quot;, null);</span>
<a href="#l27.21"></a><span id="l27.21">   else</span>
<a href="#l27.22"></a><span id="l27.22">     splitter.setAttribute(&quot;state&quot;, &quot;collapsed&quot;)</span>
<a href="#l27.23"></a><span id="l27.23"> </span>
<a href="#l27.24"></a><span id="l27.24">    ChangeMessagePaneVisibility(IsMessagePaneCollapsed());</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mail/base/jar.mn</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mail/base/jar.mn</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -9,37 +9,40 @@ messenger.jar:</span>
<a href="#l28.4"></a><span id="l28.4"> % style chrome://global/content/customizeToolbar.xul chrome://messenger/skin/addressbook/addressbook.css</span>
<a href="#l28.5"></a><span id="l28.5"> % style chrome://global/content/customizeToolbar.xul chrome://messenger/skin/messengercompose/messengercompose.css</span>
<a href="#l28.6"></a><span id="l28.6"> % style chrome://global/content/customizeToolbar.xul chrome://messenger/skin/smime/msgCompSMIMEOverlay.css</span>
<a href="#l28.7"></a><span id="l28.7"> % style chrome://global/content/customizeToolbar.xul chrome://messenger/skin/primaryToolbar.css</span>
<a href="#l28.8"></a><span id="l28.8">     content/messenger/accountCreation.dtd           (content/accountCreation.dtd)</span>
<a href="#l28.9"></a><span id="l28.9">     content/messenger/accountCreation.properties    (content/accountCreation.properties)</span>
<a href="#l28.10"></a><span id="l28.10">     content/messenger/accountCreationModel.properties (content/accountCreationModel.properties)</span>
<a href="#l28.11"></a><span id="l28.11">     content/messenger/accountCreationUtil.properties  (content/accountCreationUtil.properties)</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-*   content/messenger/mailWindow.js                 (content/mailWindow.js)</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineminus">-*   content/messenger/mailWindowOverlay.js          (content/mailWindowOverlay.js)</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineplus">+    content/messenger/mailWindow.js                 (content/mailWindow.js)</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineplus">+    content/messenger/messageDisplay.js             (content/messageDisplay.js)</span>
<a href="#l28.16"></a><span id="l28.16" class="difflineplus">+    content/messenger/folderDisplay.js              (content/folderDisplay.js)</span>
<a href="#l28.17"></a><span id="l28.17" class="difflineplus">+    content/messenger/mailWindowOverlay.js          (content/mailWindowOverlay.js)</span>
<a href="#l28.18"></a><span id="l28.18"> *   content/messenger/mailWindowOverlay.xul         (content/mailWindowOverlay.xul)</span>
<a href="#l28.19"></a><span id="l28.19" class="difflineminus">-*   content/messenger/extraCustomizeItems.xul       (content/extraCustomizeItems.xul)</span>
<a href="#l28.20"></a><span id="l28.20" class="difflineplus">+    content/messenger/extraCustomizeItems.xul       (content/extraCustomizeItems.xul)</span>
<a href="#l28.21"></a><span id="l28.21"> *   content/messenger/mailOverlay.xul               (content/mailOverlay.xul)</span>
<a href="#l28.22"></a><span id="l28.22"> *   content/messenger/messageWindow.xul             (content/messageWindow.xul)</span>
<a href="#l28.23"></a><span id="l28.23" class="difflineminus">-*   content/messenger/messageWindow.js              (content/messageWindow.js)</span>
<a href="#l28.24"></a><span id="l28.24" class="difflineminus">-*   content/messenger/mailContextMenus.js           (content/mailContextMenus.js)</span>
<a href="#l28.25"></a><span id="l28.25" class="difflineplus">+    content/messenger/messageWindow.js              (content/messageWindow.js)</span>
<a href="#l28.26"></a><span id="l28.26" class="difflineplus">+    content/messenger/mailContextMenus.js           (content/mailContextMenus.js)</span>
<a href="#l28.27"></a><span id="l28.27"> *   content/messenger/messenger.xul                 (content/messenger.xul)</span>
<a href="#l28.28"></a><span id="l28.28"> *   content/messenger/hiddenWindow.xul              (content/hiddenWindow.xul)</span>
<a href="#l28.29"></a><span id="l28.29"> *   content/messenger/hiddenWindow.js               (content/hiddenWindow.js)</span>
<a href="#l28.30"></a><span id="l28.30" class="difflineminus">-*   content/messenger/msgHdrViewOverlay.js          (content/msgHdrViewOverlay.js)</span>
<a href="#l28.31"></a><span id="l28.31" class="difflineplus">+    content/messenger/msgHdrViewOverlay.js          (content/msgHdrViewOverlay.js)</span>
<a href="#l28.32"></a><span id="l28.32">     content/messenger/msgHdrViewOverlay.xul         (content/msgHdrViewOverlay.xul)</span>
<a href="#l28.33"></a><span id="l28.33" class="difflineplus">+    content/messenger/msgViewNavigation.js          (content/msgViewNavigation.js)</span>
<a href="#l28.34"></a><span id="l28.34">     content/messenger/mailWidgets.xml               (content/mailWidgets.xml)</span>
<a href="#l28.35"></a><span id="l28.35">     content/messenger/editContactOverlay.js         (content/editContactOverlay.js)</span>
<a href="#l28.36"></a><span id="l28.36"> *   content/messenger/editContactOverlay.xul        (content/editContactOverlay.xul)</span>
<a href="#l28.37"></a><span id="l28.37" class="difflineminus">-*   content/messenger/msgMail3PaneWindow.js         (content/msgMail3PaneWindow.js)</span>
<a href="#l28.38"></a><span id="l28.38" class="difflineminus">-*   content/messenger/mail3PaneWindowCommands.js    (content/mail3PaneWindowCommands.js)</span>
<a href="#l28.39"></a><span id="l28.39" class="difflineplus">+    content/messenger/msgMail3PaneWindow.js         (content/msgMail3PaneWindow.js)</span>
<a href="#l28.40"></a><span id="l28.40" class="difflineplus">+    content/messenger/mail3PaneWindowCommands.js    (content/mail3PaneWindowCommands.js)</span>
<a href="#l28.41"></a><span id="l28.41"> *   content/messenger/mailCommands.js               (content/mailCommands.js)</span>
<a href="#l28.42"></a><span id="l28.42"> *   content/messenger/mailCore.js                   (content/mailCore.js)</span>
<a href="#l28.43"></a><span id="l28.43" class="difflineminus">-*   content/messenger/commandglue.js                (content/commandglue.js)</span>
<a href="#l28.44"></a><span id="l28.44" class="difflineplus">+    content/messenger/commandglue.js                (content/commandglue.js)</span>
<a href="#l28.45"></a><span id="l28.45"> *   content/messenger/widgetglue.js                 (content/widgetglue.js)</span>
<a href="#l28.46"></a><span id="l28.46"> *   content/messenger/SearchDialog.xul              (content/SearchDialog.xul)</span>
<a href="#l28.47"></a><span id="l28.47">     content/messenger/SearchDialog.js               (content/SearchDialog.js)</span>
<a href="#l28.48"></a><span id="l28.48"> *   content/messenger/ABSearchDialog.xul            (content/ABSearchDialog.xul)</span>
<a href="#l28.49"></a><span id="l28.49"> *   content/messenger/ABSearchDialog.js             (content/ABSearchDialog.js)</span>
<a href="#l28.50"></a><span id="l28.50"> *   content/messenger/FilterListDialog.xul          (content/FilterListDialog.xul)</span>
<a href="#l28.51"></a><span id="l28.51"> *   content/messenger/FilterListDialog.js           (content/FilterListDialog.js)</span>
<a href="#l28.52"></a><span id="l28.52">     content/messenger/specialTabs.js                (content/specialTabs.js)</span>
<a href="#l28.53"></a><span id="l28.53" class="difflineat">@@ -48,25 +51,25 @@ messenger.jar:</span>
<a href="#l28.54"></a><span id="l28.54"> *   content/messenger/aboutDialog.xul               (content/aboutDialog.xul)</span>
<a href="#l28.55"></a><span id="l28.55"> *   content/messenger/aboutDialog.js                (content/aboutDialog.js)</span>
<a href="#l28.56"></a><span id="l28.56"> *   content/messenger/aboutRights.xhtml             (content/aboutRights.xhtml)</span>
<a href="#l28.57"></a><span id="l28.57"> *   content/messenger/systemIntegrationDialog.xul   (content/systemIntegrationDialog.xul)</span>
<a href="#l28.58"></a><span id="l28.58"> *   content/messenger/systemIntegrationDialog.js    (content/systemIntegrationDialog.js)</span>
<a href="#l28.59"></a><span id="l28.59">     content/messenger/folderPane.js                 (content/folderPane.js)</span>
<a href="#l28.60"></a><span id="l28.60"> *   content/messenger/msgSelectOffline.xul          (content/msgSelectOffline.xul)</span>
<a href="#l28.61"></a><span id="l28.61"> *   content/messenger/msgPrintEngine.xul            (content/msgPrintEngine.xul)</span>
<a href="#l28.62"></a><span id="l28.62" class="difflineminus">-*   content/messenger/searchBar.js                  (content/searchBar.js)</span>
<a href="#l28.63"></a><span id="l28.63" class="difflineminus">-*   content/messenger/phishingDetector.js           (content/phishingDetector.js)</span>
<a href="#l28.64"></a><span id="l28.64" class="difflineplus">+    content/messenger/searchBar.js                  (content/searchBar.js)</span>
<a href="#l28.65"></a><span id="l28.65" class="difflineplus">+    content/messenger/phishingDetector.js           (content/phishingDetector.js)</span>
<a href="#l28.66"></a><span id="l28.66"> *   content/messenger/mail-offline.js               (content/mail-offline.js)</span>
<a href="#l28.67"></a><span id="l28.67">     content/messenger/about-footer.png              (content/about-footer.png)</span>
<a href="#l28.68"></a><span id="l28.68">     content/messenger/aboutDialog.css               (content/aboutDialog.css)</span>
<a href="#l28.69"></a><span id="l28.69"> *   content/messenger/credits.xhtml                 (content/credits.xhtml)</span>
<a href="#l28.70"></a><span id="l28.70">     content/messenger/messenger.css                 (content/messenger.css)</span>
<a href="#l28.71"></a><span id="l28.71"> *   content/messenger/search.xml                    (content/search.xml)</span>
<a href="#l28.72"></a><span id="l28.72" class="difflineminus">-*   content/messenger/tabmail.xml                   (content/tabmail.xml)</span>
<a href="#l28.73"></a><span id="l28.73" class="difflineplus">+    content/messenger/tabmail.xml                   (content/tabmail.xml)</span>
<a href="#l28.74"></a><span id="l28.74"> *   content/messenger/newmailalert.xul              (content/newmailalert.xul)</span>
<a href="#l28.75"></a><span id="l28.75">     content/messenger/newmailalert.js               (content/newmailalert.js)</span>
<a href="#l28.76"></a><span id="l28.76">     content/messenger/newTagDialog.xul              (content/newTagDialog.xul)</span>
<a href="#l28.77"></a><span id="l28.77">     content/messenger/newTagDialog.js               (content/newTagDialog.js)</span>
<a href="#l28.78"></a><span id="l28.78"> *   content/messenger/viewSourceOverlay.xul         (content/viewSourceOverlay.xul)</span>
<a href="#l28.79"></a><span id="l28.79"> *   content/messenger/configEditorOverlay.xul       (content/configEditorOverlay.xul)</span>
<a href="#l28.80"></a><span id="l28.80">     content/messenger/composerOverlay.css           (content/composerOverlay.css)</span>
<a href="#l28.81"></a><span id="l28.81">     content/messenger/threadPane.js                 (content/threadPane.js)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -1,48 +1,48 @@</span>
<a href="#l29.4"></a><span id="l29.4" class="difflineminus">-# -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l29.5"></a><span id="l29.5" class="difflineminus">-# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l29.6"></a><span id="l29.6" class="difflineminus">-# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l29.7"></a><span id="l29.7" class="difflineminus">-#</span>
<a href="#l29.8"></a><span id="l29.8" class="difflineminus">-# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l29.9"></a><span id="l29.9" class="difflineminus">-# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l29.10"></a><span id="l29.10" class="difflineminus">-# the License. You may obtain a copy of the License at</span>
<a href="#l29.11"></a><span id="l29.11" class="difflineminus">-# http://www.mozilla.org/MPL/</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-#</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineminus">-# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l29.14"></a><span id="l29.14" class="difflineminus">-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l29.15"></a><span id="l29.15" class="difflineminus">-# for the specific language governing rights and limitations under the</span>
<a href="#l29.16"></a><span id="l29.16" class="difflineminus">-# License.</span>
<a href="#l29.17"></a><span id="l29.17" class="difflineminus">-#</span>
<a href="#l29.18"></a><span id="l29.18" class="difflineminus">-# The Original Code is Mozilla Communicator client code, released</span>
<a href="#l29.19"></a><span id="l29.19" class="difflineminus">-# March 31, 1998.</span>
<a href="#l29.20"></a><span id="l29.20" class="difflineminus">-#</span>
<a href="#l29.21"></a><span id="l29.21" class="difflineminus">-# The Initial Developer of the Original Code is</span>
<a href="#l29.22"></a><span id="l29.22" class="difflineminus">-# Netscape Communications Corporation.</span>
<a href="#l29.23"></a><span id="l29.23" class="difflineminus">-# Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l29.24"></a><span id="l29.24" class="difflineminus">-# the Initial Developer. All Rights Reserved.</span>
<a href="#l29.25"></a><span id="l29.25" class="difflineminus">-#</span>
<a href="#l29.26"></a><span id="l29.26" class="difflineminus">-# Contributor(s):</span>
<a href="#l29.27"></a><span id="l29.27" class="difflineminus">-#   David Bienvenu &lt;bienvenu@nventure.com&gt;</span>
<a href="#l29.28"></a><span id="l29.28" class="difflineminus">-#   Olivier Parniere BT Global Services / Etat francais Ministere de la Defense</span>
<a href="#l29.29"></a><span id="l29.29" class="difflineminus">-#   Simon Wilkinson &lt;simon@sxw.org.uk&gt;</span>
<a href="#l29.30"></a><span id="l29.30" class="difflineminus">-#</span>
<a href="#l29.31"></a><span id="l29.31" class="difflineminus">-# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l29.32"></a><span id="l29.32" class="difflineminus">-# either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l29.33"></a><span id="l29.33" class="difflineminus">-# the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l29.34"></a><span id="l29.34" class="difflineminus">-# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l29.35"></a><span id="l29.35" class="difflineminus">-# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l29.36"></a><span id="l29.36" class="difflineminus">-# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l29.37"></a><span id="l29.37" class="difflineminus">-# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l29.38"></a><span id="l29.38" class="difflineminus">-# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l29.39"></a><span id="l29.39" class="difflineminus">-# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l29.40"></a><span id="l29.40" class="difflineminus">-# the provisions above, a recipient may use your version of this file under</span>
<a href="#l29.41"></a><span id="l29.41" class="difflineminus">-# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l29.42"></a><span id="l29.42" class="difflineminus">-#</span>
<a href="#l29.43"></a><span id="l29.43" class="difflineminus">-# ***** END LICENSE BLOCK *****</span>
<a href="#l29.44"></a><span id="l29.44" class="difflineplus">+/* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l29.45"></a><span id="l29.45" class="difflineplus">+ * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l29.46"></a><span id="l29.46" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l29.47"></a><span id="l29.47" class="difflineplus">+ *</span>
<a href="#l29.48"></a><span id="l29.48" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l29.49"></a><span id="l29.49" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l29.50"></a><span id="l29.50" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l29.51"></a><span id="l29.51" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l29.52"></a><span id="l29.52" class="difflineplus">+ *</span>
<a href="#l29.53"></a><span id="l29.53" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l29.54"></a><span id="l29.54" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l29.55"></a><span id="l29.55" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l29.56"></a><span id="l29.56" class="difflineplus">+ * License.</span>
<a href="#l29.57"></a><span id="l29.57" class="difflineplus">+ *</span>
<a href="#l29.58"></a><span id="l29.58" class="difflineplus">+ * The Original Code is Mozilla Communicator client code, released</span>
<a href="#l29.59"></a><span id="l29.59" class="difflineplus">+ * March 31, 1998.</span>
<a href="#l29.60"></a><span id="l29.60" class="difflineplus">+ *</span>
<a href="#l29.61"></a><span id="l29.61" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l29.62"></a><span id="l29.62" class="difflineplus">+ * Netscape Communications Corporation.</span>
<a href="#l29.63"></a><span id="l29.63" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l29.64"></a><span id="l29.64" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l29.65"></a><span id="l29.65" class="difflineplus">+ *</span>
<a href="#l29.66"></a><span id="l29.66" class="difflineplus">+ * Contributor(s):</span>
<a href="#l29.67"></a><span id="l29.67" class="difflineplus">+ *   David Bienvenu &lt;bienvenu@nventure.com&gt;</span>
<a href="#l29.68"></a><span id="l29.68" class="difflineplus">+ *   Olivier Parniere BT Global Services / Etat francais Ministere de la Defense</span>
<a href="#l29.69"></a><span id="l29.69" class="difflineplus">+ *   Simon Wilkinson &lt;simon@sxw.org.uk&gt;</span>
<a href="#l29.70"></a><span id="l29.70" class="difflineplus">+ *</span>
<a href="#l29.71"></a><span id="l29.71" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l29.72"></a><span id="l29.72" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l29.73"></a><span id="l29.73" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l29.74"></a><span id="l29.74" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l29.75"></a><span id="l29.75" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l29.76"></a><span id="l29.76" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l29.77"></a><span id="l29.77" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l29.78"></a><span id="l29.78" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l29.79"></a><span id="l29.79" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l29.80"></a><span id="l29.80" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l29.81"></a><span id="l29.81" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l29.82"></a><span id="l29.82" class="difflineplus">+ *</span>
<a href="#l29.83"></a><span id="l29.83" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l29.84"></a><span id="l29.84"> </span>
<a href="#l29.85"></a><span id="l29.85"> // Ensure the activity modules are loaded for this window.</span>
<a href="#l29.86"></a><span id="l29.86"> Components.utils.import(&quot;resource://app/modules/activity/activityModules.js&quot;);</span>
<a href="#l29.87"></a><span id="l29.87"> </span>
<a href="#l29.88"></a><span id="l29.88"> /**</span>
<a href="#l29.89"></a><span id="l29.89">  * interfaces</span>
<a href="#l29.90"></a><span id="l29.90">  */</span>
<a href="#l29.91"></a><span id="l29.91"> const nsIMsgCompDeliverMode = Components.interfaces.nsIMsgCompDeliverMode;</span>
<a href="#l29.92"></a><span id="l29.92" class="difflineat">@@ -52,17 +52,17 @@ const nsIMsgCompType = Components.interf</span>
<a href="#l29.93"></a><span id="l29.93"> const nsIMsgCompFormat = Components.interfaces.nsIMsgCompFormat;</span>
<a href="#l29.94"></a><span id="l29.94"> const nsIAbPreferMailFormat = Components.interfaces.nsIAbPreferMailFormat;</span>
<a href="#l29.95"></a><span id="l29.95"> const nsIPlaintextEditorMail = Components.interfaces.nsIPlaintextEditor;</span>
<a href="#l29.96"></a><span id="l29.96"> const nsISupportsString = Components.interfaces.nsISupportsString;</span>
<a href="#l29.97"></a><span id="l29.97"> const mozISpellCheckingEngine = Components.interfaces.mozISpellCheckingEngine;</span>
<a href="#l29.98"></a><span id="l29.98"> </span>
<a href="#l29.99"></a><span id="l29.99"> var sDictCount = 0;</span>
<a href="#l29.100"></a><span id="l29.100"> </span>
<a href="#l29.101"></a><span id="l29.101" class="difflineminus">-/* Create message window object. This is use by mail-offline.js and therefore should not be renamed. We need to avoid doing </span>
<a href="#l29.102"></a><span id="l29.102" class="difflineplus">+/* Create message window object. This is use by mail-offline.js and therefore should not be renamed. We need to avoid doing</span>
<a href="#l29.103"></a><span id="l29.103">    this kind of cross file global stuff in the future and instead pass this object as parameter when needed by function</span>
<a href="#l29.104"></a><span id="l29.104">    in the other js file.</span>
<a href="#l29.105"></a><span id="l29.105"> */</span>
<a href="#l29.106"></a><span id="l29.106"> var msgWindow = Components.classes[&quot;@mozilla.org/messenger/msgwindow;1&quot;]</span>
<a href="#l29.107"></a><span id="l29.107">                           .createInstance(Components.interfaces.nsIMsgWindow);</span>
<a href="#l29.108"></a><span id="l29.108"> </span>
<a href="#l29.109"></a><span id="l29.109"> /**</span>
<a href="#l29.110"></a><span id="l29.110">  * Global variables, need to be re-initialized every time mostly because we need to release them when the window close</span>
<a href="#l29.111"></a><span id="l29.111" class="difflineat">@@ -111,17 +111,17 @@ var gEditingDraft;</span>
<a href="#l29.112"></a><span id="l29.112"> </span>
<a href="#l29.113"></a><span id="l29.113"> const kComposeAttachDirPrefName = &quot;mail.compose.attach.dir&quot;;</span>
<a href="#l29.114"></a><span id="l29.114"> </span>
<a href="#l29.115"></a><span id="l29.115"> function InitializeGlobalVariables()</span>
<a href="#l29.116"></a><span id="l29.116"> {</span>
<a href="#l29.117"></a><span id="l29.117">   gAccountManager = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;].getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l29.118"></a><span id="l29.118">   gIOService = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;].getService(Components.interfaces.nsIIOService);</span>
<a href="#l29.119"></a><span id="l29.119">   gPromptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;].getService(Components.interfaces.nsIPromptService);</span>
<a href="#l29.120"></a><span id="l29.120" class="difflineminus">-  </span>
<a href="#l29.121"></a><span id="l29.121" class="difflineplus">+</span>
<a href="#l29.122"></a><span id="l29.122">   gMsgCompose = null;</span>
<a href="#l29.123"></a><span id="l29.123">   gWindowLocked = false;</span>
<a href="#l29.124"></a><span id="l29.124">   gContentChanged = false;</span>
<a href="#l29.125"></a><span id="l29.125">   gCurrentIdentity = null;</span>
<a href="#l29.126"></a><span id="l29.126">   defaultSaveOperation = &quot;draft&quot;;</span>
<a href="#l29.127"></a><span id="l29.127">   gSendOrSaveOperationInProgress = false;</span>
<a href="#l29.128"></a><span id="l29.128">   gAutoSaving = false;</span>
<a href="#l29.129"></a><span id="l29.129">   gCloseWindowAfterSave = false;</span>
<a href="#l29.130"></a><span id="l29.130" class="difflineat">@@ -178,34 +178,34 @@ function enableEditableFields()</span>
<a href="#l29.131"></a><span id="l29.131"> </span>
<a href="#l29.132"></a><span id="l29.132"> var gComposeRecyclingListener = {</span>
<a href="#l29.133"></a><span id="l29.133">   onClose: function() {</span>
<a href="#l29.134"></a><span id="l29.134">     //Reset recipients and attachments</span>
<a href="#l29.135"></a><span id="l29.135">     ReleaseAutoCompleteState();</span>
<a href="#l29.136"></a><span id="l29.136">     awResetAllRows();</span>
<a href="#l29.137"></a><span id="l29.137">     RemoveAllAttachments();</span>
<a href="#l29.138"></a><span id="l29.138"> </span>
<a href="#l29.139"></a><span id="l29.139" class="difflineminus">-    // We need to clear the identity popup menu in case the user will change them. </span>
<a href="#l29.140"></a><span id="l29.140" class="difflineplus">+    // We need to clear the identity popup menu in case the user will change them.</span>
<a href="#l29.141"></a><span id="l29.141">     // It will be rebuilt later in ComposeStartup</span>
<a href="#l29.142"></a><span id="l29.142">     ClearIdentityListPopup(document.getElementById(&quot;msgIdentityPopup&quot;));</span>
<a href="#l29.143"></a><span id="l29.143" class="difflineminus">- </span>
<a href="#l29.144"></a><span id="l29.144" class="difflineplus">+</span>
<a href="#l29.145"></a><span id="l29.145">     //Clear the subject</span>
<a href="#l29.146"></a><span id="l29.146">     GetMsgSubjectElement().value = &quot;&quot;;</span>
<a href="#l29.147"></a><span id="l29.147">     // be sure to clear the transaction manager for the subject</span>
<a href="#l29.148"></a><span id="l29.148">     GetMsgSubjectElement().editor.transactionManager.clear();</span>
<a href="#l29.149"></a><span id="l29.149">     SetComposeWindowTitle();</span>
<a href="#l29.150"></a><span id="l29.150"> </span>
<a href="#l29.151"></a><span id="l29.151">     SetContentAndBodyAsUnmodified();</span>
<a href="#l29.152"></a><span id="l29.152">     disableEditableFields();</span>
<a href="#l29.153"></a><span id="l29.153">     ReleaseGlobalVariables();</span>
<a href="#l29.154"></a><span id="l29.154"> </span>
<a href="#l29.155"></a><span id="l29.155">     // Clear the focus</span>
<a href="#l29.156"></a><span id="l29.156">     awGetInputElement(1).removeAttribute('focused');</span>
<a href="#l29.157"></a><span id="l29.157"> </span>
<a href="#l29.158"></a><span id="l29.158" class="difflineminus">-    //Reset Boxes size    </span>
<a href="#l29.159"></a><span id="l29.159" class="difflineplus">+    //Reset Boxes size</span>
<a href="#l29.160"></a><span id="l29.160">     document.getElementById(&quot;headers-box&quot;).removeAttribute(&quot;height&quot;);</span>
<a href="#l29.161"></a><span id="l29.161">     document.getElementById(&quot;appcontent&quot;).removeAttribute(&quot;height&quot;);</span>
<a href="#l29.162"></a><span id="l29.162">     document.getElementById(&quot;addresses-box&quot;).removeAttribute(&quot;width&quot;);</span>
<a href="#l29.163"></a><span id="l29.163">     document.getElementById(&quot;attachments-box&quot;).removeAttribute(&quot;width&quot;);</span>
<a href="#l29.164"></a><span id="l29.164"> </span>
<a href="#l29.165"></a><span id="l29.165">     //Reset menu options</span>
<a href="#l29.166"></a><span id="l29.166">     document.getElementById(&quot;format_auto&quot;).setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l29.167"></a><span id="l29.167">     document.getElementById(&quot;priority_normal&quot;).setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l29.168"></a><span id="l29.168" class="difflineat">@@ -219,17 +219,17 @@ var gComposeRecyclingListener = {</span>
<a href="#l29.169"></a><span id="l29.169">       if (showFormat.getAttribute(&quot;checked&quot;) == &quot;true&quot;)</span>
<a href="#l29.170"></a><span id="l29.170">         document.getElementById(&quot;FormatToolbar&quot;).hidden = false;</span>
<a href="#l29.171"></a><span id="l29.171">     }</span>
<a href="#l29.172"></a><span id="l29.172"> </span>
<a href="#l29.173"></a><span id="l29.173">     // Stop InlineSpellCheckerUI so personal dictionary is saved</span>
<a href="#l29.174"></a><span id="l29.174">     enableInlineSpellCheck(false);</span>
<a href="#l29.175"></a><span id="l29.175">     // clear any suggestions in the context menu</span>
<a href="#l29.176"></a><span id="l29.176">     InlineSpellCheckerUI.clearSuggestionsFromMenu();</span>
<a href="#l29.177"></a><span id="l29.177" class="difflineminus">-           </span>
<a href="#l29.178"></a><span id="l29.178" class="difflineplus">+</span>
<a href="#l29.179"></a><span id="l29.179">     //Reset editor</span>
<a href="#l29.180"></a><span id="l29.180">     EditorResetFontAndColorAttributes();</span>
<a href="#l29.181"></a><span id="l29.181">     EditorCleanup();</span>
<a href="#l29.182"></a><span id="l29.182"> </span>
<a href="#l29.183"></a><span id="l29.183">     //Release the nsIMsgComposeParams object</span>
<a href="#l29.184"></a><span id="l29.184">     if (window.arguments &amp;&amp; window.arguments[0])</span>
<a href="#l29.185"></a><span id="l29.185">       window.arguments[0] = null;</span>
<a href="#l29.186"></a><span id="l29.186"> </span>
<a href="#l29.187"></a><span id="l29.187" class="difflineat">@@ -265,31 +265,31 @@ var stateListener = {</span>
<a href="#l29.188"></a><span id="l29.188">     gWindowLocked = false;</span>
<a href="#l29.189"></a><span id="l29.189">     enableEditableFields();</span>
<a href="#l29.190"></a><span id="l29.190">     updateComposeItems();</span>
<a href="#l29.191"></a><span id="l29.191"> </span>
<a href="#l29.192"></a><span id="l29.192">     if (aResult== Components.results.NS_OK)</span>
<a href="#l29.193"></a><span id="l29.193">     {</span>
<a href="#l29.194"></a><span id="l29.194">       if (!gAutoSaving)</span>
<a href="#l29.195"></a><span id="l29.195">         SetContentAndBodyAsUnmodified();</span>
<a href="#l29.196"></a><span id="l29.196" class="difflineminus">-     </span>
<a href="#l29.197"></a><span id="l29.197" class="difflineplus">+</span>
<a href="#l29.198"></a><span id="l29.198">       if (gCloseWindowAfterSave)</span>
<a href="#l29.199"></a><span id="l29.199">       {</span>
<a href="#l29.200"></a><span id="l29.200">         // Notify the SendListener that Send has been aborted and Stopped</span>
<a href="#l29.201"></a><span id="l29.201">         if (gMsgCompose)</span>
<a href="#l29.202"></a><span id="l29.202">           gMsgCompose.onSendNotPerformed(null, Components.results.NS_ERROR_ABORT);</span>
<a href="#l29.203"></a><span id="l29.203"> </span>
<a href="#l29.204"></a><span id="l29.204">         MsgComposeCloseWindow(true);</span>
<a href="#l29.205"></a><span id="l29.205">       }</span>
<a href="#l29.206"></a><span id="l29.206">     }</span>
<a href="#l29.207"></a><span id="l29.207">     // else if we failed to save, and we're autosaving, need to re-mark the editor</span>
<a href="#l29.208"></a><span id="l29.208">     // as changed, so that we won't lose the changes.</span>
<a href="#l29.209"></a><span id="l29.209">     else if (gAutoSaving)</span>
<a href="#l29.210"></a><span id="l29.210">     {</span>
<a href="#l29.211"></a><span id="l29.211" class="difflineminus">-      gMsgCompose.bodyModified = true; </span>
<a href="#l29.212"></a><span id="l29.212" class="difflineplus">+      gMsgCompose.bodyModified = true;</span>
<a href="#l29.213"></a><span id="l29.213">       gContentChanged = true;</span>
<a href="#l29.214"></a><span id="l29.214">     }</span>
<a href="#l29.215"></a><span id="l29.215">     gAutoSaving = false;</span>
<a href="#l29.216"></a><span id="l29.216">     gCloseWindowAfterSave = false;</span>
<a href="#l29.217"></a><span id="l29.217">   },</span>
<a href="#l29.218"></a><span id="l29.218"> </span>
<a href="#l29.219"></a><span id="l29.219">   SaveInFolderDone: function(folderURI) {</span>
<a href="#l29.220"></a><span id="l29.220">     DisplaySaveFolderDlg(folderURI);</span>
<a href="#l29.221"></a><span id="l29.221" class="difflineat">@@ -299,42 +299,42 @@ var stateListener = {</span>
<a href="#l29.222"></a><span id="l29.222"> // all progress notifications are done through the nsIWebProgressListener implementation...</span>
<a href="#l29.223"></a><span id="l29.223"> var progressListener = {</span>
<a href="#l29.224"></a><span id="l29.224">     onStateChange: function(aWebProgress, aRequest, aStateFlags, aStatus)</span>
<a href="#l29.225"></a><span id="l29.225">     {</span>
<a href="#l29.226"></a><span id="l29.226">       if (aStateFlags &amp; Components.interfaces.nsIWebProgressListener.STATE_START)</span>
<a href="#l29.227"></a><span id="l29.227">       {</span>
<a href="#l29.228"></a><span id="l29.228">         document.getElementById('compose-progressmeter').setAttribute( &quot;mode&quot;, &quot;undetermined&quot; );</span>
<a href="#l29.229"></a><span id="l29.229">       }</span>
<a href="#l29.230"></a><span id="l29.230" class="difflineminus">-      </span>
<a href="#l29.231"></a><span id="l29.231" class="difflineplus">+</span>
<a href="#l29.232"></a><span id="l29.232">       if (aStateFlags &amp; Components.interfaces.nsIWebProgressListener.STATE_STOP)</span>
<a href="#l29.233"></a><span id="l29.233">       {</span>
<a href="#l29.234"></a><span id="l29.234">         gSendOrSaveOperationInProgress = false;</span>
<a href="#l29.235"></a><span id="l29.235">         document.getElementById('compose-progressmeter').setAttribute( &quot;mode&quot;, &quot;normal&quot; );</span>
<a href="#l29.236"></a><span id="l29.236">         document.getElementById('compose-progressmeter').setAttribute( &quot;value&quot;, 0 );</span>
<a href="#l29.237"></a><span id="l29.237">         document.getElementById('statusText').setAttribute('label', '');</span>
<a href="#l29.238"></a><span id="l29.238">       }</span>
<a href="#l29.239"></a><span id="l29.239">     },</span>
<a href="#l29.240"></a><span id="l29.240" class="difflineminus">-    </span>
<a href="#l29.241"></a><span id="l29.241" class="difflineplus">+</span>
<a href="#l29.242"></a><span id="l29.242">     onProgressChange: function(aWebProgress, aRequest, aCurSelfProgress, aMaxSelfProgress, aCurTotalProgress, aMaxTotalProgress)</span>
<a href="#l29.243"></a><span id="l29.243">     {</span>
<a href="#l29.244"></a><span id="l29.244">       // Calculate percentage.</span>
<a href="#l29.245"></a><span id="l29.245">       var percent;</span>
<a href="#l29.246"></a><span id="l29.246" class="difflineminus">-      if ( aMaxTotalProgress &gt; 0 ) </span>
<a href="#l29.247"></a><span id="l29.247" class="difflineplus">+      if ( aMaxTotalProgress &gt; 0 )</span>
<a href="#l29.248"></a><span id="l29.248">       {</span>
<a href="#l29.249"></a><span id="l29.249">         percent = Math.round( (aCurTotalProgress*100)/aMaxTotalProgress );</span>
<a href="#l29.250"></a><span id="l29.250">         if ( percent &gt; 100 )</span>
<a href="#l29.251"></a><span id="l29.251">           percent = 100;</span>
<a href="#l29.252"></a><span id="l29.252" class="difflineminus">-        </span>
<a href="#l29.253"></a><span id="l29.253" class="difflineplus">+</span>
<a href="#l29.254"></a><span id="l29.254">         document.getElementById('compose-progressmeter').removeAttribute(&quot;mode&quot;);</span>
<a href="#l29.255"></a><span id="l29.255" class="difflineminus">-        </span>
<a href="#l29.256"></a><span id="l29.256" class="difflineplus">+</span>
<a href="#l29.257"></a><span id="l29.257">         // Advance progress meter.</span>
<a href="#l29.258"></a><span id="l29.258">         document.getElementById('compose-progressmeter').setAttribute( &quot;value&quot;, percent );</span>
<a href="#l29.259"></a><span id="l29.259" class="difflineminus">-      } </span>
<a href="#l29.260"></a><span id="l29.260" class="difflineminus">-      else </span>
<a href="#l29.261"></a><span id="l29.261" class="difflineplus">+      }</span>
<a href="#l29.262"></a><span id="l29.262" class="difflineplus">+      else</span>
<a href="#l29.263"></a><span id="l29.263">       {</span>
<a href="#l29.264"></a><span id="l29.264">         // Progress meter should be barber-pole in this case.</span>
<a href="#l29.265"></a><span id="l29.265">         document.getElementById('compose-progressmeter').setAttribute( &quot;mode&quot;, &quot;undetermined&quot; );</span>
<a href="#l29.266"></a><span id="l29.266">       }</span>
<a href="#l29.267"></a><span id="l29.267">     },</span>
<a href="#l29.268"></a><span id="l29.268"> </span>
<a href="#l29.269"></a><span id="l29.269">     onLocationChange: function(aWebProgress, aRequest, aLocation)</span>
<a href="#l29.270"></a><span id="l29.270">     {</span>
<a href="#l29.271"></a><span id="l29.271" class="difflineat">@@ -358,17 +358,17 @@ var progressListener = {</span>
<a href="#l29.272"></a><span id="l29.272">     },</span>
<a href="#l29.273"></a><span id="l29.273"> </span>
<a href="#l29.274"></a><span id="l29.274">     QueryInterface : function(iid)</span>
<a href="#l29.275"></a><span id="l29.275">     {</span>
<a href="#l29.276"></a><span id="l29.276">       if (iid.equals(Components.interfaces.nsIWebProgressListener) ||</span>
<a href="#l29.277"></a><span id="l29.277">           iid.equals(Components.interfaces.nsISupportsWeakReference) ||</span>
<a href="#l29.278"></a><span id="l29.278">           iid.equals(Components.interfaces.nsISupports))</span>
<a href="#l29.279"></a><span id="l29.279">         return this;</span>
<a href="#l29.280"></a><span id="l29.280" class="difflineminus">-     </span>
<a href="#l29.281"></a><span id="l29.281" class="difflineplus">+</span>
<a href="#l29.282"></a><span id="l29.282">       throw Components.results.NS_NOINTERFACE;</span>
<a href="#l29.283"></a><span id="l29.283">     }</span>
<a href="#l29.284"></a><span id="l29.284"> };</span>
<a href="#l29.285"></a><span id="l29.285"> </span>
<a href="#l29.286"></a><span id="l29.286"> var defaultController =</span>
<a href="#l29.287"></a><span id="l29.287"> {</span>
<a href="#l29.288"></a><span id="l29.288">   supportsCommand: function(command)</span>
<a href="#l29.289"></a><span id="l29.289">   {</span>
<a href="#l29.290"></a><span id="l29.290" class="difflineat">@@ -464,17 +464,17 @@ var defaultController =</span>
<a href="#l29.291"></a><span id="l29.291"> </span>
<a href="#l29.292"></a><span id="l29.292">       default:</span>
<a href="#l29.293"></a><span id="l29.293"> //        dump(&quot;##MsgCompose: command &quot; + command + &quot; disabled!\n&quot;);</span>
<a href="#l29.294"></a><span id="l29.294">         return false;</span>
<a href="#l29.295"></a><span id="l29.295">     }</span>
<a href="#l29.296"></a><span id="l29.296">   },</span>
<a href="#l29.297"></a><span id="l29.297"> </span>
<a href="#l29.298"></a><span id="l29.298">   doCommand: function(command)</span>
<a href="#l29.299"></a><span id="l29.299" class="difflineminus">-  { </span>
<a href="#l29.300"></a><span id="l29.300" class="difflineplus">+  {</span>
<a href="#l29.301"></a><span id="l29.301">     switch (command)</span>
<a href="#l29.302"></a><span id="l29.302">     {</span>
<a href="#l29.303"></a><span id="l29.303">       //File Menu</span>
<a href="#l29.304"></a><span id="l29.304">       case &quot;cmd_attachFile&quot;         : if (defaultController.isCommandEnabled(command)) AttachFile();           break;</span>
<a href="#l29.305"></a><span id="l29.305">       case &quot;cmd_attachPage&quot;         : AttachPage();           break;</span>
<a href="#l29.306"></a><span id="l29.306">       case &quot;cmd_close&quot;              : DoCommandClose();       break;</span>
<a href="#l29.307"></a><span id="l29.307">       case &quot;cmd_saveDefault&quot;        : Save();                 break;</span>
<a href="#l29.308"></a><span id="l29.308">       case &quot;cmd_saveAsFile&quot;         : SaveAsFile(true);       break;</span>
<a href="#l29.309"></a><span id="l29.309" class="difflineat">@@ -549,17 +549,17 @@ function QuoteSelectedMessage()</span>
<a href="#l29.310"></a><span id="l29.310"> </span>
<a href="#l29.311"></a><span id="l29.311"> function GetSelectedMessages()</span>
<a href="#l29.312"></a><span id="l29.312"> {</span>
<a href="#l29.313"></a><span id="l29.313">   if (gMsgCompose) {</span>
<a href="#l29.314"></a><span id="l29.314">     var mailWindow = Components.classes[&quot;@mozilla.org/appshell/window-mediator;1&quot;].getService()</span>
<a href="#l29.315"></a><span id="l29.315">                      .QueryInterface(Components.interfaces.nsIWindowMediator)</span>
<a href="#l29.316"></a><span id="l29.316">                      .getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l29.317"></a><span id="l29.317">     if (mailWindow) {</span>
<a href="#l29.318"></a><span id="l29.318" class="difflineminus">-      return mailWindow.GetSelectedMessages();</span>
<a href="#l29.319"></a><span id="l29.319" class="difflineplus">+      return mailWindow.gFolderDisplay.selectedMessageUris;</span>
<a href="#l29.320"></a><span id="l29.320">     }</span>
<a href="#l29.321"></a><span id="l29.321">   }</span>
<a href="#l29.322"></a><span id="l29.322"> </span>
<a href="#l29.323"></a><span id="l29.323">   return null;</span>
<a href="#l29.324"></a><span id="l29.324"> }</span>
<a href="#l29.325"></a><span id="l29.325"> </span>
<a href="#l29.326"></a><span id="l29.326"> function SetupCommandUpdateHandlers()</span>
<a href="#l29.327"></a><span id="l29.327"> {</span>
<a href="#l29.328"></a><span id="l29.328" class="difflineat">@@ -579,17 +579,17 @@ function CommandUpdate_MsgCompose()</span>
<a href="#l29.329"></a><span id="l29.329">   if (focusedWindow == gLastWindowToHaveFocus) {</span>
<a href="#l29.330"></a><span id="l29.330">     //dump(&quot;XXX skip\n&quot;);</span>
<a href="#l29.331"></a><span id="l29.331">     return;</span>
<a href="#l29.332"></a><span id="l29.332">   }</span>
<a href="#l29.333"></a><span id="l29.333"> </span>
<a href="#l29.334"></a><span id="l29.334">   gLastWindowToHaveFocus = focusedWindow;</span>
<a href="#l29.335"></a><span id="l29.335"> </span>
<a href="#l29.336"></a><span id="l29.336">   //dump(&quot;XXX update, focus on &quot; + focusedWindow + &quot;\n&quot;);</span>
<a href="#l29.337"></a><span id="l29.337" class="difflineminus">-  </span>
<a href="#l29.338"></a><span id="l29.338" class="difflineplus">+</span>
<a href="#l29.339"></a><span id="l29.339">   updateComposeItems();</span>
<a href="#l29.340"></a><span id="l29.340"> }</span>
<a href="#l29.341"></a><span id="l29.341"> </span>
<a href="#l29.342"></a><span id="l29.342"> function updateComposeItems()</span>
<a href="#l29.343"></a><span id="l29.343"> {</span>
<a href="#l29.344"></a><span id="l29.344">   try {</span>
<a href="#l29.345"></a><span id="l29.345">     // Edit Menu</span>
<a href="#l29.346"></a><span id="l29.346">     goUpdateCommand(&quot;cmd_rewrap&quot;);</span>
<a href="#l29.347"></a><span id="l29.347" class="difflineat">@@ -641,40 +641,40 @@ function updateEditItems()</span>
<a href="#l29.348"></a><span id="l29.348">   goUpdateCommand(&quot;cmd_renameAttachment&quot;);</span>
<a href="#l29.349"></a><span id="l29.349">   goUpdateCommand(&quot;cmd_selectAll&quot;);</span>
<a href="#l29.350"></a><span id="l29.350">   goUpdateCommand(&quot;cmd_openAttachment&quot;);</span>
<a href="#l29.351"></a><span id="l29.351">   goUpdateCommand(&quot;cmd_find&quot;);</span>
<a href="#l29.352"></a><span id="l29.352">   goUpdateCommand(&quot;cmd_findNext&quot;);</span>
<a href="#l29.353"></a><span id="l29.353">   goUpdateCommand(&quot;cmd_findPrev&quot;);</span>
<a href="#l29.354"></a><span id="l29.354"> }</span>
<a href="#l29.355"></a><span id="l29.355"> </span>
<a href="#l29.356"></a><span id="l29.356" class="difflineminus">-var messageComposeOfflineObserver = </span>
<a href="#l29.357"></a><span id="l29.357" class="difflineplus">+var messageComposeOfflineObserver =</span>
<a href="#l29.358"></a><span id="l29.358"> {</span>
<a href="#l29.359"></a><span id="l29.359" class="difflineminus">-  observe: function(subject, topic, state) </span>
<a href="#l29.360"></a><span id="l29.360" class="difflineplus">+  observe: function(subject, topic, state)</span>
<a href="#l29.361"></a><span id="l29.361">   {</span>
<a href="#l29.362"></a><span id="l29.362">     // sanity checks</span>
<a href="#l29.363"></a><span id="l29.363" class="difflineminus">-    if (topic != &quot;network:offline-status-changed&quot;) </span>
<a href="#l29.364"></a><span id="l29.364" class="difflineplus">+    if (topic != &quot;network:offline-status-changed&quot;)</span>
<a href="#l29.365"></a><span id="l29.365">       return;</span>
<a href="#l29.366"></a><span id="l29.366">     gIsOffline = state == &quot;offline&quot;;</span>
<a href="#l29.367"></a><span id="l29.367">     MessageComposeOfflineStateChanged(gIsOffline);</span>
<a href="#l29.368"></a><span id="l29.368"> </span>
<a href="#l29.369"></a><span id="l29.369">     try {</span>
<a href="#l29.370"></a><span id="l29.370">       setupLdapAutocompleteSession();</span>
<a href="#l29.371"></a><span id="l29.371">     } catch (ex) {</span>
<a href="#l29.372"></a><span id="l29.372" class="difflineminus">-      // catch the exception and ignore it, so that if LDAP setup </span>
<a href="#l29.373"></a><span id="l29.373" class="difflineplus">+      // catch the exception and ignore it, so that if LDAP setup</span>
<a href="#l29.374"></a><span id="l29.374">       // fails, the entire compose window stuff doesn't get aborted</span>
<a href="#l29.375"></a><span id="l29.375">     }</span>
<a href="#l29.376"></a><span id="l29.376">   }</span>
<a href="#l29.377"></a><span id="l29.377"> }</span>
<a href="#l29.378"></a><span id="l29.378"> </span>
<a href="#l29.379"></a><span id="l29.379"> function AddMessageComposeOfflineObserver()</span>
<a href="#l29.380"></a><span id="l29.380"> {</span>
<a href="#l29.381"></a><span id="l29.381">   var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;].getService(Components.interfaces.nsIObserverService);</span>
<a href="#l29.382"></a><span id="l29.382">   observerService.addObserver(messageComposeOfflineObserver, &quot;network:offline-status-changed&quot;, false);</span>
<a href="#l29.383"></a><span id="l29.383" class="difflineminus">-  </span>
<a href="#l29.384"></a><span id="l29.384" class="difflineplus">+</span>
<a href="#l29.385"></a><span id="l29.385">   gIsOffline = gIOService.offline;</span>
<a href="#l29.386"></a><span id="l29.386">   // set the initial state of the send button</span>
<a href="#l29.387"></a><span id="l29.387">   MessageComposeOfflineStateChanged(gIsOffline);</span>
<a href="#l29.388"></a><span id="l29.388"> }</span>
<a href="#l29.389"></a><span id="l29.389"> </span>
<a href="#l29.390"></a><span id="l29.390"> function RemoveMessageComposeOfflineObserver()</span>
<a href="#l29.391"></a><span id="l29.391"> {</span>
<a href="#l29.392"></a><span id="l29.392">   var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;].getService(Components.interfaces.nsIObserverService);</span>
<a href="#l29.393"></a><span id="l29.393" class="difflineat">@@ -712,17 +712,17 @@ function MessageComposeOfflineStateChang</span>
<a href="#l29.394"></a><span id="l29.394">   } catch(e) {}</span>
<a href="#l29.395"></a><span id="l29.395"> }</span>
<a href="#l29.396"></a><span id="l29.396"> </span>
<a href="#l29.397"></a><span id="l29.397"> var directoryServerObserver = {</span>
<a href="#l29.398"></a><span id="l29.398">   observe: function(subject, topic, value) {</span>
<a href="#l29.399"></a><span id="l29.399">       try {</span>
<a href="#l29.400"></a><span id="l29.400">           setupLdapAutocompleteSession();</span>
<a href="#l29.401"></a><span id="l29.401">       } catch (ex) {</span>
<a href="#l29.402"></a><span id="l29.402" class="difflineminus">-          // catch the exception and ignore it, so that if LDAP setup </span>
<a href="#l29.403"></a><span id="l29.403" class="difflineplus">+          // catch the exception and ignore it, so that if LDAP setup</span>
<a href="#l29.404"></a><span id="l29.404">           // fails, the entire compose window doesn't get horked</span>
<a href="#l29.405"></a><span id="l29.405">       }</span>
<a href="#l29.406"></a><span id="l29.406">   }</span>
<a href="#l29.407"></a><span id="l29.407"> }</span>
<a href="#l29.408"></a><span id="l29.408"> </span>
<a href="#l29.409"></a><span id="l29.409"> function AddDirectoryServerObserver(flag) {</span>
<a href="#l29.410"></a><span id="l29.410">   var branch = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l29.411"></a><span id="l29.411">                          .getService(Components.interfaces.nsIPrefBranch2);</span>
<a href="#l29.412"></a><span id="l29.412" class="difflineat">@@ -802,31 +802,31 @@ function setupLdapAutocompleteSession()</span>
<a href="#l29.413"></a><span id="l29.413">             .classes[&quot;@mozilla.org/autocompleteSession;1?type=ldap&quot;];</span>
<a href="#l29.414"></a><span id="l29.414">         if (LDAPSession) {</span>
<a href="#l29.415"></a><span id="l29.415">           try {</span>
<a href="#l29.416"></a><span id="l29.416">             LDAPSession = LDAPSession.createInstance()</span>
<a href="#l29.417"></a><span id="l29.417">                 .QueryInterface(Components.interfaces.nsILDAPAutoCompleteSession);</span>
<a href="#l29.418"></a><span id="l29.418">           } catch (ex) {dump (&quot;ERROR: Cannot get the LDAP autocomplete session\n&quot; + ex + &quot;\n&quot;);}</span>
<a href="#l29.419"></a><span id="l29.419">         }</span>
<a href="#l29.420"></a><span id="l29.420">     }</span>
<a href="#l29.421"></a><span id="l29.421" class="difflineminus">-            </span>
<a href="#l29.422"></a><span id="l29.422" class="difflineminus">-    if (autocompleteDirectory &amp;&amp; !gIsOffline) { </span>
<a href="#l29.423"></a><span id="l29.423" class="difflineplus">+</span>
<a href="#l29.424"></a><span id="l29.424" class="difflineplus">+    if (autocompleteDirectory &amp;&amp; !gIsOffline) {</span>
<a href="#l29.425"></a><span id="l29.425">         // Add observer on the directory server we are autocompleting against</span>
<a href="#l29.426"></a><span id="l29.426">         // only if current server is different from previous.</span>
<a href="#l29.427"></a><span id="l29.427" class="difflineminus">-        // Remove observer if current server is different from previous       </span>
<a href="#l29.428"></a><span id="l29.428" class="difflineplus">+        // Remove observer if current server is different from previous</span>
<a href="#l29.429"></a><span id="l29.429">         gCurrentAutocompleteDirectory = autocompleteDirectory;</span>
<a href="#l29.430"></a><span id="l29.430">         if (prevAutocompleteDirectory) {</span>
<a href="#l29.431"></a><span id="l29.431" class="difflineminus">-          if (prevAutocompleteDirectory != gCurrentAutocompleteDirectory) { </span>
<a href="#l29.432"></a><span id="l29.432" class="difflineplus">+          if (prevAutocompleteDirectory != gCurrentAutocompleteDirectory) {</span>
<a href="#l29.433"></a><span id="l29.433">             RemoveDirectorySettingsObserver(prevAutocompleteDirectory);</span>
<a href="#l29.434"></a><span id="l29.434">             AddDirectorySettingsObserver();</span>
<a href="#l29.435"></a><span id="l29.435">           }</span>
<a href="#l29.436"></a><span id="l29.436">         }</span>
<a href="#l29.437"></a><span id="l29.437">         else</span>
<a href="#l29.438"></a><span id="l29.438">           AddDirectorySettingsObserver();</span>
<a href="#l29.439"></a><span id="l29.439" class="difflineminus">-        </span>
<a href="#l29.440"></a><span id="l29.440" class="difflineplus">+</span>
<a href="#l29.441"></a><span id="l29.441">         // fill in the session params if there is a session</span>
<a href="#l29.442"></a><span id="l29.442">         //</span>
<a href="#l29.443"></a><span id="l29.443">         if (LDAPSession) {</span>
<a href="#l29.444"></a><span id="l29.444">             let url = getPref(autocompleteDirectory + &quot;.uri&quot;, true);</span>
<a href="#l29.445"></a><span id="l29.445"> </span>
<a href="#l29.446"></a><span id="l29.446">             LDAPSession.serverURL =</span>
<a href="#l29.447"></a><span id="l29.447">               Components.classes[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l29.448"></a><span id="l29.448">                         .getService(Components.interfaces.nsIIOService)</span>
<a href="#l29.449"></a><span id="l29.449" class="difflineat">@@ -837,48 +837,48 @@ function setupLdapAutocompleteSession()</span>
<a href="#l29.450"></a><span id="l29.450">             //</span>
<a href="#l29.451"></a><span id="l29.451">             try {</span>
<a href="#l29.452"></a><span id="l29.452">                 LDAPSession.login = getPref(autocompleteDirectory + &quot;.auth.dn&quot;, true);</span>
<a href="#l29.453"></a><span id="l29.453">             } catch (ex) {</span>
<a href="#l29.454"></a><span id="l29.454">                 // if we don't have this pref, no big deal</span>
<a href="#l29.455"></a><span id="l29.455">             }</span>
<a href="#l29.456"></a><span id="l29.456"> </span>
<a href="#l29.457"></a><span id="l29.457">             try {</span>
<a href="#l29.458"></a><span id="l29.458" class="difflineminus">-                 LDAPSession.saslMechanism = getPref(autocompleteDirectory + </span>
<a href="#l29.459"></a><span id="l29.459" class="difflineplus">+                 LDAPSession.saslMechanism = getPref(autocompleteDirectory +</span>
<a href="#l29.460"></a><span id="l29.460"> 		    &quot;.auth.saslmech&quot;, true);</span>
<a href="#l29.461"></a><span id="l29.461">             } catch (ex) {</span>
<a href="#l29.462"></a><span id="l29.462">                 // don't care if we don't have this pref</span>
<a href="#l29.463"></a><span id="l29.463">             }</span>
<a href="#l29.464"></a><span id="l29.464" class="difflineminus">-            </span>
<a href="#l29.465"></a><span id="l29.465" class="difflineplus">+</span>
<a href="#l29.466"></a><span id="l29.466">             // set the LDAP protocol version correctly</span>
<a href="#l29.467"></a><span id="l29.467">             var protocolVersion;</span>
<a href="#l29.468"></a><span id="l29.468" class="difflineminus">-            try { </span>
<a href="#l29.469"></a><span id="l29.469" class="difflineplus">+            try {</span>
<a href="#l29.470"></a><span id="l29.470">                 protocolVersion = getPref(autocompleteDirectory +</span>
<a href="#l29.471"></a><span id="l29.471">                                           &quot;.protocolVersion&quot;);</span>
<a href="#l29.472"></a><span id="l29.472">             } catch (ex) {</span>
<a href="#l29.473"></a><span id="l29.473">                 // if we don't have this pref, no big deal</span>
<a href="#l29.474"></a><span id="l29.474">             }</span>
<a href="#l29.475"></a><span id="l29.475">             if (protocolVersion == &quot;2&quot;) {</span>
<a href="#l29.476"></a><span id="l29.476" class="difflineminus">-                LDAPSession.version = </span>
<a href="#l29.477"></a><span id="l29.477" class="difflineplus">+                LDAPSession.version =</span>
<a href="#l29.478"></a><span id="l29.478">                     Components.interfaces.nsILDAPConnection.VERSION2;</span>
<a href="#l29.479"></a><span id="l29.479">             }</span>
<a href="#l29.480"></a><span id="l29.480"> </span>
<a href="#l29.481"></a><span id="l29.481">             // don't search on non-CJK strings shorter than this</span>
<a href="#l29.482"></a><span id="l29.482">             //</span>
<a href="#l29.483"></a><span id="l29.483" class="difflineminus">-            try { </span>
<a href="#l29.484"></a><span id="l29.484" class="difflineplus">+            try {</span>
<a href="#l29.485"></a><span id="l29.485">                 LDAPSession.minStringLength = getPref(</span>
<a href="#l29.486"></a><span id="l29.486">                     autocompleteDirectory + &quot;.autoComplete.minStringLength&quot;);</span>
<a href="#l29.487"></a><span id="l29.487">             } catch (ex) {</span>
<a href="#l29.488"></a><span id="l29.488">                 // if this pref isn't there, no big deal.  just let</span>
<a href="#l29.489"></a><span id="l29.489">                 // nsLDAPAutoCompleteSession use its default.</span>
<a href="#l29.490"></a><span id="l29.490">             }</span>
<a href="#l29.491"></a><span id="l29.491"> </span>
<a href="#l29.492"></a><span id="l29.492">             // don't search on CJK strings shorter than this</span>
<a href="#l29.493"></a><span id="l29.493">             //</span>
<a href="#l29.494"></a><span id="l29.494" class="difflineminus">-            try { </span>
<a href="#l29.495"></a><span id="l29.495" class="difflineplus">+            try {</span>
<a href="#l29.496"></a><span id="l29.496">                 LDAPSession.cjkMinStringLength = getPref(</span>
<a href="#l29.497"></a><span id="l29.497">                   autocompleteDirectory + &quot;.autoComplete.cjkMinStringLength&quot;);</span>
<a href="#l29.498"></a><span id="l29.498">             } catch (ex) {</span>
<a href="#l29.499"></a><span id="l29.499">                 // if this pref isn't there, no big deal.  just let</span>
<a href="#l29.500"></a><span id="l29.500">                 // nsLDAPAutoCompleteSession use its default.</span>
<a href="#l29.501"></a><span id="l29.501">             }</span>
<a href="#l29.502"></a><span id="l29.502"> </span>
<a href="#l29.503"></a><span id="l29.503">             // we don't try/catch here, because if this fails, we're outta luck</span>
<a href="#l29.504"></a><span id="l29.504" class="difflineat">@@ -927,17 +927,17 @@ function setupLdapAutocompleteSession()</span>
<a href="#l29.505"></a><span id="l29.505">                     ldapFormatter.commentFormat = getPref(</span>
<a href="#l29.506"></a><span id="l29.506">                         autocompleteDirectory + &quot;.description&quot;, true);</span>
<a href="#l29.507"></a><span id="l29.507">                     break;</span>
<a href="#l29.508"></a><span id="l29.508"> </span>
<a href="#l29.509"></a><span id="l29.509">                 case 2:</span>
<a href="#l29.510"></a><span id="l29.510">                     // override ldap-specific autocomplete entry?</span>
<a href="#l29.511"></a><span id="l29.511">                     //</span>
<a href="#l29.512"></a><span id="l29.512">                     try {</span>
<a href="#l29.513"></a><span id="l29.513" class="difflineminus">-                        ldapFormatter.commentFormat = </span>
<a href="#l29.514"></a><span id="l29.514" class="difflineplus">+                        ldapFormatter.commentFormat =</span>
<a href="#l29.515"></a><span id="l29.515">                             getPref(autocompleteDirectory +</span>
<a href="#l29.516"></a><span id="l29.516">                                     &quot;.autoComplete.commentFormat&quot;, true);</span>
<a href="#l29.517"></a><span id="l29.517">                     } catch (innerException) {</span>
<a href="#l29.518"></a><span id="l29.518">                         // if nothing has been specified, use the ldap</span>
<a href="#l29.519"></a><span id="l29.519">                         // organization field</span>
<a href="#l29.520"></a><span id="l29.520">                         ldapFormatter.commentFormat = &quot;[o]&quot;;</span>
<a href="#l29.521"></a><span id="l29.521">                     }</span>
<a href="#l29.522"></a><span id="l29.522">                     break;</span>
<a href="#l29.523"></a><span id="l29.523" class="difflineat">@@ -967,51 +967,51 @@ function setupLdapAutocompleteSession()</span>
<a href="#l29.524"></a><span id="l29.524"> </span>
<a href="#l29.525"></a><span id="l29.525">             } catch (ex) {</span>
<a href="#l29.526"></a><span id="l29.526">                 // if this pref isn't there, no big deal.  just let</span>
<a href="#l29.527"></a><span id="l29.527">                 // nsLDAPAutoCompleteSession use its default.</span>
<a href="#l29.528"></a><span id="l29.528">             }</span>
<a href="#l29.529"></a><span id="l29.529"> </span>
<a href="#l29.530"></a><span id="l29.530">             // override default search filter template?</span>
<a href="#l29.531"></a><span id="l29.531">             //</span>
<a href="#l29.532"></a><span id="l29.532" class="difflineminus">-            try { </span>
<a href="#l29.533"></a><span id="l29.533" class="difflineplus">+            try {</span>
<a href="#l29.534"></a><span id="l29.534">                 LDAPSession.filterTemplate = getPref(</span>
<a href="#l29.535"></a><span id="l29.535">                     autocompleteDirectory + &quot;.autoComplete.filterTemplate&quot;,</span>
<a href="#l29.536"></a><span id="l29.536">                     true);</span>
<a href="#l29.537"></a><span id="l29.537"> </span>
<a href="#l29.538"></a><span id="l29.538">             } catch (ex) {</span>
<a href="#l29.539"></a><span id="l29.539">                 // if this pref isn't there, no big deal.  just let</span>
<a href="#l29.540"></a><span id="l29.540">                 // nsLDAPAutoCompleteSession use its default</span>
<a href="#l29.541"></a><span id="l29.541">             }</span>
<a href="#l29.542"></a><span id="l29.542"> </span>
<a href="#l29.543"></a><span id="l29.543">             // override default maxHits (currently 100)</span>
<a href="#l29.544"></a><span id="l29.544">             //</span>
<a href="#l29.545"></a><span id="l29.545" class="difflineminus">-            try { </span>
<a href="#l29.546"></a><span id="l29.546" class="difflineplus">+            try {</span>
<a href="#l29.547"></a><span id="l29.547">                 // XXXdmose should really use .autocomplete.maxHits,</span>
<a href="#l29.548"></a><span id="l29.548">                 // but there's no UI for that yet</span>
<a href="#l29.549"></a><span id="l29.549" class="difflineminus">-                // </span>
<a href="#l29.550"></a><span id="l29.550" class="difflineplus">+                //</span>
<a href="#l29.551"></a><span id="l29.551">                 LDAPSession.maxHits = getPref(autocompleteDirectory + &quot;.maxHits&quot;);</span>
<a href="#l29.552"></a><span id="l29.552">             } catch (ex) {</span>
<a href="#l29.553"></a><span id="l29.553" class="difflineminus">-                // if this pref isn't there, or is out of range, no big deal. </span>
<a href="#l29.554"></a><span id="l29.554" class="difflineplus">+                // if this pref isn't there, or is out of range, no big deal.</span>
<a href="#l29.555"></a><span id="l29.555">                 // just let nsLDAPAutoCompleteSession use its default.</span>
<a href="#l29.556"></a><span id="l29.556">             }</span>
<a href="#l29.557"></a><span id="l29.557"> </span>
<a href="#l29.558"></a><span id="l29.558">             if (!gSessionAdded) {</span>
<a href="#l29.559"></a><span id="l29.559">                 // if we make it here, we know that session initialization has</span>
<a href="#l29.560"></a><span id="l29.560" class="difflineminus">-                // succeeded; add the session for all recipients, and </span>
<a href="#l29.561"></a><span id="l29.561" class="difflineplus">+                // succeeded; add the session for all recipients, and</span>
<a href="#l29.562"></a><span id="l29.562">                 // remember that we've done so</span>
<a href="#l29.563"></a><span id="l29.563">                 let maxRecipients = awGetMaxRecipients();</span>
<a href="#l29.564"></a><span id="l29.564">                 for (let i = 1; i &lt;= maxRecipients; i++)</span>
<a href="#l29.565"></a><span id="l29.565">                 {</span>
<a href="#l29.566"></a><span id="l29.566">                     let autoCompleteWidget = document.getElementById(&quot;addressCol2#&quot; + i);</span>
<a href="#l29.567"></a><span id="l29.567">                     if (autoCompleteWidget)</span>
<a href="#l29.568"></a><span id="l29.568">                     {</span>
<a href="#l29.569"></a><span id="l29.569">                       autoCompleteWidget.addSession(LDAPSession);</span>
<a href="#l29.570"></a><span id="l29.570">                       // ldap searches don't insert a default entry with the default domain appended to it</span>
<a href="#l29.571"></a><span id="l29.571" class="difflineminus">-                      // so reduce the minimum results for a popup to 2 in this case. </span>
<a href="#l29.572"></a><span id="l29.572" class="difflineplus">+                      // so reduce the minimum results for a popup to 2 in this case.</span>
<a href="#l29.573"></a><span id="l29.573">                       autoCompleteWidget.minResultsForPopup = 2;</span>
<a href="#l29.574"></a><span id="l29.574"> </span>
<a href="#l29.575"></a><span id="l29.575">                     }</span>
<a href="#l29.576"></a><span id="l29.576">                  }</span>
<a href="#l29.577"></a><span id="l29.577">                 gSessionAdded = true;</span>
<a href="#l29.578"></a><span id="l29.578">             }</span>
<a href="#l29.579"></a><span id="l29.579">         }</span>
<a href="#l29.580"></a><span id="l29.580">     } else {</span>
<a href="#l29.581"></a><span id="l29.581" class="difflineat">@@ -1165,17 +1165,17 @@ function handleMailtoArgs(mailtoUrl)</span>
<a href="#l29.582"></a><span id="l29.582"> </span>
<a href="#l29.583"></a><span id="l29.583">   return null;</span>
<a href="#l29.584"></a><span id="l29.584"> }</span>
<a href="#l29.585"></a><span id="l29.585"> </span>
<a href="#l29.586"></a><span id="l29.586"> function ComposeStartup(recycled, aParams)</span>
<a href="#l29.587"></a><span id="l29.587"> {</span>
<a href="#l29.588"></a><span id="l29.588">   var params = null; // New way to pass parameters to the compose window as a nsIMsgComposeParameters object</span>
<a href="#l29.589"></a><span id="l29.589">   var args = null;   // old way, parameters are passed as a string</span>
<a href="#l29.590"></a><span id="l29.590" class="difflineminus">-  </span>
<a href="#l29.591"></a><span id="l29.591" class="difflineplus">+</span>
<a href="#l29.592"></a><span id="l29.592">   if (aParams)</span>
<a href="#l29.593"></a><span id="l29.593">     params = aParams;</span>
<a href="#l29.594"></a><span id="l29.594">   else if (window.arguments &amp;&amp; window.arguments[0]) {</span>
<a href="#l29.595"></a><span id="l29.595">     try {</span>
<a href="#l29.596"></a><span id="l29.596">       if (window.arguments[0] instanceof Components.interfaces.nsIMsgComposeParams)</span>
<a href="#l29.597"></a><span id="l29.597">         params = window.arguments[0];</span>
<a href="#l29.598"></a><span id="l29.598">       else</span>
<a href="#l29.599"></a><span id="l29.599">         params = handleMailtoArgs(window.arguments[0]);</span>
<a href="#l29.600"></a><span id="l29.600" class="difflineat">@@ -1382,17 +1382,17 @@ function ComposeStartup(recycled, aParam</span>
<a href="#l29.601"></a><span id="l29.601">       } catch (e) {</span>
<a href="#l29.602"></a><span id="l29.602">         dump(&quot; Failed to startup editor: &quot;+e+&quot;\n&quot;);</span>
<a href="#l29.603"></a><span id="l29.603">       }</span>
<a href="#l29.604"></a><span id="l29.604">     }</span>
<a href="#l29.605"></a><span id="l29.605">   }</span>
<a href="#l29.606"></a><span id="l29.606"> </span>
<a href="#l29.607"></a><span id="l29.607">   gEditingDraft = gMsgCompose.compFields.draftId;</span>
<a href="#l29.608"></a><span id="l29.608"> </span>
<a href="#l29.609"></a><span id="l29.609" class="difflineminus">-  // finally, see if we need to auto open the address sidebar. </span>
<a href="#l29.610"></a><span id="l29.610" class="difflineplus">+  // finally, see if we need to auto open the address sidebar.</span>
<a href="#l29.611"></a><span id="l29.611">   var sideBarBox = document.getElementById('sidebar-box');</span>
<a href="#l29.612"></a><span id="l29.612">   if (sideBarBox.getAttribute(&quot;sidebarVisible&quot;) == &quot;true&quot;)</span>
<a href="#l29.613"></a><span id="l29.613">   {</span>
<a href="#l29.614"></a><span id="l29.614">     // if we aren't supposed to have the side bar hidden, make sure it is visible</span>
<a href="#l29.615"></a><span id="l29.615">     if (document.getElementById(&quot;sidebar&quot;).getAttribute(&quot;src&quot;) == &quot;&quot;)</span>
<a href="#l29.616"></a><span id="l29.616">       setTimeout(toggleAddressPicker, 0);   // do this on a delay so we don't hurt perf. on bringing up a new compose window</span>
<a href="#l29.617"></a><span id="l29.617">   }</span>
<a href="#l29.618"></a><span id="l29.618">   gAutoSaveInterval = getPref(&quot;mail.compose.autosave&quot;) ?</span>
<a href="#l29.619"></a><span id="l29.619" class="difflineat">@@ -1401,17 +1401,17 @@ function ComposeStartup(recycled, aParam</span>
<a href="#l29.620"></a><span id="l29.620">   if (gAutoSaveInterval)</span>
<a href="#l29.621"></a><span id="l29.621">     gAutoSaveTimeout = setTimeout(AutoSave, gAutoSaveInterval);</span>
<a href="#l29.622"></a><span id="l29.622"> </span>
<a href="#l29.623"></a><span id="l29.623">   gAutoSaveKickedIn = false;</span>
<a href="#l29.624"></a><span id="l29.624"> }</span>
<a href="#l29.625"></a><span id="l29.625"> </span>
<a href="#l29.626"></a><span id="l29.626"> // The new, nice, simple way of getting notified when a new editor has been created</span>
<a href="#l29.627"></a><span id="l29.627"> var gMsgEditorCreationObserver =</span>
<a href="#l29.628"></a><span id="l29.628" class="difflineminus">-{ </span>
<a href="#l29.629"></a><span id="l29.629" class="difflineplus">+{</span>
<a href="#l29.630"></a><span id="l29.630">   observe: function(aSubject, aTopic, aData)</span>
<a href="#l29.631"></a><span id="l29.631">   {</span>
<a href="#l29.632"></a><span id="l29.632">     if (aTopic == &quot;obs_documentCreated&quot;)</span>
<a href="#l29.633"></a><span id="l29.633">     {</span>
<a href="#l29.634"></a><span id="l29.634">       var editor = GetCurrentEditor();</span>
<a href="#l29.635"></a><span id="l29.635">       if (editor &amp;&amp; GetCurrentCommandManager() == aSubject)</span>
<a href="#l29.636"></a><span id="l29.636">       {</span>
<a href="#l29.637"></a><span id="l29.637">         var editorStyle = editor.QueryInterface(Components.interfaces.nsIEditorStyleSheets);</span>
<a href="#l29.638"></a><span id="l29.638" class="difflineat">@@ -1449,23 +1449,23 @@ function ComposeLoad()</span>
<a href="#l29.639"></a><span id="l29.639">   catch (ex) {</span>
<a href="#l29.640"></a><span id="l29.640">     dump(&quot;failed to get the mail.compose.other.header pref\n&quot;);</span>
<a href="#l29.641"></a><span id="l29.641">   }</span>
<a href="#l29.642"></a><span id="l29.642"> </span>
<a href="#l29.643"></a><span id="l29.643">   AddMessageComposeOfflineObserver();</span>
<a href="#l29.644"></a><span id="l29.644">   AddDirectoryServerObserver(true);</span>
<a href="#l29.645"></a><span id="l29.645"> </span>
<a href="#l29.646"></a><span id="l29.646">   try {</span>
<a href="#l29.647"></a><span id="l29.647" class="difflineminus">-    // XXX: We used to set commentColumn on the initial auto complete column after the document has loaded </span>
<a href="#l29.648"></a><span id="l29.648" class="difflineplus">+    // XXX: We used to set commentColumn on the initial auto complete column after the document has loaded</span>
<a href="#l29.649"></a><span id="l29.649">     // inside of setupAutocomplete. But this happens too late for the first widget and it was never showing</span>
<a href="#l29.650"></a><span id="l29.650">     // the comment field. Try to set it before the document finishes loading:</span>
<a href="#l29.651"></a><span id="l29.651">     if (getPref(&quot;mail.autoComplete.commentColumn&quot;))</span>
<a href="#l29.652"></a><span id="l29.652">       document.getElementById('addressCol2#1').showCommentColumn = true;</span>
<a href="#l29.653"></a><span id="l29.653" class="difflineminus">-  } </span>
<a href="#l29.654"></a><span id="l29.654" class="difflineminus">-  catch (ex) { </span>
<a href="#l29.655"></a><span id="l29.655" class="difflineplus">+  }</span>
<a href="#l29.656"></a><span id="l29.656" class="difflineplus">+  catch (ex) {</span>
<a href="#l29.657"></a><span id="l29.657">     // do nothing...</span>
<a href="#l29.658"></a><span id="l29.658">   }</span>
<a href="#l29.659"></a><span id="l29.659"> </span>
<a href="#l29.660"></a><span id="l29.660">   try {</span>
<a href="#l29.661"></a><span id="l29.661">     SetupCommandUpdateHandlers();</span>
<a href="#l29.662"></a><span id="l29.662">     // This will do migration, or create a new account if we need to.</span>
<a href="#l29.663"></a><span id="l29.663">     // We also want to open the account wizard if no identities are found</span>
<a href="#l29.664"></a><span id="l29.664">     var state = verifyAccounts(WizCallback, true);</span>
<a href="#l29.665"></a><span id="l29.665" class="difflineat">@@ -1547,17 +1547,17 @@ function UpdateMailEditCharset()</span>
<a href="#l29.666"></a><span id="l29.666">   if (gCharsetConvertManager) {</span>
<a href="#l29.667"></a><span id="l29.667">     var charsetAlias = gCharsetConvertManager.getCharsetAlias(compFieldsCharset);</span>
<a href="#l29.668"></a><span id="l29.668">     if (charsetAlias == &quot;us-ascii&quot;)</span>
<a href="#l29.669"></a><span id="l29.669">       compFieldsCharset = &quot;ISO-8859-1&quot;;   // no menu item for &quot;us-ascii&quot;</span>
<a href="#l29.670"></a><span id="l29.670">   }</span>
<a href="#l29.671"></a><span id="l29.671"> </span>
<a href="#l29.672"></a><span id="l29.672">   // charset may have been set implicitly in case of reply/forward</span>
<a href="#l29.673"></a><span id="l29.673">   // or use pref default otherwise</span>
<a href="#l29.674"></a><span id="l29.674" class="difflineminus">-  var menuitem = document.getElementById(send_default_charset == compFieldsCharset ? </span>
<a href="#l29.675"></a><span id="l29.675" class="difflineplus">+  var menuitem = document.getElementById(send_default_charset == compFieldsCharset ?</span>
<a href="#l29.676"></a><span id="l29.676">                                          send_default_charset : compFieldsCharset);</span>
<a href="#l29.677"></a><span id="l29.677">   if (menuitem)</span>
<a href="#l29.678"></a><span id="l29.678">     menuitem.setAttribute('checked', 'true');</span>
<a href="#l29.679"></a><span id="l29.679"> </span>
<a href="#l29.680"></a><span id="l29.680">   // Set a document charset to a default mail send charset.</span>
<a href="#l29.681"></a><span id="l29.681">   if (send_default_charset == compFieldsCharset)</span>
<a href="#l29.682"></a><span id="l29.682">     SetDocumentCharacterSet(send_default_charset);</span>
<a href="#l29.683"></a><span id="l29.683"> }</span>
<a href="#l29.684"></a><span id="l29.684" class="difflineat">@@ -1811,23 +1811,23 @@ function GenericSendMessage( msgType )</span>
<a href="#l29.685"></a><span id="l29.685">       }</span>
<a href="#l29.686"></a><span id="l29.686"> </span>
<a href="#l29.687"></a><span id="l29.687">       // hook for extra compose pre-processing</span>
<a href="#l29.688"></a><span id="l29.688">       var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;].getService(Components.interfaces.nsIObserverService);</span>
<a href="#l29.689"></a><span id="l29.689">       observerService.notifyObservers(window, &quot;mail:composeOnSend&quot;, null);</span>
<a href="#l29.690"></a><span id="l29.690"> </span>
<a href="#l29.691"></a><span id="l29.691">       var originalCharset = gMsgCompose.compFields.characterSet;</span>
<a href="#l29.692"></a><span id="l29.692">       // Check if the headers of composing mail can be converted to a mail charset.</span>
<a href="#l29.693"></a><span id="l29.693" class="difflineminus">-      if (msgType == nsIMsgCompDeliverMode.Now || </span>
<a href="#l29.694"></a><span id="l29.694" class="difflineplus">+      if (msgType == nsIMsgCompDeliverMode.Now ||</span>
<a href="#l29.695"></a><span id="l29.695">         msgType == nsIMsgCompDeliverMode.Later ||</span>
<a href="#l29.696"></a><span id="l29.696">         msgType == nsIMsgCompDeliverMode.Background ||</span>
<a href="#l29.697"></a><span id="l29.697" class="difflineminus">-        msgType == nsIMsgCompDeliverMode.Save || </span>
<a href="#l29.698"></a><span id="l29.698" class="difflineminus">-        msgType == nsIMsgCompDeliverMode.SaveAsDraft || </span>
<a href="#l29.699"></a><span id="l29.699" class="difflineminus">-        msgType == nsIMsgCompDeliverMode.AutoSaveAsDraft || </span>
<a href="#l29.700"></a><span id="l29.700" class="difflineminus">-        msgType == nsIMsgCompDeliverMode.SaveAsTemplate) </span>
<a href="#l29.701"></a><span id="l29.701" class="difflineplus">+        msgType == nsIMsgCompDeliverMode.Save ||</span>
<a href="#l29.702"></a><span id="l29.702" class="difflineplus">+        msgType == nsIMsgCompDeliverMode.SaveAsDraft ||</span>
<a href="#l29.703"></a><span id="l29.703" class="difflineplus">+        msgType == nsIMsgCompDeliverMode.AutoSaveAsDraft ||</span>
<a href="#l29.704"></a><span id="l29.704" class="difflineplus">+        msgType == nsIMsgCompDeliverMode.SaveAsTemplate)</span>
<a href="#l29.705"></a><span id="l29.705">       {</span>
<a href="#l29.706"></a><span id="l29.706">         var fallbackCharset = new Object;</span>
<a href="#l29.707"></a><span id="l29.707">         // Check encoding, switch to UTF-8 if the default encoding doesn't fit</span>
<a href="#l29.708"></a><span id="l29.708">         // and disable_fallback_to_utf8 isn't set for this encoding.</span>
<a href="#l29.709"></a><span id="l29.709">         if (!gMsgCompose.checkCharsetConversion(getCurrentIdentity(), fallbackCharset))</span>
<a href="#l29.710"></a><span id="l29.710">         {</span>
<a href="#l29.711"></a><span id="l29.711">           var disableFallback = false;</span>
<a href="#l29.712"></a><span id="l29.712">           try</span>
<a href="#l29.713"></a><span id="l29.713" class="difflineat">@@ -1836,17 +1836,17 @@ function GenericSendMessage( msgType )</span>
<a href="#l29.714"></a><span id="l29.714">           }</span>
<a href="#l29.715"></a><span id="l29.715">           catch (e) {}</span>
<a href="#l29.716"></a><span id="l29.716">           if (disableFallback)</span>
<a href="#l29.717"></a><span id="l29.717">             msgCompFields.needToCheckCharset = false;</span>
<a href="#l29.718"></a><span id="l29.718">           else</span>
<a href="#l29.719"></a><span id="l29.719">             fallbackCharset.value = &quot;UTF-8&quot;;</span>
<a href="#l29.720"></a><span id="l29.720">         }</span>
<a href="#l29.721"></a><span id="l29.721"> </span>
<a href="#l29.722"></a><span id="l29.722" class="difflineminus">-        if (fallbackCharset &amp;&amp; </span>
<a href="#l29.723"></a><span id="l29.723" class="difflineplus">+        if (fallbackCharset &amp;&amp;</span>
<a href="#l29.724"></a><span id="l29.724">             fallbackCharset.value &amp;&amp; fallbackCharset.value != &quot;&quot;)</span>
<a href="#l29.725"></a><span id="l29.725">           gMsgCompose.SetDocumentCharset(fallbackCharset.value);</span>
<a href="#l29.726"></a><span id="l29.726">       }</span>
<a href="#l29.727"></a><span id="l29.727">       try {</span>
<a href="#l29.728"></a><span id="l29.728"> </span>
<a href="#l29.729"></a><span id="l29.729">         // just before we try to send the message, fire off the compose-send-message event for listeners</span>
<a href="#l29.730"></a><span id="l29.730">         // such as smime so they can do any pre-security work such as fetching certificates before sending</span>
<a href="#l29.731"></a><span id="l29.731">         var event = document.createEvent('UIEvents');</span>
<a href="#l29.732"></a><span id="l29.732" class="difflineat">@@ -1863,17 +1863,17 @@ function GenericSendMessage( msgType )</span>
<a href="#l29.733"></a><span id="l29.733">         {</span>
<a href="#l29.734"></a><span id="l29.734">           gWindowLocked = true;</span>
<a href="#l29.735"></a><span id="l29.735">           disableEditableFields();</span>
<a href="#l29.736"></a><span id="l29.736">           updateComposeItems();</span>
<a href="#l29.737"></a><span id="l29.737">         }</span>
<a href="#l29.738"></a><span id="l29.738">         // if we're auto saving, mark the body as not changed here, and not</span>
<a href="#l29.739"></a><span id="l29.739">         // when the save is done, because the user might change it between now</span>
<a href="#l29.740"></a><span id="l29.740">         // and when the save is done.</span>
<a href="#l29.741"></a><span id="l29.741" class="difflineminus">-        else </span>
<a href="#l29.742"></a><span id="l29.742" class="difflineplus">+        else</span>
<a href="#l29.743"></a><span id="l29.743">           SetContentAndBodyAsUnmodified();</span>
<a href="#l29.744"></a><span id="l29.744"> </span>
<a href="#l29.745"></a><span id="l29.745">         var progress = Components.classes[&quot;@mozilla.org/messenger/progress;1&quot;].createInstance(Components.interfaces.nsIMsgProgress);</span>
<a href="#l29.746"></a><span id="l29.746">         if (progress)</span>
<a href="#l29.747"></a><span id="l29.747">         {</span>
<a href="#l29.748"></a><span id="l29.748">           progress.registerListener(progressListener);</span>
<a href="#l29.749"></a><span id="l29.749">           gSendOrSaveOperationInProgress = true;</span>
<a href="#l29.750"></a><span id="l29.750">         }</span>
<a href="#l29.751"></a><span id="l29.751" class="difflineat">@@ -1909,17 +1909,17 @@ function CheckValidEmailAddress(to, cc, </span>
<a href="#l29.752"></a><span id="l29.752">   if (invalidStr)</span>
<a href="#l29.753"></a><span id="l29.753">   {</span>
<a href="#l29.754"></a><span id="l29.754">     var bundle = document.getElementById(&quot;bundle_composeMsgs&quot;);</span>
<a href="#l29.755"></a><span id="l29.755">     var errorTitle = bundle.getString(&quot;sendMsgTitle&quot;);</span>
<a href="#l29.756"></a><span id="l29.756">     var errorMsg = bundle.getFormattedString(&quot;addressInvalid&quot;, [invalidStr], 1);</span>
<a href="#l29.757"></a><span id="l29.757">     if (gPromptService)</span>
<a href="#l29.758"></a><span id="l29.758">       gPromptService.alert(window, errorTitle, errorMsg);</span>
<a href="#l29.759"></a><span id="l29.759">     return false;</span>
<a href="#l29.760"></a><span id="l29.760" class="difflineminus">-  } </span>
<a href="#l29.761"></a><span id="l29.761" class="difflineplus">+  }</span>
<a href="#l29.762"></a><span id="l29.762">   return true;</span>
<a href="#l29.763"></a><span id="l29.763"> }</span>
<a href="#l29.764"></a><span id="l29.764"> </span>
<a href="#l29.765"></a><span id="l29.765"> function SendMessage()</span>
<a href="#l29.766"></a><span id="l29.766"> {</span>
<a href="#l29.767"></a><span id="l29.767">   let sendInBackground =</span>
<a href="#l29.768"></a><span id="l29.768">     Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l29.769"></a><span id="l29.769">               .getService(Components.interfaces.nsIPrefBranch)</span>
<a href="#l29.770"></a><span id="l29.770" class="difflineat">@@ -1932,17 +1932,17 @@ function SendMessage()</span>
<a href="#l29.771"></a><span id="l29.771"> </span>
<a href="#l29.772"></a><span id="l29.772"> function SendMessageWithCheck()</span>
<a href="#l29.773"></a><span id="l29.773"> {</span>
<a href="#l29.774"></a><span id="l29.774">     var warn = getPref(&quot;mail.warn_on_send_accel_key&quot;);</span>
<a href="#l29.775"></a><span id="l29.775"> </span>
<a href="#l29.776"></a><span id="l29.776">     if (warn) {</span>
<a href="#l29.777"></a><span id="l29.777">         var checkValue = {value:false};</span>
<a href="#l29.778"></a><span id="l29.778">         var bundle = document.getElementById(&quot;bundle_composeMsgs&quot;);</span>
<a href="#l29.779"></a><span id="l29.779" class="difflineminus">-        var buttonPressed = gPromptService.confirmEx(window, </span>
<a href="#l29.780"></a><span id="l29.780" class="difflineplus">+        var buttonPressed = gPromptService.confirmEx(window,</span>
<a href="#l29.781"></a><span id="l29.781">               bundle.getString('sendMessageCheckWindowTitle'),</span>
<a href="#l29.782"></a><span id="l29.782">               bundle.getString('sendMessageCheckLabel'),</span>
<a href="#l29.783"></a><span id="l29.783">               (gPromptService.BUTTON_TITLE_IS_STRING * gPromptService.BUTTON_POS_0) +</span>
<a href="#l29.784"></a><span id="l29.784">               (gPromptService.BUTTON_TITLE_CANCEL * gPromptService.BUTTON_POS_1),</span>
<a href="#l29.785"></a><span id="l29.785">               bundle.getString('sendMessageCheckSendButtonLabel'),</span>
<a href="#l29.786"></a><span id="l29.786">               null, null,</span>
<a href="#l29.787"></a><span id="l29.787">               bundle.getString('CheckMsg'),</span>
<a href="#l29.788"></a><span id="l29.788">               checkValue);</span>
<a href="#l29.789"></a><span id="l29.789" class="difflineat">@@ -2030,17 +2030,17 @@ function MessageFcc(aFolder)</span>
<a href="#l29.790"></a><span id="l29.790"> </span>
<a href="#l29.791"></a><span id="l29.791"> function updatePriorityMenu()</span>
<a href="#l29.792"></a><span id="l29.792"> {</span>
<a href="#l29.793"></a><span id="l29.793">   if (gMsgCompose)</span>
<a href="#l29.794"></a><span id="l29.794">   {</span>
<a href="#l29.795"></a><span id="l29.795">     var msgCompFields = gMsgCompose.compFields;</span>
<a href="#l29.796"></a><span id="l29.796">     if (msgCompFields &amp;&amp; msgCompFields.priority)</span>
<a href="#l29.797"></a><span id="l29.797">     {</span>
<a href="#l29.798"></a><span id="l29.798" class="difflineminus">-      var priorityMenu = document.getElementById('priorityMenu' ); </span>
<a href="#l29.799"></a><span id="l29.799" class="difflineplus">+      var priorityMenu = document.getElementById('priorityMenu' );</span>
<a href="#l29.800"></a><span id="l29.800">       priorityMenu.getElementsByAttribute( &quot;checked&quot;, 'true' )[0].removeAttribute('checked');</span>
<a href="#l29.801"></a><span id="l29.801">       priorityMenu.getElementsByAttribute( &quot;value&quot;, msgCompFields.priority )[0].setAttribute('checked', 'true');</span>
<a href="#l29.802"></a><span id="l29.802">     }</span>
<a href="#l29.803"></a><span id="l29.803">   }</span>
<a href="#l29.804"></a><span id="l29.804"> }</span>
<a href="#l29.805"></a><span id="l29.805"> </span>
<a href="#l29.806"></a><span id="l29.806"> function updatePriorityToolbarButton(newPriorityValue)</span>
<a href="#l29.807"></a><span id="l29.807"> {</span>
<a href="#l29.808"></a><span id="l29.808" class="difflineat">@@ -2189,29 +2189,29 @@ function InitLanguageMenu()</span>
<a href="#l29.809"></a><span id="l29.809"> </span>
<a href="#l29.810"></a><span id="l29.810">   // sort by locale-aware collation</span>
<a href="#l29.811"></a><span id="l29.811">   dictList.sort(</span>
<a href="#l29.812"></a><span id="l29.812">     function compareFn(a, b)</span>
<a href="#l29.813"></a><span id="l29.813">     {</span>
<a href="#l29.814"></a><span id="l29.814">       return a[0].localeCompare(b[0]);</span>
<a href="#l29.815"></a><span id="l29.815">     }</span>
<a href="#l29.816"></a><span id="l29.816">   );</span>
<a href="#l29.817"></a><span id="l29.817" class="difflineminus">- </span>
<a href="#l29.818"></a><span id="l29.818" class="difflineplus">+</span>
<a href="#l29.819"></a><span id="l29.819">   // Remove any languages from the list.</span>
<a href="#l29.820"></a><span id="l29.820">   while (languageMenuList.hasChildNodes())</span>
<a href="#l29.821"></a><span id="l29.821">     languageMenuList.removeChild(languageMenuList.firstChild);</span>
<a href="#l29.822"></a><span id="l29.822"> </span>
<a href="#l29.823"></a><span id="l29.823">   for (let i = 0; i &lt; count; i++)</span>
<a href="#l29.824"></a><span id="l29.824">   {</span>
<a href="#l29.825"></a><span id="l29.825">     var item = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l29.826"></a><span id="l29.826">     item.setAttribute(&quot;label&quot;, dictList[i][0]);</span>
<a href="#l29.827"></a><span id="l29.827">     item.setAttribute(&quot;value&quot;, dictList[i][1]);</span>
<a href="#l29.828"></a><span id="l29.828">     item.setAttribute('type', 'radio');</span>
<a href="#l29.829"></a><span id="l29.829">     languageMenuList.appendChild(item);</span>
<a href="#l29.830"></a><span id="l29.830" class="difflineminus">-  }      </span>
<a href="#l29.831"></a><span id="l29.831" class="difflineplus">+  }</span>
<a href="#l29.832"></a><span id="l29.832"> }</span>
<a href="#l29.833"></a><span id="l29.833"> </span>
<a href="#l29.834"></a><span id="l29.834"> function OnShowDictionaryMenu(aTarget)</span>
<a href="#l29.835"></a><span id="l29.835"> {</span>
<a href="#l29.836"></a><span id="l29.836">   InitLanguageMenu();</span>
<a href="#l29.837"></a><span id="l29.837">   var curLang = getPref(&quot;spellchecker.dictionary&quot;, true);</span>
<a href="#l29.838"></a><span id="l29.838">   var languages = aTarget.getElementsByAttribute(&quot;value&quot;, curLang);</span>
<a href="#l29.839"></a><span id="l29.839">   if (languages.length &gt; 0)</span>
<a href="#l29.840"></a><span id="l29.840" class="difflineat">@@ -2493,28 +2493,28 @@ function RemoveDraft()</span>
<a href="#l29.841"></a><span id="l29.841">       keyArray[0] = msgKey;</span>
<a href="#l29.842"></a><span id="l29.842">       imapFolder.storeImapFlags(8, true, keyArray, 1, null);</span>
<a href="#l29.843"></a><span id="l29.843">     }</span>
<a href="#l29.844"></a><span id="l29.844">   } catch (ex) {}</span>
<a href="#l29.845"></a><span id="l29.845"> }</span>
<a href="#l29.846"></a><span id="l29.846"> </span>
<a href="#l29.847"></a><span id="l29.847"> function SetContentAndBodyAsUnmodified()</span>
<a href="#l29.848"></a><span id="l29.848"> {</span>
<a href="#l29.849"></a><span id="l29.849" class="difflineminus">-  gMsgCompose.bodyModified = false; </span>
<a href="#l29.850"></a><span id="l29.850" class="difflineplus">+  gMsgCompose.bodyModified = false;</span>
<a href="#l29.851"></a><span id="l29.851">   gContentChanged = false;</span>
<a href="#l29.852"></a><span id="l29.852"> }</span>
<a href="#l29.853"></a><span id="l29.853"> </span>
<a href="#l29.854"></a><span id="l29.854"> function ReleaseAutoCompleteState()</span>
<a href="#l29.855"></a><span id="l29.855"> {</span>
<a href="#l29.856"></a><span id="l29.856">   let maxRecipients = awGetMaxRecipients();</span>
<a href="#l29.857"></a><span id="l29.857">   for (let i = 1; i &lt;= maxRecipients; i++)</span>
<a href="#l29.858"></a><span id="l29.858">     document.getElementById(&quot;addressCol2#&quot; + i).removeSession(gLDAPSession);</span>
<a href="#l29.859"></a><span id="l29.859"> </span>
<a href="#l29.860"></a><span id="l29.860">   gSessionAdded = false;</span>
<a href="#l29.861"></a><span id="l29.861" class="difflineminus">-  gLDAPSession = null;  </span>
<a href="#l29.862"></a><span id="l29.862" class="difflineplus">+  gLDAPSession = null;</span>
<a href="#l29.863"></a><span id="l29.863"> }</span>
<a href="#l29.864"></a><span id="l29.864"> </span>
<a href="#l29.865"></a><span id="l29.865"> function MsgComposeCloseWindow(recycleIt)</span>
<a href="#l29.866"></a><span id="l29.866"> {</span>
<a href="#l29.867"></a><span id="l29.867">   if (gMsgCompose)</span>
<a href="#l29.868"></a><span id="l29.868">     gMsgCompose.CloseWindow(recycleIt);</span>
<a href="#l29.869"></a><span id="l29.869">   else</span>
<a href="#l29.870"></a><span id="l29.870">     window.close();</span>
<a href="#l29.871"></a><span id="l29.871" class="difflineat">@@ -2733,24 +2733,24 @@ function RemoveAllAttachments()</span>
<a href="#l29.872"></a><span id="l29.872">   var child;</span>
<a href="#l29.873"></a><span id="l29.873">   var bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l29.874"></a><span id="l29.874">   while (bucket.getRowCount())</span>
<a href="#l29.875"></a><span id="l29.875">   {</span>
<a href="#l29.876"></a><span id="l29.876">     child = bucket.removeItemAt(bucket.getRowCount() - 1);</span>
<a href="#l29.877"></a><span id="l29.877">     // Let's release the attachment object hold by the node else it won't go away until the window is destroyed</span>
<a href="#l29.878"></a><span id="l29.878">     child.attachment = null;</span>
<a href="#l29.879"></a><span id="l29.879">   }</span>
<a href="#l29.880"></a><span id="l29.880" class="difflineminus">-  </span>
<a href="#l29.881"></a><span id="l29.881" class="difflineplus">+</span>
<a href="#l29.882"></a><span id="l29.882">   ChangeAttachmentBucketVisibility(true);</span>
<a href="#l29.883"></a><span id="l29.883"> }</span>
<a href="#l29.884"></a><span id="l29.884"> </span>
<a href="#l29.885"></a><span id="l29.885"> function ChangeAttachmentBucketVisibility(aHideBucket)</span>
<a href="#l29.886"></a><span id="l29.886"> {</span>
<a href="#l29.887"></a><span id="l29.887">   document.getElementById(&quot;attachments-box&quot;).collapsed = aHideBucket;</span>
<a href="#l29.888"></a><span id="l29.888" class="difflineminus">-  document.getElementById(&quot;attachmentbucket-sizer&quot;).collapsed = aHideBucket;   </span>
<a href="#l29.889"></a><span id="l29.889" class="difflineplus">+  document.getElementById(&quot;attachmentbucket-sizer&quot;).collapsed = aHideBucket;</span>
<a href="#l29.890"></a><span id="l29.890"> }</span>
<a href="#l29.891"></a><span id="l29.891"> </span>
<a href="#l29.892"></a><span id="l29.892"> function RemoveSelectedAttachment()</span>
<a href="#l29.893"></a><span id="l29.893"> {</span>
<a href="#l29.894"></a><span id="l29.894">   var child;</span>
<a href="#l29.895"></a><span id="l29.895">   var bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l29.896"></a><span id="l29.896">   if (bucket.selectedItems.length &gt; 0) {</span>
<a href="#l29.897"></a><span id="l29.897">     for (let i = bucket.selectedCount - 1; i &gt;= 0; i--)</span>
<a href="#l29.898"></a><span id="l29.898" class="difflineat">@@ -2797,37 +2797,37 @@ function FocusOnFirstAttachment()</span>
<a href="#l29.899"></a><span id="l29.899">   if (bucketList &amp;&amp; bucketList.getRowCount())</span>
<a href="#l29.900"></a><span id="l29.900">     bucketList.selectedIndex = 0;</span>
<a href="#l29.901"></a><span id="l29.901"> }</span>
<a href="#l29.902"></a><span id="l29.902"> </span>
<a href="#l29.903"></a><span id="l29.903"> function AttachmentElementHasItems()</span>
<a href="#l29.904"></a><span id="l29.904"> {</span>
<a href="#l29.905"></a><span id="l29.905">   var element = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l29.906"></a><span id="l29.906">   return element ? element.getRowCount() : 0;</span>
<a href="#l29.907"></a><span id="l29.907" class="difflineminus">-}  </span>
<a href="#l29.908"></a><span id="l29.908" class="difflineplus">+}</span>
<a href="#l29.909"></a><span id="l29.909"> </span>
<a href="#l29.910"></a><span id="l29.910"> function OpenSelectedAttachment()</span>
<a href="#l29.911"></a><span id="l29.911"> {</span>
<a href="#l29.912"></a><span id="l29.912">   var child;</span>
<a href="#l29.913"></a><span id="l29.913">   var bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l29.914"></a><span id="l29.914" class="difflineminus">-  if (bucket.selectedItems.length == 1) </span>
<a href="#l29.915"></a><span id="l29.915" class="difflineplus">+  if (bucket.selectedItems.length == 1)</span>
<a href="#l29.916"></a><span id="l29.916">   {</span>
<a href="#l29.917"></a><span id="l29.917">     var attachmentUrl = bucket.getSelectedItem(0).attachment.url;</span>
<a href="#l29.918"></a><span id="l29.918"> </span>
<a href="#l29.919"></a><span id="l29.919">     var messagePrefix = /^mailbox-message:|^imap-message:|^news-message:/i;</span>
<a href="#l29.920"></a><span id="l29.920">     if (messagePrefix.test(attachmentUrl))</span>
<a href="#l29.921"></a><span id="l29.921">     {</span>
<a href="#l29.922"></a><span id="l29.922">       // we must be dealing with a forwarded attachment, treat this special</span>
<a href="#l29.923"></a><span id="l29.923">       var messenger = Components.classes[&quot;@mozilla.org/messenger;1&quot;].createInstance();</span>
<a href="#l29.924"></a><span id="l29.924">       messenger = messenger.QueryInterface(Components.interfaces.nsIMessenger);</span>
<a href="#l29.925"></a><span id="l29.925">       var msgHdr = messenger.messageServiceFromURI(attachmentUrl).messageURIToMsgHdr(attachmentUrl);</span>
<a href="#l29.926"></a><span id="l29.926">       if (msgHdr)</span>
<a href="#l29.927"></a><span id="l29.927">       {</span>
<a href="#l29.928"></a><span id="l29.928">         var folderUri = msgHdr.folder.folderURL;</span>
<a href="#l29.929"></a><span id="l29.929" class="difflineminus">-        window.openDialog(&quot;chrome://messenger/content/messageWindow.xul&quot;, &quot;_blank&quot;, &quot;all,chrome,dialog=no,status,toolbar&quot;, </span>
<a href="#l29.930"></a><span id="l29.930" class="difflineplus">+        window.openDialog(&quot;chrome://messenger/content/messageWindow.xul&quot;, &quot;_blank&quot;, &quot;all,chrome,dialog=no,status,toolbar&quot;,</span>
<a href="#l29.931"></a><span id="l29.931">                           attachmentUrl, folderUri, null );</span>
<a href="#l29.932"></a><span id="l29.932">       }</span>
<a href="#l29.933"></a><span id="l29.933">     }</span>
<a href="#l29.934"></a><span id="l29.934">     else</span>
<a href="#l29.935"></a><span id="l29.935">     {</span>
<a href="#l29.936"></a><span id="l29.936">       // turn the url into a nsIURL object then open it</span>
<a href="#l29.937"></a><span id="l29.937"> </span>
<a href="#l29.938"></a><span id="l29.938">       var url = gIOService.newURI(attachmentUrl, null, null);</span>
<a href="#l29.939"></a><span id="l29.939" class="difflineat">@@ -2836,17 +2836,17 @@ function OpenSelectedAttachment()</span>
<a href="#l29.940"></a><span id="l29.940">       if (url)</span>
<a href="#l29.941"></a><span id="l29.941">       {</span>
<a href="#l29.942"></a><span id="l29.942">         var channel = gIOService.newChannelFromURI(url);</span>
<a href="#l29.943"></a><span id="l29.943">         if (channel)</span>
<a href="#l29.944"></a><span id="l29.944">         {</span>
<a href="#l29.945"></a><span id="l29.945">           var uriLoader = Components.classes[&quot;@mozilla.org/uriloader;1&quot;].getService(Components.interfaces.nsIURILoader);</span>
<a href="#l29.946"></a><span id="l29.946">           uriLoader.openURI(channel, true, new nsAttachmentOpener());</span>
<a href="#l29.947"></a><span id="l29.947">         } // if channel</span>
<a href="#l29.948"></a><span id="l29.948" class="difflineminus">-      } // if url </span>
<a href="#l29.949"></a><span id="l29.949" class="difflineplus">+      } // if url</span>
<a href="#l29.950"></a><span id="l29.950">     }</span>
<a href="#l29.951"></a><span id="l29.951">   } // if one attachment selected</span>
<a href="#l29.952"></a><span id="l29.952"> }</span>
<a href="#l29.953"></a><span id="l29.953"> </span>
<a href="#l29.954"></a><span id="l29.954"> function nsAttachmentOpener()</span>
<a href="#l29.955"></a><span id="l29.955"> {</span>
<a href="#l29.956"></a><span id="l29.956"> }</span>
<a href="#l29.957"></a><span id="l29.957"> </span>
<a href="#l29.958"></a><span id="l29.958" class="difflineat">@@ -2984,17 +2984,17 @@ function DetermineConvertibility()</span>
<a href="#l29.959"></a><span id="l29.959">     } catch(ex) {}</span>
<a href="#l29.960"></a><span id="l29.960">     return nsIMsgCompConvertible.No;</span>
<a href="#l29.961"></a><span id="l29.961"> }</span>
<a href="#l29.962"></a><span id="l29.962"> </span>
<a href="#l29.963"></a><span id="l29.963"> function LoadIdentity(startup)</span>
<a href="#l29.964"></a><span id="l29.964"> {</span>
<a href="#l29.965"></a><span id="l29.965">     var identityElement = document.getElementById(&quot;msgIdentity&quot;);</span>
<a href="#l29.966"></a><span id="l29.966">     var prevIdentity = gCurrentIdentity;</span>
<a href="#l29.967"></a><span id="l29.967" class="difflineminus">-    </span>
<a href="#l29.968"></a><span id="l29.968" class="difflineplus">+</span>
<a href="#l29.969"></a><span id="l29.969">     if (identityElement) {</span>
<a href="#l29.970"></a><span id="l29.970">         var idKey = identityElement.value;</span>
<a href="#l29.971"></a><span id="l29.971">         gCurrentIdentity = gAccountManager.getIdentity(idKey);</span>
<a href="#l29.972"></a><span id="l29.972"> </span>
<a href="#l29.973"></a><span id="l29.973">         // set the  account name on the menu list value.</span>
<a href="#l29.974"></a><span id="l29.974">         if (identityElement.selectedItem)</span>
<a href="#l29.975"></a><span id="l29.975">           identityElement.setAttribute('accountname', identityElement.selectedItem.getAttribute('accountname'));</span>
<a href="#l29.976"></a><span id="l29.976"> </span>
<a href="#l29.977"></a><span id="l29.977" class="difflineat">@@ -3017,17 +3017,17 @@ function LoadIdentity(startup)</span>
<a href="#l29.978"></a><span id="l29.978"> </span>
<a href="#l29.979"></a><span id="l29.979">           var newReplyTo = gCurrentIdentity.replyTo;</span>
<a href="#l29.980"></a><span id="l29.980">           var newBcc = &quot;&quot;;</span>
<a href="#l29.981"></a><span id="l29.981">           var newReceipt = gCurrentIdentity.requestReturnReceipt;</span>
<a href="#l29.982"></a><span id="l29.982">           var newDSN = gCurrentIdentity.DSN;</span>
<a href="#l29.983"></a><span id="l29.983">           var newAttachVCard = gCurrentIdentity.attachVCard;</span>
<a href="#l29.984"></a><span id="l29.984"> </span>
<a href="#l29.985"></a><span id="l29.985">           if (gCurrentIdentity.doBcc)</span>
<a href="#l29.986"></a><span id="l29.986" class="difflineminus">-            newBcc += gCurrentIdentity.doBccList;          </span>
<a href="#l29.987"></a><span id="l29.987" class="difflineplus">+            newBcc += gCurrentIdentity.doBccList;</span>
<a href="#l29.988"></a><span id="l29.988"> </span>
<a href="#l29.989"></a><span id="l29.989">           var needToCleanUp = false;</span>
<a href="#l29.990"></a><span id="l29.990">           var msgCompFields = gMsgCompose.compFields;</span>
<a href="#l29.991"></a><span id="l29.991"> </span>
<a href="#l29.992"></a><span id="l29.992">           if (!gReceiptOptionChanged &amp;&amp;</span>
<a href="#l29.993"></a><span id="l29.993">               prevReceipt == msgCompFields.returnReceipt &amp;&amp;</span>
<a href="#l29.994"></a><span id="l29.994">               prevReceipt != newReceipt)</span>
<a href="#l29.995"></a><span id="l29.995">           {</span>
<a href="#l29.996"></a><span id="l29.996" class="difflineat">@@ -3084,17 +3084,17 @@ function LoadIdentity(startup)</span>
<a href="#l29.997"></a><span id="l29.997">       AddDirectoryServerObserver(false);</span>
<a href="#l29.998"></a><span id="l29.998">       if (!startup) {</span>
<a href="#l29.999"></a><span id="l29.999">           if (getPref(&quot;mail.autoComplete.highlightNonMatches&quot;))</span>
<a href="#l29.1000"></a><span id="l29.1000">             document.getElementById('addressCol2#1').highlightNonMatches = true;</span>
<a href="#l29.1001"></a><span id="l29.1001"> </span>
<a href="#l29.1002"></a><span id="l29.1002">           try {</span>
<a href="#l29.1003"></a><span id="l29.1003">               setupLdapAutocompleteSession();</span>
<a href="#l29.1004"></a><span id="l29.1004">           } catch (ex) {</span>
<a href="#l29.1005"></a><span id="l29.1005" class="difflineminus">-              // catch the exception and ignore it, so that if LDAP setup </span>
<a href="#l29.1006"></a><span id="l29.1006" class="difflineplus">+              // catch the exception and ignore it, so that if LDAP setup</span>
<a href="#l29.1007"></a><span id="l29.1007">               // fails, the entire compose window doesn't end up horked</span>
<a href="#l29.1008"></a><span id="l29.1008">           }</span>
<a href="#l29.1009"></a><span id="l29.1009"> </span>
<a href="#l29.1010"></a><span id="l29.1010">           addRecipientsToIgnoreList(gCurrentIdentity.identityName);  // only do this if we aren't starting up....it gets done as part of startup already</span>
<a href="#l29.1011"></a><span id="l29.1011">       }</span>
<a href="#l29.1012"></a><span id="l29.1012">     }</span>
<a href="#l29.1013"></a><span id="l29.1013"> }</span>
<a href="#l29.1014"></a><span id="l29.1014"> </span>
<a href="#l29.1015"></a><span id="l29.1015" class="difflineat">@@ -3102,47 +3102,47 @@ function setupAutocomplete()</span>
<a href="#l29.1016"></a><span id="l29.1016"> {</span>
<a href="#l29.1017"></a><span id="l29.1017">   var autoCompleteWidget = document.getElementById(&quot;addressCol2#1&quot;);</span>
<a href="#l29.1018"></a><span id="l29.1018">   // When autocompleteToMyDomain is off there is no default entry with the domain</span>
<a href="#l29.1019"></a><span id="l29.1019">   // appended so reduce the minimum results for a popup to 2 in this case.</span>
<a href="#l29.1020"></a><span id="l29.1020">   if (!gCurrentIdentity.autocompleteToMyDomain)</span>
<a href="#l29.1021"></a><span id="l29.1021">     autoCompleteWidget.minResultsForPopup = 2;</span>
<a href="#l29.1022"></a><span id="l29.1022"> </span>
<a href="#l29.1023"></a><span id="l29.1023">   // if the pref is set to turn on the comment column, honor it here.</span>
<a href="#l29.1024"></a><span id="l29.1024" class="difflineminus">-  // this element then gets cloned for subsequent rows, so they should </span>
<a href="#l29.1025"></a><span id="l29.1025" class="difflineplus">+  // this element then gets cloned for subsequent rows, so they should</span>
<a href="#l29.1026"></a><span id="l29.1026">   // honor it as well</span>
<a href="#l29.1027"></a><span id="l29.1027">   //</span>
<a href="#l29.1028"></a><span id="l29.1028" class="difflineminus">-  try </span>
<a href="#l29.1029"></a><span id="l29.1029" class="difflineplus">+  try</span>
<a href="#l29.1030"></a><span id="l29.1030">   {</span>
<a href="#l29.1031"></a><span id="l29.1031">     if (getPref(&quot;mail.autoComplete.highlightNonMatches&quot;))</span>
<a href="#l29.1032"></a><span id="l29.1032">       autoCompleteWidget.highlightNonMatches = true;</span>
<a href="#l29.1033"></a><span id="l29.1033"> </span>
<a href="#l29.1034"></a><span id="l29.1034">     if (getPref(&quot;mail.autoComplete.commentColumn&quot;))</span>
<a href="#l29.1035"></a><span id="l29.1035">       autoCompleteWidget.showCommentColumn = true;</span>
<a href="#l29.1036"></a><span id="l29.1036" class="difflineminus">-  } catch (ex) </span>
<a href="#l29.1037"></a><span id="l29.1037" class="difflineplus">+  } catch (ex)</span>
<a href="#l29.1038"></a><span id="l29.1038">   {</span>
<a href="#l29.1039"></a><span id="l29.1039">       // if we can't get this pref, then don't show the columns (which is</span>
<a href="#l29.1040"></a><span id="l29.1040">       // what the XUL defaults to)</span>
<a href="#l29.1041"></a><span id="l29.1041">   }</span>
<a href="#l29.1042"></a><span id="l29.1042" class="difflineminus">-  </span>
<a href="#l29.1043"></a><span id="l29.1043" class="difflineminus">-  if (!gSetupLdapAutocomplete) </span>
<a href="#l29.1044"></a><span id="l29.1044" class="difflineplus">+</span>
<a href="#l29.1045"></a><span id="l29.1045" class="difflineplus">+  if (!gSetupLdapAutocomplete)</span>
<a href="#l29.1046"></a><span id="l29.1046">   {</span>
<a href="#l29.1047"></a><span id="l29.1047" class="difflineminus">-    try </span>
<a href="#l29.1048"></a><span id="l29.1048" class="difflineplus">+    try</span>
<a href="#l29.1049"></a><span id="l29.1049">     {</span>
<a href="#l29.1050"></a><span id="l29.1050">           setupLdapAutocompleteSession();</span>
<a href="#l29.1051"></a><span id="l29.1051" class="difflineminus">-    } catch (ex) </span>
<a href="#l29.1052"></a><span id="l29.1052" class="difflineplus">+    } catch (ex)</span>
<a href="#l29.1053"></a><span id="l29.1053">     {</span>
<a href="#l29.1054"></a><span id="l29.1054" class="difflineminus">-          // catch the exception and ignore it, so that if LDAP setup </span>
<a href="#l29.1055"></a><span id="l29.1055" class="difflineplus">+          // catch the exception and ignore it, so that if LDAP setup</span>
<a href="#l29.1056"></a><span id="l29.1056">           // fails, the entire compose window doesn't end up horked</span>
<a href="#l29.1057"></a><span id="l29.1057">       }</span>
<a href="#l29.1058"></a><span id="l29.1058">   }</span>
<a href="#l29.1059"></a><span id="l29.1059"> }</span>
<a href="#l29.1060"></a><span id="l29.1060"> </span>
<a href="#l29.1061"></a><span id="l29.1061"> function subjectKeyPress(event)</span>
<a href="#l29.1062"></a><span id="l29.1062" class="difflineminus">-{  </span>
<a href="#l29.1063"></a><span id="l29.1063" class="difflineplus">+{</span>
<a href="#l29.1064"></a><span id="l29.1064">   switch(event.keyCode) {</span>
<a href="#l29.1065"></a><span id="l29.1065">   case KeyEvent.DOM_VK_TAB:</span>
<a href="#l29.1066"></a><span id="l29.1066">     if (!event.shiftKey) {</span>
<a href="#l29.1067"></a><span id="l29.1067">       SetMsgBodyFrameFocus();</span>
<a href="#l29.1068"></a><span id="l29.1068">       event.preventDefault();</span>
<a href="#l29.1069"></a><span id="l29.1069">     }</span>
<a href="#l29.1070"></a><span id="l29.1070">     break;</span>
<a href="#l29.1071"></a><span id="l29.1071">   case KeyEvent.DOM_VK_RETURN:</span>
<a href="#l29.1072"></a><span id="l29.1072" class="difflineat">@@ -3156,17 +3156,17 @@ function AttachmentBucketClicked(event)</span>
<a href="#l29.1073"></a><span id="l29.1073">   event.currentTarget.focus();</span>
<a href="#l29.1074"></a><span id="l29.1074"> </span>
<a href="#l29.1075"></a><span id="l29.1075">   if (event.button != 0)</span>
<a href="#l29.1076"></a><span id="l29.1076">     return;</span>
<a href="#l29.1077"></a><span id="l29.1077"> </span>
<a href="#l29.1078"></a><span id="l29.1078">   if (event.originalTarget.localName == &quot;listboxbody&quot;)</span>
<a href="#l29.1079"></a><span id="l29.1079">     goDoCommand('cmd_attachFile');</span>
<a href="#l29.1080"></a><span id="l29.1080">   else if (event.originalTarget.localName == &quot;listitem&quot; &amp;&amp; event.detail == 2)</span>
<a href="#l29.1081"></a><span id="l29.1081" class="difflineminus">-    OpenSelectedAttachment();    </span>
<a href="#l29.1082"></a><span id="l29.1082" class="difflineplus">+    OpenSelectedAttachment();</span>
<a href="#l29.1083"></a><span id="l29.1083"> }</span>
<a href="#l29.1084"></a><span id="l29.1084"> </span>
<a href="#l29.1085"></a><span id="l29.1085"> // we can drag and drop addresses, files, messages and urls into the compose envelope</span>
<a href="#l29.1086"></a><span id="l29.1086"> var envelopeDragObserver = {</span>
<a href="#l29.1087"></a><span id="l29.1087"> </span>
<a href="#l29.1088"></a><span id="l29.1088">   canHandleMultipleItems: true,</span>
<a href="#l29.1089"></a><span id="l29.1089"> </span>
<a href="#l29.1090"></a><span id="l29.1090">   onDrop: function (aEvent, aData, aDragSession)</span>
<a href="#l29.1091"></a><span id="l29.1091" class="difflineat">@@ -3195,33 +3195,33 @@ var envelopeDragObserver = {</span>
<a href="#l29.1092"></a><span id="l29.1092">                                         .getService(Components.interfaces.nsIIOService)</span>
<a href="#l29.1093"></a><span id="l29.1093">                                         .getProtocolHandler(&quot;file&quot;)</span>
<a href="#l29.1094"></a><span id="l29.1094">                                         .QueryInterface(Components.interfaces.nsIFileProtocolHandler);</span>
<a href="#l29.1095"></a><span id="l29.1095">             rawData = fileHandler.getURLSpecFromFile(rawData);</span>
<a href="#l29.1096"></a><span id="l29.1096">           }</span>
<a href="#l29.1097"></a><span id="l29.1097">           else</span>
<a href="#l29.1098"></a><span id="l29.1098">           {</span>
<a href="#l29.1099"></a><span id="l29.1099">             var separator = rawData.indexOf(&quot;\n&quot;);</span>
<a href="#l29.1100"></a><span id="l29.1100" class="difflineminus">-            if (separator != -1) </span>
<a href="#l29.1101"></a><span id="l29.1101" class="difflineplus">+            if (separator != -1)</span>
<a href="#l29.1102"></a><span id="l29.1102">             {</span>
<a href="#l29.1103"></a><span id="l29.1103">               prettyName = rawData.substr(separator+1);</span>
<a href="#l29.1104"></a><span id="l29.1104">               rawData = rawData.substr(0,separator);</span>
<a href="#l29.1105"></a><span id="l29.1105">             }</span>
<a href="#l29.1106"></a><span id="l29.1106">           }</span>
<a href="#l29.1107"></a><span id="l29.1107"> </span>
<a href="#l29.1108"></a><span id="l29.1108">           if (DuplicateFileAlreadyAttached(rawData))</span>
<a href="#l29.1109"></a><span id="l29.1109">           {</span>
<a href="#l29.1110"></a><span id="l29.1110">             dump(&quot;Skipping file &quot;+rawData+&quot;; already attached!\n&quot;);</span>
<a href="#l29.1111"></a><span id="l29.1111">           }</span>
<a href="#l29.1112"></a><span id="l29.1112">           else</span>
<a href="#l29.1113"></a><span id="l29.1113">           {</span>
<a href="#l29.1114"></a><span id="l29.1114">             var isValid = true;</span>
<a href="#l29.1115"></a><span id="l29.1115">             if (item.flavour.contentType == &quot;text/x-moz-url&quot;) {</span>
<a href="#l29.1116"></a><span id="l29.1116">               // if this is a url (or selected text)</span>
<a href="#l29.1117"></a><span id="l29.1117" class="difflineminus">-              // see if it's a valid url by checking </span>
<a href="#l29.1118"></a><span id="l29.1118" class="difflineplus">+              // see if it's a valid url by checking</span>
<a href="#l29.1119"></a><span id="l29.1119">               // if we can extract a scheme</span>
<a href="#l29.1120"></a><span id="l29.1120">               // using the ioservice</span>
<a href="#l29.1121"></a><span id="l29.1121">               //</span>
<a href="#l29.1122"></a><span id="l29.1122">               // also skip mailto:, since it doesn't make sense</span>
<a href="#l29.1123"></a><span id="l29.1123">               // to attach and send mailto urls</span>
<a href="#l29.1124"></a><span id="l29.1124">               try {</span>
<a href="#l29.1125"></a><span id="l29.1125">                 var scheme = gIOService.extractScheme(rawData);</span>
<a href="#l29.1126"></a><span id="l29.1126">                 // don't attach mailto: urls</span>
<a href="#l29.1127"></a><span id="l29.1127" class="difflineat">@@ -3271,17 +3271,17 @@ var envelopeDragObserver = {</span>
<a href="#l29.1128"></a><span id="l29.1128">     },</span>
<a href="#l29.1129"></a><span id="l29.1129"> </span>
<a href="#l29.1130"></a><span id="l29.1130">   getSupportedFlavours: function ()</span>
<a href="#l29.1131"></a><span id="l29.1131">     {</span>
<a href="#l29.1132"></a><span id="l29.1132">       var flavourSet = new FlavourSet();</span>
<a href="#l29.1133"></a><span id="l29.1133">       flavourSet.appendFlavour(&quot;text/x-moz-url&quot;);</span>
<a href="#l29.1134"></a><span id="l29.1134">       flavourSet.appendFlavour(&quot;text/x-moz-message&quot;);</span>
<a href="#l29.1135"></a><span id="l29.1135">       flavourSet.appendFlavour(&quot;application/x-moz-file&quot;, &quot;nsIFile&quot;);</span>
<a href="#l29.1136"></a><span id="l29.1136" class="difflineminus">-      flavourSet.appendFlavour(&quot;text/x-moz-address&quot;);      </span>
<a href="#l29.1137"></a><span id="l29.1137" class="difflineplus">+      flavourSet.appendFlavour(&quot;text/x-moz-address&quot;);</span>
<a href="#l29.1138"></a><span id="l29.1138">       return flavourSet;</span>
<a href="#l29.1139"></a><span id="l29.1139">     }</span>
<a href="#l29.1140"></a><span id="l29.1140"> };</span>
<a href="#l29.1141"></a><span id="l29.1141"> </span>
<a href="#l29.1142"></a><span id="l29.1142"> function DisplaySaveFolderDlg(folderURI)</span>
<a href="#l29.1143"></a><span id="l29.1143"> {</span>
<a href="#l29.1144"></a><span id="l29.1144">   try</span>
<a href="#l29.1145"></a><span id="l29.1145">   {</span>
<a href="#l29.1146"></a><span id="l29.1146" class="difflineat">@@ -3406,17 +3406,17 @@ function WhichElementHasFocus()</span>
<a href="#l29.1147"></a><span id="l29.1147">       return currentNode;</span>
<a href="#l29.1148"></a><span id="l29.1148"> </span>
<a href="#l29.1149"></a><span id="l29.1149">     currentNode = currentNode.parentNode;</span>
<a href="#l29.1150"></a><span id="l29.1150">   }</span>
<a href="#l29.1151"></a><span id="l29.1151"> </span>
<a href="#l29.1152"></a><span id="l29.1152">   return null;</span>
<a href="#l29.1153"></a><span id="l29.1153"> }</span>
<a href="#l29.1154"></a><span id="l29.1154"> </span>
<a href="#l29.1155"></a><span id="l29.1155" class="difflineminus">-// Function that performs the logic of switching focus from </span>
<a href="#l29.1156"></a><span id="l29.1156" class="difflineplus">+// Function that performs the logic of switching focus from</span>
<a href="#l29.1157"></a><span id="l29.1157"> // one element to another in the mail compose window.</span>
<a href="#l29.1158"></a><span id="l29.1158"> // The default element to switch to when going in either</span>
<a href="#l29.1159"></a><span id="l29.1159"> // direction (shift or no shift key pressed), is the</span>
<a href="#l29.1160"></a><span id="l29.1160"> // AddressingWidgetTreeElement.</span>
<a href="#l29.1161"></a><span id="l29.1161"> //</span>
<a href="#l29.1162"></a><span id="l29.1162"> // The only exception is when the MsgHeadersToolbar is</span>
<a href="#l29.1163"></a><span id="l29.1163"> // collapsed, then the focus will always be on the body of</span>
<a href="#l29.1164"></a><span id="l29.1164"> // the message.</span>
<a href="#l29.1165"></a><span id="l29.1165" class="difflineat">@@ -3466,17 +3466,17 @@ function SwitchElementFocus(event)</span>
<a href="#l29.1166"></a><span id="l29.1166">   }</span>
<a href="#l29.1167"></a><span id="l29.1167"> }</span>
<a href="#l29.1168"></a><span id="l29.1168"> </span>
<a href="#l29.1169"></a><span id="l29.1169"> function toggleAddressPicker()</span>
<a href="#l29.1170"></a><span id="l29.1170"> {</span>
<a href="#l29.1171"></a><span id="l29.1171">   var sidebarBox = document.getElementById(&quot;sidebar-box&quot;);</span>
<a href="#l29.1172"></a><span id="l29.1172">   var sidebarSplitter = document.getElementById(&quot;sidebar-splitter&quot;);</span>
<a href="#l29.1173"></a><span id="l29.1173">   var elt = document.getElementById(&quot;viewAddressPicker&quot;);</span>
<a href="#l29.1174"></a><span id="l29.1174" class="difflineminus">-  if (sidebarBox.hidden) </span>
<a href="#l29.1175"></a><span id="l29.1175" class="difflineplus">+  if (sidebarBox.hidden)</span>
<a href="#l29.1176"></a><span id="l29.1176">   {</span>
<a href="#l29.1177"></a><span id="l29.1177">     sidebarBox.hidden = false;</span>
<a href="#l29.1178"></a><span id="l29.1178">     sidebarSplitter.hidden = false;</span>
<a href="#l29.1179"></a><span id="l29.1179">     elt.setAttribute(&quot;checked&quot;,&quot;true&quot;);</span>
<a href="#l29.1180"></a><span id="l29.1180"> </span>
<a href="#l29.1181"></a><span id="l29.1181">     var sidebar = document.getElementById(&quot;sidebar&quot;);</span>
<a href="#l29.1182"></a><span id="l29.1182">     var sidebarUrl = sidebar.getAttribute(&quot;src&quot;);</span>
<a href="#l29.1183"></a><span id="l29.1183">     // if we have yet to initialize the src url on the sidebar than go ahead and do so now...</span>
<a href="#l29.1184"></a><span id="l29.1184" class="difflineat">@@ -3503,71 +3503,71 @@ function AddRecipient(recipientType, add</span>
<a href="#l29.1185"></a><span id="l29.1185"> }</span>
<a href="#l29.1186"></a><span id="l29.1186"> </span>
<a href="#l29.1187"></a><span id="l29.1187"> function loadHTMLMsgPrefs()</span>
<a href="#l29.1188"></a><span id="l29.1188"> {</span>
<a href="#l29.1189"></a><span id="l29.1189">   var fontFace;</span>
<a href="#l29.1190"></a><span id="l29.1190">   var fontSize;</span>
<a href="#l29.1191"></a><span id="l29.1191">   var textColor;</span>
<a href="#l29.1192"></a><span id="l29.1192">   var bgColor;</span>
<a href="#l29.1193"></a><span id="l29.1193" class="difflineminus">-  </span>
<a href="#l29.1194"></a><span id="l29.1194" class="difflineminus">-  try { </span>
<a href="#l29.1195"></a><span id="l29.1195" class="difflineplus">+</span>
<a href="#l29.1196"></a><span id="l29.1196" class="difflineplus">+  try {</span>
<a href="#l29.1197"></a><span id="l29.1197">     fontFace = getPref(&quot;msgcompose.font_face&quot;, true);</span>
<a href="#l29.1198"></a><span id="l29.1198">     doStatefulCommand('cmd_fontFace', fontFace);</span>
<a href="#l29.1199"></a><span id="l29.1199">   } catch (e) {}</span>
<a href="#l29.1200"></a><span id="l29.1200"> </span>
<a href="#l29.1201"></a><span id="l29.1201" class="difflineminus">-  try { </span>
<a href="#l29.1202"></a><span id="l29.1202" class="difflineplus">+  try {</span>
<a href="#l29.1203"></a><span id="l29.1203">     fontSize = getPref(&quot;msgcompose.font_size&quot;);</span>
<a href="#l29.1204"></a><span id="l29.1204">     EditorSetFontSize(fontSize);</span>
<a href="#l29.1205"></a><span id="l29.1205">   } catch (e) {}</span>
<a href="#l29.1206"></a><span id="l29.1206"> </span>
<a href="#l29.1207"></a><span id="l29.1207">   var bodyElement = GetBodyElement();</span>
<a href="#l29.1208"></a><span id="l29.1208"> </span>
<a href="#l29.1209"></a><span id="l29.1209" class="difflineminus">-  try { </span>
<a href="#l29.1210"></a><span id="l29.1210" class="difflineplus">+  try {</span>
<a href="#l29.1211"></a><span id="l29.1211">     textColor = getPref(&quot;msgcompose.text_color&quot;);</span>
<a href="#l29.1212"></a><span id="l29.1212">     if (!bodyElement.getAttribute(&quot;text&quot;))</span>
<a href="#l29.1213"></a><span id="l29.1213">     {</span>
<a href="#l29.1214"></a><span id="l29.1214">     bodyElement.setAttribute(&quot;text&quot;, textColor);</span>
<a href="#l29.1215"></a><span id="l29.1215">     gDefaultTextColor = textColor;</span>
<a href="#l29.1216"></a><span id="l29.1216" class="difflineminus">-    document.getElementById(&quot;cmd_fontColor&quot;).setAttribute(&quot;state&quot;, textColor);    </span>
<a href="#l29.1217"></a><span id="l29.1217" class="difflineplus">+    document.getElementById(&quot;cmd_fontColor&quot;).setAttribute(&quot;state&quot;, textColor);</span>
<a href="#l29.1218"></a><span id="l29.1218">     onFontColorChange();</span>
<a href="#l29.1219"></a><span id="l29.1219">     }</span>
<a href="#l29.1220"></a><span id="l29.1220">   } catch (e) {}</span>
<a href="#l29.1221"></a><span id="l29.1221"> </span>
<a href="#l29.1222"></a><span id="l29.1222" class="difflineminus">-  try { </span>
<a href="#l29.1223"></a><span id="l29.1223" class="difflineplus">+  try {</span>
<a href="#l29.1224"></a><span id="l29.1224">     bgColor = getPref(&quot;msgcompose.background_color&quot;);</span>
<a href="#l29.1225"></a><span id="l29.1225">     if (!bodyElement.getAttribute(&quot;bgcolor&quot;))</span>
<a href="#l29.1226"></a><span id="l29.1226">     {</span>
<a href="#l29.1227"></a><span id="l29.1227">     bodyElement.setAttribute(&quot;bgcolor&quot;, bgColor);</span>
<a href="#l29.1228"></a><span id="l29.1228">     gDefaultBackgroundColor = bgColor;</span>
<a href="#l29.1229"></a><span id="l29.1229">     document.getElementById(&quot;cmd_backgroundColor&quot;).setAttribute(&quot;state&quot;, bgColor);</span>
<a href="#l29.1230"></a><span id="l29.1230">     onBackgroundColorChange();</span>
<a href="#l29.1231"></a><span id="l29.1231">     }</span>
<a href="#l29.1232"></a><span id="l29.1232">   } catch (e) {}</span>
<a href="#l29.1233"></a><span id="l29.1233"> }</span>
<a href="#l29.1234"></a><span id="l29.1234"> </span>
<a href="#l29.1235"></a><span id="l29.1235"> function AutoSave()</span>
<a href="#l29.1236"></a><span id="l29.1236"> {</span>
<a href="#l29.1237"></a><span id="l29.1237" class="difflineminus">-  if (gMsgCompose.editor &amp;&amp; (gContentChanged || gMsgCompose.bodyModified) </span>
<a href="#l29.1238"></a><span id="l29.1238" class="difflineplus">+  if (gMsgCompose.editor &amp;&amp; (gContentChanged || gMsgCompose.bodyModified)</span>
<a href="#l29.1239"></a><span id="l29.1239">       &amp;&amp; !gSendOrSaveOperationInProgress)</span>
<a href="#l29.1240"></a><span id="l29.1240">   {</span>
<a href="#l29.1241"></a><span id="l29.1241">     GenericSendMessage(nsIMsgCompDeliverMode.AutoSaveAsDraft);</span>
<a href="#l29.1242"></a><span id="l29.1242">     gAutoSaveKickedIn = true;</span>
<a href="#l29.1243"></a><span id="l29.1243">   }</span>
<a href="#l29.1244"></a><span id="l29.1244"> </span>
<a href="#l29.1245"></a><span id="l29.1245">   gAutoSaveTimeout = setTimeout(AutoSave, gAutoSaveInterval);</span>
<a href="#l29.1246"></a><span id="l29.1246"> }</span>
<a href="#l29.1247"></a><span id="l29.1247"> </span>
<a href="#l29.1248"></a><span id="l29.1248"> function InitEditor()</span>
<a href="#l29.1249"></a><span id="l29.1249"> {</span>
<a href="#l29.1250"></a><span id="l29.1250">   var editor = GetCurrentEditor();</span>
<a href="#l29.1251"></a><span id="l29.1251">   editor.QueryInterface(nsIEditorStyleSheets);</span>
<a href="#l29.1252"></a><span id="l29.1252">   editor.addOverrideStyleSheet(&quot;chrome://messenger/content/composerOverlay.css&quot;);</span>
<a href="#l29.1253"></a><span id="l29.1253">   gMsgCompose.initEditor(editor, window.content);</span>
<a href="#l29.1254"></a><span id="l29.1254" class="difflineminus">-  </span>
<a href="#l29.1255"></a><span id="l29.1255" class="difflineplus">+</span>
<a href="#l29.1256"></a><span id="l29.1256">   InlineSpellCheckerUI.init(editor);</span>
<a href="#l29.1257"></a><span id="l29.1257">   enableInlineSpellCheck(getPref(&quot;mail.spellcheck.inline&quot;));</span>
<a href="#l29.1258"></a><span id="l29.1258">   document.getElementById('menu_inlineSpellCheck').setAttribute('disabled', !InlineSpellCheckerUI.canSpellCheck);</span>
<a href="#l29.1259"></a><span id="l29.1259"> }</span>
<a href="#l29.1260"></a><span id="l29.1260"> </span>
<a href="#l29.1261"></a><span id="l29.1261"> function enableInlineSpellCheck(aEnableInlineSpellCheck)</span>
<a href="#l29.1262"></a><span id="l29.1262"> {</span>
<a href="#l29.1263"></a><span id="l29.1263">   InlineSpellCheckerUI.enabled = aEnableInlineSpellCheck;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mail/components/compose/jar.mn</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mail/components/compose/jar.mn</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -1,9 +1,9 @@</span>
<a href="#l30.4"></a><span id="l30.4"> messenger.jar:</span>
<a href="#l30.5"></a><span id="l30.5"> % overlay chrome://editor/content/EdImageOverlay.xul chrome://messenger/content/messengercompose/mailComposeEditorOverlay.xul</span>
<a href="#l30.6"></a><span id="l30.6"> % overlay chrome://editor/content/EdLinkProps.xul chrome://messenger/content/messengercompose/mailComposeEditorOverlay.xul</span>
<a href="#l30.7"></a><span id="l30.7"> *   content/messenger/messengercompose/messengercompose.xul        (content/messengercompose.xul)</span>
<a href="#l30.8"></a><span id="l30.8" class="difflineminus">-*   content/messenger/messengercompose/MsgComposeCommands.js       (content/MsgComposeCommands.js)</span>
<a href="#l30.9"></a><span id="l30.9" class="difflineplus">+    content/messenger/messengercompose/MsgComposeCommands.js       (content/MsgComposeCommands.js)</span>
<a href="#l30.10"></a><span id="l30.10"> *   content/messenger/messengercompose/addressingWidgetOverlay.js  (content/addressingWidgetOverlay.js)</span>
<a href="#l30.11"></a><span id="l30.11"> </span>
<a href="#l30.12"></a><span id="l30.12"> comm.jar:</span>
<a href="#l30.13"></a><span id="l30.13"> *+  content/editor/editorOverlay.xul                               (content/editorOverlay.xul) </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mail/extensions/mailviews/content/msgViewPickerOverlay.js</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mail/extensions/mailviews/content/msgViewPickerOverlay.js</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -1,10 +1,9 @@</span>
<a href="#l31.4"></a><span id="l31.4" class="difflineminus">-/* -*- Mode: Java; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l31.5"></a><span id="l31.5" class="difflineminus">- * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l31.6"></a><span id="l31.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l31.7"></a><span id="l31.7">  * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l31.8"></a><span id="l31.8">  *</span>
<a href="#l31.9"></a><span id="l31.9">  * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l31.10"></a><span id="l31.10">  * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l31.11"></a><span id="l31.11">  * the License. You may obtain a copy of the License at</span>
<a href="#l31.12"></a><span id="l31.12">  * http://www.mozilla.org/MPL/</span>
<a href="#l31.13"></a><span id="l31.13">  *</span>
<a href="#l31.14"></a><span id="l31.14">  * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l31.15"></a><span id="l31.15" class="difflineat">@@ -33,428 +32,267 @@</span>
<a href="#l31.16"></a><span id="l31.16">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l31.17"></a><span id="l31.17">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l31.18"></a><span id="l31.18">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l31.19"></a><span id="l31.19">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l31.20"></a><span id="l31.20">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l31.21"></a><span id="l31.21">  *</span>
<a href="#l31.22"></a><span id="l31.22">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l31.23"></a><span id="l31.23"> </span>
<a href="#l31.24"></a><span id="l31.24" class="difflineminus">-// menuitem value constants</span>
<a href="#l31.25"></a><span id="l31.25" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/mailViewManager.js&quot;);</span>
<a href="#l31.26"></a><span id="l31.26" class="difflineplus">+</span>
<a href="#l31.27"></a><span id="l31.27" class="difflineplus">+// these constants are now authoritatively defined in mailViewManager.js (above)</span>
<a href="#l31.28"></a><span id="l31.28"> // tag views have kViewTagMarker + their key as value</span>
<a href="#l31.29"></a><span id="l31.29" class="difflineminus">-const kViewItemAll         = 0;</span>
<a href="#l31.30"></a><span id="l31.30" class="difflineminus">-const kViewItemUnread      = 1;</span>
<a href="#l31.31"></a><span id="l31.31" class="difflineminus">-const kViewItemTags        = 2; // former labels used values 2-6</span>
<a href="#l31.32"></a><span id="l31.32" class="difflineminus">-const kViewItemNotDeleted  = 3;</span>
<a href="#l31.33"></a><span id="l31.33" class="difflineminus">-const kViewItemVirtual     = 7;</span>
<a href="#l31.34"></a><span id="l31.34" class="difflineminus">-const kViewItemCustomize   = 8;</span>
<a href="#l31.35"></a><span id="l31.35" class="difflineminus">-const kViewItemFirstCustom = 9;</span>
<a href="#l31.36"></a><span id="l31.36" class="difflineplus">+const kViewItemAll         = MailViewConstants.kViewItemAll;</span>
<a href="#l31.37"></a><span id="l31.37" class="difflineplus">+const kViewItemUnread      = MailViewConstants.kViewItemUnread;</span>
<a href="#l31.38"></a><span id="l31.38" class="difflineplus">+const kViewItemTags        = MailViewConstants.kViewItemTags; // former labels used values 2-6</span>
<a href="#l31.39"></a><span id="l31.39" class="difflineplus">+const kViewItemNotDeleted  = MailViewConstants.kViewItemNotDeleted;</span>
<a href="#l31.40"></a><span id="l31.40" class="difflineplus">+// not a real view! a sentinel value to pop up a dialog</span>
<a href="#l31.41"></a><span id="l31.41" class="difflineplus">+const kViewItemVirtual     = MailViewConstants.kViewItemVirtual;</span>
<a href="#l31.42"></a><span id="l31.42" class="difflineplus">+// not a real view! a sentinel value to pop up a dialog</span>
<a href="#l31.43"></a><span id="l31.43" class="difflineplus">+const kViewItemCustomize   = MailViewConstants.kViewItemCustomize;</span>
<a href="#l31.44"></a><span id="l31.44" class="difflineplus">+const kViewItemFirstCustom = MailViewConstants.kViewItemFirstCustom;</span>
<a href="#l31.45"></a><span id="l31.45"> </span>
<a href="#l31.46"></a><span id="l31.46" class="difflineminus">-const kViewCurrent    = &quot;current-view&quot;;</span>
<a href="#l31.47"></a><span id="l31.47" class="difflineminus">-const kViewCurrentTag = &quot;current-view-tag&quot;;</span>
<a href="#l31.48"></a><span id="l31.48" class="difflineminus">-const kViewTagMarker  = &quot;:&quot;;</span>
<a href="#l31.49"></a><span id="l31.49" class="difflineplus">+const kViewCurrent    = MailViewConstants.kViewCurrent;</span>
<a href="#l31.50"></a><span id="l31.50" class="difflineplus">+const kViewCurrentTag = MailViewConstants.kViewCurrentTag;</span>
<a href="#l31.51"></a><span id="l31.51" class="difflineplus">+const kViewTagMarker  = MailViewConstants.kViewTagMarker;</span>
<a href="#l31.52"></a><span id="l31.52"> </span>
<a href="#l31.53"></a><span id="l31.53" class="difflineplus">+/**</span>
<a href="#l31.54"></a><span id="l31.54" class="difflineplus">+ * A reference to the nsIMsgMailViewList service that tracks custom mail views.</span>
<a href="#l31.55"></a><span id="l31.55" class="difflineplus">+ */</span>
<a href="#l31.56"></a><span id="l31.56"> var gMailViewList = null;</span>
<a href="#l31.57"></a><span id="l31.57" class="difflineminus">-var gCurrentViewValue = kViewItemAll;</span>
<a href="#l31.58"></a><span id="l31.58" class="difflineminus">-var gCurrentViewLabel = &quot;&quot;;</span>
<a href="#l31.59"></a><span id="l31.59" class="difflineminus">-var gSaveDefaultSVTerms;</span>
<a href="#l31.60"></a><span id="l31.60"> </span>
<a href="#l31.61"></a><span id="l31.61"> var nsMsgSearchScope  = Components.interfaces.nsMsgSearchScope;</span>
<a href="#l31.62"></a><span id="l31.62"> var nsMsgSearchAttrib = Components.interfaces.nsMsgSearchAttrib;</span>
<a href="#l31.63"></a><span id="l31.63"> var nsMsgSearchOp     = Components.interfaces.nsMsgSearchOp;</span>
<a href="#l31.64"></a><span id="l31.64"> </span>
<a href="#l31.65"></a><span id="l31.65" class="difflineplus">+var nsMsgMessageFlags = Components.interfaces.nsMsgMessageFlags;</span>
<a href="#l31.66"></a><span id="l31.66"> </span>
<a href="#l31.67"></a><span id="l31.67"> // perform the view/action requested by the aValue string</span>
<a href="#l31.68"></a><span id="l31.68"> // and set the view picker label to the aLabel string</span>
<a href="#l31.69"></a><span id="l31.69" class="difflineminus">-function ViewChange(aValue, aLabel)</span>
<a href="#l31.70"></a><span id="l31.70" class="difflineplus">+function ViewChange(aValue)</span>
<a href="#l31.71"></a><span id="l31.71"> {</span>
<a href="#l31.72"></a><span id="l31.72">   if (aValue == kViewItemCustomize || aValue == kViewItemVirtual)</span>
<a href="#l31.73"></a><span id="l31.73">   {</span>
<a href="#l31.74"></a><span id="l31.74">     // restore to the previous view value, in case they cancel</span>
<a href="#l31.75"></a><span id="l31.75" class="difflineminus">-    UpdateViewPicker(gCurrentViewValue, gCurrentViewLabel);</span>
<a href="#l31.76"></a><span id="l31.76" class="difflineplus">+    ViewPickerBinding.updateDisplay();</span>
<a href="#l31.77"></a><span id="l31.77">     if (aValue == kViewItemCustomize)</span>
<a href="#l31.78"></a><span id="l31.78">       LaunchCustomizeDialog();</span>
<a href="#l31.79"></a><span id="l31.79">     else</span>
<a href="#l31.80"></a><span id="l31.80" class="difflineminus">-    {</span>
<a href="#l31.81"></a><span id="l31.81" class="difflineminus">-      // Thunderbird uses the folder pane for this.</span>
<a href="#l31.82"></a><span id="l31.82" class="difflineminus">-      if (&quot;gFolderTreeController&quot; in window)</span>
<a href="#l31.83"></a><span id="l31.83" class="difflineminus">-        gFolderTreeController.newVirtualFolder(gCurrentViewLabel,</span>
<a href="#l31.84"></a><span id="l31.84" class="difflineminus">-                                               gSaveDefaultSVTerms);</span>
<a href="#l31.85"></a><span id="l31.85" class="difflineminus">-      else</span>
<a href="#l31.86"></a><span id="l31.86" class="difflineminus">-        openNewVirtualFolderDialogWithArgs(gCurrentViewLabel, gSaveDefaultSVTerms);</span>
<a href="#l31.87"></a><span id="l31.87" class="difflineminus">-    }</span>
<a href="#l31.88"></a><span id="l31.88" class="difflineplus">+      gFolderTreeController.newVirtualFolder(</span>
<a href="#l31.89"></a><span id="l31.89" class="difflineplus">+        ViewPickerBinding.currentViewLabel,</span>
<a href="#l31.90"></a><span id="l31.90" class="difflineplus">+        gFolderDisplay.view.search.viewTerms);</span>
<a href="#l31.91"></a><span id="l31.91">     return;</span>
<a href="#l31.92"></a><span id="l31.92">   }</span>
<a href="#l31.93"></a><span id="l31.93"> </span>
<a href="#l31.94"></a><span id="l31.94" class="difflineminus">-  // persist the view</span>
<a href="#l31.95"></a><span id="l31.95" class="difflineminus">-  gCurrentViewValue = aValue;</span>
<a href="#l31.96"></a><span id="l31.96" class="difflineminus">-  gCurrentViewLabel = aLabel;</span>
<a href="#l31.97"></a><span id="l31.97" class="difflineminus">-  SetMailViewForFolder(GetFirstSelectedMsgFolder(), gCurrentViewValue)</span>
<a href="#l31.98"></a><span id="l31.98" class="difflineminus">-  UpdateViewPicker(gCurrentViewValue, gCurrentViewLabel);</span>
<a href="#l31.99"></a><span id="l31.99" class="difflineminus">-</span>
<a href="#l31.100"></a><span id="l31.100">   // tag menuitem values are of the form :&lt;keyword&gt;</span>
<a href="#l31.101"></a><span id="l31.101">   if (isNaN(aValue))</span>
<a href="#l31.102"></a><span id="l31.102">   {</span>
<a href="#l31.103"></a><span id="l31.103">     // split off the tag key</span>
<a href="#l31.104"></a><span id="l31.104">     var tagkey = aValue.substr(kViewTagMarker.length);</span>
<a href="#l31.105"></a><span id="l31.105" class="difflineminus">-    ViewTagKeyword(tagkey);</span>
<a href="#l31.106"></a><span id="l31.106" class="difflineplus">+    gFolderDisplay.view.setMailView(kViewItemTags, tagkey);</span>
<a href="#l31.107"></a><span id="l31.107">   }</span>
<a href="#l31.108"></a><span id="l31.108">   else</span>
<a href="#l31.109"></a><span id="l31.109">   {</span>
<a href="#l31.110"></a><span id="l31.110">     var numval = Number(aValue);</span>
<a href="#l31.111"></a><span id="l31.111" class="difflineminus">-    switch (numval)</span>
<a href="#l31.112"></a><span id="l31.112" class="difflineminus">-    {</span>
<a href="#l31.113"></a><span id="l31.113" class="difflineminus">-      case kViewItemAll: // View All</span>
<a href="#l31.114"></a><span id="l31.114" class="difflineminus">-        gDefaultSearchViewTerms = null;</span>
<a href="#l31.115"></a><span id="l31.115" class="difflineminus">-        break;</span>
<a href="#l31.116"></a><span id="l31.116" class="difflineminus">-      case kViewItemUnread: // Unread</span>
<a href="#l31.117"></a><span id="l31.117" class="difflineminus">-        ViewNewMail();</span>
<a href="#l31.118"></a><span id="l31.118" class="difflineminus">-        break;</span>
<a href="#l31.119"></a><span id="l31.119" class="difflineminus">-      case kViewItemNotDeleted: // Not deleted</span>
<a href="#l31.120"></a><span id="l31.120" class="difflineminus">-        ViewNotDeletedMail();</span>
<a href="#l31.121"></a><span id="l31.121" class="difflineminus">-        break;</span>
<a href="#l31.122"></a><span id="l31.122" class="difflineminus">-      default:</span>
<a href="#l31.123"></a><span id="l31.123" class="difflineminus">-        // for legacy reasons, custom views start at index 9</span>
<a href="#l31.124"></a><span id="l31.124" class="difflineminus">-        LoadCustomMailView(numval - kViewItemFirstCustom);</span>
<a href="#l31.125"></a><span id="l31.125" class="difflineminus">-        break;</span>
<a href="#l31.126"></a><span id="l31.126" class="difflineminus">-    }</span>
<a href="#l31.127"></a><span id="l31.127" class="difflineplus">+    gFolderDisplay.view.setMailView(numval, null);</span>
<a href="#l31.128"></a><span id="l31.128">   }</span>
<a href="#l31.129"></a><span id="l31.129" class="difflineminus">-  gSaveDefaultSVTerms = gDefaultSearchViewTerms;</span>
<a href="#l31.130"></a><span id="l31.130" class="difflineminus">-  onEnterInSearchBar();</span>
<a href="#l31.131"></a><span id="l31.131" class="difflineminus">-  gQSViewIsDirty = true;</span>
<a href="#l31.132"></a><span id="l31.132" class="difflineplus">+  ViewPickerBinding.updateDisplay();</span>
<a href="#l31.133"></a><span id="l31.133"> }</span>
<a href="#l31.134"></a><span id="l31.134"> </span>
<a href="#l31.135"></a><span id="l31.135"> </span>
<a href="#l31.136"></a><span id="l31.136"> function ViewChangeByMenuitem(aMenuitem)</span>
<a href="#l31.137"></a><span id="l31.137"> {</span>
<a href="#l31.138"></a><span id="l31.138">   // Mac View menu menuitems don't have XBL bindings</span>
<a href="#l31.139"></a><span id="l31.139" class="difflineminus">-  ViewChange(aMenuitem.getAttribute(&quot;value&quot;), aMenuitem.getAttribute(&quot;label&quot;));</span>
<a href="#l31.140"></a><span id="l31.140" class="difflineminus">-}</span>
<a href="#l31.141"></a><span id="l31.141" class="difflineminus">-</span>
<a href="#l31.142"></a><span id="l31.142" class="difflineminus">-</span>
<a href="#l31.143"></a><span id="l31.143" class="difflineminus">-function ViewChangeByValue(aValue)</span>
<a href="#l31.144"></a><span id="l31.144" class="difflineminus">-{</span>
<a href="#l31.145"></a><span id="l31.145" class="difflineminus">-  ViewChange(aValue, GetLabelForValue(aValue));</span>
<a href="#l31.146"></a><span id="l31.146" class="difflineminus">-}</span>
<a href="#l31.147"></a><span id="l31.147" class="difflineminus">-</span>
<a href="#l31.148"></a><span id="l31.148" class="difflineminus">-function ViewChangeByFolder(aFolder)</span>
<a href="#l31.149"></a><span id="l31.149" class="difflineminus">-{</span>
<a href="#l31.150"></a><span id="l31.150" class="difflineminus">-  var result = GetMailViewForFolder(aFolder);</span>
<a href="#l31.151"></a><span id="l31.151" class="difflineminus">-  ViewChangeByValue(result);</span>
<a href="#l31.152"></a><span id="l31.152" class="difflineminus">-}</span>
<a href="#l31.153"></a><span id="l31.153" class="difflineminus">-</span>
<a href="#l31.154"></a><span id="l31.154" class="difflineminus">-function GetLabelForValue(aValue)</span>
<a href="#l31.155"></a><span id="l31.155" class="difflineminus">-{</span>
<a href="#l31.156"></a><span id="l31.156" class="difflineminus">-  var label = &quot;&quot;;</span>
<a href="#l31.157"></a><span id="l31.157" class="difflineminus">-  let viewPickerPopup = document.getElementById(&quot;viewPickerPopup&quot;);</span>
<a href="#l31.158"></a><span id="l31.158" class="difflineminus">-  if (viewPickerPopup)</span>
<a href="#l31.159"></a><span id="l31.159" class="difflineminus">-  {</span>
<a href="#l31.160"></a><span id="l31.160" class="difflineminus">-    // grab the label for the menulist from one of its menuitems</span>
<a href="#l31.161"></a><span id="l31.161" class="difflineminus">-    var selectedItems = viewPickerPopup.getElementsByAttribute(&quot;value&quot;, aValue);</span>
<a href="#l31.162"></a><span id="l31.162" class="difflineminus">-    if (!selectedItems || !selectedItems.length)</span>
<a href="#l31.163"></a><span id="l31.163" class="difflineminus">-    {</span>
<a href="#l31.164"></a><span id="l31.164" class="difflineminus">-      // we may have a new item</span>
<a href="#l31.165"></a><span id="l31.165" class="difflineminus">-      RefreshAllViewPopups(viewPickerPopup, true);</span>
<a href="#l31.166"></a><span id="l31.166" class="difflineminus">-      selectedItems = viewPickerPopup.getElementsByAttribute(&quot;value&quot;, aValue);</span>
<a href="#l31.167"></a><span id="l31.167" class="difflineminus">-    }</span>
<a href="#l31.168"></a><span id="l31.168" class="difflineminus">-    label = selectedItems &amp;&amp; selectedItems.length &amp;&amp; selectedItems.item(0).label;</span>
<a href="#l31.169"></a><span id="l31.169" class="difflineminus">-  }</span>
<a href="#l31.170"></a><span id="l31.170" class="difflineminus">-  return label;</span>
<a href="#l31.171"></a><span id="l31.171" class="difflineminus">-}</span>
<a href="#l31.172"></a><span id="l31.172" class="difflineminus">-</span>
<a href="#l31.173"></a><span id="l31.173" class="difflineminus">-function UpdateViewPickerByValue(aValue)</span>
<a href="#l31.174"></a><span id="l31.174" class="difflineminus">-{</span>
<a href="#l31.175"></a><span id="l31.175" class="difflineminus">-  UpdateViewPicker(aValue, GetLabelForValue(aValue));</span>
<a href="#l31.176"></a><span id="l31.176" class="difflineplus">+  ViewChange(aMenuitem.getAttribute(&quot;value&quot;));</span>
<a href="#l31.177"></a><span id="l31.177"> }</span>
<a href="#l31.178"></a><span id="l31.178"> </span>
<a href="#l31.179"></a><span id="l31.179" class="difflineminus">-function UpdateViewPicker(aValue, aLabel)</span>
<a href="#l31.180"></a><span id="l31.180" class="difflineminus">-{</span>
<a href="#l31.181"></a><span id="l31.181" class="difflineminus">-  var viewPicker = document.getElementById(&quot;viewPicker&quot;);</span>
<a href="#l31.182"></a><span id="l31.182" class="difflineminus">-  if (viewPicker)</span>
<a href="#l31.183"></a><span id="l31.183" class="difflineminus">-  {</span>
<a href="#l31.184"></a><span id="l31.184" class="difflineminus">-    viewPicker.value = aValue;</span>
<a href="#l31.185"></a><span id="l31.185" class="difflineminus">-    viewPicker.setAttribute(&quot;label&quot;, aLabel);</span>
<a href="#l31.186"></a><span id="l31.186" class="difflineminus">-  }</span>
<a href="#l31.187"></a><span id="l31.187" class="difflineminus">-}</span>
<a href="#l31.188"></a><span id="l31.188" class="difflineplus">+/**</span>
<a href="#l31.189"></a><span id="l31.189" class="difflineplus">+ * Mediates interaction with the #viewPickerPopup.  In theory this should be</span>
<a href="#l31.190"></a><span id="l31.190" class="difflineplus">+ *  an XBL binding, but for the insanity where the view picker may not be</span>
<a href="#l31.191"></a><span id="l31.191" class="difflineplus">+ *  visible at all times (or ever).  No view picker widget, no binding.</span>
<a href="#l31.192"></a><span id="l31.192" class="difflineplus">+ */</span>
<a href="#l31.193"></a><span id="l31.193" class="difflineplus">+var ViewPickerBinding = {</span>
<a href="#l31.194"></a><span id="l31.194" class="difflineplus">+  _init: function ViewPickerBinding_init() {</span>
<a href="#l31.195"></a><span id="l31.195" class="difflineplus">+    window.addEventListener(</span>
<a href="#l31.196"></a><span id="l31.196" class="difflineplus">+      &quot;MailViewChanged&quot;,</span>
<a href="#l31.197"></a><span id="l31.197" class="difflineplus">+      function(aEvent) { ViewPickerBinding.updateDisplay(aEvent); },</span>
<a href="#l31.198"></a><span id="l31.198" class="difflineplus">+      false);</span>
<a href="#l31.199"></a><span id="l31.199" class="difflineplus">+  },</span>
<a href="#l31.200"></a><span id="l31.200"> </span>
<a href="#l31.201"></a><span id="l31.201" class="difflineminus">-function GetFolderInfo(aFolder)</span>
<a href="#l31.202"></a><span id="l31.202" class="difflineminus">-{</span>
<a href="#l31.203"></a><span id="l31.203" class="difflineminus">-  if (aFolder)</span>
<a href="#l31.204"></a><span id="l31.204" class="difflineminus">-  {</span>
<a href="#l31.205"></a><span id="l31.205" class="difflineminus">-    var db = aFolder.msgDatabase;</span>
<a href="#l31.206"></a><span id="l31.206" class="difflineminus">-    if (db)</span>
<a href="#l31.207"></a><span id="l31.207" class="difflineminus">-      return db.dBFolderInfo;</span>
<a href="#l31.208"></a><span id="l31.208" class="difflineminus">-  }</span>
<a href="#l31.209"></a><span id="l31.209" class="difflineminus">-  return null;</span>
<a href="#l31.210"></a><span id="l31.210" class="difflineminus">-}</span>
<a href="#l31.211"></a><span id="l31.211" class="difflineminus">-</span>
<a href="#l31.212"></a><span id="l31.212" class="difflineplus">+  /**</span>
<a href="#l31.213"></a><span id="l31.213" class="difflineplus">+   * Return true if the view picker is visible.  This is used by the</span>
<a href="#l31.214"></a><span id="l31.214" class="difflineplus">+   *  FolderDisplayWidget to know whether or not to actually use mailviews. (The</span>
<a href="#l31.215"></a><span id="l31.215" class="difflineplus">+   *  idea is that if we are not visible, then it would be confusing to the user</span>
<a href="#l31.216"></a><span id="l31.216" class="difflineplus">+   *  if we filtered their mail since they would have no feedback about this and</span>
<a href="#l31.217"></a><span id="l31.217" class="difflineplus">+   *  no way to change it.)</span>
<a href="#l31.218"></a><span id="l31.218" class="difflineplus">+   */</span>
<a href="#l31.219"></a><span id="l31.219" class="difflineplus">+  get isVisible() {</span>
<a href="#l31.220"></a><span id="l31.220" class="difflineplus">+    return document.getElementById(&quot;viewPicker&quot;) != null;</span>
<a href="#l31.221"></a><span id="l31.221" class="difflineplus">+  },</span>
<a href="#l31.222"></a><span id="l31.222"> </span>
<a href="#l31.223"></a><span id="l31.223" class="difflineminus">-function GetMailViewForFolder(aFolder)</span>
<a href="#l31.224"></a><span id="l31.224" class="difflineminus">-{</span>
<a href="#l31.225"></a><span id="l31.225" class="difflineminus">-  var val = &quot;&quot;;</span>
<a href="#l31.226"></a><span id="l31.226" class="difflineminus">-  var folderInfo = GetFolderInfo(aFolder);</span>
<a href="#l31.227"></a><span id="l31.227" class="difflineminus">-  if (folderInfo)</span>
<a href="#l31.228"></a><span id="l31.228" class="difflineminus">-  {</span>
<a href="#l31.229"></a><span id="l31.229" class="difflineminus">-    val = folderInfo.getCharProperty(kViewCurrentTag);</span>
<a href="#l31.230"></a><span id="l31.230" class="difflineminus">-    if (!val)</span>
<a href="#l31.231"></a><span id="l31.231" class="difflineminus">-    {</span>
<a href="#l31.232"></a><span id="l31.232" class="difflineminus">-      // no new view value, thus using the old</span>
<a href="#l31.233"></a><span id="l31.233" class="difflineminus">-      var numval = folderInfo.getUint32Property(kViewCurrent, kViewItemAll);</span>
<a href="#l31.234"></a><span id="l31.234" class="difflineminus">-      // and migrate it, if it's a former label view (label views used values 2-6)</span>
<a href="#l31.235"></a><span id="l31.235" class="difflineminus">-      if ((kViewItemTags &lt;= numval) &amp;&amp; (numval &lt; kViewItemVirtual))</span>
<a href="#l31.236"></a><span id="l31.236" class="difflineminus">-        val = kViewTagMarker + &quot;$label&quot; + (val - 1);</span>
<a href="#l31.237"></a><span id="l31.237" class="difflineminus">-      else</span>
<a href="#l31.238"></a><span id="l31.238" class="difflineminus">-        val = numval;</span>
<a href="#l31.239"></a><span id="l31.239" class="difflineplus">+  /**</span>
<a href="#l31.240"></a><span id="l31.240" class="difflineplus">+   * Return the string value representing the current mail view value as</span>
<a href="#l31.241"></a><span id="l31.241" class="difflineplus">+   *  understood by the view picker widgets.  The value is the index for</span>
<a href="#l31.242"></a><span id="l31.242" class="difflineplus">+   *  everything but tags.  for tags it's the &quot;:&quot;-prefixed tagname.</span>
<a href="#l31.243"></a><span id="l31.243" class="difflineplus">+   */</span>
<a href="#l31.244"></a><span id="l31.244" class="difflineplus">+  get currentViewValue() {</span>
<a href="#l31.245"></a><span id="l31.245" class="difflineplus">+    if (gFolderDisplay.view.mailViewIndex == kViewItemTags)</span>
<a href="#l31.246"></a><span id="l31.246" class="difflineplus">+      return kViewTagMarker + gFolderDisplay.view.mailViewData;</span>
<a href="#l31.247"></a><span id="l31.247" class="difflineplus">+    else</span>
<a href="#l31.248"></a><span id="l31.248" class="difflineplus">+      return gFolderDisplay.view.mailViewIndex + &quot;&quot;;</span>
<a href="#l31.249"></a><span id="l31.249" class="difflineplus">+  },</span>
<a href="#l31.250"></a><span id="l31.250" class="difflineplus">+</span>
<a href="#l31.251"></a><span id="l31.251" class="difflineplus">+  /**</span>
<a href="#l31.252"></a><span id="l31.252" class="difflineplus">+   * @return The label for the current mail view value.</span>
<a href="#l31.253"></a><span id="l31.253" class="difflineplus">+   */</span>
<a href="#l31.254"></a><span id="l31.254" class="difflineplus">+  get currentViewLabel() {</span>
<a href="#l31.255"></a><span id="l31.255" class="difflineplus">+    let viewPicker = document.getElementById(&quot;viewPicker&quot;);</span>
<a href="#l31.256"></a><span id="l31.256" class="difflineplus">+    return viewPicker.getAttribute(&quot;label&quot;);</span>
<a href="#l31.257"></a><span id="l31.257" class="difflineplus">+  },</span>
<a href="#l31.258"></a><span id="l31.258" class="difflineplus">+</span>
<a href="#l31.259"></a><span id="l31.259" class="difflineplus">+  /**</span>
<a href="#l31.260"></a><span id="l31.260" class="difflineplus">+   * The effective view has changed, update the widget.</span>
<a href="#l31.261"></a><span id="l31.261" class="difflineplus">+   */</span>
<a href="#l31.262"></a><span id="l31.262" class="difflineplus">+  updateDisplay: function ViewPickerBinding_updateDisplay(aEvent, aGiveUpIfNotFound) {</span>
<a href="#l31.263"></a><span id="l31.263" class="difflineplus">+    let viewPicker = document.getElementById(&quot;viewPicker&quot;);</span>
<a href="#l31.264"></a><span id="l31.264" class="difflineplus">+    if (viewPicker) {</span>
<a href="#l31.265"></a><span id="l31.265" class="difflineplus">+      let value = this.currentViewValue;</span>
<a href="#l31.266"></a><span id="l31.266" class="difflineplus">+</span>
<a href="#l31.267"></a><span id="l31.267" class="difflineplus">+      let viewPickerPopup = document.getElementById(&quot;viewPickerPopup&quot;);</span>
<a href="#l31.268"></a><span id="l31.268" class="difflineplus">+      let selectedItems =</span>
<a href="#l31.269"></a><span id="l31.269" class="difflineplus">+        viewPickerPopup.getElementsByAttribute(&quot;value&quot;, value);</span>
<a href="#l31.270"></a><span id="l31.270" class="difflineplus">+      if (!selectedItems || !selectedItems.length)</span>
<a href="#l31.271"></a><span id="l31.271" class="difflineplus">+      {</span>
<a href="#l31.272"></a><span id="l31.272" class="difflineplus">+        // we may have a new item, so refresh to make it show up</span>
<a href="#l31.273"></a><span id="l31.273" class="difflineplus">+        RefreshAllViewPopups(viewPickerPopup, true);</span>
<a href="#l31.274"></a><span id="l31.274" class="difflineplus">+        selectedItems = viewPickerPopup.getElementsByAttribute(&quot;value&quot;, value);</span>
<a href="#l31.275"></a><span id="l31.275" class="difflineplus">+      }</span>
<a href="#l31.276"></a><span id="l31.276" class="difflineplus">+      viewPicker.setAttribute(&quot;label&quot;,</span>
<a href="#l31.277"></a><span id="l31.277" class="difflineplus">+                              selectedItems &amp;&amp; selectedItems.length &amp;&amp;</span>
<a href="#l31.278"></a><span id="l31.278" class="difflineplus">+                              selectedItems.item(0).getAttribute(&quot;label&quot;));</span>
<a href="#l31.279"></a><span id="l31.279">     }</span>
<a href="#l31.280"></a><span id="l31.280" class="difflineminus">-  }</span>
<a href="#l31.281"></a><span id="l31.281" class="difflineminus">-  return val;</span>
<a href="#l31.282"></a><span id="l31.282" class="difflineminus">-}</span>
<a href="#l31.283"></a><span id="l31.283" class="difflineminus">-</span>
<a href="#l31.284"></a><span id="l31.284" class="difflineminus">-</span>
<a href="#l31.285"></a><span id="l31.285" class="difflineminus">-function SetMailViewForFolder(aFolder, aValue)</span>
<a href="#l31.286"></a><span id="l31.286" class="difflineminus">-{</span>
<a href="#l31.287"></a><span id="l31.287" class="difflineminus">-  var folderInfo = GetFolderInfo(aFolder);</span>
<a href="#l31.288"></a><span id="l31.288" class="difflineminus">-  if (folderInfo)</span>
<a href="#l31.289"></a><span id="l31.289" class="difflineminus">-  {</span>
<a href="#l31.290"></a><span id="l31.290" class="difflineminus">-    // we can't map tags back to labels in general,</span>
<a href="#l31.291"></a><span id="l31.291" class="difflineminus">-    // so set view to all for backwards compatibility in this case</span>
<a href="#l31.292"></a><span id="l31.292" class="difflineminus">-    folderInfo.setUint32Property (kViewCurrent, isNaN(aValue) ? kViewItemAll : aValue);</span>
<a href="#l31.293"></a><span id="l31.293" class="difflineminus">-    folderInfo.setCharProperty(kViewCurrentTag, aValue);</span>
<a href="#l31.294"></a><span id="l31.294" class="difflineminus">-  }</span>
<a href="#l31.295"></a><span id="l31.295" class="difflineminus">-}</span>
<a href="#l31.296"></a><span id="l31.296" class="difflineminus">-</span>
<a href="#l31.297"></a><span id="l31.297" class="difflineplus">+  },</span>
<a href="#l31.298"></a><span id="l31.298" class="difflineplus">+};</span>
<a href="#l31.299"></a><span id="l31.299" class="difflineplus">+ViewPickerBinding._init();</span>
<a href="#l31.300"></a><span id="l31.300"> </span>
<a href="#l31.301"></a><span id="l31.301"> function LaunchCustomizeDialog()</span>
<a href="#l31.302"></a><span id="l31.302"> {</span>
<a href="#l31.303"></a><span id="l31.303">   OpenOrFocusWindow({}, &quot;mailnews:mailviewlist&quot;, &quot;chrome://messenger/content/mailViewList.xul&quot;);</span>
<a href="#l31.304"></a><span id="l31.304"> }</span>
<a href="#l31.305"></a><span id="l31.305"> </span>
<a href="#l31.306"></a><span id="l31.306" class="difflineminus">-</span>
<a href="#l31.307"></a><span id="l31.307" class="difflineminus">-function LoadCustomMailView(index)</span>
<a href="#l31.308"></a><span id="l31.308" class="difflineminus">-{</span>
<a href="#l31.309"></a><span id="l31.309" class="difflineminus">-  PrepareForViewChange();</span>
<a href="#l31.310"></a><span id="l31.310" class="difflineminus">-  var searchTermsArrayForQS = CreateGroupedSearchTerms(gMailViewList.getMailViewAt(index).searchTerms);</span>
<a href="#l31.311"></a><span id="l31.311" class="difflineminus">-  createSearchTermsWithList(searchTermsArrayForQS);</span>
<a href="#l31.312"></a><span id="l31.312" class="difflineminus">-  AddVirtualFolderTerms(searchTermsArrayForQS);</span>
<a href="#l31.313"></a><span id="l31.313" class="difflineminus">-  gDefaultSearchViewTerms = searchTermsArrayForQS;</span>
<a href="#l31.314"></a><span id="l31.314" class="difflineminus">-}</span>
<a href="#l31.315"></a><span id="l31.315" class="difflineminus">-</span>
<a href="#l31.316"></a><span id="l31.316" class="difflineminus">-</span>
<a href="#l31.317"></a><span id="l31.317" class="difflineminus">-function ViewTagKeyword(keyword)</span>
<a href="#l31.318"></a><span id="l31.318" class="difflineplus">+/**</span>
<a href="#l31.319"></a><span id="l31.319" class="difflineplus">+ * All of these Refresh*ViewPopup* methods have to deal with two menu</span>
<a href="#l31.320"></a><span id="l31.320" class="difflineplus">+ *  variations.  They are accessible from the &quot;View... Messages&quot; menu as well as</span>
<a href="#l31.321"></a><span id="l31.321" class="difflineplus">+ *  the view picker menu list in the toolbar.  aIsMenulist will be false in the</span>
<a href="#l31.322"></a><span id="l31.322" class="difflineplus">+ *  former case and true in the latter case.</span>
<a href="#l31.323"></a><span id="l31.323" class="difflineplus">+ */</span>
<a href="#l31.324"></a><span id="l31.324" class="difflineplus">+function RefreshAllViewPopups(aViewPopup)</span>
<a href="#l31.325"></a><span id="l31.325"> {</span>
<a href="#l31.326"></a><span id="l31.326" class="difflineminus">-  PrepareForViewChange();</span>
<a href="#l31.327"></a><span id="l31.327" class="difflineminus">-</span>
<a href="#l31.328"></a><span id="l31.328" class="difflineminus">-  // create an i supports array to store our search terms</span>
<a href="#l31.329"></a><span id="l31.329" class="difflineminus">-  var searchTermsArray = Components.classes[&quot;@mozilla.org/supports-array;1&quot;]</span>
<a href="#l31.330"></a><span id="l31.330" class="difflineminus">-                                   .createInstance(Components.interfaces.nsISupportsArray);</span>
<a href="#l31.331"></a><span id="l31.331" class="difflineminus">-  var term = gSearchSession.createTerm();</span>
<a href="#l31.332"></a><span id="l31.332" class="difflineminus">-  var value = term.value;</span>
<a href="#l31.333"></a><span id="l31.333" class="difflineminus">-</span>
<a href="#l31.334"></a><span id="l31.334" class="difflineminus">-  value.str = keyword;</span>
<a href="#l31.335"></a><span id="l31.335" class="difflineminus">-  value.attrib = nsMsgSearchAttrib.Keywords;</span>
<a href="#l31.336"></a><span id="l31.336" class="difflineminus">-  term.value = value;</span>
<a href="#l31.337"></a><span id="l31.337" class="difflineminus">-  term.attrib = nsMsgSearchAttrib.Keywords;</span>
<a href="#l31.338"></a><span id="l31.338" class="difflineminus">-  term.op = nsMsgSearchOp.Contains;</span>
<a href="#l31.339"></a><span id="l31.339" class="difflineminus">-  term.booleanAnd = true;</span>
<a href="#l31.340"></a><span id="l31.340" class="difflineminus">-</span>
<a href="#l31.341"></a><span id="l31.341" class="difflineminus">-  searchTermsArray.AppendElement(term);</span>
<a href="#l31.342"></a><span id="l31.342" class="difflineminus">-  AddVirtualFolderTerms(searchTermsArray);</span>
<a href="#l31.343"></a><span id="l31.343" class="difflineminus">-  createSearchTermsWithList(searchTermsArray);</span>
<a href="#l31.344"></a><span id="l31.344" class="difflineminus">-  gDefaultSearchViewTerms = searchTermsArray;</span>
<a href="#l31.345"></a><span id="l31.345" class="difflineplus">+  RefreshViewPopup(aViewPopup);</span>
<a href="#l31.346"></a><span id="l31.346" class="difflineplus">+  var menupopups = aViewPopup.getElementsByTagName(&quot;menupopup&quot;);</span>
<a href="#l31.347"></a><span id="l31.347" class="difflineplus">+  if (menupopups.length &gt; 1)</span>
<a href="#l31.348"></a><span id="l31.348" class="difflineplus">+  {</span>
<a href="#l31.349"></a><span id="l31.349" class="difflineplus">+    // when we have menupopups, we assume both tags and custom views are there</span>
<a href="#l31.350"></a><span id="l31.350" class="difflineplus">+    RefreshTagsPopup(menupopups[0]);</span>
<a href="#l31.351"></a><span id="l31.351" class="difflineplus">+    RefreshCustomViewsPopup(menupopups[1]);</span>
<a href="#l31.352"></a><span id="l31.352" class="difflineplus">+  }</span>
<a href="#l31.353"></a><span id="l31.353"> }</span>
<a href="#l31.354"></a><span id="l31.354"> </span>
<a href="#l31.355"></a><span id="l31.355"> </span>
<a href="#l31.356"></a><span id="l31.356" class="difflineminus">-function ViewNewMail()</span>
<a href="#l31.357"></a><span id="l31.357" class="difflineplus">+function RefreshViewPopup(aViewPopup)</span>
<a href="#l31.358"></a><span id="l31.358"> {</span>
<a href="#l31.359"></a><span id="l31.359" class="difflineminus">-  PrepareForViewChange();</span>
<a href="#l31.360"></a><span id="l31.360" class="difflineminus">-</span>
<a href="#l31.361"></a><span id="l31.361" class="difflineminus">-  // create an i supports array to store our search terms</span>
<a href="#l31.362"></a><span id="l31.362" class="difflineminus">-  var searchTermsArray = Components.classes[&quot;@mozilla.org/supports-array;1&quot;]</span>
<a href="#l31.363"></a><span id="l31.363" class="difflineminus">-                                   .createInstance(Components.interfaces.nsISupportsArray);</span>
<a href="#l31.364"></a><span id="l31.364" class="difflineminus">-  var term = gSearchSession.createTerm();</span>
<a href="#l31.365"></a><span id="l31.365" class="difflineminus">-  var value = term.value;</span>
<a href="#l31.366"></a><span id="l31.366" class="difflineplus">+  // mark default views if selected</span>
<a href="#l31.367"></a><span id="l31.367" class="difflineplus">+  let currentViewValue = ViewPickerBinding.currentViewValue;</span>
<a href="#l31.368"></a><span id="l31.368"> </span>
<a href="#l31.369"></a><span id="l31.369" class="difflineminus">-  value.status = 1;</span>
<a href="#l31.370"></a><span id="l31.370" class="difflineminus">-  value.attrib = nsMsgSearchAttrib.MsgStatus;</span>
<a href="#l31.371"></a><span id="l31.371" class="difflineminus">-  term.value = value;</span>
<a href="#l31.372"></a><span id="l31.372" class="difflineminus">-  term.attrib = nsMsgSearchAttrib.MsgStatus;</span>
<a href="#l31.373"></a><span id="l31.373" class="difflineminus">-  term.op = nsMsgSearchOp.Isnt;</span>
<a href="#l31.374"></a><span id="l31.374" class="difflineminus">-  term.booleanAnd = true;</span>
<a href="#l31.375"></a><span id="l31.375" class="difflineminus">-  searchTermsArray.AppendElement(term);</span>
<a href="#l31.376"></a><span id="l31.376" class="difflineminus">-</span>
<a href="#l31.377"></a><span id="l31.377" class="difflineminus">-  AddVirtualFolderTerms(searchTermsArray);</span>
<a href="#l31.378"></a><span id="l31.378" class="difflineminus">-</span>
<a href="#l31.379"></a><span id="l31.379" class="difflineminus">-  createSearchTermsWithList(searchTermsArray);</span>
<a href="#l31.380"></a><span id="l31.380" class="difflineminus">-  // not quite right - these want to be just the view terms...but it might not matter.</span>
<a href="#l31.381"></a><span id="l31.381" class="difflineminus">-  gDefaultSearchViewTerms = searchTermsArray;</span>
<a href="#l31.382"></a><span id="l31.382" class="difflineminus">-}</span>
<a href="#l31.383"></a><span id="l31.383" class="difflineminus">-</span>
<a href="#l31.384"></a><span id="l31.384" class="difflineminus">-</span>
<a href="#l31.385"></a><span id="l31.385" class="difflineminus">-function ViewNotDeletedMail()</span>
<a href="#l31.386"></a><span id="l31.386" class="difflineminus">-{</span>
<a href="#l31.387"></a><span id="l31.387" class="difflineminus">-  PrepareForViewChange();</span>
<a href="#l31.388"></a><span id="l31.388" class="difflineplus">+  var viewAll = aViewPopup.getElementsByAttribute(&quot;value&quot;, kViewItemAll)[0];</span>
<a href="#l31.389"></a><span id="l31.389" class="difflineplus">+  viewAll.setAttribute(&quot;checked&quot;, currentViewValue == kViewItemAll);</span>
<a href="#l31.390"></a><span id="l31.390" class="difflineplus">+  let viewUnread =</span>
<a href="#l31.391"></a><span id="l31.391" class="difflineplus">+    aViewPopup.getElementsByAttribute(&quot;value&quot;, kViewItemUnread)[0];</span>
<a href="#l31.392"></a><span id="l31.392" class="difflineplus">+  viewUnread.setAttribute(&quot;checked&quot;, currentViewValue == kViewItemUnread);</span>
<a href="#l31.393"></a><span id="l31.393"> </span>
<a href="#l31.394"></a><span id="l31.394" class="difflineminus">-  // create an i supports array to store our search terms</span>
<a href="#l31.395"></a><span id="l31.395" class="difflineminus">-  var searchTermsArray = Components.classes[&quot;@mozilla.org/supports-array;1&quot;]</span>
<a href="#l31.396"></a><span id="l31.396" class="difflineminus">-                                   .createInstance(Components.interfaces.nsISupportsArray);</span>
<a href="#l31.397"></a><span id="l31.397" class="difflineminus">-  var term = gSearchSession.createTerm();</span>
<a href="#l31.398"></a><span id="l31.398" class="difflineminus">-  var value = term.value;</span>
<a href="#l31.399"></a><span id="l31.399" class="difflineminus">-</span>
<a href="#l31.400"></a><span id="l31.400" class="difflineminus">-  value.status = 0x00200000;</span>
<a href="#l31.401"></a><span id="l31.401" class="difflineminus">-  value.attrib = nsMsgSearchAttrib.MsgStatus;</span>
<a href="#l31.402"></a><span id="l31.402" class="difflineminus">-  term.value = value;</span>
<a href="#l31.403"></a><span id="l31.403" class="difflineminus">-  term.attrib = nsMsgSearchAttrib.MsgStatus;</span>
<a href="#l31.404"></a><span id="l31.404" class="difflineminus">-  term.op = nsMsgSearchOp.Isnt;</span>
<a href="#l31.405"></a><span id="l31.405" class="difflineminus">-  term.booleanAnd = true;</span>
<a href="#l31.406"></a><span id="l31.406" class="difflineminus">-  searchTermsArray.AppendElement(term);</span>
<a href="#l31.407"></a><span id="l31.407" class="difflineminus">-</span>
<a href="#l31.408"></a><span id="l31.408" class="difflineminus">-  AddVirtualFolderTerms(searchTermsArray);</span>
<a href="#l31.409"></a><span id="l31.409" class="difflineplus">+  let viewNotDeleted =</span>
<a href="#l31.410"></a><span id="l31.410" class="difflineplus">+    aViewPopup.getElementsByAttribute(&quot;value&quot;, kViewItemNotDeleted)[0];</span>
<a href="#l31.411"></a><span id="l31.411" class="difflineplus">+  var folderArray = GetSelectedMsgFolders();</span>
<a href="#l31.412"></a><span id="l31.412" class="difflineplus">+  if (folderArray.length == 0)</span>
<a href="#l31.413"></a><span id="l31.413" class="difflineplus">+    return;</span>
<a href="#l31.414"></a><span id="l31.414"> </span>
<a href="#l31.415"></a><span id="l31.415" class="difflineminus">-  createSearchTermsWithList(searchTermsArray);</span>
<a href="#l31.416"></a><span id="l31.416" class="difflineminus">-  // not quite right - these want to be just the view terms...but it might not matter.</span>
<a href="#l31.417"></a><span id="l31.417" class="difflineminus">-  gDefaultSearchViewTerms = searchTermsArray;</span>
<a href="#l31.418"></a><span id="l31.418" class="difflineminus">-}</span>
<a href="#l31.419"></a><span id="l31.419" class="difflineminus">-</span>
<a href="#l31.420"></a><span id="l31.420" class="difflineminus">-</span>
<a href="#l31.421"></a><span id="l31.421" class="difflineminus">-function AddVirtualFolderTerms(searchTermsArray)</span>
<a href="#l31.422"></a><span id="l31.422" class="difflineminus">-{</span>
<a href="#l31.423"></a><span id="l31.423" class="difflineminus">-  // add in any virtual folder terms</span>
<a href="#l31.424"></a><span id="l31.424" class="difflineminus">-  var virtualFolderSearchTerms = (gVirtualFolderTerms || gXFVirtualFolderTerms);</span>
<a href="#l31.425"></a><span id="l31.425" class="difflineminus">-  if (virtualFolderSearchTerms)</span>
<a href="#l31.426"></a><span id="l31.426" class="difflineplus">+  // only show the &quot;Not Deleted&quot; item for IMAP servers that are using the IMAP</span>
<a href="#l31.427"></a><span id="l31.427" class="difflineplus">+  // delete model</span>
<a href="#l31.428"></a><span id="l31.428" class="difflineplus">+  viewNotDeleted.setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l31.429"></a><span id="l31.429" class="difflineplus">+  var msgFolder = folderArray[0];</span>
<a href="#l31.430"></a><span id="l31.430" class="difflineplus">+  var server = msgFolder.server;</span>
<a href="#l31.431"></a><span id="l31.431" class="difflineplus">+  if (server.type == &quot;imap&quot;)</span>
<a href="#l31.432"></a><span id="l31.432">   {</span>
<a href="#l31.433"></a><span id="l31.433" class="difflineminus">-    var isupports = null;</span>
<a href="#l31.434"></a><span id="l31.434" class="difflineminus">-    var searchTerm;</span>
<a href="#l31.435"></a><span id="l31.435" class="difflineminus">-    var termsArray = virtualFolderSearchTerms.QueryInterface(Components.interfaces.nsISupportsArray);</span>
<a href="#l31.436"></a><span id="l31.436" class="difflineminus">-    for (var i = 0; i &lt; termsArray.Count(); i++)</span>
<a href="#l31.437"></a><span id="l31.437" class="difflineminus">-    {</span>
<a href="#l31.438"></a><span id="l31.438" class="difflineminus">-      isupports = termsArray.GetElementAt(i);</span>
<a href="#l31.439"></a><span id="l31.439" class="difflineminus">-      searchTerm = isupports.QueryInterface(Components.interfaces.nsIMsgSearchTerm);</span>
<a href="#l31.440"></a><span id="l31.440" class="difflineminus">-      searchTermsArray.AppendElement(searchTerm);</span>
<a href="#l31.441"></a><span id="l31.441" class="difflineplus">+    let imapServer =</span>
<a href="#l31.442"></a><span id="l31.442" class="difflineplus">+      server.QueryInterface(Components.interfaces.nsIImapIncomingServer);</span>
<a href="#l31.443"></a><span id="l31.443" class="difflineplus">+    if (imapServer.deleteModel == 0) { // nsMsgImapDeleteModels.IMAPDelete</span>
<a href="#l31.444"></a><span id="l31.444" class="difflineplus">+      viewNotDeleted.setAttribute(&quot;hidden&quot;, false);</span>
<a href="#l31.445"></a><span id="l31.445" class="difflineplus">+      viewNotDeleted.setAttribute(&quot;checked&quot;,</span>
<a href="#l31.446"></a><span id="l31.446" class="difflineplus">+                                  currentViewValue == kViewItemNotDeleted);</span>
<a href="#l31.447"></a><span id="l31.447">     }</span>
<a href="#l31.448"></a><span id="l31.448">   }</span>
<a href="#l31.449"></a><span id="l31.449"> }</span>
<a href="#l31.450"></a><span id="l31.450"> </span>
<a href="#l31.451"></a><span id="l31.451"> </span>
<a href="#l31.452"></a><span id="l31.452" class="difflineminus">-function PrepareForViewChange()</span>
<a href="#l31.453"></a><span id="l31.453" class="difflineminus">-{</span>
<a href="#l31.454"></a><span id="l31.454" class="difflineminus">-  // this is a problem - it saves the current view in gPreQuickSearchView</span>
<a href="#l31.455"></a><span id="l31.455" class="difflineminus">-  // then we eventually call onEnterInSearchBar, and we think we need to restore the pre search view!</span>
<a href="#l31.456"></a><span id="l31.456" class="difflineminus">-  initializeSearchBar();</span>
<a href="#l31.457"></a><span id="l31.457" class="difflineminus">-  ClearThreadPaneSelection();</span>
<a href="#l31.458"></a><span id="l31.458" class="difflineminus">-  ClearMessagePane();</span>
<a href="#l31.459"></a><span id="l31.459" class="difflineminus">-}</span>
<a href="#l31.460"></a><span id="l31.460" class="difflineminus">-</span>
<a href="#l31.461"></a><span id="l31.461" class="difflineminus">-</span>
<a href="#l31.462"></a><span id="l31.462" class="difflineminus">-// refresh view popup and its subpopups</span>
<a href="#l31.463"></a><span id="l31.463" class="difflineminus">-function RefreshAllViewPopups(aViewPopup, aIsMenulist)</span>
<a href="#l31.464"></a><span id="l31.464" class="difflineminus">-{</span>
<a href="#l31.465"></a><span id="l31.465" class="difflineminus">-  RefreshViewPopup(aViewPopup, aIsMenulist);</span>
<a href="#l31.466"></a><span id="l31.466" class="difflineminus">-  var menupopups = aViewPopup.getElementsByTagName(&quot;menupopup&quot;);</span>
<a href="#l31.467"></a><span id="l31.467" class="difflineminus">-  if (menupopups.length &gt; 1)</span>
<a href="#l31.468"></a><span id="l31.468" class="difflineminus">-  {</span>
<a href="#l31.469"></a><span id="l31.469" class="difflineminus">-    // when we have menupopups, we assume both tags and custom views are there</span>
<a href="#l31.470"></a><span id="l31.470" class="difflineminus">-    RefreshTagsPopup(menupopups[0], aIsMenulist);</span>
<a href="#l31.471"></a><span id="l31.471" class="difflineminus">-    RefreshCustomViewsPopup(menupopups[1], aIsMenulist);</span>
<a href="#l31.472"></a><span id="l31.472" class="difflineminus">-  }</span>
<a href="#l31.473"></a><span id="l31.473" class="difflineminus">-}</span>
<a href="#l31.474"></a><span id="l31.474" class="difflineminus">-</span>
<a href="#l31.475"></a><span id="l31.475" class="difflineminus">-</span>
<a href="#l31.476"></a><span id="l31.476" class="difflineminus">-function RefreshViewPopup(aViewPopup, aIsMenulist)</span>
<a href="#l31.477"></a><span id="l31.477" class="difflineminus">-{</span>
<a href="#l31.478"></a><span id="l31.478" class="difflineminus">-  // mark default views if selected</span>
<a href="#l31.479"></a><span id="l31.479" class="difflineminus">-  if (!aIsMenulist)</span>
<a href="#l31.480"></a><span id="l31.480" class="difflineminus">-  {</span>
<a href="#l31.481"></a><span id="l31.481" class="difflineminus">-    var viewAll = aViewPopup.getElementsByAttribute(&quot;value&quot;, kViewItemAll)[0];</span>
<a href="#l31.482"></a><span id="l31.482" class="difflineminus">-    viewAll.setAttribute(&quot;checked&quot;, gCurrentViewValue == kViewItemAll);</span>
<a href="#l31.483"></a><span id="l31.483" class="difflineminus">-    var viewUnread = aViewPopup.getElementsByAttribute(&quot;value&quot;, kViewItemUnread)[0];</span>
<a href="#l31.484"></a><span id="l31.484" class="difflineminus">-    viewUnread.setAttribute(&quot;checked&quot;, gCurrentViewValue == kViewItemUnread);</span>
<a href="#l31.485"></a><span id="l31.485" class="difflineminus">-</span>
<a href="#l31.486"></a><span id="l31.486" class="difflineminus">-    var viewNotDeleted = aViewPopup.getElementsByAttribute(&quot;value&quot;, kViewItemNotDeleted)[0];</span>
<a href="#l31.487"></a><span id="l31.487" class="difflineminus">-    var folderArray = GetSelectedMsgFolders();</span>
<a href="#l31.488"></a><span id="l31.488" class="difflineminus">-    if (folderArray.length == 0)</span>
<a href="#l31.489"></a><span id="l31.489" class="difflineminus">-      return;</span>
<a href="#l31.490"></a><span id="l31.490" class="difflineminus">-</span>
<a href="#l31.491"></a><span id="l31.491" class="difflineminus">-    // only show the &quot;Not Deleted&quot; item for IMAP servers that are using the IMAP delete model</span>
<a href="#l31.492"></a><span id="l31.492" class="difflineminus">-    viewNotDeleted.setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l31.493"></a><span id="l31.493" class="difflineminus">-    var msgFolder = folderArray[0];</span>
<a href="#l31.494"></a><span id="l31.494" class="difflineminus">-    var server = msgFolder.server;</span>
<a href="#l31.495"></a><span id="l31.495" class="difflineminus">-    if (server.type == &quot;imap&quot;)</span>
<a href="#l31.496"></a><span id="l31.496" class="difflineminus">-    {</span>
<a href="#l31.497"></a><span id="l31.497" class="difflineminus">-      var imapServer = server.QueryInterface(Components.interfaces.nsIImapIncomingServer);</span>
<a href="#l31.498"></a><span id="l31.498" class="difflineminus">-      if (imapServer.deleteModel == 0)   // nsMsgImapDeleteModels.IMAPDelete == 0</span>
<a href="#l31.499"></a><span id="l31.499" class="difflineminus">-      {</span>
<a href="#l31.500"></a><span id="l31.500" class="difflineminus">-        viewNotDeleted.setAttribute(&quot;hidden&quot;, false);</span>
<a href="#l31.501"></a><span id="l31.501" class="difflineminus">-        viewNotDeleted.setAttribute(&quot;checked&quot;, gCurrentViewValue == kViewItemNotDeleted);</span>
<a href="#l31.502"></a><span id="l31.502" class="difflineminus">-      }</span>
<a href="#l31.503"></a><span id="l31.503" class="difflineminus">-    }</span>
<a href="#l31.504"></a><span id="l31.504" class="difflineminus">-  }</span>
<a href="#l31.505"></a><span id="l31.505" class="difflineminus">-}</span>
<a href="#l31.506"></a><span id="l31.506" class="difflineminus">-</span>
<a href="#l31.507"></a><span id="l31.507" class="difflineminus">-</span>
<a href="#l31.508"></a><span id="l31.508" class="difflineminus">-function RefreshCustomViewsPopup(aMenupopup, aIsMenulist)</span>
<a href="#l31.509"></a><span id="l31.509" class="difflineplus">+function RefreshCustomViewsPopup(aMenupopup)</span>
<a href="#l31.510"></a><span id="l31.510"> {</span>
<a href="#l31.511"></a><span id="l31.511">   // for each mail view in the msg view list, add an entry in our combo box</span>
<a href="#l31.512"></a><span id="l31.512">   if (!gMailViewList)</span>
<a href="#l31.513"></a><span id="l31.513">     gMailViewList = Components.classes[&quot;@mozilla.org/messenger/mailviewlist;1&quot;]</span>
<a href="#l31.514"></a><span id="l31.514">                               .getService(Components.interfaces.nsIMsgMailViewList);</span>
<a href="#l31.515"></a><span id="l31.515">   // remove all menuitems</span>
<a href="#l31.516"></a><span id="l31.516">   while (aMenupopup.hasChildNodes())</span>
<a href="#l31.517"></a><span id="l31.517">     aMenupopup.removeChild(aMenupopup.lastChild);</span>
<a href="#l31.518"></a><span id="l31.518"> </span>
<a href="#l31.519"></a><span id="l31.519">   // now rebuild the list</span>
<a href="#l31.520"></a><span id="l31.520" class="difflineminus">-  var currentView = isNaN(gCurrentViewValue) ? kViewItemAll : Number(gCurrentViewValue);</span>
<a href="#l31.521"></a><span id="l31.521" class="difflineplus">+  var currentView = ViewPickerBinding.currentViewValue;</span>
<a href="#l31.522"></a><span id="l31.522">   var numItems = gMailViewList.mailViewCount;</span>
<a href="#l31.523"></a><span id="l31.523">   for (var i = 0; i &lt; numItems; ++i)</span>
<a href="#l31.524"></a><span id="l31.524">   {</span>
<a href="#l31.525"></a><span id="l31.525">     var viewInfo = gMailViewList.getMailViewAt(i);</span>
<a href="#l31.526"></a><span id="l31.526">     var menuitem = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l31.527"></a><span id="l31.527">     menuitem.setAttribute(&quot;label&quot;, viewInfo.prettyName);</span>
<a href="#l31.528"></a><span id="l31.528">     menuitem.setAttribute(&quot;value&quot;, kViewItemFirstCustom + i);</span>
<a href="#l31.529"></a><span id="l31.529" class="difflineminus">-    if (!aIsMenulist)</span>
<a href="#l31.530"></a><span id="l31.530" class="difflineminus">-    {</span>
<a href="#l31.531"></a><span id="l31.531" class="difflineminus">-      menuitem.setAttribute(&quot;type&quot;, &quot;radio&quot;);</span>
<a href="#l31.532"></a><span id="l31.532" class="difflineminus">-      if (kViewItemFirstCustom + i == currentView)</span>
<a href="#l31.533"></a><span id="l31.533" class="difflineminus">-        menuitem.setAttribute(&quot;checked&quot;, true);</span>
<a href="#l31.534"></a><span id="l31.534" class="difflineminus">-    }</span>
<a href="#l31.535"></a><span id="l31.535" class="difflineplus">+    menuitem.setAttribute(&quot;type&quot;, &quot;radio&quot;);</span>
<a href="#l31.536"></a><span id="l31.536" class="difflineplus">+    if (kViewItemFirstCustom + i == currentView)</span>
<a href="#l31.537"></a><span id="l31.537" class="difflineplus">+      menuitem.setAttribute(&quot;checked&quot;, true);</span>
<a href="#l31.538"></a><span id="l31.538">     aMenupopup.appendChild(menuitem);</span>
<a href="#l31.539"></a><span id="l31.539">   }</span>
<a href="#l31.540"></a><span id="l31.540"> }</span>
<a href="#l31.541"></a><span id="l31.541"> </span>
<a href="#l31.542"></a><span id="l31.542"> </span>
<a href="#l31.543"></a><span id="l31.543" class="difflineminus">-function RefreshTagsPopup(aMenupopup, aIsMenulist)</span>
<a href="#l31.544"></a><span id="l31.544" class="difflineplus">+function RefreshTagsPopup(aMenupopup)</span>
<a href="#l31.545"></a><span id="l31.545"> {</span>
<a href="#l31.546"></a><span id="l31.546">   // remove all menuitems</span>
<a href="#l31.547"></a><span id="l31.547">   while (aMenupopup.hasChildNodes())</span>
<a href="#l31.548"></a><span id="l31.548">     aMenupopup.removeChild(aMenupopup.lastChild);</span>
<a href="#l31.549"></a><span id="l31.549"> </span>
<a href="#l31.550"></a><span id="l31.550">   // create tag menuitems</span>
<a href="#l31.551"></a><span id="l31.551" class="difflineminus">-  var currentTagKey = isNaN(gCurrentViewValue) ? gCurrentViewValue.substr(kViewTagMarker.length) : &quot;&quot;;</span>
<a href="#l31.552"></a><span id="l31.552" class="difflineplus">+  var currentTagKey = gFolderDisplay.view.mailViewIndex == kViewItemTags ?</span>
<a href="#l31.553"></a><span id="l31.553" class="difflineplus">+                        gFolderDisplay.view.mailViewData : &quot;&quot;;</span>
<a href="#l31.554"></a><span id="l31.554">   var tagService = Components.classes[&quot;@mozilla.org/messenger/tagservice;1&quot;]</span>
<a href="#l31.555"></a><span id="l31.555">                              .getService(Components.interfaces.nsIMsgTagService);</span>
<a href="#l31.556"></a><span id="l31.556">   var tagArray = tagService.getAllTags({});</span>
<a href="#l31.557"></a><span id="l31.557">   for (var i = 0; i &lt; tagArray.length; ++i)</span>
<a href="#l31.558"></a><span id="l31.558">   {</span>
<a href="#l31.559"></a><span id="l31.559">     var tagInfo = tagArray[i];</span>
<a href="#l31.560"></a><span id="l31.560">     var menuitem = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l31.561"></a><span id="l31.561">     menuitem.setAttribute(&quot;label&quot;, tagInfo.tag);</span>
<a href="#l31.562"></a><span id="l31.562">     menuitem.setAttribute(&quot;value&quot;, kViewTagMarker + tagInfo.key);</span>
<a href="#l31.563"></a><span id="l31.563" class="difflineminus">-    if (!aIsMenulist)</span>
<a href="#l31.564"></a><span id="l31.564" class="difflineminus">-    {</span>
<a href="#l31.565"></a><span id="l31.565" class="difflineminus">-      menuitem.setAttribute(&quot;type&quot;, &quot;radio&quot;);</span>
<a href="#l31.566"></a><span id="l31.566" class="difflineminus">-      if (tagInfo.key == currentTagKey)</span>
<a href="#l31.567"></a><span id="l31.567" class="difflineminus">-        menuitem.setAttribute(&quot;checked&quot;, true);</span>
<a href="#l31.568"></a><span id="l31.568" class="difflineminus">-    }</span>
<a href="#l31.569"></a><span id="l31.569" class="difflineplus">+    menuitem.setAttribute(&quot;type&quot;, &quot;radio&quot;);</span>
<a href="#l31.570"></a><span id="l31.570" class="difflineplus">+    if (tagInfo.key == currentTagKey)</span>
<a href="#l31.571"></a><span id="l31.571" class="difflineplus">+      menuitem.setAttribute(&quot;checked&quot;, true);</span>
<a href="#l31.572"></a><span id="l31.572">     var color = tagInfo.color;</span>
<a href="#l31.573"></a><span id="l31.573">     if (color)</span>
<a href="#l31.574"></a><span id="l31.574">       menuitem.setAttribute(&quot;class&quot;, &quot;lc-&quot; + color.substr(1));</span>
<a href="#l31.575"></a><span id="l31.575">     aMenupopup.appendChild(menuitem);</span>
<a href="#l31.576"></a><span id="l31.576">   }</span>
<a href="#l31.577"></a><span id="l31.577"> }</span>
<a href="#l31.578"></a><span id="l31.578"> </span>
<a href="#l31.579"></a><span id="l31.579" class="difflineminus">-</span>
<a href="#l31.580"></a><span id="l31.580"> function ViewPickerOnLoad()</span>
<a href="#l31.581"></a><span id="l31.581"> {</span>
<a href="#l31.582"></a><span id="l31.582">   var viewPickerPopup = document.getElementById(&quot;viewPickerPopup&quot;);</span>
<a href="#l31.583"></a><span id="l31.583">   if (viewPickerPopup)</span>
<a href="#l31.584"></a><span id="l31.584">     RefreshAllViewPopups(viewPickerPopup, true);</span>
<a href="#l31.585"></a><span id="l31.585"> }</span>
<a href="#l31.586"></a><span id="l31.586"> </span>
<a href="#l31.587"></a><span id="l31.587"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1">new file mode 100644</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineminus">--- /dev/null</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-deletion-with-multiple-displays.js</span>
<a href="#l32.4"></a><span id="l32.4" class="difflineat">@@ -0,0 +1,196 @@</span>
<a href="#l32.5"></a><span id="l32.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l32.6"></a><span id="l32.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l32.7"></a><span id="l32.7" class="difflineplus">+ *</span>
<a href="#l32.8"></a><span id="l32.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l32.9"></a><span id="l32.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l32.10"></a><span id="l32.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l32.11"></a><span id="l32.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineplus">+ *</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l32.14"></a><span id="l32.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l32.15"></a><span id="l32.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l32.16"></a><span id="l32.16" class="difflineplus">+ * License.</span>
<a href="#l32.17"></a><span id="l32.17" class="difflineplus">+ *</span>
<a href="#l32.18"></a><span id="l32.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l32.19"></a><span id="l32.19" class="difflineplus">+ *</span>
<a href="#l32.20"></a><span id="l32.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l32.21"></a><span id="l32.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l32.22"></a><span id="l32.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l32.23"></a><span id="l32.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l32.24"></a><span id="l32.24" class="difflineplus">+ *</span>
<a href="#l32.25"></a><span id="l32.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l32.26"></a><span id="l32.26" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l32.27"></a><span id="l32.27" class="difflineplus">+ *</span>
<a href="#l32.28"></a><span id="l32.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l32.29"></a><span id="l32.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l32.30"></a><span id="l32.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l32.31"></a><span id="l32.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l32.32"></a><span id="l32.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l32.33"></a><span id="l32.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l32.34"></a><span id="l32.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l32.35"></a><span id="l32.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l32.36"></a><span id="l32.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l32.37"></a><span id="l32.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l32.38"></a><span id="l32.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l32.39"></a><span id="l32.39" class="difflineplus">+ *</span>
<a href="#l32.40"></a><span id="l32.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l32.41"></a><span id="l32.41" class="difflineplus">+</span>
<a href="#l32.42"></a><span id="l32.42" class="difflineplus">+/*</span>
<a href="#l32.43"></a><span id="l32.43" class="difflineplus">+ * Test that deleting a message in a given tab or window properly updates both</span>
<a href="#l32.44"></a><span id="l32.44" class="difflineplus">+ *  that tab/window as well as all other tabs/windows.  We also test that the</span>
<a href="#l32.45"></a><span id="l32.45" class="difflineplus">+ *  message tab title updates appropriately through all of this.</span>
<a href="#l32.46"></a><span id="l32.46" class="difflineplus">+ */</span>
<a href="#l32.47"></a><span id="l32.47" class="difflineplus">+var MODULE_NAME = 'test-deletion-with-multiple-displays';</span>
<a href="#l32.48"></a><span id="l32.48" class="difflineplus">+</span>
<a href="#l32.49"></a><span id="l32.49" class="difflineplus">+var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l32.50"></a><span id="l32.50" class="difflineplus">+var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers'];</span>
<a href="#l32.51"></a><span id="l32.51" class="difflineplus">+</span>
<a href="#l32.52"></a><span id="l32.52" class="difflineplus">+var folder;</span>
<a href="#l32.53"></a><span id="l32.53" class="difflineplus">+</span>
<a href="#l32.54"></a><span id="l32.54" class="difflineplus">+function setupModule(module) {</span>
<a href="#l32.55"></a><span id="l32.55" class="difflineplus">+  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l32.56"></a><span id="l32.56" class="difflineplus">+  fdh.installInto(module);</span>
<a href="#l32.57"></a><span id="l32.57" class="difflineplus">+  let wh = collector.getModule('window-helpers');</span>
<a href="#l32.58"></a><span id="l32.58" class="difflineplus">+  wh.installInto(module);</span>
<a href="#l32.59"></a><span id="l32.59" class="difflineplus">+</span>
<a href="#l32.60"></a><span id="l32.60" class="difflineplus">+  folder = create_folder(&quot;DeletionA&quot;);</span>
<a href="#l32.61"></a><span id="l32.61" class="difflineplus">+  // we want exactly as many messages as we plan to delete, so that we can test</span>
<a href="#l32.62"></a><span id="l32.62" class="difflineplus">+  //  that the message window and tabs close when they run out of things to</span>
<a href="#l32.63"></a><span id="l32.63" class="difflineplus">+  //  to display.</span>
<a href="#l32.64"></a><span id="l32.64" class="difflineplus">+  make_new_sets_in_folder(folder, [{count: 4}]);</span>
<a href="#l32.65"></a><span id="l32.65" class="difflineplus">+}</span>
<a href="#l32.66"></a><span id="l32.66" class="difflineplus">+</span>
<a href="#l32.67"></a><span id="l32.67" class="difflineplus">+</span>
<a href="#l32.68"></a><span id="l32.68" class="difflineplus">+var tabFolder, tabMessage, curMessage, nextMessage;</span>
<a href="#l32.69"></a><span id="l32.69" class="difflineplus">+</span>
<a href="#l32.70"></a><span id="l32.70" class="difflineplus">+/**</span>
<a href="#l32.71"></a><span id="l32.71" class="difflineplus">+ * The message window controller.  Short names because controllers get used a</span>
<a href="#l32.72"></a><span id="l32.72" class="difflineplus">+ *  lot.</span>
<a href="#l32.73"></a><span id="l32.73" class="difflineplus">+ */</span>
<a href="#l32.74"></a><span id="l32.74" class="difflineplus">+var msgc;</span>
<a href="#l32.75"></a><span id="l32.75" class="difflineplus">+</span>
<a href="#l32.76"></a><span id="l32.76" class="difflineplus">+/**</span>
<a href="#l32.77"></a><span id="l32.77" class="difflineplus">+ * Have a message displayed in a folder tab, message tab, and message window.</span>
<a href="#l32.78"></a><span id="l32.78" class="difflineplus">+ *  The idea is that as we delete from the various sources, they should all</span>
<a href="#l32.79"></a><span id="l32.79" class="difflineplus">+ *  advance in lock-step through their messages, simplifying our lives (but</span>
<a href="#l32.80"></a><span id="l32.80" class="difflineplus">+ *  making us explode forevermore the first time any of the tests fail.)</span>
<a href="#l32.81"></a><span id="l32.81" class="difflineplus">+ */</span>
<a href="#l32.82"></a><span id="l32.82" class="difflineplus">+function test_open_message_in_all_three_display_mechanisms() {</span>
<a href="#l32.83"></a><span id="l32.83" class="difflineplus">+  // - Select the message in this tab.</span>
<a href="#l32.84"></a><span id="l32.84" class="difflineplus">+  tabFolder = be_in_folder(folder);</span>
<a href="#l32.85"></a><span id="l32.85" class="difflineplus">+  curMessage = select_click_row(0);</span>
<a href="#l32.86"></a><span id="l32.86" class="difflineplus">+  assert_selected_and_displayed(curMessage);</span>
<a href="#l32.87"></a><span id="l32.87" class="difflineplus">+</span>
<a href="#l32.88"></a><span id="l32.88" class="difflineplus">+  // - Open the tab with the message</span>
<a href="#l32.89"></a><span id="l32.89" class="difflineplus">+  tabMessage = open_selected_message_in_new_tab();</span>
<a href="#l32.90"></a><span id="l32.90" class="difflineplus">+  assert_selected_and_displayed(curMessage);</span>
<a href="#l32.91"></a><span id="l32.91" class="difflineplus">+  assert_tab_titled_from(tabMessage, curMessage);</span>
<a href="#l32.92"></a><span id="l32.92" class="difflineplus">+</span>
<a href="#l32.93"></a><span id="l32.93" class="difflineplus">+  // - Open the window with the message</span>
<a href="#l32.94"></a><span id="l32.94" class="difflineplus">+  // need to go back to the folder tab.  (well, should.)</span>
<a href="#l32.95"></a><span id="l32.95" class="difflineplus">+  switch_tab(tabFolder);</span>
<a href="#l32.96"></a><span id="l32.96" class="difflineplus">+  msgc = open_selected_message_in_new_window();</span>
<a href="#l32.97"></a><span id="l32.97" class="difflineplus">+  assert_selected_and_displayed(msgc, curMessage);</span>
<a href="#l32.98"></a><span id="l32.98" class="difflineplus">+}</span>
<a href="#l32.99"></a><span id="l32.99" class="difflineplus">+</span>
<a href="#l32.100"></a><span id="l32.100" class="difflineplus">+/**</span>
<a href="#l32.101"></a><span id="l32.101" class="difflineplus">+ * Perform a deletion from the folder tab, verify the others update correctly</span>
<a href="#l32.102"></a><span id="l32.102" class="difflineplus">+ *  (advancing to the next message).</span>
<a href="#l32.103"></a><span id="l32.103" class="difflineplus">+ */</span>
<a href="#l32.104"></a><span id="l32.104" class="difflineplus">+function test_delete_in_folder_tab() {</span>
<a href="#l32.105"></a><span id="l32.105" class="difflineplus">+  // - plan to end up on the guy who is currently at index 1</span>
<a href="#l32.106"></a><span id="l32.106" class="difflineplus">+  curMessage = mc.dbView.getMsgHdrAt(1);</span>
<a href="#l32.107"></a><span id="l32.107" class="difflineplus">+  // while we're at it, figure out who is at 2 for the next step</span>
<a href="#l32.108"></a><span id="l32.108" class="difflineplus">+  nextMessage = mc.dbView.getMsgHdrAt(2);</span>
<a href="#l32.109"></a><span id="l32.109" class="difflineplus">+  // - delete the message</span>
<a href="#l32.110"></a><span id="l32.110" class="difflineplus">+  press_delete();</span>
<a href="#l32.111"></a><span id="l32.111" class="difflineplus">+  // - make sure the right guy is selected, and that he is at index 0</span>
<a href="#l32.112"></a><span id="l32.112" class="difflineplus">+  assert_selected_and_displayed(curMessage);</span>
<a href="#l32.113"></a><span id="l32.113" class="difflineplus">+  assert_selected_and_displayed(0);</span>
<a href="#l32.114"></a><span id="l32.114" class="difflineplus">+</span>
<a href="#l32.115"></a><span id="l32.115" class="difflineplus">+  // - make sure the message tab updated its title even without us switching</span>
<a href="#l32.116"></a><span id="l32.116" class="difflineplus">+  assert_tab_titled_from(tabMessage, curMessage);</span>
<a href="#l32.117"></a><span id="l32.117" class="difflineplus">+</span>
<a href="#l32.118"></a><span id="l32.118" class="difflineplus">+  // - switch to the message tab, make sure he is now on the right guy</span>
<a href="#l32.119"></a><span id="l32.119" class="difflineplus">+  switch_tab(tabMessage);</span>
<a href="#l32.120"></a><span id="l32.120" class="difflineplus">+  assert_selected_and_displayed(curMessage);</span>
<a href="#l32.121"></a><span id="l32.121" class="difflineplus">+</span>
<a href="#l32.122"></a><span id="l32.122" class="difflineplus">+  // - check the window</span>
<a href="#l32.123"></a><span id="l32.123" class="difflineplus">+  assert_selected_and_displayed(msgc, curMessage);</span>
<a href="#l32.124"></a><span id="l32.124" class="difflineplus">+}</span>
<a href="#l32.125"></a><span id="l32.125" class="difflineplus">+</span>
<a href="#l32.126"></a><span id="l32.126" class="difflineplus">+/**</span>
<a href="#l32.127"></a><span id="l32.127" class="difflineplus">+ * Perform a deletion from the message tab, verify the others update correctly</span>
<a href="#l32.128"></a><span id="l32.128" class="difflineplus">+ *  (advancing to the next message).</span>
<a href="#l32.129"></a><span id="l32.129" class="difflineplus">+ */</span>
<a href="#l32.130"></a><span id="l32.130" class="difflineplus">+function test_delete_in_message_tab() {</span>
<a href="#l32.131"></a><span id="l32.131" class="difflineplus">+  // (we're still on the message tab, and nextMessage is the guy we want to see</span>
<a href="#l32.132"></a><span id="l32.132" class="difflineplus">+  //  once the delete completes.)</span>
<a href="#l32.133"></a><span id="l32.133" class="difflineplus">+  press_delete();</span>
<a href="#l32.134"></a><span id="l32.134" class="difflineplus">+  curMessage = nextMessage;</span>
<a href="#l32.135"></a><span id="l32.135" class="difflineplus">+  assert_selected_and_displayed(curMessage);</span>
<a href="#l32.136"></a><span id="l32.136" class="difflineplus">+  assert_tab_titled_from(tabMessage, curMessage);</span>
<a href="#l32.137"></a><span id="l32.137" class="difflineplus">+</span>
<a href="#l32.138"></a><span id="l32.138" class="difflineplus">+  // - switch to the folder tab and make sure he is on the right guy and at 0</span>
<a href="#l32.139"></a><span id="l32.139" class="difflineplus">+  switch_tab(tabFolder);</span>
<a href="#l32.140"></a><span id="l32.140" class="difflineplus">+  assert_selected_and_displayed(curMessage);</span>
<a href="#l32.141"></a><span id="l32.141" class="difflineplus">+  assert_selected_and_displayed(0);</span>
<a href="#l32.142"></a><span id="l32.142" class="difflineplus">+  // figure out the next guy...</span>
<a href="#l32.143"></a><span id="l32.143" class="difflineplus">+  nextMessage = mc.dbView.getMsgHdrAt(1);</span>
<a href="#l32.144"></a><span id="l32.144" class="difflineplus">+  if (!nextMessage)</span>
<a href="#l32.145"></a><span id="l32.145" class="difflineplus">+    throw new Error(&quot;We ran out of messages early?&quot;);</span>
<a href="#l32.146"></a><span id="l32.146" class="difflineplus">+</span>
<a href="#l32.147"></a><span id="l32.147" class="difflineplus">+  // - check the message window</span>
<a href="#l32.148"></a><span id="l32.148" class="difflineplus">+  assert_selected_and_displayed(msgc, curMessage);</span>
<a href="#l32.149"></a><span id="l32.149" class="difflineplus">+}</span>
<a href="#l32.150"></a><span id="l32.150" class="difflineplus">+</span>
<a href="#l32.151"></a><span id="l32.151" class="difflineplus">+/**</span>
<a href="#l32.152"></a><span id="l32.152" class="difflineplus">+ * Perform a deletion from the message window, verify the others update</span>
<a href="#l32.153"></a><span id="l32.153" class="difflineplus">+ *  correctly (advancing to the next message).</span>
<a href="#l32.154"></a><span id="l32.154" class="difflineplus">+ */</span>
<a href="#l32.155"></a><span id="l32.155" class="difflineplus">+function test_delete_in_message_window() {</span>
<a href="#l32.156"></a><span id="l32.156" class="difflineplus">+  // - delete, verify in the message window</span>
<a href="#l32.157"></a><span id="l32.157" class="difflineplus">+  press_delete(msgc);</span>
<a href="#l32.158"></a><span id="l32.158" class="difflineplus">+  curMessage = nextMessage;</span>
<a href="#l32.159"></a><span id="l32.159" class="difflineplus">+  assert_selected_and_displayed(msgc, curMessage);</span>
<a href="#l32.160"></a><span id="l32.160" class="difflineplus">+</span>
<a href="#l32.161"></a><span id="l32.161" class="difflineplus">+  // - verify in the folder tab (we're still on this tab)</span>
<a href="#l32.162"></a><span id="l32.162" class="difflineplus">+  assert_selected_and_displayed(curMessage);</span>
<a href="#l32.163"></a><span id="l32.163" class="difflineplus">+  assert_selected_and_displayed(0);</span>
<a href="#l32.164"></a><span id="l32.164" class="difflineplus">+</span>
<a href="#l32.165"></a><span id="l32.165" class="difflineplus">+  // - verify in the message tab</span>
<a href="#l32.166"></a><span id="l32.166" class="difflineplus">+  switch_tab(tabMessage);</span>
<a href="#l32.167"></a><span id="l32.167" class="difflineplus">+  assert_selected_and_displayed(curMessage);</span>
<a href="#l32.168"></a><span id="l32.168" class="difflineplus">+  assert_tab_titled_from(tabMessage, curMessage);</span>
<a href="#l32.169"></a><span id="l32.169" class="difflineplus">+}</span>
<a href="#l32.170"></a><span id="l32.170" class="difflineplus">+</span>
<a href="#l32.171"></a><span id="l32.171" class="difflineplus">+/**</span>
<a href="#l32.172"></a><span id="l32.172" class="difflineplus">+ * Delete the last message in that folder, which should close all message</span>
<a href="#l32.173"></a><span id="l32.173" class="difflineplus">+ *  displays.  For comprehensiveness, first open an additional message tab</span>
<a href="#l32.174"></a><span id="l32.174" class="difflineplus">+ *  of the message so that we can test foreground and background closing at the</span>
<a href="#l32.175"></a><span id="l32.175" class="difflineplus">+ *  same time.</span>
<a href="#l32.176"></a><span id="l32.176" class="difflineplus">+ */</span>
<a href="#l32.177"></a><span id="l32.177" class="difflineplus">+function test_delete_last_message_closes_message_displays() {</span>
<a href="#l32.178"></a><span id="l32.178" class="difflineplus">+  // - open the additional message tab</span>
<a href="#l32.179"></a><span id="l32.179" class="difflineplus">+  switch_tab(tabFolder);</span>
<a href="#l32.180"></a><span id="l32.180" class="difflineplus">+  let tabMessage2 = open_selected_message_in_new_tab();</span>
<a href="#l32.181"></a><span id="l32.181" class="difflineplus">+</span>
<a href="#l32.182"></a><span id="l32.182" class="difflineplus">+  // - prep for the message window disappearing</span>
<a href="#l32.183"></a><span id="l32.183" class="difflineplus">+  plan_for_window_close(msgc);</span>
<a href="#l32.184"></a><span id="l32.184" class="difflineplus">+</span>
<a href="#l32.185"></a><span id="l32.185" class="difflineplus">+  // - let's arbitrarily perform the deletion on this message tab</span>
<a href="#l32.186"></a><span id="l32.186" class="difflineplus">+  press_delete();</span>
<a href="#l32.187"></a><span id="l32.187" class="difflineplus">+</span>
<a href="#l32.188"></a><span id="l32.188" class="difflineplus">+  // - the message window should have gone away...</span>
<a href="#l32.189"></a><span id="l32.189" class="difflineplus">+  // (this also helps ensure that the 3pane gets enough event loop time to do</span>
<a href="#l32.190"></a><span id="l32.190" class="difflineplus">+  //  all that it needs to accomplish)</span>
<a href="#l32.191"></a><span id="l32.191" class="difflineplus">+  wait_for_window_close(msgc);</span>
<a href="#l32.192"></a><span id="l32.192" class="difflineplus">+  msgc = null;</span>
<a href="#l32.193"></a><span id="l32.193" class="difflineplus">+</span>
<a href="#l32.194"></a><span id="l32.194" class="difflineplus">+  // - and we should now be on the folder tab and there should be no other tabs</span>
<a href="#l32.195"></a><span id="l32.195" class="difflineplus">+  if (mc.tabmail.tabInfo.length != 1)</span>
<a href="#l32.196"></a><span id="l32.196" class="difflineplus">+    throw new Error(&quot;There should only be one tab left!&quot;);</span>
<a href="#l32.197"></a><span id="l32.197" class="difflineplus">+  // the below check is implied by the previous check if things are sane-ish</span>
<a href="#l32.198"></a><span id="l32.198" class="difflineplus">+  if (mc.tabmail.currentTabInfo != tabFolder)</span>
<a href="#l32.199"></a><span id="l32.199" class="difflineplus">+    throw new Error(&quot;We should be on the folder tab!&quot;);</span>
<a href="#l32.200"></a><span id="l32.200" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1">new file mode 100644</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineminus">--- /dev/null</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-mail-views.js</span>
<a href="#l33.4"></a><span id="l33.4" class="difflineat">@@ -0,0 +1,112 @@</span>
<a href="#l33.5"></a><span id="l33.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l33.6"></a><span id="l33.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l33.7"></a><span id="l33.7" class="difflineplus">+ *</span>
<a href="#l33.8"></a><span id="l33.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l33.9"></a><span id="l33.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l33.10"></a><span id="l33.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l33.11"></a><span id="l33.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineplus">+ *</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l33.14"></a><span id="l33.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l33.15"></a><span id="l33.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l33.16"></a><span id="l33.16" class="difflineplus">+ * License.</span>
<a href="#l33.17"></a><span id="l33.17" class="difflineplus">+ *</span>
<a href="#l33.18"></a><span id="l33.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l33.19"></a><span id="l33.19" class="difflineplus">+ *</span>
<a href="#l33.20"></a><span id="l33.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l33.21"></a><span id="l33.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l33.22"></a><span id="l33.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l33.23"></a><span id="l33.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l33.24"></a><span id="l33.24" class="difflineplus">+ *</span>
<a href="#l33.25"></a><span id="l33.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l33.26"></a><span id="l33.26" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l33.27"></a><span id="l33.27" class="difflineplus">+ *</span>
<a href="#l33.28"></a><span id="l33.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l33.29"></a><span id="l33.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l33.30"></a><span id="l33.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l33.31"></a><span id="l33.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l33.32"></a><span id="l33.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l33.33"></a><span id="l33.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l33.34"></a><span id="l33.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l33.35"></a><span id="l33.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l33.36"></a><span id="l33.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l33.37"></a><span id="l33.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l33.38"></a><span id="l33.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l33.39"></a><span id="l33.39" class="difflineplus">+ *</span>
<a href="#l33.40"></a><span id="l33.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l33.41"></a><span id="l33.41" class="difflineplus">+</span>
<a href="#l33.42"></a><span id="l33.42" class="difflineplus">+var MODULE_NAME = 'test-mail-views';</span>
<a href="#l33.43"></a><span id="l33.43" class="difflineplus">+</span>
<a href="#l33.44"></a><span id="l33.44" class="difflineplus">+var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l33.45"></a><span id="l33.45" class="difflineplus">+var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers'];</span>
<a href="#l33.46"></a><span id="l33.46" class="difflineplus">+</span>
<a href="#l33.47"></a><span id="l33.47" class="difflineplus">+var baseFolder, savedFolder;</span>
<a href="#l33.48"></a><span id="l33.48" class="difflineplus">+var setUntagged, setTagged;</span>
<a href="#l33.49"></a><span id="l33.49" class="difflineplus">+</span>
<a href="#l33.50"></a><span id="l33.50" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/mailViewManager.js&quot;);</span>
<a href="#l33.51"></a><span id="l33.51" class="difflineplus">+</span>
<a href="#l33.52"></a><span id="l33.52" class="difflineplus">+var setupModule = function(module) {</span>
<a href="#l33.53"></a><span id="l33.53" class="difflineplus">+  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l33.54"></a><span id="l33.54" class="difflineplus">+  fdh.installInto(module);</span>
<a href="#l33.55"></a><span id="l33.55" class="difflineplus">+  let wh = collector.getModule('window-helpers');</span>
<a href="#l33.56"></a><span id="l33.56" class="difflineplus">+  wh.installInto(module);</span>
<a href="#l33.57"></a><span id="l33.57" class="difflineplus">+</span>
<a href="#l33.58"></a><span id="l33.58" class="difflineplus">+  // Create a folder with some messages that have no tags and some that are</span>
<a href="#l33.59"></a><span id="l33.59" class="difflineplus">+  //  tagged Important ($label1).</span>
<a href="#l33.60"></a><span id="l33.60" class="difflineplus">+  baseFolder = create_folder(&quot;MailViewA&quot;);</span>
<a href="#l33.61"></a><span id="l33.61" class="difflineplus">+  [setUntagged, setTagged] = make_new_sets_in_folder(baseFolder,</span>
<a href="#l33.62"></a><span id="l33.62" class="difflineplus">+                                                     [{}, {}]);</span>
<a href="#l33.63"></a><span id="l33.63" class="difflineplus">+  setTagged.addTag(&quot;$label1&quot;); // Important, by default</span>
<a href="#l33.64"></a><span id="l33.64" class="difflineplus">+};</span>
<a href="#l33.65"></a><span id="l33.65" class="difflineplus">+</span>
<a href="#l33.66"></a><span id="l33.66" class="difflineplus">+function test_put_view_picker_on_toolbar() {</span>
<a href="#l33.67"></a><span id="l33.67" class="difflineplus">+  let toolbar = mc.e(&quot;mail-bar2&quot;);</span>
<a href="#l33.68"></a><span id="l33.68" class="difflineplus">+  toolbar.insertItem(&quot;mailviews-container&quot;, null);</span>
<a href="#l33.69"></a><span id="l33.69" class="difflineplus">+  mc.assertNode(mc.eid(&quot;mailviews-container&quot;));</span>
<a href="#l33.70"></a><span id="l33.70" class="difflineplus">+}</span>
<a href="#l33.71"></a><span id="l33.71" class="difflineplus">+</span>
<a href="#l33.72"></a><span id="l33.72" class="difflineplus">+/**</span>
<a href="#l33.73"></a><span id="l33.73" class="difflineplus">+ * https://bugzilla.mozilla.org/show_bug.cgi?id=474701#c97</span>
<a href="#l33.74"></a><span id="l33.74" class="difflineplus">+ */</span>
<a href="#l33.75"></a><span id="l33.75" class="difflineplus">+function test_save_view_as_folder() {</span>
<a href="#l33.76"></a><span id="l33.76" class="difflineplus">+  // - enter the folder</span>
<a href="#l33.77"></a><span id="l33.77" class="difflineplus">+  be_in_folder(baseFolder);</span>
<a href="#l33.78"></a><span id="l33.78" class="difflineplus">+</span>
<a href="#l33.79"></a><span id="l33.79" class="difflineplus">+  // - apply the mail view</span>
<a href="#l33.80"></a><span id="l33.80" class="difflineplus">+  // okay, mozmill is just not ready to click on the view picker...</span>
<a href="#l33.81"></a><span id="l33.81" class="difflineplus">+  // just call the ViewChange global.  it's sad, but it has the same effects.</span>
<a href="#l33.82"></a><span id="l33.82" class="difflineplus">+  // at least, it does once we've caused the popups to get refreshed.</span>
<a href="#l33.83"></a><span id="l33.83" class="difflineplus">+  mc.window.RefreshAllViewPopups(mc.e(&quot;viewPickerPopup&quot;));</span>
<a href="#l33.84"></a><span id="l33.84" class="difflineplus">+  mc.window.ViewChange(&quot;:$label1&quot;);</span>
<a href="#l33.85"></a><span id="l33.85" class="difflineplus">+  wait_for_all_messages_to_load();</span>
<a href="#l33.86"></a><span id="l33.86" class="difflineplus">+</span>
<a href="#l33.87"></a><span id="l33.87" class="difflineplus">+  // - save it</span>
<a href="#l33.88"></a><span id="l33.88" class="difflineplus">+  plan_for_modal_dialog(&quot;mailnews:virtualFolderProperties&quot;,</span>
<a href="#l33.89"></a><span id="l33.89" class="difflineplus">+                        subtest_save_mail_view);</span>
<a href="#l33.90"></a><span id="l33.90" class="difflineplus">+  // we have to use value here because the option mechanism is not sophisticated</span>
<a href="#l33.91"></a><span id="l33.91" class="difflineplus">+  //  enough.</span>
<a href="#l33.92"></a><span id="l33.92" class="difflineplus">+  mc.window.ViewChange(MailViewConstants.kViewItemVirtual);</span>
<a href="#l33.93"></a><span id="l33.93" class="difflineplus">+  wait_for_modal_dialog(&quot;mailnews:virtualFolderProperties&quot;);</span>
<a href="#l33.94"></a><span id="l33.94" class="difflineplus">+}</span>
<a href="#l33.95"></a><span id="l33.95" class="difflineplus">+</span>
<a href="#l33.96"></a><span id="l33.96" class="difflineplus">+function subtest_save_mail_view(savc) {</span>
<a href="#l33.97"></a><span id="l33.97" class="difflineplus">+  // - make sure the name is right</span>
<a href="#l33.98"></a><span id="l33.98" class="difflineplus">+  savc.assertValue(savc.eid(&quot;name&quot;), baseFolder.prettyName + &quot;-Important&quot;);</span>
<a href="#l33.99"></a><span id="l33.99" class="difflineplus">+</span>
<a href="#l33.100"></a><span id="l33.100" class="difflineplus">+  // - make sure the constraint is right</span>
<a href="#l33.101"></a><span id="l33.101" class="difflineplus">+  savc.assertValue(savc.aid(&quot;searchVal0&quot;, {crazyDeck: 0}), &quot;$label1&quot;);</span>
<a href="#l33.102"></a><span id="l33.102" class="difflineplus">+</span>
<a href="#l33.103"></a><span id="l33.103" class="difflineplus">+  // - save it</span>
<a href="#l33.104"></a><span id="l33.104" class="difflineplus">+  savc.window.onOK();</span>
<a href="#l33.105"></a><span id="l33.105" class="difflineplus">+}</span>
<a href="#l33.106"></a><span id="l33.106" class="difflineplus">+</span>
<a href="#l33.107"></a><span id="l33.107" class="difflineplus">+function test_verify_saved_mail_view() {</span>
<a href="#l33.108"></a><span id="l33.108" class="difflineplus">+  // - make sure the folder got created</span>
<a href="#l33.109"></a><span id="l33.109" class="difflineplus">+  savedFolder = baseFolder.findSubFolder(baseFolder.prettyName + &quot;-Important&quot;);</span>
<a href="#l33.110"></a><span id="l33.110" class="difflineplus">+  if (!savedFolder)</span>
<a href="#l33.111"></a><span id="l33.111" class="difflineplus">+    throw new Error(&quot;MailViewA-Important was not created!&quot;);</span>
<a href="#l33.112"></a><span id="l33.112" class="difflineplus">+</span>
<a href="#l33.113"></a><span id="l33.113" class="difflineplus">+  // - go in the folder and make sure the right messages are displayed</span>
<a href="#l33.114"></a><span id="l33.114" class="difflineplus">+  be_in_folder(savedFolder);</span>
<a href="#l33.115"></a><span id="l33.115" class="difflineplus">+  assert_messages_in_view(setTagged, mc);</span>
<a href="#l33.116"></a><span id="l33.116" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1">new file mode 100644</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineminus">--- /dev/null</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-message-window.js</span>
<a href="#l34.4"></a><span id="l34.4" class="difflineat">@@ -0,0 +1,81 @@</span>
<a href="#l34.5"></a><span id="l34.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l34.6"></a><span id="l34.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l34.7"></a><span id="l34.7" class="difflineplus">+ *</span>
<a href="#l34.8"></a><span id="l34.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l34.9"></a><span id="l34.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l34.10"></a><span id="l34.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l34.11"></a><span id="l34.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineplus">+ *</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l34.14"></a><span id="l34.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l34.15"></a><span id="l34.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l34.16"></a><span id="l34.16" class="difflineplus">+ * License.</span>
<a href="#l34.17"></a><span id="l34.17" class="difflineplus">+ *</span>
<a href="#l34.18"></a><span id="l34.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l34.19"></a><span id="l34.19" class="difflineplus">+ *</span>
<a href="#l34.20"></a><span id="l34.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l34.21"></a><span id="l34.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l34.22"></a><span id="l34.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l34.23"></a><span id="l34.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l34.24"></a><span id="l34.24" class="difflineplus">+ *</span>
<a href="#l34.25"></a><span id="l34.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l34.26"></a><span id="l34.26" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l34.27"></a><span id="l34.27" class="difflineplus">+ *</span>
<a href="#l34.28"></a><span id="l34.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l34.29"></a><span id="l34.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l34.30"></a><span id="l34.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l34.31"></a><span id="l34.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l34.32"></a><span id="l34.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l34.33"></a><span id="l34.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l34.34"></a><span id="l34.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l34.35"></a><span id="l34.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l34.36"></a><span id="l34.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l34.37"></a><span id="l34.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l34.38"></a><span id="l34.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l34.39"></a><span id="l34.39" class="difflineplus">+ *</span>
<a href="#l34.40"></a><span id="l34.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l34.41"></a><span id="l34.41" class="difflineplus">+</span>
<a href="#l34.42"></a><span id="l34.42" class="difflineplus">+/*</span>
<a href="#l34.43"></a><span id="l34.43" class="difflineplus">+ * Test that we can open and close a standalone message display window from the</span>
<a href="#l34.44"></a><span id="l34.44" class="difflineplus">+ *  folder pane.</span>
<a href="#l34.45"></a><span id="l34.45" class="difflineplus">+ */</span>
<a href="#l34.46"></a><span id="l34.46" class="difflineplus">+var MODULE_NAME = 'test-message-window';</span>
<a href="#l34.47"></a><span id="l34.47" class="difflineplus">+</span>
<a href="#l34.48"></a><span id="l34.48" class="difflineplus">+var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l34.49"></a><span id="l34.49" class="difflineplus">+var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers'];</span>
<a href="#l34.50"></a><span id="l34.50" class="difflineplus">+</span>
<a href="#l34.51"></a><span id="l34.51" class="difflineplus">+var folder;</span>
<a href="#l34.52"></a><span id="l34.52" class="difflineplus">+</span>
<a href="#l34.53"></a><span id="l34.53" class="difflineplus">+function setupModule(module) {</span>
<a href="#l34.54"></a><span id="l34.54" class="difflineplus">+  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l34.55"></a><span id="l34.55" class="difflineplus">+  fdh.installInto(module);</span>
<a href="#l34.56"></a><span id="l34.56" class="difflineplus">+  let wh = collector.getModule('window-helpers');</span>
<a href="#l34.57"></a><span id="l34.57" class="difflineplus">+  wh.installInto(module);</span>
<a href="#l34.58"></a><span id="l34.58" class="difflineplus">+</span>
<a href="#l34.59"></a><span id="l34.59" class="difflineplus">+  folder = create_folder(&quot;MessageWindowA&quot;);</span>
<a href="#l34.60"></a><span id="l34.60" class="difflineplus">+  // create a single message in the folder to display</span>
<a href="#l34.61"></a><span id="l34.61" class="difflineplus">+  make_new_sets_in_folder(folder, [{count: 1}]);</span>
<a href="#l34.62"></a><span id="l34.62" class="difflineplus">+}</span>
<a href="#l34.63"></a><span id="l34.63" class="difflineplus">+</span>
<a href="#l34.64"></a><span id="l34.64" class="difflineplus">+/** The message window controller. */</span>
<a href="#l34.65"></a><span id="l34.65" class="difflineplus">+var msgc;</span>
<a href="#l34.66"></a><span id="l34.66" class="difflineplus">+</span>
<a href="#l34.67"></a><span id="l34.67" class="difflineplus">+function test_open_message_window() {</span>
<a href="#l34.68"></a><span id="l34.68" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l34.69"></a><span id="l34.69" class="difflineplus">+</span>
<a href="#l34.70"></a><span id="l34.70" class="difflineplus">+  // select the one and only message</span>
<a href="#l34.71"></a><span id="l34.71" class="difflineplus">+  let curMessage = select_click_row(0);</span>
<a href="#l34.72"></a><span id="l34.72" class="difflineplus">+</span>
<a href="#l34.73"></a><span id="l34.73" class="difflineplus">+  // display it</span>
<a href="#l34.74"></a><span id="l34.74" class="difflineplus">+  msgc = open_selected_message_in_new_window();</span>
<a href="#l34.75"></a><span id="l34.75" class="difflineplus">+  assert_selected_and_displayed(msgc, curMessage);</span>
<a href="#l34.76"></a><span id="l34.76" class="difflineplus">+}</span>
<a href="#l34.77"></a><span id="l34.77" class="difflineplus">+</span>
<a href="#l34.78"></a><span id="l34.78" class="difflineplus">+/**</span>
<a href="#l34.79"></a><span id="l34.79" class="difflineplus">+ * Close the window by hitting escape.</span>
<a href="#l34.80"></a><span id="l34.80" class="difflineplus">+ */</span>
<a href="#l34.81"></a><span id="l34.81" class="difflineplus">+function test_close_message_window() {</span>
<a href="#l34.82"></a><span id="l34.82" class="difflineplus">+  plan_for_window_close(msgc);</span>
<a href="#l34.83"></a><span id="l34.83" class="difflineplus">+  msgc.keypress(null, &quot;VK_ESCAPE&quot;, {});</span>
<a href="#l34.84"></a><span id="l34.84" class="difflineplus">+  wait_for_window_close(msgc);</span>
<a href="#l34.85"></a><span id="l34.85" class="difflineplus">+}</span>
<a href="#l34.86"></a><span id="l34.86">\ No newline at end of file</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1">new file mode 100644</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineminus">--- /dev/null</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-right-click-middle-click.js</span>
<a href="#l35.4"></a><span id="l35.4" class="difflineat">@@ -0,0 +1,313 @@</span>
<a href="#l35.5"></a><span id="l35.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l35.6"></a><span id="l35.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l35.7"></a><span id="l35.7" class="difflineplus">+ *</span>
<a href="#l35.8"></a><span id="l35.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l35.9"></a><span id="l35.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l35.10"></a><span id="l35.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l35.11"></a><span id="l35.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineplus">+ *</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l35.14"></a><span id="l35.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l35.15"></a><span id="l35.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l35.16"></a><span id="l35.16" class="difflineplus">+ * License.</span>
<a href="#l35.17"></a><span id="l35.17" class="difflineplus">+ *</span>
<a href="#l35.18"></a><span id="l35.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l35.19"></a><span id="l35.19" class="difflineplus">+ *</span>
<a href="#l35.20"></a><span id="l35.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l35.21"></a><span id="l35.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l35.22"></a><span id="l35.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l35.23"></a><span id="l35.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l35.24"></a><span id="l35.24" class="difflineplus">+ *</span>
<a href="#l35.25"></a><span id="l35.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l35.26"></a><span id="l35.26" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l35.27"></a><span id="l35.27" class="difflineplus">+ *</span>
<a href="#l35.28"></a><span id="l35.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l35.29"></a><span id="l35.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l35.30"></a><span id="l35.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l35.31"></a><span id="l35.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l35.32"></a><span id="l35.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l35.33"></a><span id="l35.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l35.34"></a><span id="l35.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l35.35"></a><span id="l35.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l35.36"></a><span id="l35.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l35.37"></a><span id="l35.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l35.38"></a><span id="l35.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l35.39"></a><span id="l35.39" class="difflineplus">+ *</span>
<a href="#l35.40"></a><span id="l35.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l35.41"></a><span id="l35.41" class="difflineplus">+</span>
<a href="#l35.42"></a><span id="l35.42" class="difflineplus">+/*</span>
<a href="#l35.43"></a><span id="l35.43" class="difflineplus">+ * Test the many horrors involving right-clicks, middle clicks, and selections.</span>
<a href="#l35.44"></a><span id="l35.44" class="difflineplus">+ */</span>
<a href="#l35.45"></a><span id="l35.45" class="difflineplus">+</span>
<a href="#l35.46"></a><span id="l35.46" class="difflineplus">+var MODULE_NAME = 'test-deletion-with-multiple-displays';</span>
<a href="#l35.47"></a><span id="l35.47" class="difflineplus">+</span>
<a href="#l35.48"></a><span id="l35.48" class="difflineplus">+var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l35.49"></a><span id="l35.49" class="difflineplus">+var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers'];</span>
<a href="#l35.50"></a><span id="l35.50" class="difflineplus">+</span>
<a href="#l35.51"></a><span id="l35.51" class="difflineplus">+var folder;</span>
<a href="#l35.52"></a><span id="l35.52" class="difflineplus">+</span>
<a href="#l35.53"></a><span id="l35.53" class="difflineplus">+function setupModule(module) {</span>
<a href="#l35.54"></a><span id="l35.54" class="difflineplus">+  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l35.55"></a><span id="l35.55" class="difflineplus">+  fdh.installInto(module);</span>
<a href="#l35.56"></a><span id="l35.56" class="difflineplus">+  let wh = collector.getModule('window-helpers');</span>
<a href="#l35.57"></a><span id="l35.57" class="difflineplus">+  wh.installInto(module);</span>
<a href="#l35.58"></a><span id="l35.58" class="difflineplus">+</span>
<a href="#l35.59"></a><span id="l35.59" class="difflineplus">+  folder = create_folder(&quot;RightClickMiddleClickA&quot;);</span>
<a href="#l35.60"></a><span id="l35.60" class="difflineplus">+  // we want exactly as many messages as we plan to delete, so that we can test</span>
<a href="#l35.61"></a><span id="l35.61" class="difflineplus">+  //  that the message window and tabs close when they run out of things to</span>
<a href="#l35.62"></a><span id="l35.62" class="difflineplus">+  //  to display.</span>
<a href="#l35.63"></a><span id="l35.63" class="difflineplus">+  make_new_sets_in_folder(folder, [{count: 20}]);</span>
<a href="#l35.64"></a><span id="l35.64" class="difflineplus">+}</span>
<a href="#l35.65"></a><span id="l35.65" class="difflineplus">+</span>
<a href="#l35.66"></a><span id="l35.66" class="difflineplus">+/**</span>
<a href="#l35.67"></a><span id="l35.67" class="difflineplus">+ * Make sure that a right-click when there is nothing currently selected does</span>
<a href="#l35.68"></a><span id="l35.68" class="difflineplus">+ *  not cause us to display something, as well as correctly causing a transient</span>
<a href="#l35.69"></a><span id="l35.69" class="difflineplus">+ *  selection to occur.</span>
<a href="#l35.70"></a><span id="l35.70" class="difflineplus">+ */</span>
<a href="#l35.71"></a><span id="l35.71" class="difflineplus">+function test_right_click_with_nothing_selected() {</span>
<a href="#l35.72"></a><span id="l35.72" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l35.73"></a><span id="l35.73" class="difflineplus">+</span>
<a href="#l35.74"></a><span id="l35.74" class="difflineplus">+  select_none();</span>
<a href="#l35.75"></a><span id="l35.75" class="difflineplus">+  assert_nothing_selected();</span>
<a href="#l35.76"></a><span id="l35.76" class="difflineplus">+</span>
<a href="#l35.77"></a><span id="l35.77" class="difflineplus">+  right_click_on_row(1);</span>
<a href="#l35.78"></a><span id="l35.78" class="difflineplus">+  assert_selected(1);</span>
<a href="#l35.79"></a><span id="l35.79" class="difflineplus">+  assert_displayed();</span>
<a href="#l35.80"></a><span id="l35.80" class="difflineplus">+</span>
<a href="#l35.81"></a><span id="l35.81" class="difflineplus">+  close_popup();</span>
<a href="#l35.82"></a><span id="l35.82" class="difflineplus">+  assert_nothing_selected();</span>
<a href="#l35.83"></a><span id="l35.83" class="difflineplus">+}</span>
<a href="#l35.84"></a><span id="l35.84" class="difflineplus">+</span>
<a href="#l35.85"></a><span id="l35.85" class="difflineplus">+/**</span>
<a href="#l35.86"></a><span id="l35.86" class="difflineplus">+ * One-thing selected, right-click on something else.</span>
<a href="#l35.87"></a><span id="l35.87" class="difflineplus">+ */</span>
<a href="#l35.88"></a><span id="l35.88" class="difflineplus">+function test_right_click_with_one_thing_selected() {</span>
<a href="#l35.89"></a><span id="l35.89" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l35.90"></a><span id="l35.90" class="difflineplus">+</span>
<a href="#l35.91"></a><span id="l35.91" class="difflineplus">+  select_click_row(0);</span>
<a href="#l35.92"></a><span id="l35.92" class="difflineplus">+  assert_selected_and_displayed(0);</span>
<a href="#l35.93"></a><span id="l35.93" class="difflineplus">+</span>
<a href="#l35.94"></a><span id="l35.94" class="difflineplus">+  right_click_on_row(1);</span>
<a href="#l35.95"></a><span id="l35.95" class="difflineplus">+  assert_selected(1);</span>
<a href="#l35.96"></a><span id="l35.96" class="difflineplus">+  assert_displayed(0);</span>
<a href="#l35.97"></a><span id="l35.97" class="difflineplus">+</span>
<a href="#l35.98"></a><span id="l35.98" class="difflineplus">+  close_popup();</span>
<a href="#l35.99"></a><span id="l35.99" class="difflineplus">+  assert_selected_and_displayed(0);</span>
<a href="#l35.100"></a><span id="l35.100" class="difflineplus">+}</span>
<a href="#l35.101"></a><span id="l35.101" class="difflineplus">+</span>
<a href="#l35.102"></a><span id="l35.102" class="difflineplus">+/**</span>
<a href="#l35.103"></a><span id="l35.103" class="difflineplus">+ * Many things selected, right-click on something that is not in that selection.</span>
<a href="#l35.104"></a><span id="l35.104" class="difflineplus">+ */</span>
<a href="#l35.105"></a><span id="l35.105" class="difflineplus">+function test_right_click_with_many_things_selected() {</span>
<a href="#l35.106"></a><span id="l35.106" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l35.107"></a><span id="l35.107" class="difflineplus">+</span>
<a href="#l35.108"></a><span id="l35.108" class="difflineplus">+  select_click_row(0);</span>
<a href="#l35.109"></a><span id="l35.109" class="difflineplus">+  select_shift_click_row(5);</span>
<a href="#l35.110"></a><span id="l35.110" class="difflineplus">+  assert_selected_and_displayed([0, 5]);</span>
<a href="#l35.111"></a><span id="l35.111" class="difflineplus">+</span>
<a href="#l35.112"></a><span id="l35.112" class="difflineplus">+  right_click_on_row(6);</span>
<a href="#l35.113"></a><span id="l35.113" class="difflineplus">+  assert_selected(6);</span>
<a href="#l35.114"></a><span id="l35.114" class="difflineplus">+  assert_displayed([0, 5]);</span>
<a href="#l35.115"></a><span id="l35.115" class="difflineplus">+</span>
<a href="#l35.116"></a><span id="l35.116" class="difflineplus">+  close_popup();</span>
<a href="#l35.117"></a><span id="l35.117" class="difflineplus">+  assert_selected_and_displayed([0, 5]);</span>
<a href="#l35.118"></a><span id="l35.118" class="difflineplus">+}</span>
<a href="#l35.119"></a><span id="l35.119" class="difflineplus">+</span>
<a href="#l35.120"></a><span id="l35.120" class="difflineplus">+/**</span>
<a href="#l35.121"></a><span id="l35.121" class="difflineplus">+ * One thing selected, right-click on that.</span>
<a href="#l35.122"></a><span id="l35.122" class="difflineplus">+ */</span>
<a href="#l35.123"></a><span id="l35.123" class="difflineplus">+function test_right_click_on_existing_single_selection() {</span>
<a href="#l35.124"></a><span id="l35.124" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l35.125"></a><span id="l35.125" class="difflineplus">+</span>
<a href="#l35.126"></a><span id="l35.126" class="difflineplus">+  select_click_row(3);</span>
<a href="#l35.127"></a><span id="l35.127" class="difflineplus">+  assert_selected_and_displayed(3);</span>
<a href="#l35.128"></a><span id="l35.128" class="difflineplus">+</span>
<a href="#l35.129"></a><span id="l35.129" class="difflineplus">+  right_click_on_row(3);</span>
<a href="#l35.130"></a><span id="l35.130" class="difflineplus">+  assert_selected_and_displayed(3);</span>
<a href="#l35.131"></a><span id="l35.131" class="difflineplus">+</span>
<a href="#l35.132"></a><span id="l35.132" class="difflineplus">+  close_popup();</span>
<a href="#l35.133"></a><span id="l35.133" class="difflineplus">+  assert_selected_and_displayed(3);</span>
<a href="#l35.134"></a><span id="l35.134" class="difflineplus">+}</span>
<a href="#l35.135"></a><span id="l35.135" class="difflineplus">+</span>
<a href="#l35.136"></a><span id="l35.136" class="difflineplus">+/**</span>
<a href="#l35.137"></a><span id="l35.137" class="difflineplus">+ * Many things selected, right-click somewhere in the selection.</span>
<a href="#l35.138"></a><span id="l35.138" class="difflineplus">+ */</span>
<a href="#l35.139"></a><span id="l35.139" class="difflineplus">+function test_right_click_on_existing_multi_selection() {</span>
<a href="#l35.140"></a><span id="l35.140" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l35.141"></a><span id="l35.141" class="difflineplus">+</span>
<a href="#l35.142"></a><span id="l35.142" class="difflineplus">+  select_click_row(3);</span>
<a href="#l35.143"></a><span id="l35.143" class="difflineplus">+  select_shift_click_row(6);</span>
<a href="#l35.144"></a><span id="l35.144" class="difflineplus">+  assert_selected_and_displayed([3, 6]);</span>
<a href="#l35.145"></a><span id="l35.145" class="difflineplus">+</span>
<a href="#l35.146"></a><span id="l35.146" class="difflineplus">+  right_click_on_row(5);</span>
<a href="#l35.147"></a><span id="l35.147" class="difflineplus">+  assert_selected_and_displayed([3, 6]);</span>
<a href="#l35.148"></a><span id="l35.148" class="difflineplus">+</span>
<a href="#l35.149"></a><span id="l35.149" class="difflineplus">+  close_popup();</span>
<a href="#l35.150"></a><span id="l35.150" class="difflineplus">+  assert_selected_and_displayed([3, 6]);</span>
<a href="#l35.151"></a><span id="l35.151" class="difflineplus">+}</span>
<a href="#l35.152"></a><span id="l35.152" class="difflineplus">+</span>
<a href="#l35.153"></a><span id="l35.153" class="difflineplus">+/**</span>
<a href="#l35.154"></a><span id="l35.154" class="difflineplus">+ * Middle clicking should open a message in a tab, but not affect our selection.</span>
<a href="#l35.155"></a><span id="l35.155" class="difflineplus">+ */</span>
<a href="#l35.156"></a><span id="l35.156" class="difflineplus">+function test_middle_click_with_nothing_selected() {</span>
<a href="#l35.157"></a><span id="l35.157" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l35.158"></a><span id="l35.158" class="difflineplus">+</span>
<a href="#l35.159"></a><span id="l35.159" class="difflineplus">+  select_none();</span>
<a href="#l35.160"></a><span id="l35.160" class="difflineplus">+  assert_nothing_selected();</span>
<a href="#l35.161"></a><span id="l35.161" class="difflineplus">+</span>
<a href="#l35.162"></a><span id="l35.162" class="difflineplus">+  let [tabMessage, curMessage] = middle_click_on_row(1);</span>
<a href="#l35.163"></a><span id="l35.163" class="difflineplus">+  // as of immediately right now, the tab opens in the foreground, but soon</span>
<a href="#l35.164"></a><span id="l35.164" class="difflineplus">+  //  it will open in the background, so prepare the test for that...</span>
<a href="#l35.165"></a><span id="l35.165" class="difflineplus">+  switch_tab(tabMessage);</span>
<a href="#l35.166"></a><span id="l35.166" class="difflineplus">+  assert_selected_and_displayed(curMessage);</span>
<a href="#l35.167"></a><span id="l35.167" class="difflineplus">+  close_tab(tabMessage);</span>
<a href="#l35.168"></a><span id="l35.168" class="difflineplus">+</span>
<a href="#l35.169"></a><span id="l35.169" class="difflineplus">+  assert_nothing_selected();</span>
<a href="#l35.170"></a><span id="l35.170" class="difflineplus">+}</span>
<a href="#l35.171"></a><span id="l35.171" class="difflineplus">+</span>
<a href="#l35.172"></a><span id="l35.172" class="difflineplus">+/**</span>
<a href="#l35.173"></a><span id="l35.173" class="difflineplus">+ * One-thing selected, middle-click on something else.</span>
<a href="#l35.174"></a><span id="l35.174" class="difflineplus">+ */</span>
<a href="#l35.175"></a><span id="l35.175" class="difflineplus">+function test_middle_click_with_one_thing_selected() {</span>
<a href="#l35.176"></a><span id="l35.176" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l35.177"></a><span id="l35.177" class="difflineplus">+</span>
<a href="#l35.178"></a><span id="l35.178" class="difflineplus">+  select_click_row(0);</span>
<a href="#l35.179"></a><span id="l35.179" class="difflineplus">+  assert_selected_and_displayed(0);</span>
<a href="#l35.180"></a><span id="l35.180" class="difflineplus">+</span>
<a href="#l35.181"></a><span id="l35.181" class="difflineplus">+  let [tabMessage, curMessage] = middle_click_on_row(1);</span>
<a href="#l35.182"></a><span id="l35.182" class="difflineplus">+  switch_tab(tabMessage);</span>
<a href="#l35.183"></a><span id="l35.183" class="difflineplus">+  assert_selected_and_displayed(curMessage);</span>
<a href="#l35.184"></a><span id="l35.184" class="difflineplus">+  close_tab(tabMessage);</span>
<a href="#l35.185"></a><span id="l35.185" class="difflineplus">+</span>
<a href="#l35.186"></a><span id="l35.186" class="difflineplus">+  assert_selected_and_displayed(0);</span>
<a href="#l35.187"></a><span id="l35.187" class="difflineplus">+}</span>
<a href="#l35.188"></a><span id="l35.188" class="difflineplus">+</span>
<a href="#l35.189"></a><span id="l35.189" class="difflineplus">+/**</span>
<a href="#l35.190"></a><span id="l35.190" class="difflineplus">+ * Many things selected, middle-click on something that is not in that</span>
<a href="#l35.191"></a><span id="l35.191" class="difflineplus">+ *  selection.</span>
<a href="#l35.192"></a><span id="l35.192" class="difflineplus">+ */</span>
<a href="#l35.193"></a><span id="l35.193" class="difflineplus">+function test_middle_click_with_many_things_selected() {</span>
<a href="#l35.194"></a><span id="l35.194" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l35.195"></a><span id="l35.195" class="difflineplus">+</span>
<a href="#l35.196"></a><span id="l35.196" class="difflineplus">+  select_click_row(0);</span>
<a href="#l35.197"></a><span id="l35.197" class="difflineplus">+  select_shift_click_row(5);</span>
<a href="#l35.198"></a><span id="l35.198" class="difflineplus">+  assert_selected_and_displayed([0, 5]);</span>
<a href="#l35.199"></a><span id="l35.199" class="difflineplus">+</span>
<a href="#l35.200"></a><span id="l35.200" class="difflineplus">+  let [tabMessage, curMessage] = middle_click_on_row(1);</span>
<a href="#l35.201"></a><span id="l35.201" class="difflineplus">+  switch_tab(tabMessage);</span>
<a href="#l35.202"></a><span id="l35.202" class="difflineplus">+  assert_selected_and_displayed(curMessage);</span>
<a href="#l35.203"></a><span id="l35.203" class="difflineplus">+  close_tab(tabMessage);</span>
<a href="#l35.204"></a><span id="l35.204" class="difflineplus">+</span>
<a href="#l35.205"></a><span id="l35.205" class="difflineplus">+  assert_selected_and_displayed([0, 5]);</span>
<a href="#l35.206"></a><span id="l35.206" class="difflineplus">+}</span>
<a href="#l35.207"></a><span id="l35.207" class="difflineplus">+</span>
<a href="#l35.208"></a><span id="l35.208" class="difflineplus">+/**</span>
<a href="#l35.209"></a><span id="l35.209" class="difflineplus">+ * One thing selected, middle-click on that.</span>
<a href="#l35.210"></a><span id="l35.210" class="difflineplus">+ */</span>
<a href="#l35.211"></a><span id="l35.211" class="difflineplus">+function test_middle_click_on_existing_single_selection() {</span>
<a href="#l35.212"></a><span id="l35.212" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l35.213"></a><span id="l35.213" class="difflineplus">+</span>
<a href="#l35.214"></a><span id="l35.214" class="difflineplus">+  select_click_row(3);</span>
<a href="#l35.215"></a><span id="l35.215" class="difflineplus">+  assert_selected_and_displayed(3);</span>
<a href="#l35.216"></a><span id="l35.216" class="difflineplus">+</span>
<a href="#l35.217"></a><span id="l35.217" class="difflineplus">+  let [tabMessage, curMessage] = middle_click_on_row(3);</span>
<a href="#l35.218"></a><span id="l35.218" class="difflineplus">+  switch_tab(tabMessage);</span>
<a href="#l35.219"></a><span id="l35.219" class="difflineplus">+  assert_selected_and_displayed(curMessage);</span>
<a href="#l35.220"></a><span id="l35.220" class="difflineplus">+  close_tab(tabMessage);</span>
<a href="#l35.221"></a><span id="l35.221" class="difflineplus">+</span>
<a href="#l35.222"></a><span id="l35.222" class="difflineplus">+  assert_selected_and_displayed(3);</span>
<a href="#l35.223"></a><span id="l35.223" class="difflineplus">+}</span>
<a href="#l35.224"></a><span id="l35.224" class="difflineplus">+</span>
<a href="#l35.225"></a><span id="l35.225" class="difflineplus">+/**</span>
<a href="#l35.226"></a><span id="l35.226" class="difflineplus">+ * Many things selected, right-click somewhere in the selection.</span>
<a href="#l35.227"></a><span id="l35.227" class="difflineplus">+ */</span>
<a href="#l35.228"></a><span id="l35.228" class="difflineplus">+function test_middle_click_on_existing_multi_selection() {</span>
<a href="#l35.229"></a><span id="l35.229" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l35.230"></a><span id="l35.230" class="difflineplus">+</span>
<a href="#l35.231"></a><span id="l35.231" class="difflineplus">+  select_click_row(3);</span>
<a href="#l35.232"></a><span id="l35.232" class="difflineplus">+  select_shift_click_row(6);</span>
<a href="#l35.233"></a><span id="l35.233" class="difflineplus">+  assert_selected_and_displayed([3, 6]);</span>
<a href="#l35.234"></a><span id="l35.234" class="difflineplus">+</span>
<a href="#l35.235"></a><span id="l35.235" class="difflineplus">+  let [tabMessage, curMessage] = middle_click_on_row(5);</span>
<a href="#l35.236"></a><span id="l35.236" class="difflineplus">+  switch_tab(tabMessage);</span>
<a href="#l35.237"></a><span id="l35.237" class="difflineplus">+  assert_selected_and_displayed(curMessage);</span>
<a href="#l35.238"></a><span id="l35.238" class="difflineplus">+  close_tab(tabMessage);</span>
<a href="#l35.239"></a><span id="l35.239" class="difflineplus">+</span>
<a href="#l35.240"></a><span id="l35.240" class="difflineplus">+  assert_selected_and_displayed([3, 6]);</span>
<a href="#l35.241"></a><span id="l35.241" class="difflineplus">+}</span>
<a href="#l35.242"></a><span id="l35.242" class="difflineplus">+</span>
<a href="#l35.243"></a><span id="l35.243" class="difflineplus">+/**</span>
<a href="#l35.244"></a><span id="l35.244" class="difflineplus">+ * Right-click on something and delete it, having no selection previously.</span>
<a href="#l35.245"></a><span id="l35.245" class="difflineplus">+ */</span>
<a href="#l35.246"></a><span id="l35.246" class="difflineplus">+function test_right_click_deletion_nothing_selected() {</span>
<a href="#l35.247"></a><span id="l35.247" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l35.248"></a><span id="l35.248" class="difflineplus">+</span>
<a href="#l35.249"></a><span id="l35.249" class="difflineplus">+  select_none();</span>
<a href="#l35.250"></a><span id="l35.250" class="difflineplus">+  assert_selected_and_displayed();</span>
<a href="#l35.251"></a><span id="l35.251" class="difflineplus">+</span>
<a href="#l35.252"></a><span id="l35.252" class="difflineplus">+  let delMessage = right_click_on_row(3);</span>
<a href="#l35.253"></a><span id="l35.253" class="difflineplus">+  delete_via_popup();</span>
<a href="#l35.254"></a><span id="l35.254" class="difflineplus">+  // eh, might as well make sure the deletion worked while we are here</span>
<a href="#l35.255"></a><span id="l35.255" class="difflineplus">+  assert_message_not_in_view(delMessage);</span>
<a href="#l35.256"></a><span id="l35.256" class="difflineplus">+</span>
<a href="#l35.257"></a><span id="l35.257" class="difflineplus">+  assert_selected_and_displayed();</span>
<a href="#l35.258"></a><span id="l35.258" class="difflineplus">+}</span>
<a href="#l35.259"></a><span id="l35.259" class="difflineplus">+</span>
<a href="#l35.260"></a><span id="l35.260" class="difflineplus">+/**</span>
<a href="#l35.261"></a><span id="l35.261" class="difflineplus">+ * We want to make sure that the selection post-delete still includes the same</span>
<a href="#l35.262"></a><span id="l35.262" class="difflineplus">+ *  message (and that it is displayed).  In order for this to be interesting,</span>
<a href="#l35.263"></a><span id="l35.263" class="difflineplus">+ *  we want to make sure that we right-click delete a message above the selected</span>
<a href="#l35.264"></a><span id="l35.264" class="difflineplus">+ *  message so there is a shift in row numbering.</span>
<a href="#l35.265"></a><span id="l35.265" class="difflineplus">+ */</span>
<a href="#l35.266"></a><span id="l35.266" class="difflineplus">+function test_right_click_deletion_one_other_thing_selected() {</span>
<a href="#l35.267"></a><span id="l35.267" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l35.268"></a><span id="l35.268" class="difflineplus">+</span>
<a href="#l35.269"></a><span id="l35.269" class="difflineplus">+  let curMessage = select_click_row(5);</span>
<a href="#l35.270"></a><span id="l35.270" class="difflineplus">+</span>
<a href="#l35.271"></a><span id="l35.271" class="difflineplus">+  let delMessage = right_click_on_row(3);</span>
<a href="#l35.272"></a><span id="l35.272" class="difflineplus">+  delete_via_popup();</span>
<a href="#l35.273"></a><span id="l35.273" class="difflineplus">+  assert_message_not_in_view(delMessage);</span>
<a href="#l35.274"></a><span id="l35.274" class="difflineplus">+</span>
<a href="#l35.275"></a><span id="l35.275" class="difflineplus">+  assert_selected_and_displayed(curMessage);</span>
<a href="#l35.276"></a><span id="l35.276" class="difflineplus">+}</span>
<a href="#l35.277"></a><span id="l35.277" class="difflineplus">+</span>
<a href="#l35.278"></a><span id="l35.278" class="difflineplus">+function test_right_click_deletion_many_other_things_selected() {</span>
<a href="#l35.279"></a><span id="l35.279" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l35.280"></a><span id="l35.280" class="difflineplus">+</span>
<a href="#l35.281"></a><span id="l35.281" class="difflineplus">+  select_click_row(4);</span>
<a href="#l35.282"></a><span id="l35.282" class="difflineplus">+  let messages = select_shift_click_row(6);</span>
<a href="#l35.283"></a><span id="l35.283" class="difflineplus">+</span>
<a href="#l35.284"></a><span id="l35.284" class="difflineplus">+  let delMessage = right_click_on_row(2);</span>
<a href="#l35.285"></a><span id="l35.285" class="difflineplus">+  delete_via_popup();</span>
<a href="#l35.286"></a><span id="l35.286" class="difflineplus">+  assert_message_not_in_view(delMessage);</span>
<a href="#l35.287"></a><span id="l35.287" class="difflineplus">+</span>
<a href="#l35.288"></a><span id="l35.288" class="difflineplus">+  assert_selected_and_displayed(messages);</span>
<a href="#l35.289"></a><span id="l35.289" class="difflineplus">+}</span>
<a href="#l35.290"></a><span id="l35.290" class="difflineplus">+</span>
<a href="#l35.291"></a><span id="l35.291" class="difflineplus">+function test_right_click_deletion_of_one_selected_thing() {</span>
<a href="#l35.292"></a><span id="l35.292" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l35.293"></a><span id="l35.293" class="difflineplus">+</span>
<a href="#l35.294"></a><span id="l35.294" class="difflineplus">+  let curMessage = select_click_row(2);</span>
<a href="#l35.295"></a><span id="l35.295" class="difflineplus">+</span>
<a href="#l35.296"></a><span id="l35.296" class="difflineplus">+  right_click_on_row(2);</span>
<a href="#l35.297"></a><span id="l35.297" class="difflineplus">+  delete_via_popup();</span>
<a href="#l35.298"></a><span id="l35.298" class="difflineplus">+  assert_message_not_in_view(curMessage);</span>
<a href="#l35.299"></a><span id="l35.299" class="difflineplus">+</span>
<a href="#l35.300"></a><span id="l35.300" class="difflineplus">+  if (!mc.folderDisplay.selectedCount)</span>
<a href="#l35.301"></a><span id="l35.301" class="difflineplus">+    throw new Error(&quot;We should have tried to select something!&quot;);</span>
<a href="#l35.302"></a><span id="l35.302" class="difflineplus">+}</span>
<a href="#l35.303"></a><span id="l35.303" class="difflineplus">+</span>
<a href="#l35.304"></a><span id="l35.304" class="difflineplus">+function test_right_click_deletion_of_many_selected_things() {</span>
<a href="#l35.305"></a><span id="l35.305" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l35.306"></a><span id="l35.306" class="difflineplus">+</span>
<a href="#l35.307"></a><span id="l35.307" class="difflineplus">+  select_click_row(2);</span>
<a href="#l35.308"></a><span id="l35.308" class="difflineplus">+  let messages = select_shift_click_row(4);</span>
<a href="#l35.309"></a><span id="l35.309" class="difflineplus">+</span>
<a href="#l35.310"></a><span id="l35.310" class="difflineplus">+  right_click_on_row(3);</span>
<a href="#l35.311"></a><span id="l35.311" class="difflineplus">+  delete_via_popup();</span>
<a href="#l35.312"></a><span id="l35.312" class="difflineplus">+  assert_messages_not_in_view(messages);</span>
<a href="#l35.313"></a><span id="l35.313" class="difflineplus">+</span>
<a href="#l35.314"></a><span id="l35.314" class="difflineplus">+  if (!mc.folderDisplay.selectedCount)</span>
<a href="#l35.315"></a><span id="l35.315" class="difflineplus">+    throw new Error(&quot;We should have tried to select something!&quot;);</span>
<a href="#l35.316"></a><span id="l35.316" class="difflineplus">+}</span>
<a href="#l35.317"></a><span id="l35.317" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1">new file mode 100644</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineminus">--- /dev/null</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-selection.js</span>
<a href="#l36.4"></a><span id="l36.4" class="difflineat">@@ -0,0 +1,157 @@</span>
<a href="#l36.5"></a><span id="l36.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l36.6"></a><span id="l36.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l36.7"></a><span id="l36.7" class="difflineplus">+ *</span>
<a href="#l36.8"></a><span id="l36.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l36.9"></a><span id="l36.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l36.10"></a><span id="l36.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l36.11"></a><span id="l36.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineplus">+ *</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l36.14"></a><span id="l36.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l36.15"></a><span id="l36.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l36.16"></a><span id="l36.16" class="difflineplus">+ * License.</span>
<a href="#l36.17"></a><span id="l36.17" class="difflineplus">+ *</span>
<a href="#l36.18"></a><span id="l36.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l36.19"></a><span id="l36.19" class="difflineplus">+ *</span>
<a href="#l36.20"></a><span id="l36.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l36.21"></a><span id="l36.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l36.22"></a><span id="l36.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l36.23"></a><span id="l36.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l36.24"></a><span id="l36.24" class="difflineplus">+ *</span>
<a href="#l36.25"></a><span id="l36.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l36.26"></a><span id="l36.26" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l36.27"></a><span id="l36.27" class="difflineplus">+ *</span>
<a href="#l36.28"></a><span id="l36.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l36.29"></a><span id="l36.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l36.30"></a><span id="l36.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l36.31"></a><span id="l36.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l36.32"></a><span id="l36.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l36.33"></a><span id="l36.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l36.34"></a><span id="l36.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l36.35"></a><span id="l36.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l36.36"></a><span id="l36.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l36.37"></a><span id="l36.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l36.38"></a><span id="l36.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l36.39"></a><span id="l36.39" class="difflineplus">+ *</span>
<a href="#l36.40"></a><span id="l36.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l36.41"></a><span id="l36.41" class="difflineplus">+</span>
<a href="#l36.42"></a><span id="l36.42" class="difflineplus">+var MODULE_NAME = 'test-selection';</span>
<a href="#l36.43"></a><span id="l36.43" class="difflineplus">+</span>
<a href="#l36.44"></a><span id="l36.44" class="difflineplus">+var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l36.45"></a><span id="l36.45" class="difflineplus">+var MODULE_REQUIRES = ['folder-display-helpers'];</span>
<a href="#l36.46"></a><span id="l36.46" class="difflineplus">+</span>
<a href="#l36.47"></a><span id="l36.47" class="difflineplus">+// let us have 2 folders</span>
<a href="#l36.48"></a><span id="l36.48" class="difflineplus">+var folder = null, folder2 = null;</span>
<a href="#l36.49"></a><span id="l36.49" class="difflineplus">+</span>
<a href="#l36.50"></a><span id="l36.50" class="difflineplus">+var setupModule = function(module) {</span>
<a href="#l36.51"></a><span id="l36.51" class="difflineplus">+  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l36.52"></a><span id="l36.52" class="difflineplus">+  fdh.installInto(module);</span>
<a href="#l36.53"></a><span id="l36.53" class="difflineplus">+</span>
<a href="#l36.54"></a><span id="l36.54" class="difflineplus">+  folder = create_folder(&quot;SelectionA&quot;);</span>
<a href="#l36.55"></a><span id="l36.55" class="difflineplus">+  folder2 = create_folder(&quot;SelectionB&quot;);</span>
<a href="#l36.56"></a><span id="l36.56" class="difflineplus">+  make_new_sets_in_folders([folder, folder2], [{count: 50}]);</span>
<a href="#l36.57"></a><span id="l36.57" class="difflineplus">+};</span>
<a href="#l36.58"></a><span id="l36.58" class="difflineplus">+</span>
<a href="#l36.59"></a><span id="l36.59" class="difflineplus">+// https://bugzilla.mozilla.org/show_bug.cgi?id=474701#c80</span>
<a href="#l36.60"></a><span id="l36.60" class="difflineplus">+function test_selection_on_entry() {</span>
<a href="#l36.61"></a><span id="l36.61" class="difflineplus">+  enter_folder(folder);</span>
<a href="#l36.62"></a><span id="l36.62" class="difflineplus">+  assert_nothing_selected();</span>
<a href="#l36.63"></a><span id="l36.63" class="difflineplus">+}</span>
<a href="#l36.64"></a><span id="l36.64" class="difflineplus">+</span>
<a href="#l36.65"></a><span id="l36.65" class="difflineplus">+function test_selection_extension() {</span>
<a href="#l36.66"></a><span id="l36.66" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l36.67"></a><span id="l36.67" class="difflineplus">+</span>
<a href="#l36.68"></a><span id="l36.68" class="difflineplus">+  // https://bugzilla.mozilla.org/show_bug.cgi?id=474701#c79 (was good)</span>
<a href="#l36.69"></a><span id="l36.69" class="difflineplus">+  select_click_row(1);</span>
<a href="#l36.70"></a><span id="l36.70" class="difflineplus">+  select_control_click_row(2);</span>
<a href="#l36.71"></a><span id="l36.71" class="difflineplus">+  press_delete();</span>
<a href="#l36.72"></a><span id="l36.72" class="difflineplus">+  assert_selected_and_displayed(1);</span>
<a href="#l36.73"></a><span id="l36.73" class="difflineplus">+  // https://bugzilla.mozilla.org/show_bug.cgi?id=474701#c79 (was bad)</span>
<a href="#l36.74"></a><span id="l36.74" class="difflineplus">+  select_click_row(2);</span>
<a href="#l36.75"></a><span id="l36.75" class="difflineplus">+  select_control_click_row(1);</span>
<a href="#l36.76"></a><span id="l36.76" class="difflineplus">+  press_delete();</span>
<a href="#l36.77"></a><span id="l36.77" class="difflineplus">+  assert_selected_and_displayed(1);</span>
<a href="#l36.78"></a><span id="l36.78" class="difflineplus">+</span>
<a href="#l36.79"></a><span id="l36.79" class="difflineplus">+  // https://bugzilla.mozilla.org/show_bug.cgi?id=474701#c87 first bit</span>
<a href="#l36.80"></a><span id="l36.80" class="difflineplus">+  press_delete();</span>
<a href="#l36.81"></a><span id="l36.81" class="difflineplus">+  assert_selected_and_displayed(1);</span>
<a href="#l36.82"></a><span id="l36.82" class="difflineplus">+}</span>
<a href="#l36.83"></a><span id="l36.83" class="difflineplus">+</span>
<a href="#l36.84"></a><span id="l36.84" class="difflineplus">+// https://bugzilla.mozilla.org/show_bug.cgi?id=474701#c87 last bit</span>
<a href="#l36.85"></a><span id="l36.85" class="difflineplus">+function test_selection_last_message_deleted() {</span>
<a href="#l36.86"></a><span id="l36.86" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l36.87"></a><span id="l36.87" class="difflineplus">+  select_click_row(-1);</span>
<a href="#l36.88"></a><span id="l36.88" class="difflineplus">+  press_delete();</span>
<a href="#l36.89"></a><span id="l36.89" class="difflineplus">+  assert_selected_and_displayed(-1);</span>
<a href="#l36.90"></a><span id="l36.90" class="difflineplus">+}</span>
<a href="#l36.91"></a><span id="l36.91" class="difflineplus">+</span>
<a href="#l36.92"></a><span id="l36.92" class="difflineplus">+</span>
<a href="#l36.93"></a><span id="l36.93" class="difflineplus">+function test_selection_persists_through_threading_changes() {</span>
<a href="#l36.94"></a><span id="l36.94" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l36.95"></a><span id="l36.95" class="difflineplus">+</span>
<a href="#l36.96"></a><span id="l36.96" class="difflineplus">+  make_display_unthreaded();</span>
<a href="#l36.97"></a><span id="l36.97" class="difflineplus">+  let message = select_click_row(3);</span>
<a href="#l36.98"></a><span id="l36.98" class="difflineplus">+  make_display_threaded();</span>
<a href="#l36.99"></a><span id="l36.99" class="difflineplus">+  assert_selected_and_displayed(message);</span>
<a href="#l36.100"></a><span id="l36.100" class="difflineplus">+  make_display_grouped();</span>
<a href="#l36.101"></a><span id="l36.101" class="difflineplus">+  assert_selected_and_displayed(message);</span>
<a href="#l36.102"></a><span id="l36.102" class="difflineplus">+}</span>
<a href="#l36.103"></a><span id="l36.103" class="difflineplus">+</span>
<a href="#l36.104"></a><span id="l36.104" class="difflineplus">+// https://bugzilla.mozilla.org/show_bug.cgi?id=474701#c82 2nd half</span>
<a href="#l36.105"></a><span id="l36.105" class="difflineplus">+function test_no_selection_persists_through_threading_changes() {</span>
<a href="#l36.106"></a><span id="l36.106" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l36.107"></a><span id="l36.107" class="difflineplus">+</span>
<a href="#l36.108"></a><span id="l36.108" class="difflineplus">+  make_display_unthreaded();</span>
<a href="#l36.109"></a><span id="l36.109" class="difflineplus">+  select_none();</span>
<a href="#l36.110"></a><span id="l36.110" class="difflineplus">+  make_display_threaded();</span>
<a href="#l36.111"></a><span id="l36.111" class="difflineplus">+  assert_nothing_selected();</span>
<a href="#l36.112"></a><span id="l36.112" class="difflineplus">+  make_display_grouped();</span>
<a href="#l36.113"></a><span id="l36.113" class="difflineplus">+  assert_nothing_selected();</span>
<a href="#l36.114"></a><span id="l36.114" class="difflineplus">+  make_display_unthreaded();</span>
<a href="#l36.115"></a><span id="l36.115" class="difflineplus">+}</span>
<a href="#l36.116"></a><span id="l36.116" class="difflineplus">+</span>
<a href="#l36.117"></a><span id="l36.117" class="difflineplus">+function test_selection_persists_through_folder_tab_changes() {</span>
<a href="#l36.118"></a><span id="l36.118" class="difflineplus">+  let tab1 = be_in_folder(folder);</span>
<a href="#l36.119"></a><span id="l36.119" class="difflineplus">+</span>
<a href="#l36.120"></a><span id="l36.120" class="difflineplus">+  select_click_row(2);</span>
<a href="#l36.121"></a><span id="l36.121" class="difflineplus">+</span>
<a href="#l36.122"></a><span id="l36.122" class="difflineplus">+  let tab2 = open_folder_in_new_tab(folder2);</span>
<a href="#l36.123"></a><span id="l36.123" class="difflineplus">+  assert_nothing_selected();</span>
<a href="#l36.124"></a><span id="l36.124" class="difflineplus">+</span>
<a href="#l36.125"></a><span id="l36.125" class="difflineplus">+  switch_tab(tab1);</span>
<a href="#l36.126"></a><span id="l36.126" class="difflineplus">+  assert_selected_and_displayed(2);</span>
<a href="#l36.127"></a><span id="l36.127" class="difflineplus">+</span>
<a href="#l36.128"></a><span id="l36.128" class="difflineplus">+  switch_tab(tab2);</span>
<a href="#l36.129"></a><span id="l36.129" class="difflineplus">+  assert_nothing_selected();</span>
<a href="#l36.130"></a><span id="l36.130" class="difflineplus">+  select_click_row(3);</span>
<a href="#l36.131"></a><span id="l36.131" class="difflineplus">+</span>
<a href="#l36.132"></a><span id="l36.132" class="difflineplus">+  switch_tab(tab1);</span>
<a href="#l36.133"></a><span id="l36.133" class="difflineplus">+  assert_selected_and_displayed(2);</span>
<a href="#l36.134"></a><span id="l36.134" class="difflineplus">+  select_shift_click_row(4); // 2-4 selected</span>
<a href="#l36.135"></a><span id="l36.135" class="difflineplus">+  assert_selected_and_displayed([2,4]); // ensures multi-message summary</span>
<a href="#l36.136"></a><span id="l36.136" class="difflineplus">+</span>
<a href="#l36.137"></a><span id="l36.137" class="difflineplus">+  switch_tab(tab2);</span>
<a href="#l36.138"></a><span id="l36.138" class="difflineplus">+  assert_selected_and_displayed(3);</span>
<a href="#l36.139"></a><span id="l36.139" class="difflineplus">+</span>
<a href="#l36.140"></a><span id="l36.140" class="difflineplus">+  close_tab(tab2);</span>
<a href="#l36.141"></a><span id="l36.141" class="difflineplus">+  assert_selected_and_displayed([2,4]);</span>
<a href="#l36.142"></a><span id="l36.142" class="difflineplus">+}</span>
<a href="#l36.143"></a><span id="l36.143" class="difflineplus">+</span>
<a href="#l36.144"></a><span id="l36.144" class="difflineplus">+// https://bugzilla.mozilla.org/show_bug.cgi?id=474701#c87</span>
<a href="#l36.145"></a><span id="l36.145" class="difflineplus">+/**</span>
<a href="#l36.146"></a><span id="l36.146" class="difflineplus">+ * Verify that we scroll to new messages when we enter a folder.</span>
<a href="#l36.147"></a><span id="l36.147" class="difflineplus">+ */</span>
<a href="#l36.148"></a><span id="l36.148" class="difflineplus">+function test_enter_scroll_to_new() {</span>
<a href="#l36.149"></a><span id="l36.149" class="difflineplus">+  // be in the folder</span>
<a href="#l36.150"></a><span id="l36.150" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l36.151"></a><span id="l36.151" class="difflineplus">+  // make sure the sort is ascending...</span>
<a href="#l36.152"></a><span id="l36.152" class="difflineplus">+  mc.folderDisplay.view.sortAscending();</span>
<a href="#l36.153"></a><span id="l36.153" class="difflineplus">+  // leave the folder so that the messages get marked as read</span>
<a href="#l36.154"></a><span id="l36.154" class="difflineplus">+  enter_folder(folder.rootFolder);</span>
<a href="#l36.155"></a><span id="l36.155" class="difflineplus">+  // add a new message, and make sure it is new</span>
<a href="#l36.156"></a><span id="l36.156" class="difflineplus">+  let newSet = make_new_sets_in_folder(folder, [{count: 1}]);</span>
<a href="#l36.157"></a><span id="l36.157" class="difflineplus">+  // enter the folder</span>
<a href="#l36.158"></a><span id="l36.158" class="difflineplus">+  enter_folder(folder);</span>
<a href="#l36.159"></a><span id="l36.159" class="difflineplus">+  // make sure it (which must be the last row) is visible</span>
<a href="#l36.160"></a><span id="l36.160" class="difflineplus">+  assert_visible(-1);</span>
<a href="#l36.161"></a><span id="l36.161" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1">new file mode 100644</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineminus">--- /dev/null</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-summarization.js</span>
<a href="#l37.4"></a><span id="l37.4" class="difflineat">@@ -0,0 +1,192 @@</span>
<a href="#l37.5"></a><span id="l37.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l37.6"></a><span id="l37.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l37.7"></a><span id="l37.7" class="difflineplus">+ *</span>
<a href="#l37.8"></a><span id="l37.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l37.9"></a><span id="l37.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l37.10"></a><span id="l37.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l37.11"></a><span id="l37.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineplus">+ *</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l37.14"></a><span id="l37.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l37.15"></a><span id="l37.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l37.16"></a><span id="l37.16" class="difflineplus">+ * License.</span>
<a href="#l37.17"></a><span id="l37.17" class="difflineplus">+ *</span>
<a href="#l37.18"></a><span id="l37.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l37.19"></a><span id="l37.19" class="difflineplus">+ *</span>
<a href="#l37.20"></a><span id="l37.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l37.21"></a><span id="l37.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l37.22"></a><span id="l37.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l37.23"></a><span id="l37.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l37.24"></a><span id="l37.24" class="difflineplus">+ *</span>
<a href="#l37.25"></a><span id="l37.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l37.26"></a><span id="l37.26" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l37.27"></a><span id="l37.27" class="difflineplus">+ *</span>
<a href="#l37.28"></a><span id="l37.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l37.29"></a><span id="l37.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l37.30"></a><span id="l37.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l37.31"></a><span id="l37.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l37.32"></a><span id="l37.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l37.33"></a><span id="l37.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l37.34"></a><span id="l37.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l37.35"></a><span id="l37.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l37.36"></a><span id="l37.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l37.37"></a><span id="l37.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l37.38"></a><span id="l37.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l37.39"></a><span id="l37.39" class="difflineplus">+ *</span>
<a href="#l37.40"></a><span id="l37.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l37.41"></a><span id="l37.41" class="difflineplus">+</span>
<a href="#l37.42"></a><span id="l37.42" class="difflineplus">+/**</span>
<a href="#l37.43"></a><span id="l37.43" class="difflineplus">+ * Test that summarization happens at the right time, that it clears itself at</span>
<a href="#l37.44"></a><span id="l37.44" class="difflineplus">+ *  the right time, that it waits for selection stability when recently</span>
<a href="#l37.45"></a><span id="l37.45" class="difflineplus">+ *  summarized, and that summarization does not break under tabbing.</span>
<a href="#l37.46"></a><span id="l37.46" class="difflineplus">+ *</span>
<a href="#l37.47"></a><span id="l37.47" class="difflineplus">+ * Because most of the legwork is done automatically by</span>
<a href="#l37.48"></a><span id="l37.48" class="difflineplus">+ *  test-folder-display-helpers, the more basic tests may look like general</span>
<a href="#l37.49"></a><span id="l37.49" class="difflineplus">+ *  selection / tabbing tests, but are intended to specifically exercise the</span>
<a href="#l37.50"></a><span id="l37.50" class="difflineplus">+ *  summarization logic and edge cases.  (Although general selection tests and</span>
<a href="#l37.51"></a><span id="l37.51" class="difflineplus">+ *  tab tests may do the same thing too...)</span>
<a href="#l37.52"></a><span id="l37.52" class="difflineplus">+ *</span>
<a href="#l37.53"></a><span id="l37.53" class="difflineplus">+ * Things we don't test but should:</span>
<a href="#l37.54"></a><span id="l37.54" class="difflineplus">+ * - The difference between thread summary and multi-message summary.</span>
<a href="#l37.55"></a><span id="l37.55" class="difflineplus">+ */</span>
<a href="#l37.56"></a><span id="l37.56" class="difflineplus">+</span>
<a href="#l37.57"></a><span id="l37.57" class="difflineplus">+var MODULE_NAME = 'test-summarization';</span>
<a href="#l37.58"></a><span id="l37.58" class="difflineplus">+</span>
<a href="#l37.59"></a><span id="l37.59" class="difflineplus">+var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l37.60"></a><span id="l37.60" class="difflineplus">+var MODULE_REQUIRES = ['folder-display-helpers'];</span>
<a href="#l37.61"></a><span id="l37.61" class="difflineplus">+</span>
<a href="#l37.62"></a><span id="l37.62" class="difflineplus">+var folder;</span>
<a href="#l37.63"></a><span id="l37.63" class="difflineplus">+</span>
<a href="#l37.64"></a><span id="l37.64" class="difflineplus">+var setupModule = function(module) {</span>
<a href="#l37.65"></a><span id="l37.65" class="difflineplus">+  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l37.66"></a><span id="l37.66" class="difflineplus">+  fdh.installInto(module);</span>
<a href="#l37.67"></a><span id="l37.67" class="difflineplus">+</span>
<a href="#l37.68"></a><span id="l37.68" class="difflineplus">+  folder = create_folder(&quot;SummarizationA&quot;);</span>
<a href="#l37.69"></a><span id="l37.69" class="difflineplus">+  make_new_sets_in_folder(folder, [{count: 10}]);</span>
<a href="#l37.70"></a><span id="l37.70" class="difflineplus">+};</span>
<a href="#l37.71"></a><span id="l37.71" class="difflineplus">+</span>
<a href="#l37.72"></a><span id="l37.72" class="difflineplus">+function test_basic_summarization() {</span>
<a href="#l37.73"></a><span id="l37.73" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l37.74"></a><span id="l37.74" class="difflineplus">+</span>
<a href="#l37.75"></a><span id="l37.75" class="difflineplus">+  // - make sure we get a summary</span>
<a href="#l37.76"></a><span id="l37.76" class="difflineplus">+  select_click_row(0);</span>
<a href="#l37.77"></a><span id="l37.77" class="difflineplus">+  select_shift_click_row(5);</span>
<a href="#l37.78"></a><span id="l37.78" class="difflineplus">+  // this will verify a multi-message display is happening</span>
<a href="#l37.79"></a><span id="l37.79" class="difflineplus">+  assert_selected_and_displayed([0, 5]);</span>
<a href="#l37.80"></a><span id="l37.80" class="difflineplus">+}</span>
<a href="#l37.81"></a><span id="l37.81" class="difflineplus">+</span>
<a href="#l37.82"></a><span id="l37.82" class="difflineplus">+function test_summarization_goes_away() {</span>
<a href="#l37.83"></a><span id="l37.83" class="difflineplus">+  select_none();</span>
<a href="#l37.84"></a><span id="l37.84" class="difflineplus">+  assert_nothing_selected();</span>
<a href="#l37.85"></a><span id="l37.85" class="difflineplus">+}</span>
<a href="#l37.86"></a><span id="l37.86" class="difflineplus">+</span>
<a href="#l37.87"></a><span id="l37.87" class="difflineplus">+/**</span>
<a href="#l37.88"></a><span id="l37.88" class="difflineplus">+ * Verify that we update summarization when switching amongst tabs.</span>
<a href="#l37.89"></a><span id="l37.89" class="difflineplus">+ */</span>
<a href="#l37.90"></a><span id="l37.90" class="difflineplus">+function test_folder_tabs_update_correctly() {</span>
<a href="#l37.91"></a><span id="l37.91" class="difflineplus">+  // tab with summary</span>
<a href="#l37.92"></a><span id="l37.92" class="difflineplus">+  let tabA = be_in_folder(folder);</span>
<a href="#l37.93"></a><span id="l37.93" class="difflineplus">+  select_click_row(0);</span>
<a href="#l37.94"></a><span id="l37.94" class="difflineplus">+  select_control_click_row(2);</span>
<a href="#l37.95"></a><span id="l37.95" class="difflineplus">+  assert_selected_and_displayed(0, 2);</span>
<a href="#l37.96"></a><span id="l37.96" class="difflineplus">+</span>
<a href="#l37.97"></a><span id="l37.97" class="difflineplus">+  // tab with nothing</span>
<a href="#l37.98"></a><span id="l37.98" class="difflineplus">+  let tabB = open_folder_in_new_tab(folder);</span>
<a href="#l37.99"></a><span id="l37.99" class="difflineplus">+  assert_nothing_selected();</span>
<a href="#l37.100"></a><span id="l37.100" class="difflineplus">+</span>
<a href="#l37.101"></a><span id="l37.101" class="difflineplus">+  // correct changes, none &lt;=&gt; summary</span>
<a href="#l37.102"></a><span id="l37.102" class="difflineplus">+  switch_tab(tabA);</span>
<a href="#l37.103"></a><span id="l37.103" class="difflineplus">+  assert_selected_and_displayed(0, 2);</span>
<a href="#l37.104"></a><span id="l37.104" class="difflineplus">+  switch_tab(tabB);</span>
<a href="#l37.105"></a><span id="l37.105" class="difflineplus">+  assert_nothing_selected();</span>
<a href="#l37.106"></a><span id="l37.106" class="difflineplus">+</span>
<a href="#l37.107"></a><span id="l37.107" class="difflineplus">+  // correct changes, one &lt;=&gt; summary</span>
<a href="#l37.108"></a><span id="l37.108" class="difflineplus">+  select_click_row(0);</span>
<a href="#l37.109"></a><span id="l37.109" class="difflineplus">+  assert_selected_and_displayed(0);</span>
<a href="#l37.110"></a><span id="l37.110" class="difflineplus">+  switch_tab(tabA);</span>
<a href="#l37.111"></a><span id="l37.111" class="difflineplus">+  assert_selected_and_displayed(0, 2);</span>
<a href="#l37.112"></a><span id="l37.112" class="difflineplus">+  switch_tab(tabB);</span>
<a href="#l37.113"></a><span id="l37.113" class="difflineplus">+  assert_selected_and_displayed(0);</span>
<a href="#l37.114"></a><span id="l37.114" class="difflineplus">+</span>
<a href="#l37.115"></a><span id="l37.115" class="difflineplus">+  // correct changes, summary &lt;=&gt; summary</span>
<a href="#l37.116"></a><span id="l37.116" class="difflineplus">+  select_shift_click_row(3);</span>
<a href="#l37.117"></a><span id="l37.117" class="difflineplus">+  assert_selected_and_displayed([0, 3]);</span>
<a href="#l37.118"></a><span id="l37.118" class="difflineplus">+  switch_tab(tabA);</span>
<a href="#l37.119"></a><span id="l37.119" class="difflineplus">+  assert_selected_and_displayed(0, 2);</span>
<a href="#l37.120"></a><span id="l37.120" class="difflineplus">+  switch_tab(tabB);</span>
<a href="#l37.121"></a><span id="l37.121" class="difflineplus">+  assert_selected_and_displayed([0, 3]);</span>
<a href="#l37.122"></a><span id="l37.122" class="difflineplus">+</span>
<a href="#l37.123"></a><span id="l37.123" class="difflineplus">+  // closing tab returns state correctly...</span>
<a href="#l37.124"></a><span id="l37.124" class="difflineplus">+  close_tab(tabB);</span>
<a href="#l37.125"></a><span id="l37.125" class="difflineplus">+  assert_selected_and_displayed(0, 2);</span>
<a href="#l37.126"></a><span id="l37.126" class="difflineplus">+}</span>
<a href="#l37.127"></a><span id="l37.127" class="difflineplus">+</span>
<a href="#l37.128"></a><span id="l37.128" class="difflineplus">+function test_message_tabs_update_correctly() {</span>
<a href="#l37.129"></a><span id="l37.129" class="difflineplus">+  let tabFolder = be_in_folder(folder);</span>
<a href="#l37.130"></a><span id="l37.130" class="difflineplus">+  let message = select_click_row(0);</span>
<a href="#l37.131"></a><span id="l37.131" class="difflineplus">+  assert_selected_and_displayed(0);</span>
<a href="#l37.132"></a><span id="l37.132" class="difflineplus">+</span>
<a href="#l37.133"></a><span id="l37.133" class="difflineplus">+  let tabMessage = open_selected_message_in_new_tab();</span>
<a href="#l37.134"></a><span id="l37.134" class="difflineplus">+  assert_selected_and_displayed(message);</span>
<a href="#l37.135"></a><span id="l37.135" class="difflineplus">+</span>
<a href="#l37.136"></a><span id="l37.136" class="difflineplus">+  switch_tab(tabFolder);</span>
<a href="#l37.137"></a><span id="l37.137" class="difflineplus">+  select_shift_click_row(2);</span>
<a href="#l37.138"></a><span id="l37.138" class="difflineplus">+  assert_selected_and_displayed([0, 2]);</span>
<a href="#l37.139"></a><span id="l37.139" class="difflineplus">+</span>
<a href="#l37.140"></a><span id="l37.140" class="difflineplus">+  switch_tab(tabMessage);</span>
<a href="#l37.141"></a><span id="l37.141" class="difflineplus">+  assert_selected_and_displayed(message);</span>
<a href="#l37.142"></a><span id="l37.142" class="difflineplus">+</span>
<a href="#l37.143"></a><span id="l37.143" class="difflineplus">+  switch_tab(tabFolder);</span>
<a href="#l37.144"></a><span id="l37.144" class="difflineplus">+  assert_selected_and_displayed([0, 2]);</span>
<a href="#l37.145"></a><span id="l37.145" class="difflineplus">+</span>
<a href="#l37.146"></a><span id="l37.146" class="difflineplus">+  close_tab(tabMessage);</span>
<a href="#l37.147"></a><span id="l37.147" class="difflineplus">+}</span>
<a href="#l37.148"></a><span id="l37.148" class="difflineplus">+</span>
<a href="#l37.149"></a><span id="l37.149" class="difflineplus">+/**</span>
<a href="#l37.150"></a><span id="l37.150" class="difflineplus">+ * Test the stabilization logic by making the stabilization interval absurd and</span>
<a href="#l37.151"></a><span id="l37.151" class="difflineplus">+ *  then manually clearing things up.</span>
<a href="#l37.152"></a><span id="l37.152" class="difflineplus">+ */</span>
<a href="#l37.153"></a><span id="l37.153" class="difflineplus">+function test_selection_stabilization_logic() {</span>
<a href="#l37.154"></a><span id="l37.154" class="difflineplus">+  // make sure all summarization has run to completion.</span>
<a href="#l37.155"></a><span id="l37.155" class="difflineplus">+  mc.sleep(0);</span>
<a href="#l37.156"></a><span id="l37.156" class="difflineplus">+  // make it inconceivable that the timeout happens.</span>
<a href="#l37.157"></a><span id="l37.157" class="difflineplus">+  mc.window.MessageDisplayWidget.prototype</span>
<a href="#l37.158"></a><span id="l37.158" class="difflineplus">+    .SUMMARIZATION_SELECTION_STABILITY_INTERVAL_MS = 10000;</span>
<a href="#l37.159"></a><span id="l37.159" class="difflineplus">+  // does not summarize anything, does not affect timer</span>
<a href="#l37.160"></a><span id="l37.160" class="difflineplus">+  select_click_row(0);</span>
<a href="#l37.161"></a><span id="l37.161" class="difflineplus">+  // does summarize things.  timer will be tick tick ticking!</span>
<a href="#l37.162"></a><span id="l37.162" class="difflineplus">+  select_shift_click_row(1);</span>
<a href="#l37.163"></a><span id="l37.163" class="difflineplus">+  // verify that things were summarized...</span>
<a href="#l37.164"></a><span id="l37.164" class="difflineplus">+  assert_selected_and_displayed([0, 1]);</span>
<a href="#l37.165"></a><span id="l37.165" class="difflineplus">+  // save the set of messages so we can verify the summary sticks to this.</span>
<a href="#l37.166"></a><span id="l37.166" class="difflineplus">+  let messages = mc.folderDisplay.selectedMessages;</span>
<a href="#l37.167"></a><span id="l37.167" class="difflineplus">+</span>
<a href="#l37.168"></a><span id="l37.168" class="difflineplus">+  // make sure the</span>
<a href="#l37.169"></a><span id="l37.169" class="difflineplus">+</span>
<a href="#l37.170"></a><span id="l37.170" class="difflineplus">+  // this will not summarize!</span>
<a href="#l37.171"></a><span id="l37.171" class="difflineplus">+  select_shift_click_row(2);</span>
<a href="#l37.172"></a><span id="l37.172" class="difflineplus">+  // verify that our summary is still just 0 and 1.</span>
<a href="#l37.173"></a><span id="l37.173" class="difflineplus">+  assert_selection_summarized(mc, messages);</span>
<a href="#l37.174"></a><span id="l37.174" class="difflineplus">+</span>
<a href="#l37.175"></a><span id="l37.175" class="difflineplus">+  // - put it back, the way it was</span>
<a href="#l37.176"></a><span id="l37.176" class="difflineplus">+  // oh put it back the way it was</span>
<a href="#l37.177"></a><span id="l37.177" class="difflineplus">+  // ...</span>
<a href="#l37.178"></a><span id="l37.178" class="difflineplus">+  // That's right folks, a 'Lil Abner reference.</span>
<a href="#l37.179"></a><span id="l37.179" class="difflineplus">+  // ...</span>
<a href="#l37.180"></a><span id="l37.180" class="difflineplus">+  // Culture!</span>
<a href="#l37.181"></a><span id="l37.181" class="difflineplus">+  // ...</span>
<a href="#l37.182"></a><span id="l37.182" class="difflineplus">+  // I'm already embarassed I wrote that.</span>
<a href="#l37.183"></a><span id="l37.183" class="difflineplus">+  mc.window.MessageDisplayWidget.prototype</span>
<a href="#l37.184"></a><span id="l37.184" class="difflineplus">+    .SUMMARIZATION_SELECTION_STABILITY_INTERVAL_MS = 0;</span>
<a href="#l37.185"></a><span id="l37.185" class="difflineplus">+  // (we did that because the stability logic is going to schedule another guard</span>
<a href="#l37.186"></a><span id="l37.186" class="difflineplus">+  //  timer when we manually trigger it, and we want that to clear immediately.)</span>
<a href="#l37.187"></a><span id="l37.187" class="difflineplus">+</span>
<a href="#l37.188"></a><span id="l37.188" class="difflineplus">+  // - pretend the timer fired.</span>
<a href="#l37.189"></a><span id="l37.189" class="difflineplus">+  // we need to de-schedule the timer, but do not need to clear the variable</span>
<a href="#l37.190"></a><span id="l37.190" class="difflineplus">+  //  because it will just get overwritten anyways</span>
<a href="#l37.191"></a><span id="l37.191" class="difflineplus">+  mc.window.clearTimeout(mc.messageDisplay._summaryStabilityTimeout);</span>
<a href="#l37.192"></a><span id="l37.192" class="difflineplus">+  mc.messageDisplay._showSummary(true);</span>
<a href="#l37.193"></a><span id="l37.193" class="difflineplus">+</span>
<a href="#l37.194"></a><span id="l37.194" class="difflineplus">+  // - the summary should now be up-to-date</span>
<a href="#l37.195"></a><span id="l37.195" class="difflineplus">+  assert_selected_and_displayed([0, 2]);</span>
<a href="#l37.196"></a><span id="l37.196" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1">new file mode 100644</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineminus">--- /dev/null</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-tabs-simple.js</span>
<a href="#l38.4"></a><span id="l38.4" class="difflineat">@@ -0,0 +1,178 @@</span>
<a href="#l38.5"></a><span id="l38.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l38.6"></a><span id="l38.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l38.7"></a><span id="l38.7" class="difflineplus">+ *</span>
<a href="#l38.8"></a><span id="l38.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l38.9"></a><span id="l38.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l38.10"></a><span id="l38.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l38.11"></a><span id="l38.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l38.12"></a><span id="l38.12" class="difflineplus">+ *</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l38.14"></a><span id="l38.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l38.15"></a><span id="l38.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l38.16"></a><span id="l38.16" class="difflineplus">+ * License.</span>
<a href="#l38.17"></a><span id="l38.17" class="difflineplus">+ *</span>
<a href="#l38.18"></a><span id="l38.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l38.19"></a><span id="l38.19" class="difflineplus">+ *</span>
<a href="#l38.20"></a><span id="l38.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l38.21"></a><span id="l38.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l38.22"></a><span id="l38.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l38.23"></a><span id="l38.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l38.24"></a><span id="l38.24" class="difflineplus">+ *</span>
<a href="#l38.25"></a><span id="l38.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l38.26"></a><span id="l38.26" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l38.27"></a><span id="l38.27" class="difflineplus">+ *</span>
<a href="#l38.28"></a><span id="l38.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l38.29"></a><span id="l38.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l38.30"></a><span id="l38.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l38.31"></a><span id="l38.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l38.32"></a><span id="l38.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l38.33"></a><span id="l38.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l38.34"></a><span id="l38.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l38.35"></a><span id="l38.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l38.36"></a><span id="l38.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l38.37"></a><span id="l38.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l38.38"></a><span id="l38.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l38.39"></a><span id="l38.39" class="difflineplus">+ *</span>
<a href="#l38.40"></a><span id="l38.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l38.41"></a><span id="l38.41" class="difflineplus">+</span>
<a href="#l38.42"></a><span id="l38.42" class="difflineplus">+/*</span>
<a href="#l38.43"></a><span id="l38.43" class="difflineplus">+ * Test that opening new folder and message tabs has the expected result and</span>
<a href="#l38.44"></a><span id="l38.44" class="difflineplus">+ *  that closing them doesn't break anything.</span>
<a href="#l38.45"></a><span id="l38.45" class="difflineplus">+ */</span>
<a href="#l38.46"></a><span id="l38.46" class="difflineplus">+var MODULE_NAME = 'test-tabs-simple';</span>
<a href="#l38.47"></a><span id="l38.47" class="difflineplus">+</span>
<a href="#l38.48"></a><span id="l38.48" class="difflineplus">+var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l38.49"></a><span id="l38.49" class="difflineplus">+var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers'];</span>
<a href="#l38.50"></a><span id="l38.50" class="difflineplus">+</span>
<a href="#l38.51"></a><span id="l38.51" class="difflineplus">+var folderA, folderB, setA, setB;</span>
<a href="#l38.52"></a><span id="l38.52" class="difflineplus">+</span>
<a href="#l38.53"></a><span id="l38.53" class="difflineplus">+function setupModule(module) {</span>
<a href="#l38.54"></a><span id="l38.54" class="difflineplus">+  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l38.55"></a><span id="l38.55" class="difflineplus">+  fdh.installInto(module);</span>
<a href="#l38.56"></a><span id="l38.56" class="difflineplus">+  let wh = collector.getModule('window-helpers');</span>
<a href="#l38.57"></a><span id="l38.57" class="difflineplus">+  wh.installInto(module);</span>
<a href="#l38.58"></a><span id="l38.58" class="difflineplus">+</span>
<a href="#l38.59"></a><span id="l38.59" class="difflineplus">+  folderA = create_folder(&quot;TabsSimpleA&quot;);</span>
<a href="#l38.60"></a><span id="l38.60" class="difflineplus">+  folderB = create_folder(&quot;TabsSimpleB&quot;);</span>
<a href="#l38.61"></a><span id="l38.61" class="difflineplus">+</span>
<a href="#l38.62"></a><span id="l38.62" class="difflineplus">+  // We will verify we are seeing the right folder by checking that it has the</span>
<a href="#l38.63"></a><span id="l38.63" class="difflineplus">+  //  right messages in it.</span>
<a href="#l38.64"></a><span id="l38.64" class="difflineplus">+  [setA] = make_new_sets_in_folder(folderA, [{}]);</span>
<a href="#l38.65"></a><span id="l38.65" class="difflineplus">+  [setB] = make_new_sets_in_folder(folderB, [{}]);</span>
<a href="#l38.66"></a><span id="l38.66" class="difflineplus">+}</span>
<a href="#l38.67"></a><span id="l38.67" class="difflineplus">+</span>
<a href="#l38.68"></a><span id="l38.68" class="difflineplus">+/** The tabs in our test. */</span>
<a href="#l38.69"></a><span id="l38.69" class="difflineplus">+var tabFolderA, tabFolderB, tabMessageA, tabMessageB;</span>
<a href="#l38.70"></a><span id="l38.70" class="difflineplus">+/** The message that we selected for tab display, to check it worked right. */</span>
<a href="#l38.71"></a><span id="l38.71" class="difflineplus">+var messageA, messageB;</span>
<a href="#l38.72"></a><span id="l38.72" class="difflineplus">+</span>
<a href="#l38.73"></a><span id="l38.73" class="difflineplus">+/**</span>
<a href="#l38.74"></a><span id="l38.74" class="difflineplus">+ * Make sure the default tab works right.</span>
<a href="#l38.75"></a><span id="l38.75" class="difflineplus">+ */</span>
<a href="#l38.76"></a><span id="l38.76" class="difflineplus">+function test_open_folder_a() {</span>
<a href="#l38.77"></a><span id="l38.77" class="difflineplus">+  tabFolderA = be_in_folder(folderA);</span>
<a href="#l38.78"></a><span id="l38.78" class="difflineplus">+  assert_messages_in_view(setA);</span>
<a href="#l38.79"></a><span id="l38.79" class="difflineplus">+  assert_nothing_selected();</span>
<a href="#l38.80"></a><span id="l38.80" class="difflineplus">+}</span>
<a href="#l38.81"></a><span id="l38.81" class="difflineplus">+</span>
<a href="#l38.82"></a><span id="l38.82" class="difflineplus">+/**</span>
<a href="#l38.83"></a><span id="l38.83" class="difflineplus">+ * Open tab b, make sure it works right.</span>
<a href="#l38.84"></a><span id="l38.84" class="difflineplus">+ */</span>
<a href="#l38.85"></a><span id="l38.85" class="difflineplus">+function test_open_folder_b_in_tab() {</span>
<a href="#l38.86"></a><span id="l38.86" class="difflineplus">+  tabFolderB = open_folder_in_new_tab(folderB);</span>
<a href="#l38.87"></a><span id="l38.87" class="difflineplus">+  assert_messages_in_view(setB);</span>
<a href="#l38.88"></a><span id="l38.88" class="difflineplus">+  assert_nothing_selected();</span>
<a href="#l38.89"></a><span id="l38.89" class="difflineplus">+}</span>
<a href="#l38.90"></a><span id="l38.90" class="difflineplus">+</span>
<a href="#l38.91"></a><span id="l38.91" class="difflineplus">+/**</span>
<a href="#l38.92"></a><span id="l38.92" class="difflineplus">+ * Go back to tab/folder A and make sure we change correctly.</span>
<a href="#l38.93"></a><span id="l38.93" class="difflineplus">+ */</span>
<a href="#l38.94"></a><span id="l38.94" class="difflineplus">+function test_switch_to_tab_folder_a() {</span>
<a href="#l38.95"></a><span id="l38.95" class="difflineplus">+  switch_tab(tabFolderA);</span>
<a href="#l38.96"></a><span id="l38.96" class="difflineplus">+  assert_messages_in_view(setA);</span>
<a href="#l38.97"></a><span id="l38.97" class="difflineplus">+  assert_nothing_selected();</span>
<a href="#l38.98"></a><span id="l38.98" class="difflineplus">+}</span>
<a href="#l38.99"></a><span id="l38.99" class="difflineplus">+</span>
<a href="#l38.100"></a><span id="l38.100" class="difflineplus">+/**</span>
<a href="#l38.101"></a><span id="l38.101" class="difflineplus">+ * Select a message in folder A and open it in a new window, making sure that</span>
<a href="#l38.102"></a><span id="l38.102" class="difflineplus">+ *  the displayed message is the right one.</span>
<a href="#l38.103"></a><span id="l38.103" class="difflineplus">+ */</span>
<a href="#l38.104"></a><span id="l38.104" class="difflineplus">+function test_open_message_a_in_tab() {</span>
<a href="#l38.105"></a><span id="l38.105" class="difflineplus">+  messageA = select_click_row(0);</span>
<a href="#l38.106"></a><span id="l38.106" class="difflineplus">+  tabMessageA = open_selected_message_in_new_tab();</span>
<a href="#l38.107"></a><span id="l38.107" class="difflineplus">+  assert_selected_and_displayed(messageA);</span>
<a href="#l38.108"></a><span id="l38.108" class="difflineplus">+}</span>
<a href="#l38.109"></a><span id="l38.109" class="difflineplus">+</span>
<a href="#l38.110"></a><span id="l38.110" class="difflineplus">+/**</span>
<a href="#l38.111"></a><span id="l38.111" class="difflineplus">+ * Go back to tab/folder B and make sure we change correctly.</span>
<a href="#l38.112"></a><span id="l38.112" class="difflineplus">+ */</span>
<a href="#l38.113"></a><span id="l38.113" class="difflineplus">+function test_switch_to_tab_folder_b() {</span>
<a href="#l38.114"></a><span id="l38.114" class="difflineplus">+  switch_tab(tabFolderB);</span>
<a href="#l38.115"></a><span id="l38.115" class="difflineplus">+  assert_messages_in_view(setB);</span>
<a href="#l38.116"></a><span id="l38.116" class="difflineplus">+  assert_nothing_selected();</span>
<a href="#l38.117"></a><span id="l38.117" class="difflineplus">+}</span>
<a href="#l38.118"></a><span id="l38.118" class="difflineplus">+</span>
<a href="#l38.119"></a><span id="l38.119" class="difflineplus">+/**</span>
<a href="#l38.120"></a><span id="l38.120" class="difflineplus">+ * Select a message in folder B and open it in a new window, making sure that</span>
<a href="#l38.121"></a><span id="l38.121" class="difflineplus">+ *  the displayed message is the right one.</span>
<a href="#l38.122"></a><span id="l38.122" class="difflineplus">+ */</span>
<a href="#l38.123"></a><span id="l38.123" class="difflineplus">+function test_open_message_b_in_tab() {</span>
<a href="#l38.124"></a><span id="l38.124" class="difflineplus">+  messageB = select_click_row(0);</span>
<a href="#l38.125"></a><span id="l38.125" class="difflineplus">+  tabMessageB = open_selected_message_in_new_tab();</span>
<a href="#l38.126"></a><span id="l38.126" class="difflineplus">+  assert_selected_and_displayed(messageB);</span>
<a href="#l38.127"></a><span id="l38.127" class="difflineplus">+}</span>
<a href="#l38.128"></a><span id="l38.128" class="difflineplus">+</span>
<a href="#l38.129"></a><span id="l38.129" class="difflineplus">+/**</span>
<a href="#l38.130"></a><span id="l38.130" class="difflineplus">+ * Switch to message tab A.</span>
<a href="#l38.131"></a><span id="l38.131" class="difflineplus">+ */</span>
<a href="#l38.132"></a><span id="l38.132" class="difflineplus">+function test_switch_to_message_a() {</span>
<a href="#l38.133"></a><span id="l38.133" class="difflineplus">+  switch_tab(tabMessageA);</span>
<a href="#l38.134"></a><span id="l38.134" class="difflineplus">+  assert_selected_and_displayed(messageA);</span>
<a href="#l38.135"></a><span id="l38.135" class="difflineplus">+}</span>
<a href="#l38.136"></a><span id="l38.136" class="difflineplus">+</span>
<a href="#l38.137"></a><span id="l38.137" class="difflineplus">+/**</span>
<a href="#l38.138"></a><span id="l38.138" class="difflineplus">+ * Close message tab A (when it's in the foreground).</span>
<a href="#l38.139"></a><span id="l38.139" class="difflineplus">+ */</span>
<a href="#l38.140"></a><span id="l38.140" class="difflineplus">+function test_close_message_a() {</span>
<a href="#l38.141"></a><span id="l38.141" class="difflineplus">+  close_tab();</span>
<a href="#l38.142"></a><span id="l38.142" class="difflineplus">+  // our current tab is now undefined for the purposes of this test.</span>
<a href="#l38.143"></a><span id="l38.143" class="difflineplus">+}</span>
<a href="#l38.144"></a><span id="l38.144" class="difflineplus">+</span>
<a href="#l38.145"></a><span id="l38.145" class="difflineplus">+/**</span>
<a href="#l38.146"></a><span id="l38.146" class="difflineplus">+ * Make sure all the other tabs are still happy.</span>
<a href="#l38.147"></a><span id="l38.147" class="difflineplus">+ */</span>
<a href="#l38.148"></a><span id="l38.148" class="difflineplus">+function test_tabs_are_still_happy() {</span>
<a href="#l38.149"></a><span id="l38.149" class="difflineplus">+  switch_tab(tabFolderB);</span>
<a href="#l38.150"></a><span id="l38.150" class="difflineplus">+  assert_messages_in_view(setB);</span>
<a href="#l38.151"></a><span id="l38.151" class="difflineplus">+  assert_selected_and_displayed(messageB);</span>
<a href="#l38.152"></a><span id="l38.152" class="difflineplus">+</span>
<a href="#l38.153"></a><span id="l38.153" class="difflineplus">+  switch_tab(tabMessageB);</span>
<a href="#l38.154"></a><span id="l38.154" class="difflineplus">+  assert_selected_and_displayed(messageB);</span>
<a href="#l38.155"></a><span id="l38.155" class="difflineplus">+</span>
<a href="#l38.156"></a><span id="l38.156" class="difflineplus">+  switch_tab(tabFolderA);</span>
<a href="#l38.157"></a><span id="l38.157" class="difflineplus">+  assert_messages_in_view(setA);</span>
<a href="#l38.158"></a><span id="l38.158" class="difflineplus">+  assert_selected_and_displayed(messageA);</span>
<a href="#l38.159"></a><span id="l38.159" class="difflineplus">+}</span>
<a href="#l38.160"></a><span id="l38.160" class="difflineplus">+</span>
<a href="#l38.161"></a><span id="l38.161" class="difflineplus">+/**</span>
<a href="#l38.162"></a><span id="l38.162" class="difflineplus">+ * Close message tab B (when it's in the background).</span>
<a href="#l38.163"></a><span id="l38.163" class="difflineplus">+ */</span>
<a href="#l38.164"></a><span id="l38.164" class="difflineplus">+function test_close_message_b() {</span>
<a href="#l38.165"></a><span id="l38.165" class="difflineplus">+  close_tab(tabMessageB);</span>
<a href="#l38.166"></a><span id="l38.166" class="difflineplus">+  // we should still be on folder A</span>
<a href="#l38.167"></a><span id="l38.167" class="difflineplus">+  assert_messages_in_view(setA);</span>
<a href="#l38.168"></a><span id="l38.168" class="difflineplus">+  assert_selected_and_displayed(messageA);</span>
<a href="#l38.169"></a><span id="l38.169" class="difflineplus">+}</span>
<a href="#l38.170"></a><span id="l38.170" class="difflineplus">+</span>
<a href="#l38.171"></a><span id="l38.171" class="difflineplus">+/**</span>
<a href="#l38.172"></a><span id="l38.172" class="difflineplus">+ * Switch to tab B, close it, make sure we end up on tab A.</span>
<a href="#l38.173"></a><span id="l38.173" class="difflineplus">+ */</span>
<a href="#l38.174"></a><span id="l38.174" class="difflineplus">+function test_close_folder_b() {</span>
<a href="#l38.175"></a><span id="l38.175" class="difflineplus">+  switch_tab(tabFolderB);</span>
<a href="#l38.176"></a><span id="l38.176" class="difflineplus">+  assert_messages_in_view(setB);</span>
<a href="#l38.177"></a><span id="l38.177" class="difflineplus">+  assert_selected_and_displayed(messageB);</span>
<a href="#l38.178"></a><span id="l38.178" class="difflineplus">+</span>
<a href="#l38.179"></a><span id="l38.179" class="difflineplus">+  close_tab();</span>
<a href="#l38.180"></a><span id="l38.180" class="difflineplus">+  assert_messages_in_view(setA);</span>
<a href="#l38.181"></a><span id="l38.181" class="difflineplus">+  assert_selected_and_displayed(messageA);</span>
<a href="#l38.182"></a><span id="l38.182" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/mail/test/mozmill/runtest.py</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/mail/test/mozmill/runtest.py</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -66,49 +66,48 @@ class ThunderTestProfile(mozrunner.Thund</span>
<a href="#l39.4"></a><span id="l39.4">         'mail.winsearch.enable': False,</span>
<a href="#l39.5"></a><span id="l39.5">         'mail.winsearch.firstRunDone': True,</span>
<a href="#l39.6"></a><span id="l39.6">         'mail.spotlight.enable': False,</span>
<a href="#l39.7"></a><span id="l39.7">         'mail.spotlight.firstRunDone': True,</span>
<a href="#l39.8"></a><span id="l39.8">         # disable address books for undisclosed reasons</span>
<a href="#l39.9"></a><span id="l39.9">         'ldap_2.servers.osx.position': 0,</span>
<a href="#l39.10"></a><span id="l39.10">         'ldap_2.servers.oe.position': 0,</span>
<a href="#l39.11"></a><span id="l39.11">         # other unknown voodoo</span>
<a href="#l39.12"></a><span id="l39.12" class="difflineminus">-	'dom.max_chrome_script_run_time' :  200,</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineminus">-	'dom.max_script_run_time' :  0,</span>
<a href="#l39.14"></a><span id="l39.14" class="difflineplus">+        # -- dummied up local accounts to stop the account wizard</span>
<a href="#l39.15"></a><span id="l39.15">         'mail.account.account1.server' :  &quot;server1&quot;,</span>
<a href="#l39.16"></a><span id="l39.16">         'mail.account.account2.identities' :  &quot;id1&quot;,</span>
<a href="#l39.17"></a><span id="l39.17">         'mail.account.account2.server' :  &quot;server2&quot;,</span>
<a href="#l39.18"></a><span id="l39.18">         'mail.accountmanager.accounts' :  &quot;account1,account2&quot;,</span>
<a href="#l39.19"></a><span id="l39.19">         'mail.accountmanager.defaultaccount' :  &quot;account2&quot;,</span>
<a href="#l39.20"></a><span id="l39.20">         'mail.accountmanager.localfoldersserver' :  &quot;server1&quot;,</span>
<a href="#l39.21"></a><span id="l39.21" class="difflineminus">-       	'mail.identity.id1.fullName' :  &quot;Tinderbox&quot;,</span>
<a href="#l39.22"></a><span id="l39.22" class="difflineplus">+        'mail.identity.id1.fullName' :  &quot;Tinderbox&quot;,</span>
<a href="#l39.23"></a><span id="l39.23">         'mail.identity.id1.smtpServer' :  &quot;smtp1&quot;,</span>
<a href="#l39.24"></a><span id="l39.24" class="difflineminus">-       	'mail.identity.id1.useremail' :  &quot;tinderbox@invalid.com&quot;,</span>
<a href="#l39.25"></a><span id="l39.25" class="difflineplus">+        'mail.identity.id1.useremail' :  &quot;tinderbox@invalid.com&quot;,</span>
<a href="#l39.26"></a><span id="l39.26">         'mail.identity.id1.valid' :  True,</span>
<a href="#l39.27"></a><span id="l39.27" class="difflineminus">-       	'mail.root.none-rel' :  &quot;[ProfD]Mail&quot;,</span>
<a href="#l39.28"></a><span id="l39.28" class="difflineplus">+        'mail.root.none-rel' :  &quot;[ProfD]Mail&quot;,</span>
<a href="#l39.29"></a><span id="l39.29">         'mail.root.pop3-rel' :  &quot;[ProfD]Mail&quot;,</span>
<a href="#l39.30"></a><span id="l39.30">         'mail.server.server1.directory-rel' :  &quot;[ProfD]Mail/Local Folders&quot;,</span>
<a href="#l39.31"></a><span id="l39.31">         'mail.server.server1.hostname' :  &quot;Local Folders&quot;,</span>
<a href="#l39.32"></a><span id="l39.32" class="difflineminus">-       	'mail.server.server1.name' :  &quot;Local Folders&quot;,</span>
<a href="#l39.33"></a><span id="l39.33" class="difflineplus">+        'mail.server.server1.name' :  &quot;Local Folders&quot;,</span>
<a href="#l39.34"></a><span id="l39.34">         'mail.server.server1.type' :  &quot;none&quot;,</span>
<a href="#l39.35"></a><span id="l39.35">         'mail.server.server1.userName' :  &quot;nobody&quot;,</span>
<a href="#l39.36"></a><span id="l39.36">         'mail.server.server2.check_new_mail' :  False,</span>
<a href="#l39.37"></a><span id="l39.37">         'mail.server.server2.directory-rel' :  &quot;[ProfD]Mail/tinderbox&quot;,</span>
<a href="#l39.38"></a><span id="l39.38">         'mail.server.server2.download_on_biff' :  True,</span>
<a href="#l39.39"></a><span id="l39.39" class="difflineminus">-       	'mail.server.server2.hostname' :  &quot;tinderbox&quot;,</span>
<a href="#l39.40"></a><span id="l39.40" class="difflineminus">-       	'mail.server.server2.login_at_startup' :  False,</span>
<a href="#l39.41"></a><span id="l39.41" class="difflineminus">-       	'mail.server.server2.name' :  &quot;tinderbox@invalid.com&quot;,</span>
<a href="#l39.42"></a><span id="l39.42" class="difflineminus">-       	'mail.server.server2.type' :  &quot;pop3&quot;,</span>
<a href="#l39.43"></a><span id="l39.43" class="difflineminus">-       	'mail.server.server2.userName' :  &quot;tinderbox&quot;,</span>
<a href="#l39.44"></a><span id="l39.44" class="difflineminus">-       	'mail.smtp.defaultserver' :  &quot;smtp1&quot;,</span>
<a href="#l39.45"></a><span id="l39.45" class="difflineminus">-       	'mail.smtpserver.smtp1.hostname' :  &quot;tinderbox&quot;,</span>
<a href="#l39.46"></a><span id="l39.46" class="difflineminus">-       	'mail.smtpserver.smtp1.username' :  &quot;tinderbox&quot;,</span>
<a href="#l39.47"></a><span id="l39.47" class="difflineminus">-       	'mail.smtpservers' :  &quot;smtp1&quot;,</span>
<a href="#l39.48"></a><span id="l39.48" class="difflineminus">-       	'mail.startup.enabledMailCheckOnce' :  True,</span>
<a href="#l39.49"></a><span id="l39.49" class="difflineminus">-       	'mailnews.start_page_override.mstone' :  &quot;ignore&quot;,</span>
<a href="#l39.50"></a><span id="l39.50" class="difflineplus">+        'mail.server.server2.hostname' :  &quot;tinderbox&quot;,</span>
<a href="#l39.51"></a><span id="l39.51" class="difflineplus">+        'mail.server.server2.login_at_startup' :  False,</span>
<a href="#l39.52"></a><span id="l39.52" class="difflineplus">+        'mail.server.server2.name' :  &quot;tinderbox@invalid.com&quot;,</span>
<a href="#l39.53"></a><span id="l39.53" class="difflineplus">+        'mail.server.server2.type' :  &quot;pop3&quot;,</span>
<a href="#l39.54"></a><span id="l39.54" class="difflineplus">+        'mail.server.server2.userName' :  &quot;tinderbox&quot;,</span>
<a href="#l39.55"></a><span id="l39.55" class="difflineplus">+        'mail.smtp.defaultserver' :  &quot;smtp1&quot;,</span>
<a href="#l39.56"></a><span id="l39.56" class="difflineplus">+        'mail.smtpserver.smtp1.hostname' :  &quot;tinderbox&quot;,</span>
<a href="#l39.57"></a><span id="l39.57" class="difflineplus">+        'mail.smtpserver.smtp1.username' :  &quot;tinderbox&quot;,</span>
<a href="#l39.58"></a><span id="l39.58" class="difflineplus">+        'mail.smtpservers' :  &quot;smtp1&quot;,</span>
<a href="#l39.59"></a><span id="l39.59" class="difflineplus">+        'mail.startup.enabledMailCheckOnce' :  True,</span>
<a href="#l39.60"></a><span id="l39.60" class="difflineplus">+        'mailnews.start_page_override.mstone' :  &quot;ignore&quot;,</span>
<a href="#l39.61"></a><span id="l39.61">         }</span>
<a href="#l39.62"></a><span id="l39.62"> </span>
<a href="#l39.63"></a><span id="l39.63">     def __init__(self, default_profile=None, profile=None, create_new=True,</span>
<a href="#l39.64"></a><span id="l39.64">                  plugins=[], preferences={}):</span>
<a href="#l39.65"></a><span id="l39.65">         self.init_env()</span>
<a href="#l39.66"></a><span id="l39.66">         self.init_paths()</span>
<a href="#l39.67"></a><span id="l39.67">         mozrunner.Profile.__init__(self, None, None, True, plugins, preferences)</span>
<a href="#l39.68"></a><span id="l39.68"> </span>
<a href="#l39.69"></a><span id="l39.69" class="difflineat">@@ -166,17 +165,17 @@ class ThunderTestProfile(mozrunner.Thund</span>
<a href="#l39.70"></a><span id="l39.70">         f.close()</span>
<a href="#l39.71"></a><span id="l39.71"> </span>
<a href="#l39.72"></a><span id="l39.72">         raise Exception(&quot;unable to figure out obj_dir&quot;)</span>
<a href="#l39.73"></a><span id="l39.73"> </span>
<a href="#l39.74"></a><span id="l39.74">     def init_env(self):</span>
<a href="#l39.75"></a><span id="l39.75">         self.base_env = dict(os.environ)</span>
<a href="#l39.76"></a><span id="l39.76">         # note, we do NOT want to set NO_EM_RESTART or jsbridge wouldn't work</span>
<a href="#l39.77"></a><span id="l39.77">         # avoid dialogs on windows</span>
<a href="#l39.78"></a><span id="l39.78" class="difflineminus">-        self.base_env['XPCOM_DEBUG_BREAK'] = 'warn'</span>
<a href="#l39.79"></a><span id="l39.79" class="difflineplus">+        self.base_env['XPCOM_DEBUG_BREAK'] = 'stack'</span>
<a href="#l39.80"></a><span id="l39.80">         # do not reuse an existing instance</span>
<a href="#l39.81"></a><span id="l39.81">         self.base_env['MOZ_NO_REMOTE'] = '1'</span>
<a href="#l39.82"></a><span id="l39.82"> </span>
<a href="#l39.83"></a><span id="l39.83">     def _run(self, *args, **extraenv):</span>
<a href="#l39.84"></a><span id="l39.84">         env = self.base_env.copy()</span>
<a href="#l39.85"></a><span id="l39.85">         env.update(extraenv)</span>
<a href="#l39.86"></a><span id="l39.86">         allArgs = [self.app_path]</span>
<a href="#l39.87"></a><span id="l39.87">         allArgs.extend(args)</span>
<a href="#l39.88"></a><span id="l39.88" class="difflineat">@@ -213,10 +212,69 @@ class ThunderTestRunner(mozrunner.Thunde</span>
<a href="#l39.89"></a><span id="l39.89">     def find_binary(self):</span>
<a href="#l39.90"></a><span id="l39.90">         return self.profile.app_path</span>
<a href="#l39.91"></a><span id="l39.91"> </span>
<a href="#l39.92"></a><span id="l39.92"> </span>
<a href="#l39.93"></a><span id="l39.93"> class ThunderTestCLI(mozmill.CLI):</span>
<a href="#l39.94"></a><span id="l39.94">     profile_class = ThunderTestProfile</span>
<a href="#l39.95"></a><span id="l39.95">     runner_class = ThunderTestRunner</span>
<a href="#l39.96"></a><span id="l39.96"> </span>
<a href="#l39.97"></a><span id="l39.97" class="difflineplus">+TEST_RESULTS = []</span>
<a href="#l39.98"></a><span id="l39.98" class="difflineplus">+# override mozmill's default logging case, which I hate.</span>
<a href="#l39.99"></a><span id="l39.99" class="difflineplus">+def logFailure(obj):</span>
<a href="#l39.100"></a><span id="l39.100" class="difflineplus">+    FAILURE_LIST.append(obj)</span>
<a href="#l39.101"></a><span id="l39.101" class="difflineplus">+def logEndTest(obj):</span>
<a href="#l39.102"></a><span id="l39.102" class="difflineplus">+    TEST_RESULTS.append(obj)</span>
<a href="#l39.103"></a><span id="l39.103" class="difflineplus">+#mozmill.LoggerListener.cases['mozmill.fail'] = logFailure</span>
<a href="#l39.104"></a><span id="l39.104" class="difflineplus">+mozmill.LoggerListener.cases['mozmill.endTest'] = logEndTest</span>
<a href="#l39.105"></a><span id="l39.105" class="difflineplus">+</span>
<a href="#l39.106"></a><span id="l39.106" class="difflineplus">+def prettifyFilename(path):</span>
<a href="#l39.107"></a><span id="l39.107" class="difflineplus">+    lslash = path.rfind('/')</span>
<a href="#l39.108"></a><span id="l39.108" class="difflineplus">+    if lslash != -1:</span>
<a href="#l39.109"></a><span id="l39.109" class="difflineplus">+        return path[lslash+1:]</span>
<a href="#l39.110"></a><span id="l39.110" class="difflineplus">+    else:</span>
<a href="#l39.111"></a><span id="l39.111" class="difflineplus">+        return path</span>
<a href="#l39.112"></a><span id="l39.112" class="difflineplus">+</span>
<a href="#l39.113"></a><span id="l39.113" class="difflineplus">+def prettyPrintException(e):</span>
<a href="#l39.114"></a><span id="l39.114" class="difflineplus">+    print '  EXCEPTION:', e.get('message', 'no message!')</span>
<a href="#l39.115"></a><span id="l39.115" class="difflineplus">+    print '    at:', prettifyFilename(e.get('fileName', 'nonesuch')), 'line', e.get('lineNumber', 0)</span>
<a href="#l39.116"></a><span id="l39.116" class="difflineplus">+    if 'stack' in e:</span>
<a href="#l39.117"></a><span id="l39.117" class="difflineplus">+        for line in e['stack'].splitlines():</span>
<a href="#l39.118"></a><span id="l39.118" class="difflineplus">+            if not line:</span>
<a href="#l39.119"></a><span id="l39.119" class="difflineplus">+                continue</span>
<a href="#l39.120"></a><span id="l39.120" class="difflineplus">+            if line[0] == &quot;(&quot;:</span>
<a href="#l39.121"></a><span id="l39.121" class="difflineplus">+                funcname = None</span>
<a href="#l39.122"></a><span id="l39.122" class="difflineplus">+            elif line[0] == &quot;@&quot;:</span>
<a href="#l39.123"></a><span id="l39.123" class="difflineplus">+                # this is probably the root, don't care</span>
<a href="#l39.124"></a><span id="l39.124" class="difflineplus">+                continue</span>
<a href="#l39.125"></a><span id="l39.125" class="difflineplus">+            else:</span>
<a href="#l39.126"></a><span id="l39.126" class="difflineplus">+                funcname = line[:line.find('@')]</span>
<a href="#l39.127"></a><span id="l39.127" class="difflineplus">+            pathAndLine = line[line.rfind('@')+1:]</span>
<a href="#l39.128"></a><span id="l39.128" class="difflineplus">+            rcolon = pathAndLine.rfind(':')</span>
<a href="#l39.129"></a><span id="l39.129" class="difflineplus">+            if rcolon != -1:</span>
<a href="#l39.130"></a><span id="l39.130" class="difflineplus">+                path = pathAndLine[:rcolon]</span>
<a href="#l39.131"></a><span id="l39.131" class="difflineplus">+                line = pathAndLine[rcolon+1:]</span>
<a href="#l39.132"></a><span id="l39.132" class="difflineplus">+            else:</span>
<a href="#l39.133"></a><span id="l39.133" class="difflineplus">+                path = pathAndLine</span>
<a href="#l39.134"></a><span id="l39.134" class="difflineplus">+                line = 0</span>
<a href="#l39.135"></a><span id="l39.135" class="difflineplus">+            if funcname:</span>
<a href="#l39.136"></a><span id="l39.136" class="difflineplus">+                print '      ', funcname, prettifyFilename(path), line</span>
<a href="#l39.137"></a><span id="l39.137" class="difflineplus">+            else:</span>
<a href="#l39.138"></a><span id="l39.138" class="difflineplus">+                print '           ', prettifyFilename(path), line</span>
<a href="#l39.139"></a><span id="l39.139" class="difflineplus">+</span>
<a href="#l39.140"></a><span id="l39.140" class="difflineplus">+</span>
<a href="#l39.141"></a><span id="l39.141" class="difflineplus">+import pprint</span>
<a href="#l39.142"></a><span id="l39.142" class="difflineplus">+def prettyPrintResults():</span>
<a href="#l39.143"></a><span id="l39.143" class="difflineplus">+    for result in TEST_RESULTS:</span>
<a href="#l39.144"></a><span id="l39.144" class="difflineplus">+        #pprint.pprint(result)</span>
<a href="#l39.145"></a><span id="l39.145" class="difflineplus">+        print 'TEST', result['name'], len(result['fails']) and &quot;FAILED&quot; or &quot;PASSED&quot;</span>
<a href="#l39.146"></a><span id="l39.146" class="difflineplus">+        for failure in result['fails']:</span>
<a href="#l39.147"></a><span id="l39.147" class="difflineplus">+            if 'exception' in failure:</span>
<a href="#l39.148"></a><span id="l39.148" class="difflineplus">+                prettyPrintException(failure['exception'])</span>
<a href="#l39.149"></a><span id="l39.149" class="difflineplus">+</span>
<a href="#l39.150"></a><span id="l39.150" class="difflineplus">+import atexit</span>
<a href="#l39.151"></a><span id="l39.151" class="difflineplus">+atexit.register(prettyPrintResults)</span>
<a href="#l39.152"></a><span id="l39.152" class="difflineplus">+</span>
<a href="#l39.153"></a><span id="l39.153"> if __name__ == '__main__':</span>
<a href="#l39.154"></a><span id="l39.154" class="difflineminus">-    ThunderTestCLI().run()</span>
<a href="#l39.155"></a><span id="l39.155" class="difflineplus">+    try:</span>
<a href="#l39.156"></a><span id="l39.156" class="difflineplus">+        ThunderTestCLI().run()</span>
<a href="#l39.157"></a><span id="l39.157" class="difflineplus">+    except Exception, e:</span>
<a href="#l39.158"></a><span id="l39.158" class="difflineplus">+        print 'There was an exception', e</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1">new file mode 100644</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineminus">--- /dev/null</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineplus">+++ b/mail/test/mozmill/search-window/test-search-window.js</span>
<a href="#l40.4"></a><span id="l40.4" class="difflineat">@@ -0,0 +1,178 @@</span>
<a href="#l40.5"></a><span id="l40.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l40.6"></a><span id="l40.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l40.7"></a><span id="l40.7" class="difflineplus">+ *</span>
<a href="#l40.8"></a><span id="l40.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l40.9"></a><span id="l40.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l40.10"></a><span id="l40.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l40.11"></a><span id="l40.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l40.12"></a><span id="l40.12" class="difflineplus">+ *</span>
<a href="#l40.13"></a><span id="l40.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l40.14"></a><span id="l40.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l40.15"></a><span id="l40.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l40.16"></a><span id="l40.16" class="difflineplus">+ * License.</span>
<a href="#l40.17"></a><span id="l40.17" class="difflineplus">+ *</span>
<a href="#l40.18"></a><span id="l40.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l40.19"></a><span id="l40.19" class="difflineplus">+ *</span>
<a href="#l40.20"></a><span id="l40.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l40.21"></a><span id="l40.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l40.22"></a><span id="l40.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l40.23"></a><span id="l40.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l40.24"></a><span id="l40.24" class="difflineplus">+ *</span>
<a href="#l40.25"></a><span id="l40.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l40.26"></a><span id="l40.26" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l40.27"></a><span id="l40.27" class="difflineplus">+ *</span>
<a href="#l40.28"></a><span id="l40.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l40.29"></a><span id="l40.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l40.30"></a><span id="l40.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l40.31"></a><span id="l40.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l40.32"></a><span id="l40.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l40.33"></a><span id="l40.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l40.34"></a><span id="l40.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l40.35"></a><span id="l40.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l40.36"></a><span id="l40.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l40.37"></a><span id="l40.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l40.38"></a><span id="l40.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l40.39"></a><span id="l40.39" class="difflineplus">+ *</span>
<a href="#l40.40"></a><span id="l40.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l40.41"></a><span id="l40.41" class="difflineplus">+</span>
<a href="#l40.42"></a><span id="l40.42" class="difflineplus">+/*</span>
<a href="#l40.43"></a><span id="l40.43" class="difflineplus">+ * Tests:</span>
<a href="#l40.44"></a><span id="l40.44" class="difflineplus">+ * - https://bugzilla.mozilla.org/show_bug.cgi?id=474701#c96 first para</span>
<a href="#l40.45"></a><span id="l40.45" class="difflineplus">+ */</span>
<a href="#l40.46"></a><span id="l40.46" class="difflineplus">+var MODULE_NAME = 'test-search-window';</span>
<a href="#l40.47"></a><span id="l40.47" class="difflineplus">+</span>
<a href="#l40.48"></a><span id="l40.48" class="difflineplus">+var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l40.49"></a><span id="l40.49" class="difflineplus">+var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers'];</span>
<a href="#l40.50"></a><span id="l40.50" class="difflineplus">+</span>
<a href="#l40.51"></a><span id="l40.51" class="difflineplus">+function setupModule(module) {</span>
<a href="#l40.52"></a><span id="l40.52" class="difflineplus">+  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l40.53"></a><span id="l40.53" class="difflineplus">+  fdh.installInto(module);</span>
<a href="#l40.54"></a><span id="l40.54" class="difflineplus">+  let wh = collector.getModule('window-helpers');</span>
<a href="#l40.55"></a><span id="l40.55" class="difflineplus">+  wh.installInto(module);</span>
<a href="#l40.56"></a><span id="l40.56" class="difflineplus">+}</span>
<a href="#l40.57"></a><span id="l40.57" class="difflineplus">+</span>
<a href="#l40.58"></a><span id="l40.58" class="difflineplus">+var folder, setFoo, setBar, setFooBar;</span>
<a href="#l40.59"></a><span id="l40.59" class="difflineplus">+</span>
<a href="#l40.60"></a><span id="l40.60" class="difflineplus">+/**</span>
<a href="#l40.61"></a><span id="l40.61" class="difflineplus">+ * Create some messages that our constraint below will satisfy</span>
<a href="#l40.62"></a><span id="l40.62" class="difflineplus">+ */</span>
<a href="#l40.63"></a><span id="l40.63" class="difflineplus">+function test_create_messages() {</span>
<a href="#l40.64"></a><span id="l40.64" class="difflineplus">+  folder = create_folder(&quot;SearchWindowA&quot;);</span>
<a href="#l40.65"></a><span id="l40.65" class="difflineplus">+  [setFoo, setBar, setFooBar] =</span>
<a href="#l40.66"></a><span id="l40.66" class="difflineplus">+    make_new_sets_in_folder(folder, [{subject: &quot;foo&quot;}, {subject: &quot;bar&quot;},</span>
<a href="#l40.67"></a><span id="l40.67" class="difflineplus">+                                     {subject: &quot;foo bar&quot;}]);</span>
<a href="#l40.68"></a><span id="l40.68" class="difflineplus">+}</span>
<a href="#l40.69"></a><span id="l40.69" class="difflineplus">+</span>
<a href="#l40.70"></a><span id="l40.70" class="difflineplus">+/**</span>
<a href="#l40.71"></a><span id="l40.71" class="difflineplus">+ * The search window controller.</span>
<a href="#l40.72"></a><span id="l40.72" class="difflineplus">+ */</span>
<a href="#l40.73"></a><span id="l40.73" class="difflineplus">+var swc = null;</span>
<a href="#l40.74"></a><span id="l40.74" class="difflineplus">+</span>
<a href="#l40.75"></a><span id="l40.75" class="difflineplus">+/**</span>
<a href="#l40.76"></a><span id="l40.76" class="difflineplus">+ * Bring up the search window.</span>
<a href="#l40.77"></a><span id="l40.77" class="difflineplus">+ */</span>
<a href="#l40.78"></a><span id="l40.78" class="difflineplus">+function test_show_search_window() {</span>
<a href="#l40.79"></a><span id="l40.79" class="difflineplus">+  // put us in the folder we care about so it defaults to that</span>
<a href="#l40.80"></a><span id="l40.80" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l40.81"></a><span id="l40.81" class="difflineplus">+</span>
<a href="#l40.82"></a><span id="l40.82" class="difflineplus">+  // push control-shift-F, wait for it to show</span>
<a href="#l40.83"></a><span id="l40.83" class="difflineplus">+  plan_for_new_window(&quot;mailnews:search&quot;);</span>
<a href="#l40.84"></a><span id="l40.84" class="difflineplus">+  mc.keypress(null, &quot;f&quot;, {shiftKey: true, ctrlKey: true});</span>
<a href="#l40.85"></a><span id="l40.85" class="difflineplus">+  swc = wait_for_new_window(&quot;mailnews:search&quot;);</span>
<a href="#l40.86"></a><span id="l40.86" class="difflineplus">+}</span>
<a href="#l40.87"></a><span id="l40.87" class="difflineplus">+</span>
<a href="#l40.88"></a><span id="l40.88" class="difflineplus">+/**</span>
<a href="#l40.89"></a><span id="l40.89" class="difflineplus">+ * Set up the search.</span>
<a href="#l40.90"></a><span id="l40.90" class="difflineplus">+ */</span>
<a href="#l40.91"></a><span id="l40.91" class="difflineplus">+function test_enter_some_stuff() {</span>
<a href="#l40.92"></a><span id="l40.92" class="difflineplus">+  // - turn off search subfolders</span>
<a href="#l40.93"></a><span id="l40.93" class="difflineplus">+  // (we're not testing the UI, direct access is fine)</span>
<a href="#l40.94"></a><span id="l40.94" class="difflineplus">+  swc.e(&quot;checkSearchSubFolders&quot;).removeAttribute(&quot;checked&quot;);</span>
<a href="#l40.95"></a><span id="l40.95" class="difflineplus">+</span>
<a href="#l40.96"></a><span id="l40.96" class="difflineplus">+  // - put &quot;foo&quot; in the subject contains box</span>
<a href="#l40.97"></a><span id="l40.97" class="difflineplus">+  // Each filter criterion is a listitem in the listbox with id=searchTermList.</span>
<a href="#l40.98"></a><span id="l40.98" class="difflineplus">+  // Each filter criterion has id &quot;searchRowN&quot;, and the textbox has id</span>
<a href="#l40.99"></a><span id="l40.99" class="difflineplus">+  //  &quot;searchValN&quot; exposing the value on attribute &quot;value&quot;.</span>
<a href="#l40.100"></a><span id="l40.100" class="difflineplus">+  // XXX I am having real difficulty getting the click/type pair to actually</span>
<a href="#l40.101"></a><span id="l40.101" class="difflineplus">+  //  get the text in there reliably.  I am just going to poke things directly</span>
<a href="#l40.102"></a><span id="l40.102" class="difflineplus">+  //  into the text widget. (We used to use .aid instead of .a with swc.click</span>
<a href="#l40.103"></a><span id="l40.103" class="difflineplus">+  //  and swc.type.)</span>
<a href="#l40.104"></a><span id="l40.104" class="difflineplus">+  let searchVal0 = swc.a(&quot;searchVal0&quot;, {crazyDeck: 0});</span>
<a href="#l40.105"></a><span id="l40.105" class="difflineplus">+  searchVal0.value = &quot;foo&quot;;</span>
<a href="#l40.106"></a><span id="l40.106" class="difflineplus">+</span>
<a href="#l40.107"></a><span id="l40.107" class="difflineplus">+  // - add another subject box</span>
<a href="#l40.108"></a><span id="l40.108" class="difflineplus">+  let plusButton = swc.eid(&quot;searchRow0&quot;, {tagName: &quot;button&quot;, label: &quot;+&quot;});</span>
<a href="#l40.109"></a><span id="l40.109" class="difflineplus">+  swc.click(plusButton);</span>
<a href="#l40.110"></a><span id="l40.110" class="difflineplus">+</span>
<a href="#l40.111"></a><span id="l40.111" class="difflineplus">+  // - put &quot;bar&quot; in it</span>
<a href="#l40.112"></a><span id="l40.112" class="difflineplus">+  let searchVal1 = swc.a(&quot;searchVal1&quot;, {crazyDeck: 0});</span>
<a href="#l40.113"></a><span id="l40.113" class="difflineplus">+  searchVal1.value = &quot;bar&quot;;</span>
<a href="#l40.114"></a><span id="l40.114" class="difflineplus">+}</span>
<a href="#l40.115"></a><span id="l40.115" class="difflineplus">+</span>
<a href="#l40.116"></a><span id="l40.116" class="difflineplus">+/**</span>
<a href="#l40.117"></a><span id="l40.117" class="difflineplus">+ * Trigger the search, make sure the right results show up.</span>
<a href="#l40.118"></a><span id="l40.118" class="difflineplus">+ */</span>
<a href="#l40.119"></a><span id="l40.119" class="difflineplus">+function test_go_search() {</span>
<a href="#l40.120"></a><span id="l40.120" class="difflineplus">+  // - Trigger the search</span>
<a href="#l40.121"></a><span id="l40.121" class="difflineplus">+  // The &quot;Search&quot; button has id &quot;search-button&quot;</span>
<a href="#l40.122"></a><span id="l40.122" class="difflineplus">+  swc.click(swc.eid(&quot;search-button&quot;));</span>
<a href="#l40.123"></a><span id="l40.123" class="difflineplus">+  wait_for_all_messages_to_load(swc);</span>
<a href="#l40.124"></a><span id="l40.124" class="difflineplus">+</span>
<a href="#l40.125"></a><span id="l40.125" class="difflineplus">+  // - Verify we got the right messages</span>
<a href="#l40.126"></a><span id="l40.126" class="difflineplus">+  assert_messages_in_view(setFooBar, swc);</span>
<a href="#l40.127"></a><span id="l40.127" class="difflineplus">+</span>
<a href="#l40.128"></a><span id="l40.128" class="difflineplus">+  // - Click the &quot;Save as Search Folder&quot; button, id &quot;saveAsVFButton&quot;</span>
<a href="#l40.129"></a><span id="l40.129" class="difflineplus">+  // This will create a virtual folder properties dialog...</span>
<a href="#l40.130"></a><span id="l40.130" class="difflineplus">+  // (label: &quot;New Saved Search Folder&quot;, source: virtualFolderProperties.xul</span>
<a href="#l40.131"></a><span id="l40.131" class="difflineplus">+  //  no windowtype, id: &quot;virtualFolderPropertiesDialog&quot;)</span>
<a href="#l40.132"></a><span id="l40.132" class="difflineplus">+  plan_for_modal_dialog(&quot;mailnews:virtualFolderProperties&quot;,</span>
<a href="#l40.133"></a><span id="l40.133" class="difflineplus">+                        subtest_save_search);</span>
<a href="#l40.134"></a><span id="l40.134" class="difflineplus">+  swc.click(swc.eid(&quot;saveAsVFButton&quot;));</span>
<a href="#l40.135"></a><span id="l40.135" class="difflineplus">+  wait_for_modal_dialog(&quot;mailnews:virtualFolderProperties&quot;);</span>
<a href="#l40.136"></a><span id="l40.136" class="difflineplus">+}</span>
<a href="#l40.137"></a><span id="l40.137" class="difflineplus">+</span>
<a href="#l40.138"></a><span id="l40.138" class="difflineplus">+/**</span>
<a href="#l40.139"></a><span id="l40.139" class="difflineplus">+ * Save the search, making sure the constraints propagated.</span>
<a href="#l40.140"></a><span id="l40.140" class="difflineplus">+ */</span>
<a href="#l40.141"></a><span id="l40.141" class="difflineplus">+function subtest_save_search(savc) {</span>
<a href="#l40.142"></a><span id="l40.142" class="difflineplus">+  // - make sure our constraint propagated</span>
<a href="#l40.143"></a><span id="l40.143" class="difflineplus">+  // The query constraints are displayed using the same widgets (and code) that</span>
<a href="#l40.144"></a><span id="l40.144" class="difflineplus">+  //  we used to enter them, so it's very similar to check.</span>
<a href="#l40.145"></a><span id="l40.145" class="difflineplus">+  let searchVal0 = savc.aid(&quot;searchVal0&quot;, {crazyDeck: 0});</span>
<a href="#l40.146"></a><span id="l40.146" class="difflineplus">+  savc.assertNode(searchVal0);</span>
<a href="#l40.147"></a><span id="l40.147" class="difflineplus">+  savc.assertValue(searchVal0, &quot;foo&quot;);</span>
<a href="#l40.148"></a><span id="l40.148" class="difflineplus">+  let searchVal1 = savc.aid(&quot;searchVal1&quot;, {crazyDeck: 0});</span>
<a href="#l40.149"></a><span id="l40.149" class="difflineplus">+  savc.assertNode(searchVal1);</span>
<a href="#l40.150"></a><span id="l40.150" class="difflineplus">+  savc.assertValue(searchVal1, &quot;bar&quot;);</span>
<a href="#l40.151"></a><span id="l40.151" class="difflineplus">+</span>
<a href="#l40.152"></a><span id="l40.152" class="difflineplus">+  // - name the search</span>
<a href="#l40.153"></a><span id="l40.153" class="difflineplus">+  // I am having no luck with click/type on XUL things. workaround it.</span>
<a href="#l40.154"></a><span id="l40.154" class="difflineplus">+  savc.e(&quot;name&quot;).value = &quot;SearchSaved&quot;;</span>
<a href="#l40.155"></a><span id="l40.155" class="difflineplus">+  savc.window.doEnabling();</span>
<a href="#l40.156"></a><span id="l40.156" class="difflineplus">+</span>
<a href="#l40.157"></a><span id="l40.157" class="difflineplus">+  // - save it!</span>
<a href="#l40.158"></a><span id="l40.158" class="difflineplus">+  // this will close the dialog, which wait_for_modal_dialog is making sure</span>
<a href="#l40.159"></a><span id="l40.159" class="difflineplus">+  //  happens.</span>
<a href="#l40.160"></a><span id="l40.160" class="difflineplus">+  savc.window.onOK();</span>
<a href="#l40.161"></a><span id="l40.161" class="difflineplus">+}</span>
<a href="#l40.162"></a><span id="l40.162" class="difflineplus">+</span>
<a href="#l40.163"></a><span id="l40.163" class="difflineplus">+function test_close_search_window() {</span>
<a href="#l40.164"></a><span id="l40.164" class="difflineplus">+  // now close the search window</span>
<a href="#l40.165"></a><span id="l40.165" class="difflineplus">+  plan_for_window_close(swc);</span>
<a href="#l40.166"></a><span id="l40.166" class="difflineplus">+  swc.keypress(null, &quot;VK_ESCAPE&quot;, {});</span>
<a href="#l40.167"></a><span id="l40.167" class="difflineplus">+  wait_for_window_close(swc);</span>
<a href="#l40.168"></a><span id="l40.168" class="difflineplus">+  swc = null;</span>
<a href="#l40.169"></a><span id="l40.169" class="difflineplus">+}</span>
<a href="#l40.170"></a><span id="l40.170" class="difflineplus">+</span>
<a href="#l40.171"></a><span id="l40.171" class="difflineplus">+/**</span>
<a href="#l40.172"></a><span id="l40.172" class="difflineplus">+ * Make sure the folder showed up with the right name, and that displaying it</span>
<a href="#l40.173"></a><span id="l40.173" class="difflineplus">+ *  has the right contents.</span>
<a href="#l40.174"></a><span id="l40.174" class="difflineplus">+ */</span>
<a href="#l40.175"></a><span id="l40.175" class="difflineplus">+function test_verify_saved_search() {</span>
<a href="#l40.176"></a><span id="l40.176" class="difflineplus">+  let savedFolder = folder.findSubFolder(&quot;SearchSaved&quot;);</span>
<a href="#l40.177"></a><span id="l40.177" class="difflineplus">+  if (savedFolder == null)</span>
<a href="#l40.178"></a><span id="l40.178" class="difflineplus">+    throw new Error(&quot;Saved folder did not show up.&quot;);</span>
<a href="#l40.179"></a><span id="l40.179" class="difflineplus">+</span>
<a href="#l40.180"></a><span id="l40.180" class="difflineplus">+  be_in_folder(savedFolder);</span>
<a href="#l40.181"></a><span id="l40.181" class="difflineplus">+  assert_messages_in_view(setFooBar);</span>
<a href="#l40.182"></a><span id="l40.182" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1">new file mode 100644</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineminus">--- /dev/null</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-folder-display-helpers.js</span>
<a href="#l41.4"></a><span id="l41.4" class="difflineat">@@ -0,0 +1,998 @@</span>
<a href="#l41.5"></a><span id="l41.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l41.6"></a><span id="l41.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l41.7"></a><span id="l41.7" class="difflineplus">+ *</span>
<a href="#l41.8"></a><span id="l41.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l41.9"></a><span id="l41.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l41.10"></a><span id="l41.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l41.11"></a><span id="l41.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l41.12"></a><span id="l41.12" class="difflineplus">+ *</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l41.14"></a><span id="l41.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l41.15"></a><span id="l41.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l41.16"></a><span id="l41.16" class="difflineplus">+ * License.</span>
<a href="#l41.17"></a><span id="l41.17" class="difflineplus">+ *</span>
<a href="#l41.18"></a><span id="l41.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l41.19"></a><span id="l41.19" class="difflineplus">+ *</span>
<a href="#l41.20"></a><span id="l41.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l41.21"></a><span id="l41.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l41.22"></a><span id="l41.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l41.23"></a><span id="l41.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l41.24"></a><span id="l41.24" class="difflineplus">+ *</span>
<a href="#l41.25"></a><span id="l41.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l41.26"></a><span id="l41.26" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l41.27"></a><span id="l41.27" class="difflineplus">+ *</span>
<a href="#l41.28"></a><span id="l41.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l41.29"></a><span id="l41.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l41.30"></a><span id="l41.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l41.31"></a><span id="l41.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l41.32"></a><span id="l41.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l41.33"></a><span id="l41.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l41.34"></a><span id="l41.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l41.35"></a><span id="l41.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l41.36"></a><span id="l41.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l41.37"></a><span id="l41.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l41.38"></a><span id="l41.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l41.39"></a><span id="l41.39" class="difflineplus">+ *</span>
<a href="#l41.40"></a><span id="l41.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l41.41"></a><span id="l41.41" class="difflineplus">+</span>
<a href="#l41.42"></a><span id="l41.42" class="difflineplus">+const Ci = Components.interfaces;</span>
<a href="#l41.43"></a><span id="l41.43" class="difflineplus">+const Cc = Components.classes;</span>
<a href="#l41.44"></a><span id="l41.44" class="difflineplus">+const Cu = Components.utils;</span>
<a href="#l41.45"></a><span id="l41.45" class="difflineplus">+</span>
<a href="#l41.46"></a><span id="l41.46" class="difflineplus">+var elib = {};</span>
<a href="#l41.47"></a><span id="l41.47" class="difflineplus">+Cu.import('resource://mozmill/modules/elementslib.js', elib);</span>
<a href="#l41.48"></a><span id="l41.48" class="difflineplus">+var EventUtils = {};</span>
<a href="#l41.49"></a><span id="l41.49" class="difflineplus">+Cu.import('resource://mozmill/modules/EventUtils.js', EventUtils);</span>
<a href="#l41.50"></a><span id="l41.50" class="difflineplus">+var mozmill = {};</span>
<a href="#l41.51"></a><span id="l41.51" class="difflineplus">+Cu.import('resource://mozmill/modules/mozmill.js', mozmill);</span>
<a href="#l41.52"></a><span id="l41.52" class="difflineplus">+var controller = {};</span>
<a href="#l41.53"></a><span id="l41.53" class="difflineplus">+Cu.import('resource://mozmill/modules/controller.js', controller);</span>
<a href="#l41.54"></a><span id="l41.54" class="difflineplus">+var frame = {};</span>
<a href="#l41.55"></a><span id="l41.55" class="difflineplus">+Cu.import('resource://mozmill/modules/frame.js', frame);</span>
<a href="#l41.56"></a><span id="l41.56" class="difflineplus">+var os = {};</span>
<a href="#l41.57"></a><span id="l41.57" class="difflineplus">+Cu.import('resource://mozmill/stdlib/os.js', os);</span>
<a href="#l41.58"></a><span id="l41.58" class="difflineplus">+</span>
<a href="#l41.59"></a><span id="l41.59" class="difflineplus">+const MODULE_NAME = 'folder-display-helpers';</span>
<a href="#l41.60"></a><span id="l41.60" class="difflineplus">+</span>
<a href="#l41.61"></a><span id="l41.61" class="difflineplus">+const RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l41.62"></a><span id="l41.62" class="difflineplus">+// we need window-helpers for augment_controller</span>
<a href="#l41.63"></a><span id="l41.63" class="difflineplus">+const MODULES_REQUIRES = ['window-helpers'];</span>
<a href="#l41.64"></a><span id="l41.64" class="difflineplus">+</span>
<a href="#l41.65"></a><span id="l41.65" class="difflineplus">+const nsMsgViewIndex_None = 0xffffffff;</span>
<a href="#l41.66"></a><span id="l41.66" class="difflineplus">+</span>
<a href="#l41.67"></a><span id="l41.67" class="difflineplus">+</span>
<a href="#l41.68"></a><span id="l41.68" class="difflineplus">+const DO_NOT_EXPORT = {</span>
<a href="#l41.69"></a><span id="l41.69" class="difflineplus">+  // magic globals</span>
<a href="#l41.70"></a><span id="l41.70" class="difflineplus">+  MODULE_NAME: true, DO_NOT_EXPORT: true,</span>
<a href="#l41.71"></a><span id="l41.71" class="difflineplus">+  // imported modules</span>
<a href="#l41.72"></a><span id="l41.72" class="difflineplus">+  elib: true, mozmill: true, controller: true, frame: true, os: true,</span>
<a href="#l41.73"></a><span id="l41.73" class="difflineplus">+  // convenience constants</span>
<a href="#l41.74"></a><span id="l41.74" class="difflineplus">+  Ci: true, Cc: true, Cu: true, Cr: true,</span>
<a href="#l41.75"></a><span id="l41.75" class="difflineplus">+  // useful constants</span>
<a href="#l41.76"></a><span id="l41.76" class="difflineplus">+  nsMsgViewIndex_None: true,</span>
<a href="#l41.77"></a><span id="l41.77" class="difflineplus">+  // internal setup functions</span>
<a href="#l41.78"></a><span id="l41.78" class="difflineplus">+  setupModule: true, setupAccountStuff: true,</span>
<a href="#l41.79"></a><span id="l41.79" class="difflineplus">+  // internal setup flags</span>
<a href="#l41.80"></a><span id="l41.80" class="difflineplus">+  initialized: false,</span>
<a href="#l41.81"></a><span id="l41.81" class="difflineplus">+  // other libraries we use</span>
<a href="#l41.82"></a><span id="l41.82" class="difflineplus">+  windowHelper: true</span>
<a href="#l41.83"></a><span id="l41.83" class="difflineplus">+};</span>
<a href="#l41.84"></a><span id="l41.84" class="difflineplus">+</span>
<a href="#l41.85"></a><span id="l41.85" class="difflineplus">+var mainController = null;</span>
<a href="#l41.86"></a><span id="l41.86" class="difflineplus">+/** convenience shorthand for the mainController. */</span>
<a href="#l41.87"></a><span id="l41.87" class="difflineplus">+var mc;</span>
<a href="#l41.88"></a><span id="l41.88" class="difflineplus">+/** the index of the current 'other' tab */</span>
<a href="#l41.89"></a><span id="l41.89" class="difflineplus">+var otherTab;</span>
<a href="#l41.90"></a><span id="l41.90" class="difflineplus">+</span>
<a href="#l41.91"></a><span id="l41.91" class="difflineplus">+// These are pseudo-modules setup by setupModule:</span>
<a href="#l41.92"></a><span id="l41.92" class="difflineplus">+var messageGenerator;</span>
<a href="#l41.93"></a><span id="l41.93" class="difflineplus">+var messageModifier;</span>
<a href="#l41.94"></a><span id="l41.94" class="difflineplus">+var viewWrapperTestUtils;</span>
<a href="#l41.95"></a><span id="l41.95" class="difflineplus">+// (end pseudo-modules)</span>
<a href="#l41.96"></a><span id="l41.96" class="difflineplus">+</span>
<a href="#l41.97"></a><span id="l41.97" class="difflineplus">+var msgGen;</span>
<a href="#l41.98"></a><span id="l41.98" class="difflineplus">+</span>
<a href="#l41.99"></a><span id="l41.99" class="difflineplus">+var gLocalIncomingServer = null;</span>
<a href="#l41.100"></a><span id="l41.100" class="difflineplus">+var gLocalInboxFolder = null;</span>
<a href="#l41.101"></a><span id="l41.101" class="difflineplus">+</span>
<a href="#l41.102"></a><span id="l41.102" class="difflineplus">+var rootFolder = null;</span>
<a href="#l41.103"></a><span id="l41.103" class="difflineplus">+</span>
<a href="#l41.104"></a><span id="l41.104" class="difflineplus">+// the windowHelper module</span>
<a href="#l41.105"></a><span id="l41.105" class="difflineplus">+var windowHelper;</span>
<a href="#l41.106"></a><span id="l41.106" class="difflineplus">+</span>
<a href="#l41.107"></a><span id="l41.107" class="difflineplus">+var initialized = false;</span>
<a href="#l41.108"></a><span id="l41.108" class="difflineplus">+function setupModule() {</span>
<a href="#l41.109"></a><span id="l41.109" class="difflineplus">+  if (initialized)</span>
<a href="#l41.110"></a><span id="l41.110" class="difflineplus">+    return;</span>
<a href="#l41.111"></a><span id="l41.111" class="difflineplus">+  initialized = true;</span>
<a href="#l41.112"></a><span id="l41.112" class="difflineplus">+</span>
<a href="#l41.113"></a><span id="l41.113" class="difflineplus">+  // The xpcshell test resources assume they are loaded into a single global</span>
<a href="#l41.114"></a><span id="l41.114" class="difflineplus">+  //  namespace, so we need to help them out to maintain their delusion.</span>
<a href="#l41.115"></a><span id="l41.115" class="difflineplus">+  messageGenerator = load_via_src_path(</span>
<a href="#l41.116"></a><span id="l41.116" class="difflineplus">+    'mailnews/test/resources/messageGenerator.js');</span>
<a href="#l41.117"></a><span id="l41.117" class="difflineplus">+  messageModifier = load_via_src_path(</span>
<a href="#l41.118"></a><span id="l41.118" class="difflineplus">+    'mailnews/test/resources/messageModifier.js');</span>
<a href="#l41.119"></a><span id="l41.119" class="difflineplus">+  viewWrapperTestUtils = load_via_src_path(</span>
<a href="#l41.120"></a><span id="l41.120" class="difflineplus">+    'mailnews/test/resources/viewWrapperTestUtils.js');</span>
<a href="#l41.121"></a><span id="l41.121" class="difflineplus">+  // desired global types...</span>
<a href="#l41.122"></a><span id="l41.122" class="difflineplus">+  viewWrapperTestUtils.SyntheticMessageSet =</span>
<a href="#l41.123"></a><span id="l41.123" class="difflineplus">+    messageModifier.SyntheticMessageSet;</span>
<a href="#l41.124"></a><span id="l41.124" class="difflineplus">+  viewWrapperTestUtils.do_throw = function(aMsg) {</span>
<a href="#l41.125"></a><span id="l41.125" class="difflineplus">+    throw new Error(aMsg);</span>
<a href="#l41.126"></a><span id="l41.126" class="difflineplus">+  };</span>
<a href="#l41.127"></a><span id="l41.127" class="difflineplus">+  // viewWrapperTestUtils wants a gMessageGenerator (and so do we)</span>
<a href="#l41.128"></a><span id="l41.128" class="difflineplus">+  msgGen = new messageGenerator.MessageGenerator();</span>
<a href="#l41.129"></a><span id="l41.129" class="difflineplus">+  viewWrapperTestUtils.gMessageGenerator = msgGen;</span>
<a href="#l41.130"></a><span id="l41.130" class="difflineplus">+  make_new_sets_in_folders = make_new_sets_in_folder =</span>
<a href="#l41.131"></a><span id="l41.131" class="difflineplus">+    viewWrapperTestUtils.make_new_sets_in_folders;</span>
<a href="#l41.132"></a><span id="l41.132" class="difflineplus">+  viewWrapperTestUtils.Ci = Ci;</span>
<a href="#l41.133"></a><span id="l41.133" class="difflineplus">+  viewWrapperTestUtils.Cu = Cu;</span>
<a href="#l41.134"></a><span id="l41.134" class="difflineplus">+  viewWrapperTestUtils.Cc = Cc;</span>
<a href="#l41.135"></a><span id="l41.135" class="difflineplus">+</span>
<a href="#l41.136"></a><span id="l41.136" class="difflineplus">+  // use window-helper's augment_controller method to get our extra good stuff</span>
<a href="#l41.137"></a><span id="l41.137" class="difflineplus">+  //  we need.</span>
<a href="#l41.138"></a><span id="l41.138" class="difflineplus">+  windowHelper = collector.getModule('window-helpers');</span>
<a href="#l41.139"></a><span id="l41.139" class="difflineplus">+  mc = mainController = windowHelper.wait_for_existing_window(&quot;mail:3pane&quot;);</span>
<a href="#l41.140"></a><span id="l41.140" class="difflineplus">+  windowHelper.augment_controller(mc);</span>
<a href="#l41.141"></a><span id="l41.141" class="difflineplus">+</span>
<a href="#l41.142"></a><span id="l41.142" class="difflineplus">+  setupAccountStuff();</span>
<a href="#l41.143"></a><span id="l41.143" class="difflineplus">+}</span>
<a href="#l41.144"></a><span id="l41.144" class="difflineplus">+</span>
<a href="#l41.145"></a><span id="l41.145" class="difflineplus">+/**</span>
<a href="#l41.146"></a><span id="l41.146" class="difflineplus">+ * Install this module into the provided module.</span>
<a href="#l41.147"></a><span id="l41.147" class="difflineplus">+ */</span>
<a href="#l41.148"></a><span id="l41.148" class="difflineplus">+function installInto(module) {</span>
<a href="#l41.149"></a><span id="l41.149" class="difflineplus">+  setupModule();</span>
<a href="#l41.150"></a><span id="l41.150" class="difflineplus">+</span>
<a href="#l41.151"></a><span id="l41.151" class="difflineplus">+  // now copy everything into the module they provided to us...</span>
<a href="#l41.152"></a><span id="l41.152" class="difflineplus">+  let us = collector.getModule('folder-display-helpers');</span>
<a href="#l41.153"></a><span id="l41.153" class="difflineplus">+  for each (let [key, value] in Iterator(us)) {</span>
<a href="#l41.154"></a><span id="l41.154" class="difflineplus">+    if (!(key in DO_NOT_EXPORT) &amp;&amp;</span>
<a href="#l41.155"></a><span id="l41.155" class="difflineplus">+        key[0] != &quot;_&quot;)</span>
<a href="#l41.156"></a><span id="l41.156" class="difflineplus">+      module[key] = value;</span>
<a href="#l41.157"></a><span id="l41.157" class="difflineplus">+  }</span>
<a href="#l41.158"></a><span id="l41.158" class="difflineplus">+}</span>
<a href="#l41.159"></a><span id="l41.159" class="difflineplus">+</span>
<a href="#l41.160"></a><span id="l41.160" class="difflineplus">+function setupAccountStuff() {</span>
<a href="#l41.161"></a><span id="l41.161" class="difflineplus">+  // Create a local account to work with folders.</span>
<a href="#l41.162"></a><span id="l41.162" class="difflineplus">+  // (Note this gives you an Outbox and Trash folder by default).</span>
<a href="#l41.163"></a><span id="l41.163" class="difflineplus">+  let acctMgr = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l41.164"></a><span id="l41.164" class="difflineplus">+                          .getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l41.165"></a><span id="l41.165" class="difflineplus">+  //acctMgr.createLocalMailAccount();</span>
<a href="#l41.166"></a><span id="l41.166" class="difflineplus">+</span>
<a href="#l41.167"></a><span id="l41.167" class="difflineplus">+  gLocalIncomingServer = acctMgr.localFoldersServer;</span>
<a href="#l41.168"></a><span id="l41.168" class="difflineplus">+</span>
<a href="#l41.169"></a><span id="l41.169" class="difflineplus">+  rootFolder = gLocalIncomingServer.rootMsgFolder;</span>
<a href="#l41.170"></a><span id="l41.170" class="difflineplus">+  // Note: Inbox is not created automatically when there is no deferred server,</span>
<a href="#l41.171"></a><span id="l41.171" class="difflineplus">+  // so we need to create it.</span>
<a href="#l41.172"></a><span id="l41.172" class="difflineplus">+  gLocalInboxFolder = rootFolder.addSubfolder(&quot;Inbox&quot;);</span>
<a href="#l41.173"></a><span id="l41.173" class="difflineplus">+  // a local inbox should have a Mail flag!</span>
<a href="#l41.174"></a><span id="l41.174" class="difflineplus">+  gLocalInboxFolder.setFlag(Components.interfaces.nsMsgFolderFlags.Mail);</span>
<a href="#l41.175"></a><span id="l41.175" class="difflineplus">+</span>
<a href="#l41.176"></a><span id="l41.176" class="difflineplus">+  // Force an initialization of the Inbox folder database.</span>
<a href="#l41.177"></a><span id="l41.177" class="difflineplus">+  var folderName = gLocalInboxFolder.prettiestName;</span>
<a href="#l41.178"></a><span id="l41.178" class="difflineplus">+</span>
<a href="#l41.179"></a><span id="l41.179" class="difflineplus">+  gLocalInboxFolder = rootFolder.getChildNamed(&quot;Inbox&quot;);</span>
<a href="#l41.180"></a><span id="l41.180" class="difflineplus">+}</span>
<a href="#l41.181"></a><span id="l41.181" class="difflineplus">+</span>
<a href="#l41.182"></a><span id="l41.182" class="difflineplus">+/*</span>
<a href="#l41.183"></a><span id="l41.183" class="difflineplus">+ * Although we all agree that the use of generators when dealing with async</span>
<a href="#l41.184"></a><span id="l41.184" class="difflineplus">+ *  operations is awesome, the mozmill idiom is for calls to be synchronous and</span>
<a href="#l41.185"></a><span id="l41.185" class="difflineplus">+ *  just spin event loops when they need to wait for things to happen.  This</span>
<a href="#l41.186"></a><span id="l41.186" class="difflineplus">+ *  does make the test code significantly less confusing, so we do it too.</span>
<a href="#l41.187"></a><span id="l41.187" class="difflineplus">+ * All of our operations are synchronous and just spin until they are happy.</span>
<a href="#l41.188"></a><span id="l41.188" class="difflineplus">+ */</span>
<a href="#l41.189"></a><span id="l41.189" class="difflineplus">+</span>
<a href="#l41.190"></a><span id="l41.190" class="difflineplus">+const NORMAL_TIMEOUT = 6000;</span>
<a href="#l41.191"></a><span id="l41.191" class="difflineplus">+const FAST_INTERVAL = 100;</span>
<a href="#l41.192"></a><span id="l41.192" class="difflineplus">+</span>
<a href="#l41.193"></a><span id="l41.193" class="difflineplus">+/**</span>
<a href="#l41.194"></a><span id="l41.194" class="difflineplus">+ * Create a folder and rebuild the folder tree view.</span>
<a href="#l41.195"></a><span id="l41.195" class="difflineplus">+ */</span>
<a href="#l41.196"></a><span id="l41.196" class="difflineplus">+function create_folder(aFolderName) {</span>
<a href="#l41.197"></a><span id="l41.197" class="difflineplus">+  let folder = rootFolder.addSubfolder(aFolderName);</span>
<a href="#l41.198"></a><span id="l41.198" class="difflineplus">+  mc.folderTreeView.mode = &quot;all&quot;;</span>
<a href="#l41.199"></a><span id="l41.199" class="difflineplus">+  return folder;</span>
<a href="#l41.200"></a><span id="l41.200" class="difflineplus">+}</span>
<a href="#l41.201"></a><span id="l41.201" class="difflineplus">+</span>
<a href="#l41.202"></a><span id="l41.202" class="difflineplus">+/**</span>
<a href="#l41.203"></a><span id="l41.203" class="difflineplus">+ * Make sure we are entering the folder from not having been in the folder.  We</span>
<a href="#l41.204"></a><span id="l41.204" class="difflineplus">+ *  will leave the folder and come back if we have to.</span>
<a href="#l41.205"></a><span id="l41.205" class="difflineplus">+ */</span>
<a href="#l41.206"></a><span id="l41.206" class="difflineplus">+function enter_folder(aFolder) {</span>
<a href="#l41.207"></a><span id="l41.207" class="difflineplus">+  // if we're already selected, go back to the root...</span>
<a href="#l41.208"></a><span id="l41.208" class="difflineplus">+  if (mc.folderDisplay.displayedFolder == aFolder)</span>
<a href="#l41.209"></a><span id="l41.209" class="difflineplus">+    enter_folder(aFolder.rootFolder);</span>
<a href="#l41.210"></a><span id="l41.210" class="difflineplus">+</span>
<a href="#l41.211"></a><span id="l41.211" class="difflineplus">+  mc.folderTreeView.selectFolder(aFolder);</span>
<a href="#l41.212"></a><span id="l41.212" class="difflineplus">+  wait_for_all_messages_to_load();</span>
<a href="#l41.213"></a><span id="l41.213" class="difflineplus">+  // and drain the event queue</span>
<a href="#l41.214"></a><span id="l41.214" class="difflineplus">+  controller.sleep(0);</span>
<a href="#l41.215"></a><span id="l41.215" class="difflineplus">+}</span>
<a href="#l41.216"></a><span id="l41.216" class="difflineplus">+</span>
<a href="#l41.217"></a><span id="l41.217" class="difflineplus">+/**</span>
<a href="#l41.218"></a><span id="l41.218" class="difflineplus">+ * Make sure we are in the given folder, entering it if we were not.</span>
<a href="#l41.219"></a><span id="l41.219" class="difflineplus">+ *</span>
<a href="#l41.220"></a><span id="l41.220" class="difflineplus">+ * @return The tab info of the current tab (a more persistent identifier for</span>
<a href="#l41.221"></a><span id="l41.221" class="difflineplus">+ *     tabs than the index, which will change as tabs open/close).</span>
<a href="#l41.222"></a><span id="l41.222" class="difflineplus">+ */</span>
<a href="#l41.223"></a><span id="l41.223" class="difflineplus">+function be_in_folder(aFolder) {</span>
<a href="#l41.224"></a><span id="l41.224" class="difflineplus">+  if (mc.folderDisplay.displayedFolder != aFolder)</span>
<a href="#l41.225"></a><span id="l41.225" class="difflineplus">+    enter_folder(aFolder);</span>
<a href="#l41.226"></a><span id="l41.226" class="difflineplus">+  return mc.tabmail.currentTabInfo;</span>
<a href="#l41.227"></a><span id="l41.227" class="difflineplus">+}</span>
<a href="#l41.228"></a><span id="l41.228" class="difflineplus">+</span>
<a href="#l41.229"></a><span id="l41.229" class="difflineplus">+/**</span>
<a href="#l41.230"></a><span id="l41.230" class="difflineplus">+ * Create a new tab displaying a folder, making that tab the current tab.</span>
<a href="#l41.231"></a><span id="l41.231" class="difflineplus">+ *</span>
<a href="#l41.232"></a><span id="l41.232" class="difflineplus">+ * @return The tab info of the current tab (a more persistent identifier for</span>
<a href="#l41.233"></a><span id="l41.233" class="difflineplus">+ *     tabs than the index, which will change as tabs open/close).</span>
<a href="#l41.234"></a><span id="l41.234" class="difflineplus">+ */</span>
<a href="#l41.235"></a><span id="l41.235" class="difflineplus">+function open_folder_in_new_tab(aFolder) {</span>
<a href="#l41.236"></a><span id="l41.236" class="difflineplus">+  // save the current tab as the 'other' tab</span>
<a href="#l41.237"></a><span id="l41.237" class="difflineplus">+  otherTab = mc.tabmail.currentTabInfo;</span>
<a href="#l41.238"></a><span id="l41.238" class="difflineplus">+  mc.tabmail.openTab(&quot;folder&quot;, aFolder);</span>
<a href="#l41.239"></a><span id="l41.239" class="difflineplus">+  wait_for_all_messages_to_load();</span>
<a href="#l41.240"></a><span id="l41.240" class="difflineplus">+  return mc.tabmail.currentTabInfo;</span>
<a href="#l41.241"></a><span id="l41.241" class="difflineplus">+}</span>
<a href="#l41.242"></a><span id="l41.242" class="difflineplus">+</span>
<a href="#l41.243"></a><span id="l41.243" class="difflineplus">+/**</span>
<a href="#l41.244"></a><span id="l41.244" class="difflineplus">+ * Create a new tab displaying the currently selected message, making that tab</span>
<a href="#l41.245"></a><span id="l41.245" class="difflineplus">+ *  the current tab.  We block until the message finishes loading.</span>
<a href="#l41.246"></a><span id="l41.246" class="difflineplus">+ *</span>
<a href="#l41.247"></a><span id="l41.247" class="difflineplus">+ * @return The tab info of the current tab (a more persistent identifier for</span>
<a href="#l41.248"></a><span id="l41.248" class="difflineplus">+ *     tabs than the index, which will change as tabs open/close).</span>
<a href="#l41.249"></a><span id="l41.249" class="difflineplus">+ */</span>
<a href="#l41.250"></a><span id="l41.250" class="difflineplus">+function open_selected_message_in_new_tab() {</span>
<a href="#l41.251"></a><span id="l41.251" class="difflineplus">+  // get the current tab count so we can make sure the tab actually opened.</span>
<a href="#l41.252"></a><span id="l41.252" class="difflineplus">+  let preCount = mc.tabmail.tabContainer.childNodes.length;</span>
<a href="#l41.253"></a><span id="l41.253" class="difflineplus">+</span>
<a href="#l41.254"></a><span id="l41.254" class="difflineplus">+  // save the current tab as the 'other' tab</span>
<a href="#l41.255"></a><span id="l41.255" class="difflineplus">+  otherTab = mc.tabmail.currentTabInfo;</span>
<a href="#l41.256"></a><span id="l41.256" class="difflineplus">+</span>
<a href="#l41.257"></a><span id="l41.257" class="difflineplus">+  mc.window.MsgOpenNewTabForMessage();</span>
<a href="#l41.258"></a><span id="l41.258" class="difflineplus">+  wait_for_message_display_completion(mc, true);</span>
<a href="#l41.259"></a><span id="l41.259" class="difflineplus">+</span>
<a href="#l41.260"></a><span id="l41.260" class="difflineplus">+  // check that the tab count increased</span>
<a href="#l41.261"></a><span id="l41.261" class="difflineplus">+  if (mc.tabmail.tabContainer.childNodes.length != preCount + 1)</span>
<a href="#l41.262"></a><span id="l41.262" class="difflineplus">+    throw new Error(&quot;The tab never actually got opened!&quot;);</span>
<a href="#l41.263"></a><span id="l41.263" class="difflineplus">+</span>
<a href="#l41.264"></a><span id="l41.264" class="difflineplus">+  return mc.tabmail.currentTabInfo;</span>
<a href="#l41.265"></a><span id="l41.265" class="difflineplus">+}</span>
<a href="#l41.266"></a><span id="l41.266" class="difflineplus">+</span>
<a href="#l41.267"></a><span id="l41.267" class="difflineplus">+/**</span>
<a href="#l41.268"></a><span id="l41.268" class="difflineplus">+ * Create a new window displaying the currently selected message.  We do not</span>
<a href="#l41.269"></a><span id="l41.269" class="difflineplus">+ *  return until the message has finished loading.</span>
<a href="#l41.270"></a><span id="l41.270" class="difflineplus">+ *</span>
<a href="#l41.271"></a><span id="l41.271" class="difflineplus">+ * @return The MozmillController-wrapped new window.</span>
<a href="#l41.272"></a><span id="l41.272" class="difflineplus">+ */</span>
<a href="#l41.273"></a><span id="l41.273" class="difflineplus">+function open_selected_message_in_new_window() {</span>
<a href="#l41.274"></a><span id="l41.274" class="difflineplus">+  windowHelper.plan_for_new_window(&quot;mail:messageWindow&quot;);</span>
<a href="#l41.275"></a><span id="l41.275" class="difflineplus">+  mc.window.MsgOpenNewWindowForMessage();</span>
<a href="#l41.276"></a><span id="l41.276" class="difflineplus">+  let msgc = windowHelper.wait_for_new_window(&quot;mail:messageWindow&quot;);</span>
<a href="#l41.277"></a><span id="l41.277" class="difflineplus">+  wait_for_message_display_completion(msgc, true);</span>
<a href="#l41.278"></a><span id="l41.278" class="difflineplus">+  return msgc;</span>
<a href="#l41.279"></a><span id="l41.279" class="difflineplus">+}</span>
<a href="#l41.280"></a><span id="l41.280" class="difflineplus">+</span>
<a href="#l41.281"></a><span id="l41.281" class="difflineplus">+/**</span>
<a href="#l41.282"></a><span id="l41.282" class="difflineplus">+ * Switch to another tab.  If no tab is specified, we switch to the 'other' tab.</span>
<a href="#l41.283"></a><span id="l41.283" class="difflineplus">+ *  That is the last tab we used, most likely the tab that was current when we</span>
<a href="#l41.284"></a><span id="l41.284" class="difflineplus">+ *  created this tab.</span>
<a href="#l41.285"></a><span id="l41.285" class="difflineplus">+ *</span>
<a href="#l41.286"></a><span id="l41.286" class="difflineplus">+ * @param aNewTab Optional, index of the other tab to switch to.</span>
<a href="#l41.287"></a><span id="l41.287" class="difflineplus">+ */</span>
<a href="#l41.288"></a><span id="l41.288" class="difflineplus">+function switch_tab(aNewTab) {</span>
<a href="#l41.289"></a><span id="l41.289" class="difflineplus">+  let targetTab = (aNewTab != null) ? aNewTab : otherTab;</span>
<a href="#l41.290"></a><span id="l41.290" class="difflineplus">+  // now the current tab will be the 'other' tab after we switch</span>
<a href="#l41.291"></a><span id="l41.291" class="difflineplus">+  otherTab = mc.tabmail.currentTabInfo;</span>
<a href="#l41.292"></a><span id="l41.292" class="difflineplus">+  mc.tabmail.switchToTab(targetTab);</span>
<a href="#l41.293"></a><span id="l41.293" class="difflineplus">+  wait_for_message_display_completion();</span>
<a href="#l41.294"></a><span id="l41.294" class="difflineplus">+}</span>
<a href="#l41.295"></a><span id="l41.295" class="difflineplus">+</span>
<a href="#l41.296"></a><span id="l41.296" class="difflineplus">+/**</span>
<a href="#l41.297"></a><span id="l41.297" class="difflineplus">+ * Assert that the given tab's title is based on the provided folder or</span>
<a href="#l41.298"></a><span id="l41.298" class="difflineplus">+ *  message.</span>
<a href="#l41.299"></a><span id="l41.299" class="difflineplus">+ *</span>
<a href="#l41.300"></a><span id="l41.300" class="difflineplus">+ * @param aTab A Tab.</span>
<a href="#l41.301"></a><span id="l41.301" class="difflineplus">+ * @param aWhat Either an nsIMsgFolder or an nsIMsgDBHdr</span>
<a href="#l41.302"></a><span id="l41.302" class="difflineplus">+ */</span>
<a href="#l41.303"></a><span id="l41.303" class="difflineplus">+function assert_tab_titled_from(aTab, aWhat) {</span>
<a href="#l41.304"></a><span id="l41.304" class="difflineplus">+  let text;</span>
<a href="#l41.305"></a><span id="l41.305" class="difflineplus">+  if (aWhat instanceof Ci.nsIMsgFolder)</span>
<a href="#l41.306"></a><span id="l41.306" class="difflineplus">+    text = aWhat.prettiestName;</span>
<a href="#l41.307"></a><span id="l41.307" class="difflineplus">+  else if (aWhat instanceof Ci.nsIMsgDBHdr)</span>
<a href="#l41.308"></a><span id="l41.308" class="difflineplus">+    text = aWhat.mime2DecodedSubject;</span>
<a href="#l41.309"></a><span id="l41.309" class="difflineplus">+</span>
<a href="#l41.310"></a><span id="l41.310" class="difflineplus">+  if (aTab.title.indexOf(text) == -1)</span>
<a href="#l41.311"></a><span id="l41.311" class="difflineplus">+    throw new Error(&quot;Tab title should include '&quot; + text + &quot;' but does not.&quot; +</span>
<a href="#l41.312"></a><span id="l41.312" class="difflineplus">+                    &quot; (Current title: '&quot; + aTab.title + &quot;'&quot;);</span>
<a href="#l41.313"></a><span id="l41.313" class="difflineplus">+}</span>
<a href="#l41.314"></a><span id="l41.314" class="difflineplus">+</span>
<a href="#l41.315"></a><span id="l41.315" class="difflineplus">+/**</span>
<a href="#l41.316"></a><span id="l41.316" class="difflineplus">+ * Close a tab.  If no tab is specified, it is assumed you want to close the</span>
<a href="#l41.317"></a><span id="l41.317" class="difflineplus">+ *  current tab.</span>
<a href="#l41.318"></a><span id="l41.318" class="difflineplus">+ */</span>
<a href="#l41.319"></a><span id="l41.319" class="difflineplus">+function close_tab(aTabToClose) {</span>
<a href="#l41.320"></a><span id="l41.320" class="difflineplus">+  // get the current tab count so we can make sure the tab actually opened.</span>
<a href="#l41.321"></a><span id="l41.321" class="difflineplus">+  let preCount = mc.tabmail.tabContainer.childNodes.length;</span>
<a href="#l41.322"></a><span id="l41.322" class="difflineplus">+</span>
<a href="#l41.323"></a><span id="l41.323" class="difflineplus">+  mc.tabmail.closeTab(aTabToClose);</span>
<a href="#l41.324"></a><span id="l41.324" class="difflineplus">+  wait_for_message_display_completion();</span>
<a href="#l41.325"></a><span id="l41.325" class="difflineplus">+</span>
<a href="#l41.326"></a><span id="l41.326" class="difflineplus">+  // check that the tab count decreased</span>
<a href="#l41.327"></a><span id="l41.327" class="difflineplus">+  if (mc.tabmail.tabContainer.childNodes.length != preCount - 1)</span>
<a href="#l41.328"></a><span id="l41.328" class="difflineplus">+    throw new Error(&quot;The tab never actually got closed!&quot;);</span>
<a href="#l41.329"></a><span id="l41.329" class="difflineplus">+}</span>
<a href="#l41.330"></a><span id="l41.330" class="difflineplus">+</span>
<a href="#l41.331"></a><span id="l41.331" class="difflineplus">+/**</span>
<a href="#l41.332"></a><span id="l41.332" class="difflineplus">+ * Clear the selection.  I'm not sure how we're pretending we did that.</span>
<a href="#l41.333"></a><span id="l41.333" class="difflineplus">+ */</span>
<a href="#l41.334"></a><span id="l41.334" class="difflineplus">+function select_none() {</span>
<a href="#l41.335"></a><span id="l41.335" class="difflineplus">+  wait_for_message_display_completion();</span>
<a href="#l41.336"></a><span id="l41.336" class="difflineplus">+  mc.dbView.selection.clearSelection();</span>
<a href="#l41.337"></a><span id="l41.337" class="difflineplus">+  // give the event queue a chance to drain...</span>
<a href="#l41.338"></a><span id="l41.338" class="difflineplus">+  controller.sleep(0);</span>
<a href="#l41.339"></a><span id="l41.339" class="difflineplus">+}</span>
<a href="#l41.340"></a><span id="l41.340" class="difflineplus">+</span>
<a href="#l41.341"></a><span id="l41.341" class="difflineplus">+function _normalize_view_index(aViewIndex) {</span>
<a href="#l41.342"></a><span id="l41.342" class="difflineplus">+  if (aViewIndex &lt; 0)</span>
<a href="#l41.343"></a><span id="l41.343" class="difflineplus">+    return mc.dbView.QueryInterface(Ci.nsITreeView).rowCount + aViewIndex;</span>
<a href="#l41.344"></a><span id="l41.344" class="difflineplus">+  return aViewIndex;</span>
<a href="#l41.345"></a><span id="l41.345" class="difflineplus">+}</span>
<a href="#l41.346"></a><span id="l41.346" class="difflineplus">+</span>
<a href="#l41.347"></a><span id="l41.347" class="difflineplus">+/**</span>
<a href="#l41.348"></a><span id="l41.348" class="difflineplus">+ * Pretend we are click on a row with our mouse.</span>
<a href="#l41.349"></a><span id="l41.349" class="difflineplus">+ *</span>
<a href="#l41.350"></a><span id="l41.350" class="difflineplus">+ * @param aViewIndex If &gt;= 0, the view index provided, if &lt; 0, a reference to</span>
<a href="#l41.351"></a><span id="l41.351" class="difflineplus">+ *     a view index counting from the last row in the tree.  -1 indicates the</span>
<a href="#l41.352"></a><span id="l41.352" class="difflineplus">+ *     last message in the tree, -2 the second to last, etc.</span>
<a href="#l41.353"></a><span id="l41.353" class="difflineplus">+ *</span>
<a href="#l41.354"></a><span id="l41.354" class="difflineplus">+ * @return The message header selected.</span>
<a href="#l41.355"></a><span id="l41.355" class="difflineplus">+ */</span>
<a href="#l41.356"></a><span id="l41.356" class="difflineplus">+function select_click_row(aViewIndex) {</span>
<a href="#l41.357"></a><span id="l41.357" class="difflineplus">+  wait_for_message_display_completion();</span>
<a href="#l41.358"></a><span id="l41.358" class="difflineplus">+  aViewIndex = _normalize_view_index(aViewIndex);</span>
<a href="#l41.359"></a><span id="l41.359" class="difflineplus">+  // this should set the current index as well as setting the selection.</span>
<a href="#l41.360"></a><span id="l41.360" class="difflineplus">+  mc.dbView.selection.select(aViewIndex);</span>
<a href="#l41.361"></a><span id="l41.361" class="difflineplus">+  wait_for_message_display_completion(mc, true);</span>
<a href="#l41.362"></a><span id="l41.362" class="difflineplus">+  return mc.dbView.getMsgHdrAt(aViewIndex);</span>
<a href="#l41.363"></a><span id="l41.363" class="difflineplus">+}</span>
<a href="#l41.364"></a><span id="l41.364" class="difflineplus">+</span>
<a href="#l41.365"></a><span id="l41.365" class="difflineplus">+/**</span>
<a href="#l41.366"></a><span id="l41.366" class="difflineplus">+ * Pretend we are clicking on a row with our mouse with the control key pressed,</span>
<a href="#l41.367"></a><span id="l41.367" class="difflineplus">+ *  resulting in the addition/removal of just that row to/from the selection.</span>
<a href="#l41.368"></a><span id="l41.368" class="difflineplus">+ *</span>
<a href="#l41.369"></a><span id="l41.369" class="difflineplus">+ * @param aViewIndex If &gt;= 0, the view index provided, if &lt; 0, a reference to</span>
<a href="#l41.370"></a><span id="l41.370" class="difflineplus">+ *     a view index counting from the last row in the tree.  -1 indicates the</span>
<a href="#l41.371"></a><span id="l41.371" class="difflineplus">+ *     last message in the tree, -2 the second to last, etc.</span>
<a href="#l41.372"></a><span id="l41.372" class="difflineplus">+ *</span>
<a href="#l41.373"></a><span id="l41.373" class="difflineplus">+ * @return The message header of the affected message.</span>
<a href="#l41.374"></a><span id="l41.374" class="difflineplus">+ */</span>
<a href="#l41.375"></a><span id="l41.375" class="difflineplus">+function select_control_click_row(aViewIndex) {</span>
<a href="#l41.376"></a><span id="l41.376" class="difflineplus">+  wait_for_message_display_completion();</span>
<a href="#l41.377"></a><span id="l41.377" class="difflineplus">+  aViewIndex = _normalize_view_index(aViewIndex);</span>
<a href="#l41.378"></a><span id="l41.378" class="difflineplus">+  // Control-clicking augments the selection and moves the current index.  It</span>
<a href="#l41.379"></a><span id="l41.379" class="difflineplus">+  //  also clears the shift pivot, but that's fine as it falls back to the</span>
<a href="#l41.380"></a><span id="l41.380" class="difflineplus">+  //  current index if there is no shift pivot, which works for duplicating</span>
<a href="#l41.381"></a><span id="l41.381" class="difflineplus">+  //  actual behavior.</span>
<a href="#l41.382"></a><span id="l41.382" class="difflineplus">+  mc.dbView.selection.rangedSelect(aViewIndex, aViewIndex, true);</span>
<a href="#l41.383"></a><span id="l41.383" class="difflineplus">+  mc.dbView.selection.currentIndex = aViewIndex;</span>
<a href="#l41.384"></a><span id="l41.384" class="difflineplus">+  // give the event queue a chance to drain...</span>
<a href="#l41.385"></a><span id="l41.385" class="difflineplus">+  controller.sleep(0);</span>
<a href="#l41.386"></a><span id="l41.386" class="difflineplus">+  wait_for_message_display_completion();</span>
<a href="#l41.387"></a><span id="l41.387" class="difflineplus">+  return mc.dbView.getMsgHdrAt(aViewIndex);</span>
<a href="#l41.388"></a><span id="l41.388" class="difflineplus">+}</span>
<a href="#l41.389"></a><span id="l41.389" class="difflineplus">+</span>
<a href="#l41.390"></a><span id="l41.390" class="difflineplus">+/**</span>
<a href="#l41.391"></a><span id="l41.391" class="difflineplus">+ * Pretend we are clicking on a row with our mouse with the shift key pressed,</span>
<a href="#l41.392"></a><span id="l41.392" class="difflineplus">+ *  adding all the messages between the shift pivot and the shift selected row.</span>
<a href="#l41.393"></a><span id="l41.393" class="difflineplus">+ *</span>
<a href="#l41.394"></a><span id="l41.394" class="difflineplus">+ * @param aViewIndex If &gt;= 0, the view index provided, if &lt; 0, a reference to</span>
<a href="#l41.395"></a><span id="l41.395" class="difflineplus">+ *     a view index counting from the last row in the tree.  -1 indicates the</span>
<a href="#l41.396"></a><span id="l41.396" class="difflineplus">+ *     last message in the tree, -2 the second to last, etc.</span>
<a href="#l41.397"></a><span id="l41.397" class="difflineplus">+ *</span>
<a href="#l41.398"></a><span id="l41.398" class="difflineplus">+ * @return The message headers for all messages that are now selected.</span>
<a href="#l41.399"></a><span id="l41.399" class="difflineplus">+ */</span>
<a href="#l41.400"></a><span id="l41.400" class="difflineplus">+function select_shift_click_row(aViewIndex) {</span>
<a href="#l41.401"></a><span id="l41.401" class="difflineplus">+  wait_for_message_display_completion();</span>
<a href="#l41.402"></a><span id="l41.402" class="difflineplus">+  aViewIndex = _normalize_view_index(aViewIndex);</span>
<a href="#l41.403"></a><span id="l41.403" class="difflineplus">+  // Passing -1 as the start range checks the shift-pivot, which should be -1,</span>
<a href="#l41.404"></a><span id="l41.404" class="difflineplus">+  //  so it should fall over to the current index, which is what we want.  It</span>
<a href="#l41.405"></a><span id="l41.405" class="difflineplus">+  //  will then set the shift-pivot to the previously-current-index and update</span>
<a href="#l41.406"></a><span id="l41.406" class="difflineplus">+  //  the current index to be what we shift-clicked on.  All matches user</span>
<a href="#l41.407"></a><span id="l41.407" class="difflineplus">+  //  interaction.</span>
<a href="#l41.408"></a><span id="l41.408" class="difflineplus">+  mc.dbView.selection.rangedSelect(-1, aViewIndex, false);</span>
<a href="#l41.409"></a><span id="l41.409" class="difflineplus">+  // give the event queue a chance to drain...</span>
<a href="#l41.410"></a><span id="l41.410" class="difflineplus">+  controller.sleep(0);</span>
<a href="#l41.411"></a><span id="l41.411" class="difflineplus">+  wait_for_message_display_completion();</span>
<a href="#l41.412"></a><span id="l41.412" class="difflineplus">+  return mc.folderDisplay.selectedMessages;</span>
<a href="#l41.413"></a><span id="l41.413" class="difflineplus">+}</span>
<a href="#l41.414"></a><span id="l41.414" class="difflineplus">+</span>
<a href="#l41.415"></a><span id="l41.415" class="difflineplus">+/**</span>
<a href="#l41.416"></a><span id="l41.416" class="difflineplus">+ * Helper function to click on a row with a given button.</span>
<a href="#l41.417"></a><span id="l41.417" class="difflineplus">+ */</span>
<a href="#l41.418"></a><span id="l41.418" class="difflineplus">+function _row_click_helper(aViewIndex, aButton) {</span>
<a href="#l41.419"></a><span id="l41.419" class="difflineplus">+  let treeBox = mc.threadTree.treeBoxObject;</span>
<a href="#l41.420"></a><span id="l41.420" class="difflineplus">+  // very important, gotta be able to see the row</span>
<a href="#l41.421"></a><span id="l41.421" class="difflineplus">+  treeBox.ensureRowIsVisible(aViewIndex);</span>
<a href="#l41.422"></a><span id="l41.422" class="difflineplus">+  // now figure out the coords</span>
<a href="#l41.423"></a><span id="l41.423" class="difflineplus">+  let children = mc.e(&quot;threadTree&quot;, {tagName: &quot;treechildren&quot;});</span>
<a href="#l41.424"></a><span id="l41.424" class="difflineplus">+  let x = children.boxObject.x;</span>
<a href="#l41.425"></a><span id="l41.425" class="difflineplus">+  let y = children.boxObject.y;</span>
<a href="#l41.426"></a><span id="l41.426" class="difflineplus">+  let rowX = 10;</span>
<a href="#l41.427"></a><span id="l41.427" class="difflineplus">+  let rowY = treeBox.rowHeight * (aViewIndex - treeBox.getFirstVisibleRow());</span>
<a href="#l41.428"></a><span id="l41.428" class="difflineplus">+  if (treeBox.getRowAt(x + rowX, y + rowY) != aViewIndex) {</span>
<a href="#l41.429"></a><span id="l41.429" class="difflineplus">+    throw new Error(&quot;Thought we would find row &quot; + aViewIndex + &quot; at &quot; +</span>
<a href="#l41.430"></a><span id="l41.430" class="difflineplus">+                    rowX + &quot;,&quot; + rowY + &quot; but we found &quot; +</span>
<a href="#l41.431"></a><span id="l41.431" class="difflineplus">+                    treeBox.getRowAt(rowX, rowY));</span>
<a href="#l41.432"></a><span id="l41.432" class="difflineplus">+  }</span>
<a href="#l41.433"></a><span id="l41.433" class="difflineplus">+  let tx = mc.threadTree.boxObject.x;</span>
<a href="#l41.434"></a><span id="l41.434" class="difflineplus">+  let ty = mc.threadTree.boxObject.y;</span>
<a href="#l41.435"></a><span id="l41.435" class="difflineplus">+  EventUtils.synthesizeMouse(mc.threadTree, x + rowX - tx, y + rowY - ty,</span>
<a href="#l41.436"></a><span id="l41.436" class="difflineplus">+                             {type: &quot;mousedown&quot;, button: aButton}, mc.window);</span>
<a href="#l41.437"></a><span id="l41.437" class="difflineplus">+  if (aButton == 2)</span>
<a href="#l41.438"></a><span id="l41.438" class="difflineplus">+    EventUtils.synthesizeMouse(mc.threadTree, x + rowX - tx, y + rowY - ty,</span>
<a href="#l41.439"></a><span id="l41.439" class="difflineplus">+                               {type: &quot;contextmenu&quot;, button: aButton},</span>
<a href="#l41.440"></a><span id="l41.440" class="difflineplus">+                               mc.window);</span>
<a href="#l41.441"></a><span id="l41.441" class="difflineplus">+  EventUtils.synthesizeMouse(mc.threadTree, x + rowX - tx, y + rowY - ty,</span>
<a href="#l41.442"></a><span id="l41.442" class="difflineplus">+                             {type: &quot;mouseup&quot;, button: aButton}, mc.window);</span>
<a href="#l41.443"></a><span id="l41.443" class="difflineplus">+}</span>
<a href="#l41.444"></a><span id="l41.444" class="difflineplus">+</span>
<a href="#l41.445"></a><span id="l41.445" class="difflineplus">+/**</span>
<a href="#l41.446"></a><span id="l41.446" class="difflineplus">+ * Right-click on the tree-view in question.  With any luck, this will have</span>
<a href="#l41.447"></a><span id="l41.447" class="difflineplus">+ *  the side-effect of opening up a pop-up which it is then on _your_ head</span>
<a href="#l41.448"></a><span id="l41.448" class="difflineplus">+ *  to do something with or close.  However, we have helpful popup function</span>
<a href="#l41.449"></a><span id="l41.449" class="difflineplus">+ *  helpers because I'm so nice.</span>
<a href="#l41.450"></a><span id="l41.450" class="difflineplus">+ *</span>
<a href="#l41.451"></a><span id="l41.451" class="difflineplus">+ * @return The message header that you clicked on.</span>
<a href="#l41.452"></a><span id="l41.452" class="difflineplus">+ */</span>
<a href="#l41.453"></a><span id="l41.453" class="difflineplus">+function right_click_on_row(aViewIndex) {</span>
<a href="#l41.454"></a><span id="l41.454" class="difflineplus">+  let msgHdr = mc.dbView.getMsgHdrAt(aViewIndex);</span>
<a href="#l41.455"></a><span id="l41.455" class="difflineplus">+  _row_click_helper(aViewIndex, 2);</span>
<a href="#l41.456"></a><span id="l41.456" class="difflineplus">+  return msgHdr;</span>
<a href="#l41.457"></a><span id="l41.457" class="difflineplus">+}</span>
<a href="#l41.458"></a><span id="l41.458" class="difflineplus">+</span>
<a href="#l41.459"></a><span id="l41.459" class="difflineplus">+/**</span>
<a href="#l41.460"></a><span id="l41.460" class="difflineplus">+ * Middle-click on the tree-view in question, presumably opening a new message</span>
<a href="#l41.461"></a><span id="l41.461" class="difflineplus">+ *  tab.</span>
<a href="#l41.462"></a><span id="l41.462" class="difflineplus">+ *</span>
<a href="#l41.463"></a><span id="l41.463" class="difflineplus">+ * @return [The new tab, the message that you clicked on.]</span>
<a href="#l41.464"></a><span id="l41.464" class="difflineplus">+ */</span>
<a href="#l41.465"></a><span id="l41.465" class="difflineplus">+function middle_click_on_row(aViewIndex) {</span>
<a href="#l41.466"></a><span id="l41.466" class="difflineplus">+  let msgHdr = mc.dbView.getMsgHdrAt(aViewIndex);</span>
<a href="#l41.467"></a><span id="l41.467" class="difflineplus">+  _row_click_helper(aViewIndex, 1);</span>
<a href="#l41.468"></a><span id="l41.468" class="difflineplus">+  return [mc.tabmail.currentTabInfo, msgHdr];</span>
<a href="#l41.469"></a><span id="l41.469" class="difflineplus">+}</span>
<a href="#l41.470"></a><span id="l41.470" class="difflineplus">+</span>
<a href="#l41.471"></a><span id="l41.471" class="difflineplus">+/**</span>
<a href="#l41.472"></a><span id="l41.472" class="difflineplus">+ * Assuming the context popup is popped-up (via right_click_on_row), select</span>
<a href="#l41.473"></a><span id="l41.473" class="difflineplus">+ *  the deletion option.  If the popup is not popped up, you are out of luck.</span>
<a href="#l41.474"></a><span id="l41.474" class="difflineplus">+ */</span>
<a href="#l41.475"></a><span id="l41.475" class="difflineplus">+function delete_via_popup() {</span>
<a href="#l41.476"></a><span id="l41.476" class="difflineplus">+  plan_to_wait_for_folder_events(&quot;DeleteOrMoveMsgCompleted&quot;,</span>
<a href="#l41.477"></a><span id="l41.477" class="difflineplus">+                                 &quot;DeleteOrMoveMsgFailed&quot;);</span>
<a href="#l41.478"></a><span id="l41.478" class="difflineplus">+  mc.click(mc.eid(&quot;mailContext-delete&quot;));</span>
<a href="#l41.479"></a><span id="l41.479" class="difflineplus">+  // for reasons unknown, the pop-up does not close itself?</span>
<a href="#l41.480"></a><span id="l41.480" class="difflineplus">+  close_popup();</span>
<a href="#l41.481"></a><span id="l41.481" class="difflineplus">+  wait_for_folder_events();</span>
<a href="#l41.482"></a><span id="l41.482" class="difflineplus">+}</span>
<a href="#l41.483"></a><span id="l41.483" class="difflineplus">+</span>
<a href="#l41.484"></a><span id="l41.484" class="difflineplus">+/**</span>
<a href="#l41.485"></a><span id="l41.485" class="difflineplus">+ * Close the open pop-up.</span>
<a href="#l41.486"></a><span id="l41.486" class="difflineplus">+ */</span>
<a href="#l41.487"></a><span id="l41.487" class="difflineplus">+function close_popup(aController) {</span>
<a href="#l41.488"></a><span id="l41.488" class="difflineplus">+  if (aController === undefined)</span>
<a href="#l41.489"></a><span id="l41.489" class="difflineplus">+    aController = mc;</span>
<a href="#l41.490"></a><span id="l41.490" class="difflineplus">+  aController.keypress(aController.eid(&quot;mailContext&quot;), &quot;VK_ESCAPE&quot;, {});</span>
<a href="#l41.491"></a><span id="l41.491" class="difflineplus">+  // drain event queue</span>
<a href="#l41.492"></a><span id="l41.492" class="difflineplus">+  aController.sleep(0);</span>
<a href="#l41.493"></a><span id="l41.493" class="difflineplus">+}</span>
<a href="#l41.494"></a><span id="l41.494" class="difflineplus">+</span>
<a href="#l41.495"></a><span id="l41.495" class="difflineplus">+/**</span>
<a href="#l41.496"></a><span id="l41.496" class="difflineplus">+ * Pretend we are pressing the delete key, triggering message deletion of the</span>
<a href="#l41.497"></a><span id="l41.497" class="difflineplus">+ *  selected messages.</span>
<a href="#l41.498"></a><span id="l41.498" class="difflineplus">+ *</span>
<a href="#l41.499"></a><span id="l41.499" class="difflineplus">+ * @param aController The controller in whose context to do this, defaults to</span>
<a href="#l41.500"></a><span id="l41.500" class="difflineplus">+ *     |mc| if omitted.</span>
<a href="#l41.501"></a><span id="l41.501" class="difflineplus">+ */</span>
<a href="#l41.502"></a><span id="l41.502" class="difflineplus">+function press_delete(aController) {</span>
<a href="#l41.503"></a><span id="l41.503" class="difflineplus">+  if (aController === undefined)</span>
<a href="#l41.504"></a><span id="l41.504" class="difflineplus">+    aController = mc;</span>
<a href="#l41.505"></a><span id="l41.505" class="difflineplus">+  // if something is loading, make sure it finishes loading...</span>
<a href="#l41.506"></a><span id="l41.506" class="difflineplus">+  wait_for_message_display_completion(aController);</span>
<a href="#l41.507"></a><span id="l41.507" class="difflineplus">+  plan_to_wait_for_folder_events(&quot;DeleteOrMoveMsgCompleted&quot;,</span>
<a href="#l41.508"></a><span id="l41.508" class="difflineplus">+                                 &quot;DeleteOrMoveMsgFailed&quot;);</span>
<a href="#l41.509"></a><span id="l41.509" class="difflineplus">+  aController.keypress(aController == mc ? mc.eThreadTree : null,</span>
<a href="#l41.510"></a><span id="l41.510" class="difflineplus">+                       &quot;VK_DELETE&quot;, {});</span>
<a href="#l41.511"></a><span id="l41.511" class="difflineplus">+  wait_for_folder_events();</span>
<a href="#l41.512"></a><span id="l41.512" class="difflineplus">+}</span>
<a href="#l41.513"></a><span id="l41.513" class="difflineplus">+</span>
<a href="#l41.514"></a><span id="l41.514" class="difflineplus">+/**</span>
<a href="#l41.515"></a><span id="l41.515" class="difflineplus">+ * Wait for the |folderDisplay| on aController (defaults to mc if omitted) to</span>
<a href="#l41.516"></a><span id="l41.516" class="difflineplus">+ *  finish loading.  This generally only matters for folders that have an active</span>
<a href="#l41.517"></a><span id="l41.517" class="difflineplus">+ *  search.</span>
<a href="#l41.518"></a><span id="l41.518" class="difflineplus">+ * This method is generally called automatically most of the time, and you</span>
<a href="#l41.519"></a><span id="l41.519" class="difflineplus">+ *  should not need to call it yourself unless you are operating outside the</span>
<a href="#l41.520"></a><span id="l41.520" class="difflineplus">+ *  helper methods in this file.</span>
<a href="#l41.521"></a><span id="l41.521" class="difflineplus">+ */</span>
<a href="#l41.522"></a><span id="l41.522" class="difflineplus">+function wait_for_all_messages_to_load(aController) {</span>
<a href="#l41.523"></a><span id="l41.523" class="difflineplus">+  if (aController === undefined)</span>
<a href="#l41.524"></a><span id="l41.524" class="difflineplus">+    aController = mc;</span>
<a href="#l41.525"></a><span id="l41.525" class="difflineplus">+  if (aController.allMessagesLoaded) {</span>
<a href="#l41.526"></a><span id="l41.526" class="difflineplus">+    // even though we're taking the fast-path out, let's give the event loop a</span>
<a href="#l41.527"></a><span id="l41.527" class="difflineplus">+    //  chance to drain.</span>
<a href="#l41.528"></a><span id="l41.528" class="difflineplus">+    aController.sleep(0);</span>
<a href="#l41.529"></a><span id="l41.529" class="difflineplus">+    return;</span>
<a href="#l41.530"></a><span id="l41.530" class="difflineplus">+  }</span>
<a href="#l41.531"></a><span id="l41.531" class="difflineplus">+  if(!controller.waitForEval('subject.allMessagesLoaded', NORMAL_TIMEOUT,</span>
<a href="#l41.532"></a><span id="l41.532" class="difflineplus">+                              FAST_INTERVAL, aController.folderDisplay))</span>
<a href="#l41.533"></a><span id="l41.533" class="difflineplus">+    throw new Error(&quot;Messages never finished loading.  Timed Out.&quot;);</span>
<a href="#l41.534"></a><span id="l41.534" class="difflineplus">+  // the above may return immediately, meaning the event queue might not get a</span>
<a href="#l41.535"></a><span id="l41.535" class="difflineplus">+  //  chance.  give it a chance now.</span>
<a href="#l41.536"></a><span id="l41.536" class="difflineplus">+  aController.sleep(0);</span>
<a href="#l41.537"></a><span id="l41.537" class="difflineplus">+}</span>
<a href="#l41.538"></a><span id="l41.538" class="difflineplus">+</span>
<a href="#l41.539"></a><span id="l41.539" class="difflineplus">+/**</span>
<a href="#l41.540"></a><span id="l41.540" class="difflineplus">+ * If  a message is in the process of loading, let it finish.  Otherwise we get</span>
<a href="#l41.541"></a><span id="l41.541" class="difflineplus">+ *  horrible assertions like so:</span>
<a href="#l41.542"></a><span id="l41.542" class="difflineplus">+ * ###!!! ASSERTION: Overwriting an existing document channel!</span>
<a href="#l41.543"></a><span id="l41.543" class="difflineplus">+ *</span>
<a href="#l41.544"></a><span id="l41.544" class="difflineplus">+ * @param aController optional controller, defaulting to |mc|.</span>
<a href="#l41.545"></a><span id="l41.545" class="difflineplus">+ * @param aLoadDemanded optional indication that we expect and demand that a</span>
<a href="#l41.546"></a><span id="l41.546" class="difflineplus">+ *     message be loaded.  If you call us before the message loading is</span>
<a href="#l41.547"></a><span id="l41.547" class="difflineplus">+ *     initiated, you will need to pass true for this so that we don't see</span>
<a href="#l41.548"></a><span id="l41.548" class="difflineplus">+ *     that a load hasn't started and assume none is required.  Defaults to</span>
<a href="#l41.549"></a><span id="l41.549" class="difflineplus">+ *     false.</span>
<a href="#l41.550"></a><span id="l41.550" class="difflineplus">+ */</span>
<a href="#l41.551"></a><span id="l41.551" class="difflineplus">+function wait_for_message_display_completion(aController, aLoadDemanded) {</span>
<a href="#l41.552"></a><span id="l41.552" class="difflineplus">+  if (aController === undefined)</span>
<a href="#l41.553"></a><span id="l41.553" class="difflineplus">+    aController = mc;</span>
<a href="#l41.554"></a><span id="l41.554" class="difflineplus">+  if ((!aLoadDemanded &amp;&amp; !aController.messageDisplay.messageLoading) ||</span>
<a href="#l41.555"></a><span id="l41.555" class="difflineplus">+      aController.messageDisplay.messageLoaded) {</span>
<a href="#l41.556"></a><span id="l41.556" class="difflineplus">+    // even though we're taking the fast-path out, let's give the event loop a</span>
<a href="#l41.557"></a><span id="l41.557" class="difflineplus">+    //  chance to drain.</span>
<a href="#l41.558"></a><span id="l41.558" class="difflineplus">+    aController.sleep(0);</span>
<a href="#l41.559"></a><span id="l41.559" class="difflineplus">+    return;</span>
<a href="#l41.560"></a><span id="l41.560" class="difflineplus">+  }</span>
<a href="#l41.561"></a><span id="l41.561" class="difflineplus">+  controller.waitForEval('subject.messageLoaded', NORMAL_TIMEOUT,</span>
<a href="#l41.562"></a><span id="l41.562" class="difflineplus">+                         FAST_INTERVAL, aController.messageDisplay);</span>
<a href="#l41.563"></a><span id="l41.563" class="difflineplus">+  // the above may return immediately, meaning the event queue might not get a</span>
<a href="#l41.564"></a><span id="l41.564" class="difflineplus">+  //  chance.  give it a chance now.</span>
<a href="#l41.565"></a><span id="l41.565" class="difflineplus">+  aController.sleep(0);</span>
<a href="#l41.566"></a><span id="l41.566" class="difflineplus">+}</span>
<a href="#l41.567"></a><span id="l41.567" class="difflineplus">+</span>
<a href="#l41.568"></a><span id="l41.568" class="difflineplus">+</span>
<a href="#l41.569"></a><span id="l41.569" class="difflineplus">+var FolderListener = {</span>
<a href="#l41.570"></a><span id="l41.570" class="difflineplus">+  _inited: false,</span>
<a href="#l41.571"></a><span id="l41.571" class="difflineplus">+  ensureInited: function() {</span>
<a href="#l41.572"></a><span id="l41.572" class="difflineplus">+    if (this._inited)</span>
<a href="#l41.573"></a><span id="l41.573" class="difflineplus">+      return;</span>
<a href="#l41.574"></a><span id="l41.574" class="difflineplus">+</span>
<a href="#l41.575"></a><span id="l41.575" class="difflineplus">+    let mailSession =</span>
<a href="#l41.576"></a><span id="l41.576" class="difflineplus">+      Cc[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l41.577"></a><span id="l41.577" class="difflineplus">+        .getService(Ci.nsIMsgMailSession);</span>
<a href="#l41.578"></a><span id="l41.578" class="difflineplus">+    mailSession.AddFolderListener(this,</span>
<a href="#l41.579"></a><span id="l41.579" class="difflineplus">+                                  Ci.nsIFolderListener.event);</span>
<a href="#l41.580"></a><span id="l41.580" class="difflineplus">+</span>
<a href="#l41.581"></a><span id="l41.581" class="difflineplus">+    this._inited = true;</span>
<a href="#l41.582"></a><span id="l41.582" class="difflineplus">+  },</span>
<a href="#l41.583"></a><span id="l41.583" class="difflineplus">+</span>
<a href="#l41.584"></a><span id="l41.584" class="difflineplus">+  sawEvents: false,</span>
<a href="#l41.585"></a><span id="l41.585" class="difflineplus">+  watchingFor: null,</span>
<a href="#l41.586"></a><span id="l41.586" class="difflineplus">+  planToWaitFor: function FolderListener_planToWaitFor() {</span>
<a href="#l41.587"></a><span id="l41.587" class="difflineplus">+    this.sawEvents = false;</span>
<a href="#l41.588"></a><span id="l41.588" class="difflineplus">+    this.watchingFor = [];</span>
<a href="#l41.589"></a><span id="l41.589" class="difflineplus">+    for (let i = 0; i &lt; arguments.length; i++)</span>
<a href="#l41.590"></a><span id="l41.590" class="difflineplus">+      this.watchingFor[i] = arguments[i];</span>
<a href="#l41.591"></a><span id="l41.591" class="difflineplus">+  },</span>
<a href="#l41.592"></a><span id="l41.592" class="difflineplus">+  waitForEvents: function FolderListener_waitForEvents() {</span>
<a href="#l41.593"></a><span id="l41.593" class="difflineplus">+    if (this.sawEvents)</span>
<a href="#l41.594"></a><span id="l41.594" class="difflineplus">+      return;</span>
<a href="#l41.595"></a><span id="l41.595" class="difflineplus">+    controller.waitForEval('subject.sawEvents', NORMAL_TIMEOUT,</span>
<a href="#l41.596"></a><span id="l41.596" class="difflineplus">+                           FAST_INTERVAL, this);</span>
<a href="#l41.597"></a><span id="l41.597" class="difflineplus">+  },</span>
<a href="#l41.598"></a><span id="l41.598" class="difflineplus">+</span>
<a href="#l41.599"></a><span id="l41.599" class="difflineplus">+  OnItemEvent: function FolderNotificationHelper_OnItemEvent(</span>
<a href="#l41.600"></a><span id="l41.600" class="difflineplus">+      aFolder, aEvent) {</span>
<a href="#l41.601"></a><span id="l41.601" class="difflineplus">+    if (!this.watchingFor)</span>
<a href="#l41.602"></a><span id="l41.602" class="difflineplus">+      return;</span>
<a href="#l41.603"></a><span id="l41.603" class="difflineplus">+    if (this.watchingFor.indexOf(aEvent.toString()) != -1) {</span>
<a href="#l41.604"></a><span id="l41.604" class="difflineplus">+      this.watchingFor = null;</span>
<a href="#l41.605"></a><span id="l41.605" class="difflineplus">+      this.sawEvents = true;</span>
<a href="#l41.606"></a><span id="l41.606" class="difflineplus">+    }</span>
<a href="#l41.607"></a><span id="l41.607" class="difflineplus">+  },</span>
<a href="#l41.608"></a><span id="l41.608" class="difflineplus">+};</span>
<a href="#l41.609"></a><span id="l41.609" class="difflineplus">+</span>
<a href="#l41.610"></a><span id="l41.610" class="difflineplus">+/**</span>
<a href="#l41.611"></a><span id="l41.611" class="difflineplus">+ * Plan to wait for an nsIFolderListener.OnItemEvent matching one of the</span>
<a href="#l41.612"></a><span id="l41.612" class="difflineplus">+ *  provided strings.  Call this before you do the thing that triggers the</span>
<a href="#l41.613"></a><span id="l41.613" class="difflineplus">+ *  event, then call |wait_for_folder_events| after the event.  This ensures</span>
<a href="#l41.614"></a><span id="l41.614" class="difflineplus">+ *  that we see the event, because it might be too late after you initiate</span>
<a href="#l41.615"></a><span id="l41.615" class="difflineplus">+ *  the thing that would generate the event.</span>
<a href="#l41.616"></a><span id="l41.616" class="difflineplus">+ * For example, plan_to_wait_for_folder_events(&quot;DeleteOrMoveMsgCompleted&quot;,</span>
<a href="#l41.617"></a><span id="l41.617" class="difflineplus">+ *  &quot;DeleteOrMoveMsgFailed&quot;) waits for a deletion completion notification</span>
<a href="#l41.618"></a><span id="l41.618" class="difflineplus">+ *  when you call |wait_for_folder_events|.</span>
<a href="#l41.619"></a><span id="l41.619" class="difflineplus">+ * The waiting is currently un-scoped, so the event happening on any folder</span>
<a href="#l41.620"></a><span id="l41.620" class="difflineplus">+ *  triggers us.  It is expected that you won't try and have multiple events</span>
<a href="#l41.621"></a><span id="l41.621" class="difflineplus">+ *  in-flight or will augment us when the time comes to have to deal with that.</span>
<a href="#l41.622"></a><span id="l41.622" class="difflineplus">+ */</span>
<a href="#l41.623"></a><span id="l41.623" class="difflineplus">+function plan_to_wait_for_folder_events() {</span>
<a href="#l41.624"></a><span id="l41.624" class="difflineplus">+  FolderListener.ensureInited();</span>
<a href="#l41.625"></a><span id="l41.625" class="difflineplus">+  FolderListener.planToWaitFor.apply(FolderListener, arguments);</span>
<a href="#l41.626"></a><span id="l41.626" class="difflineplus">+}</span>
<a href="#l41.627"></a><span id="l41.627" class="difflineplus">+function wait_for_folder_events() {</span>
<a href="#l41.628"></a><span id="l41.628" class="difflineplus">+  FolderListener.waitForEvents();</span>
<a href="#l41.629"></a><span id="l41.629" class="difflineplus">+}</span>
<a href="#l41.630"></a><span id="l41.630" class="difflineplus">+</span>
<a href="#l41.631"></a><span id="l41.631" class="difflineplus">+/**</span>
<a href="#l41.632"></a><span id="l41.632" class="difflineplus">+ * Assert that the given synthetic message sets are present in the folder</span>
<a href="#l41.633"></a><span id="l41.633" class="difflineplus">+ *  display.</span>
<a href="#l41.634"></a><span id="l41.634" class="difflineplus">+ *</span>
<a href="#l41.635"></a><span id="l41.635" class="difflineplus">+ * @param aSynSets Either a single SyntheticMessageSet or a list of them.</span>
<a href="#l41.636"></a><span id="l41.636" class="difflineplus">+ * @param aController Optional controller, which we get the folderDisplay</span>
<a href="#l41.637"></a><span id="l41.637" class="difflineplus">+ *     property from.  If omitted, we use the mc (mainController).</span>
<a href="#l41.638"></a><span id="l41.638" class="difflineplus">+ */</span>
<a href="#l41.639"></a><span id="l41.639" class="difflineplus">+function assert_messages_in_view(aSynSets, aController) {</span>
<a href="#l41.640"></a><span id="l41.640" class="difflineplus">+  if (aController === undefined)</span>
<a href="#l41.641"></a><span id="l41.641" class="difflineplus">+    aController = mc;</span>
<a href="#l41.642"></a><span id="l41.642" class="difflineplus">+  viewWrapperTestUtils.verify_messages_in_view(aSynSets,</span>
<a href="#l41.643"></a><span id="l41.643" class="difflineplus">+                                               aController.folderDisplay.view);</span>
<a href="#l41.644"></a><span id="l41.644" class="difflineplus">+}</span>
<a href="#l41.645"></a><span id="l41.645" class="difflineplus">+</span>
<a href="#l41.646"></a><span id="l41.646" class="difflineplus">+/**</span>
<a href="#l41.647"></a><span id="l41.647" class="difflineplus">+ * Assert the the given message/messages are not present in the view.</span>
<a href="#l41.648"></a><span id="l41.648" class="difflineplus">+ * @param aMessages Either a single nsIMsgDBHdr or a list of them.</span>
<a href="#l41.649"></a><span id="l41.649" class="difflineplus">+ */</span>
<a href="#l41.650"></a><span id="l41.650" class="difflineplus">+function assert_messages_not_in_view(aMessages, aController) {</span>
<a href="#l41.651"></a><span id="l41.651" class="difflineplus">+  if (aController === undefined)</span>
<a href="#l41.652"></a><span id="l41.652" class="difflineplus">+    aController = mc;</span>
<a href="#l41.653"></a><span id="l41.653" class="difflineplus">+  if (aMessages instanceof Ci.nsIMsgDBHdr)</span>
<a href="#l41.654"></a><span id="l41.654" class="difflineplus">+    aMessages = [aMessages];</span>
<a href="#l41.655"></a><span id="l41.655" class="difflineplus">+  for each (let [, msgHdr] in Iterator(aMessages)) {</span>
<a href="#l41.656"></a><span id="l41.656" class="difflineplus">+    if (mc.dbView.findIndexOfMsgHdr(msgHdr, true) != nsMsgViewIndex_None)</span>
<a href="#l41.657"></a><span id="l41.657" class="difflineplus">+      throw new Error(&quot;Message header is present in view but should not be: &quot; +</span>
<a href="#l41.658"></a><span id="l41.658" class="difflineplus">+                       msgHdr.mime2DecodedSubject + &quot; index: &quot; +</span>
<a href="#l41.659"></a><span id="l41.659" class="difflineplus">+                       mc.dbView.findIndexOfMsgHdr(msgHdr, true));</span>
<a href="#l41.660"></a><span id="l41.660" class="difflineplus">+  }</span>
<a href="#l41.661"></a><span id="l41.661" class="difflineplus">+}</span>
<a href="#l41.662"></a><span id="l41.662" class="difflineplus">+var assert_message_not_in_view = assert_messages_not_in_view;</span>
<a href="#l41.663"></a><span id="l41.663" class="difflineplus">+</span>
<a href="#l41.664"></a><span id="l41.664" class="difflineplus">+/**</span>
<a href="#l41.665"></a><span id="l41.665" class="difflineplus">+ * Helper function for use by assert_selected / assert_selected_and_displayed /</span>
<a href="#l41.666"></a><span id="l41.666" class="difflineplus">+ *  assert_displayed.</span>
<a href="#l41.667"></a><span id="l41.667" class="difflineplus">+ */</span>
<a href="#l41.668"></a><span id="l41.668" class="difflineplus">+function _process_row_message_arguments() {</span>
<a href="#l41.669"></a><span id="l41.669" class="difflineplus">+  let troller = mc;</span>
<a href="#l41.670"></a><span id="l41.670" class="difflineplus">+  // - normalize into desired selected view indices</span>
<a href="#l41.671"></a><span id="l41.671" class="difflineplus">+  let desiredIndices = [];</span>
<a href="#l41.672"></a><span id="l41.672" class="difflineplus">+  for (let iArg = 0; iArg &lt; arguments.length; iArg++) {</span>
<a href="#l41.673"></a><span id="l41.673" class="difflineplus">+    let arg = arguments[iArg];</span>
<a href="#l41.674"></a><span id="l41.674" class="difflineplus">+    // An integer identifying a view index</span>
<a href="#l41.675"></a><span id="l41.675" class="difflineplus">+    if (typeof(arg) == &quot;number&quot;) {</span>
<a href="#l41.676"></a><span id="l41.676" class="difflineplus">+      desiredIndices.push(_normalize_view_index(arg));</span>
<a href="#l41.677"></a><span id="l41.677" class="difflineplus">+    }</span>
<a href="#l41.678"></a><span id="l41.678" class="difflineplus">+    // A message header</span>
<a href="#l41.679"></a><span id="l41.679" class="difflineplus">+    else if (arg instanceof Ci.nsIMsgDBHdr) {</span>
<a href="#l41.680"></a><span id="l41.680" class="difflineplus">+      // do not expand; the thing should already be selected, eg expanded!</span>
<a href="#l41.681"></a><span id="l41.681" class="difflineplus">+      let viewIndex = troller.dbView.findIndexOfMsgHdr(arg, false);</span>
<a href="#l41.682"></a><span id="l41.682" class="difflineplus">+      if (viewIndex == nsMsgViewIndex_None)</span>
<a href="#l41.683"></a><span id="l41.683" class="difflineplus">+        throw_and_dump_view_state(</span>
<a href="#l41.684"></a><span id="l41.684" class="difflineplus">+          &quot;Message not present in view that should be there. &quot; +</span>
<a href="#l41.685"></a><span id="l41.685" class="difflineplus">+            &quot;(&quot; + arg.messageKey + &quot;: &quot; + arg.mime2DecodedSubject + &quot;)&quot;);</span>
<a href="#l41.686"></a><span id="l41.686" class="difflineplus">+      desiredIndices.push(viewIndex);</span>
<a href="#l41.687"></a><span id="l41.687" class="difflineplus">+    }</span>
<a href="#l41.688"></a><span id="l41.688" class="difflineplus">+    // A list containing two integers, indicating a range of view indices.</span>
<a href="#l41.689"></a><span id="l41.689" class="difflineplus">+    else if (arg.length == 2 &amp;&amp; typeof(arg[0]) == &quot;number&quot;) {</span>
<a href="#l41.690"></a><span id="l41.690" class="difflineplus">+      let lowIndex = _normalize_view_index(arg[0]);</span>
<a href="#l41.691"></a><span id="l41.691" class="difflineplus">+      let highIndex = _normalize_view_index(arg[1]);</span>
<a href="#l41.692"></a><span id="l41.692" class="difflineplus">+      for (let viewIndex = lowIndex; viewIndex &lt;= highIndex; viewIndex++)</span>
<a href="#l41.693"></a><span id="l41.693" class="difflineplus">+        desiredIndices.push(viewIndex);</span>
<a href="#l41.694"></a><span id="l41.694" class="difflineplus">+    }</span>
<a href="#l41.695"></a><span id="l41.695" class="difflineplus">+    // a List of message headers</span>
<a href="#l41.696"></a><span id="l41.696" class="difflineplus">+    else if (arg.length !== undefined) {</span>
<a href="#l41.697"></a><span id="l41.697" class="difflineplus">+      for (let iMsg = 0; iMsg &lt; arg.length; iMsg++) {</span>
<a href="#l41.698"></a><span id="l41.698" class="difflineplus">+        let msgHdr = arg[iMsg].QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l41.699"></a><span id="l41.699" class="difflineplus">+        if (!msgHdr)</span>
<a href="#l41.700"></a><span id="l41.700" class="difflineplus">+          throw new Error(arg[iMsg] + &quot; is not a message header!&quot;);</span>
<a href="#l41.701"></a><span id="l41.701" class="difflineplus">+        // false means do not expand, it should already be selected</span>
<a href="#l41.702"></a><span id="l41.702" class="difflineplus">+        let viewIndex = troller.dbView.findIndexOfMsgHdr(msgHdr, false);</span>
<a href="#l41.703"></a><span id="l41.703" class="difflineplus">+        if (viewIndex == nsMsgViewIndex_None)</span>
<a href="#l41.704"></a><span id="l41.704" class="difflineplus">+          throw new Error(&quot;Message not present in view that should be there.&quot;);</span>
<a href="#l41.705"></a><span id="l41.705" class="difflineplus">+        desiredIndices.push(viewIndex);</span>
<a href="#l41.706"></a><span id="l41.706" class="difflineplus">+      }</span>
<a href="#l41.707"></a><span id="l41.707" class="difflineplus">+    }</span>
<a href="#l41.708"></a><span id="l41.708" class="difflineplus">+    // it's a MozmillController</span>
<a href="#l41.709"></a><span id="l41.709" class="difflineplus">+    else if (arg.window) {</span>
<a href="#l41.710"></a><span id="l41.710" class="difflineplus">+      troller = arg;</span>
<a href="#l41.711"></a><span id="l41.711" class="difflineplus">+    }</span>
<a href="#l41.712"></a><span id="l41.712" class="difflineplus">+    else {</span>
<a href="#l41.713"></a><span id="l41.713" class="difflineplus">+      throw new Error(&quot;Illegal argument: &quot; + arg);</span>
<a href="#l41.714"></a><span id="l41.714" class="difflineplus">+    }</span>
<a href="#l41.715"></a><span id="l41.715" class="difflineplus">+  }</span>
<a href="#l41.716"></a><span id="l41.716" class="difflineplus">+  // sort by integer value</span>
<a href="#l41.717"></a><span id="l41.717" class="difflineplus">+  desiredIndices.sort(function (a, b) { return a - b;} );</span>
<a href="#l41.718"></a><span id="l41.718" class="difflineplus">+</span>
<a href="#l41.719"></a><span id="l41.719" class="difflineplus">+  return [troller, desiredIndices];</span>
<a href="#l41.720"></a><span id="l41.720" class="difflineplus">+}</span>
<a href="#l41.721"></a><span id="l41.721" class="difflineplus">+</span>
<a href="#l41.722"></a><span id="l41.722" class="difflineplus">+/**</span>
<a href="#l41.723"></a><span id="l41.723" class="difflineplus">+ * Asserts that the given set of messages are selected.  Unless you are dealing</span>
<a href="#l41.724"></a><span id="l41.724" class="difflineplus">+ *  with transient selections resulting from right-clicks, you want to be using</span>
<a href="#l41.725"></a><span id="l41.725" class="difflineplus">+ *  assert_selected_and_displayed because it makes sure that the display is</span>
<a href="#l41.726"></a><span id="l41.726" class="difflineplus">+ *  correct too.</span>
<a href="#l41.727"></a><span id="l41.727" class="difflineplus">+ *</span>
<a href="#l41.728"></a><span id="l41.728" class="difflineplus">+ * The arguments consist of one or more of the following:</span>
<a href="#l41.729"></a><span id="l41.729" class="difflineplus">+ * - A MozmillController, indicating we should use that controller instead of</span>
<a href="#l41.730"></a><span id="l41.730" class="difflineplus">+ *   the default, &quot;mc&quot; (corresponding to the 3pane.)  Pass this first!</span>
<a href="#l41.731"></a><span id="l41.731" class="difflineplus">+ * - An integer identifying a view index.</span>
<a href="#l41.732"></a><span id="l41.732" class="difflineplus">+ * - A list containing two integers, indicating a range of view indices.</span>
<a href="#l41.733"></a><span id="l41.733" class="difflineplus">+ * - A message header.</span>
<a href="#l41.734"></a><span id="l41.734" class="difflineplus">+ * - A list of message headers.</span>
<a href="#l41.735"></a><span id="l41.735" class="difflineplus">+ */</span>
<a href="#l41.736"></a><span id="l41.736" class="difflineplus">+function assert_selected() {</span>
<a href="#l41.737"></a><span id="l41.737" class="difflineplus">+  let [troller, desiredIndices] =</span>
<a href="#l41.738"></a><span id="l41.738" class="difflineplus">+    _process_row_message_arguments.apply(this, arguments);</span>
<a href="#l41.739"></a><span id="l41.739" class="difflineplus">+</span>
<a href="#l41.740"></a><span id="l41.740" class="difflineplus">+  // - get the actual selection (already sorted by integer value)</span>
<a href="#l41.741"></a><span id="l41.741" class="difflineplus">+  let selectedIndices = troller.folderDisplay.selectedIndices;</span>
<a href="#l41.742"></a><span id="l41.742" class="difflineplus">+  // - test selection equivalence</span>
<a href="#l41.743"></a><span id="l41.743" class="difflineplus">+  // which is the same as string equivalence in this case. muah hah hah.</span>
<a href="#l41.744"></a><span id="l41.744" class="difflineplus">+  if (desiredIndices.toString() != selectedIndices.toString())</span>
<a href="#l41.745"></a><span id="l41.745" class="difflineplus">+    throw new Error(&quot;Desired selection is: &quot; + desiredIndices + &quot; but actual &quot; +</span>
<a href="#l41.746"></a><span id="l41.746" class="difflineplus">+                    &quot;selection is: &quot; + selectedIndices);</span>
<a href="#l41.747"></a><span id="l41.747" class="difflineplus">+</span>
<a href="#l41.748"></a><span id="l41.748" class="difflineplus">+  return [troller, desiredIndices];</span>
<a href="#l41.749"></a><span id="l41.749" class="difflineplus">+}</span>
<a href="#l41.750"></a><span id="l41.750" class="difflineplus">+</span>
<a href="#l41.751"></a><span id="l41.751" class="difflineplus">+</span>
<a href="#l41.752"></a><span id="l41.752" class="difflineplus">+/**</span>
<a href="#l41.753"></a><span id="l41.753" class="difflineplus">+ * Assert that the given set of messages is displayed, but not necessarily</span>
<a href="#l41.754"></a><span id="l41.754" class="difflineplus">+ *  selected.  Unless you are dealing with transient selection issues or some</span>
<a href="#l41.755"></a><span id="l41.755" class="difflineplus">+ *  other situation where the FolderDisplay should not be correlated with the</span>
<a href="#l41.756"></a><span id="l41.756" class="difflineplus">+ *  MessageDisplay, you really should be using assert_selected_and_displayed.</span>
<a href="#l41.757"></a><span id="l41.757" class="difflineplus">+ *</span>
<a href="#l41.758"></a><span id="l41.758" class="difflineplus">+ * The arguments consist of one or more of the following:</span>
<a href="#l41.759"></a><span id="l41.759" class="difflineplus">+ * - A MozmillController, indicating we should use that controller instead of</span>
<a href="#l41.760"></a><span id="l41.760" class="difflineplus">+ *   the default, &quot;mc&quot; (corresponding to the 3pane.)  Pass this first!</span>
<a href="#l41.761"></a><span id="l41.761" class="difflineplus">+ * - An integer identifying a view index.</span>
<a href="#l41.762"></a><span id="l41.762" class="difflineplus">+ * - A list containing two integers, indicating a range of view indices.</span>
<a href="#l41.763"></a><span id="l41.763" class="difflineplus">+ * - A message header.</span>
<a href="#l41.764"></a><span id="l41.764" class="difflineplus">+ * - A list of message headers.</span>
<a href="#l41.765"></a><span id="l41.765" class="difflineplus">+ */</span>
<a href="#l41.766"></a><span id="l41.766" class="difflineplus">+function assert_displayed() {</span>
<a href="#l41.767"></a><span id="l41.767" class="difflineplus">+  let [troller, desiredIndices] =</span>
<a href="#l41.768"></a><span id="l41.768" class="difflineplus">+    _process_row_message_arguments.apply(this, arguments);</span>
<a href="#l41.769"></a><span id="l41.769" class="difflineplus">+  _internal_assert_displayed(false, troller, desiredIndices);</span>
<a href="#l41.770"></a><span id="l41.770" class="difflineplus">+}</span>
<a href="#l41.771"></a><span id="l41.771" class="difflineplus">+</span>
<a href="#l41.772"></a><span id="l41.772" class="difflineplus">+/**</span>
<a href="#l41.773"></a><span id="l41.773" class="difflineplus">+ * Assert-that-the-display-is-right logic.  We need an internal version so that</span>
<a href="#l41.774"></a><span id="l41.774" class="difflineplus">+ *  we can know whether we can trust/assert that folderDisplay.selectedMessage</span>
<a href="#l41.775"></a><span id="l41.775" class="difflineplus">+ *  agrees with messageDisplay, and also so that we don't have to re-compute</span>
<a href="#l41.776"></a><span id="l41.776" class="difflineplus">+ *  troller and desiredIndices.</span>
<a href="#l41.777"></a><span id="l41.777" class="difflineplus">+ */</span>
<a href="#l41.778"></a><span id="l41.778" class="difflineplus">+function _internal_assert_displayed(trustSelection, troller, desiredIndices) {</span>
<a href="#l41.779"></a><span id="l41.779" class="difflineplus">+  // - verify that the right thing is being displayed.</span>
<a href="#l41.780"></a><span id="l41.780" class="difflineplus">+  // no selection means folder summary.</span>
<a href="#l41.781"></a><span id="l41.781" class="difflineplus">+  if (desiredIndices.length == 0) {</span>
<a href="#l41.782"></a><span id="l41.782" class="difflineplus">+    // folder summary is not landed yet, just verify there is no message.</span>
<a href="#l41.783"></a><span id="l41.783" class="difflineplus">+    if (troller.messageDisplay.displayedMessage != null)</span>
<a href="#l41.784"></a><span id="l41.784" class="difflineplus">+      throw new Error(&quot;Message display should not think it is displaying a &quot; +</span>
<a href="#l41.785"></a><span id="l41.785" class="difflineplus">+                      &quot;message.&quot;);</span>
<a href="#l41.786"></a><span id="l41.786" class="difflineplus">+    // make sure the content pane is pointed at about:blank</span>
<a href="#l41.787"></a><span id="l41.787" class="difflineplus">+    if (troller.window.content.location.href != &quot;about:blank&quot;) {</span>
<a href="#l41.788"></a><span id="l41.788" class="difflineplus">+      throw new Error(&quot;the content pane should be blank, but is showing: '&quot; +</span>
<a href="#l41.789"></a><span id="l41.789" class="difflineplus">+                      troller.window.content.location.href + &quot;'&quot;);</span>
<a href="#l41.790"></a><span id="l41.790" class="difflineplus">+    }</span>
<a href="#l41.791"></a><span id="l41.791" class="difflineplus">+  }</span>
<a href="#l41.792"></a><span id="l41.792" class="difflineplus">+  // 1 means the message should be displayed</span>
<a href="#l41.793"></a><span id="l41.793" class="difflineplus">+  else if (desiredIndices.length == 1) {</span>
<a href="#l41.794"></a><span id="l41.794" class="difflineplus">+    // make sure message display thinks we are in single message display mode</span>
<a href="#l41.795"></a><span id="l41.795" class="difflineplus">+    if (!troller.messageDisplay.singleMessageDisplay)</span>
<a href="#l41.796"></a><span id="l41.796" class="difflineplus">+      throw new Error(&quot;Message display is not in single message display mode.&quot;);</span>
<a href="#l41.797"></a><span id="l41.797" class="difflineplus">+    // now make sure that we actually are in single message display mode</span>
<a href="#l41.798"></a><span id="l41.798" class="difflineplus">+    let singleMessagePane = troller.e(&quot;singlemessage&quot;);</span>
<a href="#l41.799"></a><span id="l41.799" class="difflineplus">+    let multiMessagePane = troller.e(&quot;multimessage&quot;);</span>
<a href="#l41.800"></a><span id="l41.800" class="difflineplus">+    if (singleMessagePane &amp;&amp; singleMessagePane.hidden)</span>
<a href="#l41.801"></a><span id="l41.801" class="difflineplus">+      throw new Error(&quot;Single message pane is hidden but it should not be.&quot;);</span>
<a href="#l41.802"></a><span id="l41.802" class="difflineplus">+    if (multiMessagePane &amp;&amp; !multiMessagePane.hidden)</span>
<a href="#l41.803"></a><span id="l41.803" class="difflineplus">+      throw new Error(&quot;Multiple message pane is visible but it should not be.&quot;);</span>
<a href="#l41.804"></a><span id="l41.804" class="difflineplus">+</span>
<a href="#l41.805"></a><span id="l41.805" class="difflineplus">+    if (trustSelection) {</span>
<a href="#l41.806"></a><span id="l41.806" class="difflineplus">+      if (troller.folderDisplay.selectedMessage !=</span>
<a href="#l41.807"></a><span id="l41.807" class="difflineplus">+          troller.messageDisplay.displayedMessage)</span>
<a href="#l41.808"></a><span id="l41.808" class="difflineplus">+        throw new Error(&quot;folderDisplay.selectedMessage != &quot; +</span>
<a href="#l41.809"></a><span id="l41.809" class="difflineplus">+                        &quot;messageDisplay.displayedMessage! (fd: &quot; +</span>
<a href="#l41.810"></a><span id="l41.810" class="difflineplus">+                        troller.folderDisplay.selectedMessage + &quot; vs md: &quot; +</span>
<a href="#l41.811"></a><span id="l41.811" class="difflineplus">+                        troller.messageDisplay.displayedMessage + &quot;)&quot;);</span>
<a href="#l41.812"></a><span id="l41.812" class="difflineplus">+    }</span>
<a href="#l41.813"></a><span id="l41.813" class="difflineplus">+</span>
<a href="#l41.814"></a><span id="l41.814" class="difflineplus">+    let msgHdr = troller.messageDisplay.displayedMessage;</span>
<a href="#l41.815"></a><span id="l41.815" class="difflineplus">+    let msgUri = msgHdr.folder.getUriForMsg(msgHdr);</span>
<a href="#l41.816"></a><span id="l41.816" class="difflineplus">+    // wait for the document to load so that we don't try and replace it later</span>
<a href="#l41.817"></a><span id="l41.817" class="difflineplus">+    //  and get that stupid assertion</span>
<a href="#l41.818"></a><span id="l41.818" class="difflineplus">+    wait_for_message_display_completion();</span>
<a href="#l41.819"></a><span id="l41.819" class="difflineplus">+    // make sure the content pane is pointed at the right thing</span>
<a href="#l41.820"></a><span id="l41.820" class="difflineplus">+</span>
<a href="#l41.821"></a><span id="l41.821" class="difflineplus">+    let msgService =</span>
<a href="#l41.822"></a><span id="l41.822" class="difflineplus">+      troller.folderDisplay.messenger.messageServiceFromURI(msgUri);</span>
<a href="#l41.823"></a><span id="l41.823" class="difflineplus">+    let msgUrlObj = {};</span>
<a href="#l41.824"></a><span id="l41.824" class="difflineplus">+    msgService.GetUrlForUri(msgUri, msgUrlObj, troller.folderDisplay.msgWindow);</span>
<a href="#l41.825"></a><span id="l41.825" class="difflineplus">+    let msgUrl = msgUrlObj.value;</span>
<a href="#l41.826"></a><span id="l41.826" class="difflineplus">+    if (troller.window.content.location.href != msgUrl.spec)</span>
<a href="#l41.827"></a><span id="l41.827" class="difflineplus">+      throw new Error(&quot;The content pane is not displaying the right message! &quot; +</span>
<a href="#l41.828"></a><span id="l41.828" class="difflineplus">+                      &quot;Should be: &quot; + msgUrl.spec + &quot; but it's: &quot; +</span>
<a href="#l41.829"></a><span id="l41.829" class="difflineplus">+                      troller.window.content.location.href);</span>
<a href="#l41.830"></a><span id="l41.830" class="difflineplus">+  }</span>
<a href="#l41.831"></a><span id="l41.831" class="difflineplus">+  // multiple means some form of multi-message summary</span>
<a href="#l41.832"></a><span id="l41.832" class="difflineplus">+  else {</span>
<a href="#l41.833"></a><span id="l41.833" class="difflineplus">+    // XXX deal with the summarization threshold bail case.</span>
<a href="#l41.834"></a><span id="l41.834" class="difflineplus">+</span>
<a href="#l41.835"></a><span id="l41.835" class="difflineplus">+    // make sure the message display thinks we are in multi-message mode</span>
<a href="#l41.836"></a><span id="l41.836" class="difflineplus">+    if (troller.messageDisplay.singleMessageDisplay)</span>
<a href="#l41.837"></a><span id="l41.837" class="difflineplus">+      throw new Error(&quot;Message display should not be in single message display&quot;+</span>
<a href="#l41.838"></a><span id="l41.838" class="difflineplus">+                      &quot;mode!  Selected indices: &quot; + selectedIndices);</span>
<a href="#l41.839"></a><span id="l41.839" class="difflineplus">+</span>
<a href="#l41.840"></a><span id="l41.840" class="difflineplus">+    // now make sure that we actually are in nultiple message display mode</span>
<a href="#l41.841"></a><span id="l41.841" class="difflineplus">+    let singleMessagePane = troller.e(&quot;singlemessage&quot;);</span>
<a href="#l41.842"></a><span id="l41.842" class="difflineplus">+    let multiMessagePane = troller.e(&quot;multimessage&quot;);</span>
<a href="#l41.843"></a><span id="l41.843" class="difflineplus">+    if (singleMessagePane &amp;&amp; !singleMessagePane.hidden)</span>
<a href="#l41.844"></a><span id="l41.844" class="difflineplus">+      throw new Error(&quot;Single message pane is visible but it should not be.&quot;);</span>
<a href="#l41.845"></a><span id="l41.845" class="difflineplus">+    if (multiMessagePane &amp;&amp; multiMessagePane.hidden)</span>
<a href="#l41.846"></a><span id="l41.846" class="difflineplus">+      throw new Error(&quot;Multiple message pane is hidden but it should not be.&quot;);</span>
<a href="#l41.847"></a><span id="l41.847" class="difflineplus">+</span>
<a href="#l41.848"></a><span id="l41.848" class="difflineplus">+    // and _now_ make sure that we actually summarized what we wanted to</span>
<a href="#l41.849"></a><span id="l41.849" class="difflineplus">+    //  summarize.</span>
<a href="#l41.850"></a><span id="l41.850" class="difflineplus">+    let desiredMessages = [mc.dbView.getMsgHdrAt(vi) for each</span>
<a href="#l41.851"></a><span id="l41.851" class="difflineplus">+                            ([, vi] in Iterator(desiredIndices))];</span>
<a href="#l41.852"></a><span id="l41.852" class="difflineplus">+    assert_selection_summarized(troller, desiredMessages);</span>
<a href="#l41.853"></a><span id="l41.853" class="difflineplus">+  }</span>
<a href="#l41.854"></a><span id="l41.854" class="difflineplus">+}</span>
<a href="#l41.855"></a><span id="l41.855" class="difflineplus">+</span>
<a href="#l41.856"></a><span id="l41.856" class="difflineplus">+/**</span>
<a href="#l41.857"></a><span id="l41.857" class="difflineplus">+ * Assert that the messages corresponding to the one or more message spec</span>
<a href="#l41.858"></a><span id="l41.858" class="difflineplus">+ *  arguments are selected and displayed.  If you specify multiple messages,</span>
<a href="#l41.859"></a><span id="l41.859" class="difflineplus">+ *  we verify that the multi-message selection mode is in effect and that they</span>
<a href="#l41.860"></a><span id="l41.860" class="difflineplus">+ *  are doing the desired thing.  (Verifying the summarization may seem</span>
<a href="#l41.861"></a><span id="l41.861" class="difflineplus">+ *  overkill, but it helps make the tests simpler and allows you to be more</span>
<a href="#l41.862"></a><span id="l41.862" class="difflineplus">+ *  confident if you're just running one test that everything in the test is</span>
<a href="#l41.863"></a><span id="l41.863" class="difflineplus">+ *  performing in a sane fashion.  Refactoring could be in order, of course.)</span>
<a href="#l41.864"></a><span id="l41.864" class="difflineplus">+ *</span>
<a href="#l41.865"></a><span id="l41.865" class="difflineplus">+ * The arguments consist of one or more of the following:</span>
<a href="#l41.866"></a><span id="l41.866" class="difflineplus">+ * - A MozmillController, indicating we should use that controller instead of</span>
<a href="#l41.867"></a><span id="l41.867" class="difflineplus">+ *   the default, &quot;mc&quot; (corresponding to the 3pane.)  Pass this first!</span>
<a href="#l41.868"></a><span id="l41.868" class="difflineplus">+ * - An integer identifying a view index.</span>
<a href="#l41.869"></a><span id="l41.869" class="difflineplus">+ * - A list containing two integers, indicating a range of view indices.</span>
<a href="#l41.870"></a><span id="l41.870" class="difflineplus">+ * - A message header.</span>
<a href="#l41.871"></a><span id="l41.871" class="difflineplus">+ * - A list of message headers.</span>
<a href="#l41.872"></a><span id="l41.872" class="difflineplus">+ */</span>
<a href="#l41.873"></a><span id="l41.873" class="difflineplus">+function assert_selected_and_displayed() {</span>
<a href="#l41.874"></a><span id="l41.874" class="difflineplus">+  // make sure the selection is right first.</span>
<a href="#l41.875"></a><span id="l41.875" class="difflineplus">+  let [troller, desiredIndices] = assert_selected.apply(this, arguments);</span>
<a href="#l41.876"></a><span id="l41.876" class="difflineplus">+  // now make sure the display is right</span>
<a href="#l41.877"></a><span id="l41.877" class="difflineplus">+  _internal_assert_displayed(true, troller, desiredIndices);</span>
<a href="#l41.878"></a><span id="l41.878" class="difflineplus">+}</span>
<a href="#l41.879"></a><span id="l41.879" class="difflineplus">+</span>
<a href="#l41.880"></a><span id="l41.880" class="difflineplus">+/**</span>
<a href="#l41.881"></a><span id="l41.881" class="difflineplus">+ * @return true if |aSetOne| is equivalent to |aSetTwo| where the sets are</span>
<a href="#l41.882"></a><span id="l41.882" class="difflineplus">+ *     really just lists of nsIMsgDBHdrs with cool names.</span>
<a href="#l41.883"></a><span id="l41.883" class="difflineplus">+ */</span>
<a href="#l41.884"></a><span id="l41.884" class="difflineplus">+function _verify_message_sets_equivalent(aSetOne, aSetTwo) {</span>
<a href="#l41.885"></a><span id="l41.885" class="difflineplus">+  let uniqy1 = [msgHdr.folder.URI + msgHdr.folder.messageKey for each</span>
<a href="#l41.886"></a><span id="l41.886" class="difflineplus">+                 ([, msgHdr] in Iterator(aSetOne))];</span>
<a href="#l41.887"></a><span id="l41.887" class="difflineplus">+  uniqy1.sort();</span>
<a href="#l41.888"></a><span id="l41.888" class="difflineplus">+  let uniqy2 = [msgHdr.folder.URI + msgHdr.folder.messageKey for each</span>
<a href="#l41.889"></a><span id="l41.889" class="difflineplus">+                 ([, msgHdr] in Iterator(aSetTwo))];</span>
<a href="#l41.890"></a><span id="l41.890" class="difflineplus">+  uniqy2.sort();</span>
<a href="#l41.891"></a><span id="l41.891" class="difflineplus">+  // stringified versions should now be equal...</span>
<a href="#l41.892"></a><span id="l41.892" class="difflineplus">+  return uniqy1.toString() == uniqy2.toString();</span>
<a href="#l41.893"></a><span id="l41.893" class="difflineplus">+}</span>
<a href="#l41.894"></a><span id="l41.894" class="difflineplus">+</span>
<a href="#l41.895"></a><span id="l41.895" class="difflineplus">+/**</span>
<a href="#l41.896"></a><span id="l41.896" class="difflineplus">+ * Asserts that the messages the controller's folder display widget thinks are</span>
<a href="#l41.897"></a><span id="l41.897" class="difflineplus">+ *  summarized are in fact summarized.  This is automatically called by</span>
<a href="#l41.898"></a><span id="l41.898" class="difflineplus">+ *  assert_selected_and_displayed, so you do not need to call this directly</span>
<a href="#l41.899"></a><span id="l41.899" class="difflineplus">+ *  unless you are testing the summarization logic.</span>
<a href="#l41.900"></a><span id="l41.900" class="difflineplus">+ *</span>
<a href="#l41.901"></a><span id="l41.901" class="difflineplus">+ * @param aController The controller who has the summarized display going on.</span>
<a href="#l41.902"></a><span id="l41.902" class="difflineplus">+ * @param aMessages Optional set of messages to verify.  If not provided, this</span>
<a href="#l41.903"></a><span id="l41.903" class="difflineplus">+ *     is extracted via the folderDisplay.</span>
<a href="#l41.904"></a><span id="l41.904" class="difflineplus">+ */</span>
<a href="#l41.905"></a><span id="l41.905" class="difflineplus">+function assert_selection_summarized(aController, aSelectedMessages) {</span>
<a href="#l41.906"></a><span id="l41.906" class="difflineplus">+  // - Compensate for selection stabilization code.</span>
<a href="#l41.907"></a><span id="l41.907" class="difflineplus">+  // Although test-window-helpers sets the stabilization interval to 0, we</span>
<a href="#l41.908"></a><span id="l41.908" class="difflineplus">+  //  still need to make sure we have drained the event queue so that it has</span>
<a href="#l41.909"></a><span id="l41.909" class="difflineplus">+  //  actually gotten a chance to run.</span>
<a href="#l41.910"></a><span id="l41.910" class="difflineplus">+  controller.sleep(0);</span>
<a href="#l41.911"></a><span id="l41.911" class="difflineplus">+</span>
<a href="#l41.912"></a><span id="l41.912" class="difflineplus">+  // - Verify summary object knows about right messages</span>
<a href="#l41.913"></a><span id="l41.913" class="difflineplus">+  if (aSelectedMessages == null)</span>
<a href="#l41.914"></a><span id="l41.914" class="difflineplus">+    aSelectedMessages = aController.folderDisplay.selectedMessages;</span>
<a href="#l41.915"></a><span id="l41.915" class="difflineplus">+</span>
<a href="#l41.916"></a><span id="l41.916" class="difflineplus">+  let summary = aController.window.gSummary;</span>
<a href="#l41.917"></a><span id="l41.917" class="difflineplus">+  if (!_verify_message_sets_equivalent(summary._msgHdrs, aSelectedMessages)) {</span>
<a href="#l41.918"></a><span id="l41.918" class="difflineplus">+    let elaboration = &quot;Summary: &quot; + summary._msgHdrs + &quot;  Selected: &quot; +</span>
<a href="#l41.919"></a><span id="l41.919" class="difflineplus">+                      aSelectedMessages + &quot;.&quot;;</span>
<a href="#l41.920"></a><span id="l41.920" class="difflineplus">+    throw new Error(&quot;Summary does not contain the right set of messages. &quot; +</span>
<a href="#l41.921"></a><span id="l41.921" class="difflineplus">+                    elaboration);</span>
<a href="#l41.922"></a><span id="l41.922" class="difflineplus">+  }</span>
<a href="#l41.923"></a><span id="l41.923" class="difflineplus">+}</span>
<a href="#l41.924"></a><span id="l41.924" class="difflineplus">+</span>
<a href="#l41.925"></a><span id="l41.925" class="difflineplus">+/**</span>
<a href="#l41.926"></a><span id="l41.926" class="difflineplus">+ * Assert that there is nothing selected and, assuming we are in a folder, that</span>
<a href="#l41.927"></a><span id="l41.927" class="difflineplus">+ *  the folder summary is displayed.</span>
<a href="#l41.928"></a><span id="l41.928" class="difflineplus">+ */</span>
<a href="#l41.929"></a><span id="l41.929" class="difflineplus">+let assert_nothing_selected = assert_selected_and_displayed;</span>
<a href="#l41.930"></a><span id="l41.930" class="difflineplus">+</span>
<a href="#l41.931"></a><span id="l41.931" class="difflineplus">+/**</span>
<a href="#l41.932"></a><span id="l41.932" class="difflineplus">+ * Assert that the given view index or message is visible in the thread pane.</span>
<a href="#l41.933"></a><span id="l41.933" class="difflineplus">+ */</span>
<a href="#l41.934"></a><span id="l41.934" class="difflineplus">+function assert_visible(aViewIndexOrMessage) {</span>
<a href="#l41.935"></a><span id="l41.935" class="difflineplus">+  let viewIndex;</span>
<a href="#l41.936"></a><span id="l41.936" class="difflineplus">+  if (typeof(aViewIndexOrMessage) == &quot;number&quot;)</span>
<a href="#l41.937"></a><span id="l41.937" class="difflineplus">+    viewIndex = _normalize_view_index(aViewIndexOrMessage);</span>
<a href="#l41.938"></a><span id="l41.938" class="difflineplus">+  else</span>
<a href="#l41.939"></a><span id="l41.939" class="difflineplus">+    viewIndex = mc.dbView.findIndexOfMsgHdr(aViewIndexOrMessage);</span>
<a href="#l41.940"></a><span id="l41.940" class="difflineplus">+  let treeBox = mc.threadTree.boxObject.QueryInterface(Ci.nsITreeBoxObject);</span>
<a href="#l41.941"></a><span id="l41.941" class="difflineplus">+  if (viewIndex &lt; treeBox.getFirstVisibleRow() ||</span>
<a href="#l41.942"></a><span id="l41.942" class="difflineplus">+      viewIndex &gt; treeBox.getLastVisibleRow())</span>
<a href="#l41.943"></a><span id="l41.943" class="difflineplus">+    throw new Error(&quot;View index &quot; + viewIndex + &quot; is not visible! (&quot; +</span>
<a href="#l41.944"></a><span id="l41.944" class="difflineplus">+                    treeBox.getFirstVisibleRow() + &quot;-&quot; +</span>
<a href="#l41.945"></a><span id="l41.945" class="difflineplus">+                    treeBox.getLastVisibleRow() + &quot; are visible)&quot;);</span>
<a href="#l41.946"></a><span id="l41.946" class="difflineplus">+}</span>
<a href="#l41.947"></a><span id="l41.947" class="difflineplus">+</span>
<a href="#l41.948"></a><span id="l41.948" class="difflineplus">+/**</span>
<a href="#l41.949"></a><span id="l41.949" class="difflineplus">+ * Put the view in unthreaded mode.</span>
<a href="#l41.950"></a><span id="l41.950" class="difflineplus">+ */</span>
<a href="#l41.951"></a><span id="l41.951" class="difflineplus">+function make_display_unthreaded() {</span>
<a href="#l41.952"></a><span id="l41.952" class="difflineplus">+  wait_for_message_display_completion();</span>
<a href="#l41.953"></a><span id="l41.953" class="difflineplus">+  mc.folderDisplay.view.showUnthreaded = true;</span>
<a href="#l41.954"></a><span id="l41.954" class="difflineplus">+  // drain event queue</span>
<a href="#l41.955"></a><span id="l41.955" class="difflineplus">+  mc.sleep(0);</span>
<a href="#l41.956"></a><span id="l41.956" class="difflineplus">+}</span>
<a href="#l41.957"></a><span id="l41.957" class="difflineplus">+</span>
<a href="#l41.958"></a><span id="l41.958" class="difflineplus">+/**</span>
<a href="#l41.959"></a><span id="l41.959" class="difflineplus">+ * Put the view in threaded mode.</span>
<a href="#l41.960"></a><span id="l41.960" class="difflineplus">+ */</span>
<a href="#l41.961"></a><span id="l41.961" class="difflineplus">+function make_display_threaded() {</span>
<a href="#l41.962"></a><span id="l41.962" class="difflineplus">+  wait_for_message_display_completion();</span>
<a href="#l41.963"></a><span id="l41.963" class="difflineplus">+  mc.folderDisplay.view.showThreaded = true;</span>
<a href="#l41.964"></a><span id="l41.964" class="difflineplus">+  // drain event queue</span>
<a href="#l41.965"></a><span id="l41.965" class="difflineplus">+  mc.sleep(0);</span>
<a href="#l41.966"></a><span id="l41.966" class="difflineplus">+}</span>
<a href="#l41.967"></a><span id="l41.967" class="difflineplus">+</span>
<a href="#l41.968"></a><span id="l41.968" class="difflineplus">+/**</span>
<a href="#l41.969"></a><span id="l41.969" class="difflineplus">+ * Put the view in group-by-sort mode.</span>
<a href="#l41.970"></a><span id="l41.970" class="difflineplus">+ */</span>
<a href="#l41.971"></a><span id="l41.971" class="difflineplus">+function make_display_grouped() {</span>
<a href="#l41.972"></a><span id="l41.972" class="difflineplus">+  wait_for_message_display_completion();</span>
<a href="#l41.973"></a><span id="l41.973" class="difflineplus">+  mc.folderDisplay.view.showGroupedBySort = true;</span>
<a href="#l41.974"></a><span id="l41.974" class="difflineplus">+  // drain event queue</span>
<a href="#l41.975"></a><span id="l41.975" class="difflineplus">+  mc.sleep(0);</span>
<a href="#l41.976"></a><span id="l41.976" class="difflineplus">+}</span>
<a href="#l41.977"></a><span id="l41.977" class="difflineplus">+</span>
<a href="#l41.978"></a><span id="l41.978" class="difflineplus">+function throw_and_dump_view_state(aMessage, aController) {</span>
<a href="#l41.979"></a><span id="l41.979" class="difflineplus">+  if (aController == null)</span>
<a href="#l41.980"></a><span id="l41.980" class="difflineplus">+    aController = mc;</span>
<a href="#l41.981"></a><span id="l41.981" class="difflineplus">+</span>
<a href="#l41.982"></a><span id="l41.982" class="difflineplus">+  dump(&quot;******** &quot; + aMessage + &quot;\n&quot;);</span>
<a href="#l41.983"></a><span id="l41.983" class="difflineplus">+  viewWrapperTestUtils.dump_view_state(aController.folderDisplay.view);</span>
<a href="#l41.984"></a><span id="l41.984" class="difflineplus">+  throw new Error(aMessage);</span>
<a href="#l41.985"></a><span id="l41.985" class="difflineplus">+}</span>
<a href="#l41.986"></a><span id="l41.986" class="difflineplus">+</span>
<a href="#l41.987"></a><span id="l41.987" class="difflineplus">+/** exported from viewWrapperTestUtils */</span>
<a href="#l41.988"></a><span id="l41.988" class="difflineplus">+var make_new_sets_in_folders;</span>
<a href="#l41.989"></a><span id="l41.989" class="difflineplus">+var make_new_sets_in_folder;</span>
<a href="#l41.990"></a><span id="l41.990" class="difflineplus">+</span>
<a href="#l41.991"></a><span id="l41.991" class="difflineplus">+/**</span>
<a href="#l41.992"></a><span id="l41.992" class="difflineplus">+ * Load a file in its own 'module'.</span>
<a href="#l41.993"></a><span id="l41.993" class="difflineplus">+ *</span>
<a href="#l41.994"></a><span id="l41.994" class="difflineplus">+ * @param aPath A path relative to the comm-central source path.</span>
<a href="#l41.995"></a><span id="l41.995" class="difflineplus">+ *</span>
<a href="#l41.996"></a><span id="l41.996" class="difflineplus">+ * @return An object that serves as the global scope for the loaded file.</span>
<a href="#l41.997"></a><span id="l41.997" class="difflineplus">+ */</span>
<a href="#l41.998"></a><span id="l41.998" class="difflineplus">+function load_via_src_path(aPath) {</span>
<a href="#l41.999"></a><span id="l41.999" class="difflineplus">+  let srcPath = os.abspath(&quot;../../../..&quot;,os.getFileForPath( __file__));</span>
<a href="#l41.1000"></a><span id="l41.1000" class="difflineplus">+  let fullPath = os.abspath(aPath, os.getFileForPath(srcPath));</span>
<a href="#l41.1001"></a><span id="l41.1001" class="difflineplus">+  return frame.loadFile(fullPath, undefined);</span>
<a href="#l41.1002"></a><span id="l41.1002" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1">new file mode 100644</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineminus">--- /dev/null</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-window-helpers.js</span>
<a href="#l42.4"></a><span id="l42.4" class="difflineat">@@ -0,0 +1,739 @@</span>
<a href="#l42.5"></a><span id="l42.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l42.6"></a><span id="l42.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l42.7"></a><span id="l42.7" class="difflineplus">+ *</span>
<a href="#l42.8"></a><span id="l42.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l42.9"></a><span id="l42.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l42.10"></a><span id="l42.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l42.11"></a><span id="l42.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l42.12"></a><span id="l42.12" class="difflineplus">+ *</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l42.14"></a><span id="l42.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l42.15"></a><span id="l42.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l42.16"></a><span id="l42.16" class="difflineplus">+ * License.</span>
<a href="#l42.17"></a><span id="l42.17" class="difflineplus">+ *</span>
<a href="#l42.18"></a><span id="l42.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l42.19"></a><span id="l42.19" class="difflineplus">+ *</span>
<a href="#l42.20"></a><span id="l42.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l42.21"></a><span id="l42.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l42.22"></a><span id="l42.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l42.23"></a><span id="l42.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l42.24"></a><span id="l42.24" class="difflineplus">+ *</span>
<a href="#l42.25"></a><span id="l42.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l42.26"></a><span id="l42.26" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l42.27"></a><span id="l42.27" class="difflineplus">+ *</span>
<a href="#l42.28"></a><span id="l42.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l42.29"></a><span id="l42.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l42.30"></a><span id="l42.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l42.31"></a><span id="l42.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l42.32"></a><span id="l42.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l42.33"></a><span id="l42.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l42.34"></a><span id="l42.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l42.35"></a><span id="l42.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l42.36"></a><span id="l42.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l42.37"></a><span id="l42.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l42.38"></a><span id="l42.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l42.39"></a><span id="l42.39" class="difflineplus">+ *</span>
<a href="#l42.40"></a><span id="l42.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l42.41"></a><span id="l42.41" class="difflineplus">+</span>
<a href="#l42.42"></a><span id="l42.42" class="difflineplus">+const Ci = Components.interfaces;</span>
<a href="#l42.43"></a><span id="l42.43" class="difflineplus">+const Cc = Components.classes;</span>
<a href="#l42.44"></a><span id="l42.44" class="difflineplus">+const Cu = Components.utils;</span>
<a href="#l42.45"></a><span id="l42.45" class="difflineplus">+</span>
<a href="#l42.46"></a><span id="l42.46" class="difflineplus">+var mozmill = {};</span>
<a href="#l42.47"></a><span id="l42.47" class="difflineplus">+Cu.import('resource://mozmill/modules/mozmill.js', mozmill);</span>
<a href="#l42.48"></a><span id="l42.48" class="difflineplus">+var controller = {};</span>
<a href="#l42.49"></a><span id="l42.49" class="difflineplus">+Cu.import('resource://mozmill/modules/controller.js', controller);</span>
<a href="#l42.50"></a><span id="l42.50" class="difflineplus">+var elib = {};</span>
<a href="#l42.51"></a><span id="l42.51" class="difflineplus">+Cu.import('resource://mozmill/modules/elementslib.js', elib);</span>
<a href="#l42.52"></a><span id="l42.52" class="difflineplus">+var frame = {};</span>
<a href="#l42.53"></a><span id="l42.53" class="difflineplus">+Cu.import('resource://mozmill/modules/frame.js', frame);</span>
<a href="#l42.54"></a><span id="l42.54" class="difflineplus">+</span>
<a href="#l42.55"></a><span id="l42.55" class="difflineplus">+Cu.import('resource://app/modules/iteratorUtils.jsm');</span>
<a href="#l42.56"></a><span id="l42.56" class="difflineplus">+</span>
<a href="#l42.57"></a><span id="l42.57" class="difflineplus">+const MODULE_NAME = 'window-helpers';</span>
<a href="#l42.58"></a><span id="l42.58" class="difflineplus">+</span>
<a href="#l42.59"></a><span id="l42.59" class="difflineplus">+const NORMAL_TIMEOUT = 6000;</span>
<a href="#l42.60"></a><span id="l42.60" class="difflineplus">+const FAST_INTERVAL = 100;</span>
<a href="#l42.61"></a><span id="l42.61" class="difflineplus">+</span>
<a href="#l42.62"></a><span id="l42.62" class="difflineplus">+function setupModule() {</span>
<a href="#l42.63"></a><span id="l42.63" class="difflineplus">+  // do nothing</span>
<a href="#l42.64"></a><span id="l42.64" class="difflineplus">+}</span>
<a href="#l42.65"></a><span id="l42.65" class="difflineplus">+</span>
<a href="#l42.66"></a><span id="l42.66" class="difflineplus">+function installInto(module) {</span>
<a href="#l42.67"></a><span id="l42.67" class="difflineplus">+  module.plan_for_new_window = plan_for_new_window;</span>
<a href="#l42.68"></a><span id="l42.68" class="difflineplus">+  module.wait_for_new_window = wait_for_new_window;</span>
<a href="#l42.69"></a><span id="l42.69" class="difflineplus">+  module.plan_for_modal_dialog = plan_for_modal_dialog;</span>
<a href="#l42.70"></a><span id="l42.70" class="difflineplus">+  module.wait_for_modal_dialog = wait_for_modal_dialog;</span>
<a href="#l42.71"></a><span id="l42.71" class="difflineplus">+  module.plan_for_window_close = plan_for_window_close;</span>
<a href="#l42.72"></a><span id="l42.72" class="difflineplus">+  module.wait_for_window_close = wait_for_window_close;</span>
<a href="#l42.73"></a><span id="l42.73" class="difflineplus">+  module.wait_for_existing_window = wait_for_existing_window;</span>
<a href="#l42.74"></a><span id="l42.74" class="difflineplus">+</span>
<a href="#l42.75"></a><span id="l42.75" class="difflineplus">+  module.augment_controller = augment_controller;</span>
<a href="#l42.76"></a><span id="l42.76" class="difflineplus">+}</span>
<a href="#l42.77"></a><span id="l42.77" class="difflineplus">+</span>
<a href="#l42.78"></a><span id="l42.78" class="difflineplus">+var WindowWatcher = {</span>
<a href="#l42.79"></a><span id="l42.79" class="difflineplus">+  _inited: false,</span>
<a href="#l42.80"></a><span id="l42.80" class="difflineplus">+  ensureInited: function WindowWatcher_ensureInited() {</span>
<a href="#l42.81"></a><span id="l42.81" class="difflineplus">+    if (this._inited)</span>
<a href="#l42.82"></a><span id="l42.82" class="difflineplus">+      return;</span>
<a href="#l42.83"></a><span id="l42.83" class="difflineplus">+</span>
<a href="#l42.84"></a><span id="l42.84" class="difflineplus">+    // Add ourselves as an nsIWindowMediatorListener so we can here about when</span>
<a href="#l42.85"></a><span id="l42.85" class="difflineplus">+    //  windows get registered with the window mediator.  Because this</span>
<a href="#l42.86"></a><span id="l42.86" class="difflineplus">+    //  generally happens</span>
<a href="#l42.87"></a><span id="l42.87" class="difflineplus">+    // Another possible means of getting this info would be to observe</span>
<a href="#l42.88"></a><span id="l42.88" class="difflineplus">+    //  &quot;xul-window-visible&quot;, but it provides no context and may still require</span>
<a href="#l42.89"></a><span id="l42.89" class="difflineplus">+    //  polling anyways.</span>
<a href="#l42.90"></a><span id="l42.90" class="difflineplus">+    mozmill.wm.addListener(this);</span>
<a href="#l42.91"></a><span id="l42.91" class="difflineplus">+</span>
<a href="#l42.92"></a><span id="l42.92" class="difflineplus">+    this._inited = true;</span>
<a href="#l42.93"></a><span id="l42.93" class="difflineplus">+  },</span>
<a href="#l42.94"></a><span id="l42.94" class="difflineplus">+</span>
<a href="#l42.95"></a><span id="l42.95" class="difflineplus">+  /**</span>
<a href="#l42.96"></a><span id="l42.96" class="difflineplus">+   * Track the windowtypes we are waiting on.  Keys are windowtypes.  When</span>
<a href="#l42.97"></a><span id="l42.97" class="difflineplus">+   *  watching for new windows, values are initially null, and are set to an</span>
<a href="#l42.98"></a><span id="l42.98" class="difflineplus">+   *  nsIXULWindow when we actually find the window.  When watching for closing</span>
<a href="#l42.99"></a><span id="l42.99" class="difflineplus">+   *  windows, values are nsIXULWindows.  This symmetry lets us have windows</span>
<a href="#l42.100"></a><span id="l42.100" class="difflineplus">+   *  that appear and dis-appear do so without dangerously confusing us (as</span>
<a href="#l42.101"></a><span id="l42.101" class="difflineplus">+   *  long as another one comes along...)</span>
<a href="#l42.102"></a><span id="l42.102" class="difflineplus">+   */</span>
<a href="#l42.103"></a><span id="l42.103" class="difflineplus">+  waitingList: {},</span>
<a href="#l42.104"></a><span id="l42.104" class="difflineplus">+  /**</span>
<a href="#l42.105"></a><span id="l42.105" class="difflineplus">+   * Note that we will be looking for a window with the given window type</span>
<a href="#l42.106"></a><span id="l42.106" class="difflineplus">+   *  (ex: &quot;mailnews:search&quot;).  This allows us to be ready if an event shows</span>
<a href="#l42.107"></a><span id="l42.107" class="difflineplus">+   *  up before waitForWindow is called.</span>
<a href="#l42.108"></a><span id="l42.108" class="difflineplus">+   */</span>
<a href="#l42.109"></a><span id="l42.109" class="difflineplus">+  planForWindowOpen: function WindowWatcher_planForWindowOpen(aWindowType) {</span>
<a href="#l42.110"></a><span id="l42.110" class="difflineplus">+    this.waitingList[aWindowType] = null;</span>
<a href="#l42.111"></a><span id="l42.111" class="difflineplus">+  },</span>
<a href="#l42.112"></a><span id="l42.112" class="difflineplus">+</span>
<a href="#l42.113"></a><span id="l42.113" class="difflineplus">+  /**</span>
<a href="#l42.114"></a><span id="l42.114" class="difflineplus">+   * Like planForWindowOpen but we check for already-existing windows.</span>
<a href="#l42.115"></a><span id="l42.115" class="difflineplus">+   */</span>
<a href="#l42.116"></a><span id="l42.116" class="difflineplus">+  planForAlreadyOpenWindow:</span>
<a href="#l42.117"></a><span id="l42.117" class="difflineplus">+      function WindowWatcher_planForAlreadyOpenWindow(aWindowType) {</span>
<a href="#l42.118"></a><span id="l42.118" class="difflineplus">+    this.waitingList[aWindowType] = null;</span>
<a href="#l42.119"></a><span id="l42.119" class="difflineplus">+    // We need to iterate over all the XUL windows and consider them all.</span>
<a href="#l42.120"></a><span id="l42.120" class="difflineplus">+    //  We can't pass the window type because the window might not have a</span>
<a href="#l42.121"></a><span id="l42.121" class="difflineplus">+    //  window type yet.</span>
<a href="#l42.122"></a><span id="l42.122" class="difflineplus">+    // because this iterates from old to new, this does the right thing in that</span>
<a href="#l42.123"></a><span id="l42.123" class="difflineplus">+    //  side-effects of consider will pick the most recent window.</span>
<a href="#l42.124"></a><span id="l42.124" class="difflineplus">+    for each (let xulWindow in fixIterator(</span>
<a href="#l42.125"></a><span id="l42.125" class="difflineplus">+                                 mozmill.wm.getXULWindowEnumerator(null),</span>
<a href="#l42.126"></a><span id="l42.126" class="difflineplus">+                                 Ci.nsIXULWindow)) {</span>
<a href="#l42.127"></a><span id="l42.127" class="difflineplus">+      if (!this.consider(xulWindow))</span>
<a href="#l42.128"></a><span id="l42.128" class="difflineplus">+        this.monitoringList.push(xulWindow);</span>
<a href="#l42.129"></a><span id="l42.129" class="difflineplus">+    }</span>
<a href="#l42.130"></a><span id="l42.130" class="difflineplus">+  },</span>
<a href="#l42.131"></a><span id="l42.131" class="difflineplus">+</span>
<a href="#l42.132"></a><span id="l42.132" class="difflineplus">+  /**</span>
<a href="#l42.133"></a><span id="l42.133" class="difflineplus">+   * The current windowType we are waiting to open.  This is mainly a means of</span>
<a href="#l42.134"></a><span id="l42.134" class="difflineplus">+   *  communicating the desired window type to monitorize without having to</span>
<a href="#l42.135"></a><span id="l42.135" class="difflineplus">+   *  put the argument in the eval string.</span>
<a href="#l42.136"></a><span id="l42.136" class="difflineplus">+   */</span>
<a href="#l42.137"></a><span id="l42.137" class="difflineplus">+  waitingForOpen: null,</span>
<a href="#l42.138"></a><span id="l42.138" class="difflineplus">+  /**</span>
<a href="#l42.139"></a><span id="l42.139" class="difflineplus">+   * Wait for the given windowType to open and finish loading.</span>
<a href="#l42.140"></a><span id="l42.140" class="difflineplus">+   *</span>
<a href="#l42.141"></a><span id="l42.141" class="difflineplus">+   * @return The window wrapped in a MozMillController.</span>
<a href="#l42.142"></a><span id="l42.142" class="difflineplus">+   */</span>
<a href="#l42.143"></a><span id="l42.143" class="difflineplus">+  waitForWindowOpen: function WindowWatcher_waitForWindowOpen(aWindowType) {</span>
<a href="#l42.144"></a><span id="l42.144" class="difflineplus">+    this.waitingForOpen = aWindowType;</span>
<a href="#l42.145"></a><span id="l42.145" class="difflineplus">+    controller.waitForEval('subject.monitorizeOpen()', NORMAL_TIMEOUT,</span>
<a href="#l42.146"></a><span id="l42.146" class="difflineplus">+                           FAST_INTERVAL, this);</span>
<a href="#l42.147"></a><span id="l42.147" class="difflineplus">+    this.waitingForOpen = null;</span>
<a href="#l42.148"></a><span id="l42.148" class="difflineplus">+    let xulWindow = this.waitingList[aWindowType];</span>
<a href="#l42.149"></a><span id="l42.149" class="difflineplus">+dump(&quot;### XUL window: &quot; + xulWindow + &quot;\n&quot;);</span>
<a href="#l42.150"></a><span id="l42.150" class="difflineplus">+    let domWindow = xulWindow.docShell.QueryInterface(Ci.nsIInterfaceRequestor)</span>
<a href="#l42.151"></a><span id="l42.151" class="difflineplus">+                                      .getInterface(Ci.nsIDOMWindowInternal);</span>
<a href="#l42.152"></a><span id="l42.152" class="difflineplus">+dump(&quot;domWindow: &quot; + domWindow + &quot;\n&quot;);</span>
<a href="#l42.153"></a><span id="l42.153" class="difflineplus">+    delete this.waitingList[aWindowType];</span>
<a href="#l42.154"></a><span id="l42.154" class="difflineplus">+    // spin the event loop to make sure any setTimeout 0 calls have gotten their</span>
<a href="#l42.155"></a><span id="l42.155" class="difflineplus">+    //  time in the sun.</span>
<a href="#l42.156"></a><span id="l42.156" class="difflineplus">+    controller.sleep(0);</span>
<a href="#l42.157"></a><span id="l42.157" class="difflineplus">+    return new controller.MozMillController(domWindow);</span>
<a href="#l42.158"></a><span id="l42.158" class="difflineplus">+  },</span>
<a href="#l42.159"></a><span id="l42.159" class="difflineplus">+</span>
<a href="#l42.160"></a><span id="l42.160" class="difflineplus">+  /**</span>
<a href="#l42.161"></a><span id="l42.161" class="difflineplus">+   * Because the modal dialog spins its own event loop, the mozmill idiom of</span>
<a href="#l42.162"></a><span id="l42.162" class="difflineplus">+   *  spinning your own event-loop as performed by waitForEval is no good.  We</span>
<a href="#l42.163"></a><span id="l42.163" class="difflineplus">+   *  use this timer to generate our events so that we can have a waitForEval</span>
<a href="#l42.164"></a><span id="l42.164" class="difflineplus">+   *  equivalent.</span>
<a href="#l42.165"></a><span id="l42.165" class="difflineplus">+   *</span>
<a href="#l42.166"></a><span id="l42.166" class="difflineplus">+   * We only have one timer right now because modal dialogs that spawn modal</span>
<a href="#l42.167"></a><span id="l42.167" class="difflineplus">+   *  dialogs are not tremendously likely.</span>
<a href="#l42.168"></a><span id="l42.168" class="difflineplus">+   */</span>
<a href="#l42.169"></a><span id="l42.169" class="difflineplus">+  _timer: null,</span>
<a href="#l42.170"></a><span id="l42.170" class="difflineplus">+  _timerRuntimeSoFar: 0,</span>
<a href="#l42.171"></a><span id="l42.171" class="difflineplus">+  /**</span>
<a href="#l42.172"></a><span id="l42.172" class="difflineplus">+   * The test function to run when the modal dialog opens.</span>
<a href="#l42.173"></a><span id="l42.173" class="difflineplus">+   */</span>
<a href="#l42.174"></a><span id="l42.174" class="difflineplus">+  subTestFunc: null,</span>
<a href="#l42.175"></a><span id="l42.175" class="difflineplus">+  planForModalDialog: function WindowWatcher_planForModalDialog(aWindowType,</span>
<a href="#l42.176"></a><span id="l42.176" class="difflineplus">+                                                                aSubTestFunc) {</span>
<a href="#l42.177"></a><span id="l42.177" class="difflineplus">+    if (this._timer == null)</span>
<a href="#l42.178"></a><span id="l42.178" class="difflineplus">+      this._timer = Cc[&quot;@mozilla.org/timer;1&quot;].createInstance(Ci.nsITimer);</span>
<a href="#l42.179"></a><span id="l42.179" class="difflineplus">+    this.waitingForOpen = aWindowType;</span>
<a href="#l42.180"></a><span id="l42.180" class="difflineplus">+    this.subTestFunc = aSubTestFunc;</span>
<a href="#l42.181"></a><span id="l42.181" class="difflineplus">+    this.waitingList[aWindowType] = null;</span>
<a href="#l42.182"></a><span id="l42.182" class="difflineplus">+</span>
<a href="#l42.183"></a><span id="l42.183" class="difflineplus">+    this._timerRuntimeSoFar = 0;</span>
<a href="#l42.184"></a><span id="l42.184" class="difflineplus">+    this._timer.initWithCallback(this, FAST_INTERVAL,</span>
<a href="#l42.185"></a><span id="l42.185" class="difflineplus">+                                 Ci.nsITimer.TYPE_REPEATING_SLACK);</span>
<a href="#l42.186"></a><span id="l42.186" class="difflineplus">+  },</span>
<a href="#l42.187"></a><span id="l42.187" class="difflineplus">+</span>
<a href="#l42.188"></a><span id="l42.188" class="difflineplus">+  /**</span>
<a href="#l42.189"></a><span id="l42.189" class="difflineplus">+   * This is the nsITimer notification we receive...</span>
<a href="#l42.190"></a><span id="l42.190" class="difflineplus">+   */</span>
<a href="#l42.191"></a><span id="l42.191" class="difflineplus">+  notify: function WindowWatcher_notify() {</span>
<a href="#l42.192"></a><span id="l42.192" class="difflineplus">+dump(&quot;Timer check!\n&quot;);</span>
<a href="#l42.193"></a><span id="l42.193" class="difflineplus">+    if (this.monitorizeOpen()) {</span>
<a href="#l42.194"></a><span id="l42.194" class="difflineplus">+      // okay, the window is opened, and we should be in its event loop now.</span>
<a href="#l42.195"></a><span id="l42.195" class="difflineplus">+dump(&quot;  THIS IS IT!\n&quot;);</span>
<a href="#l42.196"></a><span id="l42.196" class="difflineplus">+      let xulWindow = this.waitingList[this.waitingForOpen];</span>
<a href="#l42.197"></a><span id="l42.197" class="difflineplus">+dump(&quot; xul window: &quot; + xulWindow + &quot;\n&quot;);</span>
<a href="#l42.198"></a><span id="l42.198" class="difflineplus">+      let domWindow = xulWindow.docShell.QueryInterface(Ci.nsIInterfaceRequestor)</span>
<a href="#l42.199"></a><span id="l42.199" class="difflineplus">+                                        .getInterface(Ci.nsIDOMWindowInternal);</span>
<a href="#l42.200"></a><span id="l42.200" class="difflineplus">+dump(&quot; dom window: &quot; + domWindow + &quot;\n&quot;);</span>
<a href="#l42.201"></a><span id="l42.201" class="difflineplus">+      let troller = new controller.MozMillController(domWindow);</span>
<a href="#l42.202"></a><span id="l42.202" class="difflineplus">+      augment_controller(troller, this.waitingForOpen);</span>
<a href="#l42.203"></a><span id="l42.203" class="difflineplus">+</span>
<a href="#l42.204"></a><span id="l42.204" class="difflineplus">+dump(&quot; cleanup!\n&quot;);</span>
<a href="#l42.205"></a><span id="l42.205" class="difflineplus">+      delete this.waitingList[this.waitingForOpen];</span>
<a href="#l42.206"></a><span id="l42.206" class="difflineplus">+      this._timer.cancel();</span>
<a href="#l42.207"></a><span id="l42.207" class="difflineplus">+dump(&quot;canceled!\n&quot;);</span>
<a href="#l42.208"></a><span id="l42.208" class="difflineplus">+      try {</span>
<a href="#l42.209"></a><span id="l42.209" class="difflineplus">+        dump(&quot;::: calling\n&quot;);</span>
<a href="#l42.210"></a><span id="l42.210" class="difflineplus">+        try {</span>
<a href="#l42.211"></a><span id="l42.211" class="difflineplus">+          let runner = new frame.Runner(collector);</span>
<a href="#l42.212"></a><span id="l42.212" class="difflineplus">+          runner.wrapper(this.subTestFunc, troller);</span>
<a href="#l42.213"></a><span id="l42.213" class="difflineplus">+        }</span>
<a href="#l42.214"></a><span id="l42.214" class="difflineplus">+        catch (ex) {</span>
<a href="#l42.215"></a><span id="l42.215" class="difflineplus">+          dump(&quot;problem running: &quot; + ex.fileName + &quot;:&quot; + ex.lineNumber + &quot;: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l42.216"></a><span id="l42.216" class="difflineplus">+        }</span>
<a href="#l42.217"></a><span id="l42.217" class="difflineplus">+        dump(&quot;::: called\n&quot;);</span>
<a href="#l42.218"></a><span id="l42.218" class="difflineplus">+      }</span>
<a href="#l42.219"></a><span id="l42.219" class="difflineplus">+      finally {</span>
<a href="#l42.220"></a><span id="l42.220" class="difflineplus">+        this.subTestFunc = null;</span>
<a href="#l42.221"></a><span id="l42.221" class="difflineplus">+      }</span>
<a href="#l42.222"></a><span id="l42.222" class="difflineplus">+      // now we are waiting for it to close...</span>
<a href="#l42.223"></a><span id="l42.223" class="difflineplus">+      this.waitingForClose = this.waitingForOpen;</span>
<a href="#l42.224"></a><span id="l42.224" class="difflineplus">+      this.waitingForOpen = null;</span>
<a href="#l42.225"></a><span id="l42.225" class="difflineplus">+</span>
<a href="#l42.226"></a><span id="l42.226" class="difflineplus">+      // if the test failed, make sure we force the window closed...</span>
<a href="#l42.227"></a><span id="l42.227" class="difflineplus">+      // except I'm not sure how to easily figure that out...</span>
<a href="#l42.228"></a><span id="l42.228" class="difflineplus">+      // so just close it no matter what.</span>
<a href="#l42.229"></a><span id="l42.229" class="difflineplus">+      troller.window.close();</span>
<a href="#l42.230"></a><span id="l42.230" class="difflineplus">+    }</span>
<a href="#l42.231"></a><span id="l42.231" class="difflineplus">+    this._timerRuntimeSoFar += FAST_INTERVAL;</span>
<a href="#l42.232"></a><span id="l42.232" class="difflineplus">+    if (this._timerRuntimeSoFar &gt;= NORMAL_TIMEOUT) {</span>
<a href="#l42.233"></a><span id="l42.233" class="difflineplus">+      dump(&quot;!!! TIMEOUT WHILE WAITING FOR MODAL DIALOG !!!\n&quot;);</span>
<a href="#l42.234"></a><span id="l42.234" class="difflineplus">+      this._timer.cancel();</span>
<a href="#l42.235"></a><span id="l42.235" class="difflineplus">+      throw new Error(&quot;Timeout while waiting for modal dialog.\n&quot;);</span>
<a href="#l42.236"></a><span id="l42.236" class="difflineplus">+    }</span>
<a href="#l42.237"></a><span id="l42.237" class="difflineplus">+  },</span>
<a href="#l42.238"></a><span id="l42.238" class="difflineplus">+</span>
<a href="#l42.239"></a><span id="l42.239" class="difflineplus">+  /**</span>
<a href="#l42.240"></a><span id="l42.240" class="difflineplus">+   * Symmetry for planForModalDialog; conceptually provides the waiting.  In</span>
<a href="#l42.241"></a><span id="l42.241" class="difflineplus">+   *  reality, all we do is potentially soak up the event loop a little to</span>
<a href="#l42.242"></a><span id="l42.242" class="difflineplus">+   */</span>
<a href="#l42.243"></a><span id="l42.243" class="difflineplus">+  waitForModalDialog: function WindowWatcher_waitForModalDialog(aWindowType) {</span>
<a href="#l42.244"></a><span id="l42.244" class="difflineplus">+    // did the window already come and go?</span>
<a href="#l42.245"></a><span id="l42.245" class="difflineplus">+    if (this.subTestFunc == null)</span>
<a href="#l42.246"></a><span id="l42.246" class="difflineplus">+      return;</span>
<a href="#l42.247"></a><span id="l42.247" class="difflineplus">+    // spin the event loop until we the window has come and gone.</span>
<a href="#l42.248"></a><span id="l42.248" class="difflineplus">+    controller.waitForEval(</span>
<a href="#l42.249"></a><span id="l42.249" class="difflineplus">+      'subject.waitingForOpen == null &amp;&amp; subject.waitingForClose == null',</span>
<a href="#l42.250"></a><span id="l42.250" class="difflineplus">+      NORMAL_TIMEOUT, FAST_INTERVAL, this);</span>
<a href="#l42.251"></a><span id="l42.251" class="difflineplus">+    this.waitingForClose = null;</span>
<a href="#l42.252"></a><span id="l42.252" class="difflineplus">+  },</span>
<a href="#l42.253"></a><span id="l42.253" class="difflineplus">+</span>
<a href="#l42.254"></a><span id="l42.254" class="difflineplus">+  planForWindowClose: function WindowWatcher_planForWindowClose(aXULWindow) {</span>
<a href="#l42.255"></a><span id="l42.255" class="difflineplus">+    let windowType =</span>
<a href="#l42.256"></a><span id="l42.256" class="difflineplus">+      aXULWindow.document.documentElement.getAttribute(&quot;windowtype&quot;);</span>
<a href="#l42.257"></a><span id="l42.257" class="difflineplus">+    this.waitingList[windowType] = aXULWindow;</span>
<a href="#l42.258"></a><span id="l42.258" class="difflineplus">+    this.waitingForClose = windowType;</span>
<a href="#l42.259"></a><span id="l42.259" class="difflineplus">+  },</span>
<a href="#l42.260"></a><span id="l42.260" class="difflineplus">+</span>
<a href="#l42.261"></a><span id="l42.261" class="difflineplus">+  /**</span>
<a href="#l42.262"></a><span id="l42.262" class="difflineplus">+   * The current windowType we are waiting to close.  Same deal as</span>
<a href="#l42.263"></a><span id="l42.263" class="difflineplus">+   *  waitingForOpen, this makes the eval less crazy.</span>
<a href="#l42.264"></a><span id="l42.264" class="difflineplus">+   */</span>
<a href="#l42.265"></a><span id="l42.265" class="difflineplus">+  waitingForClose: null,</span>
<a href="#l42.266"></a><span id="l42.266" class="difflineplus">+  waitForWindowClose: function WindowWatcher_waitForWindowClose() {</span>
<a href="#l42.267"></a><span id="l42.267" class="difflineplus">+    controller.waitForEval('subject.monitorizeClose()', NORMAL_TIMEOUT,</span>
<a href="#l42.268"></a><span id="l42.268" class="difflineplus">+                           FAST_INTERVAL, this);</span>
<a href="#l42.269"></a><span id="l42.269" class="difflineplus">+    let didDisappear = this.waitingList[this.waitingForClose] == null;</span>
<a href="#l42.270"></a><span id="l42.270" class="difflineplus">+    delete this.waitingList[windowType];</span>
<a href="#l42.271"></a><span id="l42.271" class="difflineplus">+    let windowType = this.waitingForClose;</span>
<a href="#l42.272"></a><span id="l42.272" class="difflineplus">+    this.waitingForClose = null;</span>
<a href="#l42.273"></a><span id="l42.273" class="difflineplus">+    if (!didDisappear)</span>
<a href="#l42.274"></a><span id="l42.274" class="difflineplus">+      throw new Error(windowType + &quot; window did not disappear!&quot;);</span>
<a href="#l42.275"></a><span id="l42.275" class="difflineplus">+  },</span>
<a href="#l42.276"></a><span id="l42.276" class="difflineplus">+</span>
<a href="#l42.277"></a><span id="l42.277" class="difflineplus">+  /**</span>
<a href="#l42.278"></a><span id="l42.278" class="difflineplus">+   * This notification gets called when windows tell the widnow mediator when</span>
<a href="#l42.279"></a><span id="l42.279" class="difflineplus">+   *  the window title gets changed.  In theory, we could use this to be</span>
<a href="#l42.280"></a><span id="l42.280" class="difflineplus">+   *  event driven with less polling (effort), but it is not to be.</span>
<a href="#l42.281"></a><span id="l42.281" class="difflineplus">+   */</span>
<a href="#l42.282"></a><span id="l42.282" class="difflineplus">+  onWindowTitleChange: function WindowWatcher_onWindowTitleChange(</span>
<a href="#l42.283"></a><span id="l42.283" class="difflineplus">+      aXULWindow, aNewTitle) {</span>
<a href="#l42.284"></a><span id="l42.284" class="difflineplus">+  },</span>
<a href="#l42.285"></a><span id="l42.285" class="difflineplus">+</span>
<a href="#l42.286"></a><span id="l42.286" class="difflineplus">+  /**</span>
<a href="#l42.287"></a><span id="l42.287" class="difflineplus">+   * Used by waitForWindowOpen to check all of the windows we are monitoring and</span>
<a href="#l42.288"></a><span id="l42.288" class="difflineplus">+   *  then check if we have any results.</span>
<a href="#l42.289"></a><span id="l42.289" class="difflineplus">+   *</span>
<a href="#l42.290"></a><span id="l42.290" class="difflineplus">+   * @return true if we found what we were |waitingForOpen|, false otherwise.</span>
<a href="#l42.291"></a><span id="l42.291" class="difflineplus">+   */</span>
<a href="#l42.292"></a><span id="l42.292" class="difflineplus">+  monitorizeOpen: function () {</span>
<a href="#l42.293"></a><span id="l42.293" class="difflineplus">+    for (let iWin = this.monitoringList.length - 1; iWin &gt;= 0; iWin--) {</span>
<a href="#l42.294"></a><span id="l42.294" class="difflineplus">+      let xulWindow = this.monitoringList[iWin];</span>
<a href="#l42.295"></a><span id="l42.295" class="difflineplus">+      if (this.consider(xulWindow))</span>
<a href="#l42.296"></a><span id="l42.296" class="difflineplus">+        this.monitoringList.splice(iWin, 1);</span>
<a href="#l42.297"></a><span id="l42.297" class="difflineplus">+    }</span>
<a href="#l42.298"></a><span id="l42.298" class="difflineplus">+</span>
<a href="#l42.299"></a><span id="l42.299" class="difflineplus">+    return this.waitingList[this.waitingForOpen] != null;</span>
<a href="#l42.300"></a><span id="l42.300" class="difflineplus">+  },</span>
<a href="#l42.301"></a><span id="l42.301" class="difflineplus">+</span>
<a href="#l42.302"></a><span id="l42.302" class="difflineplus">+  /**</span>
<a href="#l42.303"></a><span id="l42.303" class="difflineplus">+   * Used by waitForWindowClose to check if the window we are waiting to close</span>
<a href="#l42.304"></a><span id="l42.304" class="difflineplus">+   *  actually closed yet.</span>
<a href="#l42.305"></a><span id="l42.305" class="difflineplus">+   *</span>
<a href="#l42.306"></a><span id="l42.306" class="difflineplus">+   * @return true if it closed.</span>
<a href="#l42.307"></a><span id="l42.307" class="difflineplus">+   */</span>
<a href="#l42.308"></a><span id="l42.308" class="difflineplus">+  monitorizeClose: function () {</span>
<a href="#l42.309"></a><span id="l42.309" class="difflineplus">+    return this.waitingList[this.waitingForClose] == null;</span>
<a href="#l42.310"></a><span id="l42.310" class="difflineplus">+  },</span>
<a href="#l42.311"></a><span id="l42.311" class="difflineplus">+</span>
<a href="#l42.312"></a><span id="l42.312" class="difflineplus">+  /**</span>
<a href="#l42.313"></a><span id="l42.313" class="difflineplus">+   * A list of xul windows to monitor because they are loading and it's not yet</span>
<a href="#l42.314"></a><span id="l42.314" class="difflineplus">+   *  possible to tell whether they are something we are looking for.</span>
<a href="#l42.315"></a><span id="l42.315" class="difflineplus">+   */</span>
<a href="#l42.316"></a><span id="l42.316" class="difflineplus">+  monitoringList: [],</span>
<a href="#l42.317"></a><span id="l42.317" class="difflineplus">+  /**</span>
<a href="#l42.318"></a><span id="l42.318" class="difflineplus">+   * Monitor the given window's loading process until we can determine whether</span>
<a href="#l42.319"></a><span id="l42.319" class="difflineplus">+   *  it is what we are looking for.</span>
<a href="#l42.320"></a><span id="l42.320" class="difflineplus">+   */</span>
<a href="#l42.321"></a><span id="l42.321" class="difflineplus">+  monitorWindowLoad: function(aXULWindow) {</span>
<a href="#l42.322"></a><span id="l42.322" class="difflineplus">+    this.monitoringList.push(aXULWindow);</span>
<a href="#l42.323"></a><span id="l42.323" class="difflineplus">+  },</span>
<a href="#l42.324"></a><span id="l42.324" class="difflineplus">+</span>
<a href="#l42.325"></a><span id="l42.325" class="difflineplus">+  /**</span>
<a href="#l42.326"></a><span id="l42.326" class="difflineplus">+   * nsIWindowMediatorListener notification that a XUL window was opened.  We</span>
<a href="#l42.327"></a><span id="l42.327" class="difflineplus">+   *  check out the window, and if we were not able to fully consider it, we</span>
<a href="#l42.328"></a><span id="l42.328" class="difflineplus">+   *  add it to our monitoring list.</span>
<a href="#l42.329"></a><span id="l42.329" class="difflineplus">+   */</span>
<a href="#l42.330"></a><span id="l42.330" class="difflineplus">+  onOpenWindow: function WindowWatcher_onOpenWindow(aXULWindow) {</span>
<a href="#l42.331"></a><span id="l42.331" class="difflineplus">+    if (!this.consider(aXULWindow))</span>
<a href="#l42.332"></a><span id="l42.332" class="difflineplus">+      this.monitorWindowLoad(aXULWindow);</span>
<a href="#l42.333"></a><span id="l42.333" class="difflineplus">+  },</span>
<a href="#l42.334"></a><span id="l42.334" class="difflineplus">+</span>
<a href="#l42.335"></a><span id="l42.335" class="difflineplus">+  /**</span>
<a href="#l42.336"></a><span id="l42.336" class="difflineplus">+   * Consider if the given window is something in our |waitingList|.</span>
<a href="#l42.337"></a><span id="l42.337" class="difflineplus">+   *</span>
<a href="#l42.338"></a><span id="l42.338" class="difflineplus">+   * @return true if we were able to fully consider the object, false if we were</span>
<a href="#l42.339"></a><span id="l42.339" class="difflineplus">+   *     not and need to be called again on the window later.  This has no</span>
<a href="#l42.340"></a><span id="l42.340" class="difflineplus">+   *     relation to whether the window was one in our waitingList or not.</span>
<a href="#l42.341"></a><span id="l42.341" class="difflineplus">+   *     Check the waitingList structure for that.</span>
<a href="#l42.342"></a><span id="l42.342" class="difflineplus">+   */</span>
<a href="#l42.343"></a><span id="l42.343" class="difflineplus">+  consider: function (aXULWindow) {</span>
<a href="#l42.344"></a><span id="l42.344" class="difflineplus">+dump(&quot;### considering: &quot; + aXULWindow + &quot;\n&quot;);</span>
<a href="#l42.345"></a><span id="l42.345" class="difflineplus">+    let docshell = aXULWindow.docShell;</span>
<a href="#l42.346"></a><span id="l42.346" class="difflineplus">+    // we need the docshell to exist...</span>
<a href="#l42.347"></a><span id="l42.347" class="difflineplus">+    if (!docshell)</span>
<a href="#l42.348"></a><span id="l42.348" class="difflineplus">+      return false;</span>
<a href="#l42.349"></a><span id="l42.349" class="difflineplus">+dump(&quot;### has docshell\n&quot;);</span>
<a href="#l42.350"></a><span id="l42.350" class="difflineplus">+    // we can't know if it's the right document until it's not busy</span>
<a href="#l42.351"></a><span id="l42.351" class="difflineplus">+    if (docshell.busyFlags)</span>
<a href="#l42.352"></a><span id="l42.352" class="difflineplus">+      return false;</span>
<a href="#l42.353"></a><span id="l42.353" class="difflineplus">+dump(&quot;### not busy\n&quot;);</span>
<a href="#l42.354"></a><span id="l42.354" class="difflineplus">+    // it also needs to have content loaded (it starts out not busy with no</span>
<a href="#l42.355"></a><span id="l42.355" class="difflineplus">+    //  content viewer.)</span>
<a href="#l42.356"></a><span id="l42.356" class="difflineplus">+    if (docshell.contentViewer == null)</span>
<a href="#l42.357"></a><span id="l42.357" class="difflineplus">+      return false;</span>
<a href="#l42.358"></a><span id="l42.358" class="difflineplus">+dump(&quot;### has contentViewer\n&quot;);</span>
<a href="#l42.359"></a><span id="l42.359" class="difflineplus">+    // now we're cooking! let's get the document...</span>
<a href="#l42.360"></a><span id="l42.360" class="difflineplus">+    let outerDoc = docshell.contentViewer.DOMDocument;</span>
<a href="#l42.361"></a><span id="l42.361" class="difflineplus">+    // and make sure it's not blank.  that's also an intermediate state.</span>
<a href="#l42.362"></a><span id="l42.362" class="difflineplus">+    if (outerDoc.location.href == &quot;about:blank&quot;)</span>
<a href="#l42.363"></a><span id="l42.363" class="difflineplus">+      return false;</span>
<a href="#l42.364"></a><span id="l42.364" class="difflineplus">+dump(&quot;has href: &quot; + outerDoc.location.href + &quot;\n&quot;);</span>
<a href="#l42.365"></a><span id="l42.365" class="difflineplus">+    // finally, we can now have a windowtype!</span>
<a href="#l42.366"></a><span id="l42.366" class="difflineplus">+    let windowType = outerDoc.documentElement.getAttribute(&quot;windowtype&quot;);</span>
<a href="#l42.367"></a><span id="l42.367" class="difflineplus">+dump(&quot;has windowtype: &quot; + windowType + &quot;\n&quot;);</span>
<a href="#l42.368"></a><span id="l42.368" class="difflineplus">+dump(&quot;this: &quot; + this + &quot;\n&quot;);</span>
<a href="#l42.369"></a><span id="l42.369" class="difflineplus">+dump(&quot;waitingList: &quot; + this.waitingList + &quot;\n&quot;);</span>
<a href="#l42.370"></a><span id="l42.370" class="difflineplus">+    // stash the window if we were watching for it</span>
<a href="#l42.371"></a><span id="l42.371" class="difflineplus">+    if (windowType in this.waitingList) {</span>
<a href="#l42.372"></a><span id="l42.372" class="difflineplus">+      dump(&quot;It's there! setting...\n&quot;);</span>
<a href="#l42.373"></a><span id="l42.373" class="difflineplus">+      this.waitingList[windowType] = aXULWindow;</span>
<a href="#l42.374"></a><span id="l42.374" class="difflineplus">+    }</span>
<a href="#l42.375"></a><span id="l42.375" class="difflineplus">+    else {</span>
<a href="#l42.376"></a><span id="l42.376" class="difflineplus">+      dump(&quot;Not there! :( SCREWED\n&quot;);</span>
<a href="#l42.377"></a><span id="l42.377" class="difflineplus">+    }</span>
<a href="#l42.378"></a><span id="l42.378" class="difflineplus">+</span>
<a href="#l42.379"></a><span id="l42.379" class="difflineplus">+    return true;</span>
<a href="#l42.380"></a><span id="l42.380" class="difflineplus">+  },</span>
<a href="#l42.381"></a><span id="l42.381" class="difflineplus">+</span>
<a href="#l42.382"></a><span id="l42.382" class="difflineplus">+  /**</span>
<a href="#l42.383"></a><span id="l42.383" class="difflineplus">+   * Closing windows have the advantage of having to already have been loaded,</span>
<a href="#l42.384"></a><span id="l42.384" class="difflineplus">+   *  so things like their windowtype are immediately available.</span>
<a href="#l42.385"></a><span id="l42.385" class="difflineplus">+   */</span>
<a href="#l42.386"></a><span id="l42.386" class="difflineplus">+  onCloseWindow: function WindowWatcher_onCloseWindow(aXULWindow) {</span>
<a href="#l42.387"></a><span id="l42.387" class="difflineplus">+    dump(&quot;!!! CLOSE EVENT: &quot; + aXULWindow + &quot;\n&quot;);</span>
<a href="#l42.388"></a><span id="l42.388" class="difflineplus">+    let domWindow = aXULWindow.docShell.QueryInterface(Ci.nsIInterfaceRequestor)</span>
<a href="#l42.389"></a><span id="l42.389" class="difflineplus">+                                       .getInterface(Ci.nsIDOMWindowInternal);</span>
<a href="#l42.390"></a><span id="l42.390" class="difflineplus">+    let windowType =</span>
<a href="#l42.391"></a><span id="l42.391" class="difflineplus">+      domWindow.document.documentElement.getAttribute(&quot;windowtype&quot;);</span>
<a href="#l42.392"></a><span id="l42.392" class="difflineplus">+    // XXX because of how we dance with things, equivalence is not gonna</span>
<a href="#l42.393"></a><span id="l42.393" class="difflineplus">+    //  happen for us.  This is most pragmatic.</span>
<a href="#l42.394"></a><span id="l42.394" class="difflineplus">+    if (this.waitingList[windowType] !== null)</span>
<a href="#l42.395"></a><span id="l42.395" class="difflineplus">+      this.waitingList[windowType] = null;</span>
<a href="#l42.396"></a><span id="l42.396" class="difflineplus">+    dump(&quot;close end proc\n&quot;);</span>
<a href="#l42.397"></a><span id="l42.397" class="difflineplus">+  },</span>
<a href="#l42.398"></a><span id="l42.398" class="difflineplus">+};</span>
<a href="#l42.399"></a><span id="l42.399" class="difflineplus">+</span>
<a href="#l42.400"></a><span id="l42.400" class="difflineplus">+/**</span>
<a href="#l42.401"></a><span id="l42.401" class="difflineplus">+ * Call this if the window you want to get may already be open.  What we</span>
<a href="#l42.402"></a><span id="l42.402" class="difflineplus">+ *  provide above just directly grabbing the window yourself is:</span>
<a href="#l42.403"></a><span id="l42.403" class="difflineplus">+ * - We wait for it to finish loading.</span>
<a href="#l42.404"></a><span id="l42.404" class="difflineplus">+ * - We augment it via the augment_controller mechanism.</span>
<a href="#l42.405"></a><span id="l42.405" class="difflineplus">+ *</span>
<a href="#l42.406"></a><span id="l42.406" class="difflineplus">+ * @param aWindowType the window type that will be created.  This is literally</span>
<a href="#l42.407"></a><span id="l42.407" class="difflineplus">+ *     the value of the &quot;windowtype&quot; attribute on the window.  The values tend</span>
<a href="#l42.408"></a><span id="l42.408" class="difflineplus">+ *     to look like &quot;app:windowname&quot;, for example &quot;mailnews:search&quot;.</span>
<a href="#l42.409"></a><span id="l42.409" class="difflineplus">+ *</span>
<a href="#l42.410"></a><span id="l42.410" class="difflineplus">+ * @return The loaded window of the given type wrapped in a MozmillController</span>
<a href="#l42.411"></a><span id="l42.411" class="difflineplus">+ *     that is augmented using augment_controller.</span>
<a href="#l42.412"></a><span id="l42.412" class="difflineplus">+ */</span>
<a href="#l42.413"></a><span id="l42.413" class="difflineplus">+function wait_for_existing_window(aWindowType) {</span>
<a href="#l42.414"></a><span id="l42.414" class="difflineplus">+  WindowWatcher.ensureInited();</span>
<a href="#l42.415"></a><span id="l42.415" class="difflineplus">+  WindowWatcher.planForAlreadyOpenWindow(aWindowType);</span>
<a href="#l42.416"></a><span id="l42.416" class="difflineplus">+  return augment_controller(WindowWatcher.waitForWindowOpen(aWindowType),</span>
<a href="#l42.417"></a><span id="l42.417" class="difflineplus">+                            aWindowType);</span>
<a href="#l42.418"></a><span id="l42.418" class="difflineplus">+}</span>
<a href="#l42.419"></a><span id="l42.419" class="difflineplus">+</span>
<a href="#l42.420"></a><span id="l42.420" class="difflineplus">+/**</span>
<a href="#l42.421"></a><span id="l42.421" class="difflineplus">+ * Call this just before you trigger the event that will cause a window to be</span>
<a href="#l42.422"></a><span id="l42.422" class="difflineplus">+ *  displayed.</span>
<a href="#l42.423"></a><span id="l42.423" class="difflineplus">+ * In theory, we don't need this and could just do a sweep of existing windows</span>
<a href="#l42.424"></a><span id="l42.424" class="difflineplus">+ *  when you call wait_for_new_window, or we could always just keep track of</span>
<a href="#l42.425"></a><span id="l42.425" class="difflineplus">+ *  the most recently seen window of each type, but this is arguably more</span>
<a href="#l42.426"></a><span id="l42.426" class="difflineplus">+ *  resilient in the face of multiple windows of the same type as long as you</span>
<a href="#l42.427"></a><span id="l42.427" class="difflineplus">+ *  don't try and open them all at the same time.</span>
<a href="#l42.428"></a><span id="l42.428" class="difflineplus">+ *</span>
<a href="#l42.429"></a><span id="l42.429" class="difflineplus">+ * @param aWindowType the window type that will be created.  This is literally</span>
<a href="#l42.430"></a><span id="l42.430" class="difflineplus">+ *     the value of the &quot;windowtype&quot; attribute on the window.  The values tend</span>
<a href="#l42.431"></a><span id="l42.431" class="difflineplus">+ *     to look like &quot;app:windowname&quot;, for example &quot;mailnews:search&quot;.</span>
<a href="#l42.432"></a><span id="l42.432" class="difflineplus">+ */</span>
<a href="#l42.433"></a><span id="l42.433" class="difflineplus">+function plan_for_new_window(aWindowType) {</span>
<a href="#l42.434"></a><span id="l42.434" class="difflineplus">+  WindowWatcher.ensureInited();</span>
<a href="#l42.435"></a><span id="l42.435" class="difflineplus">+  WindowWatcher.planForWindowOpen(aWindowType);</span>
<a href="#l42.436"></a><span id="l42.436" class="difflineplus">+}</span>
<a href="#l42.437"></a><span id="l42.437" class="difflineplus">+</span>
<a href="#l42.438"></a><span id="l42.438" class="difflineplus">+</span>
<a href="#l42.439"></a><span id="l42.439" class="difflineplus">+/**</span>
<a href="#l42.440"></a><span id="l42.440" class="difflineplus">+ * Wait for the loading of the given window type to complete (that you</span>
<a href="#l42.441"></a><span id="l42.441" class="difflineplus">+ *  previously told us about via |plan_for_new_window|), returning it wrapped</span>
<a href="#l42.442"></a><span id="l42.442" class="difflineplus">+ *  in a MozmillController.</span>
<a href="#l42.443"></a><span id="l42.443" class="difflineplus">+ *</span>
<a href="#l42.444"></a><span id="l42.444" class="difflineplus">+ * @return The loaded window of the given type wrapped in a MozmillController</span>
<a href="#l42.445"></a><span id="l42.445" class="difflineplus">+ *     that is augmented using augment_controller.</span>
<a href="#l42.446"></a><span id="l42.446" class="difflineplus">+ */</span>
<a href="#l42.447"></a><span id="l42.447" class="difflineplus">+function wait_for_new_window(aWindowType) {</span>
<a href="#l42.448"></a><span id="l42.448" class="difflineplus">+  return augment_controller(WindowWatcher.waitForWindowOpen(aWindowType),</span>
<a href="#l42.449"></a><span id="l42.449" class="difflineplus">+                            aWindowType);</span>
<a href="#l42.450"></a><span id="l42.450" class="difflineplus">+}</span>
<a href="#l42.451"></a><span id="l42.451" class="difflineplus">+</span>
<a href="#l42.452"></a><span id="l42.452" class="difflineplus">+/**</span>
<a href="#l42.453"></a><span id="l42.453" class="difflineplus">+ * Plan for the imminent display of a modal dialog.  Modal dialogs spin their</span>
<a href="#l42.454"></a><span id="l42.454" class="difflineplus">+ *  own event loop which means that either that control flow will not return</span>
<a href="#l42.455"></a><span id="l42.455" class="difflineplus">+ *  to the caller until the modal dialog finishes running.  This means that</span>
<a href="#l42.456"></a><span id="l42.456" class="difflineplus">+ *  you need to provide a sub-test function to be run inside the modal dialog</span>
<a href="#l42.457"></a><span id="l42.457" class="difflineplus">+ *  (and it should not start with &quot;test&quot; or mozmill will also try and run it.)</span>
<a href="#l42.458"></a><span id="l42.458" class="difflineplus">+ *</span>
<a href="#l42.459"></a><span id="l42.459" class="difflineplus">+ * @param aWindowType The window type that you expect the modal dialog to have.</span>
<a href="#l42.460"></a><span id="l42.460" class="difflineplus">+ * @param aSubTestFunction The sub-test function that will be run once the modal</span>
<a href="#l42.461"></a><span id="l42.461" class="difflineplus">+ *     dialog appears and is loaded.  This function should take one argument,</span>
<a href="#l42.462"></a><span id="l42.462" class="difflineplus">+ *     a MozmillController against the modal dialog.</span>
<a href="#l42.463"></a><span id="l42.463" class="difflineplus">+ */</span>
<a href="#l42.464"></a><span id="l42.464" class="difflineplus">+function plan_for_modal_dialog(aWindowType, aSubTestFunction) {</span>
<a href="#l42.465"></a><span id="l42.465" class="difflineplus">+  WindowWatcher.ensureInited();</span>
<a href="#l42.466"></a><span id="l42.466" class="difflineplus">+  WindowWatcher.planForModalDialog(aWindowType, aSubTestFunction);</span>
<a href="#l42.467"></a><span id="l42.467" class="difflineplus">+}</span>
<a href="#l42.468"></a><span id="l42.468" class="difflineplus">+function wait_for_modal_dialog(aWindowType) {</span>
<a href="#l42.469"></a><span id="l42.469" class="difflineplus">+  WindowWatcher.waitForModalDialog(aWindowType);</span>
<a href="#l42.470"></a><span id="l42.470" class="difflineplus">+}</span>
<a href="#l42.471"></a><span id="l42.471" class="difflineplus">+</span>
<a href="#l42.472"></a><span id="l42.472" class="difflineplus">+/**</span>
<a href="#l42.473"></a><span id="l42.473" class="difflineplus">+ * Call this just before you trigger the event that will cause the provided</span>
<a href="#l42.474"></a><span id="l42.474" class="difflineplus">+ *  controller's window to disappear.  You then follow this with a call to</span>
<a href="#l42.475"></a><span id="l42.475" class="difflineplus">+ *  |wait_for_window_close| when you want to block on verifying the close.</span>
<a href="#l42.476"></a><span id="l42.476" class="difflineplus">+ *</span>
<a href="#l42.477"></a><span id="l42.477" class="difflineplus">+ * @param aController The MozmillController, potentially returned from a call to</span>
<a href="#l42.478"></a><span id="l42.478" class="difflineplus">+ *     wait_for_new_window, whose window should be disappearing.</span>
<a href="#l42.479"></a><span id="l42.479" class="difflineplus">+ */</span>
<a href="#l42.480"></a><span id="l42.480" class="difflineplus">+function plan_for_window_close(aController) {</span>
<a href="#l42.481"></a><span id="l42.481" class="difflineplus">+  WindowWatcher.ensureInited();</span>
<a href="#l42.482"></a><span id="l42.482" class="difflineplus">+  WindowWatcher.planForWindowClose(aController.window);</span>
<a href="#l42.483"></a><span id="l42.483" class="difflineplus">+}</span>
<a href="#l42.484"></a><span id="l42.484" class="difflineplus">+</span>
<a href="#l42.485"></a><span id="l42.485" class="difflineplus">+/**</span>
<a href="#l42.486"></a><span id="l42.486" class="difflineplus">+ * Wait for the closure of the window you noted you would listen for its close</span>
<a href="#l42.487"></a><span id="l42.487" class="difflineplus">+ *  in plan_for_window_close.</span>
<a href="#l42.488"></a><span id="l42.488" class="difflineplus">+ */</span>
<a href="#l42.489"></a><span id="l42.489" class="difflineplus">+function wait_for_window_close() {</span>
<a href="#l42.490"></a><span id="l42.490" class="difflineplus">+  WindowWatcher.waitForWindowClose();</span>
<a href="#l42.491"></a><span id="l42.491" class="difflineplus">+}</span>
<a href="#l42.492"></a><span id="l42.492" class="difflineplus">+</span>
<a href="#l42.493"></a><span id="l42.493" class="difflineplus">+/**</span>
<a href="#l42.494"></a><span id="l42.494" class="difflineplus">+ * Methods to augment every controller that passes through augment_controller.</span>
<a href="#l42.495"></a><span id="l42.495" class="difflineplus">+ */</span>
<a href="#l42.496"></a><span id="l42.496" class="difflineplus">+var AugmentEverybodyWith = {</span>
<a href="#l42.497"></a><span id="l42.497" class="difflineplus">+  methods: {</span>
<a href="#l42.498"></a><span id="l42.498" class="difflineplus">+    /**</span>
<a href="#l42.499"></a><span id="l42.499" class="difflineplus">+     * @param aId The element id to use to locate the (initial) element.</span>
<a href="#l42.500"></a><span id="l42.500" class="difflineplus">+     * @param aQuery Optional query to pick a child of the element identified</span>
<a href="#l42.501"></a><span id="l42.501" class="difflineplus">+     *   by the id.  Terms that can be used (and applied in this order):</span>
<a href="#l42.502"></a><span id="l42.502" class="difflineplus">+     * - tagName: Find children with the tagname, if further constraints don't</span>
<a href="#l42.503"></a><span id="l42.503" class="difflineplus">+     *     whittle it down, the first element is chosen.</span>
<a href="#l42.504"></a><span id="l42.504" class="difflineplus">+     * - label: Whittle previous elements by their label.</span>
<a href="#l42.505"></a><span id="l42.505" class="difflineplus">+     *</span>
<a href="#l42.506"></a><span id="l42.506" class="difflineplus">+     * example:</span>
<a href="#l42.507"></a><span id="l42.507" class="difflineplus">+     *  // find the child of bob that is a button with a &quot;+&quot; on it.</span>
<a href="#l42.508"></a><span id="l42.508" class="difflineplus">+     *  e(&quot;bob&quot;, {tagName: &quot;button&quot;, label: &quot;+&quot;});</span>
<a href="#l42.509"></a><span id="l42.509" class="difflineplus">+     *  // example:</span>
<a href="#l42.510"></a><span id="l42.510" class="difflineplus">+     *  e(&quot;threadTree&quot;, {tagName: &quot;treechildren&quot;});</span>
<a href="#l42.511"></a><span id="l42.511" class="difflineplus">+     *</span>
<a href="#l42.512"></a><span id="l42.512" class="difflineplus">+     * @return the element with the given id on the window's document</span>
<a href="#l42.513"></a><span id="l42.513" class="difflineplus">+     */</span>
<a href="#l42.514"></a><span id="l42.514" class="difflineplus">+    e: function _get_element_by_id_helper(aId, aQuery) {</span>
<a href="#l42.515"></a><span id="l42.515" class="difflineplus">+      let elem = this.window.document.getElementById(aId);</span>
<a href="#l42.516"></a><span id="l42.516" class="difflineplus">+      if (aQuery) {</span>
<a href="#l42.517"></a><span id="l42.517" class="difflineplus">+        if (aQuery.tagName) {</span>
<a href="#l42.518"></a><span id="l42.518" class="difflineplus">+          let elems = Array.slice.call(</span>
<a href="#l42.519"></a><span id="l42.519" class="difflineplus">+                        elem.getElementsByTagName(aQuery.tagName));</span>
<a href="#l42.520"></a><span id="l42.520" class="difflineplus">+          if (aQuery.label)</span>
<a href="#l42.521"></a><span id="l42.521" class="difflineplus">+            elems = [elem for each (elem in elems)</span>
<a href="#l42.522"></a><span id="l42.522" class="difflineplus">+                          if (elem.label == aQuery.label)];</span>
<a href="#l42.523"></a><span id="l42.523" class="difflineplus">+          elem = elems[0];</span>
<a href="#l42.524"></a><span id="l42.524" class="difflineplus">+        }</span>
<a href="#l42.525"></a><span id="l42.525" class="difflineplus">+      }</span>
<a href="#l42.526"></a><span id="l42.526" class="difflineplus">+      return elem;</span>
<a href="#l42.527"></a><span id="l42.527" class="difflineplus">+    },</span>
<a href="#l42.528"></a><span id="l42.528" class="difflineplus">+</span>
<a href="#l42.529"></a><span id="l42.529" class="difflineplus">+    /**</span>
<a href="#l42.530"></a><span id="l42.530" class="difflineplus">+     * @return an elementlib.Elem for the element with the given id on the</span>
<a href="#l42.531"></a><span id="l42.531" class="difflineplus">+     *  window's document.</span>
<a href="#l42.532"></a><span id="l42.532" class="difflineplus">+     */</span>
<a href="#l42.533"></a><span id="l42.533" class="difflineplus">+    eid: function _get_elementid_by_id_helper(aId, aQuery) {</span>
<a href="#l42.534"></a><span id="l42.534" class="difflineplus">+      return new elib.Elem(this.e(aId, aQuery));</span>
<a href="#l42.535"></a><span id="l42.535" class="difflineplus">+    },</span>
<a href="#l42.536"></a><span id="l42.536" class="difflineplus">+</span>
<a href="#l42.537"></a><span id="l42.537" class="difflineplus">+    /**</span>
<a href="#l42.538"></a><span id="l42.538" class="difflineplus">+     * Find an element in the anonymous subtree of an element in the document</span>
<a href="#l42.539"></a><span id="l42.539" class="difflineplus">+     *  identified by its id.  You would use this to dig into XBL bindings that</span>
<a href="#l42.540"></a><span id="l42.540" class="difflineplus">+     *  are not doing what you want.  For example, jerks that don't focus right.</span>
<a href="#l42.541"></a><span id="l42.541" class="difflineplus">+     *</span>
<a href="#l42.542"></a><span id="l42.542" class="difflineplus">+     * Examples:</span>
<a href="#l42.543"></a><span id="l42.543" class="difflineplus">+     *  // by class of the node</span>
<a href="#l42.544"></a><span id="l42.544" class="difflineplus">+     *  a(&quot;searchVal0&quot;, {class: &quot;search-value-textbox&quot;});</span>
<a href="#l42.545"></a><span id="l42.545" class="difflineplus">+     *  // when the thing is vaguely deck-like</span>
<a href="#l42.546"></a><span id="l42.546" class="difflineplus">+     *  a(&quot;searchVal0&quot;, {crazyDeck: 0});</span>
<a href="#l42.547"></a><span id="l42.547" class="difflineplus">+     *  // when you want the first descendent with the given tagName</span>
<a href="#l42.548"></a><span id="l42.548" class="difflineplus">+     *  a(&quot;threadTree&quot;, {tagName: treechildren})</span>
<a href="#l42.549"></a><span id="l42.549" class="difflineplus">+     *</span>
<a href="#l42.550"></a><span id="l42.550" class="difflineplus">+     * @return the anonymous element determined by the query found in the</span>
<a href="#l42.551"></a><span id="l42.551" class="difflineplus">+     *  anonymous sub-tree of the element with the given id.</span>
<a href="#l42.552"></a><span id="l42.552" class="difflineplus">+     */</span>
<a href="#l42.553"></a><span id="l42.553" class="difflineplus">+    a: function _get_anon_element_by_id_and_query(aId, aQuery) {</span>
<a href="#l42.554"></a><span id="l42.554" class="difflineplus">+      let realElem = this.window.document.getElementById(aId);</span>
<a href="#l42.555"></a><span id="l42.555" class="difflineplus">+      if (aQuery[&quot;class&quot;]) {</span>
<a href="#l42.556"></a><span id="l42.556" class="difflineplus">+        return this.window.document.getAnonymousElementByAttribute(</span>
<a href="#l42.557"></a><span id="l42.557" class="difflineplus">+          realElem, &quot;class&quot;, aQuery[&quot;class&quot;]);</span>
<a href="#l42.558"></a><span id="l42.558" class="difflineplus">+      }</span>
<a href="#l42.559"></a><span id="l42.559" class="difflineplus">+      else if(aQuery.crazyDeck != null) {</span>
<a href="#l42.560"></a><span id="l42.560" class="difflineplus">+        let anonNodes = this.window.document.getAnonymousNodes(realElem);</span>
<a href="#l42.561"></a><span id="l42.561" class="difflineplus">+        let index;</span>
<a href="#l42.562"></a><span id="l42.562" class="difflineplus">+        if (realElem.hasAttribute(&quot;selectedIndex&quot;))</span>
<a href="#l42.563"></a><span id="l42.563" class="difflineplus">+          index = parseInt(realElem.getAttribute(&quot;selectedIndex&quot;));</span>
<a href="#l42.564"></a><span id="l42.564" class="difflineplus">+        else</span>
<a href="#l42.565"></a><span id="l42.565" class="difflineplus">+          index = aQuery.crazyDeck;</span>
<a href="#l42.566"></a><span id="l42.566" class="difflineplus">+        let elem = anonNodes[index];</span>
<a href="#l42.567"></a><span id="l42.567" class="difflineplus">+        return elem;</span>
<a href="#l42.568"></a><span id="l42.568" class="difflineplus">+      }</span>
<a href="#l42.569"></a><span id="l42.569" class="difflineplus">+      else if(aQuery.tagName) {</span>
<a href="#l42.570"></a><span id="l42.570" class="difflineplus">+        let anonNodes = this.window.document.getAnonymousNodes(realElem);</span>
<a href="#l42.571"></a><span id="l42.571" class="difflineplus">+        let index;</span>
<a href="#l42.572"></a><span id="l42.572" class="difflineplus">+        for (let iNode = 0; iNode &lt; anonNodes.length; iNode++) {</span>
<a href="#l42.573"></a><span id="l42.573" class="difflineplus">+          let node = anonNodes[iNode];</span>
<a href="#l42.574"></a><span id="l42.574" class="difflineplus">+          let named = node.getElementsByTagName(aQuery.tagName);</span>
<a href="#l42.575"></a><span id="l42.575" class="difflineplus">+          if (named.length)</span>
<a href="#l42.576"></a><span id="l42.576" class="difflineplus">+            return named[0];</span>
<a href="#l42.577"></a><span id="l42.577" class="difflineplus">+        }</span>
<a href="#l42.578"></a><span id="l42.578" class="difflineplus">+      }</span>
<a href="#l42.579"></a><span id="l42.579" class="difflineplus">+      else {</span>
<a href="#l42.580"></a><span id="l42.580" class="difflineplus">+        let msg = &quot;Query constraint not implemented, query contained:&quot;;</span>
<a href="#l42.581"></a><span id="l42.581" class="difflineplus">+        for (let [key, val] in Iterator(aQuery)) {</span>
<a href="#l42.582"></a><span id="l42.582" class="difflineplus">+          msg += &quot; '&quot; + key + &quot;': &quot; + val;</span>
<a href="#l42.583"></a><span id="l42.583" class="difflineplus">+        }</span>
<a href="#l42.584"></a><span id="l42.584" class="difflineplus">+        throw new Error(msg);</span>
<a href="#l42.585"></a><span id="l42.585" class="difflineplus">+      }</span>
<a href="#l42.586"></a><span id="l42.586" class="difflineplus">+      return null;</span>
<a href="#l42.587"></a><span id="l42.587" class="difflineplus">+    },</span>
<a href="#l42.588"></a><span id="l42.588" class="difflineplus">+    /**</span>
<a href="#l42.589"></a><span id="l42.589" class="difflineplus">+     * Wraps a call to a() in an elib.Elem.</span>
<a href="#l42.590"></a><span id="l42.590" class="difflineplus">+     */</span>
<a href="#l42.591"></a><span id="l42.591" class="difflineplus">+    aid: function _get_anon_elementid(aId, aQuery) {</span>
<a href="#l42.592"></a><span id="l42.592" class="difflineplus">+      return new elib.Elem(this.a(aId, aQuery));</span>
<a href="#l42.593"></a><span id="l42.593" class="difflineplus">+    },</span>
<a href="#l42.594"></a><span id="l42.594" class="difflineplus">+  },</span>
<a href="#l42.595"></a><span id="l42.595" class="difflineplus">+};</span>
<a href="#l42.596"></a><span id="l42.596" class="difflineplus">+</span>
<a href="#l42.597"></a><span id="l42.597" class="difflineplus">+/**</span>
<a href="#l42.598"></a><span id="l42.598" class="difflineplus">+ * Per-windowtype augmentations.  Please use the documentation and general</span>
<a href="#l42.599"></a><span id="l42.599" class="difflineplus">+ *  example of mail:3pane as your example.</span>
<a href="#l42.600"></a><span id="l42.600" class="difflineplus">+ */</span>
<a href="#l42.601"></a><span id="l42.601" class="difflineplus">+var PerWindowTypeAugmentations = {</span>
<a href="#l42.602"></a><span id="l42.602" class="difflineplus">+  /**</span>
<a href="#l42.603"></a><span id="l42.603" class="difflineplus">+   * The 3pane window is messenger.xul, the default window.</span>
<a href="#l42.604"></a><span id="l42.604" class="difflineplus">+   */</span>
<a href="#l42.605"></a><span id="l42.605" class="difflineplus">+  &quot;mail:3pane&quot;: {</span>
<a href="#l42.606"></a><span id="l42.606" class="difflineplus">+    /**</span>
<a href="#l42.607"></a><span id="l42.607" class="difflineplus">+     * DOM elements to expose as attributes (by copying at augmentation time.)</span>
<a href="#l42.608"></a><span id="l42.608" class="difflineplus">+     */</span>
<a href="#l42.609"></a><span id="l42.609" class="difflineplus">+    elementsToExpose: {</span>
<a href="#l42.610"></a><span id="l42.610" class="difflineplus">+      threadTree: &quot;threadTree&quot;,</span>
<a href="#l42.611"></a><span id="l42.611" class="difflineplus">+      tabmail: &quot;tabmail&quot;,</span>
<a href="#l42.612"></a><span id="l42.612" class="difflineplus">+    },</span>
<a href="#l42.613"></a><span id="l42.613" class="difflineplus">+    /**</span>
<a href="#l42.614"></a><span id="l42.614" class="difflineplus">+     * DOM elements to expose as elementslib.IDs as attributes (at augmentation</span>
<a href="#l42.615"></a><span id="l42.615" class="difflineplus">+     *  time.)</span>
<a href="#l42.616"></a><span id="l42.616" class="difflineplus">+     */</span>
<a href="#l42.617"></a><span id="l42.617" class="difflineplus">+    elementIDsToExpose: {</span>
<a href="#l42.618"></a><span id="l42.618" class="difflineplus">+      eThreadTree: &quot;threadTree&quot;,</span>
<a href="#l42.619"></a><span id="l42.619" class="difflineplus">+    },</span>
<a href="#l42.620"></a><span id="l42.620" class="difflineplus">+    /**</span>
<a href="#l42.621"></a><span id="l42.621" class="difflineplus">+     * Globals from the controller's windows global scope at augmentation time.</span>
<a href="#l42.622"></a><span id="l42.622" class="difflineplus">+     */</span>
<a href="#l42.623"></a><span id="l42.623" class="difflineplus">+    globalsToExposeAtStartup: {</span>
<a href="#l42.624"></a><span id="l42.624" class="difflineplus">+      folderTreeView: &quot;gFolderTreeView&quot;,</span>
<a href="#l42.625"></a><span id="l42.625" class="difflineplus">+    },</span>
<a href="#l42.626"></a><span id="l42.626" class="difflineplus">+    /**</span>
<a href="#l42.627"></a><span id="l42.627" class="difflineplus">+     * Globals from the controller's windows global to retrieve on-demand</span>
<a href="#l42.628"></a><span id="l42.628" class="difflineplus">+     *  through getters.</span>
<a href="#l42.629"></a><span id="l42.629" class="difflineplus">+     */</span>
<a href="#l42.630"></a><span id="l42.630" class="difflineplus">+    globalsToExposeViaGetters: {</span>
<a href="#l42.631"></a><span id="l42.631" class="difflineplus">+      // all of these dudes</span>
<a href="#l42.632"></a><span id="l42.632" class="difflineplus">+      folderDisplay: &quot;gFolderDisplay&quot;,</span>
<a href="#l42.633"></a><span id="l42.633" class="difflineplus">+      messageDisplay: &quot;gMessageDisplay&quot;,</span>
<a href="#l42.634"></a><span id="l42.634" class="difflineplus">+    },</span>
<a href="#l42.635"></a><span id="l42.635" class="difflineplus">+    /**</span>
<a href="#l42.636"></a><span id="l42.636" class="difflineplus">+     * Custom getters whose |this| is the controller.</span>
<a href="#l42.637"></a><span id="l42.637" class="difflineplus">+     */</span>
<a href="#l42.638"></a><span id="l42.638" class="difflineplus">+    getters: {</span>
<a href="#l42.639"></a><span id="l42.639" class="difflineplus">+      dbView: function () {</span>
<a href="#l42.640"></a><span id="l42.640" class="difflineplus">+        return this.threadTree.view.QueryInterface(Ci.nsIMsgDBView);</span>
<a href="#l42.641"></a><span id="l42.641" class="difflineplus">+      },</span>
<a href="#l42.642"></a><span id="l42.642" class="difflineplus">+    },</span>
<a href="#l42.643"></a><span id="l42.643" class="difflineplus">+</span>
<a href="#l42.644"></a><span id="l42.644" class="difflineplus">+    /**</span>
<a href="#l42.645"></a><span id="l42.645" class="difflineplus">+     * Invoked when we are augmenting a controller.  This is a great time to</span>
<a href="#l42.646"></a><span id="l42.646" class="difflineplus">+     *  poke into the global namespace as required.</span>
<a href="#l42.647"></a><span id="l42.647" class="difflineplus">+     */</span>
<a href="#l42.648"></a><span id="l42.648" class="difflineplus">+    onAugment: function(aController) {</span>
<a href="#l42.649"></a><span id="l42.649" class="difflineplus">+      // -- turn off summarization's stabilization logic for now by setting the</span>
<a href="#l42.650"></a><span id="l42.650" class="difflineplus">+      //  timer interval to 0.  We do need to make sure that we drain the event</span>
<a href="#l42.651"></a><span id="l42.651" class="difflineplus">+      //  queue after performing anything that will summarize, but use of</span>
<a href="#l42.652"></a><span id="l42.652" class="difflineplus">+      //  assert_selected_and_displayed in test-folder-display-helpers should</span>
<a href="#l42.653"></a><span id="l42.653" class="difflineplus">+      //  handle that.</span>
<a href="#l42.654"></a><span id="l42.654" class="difflineplus">+      aController.window.MessageDisplayWidget.prototype</span>
<a href="#l42.655"></a><span id="l42.655" class="difflineplus">+                 .SUMMARIZATION_SELECTION_STABILITY_INTERVAL_MS = 0;</span>
<a href="#l42.656"></a><span id="l42.656" class="difflineplus">+    }</span>
<a href="#l42.657"></a><span id="l42.657" class="difflineplus">+  },</span>
<a href="#l42.658"></a><span id="l42.658" class="difflineplus">+</span>
<a href="#l42.659"></a><span id="l42.659" class="difflineplus">+  /**</span>
<a href="#l42.660"></a><span id="l42.660" class="difflineplus">+   * Standalone message window.</span>
<a href="#l42.661"></a><span id="l42.661" class="difflineplus">+   */</span>
<a href="#l42.662"></a><span id="l42.662" class="difflineplus">+  &quot;mail:messageWindow&quot;: {</span>
<a href="#l42.663"></a><span id="l42.663" class="difflineplus">+    // the load is deferred, so use a getter.</span>
<a href="#l42.664"></a><span id="l42.664" class="difflineplus">+    globalsToExposeViaGetters: {</span>
<a href="#l42.665"></a><span id="l42.665" class="difflineplus">+      folderDisplay: &quot;gFolderDisplay&quot;,</span>
<a href="#l42.666"></a><span id="l42.666" class="difflineplus">+      messageDisplay: &quot;gMessageDisplay&quot;,</span>
<a href="#l42.667"></a><span id="l42.667" class="difflineplus">+    },</span>
<a href="#l42.668"></a><span id="l42.668" class="difflineplus">+    getters: {</span>
<a href="#l42.669"></a><span id="l42.669" class="difflineplus">+      dbView: function () {</span>
<a href="#l42.670"></a><span id="l42.670" class="difflineplus">+        return this.folderDisplay.view.dbView;</span>
<a href="#l42.671"></a><span id="l42.671" class="difflineplus">+      },</span>
<a href="#l42.672"></a><span id="l42.672" class="difflineplus">+    },</span>
<a href="#l42.673"></a><span id="l42.673" class="difflineplus">+  },</span>
<a href="#l42.674"></a><span id="l42.674" class="difflineplus">+</span>
<a href="#l42.675"></a><span id="l42.675" class="difflineplus">+  /**</span>
<a href="#l42.676"></a><span id="l42.676" class="difflineplus">+   * The search window, via control-shift-F.</span>
<a href="#l42.677"></a><span id="l42.677" class="difflineplus">+   */</span>
<a href="#l42.678"></a><span id="l42.678" class="difflineplus">+  &quot;mailnews:search&quot;: {</span>
<a href="#l42.679"></a><span id="l42.679" class="difflineplus">+    globalsToExposeAtStartup: {</span>
<a href="#l42.680"></a><span id="l42.680" class="difflineplus">+      folderDisplay: &quot;gFolderDisplay&quot;,</span>
<a href="#l42.681"></a><span id="l42.681" class="difflineplus">+    }</span>
<a href="#l42.682"></a><span id="l42.682" class="difflineplus">+  }</span>
<a href="#l42.683"></a><span id="l42.683" class="difflineplus">+};</span>
<a href="#l42.684"></a><span id="l42.684" class="difflineplus">+</span>
<a href="#l42.685"></a><span id="l42.685" class="difflineplus">+function _augment_helper(aController, aAugmentDef) {</span>
<a href="#l42.686"></a><span id="l42.686" class="difflineplus">+  if (aAugmentDef.elementsToExpose) {</span>
<a href="#l42.687"></a><span id="l42.687" class="difflineplus">+    for each (let [key, value] in Iterator(aAugmentDef.elementsToExpose)) {</span>
<a href="#l42.688"></a><span id="l42.688" class="difflineplus">+      aController[key] = aController.window.document.getElementById(value);</span>
<a href="#l42.689"></a><span id="l42.689" class="difflineplus">+    }</span>
<a href="#l42.690"></a><span id="l42.690" class="difflineplus">+  }</span>
<a href="#l42.691"></a><span id="l42.691" class="difflineplus">+  if (aAugmentDef.elementsIDsToExpose) {</span>
<a href="#l42.692"></a><span id="l42.692" class="difflineplus">+    for each (let [key, value] in Iterator(aAugmentDef.elementIDsToExpose)) {</span>
<a href="#l42.693"></a><span id="l42.693" class="difflineplus">+      aController[key] = new elib.ID(</span>
<a href="#l42.694"></a><span id="l42.694" class="difflineplus">+                           aController.window.document, value);</span>
<a href="#l42.695"></a><span id="l42.695" class="difflineplus">+    }</span>
<a href="#l42.696"></a><span id="l42.696" class="difflineplus">+  }</span>
<a href="#l42.697"></a><span id="l42.697" class="difflineplus">+  if (aAugmentDef.globalsToExposeAtStartup) {</span>
<a href="#l42.698"></a><span id="l42.698" class="difflineplus">+    for each (let [key, value] in</span>
<a href="#l42.699"></a><span id="l42.699" class="difflineplus">+              Iterator(aAugmentDef.globalsToExposeAtStartup)) {</span>
<a href="#l42.700"></a><span id="l42.700" class="difflineplus">+      aController[key] = aController.window[value];</span>
<a href="#l42.701"></a><span id="l42.701" class="difflineplus">+    }</span>
<a href="#l42.702"></a><span id="l42.702" class="difflineplus">+  }</span>
<a href="#l42.703"></a><span id="l42.703" class="difflineplus">+  if (aAugmentDef.globalsToExposeViaGetters) {</span>
<a href="#l42.704"></a><span id="l42.704" class="difflineplus">+    for each (let [key, value] in</span>
<a href="#l42.705"></a><span id="l42.705" class="difflineplus">+              Iterator(aAugmentDef.globalsToExposeViaGetters)) {</span>
<a href="#l42.706"></a><span id="l42.706" class="difflineplus">+      let globalName = value;</span>
<a href="#l42.707"></a><span id="l42.707" class="difflineplus">+      aController.__defineGetter__(key, function() {</span>
<a href="#l42.708"></a><span id="l42.708" class="difflineplus">+          return this.window[globalName];</span>
<a href="#l42.709"></a><span id="l42.709" class="difflineplus">+        });</span>
<a href="#l42.710"></a><span id="l42.710" class="difflineplus">+    }</span>
<a href="#l42.711"></a><span id="l42.711" class="difflineplus">+  }</span>
<a href="#l42.712"></a><span id="l42.712" class="difflineplus">+  if (aAugmentDef.getters) {</span>
<a href="#l42.713"></a><span id="l42.713" class="difflineplus">+    for each (let [key, value] in Iterator(aAugmentDef.getters)) {</span>
<a href="#l42.714"></a><span id="l42.714" class="difflineplus">+      aController.__defineGetter__(key, value);</span>
<a href="#l42.715"></a><span id="l42.715" class="difflineplus">+    }</span>
<a href="#l42.716"></a><span id="l42.716" class="difflineplus">+  }</span>
<a href="#l42.717"></a><span id="l42.717" class="difflineplus">+  if (aAugmentDef.methods) {</span>
<a href="#l42.718"></a><span id="l42.718" class="difflineplus">+    for each (let [key, value] in Iterator(aAugmentDef.methods)) {</span>
<a href="#l42.719"></a><span id="l42.719" class="difflineplus">+      aController[key] = value;</span>
<a href="#l42.720"></a><span id="l42.720" class="difflineplus">+    }</span>
<a href="#l42.721"></a><span id="l42.721" class="difflineplus">+  }</span>
<a href="#l42.722"></a><span id="l42.722" class="difflineplus">+</span>
<a href="#l42.723"></a><span id="l42.723" class="difflineplus">+  if (aAugmentDef.onAugment) {</span>
<a href="#l42.724"></a><span id="l42.724" class="difflineplus">+    aAugmentDef.onAugment(aController);</span>
<a href="#l42.725"></a><span id="l42.725" class="difflineplus">+  }</span>
<a href="#l42.726"></a><span id="l42.726" class="difflineplus">+}</span>
<a href="#l42.727"></a><span id="l42.727" class="difflineplus">+</span>
<a href="#l42.728"></a><span id="l42.728" class="difflineplus">+/**</span>
<a href="#l42.729"></a><span id="l42.729" class="difflineplus">+ * controller.js in mozmill actually has its own extension mechanism,</span>
<a href="#l42.730"></a><span id="l42.730" class="difflineplus">+ *  controllerAdditions.  Unfortunately, it does not make its stuff public at</span>
<a href="#l42.731"></a><span id="l42.731" class="difflineplus">+ *  this time.  In the future we can change ourselves to just use that</span>
<a href="#l42.732"></a><span id="l42.732" class="difflineplus">+ *  mechanism.</span>
<a href="#l42.733"></a><span id="l42.733" class="difflineplus">+ */</span>
<a href="#l42.734"></a><span id="l42.734" class="difflineplus">+function augment_controller(aController, aWindowType) {</span>
<a href="#l42.735"></a><span id="l42.735" class="difflineplus">+  if (aWindowType === undefined)</span>
<a href="#l42.736"></a><span id="l42.736" class="difflineplus">+    aWindowType =</span>
<a href="#l42.737"></a><span id="l42.737" class="difflineplus">+      aController.window.document.documentElement.getAttribute(&quot;windowtype&quot;);</span>
<a href="#l42.738"></a><span id="l42.738" class="difflineplus">+</span>
<a href="#l42.739"></a><span id="l42.739" class="difflineplus">+  _augment_helper(aController, AugmentEverybodyWith);</span>
<a href="#l42.740"></a><span id="l42.740" class="difflineplus">+  if (PerWindowTypeAugmentations[aWindowType])</span>
<a href="#l42.741"></a><span id="l42.741" class="difflineplus">+    _augment_helper(aController, PerWindowTypeAugmentations[aWindowType]);</span>
<a href="#l42.742"></a><span id="l42.742" class="difflineplus">+  return aController;</span>
<a href="#l42.743"></a><span id="l42.743" class="difflineplus">+}</span>
<a href="#l42.744"></a><span id="l42.744">\ No newline at end of file</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1" class="difflineminus">--- a/mail/themes/gnomestripe/mail/messenger.css</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineplus">+++ b/mail/themes/gnomestripe/mail/messenger.css</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineat">@@ -14,16 +14,28 @@ description.error {</span>
<a href="#l43.4"></a><span id="l43.4"> .toolbar-primary {</span>
<a href="#l43.5"></a><span id="l43.5">   -moz-binding: url(&quot;chrome://global/content/bindings/toolbar.xml#toolbar&quot;);</span>
<a href="#l43.6"></a><span id="l43.6"> }</span>
<a href="#l43.7"></a><span id="l43.7"> </span>
<a href="#l43.8"></a><span id="l43.8"> toolbar[printpreview=&quot;true&quot;] {</span>
<a href="#l43.9"></a><span id="l43.9">   -moz-binding: url(&quot;chrome://global/content/printPreviewBindings.xml#printpreviewtoolbar&quot;);</span>
<a href="#l43.10"></a><span id="l43.10"> }</span>
<a href="#l43.11"></a><span id="l43.11"> </span>
<a href="#l43.12"></a><span id="l43.12" class="difflineplus">+/*</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineplus">+ * Override the menulist icon forbidding in menu.css so that we can show</span>
<a href="#l43.14"></a><span id="l43.14" class="difflineplus">+ * check-marks. bug 443516</span>
<a href="#l43.15"></a><span id="l43.15" class="difflineplus">+ */</span>
<a href="#l43.16"></a><span id="l43.16" class="difflineplus">+.menulist-menupopup &gt; menuitem &gt; .menu-iconic-left,</span>
<a href="#l43.17"></a><span id="l43.17" class="difflineplus">+menulist &gt; menupopup &gt; menuitem &gt; .menu-iconic-left,</span>
<a href="#l43.18"></a><span id="l43.18" class="difflineplus">+.menulist-menupopup &gt; menu &gt; .menu-iconic-left,</span>
<a href="#l43.19"></a><span id="l43.19" class="difflineplus">+menulist &gt; menupopup &gt; menu &gt; .menu-iconic-left {</span>
<a href="#l43.20"></a><span id="l43.20" class="difflineplus">+  display: -moz-box;</span>
<a href="#l43.21"></a><span id="l43.21" class="difflineplus">+}</span>
<a href="#l43.22"></a><span id="l43.22" class="difflineplus">+</span>
<a href="#l43.23"></a><span id="l43.23" class="difflineplus">+</span>
<a href="#l43.24"></a><span id="l43.24"> /* ::::: throbber ::::: */</span>
<a href="#l43.25"></a><span id="l43.25"> </span>
<a href="#l43.26"></a><span id="l43.26"> #navigator-throbber {</span>
<a href="#l43.27"></a><span id="l43.27">   -moz-appearance: none;</span>
<a href="#l43.28"></a><span id="l43.28">   -moz-user-focus: ignore;</span>
<a href="#l43.29"></a><span id="l43.29">   margin: 0 !important;</span>
<a href="#l43.30"></a><span id="l43.30">   border: none !important;</span>
<a href="#l43.31"></a><span id="l43.31">   padding: 0px !important;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1" class="difflineminus">--- a/mail/themes/gnomestripe/mail/tabmail.css</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineplus">+++ b/mail/themes/gnomestripe/mail/tabmail.css</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineat">@@ -70,16 +70,20 @@</span>
<a href="#l44.4"></a><span id="l44.4">   padding-top: 1px;</span>
<a href="#l44.5"></a><span id="l44.5">   -moz-padding-start: 1px;</span>
<a href="#l44.6"></a><span id="l44.6"> }</span>
<a href="#l44.7"></a><span id="l44.7"> </span>
<a href="#l44.8"></a><span id="l44.8"> .tabmail-tab[busy] &gt; .tab-image-middle &gt; .tab-icon &gt; .tab-icon-image {</span>
<a href="#l44.9"></a><span id="l44.9">   list-style-image: url(&quot;chrome://global/skin/icons/loading_16.png&quot;) !important;</span>
<a href="#l44.10"></a><span id="l44.10"> }</span>
<a href="#l44.11"></a><span id="l44.11"> </span>
<a href="#l44.12"></a><span id="l44.12" class="difflineplus">+.tabmail-tab[thinking] &gt; .tab-image-middle &gt; .tab-icon &gt; .tab-icon-image {</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineplus">+  list-style-image: url(&quot;chrome://global/skin/icons/loading_16.png&quot;) !important;</span>
<a href="#l44.14"></a><span id="l44.14" class="difflineplus">+}</span>
<a href="#l44.15"></a><span id="l44.15" class="difflineplus">+</span>
<a href="#l44.16"></a><span id="l44.16"> .tabmail-tab[selected=&quot;true&quot;] {</span>
<a href="#l44.17"></a><span id="l44.17">   font-weight: bold;</span>
<a href="#l44.18"></a><span id="l44.18"> }</span>
<a href="#l44.19"></a><span id="l44.19"> </span>
<a href="#l44.20"></a><span id="l44.20"> .tabmail-tab[selected=&quot;true&quot;] &gt; .tab-image-middle &gt; .tab-text {</span>
<a href="#l44.21"></a><span id="l44.21">   opacity: 1.0 !important;</span>
<a href="#l44.22"></a><span id="l44.22"> }</span>
<a href="#l44.23"></a><span id="l44.23"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1" class="difflineminus">--- a/mail/themes/pinstripe/mail/tabmail.css</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineplus">+++ b/mail/themes/pinstripe/mail/tabmail.css</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineat">@@ -71,16 +71,20 @@</span>
<a href="#l45.4"></a><span id="l45.4"> .tabmail-tab[selected=&quot;true&quot;] &gt; .tab-icon {</span>
<a href="#l45.5"></a><span id="l45.5">   list-style-image: url(&quot;chrome://global/skin/tree/item.png&quot;);</span>
<a href="#l45.6"></a><span id="l45.6"> }</span>
<a href="#l45.7"></a><span id="l45.7"> </span>
<a href="#l45.8"></a><span id="l45.8"> .tabmail-tab[busy] &gt; .tab-icon {</span>
<a href="#l45.9"></a><span id="l45.9">   list-style-image: url(&quot;chrome://global/skin/icons/loading_16.png&quot;) !important;</span>
<a href="#l45.10"></a><span id="l45.10"> }</span>
<a href="#l45.11"></a><span id="l45.11"> </span>
<a href="#l45.12"></a><span id="l45.12" class="difflineplus">+.tabmail-tab[thinking] &gt; .tab-icon {</span>
<a href="#l45.13"></a><span id="l45.13" class="difflineplus">+  list-style-image: url(&quot;chrome://global/skin/icons/loading_16.png&quot;) !important;</span>
<a href="#l45.14"></a><span id="l45.14" class="difflineplus">+}</span>
<a href="#l45.15"></a><span id="l45.15" class="difflineplus">+</span>
<a href="#l45.16"></a><span id="l45.16"> .tabmail-tab:hover &gt; .tab-icon,</span>
<a href="#l45.17"></a><span id="l45.17"> .tabmail-tab[selected=&quot;true&quot;] &gt; .tab-icon {</span>
<a href="#l45.18"></a><span id="l45.18">   opacity: 1;</span>
<a href="#l45.19"></a><span id="l45.19"> }</span>
<a href="#l45.20"></a><span id="l45.20"> </span>
<a href="#l45.21"></a><span id="l45.21"> .tab-text {</span>
<a href="#l45.22"></a><span id="l45.22">   margin-top: 3px !important;</span>
<a href="#l45.23"></a><span id="l45.23">   margin-bottom: 0 !important;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1" class="difflineminus">--- a/mail/themes/qute/mail/tabmail.css</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineplus">+++ b/mail/themes/qute/mail/tabmail.css</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineat">@@ -70,16 +70,20 @@</span>
<a href="#l46.4"></a><span id="l46.4">   padding-top: 1px;</span>
<a href="#l46.5"></a><span id="l46.5">   -moz-padding-start: 1px;</span>
<a href="#l46.6"></a><span id="l46.6"> }</span>
<a href="#l46.7"></a><span id="l46.7"> </span>
<a href="#l46.8"></a><span id="l46.8"> .tabmail-tab[busy] &gt; .tab-image-middle &gt; .tab-icon &gt; .tab-icon-image {</span>
<a href="#l46.9"></a><span id="l46.9">   list-style-image: url(&quot;chrome://global/skin/icons/loading_16.png&quot;) !important;</span>
<a href="#l46.10"></a><span id="l46.10"> }</span>
<a href="#l46.11"></a><span id="l46.11"> </span>
<a href="#l46.12"></a><span id="l46.12" class="difflineplus">+.tabmail-tab[thinking] &gt; .tab-image-middle &gt; .tab-icon &gt; .tab-icon-image {</span>
<a href="#l46.13"></a><span id="l46.13" class="difflineplus">+  list-style-image: url(&quot;chrome://global/skin/icons/loading_16.png&quot;) !important;</span>
<a href="#l46.14"></a><span id="l46.14" class="difflineplus">+}</span>
<a href="#l46.15"></a><span id="l46.15" class="difflineplus">+</span>
<a href="#l46.16"></a><span id="l46.16"> .tabmail-tab[selected=&quot;true&quot;] {</span>
<a href="#l46.17"></a><span id="l46.17">   font-weight: bold;</span>
<a href="#l46.18"></a><span id="l46.18"> }</span>
<a href="#l46.19"></a><span id="l46.19"> </span>
<a href="#l46.20"></a><span id="l46.20"> .tabmail-tab[selected=&quot;true&quot;] &gt; .tab-image-middle &gt; .tab-text {</span>
<a href="#l46.21"></a><span id="l46.21">   opacity: 1.0 !important;</span>
<a href="#l46.22"></a><span id="l46.22"> }</span>
<a href="#l46.23"></a><span id="l46.23"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgDBView.idl</span>
<a href="#l47.2"></a><span id="l47.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgDBView.idl</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineat">@@ -41,16 +41,17 @@</span>
<a href="#l47.4"></a><span id="l47.4"> interface nsIMsgFolder;</span>
<a href="#l47.5"></a><span id="l47.5"> interface nsIMsgWindow;</span>
<a href="#l47.6"></a><span id="l47.6"> interface nsIMessenger;</span>
<a href="#l47.7"></a><span id="l47.7"> interface nsIMsgDBHdr;</span>
<a href="#l47.8"></a><span id="l47.8"> interface nsIMsgThread;</span>
<a href="#l47.9"></a><span id="l47.9"> interface nsIMsgDBViewCommandUpdater;</span>
<a href="#l47.10"></a><span id="l47.10"> interface nsIMsgDatabase;</span>
<a href="#l47.11"></a><span id="l47.11"> interface nsIMsgSearchSession;</span>
<a href="#l47.12"></a><span id="l47.12" class="difflineplus">+interface nsIMutableArray;</span>
<a href="#l47.13"></a><span id="l47.13"> interface nsISimpleEnumerator;</span>
<a href="#l47.14"></a><span id="l47.14"> interface nsITreeView;</span>
<a href="#l47.15"></a><span id="l47.15"> interface nsIMsgCustomColumnHandler;</span>
<a href="#l47.16"></a><span id="l47.16"> </span>
<a href="#l47.17"></a><span id="l47.17"> typedef long nsMsgViewNotificationCodeValue;</span>
<a href="#l47.18"></a><span id="l47.18"> typedef long nsMsgViewCommandCheckStateValue;</span>
<a href="#l47.19"></a><span id="l47.19"> typedef long nsMsgViewCommandTypeValue;</span>
<a href="#l47.20"></a><span id="l47.20"> typedef long nsMsgNavigationTypeValue;</span>
<a href="#l47.21"></a><span id="l47.21" class="difflineat">@@ -240,17 +241,17 @@ interface nsMsgNavigationType</span>
<a href="#l47.22"></a><span id="l47.22">   const nsMsgNavigationTypeValue previousFlagged = 19;</span>
<a href="#l47.23"></a><span id="l47.23">   const nsMsgNavigationTypeValue firstNew = 20;</span>
<a href="#l47.24"></a><span id="l47.24">   const nsMsgNavigationTypeValue editUndo = 21;</span>
<a href="#l47.25"></a><span id="l47.25">   const nsMsgNavigationTypeValue editRedo = 22;</span>
<a href="#l47.26"></a><span id="l47.26">   const nsMsgNavigationTypeValue toggleSubthreadKilled = 23;</span>
<a href="#l47.27"></a><span id="l47.27"> };</span>
<a href="#l47.28"></a><span id="l47.28"> </span>
<a href="#l47.29"></a><span id="l47.29"> </span>
<a href="#l47.30"></a><span id="l47.30" class="difflineminus">-[scriptable, uuid(03969356-7a74-4b78-bb17-0d56849c789f)]</span>
<a href="#l47.31"></a><span id="l47.31" class="difflineplus">+[scriptable, uuid(7b6f1f8f-f27a-409b-955b-ab40d46194e1)]</span>
<a href="#l47.32"></a><span id="l47.32"> interface nsIMsgDBView : nsISupports</span>
<a href="#l47.33"></a><span id="l47.33"> {</span>
<a href="#l47.34"></a><span id="l47.34">   void open(in nsIMsgFolder folder, in nsMsgViewSortTypeValue sortType, in nsMsgViewSortOrderValue sortOrder, in nsMsgViewFlagsTypeValue viewFlags, out long count);</span>
<a href="#l47.35"></a><span id="l47.35">   void openWithHdrs(in nsISimpleEnumerator aHeaders, in nsMsgViewSortTypeValue aSortType, </span>
<a href="#l47.36"></a><span id="l47.36">                       in nsMsgViewSortOrderValue aSortOrder, </span>
<a href="#l47.37"></a><span id="l47.37">                       in nsMsgViewFlagsTypeValue aViewFlags, out long aCount);</span>
<a href="#l47.38"></a><span id="l47.38">   void close();</span>
<a href="#l47.39"></a><span id="l47.39"> </span>
<a href="#l47.40"></a><span id="l47.40" class="difflineat">@@ -320,27 +321,50 @@ interface nsIMsgDBView : nsISupports</span>
<a href="#l47.41"></a><span id="l47.41">    * @return - msg hdr at the passed in index</span>
<a href="#l47.42"></a><span id="l47.42">    * @exception - NS_MSG_INVALID_DBVIEW_INDEX</span>
<a href="#l47.43"></a><span id="l47.43">    */</span>
<a href="#l47.44"></a><span id="l47.44">   nsIMsgDBHdr getMsgHdrAt(in nsMsgViewIndex aIndex);</span>
<a href="#l47.45"></a><span id="l47.45"> </span>
<a href="#l47.46"></a><span id="l47.46">   nsIMsgFolder getFolderForViewIndex(in nsMsgViewIndex index); // mainly for search</span>
<a href="#l47.47"></a><span id="l47.47">   ACString getURIForViewIndex(in nsMsgViewIndex index);</span>
<a href="#l47.48"></a><span id="l47.48">   nsIMsgDBView cloneDBView(in nsIMessenger aMessengerInstance, in nsIMsgWindow aMsgWindow, in nsIMsgDBViewCommandUpdater aCommandUpdater);</span>
<a href="#l47.49"></a><span id="l47.49" class="difflineplus">+</span>
<a href="#l47.50"></a><span id="l47.50" class="difflineplus">+  /**</span>
<a href="#l47.51"></a><span id="l47.51" class="difflineplus">+   * Provides a list of the message headers for the currently selected messages.</span>
<a href="#l47.52"></a><span id="l47.52" class="difflineplus">+   *  If the &quot;mail.operate_on_msgs_in_collapsed_threads&quot; preference is enabled,</span>
<a href="#l47.53"></a><span id="l47.53" class="difflineplus">+   *  then any collapsed thread roots that are selected will also (conceptually)</span>
<a href="#l47.54"></a><span id="l47.54" class="difflineplus">+   *  have all of the messages in that thread selected and they will be included</span>
<a href="#l47.55"></a><span id="l47.55" class="difflineplus">+   *  in the returned list.</span>
<a href="#l47.56"></a><span id="l47.56" class="difflineplus">+   *</span>
<a href="#l47.57"></a><span id="l47.57" class="difflineplus">+   * If the user has right-clicked on a message, this will return that message</span>
<a href="#l47.58"></a><span id="l47.58" class="difflineplus">+   *  (and any collapsed children if so enabled) and not the selection prior to</span>
<a href="#l47.59"></a><span id="l47.59" class="difflineplus">+   *  the right-click.</span>
<a href="#l47.60"></a><span id="l47.60" class="difflineplus">+   *</span>
<a href="#l47.61"></a><span id="l47.61" class="difflineplus">+   * @return an nsIMutableArray containing the selected message headers.  You</span>
<a href="#l47.62"></a><span id="l47.62" class="difflineplus">+   *     are free to mutate the array; it will not affect the underlying</span>
<a href="#l47.63"></a><span id="l47.63" class="difflineplus">+   *     selection.</span>
<a href="#l47.64"></a><span id="l47.64" class="difflineplus">+   */</span>
<a href="#l47.65"></a><span id="l47.65" class="difflineplus">+  nsIMutableArray getMsgHdrsForSelection();</span>
<a href="#l47.66"></a><span id="l47.66">   void getURIsForSelection(out unsigned long count, [retval, array, size_is(count)] out string uris);</span>
<a href="#l47.67"></a><span id="l47.67">   void getIndicesForSelection(out unsigned long count, [retval, array, size_is(count)] out nsMsgViewIndex indices);</span>
<a href="#l47.68"></a><span id="l47.68"> </span>
<a href="#l47.69"></a><span id="l47.69">   readonly attribute ACString URIForFirstSelectedMessage;</span>
<a href="#l47.70"></a><span id="l47.70">   readonly attribute nsIMsgDBHdr hdrForFirstSelectedMessage;</span>
<a href="#l47.71"></a><span id="l47.71">   void loadMessageByMsgKey(in nsMsgKey aMsgKey);</span>
<a href="#l47.72"></a><span id="l47.72">   void loadMessageByViewIndex(in nsMsgViewIndex aIndex);</span>
<a href="#l47.73"></a><span id="l47.73">   void loadMessageByUrl(in string aUrl);</span>
<a href="#l47.74"></a><span id="l47.74">   void reloadMessage();</span>
<a href="#l47.75"></a><span id="l47.75">   void reloadMessageWithAllParts();</span>
<a href="#l47.76"></a><span id="l47.76"> </span>
<a href="#l47.77"></a><span id="l47.77" class="difflineplus">+  /**</span>
<a href="#l47.78"></a><span id="l47.78" class="difflineplus">+   * The number of selected messages.  If the</span>
<a href="#l47.79"></a><span id="l47.79" class="difflineplus">+   *  &quot;mail.operate_on_msgs_in_collapsed_threads&quot; preference is enabled, then</span>
<a href="#l47.80"></a><span id="l47.80" class="difflineplus">+   *  any collapsed thread roots that are selected will also conceptually have</span>
<a href="#l47.81"></a><span id="l47.81" class="difflineplus">+   *  all of the messages in that thread selected.</span>
<a href="#l47.82"></a><span id="l47.82" class="difflineplus">+   */</span>
<a href="#l47.83"></a><span id="l47.83">   readonly attribute unsigned long numSelected;</span>
<a href="#l47.84"></a><span id="l47.84">   readonly attribute nsMsgViewIndex msgToSelectAfterDelete; </span>
<a href="#l47.85"></a><span id="l47.85">   readonly attribute nsMsgViewIndex currentlyDisplayedMessage; </span>
<a href="#l47.86"></a><span id="l47.86"> </span>
<a href="#l47.87"></a><span id="l47.87">   // used by &quot;go to folder&quot; feature</span>
<a href="#l47.88"></a><span id="l47.88">   // and &quot;remember last selected message&quot; feature</span>
<a href="#l47.89"></a><span id="l47.89">   // if key is not found, we don't select.</span>
<a href="#l47.90"></a><span id="l47.90">   void selectMsgByKey(in nsMsgKey key);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1" class="difflineminus">--- a/mailnews/base/resources/content/virtualFolderProperties.js</span>
<a href="#l48.2"></a><span id="l48.2" class="difflineplus">+++ b/mailnews/base/resources/content/virtualFolderProperties.js</span>
<a href="#l48.3"></a><span id="l48.3" class="difflineat">@@ -38,41 +38,46 @@</span>
<a href="#l48.4"></a><span id="l48.4">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l48.5"></a><span id="l48.5"> </span>
<a href="#l48.6"></a><span id="l48.6"> var gPickedFolder;</span>
<a href="#l48.7"></a><span id="l48.7"> var gMailView = null;</span>
<a href="#l48.8"></a><span id="l48.8"> var msgWindow; // important, don't change the name of this variable. it's really a global used by commandglue.js</span>
<a href="#l48.9"></a><span id="l48.9"> var gSearchTermSession; // really an in memory temporary filter we use to read in and write out the search terms</span>
<a href="#l48.10"></a><span id="l48.10"> var gSearchFolderURIs = &quot;&quot;;</span>
<a href="#l48.11"></a><span id="l48.11"> </span>
<a href="#l48.12"></a><span id="l48.12" class="difflineplus">+var nsMsgSearchScope = Components.interfaces.nsMsgSearchScope;</span>
<a href="#l48.13"></a><span id="l48.13" class="difflineplus">+</span>
<a href="#l48.14"></a><span id="l48.14" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/virtualFolderWrapper.js&quot;);</span>
<a href="#l48.15"></a><span id="l48.15" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/iteratorUtils.jsm&quot;);</span>
<a href="#l48.16"></a><span id="l48.16" class="difflineplus">+</span>
<a href="#l48.17"></a><span id="l48.17"> function onLoad()</span>
<a href="#l48.18"></a><span id="l48.18"> {</span>
<a href="#l48.19"></a><span id="l48.19">   var arguments = window.arguments[0];</span>
<a href="#l48.20"></a><span id="l48.20"> </span>
<a href="#l48.21"></a><span id="l48.21">   document.getElementById(&quot;name&quot;).focus();</span>
<a href="#l48.22"></a><span id="l48.22"> </span>
<a href="#l48.23"></a><span id="l48.23">   // call this when OK is pressed</span>
<a href="#l48.24"></a><span id="l48.24">   msgWindow = arguments.msgWindow;</span>
<a href="#l48.25"></a><span id="l48.25"> </span>
<a href="#l48.26"></a><span id="l48.26">   initializeSearchWidgets();</span>
<a href="#l48.27"></a><span id="l48.27">   setSearchScope(nsMsgSearchScope.offlineMail);</span>
<a href="#l48.28"></a><span id="l48.28"> </span>
<a href="#l48.29"></a><span id="l48.29">   if (arguments.editExistingFolder)</span>
<a href="#l48.30"></a><span id="l48.30" class="difflineminus">-    InitDialogWithVirtualFolder(arguments.folder ? arguments.folder.URI : null);</span>
<a href="#l48.31"></a><span id="l48.31" class="difflineplus">+    InitDialogWithVirtualFolder(arguments.folder);</span>
<a href="#l48.32"></a><span id="l48.32">   else // we are creating a new virtual folder</span>
<a href="#l48.33"></a><span id="l48.33">   {</span>
<a href="#l48.34"></a><span id="l48.34">     // it is possible that we were given arguments to pre-fill the dialog with...</span>
<a href="#l48.35"></a><span id="l48.35">     gSearchTermSession = Components.classes[&quot;@mozilla.org/messenger/searchSession;1&quot;]</span>
<a href="#l48.36"></a><span id="l48.36">                                    .createInstance(Components.interfaces.nsIMsgSearchSession);</span>
<a href="#l48.37"></a><span id="l48.37"> </span>
<a href="#l48.38"></a><span id="l48.38">     if (arguments.searchTerms) // then add them to our search session</span>
<a href="#l48.39"></a><span id="l48.39">     {</span>
<a href="#l48.40"></a><span id="l48.40" class="difflineminus">-      var count = arguments.searchTerms.Count();</span>
<a href="#l48.41"></a><span id="l48.41" class="difflineminus">-      for (var searchIndex = 0; searchIndex &lt; count; )</span>
<a href="#l48.42"></a><span id="l48.42" class="difflineminus">-        gSearchTermSession.appendTerm(arguments.searchTerms.QueryElementAt(searchIndex++, Components.interfaces.nsIMsgSearchTerm));</span>
<a href="#l48.43"></a><span id="l48.43" class="difflineplus">+      for each (let searchTerm in fixIterator(arguments.searchTerms,</span>
<a href="#l48.44"></a><span id="l48.44" class="difflineplus">+                                              Components.interfaces.nsIMsgSearchTerm))</span>
<a href="#l48.45"></a><span id="l48.45" class="difflineplus">+        gSearchTermSession.appendTerm(searchTerm);</span>
<a href="#l48.46"></a><span id="l48.46">     }</span>
<a href="#l48.47"></a><span id="l48.47">     if (arguments.folder)</span>
<a href="#l48.48"></a><span id="l48.48">     {</span>
<a href="#l48.49"></a><span id="l48.49">       // pre select the folderPicker, based on what they selected in the folder pane</span>
<a href="#l48.50"></a><span id="l48.50">       gPickedFolder = arguments.folder;</span>
<a href="#l48.51"></a><span id="l48.51">       try {</span>
<a href="#l48.52"></a><span id="l48.52">         document.getElementById(&quot;msgNewFolderPopup&quot;).selectFolder(arguments.folder);</span>
<a href="#l48.53"></a><span id="l48.53">       } catch(ex) {</span>
<a href="#l48.54"></a><span id="l48.54" class="difflineat">@@ -121,44 +126,39 @@ function updateOnlineSearchState()</span>
<a href="#l48.55"></a><span id="l48.55">     checkbox.removeAttribute('disabled');</span>
<a href="#l48.56"></a><span id="l48.56">   else</span>
<a href="#l48.57"></a><span id="l48.57">   {</span>
<a href="#l48.58"></a><span id="l48.58">     checkbox.setAttribute('disabled', true);</span>
<a href="#l48.59"></a><span id="l48.59">     checkbox.checked = false;</span>
<a href="#l48.60"></a><span id="l48.60">   }</span>
<a href="#l48.61"></a><span id="l48.61"> }</span>
<a href="#l48.62"></a><span id="l48.62"> </span>
<a href="#l48.63"></a><span id="l48.63" class="difflineminus">-function InitDialogWithVirtualFolder(aVirtualFolderURI)</span>
<a href="#l48.64"></a><span id="l48.64" class="difflineplus">+function InitDialogWithVirtualFolder(aVirtualFolder)</span>
<a href="#l48.65"></a><span id="l48.65"> {</span>
<a href="#l48.66"></a><span id="l48.66" class="difflineplus">+  let virtualFolderWrapper =</span>
<a href="#l48.67"></a><span id="l48.67" class="difflineplus">+    VirtualFolderHelper.wrapVirtualFolder(window.arguments[0].folder);</span>
<a href="#l48.68"></a><span id="l48.68" class="difflineplus">+</span>
<a href="#l48.69"></a><span id="l48.69">   // when editing an existing folder, hide the folder picker that stores the parent location of the folder</span>
<a href="#l48.70"></a><span id="l48.70">   document.getElementById(&quot;chooseFolderLocationRow&quot;).collapsed = true;</span>
<a href="#l48.71"></a><span id="l48.71">   var folderNameField = document.getElementById(&quot;name&quot;);</span>
<a href="#l48.72"></a><span id="l48.72">   folderNameField.disabled = true;</span>
<a href="#l48.73"></a><span id="l48.73"> </span>
<a href="#l48.74"></a><span id="l48.74" class="difflineminus">-  var msgFolder = GetMsgFolderFromUri(aVirtualFolderURI);</span>
<a href="#l48.75"></a><span id="l48.75" class="difflineminus">-  var dbFolderInfo = msgFolder.msgDatabase.dBFolderInfo;</span>
<a href="#l48.76"></a><span id="l48.76" class="difflineminus">-</span>
<a href="#l48.77"></a><span id="l48.77" class="difflineminus">-  gSearchFolderURIs = dbFolderInfo.getCharProperty(&quot;searchFolderUri&quot;);</span>
<a href="#l48.78"></a><span id="l48.78" class="difflineminus">-  var searchTermString = dbFolderInfo.getCharProperty(&quot;searchStr&quot;);</span>
<a href="#l48.79"></a><span id="l48.79" class="difflineminus">-  document.getElementById('searchOnline').checked = dbFolderInfo.getBooleanProperty(&quot;searchOnline&quot;, false);</span>
<a href="#l48.80"></a><span id="l48.80" class="difflineminus">-</span>
<a href="#l48.81"></a><span id="l48.81" class="difflineminus">-  // work around to get our search term string converted into a real array of search terms</span>
<a href="#l48.82"></a><span id="l48.82" class="difflineminus">-  var filterService = Components.classes[&quot;@mozilla.org/messenger/services/filters;1&quot;].getService(Components.interfaces.nsIMsgFilterService);</span>
<a href="#l48.83"></a><span id="l48.83" class="difflineminus">-  var filterList = filterService.getTempFilterList(msgFolder);</span>
<a href="#l48.84"></a><span id="l48.84" class="difflineminus">-  gSearchTermSession = filterList.createFilter(&quot;temp&quot;);</span>
<a href="#l48.85"></a><span id="l48.85" class="difflineminus">-  filterList.parseCondition(gSearchTermSession, searchTermString);</span>
<a href="#l48.86"></a><span id="l48.86" class="difflineplus">+  gSearchFolderURIs = virtualFolderWrapper.searchFolderURIs;</span>
<a href="#l48.87"></a><span id="l48.87" class="difflineplus">+  document.getElementById('searchOnline').checked = virtualFolderWrapper.onlineSearch;</span>
<a href="#l48.88"></a><span id="l48.88" class="difflineplus">+  gSearchTermSession = virtualFolderWrapper.searchTermsSession;</span>
<a href="#l48.89"></a><span id="l48.89"> </span>
<a href="#l48.90"></a><span id="l48.90">   setupSearchRows(gSearchTermSession.searchTerms);</span>
<a href="#l48.91"></a><span id="l48.91"> </span>
<a href="#l48.92"></a><span id="l48.92">   // set the name of the folder</span>
<a href="#l48.93"></a><span id="l48.93" class="difflineminus">-  folderNameField.value = msgFolder.prettyName;</span>
<a href="#l48.94"></a><span id="l48.94" class="difflineplus">+  folderNameField.value = aVirtualFolder.prettyName;</span>
<a href="#l48.95"></a><span id="l48.95"> </span>
<a href="#l48.96"></a><span id="l48.96">   // update the window title based on the name of the saved search</span>
<a href="#l48.97"></a><span id="l48.97">   var messengerBundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l48.98"></a><span id="l48.98" class="difflineminus">-  document.title = messengerBundle.getFormattedString('editVirtualFolderPropertiesTitle', [msgFolder.prettyName]);</span>
<a href="#l48.99"></a><span id="l48.99" class="difflineplus">+  document.title = messengerBundle.getFormattedString('editVirtualFolderPropertiesTitle',</span>
<a href="#l48.100"></a><span id="l48.100" class="difflineplus">+                                                      [aVirtualFolder.prettyName]);</span>
<a href="#l48.101"></a><span id="l48.101"> }</span>
<a href="#l48.102"></a><span id="l48.102"> </span>
<a href="#l48.103"></a><span id="l48.103"> function onFolderPick(aEvent) {</span>
<a href="#l48.104"></a><span id="l48.104">   gPickedFolder = aEvent.target._folder;</span>
<a href="#l48.105"></a><span id="l48.105">   document.getElementById(&quot;msgNewFolderPicker&quot;)</span>
<a href="#l48.106"></a><span id="l48.106">           .setAttribute(&quot;label&quot;, gPickedFolder.prettyName);</span>
<a href="#l48.107"></a><span id="l48.107"> }</span>
<a href="#l48.108"></a><span id="l48.108"> </span>
<a href="#l48.109"></a><span id="l48.109" class="difflineat">@@ -177,34 +177,29 @@ function onOK()</span>
<a href="#l48.110"></a><span id="l48.110">                         messengerBundle.getString('alertNoSearchFoldersSelected'));</span>
<a href="#l48.111"></a><span id="l48.111">     return false;</span>
<a href="#l48.112"></a><span id="l48.112">   }</span>
<a href="#l48.113"></a><span id="l48.113"> </span>
<a href="#l48.114"></a><span id="l48.114">   if (window.arguments[0].editExistingFolder)</span>
<a href="#l48.115"></a><span id="l48.115">   {</span>
<a href="#l48.116"></a><span id="l48.116">     // update the search terms</span>
<a href="#l48.117"></a><span id="l48.117">     saveSearchTerms(gSearchTermSession.searchTerms, gSearchTermSession);</span>
<a href="#l48.118"></a><span id="l48.118" class="difflineminus">-    var searchTermString = getSearchTermString(gSearchTermSession.searchTerms);</span>
<a href="#l48.119"></a><span id="l48.119" class="difflineminus">-</span>
<a href="#l48.120"></a><span id="l48.120" class="difflineminus">-    var msgFolder = window.arguments[0].folder;</span>
<a href="#l48.121"></a><span id="l48.121" class="difflineminus">-    var msgDatabase = msgFolder.msgDatabase;</span>
<a href="#l48.122"></a><span id="l48.122" class="difflineminus">-    var dbFolderInfo = msgDatabase.dBFolderInfo;</span>
<a href="#l48.123"></a><span id="l48.123" class="difflineminus">-</span>
<a href="#l48.124"></a><span id="l48.124" class="difflineminus">-    // set the view string as a property of the db folder info</span>
<a href="#l48.125"></a><span id="l48.125" class="difflineminus">-    // set the original folder name as well.</span>
<a href="#l48.126"></a><span id="l48.126" class="difflineminus">-    dbFolderInfo.setCharProperty(&quot;searchStr&quot;, searchTermString);</span>
<a href="#l48.127"></a><span id="l48.127" class="difflineminus">-    dbFolderInfo.setCharProperty(&quot;searchFolderUri&quot;, gSearchFolderURIs);</span>
<a href="#l48.128"></a><span id="l48.128" class="difflineminus">-    dbFolderInfo.setBooleanProperty(&quot;searchOnline&quot;, searchOnline);</span>
<a href="#l48.129"></a><span id="l48.129" class="difflineminus">-    msgDatabase.Close(true);</span>
<a href="#l48.130"></a><span id="l48.130" class="difflineplus">+    // save the settings</span>
<a href="#l48.131"></a><span id="l48.131" class="difflineplus">+    let virtualFolderWrapper =</span>
<a href="#l48.132"></a><span id="l48.132" class="difflineplus">+      VirtualFolderHelper.wrapVirtualFolder(window.arguments[0].folder);</span>
<a href="#l48.133"></a><span id="l48.133" class="difflineplus">+    virtualFolderWrapper.searchTerms = gSearchTermSession.searchTerms;</span>
<a href="#l48.134"></a><span id="l48.134" class="difflineplus">+    virtualFolderWrapper.searchFolders = gSearchFolderURIs;</span>
<a href="#l48.135"></a><span id="l48.135" class="difflineplus">+    virtualFolderWrapper.onlineSearch = searchOnline;</span>
<a href="#l48.136"></a><span id="l48.136" class="difflineplus">+    virtualFolderWrapper.cleanUpMessageDatabase();</span>
<a href="#l48.137"></a><span id="l48.137"> </span>
<a href="#l48.138"></a><span id="l48.138">     var accountManager = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;].getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l48.139"></a><span id="l48.139">     accountManager.saveVirtualFolders();</span>
<a href="#l48.140"></a><span id="l48.140"> </span>
<a href="#l48.141"></a><span id="l48.141">     if (window.arguments[0].onOKCallback)</span>
<a href="#l48.142"></a><span id="l48.142" class="difflineminus">-      window.arguments[0].onOKCallback(msgFolder.URI);</span>
<a href="#l48.143"></a><span id="l48.143" class="difflineplus">+      window.arguments[0].onOKCallback(virtualFolderWrapper.virtualFolder.URI);</span>
<a href="#l48.144"></a><span id="l48.144">     return true;</span>
<a href="#l48.145"></a><span id="l48.145">   }</span>
<a href="#l48.146"></a><span id="l48.146">   var uri = gPickedFolder.URI;</span>
<a href="#l48.147"></a><span id="l48.147">   if (name &amp;&amp; uri) // create a new virtual folder</span>
<a href="#l48.148"></a><span id="l48.148">   {</span>
<a href="#l48.149"></a><span id="l48.149">     // check to see if we already have a folder with the same name and alert the user if so...</span>
<a href="#l48.150"></a><span id="l48.150">     var parentFolder = GetMsgFolderFromUri(uri);</span>
<a href="#l48.151"></a><span id="l48.151">     </span>
<a href="#l48.152"></a><span id="l48.152" class="difflineat">@@ -225,17 +220,19 @@ function onOK()</span>
<a href="#l48.153"></a><span id="l48.153">         Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l48.154"></a><span id="l48.154">                   .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l48.155"></a><span id="l48.155">       promptService.alert(window, null,</span>
<a href="#l48.156"></a><span id="l48.156">                           messengerBundle.getString('folderExists'));</span>
<a href="#l48.157"></a><span id="l48.157">       return false;</span>
<a href="#l48.158"></a><span id="l48.158">     }</span>
<a href="#l48.159"></a><span id="l48.159">     </span>
<a href="#l48.160"></a><span id="l48.160">     saveSearchTerms(gSearchTermSession.searchTerms, gSearchTermSession);</span>
<a href="#l48.161"></a><span id="l48.161" class="difflineminus">-    CreateVirtualFolder(name, parentFolder, gSearchFolderURIs, gSearchTermSession.searchTerms, searchOnline);</span>
<a href="#l48.162"></a><span id="l48.162" class="difflineplus">+    VirtualFolderHelper.createNewVirtualFolder(name, parentFolder, gSearchFolderURIs,</span>
<a href="#l48.163"></a><span id="l48.163" class="difflineplus">+                                               gSearchTermSession.searchTerms,</span>
<a href="#l48.164"></a><span id="l48.164" class="difflineplus">+                                               searchOnline);</span>
<a href="#l48.165"></a><span id="l48.165">   }</span>
<a href="#l48.166"></a><span id="l48.166"> </span>
<a href="#l48.167"></a><span id="l48.167">   return true;</span>
<a href="#l48.168"></a><span id="l48.168"> }</span>
<a href="#l48.169"></a><span id="l48.169"> </span>
<a href="#l48.170"></a><span id="l48.170"> function onCancel()</span>
<a href="#l48.171"></a><span id="l48.171"> {</span>
<a href="#l48.172"></a><span id="l48.172">   // close the window</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l49.1"></a><span id="l49.1" class="difflineminus">--- a/mailnews/base/resources/content/virtualFolderProperties.xul</span>
<a href="#l49.2"></a><span id="l49.2" class="difflineplus">+++ b/mailnews/base/resources/content/virtualFolderProperties.xul</span>
<a href="#l49.3"></a><span id="l49.3" class="difflineat">@@ -52,17 +52,18 @@</span>
<a href="#l49.4"></a><span id="l49.4"> ]&gt;</span>
<a href="#l49.5"></a><span id="l49.5"> </span>
<a href="#l49.6"></a><span id="l49.6"> &lt;dialog xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l49.7"></a><span id="l49.7">         id=&quot;virtualFolderPropertiesDialog&quot;</span>
<a href="#l49.8"></a><span id="l49.8">         title=&quot;&amp;virtualFolderProperties.title;&quot;</span>
<a href="#l49.9"></a><span id="l49.9">         onload=&quot;onLoad();&quot;</span>
<a href="#l49.10"></a><span id="l49.10">         buttons=&quot;accept,cancel&quot;</span>
<a href="#l49.11"></a><span id="l49.11">         style=&quot;width: 50em; height: 28em;&quot;</span>
<a href="#l49.12"></a><span id="l49.12" class="difflineminus">-	      ondialogaccept=&quot;return onOK();&quot;&gt;</span>
<a href="#l49.13"></a><span id="l49.13" class="difflineplus">+        windowtype=&quot;mailnews:virtualFolderProperties&quot;</span>
<a href="#l49.14"></a><span id="l49.14" class="difflineplus">+        ondialogaccept=&quot;return onOK();&quot;&gt;</span>
<a href="#l49.15"></a><span id="l49.15"> </span>
<a href="#l49.16"></a><span id="l49.16">   &lt;stringbundleset id=&quot;stringbundleset&quot;&gt;</span>
<a href="#l49.17"></a><span id="l49.17">     &lt;stringbundle id=&quot;bundle_search&quot;    src=&quot;chrome://messenger/locale/search.properties&quot;/&gt;</span>
<a href="#l49.18"></a><span id="l49.18">     &lt;stringbundle id=&quot;bundle_messenger&quot; src=&quot;chrome://messenger/locale/messenger.properties&quot;/&gt;</span>
<a href="#l49.19"></a><span id="l49.19">   &lt;/stringbundleset&gt;</span>
<a href="#l49.20"></a><span id="l49.20"> </span>
<a href="#l49.21"></a><span id="l49.21">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/mailCommands.js&quot;/&gt;</span>
<a href="#l49.22"></a><span id="l49.22">   &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/commandglue.js&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l50.1"></a><span id="l50.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgSearchAdapter.cpp</span>
<a href="#l50.2"></a><span id="l50.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgSearchAdapter.cpp</span>
<a href="#l50.3"></a><span id="l50.3" class="difflineat">@@ -714,19 +714,23 @@ nsresult nsMsgSearchAdapter::EncodeImap </span>
<a href="#l50.4"></a><span id="l50.4">   // create our expression</span>
<a href="#l50.5"></a><span id="l50.5">   nsMsgSearchBoolExpression * expression = new nsMsgSearchBoolExpression();</span>
<a href="#l50.6"></a><span id="l50.6">   if (!expression)</span>
<a href="#l50.7"></a><span id="l50.7">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l50.8"></a><span id="l50.8"> </span>
<a href="#l50.9"></a><span id="l50.9">   for (i = 0; i &lt; termCount &amp;&amp; NS_SUCCEEDED(err); i++)</span>
<a href="#l50.10"></a><span id="l50.10">   {</span>
<a href="#l50.11"></a><span id="l50.11">     char *termEncoding;</span>
<a href="#l50.12"></a><span id="l50.12" class="difflineplus">+    PRBool matchAll;</span>
<a href="#l50.13"></a><span id="l50.13">     nsCOMPtr&lt;nsIMsgSearchTerm&gt; pTerm;</span>
<a href="#l50.14"></a><span id="l50.14">     searchTerms-&gt;QueryElementAt(i, NS_GET_IID(nsIMsgSearchTerm),</span>
<a href="#l50.15"></a><span id="l50.15">       (void **)getter_AddRefs(pTerm));</span>
<a href="#l50.16"></a><span id="l50.16" class="difflineplus">+    pTerm-&gt;GetMatchAll(&amp;matchAll);</span>
<a href="#l50.17"></a><span id="l50.17" class="difflineplus">+    if (matchAll)</span>
<a href="#l50.18"></a><span id="l50.18" class="difflineplus">+      continue;</span>
<a href="#l50.19"></a><span id="l50.19">     err = EncodeImapTerm (pTerm, reallyDredd, srcCharset, destCharset, &amp;termEncoding);</span>
<a href="#l50.20"></a><span id="l50.20">     if (NS_SUCCEEDED(err) &amp;&amp; nsnull != termEncoding)</span>
<a href="#l50.21"></a><span id="l50.21">     {</span>
<a href="#l50.22"></a><span id="l50.22">       expression = nsMsgSearchBoolExpression::AddSearchTerm(expression, pTerm, termEncoding);</span>
<a href="#l50.23"></a><span id="l50.23">       delete [] termEncoding;</span>
<a href="#l50.24"></a><span id="l50.24">     }</span>
<a href="#l50.25"></a><span id="l50.25">   }</span>
<a href="#l50.26"></a><span id="l50.26"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l51.1"></a><span id="l51.1" class="difflineminus">--- a/mailnews/base/src/dbViewWrapper.js</span>
<a href="#l51.2"></a><span id="l51.2" class="difflineplus">+++ b/mailnews/base/src/dbViewWrapper.js</span>
<a href="#l51.3"></a><span id="l51.3" class="difflineat">@@ -45,16 +45,20 @@ const Cu = Components.utils;</span>
<a href="#l51.4"></a><span id="l51.4"> Cu.import(&quot;resource://app/modules/mailViewManager.js&quot;);</span>
<a href="#l51.5"></a><span id="l51.5"> Cu.import(&quot;resource://app/modules/searchSpec.js&quot;);</span>
<a href="#l51.6"></a><span id="l51.6"> Cu.import(&quot;resource://app/modules/virtualFolderWrapper.js&quot;);</span>
<a href="#l51.7"></a><span id="l51.7"> </span>
<a href="#l51.8"></a><span id="l51.8"> const nsMsgFolderFlags = Ci.nsMsgFolderFlags;</span>
<a href="#l51.9"></a><span id="l51.9"> const nsMsgViewType = Ci.nsMsgViewType;</span>
<a href="#l51.10"></a><span id="l51.10"> const nsMsgViewFlagsType = Ci.nsMsgViewFlagsType;</span>
<a href="#l51.11"></a><span id="l51.11"> const nsMsgViewSortType = Ci.nsMsgViewSortType;</span>
<a href="#l51.12"></a><span id="l51.12" class="difflineplus">+const nsMsgViewSortOrder = Ci.nsMsgViewSortOrder;</span>
<a href="#l51.13"></a><span id="l51.13" class="difflineplus">+const nsMsgMessageFlags = Ci.nsMsgMessageFlags;</span>
<a href="#l51.14"></a><span id="l51.14" class="difflineplus">+</span>
<a href="#l51.15"></a><span id="l51.15" class="difflineplus">+const MSG_VIEW_FLAG_DUMMY = 0x20000000;</span>
<a href="#l51.16"></a><span id="l51.16"> </span>
<a href="#l51.17"></a><span id="l51.17"> /**</span>
<a href="#l51.18"></a><span id="l51.18">  * Helper singleton for DBViewWrapper that tells instances when something</span>
<a href="#l51.19"></a><span id="l51.19">  *  interesting is happening to the folder(s) they care about.  The rationale</span>
<a href="#l51.20"></a><span id="l51.20">  *  for this is to:</span>
<a href="#l51.21"></a><span id="l51.21">  * - reduce listener overhead (although arguably the events we listen to are</span>
<a href="#l51.22"></a><span id="l51.22">  *     fairly rare)</span>
<a href="#l51.23"></a><span id="l51.23">  * - make testing / verification easier by centralizing and exposing listeners.</span>
<a href="#l51.24"></a><span id="l51.24" class="difflineat">@@ -75,27 +79,23 @@ var FolderNotificationHelper = {</span>
<a href="#l51.25"></a><span id="l51.25">   _interestedWrappers: {},</span>
<a href="#l51.26"></a><span id="l51.26"> </span>
<a href="#l51.27"></a><span id="l51.27">   /**</span>
<a href="#l51.28"></a><span id="l51.28">    * Initialize our listeners.  We currently don't bother cleaning these up</span>
<a href="#l51.29"></a><span id="l51.29">    *  because we are a singleton and if anyone imports us, they probably want</span>
<a href="#l51.30"></a><span id="l51.30">    *  us for as long as their application so shall live.</span>
<a href="#l51.31"></a><span id="l51.31">    */</span>
<a href="#l51.32"></a><span id="l51.32">   _init: function FolderNotificationHelper__init() {</span>
<a href="#l51.33"></a><span id="l51.33" class="difflineminus">-    let atomService =</span>
<a href="#l51.34"></a><span id="l51.34" class="difflineminus">-      Cc[&quot;@mozilla.org/atom-service;1&quot;]</span>
<a href="#l51.35"></a><span id="l51.35" class="difflineminus">-        .getService(Ci.nsIAtomService);</span>
<a href="#l51.36"></a><span id="l51.36" class="difflineminus">-      this._kFolderLoadedAtom = atomService.getAtom(&quot;FolderLoaded&quot;);</span>
<a href="#l51.37"></a><span id="l51.37" class="difflineminus">-</span>
<a href="#l51.38"></a><span id="l51.38">     // register with the session for our folded loaded notifications</span>
<a href="#l51.39"></a><span id="l51.39">     let mailSession =</span>
<a href="#l51.40"></a><span id="l51.40">       Cc[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l51.41"></a><span id="l51.41">         .getService(Ci.nsIMsgMailSession);</span>
<a href="#l51.42"></a><span id="l51.42">     mailSession.AddFolderListener(this,</span>
<a href="#l51.43"></a><span id="l51.43" class="difflineminus">-                                  Ci.nsIFolderListener.event);</span>
<a href="#l51.44"></a><span id="l51.44" class="difflineplus">+                                  Ci.nsIFolderListener.event |</span>
<a href="#l51.45"></a><span id="l51.45" class="difflineplus">+                                  Ci.nsIFolderListener.intPropertyChanged);</span>
<a href="#l51.46"></a><span id="l51.46"> </span>
<a href="#l51.47"></a><span id="l51.47">     // register with the notification service for deleted folder notifications</span>
<a href="#l51.48"></a><span id="l51.48">     let notificationService =</span>
<a href="#l51.49"></a><span id="l51.49">       Cc[&quot;@mozilla.org/messenger/msgnotificationservice;1&quot;]</span>
<a href="#l51.50"></a><span id="l51.50">         .getService(Ci.nsIMsgFolderNotificationService);</span>
<a href="#l51.51"></a><span id="l51.51">     notificationService.addListener(this,</span>
<a href="#l51.52"></a><span id="l51.52">       Ci.nsIMsgFolderNotificationService.folderDeleted |</span>
<a href="#l51.53"></a><span id="l51.53">       // we need to track renames because we key off of URIs. frick.</span>
<a href="#l51.54"></a><span id="l51.54" class="difflineat">@@ -138,17 +138,17 @@ var FolderNotificationHelper = {</span>
<a href="#l51.55"></a><span id="l51.55">    * @param aNotherFolder A folder that may or may not be in aFolders.</span>
<a href="#l51.56"></a><span id="l51.56">    * @param aViewWrapper The view wrapper that is up to no good.</span>
<a href="#l51.57"></a><span id="l51.57">    */</span>
<a href="#l51.58"></a><span id="l51.58">   stalkFolders: function FolderNotificationHelper_stalkFolders(</span>
<a href="#l51.59"></a><span id="l51.59">       aFolders, aNotherFolder, aViewWrapper) {</span>
<a href="#l51.60"></a><span id="l51.60">     let folders = aFolders.concat();</span>
<a href="#l51.61"></a><span id="l51.61">     if (aNotherFolder &amp;&amp; folders.indexOf(aNotherFolder) == -1)</span>
<a href="#l51.62"></a><span id="l51.62">       folders.push(aNotherFolder);</span>
<a href="#l51.63"></a><span id="l51.63" class="difflineminus">-    for each (let [, folder] in Iterator(aFolders)) {</span>
<a href="#l51.64"></a><span id="l51.64" class="difflineplus">+    for each (let [, folder] in Iterator(folders)) {</span>
<a href="#l51.65"></a><span id="l51.65">       let wrappers = this._interestedWrappers[folder.URI];</span>
<a href="#l51.66"></a><span id="l51.66">       if (wrappers == null)</span>
<a href="#l51.67"></a><span id="l51.67">         wrappers = this._interestedWrappers[folder.URI] = [];</span>
<a href="#l51.68"></a><span id="l51.68">       wrappers.push(aViewWrapper);</span>
<a href="#l51.69"></a><span id="l51.69">     }</span>
<a href="#l51.70"></a><span id="l51.70">   },</span>
<a href="#l51.71"></a><span id="l51.71"> </span>
<a href="#l51.72"></a><span id="l51.72">   /**</span>
<a href="#l51.73"></a><span id="l51.73" class="difflineat">@@ -195,20 +195,31 @@ var FolderNotificationHelper = {</span>
<a href="#l51.74"></a><span id="l51.74">     for each (let [folderURI, wrappers] in</span>
<a href="#l51.75"></a><span id="l51.75">               Iterator(this._interestedWrappers)) {</span>
<a href="#l51.76"></a><span id="l51.76">       return true;</span>
<a href="#l51.77"></a><span id="l51.77">     }</span>
<a href="#l51.78"></a><span id="l51.78">     return false;</span>
<a href="#l51.79"></a><span id="l51.79">   },</span>
<a href="#l51.80"></a><span id="l51.80"> </span>
<a href="#l51.81"></a><span id="l51.81">   /* ***** Notifications ***** */</span>
<a href="#l51.82"></a><span id="l51.82" class="difflineplus">+  _notifyHelper: function FolderNotificationHelper__notifyHelper(aFolder,</span>
<a href="#l51.83"></a><span id="l51.83" class="difflineplus">+                                                                 aHandlerName) {</span>
<a href="#l51.84"></a><span id="l51.84" class="difflineplus">+    let wrappers = this._interestedWrappers[aFolder.URI];</span>
<a href="#l51.85"></a><span id="l51.85" class="difflineplus">+    if (wrappers) {</span>
<a href="#l51.86"></a><span id="l51.86" class="difflineplus">+      // clone the list to avoid confusing mutation by listeners</span>
<a href="#l51.87"></a><span id="l51.87" class="difflineplus">+      for each (let [, wrapper] in Iterator(wrappers.concat())) {</span>
<a href="#l51.88"></a><span id="l51.88" class="difflineplus">+        wrapper[aHandlerName](aFolder);</span>
<a href="#l51.89"></a><span id="l51.89" class="difflineplus">+      }</span>
<a href="#l51.90"></a><span id="l51.90" class="difflineplus">+    }</span>
<a href="#l51.91"></a><span id="l51.91" class="difflineplus">+  },</span>
<a href="#l51.92"></a><span id="l51.92"> </span>
<a href="#l51.93"></a><span id="l51.93">   OnItemEvent: function FolderNotificationHelper_OnItemEvent(</span>
<a href="#l51.94"></a><span id="l51.94">       aFolder, aEvent) {</span>
<a href="#l51.95"></a><span id="l51.95" class="difflineminus">-    if (aEvent == this._kFolderLoadedAtom) {</span>
<a href="#l51.96"></a><span id="l51.96" class="difflineplus">+    let eventType = aEvent.toString();</span>
<a href="#l51.97"></a><span id="l51.97" class="difflineplus">+    if (eventType == &quot;FolderLoaded&quot;) {</span>
<a href="#l51.98"></a><span id="l51.98">       let folderURI = aFolder.URI;</span>
<a href="#l51.99"></a><span id="l51.99">       let widgets = this._pendingFolderUriToViewWrapperLists[folderURI];</span>
<a href="#l51.100"></a><span id="l51.100">       if (widgets) {</span>
<a href="#l51.101"></a><span id="l51.101">         for each (let [, widget] in Iterator(widgets)) {</span>
<a href="#l51.102"></a><span id="l51.102">           // we are friends, this is an explicit relationship.</span>
<a href="#l51.103"></a><span id="l51.103">           // (we don't use a generic callback mechanism because the 'this' stuff</span>
<a href="#l51.104"></a><span id="l51.104">           //  gets ugly and no one else should be hooking in at this level.)</span>
<a href="#l51.105"></a><span id="l51.105">           try {</span>
<a href="#l51.106"></a><span id="l51.106" class="difflineat">@@ -217,16 +228,36 @@ var FolderNotificationHelper = {</span>
<a href="#l51.107"></a><span id="l51.107">           catch (ex) {</span>
<a href="#l51.108"></a><span id="l51.108">             dump(&quot;``` EXCEPTION DURING NOTIFY: &quot; + ex.fileName + &quot;:&quot; +</span>
<a href="#l51.109"></a><span id="l51.109">                  ex.lineNumber + &quot;: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l51.110"></a><span id="l51.110">           }</span>
<a href="#l51.111"></a><span id="l51.111">         }</span>
<a href="#l51.112"></a><span id="l51.112">         delete this._pendingFolderUriToViewWrapperLists[folderURI];</span>
<a href="#l51.113"></a><span id="l51.113">       }</span>
<a href="#l51.114"></a><span id="l51.114">     }</span>
<a href="#l51.115"></a><span id="l51.115" class="difflineplus">+    else if (eventType == &quot;AboutToCompact&quot;) {</span>
<a href="#l51.116"></a><span id="l51.116" class="difflineplus">+      this._notifyHelper(aFolder, &quot;_aboutToCompactFolder&quot;);</span>
<a href="#l51.117"></a><span id="l51.117" class="difflineplus">+    }</span>
<a href="#l51.118"></a><span id="l51.118" class="difflineplus">+    else if (eventType == &quot;CompactCompleted&quot;) {</span>
<a href="#l51.119"></a><span id="l51.119" class="difflineplus">+      this._notifyHelper(aFolder, &quot;_compactedFolder&quot;);</span>
<a href="#l51.120"></a><span id="l51.120" class="difflineplus">+    }</span>
<a href="#l51.121"></a><span id="l51.121" class="difflineplus">+    else if (eventType == &quot;DeleteOrMoveMsgCompleted&quot;) {</span>
<a href="#l51.122"></a><span id="l51.122" class="difflineplus">+      this._notifyHelper(aFolder, &quot;_deleteCompleted&quot;);</span>
<a href="#l51.123"></a><span id="l51.123" class="difflineplus">+    }</span>
<a href="#l51.124"></a><span id="l51.124" class="difflineplus">+    else if (eventType == &quot;DeleteOrMoveMsgFailed&quot;) {</span>
<a href="#l51.125"></a><span id="l51.125" class="difflineplus">+      this._notifyHelper(aFolder, &quot;_deleteFailed&quot;);</span>
<a href="#l51.126"></a><span id="l51.126" class="difflineplus">+    }</span>
<a href="#l51.127"></a><span id="l51.127" class="difflineplus">+</span>
<a href="#l51.128"></a><span id="l51.128" class="difflineplus">+  },</span>
<a href="#l51.129"></a><span id="l51.129" class="difflineplus">+</span>
<a href="#l51.130"></a><span id="l51.130" class="difflineplus">+  OnItemIntPropertyChanged: function(aFolder, aProperty, aOldValue, aNewValue) {</span>
<a href="#l51.131"></a><span id="l51.131" class="difflineplus">+    let propertyString = aProperty.toString();</span>
<a href="#l51.132"></a><span id="l51.132" class="difflineplus">+    if ((propertyString == &quot;TotalMessages&quot;) ||</span>
<a href="#l51.133"></a><span id="l51.133" class="difflineplus">+        (propertyString == &quot;TotalUnreadMessages&quot;))</span>
<a href="#l51.134"></a><span id="l51.134" class="difflineplus">+      this._notifyHelper(aFolder, &quot;_messageCountsChanged&quot;);</span>
<a href="#l51.135"></a><span id="l51.135">   },</span>
<a href="#l51.136"></a><span id="l51.136"> </span>
<a href="#l51.137"></a><span id="l51.137">   _folderMoveHelper: function(aOldFolder, aNewFolder) {</span>
<a href="#l51.138"></a><span id="l51.138">     let oldURI = aOldFolder.URI;</span>
<a href="#l51.139"></a><span id="l51.139">     let newURI = aNewFolder.URI;</span>
<a href="#l51.140"></a><span id="l51.140">     // fix up our listener tables.</span>
<a href="#l51.141"></a><span id="l51.141">     if (oldURI in this._pendingFolderUriToViewWrapperLists) {</span>
<a href="#l51.142"></a><span id="l51.142">       this._pendingFolderUriToViewWrapperLists[newURI] =</span>
<a href="#l51.143"></a><span id="l51.143" class="difflineat">@@ -271,17 +302,17 @@ var FolderNotificationHelper = {</span>
<a href="#l51.144"></a><span id="l51.144"> </span>
<a href="#l51.145"></a><span id="l51.145">   folderDeleted: function FolderNotificationHelper_folderDeleted(aFolder) {</span>
<a href="#l51.146"></a><span id="l51.146">     let wrappers = this._interestedWrappers[aFolder.URI];</span>
<a href="#l51.147"></a><span id="l51.147">     if (wrappers) {</span>
<a href="#l51.148"></a><span id="l51.148">       // clone the list to avoid confusing mutation by listeners</span>
<a href="#l51.149"></a><span id="l51.149">       for each (let [, wrapper] in Iterator(wrappers.concat())) {</span>
<a href="#l51.150"></a><span id="l51.150">         wrapper._folderDeleted(aFolder);</span>
<a href="#l51.151"></a><span id="l51.151">       }</span>
<a href="#l51.152"></a><span id="l51.152" class="difflineminus">-      // if the folder is deleted, it's not going to get deleted again.</span>
<a href="#l51.153"></a><span id="l51.153" class="difflineplus">+      // if the folder is deleted, it's not going to ever do anything again</span>
<a href="#l51.154"></a><span id="l51.154">       delete this._interestedWrappers[aFolder.URI];</span>
<a href="#l51.155"></a><span id="l51.155">     }</span>
<a href="#l51.156"></a><span id="l51.156">   },</span>
<a href="#l51.157"></a><span id="l51.157"> };</span>
<a href="#l51.158"></a><span id="l51.158"> FolderNotificationHelper._init();</span>
<a href="#l51.159"></a><span id="l51.159"> </span>
<a href="#l51.160"></a><span id="l51.160"> </span>
<a href="#l51.161"></a><span id="l51.161"> /**</span>
<a href="#l51.162"></a><span id="l51.162" class="difflineat">@@ -364,64 +395,117 @@ IDBViewWrapperListener.prototype = {</span>
<a href="#l51.163"></a><span id="l51.163">    *  is fundamentally a UI issue.  Additionally, because the MsgCreateDBView</span>
<a href="#l51.164"></a><span id="l51.164">    *  notification consumers assume gDBView whose exposure is affected by tabs,</span>
<a href="#l51.165"></a><span id="l51.165">    *  the tab logic needs to be involved.</span>
<a href="#l51.166"></a><span id="l51.166">    */</span>
<a href="#l51.167"></a><span id="l51.167">   onCreatedView: function() {</span>
<a href="#l51.168"></a><span id="l51.168">   },</span>
<a href="#l51.169"></a><span id="l51.169"> </span>
<a href="#l51.170"></a><span id="l51.170">   /**</span>
<a href="#l51.171"></a><span id="l51.171" class="difflineplus">+   * This event is generated just before we close/destroy a message view.</span>
<a href="#l51.172"></a><span id="l51.172" class="difflineplus">+   *</span>
<a href="#l51.173"></a><span id="l51.173" class="difflineplus">+   * @param aFolderIsComingBack Indicates whether we are planning to create a</span>
<a href="#l51.174"></a><span id="l51.174" class="difflineplus">+   *     new view to display the same folder after we destroy this view.  This</span>
<a href="#l51.175"></a><span id="l51.175" class="difflineplus">+   *     will be the case unless we are switching to display a new folder or</span>
<a href="#l51.176"></a><span id="l51.176" class="difflineplus">+   *     closing the view wrapper entirely.</span>
<a href="#l51.177"></a><span id="l51.177" class="difflineplus">+   */</span>
<a href="#l51.178"></a><span id="l51.178" class="difflineplus">+  onDestroyingView: function(aFolderIsComingBack) {</span>
<a href="#l51.179"></a><span id="l51.179" class="difflineplus">+  },</span>
<a href="#l51.180"></a><span id="l51.180" class="difflineplus">+</span>
<a href="#l51.181"></a><span id="l51.181" class="difflineplus">+  /**</span>
<a href="#l51.182"></a><span id="l51.182">    * Generated when the folder is being entered for display.  This is the chance</span>
<a href="#l51.183"></a><span id="l51.183">    *  for the listener to affect any UI-related changes to the folder required.</span>
<a href="#l51.184"></a><span id="l51.184">    *  Currently, this just means setting the header cache size (which needs to</span>
<a href="#l51.185"></a><span id="l51.185">    *  be proportional to the number of lines in the tree view, and is thus a</span>
<a href="#l51.186"></a><span id="l51.186">    *  UI issue.)</span>
<a href="#l51.187"></a><span id="l51.187">    */</span>
<a href="#l51.188"></a><span id="l51.188">   onDisplayingFolder: function() {</span>
<a href="#l51.189"></a><span id="l51.189">   },</span>
<a href="#l51.190"></a><span id="l51.190"> </span>
<a href="#l51.191"></a><span id="l51.191">   /**</span>
<a href="#l51.192"></a><span id="l51.192" class="difflineplus">+   * Generated when we are leaving a folder.</span>
<a href="#l51.193"></a><span id="l51.193" class="difflineplus">+   */</span>
<a href="#l51.194"></a><span id="l51.194" class="difflineplus">+  onLeavingFolder: function() {</span>
<a href="#l51.195"></a><span id="l51.195" class="difflineplus">+  },</span>
<a href="#l51.196"></a><span id="l51.196" class="difflineplus">+</span>
<a href="#l51.197"></a><span id="l51.197" class="difflineplus">+  /**</span>
<a href="#l51.198"></a><span id="l51.198">    * Things to do once all the messages that should show up in a folder have</span>
<a href="#l51.199"></a><span id="l51.199">    *  shown up.  For a real folder, this happens when the folder is entered.</span>
<a href="#l51.200"></a><span id="l51.200">    *  For a (multi-folder) virtual folder, this happens when the search</span>
<a href="#l51.201"></a><span id="l51.201">    *  completes.</span>
<a href="#l51.202"></a><span id="l51.202">    */</span>
<a href="#l51.203"></a><span id="l51.203">   onAllMessagesLoaded: function() {</span>
<a href="#l51.204"></a><span id="l51.204">   },</span>
<a href="#l51.205"></a><span id="l51.205"> </span>
<a href="#l51.206"></a><span id="l51.206">   /**</span>
<a href="#l51.207"></a><span id="l51.207">    * The mail view changed.  The mail view widget is likely to care about this.</span>
<a href="#l51.208"></a><span id="l51.208">    */</span>
<a href="#l51.209"></a><span id="l51.209" class="difflineminus">-  onMailViewChanged: function () {</span>
<a href="#l51.210"></a><span id="l51.210" class="difflineplus">+  onMailViewChanged: function() {</span>
<a href="#l51.211"></a><span id="l51.211" class="difflineplus">+  },</span>
<a href="#l51.212"></a><span id="l51.212"> </span>
<a href="#l51.213"></a><span id="l51.213" class="difflineplus">+  /**</span>
<a href="#l51.214"></a><span id="l51.214" class="difflineplus">+   * The active sort changed, and that is all that changed.  If the sort is</span>
<a href="#l51.215"></a><span id="l51.215" class="difflineplus">+   *  changing because the view is being destroyed and re-created, this event</span>
<a href="#l51.216"></a><span id="l51.216" class="difflineplus">+   *  will not be generated.</span>
<a href="#l51.217"></a><span id="l51.217" class="difflineplus">+   */</span>
<a href="#l51.218"></a><span id="l51.218" class="difflineplus">+  onSortChanged: function() {</span>
<a href="#l51.219"></a><span id="l51.219">   },</span>
<a href="#l51.220"></a><span id="l51.220"> </span>
<a href="#l51.221"></a><span id="l51.221" class="difflineplus">+  /**</span>
<a href="#l51.222"></a><span id="l51.222" class="difflineplus">+   * This event is generated when messages in one of the folders backing the</span>
<a href="#l51.223"></a><span id="l51.223" class="difflineplus">+   *  view have been removed by message moves / deletion.  If there is a search</span>
<a href="#l51.224"></a><span id="l51.224" class="difflineplus">+   *  in effect, it is possible that the removed messages were not visible in</span>
<a href="#l51.225"></a><span id="l51.225" class="difflineplus">+   *  the view in the first place.</span>
<a href="#l51.226"></a><span id="l51.226" class="difflineplus">+   */</span>
<a href="#l51.227"></a><span id="l51.227" class="difflineplus">+  onMessagesRemoved: function () {</span>
<a href="#l51.228"></a><span id="l51.228" class="difflineplus">+  },</span>
<a href="#l51.229"></a><span id="l51.229"> </span>
<a href="#l51.230"></a><span id="l51.230" class="difflineplus">+  /**</span>
<a href="#l51.231"></a><span id="l51.231" class="difflineplus">+   * Like onMessagesRemoved, but something went awry in the move/deletion and</span>
<a href="#l51.232"></a><span id="l51.232" class="difflineplus">+   *  it failed.  Although this is not a very interesting event on its own,</span>
<a href="#l51.233"></a><span id="l51.233" class="difflineplus">+   *  it is useful in cases where the listener was expecting an</span>
<a href="#l51.234"></a><span id="l51.234" class="difflineplus">+   *  onMessagesRemoved and might need to clean some state up.</span>
<a href="#l51.235"></a><span id="l51.235" class="difflineplus">+   */</span>
<a href="#l51.236"></a><span id="l51.236" class="difflineplus">+  onMessageRemovalFailed: function () {</span>
<a href="#l51.237"></a><span id="l51.237" class="difflineplus">+  },</span>
<a href="#l51.238"></a><span id="l51.238" class="difflineplus">+</span>
<a href="#l51.239"></a><span id="l51.239" class="difflineplus">+  /**</span>
<a href="#l51.240"></a><span id="l51.240" class="difflineplus">+   * The total message count or total unread message counts changed.</span>
<a href="#l51.241"></a><span id="l51.241" class="difflineplus">+   */</span>
<a href="#l51.242"></a><span id="l51.242" class="difflineplus">+  onMessageCountsChanged: function () {</span>
<a href="#l51.243"></a><span id="l51.243" class="difflineplus">+  },</span>
<a href="#l51.244"></a><span id="l51.244"> };</span>
<a href="#l51.245"></a><span id="l51.245"> </span>
<a href="#l51.246"></a><span id="l51.246"> /**</span>
<a href="#l51.247"></a><span id="l51.247">  * Encapsulates everything related to working with our nsIMsgDBView</span>
<a href="#l51.248"></a><span id="l51.248">  *  implementations.</span>
<a href="#l51.249"></a><span id="l51.249" class="difflineplus">+ *</span>
<a href="#l51.250"></a><span id="l51.250" class="difflineplus">+ * Things we do not do and why we do not do them:</span>
<a href="#l51.251"></a><span id="l51.251" class="difflineplus">+ * - Selection.  This depends on having an nsITreeSelection object and we choose</span>
<a href="#l51.252"></a><span id="l51.252" class="difflineplus">+ *   to avoid entanglement with XUL/layout code.  Selection accordingly must be</span>
<a href="#l51.253"></a><span id="l51.253" class="difflineplus">+ *   handled a layer up in the FolderDisplayWidget.</span>
<a href="#l51.254"></a><span id="l51.254">  */</span>
<a href="#l51.255"></a><span id="l51.255"> function DBViewWrapper(aListener) {</span>
<a href="#l51.256"></a><span id="l51.256">   this.displayedFolder = null;</span>
<a href="#l51.257"></a><span id="l51.257">   this.listener = aListener;</span>
<a href="#l51.258"></a><span id="l51.258"> </span>
<a href="#l51.259"></a><span id="l51.259">   this._underlyingData = this.kUnderlyingNone;</span>
<a href="#l51.260"></a><span id="l51.260">   this._underlyingFolders = null;</span>
<a href="#l51.261"></a><span id="l51.261" class="difflineplus">+  this._syntheticView = null;</span>
<a href="#l51.262"></a><span id="l51.262"> </span>
<a href="#l51.263"></a><span id="l51.263">   this._viewUpdateDepth = 0;</span>
<a href="#l51.264"></a><span id="l51.264"> </span>
<a href="#l51.265"></a><span id="l51.265">   this._mailViewIndex = MailViewConstants.kViewItemAll;</span>
<a href="#l51.266"></a><span id="l51.266">   this._mailViewData = null;</span>
<a href="#l51.267"></a><span id="l51.267"> </span>
<a href="#l51.268"></a><span id="l51.268">   this._specialView = null;</span>
<a href="#l51.269"></a><span id="l51.269"> </span>
<a href="#l51.270"></a><span id="l51.270">   this._sort = [];</span>
<a href="#l51.271"></a><span id="l51.271" class="difflineminus">-  this._viewFlags = 0;</span>
<a href="#l51.272"></a><span id="l51.272" class="difflineplus">+  // see the _viewFlags getter and setter for info on our use of __viewFlags.</span>
<a href="#l51.273"></a><span id="l51.273" class="difflineplus">+  this.__viewFlags = null;</span>
<a href="#l51.274"></a><span id="l51.274"> </span>
<a href="#l51.275"></a><span id="l51.275">   this.dbView = null;</span>
<a href="#l51.276"></a><span id="l51.276">   this.search = null;</span>
<a href="#l51.277"></a><span id="l51.277"> </span>
<a href="#l51.278"></a><span id="l51.278">   this._folderLoading = false;</span>
<a href="#l51.279"></a><span id="l51.279">   this._searching = false;</span>
<a href="#l51.280"></a><span id="l51.280"> }</span>
<a href="#l51.281"></a><span id="l51.281"> DBViewWrapper.prototype = {</span>
<a href="#l51.282"></a><span id="l51.282" class="difflineat">@@ -436,108 +520,220 @@ DBViewWrapper.prototype = {</span>
<a href="#l51.283"></a><span id="l51.283">   kUnderlyingRealFolder: 1,</span>
<a href="#l51.284"></a><span id="l51.284">   /**</span>
<a href="#l51.285"></a><span id="l51.285">    * The underlying data source is a virtual folder that is operating over</span>
<a href="#l51.286"></a><span id="l51.286">    *  multiple underlying folders.</span>
<a href="#l51.287"></a><span id="l51.287">    */</span>
<a href="#l51.288"></a><span id="l51.288">   kUnderlyingMultipleFolder: 2,</span>
<a href="#l51.289"></a><span id="l51.289">   /**</span>
<a href="#l51.290"></a><span id="l51.290">    * Our data source is transient, most likely a gloda search that crammed the</span>
<a href="#l51.291"></a><span id="l51.291" class="difflineminus">-   *  results into us.</span>
<a href="#l51.292"></a><span id="l51.292" class="difflineplus">+   *  results into us.  This is different from a search view.</span>
<a href="#l51.293"></a><span id="l51.293">    */</span>
<a href="#l51.294"></a><span id="l51.294">   kUnderlyingSynthetic: 3,</span>
<a href="#l51.295"></a><span id="l51.295" class="difflineplus">+  /**</span>
<a href="#l51.296"></a><span id="l51.296" class="difflineplus">+   * We are a search view, which translates into a search that has underlying</span>
<a href="#l51.297"></a><span id="l51.297" class="difflineplus">+   *  folders, just like kUnderlyingMultipleFolder, but we have no</span>
<a href="#l51.298"></a><span id="l51.298" class="difflineplus">+   *  displayedFolder.  We differ from kUnderlyingSynthetic in that we are</span>
<a href="#l51.299"></a><span id="l51.299" class="difflineplus">+   *  not just a bunch of message headers randomly crammed in.</span>
<a href="#l51.300"></a><span id="l51.300" class="difflineplus">+   */</span>
<a href="#l51.301"></a><span id="l51.301" class="difflineplus">+  kUnderlyingSearchView: 4,</span>
<a href="#l51.302"></a><span id="l51.302"> </span>
<a href="#l51.303"></a><span id="l51.303">   /**</span>
<a href="#l51.304"></a><span id="l51.304">    * @return true if the folder being displayed is backed by a single 'real'</span>
<a href="#l51.305"></a><span id="l51.305">    *     folder.  This folder can be a saved search on that folder or just</span>
<a href="#l51.306"></a><span id="l51.306">    *     an outright un-filtered display of that folder.</span>
<a href="#l51.307"></a><span id="l51.307">    */</span>
<a href="#l51.308"></a><span id="l51.308">   get isSingleFolder() {</span>
<a href="#l51.309"></a><span id="l51.309">     return this._underlyingData == this.kUnderlyingRealFolder;</span>
<a href="#l51.310"></a><span id="l51.310">   },</span>
<a href="#l51.311"></a><span id="l51.311"> </span>
<a href="#l51.312"></a><span id="l51.312">   /**</span>
<a href="#l51.313"></a><span id="l51.313">    * @return true if the folder being displayed is a virtual folder backed by</span>
<a href="#l51.314"></a><span id="l51.314" class="difflineminus">-   *     multiple 'real' folders.  This corresponds to a cross-folder saved</span>
<a href="#l51.315"></a><span id="l51.315" class="difflineminus">-   *     search.</span>
<a href="#l51.316"></a><span id="l51.316" class="difflineplus">+   *     multiple 'real' folders or a search view.  This corresponds to a</span>
<a href="#l51.317"></a><span id="l51.317" class="difflineplus">+   *     cross-folder saved search.</span>
<a href="#l51.318"></a><span id="l51.318">    */</span>
<a href="#l51.319"></a><span id="l51.319">   get isMultiFolder() {</span>
<a href="#l51.320"></a><span id="l51.320" class="difflineminus">-    return this._underlyingData == this.kUnderlyingMultipleFolder;</span>
<a href="#l51.321"></a><span id="l51.321" class="difflineplus">+    return (this._underlyingData == this.kUnderlyingMultipleFolder) ||</span>
<a href="#l51.322"></a><span id="l51.322" class="difflineplus">+           (this._underlyingData == this.kUnderlyingSearchView);;</span>
<a href="#l51.323"></a><span id="l51.323">   },</span>
<a href="#l51.324"></a><span id="l51.324"> </span>
<a href="#l51.325"></a><span id="l51.325">   /**</span>
<a href="#l51.326"></a><span id="l51.326">    * @return true if the folder being displayed is not a real folder at all,</span>
<a href="#l51.327"></a><span id="l51.327">    *     but rather the result of an un-scoped search, such as a gloda search.</span>
<a href="#l51.328"></a><span id="l51.328">    */</span>
<a href="#l51.329"></a><span id="l51.329">   get isSynthetic() {</span>
<a href="#l51.330"></a><span id="l51.330">     return this._underlyingData == this.kUnderlyingSynthetic;</span>
<a href="#l51.331"></a><span id="l51.331">   },</span>
<a href="#l51.332"></a><span id="l51.332"> </span>
<a href="#l51.333"></a><span id="l51.333">   /**</span>
<a href="#l51.334"></a><span id="l51.334" class="difflineplus">+   * Check if the folder in question backs the currently displayed folder.  For</span>
<a href="#l51.335"></a><span id="l51.335" class="difflineplus">+   *  a virtual folder, this is a test of whether the virtual folder includes</span>
<a href="#l51.336"></a><span id="l51.336" class="difflineplus">+   *  messages from the given folder.  For a 'real' single folder, this is</span>
<a href="#l51.337"></a><span id="l51.337" class="difflineplus">+   *  effectively a test against displayedFolder.</span>
<a href="#l51.338"></a><span id="l51.338" class="difflineplus">+   * If you want to see if the displayed folder is a folder, just compare</span>
<a href="#l51.339"></a><span id="l51.339" class="difflineplus">+   *  against the displayedFolder attribute.</span>
<a href="#l51.340"></a><span id="l51.340" class="difflineplus">+   */</span>
<a href="#l51.341"></a><span id="l51.341" class="difflineplus">+  isUnderlyingFolder: function DBViewWrapper_isUnderlyingFolder(aFolder) {</span>
<a href="#l51.342"></a><span id="l51.342" class="difflineplus">+    for each (let [i,underlyingFolder] in Iterator(this._underlyingFolders)) {</span>
<a href="#l51.343"></a><span id="l51.343" class="difflineplus">+      if (aFolder == underlyingFolder)</span>
<a href="#l51.344"></a><span id="l51.344" class="difflineplus">+        return true;</span>
<a href="#l51.345"></a><span id="l51.345" class="difflineplus">+    }</span>
<a href="#l51.346"></a><span id="l51.346" class="difflineplus">+    return false;</span>
<a href="#l51.347"></a><span id="l51.347" class="difflineplus">+  },</span>
<a href="#l51.348"></a><span id="l51.348" class="difflineplus">+</span>
<a href="#l51.349"></a><span id="l51.349" class="difflineplus">+  /**</span>
<a href="#l51.350"></a><span id="l51.350">    * Refresh the view by re-creating the view.  You would do this to get rid of</span>
<a href="#l51.351"></a><span id="l51.351">    *  messages that no longer match the view but are kept around for view</span>
<a href="#l51.352"></a><span id="l51.352">    *  stability reasons.  (In other words, in an unread-messages view, you would</span>
<a href="#l51.353"></a><span id="l51.353">    *  go insane if when you clicked on a message it immediately disappeared</span>
<a href="#l51.354"></a><span id="l51.354">    *  because it no longer matched.)</span>
<a href="#l51.355"></a><span id="l51.355">    * This method was adding for testing purposes and does not have a (legacy) UI</span>
<a href="#l51.356"></a><span id="l51.356">    *  reason for existing.  (The 'open' method is intended to behave identically</span>
<a href="#l51.357"></a><span id="l51.357">    *  to the legacy UI if you click on the currently displayed folder.)</span>
<a href="#l51.358"></a><span id="l51.358">    */</span>
<a href="#l51.359"></a><span id="l51.359">   refresh: function DBViewWrapper_refresh() {</span>
<a href="#l51.360"></a><span id="l51.360">     this._applyViewChanges();</span>
<a href="#l51.361"></a><span id="l51.361">   },</span>
<a href="#l51.362"></a><span id="l51.362"> </span>
<a href="#l51.363"></a><span id="l51.363">   /**</span>
<a href="#l51.364"></a><span id="l51.364" class="difflineplus">+   * Null out the folder's database to avoid memory bloat if we don't have a</span>
<a href="#l51.365"></a><span id="l51.365" class="difflineplus">+   *  reason to keep the database around.  Currently, we keep all Inboxes</span>
<a href="#l51.366"></a><span id="l51.366" class="difflineplus">+   *  around and null out everyone else.  This is a standard stopgap measure</span>
<a href="#l51.367"></a><span id="l51.367" class="difflineplus">+   *  until we have something more clever going on.</span>
<a href="#l51.368"></a><span id="l51.368" class="difflineplus">+   * In general, there is little potential downside to nulling out the message</span>
<a href="#l51.369"></a><span id="l51.369" class="difflineplus">+   *  database reference when it is in use.  As long as someone is holding onto</span>
<a href="#l51.370"></a><span id="l51.370" class="difflineplus">+   *  a message header from the database, the database will be kept open, and</span>
<a href="#l51.371"></a><span id="l51.371" class="difflineplus">+   *  therefore the database service will still have a reference to the db.</span>
<a href="#l51.372"></a><span id="l51.372" class="difflineplus">+   *  When the folder goes to ask for the database again, the service will have</span>
<a href="#l51.373"></a><span id="l51.373" class="difflineplus">+   *  it, and it will not need to be re-opened.</span>
<a href="#l51.374"></a><span id="l51.374" class="difflineplus">+   *</span>
<a href="#l51.375"></a><span id="l51.375" class="difflineplus">+   * Another heuristic we could theoretically use is use the mail session's</span>
<a href="#l51.376"></a><span id="l51.376" class="difflineplus">+   *  isFolderOpenInWindow call, except that uses the outmoded concept that each</span>
<a href="#l51.377"></a><span id="l51.377" class="difflineplus">+   *  window will have at most one folder open.  So nuts to that.</span>
<a href="#l51.378"></a><span id="l51.378" class="difflineplus">+   *</span>
<a href="#l51.379"></a><span id="l51.379" class="difflineplus">+   * Note: regrettably a unit test cannot verify that we did this; msgDatabase</span>
<a href="#l51.380"></a><span id="l51.380" class="difflineplus">+   *  is a getter that will always try and load the message database!</span>
<a href="#l51.381"></a><span id="l51.381" class="difflineplus">+   */</span>
<a href="#l51.382"></a><span id="l51.382" class="difflineplus">+  _releaseFolderDatabase: function DBViewWrapper__nullFolderDatabase(aFolder) {</span>
<a href="#l51.383"></a><span id="l51.383" class="difflineplus">+    if (!this._isSpecialFolder(aFolder, nsMsgFolderFlags.Inbox, false))</span>
<a href="#l51.384"></a><span id="l51.384" class="difflineplus">+      aFolder.msgDatabase = null;</span>
<a href="#l51.385"></a><span id="l51.385" class="difflineplus">+  },</span>
<a href="#l51.386"></a><span id="l51.386" class="difflineplus">+</span>
<a href="#l51.387"></a><span id="l51.387" class="difflineplus">+  /**</span>
<a href="#l51.388"></a><span id="l51.388" class="difflineplus">+   * Clone this DBViewWrapper and its underlying nsIMsgDBView.</span>
<a href="#l51.389"></a><span id="l51.389" class="difflineplus">+   *</span>
<a href="#l51.390"></a><span id="l51.390" class="difflineplus">+   * @param aListener {IDBViewWrapperListener} The listener to use on the new view.</span>
<a href="#l51.391"></a><span id="l51.391" class="difflineplus">+   */</span>
<a href="#l51.392"></a><span id="l51.392" class="difflineplus">+  clone: function DBViewWrapper_clone(aListener) {</span>
<a href="#l51.393"></a><span id="l51.393" class="difflineplus">+    let doppel = new DBViewWrapper(aListener);</span>
<a href="#l51.394"></a><span id="l51.394" class="difflineplus">+</span>
<a href="#l51.395"></a><span id="l51.395" class="difflineplus">+    // -- copy attributes</span>
<a href="#l51.396"></a><span id="l51.396" class="difflineplus">+    doppel.displayedFolder = this.displayedFolder;</span>
<a href="#l51.397"></a><span id="l51.397" class="difflineplus">+    doppel._underlyingData = this._underlyingData;</span>
<a href="#l51.398"></a><span id="l51.398" class="difflineplus">+    doppel._underlyingFolders = this._underlyingFolders ?</span>
<a href="#l51.399"></a><span id="l51.399" class="difflineplus">+                                  this._underlyingFolders.concat() : null;</span>
<a href="#l51.400"></a><span id="l51.400" class="difflineplus">+    doppel._syntheticView = this._syntheticView;</span>
<a href="#l51.401"></a><span id="l51.401" class="difflineplus">+</span>
<a href="#l51.402"></a><span id="l51.402" class="difflineplus">+    // _viewUpdateDepth should stay at its initial value of zero</span>
<a href="#l51.403"></a><span id="l51.403" class="difflineplus">+    doppel._mailViewIndex = this._mailViewIndex;</span>
<a href="#l51.404"></a><span id="l51.404" class="difflineplus">+    doppel._mailViewData = this._mailViewData;</span>
<a href="#l51.405"></a><span id="l51.405" class="difflineplus">+</span>
<a href="#l51.406"></a><span id="l51.406" class="difflineplus">+    doppel._specialView = this._specialView;</span>
<a href="#l51.407"></a><span id="l51.407" class="difflineplus">+    // a shallow copy is all that is required for sort; we do not mutate entries</span>
<a href="#l51.408"></a><span id="l51.408" class="difflineplus">+    doppel._sort = this._sort.concat();</span>
<a href="#l51.409"></a><span id="l51.409" class="difflineplus">+</span>
<a href="#l51.410"></a><span id="l51.410" class="difflineplus">+    // -- register listeners...</span>
<a href="#l51.411"></a><span id="l51.411" class="difflineplus">+    // note: this does not get us a folder loaded notification.  Our expected</span>
<a href="#l51.412"></a><span id="l51.412" class="difflineplus">+    //  use case for cloning is displaying a single message already visible in</span>
<a href="#l51.413"></a><span id="l51.413" class="difflineplus">+    //  the original view, which implies we don't need to hang about for folder</span>
<a href="#l51.414"></a><span id="l51.414" class="difflineplus">+    //  loaded notification messages.</span>
<a href="#l51.415"></a><span id="l51.415" class="difflineplus">+    FolderNotificationHelper.stalkFolders(doppel._underlyingFolders,</span>
<a href="#l51.416"></a><span id="l51.416" class="difflineplus">+                                          doppel.displayedFolder,</span>
<a href="#l51.417"></a><span id="l51.417" class="difflineplus">+                                          doppel);</span>
<a href="#l51.418"></a><span id="l51.418" class="difflineplus">+</span>
<a href="#l51.419"></a><span id="l51.419" class="difflineplus">+    // -- clone the view</span>
<a href="#l51.420"></a><span id="l51.420" class="difflineplus">+    if (this.dbView)</span>
<a href="#l51.421"></a><span id="l51.421" class="difflineplus">+      doppel.dbView = this.dbView.cloneDBView(aListener.messenger,</span>
<a href="#l51.422"></a><span id="l51.422" class="difflineplus">+                                              aListener.msgWindow,</span>
<a href="#l51.423"></a><span id="l51.423" class="difflineplus">+                                              aListener.threadPaneCommandUpdater)</span>
<a href="#l51.424"></a><span id="l51.424" class="difflineplus">+                          .QueryInterface(Components.interfaces.nsITreeView);</span>
<a href="#l51.425"></a><span id="l51.425" class="difflineplus">+    // -- clone the search</span>
<a href="#l51.426"></a><span id="l51.426" class="difflineplus">+    if (this.search)</span>
<a href="#l51.427"></a><span id="l51.427" class="difflineplus">+      doppel.search = this.search.clone(doppel);</span>
<a href="#l51.428"></a><span id="l51.428" class="difflineplus">+</span>
<a href="#l51.429"></a><span id="l51.429" class="difflineplus">+    return doppel;</span>
<a href="#l51.430"></a><span id="l51.430" class="difflineplus">+  },</span>
<a href="#l51.431"></a><span id="l51.431" class="difflineplus">+</span>
<a href="#l51.432"></a><span id="l51.432" class="difflineplus">+  /**</span>
<a href="#l51.433"></a><span id="l51.433">    * Close the current view.  You would only do this if you want to clean up all</span>
<a href="#l51.434"></a><span id="l51.434">    *  the resources associated with this view wrapper.  You would not do this</span>
<a href="#l51.435"></a><span id="l51.435">    *  for UI reasons like the user de-selecting the node in the tree; we should</span>
<a href="#l51.436"></a><span id="l51.436">    *  always be displaying something when used in a UI context!</span>
<a href="#l51.437"></a><span id="l51.437">    *</span>
<a href="#l51.438"></a><span id="l51.438">    * @param aFolderIsDead If true, tells us not to try and tidy up on our way</span>
<a href="#l51.439"></a><span id="l51.439">    *     out by virtue of the fact that the folder is dead and should not be</span>
<a href="#l51.440"></a><span id="l51.440">    *     messed with.</span>
<a href="#l51.441"></a><span id="l51.441">    */</span>
<a href="#l51.442"></a><span id="l51.442">   close: function DBViewWrapper_close(aFolderIsDead) {</span>
<a href="#l51.443"></a><span id="l51.443" class="difflineminus">-    if (this._underlyingFolders)</span>
<a href="#l51.444"></a><span id="l51.444" class="difflineminus">-      FolderNotificationHelper.removeNotifications(this._underlyingFolders,</span>
<a href="#l51.445"></a><span id="l51.445" class="difflineminus">-                                                   this);</span>
<a href="#l51.446"></a><span id="l51.446" class="difflineminus">-</span>
<a href="#l51.447"></a><span id="l51.447">     if (this.displayedFolder != null) {</span>
<a href="#l51.448"></a><span id="l51.448">       // onLeavingFolder does all the application-level stuff related to leaving</span>
<a href="#l51.449"></a><span id="l51.449">       //  the folder (marking as read, etc.)  We only do this when the folder</span>
<a href="#l51.450"></a><span id="l51.450">       //  is not dead (for obvious reasons).</span>
<a href="#l51.451"></a><span id="l51.451" class="difflineminus">-      if (!aFolderIsDead)</span>
<a href="#l51.452"></a><span id="l51.452" class="difflineminus">-        this.onLeavingFolder();</span>
<a href="#l51.453"></a><span id="l51.453" class="difflineplus">+      if (!aFolderIsDead) {</span>
<a href="#l51.454"></a><span id="l51.454" class="difflineplus">+        // onLeavingFolder must be called before we potentially null out its</span>
<a href="#l51.455"></a><span id="l51.455" class="difflineplus">+        //  msgDatabase, which we will do in the upcoming underlyingFolders loop</span>
<a href="#l51.456"></a><span id="l51.456" class="difflineplus">+        this.onLeavingFolder(); // application logic</span>
<a href="#l51.457"></a><span id="l51.457" class="difflineplus">+        this.listener.onLeavingFolder(); // display logic</span>
<a href="#l51.458"></a><span id="l51.458" class="difflineplus">+      }</span>
<a href="#l51.459"></a><span id="l51.459" class="difflineplus">+      // (potentially) zero out the display folder if we are dealing with a</span>
<a href="#l51.460"></a><span id="l51.460" class="difflineplus">+      //  virtual folder and so the next loop won't take care of it.</span>
<a href="#l51.461"></a><span id="l51.461" class="difflineplus">+      if (this.isVirtual) {</span>
<a href="#l51.462"></a><span id="l51.462" class="difflineplus">+        FolderNotificationHelper.removeNotifications([this.displayedFolder],</span>
<a href="#l51.463"></a><span id="l51.463" class="difflineplus">+                                                     this);</span>
<a href="#l51.464"></a><span id="l51.464" class="difflineplus">+        this._releaseFolderDatabase(this.displayedFolder);</span>
<a href="#l51.465"></a><span id="l51.465" class="difflineplus">+      }</span>
<a href="#l51.466"></a><span id="l51.466" class="difflineplus">+</span>
<a href="#l51.467"></a><span id="l51.467" class="difflineplus">+      this.folderLoading = false;</span>
<a href="#l51.468"></a><span id="l51.468">       this.displayedFolder = null;</span>
<a href="#l51.469"></a><span id="l51.469" class="difflineminus">-      this.folderLoading = false;</span>
<a href="#l51.470"></a><span id="l51.470" class="difflineplus">+    }</span>
<a href="#l51.471"></a><span id="l51.471" class="difflineplus">+</span>
<a href="#l51.472"></a><span id="l51.472" class="difflineplus">+    if (this._underlyingFolders) {</span>
<a href="#l51.473"></a><span id="l51.473" class="difflineplus">+      FolderNotificationHelper.removeNotifications(this._underlyingFolders,</span>
<a href="#l51.474"></a><span id="l51.474" class="difflineplus">+                                                   this);</span>
<a href="#l51.475"></a><span id="l51.475" class="difflineplus">+      // (potentially) zero out the underlying msgDatabase references</span>
<a href="#l51.476"></a><span id="l51.476" class="difflineplus">+      for each (let [, folder] in Iterator(this._underlyingFolders))</span>
<a href="#l51.477"></a><span id="l51.477" class="difflineplus">+        this._releaseFolderDatabase(folder);</span>
<a href="#l51.478"></a><span id="l51.478">     }</span>
<a href="#l51.479"></a><span id="l51.479"> </span>
<a href="#l51.480"></a><span id="l51.480">     // kill off the view and its search association</span>
<a href="#l51.481"></a><span id="l51.481">     if (this.dbView) {</span>
<a href="#l51.482"></a><span id="l51.482" class="difflineplus">+      this.listener.onDestroyingView(false);</span>
<a href="#l51.483"></a><span id="l51.483">       this.search.dissociateView(this.dbView);</span>
<a href="#l51.484"></a><span id="l51.484">       this.dbView.close();</span>
<a href="#l51.485"></a><span id="l51.485">       this.dbView = null;</span>
<a href="#l51.486"></a><span id="l51.486">     }</span>
<a href="#l51.487"></a><span id="l51.487"> </span>
<a href="#l51.488"></a><span id="l51.488">     this._underlyingData = this.kUnderlyingNone;</span>
<a href="#l51.489"></a><span id="l51.489">     this._underlyingFolders = null;</span>
<a href="#l51.490"></a><span id="l51.490" class="difflineplus">+    this._syntheticView = null;</span>
<a href="#l51.491"></a><span id="l51.491"> </span>
<a href="#l51.492"></a><span id="l51.492">     this._mailViewIndex = MailViewConstants.kViewItemAll;</span>
<a href="#l51.493"></a><span id="l51.493">     this._mailViewData = null;</span>
<a href="#l51.494"></a><span id="l51.494"> </span>
<a href="#l51.495"></a><span id="l51.495">     this._specialView = null;</span>
<a href="#l51.496"></a><span id="l51.496"> </span>
<a href="#l51.497"></a><span id="l51.497">     this._sort = [];</span>
<a href="#l51.498"></a><span id="l51.498" class="difflineminus">-    this._viewFlags = 0;</span>
<a href="#l51.499"></a><span id="l51.499" class="difflineplus">+    this.__viewFlags = null;</span>
<a href="#l51.500"></a><span id="l51.500"> </span>
<a href="#l51.501"></a><span id="l51.501">     this.search = null;</span>
<a href="#l51.502"></a><span id="l51.502">   },</span>
<a href="#l51.503"></a><span id="l51.503"> </span>
<a href="#l51.504"></a><span id="l51.504">   /**</span>
<a href="#l51.505"></a><span id="l51.505" class="difflineminus">-   * Open the passed-in folder.</span>
<a href="#l51.506"></a><span id="l51.506" class="difflineplus">+   * Open the passed-in nsIMsgFolder folder.  Use openSynthetic for synthetic</span>
<a href="#l51.507"></a><span id="l51.507" class="difflineplus">+   *  view providers.</span>
<a href="#l51.508"></a><span id="l51.508">    */</span>
<a href="#l51.509"></a><span id="l51.509">   open: function DBViewWrapper_open(aFolder) {</span>
<a href="#l51.510"></a><span id="l51.510">     if (aFolder == null) {</span>
<a href="#l51.511"></a><span id="l51.511">       this.close();</span>
<a href="#l51.512"></a><span id="l51.512">       return;</span>
<a href="#l51.513"></a><span id="l51.513">     }</span>
<a href="#l51.514"></a><span id="l51.514"> </span>
<a href="#l51.515"></a><span id="l51.515">     // If we are in the same folder, there is nothing to do unless we are a</span>
<a href="#l51.516"></a><span id="l51.516" class="difflineat">@@ -565,22 +761,32 @@ DBViewWrapper.prototype = {</span>
<a href="#l51.517"></a><span id="l51.517">     this.beginViewUpdate();</span>
<a href="#l51.518"></a><span id="l51.518">     let msgDatabase = this.displayedFolder.msgDatabase;</span>
<a href="#l51.519"></a><span id="l51.519">     if (msgDatabase) {</span>
<a href="#l51.520"></a><span id="l51.520">       let dbFolderInfo = msgDatabase.dBFolderInfo;</span>
<a href="#l51.521"></a><span id="l51.521">       // - retrieve persisted sort information</span>
<a href="#l51.522"></a><span id="l51.522">       this._sort = [[dbFolderInfo.sortType, dbFolderInfo.sortOrder]];</span>
<a href="#l51.523"></a><span id="l51.523"> </span>
<a href="#l51.524"></a><span id="l51.524">       // - retrieve persisted display settings</span>
<a href="#l51.525"></a><span id="l51.525" class="difflineminus">-      this._viewFlags = dbFolderInfo.viewFlags;</span>
<a href="#l51.526"></a><span id="l51.526" class="difflineplus">+      this.__viewFlags = dbFolderInfo.viewFlags;</span>
<a href="#l51.527"></a><span id="l51.527" class="difflineplus">+      // Make sure the threaded bit is set if group-by-sort is set.  The views</span>
<a href="#l51.528"></a><span id="l51.528" class="difflineplus">+      //  encode 3 states in 2-bits, and we want to avoid that odd-man-out</span>
<a href="#l51.529"></a><span id="l51.529" class="difflineplus">+      //  state.</span>
<a href="#l51.530"></a><span id="l51.530" class="difflineplus">+      if (this.__viewFlags &amp; nsMsgViewFlagsType.kGroupBySort) {</span>
<a href="#l51.531"></a><span id="l51.531" class="difflineplus">+        this.__viewFlags |= nsMsgViewFlagsType.kThreadedDisplay;</span>
<a href="#l51.532"></a><span id="l51.532" class="difflineplus">+        this._ensureValidSort();</span>
<a href="#l51.533"></a><span id="l51.533" class="difflineplus">+      }</span>
<a href="#l51.534"></a><span id="l51.534"> </span>
<a href="#l51.535"></a><span id="l51.535">       // - retrieve virtual folder configuration</span>
<a href="#l51.536"></a><span id="l51.536">       if (aFolder.flags &amp; nsMsgFolderFlags.Virtual) {</span>
<a href="#l51.537"></a><span id="l51.537">         let virtFolder = VirtualFolderHelper.wrapVirtualFolder(aFolder);</span>
<a href="#l51.538"></a><span id="l51.538" class="difflineminus">-        this._underlyingFolders = virtFolder.searchFolders;</span>
<a href="#l51.539"></a><span id="l51.539" class="difflineplus">+        // Filter out the server roots; they only exist for UI reasons.</span>
<a href="#l51.540"></a><span id="l51.540" class="difflineplus">+        this._underlyingFolders =</span>
<a href="#l51.541"></a><span id="l51.541" class="difflineplus">+          [folder for each ([, folder] in Iterator(virtFolder.searchFolders))</span>
<a href="#l51.542"></a><span id="l51.542" class="difflineplus">+                  if (!folder.isServer)];</span>
<a href="#l51.543"></a><span id="l51.543">         this._underlyingData = (this._underlyingFolders.length &gt; 1) ?</span>
<a href="#l51.544"></a><span id="l51.544">                                this.kUnderlyingMultipleFolder :</span>
<a href="#l51.545"></a><span id="l51.545">                                this.kUnderlyingRealFolder;</span>
<a href="#l51.546"></a><span id="l51.546"> </span>
<a href="#l51.547"></a><span id="l51.547">         // figure out if we are using online IMAP searching</span>
<a href="#l51.548"></a><span id="l51.548">         this.search.onlineSearch = virtFolder.onlineSearch;</span>
<a href="#l51.549"></a><span id="l51.549"> </span>
<a href="#l51.550"></a><span id="l51.550">         // retrieve and chew the search query</span>
<a href="#l51.551"></a><span id="l51.551" class="difflineat">@@ -624,32 +830,87 @@ DBViewWrapper.prototype = {</span>
<a href="#l51.552"></a><span id="l51.552">             this.setMailView(MailViewConstants.kViewItemTags,</span>
<a href="#l51.553"></a><span id="l51.553">                              &quot;$label&quot; + (mailViewIndex-1));</span>
<a href="#l51.554"></a><span id="l51.554">           else</span>
<a href="#l51.555"></a><span id="l51.555">             this.setMailView(mailViewIndex);</span>
<a href="#l51.556"></a><span id="l51.556">         }</span>
<a href="#l51.557"></a><span id="l51.557">       }</span>
<a href="#l51.558"></a><span id="l51.558">     }</span>
<a href="#l51.559"></a><span id="l51.559"> </span>
<a href="#l51.560"></a><span id="l51.560" class="difflineplus">+    if (!this.isVirtual) {</span>
<a href="#l51.561"></a><span id="l51.561" class="difflineplus">+      this.folderLoading = true;</span>
<a href="#l51.562"></a><span id="l51.562" class="difflineplus">+      FolderNotificationHelper.updateFolderAndNotifyOnLoad(</span>
<a href="#l51.563"></a><span id="l51.563" class="difflineplus">+        this.displayedFolder, this, this.listener.msgWindow);</span>
<a href="#l51.564"></a><span id="l51.564" class="difflineplus">+    }</span>
<a href="#l51.565"></a><span id="l51.565" class="difflineplus">+</span>
<a href="#l51.566"></a><span id="l51.566" class="difflineplus">+    // we do this after kicking off the update because this could initiate a</span>
<a href="#l51.567"></a><span id="l51.567" class="difflineplus">+    //  search which could fight our explicit updateFolder call if the search</span>
<a href="#l51.568"></a><span id="l51.568" class="difflineplus">+    //  is already outstanding.</span>
<a href="#l51.569"></a><span id="l51.569">     if (this.shouldShowMessagesForFolderImmediately())</span>
<a href="#l51.570"></a><span id="l51.570">       this._enterFolder();</span>
<a href="#l51.571"></a><span id="l51.571" class="difflineplus">+  },</span>
<a href="#l51.572"></a><span id="l51.572"> </span>
<a href="#l51.573"></a><span id="l51.573" class="difflineminus">-    this.folderLoading = true;</span>
<a href="#l51.574"></a><span id="l51.574" class="difflineminus">-    if (!this.isVirtual)</span>
<a href="#l51.575"></a><span id="l51.575" class="difflineminus">-      FolderNotificationHelper.updateFolderAndNotifyOnLoad(</span>
<a href="#l51.576"></a><span id="l51.576" class="difflineminus">-        this.displayedFolder, this, this.listener.msgWindow);</span>
<a href="#l51.577"></a><span id="l51.577" class="difflineplus">+  /**</span>
<a href="#l51.578"></a><span id="l51.578" class="difflineplus">+   * Open a synthetic view provider as backing our view.</span>
<a href="#l51.579"></a><span id="l51.579" class="difflineplus">+   */</span>
<a href="#l51.580"></a><span id="l51.580" class="difflineplus">+  openSynthetic: function DBViewWrapper_openSynthetic(aSyntheticView) {</span>
<a href="#l51.581"></a><span id="l51.581" class="difflineplus">+    this.close();</span>
<a href="#l51.582"></a><span id="l51.582" class="difflineplus">+</span>
<a href="#l51.583"></a><span id="l51.583" class="difflineplus">+    this._underlyingData = this.kUnderlyingSynthetic;</span>
<a href="#l51.584"></a><span id="l51.584" class="difflineplus">+    this._syntheticView = aSyntheticView;</span>
<a href="#l51.585"></a><span id="l51.585" class="difflineplus">+</span>
<a href="#l51.586"></a><span id="l51.586" class="difflineplus">+    this.search = new SearchSpec(this);</span>
<a href="#l51.587"></a><span id="l51.587" class="difflineplus">+    this._sort = this._syntheticView.defaultSort.concat();</span>
<a href="#l51.588"></a><span id="l51.588" class="difflineplus">+</span>
<a href="#l51.589"></a><span id="l51.589" class="difflineplus">+    this._applyViewChanges();</span>
<a href="#l51.590"></a><span id="l51.590" class="difflineplus">+  },</span>
<a href="#l51.591"></a><span id="l51.591" class="difflineplus">+</span>
<a href="#l51.592"></a><span id="l51.592" class="difflineplus">+  /**</span>
<a href="#l51.593"></a><span id="l51.593" class="difflineplus">+   * Makes us irrevocavbly be a search view, for use in search windows.</span>
<a href="#l51.594"></a><span id="l51.594" class="difflineplus">+   *  Once you call this, you are not allowed to use us for anything</span>
<a href="#l51.595"></a><span id="l51.595" class="difflineplus">+   *  but a search view!</span>
<a href="#l51.596"></a><span id="l51.596" class="difflineplus">+   * We add a 'searchFolders' property that allows you to control what</span>
<a href="#l51.597"></a><span id="l51.597" class="difflineplus">+   *  folders we are searching over.</span>
<a href="#l51.598"></a><span id="l51.598" class="difflineplus">+   */</span>
<a href="#l51.599"></a><span id="l51.599" class="difflineplus">+  openSearchView: function DBViewWrapper_openSearchView() {</span>
<a href="#l51.600"></a><span id="l51.600" class="difflineplus">+    this.close();</span>
<a href="#l51.601"></a><span id="l51.601" class="difflineplus">+</span>
<a href="#l51.602"></a><span id="l51.602" class="difflineplus">+    this._underlyingData = this.kUnderlyingSearchView;</span>
<a href="#l51.603"></a><span id="l51.603" class="difflineplus">+    this._underlyingFolders = [];</span>
<a href="#l51.604"></a><span id="l51.604" class="difflineplus">+</span>
<a href="#l51.605"></a><span id="l51.605" class="difflineplus">+    let dis = this;</span>
<a href="#l51.606"></a><span id="l51.606" class="difflineplus">+    this.__defineGetter__('searchFolders', function() {</span>
<a href="#l51.607"></a><span id="l51.607" class="difflineplus">+                            return dis._underlyingFolders;</span>
<a href="#l51.608"></a><span id="l51.608" class="difflineplus">+                          });</span>
<a href="#l51.609"></a><span id="l51.609" class="difflineplus">+    this.__defineSetter__('searchFolders', function(aSearchFolders) {</span>
<a href="#l51.610"></a><span id="l51.610" class="difflineplus">+                            dis._underlyingFolders = aSearchFolders;</span>
<a href="#l51.611"></a><span id="l51.611" class="difflineplus">+                            dis._applyViewChanges();</span>
<a href="#l51.612"></a><span id="l51.612" class="difflineplus">+                          });</span>
<a href="#l51.613"></a><span id="l51.613" class="difflineplus">+</span>
<a href="#l51.614"></a><span id="l51.614" class="difflineplus">+    this.search = new SearchSpec(this);</span>
<a href="#l51.615"></a><span id="l51.615" class="difflineplus">+    // the search view uses the order in which messages are added as the</span>
<a href="#l51.616"></a><span id="l51.616" class="difflineplus">+    //  order by default.</span>
<a href="#l51.617"></a><span id="l51.617" class="difflineplus">+    this._sort = [[nsMsgViewSortType.byNone, nsMsgViewSortOrder.ascending]];</span>
<a href="#l51.618"></a><span id="l51.618" class="difflineplus">+</span>
<a href="#l51.619"></a><span id="l51.619" class="difflineplus">+    this._applyViewChanges();</span>
<a href="#l51.620"></a><span id="l51.620">   },</span>
<a href="#l51.621"></a><span id="l51.621"> </span>
<a href="#l51.622"></a><span id="l51.622">   get folderLoading() {</span>
<a href="#l51.623"></a><span id="l51.623">     return this._folderLoading;</span>
<a href="#l51.624"></a><span id="l51.624">   },</span>
<a href="#l51.625"></a><span id="l51.625">   set folderLoading(aFolderLoading) {</span>
<a href="#l51.626"></a><span id="l51.626">     if (this._folderLoading == aFolderLoading)</span>
<a href="#l51.627"></a><span id="l51.627">       return;</span>
<a href="#l51.628"></a><span id="l51.628">     this._folderLoading = aFolderLoading;</span>
<a href="#l51.629"></a><span id="l51.629" class="difflineplus">+    // tell the folder about what is going on so it can remove its db change</span>
<a href="#l51.630"></a><span id="l51.630" class="difflineplus">+    //  listener and restore it, respectively.</span>
<a href="#l51.631"></a><span id="l51.631" class="difflineplus">+    if (aFolderLoading)</span>
<a href="#l51.632"></a><span id="l51.632" class="difflineplus">+      this.displayedFolder.startFolderLoading();</span>
<a href="#l51.633"></a><span id="l51.633" class="difflineplus">+    else</span>
<a href="#l51.634"></a><span id="l51.634" class="difflineplus">+      this.displayedFolder.endFolderLoading();</span>
<a href="#l51.635"></a><span id="l51.635">     this.listener.onFolderLoading(aFolderLoading);</span>
<a href="#l51.636"></a><span id="l51.636">   },</span>
<a href="#l51.637"></a><span id="l51.637"> </span>
<a href="#l51.638"></a><span id="l51.638">   get searching() {</span>
<a href="#l51.639"></a><span id="l51.639">     return this._searching;</span>
<a href="#l51.640"></a><span id="l51.640">   },</span>
<a href="#l51.641"></a><span id="l51.641">   set searching(aSearching) {</span>
<a href="#l51.642"></a><span id="l51.642">     if (aSearching == this._searching)</span>
<a href="#l51.643"></a><span id="l51.643" class="difflineat">@@ -692,17 +953,18 @@ DBViewWrapper.prototype = {</span>
<a href="#l51.644"></a><span id="l51.644">   /**</span>
<a href="#l51.645"></a><span id="l51.645">    * Creates a view appropriate to the current settings of the folder display</span>
<a href="#l51.646"></a><span id="l51.646">    *  widget, returning it.  The caller is responsible to assign the result to</span>
<a href="#l51.647"></a><span id="l51.647">    *  this.dbView (or whatever it wants to do with it.)</span>
<a href="#l51.648"></a><span id="l51.648">    */</span>
<a href="#l51.649"></a><span id="l51.649">   _createView: function DBViewWrapper__createView() {</span>
<a href="#l51.650"></a><span id="l51.650">     let dbviewContractId = &quot;@mozilla.org/messenger/msgdbview;1?type=&quot;;</span>
<a href="#l51.651"></a><span id="l51.651"> </span>
<a href="#l51.652"></a><span id="l51.652" class="difflineminus">-    let viewFlags = this._viewFlags;</span>
<a href="#l51.653"></a><span id="l51.653" class="difflineplus">+    // we will have saved these off when closing our view</span>
<a href="#l51.654"></a><span id="l51.654" class="difflineplus">+    let viewFlags = this.__viewFlags || 0;</span>
<a href="#l51.655"></a><span id="l51.655"> </span>
<a href="#l51.656"></a><span id="l51.656">     // real folders are subject to the most interest set of possibilities...</span>
<a href="#l51.657"></a><span id="l51.657">     if (this._underlyingData == this.kUnderlyingRealFolder) {</span>
<a href="#l51.658"></a><span id="l51.658">       // quick-search inherits from threaded which inherits from group, so this</span>
<a href="#l51.659"></a><span id="l51.659">       //  is right to choose it first.</span>
<a href="#l51.660"></a><span id="l51.660">       if (this.search.hasSearchTerms)</span>
<a href="#l51.661"></a><span id="l51.661">         dbviewContractId += &quot;quicksearch&quot;;</span>
<a href="#l51.662"></a><span id="l51.662">       else if (this.showGroupedBySort)</span>
<a href="#l51.663"></a><span id="l51.663" class="difflineat">@@ -713,66 +975,80 @@ DBViewWrapper.prototype = {</span>
<a href="#l51.664"></a><span id="l51.664">         dbviewContractId += &quot;watchedthreadswithunread&quot;;</span>
<a href="#l51.665"></a><span id="l51.665">       else</span>
<a href="#l51.666"></a><span id="l51.666">         dbviewContractId += &quot;threaded&quot;;</span>
<a href="#l51.667"></a><span id="l51.667">     }</span>
<a href="#l51.668"></a><span id="l51.668">     // if we're dealing with virtual folders, the answer is always an xfvf</span>
<a href="#l51.669"></a><span id="l51.669">     else if (this._underlyingData == this.kUnderlyingMultipleFolder) {</span>
<a href="#l51.670"></a><span id="l51.670">       dbviewContractId += &quot;xfvf&quot;;</span>
<a href="#l51.671"></a><span id="l51.671">     }</span>
<a href="#l51.672"></a><span id="l51.672" class="difflineminus">-    else if (this._underlyingData == this.kUnderlyingSynthetic) {</span>
<a href="#l51.673"></a><span id="l51.673" class="difflineplus">+    else { // kUnderlyingSynthetic or kUnderlyingSearchView</span>
<a href="#l51.674"></a><span id="l51.674">       dbviewContractId += &quot;search&quot;;</span>
<a href="#l51.675"></a><span id="l51.675">     }</span>
<a href="#l51.676"></a><span id="l51.676"> </span>
<a href="#l51.677"></a><span id="l51.677" class="difflineplus">+    // and now zero the saved-off flags.</span>
<a href="#l51.678"></a><span id="l51.678" class="difflineplus">+    this.__viewFlags = null;</span>
<a href="#l51.679"></a><span id="l51.679" class="difflineplus">+</span>
<a href="#l51.680"></a><span id="l51.680">     let dbView = Cc[dbviewContractId]</span>
<a href="#l51.681"></a><span id="l51.681">                    .createInstance(Ci.nsIMsgDBView);</span>
<a href="#l51.682"></a><span id="l51.682">     dbView.init(this.listener.messenger, this.listener.msgWindow,</span>
<a href="#l51.683"></a><span id="l51.683">                 this.listener.threadPaneCommandUpdater);</span>
<a href="#l51.684"></a><span id="l51.684">     // use the least-specific sort so we can clock them back through to build up</span>
<a href="#l51.685"></a><span id="l51.685">     //  the correct sort order...</span>
<a href="#l51.686"></a><span id="l51.686" class="difflineminus">-    let [sortType, sortOrder] = this._sort[this._sort.length-1];</span>
<a href="#l51.687"></a><span id="l51.687" class="difflineplus">+    let [sortType, sortOrder, sortCustomCol] =</span>
<a href="#l51.688"></a><span id="l51.688" class="difflineplus">+      this._getSortDetails(this._sort.length-1);</span>
<a href="#l51.689"></a><span id="l51.689">     let outCount = {};</span>
<a href="#l51.690"></a><span id="l51.690">     // when the underlying folder is a single real folder (virtual or no), we</span>
<a href="#l51.691"></a><span id="l51.691">     //  tell the view about the underlying folder.</span>
<a href="#l51.692"></a><span id="l51.692">     if (this.isSingleFolder) {</span>
<a href="#l51.693"></a><span id="l51.693">       dbView.open(this._underlyingFolders[0], sortType, sortOrder, viewFlags,</span>
<a href="#l51.694"></a><span id="l51.694">                   outCount);</span>
<a href="#l51.695"></a><span id="l51.695">       // but if it's a virtual folder, we need to tell the db view about the</span>
<a href="#l51.696"></a><span id="l51.696">       //  the display (virtual) folder so it can store all the view-specific</span>
<a href="#l51.697"></a><span id="l51.697">       //  data there (things like the active mail view and such that go in</span>
<a href="#l51.698"></a><span id="l51.698">       //  dbFolderInfo.)</span>
<a href="#l51.699"></a><span id="l51.699">       if (this.isVirtual)</span>
<a href="#l51.700"></a><span id="l51.700">         dbView.viewFolder = this.displayedFolder;</span>
<a href="#l51.701"></a><span id="l51.701">     }</span>
<a href="#l51.702"></a><span id="l51.702">     // when we're dealing with a multi-folder virtual folder, we just tell the</span>
<a href="#l51.703"></a><span id="l51.703">     //  db view about the display folder.  (It gets its own XFVF view, so it</span>
<a href="#l51.704"></a><span id="l51.704">     //  knows what to do.)</span>
<a href="#l51.705"></a><span id="l51.705" class="difflineplus">+    // and for a synthetic folder, displayedFolder is null anyways</span>
<a href="#l51.706"></a><span id="l51.706">     else {</span>
<a href="#l51.707"></a><span id="l51.707">       dbView.open(this.displayedFolder, sortType, sortOrder, viewFlags,</span>
<a href="#l51.708"></a><span id="l51.708">                   outCount);</span>
<a href="#l51.709"></a><span id="l51.709">     }</span>
<a href="#l51.710"></a><span id="l51.710" class="difflineplus">+    if (sortCustomCol)</span>
<a href="#l51.711"></a><span id="l51.711" class="difflineplus">+      dbView.curCustomColumn = sortCustomCol;</span>
<a href="#l51.712"></a><span id="l51.712" class="difflineplus">+</span>
<a href="#l51.713"></a><span id="l51.713" class="difflineplus">+    // we all know it's a tree view, make sure the interface is available</span>
<a href="#l51.714"></a><span id="l51.714" class="difflineplus">+    //  so no one else has to do this.</span>
<a href="#l51.715"></a><span id="l51.715" class="difflineplus">+    dbView.QueryInterface(Ci.nsITreeView);</span>
<a href="#l51.716"></a><span id="l51.716"> </span>
<a href="#l51.717"></a><span id="l51.717">     // clock through the rest of the sorts, if there are any</span>
<a href="#l51.718"></a><span id="l51.718">     for (let iSort = this._sort.length - 2; iSort &gt;=0; iSort--) {</span>
<a href="#l51.719"></a><span id="l51.719" class="difflineminus">-      [sortType, sortOrder] = this._sort[iSort];</span>
<a href="#l51.720"></a><span id="l51.720" class="difflineplus">+      [sortType, sortOrder, sortCustomCol] = this._getSortDetails(iSort);</span>
<a href="#l51.721"></a><span id="l51.721" class="difflineplus">+      if (sortCustomCol)</span>
<a href="#l51.722"></a><span id="l51.722" class="difflineplus">+        dbView.curCustomColumn = sortCustomCol;</span>
<a href="#l51.723"></a><span id="l51.723">       dbView.sort(sortType, sortOrder);</span>
<a href="#l51.724"></a><span id="l51.724">     }</span>
<a href="#l51.725"></a><span id="l51.725"> </span>
<a href="#l51.726"></a><span id="l51.726">     return dbView;</span>
<a href="#l51.727"></a><span id="l51.727">   },</span>
<a href="#l51.728"></a><span id="l51.728"> </span>
<a href="#l51.729"></a><span id="l51.729">   /**</span>
<a href="#l51.730"></a><span id="l51.730">    * Callback method invoked by FolderNotificationHelper when our folder is</span>
<a href="#l51.731"></a><span id="l51.731">    *  loaded.  Assuming we are still interested in the folder, we enter the</span>
<a href="#l51.732"></a><span id="l51.732">    *  folder via _enterFolder.</span>
<a href="#l51.733"></a><span id="l51.733">    */</span>
<a href="#l51.734"></a><span id="l51.734">   _folderLoaded: function DBViewWrapper__folderLoaded(aFolder) {</span>
<a href="#l51.735"></a><span id="l51.735">     if (aFolder == this.displayedFolder) {</span>
<a href="#l51.736"></a><span id="l51.736">       this.folderLoading = false;</span>
<a href="#l51.737"></a><span id="l51.737">       this._enterFolder();</span>
<a href="#l51.738"></a><span id="l51.738" class="difflineplus">+      this.listener.onAllMessagesLoaded();</span>
<a href="#l51.739"></a><span id="l51.739">     }</span>
<a href="#l51.740"></a><span id="l51.740">   },</span>
<a href="#l51.741"></a><span id="l51.741"> </span>
<a href="#l51.742"></a><span id="l51.742">   /**</span>
<a href="#l51.743"></a><span id="l51.743">    * Enter this.displayedFolder if we have not yet entered it.</span>
<a href="#l51.744"></a><span id="l51.744">    *</span>
<a href="#l51.745"></a><span id="l51.745">    * Things we do on entering a folder:</span>
<a href="#l51.746"></a><span id="l51.746">    * - clear the folder's biffState!</span>
<a href="#l51.747"></a><span id="l51.747" class="difflineat">@@ -780,19 +1056,19 @@ DBViewWrapper.prototype = {</span>
<a href="#l51.748"></a><span id="l51.748">    */</span>
<a href="#l51.749"></a><span id="l51.749">   _enterFolder: function DBViewWrapper__enterFolder() {</span>
<a href="#l51.750"></a><span id="l51.750">     if (this._enteredFolder)</span>
<a href="#l51.751"></a><span id="l51.751">       return;</span>
<a href="#l51.752"></a><span id="l51.752"> </span>
<a href="#l51.753"></a><span id="l51.753">     this.displayedFolder.biffState =</span>
<a href="#l51.754"></a><span id="l51.754">       Ci.nsIMsgFolder.nsMsgBiffState_NoMail;</span>
<a href="#l51.755"></a><span id="l51.755"> </span>
<a href="#l51.756"></a><span id="l51.756" class="difflineminus">-    this.listener.onDisplayingFolder();</span>
<a href="#l51.757"></a><span id="l51.757" class="difflineplus">+    this.endViewUpdate();</span>
<a href="#l51.758"></a><span id="l51.758"> </span>
<a href="#l51.759"></a><span id="l51.759" class="difflineminus">-    this.endViewUpdate();</span>
<a href="#l51.760"></a><span id="l51.760" class="difflineplus">+    this.listener.onDisplayingFolder();</span>
<a href="#l51.761"></a><span id="l51.761"> </span>
<a href="#l51.762"></a><span id="l51.762">     this._enteredFolder = true;</span>
<a href="#l51.763"></a><span id="l51.763">   },</span>
<a href="#l51.764"></a><span id="l51.764"> </span>
<a href="#l51.765"></a><span id="l51.765">   /**</span>
<a href="#l51.766"></a><span id="l51.766">    * Renames, moves to the trash, it's all crazy.  We have to update all our</span>
<a href="#l51.767"></a><span id="l51.767">    *  references when this happens.</span>
<a href="#l51.768"></a><span id="l51.768">    */</span>
<a href="#l51.769"></a><span id="l51.769" class="difflineat">@@ -842,47 +1118,174 @@ DBViewWrapper.prototype = {</span>
<a href="#l51.770"></a><span id="l51.770">       return;</span>
<a href="#l51.771"></a><span id="l51.771">     }</span>
<a href="#l51.772"></a><span id="l51.772">     // if we are virtual, this will update the search session which draws its</span>
<a href="#l51.773"></a><span id="l51.773">     //  search scopes from this._underlyingFolders anyways.</span>
<a href="#l51.774"></a><span id="l51.774">     this._applyViewChanges();</span>
<a href="#l51.775"></a><span id="l51.775">   },</span>
<a href="#l51.776"></a><span id="l51.776"> </span>
<a href="#l51.777"></a><span id="l51.777">   /**</span>
<a href="#l51.778"></a><span id="l51.778" class="difflineplus">+   * Compacting a local folder nukes its message keys, requiring the view to be</span>
<a href="#l51.779"></a><span id="l51.779" class="difflineplus">+   *  rebuilt.  If the folder is IMAP, it doesn't matter because the UIDs are</span>
<a href="#l51.780"></a><span id="l51.780" class="difflineplus">+   *  the message keys and we can ignore it.  In the local case we want to</span>
<a href="#l51.781"></a><span id="l51.781" class="difflineplus">+   *  notify our listener so they have a chance to save the selected messages.</span>
<a href="#l51.782"></a><span id="l51.782" class="difflineplus">+   */</span>
<a href="#l51.783"></a><span id="l51.783" class="difflineplus">+  _aboutToCompactFolder: function DBViewWrapper__aboutToCompactFolder(aFolder) {</span>
<a href="#l51.784"></a><span id="l51.784" class="difflineplus">+    // IMAP compaction does not affect us unless we are holding headers</span>
<a href="#l51.785"></a><span id="l51.785" class="difflineplus">+    if (aFolder.server.type == &quot;imap&quot;)</span>
<a href="#l51.786"></a><span id="l51.786" class="difflineplus">+      return;</span>
<a href="#l51.787"></a><span id="l51.787" class="difflineplus">+</span>
<a href="#l51.788"></a><span id="l51.788" class="difflineplus">+    // we will have to re-create the view, so nuke the view now.</span>
<a href="#l51.789"></a><span id="l51.789" class="difflineplus">+    if (this.dbView) {</span>
<a href="#l51.790"></a><span id="l51.790" class="difflineplus">+      this.listener.onDestroyingView(true);</span>
<a href="#l51.791"></a><span id="l51.791" class="difflineplus">+      this.search.dissociateView(this.dbView);</span>
<a href="#l51.792"></a><span id="l51.792" class="difflineplus">+      this.dbView.close();</span>
<a href="#l51.793"></a><span id="l51.793" class="difflineplus">+      this.dbView = null;</span>
<a href="#l51.794"></a><span id="l51.794" class="difflineplus">+    }</span>
<a href="#l51.795"></a><span id="l51.795" class="difflineplus">+  },</span>
<a href="#l51.796"></a><span id="l51.796" class="difflineplus">+</span>
<a href="#l51.797"></a><span id="l51.797" class="difflineplus">+  /**</span>
<a href="#l51.798"></a><span id="l51.798" class="difflineplus">+   * Compaction is all done, let's re-create the view!  (Unless the folder is</span>
<a href="#l51.799"></a><span id="l51.799" class="difflineplus">+   *  IMAP, in which case we are ignoring this event sequence.)</span>
<a href="#l51.800"></a><span id="l51.800" class="difflineplus">+   */</span>
<a href="#l51.801"></a><span id="l51.801" class="difflineplus">+  _compactedFolder: function DBViewWrapper__compactedFolder(aFolder) {</span>
<a href="#l51.802"></a><span id="l51.802" class="difflineplus">+    // IMAP compaction does not affect us unless we are holding headers</span>
<a href="#l51.803"></a><span id="l51.803" class="difflineplus">+    if (aFolder.server.type == &quot;imap&quot;)</span>
<a href="#l51.804"></a><span id="l51.804" class="difflineplus">+      return;</span>
<a href="#l51.805"></a><span id="l51.805" class="difflineplus">+</span>
<a href="#l51.806"></a><span id="l51.806" class="difflineplus">+    this.refresh();</span>
<a href="#l51.807"></a><span id="l51.807" class="difflineplus">+  },</span>
<a href="#l51.808"></a><span id="l51.808" class="difflineplus">+</span>
<a href="#l51.809"></a><span id="l51.809" class="difflineplus">+  /**</span>
<a href="#l51.810"></a><span id="l51.810" class="difflineplus">+   * DB Views need help to know when their move / deletion operations complete.</span>
<a href="#l51.811"></a><span id="l51.811" class="difflineplus">+   *  This happens in both single-folder and multiple-folder backed searches.</span>
<a href="#l51.812"></a><span id="l51.812" class="difflineplus">+   *  In the latter case, there is potential danger that we tell a view that did</span>
<a href="#l51.813"></a><span id="l51.813" class="difflineplus">+   *  not initiate the move / deletion but has kicked off its own about the</span>
<a href="#l51.814"></a><span id="l51.814" class="difflineplus">+   *  completion and confuse it.  However, that's on the view code.</span>
<a href="#l51.815"></a><span id="l51.815" class="difflineplus">+   */</span>
<a href="#l51.816"></a><span id="l51.816" class="difflineplus">+  _deleteCompleted: function DBViewWrapper__deleteCompleted(aFolder) {</span>
<a href="#l51.817"></a><span id="l51.817" class="difflineplus">+    if (this.dbView)</span>
<a href="#l51.818"></a><span id="l51.818" class="difflineplus">+      this.dbView.onDeleteCompleted(true);</span>
<a href="#l51.819"></a><span id="l51.819" class="difflineplus">+    this.listener.onMessagesRemoved();</span>
<a href="#l51.820"></a><span id="l51.820" class="difflineplus">+  },</span>
<a href="#l51.821"></a><span id="l51.821" class="difflineplus">+</span>
<a href="#l51.822"></a><span id="l51.822" class="difflineplus">+  /**</span>
<a href="#l51.823"></a><span id="l51.823" class="difflineplus">+   * See _deleteCompleted for an explanation of what is going on.</span>
<a href="#l51.824"></a><span id="l51.824" class="difflineplus">+   */</span>
<a href="#l51.825"></a><span id="l51.825" class="difflineplus">+  _deleteFailed: function DBViewWrapper__deleteFailed(aFolder) {</span>
<a href="#l51.826"></a><span id="l51.826" class="difflineplus">+    if (this.dbView)</span>
<a href="#l51.827"></a><span id="l51.827" class="difflineplus">+      this.dbView.onDeleteCompleted(false);</span>
<a href="#l51.828"></a><span id="l51.828" class="difflineplus">+    this.listener.onMessageRemovalFailed();</span>
<a href="#l51.829"></a><span id="l51.829" class="difflineplus">+  },</span>
<a href="#l51.830"></a><span id="l51.830" class="difflineplus">+</span>
<a href="#l51.831"></a><span id="l51.831" class="difflineplus">+  /**</span>
<a href="#l51.832"></a><span id="l51.832" class="difflineplus">+   * If the displayed folder had its total message count or total unread message</span>
<a href="#l51.833"></a><span id="l51.833" class="difflineplus">+   *  count change, notify the listener.  (Note: only for the display folder;</span>
<a href="#l51.834"></a><span id="l51.834" class="difflineplus">+   *  not the underlying folders!)</span>
<a href="#l51.835"></a><span id="l51.835" class="difflineplus">+   */</span>
<a href="#l51.836"></a><span id="l51.836" class="difflineplus">+  _messageCountsChanged: function DBViewWrapper__messageCountsChanged(aFolder) {</span>
<a href="#l51.837"></a><span id="l51.837" class="difflineplus">+    if (aFolder == this.displayedFolder)</span>
<a href="#l51.838"></a><span id="l51.838" class="difflineplus">+      this.listener.onMessageCountsChanged();</span>
<a href="#l51.839"></a><span id="l51.839" class="difflineplus">+  },</span>
<a href="#l51.840"></a><span id="l51.840" class="difflineplus">+</span>
<a href="#l51.841"></a><span id="l51.841" class="difflineplus">+  /**</span>
<a href="#l51.842"></a><span id="l51.842" class="difflineplus">+   * @return the current set of viewFlags.  This may be:</span>
<a href="#l51.843"></a><span id="l51.843" class="difflineplus">+   * - A modified set of flags that are pending application because a view</span>
<a href="#l51.844"></a><span id="l51.844" class="difflineplus">+   *    update is in effect and we don't want to modify the view when it's just</span>
<a href="#l51.845"></a><span id="l51.845" class="difflineplus">+   *    going to get destroyed.</span>
<a href="#l51.846"></a><span id="l51.846" class="difflineplus">+   * - The live set of flags from the current dbView.</span>
<a href="#l51.847"></a><span id="l51.847" class="difflineplus">+   * - The 'limbo' set of flags because we currently lack a view but will have</span>
<a href="#l51.848"></a><span id="l51.848" class="difflineplus">+   *    one soon (and then we will apply the flags).</span>
<a href="#l51.849"></a><span id="l51.849" class="difflineplus">+   */</span>
<a href="#l51.850"></a><span id="l51.850" class="difflineplus">+  get _viewFlags DBViewWrapper_get__viewFlags() {</span>
<a href="#l51.851"></a><span id="l51.851" class="difflineplus">+    if (this.__viewFlags != null)</span>
<a href="#l51.852"></a><span id="l51.852" class="difflineplus">+      return this.__viewFlags;</span>
<a href="#l51.853"></a><span id="l51.853" class="difflineplus">+    if (this.dbView)</span>
<a href="#l51.854"></a><span id="l51.854" class="difflineplus">+      return this.dbView.viewFlags;</span>
<a href="#l51.855"></a><span id="l51.855" class="difflineplus">+    return 0;</span>
<a href="#l51.856"></a><span id="l51.856" class="difflineplus">+  },</span>
<a href="#l51.857"></a><span id="l51.857" class="difflineplus">+  /**</span>
<a href="#l51.858"></a><span id="l51.858" class="difflineplus">+   * Update the view flags to use on the view.  If we are in a view update or</span>
<a href="#l51.859"></a><span id="l51.859" class="difflineplus">+   *  currently don't have a view, we save the view flags for later usage when</span>
<a href="#l51.860"></a><span id="l51.860" class="difflineplus">+   *  the view gets (re)built.  If we have a view, depending on what's happening</span>
<a href="#l51.861"></a><span id="l51.861" class="difflineplus">+   *  we may re-create the view or just set the bits.  The rules/reasons are:</span>
<a href="#l51.862"></a><span id="l51.862" class="difflineplus">+   * - XFVF views can handle the flag changes, just set the flags.</span>
<a href="#l51.863"></a><span id="l51.863" class="difflineplus">+   * - Single-folder threaded/unthreaded can handle a change to/from unthreaded/</span>
<a href="#l51.864"></a><span id="l51.864" class="difflineplus">+   *    threaded, so set it.</span>
<a href="#l51.865"></a><span id="l51.865" class="difflineplus">+   * - Single-folder can _not_ handle a change between grouped and not-grouped,</span>
<a href="#l51.866"></a><span id="l51.866" class="difflineplus">+   *    so re-generate the view.</span>
<a href="#l51.867"></a><span id="l51.867" class="difflineplus">+   */</span>
<a href="#l51.868"></a><span id="l51.868" class="difflineplus">+  set _viewFlags DBViewWrapper_set__viewFlags(aViewFlags) {</span>
<a href="#l51.869"></a><span id="l51.869" class="difflineplus">+    if (this._viewUpdateDepth || !this.dbView)</span>
<a href="#l51.870"></a><span id="l51.870" class="difflineplus">+      this.__viewFlags = aViewFlags;</span>
<a href="#l51.871"></a><span id="l51.871" class="difflineplus">+    else {</span>
<a href="#l51.872"></a><span id="l51.872" class="difflineplus">+      let oldFlags = this.dbView.viewFlags;</span>
<a href="#l51.873"></a><span id="l51.873" class="difflineplus">+      let changedFlags = oldFlags ^ aViewFlags;</span>
<a href="#l51.874"></a><span id="l51.874" class="difflineplus">+      if ((this.isVirtual &amp;&amp; this.isMultiFolder) ||</span>
<a href="#l51.875"></a><span id="l51.875" class="difflineplus">+          (this.isSingleFolder &amp;&amp;</span>
<a href="#l51.876"></a><span id="l51.876" class="difflineplus">+           !(changedFlags &amp; nsMsgViewFlagsType.kGroupBySort))) {</span>
<a href="#l51.877"></a><span id="l51.877" class="difflineplus">+        this.dbView.viewFlags = aViewFlags;</span>
<a href="#l51.878"></a><span id="l51.878" class="difflineplus">+        // ugh, and the single folder case needs us to re-apply his sort...</span>
<a href="#l51.879"></a><span id="l51.879" class="difflineplus">+        if (this.isSingleFolder)</span>
<a href="#l51.880"></a><span id="l51.880" class="difflineplus">+          this.dbView.sort(this.dbView.sortType, this.dbView.sortOrder);</span>
<a href="#l51.881"></a><span id="l51.881" class="difflineplus">+        this.listener.onSortChanged();</span>
<a href="#l51.882"></a><span id="l51.882" class="difflineplus">+      }</span>
<a href="#l51.883"></a><span id="l51.883" class="difflineplus">+      else {</span>
<a href="#l51.884"></a><span id="l51.884" class="difflineplus">+        this.__viewFlags = aViewFlags;</span>
<a href="#l51.885"></a><span id="l51.885" class="difflineplus">+        this._applyViewChanges();</span>
<a href="#l51.886"></a><span id="l51.886" class="difflineplus">+      }</span>
<a href="#l51.887"></a><span id="l51.887" class="difflineplus">+    }</span>
<a href="#l51.888"></a><span id="l51.888" class="difflineplus">+  },</span>
<a href="#l51.889"></a><span id="l51.889" class="difflineplus">+</span>
<a href="#l51.890"></a><span id="l51.890" class="difflineplus">+  /**</span>
<a href="#l51.891"></a><span id="l51.891">    * Apply accumulated changes to the view.  If we are in a batch, we do</span>
<a href="#l51.892"></a><span id="l51.892">    *  nothing, relying on endDisplayUpdate to call us.</span>
<a href="#l51.893"></a><span id="l51.893">    */</span>
<a href="#l51.894"></a><span id="l51.894">   _applyViewChanges: function DBViewWrapper__applyViewChanges() {</span>
<a href="#l51.895"></a><span id="l51.895">     // if we are in a batch, wait for endDisplayUpdate to be called to get us</span>
<a href="#l51.896"></a><span id="l51.896">     //  out to zero.</span>
<a href="#l51.897"></a><span id="l51.897">     if (this._viewUpdateDepth)</span>
<a href="#l51.898"></a><span id="l51.898">       return;</span>
<a href="#l51.899"></a><span id="l51.899">     // make the dbView stop being a search listener if it is one</span>
<a href="#l51.900"></a><span id="l51.900">     if (this.dbView) {</span>
<a href="#l51.901"></a><span id="l51.901" class="difflineplus">+      // save the view's flags if it has any and we haven't already overridden</span>
<a href="#l51.902"></a><span id="l51.902" class="difflineplus">+      //  them.</span>
<a href="#l51.903"></a><span id="l51.903" class="difflineplus">+      if (this.__viewFlags == null)</span>
<a href="#l51.904"></a><span id="l51.904" class="difflineplus">+        this.__viewFlags = this.dbView.viewFlags;</span>
<a href="#l51.905"></a><span id="l51.905" class="difflineplus">+      this.listener.onDestroyingView(true); // we will re-create it!</span>
<a href="#l51.906"></a><span id="l51.906">       this.search.dissociateView(this.dbView);</span>
<a href="#l51.907"></a><span id="l51.907">       this.dbView.close();</span>
<a href="#l51.908"></a><span id="l51.908" class="difflineplus">+      this.dbView = null;</span>
<a href="#l51.909"></a><span id="l51.909">     }</span>
<a href="#l51.910"></a><span id="l51.910"> </span>
<a href="#l51.911"></a><span id="l51.911">     this.dbView = this._createView();</span>
<a href="#l51.912"></a><span id="l51.912" class="difflineplus">+    // if the synthetic view defines columns, add those for it</span>
<a href="#l51.913"></a><span id="l51.913" class="difflineplus">+    if (this.isSynthetic) {</span>
<a href="#l51.914"></a><span id="l51.914" class="difflineplus">+      for (let [, customCol] in Iterator(this._syntheticView.customColumns)) {</span>
<a href="#l51.915"></a><span id="l51.915" class="difflineplus">+        customCol.bindToView(this.dbView);</span>
<a href="#l51.916"></a><span id="l51.916" class="difflineplus">+        this.dbView.addColumnHandler(customCol.id, customCol);</span>
<a href="#l51.917"></a><span id="l51.917" class="difflineplus">+      }</span>
<a href="#l51.918"></a><span id="l51.918" class="difflineplus">+    }</span>
<a href="#l51.919"></a><span id="l51.919">     this.listener.onCreatedView();</span>
<a href="#l51.920"></a><span id="l51.920"> </span>
<a href="#l51.921"></a><span id="l51.921">     // this ends up being a no-op if there are no search terms</span>
<a href="#l51.922"></a><span id="l51.922">     this.search.associateView(this.dbView);</span>
<a href="#l51.923"></a><span id="l51.923"> </span>
<a href="#l51.924"></a><span id="l51.924">     // If we are searching, then the search will generate the all messages</span>
<a href="#l51.925"></a><span id="l51.925">     //  loaded notification.  Although in some cases the search may have</span>
<a href="#l51.926"></a><span id="l51.926">     //  completed by now, that is not a guarantee.  The search logic is</span>
<a href="#l51.927"></a><span id="l51.927">     //  time-slicing, which is why this can vary.  (If it uses up its time</span>
<a href="#l51.928"></a><span id="l51.928">     //  slices, it will re-schedule itself, returning to us before completing.)</span>
<a href="#l51.929"></a><span id="l51.929">     //  Which is why we always defer to the search if one is active.</span>
<a href="#l51.930"></a><span id="l51.930" class="difflineminus">-    if (!this.searching)</span>
<a href="#l51.931"></a><span id="l51.931" class="difflineplus">+    // If we are loading the folder, the load completion will also notify us,</span>
<a href="#l51.932"></a><span id="l51.932" class="difflineplus">+    //  so we should not generate all messages loaded right now.</span>
<a href="#l51.933"></a><span id="l51.933" class="difflineplus">+    if (!this.searching &amp;&amp; !this.folderLoading)</span>
<a href="#l51.934"></a><span id="l51.934">       this.listener.onAllMessagesLoaded();</span>
<a href="#l51.935"></a><span id="l51.935">   },</span>
<a href="#l51.936"></a><span id="l51.936"> </span>
<a href="#l51.937"></a><span id="l51.937" class="difflineminus">-</span>
<a href="#l51.938"></a><span id="l51.938">   /**</span>
<a href="#l51.939"></a><span id="l51.939">    * Check if the folder or (optionally) one of its ancestors has any one of the</span>
<a href="#l51.940"></a><span id="l51.940">    *  provided flags set.</span>
<a href="#l51.941"></a><span id="l51.941">    *</span>
<a href="#l51.942"></a><span id="l51.942">    * In the event there is a folder with both the SentMail and Inbox flags set,</span>
<a href="#l51.943"></a><span id="l51.943">    *  it will be treated as an Inbox, and not as a SentMail folder.</span>
<a href="#l51.944"></a><span id="l51.944">    *</span>
<a href="#l51.945"></a><span id="l51.945">    * @param {nsIMsgFolder} aMsgFolder The folder whose flags you want to check.</span>
<a href="#l51.946"></a><span id="l51.946" class="difflineat">@@ -912,38 +1315,48 @@ DBViewWrapper.prototype = {</span>
<a href="#l51.947"></a><span id="l51.947">       // and not a SENT folder</span>
<a href="#l51.948"></a><span id="l51.948">       const nsMsgFolderFlags = Ci.nsMsgFolderFlags;</span>
<a href="#l51.949"></a><span id="l51.949">       return !((aFlags &amp; nsMsgFolderFlags.SentMail) &amp;&amp;</span>
<a href="#l51.950"></a><span id="l51.950">                (aMsgFolder.flags &amp; nsMsgFolderFlags.Inbox));</span>
<a href="#l51.951"></a><span id="l51.951">     }</span>
<a href="#l51.952"></a><span id="l51.952">   },</span>
<a href="#l51.953"></a><span id="l51.953"> </span>
<a href="#l51.954"></a><span id="l51.954"> </span>
<a href="#l51.955"></a><span id="l51.955" class="difflineplus">+  get isMailFolder() {</span>
<a href="#l51.956"></a><span id="l51.956" class="difflineplus">+    return this.displayedFolder &amp;&amp;</span>
<a href="#l51.957"></a><span id="l51.957" class="difflineplus">+           (this.displayedFolder.flags &amp; nsMsgFolderFlags.Mail);</span>
<a href="#l51.958"></a><span id="l51.958" class="difflineplus">+  },</span>
<a href="#l51.959"></a><span id="l51.959" class="difflineplus">+</span>
<a href="#l51.960"></a><span id="l51.960" class="difflineplus">+  get isNewsFolder() {</span>
<a href="#l51.961"></a><span id="l51.961" class="difflineplus">+    return this.displayedFolder &amp;&amp;</span>
<a href="#l51.962"></a><span id="l51.962" class="difflineplus">+           (this.displayedFolder.flags &amp; nsMsgFolderFlags.Newsgroup);</span>
<a href="#l51.963"></a><span id="l51.963" class="difflineplus">+  },</span>
<a href="#l51.964"></a><span id="l51.964" class="difflineplus">+</span>
<a href="#l51.965"></a><span id="l51.965">   OUTGOING_FOLDER_FLAGS: nsMsgFolderFlags.SentMail |</span>
<a href="#l51.966"></a><span id="l51.966">                          nsMsgFolderFlags.Drafts |</span>
<a href="#l51.967"></a><span id="l51.967">                          nsMsgFolderFlags.Queue |</span>
<a href="#l51.968"></a><span id="l51.968" class="difflineminus">-                         nsMsgFolderFlags.Template,</span>
<a href="#l51.969"></a><span id="l51.969" class="difflineplus">+                         nsMsgFolderFlags.Templates,</span>
<a href="#l51.970"></a><span id="l51.970">   /**</span>
<a href="#l51.971"></a><span id="l51.971">    * @return true if the folder is not known to be a special outgoing folder</span>
<a href="#l51.972"></a><span id="l51.972">    *     or the descendent of a special outgoing folder.</span>
<a href="#l51.973"></a><span id="l51.973">    */</span>
<a href="#l51.974"></a><span id="l51.974">   get isIncomingFolder() {</span>
<a href="#l51.975"></a><span id="l51.975">     return !this._isSpecialFolder(this.displayedFolder,</span>
<a href="#l51.976"></a><span id="l51.976" class="difflineminus">-                                  this.OUTGOING_FOLDER_FLAGS,</span>
<a href="#l51.977"></a><span id="l51.977" class="difflineminus">-                                  true);</span>
<a href="#l51.978"></a><span id="l51.978" class="difflineplus">+                                 this.OUTGOING_FOLDER_FLAGS,</span>
<a href="#l51.979"></a><span id="l51.979" class="difflineplus">+                                 true);</span>
<a href="#l51.980"></a><span id="l51.980">   },</span>
<a href="#l51.981"></a><span id="l51.981">   /**</span>
<a href="#l51.982"></a><span id="l51.982">    * @return true if the folder is an outgoing folder by virtue of being a</span>
<a href="#l51.983"></a><span id="l51.983">    *     sent mail folder, drafts folder, queue folder, or template folder,</span>
<a href="#l51.984"></a><span id="l51.984">    *     or being a sub-folder of one of those types of folders.</span>
<a href="#l51.985"></a><span id="l51.985">    */</span>
<a href="#l51.986"></a><span id="l51.986">   get isOutgoingFolder() {</span>
<a href="#l51.987"></a><span id="l51.987" class="difflineminus">-    return !this._isSpecialFolder(this.displayedFolder,</span>
<a href="#l51.988"></a><span id="l51.988" class="difflineminus">-                                  this.OUTGOING_FOLDER_FLAGS,</span>
<a href="#l51.989"></a><span id="l51.989" class="difflineminus">-                                  true);</span>
<a href="#l51.990"></a><span id="l51.990" class="difflineplus">+    return this._isSpecialFolder(this.displayedFolder,</span>
<a href="#l51.991"></a><span id="l51.991" class="difflineplus">+                                 this.OUTGOING_FOLDER_FLAGS,</span>
<a href="#l51.992"></a><span id="l51.992" class="difflineplus">+                                 true);</span>
<a href="#l51.993"></a><span id="l51.993">   },</span>
<a href="#l51.994"></a><span id="l51.994"> </span>
<a href="#l51.995"></a><span id="l51.995">   get isVirtual() {</span>
<a href="#l51.996"></a><span id="l51.996">     return Boolean(this.displayedFolder &amp;&amp;</span>
<a href="#l51.997"></a><span id="l51.997">                    (this.displayedFolder.flags &amp; nsMsgFolderFlags.Virtual));</span>
<a href="#l51.998"></a><span id="l51.998">   },</span>
<a href="#l51.999"></a><span id="l51.999"> </span>
<a href="#l51.1000"></a><span id="l51.1000">   beginViewUpdate: function DBViewWrapper_beginViewUpdate() {</span>
<a href="#l51.1001"></a><span id="l51.1001" class="difflineat">@@ -952,113 +1365,287 @@ DBViewWrapper.prototype = {</span>
<a href="#l51.1002"></a><span id="l51.1002"> </span>
<a href="#l51.1003"></a><span id="l51.1003">   endViewUpdate: function DBViewWrapper_endViewUpdate() {</span>
<a href="#l51.1004"></a><span id="l51.1004">     if (--this._viewUpdateDepth == 0) {</span>
<a href="#l51.1005"></a><span id="l51.1005">       this._applyViewChanges();</span>
<a href="#l51.1006"></a><span id="l51.1006">     }</span>
<a href="#l51.1007"></a><span id="l51.1007">   },</span>
<a href="#l51.1008"></a><span id="l51.1008"> </span>
<a href="#l51.1009"></a><span id="l51.1009">   /**</span>
<a href="#l51.1010"></a><span id="l51.1010" class="difflineplus">+   * @return the primary sort type (as one of the numeric constants from</span>
<a href="#l51.1011"></a><span id="l51.1011" class="difflineplus">+   *      nsMsgViewSortType).</span>
<a href="#l51.1012"></a><span id="l51.1012" class="difflineplus">+   */</span>
<a href="#l51.1013"></a><span id="l51.1013" class="difflineplus">+  get primarySortType() {</span>
<a href="#l51.1014"></a><span id="l51.1014" class="difflineplus">+    return this._sort[0][0];</span>
<a href="#l51.1015"></a><span id="l51.1015" class="difflineplus">+  },</span>
<a href="#l51.1016"></a><span id="l51.1016" class="difflineplus">+</span>
<a href="#l51.1017"></a><span id="l51.1017" class="difflineplus">+  /**</span>
<a href="#l51.1018"></a><span id="l51.1018" class="difflineplus">+   * @return the primary sort order (as one of the numeric constants from</span>
<a href="#l51.1019"></a><span id="l51.1019" class="difflineplus">+   *     nsMsgViewSortOrder.)</span>
<a href="#l51.1020"></a><span id="l51.1020" class="difflineplus">+   */</span>
<a href="#l51.1021"></a><span id="l51.1021" class="difflineplus">+  get primarySortOrder() {</span>
<a href="#l51.1022"></a><span id="l51.1022" class="difflineplus">+    return this._sort[0][1];</span>
<a href="#l51.1023"></a><span id="l51.1023" class="difflineplus">+  },</span>
<a href="#l51.1024"></a><span id="l51.1024" class="difflineplus">+</span>
<a href="#l51.1025"></a><span id="l51.1025" class="difflineplus">+  /**</span>
<a href="#l51.1026"></a><span id="l51.1026" class="difflineplus">+   * @return true if the dominant sort is ascending.</span>
<a href="#l51.1027"></a><span id="l51.1027" class="difflineplus">+   */</span>
<a href="#l51.1028"></a><span id="l51.1028" class="difflineplus">+  get isSortedAscending() {</span>
<a href="#l51.1029"></a><span id="l51.1029" class="difflineplus">+    return this._sort.length &amp;&amp;</span>
<a href="#l51.1030"></a><span id="l51.1030" class="difflineplus">+           this._sort[0][1] == nsMsgViewSortOrder.ascending;</span>
<a href="#l51.1031"></a><span id="l51.1031" class="difflineplus">+  },</span>
<a href="#l51.1032"></a><span id="l51.1032" class="difflineplus">+  /**</span>
<a href="#l51.1033"></a><span id="l51.1033" class="difflineplus">+   * @return true if the dominant sort is descending.</span>
<a href="#l51.1034"></a><span id="l51.1034" class="difflineplus">+   */</span>
<a href="#l51.1035"></a><span id="l51.1035" class="difflineplus">+  get isSortedDescending() {</span>
<a href="#l51.1036"></a><span id="l51.1036" class="difflineplus">+    return this._sort.length &amp;&amp;</span>
<a href="#l51.1037"></a><span id="l51.1037" class="difflineplus">+           this._sort[0][1] == nsMsgViewSortOrder.descending;</span>
<a href="#l51.1038"></a><span id="l51.1038" class="difflineplus">+  },</span>
<a href="#l51.1039"></a><span id="l51.1039" class="difflineplus">+  /**</span>
<a href="#l51.1040"></a><span id="l51.1040" class="difflineplus">+   * Indicate if we are sorting by time or something correlated with time.</span>
<a href="#l51.1041"></a><span id="l51.1041" class="difflineplus">+   *</span>
<a href="#l51.1042"></a><span id="l51.1042" class="difflineplus">+   * @return true if the dominant sort is by time.</span>
<a href="#l51.1043"></a><span id="l51.1043" class="difflineplus">+   */</span>
<a href="#l51.1044"></a><span id="l51.1044" class="difflineplus">+  get sortImpliesTemporalOrdering() {</span>
<a href="#l51.1045"></a><span id="l51.1045" class="difflineplus">+    if (!this._sort.length)</span>
<a href="#l51.1046"></a><span id="l51.1046" class="difflineplus">+      return false;</span>
<a href="#l51.1047"></a><span id="l51.1047" class="difflineplus">+    let sortType = this._sort[0][0];</span>
<a href="#l51.1048"></a><span id="l51.1048" class="difflineplus">+    return sortType == nsMsgViewSortType.byDate ||</span>
<a href="#l51.1049"></a><span id="l51.1049" class="difflineplus">+           sortType == nsMsgViewSortType.byReceived ||</span>
<a href="#l51.1050"></a><span id="l51.1050" class="difflineplus">+           sortType == nsMsgViewSortType.byId ||</span>
<a href="#l51.1051"></a><span id="l51.1051" class="difflineplus">+           sortType == nsMsgViewSortType.byThread;</span>
<a href="#l51.1052"></a><span id="l51.1052" class="difflineplus">+  },</span>
<a href="#l51.1053"></a><span id="l51.1053" class="difflineplus">+</span>
<a href="#l51.1054"></a><span id="l51.1054" class="difflineplus">+  sortAscending: function() {</span>
<a href="#l51.1055"></a><span id="l51.1055" class="difflineplus">+    if (!this.isSortedAscending)</span>
<a href="#l51.1056"></a><span id="l51.1056" class="difflineplus">+      this.magicSort(this._sort[0][0], nsMsgViewSortOrder.ascending);</span>
<a href="#l51.1057"></a><span id="l51.1057" class="difflineplus">+  },</span>
<a href="#l51.1058"></a><span id="l51.1058" class="difflineplus">+  sortDescending: function() {</span>
<a href="#l51.1059"></a><span id="l51.1059" class="difflineplus">+    if (!this.isSortedDescending)</span>
<a href="#l51.1060"></a><span id="l51.1060" class="difflineplus">+      this.magicSort(this._sort[0][0], nsMsgViewSortOrder.descending);</span>
<a href="#l51.1061"></a><span id="l51.1061" class="difflineplus">+  },</span>
<a href="#l51.1062"></a><span id="l51.1062" class="difflineplus">+</span>
<a href="#l51.1063"></a><span id="l51.1063" class="difflineplus">+  /**</span>
<a href="#l51.1064"></a><span id="l51.1064">    * Explicit sort command.  We ignore all previous sort state and only apply</span>
<a href="#l51.1065"></a><span id="l51.1065">    *  what you tell us.  If you want implied secondary sort, use |magicSort|.</span>
<a href="#l51.1066"></a><span id="l51.1066">    * You must use this sort command, and never directly call the sort commands</span>
<a href="#l51.1067"></a><span id="l51.1067">    *  on the underlying db view!  If you do not, make sure to fight us every</span>
<a href="#l51.1068"></a><span id="l51.1068">    *   step of the way, because we will keep clobbering your manually applied</span>
<a href="#l51.1069"></a><span id="l51.1069">    *   sort.</span>
<a href="#l51.1070"></a><span id="l51.1070">    */</span>
<a href="#l51.1071"></a><span id="l51.1071">   sort: function DBViewWrapper_sort(aSortType, aSortOrder,</span>
<a href="#l51.1072"></a><span id="l51.1072">                                     aSecondaryType, aSecondaryOrder) {</span>
<a href="#l51.1073"></a><span id="l51.1073">     this._sort = [[aSortType, aSortOrder]];</span>
<a href="#l51.1074"></a><span id="l51.1074">     if (aSecondaryType != null &amp;&amp; aSecondaryOrder != null)</span>
<a href="#l51.1075"></a><span id="l51.1075">       this._sort.push([aSecondaryType, aSecondaryOrder]);</span>
<a href="#l51.1076"></a><span id="l51.1076" class="difflineplus">+    // make sure the sort won't make the view angry...</span>
<a href="#l51.1077"></a><span id="l51.1077" class="difflineplus">+    this._ensureValidSort();</span>
<a href="#l51.1078"></a><span id="l51.1078">     // if we are not in a view update, invoke the sort.</span>
<a href="#l51.1079"></a><span id="l51.1079">     if ((this._viewUpdateDepth == 0) &amp;&amp; this.dbView) {</span>
<a href="#l51.1080"></a><span id="l51.1080">       for (let iSort = this._sort.length - 1; iSort &gt;=0; iSort--) {</span>
<a href="#l51.1081"></a><span id="l51.1081">         // apply them in the reverse order</span>
<a href="#l51.1082"></a><span id="l51.1082">         let [sortType, sortOrder] = this._sort[iSort];</span>
<a href="#l51.1083"></a><span id="l51.1083">         this.dbView.sort(sortType, sortOrder);</span>
<a href="#l51.1084"></a><span id="l51.1084">       }</span>
<a href="#l51.1085"></a><span id="l51.1085" class="difflineplus">+      // (only generate the event since we're not in a update batch)</span>
<a href="#l51.1086"></a><span id="l51.1086" class="difflineplus">+      this.listener.onSortChanged();</span>
<a href="#l51.1087"></a><span id="l51.1087">     }</span>
<a href="#l51.1088"></a><span id="l51.1088">     // (if we are in a view update, then a new view will be created when the</span>
<a href="#l51.1089"></a><span id="l51.1089">     //  update ends, and it will just use the new sort order anyways.)</span>
<a href="#l51.1090"></a><span id="l51.1090">   },</span>
<a href="#l51.1091"></a><span id="l51.1091"> </span>
<a href="#l51.1092"></a><span id="l51.1092">   /**</span>
<a href="#l51.1093"></a><span id="l51.1093" class="difflineplus">+   * Logic that compensates for custom column identifiers being provided as</span>
<a href="#l51.1094"></a><span id="l51.1094" class="difflineplus">+   *  sort types.</span>
<a href="#l51.1095"></a><span id="l51.1095" class="difflineplus">+   *</span>
<a href="#l51.1096"></a><span id="l51.1096" class="difflineplus">+   * @return [sort type, sort order, sort custom column name]</span>
<a href="#l51.1097"></a><span id="l51.1097" class="difflineplus">+   */</span>
<a href="#l51.1098"></a><span id="l51.1098" class="difflineplus">+  _getSortDetails: function(aIndex) {</span>
<a href="#l51.1099"></a><span id="l51.1099" class="difflineplus">+    let [sortType, sortOrder] = this._sort[aIndex];</span>
<a href="#l51.1100"></a><span id="l51.1100" class="difflineplus">+    let sortCustomColumn = null;</span>
<a href="#l51.1101"></a><span id="l51.1101" class="difflineplus">+    let sortTypeType = typeof(sortType);</span>
<a href="#l51.1102"></a><span id="l51.1102" class="difflineplus">+    if (sortTypeType != &quot;number&quot;) {</span>
<a href="#l51.1103"></a><span id="l51.1103" class="difflineplus">+      sortCustomColumn = (sortTypeType == &quot;string&quot;) ? sortType : sortType.id;</span>
<a href="#l51.1104"></a><span id="l51.1104" class="difflineplus">+      sortType = nsMsgViewSortType.byCustom;</span>
<a href="#l51.1105"></a><span id="l51.1105" class="difflineplus">+    }</span>
<a href="#l51.1106"></a><span id="l51.1106" class="difflineplus">+</span>
<a href="#l51.1107"></a><span id="l51.1107" class="difflineplus">+    return [sortType, sortOrder, sortCustomColumn];</span>
<a href="#l51.1108"></a><span id="l51.1108" class="difflineplus">+  },</span>
<a href="#l51.1109"></a><span id="l51.1109" class="difflineplus">+</span>
<a href="#l51.1110"></a><span id="l51.1110" class="difflineplus">+  /**</span>
<a href="#l51.1111"></a><span id="l51.1111">    * Accumulates implied secondary sorts based on multiple calls to this method.</span>
<a href="#l51.1112"></a><span id="l51.1112">    *  This is intended to be hooked up to be controlled by the UI.</span>
<a href="#l51.1113"></a><span id="l51.1113">    * Because we are lazy, we actually just poke the view's sort method and save</span>
<a href="#l51.1114"></a><span id="l51.1114">    *  the apparent secondary sort.  This also allows perfect compliance with the</span>
<a href="#l51.1115"></a><span id="l51.1115">    *  way this used to be implemented!</span>
<a href="#l51.1116"></a><span id="l51.1116">    */</span>
<a href="#l51.1117"></a><span id="l51.1117">   magicSort: function DBViewWrapper_magicSort(aSortType, aSortOrder) {</span>
<a href="#l51.1118"></a><span id="l51.1118">     if (this.dbView) {</span>
<a href="#l51.1119"></a><span id="l51.1119" class="difflineminus">-      this.dbView.sort(aSortType, aSortOrder);</span>
<a href="#l51.1120"></a><span id="l51.1120">       // so, the thing we just set obviously will be there</span>
<a href="#l51.1121"></a><span id="l51.1121">       this._sort = [[aSortType, aSortOrder]];</span>
<a href="#l51.1122"></a><span id="l51.1122" class="difflineplus">+      // (make sure it is valid...)</span>
<a href="#l51.1123"></a><span id="l51.1123" class="difflineplus">+      this._ensureValidSort();</span>
<a href="#l51.1124"></a><span id="l51.1124" class="difflineplus">+      // apply the sort to see what happens secondary-wise</span>
<a href="#l51.1125"></a><span id="l51.1125" class="difflineplus">+      this.dbView.sort(aSortType, aSortOrder);</span>
<a href="#l51.1126"></a><span id="l51.1126">       // there is only a secondary sort if it's not none and not the same.</span>
<a href="#l51.1127"></a><span id="l51.1127">       if (this.dbView.secondarySortType != nsMsgViewSortType.byNone &amp;&amp;</span>
<a href="#l51.1128"></a><span id="l51.1128">           this.dbView.secondarySortType != aSortType)</span>
<a href="#l51.1129"></a><span id="l51.1129">         this._sort.push([this.dbView.secondarySortType,</span>
<a href="#l51.1130"></a><span id="l51.1130">                          this.dbView.secondarySortOrder]);</span>
<a href="#l51.1131"></a><span id="l51.1131" class="difflineplus">+      // only tell our listener if we're not in a view update batch</span>
<a href="#l51.1132"></a><span id="l51.1132" class="difflineplus">+      if (this._viewUpdateDepth == 0)</span>
<a href="#l51.1133"></a><span id="l51.1133" class="difflineplus">+        this.listener.onSortChanged();</span>
<a href="#l51.1134"></a><span id="l51.1134">     }</span>
<a href="#l51.1135"></a><span id="l51.1135">   },</span>
<a href="#l51.1136"></a><span id="l51.1136"> </span>
<a href="#l51.1137"></a><span id="l51.1137" class="difflineplus">+  /**</span>
<a href="#l51.1138"></a><span id="l51.1138" class="difflineplus">+   * Make sure the current sort is valid under our other constraints, make it</span>
<a href="#l51.1139"></a><span id="l51.1139" class="difflineplus">+   *  safe if it is not.  Most specifically, some sorts are illegal when</span>
<a href="#l51.1140"></a><span id="l51.1140" class="difflineplus">+   *  grouping by sort, and we reset the sort to date in those cases.</span>
<a href="#l51.1141"></a><span id="l51.1141" class="difflineplus">+   *</span>
<a href="#l51.1142"></a><span id="l51.1142" class="difflineplus">+   * @param aViewFlags Optional set of view flags to consider instead of the</span>
<a href="#l51.1143"></a><span id="l51.1143" class="difflineplus">+   *     potentially live view flags.</span>
<a href="#l51.1144"></a><span id="l51.1144" class="difflineplus">+   */</span>
<a href="#l51.1145"></a><span id="l51.1145" class="difflineplus">+  _ensureValidSort: function DBViewWrapper_ensureValidSort(aViewFlags) {</span>
<a href="#l51.1146"></a><span id="l51.1146" class="difflineplus">+    if ((aViewFlags != null ? aViewFlags : this._viewFlags) &amp;</span>
<a href="#l51.1147"></a><span id="l51.1147" class="difflineplus">+        nsMsgViewFlagsType.kGroupBySort) {</span>
<a href="#l51.1148"></a><span id="l51.1148" class="difflineplus">+      // We cannot be sorting by thread, id, none, or size.  If we are, switch</span>
<a href="#l51.1149"></a><span id="l51.1149" class="difflineplus">+      //  to sorting by date.</span>
<a href="#l51.1150"></a><span id="l51.1150" class="difflineplus">+      let sortType = this._sort[0][0];</span>
<a href="#l51.1151"></a><span id="l51.1151" class="difflineplus">+      if (sortType == nsMsgViewSortType.byThread ||</span>
<a href="#l51.1152"></a><span id="l51.1152" class="difflineplus">+          sortType == nsMsgViewSortType.byId ||</span>
<a href="#l51.1153"></a><span id="l51.1153" class="difflineplus">+          sortType == nsMsgViewSortType.byNone ||</span>
<a href="#l51.1154"></a><span id="l51.1154" class="difflineplus">+          sortType == nsMsgViewSortType.bySize)</span>
<a href="#l51.1155"></a><span id="l51.1155" class="difflineplus">+        this._sort = [nsMsgViewSortType.byDate, this._sort[0][1]];</span>
<a href="#l51.1156"></a><span id="l51.1156" class="difflineplus">+    }</span>
<a href="#l51.1157"></a><span id="l51.1157" class="difflineplus">+  },</span>
<a href="#l51.1158"></a><span id="l51.1158" class="difflineplus">+</span>
<a href="#l51.1159"></a><span id="l51.1159" class="difflineplus">+  /**</span>
<a href="#l51.1160"></a><span id="l51.1160" class="difflineplus">+   * @return true if we are grouped-by-sort, false if not.  If we are not</span>
<a href="#l51.1161"></a><span id="l51.1161" class="difflineplus">+   *     grouped by sort, then we are either threaded or unthreaded; check</span>
<a href="#l51.1162"></a><span id="l51.1162" class="difflineplus">+   *     the showThreaded property to find out which of those it is.</span>
<a href="#l51.1163"></a><span id="l51.1163" class="difflineplus">+   */</span>
<a href="#l51.1164"></a><span id="l51.1164">   get showGroupedBySort() {</span>
<a href="#l51.1165"></a><span id="l51.1165">     return Boolean(this._viewFlags &amp; nsMsgViewFlagsType.kGroupBySort);</span>
<a href="#l51.1166"></a><span id="l51.1166">   },</span>
<a href="#l51.1167"></a><span id="l51.1167" class="difflineplus">+  /**</span>
<a href="#l51.1168"></a><span id="l51.1168" class="difflineplus">+   * Enable grouped-by-sort which is mutually exclusive with threaded display</span>
<a href="#l51.1169"></a><span id="l51.1169" class="difflineplus">+   *  (as controlled/exposed by showThreaded).  Grouped-by-sort is not legal</span>
<a href="#l51.1170"></a><span id="l51.1170" class="difflineplus">+   *  for sorts by thread/id/size/none and enabling this will cause us to change</span>
<a href="#l51.1171"></a><span id="l51.1171" class="difflineplus">+   *  our sort to by date in those cases.</span>
<a href="#l51.1172"></a><span id="l51.1172" class="difflineplus">+   */</span>
<a href="#l51.1173"></a><span id="l51.1173">   set showGroupedBySort(aShowGroupBySort) {</span>
<a href="#l51.1174"></a><span id="l51.1174">     if (this.showGroupedBySort != aShowGroupBySort) {</span>
<a href="#l51.1175"></a><span id="l51.1175" class="difflineminus">-      if (aShowGroupBySort)</span>
<a href="#l51.1176"></a><span id="l51.1176" class="difflineminus">-        this._viewFlags |= nsMsgViewFlagsType.kGroupBySort;</span>
<a href="#l51.1177"></a><span id="l51.1177" class="difflineplus">+      if (aShowGroupBySort) {</span>
<a href="#l51.1178"></a><span id="l51.1178" class="difflineplus">+        // do not apply the flag change until we have made the sort safe</span>
<a href="#l51.1179"></a><span id="l51.1179" class="difflineplus">+        let viewFlags = this._viewFlags |</span>
<a href="#l51.1180"></a><span id="l51.1180" class="difflineplus">+                        nsMsgViewFlagsType.kGroupBySort |</span>
<a href="#l51.1181"></a><span id="l51.1181" class="difflineplus">+                         nsMsgViewFlagsType.kThreadedDisplay;</span>
<a href="#l51.1182"></a><span id="l51.1182" class="difflineplus">+        this._ensureValidSort(viewFlags);</span>
<a href="#l51.1183"></a><span id="l51.1183" class="difflineplus">+        this._viewFlags = viewFlags;</span>
<a href="#l51.1184"></a><span id="l51.1184" class="difflineplus">+      }</span>
<a href="#l51.1185"></a><span id="l51.1185" class="difflineplus">+      // maybe we shouldn't do anything in this case?</span>
<a href="#l51.1186"></a><span id="l51.1186">       else</span>
<a href="#l51.1187"></a><span id="l51.1187" class="difflineminus">-        this._viewFlags &amp;= ~nsMsgViewFlagsType.kGroupBySort;</span>
<a href="#l51.1188"></a><span id="l51.1188" class="difflineminus">-      // lose the threading bit...</span>
<a href="#l51.1189"></a><span id="l51.1189" class="difflineminus">-      this._viewFlags &amp;= ~nsMsgViewFlagsType.kThreadedDisplay;</span>
<a href="#l51.1190"></a><span id="l51.1190" class="difflineminus">-      this._applyViewChanges();</span>
<a href="#l51.1191"></a><span id="l51.1191" class="difflineplus">+        this._viewFlags &amp;= ~(nsMsgViewFlagsType.kGroupBySort |</span>
<a href="#l51.1192"></a><span id="l51.1192" class="difflineplus">+                             nsMsgViewFlagsType.kThreadedDisplay);</span>
<a href="#l51.1193"></a><span id="l51.1193">     }</span>
<a href="#l51.1194"></a><span id="l51.1194">   },</span>
<a href="#l51.1195"></a><span id="l51.1195"> </span>
<a href="#l51.1196"></a><span id="l51.1196" class="difflineplus">+  /**</span>
<a href="#l51.1197"></a><span id="l51.1197" class="difflineplus">+   * Are we showing ignored/killed threads?  Only meaningful for newsgroups.</span>
<a href="#l51.1198"></a><span id="l51.1198" class="difflineplus">+   */</span>
<a href="#l51.1199"></a><span id="l51.1199">   get showIgnored() {</span>
<a href="#l51.1200"></a><span id="l51.1200">     return Boolean(this._viewFlags &amp; nsMsgViewFlagsType.kShowIgnored);</span>
<a href="#l51.1201"></a><span id="l51.1201">   },</span>
<a href="#l51.1202"></a><span id="l51.1202" class="difflineplus">+  /**</span>
<a href="#l51.1203"></a><span id="l51.1203" class="difflineplus">+   * Set whether we are showing ignored/killed threads.  Only meaningful for</span>
<a href="#l51.1204"></a><span id="l51.1204" class="difflineplus">+   *  newsgroups.</span>
<a href="#l51.1205"></a><span id="l51.1205" class="difflineplus">+   */</span>
<a href="#l51.1206"></a><span id="l51.1206">   set showIgnored(aShowIgnored) {</span>
<a href="#l51.1207"></a><span id="l51.1207">     if (this.showIgnored != aShowIgnored) {</span>
<a href="#l51.1208"></a><span id="l51.1208">       if (aShowIgnored)</span>
<a href="#l51.1209"></a><span id="l51.1209">         this._viewFlags |= nsMsgViewFlagsType.kShowIgnored;</span>
<a href="#l51.1210"></a><span id="l51.1210">       else</span>
<a href="#l51.1211"></a><span id="l51.1211">         this._viewFlags &amp;= ~nsMsgViewFlagsType.kShowIgnored;</span>
<a href="#l51.1212"></a><span id="l51.1212" class="difflineminus">-      this._applyViewChanges();</span>
<a href="#l51.1213"></a><span id="l51.1213" class="difflineplus">+    }</span>
<a href="#l51.1214"></a><span id="l51.1214" class="difflineplus">+  },</span>
<a href="#l51.1215"></a><span id="l51.1215" class="difflineplus">+</span>
<a href="#l51.1216"></a><span id="l51.1216" class="difflineplus">+  /**</span>
<a href="#l51.1217"></a><span id="l51.1217" class="difflineplus">+   * @return true if we are in threaded display (as opposed to grouped or</span>
<a href="#l51.1218"></a><span id="l51.1218" class="difflineplus">+   *     unthreaded.)</span>
<a href="#l51.1219"></a><span id="l51.1219" class="difflineplus">+   */</span>
<a href="#l51.1220"></a><span id="l51.1220" class="difflineplus">+  get showThreaded() {</span>
<a href="#l51.1221"></a><span id="l51.1221" class="difflineplus">+    return (this._viewFlags &amp; nsMsgViewFlagsType.kThreadedDisplay) &amp;&amp;</span>
<a href="#l51.1222"></a><span id="l51.1222" class="difflineplus">+           !(this._viewFlags &amp; nsMsgViewFlagsType.kGroupBySort);</span>
<a href="#l51.1223"></a><span id="l51.1223" class="difflineplus">+  },</span>
<a href="#l51.1224"></a><span id="l51.1224" class="difflineplus">+  /**</span>
<a href="#l51.1225"></a><span id="l51.1225" class="difflineplus">+   * Set us to threaded display mode when set to true.  If we are already in</span>
<a href="#l51.1226"></a><span id="l51.1226" class="difflineplus">+   *  threaded display mode, we do nothing.  If you want to set us to unthreaded</span>
<a href="#l51.1227"></a><span id="l51.1227" class="difflineplus">+   *  mode, set |showUnthreaded| to true.  (Because we have three modes of</span>
<a href="#l51.1228"></a><span id="l51.1228" class="difflineplus">+   *  operation: unthreaded, threaded, and grouped-by-sort, we are a tri-state</span>
<a href="#l51.1229"></a><span id="l51.1229" class="difflineplus">+   *  and setting us to false is ambiguous.  We should probably be using a</span>
<a href="#l51.1230"></a><span id="l51.1230" class="difflineplus">+   *  single attribute with three constants...)</span>
<a href="#l51.1231"></a><span id="l51.1231" class="difflineplus">+   */</span>
<a href="#l51.1232"></a><span id="l51.1232" class="difflineplus">+  set showThreaded(aShowThreaded) {</span>
<a href="#l51.1233"></a><span id="l51.1233" class="difflineplus">+    if (this.showThreaded != aShowThreaded) {</span>
<a href="#l51.1234"></a><span id="l51.1234" class="difflineplus">+      let viewFlags = this._viewFlags;</span>
<a href="#l51.1235"></a><span id="l51.1235" class="difflineplus">+      if (aShowThreaded)</span>
<a href="#l51.1236"></a><span id="l51.1236" class="difflineplus">+        viewFlags |= nsMsgViewFlagsType.kThreadedDisplay;</span>
<a href="#l51.1237"></a><span id="l51.1237" class="difflineplus">+      // maybe we shouldn't do anything in this case?</span>
<a href="#l51.1238"></a><span id="l51.1238" class="difflineplus">+      else</span>
<a href="#l51.1239"></a><span id="l51.1239" class="difflineplus">+        viewFlags &amp;= ~nsMsgViewFlagsType.kThreadedDisplay;</span>
<a href="#l51.1240"></a><span id="l51.1240" class="difflineplus">+      // lose the group bit...</span>
<a href="#l51.1241"></a><span id="l51.1241" class="difflineplus">+      viewFlags &amp;= ~nsMsgViewFlagsType.kGroupBySort;</span>
<a href="#l51.1242"></a><span id="l51.1242" class="difflineplus">+      this._viewFlags = viewFlags;</span>
<a href="#l51.1243"></a><span id="l51.1243">     }</span>
<a href="#l51.1244"></a><span id="l51.1244">   },</span>
<a href="#l51.1245"></a><span id="l51.1245"> </span>
<a href="#l51.1246"></a><span id="l51.1246" class="difflineminus">-  get showThreaded() {</span>
<a href="#l51.1247"></a><span id="l51.1247" class="difflineminus">-    return Boolean(this._viewFlags &amp; nsMsgViewFlagsType.kThreadedDisplay);</span>
<a href="#l51.1248"></a><span id="l51.1248" class="difflineplus">+  /**</span>
<a href="#l51.1249"></a><span id="l51.1249" class="difflineplus">+   * @return true if we are in unthreaded mode (which means not threaded and</span>
<a href="#l51.1250"></a><span id="l51.1250" class="difflineplus">+   *     not grouped by sort).</span>
<a href="#l51.1251"></a><span id="l51.1251" class="difflineplus">+   */</span>
<a href="#l51.1252"></a><span id="l51.1252" class="difflineplus">+  get showUnthreaded() {</span>
<a href="#l51.1253"></a><span id="l51.1253" class="difflineplus">+    return Boolean(!(this._viewFlags &amp; (nsMsgViewFlagsType.kGroupBySort |</span>
<a href="#l51.1254"></a><span id="l51.1254" class="difflineplus">+                                        nsMsgViewFlagsType.kThreadedDisplay)));</span>
<a href="#l51.1255"></a><span id="l51.1255">   },</span>
<a href="#l51.1256"></a><span id="l51.1256" class="difflineminus">-  set showThreaded(aShowThreaded) {</span>
<a href="#l51.1257"></a><span id="l51.1257" class="difflineminus">-    if (this.showThreaded != aShowThreaded) {</span>
<a href="#l51.1258"></a><span id="l51.1258" class="difflineminus">-      if (aShowThreaded)</span>
<a href="#l51.1259"></a><span id="l51.1259" class="difflineminus">-        this._viewFlags |= nsMsgViewFlagsType.kThreadedDisplay;</span>
<a href="#l51.1260"></a><span id="l51.1260" class="difflineplus">+  /**</span>
<a href="#l51.1261"></a><span id="l51.1261" class="difflineplus">+   * Set to true to put us in unthreaded mode (which means not threaded and</span>
<a href="#l51.1262"></a><span id="l51.1262" class="difflineplus">+   *  not grouped by sort).</span>
<a href="#l51.1263"></a><span id="l51.1263" class="difflineplus">+   */</span>
<a href="#l51.1264"></a><span id="l51.1264" class="difflineplus">+  set showUnthreaded(aShowUnthreaded) {</span>
<a href="#l51.1265"></a><span id="l51.1265" class="difflineplus">+    if (this.showUnthreaded != aShowUnthreaded) {</span>
<a href="#l51.1266"></a><span id="l51.1266" class="difflineplus">+      if (aShowUnthreaded)</span>
<a href="#l51.1267"></a><span id="l51.1267" class="difflineplus">+        this._viewFlags &amp;= ~(nsMsgViewFlagsType.kGroupBySort |</span>
<a href="#l51.1268"></a><span id="l51.1268" class="difflineplus">+                             nsMsgViewFlagsType.kThreadedDisplay);</span>
<a href="#l51.1269"></a><span id="l51.1269" class="difflineplus">+      // maybe we shouldn't do anything in this case?</span>
<a href="#l51.1270"></a><span id="l51.1270">       else</span>
<a href="#l51.1271"></a><span id="l51.1271" class="difflineminus">-        this._viewFlags &amp;= ~nsMsgViewFlagsType.kThreadedDisplay;</span>
<a href="#l51.1272"></a><span id="l51.1272" class="difflineminus">-      // lose the group bit...</span>
<a href="#l51.1273"></a><span id="l51.1273" class="difflineminus">-      this._viewFlags &amp;= ~nsMsgViewFlagsType.kGroupBySort;</span>
<a href="#l51.1274"></a><span id="l51.1274" class="difflineminus">-      this._applyViewChanges();</span>
<a href="#l51.1275"></a><span id="l51.1275" class="difflineplus">+        this._viewFlags = (this._viewFlags &amp; ~nsMsgViewFlagsType.kGroupBySort) |</span>
<a href="#l51.1276"></a><span id="l51.1276" class="difflineplus">+                            nsMsgViewFlagsType.kThreadedDisplay;</span>
<a href="#l51.1277"></a><span id="l51.1277">     }</span>
<a href="#l51.1278"></a><span id="l51.1278">   },</span>
<a href="#l51.1279"></a><span id="l51.1279"> </span>
<a href="#l51.1280"></a><span id="l51.1280" class="difflineplus">+  /**</span>
<a href="#l51.1281"></a><span id="l51.1281" class="difflineplus">+   * @return true if we are showing only unread messages.</span>
<a href="#l51.1282"></a><span id="l51.1282" class="difflineplus">+   */</span>
<a href="#l51.1283"></a><span id="l51.1283">   get showUnreadOnly() {</span>
<a href="#l51.1284"></a><span id="l51.1284">     return Boolean(this._viewFlags &amp; nsMsgViewFlagsType.kUnreadOnly);</span>
<a href="#l51.1285"></a><span id="l51.1285">   },</span>
<a href="#l51.1286"></a><span id="l51.1286" class="difflineplus">+  /**</span>
<a href="#l51.1287"></a><span id="l51.1287" class="difflineplus">+   * Enable/disable showing only unread messages using the view's flag-based</span>
<a href="#l51.1288"></a><span id="l51.1288" class="difflineplus">+   *  mechanism.  This functionality can also be approximated using a mail</span>
<a href="#l51.1289"></a><span id="l51.1289" class="difflineplus">+   *  view (or other search) for unread messages.  There also exist special</span>
<a href="#l51.1290"></a><span id="l51.1290" class="difflineplus">+   *  views for showing messages with unread threads which is different and</span>
<a href="#l51.1291"></a><span id="l51.1291" class="difflineplus">+   *  has serious limitations because of its nature.</span>
<a href="#l51.1292"></a><span id="l51.1292" class="difflineplus">+   */</span>
<a href="#l51.1293"></a><span id="l51.1293">   set showUnreadOnly(aShowUnreadOnly) {</span>
<a href="#l51.1294"></a><span id="l51.1294">     if (this.showUnreadOnly != aShowUnreadOnly) {</span>
<a href="#l51.1295"></a><span id="l51.1295">       if (aShowUnreadOnly)</span>
<a href="#l51.1296"></a><span id="l51.1296">         this._viewFlags |= nsMsgViewFlagsType.kUnreadOnly;</span>
<a href="#l51.1297"></a><span id="l51.1297">       else</span>
<a href="#l51.1298"></a><span id="l51.1298">         this._viewFlags &amp;= ~nsMsgViewFlagsType.kUnreadOnly;</span>
<a href="#l51.1299"></a><span id="l51.1299" class="difflineminus">-      this._applyViewChanges();</span>
<a href="#l51.1300"></a><span id="l51.1300">     }</span>
<a href="#l51.1301"></a><span id="l51.1301">   },</span>
<a href="#l51.1302"></a><span id="l51.1302"> </span>
<a href="#l51.1303"></a><span id="l51.1303">   /**</span>
<a href="#l51.1304"></a><span id="l51.1304">    * Read-only attribute indicating if a 'special view' is in use.  There are</span>
<a href="#l51.1305"></a><span id="l51.1305">    *  two special views in existence, both of which are concerned about</span>
<a href="#l51.1306"></a><span id="l51.1306">    *  showing you threads that have any unread messages in them.  They are views</span>
<a href="#l51.1307"></a><span id="l51.1307">    *  rather than search predicates because the search mechanism is not capable</span>
<a href="#l51.1308"></a><span id="l51.1308" class="difflineat">@@ -1143,17 +1730,18 @@ DBViewWrapper.prototype = {</span>
<a href="#l51.1309"></a><span id="l51.1309">    */</span>
<a href="#l51.1310"></a><span id="l51.1310">   setMailView: function DBViewWrapper_setMailView(aMailViewIndex, aData,</span>
<a href="#l51.1311"></a><span id="l51.1311">                                                   aDoNotPersist) {</span>
<a href="#l51.1312"></a><span id="l51.1312">     let mailViewDef = MailViewManager.getMailViewByIndex(aMailViewIndex);</span>
<a href="#l51.1313"></a><span id="l51.1313"> </span>
<a href="#l51.1314"></a><span id="l51.1314">     this._mailViewIndex = aMailViewIndex;</span>
<a href="#l51.1315"></a><span id="l51.1315">     this._mailViewData = aData;</span>
<a href="#l51.1316"></a><span id="l51.1316"> </span>
<a href="#l51.1317"></a><span id="l51.1317" class="difflineminus">-    // - update the search terms (this triggers the view update)</span>
<a href="#l51.1318"></a><span id="l51.1318" class="difflineplus">+    // - update the search terms</span>
<a href="#l51.1319"></a><span id="l51.1319" class="difflineplus">+    // (this triggers a view update if we are not in a batch)</span>
<a href="#l51.1320"></a><span id="l51.1320">     this.search.viewTerms = mailViewDef.makeTerms(this.search.session,</span>
<a href="#l51.1321"></a><span id="l51.1321">                                                   aData);</span>
<a href="#l51.1322"></a><span id="l51.1322"> </span>
<a href="#l51.1323"></a><span id="l51.1323">     // - persist the view to the folder.</span>
<a href="#l51.1324"></a><span id="l51.1324">     if (!aDoNotPersist) {</span>
<a href="#l51.1325"></a><span id="l51.1325">       let msgDatabase = this.displayedFolder.msgDatabase;</span>
<a href="#l51.1326"></a><span id="l51.1326">       if (msgDatabase) {</span>
<a href="#l51.1327"></a><span id="l51.1327">         let dbFolderInfo = msgDatabase.dBFolderInfo;</span>
<a href="#l51.1328"></a><span id="l51.1328" class="difflineat">@@ -1165,20 +1753,31 @@ DBViewWrapper.prototype = {</span>
<a href="#l51.1329"></a><span id="l51.1329">         //  when we persist it.  It's not like the property is really generic</span>
<a href="#l51.1330"></a><span id="l51.1330">         //  anyways.</span>
<a href="#l51.1331"></a><span id="l51.1331">         dbFolderInfo.setCharProperty(</span>
<a href="#l51.1332"></a><span id="l51.1332">           MailViewConstants.kViewCurrentTag,</span>
<a href="#l51.1333"></a><span id="l51.1333">           this._mailViewData ? (&quot;:&quot; + this._mailViewData) : &quot;&quot;);</span>
<a href="#l51.1334"></a><span id="l51.1334">       }</span>
<a href="#l51.1335"></a><span id="l51.1335">     }</span>
<a href="#l51.1336"></a><span id="l51.1336"> </span>
<a href="#l51.1337"></a><span id="l51.1337" class="difflineminus">-    // we don't need to notify the view picker to update because the makeActive that</span>
<a href="#l51.1338"></a><span id="l51.1338" class="difflineminus">-    //  cascades out of the view update will do it for us.</span>
<a href="#l51.1339"></a><span id="l51.1339" class="difflineplus">+    // we don't need to notify the view picker to update because the makeActive</span>
<a href="#l51.1340"></a><span id="l51.1340" class="difflineplus">+    //  that cascades out of the view update will do it for us.</span>
<a href="#l51.1341"></a><span id="l51.1341">   },</span>
<a href="#l51.1342"></a><span id="l51.1342"> </span>
<a href="#l51.1343"></a><span id="l51.1343" class="difflineplus">+  /**</span>
<a href="#l51.1344"></a><span id="l51.1344" class="difflineplus">+   * @return true if the row at the given index contains a collapsed thread,</span>
<a href="#l51.1345"></a><span id="l51.1345" class="difflineplus">+   *     false if the row is a collapsed group or anything else.</span>
<a href="#l51.1346"></a><span id="l51.1346" class="difflineplus">+   */</span>
<a href="#l51.1347"></a><span id="l51.1347" class="difflineplus">+  isCollapsedThreadAtIndex:</span>
<a href="#l51.1348"></a><span id="l51.1348" class="difflineplus">+      function DBViewWrapper_isCollapsedThreadAtIndex(aViewIndex) {</span>
<a href="#l51.1349"></a><span id="l51.1349" class="difflineplus">+    let flags = this.dbView.getFlagsAt(aViewIndex);</span>
<a href="#l51.1350"></a><span id="l51.1350" class="difflineplus">+    return (flags &amp; nsMsgMessageFlags.Elided) &amp;&amp;</span>
<a href="#l51.1351"></a><span id="l51.1351" class="difflineplus">+           !(flags &amp; MSG_VIEW_FLAG_DUMMY) &amp;&amp;</span>
<a href="#l51.1352"></a><span id="l51.1352" class="difflineplus">+           this.dbView.isContainer(aViewIndex);</span>
<a href="#l51.1353"></a><span id="l51.1353" class="difflineplus">+  },</span>
<a href="#l51.1354"></a><span id="l51.1354"> </span>
<a href="#l51.1355"></a><span id="l51.1355">   /**</span>
<a href="#l51.1356"></a><span id="l51.1356">    * Perform application-level behaviors related to leaving a folder that have</span>
<a href="#l51.1357"></a><span id="l51.1357">    *  nothing to do with our abstraction.</span>
<a href="#l51.1358"></a><span id="l51.1358">    *</span>
<a href="#l51.1359"></a><span id="l51.1359">    * Things we do on leaving a folder:</span>
<a href="#l51.1360"></a><span id="l51.1360">    * - Mark the folder's messages as no longer new</span>
<a href="#l51.1361"></a><span id="l51.1361">    * - Mark all messages read in the folder _if so configured_.</span>
<a href="#l51.1362"></a><span id="l51.1362" class="difflineat">@@ -1197,9 +1796,39 @@ DBViewWrapper.prototype = {</span>
<a href="#l51.1363"></a><span id="l51.1363">       // goDoCommand('cmd_markAllRead').</span>
<a href="#l51.1364"></a><span id="l51.1364">       if (this.dbView &amp;&amp;</span>
<a href="#l51.1365"></a><span id="l51.1365">           this.listener.shouldDeferMessageDisplayUntilAfterServerConnect(</span>
<a href="#l51.1366"></a><span id="l51.1366">             this.displayedFolder.server.type))</span>
<a href="#l51.1367"></a><span id="l51.1367">         this.dbView.doCommand(nsMsgViewCommandType.markAllRead);</span>
<a href="#l51.1368"></a><span id="l51.1368">     }</span>
<a href="#l51.1369"></a><span id="l51.1369">     catch(e){/* ignore */}</span>
<a href="#l51.1370"></a><span id="l51.1370">   },</span>
<a href="#l51.1371"></a><span id="l51.1371" class="difflineplus">+</span>
<a href="#l51.1372"></a><span id="l51.1372" class="difflineplus">+  /**</span>
<a href="#l51.1373"></a><span id="l51.1373" class="difflineplus">+   * Convenience function to retrieve the first nsIMsgDBHdr in any of the</span>
<a href="#l51.1374"></a><span id="l51.1374" class="difflineplus">+   *  folders backing this view with the given message-id header.  This</span>
<a href="#l51.1375"></a><span id="l51.1375" class="difflineplus">+   *  is for the benefit of FolderDisplayWidget's selection logic.</span>
<a href="#l51.1376"></a><span id="l51.1376" class="difflineplus">+   * When thinking about using this, please keep in mind that, currently, this</span>
<a href="#l51.1377"></a><span id="l51.1377" class="difflineplus">+   *  is O(n) for the total number of messages across all the backing folders.</span>
<a href="#l51.1378"></a><span id="l51.1378" class="difflineplus">+   *  Since the folder database should already be in memory, this should</span>
<a href="#l51.1379"></a><span id="l51.1379" class="difflineplus">+   *  ideally not involve any disk I/O.</span>
<a href="#l51.1380"></a><span id="l51.1380" class="difflineplus">+   * Additionally, duplicate message-ids can and will happen, but since we</span>
<a href="#l51.1381"></a><span id="l51.1381" class="difflineplus">+   *  are using the message database's getMsgHdrForMessageID method to be fast,</span>
<a href="#l51.1382"></a><span id="l51.1382" class="difflineplus">+   *  our semantics are limited to telling you about only the first one we find.</span>
<a href="#l51.1383"></a><span id="l51.1383" class="difflineplus">+   *</span>
<a href="#l51.1384"></a><span id="l51.1384" class="difflineplus">+   * @param aMessageId The message-id of the message you want.</span>
<a href="#l51.1385"></a><span id="l51.1385" class="difflineplus">+   * @return The first nsIMsgDBHdr found in any of the underlying folders with</span>
<a href="#l51.1386"></a><span id="l51.1386" class="difflineplus">+   *     the given message header, null if none are found.  The fact that we</span>
<a href="#l51.1387"></a><span id="l51.1387" class="difflineplus">+   *     return something does not guarantee that it is actually visible in the</span>
<a href="#l51.1388"></a><span id="l51.1388" class="difflineplus">+   *     view.  (The search may be filtering it out.)</span>
<a href="#l51.1389"></a><span id="l51.1389" class="difflineplus">+   */</span>
<a href="#l51.1390"></a><span id="l51.1390" class="difflineplus">+  getMsgHdrForMessageID: function DBViewWrapper_getMsgHdrForMessageID(</span>
<a href="#l51.1391"></a><span id="l51.1391" class="difflineplus">+      aMessageId) {</span>
<a href="#l51.1392"></a><span id="l51.1392" class="difflineplus">+    if (!this._underlyingFolders)</span>
<a href="#l51.1393"></a><span id="l51.1393" class="difflineplus">+      return null;</span>
<a href="#l51.1394"></a><span id="l51.1394" class="difflineplus">+    for (let [, folder] in Iterator(this._underlyingFolders)) {</span>
<a href="#l51.1395"></a><span id="l51.1395" class="difflineplus">+      let msgHdr = folder.msgDatabase.getMsgHdrForMessageID(aMessageId);</span>
<a href="#l51.1396"></a><span id="l51.1396" class="difflineplus">+      if (msgHdr)</span>
<a href="#l51.1397"></a><span id="l51.1397" class="difflineplus">+        return msgHdr;</span>
<a href="#l51.1398"></a><span id="l51.1398" class="difflineplus">+    }</span>
<a href="#l51.1399"></a><span id="l51.1399" class="difflineplus">+    return null;</span>
<a href="#l51.1400"></a><span id="l51.1400" class="difflineplus">+  },</span>
<a href="#l51.1401"></a><span id="l51.1401"> };</span>
<a href="#l51.1402"></a><span id="l51.1402">\ No newline at end of file</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l52.1"></a><span id="l52.1" class="difflineminus">--- a/mailnews/base/src/nsMsgDBView.cpp</span>
<a href="#l52.2"></a><span id="l52.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgDBView.cpp</span>
<a href="#l52.3"></a><span id="l52.3" class="difflineat">@@ -2177,16 +2177,31 @@ NS_IMETHODIMP nsMsgDBView::GetIndicesFor</span>
<a href="#l52.4"></a><span id="l52.4"> </span>
<a href="#l52.5"></a><span id="l52.5">   PRUint32 datalen = numIndices * sizeof(nsMsgViewIndex);</span>
<a href="#l52.6"></a><span id="l52.6">   *indices = (nsMsgViewIndex *)NS_Alloc(datalen);</span>
<a href="#l52.7"></a><span id="l52.7">   if (!*indices) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l52.8"></a><span id="l52.8">   memcpy(*indices, selection.Elements(), datalen);</span>
<a href="#l52.9"></a><span id="l52.9">   return NS_OK;</span>
<a href="#l52.10"></a><span id="l52.10"> }</span>
<a href="#l52.11"></a><span id="l52.11"> </span>
<a href="#l52.12"></a><span id="l52.12" class="difflineplus">+NS_IMETHODIMP nsMsgDBView::GetMsgHdrsForSelection(nsIMutableArray **aResult)</span>
<a href="#l52.13"></a><span id="l52.13" class="difflineplus">+{</span>
<a href="#l52.14"></a><span id="l52.14" class="difflineplus">+  nsMsgViewIndexArray selection;</span>
<a href="#l52.15"></a><span id="l52.15" class="difflineplus">+  GetSelectedIndices(selection);</span>
<a href="#l52.16"></a><span id="l52.16" class="difflineplus">+  PRUint32 numIndices = selection.Length();</span>
<a href="#l52.17"></a><span id="l52.17" class="difflineplus">+</span>
<a href="#l52.18"></a><span id="l52.18" class="difflineplus">+  nsresult rv;</span>
<a href="#l52.19"></a><span id="l52.19" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; messages(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l52.20"></a><span id="l52.20" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.21"></a><span id="l52.21" class="difflineplus">+  rv = GetHeadersFromSelection(selection.Elements(), numIndices, messages);</span>
<a href="#l52.22"></a><span id="l52.22" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.23"></a><span id="l52.23" class="difflineplus">+  messages.forget(aResult);</span>
<a href="#l52.24"></a><span id="l52.24" class="difflineplus">+  return rv;</span>
<a href="#l52.25"></a><span id="l52.25" class="difflineplus">+}</span>
<a href="#l52.26"></a><span id="l52.26" class="difflineplus">+</span>
<a href="#l52.27"></a><span id="l52.27"> NS_IMETHODIMP nsMsgDBView::GetURIsForSelection(PRUint32 *length, char ***uris)</span>
<a href="#l52.28"></a><span id="l52.28"> {</span>
<a href="#l52.29"></a><span id="l52.29">   nsresult rv = NS_OK;</span>
<a href="#l52.30"></a><span id="l52.30"> </span>
<a href="#l52.31"></a><span id="l52.31">   NS_ENSURE_ARG_POINTER(length);</span>
<a href="#l52.32"></a><span id="l52.32">   *length = 0;</span>
<a href="#l52.33"></a><span id="l52.33">   </span>
<a href="#l52.34"></a><span id="l52.34">   NS_ENSURE_ARG_POINTER(uris);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l53.1"></a><span id="l53.1" class="difflineminus">--- a/mailnews/base/src/nsMsgSearchDBView.cpp</span>
<a href="#l53.2"></a><span id="l53.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgSearchDBView.cpp</span>
<a href="#l53.3"></a><span id="l53.3" class="difflineat">@@ -50,16 +50,17 @@</span>
<a href="#l53.4"></a><span id="l53.4"> #include &quot;nsIMsgMessageService.h&quot;</span>
<a href="#l53.5"></a><span id="l53.5"> #include &quot;nsAutoPtr.h&quot;</span>
<a href="#l53.6"></a><span id="l53.6"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l53.7"></a><span id="l53.7"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l53.8"></a><span id="l53.8"> #include &quot;nsMsgGroupThread.h&quot;</span>
<a href="#l53.9"></a><span id="l53.9"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l53.10"></a><span id="l53.10"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l53.11"></a><span id="l53.11"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l53.12"></a><span id="l53.12" class="difflineplus">+#include &quot;nsIMsgSearchSession.h&quot;</span>
<a href="#l53.13"></a><span id="l53.13"> </span>
<a href="#l53.14"></a><span id="l53.14"> static PRBool gReferenceOnlyThreading;</span>
<a href="#l53.15"></a><span id="l53.15"> </span>
<a href="#l53.16"></a><span id="l53.16"> nsMsgSearchDBView::nsMsgSearchDBView()</span>
<a href="#l53.17"></a><span id="l53.17"> {</span>
<a href="#l53.18"></a><span id="l53.18">   // don't try to display messages for the search pane.</span>
<a href="#l53.19"></a><span id="l53.19">   mSuppressMsgDisplay = PR_TRUE;</span>
<a href="#l53.20"></a><span id="l53.20">   m_threadsTable.Init();</span>
<a href="#l53.21"></a><span id="l53.21" class="difflineat">@@ -731,16 +732,23 @@ nsMsgSearchDBView::OnNewSearch()</span>
<a href="#l53.22"></a><span id="l53.22"> </span>
<a href="#l53.23"></a><span id="l53.23"> NS_IMETHODIMP nsMsgSearchDBView::GetViewType(nsMsgViewTypeValue *aViewType)</span>
<a href="#l53.24"></a><span id="l53.24"> {</span>
<a href="#l53.25"></a><span id="l53.25">     NS_ENSURE_ARG_POINTER(aViewType);</span>
<a href="#l53.26"></a><span id="l53.26">     *aViewType = nsMsgViewType::eShowSearch;</span>
<a href="#l53.27"></a><span id="l53.27">     return NS_OK;</span>
<a href="#l53.28"></a><span id="l53.28"> }</span>
<a href="#l53.29"></a><span id="l53.29"> </span>
<a href="#l53.30"></a><span id="l53.30" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l53.31"></a><span id="l53.31" class="difflineplus">+nsMsgSearchDBView::SetSearchSession(nsIMsgSearchSession *aSession)</span>
<a href="#l53.32"></a><span id="l53.32" class="difflineplus">+{</span>
<a href="#l53.33"></a><span id="l53.33" class="difflineplus">+  m_searchSession = do_GetWeakReference(aSession);</span>
<a href="#l53.34"></a><span id="l53.34" class="difflineplus">+  return NS_OK;</span>
<a href="#l53.35"></a><span id="l53.35" class="difflineplus">+}</span>
<a href="#l53.36"></a><span id="l53.36" class="difflineplus">+</span>
<a href="#l53.37"></a><span id="l53.37"> NS_IMETHODIMP nsMsgSearchDBView::OnAnnouncerGoingAway(nsIDBChangeAnnouncer *instigator)</span>
<a href="#l53.38"></a><span id="l53.38"> {</span>
<a href="#l53.39"></a><span id="l53.39">   nsIMsgDatabase *db = static_cast&lt;nsIMsgDatabase *&gt;(instigator);</span>
<a href="#l53.40"></a><span id="l53.40">   if (db)</span>
<a href="#l53.41"></a><span id="l53.41">   {</span>
<a href="#l53.42"></a><span id="l53.42">     db-&gt;RemoveListener(this);</span>
<a href="#l53.43"></a><span id="l53.43">     m_dbToUseList.RemoveObject(db);</span>
<a href="#l53.44"></a><span id="l53.44">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l54.1"></a><span id="l54.1" class="difflineminus">--- a/mailnews/base/src/nsMsgSearchDBView.h</span>
<a href="#l54.2"></a><span id="l54.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgSearchDBView.h</span>
<a href="#l54.3"></a><span id="l54.3" class="difflineat">@@ -52,16 +52,18 @@ public:</span>
<a href="#l54.4"></a><span id="l54.4"> </span>
<a href="#l54.5"></a><span id="l54.5">   // these are tied together pretty intimately</span>
<a href="#l54.6"></a><span id="l54.6">   friend class nsMsgXFViewThread;</span>
<a href="#l54.7"></a><span id="l54.7"> </span>
<a href="#l54.8"></a><span id="l54.8">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l54.9"></a><span id="l54.9">   NS_DECL_NSIMSGSEARCHNOTIFY</span>
<a href="#l54.10"></a><span id="l54.10">   NS_DECL_NSIMSGCOPYSERVICELISTENER</span>
<a href="#l54.11"></a><span id="l54.11"> </span>
<a href="#l54.12"></a><span id="l54.12" class="difflineplus">+  NS_IMETHOD SetSearchSession(nsIMsgSearchSession *aSearchSession);</span>
<a href="#l54.13"></a><span id="l54.13" class="difflineplus">+</span>
<a href="#l54.14"></a><span id="l54.14">   virtual const char * GetViewName(void) {return &quot;SearchView&quot;; }</span>
<a href="#l54.15"></a><span id="l54.15">   NS_IMETHOD Open(nsIMsgFolder *folder, nsMsgViewSortTypeValue sortType, nsMsgViewSortOrderValue sortOrder, </span>
<a href="#l54.16"></a><span id="l54.16">         nsMsgViewFlagsTypeValue viewFlags, PRInt32 *pCount);</span>
<a href="#l54.17"></a><span id="l54.17">   NS_IMETHOD CloneDBView(nsIMessenger *aMessengerInstance, nsIMsgWindow *aMsgWindow,</span>
<a href="#l54.18"></a><span id="l54.18">                          nsIMsgDBViewCommandUpdater *aCmdUpdater, nsIMsgDBView **_retval);</span>
<a href="#l54.19"></a><span id="l54.19">   NS_IMETHOD CopyDBView(nsMsgDBView *aNewMsgDBView, nsIMessenger *aMessengerInstance, </span>
<a href="#l54.20"></a><span id="l54.20">                         nsIMsgWindow *aMsgWindow, nsIMsgDBViewCommandUpdater *aCmdUpdater);</span>
<a href="#l54.21"></a><span id="l54.21">   NS_IMETHOD Close();</span>
<a href="#l54.22"></a><span id="l54.22" class="difflineat">@@ -130,16 +132,17 @@ protected:</span>
<a href="#l54.23"></a><span id="l54.23">   PRUint32 mCurIndex;</span>
<a href="#l54.24"></a><span id="l54.24"> </span>
<a href="#l54.25"></a><span id="l54.25">   nsMsgViewIndex* mIndicesForChainedDeleteAndFile;</span>
<a href="#l54.26"></a><span id="l54.26">   PRInt32 mTotalIndices;</span>
<a href="#l54.27"></a><span id="l54.27">   nsCOMArray&lt;nsIMsgDatabase&gt; m_dbToUseList;</span>
<a href="#l54.28"></a><span id="l54.28">   nsMsgViewCommandTypeValue mCommand;</span>
<a href="#l54.29"></a><span id="l54.29">   nsCOMPtr &lt;nsIMsgFolder&gt; mDestFolder;</span>
<a href="#l54.30"></a><span id="l54.30">   nsString m_curCustomColumn;</span>
<a href="#l54.31"></a><span id="l54.31" class="difflineplus">+  nsWeakPtr m_searchSession;</span>
<a href="#l54.32"></a><span id="l54.32"> </span>
<a href="#l54.33"></a><span id="l54.33">   nsresult ProcessRequestsInOneFolder(nsIMsgWindow *window);</span>
<a href="#l54.34"></a><span id="l54.34">   nsresult ProcessRequestsInAllFolders(nsIMsgWindow *window);</span>
<a href="#l54.35"></a><span id="l54.35">   // these are for doing threading of the search hits</span>
<a href="#l54.36"></a><span id="l54.36"> </span>
<a href="#l54.37"></a><span id="l54.37"> </span>
<a href="#l54.38"></a><span id="l54.38">   // this maps message-ids and reference message ids to</span>
<a href="#l54.39"></a><span id="l54.39">   // the corresponding nsMsgXFViewThread object. If we're </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l55.1"></a><span id="l55.1" class="difflineminus">--- a/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp</span>
<a href="#l55.2"></a><span id="l55.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp</span>
<a href="#l55.3"></a><span id="l55.3" class="difflineat">@@ -119,23 +119,16 @@ nsMsgXFVirtualFolderDBView::CopyDBView(n</span>
<a href="#l55.4"></a><span id="l55.4"> </span>
<a href="#l55.5"></a><span id="l55.5"> NS_IMETHODIMP nsMsgXFVirtualFolderDBView::GetViewType(nsMsgViewTypeValue *aViewType)</span>
<a href="#l55.6"></a><span id="l55.6"> {</span>
<a href="#l55.7"></a><span id="l55.7">     NS_ENSURE_ARG_POINTER(aViewType);</span>
<a href="#l55.8"></a><span id="l55.8">     *aViewType = nsMsgViewType::eShowVirtualFolderResults;</span>
<a href="#l55.9"></a><span id="l55.9">     return NS_OK;</span>
<a href="#l55.10"></a><span id="l55.10"> }</span>
<a href="#l55.11"></a><span id="l55.11"> </span>
<a href="#l55.12"></a><span id="l55.12" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l55.13"></a><span id="l55.13" class="difflineminus">-nsMsgXFVirtualFolderDBView::SetSearchSession(nsIMsgSearchSession *aSession)</span>
<a href="#l55.14"></a><span id="l55.14" class="difflineminus">-{</span>
<a href="#l55.15"></a><span id="l55.15" class="difflineminus">-  m_searchSession = do_GetWeakReference(aSession);</span>
<a href="#l55.16"></a><span id="l55.16" class="difflineminus">-  return NS_OK;</span>
<a href="#l55.17"></a><span id="l55.17" class="difflineminus">-}</span>
<a href="#l55.18"></a><span id="l55.18" class="difflineminus">-</span>
<a href="#l55.19"></a><span id="l55.19"> nsresult nsMsgXFVirtualFolderDBView::OnNewHeader(nsIMsgDBHdr *newHdr, nsMsgKey aParentKey, PRBool /*ensureListed*/)</span>
<a href="#l55.20"></a><span id="l55.20"> {</span>
<a href="#l55.21"></a><span id="l55.21">   if (newHdr)</span>
<a href="#l55.22"></a><span id="l55.22">   {</span>
<a href="#l55.23"></a><span id="l55.23">     PRBool match = PR_FALSE;</span>
<a href="#l55.24"></a><span id="l55.24">     nsCOMPtr &lt;nsIMsgSearchSession&gt; searchSession = do_QueryReferent(m_searchSession);</span>
<a href="#l55.25"></a><span id="l55.25">     if (searchSession)</span>
<a href="#l55.26"></a><span id="l55.26">       searchSession-&gt;MatchHdr(newHdr, m_db, &amp;match);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l56.1"></a><span id="l56.1" class="difflineminus">--- a/mailnews/base/src/nsMsgXFVirtualFolderDBView.h</span>
<a href="#l56.2"></a><span id="l56.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgXFVirtualFolderDBView.h</span>
<a href="#l56.3"></a><span id="l56.3" class="difflineat">@@ -47,17 +47,16 @@</span>
<a href="#l56.4"></a><span id="l56.4"> class nsMsgGroupThread;</span>
<a href="#l56.5"></a><span id="l56.5"> </span>
<a href="#l56.6"></a><span id="l56.6"> class nsMsgXFVirtualFolderDBView : public nsMsgSearchDBView</span>
<a href="#l56.7"></a><span id="l56.7"> {</span>
<a href="#l56.8"></a><span id="l56.8"> public:</span>
<a href="#l56.9"></a><span id="l56.9">   nsMsgXFVirtualFolderDBView();</span>
<a href="#l56.10"></a><span id="l56.10">   virtual ~nsMsgXFVirtualFolderDBView();</span>
<a href="#l56.11"></a><span id="l56.11"> </span>
<a href="#l56.12"></a><span id="l56.12" class="difflineminus">-  NS_IMETHOD SetSearchSession(nsIMsgSearchSession *aSearchSession);</span>
<a href="#l56.13"></a><span id="l56.13">   // we override all the methods, currently. Might change...</span>
<a href="#l56.14"></a><span id="l56.14">   NS_DECL_NSIMSGSEARCHNOTIFY</span>
<a href="#l56.15"></a><span id="l56.15"> </span>
<a href="#l56.16"></a><span id="l56.16">   virtual const char * GetViewName(void) {return &quot;XFVirtualFolderView&quot;; }</span>
<a href="#l56.17"></a><span id="l56.17">   NS_IMETHOD Open(nsIMsgFolder *folder, nsMsgViewSortTypeValue sortType, nsMsgViewSortOrderValue sortOrder, </span>
<a href="#l56.18"></a><span id="l56.18">         nsMsgViewFlagsTypeValue viewFlags, PRInt32 *pCount);</span>
<a href="#l56.19"></a><span id="l56.19">   NS_IMETHOD OpenWithHdrs(nsISimpleEnumerator *aHeaders, </span>
<a href="#l56.20"></a><span id="l56.20">                           nsMsgViewSortTypeValue aSortType,</span>
<a href="#l56.21"></a><span id="l56.21" class="difflineat">@@ -87,12 +86,11 @@ protected:</span>
<a href="#l56.22"></a><span id="l56.22"> </span>
<a href="#l56.23"></a><span id="l56.23">   PRUint32 m_cachedFolderArrayIndex; // array index of next folder with cached hits to deal with.</span>
<a href="#l56.24"></a><span id="l56.24">   nsCOMArray&lt;nsIMsgFolder&gt; m_foldersSearchingOver;</span>
<a href="#l56.25"></a><span id="l56.25">   nsCOMArray&lt;nsIMsgDBHdr&gt; m_hdrHits;</span>
<a href="#l56.26"></a><span id="l56.26">   nsCOMPtr &lt;nsIMsgFolder&gt; m_curFolderGettingHits;</span>
<a href="#l56.27"></a><span id="l56.27">   PRUint32 m_curFolderStartKeyIndex; // keeps track of the index of the first hit from the cur folder</span>
<a href="#l56.28"></a><span id="l56.28">   PRBool m_curFolderHasCachedHits;</span>
<a href="#l56.29"></a><span id="l56.29">   PRBool m_doingSearch;</span>
<a href="#l56.30"></a><span id="l56.30" class="difflineminus">-  nsWeakPtr m_searchSession;</span>
<a href="#l56.31"></a><span id="l56.31"> };</span>
<a href="#l56.32"></a><span id="l56.32"> </span>
<a href="#l56.33"></a><span id="l56.33"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l57.1"></a><span id="l57.1" class="difflineminus">--- a/mailnews/base/src/quickSearchManager.js</span>
<a href="#l57.2"></a><span id="l57.2" class="difflineplus">+++ b/mailnews/base/src/quickSearchManager.js</span>
<a href="#l57.3"></a><span id="l57.3" class="difflineat">@@ -176,11 +176,11 @@ var QuickSearchManager = {</span>
<a href="#l57.4"></a><span id="l57.4">         term.value = value;</span>
<a href="#l57.5"></a><span id="l57.5">         term.attrib = nsMsgSearchAttrib.ToOrCC;</span>
<a href="#l57.6"></a><span id="l57.6">         term.op = nsMsgSearchOp.Contains;</span>
<a href="#l57.7"></a><span id="l57.7">         term.booleanAnd = false;</span>
<a href="#l57.8"></a><span id="l57.8">         searchTerms.push(term);</span>
<a href="#l57.9"></a><span id="l57.9">       }</span>
<a href="#l57.10"></a><span id="l57.10">     }</span>
<a href="#l57.11"></a><span id="l57.11"> </span>
<a href="#l57.12"></a><span id="l57.12" class="difflineminus">-    return searchTerms;</span>
<a href="#l57.13"></a><span id="l57.13" class="difflineplus">+    return searchTerms.length ? searchTerms : null;</span>
<a href="#l57.14"></a><span id="l57.14">   }</span>
<a href="#l57.15"></a><span id="l57.15"> };</span>
<a href="#l57.16"></a><span id="l57.16">\ No newline at end of file</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l58.1"></a><span id="l58.1" class="difflineminus">--- a/mailnews/base/src/searchSpec.js</span>
<a href="#l58.2"></a><span id="l58.2" class="difflineplus">+++ b/mailnews/base/src/searchSpec.js</span>
<a href="#l58.3"></a><span id="l58.3" class="difflineat">@@ -44,35 +44,56 @@ const Cu = Components.utils;</span>
<a href="#l58.4"></a><span id="l58.4"> </span>
<a href="#l58.5"></a><span id="l58.5"> Cu.import(&quot;resource://app/modules/iteratorUtils.jsm&quot;);</span>
<a href="#l58.6"></a><span id="l58.6"> Cu.import(&quot;resource://app/modules/quickSearchManager.js&quot;);</span>
<a href="#l58.7"></a><span id="l58.7"> </span>
<a href="#l58.8"></a><span id="l58.8"> const nsMsgSearchScope = Ci.nsMsgSearchScope;</span>
<a href="#l58.9"></a><span id="l58.9"> const nsIMsgSearchTerm = Ci.nsIMsgSearchTerm;</span>
<a href="#l58.10"></a><span id="l58.10"> const nsIMsgLocalMailFolder = Ci.nsIMsgLocalMailFolder;</span>
<a href="#l58.11"></a><span id="l58.11"> const nsMsgFolderFlags = Ci.nsMsgFolderFlags;</span>
<a href="#l58.12"></a><span id="l58.12" class="difflineplus">+const nsMsgSearchAttrib = Ci.nsMsgSearchAttrib;</span>
<a href="#l58.13"></a><span id="l58.13"> </span>
<a href="#l58.14"></a><span id="l58.14"> const NS_MSG_SEARCH_INTERRUPTED = 0x00550002;</span>
<a href="#l58.15"></a><span id="l58.15"> </span>
<a href="#l58.16"></a><span id="l58.16"> /**</span>
<a href="#l58.17"></a><span id="l58.17">  * Wrapper abstraction around a view's search session.  This is basically a</span>
<a href="#l58.18"></a><span id="l58.18">  *  friend class of FolderDisplayWidget and is privy to some of its internals.</span>
<a href="#l58.19"></a><span id="l58.19">  */</span>
<a href="#l58.20"></a><span id="l58.20" class="difflineminus">-function SearchSpec(aFolderDisplayWidget) {</span>
<a href="#l58.21"></a><span id="l58.21" class="difflineminus">-  this.owner = aFolderDisplayWidget;</span>
<a href="#l58.22"></a><span id="l58.22" class="difflineplus">+function SearchSpec(aViewWrapper) {</span>
<a href="#l58.23"></a><span id="l58.23" class="difflineplus">+  this.owner = aViewWrapper;</span>
<a href="#l58.24"></a><span id="l58.24"> </span>
<a href="#l58.25"></a><span id="l58.25">   this._viewTerms = null;</span>
<a href="#l58.26"></a><span id="l58.26">   this._virtualFolderTerms = null;</span>
<a href="#l58.27"></a><span id="l58.27">   this._userTerms = null;</span>
<a href="#l58.28"></a><span id="l58.28"> </span>
<a href="#l58.29"></a><span id="l58.29">   this._session = null;</span>
<a href="#l58.30"></a><span id="l58.30">   this._sessionListener = null;</span>
<a href="#l58.31"></a><span id="l58.31">   this._listenersRegistered = false;</span>
<a href="#l58.32"></a><span id="l58.32" class="difflineplus">+</span>
<a href="#l58.33"></a><span id="l58.33" class="difflineplus">+  this._onlineSearch = false;</span>
<a href="#l58.34"></a><span id="l58.34"> }</span>
<a href="#l58.35"></a><span id="l58.35"> SearchSpec.prototype = {</span>
<a href="#l58.36"></a><span id="l58.36" class="difflineplus">+  /**</span>
<a href="#l58.37"></a><span id="l58.37" class="difflineplus">+   * Clone this SearchSpec; intended to be used by DBViewWrapper.clone().</span>
<a href="#l58.38"></a><span id="l58.38" class="difflineplus">+   */</span>
<a href="#l58.39"></a><span id="l58.39" class="difflineplus">+  clone: function SearchSpec_clone(aViewWrapper) {</span>
<a href="#l58.40"></a><span id="l58.40" class="difflineplus">+    let doppel = new SearchSpec(aViewWrapper);</span>
<a href="#l58.41"></a><span id="l58.41" class="difflineplus">+</span>
<a href="#l58.42"></a><span id="l58.42" class="difflineplus">+    // we can just copy the terms since we never mutate them</span>
<a href="#l58.43"></a><span id="l58.43" class="difflineplus">+    doppel._viewTerms = this._viewTerms;</span>
<a href="#l58.44"></a><span id="l58.44" class="difflineplus">+    doppel._virtualFolderTerms = this._viewTerms;</span>
<a href="#l58.45"></a><span id="l58.45" class="difflineplus">+    doppel._userTerms = this._viewTerms;</span>
<a href="#l58.46"></a><span id="l58.46" class="difflineplus">+</span>
<a href="#l58.47"></a><span id="l58.47" class="difflineplus">+    // _session can stay null</span>
<a href="#l58.48"></a><span id="l58.48" class="difflineplus">+    // no listener is required, so we can keep _sessionListener and</span>
<a href="#l58.49"></a><span id="l58.49" class="difflineplus">+    //  _listenersRegistered at their default values</span>
<a href="#l58.50"></a><span id="l58.50" class="difflineplus">+</span>
<a href="#l58.51"></a><span id="l58.51" class="difflineplus">+    return doppel;</span>
<a href="#l58.52"></a><span id="l58.52" class="difflineplus">+  },</span>
<a href="#l58.53"></a><span id="l58.53" class="difflineplus">+</span>
<a href="#l58.54"></a><span id="l58.54">   get hasSearchTerms() {</span>
<a href="#l58.55"></a><span id="l58.55">     return this._viewTerms || this._virtualFolderTerms || this._userTerms;</span>
<a href="#l58.56"></a><span id="l58.56">   },</span>
<a href="#l58.57"></a><span id="l58.57"> </span>
<a href="#l58.58"></a><span id="l58.58">   get hasOnlyVirtualTerms() {</span>
<a href="#l58.59"></a><span id="l58.59">     return this._virtualFolderTerms &amp;&amp; !this._viewTerms &amp;&amp; !this._userTerms;</span>
<a href="#l58.60"></a><span id="l58.60">   },</span>
<a href="#l58.61"></a><span id="l58.61"> </span>
<a href="#l58.62"></a><span id="l58.62" class="difflineat">@@ -99,17 +120,17 @@ SearchSpec.prototype = {</span>
<a href="#l58.63"></a><span id="l58.63">    * (Potentially) add the db view as a search listener and kick off the search.</span>
<a href="#l58.64"></a><span id="l58.64">    *  We only do that if we have search terms.  The intent is to allow you to</span>
<a href="#l58.65"></a><span id="l58.65">    *  call this all the time, even if you don't need to.</span>
<a href="#l58.66"></a><span id="l58.66">    * DBViewWrapper._applyViewChanges used to handle a lot more of this, but our</span>
<a href="#l58.67"></a><span id="l58.67">    *  need to make sure that the session listener gets added after the DBView</span>
<a href="#l58.68"></a><span id="l58.68">    *  caused us to introduce this method.  (We want the DB View's OnDone method</span>
<a href="#l58.69"></a><span id="l58.69">    *  to run before our listener, as it may do important work.)</span>
<a href="#l58.70"></a><span id="l58.70">    */</span>
<a href="#l58.71"></a><span id="l58.71" class="difflineminus">-  associateView: function(aDBView) {</span>
<a href="#l58.72"></a><span id="l58.72" class="difflineplus">+  associateView: function SearchSpec_associateView(aDBView) {</span>
<a href="#l58.73"></a><span id="l58.73">     if (this.hasSearchTerms) {</span>
<a href="#l58.74"></a><span id="l58.74">       this.updateSession();</span>
<a href="#l58.75"></a><span id="l58.75"> </span>
<a href="#l58.76"></a><span id="l58.76">       if (!this._sessionListener)</span>
<a href="#l58.77"></a><span id="l58.77">         this._sessionListener = new SearchSpecListener(this);</span>
<a href="#l58.78"></a><span id="l58.78"> </span>
<a href="#l58.79"></a><span id="l58.79">       this.session.registerListener(aDBView);</span>
<a href="#l58.80"></a><span id="l58.80">       aDBView.searchSession = this._session;</span>
<a href="#l58.81"></a><span id="l58.81" class="difflineat">@@ -119,17 +140,17 @@ SearchSpec.prototype = {</span>
<a href="#l58.82"></a><span id="l58.82">       this.owner.searching = true;</span>
<a href="#l58.83"></a><span id="l58.83">       this.session.search(this.owner.listener.msgWindow);</span>
<a href="#l58.84"></a><span id="l58.84">     }</span>
<a href="#l58.85"></a><span id="l58.85">   },</span>
<a href="#l58.86"></a><span id="l58.86">   /**</span>
<a href="#l58.87"></a><span id="l58.87">    * Stop any active search and stop the db view being a search listener (if it</span>
<a href="#l58.88"></a><span id="l58.88">    *  is one).</span>
<a href="#l58.89"></a><span id="l58.89">    */</span>
<a href="#l58.90"></a><span id="l58.90" class="difflineminus">-  dissociateView: function(aDBView) {</span>
<a href="#l58.91"></a><span id="l58.91" class="difflineplus">+  dissociateView: function SearchSpec_dissociateView(aDBView) {</span>
<a href="#l58.92"></a><span id="l58.92">     // If we are currently searching, interrupt the search.  This will</span>
<a href="#l58.93"></a><span id="l58.93">     //  immediately notify the listeners that the search is done with and</span>
<a href="#l58.94"></a><span id="l58.94">     //  clear the searching flag for us.</span>
<a href="#l58.95"></a><span id="l58.95">     if (this.owner.searching)</span>
<a href="#l58.96"></a><span id="l58.96">       this.session.interruptSearch();</span>
<a href="#l58.97"></a><span id="l58.97"> </span>
<a href="#l58.98"></a><span id="l58.98">     if (this._listenersRegistered) {</span>
<a href="#l58.99"></a><span id="l58.99">       this._session.unregisterListener(this._sessionListener);</span>
<a href="#l58.100"></a><span id="l58.100" class="difflineat">@@ -183,77 +204,109 @@ SearchSpec.prototype = {</span>
<a href="#l58.101"></a><span id="l58.101">   set viewTerms(aViewTerms) {</span>
<a href="#l58.102"></a><span id="l58.102">     if (aViewTerms)</span>
<a href="#l58.103"></a><span id="l58.103">       this._viewTerms = this._groupifyTerms(aViewTerms);</span>
<a href="#l58.104"></a><span id="l58.104">     else</span>
<a href="#l58.105"></a><span id="l58.105">       this._viewTerms = null;</span>
<a href="#l58.106"></a><span id="l58.106">     this.owner._applyViewChanges();</span>
<a href="#l58.107"></a><span id="l58.107">   },</span>
<a href="#l58.108"></a><span id="l58.108">   /**</span>
<a href="#l58.109"></a><span id="l58.109" class="difflineplus">+   * @return the view terms currently in effect.  Do not mutate this.</span>
<a href="#l58.110"></a><span id="l58.110" class="difflineplus">+   */</span>
<a href="#l58.111"></a><span id="l58.111" class="difflineplus">+  get viewTerms() {</span>
<a href="#l58.112"></a><span id="l58.112" class="difflineplus">+    return this._viewTerms;</span>
<a href="#l58.113"></a><span id="l58.113" class="difflineplus">+  },</span>
<a href="#l58.114"></a><span id="l58.114" class="difflineplus">+  /**</span>
<a href="#l58.115"></a><span id="l58.115">    * Set search terms that are defined by the 'virtual folder' definition.  This</span>
<a href="#l58.116"></a><span id="l58.116">    *  could also be thought of as the 'saved search' part of a saved search.</span>
<a href="#l58.117"></a><span id="l58.117">    *</span>
<a href="#l58.118"></a><span id="l58.118">    * @param aVirtualFolderTerms The list of terms.  We make our own copy and</span>
<a href="#l58.119"></a><span id="l58.119">    *     do not mutate yours.</span>
<a href="#l58.120"></a><span id="l58.120">    */</span>
<a href="#l58.121"></a><span id="l58.121">   set virtualFolderTerms(aVirtualFolderTerms) {</span>
<a href="#l58.122"></a><span id="l58.122">     if (aVirtualFolderTerms)</span>
<a href="#l58.123"></a><span id="l58.123">       // we need to clone virtual folder terms because they are pulled from a</span>
<a href="#l58.124"></a><span id="l58.124">       //  persistent location rather than created on demand</span>
<a href="#l58.125"></a><span id="l58.125">       this._virtualFolderTerms = this._groupifyTerms(aVirtualFolderTerms,</span>
<a href="#l58.126"></a><span id="l58.126">                                                      true);</span>
<a href="#l58.127"></a><span id="l58.127">     else</span>
<a href="#l58.128"></a><span id="l58.128">       this._virtualFolderTerms = null;</span>
<a href="#l58.129"></a><span id="l58.129">     this.owner._applyViewChanges();</span>
<a href="#l58.130"></a><span id="l58.130">   },</span>
<a href="#l58.131"></a><span id="l58.131" class="difflineplus">+  /**</span>
<a href="#l58.132"></a><span id="l58.132" class="difflineplus">+   * @return the Virtual folder terms currently in effect.  Do not mutate this.</span>
<a href="#l58.133"></a><span id="l58.133" class="difflineplus">+   */</span>
<a href="#l58.134"></a><span id="l58.134" class="difflineplus">+  get virtualFolderTerms() {</span>
<a href="#l58.135"></a><span id="l58.135" class="difflineplus">+    return this._virtualFolderTerms;</span>
<a href="#l58.136"></a><span id="l58.136" class="difflineplus">+  },</span>
<a href="#l58.137"></a><span id="l58.137"> </span>
<a href="#l58.138"></a><span id="l58.138">   /**</span>
<a href="#l58.139"></a><span id="l58.139">    * Set the terms that the user is explicitly searching on.  These will be</span>
<a href="#l58.140"></a><span id="l58.140">    *  augmented with the 'context' search terms potentially provided by</span>
<a href="#l58.141"></a><span id="l58.141">    *  viewTerms and virtualFolderTerms.</span>
<a href="#l58.142"></a><span id="l58.142">    *</span>
<a href="#l58.143"></a><span id="l58.143">    * @param aUserTerms The list of terms.  We take ownership and mutate it.</span>
<a href="#l58.144"></a><span id="l58.144">    */</span>
<a href="#l58.145"></a><span id="l58.145">   set userTerms(aUserTerms) {</span>
<a href="#l58.146"></a><span id="l58.146">     if (aUserTerms)</span>
<a href="#l58.147"></a><span id="l58.147">       this._userTerms = this._groupifyTerms(aUserTerms);</span>
<a href="#l58.148"></a><span id="l58.148">     else</span>
<a href="#l58.149"></a><span id="l58.149">       this._userTerms = null;</span>
<a href="#l58.150"></a><span id="l58.150">     this.owner._applyViewChanges();</span>
<a href="#l58.151"></a><span id="l58.151">   },</span>
<a href="#l58.152"></a><span id="l58.152">   /**</span>
<a href="#l58.153"></a><span id="l58.153" class="difflineplus">+   * @return the user terms currently in effect as set via the |userTerms|</span>
<a href="#l58.154"></a><span id="l58.154" class="difflineplus">+   *     attribute or via the |quickSearch| method.  Do not mutate this.</span>
<a href="#l58.155"></a><span id="l58.155" class="difflineplus">+   */</span>
<a href="#l58.156"></a><span id="l58.156" class="difflineplus">+  get userTerms() {</span>
<a href="#l58.157"></a><span id="l58.157" class="difflineplus">+    return this._userTerms;</span>
<a href="#l58.158"></a><span id="l58.158" class="difflineplus">+  },</span>
<a href="#l58.159"></a><span id="l58.159" class="difflineplus">+  /**</span>
<a href="#l58.160"></a><span id="l58.160">    * Apply a quick-search for the given search mode using the given search</span>
<a href="#l58.161"></a><span id="l58.161">    *  string.  All of the hard work is done by</span>
<a href="#l58.162"></a><span id="l58.162">    *  QuickSearchManager.createSearchTerms; we mainly just assign the result to</span>
<a href="#l58.163"></a><span id="l58.163">    *  our userTerms property.</span>
<a href="#l58.164"></a><span id="l58.164">    *</span>
<a href="#l58.165"></a><span id="l58.165">    * @param aSearchMode One of the QuickSearchConstants.kQuickSearch* search</span>
<a href="#l58.166"></a><span id="l58.166">    *     mode constants specifying what parts of the message to search on.</span>
<a href="#l58.167"></a><span id="l58.167">    * @param aSearchString The search string, consisting of sub-strings delimited</span>
<a href="#l58.168"></a><span id="l58.168">    *     by '|' to be OR-ed together.  Given the string &quot;foo&quot; we search for</span>
<a href="#l58.169"></a><span id="l58.169">    *     messages containing &quot;foo&quot;.  Given the string &quot;foo|bar&quot;, we search for</span>
<a href="#l58.170"></a><span id="l58.170">    *     messages containing &quot;foo&quot; or &quot;bar&quot;.</span>
<a href="#l58.171"></a><span id="l58.171">    */</span>
<a href="#l58.172"></a><span id="l58.172">   quickSearch: function SearchSpec_quickSearch(aSearchMode, aSearchString) {</span>
<a href="#l58.173"></a><span id="l58.173">     this.userTerms = QuickSearchManager.createSearchTerms(</span>
<a href="#l58.174"></a><span id="l58.174" class="difflineminus">-      this._session, aSearchMode, aSearchString);</span>
<a href="#l58.175"></a><span id="l58.175" class="difflineplus">+      this.session, aSearchMode, aSearchString);</span>
<a href="#l58.176"></a><span id="l58.176">   },</span>
<a href="#l58.177"></a><span id="l58.177"> </span>
<a href="#l58.178"></a><span id="l58.178">   clear: function SearchSpec_clear() {</span>
<a href="#l58.179"></a><span id="l58.179">     if (this.hasSearchTerms) {</span>
<a href="#l58.180"></a><span id="l58.180">       this._viewTerms = null;</span>
<a href="#l58.181"></a><span id="l58.181">       this._virtualFolderTerms = null;</span>
<a href="#l58.182"></a><span id="l58.182">       this._userTerms = null;</span>
<a href="#l58.183"></a><span id="l58.183">       this.owner._applyViewChanges();</span>
<a href="#l58.184"></a><span id="l58.184">     }</span>
<a href="#l58.185"></a><span id="l58.185">   },</span>
<a href="#l58.186"></a><span id="l58.186"> </span>
<a href="#l58.187"></a><span id="l58.187">   get onlineSearch() {</span>
<a href="#l58.188"></a><span id="l58.188">     return this._onlineSearch;</span>
<a href="#l58.189"></a><span id="l58.189">   },</span>
<a href="#l58.190"></a><span id="l58.190" class="difflineplus">+  /**</span>
<a href="#l58.191"></a><span id="l58.191" class="difflineplus">+   * Virtual folders have a concept of 'online search' which affects the logic</span>
<a href="#l58.192"></a><span id="l58.192" class="difflineplus">+   *  in updateSession that builds our search scopes.  If onlineSearch is false,</span>
<a href="#l58.193"></a><span id="l58.193" class="difflineplus">+   *  then when displaying the virtual folder unaffected by mail views or quick</span>
<a href="#l58.194"></a><span id="l58.194" class="difflineplus">+   *  searches, we will most definitely perform an offline search.  If</span>
<a href="#l58.195"></a><span id="l58.195" class="difflineplus">+   *  onlineSearch is true, we will perform an online search only for folders</span>
<a href="#l58.196"></a><span id="l58.196" class="difflineplus">+   *  which are not available offline and for which the server is configured</span>
<a href="#l58.197"></a><span id="l58.197" class="difflineplus">+   *  to have an online 'searchScope'.</span>
<a href="#l58.198"></a><span id="l58.198" class="difflineplus">+   * When mail views or quick searches are in effect our search is always</span>
<a href="#l58.199"></a><span id="l58.199" class="difflineplus">+   *  offline unless the only way to satisfy the needs of the constraints is an</span>
<a href="#l58.200"></a><span id="l58.200" class="difflineplus">+   *  online search (read: the message body is required but not available</span>
<a href="#l58.201"></a><span id="l58.201" class="difflineplus">+   *  offline.)</span>
<a href="#l58.202"></a><span id="l58.202" class="difflineplus">+   */</span>
<a href="#l58.203"></a><span id="l58.203">   set onlineSearch(aOnlineSearch) {</span>
<a href="#l58.204"></a><span id="l58.204">     this._onlineSearch = aOnlineSearch;</span>
<a href="#l58.205"></a><span id="l58.205">   },</span>
<a href="#l58.206"></a><span id="l58.206"> </span>
<a href="#l58.207"></a><span id="l58.207">   /**</span>
<a href="#l58.208"></a><span id="l58.208">    * Populate the search session using viewTerms, virtualFolderTerms, and</span>
<a href="#l58.209"></a><span id="l58.209">    *  userTerms.  The way this works is that each of the 'context' sets of</span>
<a href="#l58.210"></a><span id="l58.210">    *  terms gets wrapped into a group which is boolean anded together with</span>
<a href="#l58.211"></a><span id="l58.211" class="difflineat">@@ -261,53 +314,82 @@ SearchSpec.prototype = {</span>
<a href="#l58.212"></a><span id="l58.212">    */</span>
<a href="#l58.213"></a><span id="l58.213">   updateSession: function SearchSpec_applySearch() {</span>
<a href="#l58.214"></a><span id="l58.214">     let session = this.session;</span>
<a href="#l58.215"></a><span id="l58.215"> </span>
<a href="#l58.216"></a><span id="l58.216">     // clear out our current terms and scope</span>
<a href="#l58.217"></a><span id="l58.217">     session.searchTerms.QueryInterface(Ci.nsISupportsArray).Clear();</span>
<a href="#l58.218"></a><span id="l58.218">     session.clearScopes();</span>
<a href="#l58.219"></a><span id="l58.219"> </span>
<a href="#l58.220"></a><span id="l58.220" class="difflineplus">+    // the scope logic needs to know if any terms look at the body attribute.</span>
<a href="#l58.221"></a><span id="l58.221" class="difflineplus">+    let haveBodyTerm = false;</span>
<a href="#l58.222"></a><span id="l58.222" class="difflineplus">+</span>
<a href="#l58.223"></a><span id="l58.223">     // -- apply terms</span>
<a href="#l58.224"></a><span id="l58.224">     if (this._virtualFolderTerms) {</span>
<a href="#l58.225"></a><span id="l58.225">       for each (let term in fixIterator(this._virtualFolderTerms,</span>
<a href="#l58.226"></a><span id="l58.226">                                         nsIMsgSearchTerm)) {</span>
<a href="#l58.227"></a><span id="l58.227" class="difflineplus">+        if (term.attrib == nsMsgSearchAttrib.Body)</span>
<a href="#l58.228"></a><span id="l58.228" class="difflineplus">+          haveBodyTerm = true;</span>
<a href="#l58.229"></a><span id="l58.229">         session.appendTerm(term);</span>
<a href="#l58.230"></a><span id="l58.230">       }</span>
<a href="#l58.231"></a><span id="l58.231">     }</span>
<a href="#l58.232"></a><span id="l58.232"> </span>
<a href="#l58.233"></a><span id="l58.233">     if (this._viewTerms) {</span>
<a href="#l58.234"></a><span id="l58.234">       for each (let term in fixIterator(this._viewTerms,</span>
<a href="#l58.235"></a><span id="l58.235">                                         nsIMsgSearchTerm)) {</span>
<a href="#l58.236"></a><span id="l58.236" class="difflineplus">+        if (term.attrib == nsMsgSearchAttrib.Body)</span>
<a href="#l58.237"></a><span id="l58.237" class="difflineplus">+          haveBodyTerm = true;</span>
<a href="#l58.238"></a><span id="l58.238">         session.appendTerm(term);</span>
<a href="#l58.239"></a><span id="l58.239">       }</span>
<a href="#l58.240"></a><span id="l58.240">     }</span>
<a href="#l58.241"></a><span id="l58.241"> </span>
<a href="#l58.242"></a><span id="l58.242">     if (this._userTerms) {</span>
<a href="#l58.243"></a><span id="l58.243">       for each (let term in fixIterator(this._userTerms,</span>
<a href="#l58.244"></a><span id="l58.244">                                         nsIMsgSearchTerm)) {</span>
<a href="#l58.245"></a><span id="l58.245" class="difflineplus">+        if (term.attrib == nsMsgSearchAttrib.Body)</span>
<a href="#l58.246"></a><span id="l58.246" class="difflineplus">+          haveBodyTerm = true;</span>
<a href="#l58.247"></a><span id="l58.247">         session.appendTerm(term);</span>
<a href="#l58.248"></a><span id="l58.248">       }</span>
<a href="#l58.249"></a><span id="l58.249">     }</span>
<a href="#l58.250"></a><span id="l58.250"> </span>
<a href="#l58.251"></a><span id="l58.251">     // -- apply scopes</span>
<a href="#l58.252"></a><span id="l58.252" class="difflineminus">-    // if the folder is local, the folder is marked for offline access, or we</span>
<a href="#l58.253"></a><span id="l58.253" class="difflineminus">-    //  are offline, then perform an offline search.</span>
<a href="#l58.254"></a><span id="l58.254" class="difflineminus">-    // otherwise, rely on the server's search scope. if we were more thorough,</span>
<a href="#l58.255"></a><span id="l58.255" class="difflineminus">-    //  we could try and figure out what operands cause us to fall back toward</span>
<a href="#l58.256"></a><span id="l58.256" class="difflineminus">-    //  online usage.  (quick search previously specialized this by virtue of</span>
<a href="#l58.257"></a><span id="l58.257" class="difflineminus">-    //  having a very limited set of terms in use.)</span>
<a href="#l58.258"></a><span id="l58.258" class="difflineplus">+    // We are filtering if we have mail view terms or user terms.  When</span>
<a href="#l58.259"></a><span id="l58.259" class="difflineplus">+    //  filtering, we bias towards offline search.  The only time we would use</span>
<a href="#l58.260"></a><span id="l58.260" class="difflineplus">+    //  an online search when filtering is if one of the constraints uses the</span>
<a href="#l58.261"></a><span id="l58.261" class="difflineplus">+    //  body attribute and the folder is not marked for offline access.</span>
<a href="#l58.262"></a><span id="l58.262" class="difflineplus">+    // We are not filtering if we only have virtual folder terms, in which case</span>
<a href="#l58.263"></a><span id="l58.263" class="difflineplus">+    //  we honor the onlineSearch attribute.  This means that we use the</span>
<a href="#l58.264"></a><span id="l58.264" class="difflineplus">+    //  folder's server's searchScope if the folder is not explicitly marked</span>
<a href="#l58.265"></a><span id="l58.265" class="difflineplus">+    //  offline.</span>
<a href="#l58.266"></a><span id="l58.266" class="difflineplus">+    // For further discussion on this choice of logic, please read from:</span>
<a href="#l58.267"></a><span id="l58.267" class="difflineplus">+    //  https://bugzilla.mozilla.org/show_bug.cgi?id=474701#c73</span>
<a href="#l58.268"></a><span id="l58.268" class="difflineplus">+    let filtering = this._virtualFolderTerms == null &amp;&amp;</span>
<a href="#l58.269"></a><span id="l58.269" class="difflineplus">+                    this._viewTerms == null;</span>
<a href="#l58.270"></a><span id="l58.270" class="difflineplus">+</span>
<a href="#l58.271"></a><span id="l58.271">     let ioService = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l58.272"></a><span id="l58.272">                       .getService(Ci.nsIIOService);</span>
<a href="#l58.273"></a><span id="l58.273">     for each (let [, folder] in Iterator(this.owner._underlyingFolders)) {</span>
<a href="#l58.274"></a><span id="l58.274" class="difflineplus">+      // we do not need to check isServer here because _underlyingFolders</span>
<a href="#l58.275"></a><span id="l58.275" class="difflineplus">+      //  filtered it out when it was initialized.</span>
<a href="#l58.276"></a><span id="l58.276" class="difflineplus">+</span>
<a href="#l58.277"></a><span id="l58.277">       let scope;</span>
<a href="#l58.278"></a><span id="l58.278" class="difflineminus">-      if ((folder instanceof nsIMsgLocalMailFolder) ||</span>
<a href="#l58.279"></a><span id="l58.279" class="difflineminus">-        (folder.flags &amp; nsMsgFolderFlags.Offline) ||</span>
<a href="#l58.280"></a><span id="l58.280" class="difflineminus">-          ioService.offline)</span>
<a href="#l58.281"></a><span id="l58.281" class="difflineplus">+      let folderIsOffline = (folder instanceof nsIMsgLocalMailFolder) ||</span>
<a href="#l58.282"></a><span id="l58.282" class="difflineplus">+                            (folder.flags &amp; nsMsgFolderFlags.Offline) ||</span>
<a href="#l58.283"></a><span id="l58.283" class="difflineplus">+                            ioService.offline;</span>
<a href="#l58.284"></a><span id="l58.284" class="difflineplus">+      // To restate the above logic into simpler rules, the scope is definitely</span>
<a href="#l58.285"></a><span id="l58.285" class="difflineplus">+      //  offline if:</span>
<a href="#l58.286"></a><span id="l58.286" class="difflineplus">+      // - Folders available offline always use offline search.</span>
<a href="#l58.287"></a><span id="l58.287" class="difflineplus">+      // - If we are filtering and don't have a body term, use offline search.</span>
<a href="#l58.288"></a><span id="l58.288" class="difflineplus">+      // - If we are not filtering and our virtual folder is not marked for</span>
<a href="#l58.289"></a><span id="l58.289" class="difflineplus">+      //   onlineSearch.</span>
<a href="#l58.290"></a><span id="l58.290" class="difflineplus">+      if (folderIsOffline ||</span>
<a href="#l58.291"></a><span id="l58.291" class="difflineplus">+          (filtering &amp;&amp; !haveBodyTerm) ||</span>
<a href="#l58.292"></a><span id="l58.292" class="difflineplus">+          (!filtering &amp;&amp; !this.onlineSearch))</span>
<a href="#l58.293"></a><span id="l58.293">         scope = nsMsgSearchScope.offlineMail;</span>
<a href="#l58.294"></a><span id="l58.294" class="difflineplus">+      // Otherwise, it's up to the folder's sever's searchScope.</span>
<a href="#l58.295"></a><span id="l58.295">       else</span>
<a href="#l58.296"></a><span id="l58.296">         scope = folder.server.searchScope;</span>
<a href="#l58.297"></a><span id="l58.297">       session.addScopeTerm(scope, folder);</span>
<a href="#l58.298"></a><span id="l58.298">     }</span>
<a href="#l58.299"></a><span id="l58.299">   },</span>
<a href="#l58.300"></a><span id="l58.300"> </span>
<a href="#l58.301"></a><span id="l58.301">   prettyStringOfSearchTerms: function(aSearchTerms) {</span>
<a href="#l58.302"></a><span id="l58.302">     if (aSearchTerms == null)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l59.1"></a><span id="l59.1" class="difflineminus">--- a/mailnews/base/src/virtualFolderWrapper.js</span>
<a href="#l59.2"></a><span id="l59.2" class="difflineplus">+++ b/mailnews/base/src/virtualFolderWrapper.js</span>
<a href="#l59.3"></a><span id="l59.3" class="difflineat">@@ -61,17 +61,19 @@ var VirtualFolderHelper = {</span>
<a href="#l59.4"></a><span id="l59.4">    * If the call to addSubfolder fails (and therefore throws), we will NOT catch</span>
<a href="#l59.5"></a><span id="l59.5">    *  it.</span>
<a href="#l59.6"></a><span id="l59.6">    *</span>
<a href="#l59.7"></a><span id="l59.7">    * @param aFolderName The name of the new folder to create.</span>
<a href="#l59.8"></a><span id="l59.8">    * @param aParentFolder The folder in which to create the search folder.</span>
<a href="#l59.9"></a><span id="l59.9">    * @param aSearchFolders A list of nsIMsgFolders that you want to use as the</span>
<a href="#l59.10"></a><span id="l59.10">    *     sources for the virtual folder OR a string that is the already '|'</span>
<a href="#l59.11"></a><span id="l59.11">    *     delimited list of folder URIs to use.</span>
<a href="#l59.12"></a><span id="l59.12" class="difflineminus">-   * @param aSearchTerms The search terms to use for the virtual folder.</span>
<a href="#l59.13"></a><span id="l59.13" class="difflineplus">+   * @param aSearchTerms The search terms to use for the virtual folder.  This</span>
<a href="#l59.14"></a><span id="l59.14" class="difflineplus">+   *     should be a JS list/nsIMutableArray/nsISupportsArray of</span>
<a href="#l59.15"></a><span id="l59.15" class="difflineplus">+   *     nsIMsgSearchTermbs.</span>
<a href="#l59.16"></a><span id="l59.16">    * @param aOnlineSearch Should the search attempt to use the server's search</span>
<a href="#l59.17"></a><span id="l59.17">    *     capabilities when possible and appropriate?</span>
<a href="#l59.18"></a><span id="l59.18">    *</span>
<a href="#l59.19"></a><span id="l59.19">    * @return The VirtualFolderWrapper wrapping the newly created folder.  You</span>
<a href="#l59.20"></a><span id="l59.20">    *     would probably only want this for its virtualFolder attribute which has</span>
<a href="#l59.21"></a><span id="l59.21">    *     the nsIMsgFolder we created.  Be careful about accessing any of the</span>
<a href="#l59.22"></a><span id="l59.22">    *     other attributes, as they will bring its message database back to life.</span>
<a href="#l59.23"></a><span id="l59.23">    */</span>
<a href="#l59.24"></a><span id="l59.24" class="difflineat">@@ -160,70 +162,135 @@ VirtualFolderWrapper.prototype = {</span>
<a href="#l59.25"></a><span id="l59.25">       this.dbFolderInfo.getCharProperty(&quot;searchFolderUri&quot;).split(&quot;|&quot;);</span>
<a href="#l59.26"></a><span id="l59.26">     let folders = [];</span>
<a href="#l59.27"></a><span id="l59.27">     for each (let [, folderURI] in Iterator(virtualFolderUris)) {</span>
<a href="#l59.28"></a><span id="l59.28">       folders.push(rdfService.GetResource(folderURI)</span>
<a href="#l59.29"></a><span id="l59.29">                              .QueryInterface(Ci.nsIMsgFolder));</span>
<a href="#l59.30"></a><span id="l59.30">     }</span>
<a href="#l59.31"></a><span id="l59.31">     return folders;</span>
<a href="#l59.32"></a><span id="l59.32">   },</span>
<a href="#l59.33"></a><span id="l59.33" class="difflineplus">+  /**</span>
<a href="#l59.34"></a><span id="l59.34" class="difflineplus">+   * Set the search folders that back this virtual folder.</span>
<a href="#l59.35"></a><span id="l59.35" class="difflineplus">+   *</span>
<a href="#l59.36"></a><span id="l59.36" class="difflineplus">+   * @param aFolders Either a &quot;|&quot;-delimited string of folder URIs or a list of</span>
<a href="#l59.37"></a><span id="l59.37" class="difflineplus">+   *     nsIMsgFolders that fixIterator can traverse (JS array/nsIMutableArray/</span>
<a href="#l59.38"></a><span id="l59.38" class="difflineplus">+   *     nsISupportsArray).</span>
<a href="#l59.39"></a><span id="l59.39" class="difflineplus">+   */</span>
<a href="#l59.40"></a><span id="l59.40">   set searchFolders(aFolders) {</span>
<a href="#l59.41"></a><span id="l59.41">     if (typeof(aFolders) == &quot;string&quot;) {</span>
<a href="#l59.42"></a><span id="l59.42">       this.dbFolderInfo.setCharProperty(&quot;searchFolderUri&quot;, aFolders);</span>
<a href="#l59.43"></a><span id="l59.43">     }</span>
<a href="#l59.44"></a><span id="l59.44">     else {</span>
<a href="#l59.45"></a><span id="l59.45" class="difflineminus">-      let uris = [folder.URI for each ([, folder] in Iterator(aFolders))];</span>
<a href="#l59.46"></a><span id="l59.46" class="difflineplus">+      let uris = [folder.URI for each (folder in fixIterator(aFolders,</span>
<a href="#l59.47"></a><span id="l59.47" class="difflineplus">+                                                             Ci.nsIMsgFolder))];</span>
<a href="#l59.48"></a><span id="l59.48">       this.dbFolderInfo.setCharProperty(&quot;searchFolderUri&quot;, uris.join(&quot;|&quot;));</span>
<a href="#l59.49"></a><span id="l59.49">     }</span>
<a href="#l59.50"></a><span id="l59.50">   },</span>
<a href="#l59.51"></a><span id="l59.51"> </span>
<a href="#l59.52"></a><span id="l59.52">   /**</span>
<a href="#l59.53"></a><span id="l59.53" class="difflineplus">+   * @return a &quot;|&quot;-delimited string containing the URIs of the folders that back</span>
<a href="#l59.54"></a><span id="l59.54" class="difflineplus">+   *     this virtual folder.</span>
<a href="#l59.55"></a><span id="l59.55" class="difflineplus">+   */</span>
<a href="#l59.56"></a><span id="l59.56" class="difflineplus">+  get searchFolderURIs() {</span>
<a href="#l59.57"></a><span id="l59.57" class="difflineplus">+    return this.dbFolderInfo.getCharProperty(&quot;searchFolderUri&quot;);</span>
<a href="#l59.58"></a><span id="l59.58" class="difflineplus">+  },</span>
<a href="#l59.59"></a><span id="l59.59" class="difflineplus">+</span>
<a href="#l59.60"></a><span id="l59.60" class="difflineplus">+  /**</span>
<a href="#l59.61"></a><span id="l59.61">    * @return the list of search terms that define this virtual folder.</span>
<a href="#l59.62"></a><span id="l59.62">    */</span>
<a href="#l59.63"></a><span id="l59.63">   get searchTerms() {</span>
<a href="#l59.64"></a><span id="l59.64" class="difflineplus">+    return this.searchTermsSession.searchTerms;</span>
<a href="#l59.65"></a><span id="l59.65" class="difflineplus">+  },</span>
<a href="#l59.66"></a><span id="l59.66" class="difflineplus">+  /**</span>
<a href="#l59.67"></a><span id="l59.67" class="difflineplus">+   * @return a newly created filter with the search terms loaded into it that</span>
<a href="#l59.68"></a><span id="l59.68" class="difflineplus">+   *     define this virtual folder.  The filter is apparently useful as an</span>
<a href="#l59.69"></a><span id="l59.69" class="difflineplus">+   *     nsIMsgSearchSession stand-in to some code.</span>
<a href="#l59.70"></a><span id="l59.70" class="difflineplus">+   */</span>
<a href="#l59.71"></a><span id="l59.71" class="difflineplus">+  get searchTermsSession() {</span>
<a href="#l59.72"></a><span id="l59.72">     let filterService =</span>
<a href="#l59.73"></a><span id="l59.73">       Cc[&quot;@mozilla.org/messenger/services/filters;1&quot;]</span>
<a href="#l59.74"></a><span id="l59.74">         .getService(Ci.nsIMsgFilterService);</span>
<a href="#l59.75"></a><span id="l59.75">     // Temporary means it doesn't get exposed to the UI and doesn't get saved to</span>
<a href="#l59.76"></a><span id="l59.76">     //  disk.  Which is good, because this is just a trick to parse the string</span>
<a href="#l59.77"></a><span id="l59.77">     //  into search terms.</span>
<a href="#l59.78"></a><span id="l59.78">     let filterList = filterService.getTempFilterList(this.virtualFolder);</span>
<a href="#l59.79"></a><span id="l59.79">     let tempFilter = filterList.createFilter(&quot;temp&quot;);</span>
<a href="#l59.80"></a><span id="l59.80">     filterList.parseCondition(tempFilter, this.searchString);</span>
<a href="#l59.81"></a><span id="l59.81" class="difflineminus">-    return tempFilter.searchTerms;</span>
<a href="#l59.82"></a><span id="l59.82" class="difflineplus">+    return tempFilter;</span>
<a href="#l59.83"></a><span id="l59.83">   },</span>
<a href="#l59.84"></a><span id="l59.84" class="difflineplus">+</span>
<a href="#l59.85"></a><span id="l59.85">   /**</span>
<a href="#l59.86"></a><span id="l59.86">    * Set the search string for this virtual folder to the stringified version of</span>
<a href="#l59.87"></a><span id="l59.87" class="difflineminus">-   *  the provided list of search terms.</span>
<a href="#l59.88"></a><span id="l59.88" class="difflineplus">+   *  the provided list of nsIMsgSearchTerm search terms.  If you already have</span>
<a href="#l59.89"></a><span id="l59.89" class="difflineplus">+   *  a strinigified version of the search constraint, just set |searchString|</span>
<a href="#l59.90"></a><span id="l59.90" class="difflineplus">+   *  directly.</span>
<a href="#l59.91"></a><span id="l59.91" class="difflineplus">+   *</span>
<a href="#l59.92"></a><span id="l59.92" class="difflineplus">+   * @param aTerms Some collection that fixIterator can traverse.  A JS list or</span>
<a href="#l59.93"></a><span id="l59.93" class="difflineplus">+   *     XPCOM array (nsIMutableArray or nsISupportsArray) should work.</span>
<a href="#l59.94"></a><span id="l59.94">    */</span>
<a href="#l59.95"></a><span id="l59.95">   set searchTerms(aTerms) {</span>
<a href="#l59.96"></a><span id="l59.96">     let condition = &quot;&quot;;</span>
<a href="#l59.97"></a><span id="l59.97">     for (let term in fixIterator(aTerms, Ci.nsIMsgSearchTerm)) {</span>
<a href="#l59.98"></a><span id="l59.98">       if (condition.length)</span>
<a href="#l59.99"></a><span id="l59.99">         condition += &quot; &quot;;</span>
<a href="#l59.100"></a><span id="l59.100">       if (term.matchAll) {</span>
<a href="#l59.101"></a><span id="l59.101">         condition = &quot;ALL&quot;;</span>
<a href="#l59.102"></a><span id="l59.102">         break;</span>
<a href="#l59.103"></a><span id="l59.103">       }</span>
<a href="#l59.104"></a><span id="l59.104">       condition += (term.booleanAnd) ? &quot;AND (&quot; : &quot;OR (&quot;;</span>
<a href="#l59.105"></a><span id="l59.105">       condition += term.termAsString + &quot;)&quot;;</span>
<a href="#l59.106"></a><span id="l59.106">     }</span>
<a href="#l59.107"></a><span id="l59.107">     this.searchString = condition;</span>
<a href="#l59.108"></a><span id="l59.108">   },</span>
<a href="#l59.109"></a><span id="l59.109"> </span>
<a href="#l59.110"></a><span id="l59.110" class="difflineplus">+  /**</span>
<a href="#l59.111"></a><span id="l59.111" class="difflineplus">+   * @return the set of search terms that define this virtual folder as a</span>
<a href="#l59.112"></a><span id="l59.112" class="difflineplus">+   *     string.  You may prefer to use |searchTerms| which converts them</span>
<a href="#l59.113"></a><span id="l59.113" class="difflineplus">+   *     into a list of nsIMsgSearchTerms instead.</span>
<a href="#l59.114"></a><span id="l59.114" class="difflineplus">+   */</span>
<a href="#l59.115"></a><span id="l59.115">   get searchString() {</span>
<a href="#l59.116"></a><span id="l59.116">     return this.dbFolderInfo.getCharProperty(&quot;searchStr&quot;);</span>
<a href="#l59.117"></a><span id="l59.117">   },</span>
<a href="#l59.118"></a><span id="l59.118" class="difflineplus">+  /**</span>
<a href="#l59.119"></a><span id="l59.119" class="difflineplus">+   * Set the search that defines this virtual folder from a string.  If you have</span>
<a href="#l59.120"></a><span id="l59.120" class="difflineplus">+   *  a list of nsIMsgSearchTerms, you should use |searchTerms| instead.</span>
<a href="#l59.121"></a><span id="l59.121" class="difflineplus">+   */</span>
<a href="#l59.122"></a><span id="l59.122">   set searchString(aSearchString) {</span>
<a href="#l59.123"></a><span id="l59.123">     this.dbFolderInfo.setCharProperty(&quot;searchStr&quot;, aSearchString);</span>
<a href="#l59.124"></a><span id="l59.124">   },</span>
<a href="#l59.125"></a><span id="l59.125"> </span>
<a href="#l59.126"></a><span id="l59.126" class="difflineplus">+  /**</span>
<a href="#l59.127"></a><span id="l59.127" class="difflineplus">+   * @return whether the virtual folder is configured for online search.</span>
<a href="#l59.128"></a><span id="l59.128" class="difflineplus">+   */</span>
<a href="#l59.129"></a><span id="l59.129">   get onlineSearch() {</span>
<a href="#l59.130"></a><span id="l59.130">     return this.dbFolderInfo.getBooleanProperty(&quot;searchOnline&quot;, false);</span>
<a href="#l59.131"></a><span id="l59.131">   },</span>
<a href="#l59.132"></a><span id="l59.132" class="difflineplus">+  /**</span>
<a href="#l59.133"></a><span id="l59.133" class="difflineplus">+   * Set whether the virtual folder is configured for online search.</span>
<a href="#l59.134"></a><span id="l59.134" class="difflineplus">+   */</span>
<a href="#l59.135"></a><span id="l59.135">   set onlineSearch(aOnlineSearch) {</span>
<a href="#l59.136"></a><span id="l59.136">     this.dbFolderInfo.setBooleanProperty(&quot;searchOnline&quot;, aOnlineSearch);</span>
<a href="#l59.137"></a><span id="l59.137">   },</span>
<a href="#l59.138"></a><span id="l59.138"> </span>
<a href="#l59.139"></a><span id="l59.139" class="difflineplus">+  /**</span>
<a href="#l59.140"></a><span id="l59.140" class="difflineplus">+   * @return the dBFolderInfo associated with the virtual folder directly.  May</span>
<a href="#l59.141"></a><span id="l59.141" class="difflineplus">+   *     be null.  Will cause the message database to be opened, which may have</span>
<a href="#l59.142"></a><span id="l59.142" class="difflineplus">+   *     memory bloat/leak ramifications, so make sure the folder's database was</span>
<a href="#l59.143"></a><span id="l59.143" class="difflineplus">+   *     already going to be opened anyways or that you call</span>
<a href="#l59.144"></a><span id="l59.144" class="difflineplus">+   *     |cleanUpMessageDatabase|.</span>
<a href="#l59.145"></a><span id="l59.145" class="difflineplus">+   */</span>
<a href="#l59.146"></a><span id="l59.146">   get dbFolderInfo() {</span>
<a href="#l59.147"></a><span id="l59.147" class="difflineminus">-    return this.virtualFolder.msgDatabase.dBFolderInfo;</span>
<a href="#l59.148"></a><span id="l59.148" class="difflineplus">+    let msgDatabase = this.virtualFolder.msgDatabase;</span>
<a href="#l59.149"></a><span id="l59.149" class="difflineplus">+    return (msgDatabase &amp;&amp; msgDatabase.dBFolderInfo);</span>
<a href="#l59.150"></a><span id="l59.150" class="difflineplus">+  },</span>
<a href="#l59.151"></a><span id="l59.151" class="difflineplus">+</span>
<a href="#l59.152"></a><span id="l59.152" class="difflineplus">+  /**</span>
<a href="#l59.153"></a><span id="l59.153" class="difflineplus">+   * Avoid memory bloat by making the virtual folder forget about its database.</span>
<a href="#l59.154"></a><span id="l59.154" class="difflineplus">+   *  If the database is actually in use (read: someone is keeping it alive by</span>
<a href="#l59.155"></a><span id="l59.155" class="difflineplus">+   *  having references to it from places other than the nsIMsgFolder), the</span>
<a href="#l59.156"></a><span id="l59.156" class="difflineplus">+   *  folder will be able to re-establish the reference for minimal cost.</span>
<a href="#l59.157"></a><span id="l59.157" class="difflineplus">+   */</span>
<a href="#l59.158"></a><span id="l59.158" class="difflineplus">+  cleanUpMessageDatabase:</span>
<a href="#l59.159"></a><span id="l59.159" class="difflineplus">+      function VirtualFolderWrapper_cleanUpMessageDatabase() {</span>
<a href="#l59.160"></a><span id="l59.160" class="difflineplus">+    this.virtualFolder.msgDatabase.Close(true);</span>
<a href="#l59.161"></a><span id="l59.161" class="difflineplus">+    this.virtualFolder.msgDatabase = null;</span>
<a href="#l59.162"></a><span id="l59.162">   }</span>
<a href="#l59.163"></a><span id="l59.163"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l60.1"></a><span id="l60.1">new file mode 100644</span>
<a href="#l60.2"></a><span id="l60.2" class="difflineminus">--- /dev/null</span>
<a href="#l60.3"></a><span id="l60.3" class="difflineplus">+++ b/mailnews/base/test/unit/test_jsTreeSelection.js</span>
<a href="#l60.4"></a><span id="l60.4" class="difflineat">@@ -0,0 +1,444 @@</span>
<a href="#l60.5"></a><span id="l60.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l60.6"></a><span id="l60.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l60.7"></a><span id="l60.7" class="difflineplus">+ *</span>
<a href="#l60.8"></a><span id="l60.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l60.9"></a><span id="l60.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l60.10"></a><span id="l60.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l60.11"></a><span id="l60.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l60.12"></a><span id="l60.12" class="difflineplus">+ *</span>
<a href="#l60.13"></a><span id="l60.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l60.14"></a><span id="l60.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l60.15"></a><span id="l60.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l60.16"></a><span id="l60.16" class="difflineplus">+ * License.</span>
<a href="#l60.17"></a><span id="l60.17" class="difflineplus">+ *</span>
<a href="#l60.18"></a><span id="l60.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l60.19"></a><span id="l60.19" class="difflineplus">+ *</span>
<a href="#l60.20"></a><span id="l60.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l60.21"></a><span id="l60.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l60.22"></a><span id="l60.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l60.23"></a><span id="l60.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l60.24"></a><span id="l60.24" class="difflineplus">+ *</span>
<a href="#l60.25"></a><span id="l60.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l60.26"></a><span id="l60.26" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l60.27"></a><span id="l60.27" class="difflineplus">+ *</span>
<a href="#l60.28"></a><span id="l60.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l60.29"></a><span id="l60.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l60.30"></a><span id="l60.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l60.31"></a><span id="l60.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l60.32"></a><span id="l60.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l60.33"></a><span id="l60.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l60.34"></a><span id="l60.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l60.35"></a><span id="l60.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l60.36"></a><span id="l60.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l60.37"></a><span id="l60.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l60.38"></a><span id="l60.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l60.39"></a><span id="l60.39" class="difflineplus">+ *</span>
<a href="#l60.40"></a><span id="l60.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l60.41"></a><span id="l60.41" class="difflineplus">+</span>
<a href="#l60.42"></a><span id="l60.42" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/jsTreeSelection.js&quot;);</span>
<a href="#l60.43"></a><span id="l60.43" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l60.44"></a><span id="l60.44" class="difflineplus">+</span>
<a href="#l60.45"></a><span id="l60.45" class="difflineplus">+var fakeView = {</span>
<a href="#l60.46"></a><span id="l60.46" class="difflineplus">+  rowCount: 101,</span>
<a href="#l60.47"></a><span id="l60.47" class="difflineplus">+  selectionChanged: function() {</span>
<a href="#l60.48"></a><span id="l60.48" class="difflineplus">+  },</span>
<a href="#l60.49"></a><span id="l60.49" class="difflineplus">+  QueryInterface: XPCOMUtils.generateQI(</span>
<a href="#l60.50"></a><span id="l60.50" class="difflineplus">+    [Ci.nsITreeView]),</span>
<a href="#l60.51"></a><span id="l60.51" class="difflineplus">+};</span>
<a href="#l60.52"></a><span id="l60.52" class="difflineplus">+</span>
<a href="#l60.53"></a><span id="l60.53" class="difflineplus">+var fakeBox = {</span>
<a href="#l60.54"></a><span id="l60.54" class="difflineplus">+  view: fakeView,</span>
<a href="#l60.55"></a><span id="l60.55" class="difflineplus">+  invalidate: function() {},</span>
<a href="#l60.56"></a><span id="l60.56" class="difflineplus">+  invalidateRow: function() {},</span>
<a href="#l60.57"></a><span id="l60.57" class="difflineplus">+  QueryInterface: XPCOMUtils.generateQI(</span>
<a href="#l60.58"></a><span id="l60.58" class="difflineplus">+    [Ci.nsITreeBoxObject]),</span>
<a href="#l60.59"></a><span id="l60.59" class="difflineplus">+};</span>
<a href="#l60.60"></a><span id="l60.60" class="difflineplus">+</span>
<a href="#l60.61"></a><span id="l60.61" class="difflineplus">+var sel = new JSTreeSelection(fakeBox);</span>
<a href="#l60.62"></a><span id="l60.62" class="difflineplus">+</span>
<a href="#l60.63"></a><span id="l60.63" class="difflineplus">+function bad_ranges(aMsg, aExpected) {</span>
<a href="#l60.64"></a><span id="l60.64" class="difflineplus">+  let s = &quot;\x1b[1;31m!!! BAD RANGES: &quot; + aMsg + &quot;\n&quot;;</span>
<a href="#l60.65"></a><span id="l60.65" class="difflineplus">+  s += &quot;Selection ranges: &quot; + sel._ranges.length + &quot;:&quot;;</span>
<a href="#l60.66"></a><span id="l60.66" class="difflineplus">+  for each (let [,[low,high]] in Iterator(sel._ranges)) {</span>
<a href="#l60.67"></a><span id="l60.67" class="difflineplus">+    s += &quot; &quot; + low + &quot;-&quot; + high;</span>
<a href="#l60.68"></a><span id="l60.68" class="difflineplus">+  }</span>
<a href="#l60.69"></a><span id="l60.69" class="difflineplus">+</span>
<a href="#l60.70"></a><span id="l60.70" class="difflineplus">+  s += &quot;\nExpected ranges: &quot; + aExpected.length + &quot;:&quot;;</span>
<a href="#l60.71"></a><span id="l60.71" class="difflineplus">+  for (let i = 0; i &lt; aExpected.length; i++) {</span>
<a href="#l60.72"></a><span id="l60.72" class="difflineplus">+    s += &quot; &quot; + aExpected[i][0] + &quot;-&quot; + aExpected[i][1];</span>
<a href="#l60.73"></a><span id="l60.73" class="difflineplus">+  }</span>
<a href="#l60.74"></a><span id="l60.74" class="difflineplus">+</span>
<a href="#l60.75"></a><span id="l60.75" class="difflineplus">+  s += &quot;\x1b[0m\n&quot;;</span>
<a href="#l60.76"></a><span id="l60.76" class="difflineplus">+</span>
<a href="#l60.77"></a><span id="l60.77" class="difflineplus">+  dump(s);</span>
<a href="#l60.78"></a><span id="l60.78" class="difflineplus">+  do_throw(aMsg);</span>
<a href="#l60.79"></a><span id="l60.79" class="difflineplus">+}</span>
<a href="#l60.80"></a><span id="l60.80" class="difflineplus">+</span>
<a href="#l60.81"></a><span id="l60.81" class="difflineplus">+function assert_selection_ranges() {</span>
<a href="#l60.82"></a><span id="l60.82" class="difflineplus">+  if (sel._ranges.length != arguments.length)</span>
<a href="#l60.83"></a><span id="l60.83" class="difflineplus">+    bad_ranges(&quot;Wrong number of ranges!&quot;, arguments);</span>
<a href="#l60.84"></a><span id="l60.84" class="difflineplus">+</span>
<a href="#l60.85"></a><span id="l60.85" class="difflineplus">+  let i = 0;</span>
<a href="#l60.86"></a><span id="l60.86" class="difflineplus">+  let ourCount = 0;</span>
<a href="#l60.87"></a><span id="l60.87" class="difflineplus">+  for each (let [,[slow,shigh]] in Iterator(sel._ranges)) {</span>
<a href="#l60.88"></a><span id="l60.88" class="difflineplus">+    let [dlow, dhigh] = arguments[i++];</span>
<a href="#l60.89"></a><span id="l60.89" class="difflineplus">+    if (dlow != slow || dhigh != shigh)</span>
<a href="#l60.90"></a><span id="l60.90" class="difflineplus">+      bad_ranges(&quot;Range mis-match on index &quot; + i, arguments);</span>
<a href="#l60.91"></a><span id="l60.91" class="difflineplus">+    ourCount += shigh - slow + 1;</span>
<a href="#l60.92"></a><span id="l60.92" class="difflineplus">+  }</span>
<a href="#l60.93"></a><span id="l60.93" class="difflineplus">+</span>
<a href="#l60.94"></a><span id="l60.94" class="difflineplus">+  if (ourCount != sel.count)</span>
<a href="#l60.95"></a><span id="l60.95" class="difflineplus">+    bad_ranges(&quot;Count was wrong! We counted &quot; + ourCount + &quot; but they say &quot; +</span>
<a href="#l60.96"></a><span id="l60.96" class="difflineplus">+               sel.count, arguments);</span>
<a href="#l60.97"></a><span id="l60.97" class="difflineplus">+}</span>
<a href="#l60.98"></a><span id="l60.98" class="difflineplus">+var asr = assert_selection_ranges;</span>
<a href="#l60.99"></a><span id="l60.99" class="difflineplus">+</span>
<a href="#l60.100"></a><span id="l60.100" class="difflineplus">+function assert_current_index(aIndex) {</span>
<a href="#l60.101"></a><span id="l60.101" class="difflineplus">+  if (sel.currentIndex != aIndex)</span>
<a href="#l60.102"></a><span id="l60.102" class="difflineplus">+    do_throw(&quot;Current index is wrong! Is &quot; + sel.currentIndex +</span>
<a href="#l60.103"></a><span id="l60.103" class="difflineplus">+             &quot; but should be &quot; + aIndex);</span>
<a href="#l60.104"></a><span id="l60.104" class="difflineplus">+}</span>
<a href="#l60.105"></a><span id="l60.105" class="difflineplus">+var aci = assert_current_index;</span>
<a href="#l60.106"></a><span id="l60.106" class="difflineplus">+</span>
<a href="#l60.107"></a><span id="l60.107" class="difflineplus">+function assert_shift_pivot(aIndex) {</span>
<a href="#l60.108"></a><span id="l60.108" class="difflineplus">+  if (sel.shiftSelectPivot != aIndex)</span>
<a href="#l60.109"></a><span id="l60.109" class="difflineplus">+    do_throw(&quot;Current index is wrong! Is &quot; + sel._shiftSelectPivot +</span>
<a href="#l60.110"></a><span id="l60.110" class="difflineplus">+             &quot; but should be &quot; + aIndex);</span>
<a href="#l60.111"></a><span id="l60.111" class="difflineplus">+}</span>
<a href="#l60.112"></a><span id="l60.112" class="difflineplus">+var asp = assert_shift_pivot;</span>
<a href="#l60.113"></a><span id="l60.113" class="difflineplus">+</span>
<a href="#l60.114"></a><span id="l60.114" class="difflineplus">+function assert_selected(aIndex) {</span>
<a href="#l60.115"></a><span id="l60.115" class="difflineplus">+  if (!sel.isSelected(aIndex))</span>
<a href="#l60.116"></a><span id="l60.116" class="difflineplus">+    do_throw(&quot;Index is not selected but should be: &quot; + aIndex);</span>
<a href="#l60.117"></a><span id="l60.117" class="difflineplus">+}</span>
<a href="#l60.118"></a><span id="l60.118" class="difflineplus">+var asel = assert_selected;</span>
<a href="#l60.119"></a><span id="l60.119" class="difflineplus">+</span>
<a href="#l60.120"></a><span id="l60.120" class="difflineplus">+function assert_not_selected(aIndex) {</span>
<a href="#l60.121"></a><span id="l60.121" class="difflineplus">+  if (sel.isSelected(aIndex))</span>
<a href="#l60.122"></a><span id="l60.122" class="difflineplus">+    do_throw(&quot;Index is selected but should not be: &quot; + aIndex);</span>
<a href="#l60.123"></a><span id="l60.123" class="difflineplus">+}</span>
<a href="#l60.124"></a><span id="l60.124" class="difflineplus">+var ansel = assert_not_selected;</span>
<a href="#l60.125"></a><span id="l60.125" class="difflineplus">+</span>
<a href="#l60.126"></a><span id="l60.126" class="difflineplus">+function run_test() {</span>
<a href="#l60.127"></a><span id="l60.127" class="difflineplus">+  // -- select</span>
<a href="#l60.128"></a><span id="l60.128" class="difflineplus">+  sel.select(1);</span>
<a href="#l60.129"></a><span id="l60.129" class="difflineplus">+  asel(1);</span>
<a href="#l60.130"></a><span id="l60.130" class="difflineplus">+  ansel(0);</span>
<a href="#l60.131"></a><span id="l60.131" class="difflineplus">+  ansel(2);</span>
<a href="#l60.132"></a><span id="l60.132" class="difflineplus">+  asr([1,1]);</span>
<a href="#l60.133"></a><span id="l60.133" class="difflineplus">+  aci(1);</span>
<a href="#l60.134"></a><span id="l60.134" class="difflineplus">+</span>
<a href="#l60.135"></a><span id="l60.135" class="difflineplus">+  sel.select(2);</span>
<a href="#l60.136"></a><span id="l60.136" class="difflineplus">+  asel(2);</span>
<a href="#l60.137"></a><span id="l60.137" class="difflineplus">+  ansel(1);</span>
<a href="#l60.138"></a><span id="l60.138" class="difflineplus">+  ansel(3);</span>
<a href="#l60.139"></a><span id="l60.139" class="difflineplus">+  asr([2,2]);</span>
<a href="#l60.140"></a><span id="l60.140" class="difflineplus">+  aci(2);</span>
<a href="#l60.141"></a><span id="l60.141" class="difflineplus">+</span>
<a href="#l60.142"></a><span id="l60.142" class="difflineplus">+  // -- clearSelection</span>
<a href="#l60.143"></a><span id="l60.143" class="difflineplus">+  sel.clearSelection();</span>
<a href="#l60.144"></a><span id="l60.144" class="difflineplus">+  asr();</span>
<a href="#l60.145"></a><span id="l60.145" class="difflineplus">+  aci(2); // should still be the same...</span>
<a href="#l60.146"></a><span id="l60.146" class="difflineplus">+</span>
<a href="#l60.147"></a><span id="l60.147" class="difflineplus">+  // -- toggleSelect</span>
<a href="#l60.148"></a><span id="l60.148" class="difflineplus">+  // lower fusion</span>
<a href="#l60.149"></a><span id="l60.149" class="difflineplus">+  sel.select(2);</span>
<a href="#l60.150"></a><span id="l60.150" class="difflineplus">+  sel.toggleSelect(1);</span>
<a href="#l60.151"></a><span id="l60.151" class="difflineplus">+  asr([1, 2]);</span>
<a href="#l60.152"></a><span id="l60.152" class="difflineplus">+  aci(1);</span>
<a href="#l60.153"></a><span id="l60.153" class="difflineplus">+</span>
<a href="#l60.154"></a><span id="l60.154" class="difflineplus">+  // upper fusion</span>
<a href="#l60.155"></a><span id="l60.155" class="difflineplus">+  sel.toggleSelect(3);</span>
<a href="#l60.156"></a><span id="l60.156" class="difflineplus">+  asr([1, 3]);</span>
<a href="#l60.157"></a><span id="l60.157" class="difflineplus">+  aci(3);</span>
<a href="#l60.158"></a><span id="l60.158" class="difflineplus">+</span>
<a href="#l60.159"></a><span id="l60.159" class="difflineplus">+  // splitting</span>
<a href="#l60.160"></a><span id="l60.160" class="difflineplus">+  sel.toggleSelect(2);</span>
<a href="#l60.161"></a><span id="l60.161" class="difflineplus">+  asr([1, 1], [3, 3]);</span>
<a href="#l60.162"></a><span id="l60.162" class="difflineplus">+  asel(1);</span>
<a href="#l60.163"></a><span id="l60.163" class="difflineplus">+  asel(3);</span>
<a href="#l60.164"></a><span id="l60.164" class="difflineplus">+  ansel(0);</span>
<a href="#l60.165"></a><span id="l60.165" class="difflineplus">+  ansel(2);</span>
<a href="#l60.166"></a><span id="l60.166" class="difflineplus">+  ansel(4);</span>
<a href="#l60.167"></a><span id="l60.167" class="difflineplus">+  aci(2);</span>
<a href="#l60.168"></a><span id="l60.168" class="difflineplus">+</span>
<a href="#l60.169"></a><span id="l60.169" class="difflineplus">+  // merge</span>
<a href="#l60.170"></a><span id="l60.170" class="difflineplus">+  sel.toggleSelect(2);</span>
<a href="#l60.171"></a><span id="l60.171" class="difflineplus">+  asr([1, 3]);</span>
<a href="#l60.172"></a><span id="l60.172" class="difflineplus">+  aci(2);</span>
<a href="#l60.173"></a><span id="l60.173" class="difflineplus">+</span>
<a href="#l60.174"></a><span id="l60.174" class="difflineplus">+  // lower shrinkage</span>
<a href="#l60.175"></a><span id="l60.175" class="difflineplus">+  sel.toggleSelect(1);</span>
<a href="#l60.176"></a><span id="l60.176" class="difflineplus">+  asr([2, 3]);</span>
<a href="#l60.177"></a><span id="l60.177" class="difflineplus">+  aci(1);</span>
<a href="#l60.178"></a><span id="l60.178" class="difflineplus">+</span>
<a href="#l60.179"></a><span id="l60.179" class="difflineplus">+  // upper shrinkage</span>
<a href="#l60.180"></a><span id="l60.180" class="difflineplus">+  sel.toggleSelect(3);</span>
<a href="#l60.181"></a><span id="l60.181" class="difflineplus">+  asr([2, 2]);</span>
<a href="#l60.182"></a><span id="l60.182" class="difflineplus">+  aci(3);</span>
<a href="#l60.183"></a><span id="l60.183" class="difflineplus">+</span>
<a href="#l60.184"></a><span id="l60.184" class="difflineplus">+  // nukage</span>
<a href="#l60.185"></a><span id="l60.185" class="difflineplus">+  sel.toggleSelect(2);</span>
<a href="#l60.186"></a><span id="l60.186" class="difflineplus">+  asr();</span>
<a href="#l60.187"></a><span id="l60.187" class="difflineplus">+  aci(2);</span>
<a href="#l60.188"></a><span id="l60.188" class="difflineplus">+</span>
<a href="#l60.189"></a><span id="l60.189" class="difflineplus">+  // -- rangedSelect</span>
<a href="#l60.190"></a><span id="l60.190" class="difflineplus">+  // simple non-augment</span>
<a href="#l60.191"></a><span id="l60.191" class="difflineplus">+  sel.rangedSelect(0, 0, false);</span>
<a href="#l60.192"></a><span id="l60.192" class="difflineplus">+  asr([0, 0]);</span>
<a href="#l60.193"></a><span id="l60.193" class="difflineplus">+  asp(0);</span>
<a href="#l60.194"></a><span id="l60.194" class="difflineplus">+  aci(0);</span>
<a href="#l60.195"></a><span id="l60.195" class="difflineplus">+</span>
<a href="#l60.196"></a><span id="l60.196" class="difflineplus">+  // slightly less simple non-augment</span>
<a href="#l60.197"></a><span id="l60.197" class="difflineplus">+  sel.rangedSelect(2, 4, false);</span>
<a href="#l60.198"></a><span id="l60.198" class="difflineplus">+  asr([2, 4]);</span>
<a href="#l60.199"></a><span id="l60.199" class="difflineplus">+  asp(2);</span>
<a href="#l60.200"></a><span id="l60.200" class="difflineplus">+  aci(4);</span>
<a href="#l60.201"></a><span id="l60.201" class="difflineplus">+</span>
<a href="#l60.202"></a><span id="l60.202" class="difflineplus">+  // higher distinct range</span>
<a href="#l60.203"></a><span id="l60.203" class="difflineplus">+  sel.rangedSelect(7, 9, true);</span>
<a href="#l60.204"></a><span id="l60.204" class="difflineplus">+  asr([2, 4], [7, 9]);</span>
<a href="#l60.205"></a><span id="l60.205" class="difflineplus">+  asp(7);</span>
<a href="#l60.206"></a><span id="l60.206" class="difflineplus">+  aci(9);</span>
<a href="#l60.207"></a><span id="l60.207" class="difflineplus">+</span>
<a href="#l60.208"></a><span id="l60.208" class="difflineplus">+  // lower distinct range</span>
<a href="#l60.209"></a><span id="l60.209" class="difflineplus">+  sel.rangedSelect(0, 0, true);</span>
<a href="#l60.210"></a><span id="l60.210" class="difflineplus">+  asr([0, 0], [2, 4], [7, 9]);</span>
<a href="#l60.211"></a><span id="l60.211" class="difflineplus">+  asp(0);</span>
<a href="#l60.212"></a><span id="l60.212" class="difflineplus">+  aci(0);</span>
<a href="#l60.213"></a><span id="l60.213" class="difflineplus">+</span>
<a href="#l60.214"></a><span id="l60.214" class="difflineplus">+  // lower fusion</span>
<a href="#l60.215"></a><span id="l60.215" class="difflineplus">+  sel.rangedSelect(6, 6, true);</span>
<a href="#l60.216"></a><span id="l60.216" class="difflineplus">+  asr([0, 0], [2, 4], [6, 9]);</span>
<a href="#l60.217"></a><span id="l60.217" class="difflineplus">+  asp(6);</span>
<a href="#l60.218"></a><span id="l60.218" class="difflineplus">+  aci(6);</span>
<a href="#l60.219"></a><span id="l60.219" class="difflineplus">+</span>
<a href="#l60.220"></a><span id="l60.220" class="difflineplus">+  // upper fusion</span>
<a href="#l60.221"></a><span id="l60.221" class="difflineplus">+  sel.rangedSelect(10, 11, true);</span>
<a href="#l60.222"></a><span id="l60.222" class="difflineplus">+  asr([0, 0], [2, 4], [6, 11]);</span>
<a href="#l60.223"></a><span id="l60.223" class="difflineplus">+  asp(10);</span>
<a href="#l60.224"></a><span id="l60.224" class="difflineplus">+  aci(11);</span>
<a href="#l60.225"></a><span id="l60.225" class="difflineplus">+</span>
<a href="#l60.226"></a><span id="l60.226" class="difflineplus">+  // notch merge</span>
<a href="#l60.227"></a><span id="l60.227" class="difflineplus">+  sel.rangedSelect(5, 5, true);</span>
<a href="#l60.228"></a><span id="l60.228" class="difflineplus">+  asr([0, 0], [2, 11]);</span>
<a href="#l60.229"></a><span id="l60.229" class="difflineplus">+  asp(5);</span>
<a href="#l60.230"></a><span id="l60.230" class="difflineplus">+  aci(5);</span>
<a href="#l60.231"></a><span id="l60.231" class="difflineplus">+</span>
<a href="#l60.232"></a><span id="l60.232" class="difflineplus">+  // ambiguous consume with merge</span>
<a href="#l60.233"></a><span id="l60.233" class="difflineplus">+  sel.rangedSelect(0, 5, true);</span>
<a href="#l60.234"></a><span id="l60.234" class="difflineplus">+  asr([0, 11]);</span>
<a href="#l60.235"></a><span id="l60.235" class="difflineplus">+  asp(0);</span>
<a href="#l60.236"></a><span id="l60.236" class="difflineplus">+  aci(5);</span>
<a href="#l60.237"></a><span id="l60.237" class="difflineplus">+</span>
<a href="#l60.238"></a><span id="l60.238" class="difflineplus">+  // aligned consumption</span>
<a href="#l60.239"></a><span id="l60.239" class="difflineplus">+  sel.rangedSelect(0, 15, true);</span>
<a href="#l60.240"></a><span id="l60.240" class="difflineplus">+  asr([0, 15]);</span>
<a href="#l60.241"></a><span id="l60.241" class="difflineplus">+  asp(0);</span>
<a href="#l60.242"></a><span id="l60.242" class="difflineplus">+  aci(15);</span>
<a href="#l60.243"></a><span id="l60.243" class="difflineplus">+</span>
<a href="#l60.244"></a><span id="l60.244" class="difflineplus">+  // excessive consumption</span>
<a href="#l60.245"></a><span id="l60.245" class="difflineplus">+  sel.rangedSelect(5, 7, false);</span>
<a href="#l60.246"></a><span id="l60.246" class="difflineplus">+  sel.rangedSelect(3, 10, true);</span>
<a href="#l60.247"></a><span id="l60.247" class="difflineplus">+  asr([3, 10]);</span>
<a href="#l60.248"></a><span id="l60.248" class="difflineplus">+  asp(3);</span>
<a href="#l60.249"></a><span id="l60.249" class="difflineplus">+  aci(10);</span>
<a href="#l60.250"></a><span id="l60.250" class="difflineplus">+</span>
<a href="#l60.251"></a><span id="l60.251" class="difflineplus">+  // overlap merge</span>
<a href="#l60.252"></a><span id="l60.252" class="difflineplus">+  sel.rangedSelect(5, 10, false);</span>
<a href="#l60.253"></a><span id="l60.253" class="difflineplus">+  sel.rangedSelect(15, 20, true);</span>
<a href="#l60.254"></a><span id="l60.254" class="difflineplus">+  sel.rangedSelect(7, 17, true);</span>
<a href="#l60.255"></a><span id="l60.255" class="difflineplus">+  asr([5, 20]);</span>
<a href="#l60.256"></a><span id="l60.256" class="difflineplus">+  asp(7);</span>
<a href="#l60.257"></a><span id="l60.257" class="difflineplus">+  aci(17);</span>
<a href="#l60.258"></a><span id="l60.258" class="difflineplus">+</span>
<a href="#l60.259"></a><span id="l60.259" class="difflineplus">+  // big merge and consume</span>
<a href="#l60.260"></a><span id="l60.260" class="difflineplus">+  sel.rangedSelect(5, 10, false);</span>
<a href="#l60.261"></a><span id="l60.261" class="difflineplus">+  sel.rangedSelect(15, 20, true);</span>
<a href="#l60.262"></a><span id="l60.262" class="difflineplus">+  sel.rangedSelect(25, 30, true);</span>
<a href="#l60.263"></a><span id="l60.263" class="difflineplus">+  sel.rangedSelect(35, 40, true);</span>
<a href="#l60.264"></a><span id="l60.264" class="difflineplus">+  sel.rangedSelect(7, 37, true);</span>
<a href="#l60.265"></a><span id="l60.265" class="difflineplus">+  asr([5, 40]);</span>
<a href="#l60.266"></a><span id="l60.266" class="difflineplus">+  asp(7);</span>
<a href="#l60.267"></a><span id="l60.267" class="difflineplus">+  aci(37);</span>
<a href="#l60.268"></a><span id="l60.268" class="difflineplus">+</span>
<a href="#l60.269"></a><span id="l60.269" class="difflineplus">+  // broad lower fusion</span>
<a href="#l60.270"></a><span id="l60.270" class="difflineplus">+  sel.rangedSelect(10, 20, false);</span>
<a href="#l60.271"></a><span id="l60.271" class="difflineplus">+  sel.rangedSelect(3, 15, true);</span>
<a href="#l60.272"></a><span id="l60.272" class="difflineplus">+  asr([3, 20]);</span>
<a href="#l60.273"></a><span id="l60.273" class="difflineplus">+  asp(3);</span>
<a href="#l60.274"></a><span id="l60.274" class="difflineplus">+  aci(15);</span>
<a href="#l60.275"></a><span id="l60.275" class="difflineplus">+</span>
<a href="#l60.276"></a><span id="l60.276" class="difflineplus">+  // -- clearRange</span>
<a href="#l60.277"></a><span id="l60.277" class="difflineplus">+  sel.rangedSelect(10, 30, false);</span>
<a href="#l60.278"></a><span id="l60.278" class="difflineplus">+</span>
<a href="#l60.279"></a><span id="l60.279" class="difflineplus">+  // irrelevant low</span>
<a href="#l60.280"></a><span id="l60.280" class="difflineplus">+  sel.clearRange(0, 5);</span>
<a href="#l60.281"></a><span id="l60.281" class="difflineplus">+  asr([10, 30]);</span>
<a href="#l60.282"></a><span id="l60.282" class="difflineplus">+</span>
<a href="#l60.283"></a><span id="l60.283" class="difflineplus">+  // irrelevant high</span>
<a href="#l60.284"></a><span id="l60.284" class="difflineplus">+  sel.clearRange(40, 45);</span>
<a href="#l60.285"></a><span id="l60.285" class="difflineplus">+  asr([10, 30]);</span>
<a href="#l60.286"></a><span id="l60.286" class="difflineplus">+</span>
<a href="#l60.287"></a><span id="l60.287" class="difflineplus">+  // lower shrinkage tight</span>
<a href="#l60.288"></a><span id="l60.288" class="difflineplus">+  sel.clearRange(10, 10);</span>
<a href="#l60.289"></a><span id="l60.289" class="difflineplus">+  asr([11, 30]);</span>
<a href="#l60.290"></a><span id="l60.290" class="difflineplus">+</span>
<a href="#l60.291"></a><span id="l60.291" class="difflineplus">+  // lower shrinkage broad</span>
<a href="#l60.292"></a><span id="l60.292" class="difflineplus">+  sel.clearRange(0, 13);</span>
<a href="#l60.293"></a><span id="l60.293" class="difflineplus">+  asr([14, 30]);</span>
<a href="#l60.294"></a><span id="l60.294" class="difflineplus">+</span>
<a href="#l60.295"></a><span id="l60.295" class="difflineplus">+  // upper shrinkage tight</span>
<a href="#l60.296"></a><span id="l60.296" class="difflineplus">+  sel.clearRange(30, 30);</span>
<a href="#l60.297"></a><span id="l60.297" class="difflineplus">+  asr([14, 29]);</span>
<a href="#l60.298"></a><span id="l60.298" class="difflineplus">+</span>
<a href="#l60.299"></a><span id="l60.299" class="difflineplus">+  // upper shrinkage broad</span>
<a href="#l60.300"></a><span id="l60.300" class="difflineplus">+  sel.clearRange(27, 50);</span>
<a href="#l60.301"></a><span id="l60.301" class="difflineplus">+  asr([14, 26]);</span>
<a href="#l60.302"></a><span id="l60.302" class="difflineplus">+</span>
<a href="#l60.303"></a><span id="l60.303" class="difflineplus">+  // split tight</span>
<a href="#l60.304"></a><span id="l60.304" class="difflineplus">+  sel.clearRange(20, 20);</span>
<a href="#l60.305"></a><span id="l60.305" class="difflineplus">+  asr([14, 19], [21, 26]);</span>
<a href="#l60.306"></a><span id="l60.306" class="difflineplus">+</span>
<a href="#l60.307"></a><span id="l60.307" class="difflineplus">+  // split broad</span>
<a href="#l60.308"></a><span id="l60.308" class="difflineplus">+  sel.toggleSelect(20);</span>
<a href="#l60.309"></a><span id="l60.309" class="difflineplus">+  sel.clearRange(19, 21);</span>
<a href="#l60.310"></a><span id="l60.310" class="difflineplus">+  asr([14, 18], [22, 26]);</span>
<a href="#l60.311"></a><span id="l60.311" class="difflineplus">+</span>
<a href="#l60.312"></a><span id="l60.312" class="difflineplus">+  // hit two with tight shrinkage</span>
<a href="#l60.313"></a><span id="l60.313" class="difflineplus">+  sel.clearRange(18, 22);</span>
<a href="#l60.314"></a><span id="l60.314" class="difflineplus">+  asr([14, 17], [23, 26]);</span>
<a href="#l60.315"></a><span id="l60.315" class="difflineplus">+</span>
<a href="#l60.316"></a><span id="l60.316" class="difflineplus">+  // hit two with broad shrinkage</span>
<a href="#l60.317"></a><span id="l60.317" class="difflineplus">+  sel.clearRange(15, 25);</span>
<a href="#l60.318"></a><span id="l60.318" class="difflineplus">+  asr([14, 14], [26, 26]);</span>
<a href="#l60.319"></a><span id="l60.319" class="difflineplus">+</span>
<a href="#l60.320"></a><span id="l60.320" class="difflineplus">+  // obliterate</span>
<a href="#l60.321"></a><span id="l60.321" class="difflineplus">+  sel.clearRange(0, 100);</span>
<a href="#l60.322"></a><span id="l60.322" class="difflineplus">+  asr();</span>
<a href="#l60.323"></a><span id="l60.323" class="difflineplus">+</span>
<a href="#l60.324"></a><span id="l60.324" class="difflineplus">+  // multi-obliterate</span>
<a href="#l60.325"></a><span id="l60.325" class="difflineplus">+  sel.rangedSelect(10, 20, true);</span>
<a href="#l60.326"></a><span id="l60.326" class="difflineplus">+  sel.rangedSelect(30, 40, true);</span>
<a href="#l60.327"></a><span id="l60.327" class="difflineplus">+  sel.clearRange(0, 100);</span>
<a href="#l60.328"></a><span id="l60.328" class="difflineplus">+  asr();</span>
<a href="#l60.329"></a><span id="l60.329" class="difflineplus">+</span>
<a href="#l60.330"></a><span id="l60.330" class="difflineplus">+  // obliterate with shrinkage</span>
<a href="#l60.331"></a><span id="l60.331" class="difflineplus">+  sel.rangedSelect(5, 10, true);</span>
<a href="#l60.332"></a><span id="l60.332" class="difflineplus">+  sel.rangedSelect(15, 20, true);</span>
<a href="#l60.333"></a><span id="l60.333" class="difflineplus">+  sel.rangedSelect(25, 30, true);</span>
<a href="#l60.334"></a><span id="l60.334" class="difflineplus">+  sel.rangedSelect(35, 40, true);</span>
<a href="#l60.335"></a><span id="l60.335" class="difflineplus">+  sel.clearRange(7, 37);</span>
<a href="#l60.336"></a><span id="l60.336" class="difflineplus">+  asr([5, 6], [38, 40]);</span>
<a href="#l60.337"></a><span id="l60.337" class="difflineplus">+</span>
<a href="#l60.338"></a><span id="l60.338" class="difflineplus">+  // -- selectAll</span>
<a href="#l60.339"></a><span id="l60.339" class="difflineplus">+  sel.selectAll();</span>
<a href="#l60.340"></a><span id="l60.340" class="difflineplus">+  asr([0, 100]);</span>
<a href="#l60.341"></a><span id="l60.341" class="difflineplus">+</span>
<a href="#l60.342"></a><span id="l60.342" class="difflineplus">+  // -- adjustSelection</span>
<a href="#l60.343"></a><span id="l60.343" class="difflineplus">+  // bump due to addition on simple select</span>
<a href="#l60.344"></a><span id="l60.344" class="difflineplus">+  sel.select(5);</span>
<a href="#l60.345"></a><span id="l60.345" class="difflineplus">+  sel.adjustSelection(5, 1);</span>
<a href="#l60.346"></a><span id="l60.346" class="difflineplus">+  asr([6, 6]);</span>
<a href="#l60.347"></a><span id="l60.347" class="difflineplus">+  aci(6);</span>
<a href="#l60.348"></a><span id="l60.348" class="difflineplus">+</span>
<a href="#l60.349"></a><span id="l60.349" class="difflineplus">+  sel.select(5);</span>
<a href="#l60.350"></a><span id="l60.350" class="difflineplus">+  sel.adjustSelection(0, 1);</span>
<a href="#l60.351"></a><span id="l60.351" class="difflineplus">+  asr([6, 6]);</span>
<a href="#l60.352"></a><span id="l60.352" class="difflineplus">+  aci(6);</span>
<a href="#l60.353"></a><span id="l60.353" class="difflineplus">+</span>
<a href="#l60.354"></a><span id="l60.354" class="difflineplus">+  // bump due to addition on ranged simple select</span>
<a href="#l60.355"></a><span id="l60.355" class="difflineplus">+  sel.rangedSelect(5, 5, false);</span>
<a href="#l60.356"></a><span id="l60.356" class="difflineplus">+  sel.adjustSelection(5, 1);</span>
<a href="#l60.357"></a><span id="l60.357" class="difflineplus">+  asr([6, 6]);</span>
<a href="#l60.358"></a><span id="l60.358" class="difflineplus">+  asp(6);</span>
<a href="#l60.359"></a><span id="l60.359" class="difflineplus">+  aci(6);</span>
<a href="#l60.360"></a><span id="l60.360" class="difflineplus">+</span>
<a href="#l60.361"></a><span id="l60.361" class="difflineplus">+  sel.rangedSelect(5, 5, false);</span>
<a href="#l60.362"></a><span id="l60.362" class="difflineplus">+  sel.adjustSelection(0, 1);</span>
<a href="#l60.363"></a><span id="l60.363" class="difflineplus">+  asr([6, 6]);</span>
<a href="#l60.364"></a><span id="l60.364" class="difflineplus">+  asp(6);</span>
<a href="#l60.365"></a><span id="l60.365" class="difflineplus">+  aci(6);</span>
<a href="#l60.366"></a><span id="l60.366" class="difflineplus">+</span>
<a href="#l60.367"></a><span id="l60.367" class="difflineplus">+  // bump due to addition on ranged select</span>
<a href="#l60.368"></a><span id="l60.368" class="difflineplus">+  sel.rangedSelect(5, 7, false);</span>
<a href="#l60.369"></a><span id="l60.369" class="difflineplus">+  sel.adjustSelection(5, 1);</span>
<a href="#l60.370"></a><span id="l60.370" class="difflineplus">+  asr([6, 8]);</span>
<a href="#l60.371"></a><span id="l60.371" class="difflineplus">+  asp(6);</span>
<a href="#l60.372"></a><span id="l60.372" class="difflineplus">+  aci(8);</span>
<a href="#l60.373"></a><span id="l60.373" class="difflineplus">+</span>
<a href="#l60.374"></a><span id="l60.374" class="difflineplus">+  // no-op with addition</span>
<a href="#l60.375"></a><span id="l60.375" class="difflineplus">+  sel.rangedSelect(0, 3, false);</span>
<a href="#l60.376"></a><span id="l60.376" class="difflineplus">+  sel.adjustSelection(10, 1);</span>
<a href="#l60.377"></a><span id="l60.377" class="difflineplus">+  asr([0, 3]);</span>
<a href="#l60.378"></a><span id="l60.378" class="difflineplus">+  asp(0);</span>
<a href="#l60.379"></a><span id="l60.379" class="difflineplus">+  aci(3);</span>
<a href="#l60.380"></a><span id="l60.380" class="difflineplus">+</span>
<a href="#l60.381"></a><span id="l60.381" class="difflineplus">+  // split due to addition</span>
<a href="#l60.382"></a><span id="l60.382" class="difflineplus">+  sel.rangedSelect(5, 6, false);</span>
<a href="#l60.383"></a><span id="l60.383" class="difflineplus">+  sel.adjustSelection(6, 1);</span>
<a href="#l60.384"></a><span id="l60.384" class="difflineplus">+  asr([5, 5], [7, 7]);</span>
<a href="#l60.385"></a><span id="l60.385" class="difflineplus">+  asp(5);</span>
<a href="#l60.386"></a><span id="l60.386" class="difflineplus">+  aci(7);</span>
<a href="#l60.387"></a><span id="l60.387" class="difflineplus">+</span>
<a href="#l60.388"></a><span id="l60.388" class="difflineplus">+  // shift due to removal on simple select</span>
<a href="#l60.389"></a><span id="l60.389" class="difflineplus">+  sel.select(5);</span>
<a href="#l60.390"></a><span id="l60.390" class="difflineplus">+  sel.adjustSelection(0, -1);</span>
<a href="#l60.391"></a><span id="l60.391" class="difflineplus">+  asr([4, 4]);</span>
<a href="#l60.392"></a><span id="l60.392" class="difflineplus">+  aci(4);</span>
<a href="#l60.393"></a><span id="l60.393" class="difflineplus">+</span>
<a href="#l60.394"></a><span id="l60.394" class="difflineplus">+  // shift due to removal on ranged simple select</span>
<a href="#l60.395"></a><span id="l60.395" class="difflineplus">+  sel.rangedSelect(5, 5, false);</span>
<a href="#l60.396"></a><span id="l60.396" class="difflineplus">+  sel.adjustSelection(0, -1);</span>
<a href="#l60.397"></a><span id="l60.397" class="difflineplus">+  asr([4, 4]);</span>
<a href="#l60.398"></a><span id="l60.398" class="difflineplus">+  asp(4);</span>
<a href="#l60.399"></a><span id="l60.399" class="difflineplus">+  aci(4);</span>
<a href="#l60.400"></a><span id="l60.400" class="difflineplus">+</span>
<a href="#l60.401"></a><span id="l60.401" class="difflineplus">+  // nuked due to removal on simple select</span>
<a href="#l60.402"></a><span id="l60.402" class="difflineplus">+  sel.select(5);</span>
<a href="#l60.403"></a><span id="l60.403" class="difflineplus">+  sel.adjustSelection(5, -1);</span>
<a href="#l60.404"></a><span id="l60.404" class="difflineplus">+  asr();</span>
<a href="#l60.405"></a><span id="l60.405" class="difflineplus">+  aci(-1);</span>
<a href="#l60.406"></a><span id="l60.406" class="difflineplus">+</span>
<a href="#l60.407"></a><span id="l60.407" class="difflineplus">+  // upper tight shrinkage due to removal</span>
<a href="#l60.408"></a><span id="l60.408" class="difflineplus">+  sel.rangedSelect(5, 10, false);</span>
<a href="#l60.409"></a><span id="l60.409" class="difflineplus">+  sel.adjustSelection(10, -1);</span>
<a href="#l60.410"></a><span id="l60.410" class="difflineplus">+  asr([5, 9]);</span>
<a href="#l60.411"></a><span id="l60.411" class="difflineplus">+  asp(5);</span>
<a href="#l60.412"></a><span id="l60.412" class="difflineplus">+  aci(-1);</span>
<a href="#l60.413"></a><span id="l60.413" class="difflineplus">+</span>
<a href="#l60.414"></a><span id="l60.414" class="difflineplus">+  // upper broad shrinkage due to removal</span>
<a href="#l60.415"></a><span id="l60.415" class="difflineplus">+  sel.rangedSelect(5, 10, false);</span>
<a href="#l60.416"></a><span id="l60.416" class="difflineplus">+  sel.adjustSelection(6, -10);</span>
<a href="#l60.417"></a><span id="l60.417" class="difflineplus">+  asr([5, 5]);</span>
<a href="#l60.418"></a><span id="l60.418" class="difflineplus">+  asp(5);</span>
<a href="#l60.419"></a><span id="l60.419" class="difflineplus">+  aci(-1);</span>
<a href="#l60.420"></a><span id="l60.420" class="difflineplus">+</span>
<a href="#l60.421"></a><span id="l60.421" class="difflineplus">+  // lower tight shrinkage due to removal</span>
<a href="#l60.422"></a><span id="l60.422" class="difflineplus">+  sel.rangedSelect(5, 10, false);</span>
<a href="#l60.423"></a><span id="l60.423" class="difflineplus">+  sel.adjustSelection(5, -1);</span>
<a href="#l60.424"></a><span id="l60.424" class="difflineplus">+  asr([5, 9]);</span>
<a href="#l60.425"></a><span id="l60.425" class="difflineplus">+  asp(-1);</span>
<a href="#l60.426"></a><span id="l60.426" class="difflineplus">+  aci(9);</span>
<a href="#l60.427"></a><span id="l60.427" class="difflineplus">+</span>
<a href="#l60.428"></a><span id="l60.428" class="difflineplus">+  // lower broad shrinkage due to removal</span>
<a href="#l60.429"></a><span id="l60.429" class="difflineplus">+  sel.rangedSelect(5, 10, false);</span>
<a href="#l60.430"></a><span id="l60.430" class="difflineplus">+  sel.adjustSelection(0, -10);</span>
<a href="#l60.431"></a><span id="l60.431" class="difflineplus">+  asr([0, 0]);</span>
<a href="#l60.432"></a><span id="l60.432" class="difflineplus">+  asp(-1);</span>
<a href="#l60.433"></a><span id="l60.433" class="difflineplus">+  aci(0);</span>
<a href="#l60.434"></a><span id="l60.434" class="difflineplus">+</span>
<a href="#l60.435"></a><span id="l60.435" class="difflineplus">+  // tight nuke due to removal</span>
<a href="#l60.436"></a><span id="l60.436" class="difflineplus">+  sel.rangedSelect(5, 10, false);</span>
<a href="#l60.437"></a><span id="l60.437" class="difflineplus">+  sel.adjustSelection(5, -6);</span>
<a href="#l60.438"></a><span id="l60.438" class="difflineplus">+  asr();</span>
<a href="#l60.439"></a><span id="l60.439" class="difflineplus">+  asp(-1);</span>
<a href="#l60.440"></a><span id="l60.440" class="difflineplus">+  aci(-1);</span>
<a href="#l60.441"></a><span id="l60.441" class="difflineplus">+</span>
<a href="#l60.442"></a><span id="l60.442" class="difflineplus">+  // broad nuke due to removal</span>
<a href="#l60.443"></a><span id="l60.443" class="difflineplus">+  sel.rangedSelect(5, 10, false);</span>
<a href="#l60.444"></a><span id="l60.444" class="difflineplus">+  sel.adjustSelection(0, -20);</span>
<a href="#l60.445"></a><span id="l60.445" class="difflineplus">+  asr();</span>
<a href="#l60.446"></a><span id="l60.446" class="difflineplus">+  asp(-1);</span>
<a href="#l60.447"></a><span id="l60.447" class="difflineplus">+  aci(-1);</span>
<a href="#l60.448"></a><span id="l60.448" class="difflineplus">+}</span>
<a href="#l60.449"></a><span id="l60.449">\ No newline at end of file</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l61.1"></a><span id="l61.1" class="difflineminus">--- a/mailnews/base/test/unit/test_viewWrapper_logic.js</span>
<a href="#l61.2"></a><span id="l61.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_viewWrapper_logic.js</span>
<a href="#l61.3"></a><span id="l61.3" class="difflineat">@@ -1,13 +1,14 @@</span>
<a href="#l61.4"></a><span id="l61.4"> load(&quot;../../mailnews/resources/messageGenerator.js&quot;);</span>
<a href="#l61.5"></a><span id="l61.5"> load(&quot;../../mailnews/resources/messageModifier.js&quot;);</span>
<a href="#l61.6"></a><span id="l61.6"> load(&quot;../../mailnews/resources/asyncTestUtils.js&quot;);</span>
<a href="#l61.7"></a><span id="l61.7"> </span>
<a href="#l61.8"></a><span id="l61.8"> load(&quot;../../mailnews/resources/viewWrapperTestUtils.js&quot;);</span>
<a href="#l61.9"></a><span id="l61.9" class="difflineplus">+initViewWrapperTestUtils();</span>
<a href="#l61.10"></a><span id="l61.10"> </span>
<a href="#l61.11"></a><span id="l61.11"> /**</span>
<a href="#l61.12"></a><span id="l61.12">  * Verify that flipping between threading and grouped by sort settings properly</span>
<a href="#l61.13"></a><span id="l61.13">  *  clears the other flag.  (Because they're mutually exclusive, you see.)</span>
<a href="#l61.14"></a><span id="l61.14">  */</span>
<a href="#l61.15"></a><span id="l61.15"> function test_threading_grouping_mutual_exclusion () {</span>
<a href="#l61.16"></a><span id="l61.16">   let viewWrapper = make_view_wrapper();</span>
<a href="#l61.17"></a><span id="l61.17">   let folder = make_empty_folder();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l62.1"></a><span id="l62.1" class="difflineminus">--- a/mailnews/base/test/unit/test_viewWrapper_realFolder.js</span>
<a href="#l62.2"></a><span id="l62.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_viewWrapper_realFolder.js</span>
<a href="#l62.3"></a><span id="l62.3" class="difflineat">@@ -4,16 +4,17 @@</span>
<a href="#l62.4"></a><span id="l62.4">  *  newsgroup specific.)</span>
<a href="#l62.5"></a><span id="l62.5">  */</span>
<a href="#l62.6"></a><span id="l62.6"> </span>
<a href="#l62.7"></a><span id="l62.7"> load(&quot;../../mailnews/resources/messageGenerator.js&quot;);</span>
<a href="#l62.8"></a><span id="l62.8"> load(&quot;../../mailnews/resources/messageModifier.js&quot;);</span>
<a href="#l62.9"></a><span id="l62.9"> load(&quot;../../mailnews/resources/asyncTestUtils.js&quot;);</span>
<a href="#l62.10"></a><span id="l62.10"> </span>
<a href="#l62.11"></a><span id="l62.11"> load(&quot;../../mailnews/resources/viewWrapperTestUtils.js&quot;);</span>
<a href="#l62.12"></a><span id="l62.12" class="difflineplus">+initViewWrapperTestUtils();</span>
<a href="#l62.13"></a><span id="l62.13"> </span>
<a href="#l62.14"></a><span id="l62.14"> /* ===== Real Folder, no features ===== */</span>
<a href="#l62.15"></a><span id="l62.15"> </span>
<a href="#l62.16"></a><span id="l62.16"> /**</span>
<a href="#l62.17"></a><span id="l62.17">  * Open a pre-populated real folder, make sure all the messages show up.</span>
<a href="#l62.18"></a><span id="l62.18">  */</span>
<a href="#l62.19"></a><span id="l62.19"> function test_real_folder_load() {</span>
<a href="#l62.20"></a><span id="l62.20">   let viewWrapper = make_view_wrapper();</span>
<a href="#l62.21"></a><span id="l62.21" class="difflineat">@@ -64,30 +65,47 @@ function test_real_folder_load_after_rea</span>
<a href="#l62.22"></a><span id="l62.22">   verify_messages_in_view(setOne, viewWrapper);</span>
<a href="#l62.23"></a><span id="l62.23"> </span>
<a href="#l62.24"></a><span id="l62.24">   let [folderTwo, setTwo] = make_folder_with_sets(1);</span>
<a href="#l62.25"></a><span id="l62.25">   yield async_view_open(viewWrapper, folderTwo);</span>
<a href="#l62.26"></a><span id="l62.26">   verify_messages_in_view(setTwo, viewWrapper);</span>
<a href="#l62.27"></a><span id="l62.27"> }</span>
<a href="#l62.28"></a><span id="l62.28"> </span>
<a href="#l62.29"></a><span id="l62.29"> /* ===== Real Folder, Threading Modes ==== */</span>
<a href="#l62.30"></a><span id="l62.30" class="difflineplus">+/*</span>
<a href="#l62.31"></a><span id="l62.31" class="difflineplus">+ * The first three tests that verify setting the threading flags has the</span>
<a href="#l62.32"></a><span id="l62.32" class="difflineplus">+ *  expected outcome do this by creating the view from scratch with the view</span>
<a href="#l62.33"></a><span id="l62.33" class="difflineplus">+ *  flags applied.  The view threading persistence test handles making sure</span>
<a href="#l62.34"></a><span id="l62.34" class="difflineplus">+ *  that changes in threading on-the-fly work from the perspective of the</span>
<a href="#l62.35"></a><span id="l62.35" class="difflineplus">+ *  bits and what not.  None of these are tests of the view implementation's</span>
<a href="#l62.36"></a><span id="l62.36" class="difflineplus">+ *  threading/grouping logic, just sanity checking that we are doing the right</span>
<a href="#l62.37"></a><span id="l62.37" class="difflineplus">+ *  thing.</span>
<a href="#l62.38"></a><span id="l62.38" class="difflineplus">+ */</span>
<a href="#l62.39"></a><span id="l62.39" class="difflineplus">+</span>
<a href="#l62.40"></a><span id="l62.40"> function test_real_folder_threading_unthreaded() {</span>
<a href="#l62.41"></a><span id="l62.41">   let viewWrapper = make_view_wrapper();</span>
<a href="#l62.42"></a><span id="l62.42">   let folder = make_empty_folder();</span>
<a href="#l62.43"></a><span id="l62.43"> </span>
<a href="#l62.44"></a><span id="l62.44">   // create a single maximally nested thread.</span>
<a href="#l62.45"></a><span id="l62.45">   const count = 10;</span>
<a href="#l62.46"></a><span id="l62.46">   let messageSet =</span>
<a href="#l62.47"></a><span id="l62.47">     new SyntheticMessageSet(gMessageScenarioFactory.directReply(count));</span>
<a href="#l62.48"></a><span id="l62.48">   add_sets_to_folder(folder, [messageSet]);</span>
<a href="#l62.49"></a><span id="l62.49"> </span>
<a href="#l62.50"></a><span id="l62.50">   // verify that we are not threaded (or grouped)</span>
<a href="#l62.51"></a><span id="l62.51">   yield async_view_open(viewWrapper, folder);</span>
<a href="#l62.52"></a><span id="l62.52">   viewWrapper.beginViewUpdate();</span>
<a href="#l62.53"></a><span id="l62.53" class="difflineminus">-  viewWrapper.showThreaded = false;</span>
<a href="#l62.54"></a><span id="l62.54" class="difflineplus">+  viewWrapper.showUnthreaded = true;</span>
<a href="#l62.55"></a><span id="l62.55" class="difflineplus">+  // whitebox test view flags (we've gotten them wrong before...)</span>
<a href="#l62.56"></a><span id="l62.56" class="difflineplus">+  assert_bit_not_set(viewWrapper._viewFlags,</span>
<a href="#l62.57"></a><span id="l62.57" class="difflineplus">+                     Ci.nsMsgViewFlagsType.kThreadedDisplay,</span>
<a href="#l62.58"></a><span id="l62.58" class="difflineplus">+                     &quot;View threaded bit should not be set.&quot;);</span>
<a href="#l62.59"></a><span id="l62.59" class="difflineplus">+  assert_bit_not_set(viewWrapper._viewFlags,</span>
<a href="#l62.60"></a><span id="l62.60" class="difflineplus">+                     Ci.nsMsgViewFlagsType.kGroupBySort,</span>
<a href="#l62.61"></a><span id="l62.61" class="difflineplus">+                     &quot;View group-by-sort bit should not be set.&quot;);</span>
<a href="#l62.62"></a><span id="l62.62">   yield async_view_end_update(viewWrapper);</span>
<a href="#l62.63"></a><span id="l62.63">   verify_view_level_histogram({0: count}, viewWrapper);</span>
<a href="#l62.64"></a><span id="l62.64"> }</span>
<a href="#l62.65"></a><span id="l62.65"> </span>
<a href="#l62.66"></a><span id="l62.66"> function test_real_folder_threading_threaded() {</span>
<a href="#l62.67"></a><span id="l62.67">   let viewWrapper = make_view_wrapper();</span>
<a href="#l62.68"></a><span id="l62.68">   let folder = make_empty_folder();</span>
<a href="#l62.69"></a><span id="l62.69"> </span>
<a href="#l62.70"></a><span id="l62.70" class="difflineat">@@ -96,18 +114,29 @@ function test_real_folder_threading_thre</span>
<a href="#l62.71"></a><span id="l62.71">   let messageSet =</span>
<a href="#l62.72"></a><span id="l62.72">     new SyntheticMessageSet(gMessageScenarioFactory.directReply(count));</span>
<a href="#l62.73"></a><span id="l62.73">   add_sets_to_folder(folder, [messageSet]);</span>
<a href="#l62.74"></a><span id="l62.74"> </span>
<a href="#l62.75"></a><span id="l62.75">   // verify that we are threaded (in such a way that we can't be grouped)</span>
<a href="#l62.76"></a><span id="l62.76">   yield async_view_open(viewWrapper, folder);</span>
<a href="#l62.77"></a><span id="l62.77">   viewWrapper.beginViewUpdate();</span>
<a href="#l62.78"></a><span id="l62.78">   viewWrapper.showThreaded = true;</span>
<a href="#l62.79"></a><span id="l62.79" class="difflineplus">+  // whitebox test view flags (we've gotten them wrong before...)</span>
<a href="#l62.80"></a><span id="l62.80" class="difflineplus">+  assert_bit_set(viewWrapper._viewFlags,</span>
<a href="#l62.81"></a><span id="l62.81" class="difflineplus">+                 Ci.nsMsgViewFlagsType.kThreadedDisplay,</span>
<a href="#l62.82"></a><span id="l62.82" class="difflineplus">+                 &quot;View threaded bit should be set.&quot;);</span>
<a href="#l62.83"></a><span id="l62.83" class="difflineplus">+  assert_bit_not_set(viewWrapper._viewFlags,</span>
<a href="#l62.84"></a><span id="l62.84" class="difflineplus">+                     Ci.nsMsgViewFlagsType.kGroupBySort,</span>
<a href="#l62.85"></a><span id="l62.85" class="difflineplus">+                     &quot;View group-by-sort bit should not be set.&quot;);</span>
<a href="#l62.86"></a><span id="l62.86" class="difflineplus">+  // expand everything so our logic below works.</span>
<a href="#l62.87"></a><span id="l62.87">   view_expand_all(viewWrapper);</span>
<a href="#l62.88"></a><span id="l62.88">   yield async_view_end_update(viewWrapper);</span>
<a href="#l62.89"></a><span id="l62.89" class="difflineplus">+  // blackbox test view flags: make sure IsContainer is true for the root</span>
<a href="#l62.90"></a><span id="l62.90" class="difflineplus">+  verify_view_row_at_index_is_container(viewWrapper, 0);</span>
<a href="#l62.91"></a><span id="l62.91" class="difflineplus">+  // do the histogram test to verify threading...</span>
<a href="#l62.92"></a><span id="l62.92">   let expectedHisto = {};</span>
<a href="#l62.93"></a><span id="l62.93">   for (let i = 0; i &lt; count; i++)</span>
<a href="#l62.94"></a><span id="l62.94">     expectedHisto[i] = 1;</span>
<a href="#l62.95"></a><span id="l62.95">   verify_view_level_histogram(expectedHisto, viewWrapper);</span>
<a href="#l62.96"></a><span id="l62.96"> }</span>
<a href="#l62.97"></a><span id="l62.97"> </span>
<a href="#l62.98"></a><span id="l62.98"> function test_real_folder_threading_grouped_by_sort() {</span>
<a href="#l62.99"></a><span id="l62.99">   let viewWrapper = make_view_wrapper();</span>
<a href="#l62.100"></a><span id="l62.100" class="difflineat">@@ -117,28 +146,115 @@ function test_real_folder_threading_grou</span>
<a href="#l62.101"></a><span id="l62.101">   const count = 5;</span>
<a href="#l62.102"></a><span id="l62.102">   let [folder, messageSet] = make_folder_with_sets([</span>
<a href="#l62.103"></a><span id="l62.103">     {count: count, age: {days: 2}, age_incr: {mins: 1}}]);</span>
<a href="#l62.104"></a><span id="l62.104"> </span>
<a href="#l62.105"></a><span id="l62.105">   // group-by-sort sorted by date</span>
<a href="#l62.106"></a><span id="l62.106">   yield async_view_open(viewWrapper, folder);</span>
<a href="#l62.107"></a><span id="l62.107">   viewWrapper.beginViewUpdate();</span>
<a href="#l62.108"></a><span id="l62.108">   viewWrapper.showGroupedBySort = true;</span>
<a href="#l62.109"></a><span id="l62.109" class="difflineplus">+  // whitebox test view flags (we've gotten them wrong before...)</span>
<a href="#l62.110"></a><span id="l62.110" class="difflineplus">+  assert_bit_set(viewWrapper._viewFlags,</span>
<a href="#l62.111"></a><span id="l62.111" class="difflineplus">+                 Ci.nsMsgViewFlagsType.kThreadedDisplay,</span>
<a href="#l62.112"></a><span id="l62.112" class="difflineplus">+                 &quot;View threaded bit should be set.&quot;);</span>
<a href="#l62.113"></a><span id="l62.113" class="difflineplus">+  assert_bit_set(viewWrapper._viewFlags,</span>
<a href="#l62.114"></a><span id="l62.114" class="difflineplus">+                 Ci.nsMsgViewFlagsType.kGroupBySort,</span>
<a href="#l62.115"></a><span id="l62.115" class="difflineplus">+                 &quot;View group-by-sort bit should be set.&quot;);</span>
<a href="#l62.116"></a><span id="l62.116">   viewWrapper.sort(Ci.nsMsgViewSortType.byDate,</span>
<a href="#l62.117"></a><span id="l62.117">                    Ci.nsMsgViewSortOrder.ascending);</span>
<a href="#l62.118"></a><span id="l62.118">   // expand everyone</span>
<a href="#l62.119"></a><span id="l62.119">   view_expand_all(viewWrapper);</span>
<a href="#l62.120"></a><span id="l62.120">   yield async_view_end_update(viewWrapper);</span>
<a href="#l62.121"></a><span id="l62.121"> </span>
<a href="#l62.122"></a><span id="l62.122">   // make sure the level depths are correct</span>
<a href="#l62.123"></a><span id="l62.123">   verify_view_level_histogram({0: 1, 1: count}, viewWrapper);</span>
<a href="#l62.124"></a><span id="l62.124">   // and make sure the first dude is a dummy</span>
<a href="#l62.125"></a><span id="l62.125">   verify_view_row_at_index_is_dummy(viewWrapper, 0);</span>
<a href="#l62.126"></a><span id="l62.126"> }</span>
<a href="#l62.127"></a><span id="l62.127"> </span>
<a href="#l62.128"></a><span id="l62.128" class="difflineplus">+/**</span>
<a href="#l62.129"></a><span id="l62.129" class="difflineplus">+ * Verify that we the threading modes are persisted.  We are only checking</span>
<a href="#l62.130"></a><span id="l62.130" class="difflineplus">+ *  flags here; we trust the previous tests to have done their job.</span>
<a href="#l62.131"></a><span id="l62.131" class="difflineplus">+ */</span>
<a href="#l62.132"></a><span id="l62.132" class="difflineplus">+function test_real_folder_threading_persistence() {</span>
<a href="#l62.133"></a><span id="l62.133" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l62.134"></a><span id="l62.134" class="difflineplus">+  let folder = make_empty_folder();</span>
<a href="#l62.135"></a><span id="l62.135" class="difflineplus">+</span>
<a href="#l62.136"></a><span id="l62.136" class="difflineplus">+  // create a single maximally nested thread.</span>
<a href="#l62.137"></a><span id="l62.137" class="difflineplus">+  const count = 10;</span>
<a href="#l62.138"></a><span id="l62.138" class="difflineplus">+  let messageSet =</span>
<a href="#l62.139"></a><span id="l62.139" class="difflineplus">+    new SyntheticMessageSet(gMessageScenarioFactory.directReply(count));</span>
<a href="#l62.140"></a><span id="l62.140" class="difflineplus">+  add_sets_to_folder(folder, [messageSet]);</span>
<a href="#l62.141"></a><span id="l62.141" class="difflineplus">+</span>
<a href="#l62.142"></a><span id="l62.142" class="difflineplus">+  // open the folder, set threaded mode, close it</span>
<a href="#l62.143"></a><span id="l62.143" class="difflineplus">+  yield async_view_open(viewWrapper, folder);</span>
<a href="#l62.144"></a><span id="l62.144" class="difflineplus">+  viewWrapper.showThreaded = true; // should be instantaneous</span>
<a href="#l62.145"></a><span id="l62.145" class="difflineplus">+  verify_view_row_at_index_is_container(viewWrapper, 0);</span>
<a href="#l62.146"></a><span id="l62.146" class="difflineplus">+  assert_bit_set(viewWrapper._viewFlags,</span>
<a href="#l62.147"></a><span id="l62.147" class="difflineplus">+                 Ci.nsMsgViewFlagsType.kThreadedDisplay,</span>
<a href="#l62.148"></a><span id="l62.148" class="difflineplus">+                 &quot;View threaded bit should be set.&quot;);</span>
<a href="#l62.149"></a><span id="l62.149" class="difflineplus">+  assert_bit_not_set(viewWrapper._viewFlags,</span>
<a href="#l62.150"></a><span id="l62.150" class="difflineplus">+                     Ci.nsMsgViewFlagsType.kGroupBySort,</span>
<a href="#l62.151"></a><span id="l62.151" class="difflineplus">+                     &quot;View group-by-sort bit should not be set.&quot;);</span>
<a href="#l62.152"></a><span id="l62.152" class="difflineplus">+  viewWrapper.close();</span>
<a href="#l62.153"></a><span id="l62.153" class="difflineplus">+</span>
<a href="#l62.154"></a><span id="l62.154" class="difflineplus">+  // open it again, make sure we're threaded, go unthreaded, close</span>
<a href="#l62.155"></a><span id="l62.155" class="difflineplus">+  yield async_view_open(viewWrapper, folder);</span>
<a href="#l62.156"></a><span id="l62.156" class="difflineplus">+  assert_true(viewWrapper.showThreaded, &quot;view should be threaded&quot;);</span>
<a href="#l62.157"></a><span id="l62.157" class="difflineplus">+  assert_false(viewWrapper.showUnthreaded, &quot;view is lying about threading&quot;);</span>
<a href="#l62.158"></a><span id="l62.158" class="difflineplus">+  assert_false(viewWrapper.showGroupedBySort, &quot;view is lying about threading&quot;);</span>
<a href="#l62.159"></a><span id="l62.159" class="difflineplus">+  verify_view_row_at_index_is_container(viewWrapper, 0);</span>
<a href="#l62.160"></a><span id="l62.160" class="difflineplus">+  assert_bit_set(viewWrapper._viewFlags,</span>
<a href="#l62.161"></a><span id="l62.161" class="difflineplus">+                 Ci.nsMsgViewFlagsType.kThreadedDisplay,</span>
<a href="#l62.162"></a><span id="l62.162" class="difflineplus">+                 &quot;View threaded bit should be set.&quot;);</span>
<a href="#l62.163"></a><span id="l62.163" class="difflineplus">+  assert_bit_not_set(viewWrapper._viewFlags,</span>
<a href="#l62.164"></a><span id="l62.164" class="difflineplus">+                     Ci.nsMsgViewFlagsType.kGroupBySort,</span>
<a href="#l62.165"></a><span id="l62.165" class="difflineplus">+                     &quot;View group-by-sort bit should not be set.&quot;);</span>
<a href="#l62.166"></a><span id="l62.166" class="difflineplus">+</span>
<a href="#l62.167"></a><span id="l62.167" class="difflineplus">+  viewWrapper.showUnthreaded = true;</span>
<a href="#l62.168"></a><span id="l62.168" class="difflineplus">+  assert_bit_not_set(viewWrapper._viewFlags,</span>
<a href="#l62.169"></a><span id="l62.169" class="difflineplus">+                     Ci.nsMsgViewFlagsType.kThreadedDisplay,</span>
<a href="#l62.170"></a><span id="l62.170" class="difflineplus">+                     &quot;View threaded bit should not be set.&quot;);</span>
<a href="#l62.171"></a><span id="l62.171" class="difflineplus">+  assert_bit_not_set(viewWrapper._viewFlags,</span>
<a href="#l62.172"></a><span id="l62.172" class="difflineplus">+                     Ci.nsMsgViewFlagsType.kGroupBySort,</span>
<a href="#l62.173"></a><span id="l62.173" class="difflineplus">+                     &quot;View group-by-sort bit should not be set.&quot;);</span>
<a href="#l62.174"></a><span id="l62.174" class="difflineplus">+  viewWrapper.close();</span>
<a href="#l62.175"></a><span id="l62.175" class="difflineplus">+</span>
<a href="#l62.176"></a><span id="l62.176" class="difflineplus">+  // open it again, make sure we're unthreaded, go grouped, close</span>
<a href="#l62.177"></a><span id="l62.177" class="difflineplus">+  yield async_view_open(viewWrapper, folder);</span>
<a href="#l62.178"></a><span id="l62.178" class="difflineplus">+  assert_true(viewWrapper.showUnthreaded, &quot;view should be unthreaded&quot;);</span>
<a href="#l62.179"></a><span id="l62.179" class="difflineplus">+  assert_false(viewWrapper.showThreaded, &quot;view is lying about threading&quot;);</span>
<a href="#l62.180"></a><span id="l62.180" class="difflineplus">+  assert_false(viewWrapper.showGroupedBySort, &quot;view is lying about threading&quot;);</span>
<a href="#l62.181"></a><span id="l62.181" class="difflineplus">+  assert_bit_not_set(viewWrapper._viewFlags,</span>
<a href="#l62.182"></a><span id="l62.182" class="difflineplus">+                     Ci.nsMsgViewFlagsType.kThreadedDisplay,</span>
<a href="#l62.183"></a><span id="l62.183" class="difflineplus">+                     &quot;View threaded bit should not be set.&quot;);</span>
<a href="#l62.184"></a><span id="l62.184" class="difflineplus">+  assert_bit_not_set(viewWrapper._viewFlags,</span>
<a href="#l62.185"></a><span id="l62.185" class="difflineplus">+                     Ci.nsMsgViewFlagsType.kGroupBySort,</span>
<a href="#l62.186"></a><span id="l62.186" class="difflineplus">+                     &quot;View group-by-sort bit should not be set.&quot;);</span>
<a href="#l62.187"></a><span id="l62.187" class="difflineplus">+</span>
<a href="#l62.188"></a><span id="l62.188" class="difflineplus">+  viewWrapper.showGroupedBySort = true;</span>
<a href="#l62.189"></a><span id="l62.189" class="difflineplus">+  assert_bit_set(viewWrapper._viewFlags,</span>
<a href="#l62.190"></a><span id="l62.190" class="difflineplus">+                 Ci.nsMsgViewFlagsType.kThreadedDisplay,</span>
<a href="#l62.191"></a><span id="l62.191" class="difflineplus">+                 &quot;View threaded bit should be set.&quot;);</span>
<a href="#l62.192"></a><span id="l62.192" class="difflineplus">+  assert_bit_set(viewWrapper._viewFlags, Ci.nsMsgViewFlagsType.kGroupBySort,</span>
<a href="#l62.193"></a><span id="l62.193" class="difflineplus">+                 &quot;View group-by-sort bit should be set.&quot;);</span>
<a href="#l62.194"></a><span id="l62.194" class="difflineplus">+  viewWrapper.close();</span>
<a href="#l62.195"></a><span id="l62.195" class="difflineplus">+</span>
<a href="#l62.196"></a><span id="l62.196" class="difflineplus">+  // open it again, make sure we're grouped.</span>
<a href="#l62.197"></a><span id="l62.197" class="difflineplus">+  yield async_view_open(viewWrapper, folder);</span>
<a href="#l62.198"></a><span id="l62.198" class="difflineplus">+  assert_true(viewWrapper.showGroupedBySort, &quot;view should be grouped&quot;);</span>
<a href="#l62.199"></a><span id="l62.199" class="difflineplus">+  assert_false(viewWrapper.showThreaded, &quot;view is lying about threading&quot;);</span>
<a href="#l62.200"></a><span id="l62.200" class="difflineplus">+  assert_false(viewWrapper.showUnthreaded, &quot;view is lying about threading&quot;);</span>
<a href="#l62.201"></a><span id="l62.201" class="difflineplus">+  assert_bit_set(viewWrapper._viewFlags,</span>
<a href="#l62.202"></a><span id="l62.202" class="difflineplus">+                 Ci.nsMsgViewFlagsType.kThreadedDisplay,</span>
<a href="#l62.203"></a><span id="l62.203" class="difflineplus">+                 &quot;View threaded bit should be set.&quot;);</span>
<a href="#l62.204"></a><span id="l62.204" class="difflineplus">+  assert_bit_set(viewWrapper._viewFlags, Ci.nsMsgViewFlagsType.kGroupBySort,</span>
<a href="#l62.205"></a><span id="l62.205" class="difflineplus">+                 &quot;View group-by-sort bit should be set.&quot;);</span>
<a href="#l62.206"></a><span id="l62.206" class="difflineplus">+}</span>
<a href="#l62.207"></a><span id="l62.207" class="difflineplus">+</span>
<a href="#l62.208"></a><span id="l62.208"> /* ===== Real Folder, View Flags ===== */</span>
<a href="#l62.209"></a><span id="l62.209"> </span>
<a href="#l62.210"></a><span id="l62.210"> /*</span>
<a href="#l62.211"></a><span id="l62.211">  * We cannot test the ignored flag for a local folder because we cannot ignore</span>
<a href="#l62.212"></a><span id="l62.212">  *  threads in a local folder.  Only newsgroups can do that and that's not</span>
<a href="#l62.213"></a><span id="l62.213">  *  easily testable at this time.</span>
<a href="#l62.214"></a><span id="l62.214">  */</span>
<a href="#l62.215"></a><span id="l62.215"> </span>
<a href="#l62.216"></a><span id="l62.216" class="difflineat">@@ -566,16 +682,17 @@ function test_real_folder_special_views_</span>
<a href="#l62.217"></a><span id="l62.217"> var tests = [</span>
<a href="#l62.218"></a><span id="l62.218">   test_real_folder_load,</span>
<a href="#l62.219"></a><span id="l62.219">   test_real_folder_update,</span>
<a href="#l62.220"></a><span id="l62.220">   test_real_folder_load_after_real_folder_load,</span>
<a href="#l62.221"></a><span id="l62.221">   // - threading modes</span>
<a href="#l62.222"></a><span id="l62.222">   test_real_folder_threading_unthreaded,</span>
<a href="#l62.223"></a><span id="l62.223">   test_real_folder_threading_threaded,</span>
<a href="#l62.224"></a><span id="l62.224">   test_real_folder_threading_grouped_by_sort,</span>
<a href="#l62.225"></a><span id="l62.225" class="difflineplus">+  test_real_folder_threading_persistence,</span>
<a href="#l62.226"></a><span id="l62.226">   // - view flags</span>
<a href="#l62.227"></a><span id="l62.227">   // (we cannot test ignored flags in local folders)</span>
<a href="#l62.228"></a><span id="l62.228">   test_real_folder_flags_show_unread,</span>
<a href="#l62.229"></a><span id="l62.229">   // - mail views: test the actual views</span>
<a href="#l62.230"></a><span id="l62.230">   test_real_folder_mail_views_unread,</span>
<a href="#l62.231"></a><span id="l62.231">   test_real_folder_mail_views_tags,</span>
<a href="#l62.232"></a><span id="l62.232">   test_real_folder_mail_views_not_deleted,</span>
<a href="#l62.233"></a><span id="l62.233">   // - mail views: test the custom views</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l63.1"></a><span id="l63.1" class="difflineminus">--- a/mailnews/base/test/unit/test_viewWrapper_virtualFolder.js</span>
<a href="#l63.2"></a><span id="l63.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_viewWrapper_virtualFolder.js</span>
<a href="#l63.3"></a><span id="l63.3" class="difflineat">@@ -11,16 +11,17 @@</span>
<a href="#l63.4"></a><span id="l63.4">  * We could test all these things, but my patch is way behind schedule...</span>
<a href="#l63.5"></a><span id="l63.5">  */</span>
<a href="#l63.6"></a><span id="l63.6"> </span>
<a href="#l63.7"></a><span id="l63.7"> load(&quot;../../mailnews/resources/messageGenerator.js&quot;);</span>
<a href="#l63.8"></a><span id="l63.8"> load(&quot;../../mailnews/resources/messageModifier.js&quot;);</span>
<a href="#l63.9"></a><span id="l63.9"> load(&quot;../../mailnews/resources/asyncTestUtils.js&quot;);</span>
<a href="#l63.10"></a><span id="l63.10"> </span>
<a href="#l63.11"></a><span id="l63.11"> load(&quot;../../mailnews/resources/viewWrapperTestUtils.js&quot;);</span>
<a href="#l63.12"></a><span id="l63.12" class="difflineplus">+initViewWrapperTestUtils();</span>
<a href="#l63.13"></a><span id="l63.13"> </span>
<a href="#l63.14"></a><span id="l63.14"> /**</span>
<a href="#l63.15"></a><span id="l63.15">  * Make sure we open a virtual folder backed by a single underlying folder</span>
<a href="#l63.16"></a><span id="l63.16">  *  correctly; no constraints.</span>
<a href="#l63.17"></a><span id="l63.17">  */</span>
<a href="#l63.18"></a><span id="l63.18"> function test_virtual_folder_single_load_no_pred() {</span>
<a href="#l63.19"></a><span id="l63.19">   let viewWrapper = make_view_wrapper();</span>
<a href="#l63.20"></a><span id="l63.20"> </span>
<a href="#l63.21"></a><span id="l63.21" class="difflineat">@@ -238,16 +239,32 @@ function test_virtual_folder_combo_load_</span>
<a href="#l63.22"></a><span id="l63.22">   yield async_view_open(viewWrapper, virtTwo);</span>
<a href="#l63.23"></a><span id="l63.23">   verify_messages_in_view([twoSubjBar], viewWrapper);</span>
<a href="#l63.24"></a><span id="l63.24"> </span>
<a href="#l63.25"></a><span id="l63.25">   yield async_view_open(viewWrapper, virtOne);</span>
<a href="#l63.26"></a><span id="l63.26">   verify_messages_in_view([oneSubjFoo], viewWrapper);</span>
<a href="#l63.27"></a><span id="l63.27"> }</span>
<a href="#l63.28"></a><span id="l63.28"> </span>
<a href="#l63.29"></a><span id="l63.29"> /**</span>
<a href="#l63.30"></a><span id="l63.30" class="difflineplus">+ * Make sure that if a server is listed in a virtual folder's search Uris that</span>
<a href="#l63.31"></a><span id="l63.31" class="difflineplus">+ *  it does not get into our list of _underlyingFolders.</span>
<a href="#l63.32"></a><span id="l63.32" class="difflineplus">+ */</span>
<a href="#l63.33"></a><span id="l63.33" class="difflineplus">+function test_virtual_folder_filters_out_servers() {</span>
<a href="#l63.34"></a><span id="l63.34" class="difflineplus">+  let viewWrapper = make_view_wrapper();</span>
<a href="#l63.35"></a><span id="l63.35" class="difflineplus">+</span>
<a href="#l63.36"></a><span id="l63.36" class="difflineplus">+  let [folders] = make_folders_with_sets(2, []);</span>
<a href="#l63.37"></a><span id="l63.37" class="difflineplus">+  folders.push(folders[0].rootFolder);</span>
<a href="#l63.38"></a><span id="l63.38" class="difflineplus">+  let virtFolder = make_virtual_folder(folders, {});</span>
<a href="#l63.39"></a><span id="l63.39" class="difflineplus">+  yield async_view_open(viewWrapper, virtFolder);</span>
<a href="#l63.40"></a><span id="l63.40" class="difflineplus">+</span>
<a href="#l63.41"></a><span id="l63.41" class="difflineplus">+  assert_equals(viewWrapper._underlyingFolders.length, 2,</span>
<a href="#l63.42"></a><span id="l63.42" class="difflineplus">+                &quot;Server folder should have been filtered out.&quot;);</span>
<a href="#l63.43"></a><span id="l63.43" class="difflineplus">+}</span>
<a href="#l63.44"></a><span id="l63.44" class="difflineplus">+</span>
<a href="#l63.45"></a><span id="l63.45" class="difflineplus">+/**</span>
<a href="#l63.46"></a><span id="l63.46">  * Verify that if one of the folders backing our virtual folder is deleted that</span>
<a href="#l63.47"></a><span id="l63.47">  *  we do not explode.  Then verify that if we remove the rest of them that the</span>
<a href="#l63.48"></a><span id="l63.48">  *  view wrapper closes itself.</span>
<a href="#l63.49"></a><span id="l63.49">  */</span>
<a href="#l63.50"></a><span id="l63.50"> function test_virtual_folder_underlying_folder_deleted() {</span>
<a href="#l63.51"></a><span id="l63.51">   let viewWrapper = make_view_wrapper();</span>
<a href="#l63.52"></a><span id="l63.52"> </span>
<a href="#l63.53"></a><span id="l63.53">   let [folderOne, oneSubjFoo, oneNopers] = make_folder_with_sets([</span>
<a href="#l63.54"></a><span id="l63.54" class="difflineat">@@ -397,16 +414,18 @@ var tests = [</span>
<a href="#l63.55"></a><span id="l63.55">   test_virtual_folder_multi_load_no_pred,</span>
<a href="#l63.56"></a><span id="l63.56">   test_virtual_folder_multi_load_simple_pred,</span>
<a href="#l63.57"></a><span id="l63.57">   test_virtual_folder_multi_load_complex_pred,</span>
<a href="#l63.58"></a><span id="l63.58">   test_virtual_folder_multi_load_alotta_folders_no_pred,</span>
<a href="#l63.59"></a><span id="l63.59">   test_virtual_folder_multi_load_alotta_folders_simple_pred,</span>
<a href="#l63.60"></a><span id="l63.60">   test_virtual_folder_multi_load_after_load,</span>
<a href="#l63.61"></a><span id="l63.61">   // -- mixture of single-backed and multi-backed</span>
<a href="#l63.62"></a><span id="l63.62">   test_virtual_folder_combo_load_after_load,</span>
<a href="#l63.63"></a><span id="l63.63" class="difflineplus">+  // -- ignore things we should ignore</span>
<a href="#l63.64"></a><span id="l63.64" class="difflineplus">+  test_virtual_folder_filters_out_servers,</span>
<a href="#l63.65"></a><span id="l63.65">   // -- rare/edge cases!</span>
<a href="#l63.66"></a><span id="l63.66">   test_virtual_folder_underlying_folder_deleted,</span>
<a href="#l63.67"></a><span id="l63.67">   // -- mail views (parameterized)</span>
<a href="#l63.68"></a><span id="l63.68">   parameterizeTest(test_virtual_folder_mail_views_unread, [1, 4]),</span>
<a href="#l63.69"></a><span id="l63.69">   // -- quick search (parameterized for single and multi folder cases)</span>
<a href="#l63.70"></a><span id="l63.70">   parameterizeTest(test_virtual_folder_param_quick_search_simple, [1, 4]),</span>
<a href="#l63.71"></a><span id="l63.71">   parameterizeTest(test_virtual_folder_param_quick_search_complex, [1, 4]),</span>
<a href="#l63.72"></a><span id="l63.72">   // -- mail view with quick search</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l64.1"></a><span id="l64.1" class="difflineminus">--- a/mailnews/base/util/Makefile.in</span>
<a href="#l64.2"></a><span id="l64.2" class="difflineplus">+++ b/mailnews/base/util/Makefile.in</span>
<a href="#l64.3"></a><span id="l64.3" class="difflineat">@@ -124,17 +124,20 @@ EXPORTS		= \</span>
<a href="#l64.4"></a><span id="l64.4"> 		nsMsgTxn.h \</span>
<a href="#l64.5"></a><span id="l64.5"> 		nsMsgI18N.h \</span>
<a href="#l64.6"></a><span id="l64.6"> 		nsImapMoveCoalescer.h \</span>
<a href="#l64.7"></a><span id="l64.7"> 		nsMsgReadStateTxn.h \</span>
<a href="#l64.8"></a><span id="l64.8"> 		$(NULL)</span>
<a href="#l64.9"></a><span id="l64.9"> </span>
<a href="#l64.10"></a><span id="l64.10"> EXTRA_JS_MODULES = \</span>
<a href="#l64.11"></a><span id="l64.11"> 		folderUtils.jsm \</span>
<a href="#l64.12"></a><span id="l64.12" class="difflineminus">-		iteratorUtils.jsm</span>
<a href="#l64.13"></a><span id="l64.13" class="difflineplus">+		iteratorUtils.jsm \</span>
<a href="#l64.14"></a><span id="l64.14" class="difflineplus">+		jsTreeSelection.js \</span>
<a href="#l64.15"></a><span id="l64.15" class="difflineplus">+		traceHelper.js \</span>
<a href="#l64.16"></a><span id="l64.16" class="difflineplus">+		$(NULL)</span>
<a href="#l64.17"></a><span id="l64.17"> </span>
<a href="#l64.18"></a><span id="l64.18"> ifndef MOZ_STATIC_MAIL_BUILD</span>
<a href="#l64.19"></a><span id="l64.19"> </span>
<a href="#l64.20"></a><span id="l64.20"> ifdef MOZILLA_INTERNAL_API</span>
<a href="#l64.21"></a><span id="l64.21"> EXTRA_DSO_LDOPTS = \</span>
<a href="#l64.22"></a><span id="l64.22"> 	$(LIBS_DIR) \</span>
<a href="#l64.23"></a><span id="l64.23"> 	$(MOZDEPTH)/rdf/util/src/internal/$(LIB_PREFIX)rdfutil_s.$(LIB_SUFFIX) \</span>
<a href="#l64.24"></a><span id="l64.24"> 	$(MOZ_UNICHARUTIL_LIBS) \</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l65.1"></a><span id="l65.1">new file mode 100644</span>
<a href="#l65.2"></a><span id="l65.2" class="difflineminus">--- /dev/null</span>
<a href="#l65.3"></a><span id="l65.3" class="difflineplus">+++ b/mailnews/base/util/jsTreeSelection.js</span>
<a href="#l65.4"></a><span id="l65.4" class="difflineat">@@ -0,0 +1,648 @@</span>
<a href="#l65.5"></a><span id="l65.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l65.6"></a><span id="l65.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l65.7"></a><span id="l65.7" class="difflineplus">+ *</span>
<a href="#l65.8"></a><span id="l65.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l65.9"></a><span id="l65.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l65.10"></a><span id="l65.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l65.11"></a><span id="l65.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l65.12"></a><span id="l65.12" class="difflineplus">+ *</span>
<a href="#l65.13"></a><span id="l65.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l65.14"></a><span id="l65.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l65.15"></a><span id="l65.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l65.16"></a><span id="l65.16" class="difflineplus">+ * License.</span>
<a href="#l65.17"></a><span id="l65.17" class="difflineplus">+ *</span>
<a href="#l65.18"></a><span id="l65.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l65.19"></a><span id="l65.19" class="difflineplus">+ *</span>
<a href="#l65.20"></a><span id="l65.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l65.21"></a><span id="l65.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l65.22"></a><span id="l65.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l65.23"></a><span id="l65.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l65.24"></a><span id="l65.24" class="difflineplus">+ *</span>
<a href="#l65.25"></a><span id="l65.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l65.26"></a><span id="l65.26" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l65.27"></a><span id="l65.27" class="difflineplus">+ *</span>
<a href="#l65.28"></a><span id="l65.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l65.29"></a><span id="l65.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l65.30"></a><span id="l65.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l65.31"></a><span id="l65.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l65.32"></a><span id="l65.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l65.33"></a><span id="l65.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l65.34"></a><span id="l65.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l65.35"></a><span id="l65.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l65.36"></a><span id="l65.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l65.37"></a><span id="l65.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l65.38"></a><span id="l65.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l65.39"></a><span id="l65.39" class="difflineplus">+ *</span>
<a href="#l65.40"></a><span id="l65.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l65.41"></a><span id="l65.41" class="difflineplus">+</span>
<a href="#l65.42"></a><span id="l65.42" class="difflineplus">+EXPORTED_SYMBOLS = ['JSTreeSelection'];</span>
<a href="#l65.43"></a><span id="l65.43" class="difflineplus">+</span>
<a href="#l65.44"></a><span id="l65.44" class="difflineplus">+const Cc = Components.classes;</span>
<a href="#l65.45"></a><span id="l65.45" class="difflineplus">+const Ci = Components.interfaces;</span>
<a href="#l65.46"></a><span id="l65.46" class="difflineplus">+const Cr = Components.results;</span>
<a href="#l65.47"></a><span id="l65.47" class="difflineplus">+const Cu = Components.utils;</span>
<a href="#l65.48"></a><span id="l65.48" class="difflineplus">+</span>
<a href="#l65.49"></a><span id="l65.49" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l65.50"></a><span id="l65.50" class="difflineplus">+</span>
<a href="#l65.51"></a><span id="l65.51" class="difflineplus">+/**</span>
<a href="#l65.52"></a><span id="l65.52" class="difflineplus">+ * Partial nsITreeSelection implementation so that we can have nsMsgDBViews that</span>
<a href="#l65.53"></a><span id="l65.53" class="difflineplus">+ *  exist only for message display but do not need to be backed by a full</span>
<a href="#l65.54"></a><span id="l65.54" class="difflineplus">+ *  tree view widget.  This could also hopefully be used for more xpcshell unit</span>
<a href="#l65.55"></a><span id="l65.55" class="difflineplus">+ *  testing of the FolderDisplayWidget.  It might also be useful for creating</span>
<a href="#l65.56"></a><span id="l65.56" class="difflineplus">+ *  transient selections when right-click selection happens.</span>
<a href="#l65.57"></a><span id="l65.57" class="difflineplus">+ *</span>
<a href="#l65.58"></a><span id="l65.58" class="difflineplus">+ * Our current limitations:</span>
<a href="#l65.59"></a><span id="l65.59" class="difflineplus">+ * - We do not support any single selection modes.  This is mainly because we</span>
<a href="#l65.60"></a><span id="l65.60" class="difflineplus">+ *   need to look at the box object for that and we don't want to do it.</span>
<a href="#l65.61"></a><span id="l65.61" class="difflineplus">+ * - Timed selection.  Our expected consumers don't use it.</span>
<a href="#l65.62"></a><span id="l65.62" class="difflineplus">+ *</span>
<a href="#l65.63"></a><span id="l65.63" class="difflineplus">+ * Our current laziness:</span>
<a href="#l65.64"></a><span id="l65.64" class="difflineplus">+ * - We aren't very precise about invalidation when it would be potentially</span>
<a href="#l65.65"></a><span id="l65.65" class="difflineplus">+ *   complicated.  The theory is that if there is a tree box object, it's</span>
<a href="#l65.66"></a><span id="l65.66" class="difflineplus">+ *   probably native and the XPConnect overhead is probably a lot more than</span>
<a href="#l65.67"></a><span id="l65.67" class="difflineplus">+ *   any potential savings, at least for now when the tree display is</span>
<a href="#l65.68"></a><span id="l65.68" class="difflineplus">+ *   generally C++ XPCOM backed rather than JS XPCOM backed.  Also, we</span>
<a href="#l65.69"></a><span id="l65.69" class="difflineplus">+ *   aren't intended to actually be used with a real tree display; you should</span>
<a href="#l65.70"></a><span id="l65.70" class="difflineplus">+ *   be using the C++ object in that case!</span>
<a href="#l65.71"></a><span id="l65.71" class="difflineplus">+ *</span>
<a href="#l65.72"></a><span id="l65.72" class="difflineplus">+ * If documentation is omitted for something, it is because we have little to</span>
<a href="#l65.73"></a><span id="l65.73" class="difflineplus">+ *  add to the documentation of nsITreeSelection and really hope that our</span>
<a href="#l65.74"></a><span id="l65.74" class="difflineplus">+ *  documentation tool will copy-down that documentation.</span>
<a href="#l65.75"></a><span id="l65.75" class="difflineplus">+ *</span>
<a href="#l65.76"></a><span id="l65.76" class="difflineplus">+ * This implementation attempts to mimic the behavior of nsTreeSelection.  In</span>
<a href="#l65.77"></a><span id="l65.77" class="difflineplus">+ *  a few cases, this leads to potentially confusing actions.  I attempt to note</span>
<a href="#l65.78"></a><span id="l65.78" class="difflineplus">+ *  when we are doing this and why we do it.</span>
<a href="#l65.79"></a><span id="l65.79" class="difflineplus">+ *</span>
<a href="#l65.80"></a><span id="l65.80" class="difflineplus">+ * Unit test is in mailnews/base/util/test_jsTreeSelection.js</span>
<a href="#l65.81"></a><span id="l65.81" class="difflineplus">+ */</span>
<a href="#l65.82"></a><span id="l65.82" class="difflineplus">+function JSTreeSelection(aTreeBoxObject) {</span>
<a href="#l65.83"></a><span id="l65.83" class="difflineplus">+  this._treeBoxObject = aTreeBoxObject;</span>
<a href="#l65.84"></a><span id="l65.84" class="difflineplus">+</span>
<a href="#l65.85"></a><span id="l65.85" class="difflineplus">+  this._currentIndex = null;</span>
<a href="#l65.86"></a><span id="l65.86" class="difflineplus">+  this._shiftSelectPivot = null;</span>
<a href="#l65.87"></a><span id="l65.87" class="difflineplus">+  this._ranges = [];</span>
<a href="#l65.88"></a><span id="l65.88" class="difflineplus">+  this._count = 0;</span>
<a href="#l65.89"></a><span id="l65.89" class="difflineplus">+</span>
<a href="#l65.90"></a><span id="l65.90" class="difflineplus">+  this._selectEventsSuppressed = false;</span>
<a href="#l65.91"></a><span id="l65.91" class="difflineplus">+}</span>
<a href="#l65.92"></a><span id="l65.92" class="difflineplus">+JSTreeSelection.prototype = {</span>
<a href="#l65.93"></a><span id="l65.93" class="difflineplus">+  /**</span>
<a href="#l65.94"></a><span id="l65.94" class="difflineplus">+   * The current nsITreeBoxObject, appropriately QueryInterfaced.  May be null.</span>
<a href="#l65.95"></a><span id="l65.95" class="difflineplus">+   */</span>
<a href="#l65.96"></a><span id="l65.96" class="difflineplus">+  _treeBoxObject: null,</span>
<a href="#l65.97"></a><span id="l65.97" class="difflineplus">+</span>
<a href="#l65.98"></a><span id="l65.98" class="difflineplus">+  /**</span>
<a href="#l65.99"></a><span id="l65.99" class="difflineplus">+   * Where the focus rectangle (that little dotted thing) shows up.  Just</span>
<a href="#l65.100"></a><span id="l65.100" class="difflineplus">+   *  because something is focused does not mean it is actually selected.</span>
<a href="#l65.101"></a><span id="l65.101" class="difflineplus">+   */</span>
<a href="#l65.102"></a><span id="l65.102" class="difflineplus">+  _currentIndex: null,</span>
<a href="#l65.103"></a><span id="l65.103" class="difflineplus">+  /**</span>
<a href="#l65.104"></a><span id="l65.104" class="difflineplus">+   * The view index where the shift is anchored when it is not (conceptually)</span>
<a href="#l65.105"></a><span id="l65.105" class="difflineplus">+   *  the same as _currentIndex.  This only happens when you perform a ranged</span>
<a href="#l65.106"></a><span id="l65.106" class="difflineplus">+   *  selection.  In that case, the start index of the ranged selection becomes</span>
<a href="#l65.107"></a><span id="l65.107" class="difflineplus">+   *  the shift pivot (and the _currentIndex becomes the end of the ranged</span>
<a href="#l65.108"></a><span id="l65.108" class="difflineplus">+   *  selection.)</span>
<a href="#l65.109"></a><span id="l65.109" class="difflineplus">+   * It gets cleared whenever the selection changes and it's not the result of</span>
<a href="#l65.110"></a><span id="l65.110" class="difflineplus">+   *  a call to rangedSelect.</span>
<a href="#l65.111"></a><span id="l65.111" class="difflineplus">+   */</span>
<a href="#l65.112"></a><span id="l65.112" class="difflineplus">+  _shiftSelectPivot: null,</span>
<a href="#l65.113"></a><span id="l65.113" class="difflineplus">+  /**</span>
<a href="#l65.114"></a><span id="l65.114" class="difflineplus">+   * A list of [lowIndexInclusive, highIndexInclusive] non-overlapping,</span>
<a href="#l65.115"></a><span id="l65.115" class="difflineplus">+   *  non-adjacent 'tuples' sort in ascending order.</span>
<a href="#l65.116"></a><span id="l65.116" class="difflineplus">+   */</span>
<a href="#l65.117"></a><span id="l65.117" class="difflineplus">+  _ranges: [],</span>
<a href="#l65.118"></a><span id="l65.118" class="difflineplus">+  /**</span>
<a href="#l65.119"></a><span id="l65.119" class="difflineplus">+   * The number of currently selected rows.</span>
<a href="#l65.120"></a><span id="l65.120" class="difflineplus">+   */</span>
<a href="#l65.121"></a><span id="l65.121" class="difflineplus">+  _count: 0,</span>
<a href="#l65.122"></a><span id="l65.122" class="difflineplus">+</span>
<a href="#l65.123"></a><span id="l65.123" class="difflineplus">+  get tree JSTreeSelection_get_treeBoxObject() {</span>
<a href="#l65.124"></a><span id="l65.124" class="difflineplus">+    return this._treeBoxObject;</span>
<a href="#l65.125"></a><span id="l65.125" class="difflineplus">+  },</span>
<a href="#l65.126"></a><span id="l65.126" class="difflineplus">+  set tree JSTreeSelection_set_treeBoxObject(aTreeBoxObject) {</span>
<a href="#l65.127"></a><span id="l65.127" class="difflineplus">+    this._treeBoxObject = aTreeBoxObject;</span>
<a href="#l65.128"></a><span id="l65.128" class="difflineplus">+  },</span>
<a href="#l65.129"></a><span id="l65.129" class="difflineplus">+</span>
<a href="#l65.130"></a><span id="l65.130" class="difflineplus">+  /**</span>
<a href="#l65.131"></a><span id="l65.131" class="difflineplus">+   * Although the nsITreeSelection documentation doesn't say, what this method</span>
<a href="#l65.132"></a><span id="l65.132" class="difflineplus">+   *  is supposed to do is check if the seltype attribute on the XUL tree is any</span>
<a href="#l65.133"></a><span id="l65.133" class="difflineplus">+   *  of the following: &quot;single&quot; (only a single row may be selected at a time,</span>
<a href="#l65.134"></a><span id="l65.134" class="difflineplus">+   *  &quot;cell&quot; (a single cell may be selected), or &quot;text&quot; (the row gets selected</span>
<a href="#l65.135"></a><span id="l65.135" class="difflineplus">+   *  but only the primary column shows up as selected.)</span>
<a href="#l65.136"></a><span id="l65.136" class="difflineplus">+   *</span>
<a href="#l65.137"></a><span id="l65.137" class="difflineplus">+   * @return false because we don't support single-selection.</span>
<a href="#l65.138"></a><span id="l65.138" class="difflineplus">+   */</span>
<a href="#l65.139"></a><span id="l65.139" class="difflineplus">+  get single JSTreeSelection_get_single() {</span>
<a href="#l65.140"></a><span id="l65.140" class="difflineplus">+    return false;</span>
<a href="#l65.141"></a><span id="l65.141" class="difflineplus">+  },</span>
<a href="#l65.142"></a><span id="l65.142" class="difflineplus">+</span>
<a href="#l65.143"></a><span id="l65.143" class="difflineplus">+  _updateCount: function JSTreeSelection__updateCount() {</span>
<a href="#l65.144"></a><span id="l65.144" class="difflineplus">+    this._count = 0;</span>
<a href="#l65.145"></a><span id="l65.145" class="difflineplus">+    for each (let [, [low, high]] in Iterator(this._ranges)) {</span>
<a href="#l65.146"></a><span id="l65.146" class="difflineplus">+      this._count += high - low + 1;</span>
<a href="#l65.147"></a><span id="l65.147" class="difflineplus">+    }</span>
<a href="#l65.148"></a><span id="l65.148" class="difflineplus">+  },</span>
<a href="#l65.149"></a><span id="l65.149" class="difflineplus">+</span>
<a href="#l65.150"></a><span id="l65.150" class="difflineplus">+  get count JSTreeSelection_get_count() {</span>
<a href="#l65.151"></a><span id="l65.151" class="difflineplus">+    return this._count;</span>
<a href="#l65.152"></a><span id="l65.152" class="difflineplus">+  },</span>
<a href="#l65.153"></a><span id="l65.153" class="difflineplus">+</span>
<a href="#l65.154"></a><span id="l65.154" class="difflineplus">+  isSelected: function JSTreeSelection_isSelected(aViewIndex) {</span>
<a href="#l65.155"></a><span id="l65.155" class="difflineplus">+    for each (let [,[low, high]] in Iterator(this._ranges)) {</span>
<a href="#l65.156"></a><span id="l65.156" class="difflineplus">+      if (aViewIndex &gt;= low &amp;&amp; aViewIndex &lt;= high)</span>
<a href="#l65.157"></a><span id="l65.157" class="difflineplus">+        return true;</span>
<a href="#l65.158"></a><span id="l65.158" class="difflineplus">+    }</span>
<a href="#l65.159"></a><span id="l65.159" class="difflineplus">+    return false;</span>
<a href="#l65.160"></a><span id="l65.160" class="difflineplus">+  },</span>
<a href="#l65.161"></a><span id="l65.161" class="difflineplus">+</span>
<a href="#l65.162"></a><span id="l65.162" class="difflineplus">+  /**</span>
<a href="#l65.163"></a><span id="l65.163" class="difflineplus">+   * Select the given row.  It does nothing if that row was already selected.</span>
<a href="#l65.164"></a><span id="l65.164" class="difflineplus">+   */</span>
<a href="#l65.165"></a><span id="l65.165" class="difflineplus">+  select: function JSTreeSelection_select(aViewIndex) {</span>
<a href="#l65.166"></a><span id="l65.166" class="difflineplus">+    // current index will provide our effective shift pivot</span>
<a href="#l65.167"></a><span id="l65.167" class="difflineplus">+    this._shiftSelectPivot = null;</span>
<a href="#l65.168"></a><span id="l65.168" class="difflineplus">+    this.currentIndex = aViewIndex;</span>
<a href="#l65.169"></a><span id="l65.169" class="difflineplus">+</span>
<a href="#l65.170"></a><span id="l65.170" class="difflineplus">+    if (this._count == 1 &amp;&amp; this._ranges[0][0] == aViewIndex)</span>
<a href="#l65.171"></a><span id="l65.171" class="difflineplus">+      return;</span>
<a href="#l65.172"></a><span id="l65.172" class="difflineplus">+</span>
<a href="#l65.173"></a><span id="l65.173" class="difflineplus">+    this._count = 1;</span>
<a href="#l65.174"></a><span id="l65.174" class="difflineplus">+    this._ranges = [[aViewIndex, aViewIndex]];</span>
<a href="#l65.175"></a><span id="l65.175" class="difflineplus">+</span>
<a href="#l65.176"></a><span id="l65.176" class="difflineplus">+    if (this._treeBoxObject)</span>
<a href="#l65.177"></a><span id="l65.177" class="difflineplus">+      this._treeBoxObject.invalidate();</span>
<a href="#l65.178"></a><span id="l65.178" class="difflineplus">+</span>
<a href="#l65.179"></a><span id="l65.179" class="difflineplus">+    this._fireSelectionChanged();</span>
<a href="#l65.180"></a><span id="l65.180" class="difflineplus">+  },</span>
<a href="#l65.181"></a><span id="l65.181" class="difflineplus">+</span>
<a href="#l65.182"></a><span id="l65.182" class="difflineplus">+  timedSelect: function JSTreeSelection_timedSelect(aIndex, aDelay) {</span>
<a href="#l65.183"></a><span id="l65.183" class="difflineplus">+    throw new Error(&quot;We do not implement timed selection.&quot;);</span>
<a href="#l65.184"></a><span id="l65.184" class="difflineplus">+  },</span>
<a href="#l65.185"></a><span id="l65.185" class="difflineplus">+</span>
<a href="#l65.186"></a><span id="l65.186" class="difflineplus">+  toggleSelect: function JSTreeSelection_toggleSelect(aIndex) {</span>
<a href="#l65.187"></a><span id="l65.187" class="difflineplus">+    this.currentIndex = aIndex;</span>
<a href="#l65.188"></a><span id="l65.188" class="difflineplus">+    for each (let [iTupe, [low, high]] in Iterator(this._ranges)) {</span>
<a href="#l65.189"></a><span id="l65.189" class="difflineplus">+      // below the range? add it to the existing range or create a new one</span>
<a href="#l65.190"></a><span id="l65.190" class="difflineplus">+      if (aIndex &lt; low) {</span>
<a href="#l65.191"></a><span id="l65.191" class="difflineplus">+        this._count++;</span>
<a href="#l65.192"></a><span id="l65.192" class="difflineplus">+        // is it just below an existing range? (range fusion only happens in the</span>
<a href="#l65.193"></a><span id="l65.193" class="difflineplus">+        //  high case, not here.)</span>
<a href="#l65.194"></a><span id="l65.194" class="difflineplus">+        if (aIndex == low - 1) {</span>
<a href="#l65.195"></a><span id="l65.195" class="difflineplus">+          this._ranges[iTupe][0] = aIndex;</span>
<a href="#l65.196"></a><span id="l65.196" class="difflineplus">+          break;</span>
<a href="#l65.197"></a><span id="l65.197" class="difflineplus">+        }</span>
<a href="#l65.198"></a><span id="l65.198" class="difflineplus">+        // then it gets its own range</span>
<a href="#l65.199"></a><span id="l65.199" class="difflineplus">+        this._ranges.splice(iTupe, 0, [aIndex, aIndex]);</span>
<a href="#l65.200"></a><span id="l65.200" class="difflineplus">+        break;</span>
<a href="#l65.201"></a><span id="l65.201" class="difflineplus">+      }</span>
<a href="#l65.202"></a><span id="l65.202" class="difflineplus">+      // in the range?  will need to either nuke, shrink, or split the range to</span>
<a href="#l65.203"></a><span id="l65.203" class="difflineplus">+      //  remove it</span>
<a href="#l65.204"></a><span id="l65.204" class="difflineplus">+      if (aIndex &gt;= low &amp;&amp; aIndex &lt;= high) {</span>
<a href="#l65.205"></a><span id="l65.205" class="difflineplus">+        this._count--;</span>
<a href="#l65.206"></a><span id="l65.206" class="difflineplus">+        // nuke</span>
<a href="#l65.207"></a><span id="l65.207" class="difflineplus">+        if (aIndex == low &amp;&amp; aIndex == high)</span>
<a href="#l65.208"></a><span id="l65.208" class="difflineplus">+          this._ranges.splice(iTupe, 1);</span>
<a href="#l65.209"></a><span id="l65.209" class="difflineplus">+        // lower shrink</span>
<a href="#l65.210"></a><span id="l65.210" class="difflineplus">+        else if (aIndex == low)</span>
<a href="#l65.211"></a><span id="l65.211" class="difflineplus">+          this._ranges[iTupe][0] = aIndex + 1;</span>
<a href="#l65.212"></a><span id="l65.212" class="difflineplus">+        // upper shrink</span>
<a href="#l65.213"></a><span id="l65.213" class="difflineplus">+        else if (aIndex == high)</span>
<a href="#l65.214"></a><span id="l65.214" class="difflineplus">+          this._ranges[iTupe][1] = aIndex - 1;</span>
<a href="#l65.215"></a><span id="l65.215" class="difflineplus">+        // split</span>
<a href="#l65.216"></a><span id="l65.216" class="difflineplus">+        else</span>
<a href="#l65.217"></a><span id="l65.217" class="difflineplus">+          this._ranges.splice(iTupe, 1, [low, aIndex - 1], [aIndex + 1, high]);</span>
<a href="#l65.218"></a><span id="l65.218" class="difflineplus">+        break;</span>
<a href="#l65.219"></a><span id="l65.219" class="difflineplus">+      }</span>
<a href="#l65.220"></a><span id="l65.220" class="difflineplus">+      // just above the range?  fuse into the range, and possibly the next</span>
<a href="#l65.221"></a><span id="l65.221" class="difflineplus">+      //  range up.</span>
<a href="#l65.222"></a><span id="l65.222" class="difflineplus">+      if (aIndex == high + 1) {</span>
<a href="#l65.223"></a><span id="l65.223" class="difflineplus">+        this._count++;</span>
<a href="#l65.224"></a><span id="l65.224" class="difflineplus">+        // see if there is another range and there was just a gap of one between</span>
<a href="#l65.225"></a><span id="l65.225" class="difflineplus">+        //  the two ranges.</span>
<a href="#l65.226"></a><span id="l65.226" class="difflineplus">+        if ((iTupe + 1 &lt; this._ranges.length) &amp;&amp;</span>
<a href="#l65.227"></a><span id="l65.227" class="difflineplus">+            (this._ranges[iTupe+1][0] == aIndex + 1)) {</span>
<a href="#l65.228"></a><span id="l65.228" class="difflineplus">+          // yes, merge the ranges</span>
<a href="#l65.229"></a><span id="l65.229" class="difflineplus">+          this._ranges.splice(iTupe, 2, [low, this._ranges[iTupe+1][1]]);</span>
<a href="#l65.230"></a><span id="l65.230" class="difflineplus">+          break;</span>
<a href="#l65.231"></a><span id="l65.231" class="difflineplus">+        }</span>
<a href="#l65.232"></a><span id="l65.232" class="difflineplus">+        // nope, no merge required, just update the range</span>
<a href="#l65.233"></a><span id="l65.233" class="difflineplus">+        this._ranges[iTupe][1] = aIndex;</span>
<a href="#l65.234"></a><span id="l65.234" class="difflineplus">+        break;</span>
<a href="#l65.235"></a><span id="l65.235" class="difflineplus">+      }</span>
<a href="#l65.236"></a><span id="l65.236" class="difflineplus">+      // otherwise we need to keep going</span>
<a href="#l65.237"></a><span id="l65.237" class="difflineplus">+    }</span>
<a href="#l65.238"></a><span id="l65.238" class="difflineplus">+</span>
<a href="#l65.239"></a><span id="l65.239" class="difflineplus">+    if (this._treeBoxObject)</span>
<a href="#l65.240"></a><span id="l65.240" class="difflineplus">+      this._treeBoxObject.invalidateRow(aIndex);</span>
<a href="#l65.241"></a><span id="l65.241" class="difflineplus">+    this._fireSelectionChanged();</span>
<a href="#l65.242"></a><span id="l65.242" class="difflineplus">+  },</span>
<a href="#l65.243"></a><span id="l65.243" class="difflineplus">+</span>
<a href="#l65.244"></a><span id="l65.244" class="difflineplus">+  /**</span>
<a href="#l65.245"></a><span id="l65.245" class="difflineplus">+   * @param aRangeStart If omitted, it implies a shift-selection is happening,</span>
<a href="#l65.246"></a><span id="l65.246" class="difflineplus">+   *     in which case we use _shiftSelectPivot as the start if we have it,</span>
<a href="#l65.247"></a><span id="l65.247" class="difflineplus">+   *     _currentIndex if we don't, and if we somehow didn't have a</span>
<a href="#l65.248"></a><span id="l65.248" class="difflineplus">+   *     _currentIndex, we use the range end.</span>
<a href="#l65.249"></a><span id="l65.249" class="difflineplus">+   * @param aRangeEnd Just the inclusive end of the range.</span>
<a href="#l65.250"></a><span id="l65.250" class="difflineplus">+   * @param aAugment Does this set a new selection or should it be merged with</span>
<a href="#l65.251"></a><span id="l65.251" class="difflineplus">+   *     the existing selection?</span>
<a href="#l65.252"></a><span id="l65.252" class="difflineplus">+   */</span>
<a href="#l65.253"></a><span id="l65.253" class="difflineplus">+  rangedSelect: function JSTreeSelection_rangedSelect(aRangeStart, aRangeEnd,</span>
<a href="#l65.254"></a><span id="l65.254" class="difflineplus">+                                                      aAugment) {</span>
<a href="#l65.255"></a><span id="l65.255" class="difflineplus">+    if (aRangeStart == -1) {</span>
<a href="#l65.256"></a><span id="l65.256" class="difflineplus">+      if (this._shiftSelectPivot != null)</span>
<a href="#l65.257"></a><span id="l65.257" class="difflineplus">+        aRangeStart = this._shiftSelectPivot;</span>
<a href="#l65.258"></a><span id="l65.258" class="difflineplus">+      else if (this._currentIndex != null)</span>
<a href="#l65.259"></a><span id="l65.259" class="difflineplus">+        aRangeStart = this._currentIndex;</span>
<a href="#l65.260"></a><span id="l65.260" class="difflineplus">+      else</span>
<a href="#l65.261"></a><span id="l65.261" class="difflineplus">+        aRangeStart = aRangeEnd;</span>
<a href="#l65.262"></a><span id="l65.262" class="difflineplus">+    }</span>
<a href="#l65.263"></a><span id="l65.263" class="difflineplus">+</span>
<a href="#l65.264"></a><span id="l65.264" class="difflineplus">+    this._shiftSelectPivot = aRangeStart;</span>
<a href="#l65.265"></a><span id="l65.265" class="difflineplus">+    this.currentIndex = aRangeEnd;</span>
<a href="#l65.266"></a><span id="l65.266" class="difflineplus">+</span>
<a href="#l65.267"></a><span id="l65.267" class="difflineplus">+    // enforce our ordering constraint for our ranges</span>
<a href="#l65.268"></a><span id="l65.268" class="difflineplus">+    if (aRangeStart &gt; aRangeEnd)</span>
<a href="#l65.269"></a><span id="l65.269" class="difflineplus">+      [aRangeStart, aRangeEnd] = [aRangeEnd, aRangeStart];</span>
<a href="#l65.270"></a><span id="l65.270" class="difflineplus">+</span>
<a href="#l65.271"></a><span id="l65.271" class="difflineplus">+    // if we're not augmenting, then this is really easy.</span>
<a href="#l65.272"></a><span id="l65.272" class="difflineplus">+    if (!aAugment) {</span>
<a href="#l65.273"></a><span id="l65.273" class="difflineplus">+      this._count = aRangeEnd - aRangeStart + 1;</span>
<a href="#l65.274"></a><span id="l65.274" class="difflineplus">+      this._ranges = [[aRangeStart, aRangeEnd]];</span>
<a href="#l65.275"></a><span id="l65.275" class="difflineplus">+      if (this._treeBoxObject)</span>
<a href="#l65.276"></a><span id="l65.276" class="difflineplus">+        this._treeBoxObject.invalidate();</span>
<a href="#l65.277"></a><span id="l65.277" class="difflineplus">+      this._fireSelectionChanged();</span>
<a href="#l65.278"></a><span id="l65.278" class="difflineplus">+      return;</span>
<a href="#l65.279"></a><span id="l65.279" class="difflineplus">+    }</span>
<a href="#l65.280"></a><span id="l65.280" class="difflineplus">+</span>
<a href="#l65.281"></a><span id="l65.281" class="difflineplus">+    // Iterate over our existing set of ranges, finding the 'range' of ranges</span>
<a href="#l65.282"></a><span id="l65.282" class="difflineplus">+    //  that our new range overlaps or simply obviates.</span>
<a href="#l65.283"></a><span id="l65.283" class="difflineplus">+    // Overlap variables track blocks we need to keep some part of, Nuke</span>
<a href="#l65.284"></a><span id="l65.284" class="difflineplus">+    //  variables are for blocks that get spliced out.  For our purposes, all</span>
<a href="#l65.285"></a><span id="l65.285" class="difflineplus">+    //  overlap blocks are also nuke blocks.</span>
<a href="#l65.286"></a><span id="l65.286" class="difflineplus">+    let lowOverlap, lowNuke, highNuke, highOverlap;</span>
<a href="#l65.287"></a><span id="l65.287" class="difflineplus">+    // in case there is no overlap, also figure an insertionPoint</span>
<a href="#l65.288"></a><span id="l65.288" class="difflineplus">+    let insertionPoint = this._ranges.length; // default to the end</span>
<a href="#l65.289"></a><span id="l65.289" class="difflineplus">+    for each (let [iTupe, [low, high]] in Iterator(this._ranges)) {</span>
<a href="#l65.290"></a><span id="l65.290" class="difflineplus">+      // If it's completely include the range, it should be nuked</span>
<a href="#l65.291"></a><span id="l65.291" class="difflineplus">+      if (aRangeStart &lt;= low &amp;&amp; aRangeEnd &gt;= high) {</span>
<a href="#l65.292"></a><span id="l65.292" class="difflineplus">+        if (lowNuke == null) // only the first one we see is the low one</span>
<a href="#l65.293"></a><span id="l65.293" class="difflineplus">+          lowNuke = iTupe;</span>
<a href="#l65.294"></a><span id="l65.294" class="difflineplus">+        highNuke = iTupe;</span>
<a href="#l65.295"></a><span id="l65.295" class="difflineplus">+      }</span>
<a href="#l65.296"></a><span id="l65.296" class="difflineplus">+      // If our new range start is inside a range or is adjacent, it's overlap</span>
<a href="#l65.297"></a><span id="l65.297" class="difflineplus">+      if (aRangeStart &gt;= low - 1 &amp;&amp; aRangeStart &lt;= high + 1 &amp;&amp;</span>
<a href="#l65.298"></a><span id="l65.298" class="difflineplus">+          lowOverlap == null)</span>
<a href="#l65.299"></a><span id="l65.299" class="difflineplus">+        lowOverlap = lowNuke = highNuke = iTupe;</span>
<a href="#l65.300"></a><span id="l65.300" class="difflineplus">+      // If our new range ends inside a range or is adjacent, it's overlap</span>
<a href="#l65.301"></a><span id="l65.301" class="difflineplus">+      if (aRangeEnd &gt;= low - 1 &amp;&amp; aRangeEnd &lt;= high + 1) {</span>
<a href="#l65.302"></a><span id="l65.302" class="difflineplus">+        highOverlap = highNuke = iTupe;</span>
<a href="#l65.303"></a><span id="l65.303" class="difflineplus">+        if (lowNuke == null)</span>
<a href="#l65.304"></a><span id="l65.304" class="difflineplus">+          lowNuke = iTupe;</span>
<a href="#l65.305"></a><span id="l65.305" class="difflineplus">+      }</span>
<a href="#l65.306"></a><span id="l65.306" class="difflineplus">+</span>
<a href="#l65.307"></a><span id="l65.307" class="difflineplus">+      // we're done when no more overlap is possible</span>
<a href="#l65.308"></a><span id="l65.308" class="difflineplus">+      if (aRangeEnd &lt; low) {</span>
<a href="#l65.309"></a><span id="l65.309" class="difflineplus">+        insertionPoint = iTupe;</span>
<a href="#l65.310"></a><span id="l65.310" class="difflineplus">+        break;</span>
<a href="#l65.311"></a><span id="l65.311" class="difflineplus">+      }</span>
<a href="#l65.312"></a><span id="l65.312" class="difflineplus">+    }</span>
<a href="#l65.313"></a><span id="l65.313" class="difflineplus">+</span>
<a href="#l65.314"></a><span id="l65.314" class="difflineplus">+    if (lowOverlap != null)</span>
<a href="#l65.315"></a><span id="l65.315" class="difflineplus">+      aRangeStart = Math.min(aRangeStart, this._ranges[lowOverlap][0]);</span>
<a href="#l65.316"></a><span id="l65.316" class="difflineplus">+    if (highOverlap != null)</span>
<a href="#l65.317"></a><span id="l65.317" class="difflineplus">+      aRangeEnd = Math.max(aRangeEnd, this._ranges[highOverlap][1]);</span>
<a href="#l65.318"></a><span id="l65.318" class="difflineplus">+    if (lowNuke != null)</span>
<a href="#l65.319"></a><span id="l65.319" class="difflineplus">+      this._ranges.splice(lowNuke, highNuke - lowNuke + 1,</span>
<a href="#l65.320"></a><span id="l65.320" class="difflineplus">+                          [aRangeStart, aRangeEnd]);</span>
<a href="#l65.321"></a><span id="l65.321" class="difflineplus">+    else</span>
<a href="#l65.322"></a><span id="l65.322" class="difflineplus">+      this._ranges.splice(insertionPoint, 0, [aRangeStart, aRangeEnd]);</span>
<a href="#l65.323"></a><span id="l65.323" class="difflineplus">+</span>
<a href="#l65.324"></a><span id="l65.324" class="difflineplus">+    this._updateCount();</span>
<a href="#l65.325"></a><span id="l65.325" class="difflineplus">+    if (this._treeBoxObject)</span>
<a href="#l65.326"></a><span id="l65.326" class="difflineplus">+      this._treeBoxObject.invalidate();</span>
<a href="#l65.327"></a><span id="l65.327" class="difflineplus">+    this._fireSelectionChanged();</span>
<a href="#l65.328"></a><span id="l65.328" class="difflineplus">+  },</span>
<a href="#l65.329"></a><span id="l65.329" class="difflineplus">+</span>
<a href="#l65.330"></a><span id="l65.330" class="difflineplus">+  /**</span>
<a href="#l65.331"></a><span id="l65.331" class="difflineplus">+   * This is basically RangedSelect but without insertion of a new range and we</span>
<a href="#l65.332"></a><span id="l65.332" class="difflineplus">+   *  don't need to worry about adjacency.</span>
<a href="#l65.333"></a><span id="l65.333" class="difflineplus">+   * Oddly, nsTreeSelection doesn't fire a selection changed event here...</span>
<a href="#l65.334"></a><span id="l65.334" class="difflineplus">+   */</span>
<a href="#l65.335"></a><span id="l65.335" class="difflineplus">+  clearRange: function JSTreeSelection_clearRange(aRangeStart, aRangeEnd) {</span>
<a href="#l65.336"></a><span id="l65.336" class="difflineplus">+    // Iterate over our existing set of ranges, finding the 'range' of ranges</span>
<a href="#l65.337"></a><span id="l65.337" class="difflineplus">+    //  that our clear range overlaps or simply obviates.</span>
<a href="#l65.338"></a><span id="l65.338" class="difflineplus">+    // Overlap variables track blocks we need to keep some part of, Nuke</span>
<a href="#l65.339"></a><span id="l65.339" class="difflineplus">+    //  variables are for blocks that get spliced out.  For our purposes, all</span>
<a href="#l65.340"></a><span id="l65.340" class="difflineplus">+    //  overlap blocks are also nuke blocks.</span>
<a href="#l65.341"></a><span id="l65.341" class="difflineplus">+    let lowOverlap, lowNuke, highNuke, highOverlap;</span>
<a href="#l65.342"></a><span id="l65.342" class="difflineplus">+    for each (let [iTupe, [low, high]] in Iterator(this._ranges)) {</span>
<a href="#l65.343"></a><span id="l65.343" class="difflineplus">+      // If we completely include the range, it should be nuked</span>
<a href="#l65.344"></a><span id="l65.344" class="difflineplus">+      if (aRangeStart &lt;= low &amp;&amp; aRangeEnd &gt;= high) {</span>
<a href="#l65.345"></a><span id="l65.345" class="difflineplus">+        if (lowNuke == null) // only the first one we see is the low one</span>
<a href="#l65.346"></a><span id="l65.346" class="difflineplus">+          lowNuke = iTupe;</span>
<a href="#l65.347"></a><span id="l65.347" class="difflineplus">+        highNuke = iTupe;</span>
<a href="#l65.348"></a><span id="l65.348" class="difflineplus">+      }</span>
<a href="#l65.349"></a><span id="l65.349" class="difflineplus">+      // If our new range start is inside a range, it's nuke and maybe overlap</span>
<a href="#l65.350"></a><span id="l65.350" class="difflineplus">+      if (aRangeStart &gt;= low &amp;&amp; aRangeStart &lt;= high &amp;&amp; lowNuke == null) {</span>
<a href="#l65.351"></a><span id="l65.351" class="difflineplus">+        lowNuke = highNuke = iTupe;</span>
<a href="#l65.352"></a><span id="l65.352" class="difflineplus">+        // it's only overlap if we don't match at the low end</span>
<a href="#l65.353"></a><span id="l65.353" class="difflineplus">+        if (aRangeStart &gt; low)</span>
<a href="#l65.354"></a><span id="l65.354" class="difflineplus">+          lowOverlap = iTupe;</span>
<a href="#l65.355"></a><span id="l65.355" class="difflineplus">+      }</span>
<a href="#l65.356"></a><span id="l65.356" class="difflineplus">+      // If our new range ends inside a range, it's nuke and maybe overlap</span>
<a href="#l65.357"></a><span id="l65.357" class="difflineplus">+      if (aRangeEnd &gt;= low &amp;&amp; aRangeEnd &lt;= high) {</span>
<a href="#l65.358"></a><span id="l65.358" class="difflineplus">+        highNuke = iTupe;</span>
<a href="#l65.359"></a><span id="l65.359" class="difflineplus">+        // it's only overlap if we don't match at the high end</span>
<a href="#l65.360"></a><span id="l65.360" class="difflineplus">+        if (aRangeEnd &lt; high)</span>
<a href="#l65.361"></a><span id="l65.361" class="difflineplus">+          highOverlap = iTupe;</span>
<a href="#l65.362"></a><span id="l65.362" class="difflineplus">+        if (lowNuke == null)</span>
<a href="#l65.363"></a><span id="l65.363" class="difflineplus">+          lowNuke = iTupe;</span>
<a href="#l65.364"></a><span id="l65.364" class="difflineplus">+      }</span>
<a href="#l65.365"></a><span id="l65.365" class="difflineplus">+</span>
<a href="#l65.366"></a><span id="l65.366" class="difflineplus">+      // we're done when no more overlap is possible</span>
<a href="#l65.367"></a><span id="l65.367" class="difflineplus">+      if (aRangeEnd &lt; low)</span>
<a href="#l65.368"></a><span id="l65.368" class="difflineplus">+        break;</span>
<a href="#l65.369"></a><span id="l65.369" class="difflineplus">+    }</span>
<a href="#l65.370"></a><span id="l65.370" class="difflineplus">+    // nothing to do since there's nothing to nuke</span>
<a href="#l65.371"></a><span id="l65.371" class="difflineplus">+    if (lowNuke == null)</span>
<a href="#l65.372"></a><span id="l65.372" class="difflineplus">+      return;</span>
<a href="#l65.373"></a><span id="l65.373" class="difflineplus">+    let args = [lowNuke, highNuke - lowNuke + 1];</span>
<a href="#l65.374"></a><span id="l65.374" class="difflineplus">+    if (lowOverlap != null)</span>
<a href="#l65.375"></a><span id="l65.375" class="difflineplus">+      args.push([this._ranges[lowOverlap][0], aRangeStart - 1]);</span>
<a href="#l65.376"></a><span id="l65.376" class="difflineplus">+    if (highOverlap != null)</span>
<a href="#l65.377"></a><span id="l65.377" class="difflineplus">+      args.push([aRangeEnd + 1, this._ranges[highOverlap][1]]);</span>
<a href="#l65.378"></a><span id="l65.378" class="difflineplus">+    this._ranges.splice.apply(this._ranges, args);</span>
<a href="#l65.379"></a><span id="l65.379" class="difflineplus">+</span>
<a href="#l65.380"></a><span id="l65.380" class="difflineplus">+    this._updateCount();</span>
<a href="#l65.381"></a><span id="l65.381" class="difflineplus">+    if (this._treeBoxObject)</span>
<a href="#l65.382"></a><span id="l65.382" class="difflineplus">+      this._treeBoxObject.invalidate();</span>
<a href="#l65.383"></a><span id="l65.383" class="difflineplus">+    // note! nsTreeSelection doesn't fire a selection changed event, so neither</span>
<a href="#l65.384"></a><span id="l65.384" class="difflineplus">+    //  do we, but it seems like we should</span>
<a href="#l65.385"></a><span id="l65.385" class="difflineplus">+  },</span>
<a href="#l65.386"></a><span id="l65.386" class="difflineplus">+</span>
<a href="#l65.387"></a><span id="l65.387" class="difflineplus">+  /**</span>
<a href="#l65.388"></a><span id="l65.388" class="difflineplus">+   * nsTreeSelection always fires a select notification when the range is</span>
<a href="#l65.389"></a><span id="l65.389" class="difflineplus">+   *  cleared, even if there is no effective chance in selection.</span>
<a href="#l65.390"></a><span id="l65.390" class="difflineplus">+   */</span>
<a href="#l65.391"></a><span id="l65.391" class="difflineplus">+  clearSelection: function JSTreeSelection_clearSelection() {</span>
<a href="#l65.392"></a><span id="l65.392" class="difflineplus">+    this._shiftSelectPivot = null;</span>
<a href="#l65.393"></a><span id="l65.393" class="difflineplus">+    this._count = 0;</span>
<a href="#l65.394"></a><span id="l65.394" class="difflineplus">+    this._ranges = [];</span>
<a href="#l65.395"></a><span id="l65.395" class="difflineplus">+    if (this._treeBoxObject)</span>
<a href="#l65.396"></a><span id="l65.396" class="difflineplus">+      this._treeBoxObject.invalidate();</span>
<a href="#l65.397"></a><span id="l65.397" class="difflineplus">+    this._fireSelectionChanged();</span>
<a href="#l65.398"></a><span id="l65.398" class="difflineplus">+  },</span>
<a href="#l65.399"></a><span id="l65.399" class="difflineplus">+</span>
<a href="#l65.400"></a><span id="l65.400" class="difflineplus">+  /**</span>
<a href="#l65.401"></a><span id="l65.401" class="difflineplus">+   * Not even nsTreeSelection implements this.</span>
<a href="#l65.402"></a><span id="l65.402" class="difflineplus">+   */</span>
<a href="#l65.403"></a><span id="l65.403" class="difflineplus">+  invertSelection: function JSTreeSelection_invertSelection() {</span>
<a href="#l65.404"></a><span id="l65.404" class="difflineplus">+    throw new Error(&quot;Who really was going to use this?&quot;);</span>
<a href="#l65.405"></a><span id="l65.405" class="difflineplus">+  },</span>
<a href="#l65.406"></a><span id="l65.406" class="difflineplus">+</span>
<a href="#l65.407"></a><span id="l65.407" class="difflineplus">+  /**</span>
<a href="#l65.408"></a><span id="l65.408" class="difflineplus">+   * Select all with no rows is a no-op, otherwise we select all and notify.</span>
<a href="#l65.409"></a><span id="l65.409" class="difflineplus">+   */</span>
<a href="#l65.410"></a><span id="l65.410" class="difflineplus">+  selectAll: function JSTreeSelection_selectAll() {</span>
<a href="#l65.411"></a><span id="l65.411" class="difflineplus">+    if (!this._treeBoxObject)</span>
<a href="#l65.412"></a><span id="l65.412" class="difflineplus">+      return;</span>
<a href="#l65.413"></a><span id="l65.413" class="difflineplus">+</span>
<a href="#l65.414"></a><span id="l65.414" class="difflineplus">+    let view = this._treeBoxObject.view.QueryInterface(Ci.nsITreeView);</span>
<a href="#l65.415"></a><span id="l65.415" class="difflineplus">+    let rowCount = view.rowCount;</span>
<a href="#l65.416"></a><span id="l65.416" class="difflineplus">+</span>
<a href="#l65.417"></a><span id="l65.417" class="difflineplus">+    // no-ops-ville</span>
<a href="#l65.418"></a><span id="l65.418" class="difflineplus">+    if (!rowCount)</span>
<a href="#l65.419"></a><span id="l65.419" class="difflineplus">+      return;</span>
<a href="#l65.420"></a><span id="l65.420" class="difflineplus">+</span>
<a href="#l65.421"></a><span id="l65.421" class="difflineplus">+    this._count = rowCount;</span>
<a href="#l65.422"></a><span id="l65.422" class="difflineplus">+    this._ranges = [[0, rowCount - 1]];</span>
<a href="#l65.423"></a><span id="l65.423" class="difflineplus">+</span>
<a href="#l65.424"></a><span id="l65.424" class="difflineplus">+    this._treeBoxObject.invalidate();</span>
<a href="#l65.425"></a><span id="l65.425" class="difflineplus">+    this._fireSelectionChanged();</span>
<a href="#l65.426"></a><span id="l65.426" class="difflineplus">+  },</span>
<a href="#l65.427"></a><span id="l65.427" class="difflineplus">+</span>
<a href="#l65.428"></a><span id="l65.428" class="difflineplus">+  getRangeCount: function JSTreeSelection_getRangeCount() {</span>
<a href="#l65.429"></a><span id="l65.429" class="difflineplus">+    return this._ranges.length;</span>
<a href="#l65.430"></a><span id="l65.430" class="difflineplus">+  },</span>
<a href="#l65.431"></a><span id="l65.431" class="difflineplus">+  getRangeAt: function JSTreeSelection_getRangeAt(aRangeIndex, aMinObj,</span>
<a href="#l65.432"></a><span id="l65.432" class="difflineplus">+                                                  aMaxObj) {</span>
<a href="#l65.433"></a><span id="l65.433" class="difflineplus">+    if (aRangeIndex &lt; 0 || aRangeIndex &gt; this._ranges.length)</span>
<a href="#l65.434"></a><span id="l65.434" class="difflineplus">+      throw new Exception(&quot;Try a real range index next time.&quot;);</span>
<a href="#l65.435"></a><span id="l65.435" class="difflineplus">+    [aMinObj.value, aMaxObj.value] = this._ranges[aRangeIndex];</span>
<a href="#l65.436"></a><span id="l65.436" class="difflineplus">+  },</span>
<a href="#l65.437"></a><span id="l65.437" class="difflineplus">+</span>
<a href="#l65.438"></a><span id="l65.438" class="difflineplus">+  invalidateSelection: function JSTreeSelection_invalidateSelection() {</span>
<a href="#l65.439"></a><span id="l65.439" class="difflineplus">+    if (this._treeBoxObject)</span>
<a href="#l65.440"></a><span id="l65.440" class="difflineplus">+      this._treeBoxObject.invalidate();</span>
<a href="#l65.441"></a><span id="l65.441" class="difflineplus">+  },</span>
<a href="#l65.442"></a><span id="l65.442" class="difflineplus">+</span>
<a href="#l65.443"></a><span id="l65.443" class="difflineplus">+  /**</span>
<a href="#l65.444"></a><span id="l65.444" class="difflineplus">+   * Helper method to adjust points in the face of row additions/removal.</span>
<a href="#l65.445"></a><span id="l65.445" class="difflineplus">+   * @param aPoint The point, null if there isn't one, or an index otherwise.</span>
<a href="#l65.446"></a><span id="l65.446" class="difflineplus">+   * @param aDeltaAt The row at which the change is happening.</span>
<a href="#l65.447"></a><span id="l65.447" class="difflineplus">+   * @param aDelta The number of rows added if positive, or the (negative)</span>
<a href="#l65.448"></a><span id="l65.448" class="difflineplus">+   *     number of rows removed.</span>
<a href="#l65.449"></a><span id="l65.449" class="difflineplus">+   */</span>
<a href="#l65.450"></a><span id="l65.450" class="difflineplus">+  _adjustPoint: function JSTreeSelection__adjustPoint(aPoint, aDeltaAt,</span>
<a href="#l65.451"></a><span id="l65.451" class="difflineplus">+                                                      aDelta) {</span>
<a href="#l65.452"></a><span id="l65.452" class="difflineplus">+    // if there is no point, no change</span>
<a href="#l65.453"></a><span id="l65.453" class="difflineplus">+    if (aPoint == null)</span>
<a href="#l65.454"></a><span id="l65.454" class="difflineplus">+      return aPoint;</span>
<a href="#l65.455"></a><span id="l65.455" class="difflineplus">+    // if the point is before the change, no change</span>
<a href="#l65.456"></a><span id="l65.456" class="difflineplus">+    if (aPoint &lt; aDeltaAt)</span>
<a href="#l65.457"></a><span id="l65.457" class="difflineplus">+      return aPoint;</span>
<a href="#l65.458"></a><span id="l65.458" class="difflineplus">+    // if it's a deletion and it includes the point, clear it</span>
<a href="#l65.459"></a><span id="l65.459" class="difflineplus">+    if (aDelta &lt; 0 &amp;&amp; aPoint &gt;= aDeltaAt &amp;&amp; (aPoint + aDelta &lt; aDeltaAt))</span>
<a href="#l65.460"></a><span id="l65.460" class="difflineplus">+      return null;</span>
<a href="#l65.461"></a><span id="l65.461" class="difflineplus">+    // (else) the point is at/after the change, compensate</span>
<a href="#l65.462"></a><span id="l65.462" class="difflineplus">+    return aPoint + aDelta;</span>
<a href="#l65.463"></a><span id="l65.463" class="difflineplus">+  },</span>
<a href="#l65.464"></a><span id="l65.464" class="difflineplus">+  /**</span>
<a href="#l65.465"></a><span id="l65.465" class="difflineplus">+   * Find the index of the range, if any, that contains the given index, and</span>
<a href="#l65.466"></a><span id="l65.466" class="difflineplus">+   *  the index at which to insert a range if one does not exist.</span>
<a href="#l65.467"></a><span id="l65.467" class="difflineplus">+   *</span>
<a href="#l65.468"></a><span id="l65.468" class="difflineplus">+   * @return A tuple containing: 1) the index if there is one, null otherwise,</span>
<a href="#l65.469"></a><span id="l65.469" class="difflineplus">+   *     2) the index at which to insert a range that would contain the point.</span>
<a href="#l65.470"></a><span id="l65.470" class="difflineplus">+   */</span>
<a href="#l65.471"></a><span id="l65.471" class="difflineplus">+  _findRangeContainingRow:</span>
<a href="#l65.472"></a><span id="l65.472" class="difflineplus">+      function JSTreeSelection__findRangeContainingRow(aIndex) {</span>
<a href="#l65.473"></a><span id="l65.473" class="difflineplus">+    for each (let [iTupe, [low, high]] in Iterator(this._ranges)) {</span>
<a href="#l65.474"></a><span id="l65.474" class="difflineplus">+      if (aIndex &gt;= low &amp;&amp; aIndex &lt;= high)</span>
<a href="#l65.475"></a><span id="l65.475" class="difflineplus">+        return [iTupe, iTupe];</span>
<a href="#l65.476"></a><span id="l65.476" class="difflineplus">+      if (aIndex &lt; low)</span>
<a href="#l65.477"></a><span id="l65.477" class="difflineplus">+        return [null, iTupe];</span>
<a href="#l65.478"></a><span id="l65.478" class="difflineplus">+    }</span>
<a href="#l65.479"></a><span id="l65.479" class="difflineplus">+    return [null, this._ranges.length];</span>
<a href="#l65.480"></a><span id="l65.480" class="difflineplus">+  },</span>
<a href="#l65.481"></a><span id="l65.481" class="difflineplus">+</span>
<a href="#l65.482"></a><span id="l65.482" class="difflineplus">+</span>
<a href="#l65.483"></a><span id="l65.483" class="difflineplus">+  /**</span>
<a href="#l65.484"></a><span id="l65.484" class="difflineplus">+   * When present, a list of calls made to adjustSelection.  See</span>
<a href="#l65.485"></a><span id="l65.485" class="difflineplus">+   *  |logAdjustSelectionForReplay| and |replayAdjustSelectionLog|.</span>
<a href="#l65.486"></a><span id="l65.486" class="difflineplus">+   */</span>
<a href="#l65.487"></a><span id="l65.487" class="difflineplus">+  _adjustSelectionLog: null,</span>
<a href="#l65.488"></a><span id="l65.488" class="difflineplus">+  /**</span>
<a href="#l65.489"></a><span id="l65.489" class="difflineplus">+   * Start logging calls to adjustSelection made against this instance.  You</span>
<a href="#l65.490"></a><span id="l65.490" class="difflineplus">+   *  would do this because you are replacing an existing selection object</span>
<a href="#l65.491"></a><span id="l65.491" class="difflineplus">+   *  with this instance for the purposes of creating a transient selection.</span>
<a href="#l65.492"></a><span id="l65.492" class="difflineplus">+   *  Of course, you want the original selection object to be up-to-date when</span>
<a href="#l65.493"></a><span id="l65.493" class="difflineplus">+   *  you go to put it back, so then you can call replayAdjustSelectionLog</span>
<a href="#l65.494"></a><span id="l65.494" class="difflineplus">+   *  with that selection object and everything will be peachy.</span>
<a href="#l65.495"></a><span id="l65.495" class="difflineplus">+   */</span>
<a href="#l65.496"></a><span id="l65.496" class="difflineplus">+  logAdjustSelectionForReplay:</span>
<a href="#l65.497"></a><span id="l65.497" class="difflineplus">+      function JSTreeSelection_logAdjustSelectionForReplay() {</span>
<a href="#l65.498"></a><span id="l65.498" class="difflineplus">+    this._adjustSelectionLog = [];</span>
<a href="#l65.499"></a><span id="l65.499" class="difflineplus">+  },</span>
<a href="#l65.500"></a><span id="l65.500" class="difflineplus">+  /**</span>
<a href="#l65.501"></a><span id="l65.501" class="difflineplus">+   * Stop logging calls to adjustSelection and replay the existing log against</span>
<a href="#l65.502"></a><span id="l65.502" class="difflineplus">+   *  aSelection.</span>
<a href="#l65.503"></a><span id="l65.503" class="difflineplus">+   *</span>
<a href="#l65.504"></a><span id="l65.504" class="difflineplus">+   * @param aSelection {nsITreeSelection}.</span>
<a href="#l65.505"></a><span id="l65.505" class="difflineplus">+   */</span>
<a href="#l65.506"></a><span id="l65.506" class="difflineplus">+  replayAdjustSelectionLog:</span>
<a href="#l65.507"></a><span id="l65.507" class="difflineplus">+      function JSTreeSelection_replayAdjustSelectionLog(aSelection) {</span>
<a href="#l65.508"></a><span id="l65.508" class="difflineplus">+    if (this._adjustSelectionLog.length) {</span>
<a href="#l65.509"></a><span id="l65.509" class="difflineplus">+      // Temporarily disable selection events because adjustSelection is going</span>
<a href="#l65.510"></a><span id="l65.510" class="difflineplus">+      //  to generate an event each time otherwise, and better 1 event than</span>
<a href="#l65.511"></a><span id="l65.511" class="difflineplus">+      //  many.</span>
<a href="#l65.512"></a><span id="l65.512" class="difflineplus">+      aSelection.selectEventsSuppressed = true;</span>
<a href="#l65.513"></a><span id="l65.513" class="difflineplus">+      for each (let [, [index, count]] in Iterator(this._adjustSelectionLog)) {</span>
<a href="#l65.514"></a><span id="l65.514" class="difflineplus">+        aSelection.adjustSelection(index, count);</span>
<a href="#l65.515"></a><span id="l65.515" class="difflineplus">+      }</span>
<a href="#l65.516"></a><span id="l65.516" class="difflineplus">+      aSelection.selectEventsSuppressed = false;</span>
<a href="#l65.517"></a><span id="l65.517" class="difflineplus">+    }</span>
<a href="#l65.518"></a><span id="l65.518" class="difflineplus">+    this._adjustSelectionLog = null;</span>
<a href="#l65.519"></a><span id="l65.519" class="difflineplus">+  },</span>
<a href="#l65.520"></a><span id="l65.520" class="difflineplus">+</span>
<a href="#l65.521"></a><span id="l65.521" class="difflineplus">+  adjustSelection: function JSTreeSelection_adjustSelection(aIndex, aCount) {</span>
<a href="#l65.522"></a><span id="l65.522" class="difflineplus">+    // nothing to do if there is no actual change</span>
<a href="#l65.523"></a><span id="l65.523" class="difflineplus">+    if (!aCount)</span>
<a href="#l65.524"></a><span id="l65.524" class="difflineplus">+      return;</span>
<a href="#l65.525"></a><span id="l65.525" class="difflineplus">+</span>
<a href="#l65.526"></a><span id="l65.526" class="difflineplus">+    if (this._adjustSelectionLog)</span>
<a href="#l65.527"></a><span id="l65.527" class="difflineplus">+      this._adjustSelectionLog.push([aIndex, aCount]);</span>
<a href="#l65.528"></a><span id="l65.528" class="difflineplus">+</span>
<a href="#l65.529"></a><span id="l65.529" class="difflineplus">+    // adjust our points</span>
<a href="#l65.530"></a><span id="l65.530" class="difflineplus">+    this._shiftSelectPivot = this._adjustPoint(this._shiftSelectPivot,</span>
<a href="#l65.531"></a><span id="l65.531" class="difflineplus">+                                               aIndex, aCount);</span>
<a href="#l65.532"></a><span id="l65.532" class="difflineplus">+    this._currentIndex = this._adjustPoint(this._currentIndex, aIndex, aCount);</span>
<a href="#l65.533"></a><span id="l65.533" class="difflineplus">+</span>
<a href="#l65.534"></a><span id="l65.534" class="difflineplus">+    // If we are adding rows, we want to split any range at aIndex and then</span>
<a href="#l65.535"></a><span id="l65.535" class="difflineplus">+    //  translate all of the ranges above that point up.</span>
<a href="#l65.536"></a><span id="l65.536" class="difflineplus">+    if (aCount &gt; 0) {</span>
<a href="#l65.537"></a><span id="l65.537" class="difflineplus">+      let [iContain, iInsert] = this._findRangeContainingRow(aIndex);</span>
<a href="#l65.538"></a><span id="l65.538" class="difflineplus">+      if (iContain != null) {</span>
<a href="#l65.539"></a><span id="l65.539" class="difflineplus">+        let [low, high] = this._ranges[iContain];</span>
<a href="#l65.540"></a><span id="l65.540" class="difflineplus">+        // if it is the low value, we just want to shift the range entirely, so</span>
<a href="#l65.541"></a><span id="l65.541" class="difflineplus">+        //  do nothing (and keep iInsert pointing at it for translation)</span>
<a href="#l65.542"></a><span id="l65.542" class="difflineplus">+        // if it is not the low value, then there must be at least two values so</span>
<a href="#l65.543"></a><span id="l65.543" class="difflineplus">+        //  we should split it and only translate the new/upper block</span>
<a href="#l65.544"></a><span id="l65.544" class="difflineplus">+        if (aIndex != low) {</span>
<a href="#l65.545"></a><span id="l65.545" class="difflineplus">+          this._ranges.splice(iContain, 1, [low, aIndex - 1], [aIndex, high]);</span>
<a href="#l65.546"></a><span id="l65.546" class="difflineplus">+          iInsert++;</span>
<a href="#l65.547"></a><span id="l65.547" class="difflineplus">+        }</span>
<a href="#l65.548"></a><span id="l65.548" class="difflineplus">+      }</span>
<a href="#l65.549"></a><span id="l65.549" class="difflineplus">+      // now translate everything from iInsert on up</span>
<a href="#l65.550"></a><span id="l65.550" class="difflineplus">+      for (let iTrans = iInsert; iTrans &lt; this._ranges.length; iTrans++) {</span>
<a href="#l65.551"></a><span id="l65.551" class="difflineplus">+        let [low, high] = this._ranges[iTrans];</span>
<a href="#l65.552"></a><span id="l65.552" class="difflineplus">+        this._ranges[iTrans] = [low + aCount, high + aCount];</span>
<a href="#l65.553"></a><span id="l65.553" class="difflineplus">+      }</span>
<a href="#l65.554"></a><span id="l65.554" class="difflineplus">+      // invalidate and fire selection change notice</span>
<a href="#l65.555"></a><span id="l65.555" class="difflineplus">+      if (this._treeBoxObject)</span>
<a href="#l65.556"></a><span id="l65.556" class="difflineplus">+        this._treeBoxObject.invalidate();</span>
<a href="#l65.557"></a><span id="l65.557" class="difflineplus">+      this._fireSelectionChanged();</span>
<a href="#l65.558"></a><span id="l65.558" class="difflineplus">+      return;</span>
<a href="#l65.559"></a><span id="l65.559" class="difflineplus">+    }</span>
<a href="#l65.560"></a><span id="l65.560" class="difflineplus">+</span>
<a href="#l65.561"></a><span id="l65.561" class="difflineplus">+    // If we are removing rows, we are basically clearing the range that is</span>
<a href="#l65.562"></a><span id="l65.562" class="difflineplus">+    //  getting deleted and translating everyone above the remaining point</span>
<a href="#l65.563"></a><span id="l65.563" class="difflineplus">+    //  downwards.  The one trick is we may have to merge the lowest translated</span>
<a href="#l65.564"></a><span id="l65.564" class="difflineplus">+    //  block.</span>
<a href="#l65.565"></a><span id="l65.565" class="difflineplus">+    let saveSuppress = this.selectEventsSuppressed;</span>
<a href="#l65.566"></a><span id="l65.566" class="difflineplus">+    this.selectEventsSuppressed = true;</span>
<a href="#l65.567"></a><span id="l65.567" class="difflineplus">+    this.clearRange(aIndex, aIndex - aCount - 1);</span>
<a href="#l65.568"></a><span id="l65.568" class="difflineplus">+    // translate</span>
<a href="#l65.569"></a><span id="l65.569" class="difflineplus">+    let iTrans = this._findRangeContainingRow(aIndex)[1];</span>
<a href="#l65.570"></a><span id="l65.570" class="difflineplus">+    for (; iTrans &lt; this._ranges.length; iTrans++) {</span>
<a href="#l65.571"></a><span id="l65.571" class="difflineplus">+      let [low, high] = this._ranges[iTrans];</span>
<a href="#l65.572"></a><span id="l65.572" class="difflineplus">+      // for the first range, low may be below the index, in which case it</span>
<a href="#l65.573"></a><span id="l65.573" class="difflineplus">+      //  should not get translated</span>
<a href="#l65.574"></a><span id="l65.574" class="difflineplus">+      this._ranges[iTrans] = [(low &gt;= aIndex) ? low + aCount : low,</span>
<a href="#l65.575"></a><span id="l65.575" class="difflineplus">+                              high + aCount];</span>
<a href="#l65.576"></a><span id="l65.576" class="difflineplus">+    }</span>
<a href="#l65.577"></a><span id="l65.577" class="difflineplus">+    // we may have to merge the lowest translated block because it may now be</span>
<a href="#l65.578"></a><span id="l65.578" class="difflineplus">+    //  adjacent to the previous block</span>
<a href="#l65.579"></a><span id="l65.579" class="difflineplus">+    if (iTrans &gt; 0 &amp;&amp; iTrans &lt; this._ranges.length &amp;&amp;</span>
<a href="#l65.580"></a><span id="l65.580" class="difflineplus">+        this._ranges[iTrans-1][1] == this_ranges[iTrans][0]) {</span>
<a href="#l65.581"></a><span id="l65.581" class="difflineplus">+      this._ranges[iTrans-1][1] = this._ranges[iTrans][1];</span>
<a href="#l65.582"></a><span id="l65.582" class="difflineplus">+      this._ranges.splice(iTrans, 1);</span>
<a href="#l65.583"></a><span id="l65.583" class="difflineplus">+    }</span>
<a href="#l65.584"></a><span id="l65.584" class="difflineplus">+</span>
<a href="#l65.585"></a><span id="l65.585" class="difflineplus">+    if (this._treeBoxObject)</span>
<a href="#l65.586"></a><span id="l65.586" class="difflineplus">+      this._treeBoxObject.invalidate();</span>
<a href="#l65.587"></a><span id="l65.587" class="difflineplus">+    this.selectEventsSuppressed = saveSuppress;</span>
<a href="#l65.588"></a><span id="l65.588" class="difflineplus">+  },</span>
<a href="#l65.589"></a><span id="l65.589" class="difflineplus">+</span>
<a href="#l65.590"></a><span id="l65.590" class="difflineplus">+  get selectEventsSuppressed JSTreeSelection_get_selectEventsSuppressed() {</span>
<a href="#l65.591"></a><span id="l65.591" class="difflineplus">+    return this._selectEventsSuppressed;</span>
<a href="#l65.592"></a><span id="l65.592" class="difflineplus">+  },</span>
<a href="#l65.593"></a><span id="l65.593" class="difflineplus">+  /**</span>
<a href="#l65.594"></a><span id="l65.594" class="difflineplus">+   * Control whether selection events are suppressed.  For consistency with</span>
<a href="#l65.595"></a><span id="l65.595" class="difflineplus">+   *  nsTreeSelection, we always generate a selection event when a value of</span>
<a href="#l65.596"></a><span id="l65.596" class="difflineplus">+   *  false is assigned, even if the value was already false.</span>
<a href="#l65.597"></a><span id="l65.597" class="difflineplus">+   */</span>
<a href="#l65.598"></a><span id="l65.598" class="difflineplus">+  set selectEventsSuppressed</span>
<a href="#l65.599"></a><span id="l65.599" class="difflineplus">+      JSTreeSelection_set_selectEventsSuppressed(aSuppress) {</span>
<a href="#l65.600"></a><span id="l65.600" class="difflineplus">+    this._selectEventsSuppressed = aSuppress;</span>
<a href="#l65.601"></a><span id="l65.601" class="difflineplus">+    if (!aSuppress)</span>
<a href="#l65.602"></a><span id="l65.602" class="difflineplus">+      this._fireSelectionChanged();</span>
<a href="#l65.603"></a><span id="l65.603" class="difflineplus">+  },</span>
<a href="#l65.604"></a><span id="l65.604" class="difflineplus">+</span>
<a href="#l65.605"></a><span id="l65.605" class="difflineplus">+  /**</span>
<a href="#l65.606"></a><span id="l65.606" class="difflineplus">+   * Note that we bypass any XUL &quot;onselect&quot; handler that may exist and go</span>
<a href="#l65.607"></a><span id="l65.607" class="difflineplus">+   *  straight to the view.  If you have a tree, you shouldn't be using us,</span>
<a href="#l65.608"></a><span id="l65.608" class="difflineplus">+   *  so this seems aboot right.</span>
<a href="#l65.609"></a><span id="l65.609" class="difflineplus">+   */</span>
<a href="#l65.610"></a><span id="l65.610" class="difflineplus">+  _fireSelectionChanged: function JSTreeSelection__fireSelectionChanged() {</span>
<a href="#l65.611"></a><span id="l65.611" class="difflineplus">+    // don't fire if we are suppressed; we will fire when un-suppressed</span>
<a href="#l65.612"></a><span id="l65.612" class="difflineplus">+    if (this.selectEventsSuppressed)</span>
<a href="#l65.613"></a><span id="l65.613" class="difflineplus">+      return;</span>
<a href="#l65.614"></a><span id="l65.614" class="difflineplus">+    // we need a box object to get at the view</span>
<a href="#l65.615"></a><span id="l65.615" class="difflineplus">+    if (!this._treeBoxObject)</span>
<a href="#l65.616"></a><span id="l65.616" class="difflineplus">+      return;</span>
<a href="#l65.617"></a><span id="l65.617" class="difflineplus">+    // we need a view to have a view...</span>
<a href="#l65.618"></a><span id="l65.618" class="difflineplus">+    if (!this._treeBoxObject.view)</span>
<a href="#l65.619"></a><span id="l65.619" class="difflineplus">+      return;</span>
<a href="#l65.620"></a><span id="l65.620" class="difflineplus">+</span>
<a href="#l65.621"></a><span id="l65.621" class="difflineplus">+    let view = this._treeBoxObject.view.QueryInterface(Ci.nsITreeView);</span>
<a href="#l65.622"></a><span id="l65.622" class="difflineplus">+    view.selectionChanged();</span>
<a href="#l65.623"></a><span id="l65.623" class="difflineplus">+  },</span>
<a href="#l65.624"></a><span id="l65.624" class="difflineplus">+</span>
<a href="#l65.625"></a><span id="l65.625" class="difflineplus">+  get currentIndex JSTreeSelection_get_currentIndex() {</span>
<a href="#l65.626"></a><span id="l65.626" class="difflineplus">+    if (this._currentIndex == null)</span>
<a href="#l65.627"></a><span id="l65.627" class="difflineplus">+      return -1;</span>
<a href="#l65.628"></a><span id="l65.628" class="difflineplus">+    return this._currentIndex;</span>
<a href="#l65.629"></a><span id="l65.629" class="difflineplus">+  },</span>
<a href="#l65.630"></a><span id="l65.630" class="difflineplus">+  /**</span>
<a href="#l65.631"></a><span id="l65.631" class="difflineplus">+   * Sets the current index.  Other than updating the variable, this just</span>
<a href="#l65.632"></a><span id="l65.632" class="difflineplus">+   *  invalidates the tree row if we have a tree.</span>
<a href="#l65.633"></a><span id="l65.633" class="difflineplus">+   * The real selection object would send a DOM event we don't care about.</span>
<a href="#l65.634"></a><span id="l65.634" class="difflineplus">+   */</span>
<a href="#l65.635"></a><span id="l65.635" class="difflineplus">+  set currentIndex JSTreeSelection_set_currentIndex(aIndex) {</span>
<a href="#l65.636"></a><span id="l65.636" class="difflineplus">+    if (aIndex == this.currentIndex)</span>
<a href="#l65.637"></a><span id="l65.637" class="difflineplus">+      return;</span>
<a href="#l65.638"></a><span id="l65.638" class="difflineplus">+</span>
<a href="#l65.639"></a><span id="l65.639" class="difflineplus">+    this._currentIndex = (aIndex != -1) ? aIndex : null;</span>
<a href="#l65.640"></a><span id="l65.640" class="difflineplus">+    if (this._treeBoxObject)</span>
<a href="#l65.641"></a><span id="l65.641" class="difflineplus">+      this._treeBoxObject.invalidateRow(aIndex);</span>
<a href="#l65.642"></a><span id="l65.642" class="difflineplus">+  },</span>
<a href="#l65.643"></a><span id="l65.643" class="difflineplus">+</span>
<a href="#l65.644"></a><span id="l65.644" class="difflineplus">+  currentColumn: null,</span>
<a href="#l65.645"></a><span id="l65.645" class="difflineplus">+</span>
<a href="#l65.646"></a><span id="l65.646" class="difflineplus">+  get shiftSelectPivot JSTreeSelection_get_shiftSelectPivot() {</span>
<a href="#l65.647"></a><span id="l65.647" class="difflineplus">+    return this._shiftSelectPivot != null ? this._shiftSelectPivot : -1;</span>
<a href="#l65.648"></a><span id="l65.648" class="difflineplus">+  },</span>
<a href="#l65.649"></a><span id="l65.649" class="difflineplus">+</span>
<a href="#l65.650"></a><span id="l65.650" class="difflineplus">+  QueryInterface: XPCOMUtils.generateQI(</span>
<a href="#l65.651"></a><span id="l65.651" class="difflineplus">+    [Ci.nsITreeSelection]),</span>
<a href="#l65.652"></a><span id="l65.652" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l66.1"></a><span id="l66.1">new file mode 100644</span>
<a href="#l66.2"></a><span id="l66.2" class="difflineminus">--- /dev/null</span>
<a href="#l66.3"></a><span id="l66.3" class="difflineplus">+++ b/mailnews/base/util/traceHelper.js</span>
<a href="#l66.4"></a><span id="l66.4" class="difflineat">@@ -0,0 +1,146 @@</span>
<a href="#l66.5"></a><span id="l66.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l66.6"></a><span id="l66.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l66.7"></a><span id="l66.7" class="difflineplus">+ *</span>
<a href="#l66.8"></a><span id="l66.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l66.9"></a><span id="l66.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l66.10"></a><span id="l66.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l66.11"></a><span id="l66.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l66.12"></a><span id="l66.12" class="difflineplus">+ *</span>
<a href="#l66.13"></a><span id="l66.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l66.14"></a><span id="l66.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l66.15"></a><span id="l66.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l66.16"></a><span id="l66.16" class="difflineplus">+ * License.</span>
<a href="#l66.17"></a><span id="l66.17" class="difflineplus">+ *</span>
<a href="#l66.18"></a><span id="l66.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l66.19"></a><span id="l66.19" class="difflineplus">+ *</span>
<a href="#l66.20"></a><span id="l66.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l66.21"></a><span id="l66.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l66.22"></a><span id="l66.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l66.23"></a><span id="l66.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l66.24"></a><span id="l66.24" class="difflineplus">+ *</span>
<a href="#l66.25"></a><span id="l66.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l66.26"></a><span id="l66.26" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l66.27"></a><span id="l66.27" class="difflineplus">+ *</span>
<a href="#l66.28"></a><span id="l66.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l66.29"></a><span id="l66.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l66.30"></a><span id="l66.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l66.31"></a><span id="l66.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l66.32"></a><span id="l66.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l66.33"></a><span id="l66.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l66.34"></a><span id="l66.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l66.35"></a><span id="l66.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l66.36"></a><span id="l66.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l66.37"></a><span id="l66.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l66.38"></a><span id="l66.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l66.39"></a><span id="l66.39" class="difflineplus">+ *</span>
<a href="#l66.40"></a><span id="l66.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l66.41"></a><span id="l66.41" class="difflineplus">+</span>
<a href="#l66.42"></a><span id="l66.42" class="difflineplus">+EXPORTED_SYMBOLS = ['DebugTraceHelper'];</span>
<a href="#l66.43"></a><span id="l66.43" class="difflineplus">+</span>
<a href="#l66.44"></a><span id="l66.44" class="difflineplus">+const Cc = Components.classes;</span>
<a href="#l66.45"></a><span id="l66.45" class="difflineplus">+const Ci = Components.interfaces;</span>
<a href="#l66.46"></a><span id="l66.46" class="difflineplus">+const Cr = Components.results;</span>
<a href="#l66.47"></a><span id="l66.47" class="difflineplus">+const Cu = Components.utils;</span>
<a href="#l66.48"></a><span id="l66.48" class="difflineplus">+</span>
<a href="#l66.49"></a><span id="l66.49" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l66.50"></a><span id="l66.50" class="difflineplus">+</span>
<a href="#l66.51"></a><span id="l66.51" class="difflineplus">+var SPACES = &quot;                                                   &quot;;</span>
<a href="#l66.52"></a><span id="l66.52" class="difflineplus">+var BRIGHT_COLORS = {</span>
<a href="#l66.53"></a><span id="l66.53" class="difflineplus">+  red: &quot;\x1b[1;31m&quot;,</span>
<a href="#l66.54"></a><span id="l66.54" class="difflineplus">+  green: &quot;\x1b[1;32m&quot;,</span>
<a href="#l66.55"></a><span id="l66.55" class="difflineplus">+  yellow: &quot;\x1b[1;33m&quot;,</span>
<a href="#l66.56"></a><span id="l66.56" class="difflineplus">+  blue: &quot;\x1b[1;34m&quot;,</span>
<a href="#l66.57"></a><span id="l66.57" class="difflineplus">+  magenta: &quot;\x1b[1;35m&quot;,</span>
<a href="#l66.58"></a><span id="l66.58" class="difflineplus">+  cyan: &quot;\x1b[1;36m&quot;,</span>
<a href="#l66.59"></a><span id="l66.59" class="difflineplus">+  white: &quot;\x1b[1;37m&quot;,</span>
<a href="#l66.60"></a><span id="l66.60" class="difflineplus">+};</span>
<a href="#l66.61"></a><span id="l66.61" class="difflineplus">+var DARK_COLORS = {</span>
<a href="#l66.62"></a><span id="l66.62" class="difflineplus">+  red: &quot;\x1b[0;31m&quot;,</span>
<a href="#l66.63"></a><span id="l66.63" class="difflineplus">+  green: &quot;\x1b[0;32m&quot;,</span>
<a href="#l66.64"></a><span id="l66.64" class="difflineplus">+  yellow: &quot;\x1b[0;33m&quot;,</span>
<a href="#l66.65"></a><span id="l66.65" class="difflineplus">+  blue: &quot;\x1b[0;34m&quot;,</span>
<a href="#l66.66"></a><span id="l66.66" class="difflineplus">+  magenta: &quot;\x1b[0;35m&quot;,</span>
<a href="#l66.67"></a><span id="l66.67" class="difflineplus">+  cyan: &quot;\x1b[0;36m&quot;,</span>
<a href="#l66.68"></a><span id="l66.68" class="difflineplus">+  white: &quot;\x1b[0;37m&quot;,</span>
<a href="#l66.69"></a><span id="l66.69" class="difflineplus">+};</span>
<a href="#l66.70"></a><span id="l66.70" class="difflineplus">+var STOP_COLORS = &quot;\x1b[0m&quot;;</span>
<a href="#l66.71"></a><span id="l66.71" class="difflineplus">+</span>
<a href="#l66.72"></a><span id="l66.72" class="difflineplus">+</span>
<a href="#l66.73"></a><span id="l66.73" class="difflineplus">+/**</span>
<a href="#l66.74"></a><span id="l66.74" class="difflineplus">+ * Example usages:</span>
<a href="#l66.75"></a><span id="l66.75" class="difflineplus">+ *</span>
<a href="#l66.76"></a><span id="l66.76" class="difflineplus">+ * Components.utils.import(&quot;resource://app/modules/traceHelper.js&quot;);</span>
<a href="#l66.77"></a><span id="l66.77" class="difflineplus">+ * var debugContext = {color: &quot;cyan&quot;};</span>
<a href="#l66.78"></a><span id="l66.78" class="difflineplus">+ * DebugTraceHelper.tracify(FolderDisplayWidget.prototype,</span>
<a href="#l66.79"></a><span id="l66.79" class="difflineplus">+ *                          &quot;FolderDisplayWidget&quot;, /.+/, debugContext);</span>
<a href="#l66.80"></a><span id="l66.80" class="difflineplus">+ * DebugTraceHelper.tracify(MessageDisplayWidget.prototype,</span>
<a href="#l66.81"></a><span id="l66.81" class="difflineplus">+ *                          &quot;MessageDisplayWidget&quot;, /.+/, debugContext);</span>
<a href="#l66.82"></a><span id="l66.82" class="difflineplus">+ * DebugTraceHelper.tracify(StandaloneFolderDisplayWidget.prototype,</span>
<a href="#l66.83"></a><span id="l66.83" class="difflineplus">+ *                          &quot;StandaloneFolderDisplayWidget&quot;, /.+/, debugContext);</span>
<a href="#l66.84"></a><span id="l66.84" class="difflineplus">+ * DebugTraceHelper.tracify(StandaloneMessageDisplayWidget.prototype,</span>
<a href="#l66.85"></a><span id="l66.85" class="difflineplus">+ *                          &quot;StandaloneMessageDisplayWidget&quot;, /.+/, debugContext);</span>
<a href="#l66.86"></a><span id="l66.86" class="difflineplus">+ * DebugTraceHelper.tracify(DBViewWrapper.prototype,</span>
<a href="#l66.87"></a><span id="l66.87" class="difflineplus">+ *                          &quot;DBViewWrapper&quot;, /.+/, {color: &quot;green&quot;});</span>
<a href="#l66.88"></a><span id="l66.88" class="difflineplus">+ * DebugTraceHelper.tracify(JSTreeSelection.prototype,</span>
<a href="#l66.89"></a><span id="l66.89" class="difflineplus">+ *                          &quot;JSTreeSelection&quot;, /.+/, {color: &quot;yellow&quot;});</span>
<a href="#l66.90"></a><span id="l66.90" class="difflineplus">+ */</span>
<a href="#l66.91"></a><span id="l66.91" class="difflineplus">+var DebugTraceHelper = {</span>
<a href="#l66.92"></a><span id="l66.92" class="difflineplus">+  tracify: function(aObj, aDesc, aPat, aContext, aSettings) {</span>
<a href="#l66.93"></a><span id="l66.93" class="difflineplus">+    aContext.depth = 0;</span>
<a href="#l66.94"></a><span id="l66.94" class="difflineplus">+    let color = aSettings.color || &quot;cyan&quot;;</span>
<a href="#l66.95"></a><span id="l66.95" class="difflineplus">+    aSettings.introCode = BRIGHT_COLORS[color];</span>
<a href="#l66.96"></a><span id="l66.96" class="difflineplus">+    aSettings.outroCode = DARK_COLORS[color];</span>
<a href="#l66.97"></a><span id="l66.97" class="difflineplus">+    for each (let key in Iterator(aObj, true)) {</span>
<a href="#l66.98"></a><span id="l66.98" class="difflineplus">+      if (aPat.test(key)) {</span>
<a href="#l66.99"></a><span id="l66.99" class="difflineplus">+        // ignore properties!</span>
<a href="#l66.100"></a><span id="l66.100" class="difflineplus">+        if (aObj.__lookupGetter__(key) || aObj.__lookupSetter__(key))</span>
<a href="#l66.101"></a><span id="l66.101" class="difflineplus">+          continue;</span>
<a href="#l66.102"></a><span id="l66.102" class="difflineplus">+        // ignore non-functions!</span>
<a href="#l66.103"></a><span id="l66.103" class="difflineplus">+        if (typeof(aObj[key]) != &quot;function&quot;)</span>
<a href="#l66.104"></a><span id="l66.104" class="difflineplus">+          continue;</span>
<a href="#l66.105"></a><span id="l66.105" class="difflineplus">+        let name = key;</span>
<a href="#l66.106"></a><span id="l66.106" class="difflineplus">+        let prev = aObj[name];</span>
<a href="#l66.107"></a><span id="l66.107" class="difflineplus">+        aObj[name] = function() {</span>
<a href="#l66.108"></a><span id="l66.108" class="difflineplus">+          let argstr = &quot;&quot;;</span>
<a href="#l66.109"></a><span id="l66.109" class="difflineplus">+          for (let i = 0; i &lt; arguments.length; i++) {</span>
<a href="#l66.110"></a><span id="l66.110" class="difflineplus">+            let arg = arguments[i];</span>
<a href="#l66.111"></a><span id="l66.111" class="difflineplus">+            if (arg == null)</span>
<a href="#l66.112"></a><span id="l66.112" class="difflineplus">+              argstr += &quot; null&quot;;</span>
<a href="#l66.113"></a><span id="l66.113" class="difflineplus">+            else if (typeof(arg) == &quot;function&quot;)</span>
<a href="#l66.114"></a><span id="l66.114" class="difflineplus">+              argstr += &quot; function &quot;+ arg.name;</span>
<a href="#l66.115"></a><span id="l66.115" class="difflineplus">+            else</span>
<a href="#l66.116"></a><span id="l66.116" class="difflineplus">+              argstr += &quot; &quot; + arguments[i].toString();</span>
<a href="#l66.117"></a><span id="l66.117" class="difflineplus">+          }</span>
<a href="#l66.118"></a><span id="l66.118" class="difflineplus">+</span>
<a href="#l66.119"></a><span id="l66.119" class="difflineplus">+          let indent = SPACES.substr(0, aContext.depth++ * 2);</span>
<a href="#l66.120"></a><span id="l66.120" class="difflineplus">+          dump(indent + &quot;--&gt; &quot; + aSettings.introCode + aDesc + &quot;::&quot; + name +</span>
<a href="#l66.121"></a><span id="l66.121" class="difflineplus">+               &quot;:&quot; + argstr +</span>
<a href="#l66.122"></a><span id="l66.122" class="difflineplus">+               STOP_COLORS + &quot;\n&quot;);</span>
<a href="#l66.123"></a><span id="l66.123" class="difflineplus">+          let ret;</span>
<a href="#l66.124"></a><span id="l66.124" class="difflineplus">+          try {</span>
<a href="#l66.125"></a><span id="l66.125" class="difflineplus">+            ret = prev.apply(this, arguments);</span>
<a href="#l66.126"></a><span id="l66.126" class="difflineplus">+          }</span>
<a href="#l66.127"></a><span id="l66.127" class="difflineplus">+          catch (ex) {</span>
<a href="#l66.128"></a><span id="l66.128" class="difflineplus">+            if (ex.stack) {</span>
<a href="#l66.129"></a><span id="l66.129" class="difflineplus">+              dump(BRIGHT_COLORS.red + &quot;Exception: &quot; + ex + &quot;\n  &quot; +</span>
<a href="#l66.130"></a><span id="l66.130" class="difflineplus">+                   ex.stack.replace(&quot;\n&quot;, &quot;\n  &quot;) + STOP_COLORS + &quot;\n&quot;);</span>
<a href="#l66.131"></a><span id="l66.131" class="difflineplus">+            }</span>
<a href="#l66.132"></a><span id="l66.132" class="difflineplus">+            else {</span>
<a href="#l66.133"></a><span id="l66.133" class="difflineplus">+              dump(BRIGHT_COLORS.red + &quot;Exception: &quot; + ex.fileName + &quot;:&quot; +</span>
<a href="#l66.134"></a><span id="l66.134" class="difflineplus">+                   ex.lineNumber + &quot;: &quot; + ex + STOP_COLORS + &quot;\n&quot;);</span>
<a href="#l66.135"></a><span id="l66.135" class="difflineplus">+            }</span>
<a href="#l66.136"></a><span id="l66.136" class="difflineplus">+            aContext.depth--;</span>
<a href="#l66.137"></a><span id="l66.137" class="difflineplus">+            dump(indent + &quot;&lt;-- &quot; + aSettings.outroCode + aDesc + &quot;::&quot; + name +</span>
<a href="#l66.138"></a><span id="l66.138" class="difflineplus">+                 STOP_COLORS + &quot;\n&quot;);</span>
<a href="#l66.139"></a><span id="l66.139" class="difflineplus">+            throw ex;</span>
<a href="#l66.140"></a><span id="l66.140" class="difflineplus">+          }</span>
<a href="#l66.141"></a><span id="l66.141" class="difflineplus">+          aContext.depth--;</span>
<a href="#l66.142"></a><span id="l66.142" class="difflineplus">+          dump(indent + &quot;&lt;-- &quot; + aSettings.outroCode + aDesc + &quot;::&quot; + name +</span>
<a href="#l66.143"></a><span id="l66.143" class="difflineplus">+               &quot;: &quot; + (ret != null ? ret.toString() : &quot;null&quot;) +</span>
<a href="#l66.144"></a><span id="l66.144" class="difflineplus">+               STOP_COLORS + &quot;\n&quot;);</span>
<a href="#l66.145"></a><span id="l66.145" class="difflineplus">+          return ret;</span>
<a href="#l66.146"></a><span id="l66.146" class="difflineplus">+        };</span>
<a href="#l66.147"></a><span id="l66.147" class="difflineplus">+      }</span>
<a href="#l66.148"></a><span id="l66.148" class="difflineplus">+    }</span>
<a href="#l66.149"></a><span id="l66.149" class="difflineplus">+  }</span>
<a href="#l66.150"></a><span id="l66.150" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l67.1"></a><span id="l67.1" class="difflineminus">--- a/mailnews/jar.mn</span>
<a href="#l67.2"></a><span id="l67.2" class="difflineplus">+++ b/mailnews/jar.mn</span>
<a href="#l67.3"></a><span id="l67.3" class="difflineat">@@ -83,17 +83,16 @@ messenger.jar:</span>
<a href="#l67.4"></a><span id="l67.4">     content/messenger/msgSynchronize.js                                        (base/resources/content/msgSynchronize.js)</span>
<a href="#l67.5"></a><span id="l67.5">     content/messenger/folderProps.xul                                          (base/resources/content/folderProps.xul)</span>
<a href="#l67.6"></a><span id="l67.6">     content/messenger/folderProps.js                                           (base/resources/content/folderProps.js)</span>
<a href="#l67.7"></a><span id="l67.7">     content/messenger/folderWidgets.xml                                        (base/resources/content/folderWidgets.xml)</span>
<a href="#l67.8"></a><span id="l67.8">     content/messenger/retention.js                                             (base/resources/content/retention.js)</span>
<a href="#l67.9"></a><span id="l67.9">     content/messenger/shareglue.js                                             (base/resources/content/shareglue.js)</span>
<a href="#l67.10"></a><span id="l67.10">     content/messenger/newFolderDialog.xul                                      (base/resources/content/newFolderDialog.xul)</span>
<a href="#l67.11"></a><span id="l67.11">     content/messenger/newFolderDialog.js                                       (base/resources/content/newFolderDialog.js)</span>
<a href="#l67.12"></a><span id="l67.12" class="difflineminus">-    content/messenger/msgViewNavigation.js                                     (base/resources/content/msgViewNavigation.js)</span>
<a href="#l67.13"></a><span id="l67.13"> *   content/messenger/msgAccountCentral.xul                                    (base/resources/content/msgAccountCentral.xul)</span>
<a href="#l67.14"></a><span id="l67.14">     content/messenger/msgAccountCentral.js                                     (base/resources/content/msgAccountCentral.js)</span>
<a href="#l67.15"></a><span id="l67.15">     content/messenger/msgFolderPickerOverlay.js                                (base/resources/content/msgFolderPickerOverlay.js)</span>
<a href="#l67.16"></a><span id="l67.16">     content/messenger/renameFolderDialog.xul                                   (base/resources/content/renameFolderDialog.xul)</span>
<a href="#l67.17"></a><span id="l67.17">     content/messenger/renameFolderDialog.js                                    (base/resources/content/renameFolderDialog.js)</span>
<a href="#l67.18"></a><span id="l67.18">     content/messenger/virtualFolderProperties.xul                              (base/resources/content/virtualFolderProperties.xul)</span>
<a href="#l67.19"></a><span id="l67.19">     content/messenger/virtualFolderProperties.js                               (base/resources/content/virtualFolderProperties.js)</span>
<a href="#l67.20"></a><span id="l67.20">     content/messenger/virtualFolderListDialog.xul                              (base/resources/content/virtualFolderListDialog.xul)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l68.1"></a><span id="l68.1" class="difflineminus">--- a/mailnews/test/resources/viewWrapperTestUtils.js</span>
<a href="#l68.2"></a><span id="l68.2" class="difflineplus">+++ b/mailnews/test/resources/viewWrapperTestUtils.js</span>
<a href="#l68.3"></a><span id="l68.3" class="difflineat">@@ -1,14 +1,63 @@</span>
<a href="#l68.4"></a><span id="l68.4" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l68.5"></a><span id="l68.5" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l68.6"></a><span id="l68.6" class="difflineplus">+ *</span>
<a href="#l68.7"></a><span id="l68.7" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l68.8"></a><span id="l68.8" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l68.9"></a><span id="l68.9" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l68.10"></a><span id="l68.10" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l68.11"></a><span id="l68.11" class="difflineplus">+ *</span>
<a href="#l68.12"></a><span id="l68.12" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l68.13"></a><span id="l68.13" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l68.14"></a><span id="l68.14" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l68.15"></a><span id="l68.15" class="difflineplus">+ * License.</span>
<a href="#l68.16"></a><span id="l68.16" class="difflineplus">+ *</span>
<a href="#l68.17"></a><span id="l68.17" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l68.18"></a><span id="l68.18" class="difflineplus">+ *</span>
<a href="#l68.19"></a><span id="l68.19" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l68.20"></a><span id="l68.20" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l68.21"></a><span id="l68.21" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l68.22"></a><span id="l68.22" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l68.23"></a><span id="l68.23" class="difflineplus">+ *</span>
<a href="#l68.24"></a><span id="l68.24" class="difflineplus">+ * Contributor(s):</span>
<a href="#l68.25"></a><span id="l68.25" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l68.26"></a><span id="l68.26" class="difflineplus">+ *</span>
<a href="#l68.27"></a><span id="l68.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l68.28"></a><span id="l68.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l68.29"></a><span id="l68.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l68.30"></a><span id="l68.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l68.31"></a><span id="l68.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l68.32"></a><span id="l68.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l68.33"></a><span id="l68.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l68.34"></a><span id="l68.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l68.35"></a><span id="l68.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l68.36"></a><span id="l68.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l68.37"></a><span id="l68.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l68.38"></a><span id="l68.38" class="difflineplus">+ *</span>
<a href="#l68.39"></a><span id="l68.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l68.40"></a><span id="l68.40"> </span>
<a href="#l68.41"></a><span id="l68.41"> Components.utils.import(&quot;resource://app/modules/dbViewWrapper.js&quot;);</span>
<a href="#l68.42"></a><span id="l68.42"> Components.utils.import(&quot;resource://app/modules/mailViewManager.js&quot;);</span>
<a href="#l68.43"></a><span id="l68.43"> Components.utils.import(&quot;resource://app/modules/quickSearchManager.js&quot;);</span>
<a href="#l68.44"></a><span id="l68.44"> Components.utils.import(&quot;resource://app/modules/virtualFolderWrapper.js&quot;);</span>
<a href="#l68.45"></a><span id="l68.45"> </span>
<a href="#l68.46"></a><span id="l68.46" class="difflineplus">+var gMessageGenerator, gMessageScenarioFactory;</span>
<a href="#l68.47"></a><span id="l68.47" class="difflineplus">+</span>
<a href="#l68.48"></a><span id="l68.48" class="difflineplus">+/**</span>
<a href="#l68.49"></a><span id="l68.49" class="difflineplus">+ * Do initialization for xpcshell-tests; not used by</span>
<a href="#l68.50"></a><span id="l68.50" class="difflineplus">+ *  test-folder-display-helpers.js, our friendly mozmill test helper.</span>
<a href="#l68.51"></a><span id="l68.51" class="difflineplus">+ */</span>
<a href="#l68.52"></a><span id="l68.52" class="difflineplus">+function initViewWrapperTestUtils() {</span>
<a href="#l68.53"></a><span id="l68.53" class="difflineplus">+  gMessageGenerator = new MessageGenerator();</span>
<a href="#l68.54"></a><span id="l68.54" class="difflineplus">+  gMessageScenarioFactory = new MessageScenarioFactory(gMessageGenerator);</span>
<a href="#l68.55"></a><span id="l68.55" class="difflineplus">+</span>
<a href="#l68.56"></a><span id="l68.56" class="difflineplus">+  async_test_runner_register_helper(VWTU_testHelper);</span>
<a href="#l68.57"></a><span id="l68.57" class="difflineplus">+}</span>
<a href="#l68.58"></a><span id="l68.58" class="difflineplus">+</span>
<a href="#l68.59"></a><span id="l68.59"> // something less sucky than do_check_true</span>
<a href="#l68.60"></a><span id="l68.60"> function assert_true(aBeTrue, aWhy, aDumpView) {</span>
<a href="#l68.61"></a><span id="l68.61">   if (!aBeTrue) {</span>
<a href="#l68.62"></a><span id="l68.62">     if (aDumpView)</span>
<a href="#l68.63"></a><span id="l68.63">       dump_view_state(VWTU_testHelper.active_view_wrappers[0]);</span>
<a href="#l68.64"></a><span id="l68.64">     do_throw(aWhy);</span>
<a href="#l68.65"></a><span id="l68.65">   }</span>
<a href="#l68.66"></a><span id="l68.66"> }</span>
<a href="#l68.67"></a><span id="l68.67" class="difflineat">@@ -24,27 +73,37 @@ function assert_false(aBeFalse, aWhy, aD</span>
<a href="#l68.68"></a><span id="l68.68"> function assert_equals(aA, aB, aWhy, aDumpView) {</span>
<a href="#l68.69"></a><span id="l68.69">   if (aA != aB) {</span>
<a href="#l68.70"></a><span id="l68.70">     if (aDumpView)</span>
<a href="#l68.71"></a><span id="l68.71">       dump_view_state(VWTU_testHelper.active_view_wrappers[0]);</span>
<a href="#l68.72"></a><span id="l68.72">     do_throw(aWhy);</span>
<a href="#l68.73"></a><span id="l68.73">   }</span>
<a href="#l68.74"></a><span id="l68.74"> }</span>
<a href="#l68.75"></a><span id="l68.75"> </span>
<a href="#l68.76"></a><span id="l68.76" class="difflineplus">+function assert_bit_set(aWhat, aBit, aWhy) {</span>
<a href="#l68.77"></a><span id="l68.77" class="difflineplus">+  if (!(aWhat &amp; aBit))</span>
<a href="#l68.78"></a><span id="l68.78" class="difflineplus">+    do_throw(aWhy);</span>
<a href="#l68.79"></a><span id="l68.79" class="difflineplus">+}</span>
<a href="#l68.80"></a><span id="l68.80" class="difflineplus">+</span>
<a href="#l68.81"></a><span id="l68.81" class="difflineplus">+function assert_bit_not_set(aWhat, aBit, aWhy) {</span>
<a href="#l68.82"></a><span id="l68.82" class="difflineplus">+  if (aWhat &amp; aBit)</span>
<a href="#l68.83"></a><span id="l68.83" class="difflineplus">+    do_throw(aWhy);</span>
<a href="#l68.84"></a><span id="l68.84" class="difflineplus">+}</span>
<a href="#l68.85"></a><span id="l68.85" class="difflineplus">+</span>
<a href="#l68.86"></a><span id="l68.86"> var gFakeCommandUpdater = {</span>
<a href="#l68.87"></a><span id="l68.87" class="difflineminus">-  updateCommandStatus : function()</span>
<a href="#l68.88"></a><span id="l68.88" class="difflineminus">-  {</span>
<a href="#l68.89"></a><span id="l68.89" class="difflineplus">+  updateCommandStatus : function() {</span>
<a href="#l68.90"></a><span id="l68.90">   },</span>
<a href="#l68.91"></a><span id="l68.91"> </span>
<a href="#l68.92"></a><span id="l68.92" class="difflineminus">-  displayMessageChanged : function(aFolder, aSubject, aKeywords)</span>
<a href="#l68.93"></a><span id="l68.93" class="difflineminus">-  {</span>
<a href="#l68.94"></a><span id="l68.94" class="difflineplus">+  displayMessageChanged : function(aFolder, aSubject, aKeywords) {</span>
<a href="#l68.95"></a><span id="l68.95">   },</span>
<a href="#l68.96"></a><span id="l68.96"> </span>
<a href="#l68.97"></a><span id="l68.97" class="difflineminus">-  updateNextMessageAfterDelete : function()</span>
<a href="#l68.98"></a><span id="l68.98" class="difflineminus">-  {</span>
<a href="#l68.99"></a><span id="l68.99" class="difflineplus">+  summarizeSelection: function () {</span>
<a href="#l68.100"></a><span id="l68.100" class="difflineplus">+  },</span>
<a href="#l68.101"></a><span id="l68.101" class="difflineplus">+</span>
<a href="#l68.102"></a><span id="l68.102" class="difflineplus">+  updateNextMessageAfterDelete : function() {</span>
<a href="#l68.103"></a><span id="l68.103">   }</span>
<a href="#l68.104"></a><span id="l68.104"> };</span>
<a href="#l68.105"></a><span id="l68.105"> </span>
<a href="#l68.106"></a><span id="l68.106"> var gMockViewWrapperListener = {</span>
<a href="#l68.107"></a><span id="l68.107">   __proto__: IDBViewWrapperListener.prototype,</span>
<a href="#l68.108"></a><span id="l68.108">   shouldUseMailViews: true,</span>
<a href="#l68.109"></a><span id="l68.109">   shouldDeferMessageDisplayUntilAfterServerConnect: false,</span>
<a href="#l68.110"></a><span id="l68.110">   messenger: null,</span>
<a href="#l68.111"></a><span id="l68.111" class="difflineat">@@ -83,18 +142,34 @@ var VWTU_testHelper = {</span>
<a href="#l68.112"></a><span id="l68.112">   active_virtual_folders: [],</span>
<a href="#l68.113"></a><span id="l68.113"> </span>
<a href="#l68.114"></a><span id="l68.114">   postTest: function () {</span>
<a href="#l68.115"></a><span id="l68.115">     // close all the views we opened</span>
<a href="#l68.116"></a><span id="l68.116">     this.active_view_wrappers.forEach(function (wrapper) {</span>
<a href="#l68.117"></a><span id="l68.117">       wrapper.close();</span>
<a href="#l68.118"></a><span id="l68.118">     });</span>
<a href="#l68.119"></a><span id="l68.119">     // verify that the notification helper has no outstanding listeners.</span>
<a href="#l68.120"></a><span id="l68.120" class="difflineminus">-    if (IDBViewWrapperListener.prototype._FNH.haveListeners())</span>
<a href="#l68.121"></a><span id="l68.121" class="difflineminus">-      do_throw(&quot;FolderNotificationHelper has listeners, but should not.&quot;);</span>
<a href="#l68.122"></a><span id="l68.122" class="difflineplus">+    if (IDBViewWrapperListener.prototype._FNH.haveListeners()) {</span>
<a href="#l68.123"></a><span id="l68.123" class="difflineplus">+      let msg = &quot;FolderNotificationHelper has listeners, but should not.&quot;;</span>
<a href="#l68.124"></a><span id="l68.124" class="difflineplus">+      dump(&quot;*** &quot; + msg + &quot;\n&quot;);</span>
<a href="#l68.125"></a><span id="l68.125" class="difflineplus">+      dump(&quot;Pending URIs:\n&quot;);</span>
<a href="#l68.126"></a><span id="l68.126" class="difflineplus">+      for each (let [folderURI, wrappers] in</span>
<a href="#l68.127"></a><span id="l68.127" class="difflineplus">+                Iterator(IDBViewWrapperListener.prototype._FNH</span>
<a href="#l68.128"></a><span id="l68.128" class="difflineplus">+                           ._pendingFolderUriToViewWrapperLists)) {</span>
<a href="#l68.129"></a><span id="l68.129" class="difflineplus">+        dump(&quot;  &quot; + folderURI + &quot;\n&quot;);</span>
<a href="#l68.130"></a><span id="l68.130" class="difflineplus">+      }</span>
<a href="#l68.131"></a><span id="l68.131" class="difflineplus">+      dump(&quot;Interested wrappers:\n&quot;);</span>
<a href="#l68.132"></a><span id="l68.132" class="difflineplus">+      for each (let [folderURI, wrappers] in</span>
<a href="#l68.133"></a><span id="l68.133" class="difflineplus">+                Iterator(IDBViewWrapperListener.prototype._FNH</span>
<a href="#l68.134"></a><span id="l68.134" class="difflineplus">+                           ._interestedWrappers)) {</span>
<a href="#l68.135"></a><span id="l68.135" class="difflineplus">+        dump(&quot;  &quot; + folderURI + &quot;\n&quot;);</span>
<a href="#l68.136"></a><span id="l68.136" class="difflineplus">+      }</span>
<a href="#l68.137"></a><span id="l68.137" class="difflineplus">+      dump(&quot;***\n&quot;);</span>
<a href="#l68.138"></a><span id="l68.138" class="difflineplus">+      do_throw(msg);</span>
<a href="#l68.139"></a><span id="l68.139" class="difflineplus">+    }</span>
<a href="#l68.140"></a><span id="l68.140">     // force the folder to forget about the message database</span>
<a href="#l68.141"></a><span id="l68.141">     this.active_virtual_folders.forEach(function (folder) {</span>
<a href="#l68.142"></a><span id="l68.142">       folder.msgDatabase = null;</span>
<a href="#l68.143"></a><span id="l68.143">     });</span>
<a href="#l68.144"></a><span id="l68.144">     this.active_real_folders.forEach(function (folder) {</span>
<a href="#l68.145"></a><span id="l68.145">       folder.msgDatabase = null;</span>
<a href="#l68.146"></a><span id="l68.146">     });</span>
<a href="#l68.147"></a><span id="l68.147"> </span>
<a href="#l68.148"></a><span id="l68.148" class="difflineat">@@ -115,17 +190,16 @@ var VWTU_testHelper = {</span>
<a href="#l68.149"></a><span id="l68.149">     }</span>
<a href="#l68.150"></a><span id="l68.150">     for each (let [i, viewWrapper] in Iterator(this.active_view_wrappers)) {</span>
<a href="#l68.151"></a><span id="l68.151">       dump(&quot;-----------------------------------\n&quot;);</span>
<a href="#l68.152"></a><span id="l68.152">       dump(&quot;Active view wrapper &quot; + i + &quot;\n&quot;);</span>
<a href="#l68.153"></a><span id="l68.153">       dump_view_state(viewWrapper);</span>
<a href="#l68.154"></a><span id="l68.154">     }</span>
<a href="#l68.155"></a><span id="l68.155">   }</span>
<a href="#l68.156"></a><span id="l68.156"> };</span>
<a href="#l68.157"></a><span id="l68.157" class="difflineminus">-async_test_runner_register_helper(VWTU_testHelper);</span>
<a href="#l68.158"></a><span id="l68.158"> </span>
<a href="#l68.159"></a><span id="l68.159"> function make_view_wrapper() {</span>
<a href="#l68.160"></a><span id="l68.160">   let wrapper = new DBViewWrapper(gMockViewWrapperListener);</span>
<a href="#l68.161"></a><span id="l68.161">   VWTU_testHelper.active_view_wrappers.push(wrapper);</span>
<a href="#l68.162"></a><span id="l68.162">   return wrapper;</span>
<a href="#l68.163"></a><span id="l68.163"> }</span>
<a href="#l68.164"></a><span id="l68.164"> </span>
<a href="#l68.165"></a><span id="l68.165"> /**</span>
<a href="#l68.166"></a><span id="l68.166" class="difflineat">@@ -457,16 +531,34 @@ function verify_view_level_histogram(aEx</span>
<a href="#l68.167"></a><span id="l68.167">       dump(&quot;Expected count for histogram level &quot; + level + &quot; was &quot; + count +</span>
<a href="#l68.168"></a><span id="l68.168">            &quot; but got &quot; + actualHisto[level] + &quot;\n&quot;);</span>
<a href="#l68.169"></a><span id="l68.169">       do_throw(&quot;View histogram does not match!&quot;);</span>
<a href="#l68.170"></a><span id="l68.170">     }</span>
<a href="#l68.171"></a><span id="l68.171">   }</span>
<a href="#l68.172"></a><span id="l68.172"> }</span>
<a href="#l68.173"></a><span id="l68.173"> </span>
<a href="#l68.174"></a><span id="l68.174"> /**</span>
<a href="#l68.175"></a><span id="l68.175" class="difflineplus">+ * Given a view wrapper and one or more view indices, verify that the row</span>
<a href="#l68.176"></a><span id="l68.176" class="difflineplus">+ *  returns true for isContainer.</span>
<a href="#l68.177"></a><span id="l68.177" class="difflineplus">+ *</span>
<a href="#l68.178"></a><span id="l68.178" class="difflineplus">+ * @param aViewWrapper The view wrapper in question</span>
<a href="#l68.179"></a><span id="l68.179" class="difflineplus">+ * @param ... View indices to check.</span>
<a href="#l68.180"></a><span id="l68.180" class="difflineplus">+ */</span>
<a href="#l68.181"></a><span id="l68.181" class="difflineplus">+function verify_view_row_at_index_is_container(aViewWrapper) {</span>
<a href="#l68.182"></a><span id="l68.182" class="difflineplus">+  let treeView = aViewWrapper.dbView.QueryInterface(Ci.nsITreeView);</span>
<a href="#l68.183"></a><span id="l68.183" class="difflineplus">+  for (let iArg = 1; iArg &lt; arguments.length; iArg++) {</span>
<a href="#l68.184"></a><span id="l68.184" class="difflineplus">+    let viewIndex = arguments[iArg];</span>
<a href="#l68.185"></a><span id="l68.185" class="difflineplus">+    if (!treeView.isContainer(viewIndex)) {</span>
<a href="#l68.186"></a><span id="l68.186" class="difflineplus">+      dump_view_state(aViewWrapper);</span>
<a href="#l68.187"></a><span id="l68.187" class="difflineplus">+      do_throw(&quot;Expected isContainer to be true at view index &quot; + viewIndex);</span>
<a href="#l68.188"></a><span id="l68.188" class="difflineplus">+    }</span>
<a href="#l68.189"></a><span id="l68.189" class="difflineplus">+  }</span>
<a href="#l68.190"></a><span id="l68.190" class="difflineplus">+}</span>
<a href="#l68.191"></a><span id="l68.191" class="difflineplus">+</span>
<a href="#l68.192"></a><span id="l68.192" class="difflineplus">+/**</span>
<a href="#l68.193"></a><span id="l68.193">  * Given a view wrapper and one or more view indices, verify that there is a</span>
<a href="#l68.194"></a><span id="l68.194">  *  dummy header at each provided index.</span>
<a href="#l68.195"></a><span id="l68.195">  *</span>
<a href="#l68.196"></a><span id="l68.196">  * @param aViewWrapper The view wrapper in question</span>
<a href="#l68.197"></a><span id="l68.197">  * @param ... View indices to check.</span>
<a href="#l68.198"></a><span id="l68.198">  */</span>
<a href="#l68.199"></a><span id="l68.199"> function verify_view_row_at_index_is_dummy(aViewWrapper) {</span>
<a href="#l68.200"></a><span id="l68.200">   for (let iArg = 1; iArg &lt; arguments.length; iArg++) {</span>
<a href="#l68.201"></a><span id="l68.201" class="difflineat">@@ -525,18 +617,16 @@ function make_folders_with_sets(aFolderC</span>
<a href="#l68.202"></a><span id="l68.202">   let msgFolders = [];</span>
<a href="#l68.203"></a><span id="l68.203">   for (let i = 0; i &lt; aFolderCount; i++)</span>
<a href="#l68.204"></a><span id="l68.204">     msgFolders.push(make_empty_folder());</span>
<a href="#l68.205"></a><span id="l68.205">   let results = make_new_sets_in_folders(msgFolders, aSynSetDefs);</span>
<a href="#l68.206"></a><span id="l68.206">   results.unshift(msgFolders);</span>
<a href="#l68.207"></a><span id="l68.207">   return results;</span>
<a href="#l68.208"></a><span id="l68.208"> }</span>
<a href="#l68.209"></a><span id="l68.209"> </span>
<a href="#l68.210"></a><span id="l68.210" class="difflineminus">-var gMessageGenerator = new MessageGenerator();</span>
<a href="#l68.211"></a><span id="l68.211" class="difflineminus">-var gMessageScenarioFactory = new MessageScenarioFactory(gMessageGenerator);</span>
<a href="#l68.212"></a><span id="l68.212"> /**</span>
<a href="#l68.213"></a><span id="l68.213">  * Given one or more existing local folder, create new message sets and add them</span>
<a href="#l68.214"></a><span id="l68.214">  *  to the folders using</span>
<a href="#l68.215"></a><span id="l68.215">  *</span>
<a href="#l68.216"></a><span id="l68.216">  * @param aMsgFolders A single nsIMsgLocalMailFolder or a list of them.  The</span>
<a href="#l68.217"></a><span id="l68.217">  *     synthetic messages will be added to the folder(s).</span>
<a href="#l68.218"></a><span id="l68.218">  * @param aSynSetDefs Either an integer describing the number of sets of</span>
<a href="#l68.219"></a><span id="l68.219">  *     messages to create (using default parameters), or a list of set</span>
<a href="#l68.220"></a><span id="l68.220" class="difflineat">@@ -625,16 +715,17 @@ function add_sets_to_folders(aMsgFolders</span>
<a href="#l68.221"></a><span id="l68.221">   // loop, incrementing our subscript until all message sets are out of messages</span>
<a href="#l68.222"></a><span id="l68.222">   let didSomething;</span>
<a href="#l68.223"></a><span id="l68.223">   do {</span>
<a href="#l68.224"></a><span id="l68.224">     didSomething = false;</span>
<a href="#l68.225"></a><span id="l68.225">     // for each message set, if it is not out of messages, add the message</span>
<a href="#l68.226"></a><span id="l68.226">     for each (let [, messageSet] in Iterator(aMessageSets)) {</span>
<a href="#l68.227"></a><span id="l68.227">       if (iPerSet &lt; messageSet.synMessages.length) {</span>
<a href="#l68.228"></a><span id="l68.228">         messageSet.addMessageToFolderByIndex(folder, iPerSet);</span>
<a href="#l68.229"></a><span id="l68.229" class="difflineplus">+        folder.hasNewMessages = true;</span>
<a href="#l68.230"></a><span id="l68.230">         didSomething = true;</span>
<a href="#l68.231"></a><span id="l68.231">       }</span>
<a href="#l68.232"></a><span id="l68.232">     }</span>
<a href="#l68.233"></a><span id="l68.233">     iPerSet++;</span>
<a href="#l68.234"></a><span id="l68.234">     folder = iterFolders.next();</span>
<a href="#l68.235"></a><span id="l68.235">   } while (didSomething);</span>
<a href="#l68.236"></a><span id="l68.236"> }</span>
<a href="#l68.237"></a><span id="l68.237"> /** singular function name for understandability of single-folder users */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l69.1"></a><span id="l69.1" class="difflineminus">--- a/suite/mailnews/jar.mn</span>
<a href="#l69.2"></a><span id="l69.2" class="difflineplus">+++ b/suite/mailnews/jar.mn</span>
<a href="#l69.3"></a><span id="l69.3" class="difflineat">@@ -32,16 +32,17 @@ messenger.jar:</span>
<a href="#l69.4"></a><span id="l69.4">     content/messenger/mailWindow.js</span>
<a href="#l69.5"></a><span id="l69.5">     content/messenger/messageWindow.xul</span>
<a href="#l69.6"></a><span id="l69.6">     content/messenger/messageWindow.js</span>
<a href="#l69.7"></a><span id="l69.7">     content/messenger/folderPane.xul</span>
<a href="#l69.8"></a><span id="l69.8">     content/messenger/threadPane.xul</span>
<a href="#l69.9"></a><span id="l69.9">     content/messenger/threadPane.js</span>
<a href="#l69.10"></a><span id="l69.10">     content/messenger/msgHdrViewOverlay.xul</span>
<a href="#l69.11"></a><span id="l69.11">     content/messenger/msgHdrViewOverlay.js</span>
<a href="#l69.12"></a><span id="l69.12" class="difflineplus">+    content/messenger/msgViewNavigation.js</span>
<a href="#l69.13"></a><span id="l69.13">     content/messenger/widgetglue.js</span>
<a href="#l69.14"></a><span id="l69.14">     content/messenger/commandglue.js</span>
<a href="#l69.15"></a><span id="l69.15">     content/messenger/mailCommands.js</span>
<a href="#l69.16"></a><span id="l69.16">     content/messenger/subscribe.xul</span>
<a href="#l69.17"></a><span id="l69.17">     content/messenger/subscribe.js</span>
<a href="#l69.18"></a><span id="l69.18">     content/messenger/msgMail3PaneWindow.js</span>
<a href="#l69.19"></a><span id="l69.19">     content/messenger/searchBar.js</span>
<a href="#l69.20"></a><span id="l69.20">     content/messenger/mail3PaneWindowCommands.js</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l70.1"></a><span id="l70.1">copy from mailnews/base/resources/content/msgViewNavigation.js</span>
<a href="#l70.2"></a><span id="l70.2">copy to suite/mailnews/msgViewNavigation.js</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

