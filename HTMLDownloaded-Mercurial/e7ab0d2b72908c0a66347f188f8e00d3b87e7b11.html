<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 29406:e7ab0d2b72908c0a66347f188f8e00d3b87e7b11</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ e7ab0d2b72908c0a66347f188f8e00d3b87e7b11" />
<meta property="og:url" content="/comm-central/rev/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11" />
<meta property="og:description" content="Bug 1612239 - Remove nsIArray use in nsIMsgFolderListener.msgsClassified(). r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / e7ab0d2b72908c0a66347f188f8e00d3b87e7b11 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11">shortlog</a> |
<a href="/comm-central/log/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11">files</a> |
changeset |
<a href="/comm-central/raw-rev/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11">raw</a>  | <a href="/comm-central/archive/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1612239">Bug 1612239</a> - Remove nsIArray use in nsIMsgFolderListener.msgsClassified(). r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#66;&#101;&#110;&#32;&#67;&#97;&#109;&#112;&#98;&#101;&#108;&#108;&#32;&#60;&#98;&#101;&#110;&#99;&#64;&#116;&#104;&#117;&#110;&#100;&#101;&#114;&#98;&#105;&#114;&#100;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 22 Apr 2020 15:04:54 +1200</td></tr>

<tr>
 <td>changeset 29406</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11">e7ab0d2b72908c0a66347f188f8e00d3b87e7b11</a></td>
</tr>



<tr>
<td>parent 29405</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/57db1cb173f9191c03b5e9c7970383e952965753">57db1cb173f9191c03b5e9c7970383e952965753</a>
</td>
</tr>

<tr>
<td>child 29407</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/9e23d0584abc41d2ea745363fe84de5a1f34147d">9e23d0584abc41d2ea745363fe84de5a1f34147d</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=e7ab0d2b72908c0a66347f188f8e00d3b87e7b11">17354</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Mon, 27 Apr 2020 22:25:26 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@e7ab0d2b7290 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=e7ab0d2b72908c0a66347f188f8e00d3b87e7b11">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=e7ab0d2b72908c0a66347f188f8e00d3b87e7b11&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e7ab0d2b72908c0a66347f188f8e00d3b87e7b11&newProject=comm-central&newRevision=8f494764f4401dd65f09711c5592d00b2b3bab78&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e7ab0d2b72908c0a66347f188f8e00d3b87e7b11&newProject=comm-central&newRevision=8f494764f4401dd65f09711c5592d00b2b3bab78&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e7ab0d2b72908c0a66347f188f8e00d3b87e7b11&newProject=comm-central&newRevision=8f494764f4401dd65f09711c5592d00b2b3bab78&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1612239">1612239</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1612239">Bug 1612239</a> - Remove nsIArray use in nsIMsgFolderListener.msgsClassified(). r=mkmelin</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mail/components/extensions/parent/ext-messages.js">mail/components/extensions/parent/ext-messages.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mail/components/extensions/parent/ext-messages.js">file</a> |
<a href="/comm-central/annotate/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mail/components/extensions/parent/ext-messages.js">annotate</a> |
<a href="/comm-central/diff/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mail/components/extensions/parent/ext-messages.js">diff</a> |
<a href="/comm-central/comparison/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mail/components/extensions/parent/ext-messages.js">comparison</a> |
<a href="/comm-central/log/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mail/components/extensions/parent/ext-messages.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/base/public/nsIMsgFolderListener.idl">mailnews/base/public/nsIMsgFolderListener.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/base/public/nsIMsgFolderListener.idl">file</a> |
<a href="/comm-central/annotate/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/base/public/nsIMsgFolderListener.idl">annotate</a> |
<a href="/comm-central/diff/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/base/public/nsIMsgFolderListener.idl">diff</a> |
<a href="/comm-central/comparison/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/base/public/nsIMsgFolderListener.idl">comparison</a> |
<a href="/comm-central/log/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/base/public/nsIMsgFolderListener.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/base/public/nsIMsgFolderNotificationService.idl">mailnews/base/public/nsIMsgFolderNotificationService.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/base/public/nsIMsgFolderNotificationService.idl">file</a> |
<a href="/comm-central/annotate/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/base/public/nsIMsgFolderNotificationService.idl">annotate</a> |
<a href="/comm-central/diff/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/base/public/nsIMsgFolderNotificationService.idl">diff</a> |
<a href="/comm-central/comparison/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/base/public/nsIMsgFolderNotificationService.idl">comparison</a> |
<a href="/comm-central/log/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/base/public/nsIMsgFolderNotificationService.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/base/src/nsMsgFolderNotificationService.cpp">mailnews/base/src/nsMsgFolderNotificationService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/base/src/nsMsgFolderNotificationService.cpp">file</a> |
<a href="/comm-central/annotate/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/base/src/nsMsgFolderNotificationService.cpp">annotate</a> |
<a href="/comm-central/diff/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/base/src/nsMsgFolderNotificationService.cpp">diff</a> |
<a href="/comm-central/comparison/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/base/src/nsMsgFolderNotificationService.cpp">comparison</a> |
<a href="/comm-central/log/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/base/src/nsMsgFolderNotificationService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/base/test/unit/test_nsIMsgFolderListener.js">mailnews/base/test/unit/test_nsIMsgFolderListener.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/base/test/unit/test_nsIMsgFolderListener.js">file</a> |
<a href="/comm-central/annotate/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/base/test/unit/test_nsIMsgFolderListener.js">annotate</a> |
<a href="/comm-central/diff/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/base/test/unit/test_nsIMsgFolderListener.js">diff</a> |
<a href="/comm-central/comparison/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/base/test/unit/test_nsIMsgFolderListener.js">comparison</a> |
<a href="/comm-central/log/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/base/test/unit/test_nsIMsgFolderListener.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/base/util/nsMsgDBFolder.cpp">mailnews/base/util/nsMsgDBFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/base/util/nsMsgDBFolder.cpp">file</a> |
<a href="/comm-central/annotate/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/base/util/nsMsgDBFolder.cpp">annotate</a> |
<a href="/comm-central/diff/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/base/util/nsMsgDBFolder.cpp">diff</a> |
<a href="/comm-central/comparison/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/base/util/nsMsgDBFolder.cpp">comparison</a> |
<a href="/comm-central/log/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/base/util/nsMsgDBFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/db/gloda/modules/IndexMsg.jsm">mailnews/db/gloda/modules/IndexMsg.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/db/gloda/modules/IndexMsg.jsm">file</a> |
<a href="/comm-central/annotate/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/db/gloda/modules/IndexMsg.jsm">annotate</a> |
<a href="/comm-central/diff/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/db/gloda/modules/IndexMsg.jsm">diff</a> |
<a href="/comm-central/comparison/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/db/gloda/modules/IndexMsg.jsm">comparison</a> |
<a href="/comm-central/log/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/db/gloda/modules/IndexMsg.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/imap/src/nsImapMailFolder.cpp">mailnews/imap/src/nsImapMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/imap/src/nsImapMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/imap/src/nsImapMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/imap/src/nsImapMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/imap/src/nsImapMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/imap/src/nsImapMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/imap/src/nsImapMailFolder.h">mailnews/imap/src/nsImapMailFolder.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/imap/src/nsImapMailFolder.h">file</a> |
<a href="/comm-central/annotate/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/imap/src/nsImapMailFolder.h">annotate</a> |
<a href="/comm-central/diff/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/imap/src/nsImapMailFolder.h">diff</a> |
<a href="/comm-central/comparison/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/imap/src/nsImapMailFolder.h">comparison</a> |
<a href="/comm-central/log/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/imap/src/nsImapMailFolder.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js">mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js">file</a> |
<a href="/comm-central/annotate/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js">annotate</a> |
<a href="/comm-central/diff/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js">diff</a> |
<a href="/comm-central/comparison/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js">comparison</a> |
<a href="/comm-central/log/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/local/src/nsLocalMailFolder.cpp">mailnews/local/src/nsLocalMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/local/src/nsLocalMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/local/src/nsLocalMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/local/src/nsLocalMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/local/src/nsLocalMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/local/src/nsLocalMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/local/src/nsRssIncomingServer.cpp">mailnews/local/src/nsRssIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/local/src/nsRssIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/local/src/nsRssIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/local/src/nsRssIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/local/src/nsRssIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/local/src/nsRssIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/test/resources/folderEventLogHelper.js">mailnews/test/resources/folderEventLogHelper.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/test/resources/folderEventLogHelper.js">file</a> |
<a href="/comm-central/annotate/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/test/resources/folderEventLogHelper.js">annotate</a> |
<a href="/comm-central/diff/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/test/resources/folderEventLogHelper.js">diff</a> |
<a href="/comm-central/comparison/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/test/resources/folderEventLogHelper.js">comparison</a> |
<a href="/comm-central/log/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/test/resources/folderEventLogHelper.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/test/resources/msgFolderListenerSetup.js">mailnews/test/resources/msgFolderListenerSetup.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/test/resources/msgFolderListenerSetup.js">file</a> |
<a href="/comm-central/annotate/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/test/resources/msgFolderListenerSetup.js">annotate</a> |
<a href="/comm-central/diff/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/test/resources/msgFolderListenerSetup.js">diff</a> |
<a href="/comm-central/comparison/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/test/resources/msgFolderListenerSetup.js">comparison</a> |
<a href="/comm-central/log/e7ab0d2b72908c0a66347f188f8e00d3b87e7b11/mailnews/test/resources/msgFolderListenerSetup.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/components/extensions/parent/ext-messages.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/components/extensions/parent/ext-messages.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -84,21 +84,17 @@ let newMailEventTracker = new (class ext</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5">     if (--this.listenerCount == 0) {</span>
<a href="#l1.6"></a><span id="l1.6">       MailServices.mfn.removeListener(this);</span>
<a href="#l1.7"></a><span id="l1.7">     }</span>
<a href="#l1.8"></a><span id="l1.8">   }</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10">   msgsClassified(messages, junkProcessed, traitProcessed) {</span>
<a href="#l1.11"></a><span id="l1.11">     if (messages.length &gt; 0) {</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-      this.emit(</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-        &quot;new-mail-received&quot;,</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-        messages.queryElementAt(0, Ci.nsIMsgDBHdr).folder,</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-        messages.enumerate()</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-      );</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+      this.emit(&quot;new-mail-received&quot;, messages[0].folder, messages);</span>
<a href="#l1.18"></a><span id="l1.18">     }</span>
<a href="#l1.19"></a><span id="l1.19">   }</span>
<a href="#l1.20"></a><span id="l1.20"> })();</span>
<a href="#l1.21"></a><span id="l1.21"> </span>
<a href="#l1.22"></a><span id="l1.22"> this.messages = class extends ExtensionAPI {</span>
<a href="#l1.23"></a><span id="l1.23">   getAPI(context) {</span>
<a href="#l1.24"></a><span id="l1.24">     function collectMessagesInFolders(messageIds) {</span>
<a href="#l1.25"></a><span id="l1.25">       let folderMap = new DefaultMap(() =&gt; new Set());</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgFolderListener.idl</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgFolderListener.idl</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -55,17 +55,17 @@ interface nsIMsgFolderListener : nsISupp</span>
<a href="#l2.4"></a><span id="l2.4">    * existence of the new message headers.</span>
<a href="#l2.5"></a><span id="l2.5">    *</span>
<a href="#l2.6"></a><span id="l2.6">    * @param aMsgs The message headers that have been classified or were</span>
<a href="#l2.7"></a><span id="l2.7">    *     intentionally not classified.</span>
<a href="#l2.8"></a><span id="l2.8">    * @param aJunkProcessed Were the messages processed for junk classification?</span>
<a href="#l2.9"></a><span id="l2.9">    * @param aTraitProcessed Were the messages processed for trait</span>
<a href="#l2.10"></a><span id="l2.10">    *     classification?</span>
<a href="#l2.11"></a><span id="l2.11">    */</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-  void msgsClassified(in nsIArray aMsgs, in boolean aJunkProcessed,</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+  void msgsClassified(in Array&lt;nsIMsgDBHdr&gt; aMsgs, in boolean aJunkProcessed,</span>
<a href="#l2.14"></a><span id="l2.14">                       in boolean aTraitProcessed);</span>
<a href="#l2.15"></a><span id="l2.15"> </span>
<a href="#l2.16"></a><span id="l2.16">   /**</span>
<a href="#l2.17"></a><span id="l2.17">    * Notified after a command to delete a group of messages has been given, but before the</span>
<a href="#l2.18"></a><span id="l2.18">    * messages have actually been deleted.</span>
<a href="#l2.19"></a><span id="l2.19">    *</span>
<a href="#l2.20"></a><span id="l2.20">    * @param aMsgs An array of the message headers about to be deleted</span>
<a href="#l2.21"></a><span id="l2.21">    *</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgFolderNotificationService.idl</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgFolderNotificationService.idl</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -54,17 +54,17 @@ interface nsIMsgFolderNotificationServic</span>
<a href="#l3.4"></a><span id="l3.4">   readonly attribute boolean hasListeners;</span>
<a href="#l3.5"></a><span id="l3.5">   void addListener(in nsIMsgFolderListener aListener,</span>
<a href="#l3.6"></a><span id="l3.6">                    in msgFolderListenerFlag flags);</span>
<a href="#l3.7"></a><span id="l3.7">   void removeListener(in nsIMsgFolderListener aListener);</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9">   // message-specific functions</span>
<a href="#l3.10"></a><span id="l3.10">   // single message for added, array for delete/move/copy</span>
<a href="#l3.11"></a><span id="l3.11">   void notifyMsgAdded(in nsIMsgDBHdr aMsg);</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  void notifyMsgsClassified(in nsIArray aMsgs,</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+  void notifyMsgsClassified(in Array&lt;nsIMsgDBHdr&gt; aMsgs,</span>
<a href="#l3.14"></a><span id="l3.14">                             in boolean aJunkProcessed,</span>
<a href="#l3.15"></a><span id="l3.15">                             in boolean aTraitProcessed);</span>
<a href="#l3.16"></a><span id="l3.16">   void notifyMsgsDeleted(in Array&lt;nsIMsgDBHdr&gt; aMsgs);</span>
<a href="#l3.17"></a><span id="l3.17">   void notifyMsgsMoveCopyCompleted(in boolean aMove,</span>
<a href="#l3.18"></a><span id="l3.18">                                    in nsIArray aSrcMsgs,</span>
<a href="#l3.19"></a><span id="l3.19">                                    in nsIMsgFolder aDestFolder,</span>
<a href="#l3.20"></a><span id="l3.20">                                    in nsIArray aDestMsgs);</span>
<a href="#l3.21"></a><span id="l3.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/src/nsMsgFolderNotificationService.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgFolderNotificationService.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -59,17 +59,18 @@ NS_IMETHODIMP nsMsgFolderNotificationSer</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5"> NS_IMETHODIMP nsMsgFolderNotificationService::NotifyMsgAdded(</span>
<a href="#l4.6"></a><span id="l4.6">     nsIMsgDBHdr *aMsg) {</span>
<a href="#l4.7"></a><span id="l4.7">   NOTIFY_MSGFOLDER_LISTENERS(msgAdded, MsgAdded, (aMsg));</span>
<a href="#l4.8"></a><span id="l4.8">   return NS_OK;</span>
<a href="#l4.9"></a><span id="l4.9"> }</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11"> NS_IMETHODIMP nsMsgFolderNotificationService::NotifyMsgsClassified(</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    nsIArray *aMsgs, bool aJunkProcessed, bool aTraitProcessed) {</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+    const nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; &amp;aMsgs, bool aJunkProcessed,</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+    bool aTraitProcessed) {</span>
<a href="#l4.15"></a><span id="l4.15">   NOTIFY_MSGFOLDER_LISTENERS(msgsClassified, MsgsClassified,</span>
<a href="#l4.16"></a><span id="l4.16">                              (aMsgs, aJunkProcessed, aTraitProcessed));</span>
<a href="#l4.17"></a><span id="l4.17">   return NS_OK;</span>
<a href="#l4.18"></a><span id="l4.18"> }</span>
<a href="#l4.19"></a><span id="l4.19"> </span>
<a href="#l4.20"></a><span id="l4.20"> NS_IMETHODIMP nsMsgFolderNotificationService::NotifyMsgsDeleted(</span>
<a href="#l4.21"></a><span id="l4.21">     const nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; &amp;aMsgs) {</span>
<a href="#l4.22"></a><span id="l4.22">   NOTIFY_MSGFOLDER_LISTENERS(msgsDeleted, MsgsDeleted, (aMsgs));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/test/unit/test_nsIMsgFolderListener.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_nsIMsgFolderListener.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -112,17 +112,17 @@ gMFListener.prototype = {</span>
<a href="#l5.4"></a><span id="l5.4">     if (this.mRemoveSelf) {</span>
<a href="#l5.5"></a><span id="l5.5">       MailServices.mfn.removeListener(this);</span>
<a href="#l5.6"></a><span id="l5.6">     }</span>
<a href="#l5.7"></a><span id="l5.7">   },</span>
<a href="#l5.8"></a><span id="l5.8"> };</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10"> function NotifyMsgFolderListeners() {</span>
<a href="#l5.11"></a><span id="l5.11">   MailServices.mfn.notifyMsgAdded(null);</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  MailServices.mfn.notifyMsgsClassified(null, null, null);</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+  MailServices.mfn.notifyMsgsClassified([], null, null);</span>
<a href="#l5.14"></a><span id="l5.14">   MailServices.mfn.notifyMsgsDeleted([]);</span>
<a href="#l5.15"></a><span id="l5.15">   MailServices.mfn.notifyMsgsMoveCopyCompleted(null, null, null, null);</span>
<a href="#l5.16"></a><span id="l5.16">   MailServices.mfn.notifyMsgKeyChanged(null, null);</span>
<a href="#l5.17"></a><span id="l5.17">   MailServices.mfn.notifyFolderAdded(null);</span>
<a href="#l5.18"></a><span id="l5.18">   MailServices.mfn.notifyFolderDeleted(null);</span>
<a href="#l5.19"></a><span id="l5.19">   MailServices.mfn.notifyFolderMoveCopyCompleted(null, null, null);</span>
<a href="#l5.20"></a><span id="l5.20">   MailServices.mfn.notifyFolderRenamed(null, null);</span>
<a href="#l5.21"></a><span id="l5.21">   MailServices.mfn.notifyItemEvent(null, null, null, null);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -2119,48 +2119,27 @@ nsMsgDBFolder::OnMessageClassified(const</span>
<a href="#l6.4"></a><span id="l6.4">         // appearing in the middle of automatic filtering (plus I really don't</span>
<a href="#l6.5"></a><span id="l6.5">         // want to propagate that value.)</span>
<a href="#l6.6"></a><span id="l6.6">         rv = filterService-&gt;ApplyFilters(nsMsgFilterType::PostPlugin,</span>
<a href="#l6.7"></a><span id="l6.7">                                          mPostBayesMessagesToFilter, this,</span>
<a href="#l6.8"></a><span id="l6.8">                                          nullptr, nullptr);</span>
<a href="#l6.9"></a><span id="l6.9">       mPostBayesMessagesToFilter-&gt;Clear();</span>
<a href="#l6.10"></a><span id="l6.10">     }</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-    // Bail if we didn't actually classify any messages.</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-    if (mClassifiedMsgKeys.IsEmpty()) return rv;</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-    // Notify that we classified some messages.</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-        do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">-    nsCOMPtr&lt;nsIMutableArray&gt; classifiedMsgHdrs =</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-        do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+    // If we classified any messages, send out a notification.</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+    nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; hdrs;</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+    rv = MsgGetHeadersFromKeys2(mDatabase, mClassifiedMsgKeys, hdrs);</span>
<a href="#l6.25"></a><span id="l6.25">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineminus">-</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineminus">-    uint32_t numKeys = mClassifiedMsgKeys.Length();</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineminus">-    for (uint32_t i = 0; i &lt; numKeys; ++i) {</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineminus">-      nsMsgKey msgKey = mClassifiedMsgKeys[i];</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-      bool hasKey;</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-      // It is very possible for a message header to no longer be around because</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-      // a filter moved it.</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-      rv = mDatabase-&gt;ContainsKey(msgKey, &amp;hasKey);</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-      if (!NS_SUCCEEDED(rv) || !hasKey) continue;</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-      nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">-      rv = mDatabase-&gt;GetMsgHdrForKey(msgKey, getter_AddRefs(msgHdr));</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineminus">-      if (!NS_SUCCEEDED(rv)) continue;</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">-      classifiedMsgHdrs-&gt;AppendElement(msgHdr);</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+    if (!hdrs.IsEmpty()) {</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+      nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+          do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+      notifier-&gt;NotifyMsgsClassified(hdrs, mBayesJunkClassifying,</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+                                     mBayesTraitClassifying);</span>
<a href="#l6.45"></a><span id="l6.45">     }</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineminus">-</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineminus">-    // only generate the notification if there are some classified messages</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineminus">-    if (NS_SUCCEEDED(classifiedMsgHdrs-&gt;GetLength(&amp;length)) &amp;&amp; length)</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineminus">-      notifier-&gt;NotifyMsgsClassified(classifiedMsgHdrs, mBayesJunkClassifying,</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineminus">-                                     mBayesTraitClassifying);</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineminus">-    mClassifiedMsgKeys.Clear();</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineminus">-</span>
<a href="#l6.53"></a><span id="l6.53">     return rv;</span>
<a href="#l6.54"></a><span id="l6.54">   }</span>
<a href="#l6.55"></a><span id="l6.55"> </span>
<a href="#l6.56"></a><span id="l6.56">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l6.57"></a><span id="l6.57">   rv = GetServer(getter_AddRefs(server));</span>
<a href="#l6.58"></a><span id="l6.58">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.59"></a><span id="l6.59"> </span>
<a href="#l6.60"></a><span id="l6.60">   nsCOMPtr&lt;nsISpamSettings&gt; spamSettings;</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineat">@@ -2588,27 +2567,25 @@ nsMsgDBFolder::CallFilterPlugins(nsIMsgW</span>
<a href="#l6.62"></a><span id="l6.62"> }</span>
<a href="#l6.63"></a><span id="l6.63"> </span>
<a href="#l6.64"></a><span id="l6.64"> /**</span>
<a href="#l6.65"></a><span id="l6.65">  * Adds the messages in the NotReportedClassified mProcessing set to the</span>
<a href="#l6.66"></a><span id="l6.66">  * (possibly empty) array of msgHdrsNotBeingClassified, and send the</span>
<a href="#l6.67"></a><span id="l6.67">  * nsIMsgFolderNotificationService notification.</span>
<a href="#l6.68"></a><span id="l6.68">  */</span>
<a href="#l6.69"></a><span id="l6.69"> nsresult nsMsgDBFolder::NotifyHdrsNotBeingClassified() {</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; msgHdrsNotBeingClassified;</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineminus">-</span>
<a href="#l6.72"></a><span id="l6.72">   if (mProcessingFlag[5].keys) {</span>
<a href="#l6.73"></a><span id="l6.73">     nsTArray&lt;nsMsgKey&gt; keys;</span>
<a href="#l6.74"></a><span id="l6.74">     mProcessingFlag[5].keys-&gt;ToMsgKeyArray(keys);</span>
<a href="#l6.75"></a><span id="l6.75">     if (keys.Length()) {</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineminus">-      msgHdrsNotBeingClassified = do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineminus">-      if (!msgHdrsNotBeingClassified) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l6.78"></a><span id="l6.78">       nsresult rv = GetDatabase();</span>
<a href="#l6.79"></a><span id="l6.79">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineminus">-      MsgGetHeadersFromKeys(mDatabase, keys, msgHdrsNotBeingClassified);</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineplus">+      nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; msgHdrsNotBeingClassified;</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineplus">+      rv = MsgGetHeadersFromKeys2(mDatabase, keys, msgHdrsNotBeingClassified);</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.84"></a><span id="l6.84"> </span>
<a href="#l6.85"></a><span id="l6.85">       // Since we know we've handled all the NotReportedClassified messages,</span>
<a href="#l6.86"></a><span id="l6.86">       // we clear the set by deleting and recreating it.</span>
<a href="#l6.87"></a><span id="l6.87">       delete mProcessingFlag[5].keys;</span>
<a href="#l6.88"></a><span id="l6.88">       mProcessingFlag[5].keys = nsMsgKeySetU::Create();</span>
<a href="#l6.89"></a><span id="l6.89">       nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(</span>
<a href="#l6.90"></a><span id="l6.90">           do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l6.91"></a><span id="l6.91">       if (notifier)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/db/gloda/modules/IndexMsg.jsm</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/IndexMsg.jsm</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -2144,18 +2144,17 @@ var GlodaMsgIndexer = {</span>
<a href="#l7.4"></a><span id="l7.4">   /**</span>
<a href="#l7.5"></a><span id="l7.5">    * Common logic for things that want to feed event-driven indexing.  This gets</span>
<a href="#l7.6"></a><span id="l7.6">    *  called by both |_msgFolderListener.msgsClassified| when we are first</span>
<a href="#l7.7"></a><span id="l7.7">    *  seeing a message as well as by |_folderListener| when things happen to</span>
<a href="#l7.8"></a><span id="l7.8">    *  existing messages.  Although we could slightly specialize for the</span>
<a href="#l7.9"></a><span id="l7.9">    *  new-to-us case, it works out to be cleaner to just treat them the same</span>
<a href="#l7.10"></a><span id="l7.10">    *  and take a very small performance hit.</span>
<a href="#l7.11"></a><span id="l7.11">    *</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-   * @param aMsgHdrs Something fixIterator will work on to return an iterator</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-   *     on the set of messages that we should treat as potentially changed.</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+   * @param aMsgHdrs array of messages to treat as potentially changed.</span>
<a href="#l7.15"></a><span id="l7.15">    * @param aDirtyingEvent Is this event inherently dirtying?  Receiving a</span>
<a href="#l7.16"></a><span id="l7.16">    *     msgsClassified notification is not inherently dirtying because it is</span>
<a href="#l7.17"></a><span id="l7.17">    *     just telling us that a message exists.  We use this knowledge to</span>
<a href="#l7.18"></a><span id="l7.18">    *     ignore the msgsClassified notifications for messages we have received</span>
<a href="#l7.19"></a><span id="l7.19">    *     msgKeyChanged notifications for and fast-pathed.  Since it is possible</span>
<a href="#l7.20"></a><span id="l7.20">    *     for user action to do something that dirties the message between the</span>
<a href="#l7.21"></a><span id="l7.21">    *     time we get the msgKeyChanged notification and when we receive the</span>
<a href="#l7.22"></a><span id="l7.22">    *     msgsClassified notification, we want to make sure we don't get</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineat">@@ -2163,17 +2162,17 @@ var GlodaMsgIndexer = {</span>
<a href="#l7.24"></a><span id="l7.24">    *     after the first notification, we would likely just mistakenly treat</span>
<a href="#l7.25"></a><span id="l7.25">    *     the msgsClassified notification as something dirtying, so it would</span>
<a href="#l7.26"></a><span id="l7.26">    *     still work out...)</span>
<a href="#l7.27"></a><span id="l7.27">    */</span>
<a href="#l7.28"></a><span id="l7.28">   _reindexChangedMessages(aMsgHdrs, aDirtyingEvent) {</span>
<a href="#l7.29"></a><span id="l7.29">     let glodaIdsNeedingDeletion = null;</span>
<a href="#l7.30"></a><span id="l7.30">     let messageKeyChangedIds = null,</span>
<a href="#l7.31"></a><span id="l7.31">       messageKeyChangedNewKeys = null;</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-    for (let msgHdr of fixIterator(aMsgHdrs, Ci.nsIMsgDBHdr)) {</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+    for (let msgHdr of aMsgHdrs) {</span>
<a href="#l7.34"></a><span id="l7.34">       // -- Index this folder?</span>
<a href="#l7.35"></a><span id="l7.35">       let msgFolder = msgHdr.folder;</span>
<a href="#l7.36"></a><span id="l7.36">       if (!this.shouldIndexFolder(msgFolder)) {</span>
<a href="#l7.37"></a><span id="l7.37">         continue;</span>
<a href="#l7.38"></a><span id="l7.38">       }</span>
<a href="#l7.39"></a><span id="l7.39">       // -- Ignore messages in filthy folders!</span>
<a href="#l7.40"></a><span id="l7.40">       // A filthy folder can only be processed by an indexing sweep, and at</span>
<a href="#l7.41"></a><span id="l7.41">       //  that point the message will get indexed.</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineat">@@ -2338,17 +2337,17 @@ var GlodaMsgIndexer = {</span>
<a href="#l7.43"></a><span id="l7.43">      *  including both moves that generated offline fake headers and those that</span>
<a href="#l7.44"></a><span id="l7.44">      *  did not.  In the offline fake header case, however, we are able to</span>
<a href="#l7.45"></a><span id="l7.45">      *  ignore their msgsClassified events because we will have received a</span>
<a href="#l7.46"></a><span id="l7.46">      *  msgKeyChanged notification sometime in the recent past.</span>
<a href="#l7.47"></a><span id="l7.47">      */</span>
<a href="#l7.48"></a><span id="l7.48">     msgsClassified(aMsgHdrs, aJunkClassified, aTraitClassified) {</span>
<a href="#l7.49"></a><span id="l7.49">       this.indexer._log.debug(&quot;msgsClassified notification&quot;);</span>
<a href="#l7.50"></a><span id="l7.50">       try {</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-        GlodaMsgIndexer._reindexChangedMessages(aMsgHdrs.enumerate(), false);</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+        GlodaMsgIndexer._reindexChangedMessages(aMsgHdrs, false);</span>
<a href="#l7.53"></a><span id="l7.53">       } catch (ex) {</span>
<a href="#l7.54"></a><span id="l7.54">         this.indexer._log.error(&quot;Explosion in msgsClassified handling:&quot;, ex);</span>
<a href="#l7.55"></a><span id="l7.55">       }</span>
<a href="#l7.56"></a><span id="l7.56">     },</span>
<a href="#l7.57"></a><span id="l7.57"> </span>
<a href="#l7.58"></a><span id="l7.58">     /**</span>
<a href="#l7.59"></a><span id="l7.59">      * Handle real, actual deletion (move to trash and IMAP deletion model</span>
<a href="#l7.60"></a><span id="l7.60">      *  don't count); we only see the deletion here when it becomes forever,</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineat">@@ -2469,17 +2468,19 @@ var GlodaMsgIndexer = {</span>
<a href="#l7.62"></a><span id="l7.62">                 if (glodaId) {</span>
<a href="#l7.63"></a><span id="l7.63">                   destMsgHdr.setUint32Property(GLODA_MESSAGE_ID_PROPERTY, 0);</span>
<a href="#l7.64"></a><span id="l7.64">                 }</span>
<a href="#l7.65"></a><span id="l7.65">               }</span>
<a href="#l7.66"></a><span id="l7.66"> </span>
<a href="#l7.67"></a><span id="l7.67">               // Since we are moving messages from a folder where they were</span>
<a href="#l7.68"></a><span id="l7.68">               //  effectively not indexed, it is up to us to make sure the</span>
<a href="#l7.69"></a><span id="l7.69">               //  messages now get indexed.</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineminus">-              this.indexer._reindexChangedMessages(aDestMsgHdrs.enumerate());</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+              this.indexer._reindexChangedMessages(</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+                fixIterator(aDestMsgHdrs, Ci.nsIMsgDBHdr)</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+              );</span>
<a href="#l7.74"></a><span id="l7.74">               return;</span>
<a href="#l7.75"></a><span id="l7.75">             }</span>
<a href="#l7.76"></a><span id="l7.76"> </span>
<a href="#l7.77"></a><span id="l7.77">             // IMAP move case, we need to operate on the pending headers using</span>
<a href="#l7.78"></a><span id="l7.78">             //  the source header to get the pending header and as the</span>
<a href="#l7.79"></a><span id="l7.79">             //  indication of what has been already set on the pending header.</span>
<a href="#l7.80"></a><span id="l7.80">             let destDb;</span>
<a href="#l7.81"></a><span id="l7.81">             // so, this can fail, and there's not much we can do about it.</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineat">@@ -2924,17 +2925,20 @@ var GlodaMsgIndexer = {</span>
<a href="#l7.83"></a><span id="l7.83">         //  indexing sweep queued or active, and if it's already active that</span>
<a href="#l7.84"></a><span id="l7.84">         //  this folder is in the queue to be processed.)</span>
<a href="#l7.85"></a><span id="l7.85">         if (glodaFolder.dirtyStatus == glodaFolder.kFolderDirty) {</span>
<a href="#l7.86"></a><span id="l7.86">           GlodaIndexer.indexJob(new IndexingJob(&quot;folder&quot;, glodaFolder.id));</span>
<a href="#l7.87"></a><span id="l7.87">         }</span>
<a href="#l7.88"></a><span id="l7.88">       } else if (aEvent == &quot;JunkStatusChanged&quot;) {</span>
<a href="#l7.89"></a><span id="l7.89">         this.indexer._log.debug(&quot;JunkStatusChanged notification&quot;);</span>
<a href="#l7.90"></a><span id="l7.90">         aItem.QueryInterface(Ci.nsIArray);</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineminus">-        GlodaMsgIndexer._reindexChangedMessages(aItem.enumerate(), true);</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+        GlodaMsgIndexer._reindexChangedMessages(</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+          fixIterator(aItem, Ci.nsIMsgDBHdr),</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+          true</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+        );</span>
<a href="#l7.96"></a><span id="l7.96">       }</span>
<a href="#l7.97"></a><span id="l7.97">     },</span>
<a href="#l7.98"></a><span id="l7.98">   },</span>
<a href="#l7.99"></a><span id="l7.99"> </span>
<a href="#l7.100"></a><span id="l7.100">   /**</span>
<a href="#l7.101"></a><span id="l7.101">    * A nsIFolderListener (listening on nsIMsgMailSession so we get all of</span>
<a href="#l7.102"></a><span id="l7.102">    *  these events) PRIMARILY to get folder loaded notifications.  Because of</span>
<a href="#l7.103"></a><span id="l7.103">    *  deficiencies in the nsIMsgFolderListener's events at this time, we also</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -3600,29 +3600,29 @@ nsImapMailFolder::ReplayOfflineMoveCopy(</span>
<a href="#l8.4"></a><span id="l8.4">                                         nsIUrlListener *aUrlListener,</span>
<a href="#l8.5"></a><span id="l8.5">                                         nsIMsgWindow *aWindow) {</span>
<a href="#l8.6"></a><span id="l8.6">   nsresult rv;</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8">   nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(aDstFolder);</span>
<a href="#l8.9"></a><span id="l8.9">   if (imapFolder) {</span>
<a href="#l8.10"></a><span id="l8.10">     nsImapMailFolder *destImapFolder =</span>
<a href="#l8.11"></a><span id="l8.11">         static_cast&lt;nsImapMailFolder *&gt;(aDstFolder);</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-    nsCOMPtr&lt;nsIMutableArray&gt; messages(do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l8.13"></a><span id="l8.13">     nsCOMPtr&lt;nsIMsgDatabase&gt; dstFolderDB;</span>
<a href="#l8.14"></a><span id="l8.14">     aDstFolder-&gt;GetMsgDatabase(getter_AddRefs(dstFolderDB));</span>
<a href="#l8.15"></a><span id="l8.15">     if (dstFolderDB) {</span>
<a href="#l8.16"></a><span id="l8.16">       // find the fake header in the destination db, and use that to</span>
<a href="#l8.17"></a><span id="l8.17">       // set the pending attributes on the real headers. To do this,</span>
<a href="#l8.18"></a><span id="l8.18">       // we need to iterate over the offline ops in the destination db,</span>
<a href="#l8.19"></a><span id="l8.19">       // looking for ones with matching keys and source folder uri.</span>
<a href="#l8.20"></a><span id="l8.20">       // If we find that offline op, its &quot;key&quot; will be the key of the fake</span>
<a href="#l8.21"></a><span id="l8.21">       // header, so we just need to get the header for that key</span>
<a href="#l8.22"></a><span id="l8.22">       // from the dest db.</span>
<a href="#l8.23"></a><span id="l8.23">       nsTArray&lt;nsMsgKey&gt; offlineOps;</span>
<a href="#l8.24"></a><span id="l8.24">       if (NS_SUCCEEDED(dstFolderDB-&gt;ListAllOfflineOpIds(&amp;offlineOps))) {</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+        nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; messages;</span>
<a href="#l8.26"></a><span id="l8.26">         nsCString srcFolderUri;</span>
<a href="#l8.27"></a><span id="l8.27">         GetURI(srcFolderUri);</span>
<a href="#l8.28"></a><span id="l8.28">         nsCOMPtr&lt;nsIMsgOfflineImapOperation&gt; currentOp;</span>
<a href="#l8.29"></a><span id="l8.29">         for (uint32_t opIndex = 0; opIndex &lt; offlineOps.Length(); opIndex++) {</span>
<a href="#l8.30"></a><span id="l8.30">           dstFolderDB-&gt;GetOfflineOpForKey(offlineOps[opIndex], false,</span>
<a href="#l8.31"></a><span id="l8.31">                                           getter_AddRefs(currentOp));</span>
<a href="#l8.32"></a><span id="l8.32">           if (currentOp) {</span>
<a href="#l8.33"></a><span id="l8.33">             nsCString opSrcUri;</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineat">@@ -3630,17 +3630,17 @@ nsImapMailFolder::ReplayOfflineMoveCopy(</span>
<a href="#l8.35"></a><span id="l8.35">             if (opSrcUri.Equals(srcFolderUri)) {</span>
<a href="#l8.36"></a><span id="l8.36">               nsMsgKey srcMessageKey;</span>
<a href="#l8.37"></a><span id="l8.37">               currentOp-&gt;GetSrcMessageKey(&amp;srcMessageKey);</span>
<a href="#l8.38"></a><span id="l8.38">               for (auto key : aMsgKeys) {</span>
<a href="#l8.39"></a><span id="l8.39">                 if (srcMessageKey == key) {</span>
<a href="#l8.40"></a><span id="l8.40">                   nsCOMPtr&lt;nsIMsgDBHdr&gt; fakeDestHdr;</span>
<a href="#l8.41"></a><span id="l8.41">                   dstFolderDB-&gt;GetMsgHdrForKey(offlineOps[opIndex],</span>
<a href="#l8.42"></a><span id="l8.42">                                                getter_AddRefs(fakeDestHdr));</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineminus">-                  if (fakeDestHdr) messages-&gt;AppendElement(fakeDestHdr);</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+                  if (fakeDestHdr) messages.AppendElement(fakeDestHdr);</span>
<a href="#l8.45"></a><span id="l8.45">                   break;</span>
<a href="#l8.46"></a><span id="l8.46">                 }</span>
<a href="#l8.47"></a><span id="l8.47">               }</span>
<a href="#l8.48"></a><span id="l8.48">             }</span>
<a href="#l8.49"></a><span id="l8.49">           }</span>
<a href="#l8.50"></a><span id="l8.50">         }</span>
<a href="#l8.51"></a><span id="l8.51">         // 3rd parameter: Set offline flag.</span>
<a href="#l8.52"></a><span id="l8.52">         destImapFolder-&gt;SetPendingAttributes(messages, isMove, true);</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineat">@@ -6833,18 +6833,19 @@ nsresult nsImapMailFolder::CopyMessagesO</span>
<a href="#l8.54"></a><span id="l8.54">   OnCopyCompleted(srcSupport, rv);</span>
<a href="#l8.55"></a><span id="l8.55"> </span>
<a href="#l8.56"></a><span id="l8.56">   if (isMove)</span>
<a href="#l8.57"></a><span id="l8.57">     srcFolder-&gt;NotifyFolderEvent(NS_SUCCEEDED(rv) ? kDeleteOrMoveMsgCompleted</span>
<a href="#l8.58"></a><span id="l8.58">                                                   : kDeleteOrMoveMsgFailed);</span>
<a href="#l8.59"></a><span id="l8.59">   return rv;</span>
<a href="#l8.60"></a><span id="l8.60"> }</span>
<a href="#l8.61"></a><span id="l8.61"> </span>
<a href="#l8.62"></a><span id="l8.62" class="difflineminus">-void nsImapMailFolder::SetPendingAttributes(nsIArray *messages, bool aIsMove,</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineminus">-                                            bool aSetOffline) {</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+void nsImapMailFolder::SetPendingAttributes(</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+    const nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; &amp;messages, bool aIsMove,</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+    bool aSetOffline) {</span>
<a href="#l8.67"></a><span id="l8.67">   GetDatabase();</span>
<a href="#l8.68"></a><span id="l8.68">   if (!mDatabase) return;</span>
<a href="#l8.69"></a><span id="l8.69"> </span>
<a href="#l8.70"></a><span id="l8.70">   uint32_t supportedUserFlags;</span>
<a href="#l8.71"></a><span id="l8.71">   GetSupportedUserFlags(&amp;supportedUserFlags);</span>
<a href="#l8.72"></a><span id="l8.72"> </span>
<a href="#l8.73"></a><span id="l8.73">   nsresult rv;</span>
<a href="#l8.74"></a><span id="l8.74">   nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineat">@@ -6872,93 +6873,83 @@ void nsImapMailFolder::SetPendingAttribu</span>
<a href="#l8.76"></a><span id="l8.76">   // in the iteration through the properties</span>
<a href="#l8.77"></a><span id="l8.77">   dontPreserveEx.AppendLiteral(</span>
<a href="#l8.78"></a><span id="l8.78">       &quot;offlineMsgSize msgOffset flags priority pseudoHdr &quot;);</span>
<a href="#l8.79"></a><span id="l8.79"> </span>
<a href="#l8.80"></a><span id="l8.80">   // these fields are either copied separately when the server does not support</span>
<a href="#l8.81"></a><span id="l8.81">   // custom IMAP flags, or managed directly through the flags</span>
<a href="#l8.82"></a><span id="l8.82">   dontPreserveEx.AppendLiteral(&quot;keywords label &quot;);</span>
<a href="#l8.83"></a><span id="l8.83"> </span>
<a href="#l8.84"></a><span id="l8.84" class="difflineminus">-  uint32_t i, count;</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineminus">-</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineminus">-  rv = messages-&gt;GetLength(&amp;count);</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineminus">-  NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineminus">-</span>
<a href="#l8.89"></a><span id="l8.89">   // check if any msg hdr has special flags or properties set</span>
<a href="#l8.90"></a><span id="l8.90">   // that we need to set on the dest hdr</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineminus">-  for (i = 0; i &lt; count; i++) {</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineminus">-    nsCOMPtr&lt;nsIMsgDBHdr&gt; msgDBHdr = do_QueryElementAt(messages, i, &amp;rv);</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineminus">-    if (mDatabase &amp;&amp; msgDBHdr) {</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineminus">-      if (!(supportedUserFlags &amp; kImapMsgSupportUserFlag)) {</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineminus">-        nsMsgLabelValue label;</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineminus">-        msgDBHdr-&gt;GetLabel(&amp;label);</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineminus">-        if (label != 0) {</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineminus">-          nsAutoCString labelStr;</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineminus">-          labelStr.AppendInt(label);</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineminus">-          mDatabase-&gt;SetAttributeOnPendingHdr(msgDBHdr, &quot;label&quot;,</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineminus">-                                              labelStr.get());</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineminus">-        }</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineminus">-        nsCString keywords;</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineminus">-        msgDBHdr-&gt;GetStringProperty(&quot;keywords&quot;, getter_Copies(keywords));</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineminus">-        if (!keywords.IsEmpty())</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineminus">-          mDatabase-&gt;SetAttributeOnPendingHdr(msgDBHdr, &quot;keywords&quot;,</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineminus">-                                              keywords.get());</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineplus">+  for (auto msgDBHdr : messages) {</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineplus">+    if (!(supportedUserFlags &amp; kImapMsgSupportUserFlag)) {</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineplus">+      nsMsgLabelValue label;</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+      msgDBHdr-&gt;GetLabel(&amp;label);</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineplus">+      if (label != 0) {</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineplus">+        nsAutoCString labelStr;</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineplus">+        labelStr.AppendInt(label);</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineplus">+        mDatabase-&gt;SetAttributeOnPendingHdr(msgDBHdr, &quot;label&quot;, labelStr.get());</span>
<a href="#l8.116"></a><span id="l8.116">       }</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineminus">-</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineminus">-      // do this even if the server supports user-defined flags.</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineminus">-      nsCOMPtr&lt;nsIUTF8StringEnumerator&gt; propertyEnumerator;</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineminus">-      nsresult rv =</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineminus">-          msgDBHdr-&gt;GetPropertyEnumerator(getter_AddRefs(propertyEnumerator));</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineminus">-      NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineminus">-</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineminus">-      nsAutoCString property;</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineplus">+      nsCString keywords;</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineplus">+      msgDBHdr-&gt;GetStringProperty(&quot;keywords&quot;, getter_Copies(keywords));</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineplus">+      if (!keywords.IsEmpty())</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineplus">+        mDatabase-&gt;SetAttributeOnPendingHdr(msgDBHdr, &quot;keywords&quot;,</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineplus">+                                            keywords.get());</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineplus">+    }</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineplus">+    // do this even if the server supports user-defined flags.</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineplus">+    nsCOMPtr&lt;nsIUTF8StringEnumerator&gt; propertyEnumerator;</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineplus">+    nsresult rv =</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineplus">+        msgDBHdr-&gt;GetPropertyEnumerator(getter_AddRefs(propertyEnumerator));</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineplus">+    NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineplus">+</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineplus">+    nsAutoCString property;</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineplus">+    nsCString sourceString;</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineplus">+    bool hasMore;</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineplus">+    while (NS_SUCCEEDED(propertyEnumerator-&gt;HasMore(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineplus">+      propertyEnumerator-&gt;GetNext(property);</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineplus">+      nsAutoCString propertyEx(NS_LITERAL_CSTRING(&quot; &quot;));</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineplus">+      propertyEx.Append(property);</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineplus">+      propertyEx.Append(' ');</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineplus">+      if (dontPreserveEx.Find(propertyEx) != kNotFound) continue;</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineplus">+</span>
<a href="#l8.148"></a><span id="l8.148">       nsCString sourceString;</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineminus">-      bool hasMore;</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineminus">-      while (NS_SUCCEEDED(propertyEnumerator-&gt;HasMore(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineminus">-        propertyEnumerator-&gt;GetNext(property);</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineminus">-        nsAutoCString propertyEx(NS_LITERAL_CSTRING(&quot; &quot;));</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineminus">-        propertyEx.Append(property);</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineminus">-        propertyEx.Append(' ');</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineminus">-        if (dontPreserveEx.Find(propertyEx) != kNotFound) continue;</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineminus">-</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineminus">-        nsCString sourceString;</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineminus">-        msgDBHdr-&gt;GetStringProperty(property.get(),</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineminus">-                                    getter_Copies(sourceString));</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineminus">-        mDatabase-&gt;SetAttributeOnPendingHdr(msgDBHdr, property.get(),</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineminus">-                                            sourceString.get());</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineminus">-      }</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineminus">-</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineminus">-      uint32_t messageSize;</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineminus">-      uint64_t messageOffset;</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineminus">-      nsCString storeToken;</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineminus">-      msgDBHdr-&gt;GetMessageOffset(&amp;messageOffset);</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineminus">-      msgDBHdr-&gt;GetOfflineMessageSize(&amp;messageSize);</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineminus">-      msgDBHdr-&gt;GetStringProperty(&quot;storeToken&quot;, getter_Copies(storeToken));</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineminus">-      if (messageSize) {</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineminus">-        mDatabase-&gt;SetUint32AttributeOnPendingHdr(msgDBHdr, &quot;offlineMsgSize&quot;,</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineminus">-                                                  messageSize);</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineminus">-        mDatabase-&gt;SetUint64AttributeOnPendingHdr(msgDBHdr, &quot;msgOffset&quot;,</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineminus">-                                                  messageOffset);</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineminus">-        // Not always setting &quot;flags&quot; attribute to nsMsgMessageFlags::Offline</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineminus">-        // here because it can cause missing parts (inline or attachments)</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineminus">-        // when messages are moved or copied manually or by filter action.</span>
<a href="#l8.178"></a><span id="l8.178" class="difflineminus">-        if (aSetOffline)</span>
<a href="#l8.179"></a><span id="l8.179" class="difflineminus">-          mDatabase-&gt;SetUint32AttributeOnPendingHdr(msgDBHdr, &quot;flags&quot;,</span>
<a href="#l8.180"></a><span id="l8.180" class="difflineminus">-                                                    nsMsgMessageFlags::Offline);</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineminus">-        mDatabase-&gt;SetAttributeOnPendingHdr(msgDBHdr, &quot;storeToken&quot;,</span>
<a href="#l8.182"></a><span id="l8.182" class="difflineminus">-                                            storeToken.get());</span>
<a href="#l8.183"></a><span id="l8.183" class="difflineminus">-      }</span>
<a href="#l8.184"></a><span id="l8.184" class="difflineminus">-      nsMsgPriorityValue priority;</span>
<a href="#l8.185"></a><span id="l8.185" class="difflineminus">-      msgDBHdr-&gt;GetPriority(&amp;priority);</span>
<a href="#l8.186"></a><span id="l8.186" class="difflineminus">-      if (priority != 0) {</span>
<a href="#l8.187"></a><span id="l8.187" class="difflineminus">-        nsAutoCString priorityStr;</span>
<a href="#l8.188"></a><span id="l8.188" class="difflineminus">-        priorityStr.AppendInt(priority);</span>
<a href="#l8.189"></a><span id="l8.189" class="difflineminus">-        mDatabase-&gt;SetAttributeOnPendingHdr(msgDBHdr, &quot;priority&quot;,</span>
<a href="#l8.190"></a><span id="l8.190" class="difflineminus">-                                            priorityStr.get());</span>
<a href="#l8.191"></a><span id="l8.191" class="difflineminus">-      }</span>
<a href="#l8.192"></a><span id="l8.192" class="difflineplus">+      msgDBHdr-&gt;GetStringProperty(property.get(), getter_Copies(sourceString));</span>
<a href="#l8.193"></a><span id="l8.193" class="difflineplus">+      mDatabase-&gt;SetAttributeOnPendingHdr(msgDBHdr, property.get(),</span>
<a href="#l8.194"></a><span id="l8.194" class="difflineplus">+                                          sourceString.get());</span>
<a href="#l8.195"></a><span id="l8.195" class="difflineplus">+    }</span>
<a href="#l8.196"></a><span id="l8.196" class="difflineplus">+</span>
<a href="#l8.197"></a><span id="l8.197" class="difflineplus">+    uint32_t messageSize;</span>
<a href="#l8.198"></a><span id="l8.198" class="difflineplus">+    uint64_t messageOffset;</span>
<a href="#l8.199"></a><span id="l8.199" class="difflineplus">+    nsCString storeToken;</span>
<a href="#l8.200"></a><span id="l8.200" class="difflineplus">+    msgDBHdr-&gt;GetMessageOffset(&amp;messageOffset);</span>
<a href="#l8.201"></a><span id="l8.201" class="difflineplus">+    msgDBHdr-&gt;GetOfflineMessageSize(&amp;messageSize);</span>
<a href="#l8.202"></a><span id="l8.202" class="difflineplus">+    msgDBHdr-&gt;GetStringProperty(&quot;storeToken&quot;, getter_Copies(storeToken));</span>
<a href="#l8.203"></a><span id="l8.203" class="difflineplus">+    if (messageSize) {</span>
<a href="#l8.204"></a><span id="l8.204" class="difflineplus">+      mDatabase-&gt;SetUint32AttributeOnPendingHdr(msgDBHdr, &quot;offlineMsgSize&quot;,</span>
<a href="#l8.205"></a><span id="l8.205" class="difflineplus">+                                                messageSize);</span>
<a href="#l8.206"></a><span id="l8.206" class="difflineplus">+      mDatabase-&gt;SetUint64AttributeOnPendingHdr(msgDBHdr, &quot;msgOffset&quot;,</span>
<a href="#l8.207"></a><span id="l8.207" class="difflineplus">+                                                messageOffset);</span>
<a href="#l8.208"></a><span id="l8.208" class="difflineplus">+      // Not always setting &quot;flags&quot; attribute to nsMsgMessageFlags::Offline</span>
<a href="#l8.209"></a><span id="l8.209" class="difflineplus">+      // here because it can cause missing parts (inline or attachments)</span>
<a href="#l8.210"></a><span id="l8.210" class="difflineplus">+      // when messages are moved or copied manually or by filter action.</span>
<a href="#l8.211"></a><span id="l8.211" class="difflineplus">+      if (aSetOffline)</span>
<a href="#l8.212"></a><span id="l8.212" class="difflineplus">+        mDatabase-&gt;SetUint32AttributeOnPendingHdr(msgDBHdr, &quot;flags&quot;,</span>
<a href="#l8.213"></a><span id="l8.213" class="difflineplus">+                                                  nsMsgMessageFlags::Offline);</span>
<a href="#l8.214"></a><span id="l8.214" class="difflineplus">+      mDatabase-&gt;SetAttributeOnPendingHdr(msgDBHdr, &quot;storeToken&quot;,</span>
<a href="#l8.215"></a><span id="l8.215" class="difflineplus">+                                          storeToken.get());</span>
<a href="#l8.216"></a><span id="l8.216" class="difflineplus">+    }</span>
<a href="#l8.217"></a><span id="l8.217" class="difflineplus">+    nsMsgPriorityValue priority;</span>
<a href="#l8.218"></a><span id="l8.218" class="difflineplus">+    msgDBHdr-&gt;GetPriority(&amp;priority);</span>
<a href="#l8.219"></a><span id="l8.219" class="difflineplus">+    if (priority != 0) {</span>
<a href="#l8.220"></a><span id="l8.220" class="difflineplus">+      nsAutoCString priorityStr;</span>
<a href="#l8.221"></a><span id="l8.221" class="difflineplus">+      priorityStr.AppendInt(priority);</span>
<a href="#l8.222"></a><span id="l8.222" class="difflineplus">+      mDatabase-&gt;SetAttributeOnPendingHdr(msgDBHdr, &quot;priority&quot;,</span>
<a href="#l8.223"></a><span id="l8.223" class="difflineplus">+                                          priorityStr.get());</span>
<a href="#l8.224"></a><span id="l8.224">     }</span>
<a href="#l8.225"></a><span id="l8.225">   }</span>
<a href="#l8.226"></a><span id="l8.226"> }</span>
<a href="#l8.227"></a><span id="l8.227"> </span>
<a href="#l8.228"></a><span id="l8.228"> NS_IMETHODIMP</span>
<a href="#l8.229"></a><span id="l8.229"> nsImapMailFolder::CopyMessages(</span>
<a href="#l8.230"></a><span id="l8.230">     nsIMsgFolder *srcFolder, nsIArray *messages, bool isMove,</span>
<a href="#l8.231"></a><span id="l8.231">     nsIMsgWindow *msgWindow, nsIMsgCopyServiceListener *listener,</span>
<a href="#l8.232"></a><span id="l8.232" class="difflineat">@@ -7044,26 +7035,37 @@ nsImapMailFolder::CopyMessages(</span>
<a href="#l8.233"></a><span id="l8.233">     }</span>
<a href="#l8.234"></a><span id="l8.234">     keyArray.Sort();</span>
<a href="#l8.235"></a><span id="l8.235"> </span>
<a href="#l8.236"></a><span id="l8.236">     nsCOMPtr&lt;nsIMutableArray&gt; sortedMsgs(</span>
<a href="#l8.237"></a><span id="l8.237">         do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l8.238"></a><span id="l8.238">     rv = MessagesInKeyOrder(keyArray, srcFolder, sortedMsgs);</span>
<a href="#l8.239"></a><span id="l8.239">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.240"></a><span id="l8.240"> </span>
<a href="#l8.241"></a><span id="l8.241" class="difflineplus">+    // Stopgap. Build a parallel nsTArray while the nsIArray-removal</span>
<a href="#l8.242"></a><span id="l8.242" class="difflineplus">+    // is completed (see Bug 1612239).</span>
<a href="#l8.243"></a><span id="l8.243" class="difflineplus">+    sortedMsgs-&gt;GetLength(&amp;numMsgs);</span>
<a href="#l8.244"></a><span id="l8.244" class="difflineplus">+    nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; sortedHdrs;</span>
<a href="#l8.245"></a><span id="l8.245" class="difflineplus">+    sortedHdrs.SetCapacity(numMsgs);</span>
<a href="#l8.246"></a><span id="l8.246" class="difflineplus">+    for (uint32_t i = 0; i &lt; numMsgs; i++) {</span>
<a href="#l8.247"></a><span id="l8.247" class="difflineplus">+      nsCOMPtr&lt;nsIMsgDBHdr&gt; hdr = do_QueryElementAt(sortedMsgs, i, &amp;rv);</span>
<a href="#l8.248"></a><span id="l8.248" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.249"></a><span id="l8.249" class="difflineplus">+      sortedHdrs.AppendElement(hdr);</span>
<a href="#l8.250"></a><span id="l8.250" class="difflineplus">+    }</span>
<a href="#l8.251"></a><span id="l8.251" class="difflineplus">+</span>
<a href="#l8.252"></a><span id="l8.252">     if (WeAreOffline())</span>
<a href="#l8.253"></a><span id="l8.253">       return CopyMessagesOffline(srcFolder, sortedMsgs, isMove, msgWindow,</span>
<a href="#l8.254"></a><span id="l8.254">                                  listener);</span>
<a href="#l8.255"></a><span id="l8.255"> </span>
<a href="#l8.256"></a><span id="l8.256">     nsCOMPtr&lt;nsIImapService&gt; imapService =</span>
<a href="#l8.257"></a><span id="l8.257">         do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l8.258"></a><span id="l8.258">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.259"></a><span id="l8.259"> </span>
<a href="#l8.260"></a><span id="l8.260">     // 3rd parameter: Do not set offline flag.</span>
<a href="#l8.261"></a><span id="l8.261" class="difflineminus">-    SetPendingAttributes(sortedMsgs, isMove, false);</span>
<a href="#l8.262"></a><span id="l8.262" class="difflineplus">+    SetPendingAttributes(sortedHdrs, isMove, false);</span>
<a href="#l8.263"></a><span id="l8.263"> </span>
<a href="#l8.264"></a><span id="l8.264">     // if the folders aren't on the same server, do a stream base copy</span>
<a href="#l8.265"></a><span id="l8.265">     if (!sameServer) {</span>
<a href="#l8.266"></a><span id="l8.266">       rv = CopyMessagesWithStream(srcFolder, sortedMsgs, isMove, true,</span>
<a href="#l8.267"></a><span id="l8.267">                                   msgWindow, listener, allowUndo);</span>
<a href="#l8.268"></a><span id="l8.268">       goto done;</span>
<a href="#l8.269"></a><span id="l8.269">     }</span>
<a href="#l8.270"></a><span id="l8.270"> </span>
<a href="#l8.271"></a><span id="l8.271" class="difflineat">@@ -7455,17 +7457,17 @@ nsImapMailFolder::CopyFileMessage(nsIFil</span>
<a href="#l8.272"></a><span id="l8.272">       messageId.AppendInt((int32_t)key);</span>
<a href="#l8.273"></a><span id="l8.273">       // Perhaps we have the message offline, but even if we do it is</span>
<a href="#l8.274"></a><span id="l8.274">       // not valid, since the only time we do a file copy for an</span>
<a href="#l8.275"></a><span id="l8.275">       // existing message is when we are changing the message.</span>
<a href="#l8.276"></a><span id="l8.276">       // So set the offline size to 0 to force SetPendingAttributes to</span>
<a href="#l8.277"></a><span id="l8.277">       // clear the offline message flag.</span>
<a href="#l8.278"></a><span id="l8.278">       msgToReplace-&gt;SetOfflineMessageSize(0);</span>
<a href="#l8.279"></a><span id="l8.279">       messages-&gt;AppendElement(msgToReplace);</span>
<a href="#l8.280"></a><span id="l8.280" class="difflineminus">-      SetPendingAttributes(messages, false, false);</span>
<a href="#l8.281"></a><span id="l8.281" class="difflineplus">+      SetPendingAttributes({msgToReplace}, false, false);</span>
<a href="#l8.282"></a><span id="l8.282">     }</span>
<a href="#l8.283"></a><span id="l8.283">   }</span>
<a href="#l8.284"></a><span id="l8.284"> </span>
<a href="#l8.285"></a><span id="l8.285">   bool isMove = (msgToReplace ? true : false);</span>
<a href="#l8.286"></a><span id="l8.286">   rv = InitCopyState(srcSupport, messages, isMove, isDraftOrTemplate, false,</span>
<a href="#l8.287"></a><span id="l8.287">                      aNewMsgFlags, aNewMsgKeywords, listener, msgWindow, false);</span>
<a href="#l8.288"></a><span id="l8.288">   if (NS_FAILED(rv)) return OnCopyCompleted(srcSupport, rv);</span>
<a href="#l8.289"></a><span id="l8.289"> </span>
<a href="#l8.290"></a><span id="l8.290" class="difflineat">@@ -7759,28 +7761,23 @@ nsresult nsImapMailFolder::CopyFileToOff</span>
<a href="#l8.291"></a><span id="l8.291">     //   maildir it copies from tmp to cur and may change the storeToken</span>
<a href="#l8.292"></a><span id="l8.292">     //   to get a unique filename.</span>
<a href="#l8.293"></a><span id="l8.293">     if (offlineStore) {</span>
<a href="#l8.294"></a><span id="l8.294">       nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l8.295"></a><span id="l8.295">       GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l8.296"></a><span id="l8.296">       if (msgStore) msgStore-&gt;FinishNewMessage(offlineStore, fakeHdr);</span>
<a href="#l8.297"></a><span id="l8.297">     }</span>
<a href="#l8.298"></a><span id="l8.298"> </span>
<a href="#l8.299"></a><span id="l8.299" class="difflineminus">-    nsCOMPtr&lt;nsIMutableArray&gt; messages(</span>
<a href="#l8.300"></a><span id="l8.300" class="difflineminus">-        do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l8.301"></a><span id="l8.301" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.302"></a><span id="l8.302" class="difflineminus">-    messages-&gt;AppendElement(fakeHdr);</span>
<a href="#l8.303"></a><span id="l8.303" class="difflineminus">-</span>
<a href="#l8.304"></a><span id="l8.304">     // We are copying from a file to offline store so set offline flag.</span>
<a href="#l8.305"></a><span id="l8.305" class="difflineminus">-    SetPendingAttributes(messages, false, true);</span>
<a href="#l8.306"></a><span id="l8.306" class="difflineplus">+    SetPendingAttributes({&amp;*fakeHdr}, false, true);</span>
<a href="#l8.307"></a><span id="l8.307"> </span>
<a href="#l8.308"></a><span id="l8.308">     // Gloda needs this notification to index the fake message.</span>
<a href="#l8.309"></a><span id="l8.309">     nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(</span>
<a href="#l8.310"></a><span id="l8.310">         do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l8.311"></a><span id="l8.311" class="difflineminus">-    if (notifier) notifier-&gt;NotifyMsgsClassified(messages, false, false);</span>
<a href="#l8.312"></a><span id="l8.312" class="difflineplus">+    if (notifier) notifier-&gt;NotifyMsgsClassified({&amp;*fakeHdr}, false, false);</span>
<a href="#l8.313"></a><span id="l8.313">     inputStream-&gt;Close();</span>
<a href="#l8.314"></a><span id="l8.314">     inputStream = nullptr;</span>
<a href="#l8.315"></a><span id="l8.315">   }</span>
<a href="#l8.316"></a><span id="l8.316">   if (offlineStore) offlineStore-&gt;Close();</span>
<a href="#l8.317"></a><span id="l8.317">   return rv;</span>
<a href="#l8.318"></a><span id="l8.318"> }</span>
<a href="#l8.319"></a><span id="l8.319"> </span>
<a href="#l8.320"></a><span id="l8.320"> nsresult nsImapMailFolder::OnCopyCompleted(nsISupports *srcSupport,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.h</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.h</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -476,17 +476,18 @@ class nsImapMailFolder : public nsMsgDBF</span>
<a href="#l9.4"></a><span id="l9.4">                                 nsIMsgOfflineImapOperation **originalOp,</span>
<a href="#l9.5"></a><span id="l9.5">                                 nsIMsgDatabase **originalDB);</span>
<a href="#l9.6"></a><span id="l9.6">   nsresult GetOriginalOp(nsIMsgOfflineImapOperation *op,</span>
<a href="#l9.7"></a><span id="l9.7">                          nsIMsgOfflineImapOperation **originalOp,</span>
<a href="#l9.8"></a><span id="l9.8">                          nsIMsgDatabase **originalDB);</span>
<a href="#l9.9"></a><span id="l9.9">   MOZ_CAN_RUN_SCRIPT_BOUNDARY nsresult CopyMessagesOffline(</span>
<a href="#l9.10"></a><span id="l9.10">       nsIMsgFolder *srcFolder, nsIArray *messages, bool isMove,</span>
<a href="#l9.11"></a><span id="l9.11">       nsIMsgWindow *msgWindow, nsIMsgCopyServiceListener *listener);</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-  void SetPendingAttributes(nsIArray *messages, bool aIsMove, bool aSetOffline);</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+  void SetPendingAttributes(const nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; &amp;messages,</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+                            bool aIsMove, bool aSetOffline);</span>
<a href="#l9.15"></a><span id="l9.15"> </span>
<a href="#l9.16"></a><span id="l9.16">   nsresult CopyOfflineMsgBody(nsIMsgFolder *srcFolder, nsIMsgDBHdr *destHdr,</span>
<a href="#l9.17"></a><span id="l9.17">                               nsIMsgDBHdr *origHdr, nsIInputStream *inputStream,</span>
<a href="#l9.18"></a><span id="l9.18">                               nsIOutputStream *outputStream);</span>
<a href="#l9.19"></a><span id="l9.19"> </span>
<a href="#l9.20"></a><span id="l9.20">   void GetTrashFolderName(nsAString &amp;aFolderName);</span>
<a href="#l9.21"></a><span id="l9.21">   bool ShowPreviewText();</span>
<a href="#l9.22"></a><span id="l9.22"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -8,16 +8,27 @@</span>
<a href="#l10.4"></a><span id="l10.4"> </span>
<a href="#l10.5"></a><span id="l10.5"> /*</span>
<a href="#l10.6"></a><span id="l10.6">  * Test suite for nsIMsgFolderListener events due to IMAP operations</span>
<a href="#l10.7"></a><span id="l10.7">  *</span>
<a href="#l10.8"></a><span id="l10.8">  * Currently tested</span>
<a href="#l10.9"></a><span id="l10.9">  * - Adding new folders</span>
<a href="#l10.10"></a><span id="l10.10">  * - Copying messages from files to mailboxes</span>
<a href="#l10.11"></a><span id="l10.11">  * - Adding new messages directly to mailboxes</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+ *</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+ * NOTE (See Bug 1632022):</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+ * Running this test by itself...</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+ *</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+ * $ ./mach xpcshell-test comm/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+ * ...will fail.</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+ *</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+ * This is because all the IMAP tests run twice - once with mbox storage and</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+ * once with maildir storage. For this test, the two parallel instances</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+ * interact badly.</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+ *</span>
<a href="#l10.23"></a><span id="l10.23">  */</span>
<a href="#l10.24"></a><span id="l10.24"> </span>
<a href="#l10.25"></a><span id="l10.25"> /* import-globals-from ../../../test/resources/msgFolderListenerSetup.js */</span>
<a href="#l10.26"></a><span id="l10.26"> load(&quot;../../../resources/msgFolderListenerSetup.js&quot;);</span>
<a href="#l10.27"></a><span id="l10.27"> </span>
<a href="#l10.28"></a><span id="l10.28"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l10.29"></a><span id="l10.29">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l10.30"></a><span id="l10.30"> );</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineat">@@ -308,20 +319,21 @@ function run_test() {</span>
<a href="#l10.32"></a><span id="l10.32"> </span>
<a href="#l10.33"></a><span id="l10.33">   // &quot;Master&quot; do_test_pending(), paired with a do_test_finished() at the end of</span>
<a href="#l10.34"></a><span id="l10.34">   // all the operations.</span>
<a href="#l10.35"></a><span id="l10.35">   do_test_pending();</span>
<a href="#l10.36"></a><span id="l10.36"> }</span>
<a href="#l10.37"></a><span id="l10.37"> </span>
<a href="#l10.38"></a><span id="l10.38"> function doTest(test) {</span>
<a href="#l10.39"></a><span id="l10.39">   // eslint-disable-line no-unused-vars</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineminus">-  dump(&quot;Doing test &quot; + test + &quot;\n&quot;);</span>
<a href="#l10.41"></a><span id="l10.41">   if (test &lt;= gTestArray.length) {</span>
<a href="#l10.42"></a><span id="l10.42">     let testFn = gTestArray[test - 1];</span>
<a href="#l10.43"></a><span id="l10.43"> </span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+    dump(`Doing test ${test} (${testFn.name})\n`);</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+</span>
<a href="#l10.46"></a><span id="l10.46">     // Set a limit of ten seconds; if the notifications haven't arrived by then there's a problem.</span>
<a href="#l10.47"></a><span id="l10.47">     do_timeout(10000, function() {</span>
<a href="#l10.48"></a><span id="l10.48">       if (gTest == test) {</span>
<a href="#l10.49"></a><span id="l10.49">         do_throw(</span>
<a href="#l10.50"></a><span id="l10.50">           &quot;Notifications not received in 10000 ms for operation &quot; +</span>
<a href="#l10.51"></a><span id="l10.51">             testFn.name +</span>
<a href="#l10.52"></a><span id="l10.52">             &quot;, current status is &quot; +</span>
<a href="#l10.53"></a><span id="l10.53">             gCurrStatus</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -2347,20 +2347,17 @@ nsMsgLocalMailFolder::EndCopy(bool aCopy</span>
<a href="#l11.4"></a><span id="l11.4">     // notifications in that case.</span>
<a href="#l11.5"></a><span id="l11.5">     if (!numHdrs &amp;&amp; newHdr) {</span>
<a href="#l11.6"></a><span id="l11.6">       nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(</span>
<a href="#l11.7"></a><span id="l11.7">           do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l11.8"></a><span id="l11.8">       if (notifier) {</span>
<a href="#l11.9"></a><span id="l11.9">         notifier-&gt;NotifyMsgAdded(newHdr);</span>
<a href="#l11.10"></a><span id="l11.10">         // We do not appear to trigger classification in this case, so let's</span>
<a href="#l11.11"></a><span id="l11.11">         // paper over the abyss by just sending the classification notification.</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-        nsCOMPtr&lt;nsIMutableArray&gt; oneHeaderArray =</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-            do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-        oneHeaderArray-&gt;AppendElement(newHdr);</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-        notifier-&gt;NotifyMsgsClassified(oneHeaderArray, false, false);</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+        notifier-&gt;NotifyMsgsClassified({&amp;*newHdr}, false, false);</span>
<a href="#l11.17"></a><span id="l11.17">         // (We do not add the NotReportedClassified processing flag since we</span>
<a href="#l11.18"></a><span id="l11.18">         // just reported it!)</span>
<a href="#l11.19"></a><span id="l11.19">       }</span>
<a href="#l11.20"></a><span id="l11.20">     }</span>
<a href="#l11.21"></a><span id="l11.21">   }</span>
<a href="#l11.22"></a><span id="l11.22">   return rv;</span>
<a href="#l11.23"></a><span id="l11.23"> }</span>
<a href="#l11.24"></a><span id="l11.24"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/local/src/nsRssIncomingServer.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/local/src/nsRssIncomingServer.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -153,19 +153,19 @@ NS_IMETHODIMP nsRssIncomingServer::GetCa</span>
<a href="#l12.4"></a><span id="l12.4">   *canSearchMessages = true;</span>
<a href="#l12.5"></a><span id="l12.5">   return NS_OK;</span>
<a href="#l12.6"></a><span id="l12.6"> }</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8"> NS_IMETHODIMP nsRssIncomingServer::MsgAdded(nsIMsgDBHdr *aMsg) {</span>
<a href="#l12.9"></a><span id="l12.9">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l12.10"></a><span id="l12.10"> }</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-NS_IMETHODIMP nsRssIncomingServer::MsgsClassified(nsIArray *aMsgs,</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-                                                  bool aJunkProcessed,</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-                                                  bool aTraitProcessed) {</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+NS_IMETHODIMP nsRssIncomingServer::MsgsClassified(</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+    const nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; &amp;aMsgs, bool aJunkProcessed,</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+    bool aTraitProcessed) {</span>
<a href="#l12.18"></a><span id="l12.18">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l12.19"></a><span id="l12.19"> }</span>
<a href="#l12.20"></a><span id="l12.20"> </span>
<a href="#l12.21"></a><span id="l12.21"> NS_IMETHODIMP nsRssIncomingServer::MsgsDeleted(</span>
<a href="#l12.22"></a><span id="l12.22">     const nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; &amp;aMsgs) {</span>
<a href="#l12.23"></a><span id="l12.23">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l12.24"></a><span id="l12.24"> }</span>
<a href="#l12.25"></a><span id="l12.25"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/test/resources/folderEventLogHelper.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/test/resources/folderEventLogHelper.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -51,26 +51,24 @@ function registerFolderEventLogHelper() </span>
<a href="#l13.4"></a><span id="l13.4">  * @implements {nsIMsgFolderListener}</span>
<a href="#l13.5"></a><span id="l13.5">  */</span>
<a href="#l13.6"></a><span id="l13.6"> var _folderEventLogHelper_msgFolderListener = {</span>
<a href="#l13.7"></a><span id="l13.7">   msgAdded(aMsg) {</span>
<a href="#l13.8"></a><span id="l13.8">     mark_action(&quot;msgEvent&quot;, &quot;msgAdded&quot;, [aMsg]);</span>
<a href="#l13.9"></a><span id="l13.9">   },</span>
<a href="#l13.10"></a><span id="l13.10"> </span>
<a href="#l13.11"></a><span id="l13.11">   /**</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-   * @param {nsIArray} aMsgs</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+   * @param {Array&lt;nsIMsgDBHdr&gt;} aMsgs</span>
<a href="#l13.14"></a><span id="l13.14">    */</span>
<a href="#l13.15"></a><span id="l13.15">   msgsClassified(aMsgs, aJunkProcessed, aTraitProcessed) {</span>
<a href="#l13.16"></a><span id="l13.16">     let args = [</span>
<a href="#l13.17"></a><span id="l13.17">       aJunkProcessed ? &quot;junk processed&quot; : &quot;did not junk process&quot;,</span>
<a href="#l13.18"></a><span id="l13.18">       aTraitProcessed ? &quot;trait processed&quot; : &quot;did not trait process&quot;,</span>
<a href="#l13.19"></a><span id="l13.19">     ];</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineminus">-    for (let msgHdr of fixIterator(aMsgs, Ci.nsIMsgDBHdr)) {</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineminus">-      args.push(msgHdr);</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineminus">-    }</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+    args.push(...aMsgs);</span>
<a href="#l13.24"></a><span id="l13.24">     mark_action(&quot;msgEvent&quot;, &quot;msgsClassified&quot;, args);</span>
<a href="#l13.25"></a><span id="l13.25">   },</span>
<a href="#l13.26"></a><span id="l13.26"> </span>
<a href="#l13.27"></a><span id="l13.27">   /**</span>
<a href="#l13.28"></a><span id="l13.28">    * @param {Array&lt;nsIMsgDBHdr&gt;} aMsgs</span>
<a href="#l13.29"></a><span id="l13.29">    */</span>
<a href="#l13.30"></a><span id="l13.30">   msgsDeleted(aMsgs) {</span>
<a href="#l13.31"></a><span id="l13.31">     mark_action(&quot;msgEvent&quot;, &quot;msgsDeleted&quot;, aMsgs);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/test/resources/msgFolderListenerSetup.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/test/resources/msgFolderListenerSetup.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -62,21 +62,17 @@ var gMFListener = {</span>
<a href="#l14.4"></a><span id="l14.4">       //  the messages have been added, which would be when the next expected</span>
<a href="#l14.5"></a><span id="l14.5">       //  event is msgsClassified.  (The limitation is that if we don't do this,</span>
<a href="#l14.6"></a><span id="l14.6">       //  we can end up getting told about this message again later.)</span>
<a href="#l14.7"></a><span id="l14.7">       aMsg.folder.clearNewMessages();</span>
<a href="#l14.8"></a><span id="l14.8">     }</span>
<a href="#l14.9"></a><span id="l14.9">   },</span>
<a href="#l14.10"></a><span id="l14.10"> </span>
<a href="#l14.11"></a><span id="l14.11">   msgsClassified(aMsgs, aJunkProcessed, aTraitProcessed) {</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-    dump(</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-      &quot;classified id: &quot; +</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">-        aMsgs.queryElementAt(0, Ci.nsIMsgDBHdr).messageId +</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineminus">-        &quot;\n&quot;</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineminus">-    );</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+    dump(&quot;classified id: &quot; + aMsgs[0].messageId + &quot;\n&quot;);</span>
<a href="#l14.18"></a><span id="l14.18">     verify([</span>
<a href="#l14.19"></a><span id="l14.19">       MailServices.mfn.msgsClassified,</span>
<a href="#l14.20"></a><span id="l14.20">       aMsgs,</span>
<a href="#l14.21"></a><span id="l14.21">       aJunkProcessed,</span>
<a href="#l14.22"></a><span id="l14.22">       aTraitProcessed,</span>
<a href="#l14.23"></a><span id="l14.23">     ]);</span>
<a href="#l14.24"></a><span id="l14.24">     if (gExpectedEvents.length == 0) {</span>
<a href="#l14.25"></a><span id="l14.25">       gCurrStatus |= kStatus.notificationsDone;</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineat">@@ -307,20 +303,17 @@ function verify(event) {</span>
<a href="#l14.27"></a><span id="l14.27">         // new messagse.  So to deal with this we make sure the msgsClassified</span>
<a href="#l14.28"></a><span id="l14.28">         // event is telling us about at least the N expected events and that</span>
<a href="#l14.29"></a><span id="l14.29">         // the last N of these events match</span>
<a href="#l14.30"></a><span id="l14.30">         if (event[1].length &lt; expected[1].length) {</span>
<a href="#l14.31"></a><span id="l14.31">           do_throw(&quot;Not enough reported classified messages.&quot;);</span>
<a href="#l14.32"></a><span id="l14.32">         }</span>
<a href="#l14.33"></a><span id="l14.33">         let ignoreCount = event[1].length - expected[1].length;</span>
<a href="#l14.34"></a><span id="l14.34">         for (let i = 0; i &lt; expected[1].length; i++) {</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineminus">-          let eventHeader = event[1].queryElementAt(</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineminus">-            i + ignoreCount,</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineminus">-            Ci.nsIMsgDBHdr</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineminus">-          );</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+          let eventHeader = event[1][i + ignoreCount];</span>
<a href="#l14.40"></a><span id="l14.40">           Assert.equal(expected[1][i], eventHeader.messageId);</span>
<a href="#l14.41"></a><span id="l14.41">         }</span>
<a href="#l14.42"></a><span id="l14.42">       } else {</span>
<a href="#l14.43"></a><span id="l14.43">         // actual headers</span>
<a href="#l14.44"></a><span id="l14.44">         hasExactlyElements(expected[1], event[1]);</span>
<a href="#l14.45"></a><span id="l14.45">       }</span>
<a href="#l14.46"></a><span id="l14.46">       // aJunkProcessed: was the message processed for junk?</span>
<a href="#l14.47"></a><span id="l14.47">       Assert.equal(expected[2], event[2]);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:31Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

